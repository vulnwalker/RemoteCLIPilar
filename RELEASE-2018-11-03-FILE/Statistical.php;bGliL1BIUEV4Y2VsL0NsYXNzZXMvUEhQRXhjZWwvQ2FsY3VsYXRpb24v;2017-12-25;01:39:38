{
    "namaFile": "lib\/PHPExcel\/Classes\/PHPExcel\/Calculation\/Statistical.php",
    "lastUpdate": "2017-12-25+01:39:38.00",
    "contentFile": "PD9waHAKCi8qKiBQSFBFeGNlbCByb290IGRpcmVjdG9yeSAqLwppZiAoIWRlZmluZWQoJ1BIUEVYQ0VMX1JPT1QnKSkgewogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICAgIGRlZmluZSgnUEhQRVhDRUxfUk9PVCcsIGRpcm5hbWUoX19GSUxFX18pIC4gJy8uLi8uLi8nKTsKICAgIHJlcXVpcmUoUEhQRVhDRUxfUk9PVCAuICdQSFBFeGNlbC9BdXRvbG9hZGVyLnBocCcpOwp9CgoKcmVxdWlyZV9vbmNlIFBIUEVYQ0VMX1JPT1QgLiAnUEhQRXhjZWwvU2hhcmVkL3RyZW5kL3RyZW5kQ2xhc3MucGhwJzsKCgovKiogTE9HX0dBTU1BX1hfTUFYX1ZBTFVFICovCmRlZmluZSgnTE9HX0dBTU1BX1hfTUFYX1ZBTFVFJywgMi41NWUzMDUpOwoKLyoqIFhNSU5JTiAqLwpkZWZpbmUoJ1hNSU5JTicsIDIuMjNlLTMwOCk7CgovKiogRVBTICovCmRlZmluZSgnRVBTJywgMi4yMmUtMTYpOwoKLyoqIFNRUlQyUEkgKi8KZGVmaW5lKCdTUVJUMlBJJywgMi41MDY2MjgyNzQ2MzEwMDA1MDI0MTU3NjUyODQ4MTEwNDUyNTMwMDY5ODY3NDA2MDk5KTsKCi8qKgogKiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9TdGF0aXN0aWNhbAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDYgLSAyMDE1IFBIUEV4Y2VsCiAqCiAqIFRoaXMgbGlicmFyeSBpcyBmcmVlIHNvZnR3YXJlOyB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IKICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYwogKiBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIKICogdmVyc2lvbiAyLjEgb2YgdGhlIExpY2Vuc2UsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiAqCiAqIFRoaXMgbGlicmFyeSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAogKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgogKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VCiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiAqCiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMKICogTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgbGlicmFyeTsgaWYgbm90LCB3cml0ZSB0byB0aGUgRnJlZSBTb2Z0d2FyZQogKiBGb3VuZGF0aW9uLCBJbmMuLCA1MSBGcmFua2xpbiBTdHJlZXQsIEZpZnRoIEZsb29yLCBCb3N0b24sIE1BIDAyMTEwLTEzMDEgVVNBCiAqCiAqIEBjYXRlZ29yeSAgICBQSFBFeGNlbAogKiBAcGFja2FnZSAgICAgICAgUEhQRXhjZWxfQ2FsY3VsYXRpb24KICogQGNvcHlyaWdodCAgICBDb3B5cmlnaHQgKGMpIDIwMDYgLSAyMDE1IFBIUEV4Y2VsIChodHRwOi8vd3d3LmNvZGVwbGV4LmNvbS9QSFBFeGNlbCkKICogQGxpY2Vuc2UgICAgICAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9vbGQtbGljZW5zZXMvbGdwbC0yLjEudHh0ICAgIExHUEwKICogQHZlcnNpb24gICAgICAgICMjVkVSU0lPTiMjLCAjI0RBVEUjIwogKi8KY2xhc3MgUEhQRXhjZWxfQ2FsY3VsYXRpb25fU3RhdGlzdGljYWwKewogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gY2hlY2tUcmVuZEFycmF5cygmJGFycmF5MSwgJiRhcnJheTIpCiAgICB7CiAgICAgICAgaWYgKCFpc19hcnJheSgkYXJyYXkxKSkgewogICAgICAgICAgICAkYXJyYXkxID0gYXJyYXkoJGFycmF5MSk7CiAgICAgICAgfQogICAgICAgIGlmICghaXNfYXJyYXkoJGFycmF5MikpIHsKICAgICAgICAgICAgJGFycmF5MiA9IGFycmF5KCRhcnJheTIpOwogICAgICAgIH0KCiAgICAgICAgJGFycmF5MSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCRhcnJheTEpOwogICAgICAgICRhcnJheTIgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkYXJyYXkyKTsKICAgICAgICBmb3JlYWNoICgkYXJyYXkxIGFzICRrZXkgPT4gJHZhbHVlKSB7CiAgICAgICAgICAgIGlmICgoaXNfYm9vbCgkdmFsdWUpKSB8fCAoaXNfc3RyaW5nKCR2YWx1ZSkpIHx8IChpc19udWxsKCR2YWx1ZSkpKSB7CiAgICAgICAgICAgICAgICB1bnNldCgkYXJyYXkxWyRrZXldKTsKICAgICAgICAgICAgICAgIHVuc2V0KCRhcnJheTJbJGtleV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvcmVhY2ggKCRhcnJheTIgYXMgJGtleSA9PiAkdmFsdWUpIHsKICAgICAgICAgICAgaWYgKChpc19ib29sKCR2YWx1ZSkpIHx8IChpc19zdHJpbmcoJHZhbHVlKSkgfHwgKGlzX251bGwoJHZhbHVlKSkpIHsKICAgICAgICAgICAgICAgIHVuc2V0KCRhcnJheTFbJGtleV0pOwogICAgICAgICAgICAgICAgdW5zZXQoJGFycmF5Mlska2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgJGFycmF5MSA9IGFycmF5X21lcmdlKCRhcnJheTEpOwogICAgICAgICRhcnJheTIgPSBhcnJheV9tZXJnZSgkYXJyYXkyKTsKCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgoKICAgIC8qKgogICAgICogQmV0YSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAYXV0aG9yIEphY28gdmFuIEtvb3RlbgogICAgICoKICAgICAqIEBwYXJhbSBwIHJlcXVpcmUgcD4wCiAgICAgKiBAcGFyYW0gcSByZXF1aXJlIHE+MAogICAgICogQHJldHVybiAwIGlmIHA8PTAsIHE8PTAgb3IgcCtxPjIuNTVFMzA1IHRvIGF2b2lkIGVycm9ycyBhbmQgb3Zlci91bmRlcmZsb3cKICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gYmV0YSgkcCwgJHEpCiAgICB7CiAgICAgICAgaWYgKCRwIDw9IDAuMCB8fCAkcSA8PSAwLjAgfHwgKCRwICsgJHEpID4gTE9HX0dBTU1BX1hfTUFYX1ZBTFVFKSB7CiAgICAgICAgICAgIHJldHVybiAwLjA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGV4cChzZWxmOjpsb2dCZXRhKCRwLCAkcSkpOwogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBJbmNvbXBsZXRlIGJldGEgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAYXV0aG9yIEphY28gdmFuIEtvb3RlbgogICAgICogQGF1dGhvciBQYXVsIE1lYWdoZXIKICAgICAqCiAgICAgKiBUaGUgY29tcHV0YXRpb24gaXMgYmFzZWQgb24gZm9ybXVsYXMgZnJvbSBOdW1lcmljYWwgUmVjaXBlcywgQ2hhcHRlciA2LjQgKFcuSC4gUHJlc3MgZXQgYWwsIDE5OTIpLgogICAgICogQHBhcmFtIHggcmVxdWlyZSAwPD14PD0xCiAgICAgKiBAcGFyYW0gcCByZXF1aXJlIHA+MAogICAgICogQHBhcmFtIHEgcmVxdWlyZSBxPjAKICAgICAqIEByZXR1cm4gMCBpZiB4PDAsIHA8PTAsIHE8PTAgb3IgcCtxPjIuNTVFMzA1IGFuZCAxIGlmIHg+MSB0byBhdm9pZCBlcnJvcnMgYW5kIG92ZXIvdW5kZXJmbG93CiAgICAgKi8KICAgIHByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGluY29tcGxldGVCZXRhKCR4LCAkcCwgJHEpCiAgICB7CiAgICAgICAgaWYgKCR4IDw9IDAuMCkgewogICAgICAgICAgICByZXR1cm4gMC4wOwogICAgICAgIH0gZWxzZWlmICgkeCA+PSAxLjApIHsKICAgICAgICAgICAgcmV0dXJuIDEuMDsKICAgICAgICB9IGVsc2VpZiAoKCRwIDw9IDAuMCkgfHwgKCRxIDw9IDAuMCkgfHwgKCgkcCArICRxKSA+IExPR19HQU1NQV9YX01BWF9WQUxVRSkpIHsKICAgICAgICAgICAgcmV0dXJuIDAuMDsKICAgICAgICB9CiAgICAgICAgJGJldGFfZ2FtID0gZXhwKCgwIC0gc2VsZjo6bG9nQmV0YSgkcCwgJHEpKSArICRwICogbG9nKCR4KSArICRxICogbG9nKDEuMCAtICR4KSk7CiAgICAgICAgaWYgKCR4IDwgKCRwICsgMS4wKSAvICgkcCArICRxICsgMi4wKSkgewogICAgICAgICAgICByZXR1cm4gJGJldGFfZ2FtICogc2VsZjo6YmV0YUZyYWN0aW9uKCR4LCAkcCwgJHEpIC8gJHA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIDEuMCAtICgkYmV0YV9nYW0gKiBzZWxmOjpiZXRhRnJhY3Rpb24oMSAtICR4LCAkcSwgJHApIC8gJHEpOwogICAgICAgIH0KICAgIH0KCgogICAgLy8gRnVuY3Rpb24gY2FjaGUgZm9yIGxvZ0JldGEgZnVuY3Rpb24KICAgIHByaXZhdGUgc3RhdGljICRsb2dCZXRhQ2FjaGVQICAgICAgPSAwLjA7CiAgICBwcml2YXRlIHN0YXRpYyAkbG9nQmV0YUNhY2hlUSAgICAgID0gMC4wOwogICAgcHJpdmF0ZSBzdGF0aWMgJGxvZ0JldGFDYWNoZVJlc3VsdCA9IDAuMDsKCiAgICAvKioKICAgICAqIFRoZSBuYXR1cmFsIGxvZ2FyaXRobSBvZiB0aGUgYmV0YSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gcCByZXF1aXJlIHA+MAogICAgICogQHBhcmFtIHEgcmVxdWlyZSBxPjAKICAgICAqIEByZXR1cm4gMCBpZiBwPD0wLCBxPD0wIG9yIHArcT4yLjU1RTMwNSB0byBhdm9pZCBlcnJvcnMgYW5kIG92ZXIvdW5kZXJmbG93CiAgICAgKiBAYXV0aG9yIEphY28gdmFuIEtvb3RlbgogICAgICovCiAgICBwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBsb2dCZXRhKCRwLCAkcSkKICAgIHsKICAgICAgICBpZiAoJHAgIT0gc2VsZjo6JGxvZ0JldGFDYWNoZVAgfHwgJHEgIT0gc2VsZjo6JGxvZ0JldGFDYWNoZVEpIHsKICAgICAgICAgICAgc2VsZjo6JGxvZ0JldGFDYWNoZVAgPSAkcDsKICAgICAgICAgICAgc2VsZjo6JGxvZ0JldGFDYWNoZVEgPSAkcTsKICAgICAgICAgICAgaWYgKCgkcCA8PSAwLjApIHx8ICgkcSA8PSAwLjApIHx8ICgoJHAgKyAkcSkgPiBMT0dfR0FNTUFfWF9NQVhfVkFMVUUpKSB7CiAgICAgICAgICAgICAgICBzZWxmOjokbG9nQmV0YUNhY2hlUmVzdWx0ID0gMC4wOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VsZjo6JGxvZ0JldGFDYWNoZVJlc3VsdCA9IHNlbGY6OmxvZ0dhbW1hKCRwKSArIHNlbGY6OmxvZ0dhbW1hKCRxKSAtIHNlbGY6OmxvZ0dhbW1hKCRwICsgJHEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZWxmOjokbG9nQmV0YUNhY2hlUmVzdWx0OwogICAgfQoKCiAgICAvKioKICAgICAqIEV2YWx1YXRlcyBvZiBjb250aW51ZWQgZnJhY3Rpb24gcGFydCBvZiBpbmNvbXBsZXRlIGJldGEgZnVuY3Rpb24uCiAgICAgKiBCYXNlZCBvbiBhbiBpZGVhIGZyb20gTnVtZXJpY2FsIFJlY2lwZXMgKFcuSC4gUHJlc3MgZXQgYWwsIDE5OTIpLgogICAgICogQGF1dGhvciBKYWNvIHZhbiBLb290ZW4KICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gYmV0YUZyYWN0aW9uKCR4LCAkcCwgJHEpCiAgICB7CiAgICAgICAgJGMgPSAxLjA7CiAgICAgICAgJHN1bV9wcSA9ICRwICsgJHE7CiAgICAgICAgJHBfcGx1cyA9ICRwICsgMS4wOwogICAgICAgICRwX21pbnVzID0gJHAgLSAxLjA7CiAgICAgICAgJGggPSAxLjAgLSAkc3VtX3BxICogJHggLyAkcF9wbHVzOwogICAgICAgIGlmIChhYnMoJGgpIDwgWE1JTklOKSB7CiAgICAgICAgICAgICRoID0gWE1JTklOOwogICAgICAgIH0KICAgICAgICAkaCA9IDEuMCAvICRoOwogICAgICAgICRmcmFjID0gJGg7CiAgICAgICAgJG0gICAgID0gMTsKICAgICAgICAkZGVsdGEgPSAwLjA7CiAgICAgICAgd2hpbGUgKCRtIDw9IE1BWF9JVEVSQVRJT05TICYmIGFicygkZGVsdGEtMS4wKSA+IFBSRUNJU0lPTikgewogICAgICAgICAgICAkbTIgPSAyICogJG07CiAgICAgICAgICAgIC8vIGV2ZW4gaW5kZXggZm9yIGQKICAgICAgICAgICAgJGQgPSAkbSAqICgkcSAtICRtKSAqICR4IC8gKCAoJHBfbWludXMgKyAkbTIpICogKCRwICsgJG0yKSk7CiAgICAgICAgICAgICRoID0gMS4wICsgJGQgKiAkaDsKICAgICAgICAgICAgaWYgKGFicygkaCkgPCBYTUlOSU4pIHsKICAgICAgICAgICAgICAgICRoID0gWE1JTklOOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRoID0gMS4wIC8gJGg7CiAgICAgICAgICAgICRjID0gMS4wICsgJGQgLyAkYzsKICAgICAgICAgICAgaWYgKGFicygkYykgPCBYTUlOSU4pIHsKICAgICAgICAgICAgICAgICRjID0gWE1JTklOOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRmcmFjICo9ICRoICogJGM7CiAgICAgICAgICAgIC8vIG9kZCBpbmRleCBmb3IgZAogICAgICAgICAgICAkZCA9IC0oJHAgKyAkbSkgKiAoJHN1bV9wcSArICRtKSAqICR4IC8gKCgkcCArICRtMikgKiAoJHBfcGx1cyArICRtMikpOwogICAgICAgICAgICAkaCA9IDEuMCArICRkICogJGg7CiAgICAgICAgICAgIGlmIChhYnMoJGgpIDwgWE1JTklOKSB7CiAgICAgICAgICAgICAgICAkaCA9IFhNSU5JTjsKICAgICAgICAgICAgfQogICAgICAgICAgICAkaCA9IDEuMCAvICRoOwogICAgICAgICAgICAkYyA9IDEuMCArICRkIC8gJGM7CiAgICAgICAgICAgIGlmIChhYnMoJGMpIDwgWE1JTklOKSB7CiAgICAgICAgICAgICAgICAkYyA9IFhNSU5JTjsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGVsdGEgPSAkaCAqICRjOwogICAgICAgICAgICAkZnJhYyAqPSAkZGVsdGE7CiAgICAgICAgICAgICsrJG07CiAgICAgICAgfQogICAgICAgIHJldHVybiAkZnJhYzsKICAgIH0KCgogICAgLyoqCiAgICAgKiBsb2dHYW1tYSBmdW5jdGlvbgogICAgICoKICAgICAqIEB2ZXJzaW9uIDEuMQogICAgICogQGF1dGhvciBKYWNvIHZhbiBLb290ZW4KICAgICAqCiAgICAgKiBPcmlnaW5hbCBhdXRob3Igd2FzIEphY28gdmFuIEtvb3Rlbi4gUG9ydGVkIHRvIFBIUCBieSBQYXVsIE1lYWdoZXIuCiAgICAgKgogICAgICogVGhlIG5hdHVyYWwgbG9nYXJpdGhtIG9mIHRoZSBnYW1tYSBmdW5jdGlvbi4gPGJyIC8+CiAgICAgKiBCYXNlZCBvbiBwdWJsaWMgZG9tYWluIE5FVExJQiAoRm9ydHJhbikgY29kZSBieSBXLiBKLiBDb2R5IGFuZCBMLiBTdG9sdHogPGJyIC8+CiAgICAgKiBBcHBsaWVkIE1hdGhlbWF0aWNzIERpdmlzaW9uIDxiciAvPgogICAgICogQXJnb25uZSBOYXRpb25hbCBMYWJvcmF0b3J5IDxiciAvPgogICAgICogQXJnb25uZSwgSUwgNjA0MzkgPGJyIC8+CiAgICAgKiA8cD4KICAgICAqIFJlZmVyZW5jZXM6CiAgICAgKiA8b2w+CiAgICAgKiA8bGk+Vy4gSi4gQ29keSBhbmQgSy4gRS4gSGlsbHN0cm9tLCAnQ2hlYnlzaGV2IEFwcHJveGltYXRpb25zIGZvciB0aGUgTmF0dXJhbAogICAgICogICAgIExvZ2FyaXRobSBvZiB0aGUgR2FtbWEgRnVuY3Rpb24sJyBNYXRoLiBDb21wLiAyMSwgMTk2NywgcHAuIDE5OC0yMDMuPC9saT4KICAgICAqIDxsaT5LLiBFLiBIaWxsc3Ryb20sIEFOTC9BTUQgUHJvZ3JhbSBBTkxDMzY2UywgREdBTU1BL0RMR0FNQSwgTWF5LCAxOTY5LjwvbGk+CiAgICAgKiA8bGk+SGFydCwgRXQuIEFsLiwgQ29tcHV0ZXIgQXBwcm94aW1hdGlvbnMsIFdpbGV5IGFuZCBzb25zLCBOZXcgWW9yaywgMTk2OC48L2xpPgogICAgICogPC9vbD4KICAgICAqIDwvcD4KICAgICAqIDxwPgogICAgICogRnJvbSB0aGUgb3JpZ2luYWwgZG9jdW1lbnRhdGlvbjoKICAgICAqIDwvcD4KICAgICAqIDxwPgogICAgICogVGhpcyByb3V0aW5lIGNhbGN1bGF0ZXMgdGhlIExPRyhHQU1NQSkgZnVuY3Rpb24gZm9yIGEgcG9zaXRpdmUgcmVhbCBhcmd1bWVudCBYLgogICAgICogQ29tcHV0YXRpb24gaXMgYmFzZWQgb24gYW4gYWxnb3JpdGhtIG91dGxpbmVkIGluIHJlZmVyZW5jZXMgMSBhbmQgMi4KICAgICAqIFRoZSBwcm9ncmFtIHVzZXMgcmF0aW9uYWwgZnVuY3Rpb25zIHRoYXQgdGhlb3JldGljYWxseSBhcHByb3hpbWF0ZSBMT0coR0FNTUEpCiAgICAgKiB0byBhdCBsZWFzdCAxOCBzaWduaWZpY2FudCBkZWNpbWFsIGRpZ2l0cy4gVGhlIGFwcHJveGltYXRpb24gZm9yIFggPiAxMiBpcyBmcm9tCiAgICAgKiByZWZlcmVuY2UgMywgd2hpbGUgYXBwcm94aW1hdGlvbnMgZm9yIFggPCAxMi4wIGFyZSBzaW1pbGFyIHRvIHRob3NlIGluIHJlZmVyZW5jZQogICAgICogMSwgYnV0IGFyZSB1bnB1Ymxpc2hlZC4gVGhlIGFjY3VyYWN5IGFjaGlldmVkIGRlcGVuZHMgb24gdGhlIGFyaXRobWV0aWMgc3lzdGVtLAogICAgICogdGhlIGNvbXBpbGVyLCB0aGUgaW50cmluc2ljIGZ1bmN0aW9ucywgYW5kIHByb3BlciBzZWxlY3Rpb24gb2YgdGhlCiAgICAgKiBtYWNoaW5lLWRlcGVuZGVudCBjb25zdGFudHMuCiAgICAgKiA8L3A+CiAgICAgKiA8cD4KICAgICAqIEVycm9yIHJldHVybnM6IDxiciAvPgogICAgICogVGhlIHByb2dyYW0gcmV0dXJucyB0aGUgdmFsdWUgWElORiBmb3IgWCAuTEUuIDAuMCBvciB3aGVuIG92ZXJmbG93IHdvdWxkIG9jY3VyLgogICAgICogVGhlIGNvbXB1dGF0aW9uIGlzIGJlbGlldmVkIHRvIGJlIGZyZWUgb2YgdW5kZXJmbG93IGFuZCBvdmVyZmxvdy4KICAgICAqIDwvcD4KICAgICAqIEByZXR1cm4gTUFYX1ZBTFVFIGZvciB4IDwgMC4wIG9yIHdoZW4gb3ZlcmZsb3cgd291bGQgb2NjdXIsIGkuZS4geCA+IDIuNTVFMzA1CiAgICAgKi8KCiAgICAvLyBGdW5jdGlvbiBjYWNoZSBmb3IgbG9nR2FtbWEKICAgIHByaXZhdGUgc3RhdGljICRsb2dHYW1tYUNhY2hlUmVzdWx0ID0gMC4wOwogICAgcHJpdmF0ZSBzdGF0aWMgJGxvZ0dhbW1hQ2FjaGVYICAgICAgPSAwLjA7CgogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gbG9nR2FtbWEoJHgpCiAgICB7CiAgICAgICAgLy8gTG9nIEdhbW1hIHJlbGF0ZWQgY29uc3RhbnRzCiAgICAgICAgc3RhdGljICRsZ19kMSA9IC0wLjU3NzIxNTY2NDkwMTUzMjg2MDUxOTUxNzQ7CiAgICAgICAgc3RhdGljICRsZ19kMiA9IDAuNDIyNzg0MzM1MDk4NDY3MTM5Mzk5Mzc3NzsKICAgICAgICBzdGF0aWMgJGxnX2Q0ID0gMS43OTE3NTk0NjkyMjgwNTUwMDAwOTQwMjM7CgogICAgICAgIHN0YXRpYyAkbGdfcDEgPSBhcnJheSgKICAgICAgICAgICAgNC45NDUyMzUzNTkyOTY3MjcwNDY3MzQ4ODgsCiAgICAgICAgICAgIDIwMS44MTEyNjIwODU2Nzc1MDgzOTE1NTY1LAogICAgICAgICAgICAyMjkwLjgzODM3MzgzMTM0NjM5MzAyNjczOSwKICAgICAgICAgICAgMTEzMTkuNjcyMDU5MDMzODA4Mjg2ODUwNDUsCiAgICAgICAgICAgIDI4NTU3LjI0NjM1NjcxNjM1MzM1NzM2Mzg5LAogICAgICAgICAgICAzODQ4NC45NjIyODQ0Mzc5MzM1OTk5MDI2OSwKICAgICAgICAgICAgMjYzNzcuNDg3ODc2MjQxOTU0Mzc5NjM1MzQsCiAgICAgICAgICAgIDcyMjUuODEzOTc5NzAwMjg4MTk3Njk4OTYxCiAgICAgICAgKTsKICAgICAgICBzdGF0aWMgJGxnX3AyID0gYXJyYXkoCiAgICAgICAgICAgIDQuOTc0NjA3ODQ1NTY4OTMyMDM1MDEyMDY0LAogICAgICAgICAgICA1NDIuNDEzODU5OTg5MTA3MDQ5NDEwMTk4NiwKICAgICAgICAgICAgMTU1MDYuOTM4NjQ5NzgzNjQ5NDc2NjUwNzcsCiAgICAgICAgICAgIDE4NDc5My4yOTA0NDQ1NjMyNDI1NDE3MjIzLAogICAgICAgICAgICAxMDg4MjA0Ljc2OTQ2ODgyODc2NzQ5ODQ3LAogICAgICAgICAgICAzMzM4MTUyLjk2Nzk4NzAyOTczNTkxNzIyMywKICAgICAgICAgICAgNTEwNjY2MS42Nzg5MjczNTI0NTYyNzUyNTUsCiAgICAgICAgICAgIDMwNzQxMDkuMDU0ODUwNTM5NTU2MjUwOTI3CiAgICAgICAgKTsKICAgICAgICBzdGF0aWMgJGxnX3A0ID0gYXJyYXkoCiAgICAgICAgICAgIDE0NzQ1LjAyMTY2MDU5OTM5OTQ4OTA1MDYyLAogICAgICAgICAgICAyNDI2ODEzLjM2OTQ4NjcwNDUwMjgzNjMxMiwKICAgICAgICAgICAgMTIxNDc1NTU3LjQwNDUwOTMyMjc5Mzk1OTIsCiAgICAgICAgICAgIDI2NjM0MzI0NDkuNjMwOTc2OTQ5ODk4MDc4LAogICAgICAgICAgICAyOTQwMzc4OTU2Ni4zNDU1Mzg5OTkwNjg3NiwKICAgICAgICAgICAgMTcwMjY2NTczNzc2LjUzOTg4NjgzOTI5OTgsCiAgICAgICAgICAgIDQ5MjYxMjU3OTMzNy43NDMwODg3NTg4MTIsCiAgICAgICAgICAgIDU2MDYyNTE4NTYyMi4zOTUxNDY1MDc4MjQyCiAgICAgICAgKTsKICAgICAgICBzdGF0aWMgJGxnX3ExID0gYXJyYXkoCiAgICAgICAgICAgIDY3LjQ4MjEyNTUwMzAzNzc3MTk2MDczMDM2LAogICAgICAgICAgICAxMTEzLjMzMjM5Mzg1NzE5OTMyMzUxMzAwOCwKICAgICAgICAgICAgNzczOC43NTcwNTY5MzUzOTg3MzMyMzM4MzQsCiAgICAgICAgICAgIDI3NjM5Ljg3MDc0NDAzMzQwNzA4ODk4NTg1LAogICAgICAgICAgICA1NDk5My4xMDIwNjIyNjE1NzMyOTc5NDQxNCwKICAgICAgICAgICAgNjE2MTEuMjIxODAwNjYwMDIxMjc4MzMzNTIsCiAgICAgICAgICAgIDM2MzUxLjI3NTkxNTAxOTQwNTA3Mjc2Mjg3LAogICAgICAgICAgICA4Nzg1LjUzNjMwMjQzMTAxMzE3MDg3MDgzNQogICAgICAgICk7CiAgICAgICAgc3RhdGljICRsZ19xMiA9IGFycmF5KAogICAgICAgICAgICAxODMuMDMyODM5OTM3MDU5MjYwNDA1NTk0MiwKICAgICAgICAgICAgNzc2NS4wNDkzMjE0NDUwMDU4NzEzMjMwNDcsCiAgICAgICAgICAgIDEzMzE5MC4zODI3OTY2MDc0MTk0NDAyNDQ4LAogICAgICAgICAgICAxMTM2NzA1LjgyMTMyMTk2OTYwODkzODc1NSwKICAgICAgICAgICAgNTI2Nzk2NC4xMTc0Mzc5NDY5MTc1Nzc1MzgsCiAgICAgICAgICAgIDEzNDY3MDE0LjU0MzExMTAxNjkyMjkwMDUyLAogICAgICAgICAgICAxNzgyNzM2NS4zMDM1MzI3NDIxMzk3NTkzMiwKICAgICAgICAgICAgOTUzMzA5NS41OTE4NDQzNTM2MTMzOTU3NDcKICAgICAgICApOwogICAgICAgIHN0YXRpYyAkbGdfcTQgPSBhcnJheSgKICAgICAgICAgICAgMjY5MC41MzAxNzU4NzA4OTkzMzMzNzk4NDMsCiAgICAgICAgICAgIDYzOTM4OC41NjU0MzAwMDkyMzk4OTg0MjM4LAogICAgICAgICAgICA0MTM1NTk5OS4zMDI0MTM4ODA1MjA0Mjg0MiwKICAgICAgICAgICAgMTEyMDg3MjEwOS42MTYxNDc5NDEzNzY1NywKICAgICAgICAgICAgMTQ4ODYxMzcyODYuNzg4MTM4MTE1NDIzOTgsCiAgICAgICAgICAgIDEwMTY4MDM1ODYyNy4yNDM4MjI4MDc3MzA0LAogICAgICAgICAgICAzNDE3NDc2MzQ1NTAuNzM3NzEzMjc5ODU5NywKICAgICAgICAgICAgNDQ2MzE1ODE4NzQxLjk3MTMyODY0NjIwODEKICAgICAgICApOwogICAgICAgIHN0YXRpYyAkbGdfYyAgPSBhcnJheSgKICAgICAgICAgICAgLTAuMDAxOTEwNDQ0MDc3NzI4LAogICAgICAgICAgICA4LjQxNzEzODc3ODEyOTVlLTQsCiAgICAgICAgICAgIC01Ljk1MjM3OTkxMzA0MzAxMmUtNCwKICAgICAgICAgICAgNy45MzY1MDc5MzUwMDM1MDI0OGUtNCwKICAgICAgICAgICAgLTAuMDAyNzc3Nzc3Nzc3Nzc3NjgxNjIyNTUzLAogICAgICAgICAgICAwLjA4MzMzMzMzMzMzMzMzMzMzMzMxNTU0MjQ3LAogICAgICAgICAgICAwLjAwNTcwODM4MzUyNjEKICAgICAgICApOwoKICAgICAgICAvLyBSb3VnaCBlc3RpbWF0ZSBvZiB0aGUgZm91cnRoIHJvb3Qgb2YgbG9nR2FtbWFfeEJpZwogICAgICAgIHN0YXRpYyAkbGdfZnJ0YmlnID0gMi4yNWU3NjsKICAgICAgICBzdGF0aWMgJHBudDY4ICAgICA9IDAuNjc5Njg3NTsKCgogICAgICAgIGlmICgkeCA9PSBzZWxmOjokbG9nR2FtbWFDYWNoZVgpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGY6OiRsb2dHYW1tYUNhY2hlUmVzdWx0OwogICAgICAgIH0KICAgICAgICAkeSA9ICR4OwogICAgICAgIGlmICgkeSA+IDAuMCAmJiAkeSA8PSBMT0dfR0FNTUFfWF9NQVhfVkFMVUUpIHsKICAgICAgICAgICAgaWYgKCR5IDw9IEVQUykgewogICAgICAgICAgICAgICAgJHJlcyA9IC1sb2coeSk7CiAgICAgICAgICAgIH0gZWxzZWlmICgkeSA8PSAxLjUpIHsKICAgICAgICAgICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAgICAgLy8gICAgRVBTIC5MVC4gWCAuTEUuIDEuNQogICAgICAgICAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICAgICAgICBpZiAoJHkgPCAkcG50NjgpIHsKICAgICAgICAgICAgICAgICAgICAkY29yciA9IC1sb2coJHkpOwogICAgICAgICAgICAgICAgICAgICR4bTEgPSAkeTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJGNvcnIgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgJHhtMSA9ICR5IC0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCR5IDw9IDAuNSB8fCAkeSA+PSAkcG50NjgpIHsKICAgICAgICAgICAgICAgICAgICAkeGRlbiA9IDEuMDsKICAgICAgICAgICAgICAgICAgICAkeG51bSA9IDAuMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKCRpID0gMDsgJGkgPCA4OyArKyRpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICR4bnVtID0gJHhudW0gKiAkeG0xICsgJGxnX3AxWyRpXTsKICAgICAgICAgICAgICAgICAgICAgICAgJHhkZW4gPSAkeGRlbiAqICR4bTEgKyAkbGdfcTFbJGldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkcmVzID0gJGNvcnIgKyAkeG0xICogKCRsZ19kMSArICR4bTEgKiAoJHhudW0gLyAkeGRlbikpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkeG0yID0gJHkgLSAxLjA7CiAgICAgICAgICAgICAgICAgICAgJHhkZW4gPSAxLjA7CiAgICAgICAgICAgICAgICAgICAgJHhudW0gPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgZm9yICgkaSA9IDA7ICRpIDwgODsgKyskaSkgewogICAgICAgICAgICAgICAgICAgICAgICAkeG51bSA9ICR4bnVtICogJHhtMiArICRsZ19wMlskaV07CiAgICAgICAgICAgICAgICAgICAgICAgICR4ZGVuID0gJHhkZW4gKiAkeG0yICsgJGxnX3EyWyRpXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJHJlcyA9ICRjb3JyICsgJHhtMiAqICgkbGdfZDIgKyAkeG0yICogKCR4bnVtIC8gJHhkZW4pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlaWYgKCR5IDw9IDQuMCkgewogICAgICAgICAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICAgICAgICAvLyAgICAxLjUgLkxULiBYIC5MRS4gNC4wCiAgICAgICAgICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgICAgICR4bTIgPSAkeSAtIDIuMDsKICAgICAgICAgICAgICAgICR4ZGVuID0gMS4wOwogICAgICAgICAgICAgICAgJHhudW0gPSAwLjA7CiAgICAgICAgICAgICAgICBmb3IgKCRpID0gMDsgJGkgPCA4OyArKyRpKSB7CiAgICAgICAgICAgICAgICAgICAgJHhudW0gPSAkeG51bSAqICR4bTIgKyAkbGdfcDJbJGldOwogICAgICAgICAgICAgICAgICAgICR4ZGVuID0gJHhkZW4gKiAkeG0yICsgJGxnX3EyWyRpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRyZXMgPSAkeG0yICogKCRsZ19kMiArICR4bTIgKiAoJHhudW0gLyAkeGRlbikpOwogICAgICAgICAgICB9IGVsc2VpZiAoJHkgPD0gMTIuMCkgewogICAgICAgICAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAgICAgLy8gICAgNC4wIC5MVC4gWCAuTEUuIDEyLjAKICAgICAgICAgICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgICAgICR4bTQgPSAkeSAtIDQuMDsKICAgICAgICAgICAgICAgICR4ZGVuID0gLTEuMDsKICAgICAgICAgICAgICAgICR4bnVtID0gMC4wOwogICAgICAgICAgICAgICAgZm9yICgkaSA9IDA7ICRpIDwgODsgKyskaSkgewogICAgICAgICAgICAgICAgICAgICR4bnVtID0gJHhudW0gKiAkeG00ICsgJGxnX3A0WyRpXTsKICAgICAgICAgICAgICAgICAgICAkeGRlbiA9ICR4ZGVuICogJHhtNCArICRsZ19xNFskaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkcmVzID0gJGxnX2Q0ICsgJHhtNCAqICgkeG51bSAvICR4ZGVuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAgICAgLy8gICAgRXZhbHVhdGUgZm9yIGFyZ3VtZW50IC5HRS4gMTIuMAogICAgICAgICAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICAgICAgICAkcmVzID0gMC4wOwogICAgICAgICAgICAgICAgaWYgKCR5IDw9ICRsZ19mcnRiaWcpIHsKICAgICAgICAgICAgICAgICAgICAkcmVzID0gJGxnX2NbNl07CiAgICAgICAgICAgICAgICAgICAgJHlzcSA9ICR5ICogJHk7CiAgICAgICAgICAgICAgICAgICAgZm9yICgkaSA9IDA7ICRpIDwgNjsgKyskaSkgewogICAgICAgICAgICAgICAgICAgICAgICAkcmVzID0gJHJlcyAvICR5c3EgKyAkbGdfY1skaV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRyZXMgLz0gJHk7CiAgICAgICAgICAgICAgICAgICAgJGNvcnIgPSBsb2coJHkpOwogICAgICAgICAgICAgICAgICAgICRyZXMgPSAkcmVzICsgbG9nKFNRUlQyUEkpIC0gMC41ICogJGNvcnI7CiAgICAgICAgICAgICAgICAgICAgJHJlcyArPSAkeSAqICgkY29yciAtIDEuMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAvLyAgICBSZXR1cm4gZm9yIGJhZCBhcmd1bWVudHMKICAgICAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgJHJlcyA9IE1BWF9WQUxVRTsKICAgICAgICB9CiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgLy8gICAgRmluYWwgYWRqdXN0bWVudHMgYW5kIHJldHVybgogICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIHNlbGY6OiRsb2dHYW1tYUNhY2hlWCA9ICR4OwogICAgICAgIHNlbGY6OiRsb2dHYW1tYUNhY2hlUmVzdWx0ID0gJHJlczsKICAgICAgICByZXR1cm4gJHJlczsKICAgIH0KCgogICAgLy8KICAgIC8vICAgIFByaXZhdGUgaW1wbGVtZW50YXRpb24gb2YgdGhlIGluY29tcGxldGUgR2FtbWEgZnVuY3Rpb24KICAgIC8vCiAgICBwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBpbmNvbXBsZXRlR2FtbWEoJGEsICR4KQogICAgewogICAgICAgIHN0YXRpYyAkbWF4ID0gMzI7CiAgICAgICAgJHN1bW1lciA9IDA7CiAgICAgICAgZm9yICgkbj0wOyAkbjw9JG1heDsgKyskbikgewogICAgICAgICAgICAkZGl2aXNvciA9ICRhOwogICAgICAgICAgICBmb3IgKCRpPTE7ICRpPD0kbjsgKyskaSkgewogICAgICAgICAgICAgICAgJGRpdmlzb3IgKj0gKCRhICsgJGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRzdW1tZXIgKz0gKHBvdygkeCwgJG4pIC8gJGRpdmlzb3IpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcG93KCR4LCAkYSkgKiBleHAoMC0keCkgKiAkc3VtbWVyOwogICAgfQoKCiAgICAvLwogICAgLy8gICAgUHJpdmF0ZSBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgR2FtbWEgZnVuY3Rpb24KICAgIC8vCiAgICBwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBnYW1tYSgkZGF0YSkKICAgIHsKICAgICAgICBpZiAoJGRhdGEgPT0gMC4wKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgc3RhdGljICRwMCA9IDEuMDAwMDAwMDAwMTkwMDE1OwogICAgICAgIHN0YXRpYyAkcCA9IGFycmF5KAogICAgICAgICAgICAxID0+IDc2LjE4MDA5MTcyOTQ3MTQ2LAogICAgICAgICAgICAyID0+IC04Ni41MDUzMjAzMjk0MTY3NywKICAgICAgICAgICAgMyA9PiAyNC4wMTQwOTgyNDA4MzA5MSwKICAgICAgICAgICAgNCA9PiAtMS4yMzE3Mzk1NzI0NTAxNTUsCiAgICAgICAgICAgIDUgPT4gMS4yMDg2NTA5NzM4NjYxNzllLTMsCiAgICAgICAgICAgIDYgPT4gLTUuMzk1MjM5Mzg0OTUzZS02CiAgICAgICAgKTsKCiAgICAgICAgJHkgPSAkeCA9ICRkYXRhOwogICAgICAgICR0bXAgPSAkeCArIDUuNTsKICAgICAgICAkdG1wIC09ICgkeCArIDAuNSkgKiBsb2coJHRtcCk7CgogICAgICAgICRzdW1tZXIgPSAkcDA7CiAgICAgICAgZm9yICgkaj0xOyAkajw9NjsgKyskaikgewogICAgICAgICAgICAkc3VtbWVyICs9ICgkcFskal0gLyArKyR5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4cCgwIC0gJHRtcCArIGxvZyhTUVJUMlBJICogJHN1bW1lciAvICR4KSk7CiAgICB9CgoKICAgIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZlcnNlX25jZGYucGhwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiAgICBiZWdpbiAgICAgICAgICAgICAgICA6IEZyaWRheSwgSmFudWFyeSAxNiwgMjAwNAogICAgICogICAgY29weXJpZ2h0ICAgICAgICAgICAgOiAoQykgMjAwNCBNaWNoYWVsIE5pY2tlcnNvbgogICAgICogICAgZW1haWwgICAgICAgICAgICAgICAgOiBuaWNrZXJzb25tQHlhaG9vLmNvbQogICAgICoKICAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCiAgICBwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBpbnZlcnNlTmNkZigkcCkKICAgIHsKICAgICAgICAvLyAgICBJbnZlcnNlIG5jZGYgYXBwcm94aW1hdGlvbiBieSBQZXRlciBKLiBBY2tsYW0sIGltcGxlbWVudGF0aW9uIGFkYXB0ZWQgdG8KICAgICAgICAvLyAgICBQSFAgYnkgTWljaGFlbCBOaWNrZXJzb24sIHVzaW5nIERyLiBUaG9tYXMgWmllZ2xlcidzIEMgaW1wbGVtZW50YXRpb24gYXMKICAgICAgICAvLyAgICBhIGd1aWRlLiBodHRwOi8vaG9tZS5vbmxpbmUubm8vfnBqYWNrbGFtL25vdGVzL2ludm5vcm0vaW5kZXguaHRtbAogICAgICAgIC8vICAgIEkgaGF2ZSBub3QgY2hlY2tlZCB0aGUgYWNjdXJhY3kgb2YgdGhpcyBpbXBsZW1lbnRhdGlvbi4gQmUgYXdhcmUgdGhhdCBQSFAKICAgICAgICAvLyAgICB3aWxsIHRydW5jYXRlIHRoZSBjb2VmaWNjaWVudHMgdG8gMTQgZGlnaXRzLgoKICAgICAgICAvLyAgICBZb3UgaGF2ZSBwZXJtaXNzaW9uIHRvIHVzZSBhbmQgZGlzdHJpYnV0ZSB0aGlzIGZ1bmN0aW9uIGZyZWVseSBmb3IKICAgICAgICAvLyAgICB3aGF0ZXZlciBwdXJwb3NlIHlvdSB3YW50LCBidXQgcGxlYXNlIHNob3cgY29tbW9uIGNvdXJ0ZXN5IGFuZCBnaXZlIGNyZWRpdAogICAgICAgIC8vICAgIHdoZXJlIGNyZWRpdCBpcyBkdWUuCgogICAgICAgIC8vICAgIElucHV0IHBhcmFtYXRlciBpcyAkcCAtIHByb2JhYmlsaXR5IC0gd2hlcmUgMCA8IHAgPCAxLgoKICAgICAgICAvLyAgICBDb2VmZmljaWVudHMgaW4gcmF0aW9uYWwgYXBwcm94aW1hdGlvbnMKICAgICAgICBzdGF0aWMgJGEgPSBhcnJheSgKICAgICAgICAgICAgMSA9PiAtMy45Njk2ODMwMjg2NjUzNzZlKzAxLAogICAgICAgICAgICAyID0+IDIuMjA5NDYwOTg0MjQ1MjA1ZSswMiwKICAgICAgICAgICAgMyA9PiAtMi43NTkyODUxMDQ0Njk2ODdlKzAyLAogICAgICAgICAgICA0ID0+IDEuMzgzNTc3NTE4NjcyNjkwZSswMiwKICAgICAgICAgICAgNSA9PiAtMy4wNjY0Nzk4MDY2MTQ3MTZlKzAxLAogICAgICAgICAgICA2ID0+IDIuNTA2NjI4Mjc3NDU5MjM5ZSswMAogICAgICAgICk7CgogICAgICAgIHN0YXRpYyAkYiA9IGFycmF5KAogICAgICAgICAgICAxID0+IC01LjQ0NzYwOTg3OTgyMjQwNmUrMDEsCiAgICAgICAgICAgIDIgPT4gMS42MTU4NTgzNjg1ODA0MDllKzAyLAogICAgICAgICAgICAzID0+IC0xLjU1Njk4OTc5ODU5ODg2NmUrMDIsCiAgICAgICAgICAgIDQgPT4gNi42ODAxMzExODg3NzE5NzJlKzAxLAogICAgICAgICAgICA1ID0+IC0xLjMyODA2ODE1NTI4ODU3MmUrMDEKICAgICAgICApOwoKICAgICAgICBzdGF0aWMgJGMgPSBhcnJheSgKICAgICAgICAgICAgMSA9PiAtNy43ODQ4OTQwMDI0MzAyOTNlLTAzLAogICAgICAgICAgICAyID0+IC0zLjIyMzk2NDU4MDQxMTM2NWUtMDEsCiAgICAgICAgICAgIDMgPT4gLTIuNDAwNzU4Mjc3MTYxODM4ZSswMCwKICAgICAgICAgICAgNCA9PiAtMi41NDk3MzI1MzkzNDM3MzRlKzAwLAogICAgICAgICAgICA1ID0+IDQuMzc0NjY0MTQxNDY0OTY4ZSswMCwKICAgICAgICAgICAgNiA9PiAyLjkzODE2Mzk4MjY5ODc4M2UrMDAKICAgICAgICApOwoKICAgICAgICBzdGF0aWMgJGQgPSBhcnJheSgKICAgICAgICAgICAgMSA9PiA3Ljc4NDY5NTcwOTA0MTQ2MmUtMDMsCiAgICAgICAgICAgIDIgPT4gMy4yMjQ2NzEyOTA3MDAzOThlLTAxLAogICAgICAgICAgICAzID0+IDIuNDQ1MTM0MTM3MTQyOTk2ZSswMCwKICAgICAgICAgICAgNCA9PiAzLjc1NDQwODY2MTkwNzQxNmUrMDAKICAgICAgICApOwoKICAgICAgICAvLyAgICBEZWZpbmUgbG93ZXIgYW5kIHVwcGVyIHJlZ2lvbiBicmVhay1wb2ludHMuCiAgICAgICAgJHBfbG93ID0gMC4wMjQyNTsgICAgICAgICAgICAvL1VzZSBsb3dlciByZWdpb24gYXBwcm94LiBiZWxvdyB0aGlzCiAgICAgICAgJHBfaGlnaCA9IDEgLSAkcF9sb3c7ICAgICAgICAvL1VzZSB1cHBlciByZWdpb24gYXBwcm94LiBhYm92ZSB0aGlzCgogICAgICAgIGlmICgwIDwgJHAgJiYgJHAgPCAkcF9sb3cpIHsKICAgICAgICAgICAgLy8gICAgUmF0aW9uYWwgYXBwcm94aW1hdGlvbiBmb3IgbG93ZXIgcmVnaW9uLgogICAgICAgICAgICAkcSA9IHNxcnQoLTIgKiBsb2coJHApKTsKICAgICAgICAgICAgcmV0dXJuICgoKCgoJGNbMV0gKiAkcSArICRjWzJdKSAqICRxICsgJGNbM10pICogJHEgKyAkY1s0XSkgKiAkcSArICRjWzVdKSAqICRxICsgJGNbNl0pIC8KICAgICAgICAgICAgICAgICAgICAoKCgoJGRbMV0gKiAkcSArICRkWzJdKSAqICRxICsgJGRbM10pICogJHEgKyAkZFs0XSkgKiAkcSArIDEpOwogICAgICAgIH0gZWxzZWlmICgkcF9sb3cgPD0gJHAgJiYgJHAgPD0gJHBfaGlnaCkgewogICAgICAgICAgICAvLyAgICBSYXRpb25hbCBhcHByb3hpbWF0aW9uIGZvciBjZW50cmFsIHJlZ2lvbi4KICAgICAgICAgICAgJHEgPSAkcCAtIDAuNTsKICAgICAgICAgICAgJHIgPSAkcSAqICRxOwogICAgICAgICAgICByZXR1cm4gKCgoKCgkYVsxXSAqICRyICsgJGFbMl0pICogJHIgKyAkYVszXSkgKiAkciArICRhWzRdKSAqICRyICsgJGFbNV0pICogJHIgKyAkYVs2XSkgKiAkcSAvCiAgICAgICAgICAgICAgICAgICAoKCgoKCRiWzFdICogJHIgKyAkYlsyXSkgKiAkciArICRiWzNdKSAqICRyICsgJGJbNF0pICogJHIgKyAkYls1XSkgKiAkciArIDEpOwogICAgICAgIH0gZWxzZWlmICgkcF9oaWdoIDwgJHAgJiYgJHAgPCAxKSB7CiAgICAgICAgICAgIC8vICAgIFJhdGlvbmFsIGFwcHJveGltYXRpb24gZm9yIHVwcGVyIHJlZ2lvbi4KICAgICAgICAgICAgJHEgPSBzcXJ0KC0yICogbG9nKDEgLSAkcCkpOwogICAgICAgICAgICByZXR1cm4gLSgoKCgoJGNbMV0gKiAkcSArICRjWzJdKSAqICRxICsgJGNbM10pICogJHEgKyAkY1s0XSkgKiAkcSArICRjWzVdKSAqICRxICsgJGNbNl0pIC8KICAgICAgICAgICAgICAgICAgICAgKCgoKCRkWzFdICogJHEgKyAkZFsyXSkgKiAkcSArICRkWzNdKSAqICRxICsgJGRbNF0pICogJHEgKyAxKTsKICAgICAgICB9CiAgICAgICAgLy8gICAgSWYgMCA8IHAgPCAxLCByZXR1cm4gYSBudWxsIHZhbHVlCiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TlVMTCgpOwogICAgfQoKCiAgICBwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBpbnZlcnNlTmNkZjIoJHByb2IpCiAgICB7CiAgICAgICAgLy8gICAgQXBwcm94aW1hdGlvbiBvZiBpbnZlcnNlIHN0YW5kYXJkIG5vcm1hbCBDREYgZGV2ZWxvcGVkIGJ5CiAgICAgICAgLy8gICAgQi4gTW9ybywgIlRoZSBGdWxsIE1vbnRlLCIgUmlzayA4KDIpLCBGZWIgMTk5NSwgNTctNTguCgogICAgICAgICRhMSA9IDIuNTA2NjI4MjM4ODQ7CiAgICAgICAgJGEyID0gLTE4LjYxNTAwMDYyNTI5OwogICAgICAgICRhMyA9IDQxLjM5MTE5NzczNTM0OwogICAgICAgICRhNCA9IC0yNS40NDEwNjA0OTYzNzsKCiAgICAgICAgJGIxID0gLTguNDczNTEwOTMwOTsKICAgICAgICAkYjIgPSAyMy4wODMzNjc0Mzc0MzsKICAgICAgICAkYjMgPSAtMjEuMDYyMjQxMDE4MjY7CiAgICAgICAgJGI0ID0gMy4xMzA4MjkwOTgzMzsKCiAgICAgICAgJGMxID0gMC4zMzc0NzU0ODIyNzI2MTU7CiAgICAgICAgJGMyID0gMC45NzYxNjkwMTkwOTE3MTk7CiAgICAgICAgJGMzID0gMC4xNjA3OTc5NzE0OTE4MjE7CiAgICAgICAgJGM0ID0gMi43NjQzODgxMDMzMzg2M0UtMDI7CiAgICAgICAgJGM1ID0gMy44NDA1NzI5MzczNjA5RS0wMzsKICAgICAgICAkYzYgPSAzLjk1MTg5NjUxMTkxOUUtMDQ7CiAgICAgICAgJGM3ID0gMy4yMTc2Nzg4MTc2OEUtMDU7CiAgICAgICAgJGM4ID0gMi44ODgxNjczNjRFLTA3OwogICAgICAgICRjOSA9IDMuOTYwMzE1MTg3RS0wNzsKCiAgICAgICAgJHkgPSAkcHJvYiAtIDAuNTsKICAgICAgICBpZiAoYWJzKCR5KSA8IDAuNDIpIHsKICAgICAgICAgICAgJHogPSAoJHkgKiAkeSk7CiAgICAgICAgICAgICR6ID0gJHkgKiAoKCgkYTQgKiAkeiArICRhMykgKiAkeiArICRhMikgKiAkeiArICRhMSkgLyAoKCgoJGI0ICogJHogKyAkYjMpICogJHogKyAkYjIpICogJHogKyAkYjEpICogJHogKyAxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoJHkgPiAwKSB7CiAgICAgICAgICAgICAgICAkeiA9IGxvZygtbG9nKDEgLSAkcHJvYikpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJHogPSBsb2coLWxvZygkcHJvYikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICR6ID0gJGMxICsgJHogKiAoJGMyICsgJHogKiAoJGMzICsgJHogKiAoJGM0ICsgJHogKiAoJGM1ICsgJHogKiAoJGM2ICsgJHogKiAoJGM3ICsgJHogKiAoJGM4ICsgJHogKiAkYzkpKSkpKSkpOwogICAgICAgICAgICBpZiAoJHkgPCAwKSB7CiAgICAgICAgICAgICAgICAkeiA9IC0kejsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gJHo7CiAgICB9ICAgIC8vICAgIGZ1bmN0aW9uIGludmVyc2VOY2RmMigpCgoKICAgIHByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGludmVyc2VOY2RmMygkcCkKICAgIHsKICAgICAgICAvLyAgICBBTEdPUklUSE0gQVMyNDEgQVBQTC4gU1RBVElTVC4gKDE5ODgpIFZPTC4gMzcsIE5PLiAzLgogICAgICAgIC8vICAgIFByb2R1Y2VzIHRoZSBub3JtYWwgZGV2aWF0ZSBaIGNvcnJlc3BvbmRpbmcgdG8gYSBnaXZlbiBsb3dlcgogICAgICAgIC8vICAgIHRhaWwgYXJlYSBvZiBQOyBaIGlzIGFjY3VyYXRlIHRvIGFib3V0IDEgcGFydCBpbiAxMCoqMTYuCiAgICAgICAgLy8KICAgICAgICAvLyAgICBUaGlzIGlzIGEgUEhQIHZlcnNpb24gb2YgdGhlIG9yaWdpbmFsIEZPUlRSQU4gY29kZSB0aGF0IGNhbgogICAgICAgIC8vICAgIGJlIGZvdW5kIGF0IGh0dHA6Ly9saWIuc3RhdC5jbXUuZWR1L2Fwc3RhdC8KICAgICAgICAkc3BsaXQxID0gMC40MjU7CiAgICAgICAgJHNwbGl0MiA9IDU7CiAgICAgICAgJGNvbnN0MSA9IDAuMTgwNjI1OwogICAgICAgICRjb25zdDIgPSAxLjY7CgogICAgICAgIC8vICAgIGNvZWZmaWNpZW50cyBmb3IgcCBjbG9zZSB0byAwLjUKICAgICAgICAkYTAgPSAzLjM4NzEzMjg3Mjc5NjM2NjYwODA7CiAgICAgICAgJGExID0gMS4zMzE0MTY2Nzg5MTc4NDM3NzQ1RSsyOwogICAgICAgICRhMiA9IDEuOTcxNTkwOTUwMzA2NTUxNDQyN0UrMzsKICAgICAgICAkYTMgPSAxLjM3MzE2OTM3NjU1MDk0NjExMjVFKzQ7CiAgICAgICAgJGE0ID0gNC41OTIxOTUzOTMxNTQ5ODcxNDU3RSs0OwogICAgICAgICRhNSA9IDYuNzI2NTc3MDkyNzAwODcwMDg1M0UrNDsKICAgICAgICAkYTYgPSAzLjM0MzA1NzU1ODM1ODgxMjgxMDVFKzQ7CiAgICAgICAgJGE3ID0gMi41MDkwODA5Mjg3MzAxMjI2NzI3RSszOwoKICAgICAgICAkYjEgPSA0LjIzMTMzMzA3MDE2MDA5MTEyNTJFKzE7CiAgICAgICAgJGIyID0gNi44NzE4NzAwNzQ5MjA1NzkwODMwRSsyOwogICAgICAgICRiMyA9IDUuMzk0MTk2MDIxNDI0NzUxMTA3N0UrMzsKICAgICAgICAkYjQgPSAyLjEyMTM3OTQzMDE1ODY1OTU4NjdFKzQ7CiAgICAgICAgJGI1ID0gMy45MzA3ODk1ODAwMDkyNzEwNjEwRSs0OwogICAgICAgICRiNiA9IDIuODcyOTA4NTczNTcyMTk0MjY3NEUrNDsKICAgICAgICAkYjcgPSA1LjIyNjQ5NTI3ODg1Mjg1NDU2MTBFKzM7CgogICAgICAgIC8vICAgIGNvZWZmaWNpZW50cyBmb3IgcCBub3QgY2xvc2UgdG8gMCwgMC41IG9yIDEuCiAgICAgICAgJGMwID0gMS40MjM0MzcxMTA3NDk2ODM1NzczNDsKICAgICAgICAkYzEgPSA0LjYzMDMzNzg0NjE1NjU0NTI5NTkwOwogICAgICAgICRjMiA9IDUuNzY5NDk3MjIxNDYwNjkxNDA1NTA7CiAgICAgICAgJGMzID0gMy42NDc4NDgzMjQ3NjMyMDQ2MDUwNDsKICAgICAgICAkYzQgPSAxLjI3MDQ1ODI1MjQ1MjM2ODM4MjU4OwogICAgICAgICRjNSA9IDIuNDE3ODA3MjUxNzc0NTA2MTE3NzBFLTE7CiAgICAgICAgJGM2ID0gMi4yNzIzODQ0OTg5MjY5MTg0NTgzM0UtMjsKICAgICAgICAkYzcgPSA3Ljc0NTQ1MDE0Mjc4MzQxNDA3NjQwRS00OwoKICAgICAgICAkZDEgPSAyLjA1MzE5MTYyNjYzNzc1ODgyMTg3OwogICAgICAgICRkMiA9IDEuNjc2Mzg0ODMwMTgzODAzODQ5NDA7CiAgICAgICAgJGQzID0gNi44OTc2NzMzNDk4NTEwMDAwNDU1MEUtMTsKICAgICAgICAkZDQgPSAxLjQ4MTAzOTc2NDI3NDgwMDc0NTkwRS0xOwogICAgICAgICRkNSA9IDEuNTE5ODY2NjU2MzYxNjQ1NzE5NjZFLTI7CiAgICAgICAgJGQ2ID0gNS40NzU5MzgwODQ5OTUzNDQ5NDYwMEUtNDsKICAgICAgICAkZDcgPSAxLjA1MDc1MDA3MTY0NDQxNjg0MzI0RS05OwoKICAgICAgICAvLyAgICBjb2VmZmljaWVudHMgZm9yIHAgbmVhciAwIG9yIDEuCiAgICAgICAgJGUwID0gNi42NTc5MDQ2NDM1MDExMDM3NzcyMDsKICAgICAgICAkZTEgPSA1LjQ2Mzc4NDkxMTE2NDExNDM2OTkwOwogICAgICAgICRlMiA9IDEuNzg0ODI2NTM5OTE3MjkxMzM1ODA7CiAgICAgICAgJGUzID0gMi45NjU2MDU3MTgyODUwNDg5MTIzMEUtMTsKICAgICAgICAkZTQgPSAyLjY1MzIxODk1MjY1NzYxMjMwOTMwRS0yOwogICAgICAgICRlNSA9IDEuMjQyNjYwOTQ3Mzg4MDc4NDM4NjBFLTM7CiAgICAgICAgJGU2ID0gMi43MTE1NTU1Njg3NDM0ODc1NzgxNUUtNTsKICAgICAgICAkZTcgPSAyLjAxMDMzNDM5OTI5MjI4ODEzMjY1RS03OwoKICAgICAgICAkZjEgPSA1Ljk5ODMyMjA2NTU1ODg3OTM3NjkwRS0xOwogICAgICAgICRmMiA9IDEuMzY5Mjk4ODA5MjI3MzU4MDUzMTBFLTE7CiAgICAgICAgJGYzID0gMS40ODc1MzYxMjkwODUwNjE0ODUyNUUtMjsKICAgICAgICAkZjQgPSA3Ljg2ODY5MTMxMTQ1NjEzMjU5MTAwRS00OwogICAgICAgICRmNSA9IDEuODQ2MzE4MzE3NTEwMDU0NjgxODBFLTU7CiAgICAgICAgJGY2ID0gMS40MjE1MTE3NTgzMTY0NDU4ODg3MEUtNzsKICAgICAgICAkZjcgPSAyLjA0NDI2MzEwMzM4OTkzOTc4NTY0RS0xNTsKCiAgICAgICAgJHEgPSAkcCAtIDAuNTsKCiAgICAgICAgLy8gICAgY29tcHV0YXRpb24gZm9yIHAgY2xvc2UgdG8gMC41CiAgICAgICAgaWYgKGFicygkcSkgPD0gc3BsaXQxKSB7CiAgICAgICAgICAgICRSID0gJGNvbnN0MSAtICRxICogJHE7CiAgICAgICAgICAgICR6ID0gJHEgKiAoKCgoKCgoJGE3ICogJFIgKyAkYTYpICogJFIgKyAkYTUpICogJFIgKyAkYTQpICogJFIgKyAkYTMpICogJFIgKyAkYTIpICogJFIgKyAkYTEpICogJFIgKyAkYTApIC8KICAgICAgICAgICAgICAgICAgICAgICgoKCgoKCgkYjcgKiAkUiArICRiNikgKiAkUiArICRiNSkgKiAkUiArICRiNCkgKiAkUiArICRiMykgKiAkUiArICRiMikgKiAkUiArICRiMSkgKiAkUiArIDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgkcSA8IDApIHsKICAgICAgICAgICAgICAgICRSID0gJHA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkUiA9IDEgLSAkcDsKICAgICAgICAgICAgfQogICAgICAgICAgICAkUiA9IHBvdygtbG9nKCRSKSwgMik7CgogICAgICAgICAgICAvLyAgICBjb21wdXRhdGlvbiBmb3IgcCBub3QgY2xvc2UgdG8gMCwgMC41IG9yIDEuCiAgICAgICAgICAgIGlmICgkUiA8PSAkc3BsaXQyKSB7CiAgICAgICAgICAgICAgICAkUiA9ICRSIC0gJGNvbnN0MjsKICAgICAgICAgICAgICAgICR6ID0gKCgoKCgoKCRjNyAqICRSICsgJGM2KSAqICRSICsgJGM1KSAqICRSICsgJGM0KSAqICRSICsgJGMzKSAqICRSICsgJGMyKSAqICRSICsgJGMxKSAqICRSICsgJGMwKSAvCiAgICAgICAgICAgICAgICAgICAgICgoKCgoKCgkZDcgKiAkUiArICRkNikgKiAkUiArICRkNSkgKiAkUiArICRkNCkgKiAkUiArICRkMykgKiAkUiArICRkMikgKiAkUiArICRkMSkgKiAkUiArIDEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyAgICBjb21wdXRhdGlvbiBmb3IgcCBuZWFyIDAgb3IgMS4KICAgICAgICAgICAgICAgICRSID0gJFIgLSAkc3BsaXQyOwogICAgICAgICAgICAgICAgJHogPSAoKCgoKCgoJGU3ICogJFIgKyAkZTYpICogJFIgKyAkZTUpICogJFIgKyAkZTQpICogJFIgKyAkZTMpICogJFIgKyAkZTIpICogJFIgKyAkZTEpICogJFIgKyAkZTApIC8KICAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCRmNyAqICRSICsgJGY2KSAqICRSICsgJGY1KSAqICRSICsgJGY0KSAqICRSICsgJGYzKSAqICRSICsgJGYyKSAqICRSICsgJGYxKSAqICRSICsgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCRxIDwgMCkgewogICAgICAgICAgICAgICAgJHogPSAtJHo7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuICR6OwogICAgfQoKCiAgICAvKioKICAgICAqIEFWRURFVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGF2ZXJhZ2Ugb2YgdGhlIGFic29sdXRlIGRldmlhdGlvbnMgb2YgZGF0YSBwb2ludHMgZnJvbSB0aGVpciBtZWFuLgogICAgICogQVZFREVWIGlzIGEgbWVhc3VyZSBvZiB0aGUgdmFyaWFiaWxpdHkgaW4gYSBkYXRhIHNldC4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBBVkVERVYodmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBBVkVERVYoKQogICAgewogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5SW5kZXhlZChmdW5jX2dldF9hcmdzKCkpOwoKICAgICAgICAvLyBSZXR1cm4gdmFsdWUKICAgICAgICAkcmV0dXJuVmFsdWUgPSBudWxsOwoKICAgICAgICAkYU1lYW4gPSBzZWxmOjpBVkVSQUdFKCRhQXJncyk7CiAgICAgICAgaWYgKCRhTWVhbiAhPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkRJVjAoKSkgewogICAgICAgICAgICAkYUNvdW50ID0gMDsKICAgICAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRrID0+ICRhcmcpIHsKICAgICAgICAgICAgICAgIGlmICgoaXNfYm9vbCgkYXJnKSkgJiYKICAgICAgICAgICAgICAgICAgICAoKCFQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlzQ2VsbFZhbHVlKCRrKSkgfHwgKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Z2V0Q29tcGF0aWJpbGl0eU1vZGUoKSA9PSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkNPTVBBVElCSUxJVFlfT1BFTk9GRklDRSkpKSB7CiAgICAgICAgICAgICAgICAgICAgJGFyZyA9IChpbnRlZ2VyKSAkYXJnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSA9IGFicygkYXJnIC0gJGFNZWFuKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgKz0gYWJzKCRhcmcgLSAkYU1lYW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICArKyRhQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJldHVybgogICAgICAgICAgICBpZiAoJGFDb3VudCA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICRyZXR1cm5WYWx1ZSAvICRhQ291bnQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgfQoKCiAgICAvKioKICAgICAqIEFWRVJBR0UKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBhdmVyYWdlIChhcml0aG1ldGljIG1lYW4pIG9mIHRoZSBhcmd1bWVudHMKICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBBVkVSQUdFKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gQVZFUkFHRSgpCiAgICB7CiAgICAgICAgJHJldHVyblZhbHVlID0gJGFDb3VudCA9IDA7CgogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICBmb3JlYWNoIChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheUluZGV4ZWQoZnVuY19nZXRfYXJncygpKSBhcyAkayA9PiAkYXJnKSB7CiAgICAgICAgICAgIGlmICgoaXNfYm9vbCgkYXJnKSkgJiYKICAgICAgICAgICAgICAgICgoIVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6aXNDZWxsVmFsdWUoJGspKSB8fCAoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpnZXRDb21wYXRpYmlsaXR5TW9kZSgpID09IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Q09NUEFUSUJJTElUWV9PUEVOT0ZGSUNFKSkpIHsKICAgICAgICAgICAgICAgICRhcmcgPSAoaW50ZWdlcikgJGFyZzsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgJHJldHVyblZhbHVlID0gJGFyZzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJHJldHVyblZhbHVlICs9ICRhcmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICArKyRhQ291bnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJldHVybgogICAgICAgIGlmICgkYUNvdW50ID4gMCkgewogICAgICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlIC8gJGFDb3VudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEFWRVJBR0VBCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgYXZlcmFnZSBvZiBpdHMgYXJndW1lbnRzLCBpbmNsdWRpbmcgbnVtYmVycywgdGV4dCwgYW5kIGxvZ2ljYWwgdmFsdWVzCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgQVZFUkFHRUEodmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBBVkVSQUdFQSgpCiAgICB7CiAgICAgICAgJHJldHVyblZhbHVlID0gbnVsbDsKCiAgICAgICAgJGFDb3VudCA9IDA7CiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFyZ3VtZW50cwogICAgICAgIGZvcmVhY2ggKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5SW5kZXhlZChmdW5jX2dldF9hcmdzKCkpIGFzICRrID0+ICRhcmcpIHsKICAgICAgICAgICAgaWYgKChpc19ib29sKCRhcmcpKSAmJgogICAgICAgICAgICAgICAgKCFQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlzTWF0cml4VmFsdWUoJGspKSkgewogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSB8fCAoaXNfYm9vbCgkYXJnKSkgfHwgKChpc19zdHJpbmcoJGFyZykgJiYgKCRhcmcgIT0gJycpKSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNfYm9vbCgkYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkYXJnID0gKGludGVnZXIpICRhcmc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKGlzX3N0cmluZygkYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkYXJnID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzX251bGwoJHJldHVyblZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSAkYXJnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSArPSAkYXJnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICArKyRhQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICgkYUNvdW50ID4gMCkgewogICAgICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlIC8gJGFDb3VudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEFWRVJBR0VJRgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGF2ZXJhZ2UgdmFsdWUgZnJvbSBhIHJhbmdlIG9mIGNlbGxzIHRoYXQgY29udGFpbiBudW1iZXJzIHdpdGhpbiB0aGUgbGlzdCBvZiBhcmd1bWVudHMKICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBBVkVSQUdFSUYodmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSxjb25kaXRpb24pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBNYXRoZW1hdGljYWwgYW5kIFRyaWdvbm9tZXRyaWMgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHBhcmFtICAgIHN0cmluZyAgICAgICAgJGNvbmRpdGlvbiAgICAgICAgVGhlIGNyaXRlcmlhIHRoYXQgZGVmaW5lcyB3aGljaCBjZWxscyB3aWxsIGJlIGNoZWNrZWQuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWRbXSAgICAgICAgJGF2ZXJhZ2VBcmdzICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gQVZFUkFHRUlGKCRhQXJncywgJGNvbmRpdGlvbiwgJGF2ZXJhZ2VBcmdzID0gYXJyYXkoKSkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSAwOwoKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkYUFyZ3MpOwogICAgICAgICRhdmVyYWdlQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCRhdmVyYWdlQXJncyk7CiAgICAgICAgaWYgKGVtcHR5KCRhdmVyYWdlQXJncykpIHsKICAgICAgICAgICAgJGF2ZXJhZ2VBcmdzID0gJGFBcmdzOwogICAgICAgIH0KICAgICAgICAkY29uZGl0aW9uID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjppZkNvbmRpdGlvbigkY29uZGl0aW9uKTsKICAgICAgICAvLyBMb29wIHRocm91Z2ggYXJndW1lbnRzCiAgICAgICAgJGFDb3VudCA9IDA7CiAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRrZXkgPT4gJGFyZykgewogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGFyZykpIHsKICAgICAgICAgICAgICAgICRhcmcgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbjo6d3JhcFJlc3VsdChzdHJ0b3VwcGVyKCRhcmcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkdGVzdENvbmRpdGlvbiA9ICc9Jy4kYXJnLiRjb25kaXRpb247CiAgICAgICAgICAgIGlmIChQSFBFeGNlbF9DYWxjdWxhdGlvbjo6Z2V0SW5zdGFuY2UoKS0+X2NhbGN1bGF0ZUZvcm11bGFWYWx1ZSgkdGVzdENvbmRpdGlvbikpIHsKICAgICAgICAgICAgICAgIGlmICgoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB8fCAoJGFyZyA+ICRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgKz0gJGFyZzsKICAgICAgICAgICAgICAgICAgICArKyRhQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICgkYUNvdW50ID4gMCkgewogICAgICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlIC8gJGFDb3VudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6RElWMCgpOwogICAgfQoKCiAgICAvKioKICAgICAqIEJFVEFESVNUCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgYmV0YSBkaXN0cmlidXRpb24uCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkdmFsdWUgICAgICAgICAgICBWYWx1ZSBhdCB3aGljaCB5b3Ugd2FudCB0byBldmFsdWF0ZSB0aGUgZGlzdHJpYnV0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRhbHBoYSAgICAgICAgICAgIFBhcmFtZXRlciB0byB0aGUgZGlzdHJpYnV0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRiZXRhICAgICAgICAgICAgUGFyYW1ldGVyIHRvIHRoZSBkaXN0cmlidXRpb24KICAgICAqIEBwYXJhbSAgICBib29sZWFuICAgICAgICAkY3VtdWxhdGl2ZQogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICoKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBCRVRBRElTVCgkdmFsdWUsICRhbHBoYSwgJGJldGEsICRyTWluID0gMCwgJHJNYXggPSAxKQogICAgewogICAgICAgICR2YWx1ZSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR2YWx1ZSk7CiAgICAgICAgJGFscGhhID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGFscGhhKTsKICAgICAgICAkYmV0YSAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYmV0YSk7CiAgICAgICAgJHJNaW4gID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJNaW4pOwogICAgICAgICRyTWF4ICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRyTWF4KTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCR2YWx1ZSkpICYmIChpc19udW1lcmljKCRhbHBoYSkpICYmIChpc19udW1lcmljKCRiZXRhKSkgJiYgKGlzX251bWVyaWMoJHJNaW4pKSAmJiAoaXNfbnVtZXJpYygkck1heCkpKSB7CiAgICAgICAgICAgIGlmICgoJHZhbHVlIDwgJHJNaW4pIHx8ICgkdmFsdWUgPiAkck1heCkgfHwgKCRhbHBoYSA8PSAwKSB8fCAoJGJldGEgPD0gMCkgfHwgKCRyTWluID09ICRyTWF4KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCRyTWluID4gJHJNYXgpIHsKICAgICAgICAgICAgICAgICR0bXAgPSAkck1pbjsKICAgICAgICAgICAgICAgICRyTWluID0gJHJNYXg7CiAgICAgICAgICAgICAgICAkck1heCA9ICR0bXA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJHZhbHVlIC09ICRyTWluOwogICAgICAgICAgICAkdmFsdWUgLz0gKCRyTWF4IC0gJHJNaW4pOwogICAgICAgICAgICByZXR1cm4gc2VsZjo6aW5jb21wbGV0ZUJldGEoJHZhbHVlLCAkYWxwaGEsICRiZXRhKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBCRVRBSU5WCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgaW52ZXJzZSBvZiB0aGUgYmV0YSBkaXN0cmlidXRpb24uCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkcHJvYmFiaWxpdHkgICAgUHJvYmFiaWxpdHkgYXQgd2hpY2ggeW91IHdhbnQgdG8gZXZhbHVhdGUgdGhlIGRpc3RyaWJ1dGlvbgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYWxwaGEgICAgICAgICAgICBQYXJhbWV0ZXIgdG8gdGhlIGRpc3RyaWJ1dGlvbgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYmV0YSAgICAgICAgICAgIFBhcmFtZXRlciB0byB0aGUgZGlzdHJpYnV0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRyTWluICAgICAgICAgICAgTWluaW11bSB2YWx1ZQogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkck1heCAgICAgICAgICAgIE1heGltdW0gdmFsdWUKICAgICAqIEBwYXJhbSAgICBib29sZWFuICAgICAgICAkY3VtdWxhdGl2ZQogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICoKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBCRVRBSU5WKCRwcm9iYWJpbGl0eSwgJGFscGhhLCAkYmV0YSwgJHJNaW4gPSAwLCAkck1heCA9IDEpCiAgICB7CiAgICAgICAgJHByb2JhYmlsaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHByb2JhYmlsaXR5KTsKICAgICAgICAkYWxwaGEgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYWxwaGEpOwogICAgICAgICRiZXRhICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiZXRhKTsKICAgICAgICAkck1pbiAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkck1pbik7CiAgICAgICAgJHJNYXggICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJNYXgpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHByb2JhYmlsaXR5KSkgJiYgKGlzX251bWVyaWMoJGFscGhhKSkgJiYgKGlzX251bWVyaWMoJGJldGEpKSAmJiAoaXNfbnVtZXJpYygkck1pbikpICYmIChpc19udW1lcmljKCRyTWF4KSkpIHsKICAgICAgICAgICAgaWYgKCgkYWxwaGEgPD0gMCkgfHwgKCRiZXRhIDw9IDApIHx8ICgkck1pbiA9PSAkck1heCkgfHwgKCRwcm9iYWJpbGl0eSA8PSAwKSB8fCAoJHByb2JhYmlsaXR5ID4gMSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgkck1pbiA+ICRyTWF4KSB7CiAgICAgICAgICAgICAgICAkdG1wID0gJHJNaW47CiAgICAgICAgICAgICAgICAkck1pbiA9ICRyTWF4OwogICAgICAgICAgICAgICAgJHJNYXggPSAkdG1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRhID0gMDsKICAgICAgICAgICAgJGIgPSAyOwoKICAgICAgICAgICAgJGkgPSAwOwogICAgICAgICAgICB3aGlsZSAoKCgkYiAtICRhKSA+IFBSRUNJU0lPTikgJiYgKCRpKysgPCBNQVhfSVRFUkFUSU9OUykpIHsKICAgICAgICAgICAgICAgICRndWVzcyA9ICgkYSArICRiKSAvIDI7CiAgICAgICAgICAgICAgICAkcmVzdWx0ID0gc2VsZjo6QkVUQURJU1QoJGd1ZXNzLCAkYWxwaGEsICRiZXRhKTsKICAgICAgICAgICAgICAgIGlmICgoJHJlc3VsdCA9PSAkcHJvYmFiaWxpdHkpIHx8ICgkcmVzdWx0ID09IDApKSB7CiAgICAgICAgICAgICAgICAgICAgJGIgPSAkYTsKICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcmVzdWx0ID4gJHByb2JhYmlsaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgJGIgPSAkZ3Vlc3M7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRhID0gJGd1ZXNzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgkaSA9PSBNQVhfSVRFUkFUSU9OUykgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TkEoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcm91bmQoJHJNaW4gKyAkZ3Vlc3MgKiAoJHJNYXggLSAkck1pbiksIDEyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBCSU5PTURJU1QKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBpbmRpdmlkdWFsIHRlcm0gYmlub21pYWwgZGlzdHJpYnV0aW9uIHByb2JhYmlsaXR5LiBVc2UgQklOT01ESVNUIGluIHByb2JsZW1zIHdpdGgKICAgICAqICAgICAgICBhIGZpeGVkIG51bWJlciBvZiB0ZXN0cyBvciB0cmlhbHMsIHdoZW4gdGhlIG91dGNvbWVzIG9mIGFueSB0cmlhbCBhcmUgb25seSBzdWNjZXNzIG9yIGZhaWx1cmUsCiAgICAgKiAgICAgICAgd2hlbiB0cmlhbHMgYXJlIGluZGVwZW5kZW50LCBhbmQgd2hlbiB0aGUgcHJvYmFiaWxpdHkgb2Ygc3VjY2VzcyBpcyBjb25zdGFudCB0aHJvdWdob3V0IHRoZQogICAgICogICAgICAgIGV4cGVyaW1lbnQuIEZvciBleGFtcGxlLCBCSU5PTURJU1QgY2FuIGNhbGN1bGF0ZSB0aGUgcHJvYmFiaWxpdHkgdGhhdCB0d28gb2YgdGhlIG5leHQgdGhyZWUKICAgICAqICAgICAgICBiYWJpZXMgYm9ybiBhcmUgbWFsZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICR2YWx1ZSAgICAgICAgICAgIE51bWJlciBvZiBzdWNjZXNzZXMgaW4gdHJpYWxzCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICR0cmlhbHMgICAgICAgICAgICBOdW1iZXIgb2YgdHJpYWxzCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRwcm9iYWJpbGl0eSAgICBQcm9iYWJpbGl0eSBvZiBzdWNjZXNzIG9uIGVhY2ggdHJpYWwKICAgICAqIEBwYXJhbSAgICBib29sZWFuICAgICAgICAkY3VtdWxhdGl2ZQogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICoKICAgICAqIEB0b2RvICAgIEN1bXVsYXRpdmUgZGlzdHJpYnV0aW9uIGZ1bmN0aW9uCiAgICAgKgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEJJTk9NRElTVCgkdmFsdWUsICR0cmlhbHMsICRwcm9iYWJpbGl0eSwgJGN1bXVsYXRpdmUpCiAgICB7CiAgICAgICAgJHZhbHVlICAgICAgID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKSk7CiAgICAgICAgJHRyaWFscyAgICAgID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHRyaWFscykpOwogICAgICAgICRwcm9iYWJpbGl0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwcm9iYWJpbGl0eSk7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkdmFsdWUpKSAmJiAoaXNfbnVtZXJpYygkdHJpYWxzKSkgJiYgKGlzX251bWVyaWMoJHByb2JhYmlsaXR5KSkpIHsKICAgICAgICAgICAgaWYgKCgkdmFsdWUgPCAwKSB8fCAoJHZhbHVlID4gJHRyaWFscykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgoJHByb2JhYmlsaXR5IDwgMCkgfHwgKCRwcm9iYWJpbGl0eSA+IDEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGN1bXVsYXRpdmUpKSB8fCAoaXNfYm9vbCgkY3VtdWxhdGl2ZSkpKSB7CiAgICAgICAgICAgICAgICBpZiAoJGN1bXVsYXRpdmUpIHsKICAgICAgICAgICAgICAgICAgICAkc3VtbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKCRpID0gMDsgJGkgPD0gJHZhbHVlOyArKyRpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdW1tZXIgKz0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fTWF0aFRyaWc6OkNPTUJJTigkdHJpYWxzLCAkaSkgKiBwb3coJHByb2JhYmlsaXR5LCAkaSkgKiBwb3coMSAtICRwcm9iYWJpbGl0eSwgJHRyaWFscyAtICRpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdW1tZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9NYXRoVHJpZzo6Q09NQklOKCR0cmlhbHMsICR2YWx1ZSkgKiBwb3coJHByb2JhYmlsaXR5LCAkdmFsdWUpICogcG93KDEgLSAkcHJvYmFiaWxpdHksICR0cmlhbHMgLSAkdmFsdWUpIDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIENISURJU1QKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBvbmUtdGFpbGVkIHByb2JhYmlsaXR5IG9mIHRoZSBjaGktc3F1YXJlZCBkaXN0cmlidXRpb24uCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkdmFsdWUgICAgICAgICAgICBWYWx1ZSBmb3IgdGhlIGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRkZWdyZWVzICAgICAgICBkZWdyZWVzIG9mIGZyZWVkb20KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDSElESVNUKCR2YWx1ZSwgJGRlZ3JlZXMpCiAgICB7CiAgICAgICAgJHZhbHVlICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdmFsdWUpOwogICAgICAgICRkZWdyZWVzID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGRlZ3JlZXMpKTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCR2YWx1ZSkpICYmIChpc19udW1lcmljKCRkZWdyZWVzKSkpIHsKICAgICAgICAgICAgaWYgKCRkZWdyZWVzIDwgMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCR2YWx1ZSA8IDApIHsKICAgICAgICAgICAgICAgIGlmIChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmdldENvbXBhdGliaWxpdHlNb2RlKCkgPT0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpDT01QQVRJQklMSVRZX0dOVU1FUklDKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMSAtIChzZWxmOjppbmNvbXBsZXRlR2FtbWEoJGRlZ3JlZXMvMiwgJHZhbHVlLzIpIC8gc2VsZjo6Z2FtbWEoJGRlZ3JlZXMvMikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIENISUlOVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIG9uZS10YWlsZWQgcHJvYmFiaWxpdHkgb2YgdGhlIGNoaS1zcXVhcmVkIGRpc3RyaWJ1dGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRwcm9iYWJpbGl0eSAgICBQcm9iYWJpbGl0eSBmb3IgdGhlIGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRkZWdyZWVzICAgICAgICBkZWdyZWVzIG9mIGZyZWVkb20KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDSElJTlYoJHByb2JhYmlsaXR5LCAkZGVncmVlcykKICAgIHsKICAgICAgICAkcHJvYmFiaWxpdHkgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcHJvYmFiaWxpdHkpOwogICAgICAgICRkZWdyZWVzICAgICA9IGZsb29yKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRkZWdyZWVzKSk7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkcHJvYmFiaWxpdHkpKSAmJiAoaXNfbnVtZXJpYygkZGVncmVlcykpKSB7CiAgICAgICAgICAgICR4TG8gPSAxMDA7CiAgICAgICAgICAgICR4SGkgPSAwOwoKICAgICAgICAgICAgJHggPSAkeE5ldyA9IDE7CiAgICAgICAgICAgICRkeCAgICA9IDE7CiAgICAgICAgICAgICRpID0gMDsKCiAgICAgICAgICAgIHdoaWxlICgoYWJzKCRkeCkgPiBQUkVDSVNJT04pICYmICgkaSsrIDwgTUFYX0lURVJBVElPTlMpKSB7CiAgICAgICAgICAgICAgICAvLyBBcHBseSBOZXd0b24tUmFwaHNvbiBzdGVwCiAgICAgICAgICAgICAgICAkcmVzdWx0ID0gc2VsZjo6Q0hJRElTVCgkeCwgJGRlZ3JlZXMpOwogICAgICAgICAgICAgICAgJGVycm9yID0gJHJlc3VsdCAtICRwcm9iYWJpbGl0eTsKICAgICAgICAgICAgICAgIGlmICgkZXJyb3IgPT0gMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgJGR4ID0gMDsKICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkZXJyb3IgPCAwLjApIHsKICAgICAgICAgICAgICAgICAgICAkeExvID0gJHg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICR4SGkgPSAkeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIEF2b2lkIGRpdmlzaW9uIGJ5IHplcm8KICAgICAgICAgICAgICAgIGlmICgkcmVzdWx0ICE9IDAuMCkgewogICAgICAgICAgICAgICAgICAgICRkeCA9ICRlcnJvciAvICRyZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgJHhOZXcgPSAkeCAtICRkeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIElmIHRoZSBOUiBmYWlscyB0byBjb252ZXJnZSAod2hpY2ggZm9yIGV4YW1wbGUgbWF5IGJlIHRoZQogICAgICAgICAgICAgICAgLy8gY2FzZSBpZiB0aGUgaW5pdGlhbCBndWVzcyBpcyB0b28gcm91Z2gpIHdlIGFwcGx5IGEgYmlzZWN0aW9uCiAgICAgICAgICAgICAgICAvLyBzdGVwIHRvIGRldGVybWluZSBhIG1vcmUgbmFycm93IGludGVydmFsIGFyb3VuZCB0aGUgcm9vdC4KICAgICAgICAgICAgICAgIGlmICgoJHhOZXcgPCAkeExvKSB8fCAoJHhOZXcgPiAkeEhpKSB8fCAoJHJlc3VsdCA9PSAwLjApKSB7CiAgICAgICAgICAgICAgICAgICAgJHhOZXcgPSAoJHhMbyArICR4SGkpIC8gMjsKICAgICAgICAgICAgICAgICAgICAkZHggPSAkeE5ldyAtICR4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHggPSAkeE5ldzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJGkgPT0gTUFYX0lURVJBVElPTlMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5BKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJvdW5kKCR4LCAxMik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogQ09ORklERU5DRQogICAgICoKICAgICAqIFJldHVybnMgdGhlIGNvbmZpZGVuY2UgaW50ZXJ2YWwgZm9yIGEgcG9wdWxhdGlvbiBtZWFuCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYWxwaGEKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHN0ZERldiAgICAgICAgU3RhbmRhcmQgRGV2aWF0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRzaXplCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIENPTkZJREVOQ0UoJGFscGhhLCAkc3RkRGV2LCAkc2l6ZSkKICAgIHsKICAgICAgICAkYWxwaGEgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGFscGhhKTsKICAgICAgICAkc3RkRGV2ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHN0ZERldik7CiAgICAgICAgJHNpemUgICA9IGZsb29yKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRzaXplKSk7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkYWxwaGEpKSAmJiAoaXNfbnVtZXJpYygkc3RkRGV2KSkgJiYgKGlzX251bWVyaWMoJHNpemUpKSkgewogICAgICAgICAgICBpZiAoKCRhbHBoYSA8PSAwKSB8fCAoJGFscGhhID49IDEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKCRzdGREZXYgPD0gMCkgfHwgKCRzaXplIDwgMSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZWxmOjpOT1JNU0lOVigxIC0gJGFscGhhIC8gMikgKiAkc3RkRGV2IC8gc3FydCgkc2l6ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogQ09SUkVMCiAgICAgKgogICAgICogUmV0dXJucyBjb3ZhcmlhbmNlLCB0aGUgYXZlcmFnZSBvZiB0aGUgcHJvZHVjdHMgb2YgZGV2aWF0aW9ucyBmb3IgZWFjaCBkYXRhIHBvaW50IHBhaXIuCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBZCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFgKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDT1JSRUwoJHlWYWx1ZXMsICR4VmFsdWVzID0gbnVsbCkKICAgIHsKICAgICAgICBpZiAoKGlzX251bGwoJHhWYWx1ZXMpKSB8fCAoIWlzX2FycmF5KCR5VmFsdWVzKSkgfHwgKCFpc19hcnJheSgkeFZhbHVlcykpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgIGlmICghc2VsZjo6Y2hlY2tUcmVuZEFycmF5cygkeVZhbHVlcywgJHhWYWx1ZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgICR5VmFsdWVDb3VudCA9IGNvdW50KCR5VmFsdWVzKTsKICAgICAgICAkeFZhbHVlQ291bnQgPSBjb3VudCgkeFZhbHVlcyk7CgogICAgICAgIGlmICgoJHlWYWx1ZUNvdW50ID09IDApIHx8ICgkeVZhbHVlQ291bnQgIT0gJHhWYWx1ZUNvdW50KSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwogICAgICAgIH0gZWxzZWlmICgkeVZhbHVlQ291bnQgPT0gMSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgfQoKICAgICAgICAkYmVzdEZpdExpbmVhciA9IHRyZW5kQ2xhc3M6OmNhbGN1bGF0ZSh0cmVuZENsYXNzOjpUUkVORF9MSU5FQVIsICR5VmFsdWVzLCAkeFZhbHVlcyk7CiAgICAgICAgcmV0dXJuICRiZXN0Rml0TGluZWFyLT5nZXRDb3JyZWxhdGlvbigpOwogICAgfQoKCiAgICAvKioKICAgICAqIENPVU5UCiAgICAgKgogICAgICogQ291bnRzIHRoZSBudW1iZXIgb2YgY2VsbHMgdGhhdCBjb250YWluIG51bWJlcnMgd2l0aGluIHRoZSBsaXN0IG9mIGFyZ3VtZW50cwogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIENPVU5UKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGludAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIENPVU5UKCkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSAwOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYXJndW1lbnRzCiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXlJbmRleGVkKGZ1bmNfZ2V0X2FyZ3MoKSk7CiAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRrID0+ICRhcmcpIHsKICAgICAgICAgICAgaWYgKChpc19ib29sKCRhcmcpKSAmJgogICAgICAgICAgICAgICAgKCghUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjppc0NlbGxWYWx1ZSgkaykpIHx8IChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmdldENvbXBhdGliaWxpdHlNb2RlKCkgPT0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpDT01QQVRJQklMSVRZX09QRU5PRkZJQ0UpKSkgewogICAgICAgICAgICAgICAgJGFyZyA9IChpbnRlZ2VyKSAkYXJnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIElzIGl0IGEgbnVtZXJpYyB2YWx1ZT8KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgICsrJHJldHVyblZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKCiAgICAvKioKICAgICAqIENPVU5UQQogICAgICoKICAgICAqIENvdW50cyB0aGUgbnVtYmVyIG9mIGNlbGxzIHRoYXQgYXJlIG5vdCBlbXB0eSB3aXRoaW4gdGhlIGxpc3Qgb2YgYXJndW1lbnRzCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgQ09VTlRBKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGludAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIENPVU5UQSgpCiAgICB7CiAgICAgICAgJHJldHVyblZhbHVlID0gMDsKCiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFyZ3VtZW50cwogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KGZ1bmNfZ2V0X2FyZ3MoKSk7CiAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRhcmcpIHsKICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljLCBib29sZWFuIG9yIHN0cmluZyB2YWx1ZT8KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSB8fCAoaXNfYm9vbCgkYXJnKSkgfHwgKChpc19zdHJpbmcoJGFyZykgJiYgKCRhcmcgIT0gJycpKSkpIHsKICAgICAgICAgICAgICAgICsrJHJldHVyblZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKCiAgICAvKioKICAgICAqIENPVU5UQkxBTksKICAgICAqCiAgICAgKiBDb3VudHMgdGhlIG51bWJlciBvZiBlbXB0eSBjZWxscyB3aXRoaW4gdGhlIGxpc3Qgb2YgYXJndW1lbnRzCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgQ09VTlRCTEFOSyh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBpbnQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDT1VOVEJMQU5LKCkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSAwOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYXJndW1lbnRzCiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoZnVuY19nZXRfYXJncygpKTsKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGFyZykgewogICAgICAgICAgICAvLyBJcyBpdCBhIGJsYW5rIGNlbGw\/CiAgICAgICAgICAgIGlmICgoaXNfbnVsbCgkYXJnKSkgfHwgKChpc19zdHJpbmcoJGFyZykpICYmICgkYXJnID09ICcnKSkpIHsKICAgICAgICAgICAgICAgICsrJHJldHVyblZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKCiAgICAvKioKICAgICAqIENPVU5USUYKICAgICAqCiAgICAgKiBDb3VudHMgdGhlIG51bWJlciBvZiBjZWxscyB0aGF0IGNvbnRhaW4gbnVtYmVycyB3aXRoaW4gdGhlIGxpc3Qgb2YgYXJndW1lbnRzCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgQ09VTlRJRih2YWx1ZTFbLHZhbHVlMlssIC4uLl1dLGNvbmRpdGlvbikKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEBwYXJhbSAgICBzdHJpbmcgICAgICAgICRjb25kaXRpb24gICAgICAgIFRoZSBjcml0ZXJpYSB0aGF0IGRlZmluZXMgd2hpY2ggY2VsbHMgd2lsbCBiZSBjb3VudGVkLgogICAgICogQHJldHVybiAgICBpbnQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDT1VOVElGKCRhQXJncywgJGNvbmRpdGlvbikKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSAwOwoKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkYUFyZ3MpOwogICAgICAgICRjb25kaXRpb24gPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlmQ29uZGl0aW9uKCRjb25kaXRpb24pOwogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGFyZykgewogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGFyZykpIHsKICAgICAgICAgICAgICAgICRhcmcgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbjo6d3JhcFJlc3VsdChzdHJ0b3VwcGVyKCRhcmcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkdGVzdENvbmRpdGlvbiA9ICc9Jy4kYXJnLiRjb25kaXRpb247CiAgICAgICAgICAgIGlmIChQSFBFeGNlbF9DYWxjdWxhdGlvbjo6Z2V0SW5zdGFuY2UoKS0+X2NhbGN1bGF0ZUZvcm11bGFWYWx1ZSgkdGVzdENvbmRpdGlvbikpIHsKICAgICAgICAgICAgICAgIC8vIElzIGl0IGEgdmFsdWUgd2l0aGluIG91ciBjcml0ZXJpYQogICAgICAgICAgICAgICAgKyskcmV0dXJuVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICB9CgoKICAgIC8qKgogICAgICogQ09WQVIKICAgICAqCiAgICAgKiBSZXR1cm5zIGNvdmFyaWFuY2UsIHRoZSBhdmVyYWdlIG9mIHRoZSBwcm9kdWN0cyBvZiBkZXZpYXRpb25zIGZvciBlYWNoIGRhdGEgcG9pbnQgcGFpci4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFkKICAgICAqIEBwYXJhbSAgICBhcnJheSBvZiBtaXhlZCAgICAgICAgRGF0YSBTZXJpZXMgWAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIENPVkFSKCR5VmFsdWVzLCAkeFZhbHVlcykKICAgIHsKICAgICAgICBpZiAoIXNlbGY6OmNoZWNrVHJlbmRBcnJheXMoJHlWYWx1ZXMsICR4VmFsdWVzKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KICAgICAgICAkeVZhbHVlQ291bnQgPSBjb3VudCgkeVZhbHVlcyk7CiAgICAgICAgJHhWYWx1ZUNvdW50ID0gY291bnQoJHhWYWx1ZXMpOwoKICAgICAgICBpZiAoKCR5VmFsdWVDb3VudCA9PSAwKSB8fCAoJHlWYWx1ZUNvdW50ICE9ICR4VmFsdWVDb3VudCkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TkEoKTsKICAgICAgICB9IGVsc2VpZiAoJHlWYWx1ZUNvdW50ID09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6RElWMCgpOwogICAgICAgIH0KCiAgICAgICAgJGJlc3RGaXRMaW5lYXIgPSB0cmVuZENsYXNzOjpjYWxjdWxhdGUodHJlbmRDbGFzczo6VFJFTkRfTElORUFSLCAkeVZhbHVlcywgJHhWYWx1ZXMpOwogICAgICAgIHJldHVybiAkYmVzdEZpdExpbmVhci0+Z2V0Q292YXJpYW5jZSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIENSSVRCSU5PTQogICAgICoKICAgICAqIFJldHVybnMgdGhlIHNtYWxsZXN0IHZhbHVlIGZvciB3aGljaCB0aGUgY3VtdWxhdGl2ZSBiaW5vbWlhbCBkaXN0cmlidXRpb24gaXMgZ3JlYXRlcgogICAgICogICAgICAgIHRoYW4gb3IgZXF1YWwgdG8gYSBjcml0ZXJpb24gdmFsdWUKICAgICAqCiAgICAgKiBTZWUgaHR0cDovL3N1cHBvcnQubWljcm9zb2Z0LmNvbS9rYi84MjgxMTcvIGZvciBkZXRhaWxzIG9mIHRoZSBhbGdvcml0aG0gdXNlZAogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHRyaWFscyAgICAgICAgICAgIG51bWJlciBvZiBCZXJub3VsbGkgdHJpYWxzCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRwcm9iYWJpbGl0eSAgICBwcm9iYWJpbGl0eSBvZiBhIHN1Y2Nlc3Mgb24gZWFjaCB0cmlhbAogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYWxwaGEgICAgICAgICAgICBjcml0ZXJpb24gdmFsdWUKICAgICAqIEByZXR1cm4gICAgaW50CiAgICAgKgogICAgICogQHRvZG8gICAgV2FybmluZy4gVGhpcyBpbXBsZW1lbnRhdGlvbiBkaWZmZXJzIGZyb20gdGhlIGFsZ29yaXRobSBkZXRhaWxlZCBvbiB0aGUgTVMKICAgICAqICAgICAgICAgICAgd2ViIHNpdGUgaW4gdGhhdCAkQ3VtUEd1ZXNzTWludXMxID0gJEN1bVBHdWVzcyAtIDEgcmF0aGVyIHRoYW4gJEN1bVBHdWVzcyAtICRQR3Vlc3MKICAgICAqICAgICAgICAgICAgVGhpcyBlbGltaW5hdGVzIGEgcG90ZW50aWFsIGVuZGxlc3MgbG9vcCBlcnJvciwgYnV0IG1heSBoYXZlIGFuIGFkdmVyc2UgYWZmZWN0IG9uIHRoZQogICAgICogICAgICAgICAgICBhY2N1cmFjeSBvZiB0aGUgZnVuY3Rpb24gKGFsdGhvdWdoIGFsbCBteSB0ZXN0cyBoYXZlIHNvIGZhciByZXR1cm5lZCBjb3JyZWN0IHJlc3VsdHMpLgogICAgICoKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDUklUQklOT00oJHRyaWFscywgJHByb2JhYmlsaXR5LCAkYWxwaGEpCiAgICB7CiAgICAgICAgJHRyaWFscyAgICAgID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHRyaWFscykpOwogICAgICAgICRwcm9iYWJpbGl0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwcm9iYWJpbGl0eSk7CiAgICAgICAgJGFscGhhICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGFscGhhKTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCR0cmlhbHMpKSAmJiAoaXNfbnVtZXJpYygkcHJvYmFiaWxpdHkpKSAmJiAoaXNfbnVtZXJpYygkYWxwaGEpKSkgewogICAgICAgICAgICBpZiAoJHRyaWFscyA8IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9IGVsc2VpZiAoKCRwcm9iYWJpbGl0eSA8IDApIHx8ICgkcHJvYmFiaWxpdHkgPiAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0gZWxzZWlmICgoJGFscGhhIDwgMCkgfHwgKCRhbHBoYSA+IDEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfSBlbHNlaWYgKCRhbHBoYSA8PSAwLjUpIHsKICAgICAgICAgICAgICAgICR0ID0gc3FydChsb2coMSAvICgkYWxwaGEgKiAkYWxwaGEpKSk7CiAgICAgICAgICAgICAgICAkdHJpYWxzQXBwcm94ID0gMCAtICgkdCArICgyLjUxNTUxNyArIDAuODAyODUzICogJHQgKyAwLjAxMDMyOCAqICR0ICogJHQpIC8gKDEgKyAxLjQzMjc4OCAqICR0ICsgMC4xODkyNjkgKiAkdCAqICR0ICsgMC4wMDEzMDggKiAkdCAqICR0ICogJHQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICR0ID0gc3FydChsb2coMSAvIHBvdygxIC0gJGFscGhhLCAyKSkpOwogICAgICAgICAgICAgICAgJHRyaWFsc0FwcHJveCA9ICR0IC0gKDIuNTE1NTE3ICsgMC44MDI4NTMgKiAkdCArIDAuMDEwMzI4ICogJHQgKiAkdCkgLyAoMSArIDEuNDMyNzg4ICogJHQgKyAwLjE4OTI2OSAqICR0ICogJHQgKyAwLjAwMTMwOCAqICR0ICogJHQgKiAkdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJEd1ZXNzID0gZmxvb3IoJHRyaWFscyAqICRwcm9iYWJpbGl0eSArICR0cmlhbHNBcHByb3ggKiBzcXJ0KCR0cmlhbHMgKiAkcHJvYmFiaWxpdHkgKiAoMSAtICRwcm9iYWJpbGl0eSkpKTsKICAgICAgICAgICAgaWYgKCRHdWVzcyA8IDApIHsKICAgICAgICAgICAgICAgICRHdWVzcyA9IDA7CiAgICAgICAgICAgIH0gZWxzZWlmICgkR3Vlc3MgPiAkdHJpYWxzKSB7CiAgICAgICAgICAgICAgICAkR3Vlc3MgPSAkdHJpYWxzOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkVG90YWxVbnNjYWxlZFByb2JhYmlsaXR5ID0gJFVuc2NhbGVkUEd1ZXNzID0gJFVuc2NhbGVkQ3VtUEd1ZXNzID0gMC4wOwogICAgICAgICAgICAkRXNzZW50aWFsbHlaZXJvID0gMTBlLTEyOwoKICAgICAgICAgICAgJG0gPSBmbG9vcigkdHJpYWxzICogJHByb2JhYmlsaXR5KTsKICAgICAgICAgICAgKyskVG90YWxVbnNjYWxlZFByb2JhYmlsaXR5OwogICAgICAgICAgICBpZiAoJG0gPT0gJEd1ZXNzKSB7CiAgICAgICAgICAgICAgICArKyRVbnNjYWxlZFBHdWVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJG0gPD0gJEd1ZXNzKSB7CiAgICAgICAgICAgICAgICArKyRVbnNjYWxlZEN1bVBHdWVzczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJFByZXZpb3VzVmFsdWUgPSAxOwogICAgICAgICAgICAkRG9uZSA9IGZhbHNlOwogICAgICAgICAgICAkayA9ICRtICsgMTsKICAgICAgICAgICAgd2hpbGUgKCghJERvbmUpICYmICgkayA8PSAkdHJpYWxzKSkgewogICAgICAgICAgICAgICAgJEN1cnJlbnRWYWx1ZSA9ICRQcmV2aW91c1ZhbHVlICogKCR0cmlhbHMgLSAkayArIDEpICogJHByb2JhYmlsaXR5IC8gKCRrICogKDEgLSAkcHJvYmFiaWxpdHkpKTsKICAgICAgICAgICAgICAgICRUb3RhbFVuc2NhbGVkUHJvYmFiaWxpdHkgKz0gJEN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIGlmICgkayA9PSAkR3Vlc3MpIHsKICAgICAgICAgICAgICAgICAgICAkVW5zY2FsZWRQR3Vlc3MgKz0gJEN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgkayA8PSAkR3Vlc3MpIHsKICAgICAgICAgICAgICAgICAgICAkVW5zY2FsZWRDdW1QR3Vlc3MgKz0gJEN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgkQ3VycmVudFZhbHVlIDw9ICRFc3NlbnRpYWxseVplcm8pIHsKICAgICAgICAgICAgICAgICAgICAkRG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkUHJldmlvdXNWYWx1ZSA9ICRDdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICArKyRrOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkUHJldmlvdXNWYWx1ZSA9IDE7CiAgICAgICAgICAgICREb25lID0gZmFsc2U7CiAgICAgICAgICAgICRrID0gJG0gLSAxOwogICAgICAgICAgICB3aGlsZSAoKCEkRG9uZSkgJiYgKCRrID49IDApKSB7CiAgICAgICAgICAgICAgICAkQ3VycmVudFZhbHVlID0gJFByZXZpb3VzVmFsdWUgKiAkayArIDEgKiAoMSAtICRwcm9iYWJpbGl0eSkgLyAoKCR0cmlhbHMgLSAkaykgKiAkcHJvYmFiaWxpdHkpOwogICAgICAgICAgICAgICAgJFRvdGFsVW5zY2FsZWRQcm9iYWJpbGl0eSArPSAkQ3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgaWYgKCRrID09ICRHdWVzcykgewogICAgICAgICAgICAgICAgICAgICRVbnNjYWxlZFBHdWVzcyArPSAkQ3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCRrIDw9ICRHdWVzcykgewogICAgICAgICAgICAgICAgICAgICRVbnNjYWxlZEN1bVBHdWVzcyArPSAkQ3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCRDdXJyZW50VmFsdWUgPD0gJEVzc2VudGlhbGx5WmVybykgewogICAgICAgICAgICAgICAgICAgICREb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRQcmV2aW91c1ZhbHVlID0gJEN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIC0tJGs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRQR3Vlc3MgPSAkVW5zY2FsZWRQR3Vlc3MgLyAkVG90YWxVbnNjYWxlZFByb2JhYmlsaXR5OwogICAgICAgICAgICAkQ3VtUEd1ZXNzID0gJFVuc2NhbGVkQ3VtUEd1ZXNzIC8gJFRvdGFsVW5zY2FsZWRQcm9iYWJpbGl0eTsKCi8vICAgICAgICAgICAgJEN1bVBHdWVzc01pbnVzMSA9ICRDdW1QR3Vlc3MgLSAkUEd1ZXNzOwogICAgICAgICAgICAkQ3VtUEd1ZXNzTWludXMxID0gJEN1bVBHdWVzcyAtIDE7CgogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKCgkQ3VtUEd1ZXNzTWludXMxIDwgJGFscGhhKSAmJiAoJEN1bVBHdWVzcyA+PSAkYWxwaGEpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRHdWVzczsKICAgICAgICAgICAgICAgIH0gZWxzZWlmICgoJEN1bVBHdWVzc01pbnVzMSA8ICRhbHBoYSkgJiYgKCRDdW1QR3Vlc3MgPCAkYWxwaGEpKSB7CiAgICAgICAgICAgICAgICAgICAgJFBHdWVzc1BsdXMxID0gJFBHdWVzcyAqICgkdHJpYWxzIC0gJEd1ZXNzKSAqICRwcm9iYWJpbGl0eSAvICRHdWVzcyAvICgxIC0gJHByb2JhYmlsaXR5KTsKICAgICAgICAgICAgICAgICAgICAkQ3VtUEd1ZXNzTWludXMxID0gJEN1bVBHdWVzczsKICAgICAgICAgICAgICAgICAgICAkQ3VtUEd1ZXNzID0gJEN1bVBHdWVzcyArICRQR3Vlc3NQbHVzMTsKICAgICAgICAgICAgICAgICAgICAkUEd1ZXNzID0gJFBHdWVzc1BsdXMxOwogICAgICAgICAgICAgICAgICAgICsrJEd1ZXNzOwogICAgICAgICAgICAgICAgfSBlbHNlaWYgKCgkQ3VtUEd1ZXNzTWludXMxID49ICRhbHBoYSkgJiYgKCRDdW1QR3Vlc3MgPj0gJGFscGhhKSkgewogICAgICAgICAgICAgICAgICAgICRQR3Vlc3NNaW51czEgPSAkUEd1ZXNzICogJEd1ZXNzICogKDEgLSAkcHJvYmFiaWxpdHkpIC8gKCR0cmlhbHMgLSAkR3Vlc3MgKyAxKSAvICRwcm9iYWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICAkQ3VtUEd1ZXNzID0gJEN1bVBHdWVzc01pbnVzMTsKICAgICAgICAgICAgICAgICAgICAkQ3VtUEd1ZXNzTWludXMxID0gJEN1bVBHdWVzc01pbnVzMSAtICRQR3Vlc3M7CiAgICAgICAgICAgICAgICAgICAgJFBHdWVzcyA9ICRQR3Vlc3NNaW51czE7CiAgICAgICAgICAgICAgICAgICAgLS0kR3Vlc3M7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBERVZTUQogICAgICoKICAgICAqIFJldHVybnMgdGhlIHN1bSBvZiBzcXVhcmVzIG9mIGRldmlhdGlvbnMgb2YgZGF0YSBwb2ludHMgZnJvbSB0aGVpciBzYW1wbGUgbWVhbi4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBERVZTUSh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIERFVlNRKCkKICAgIHsKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheUluZGV4ZWQoZnVuY19nZXRfYXJncygpKTsKCiAgICAgICAgLy8gUmV0dXJuIHZhbHVlCiAgICAgICAgJHJldHVyblZhbHVlID0gbnVsbDsKCiAgICAgICAgJGFNZWFuID0gc2VsZjo6QVZFUkFHRSgkYUFyZ3MpOwogICAgICAgIGlmICgkYU1lYW4gIT0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCkpIHsKICAgICAgICAgICAgJGFDb3VudCA9IC0xOwogICAgICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGsgPT4gJGFyZykgewogICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgaWYgKChpc19ib29sKCRhcmcpKSAmJgogICAgICAgICAgICAgICAgICAgICgoIVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6aXNDZWxsVmFsdWUoJGspKSB8fAogICAgICAgICAgICAgICAgICAgIChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmdldENvbXBhdGliaWxpdHlNb2RlKCkgPT0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpDT01QQVRJQklMSVRZX09QRU5PRkZJQ0UpKSkgewogICAgICAgICAgICAgICAgICAgICRhcmcgPSAoaW50ZWdlcikgJGFyZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzX251bGwoJHJldHVyblZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSBwb3coKCRhcmcgLSAkYU1lYW4pLCAyKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgKz0gcG93KCgkYXJnIC0gJGFNZWFuKSwgMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICsrJGFDb3VudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUmV0dXJuCiAgICAgICAgICAgIGlmIChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICRyZXR1cm5WYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VsZjo6TkEoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBFWFBPTkRJU1QKICAgICAqCiAgICAgKiAgICBSZXR1cm5zIHRoZSBleHBvbmVudGlhbCBkaXN0cmlidXRpb24uIFVzZSBFWFBPTkRJU1QgdG8gbW9kZWwgdGhlIHRpbWUgYmV0d2VlbiBldmVudHMsCiAgICAgKiAgICAgICAgc3VjaCBhcyBob3cgbG9uZyBhbiBhdXRvbWF0ZWQgYmFuayB0ZWxsZXIgdGFrZXMgdG8gZGVsaXZlciBjYXNoLiBGb3IgZXhhbXBsZSwgeW91IGNhbgogICAgICogICAgICAgIHVzZSBFWFBPTkRJU1QgdG8gZGV0ZXJtaW5lIHRoZSBwcm9iYWJpbGl0eSB0aGF0IHRoZSBwcm9jZXNzIHRha2VzIGF0IG1vc3QgMSBtaW51dGUuCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkdmFsdWUgICAgICAgICAgICBWYWx1ZSBvZiB0aGUgZnVuY3Rpb24KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJGxhbWJkYSAgICAgICAgICAgIFRoZSBwYXJhbWV0ZXIgdmFsdWUKICAgICAqIEBwYXJhbSAgICBib29sZWFuICAgICAgICAkY3VtdWxhdGl2ZQogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEVYUE9ORElTVCgkdmFsdWUsICRsYW1iZGEsICRjdW11bGF0aXZlKQogICAgewogICAgICAgICR2YWx1ZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR2YWx1ZSk7CiAgICAgICAgJGxhbWJkYSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRsYW1iZGEpOwogICAgICAgICRjdW11bGF0aXZlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGN1bXVsYXRpdmUpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHZhbHVlKSkgJiYgKGlzX251bWVyaWMoJGxhbWJkYSkpKSB7CiAgICAgICAgICAgIGlmICgoJHZhbHVlIDwgMCkgfHwgKCRsYW1iZGEgPCAwKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRjdW11bGF0aXZlKSkgfHwgKGlzX2Jvb2woJGN1bXVsYXRpdmUpKSkgewogICAgICAgICAgICAgICAgaWYgKCRjdW11bGF0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEgLSBleHAoMC0kdmFsdWUqJGxhbWJkYSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkbGFtYmRhICogZXhwKDAtJHZhbHVlKiRsYW1iZGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogRklTSEVSCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgRmlzaGVyIHRyYW5zZm9ybWF0aW9uIGF0IHguIFRoaXMgdHJhbnNmb3JtYXRpb24gcHJvZHVjZXMgYSBmdW5jdGlvbiB0aGF0CiAgICAgKiAgICAgICAgaXMgbm9ybWFsbHkgZGlzdHJpYnV0ZWQgcmF0aGVyIHRoYW4gc2tld2VkLiBVc2UgdGhpcyBmdW5jdGlvbiB0byBwZXJmb3JtIGh5cG90aGVzaXMKICAgICAqICAgICAgICB0ZXN0aW5nIG9uIHRoZSBjb3JyZWxhdGlvbiBjb2VmZmljaWVudC4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICR2YWx1ZQogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEZJU0hFUigkdmFsdWUpCiAgICB7CiAgICAgICAgJHZhbHVlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKTsKCiAgICAgICAgaWYgKGlzX251bWVyaWMoJHZhbHVlKSkgewogICAgICAgICAgICBpZiAoKCR2YWx1ZSA8PSAtMSkgfHwgKCR2YWx1ZSA+PSAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDAuNSAqIGxvZygoMSskdmFsdWUpLygxLSR2YWx1ZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIEZJU0hFUklOVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGludmVyc2Ugb2YgdGhlIEZpc2hlciB0cmFuc2Zvcm1hdGlvbi4gVXNlIHRoaXMgdHJhbnNmb3JtYXRpb24gd2hlbgogICAgICogICAgICAgIGFuYWx5emluZyBjb3JyZWxhdGlvbnMgYmV0d2VlbiByYW5nZXMgb3IgYXJyYXlzIG9mIGRhdGEuIElmIHkgPSBGSVNIRVIoeCksIHRoZW4KICAgICAqICAgICAgICBGSVNIRVJJTlYoeSkgPSB4LgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHZhbHVlCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gRklTSEVSSU5WKCR2YWx1ZSkKICAgIHsKICAgICAgICAkdmFsdWUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdmFsdWUpOwoKICAgICAgICBpZiAoaXNfbnVtZXJpYygkdmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiAoZXhwKDIgKiAkdmFsdWUpIC0gMSkgLyAoZXhwKDIgKiAkdmFsdWUpICsgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogRk9SRUNBU1QKICAgICAqCiAgICAgKiBDYWxjdWxhdGVzLCBvciBwcmVkaWN0cywgYSBmdXR1cmUgdmFsdWUgYnkgdXNpbmcgZXhpc3RpbmcgdmFsdWVzLiBUaGUgcHJlZGljdGVkIHZhbHVlIGlzIGEgeS12YWx1ZSBmb3IgYSBnaXZlbiB4LXZhbHVlLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgICAgICAgICBWYWx1ZSBvZiBYIGZvciB3aGljaCB3ZSB3YW50IHRvIGZpbmQgWQogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBZCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFgKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBGT1JFQ0FTVCgkeFZhbHVlLCAkeVZhbHVlcywgJHhWYWx1ZXMpCiAgICB7CiAgICAgICAgJHhWYWx1ZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR4VmFsdWUpOwogICAgICAgIGlmICghaXNfbnVtZXJpYygkeFZhbHVlKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0gZWxzZWlmICghc2VsZjo6Y2hlY2tUcmVuZEFycmF5cygkeVZhbHVlcywgJHhWYWx1ZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgICR5VmFsdWVDb3VudCA9IGNvdW50KCR5VmFsdWVzKTsKICAgICAgICAkeFZhbHVlQ291bnQgPSBjb3VudCgkeFZhbHVlcyk7CgogICAgICAgIGlmICgoJHlWYWx1ZUNvdW50ID09IDApIHx8ICgkeVZhbHVlQ291bnQgIT0gJHhWYWx1ZUNvdW50KSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwogICAgICAgIH0gZWxzZWlmICgkeVZhbHVlQ291bnQgPT0gMSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgfQoKICAgICAgICAkYmVzdEZpdExpbmVhciA9IHRyZW5kQ2xhc3M6OmNhbGN1bGF0ZSh0cmVuZENsYXNzOjpUUkVORF9MSU5FQVIsICR5VmFsdWVzLCAkeFZhbHVlcyk7CiAgICAgICAgcmV0dXJuICRiZXN0Rml0TGluZWFyLT5nZXRWYWx1ZU9mWUZvclgoJHhWYWx1ZSk7CiAgICB9CgoKICAgIC8qKgogICAgICogR0FNTUFESVNUCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgZ2FtbWEgZGlzdHJpYnV0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHZhbHVlICAgICAgICAgICAgVmFsdWUgYXQgd2hpY2ggeW91IHdhbnQgdG8gZXZhbHVhdGUgdGhlIGRpc3RyaWJ1dGlvbgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYSAgICAgICAgICAgICAgICBQYXJhbWV0ZXIgdG8gdGhlIGRpc3RyaWJ1dGlvbgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYiAgICAgICAgICAgICAgICBQYXJhbWV0ZXIgdG8gdGhlIGRpc3RyaWJ1dGlvbgogICAgICogQHBhcmFtICAgIGJvb2xlYW4gICAgICAgICRjdW11bGF0aXZlCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEdBTU1BRElTVCgkdmFsdWUsICRhLCAkYiwgJGN1bXVsYXRpdmUpCiAgICB7CiAgICAgICAgJHZhbHVlID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKTsKICAgICAgICAkYSAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYSk7CiAgICAgICAgJGIgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGIpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHZhbHVlKSkgJiYgKGlzX251bWVyaWMoJGEpKSAmJiAoaXNfbnVtZXJpYygkYikpKSB7CiAgICAgICAgICAgIGlmICgoJHZhbHVlIDwgMCkgfHwgKCRhIDw9IDApIHx8ICgkYiA8PSAwKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRjdW11bGF0aXZlKSkgfHwgKGlzX2Jvb2woJGN1bXVsYXRpdmUpKSkgewogICAgICAgICAgICAgICAgaWYgKCRjdW11bGF0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGY6OmluY29tcGxldGVHYW1tYSgkYSwgJHZhbHVlIC8gJGIpIC8gc2VsZjo6Z2FtbWEoJGEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKDEgLyAocG93KCRiLCAkYSkgKiBzZWxmOjpnYW1tYSgkYSkpKSAqIHBvdygkdmFsdWUsICRhLTEpICogZXhwKDAtKCR2YWx1ZSAvICRiKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBHQU1NQUlOVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGludmVyc2Ugb2YgdGhlIGJldGEgZGlzdHJpYnV0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHByb2JhYmlsaXR5ICAgIFByb2JhYmlsaXR5IGF0IHdoaWNoIHlvdSB3YW50IHRvIGV2YWx1YXRlIHRoZSBkaXN0cmlidXRpb24KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJGFscGhhICAgICAgICAgICAgUGFyYW1ldGVyIHRvIHRoZSBkaXN0cmlidXRpb24KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJGJldGEgICAgICAgICAgICBQYXJhbWV0ZXIgdG8gdGhlIGRpc3RyaWJ1dGlvbgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICoKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBHQU1NQUlOVigkcHJvYmFiaWxpdHksICRhbHBoYSwgJGJldGEpCiAgICB7CiAgICAgICAgJHByb2JhYmlsaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHByb2JhYmlsaXR5KTsKICAgICAgICAkYWxwaGEgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYWxwaGEpOwogICAgICAgICRiZXRhICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiZXRhKTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCRwcm9iYWJpbGl0eSkpICYmIChpc19udW1lcmljKCRhbHBoYSkpICYmIChpc19udW1lcmljKCRiZXRhKSkpIHsKICAgICAgICAgICAgaWYgKCgkYWxwaGEgPD0gMCkgfHwgKCRiZXRhIDw9IDApIHx8ICgkcHJvYmFiaWxpdHkgPCAwKSB8fCAoJHByb2JhYmlsaXR5ID4gMSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkeExvID0gMDsKICAgICAgICAgICAgJHhIaSA9ICRhbHBoYSAqICRiZXRhICogNTsKCiAgICAgICAgICAgICR4ID0gJHhOZXcgPSAxOwogICAgICAgICAgICAkZXJyb3IgPSAkcGRmID0gMDsKICAgICAgICAgICAgJGR4ICAgID0gMTAyNDsKICAgICAgICAgICAgJGkgPSAwOwoKICAgICAgICAgICAgd2hpbGUgKChhYnMoJGR4KSA+IFBSRUNJU0lPTikgJiYgKCRpKysgPCBNQVhfSVRFUkFUSU9OUykpIHsKICAgICAgICAgICAgICAgIC8vIEFwcGx5IE5ld3Rvbi1SYXBoc29uIHN0ZXAKICAgICAgICAgICAgICAgICRlcnJvciA9IHNlbGY6OkdBTU1BRElTVCgkeCwgJGFscGhhLCAkYmV0YSwgdHJ1ZSkgLSAkcHJvYmFiaWxpdHk7CiAgICAgICAgICAgICAgICBpZiAoJGVycm9yIDwgMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgJHhMbyA9ICR4OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkeEhpID0gJHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkcGRmID0gc2VsZjo6R0FNTUFESVNUKCR4LCAkYWxwaGEsICRiZXRhLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAvLyBBdm9pZCBkaXZpc2lvbiBieSB6ZXJvCiAgICAgICAgICAgICAgICBpZiAoJHBkZiAhPSAwLjApIHsKICAgICAgICAgICAgICAgICAgICAkZHggPSAkZXJyb3IgLyAkcGRmOwogICAgICAgICAgICAgICAgICAgICR4TmV3ID0gJHggLSAkZHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgTlIgZmFpbHMgdG8gY29udmVyZ2UgKHdoaWNoIGZvciBleGFtcGxlIG1heSBiZSB0aGUKICAgICAgICAgICAgICAgIC8vIGNhc2UgaWYgdGhlIGluaXRpYWwgZ3Vlc3MgaXMgdG9vIHJvdWdoKSB3ZSBhcHBseSBhIGJpc2VjdGlvbgogICAgICAgICAgICAgICAgLy8gc3RlcCB0byBkZXRlcm1pbmUgYSBtb3JlIG5hcnJvdyBpbnRlcnZhbCBhcm91bmQgdGhlIHJvb3QuCiAgICAgICAgICAgICAgICBpZiAoKCR4TmV3IDwgJHhMbykgfHwgKCR4TmV3ID4gJHhIaSkgfHwgKCRwZGYgPT0gMC4wKSkgewogICAgICAgICAgICAgICAgICAgICR4TmV3ID0gKCR4TG8gKyAkeEhpKSAvIDI7CiAgICAgICAgICAgICAgICAgICAgJGR4ID0gJHhOZXcgLSAkeDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICR4ID0gJHhOZXc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCRpID09IE1BWF9JVEVSQVRJT05TKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAkeDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBHQU1NQUxOCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbmF0dXJhbCBsb2dhcml0aG0gb2YgdGhlIGdhbW1hIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHZhbHVlCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gR0FNTUFMTigkdmFsdWUpCiAgICB7CiAgICAgICAgJHZhbHVlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKTsKCiAgICAgICAgaWYgKGlzX251bWVyaWMoJHZhbHVlKSkgewogICAgICAgICAgICBpZiAoJHZhbHVlIDw9IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsb2coc2VsZjo6Z2FtbWEoJHZhbHVlKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogR0VPTUVBTgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGdlb21ldHJpYyBtZWFuIG9mIGFuIGFycmF5IG9yIHJhbmdlIG9mIHBvc2l0aXZlIGRhdGEuIEZvciBleGFtcGxlLCB5b3UKICAgICAqICAgICAgICBjYW4gdXNlIEdFT01FQU4gdG8gY2FsY3VsYXRlIGF2ZXJhZ2UgZ3Jvd3RoIHJhdGUgZ2l2ZW4gY29tcG91bmQgaW50ZXJlc3Qgd2l0aAogICAgICogICAgICAgIHZhcmlhYmxlIHJhdGVzLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIEdFT01FQU4odmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBHRU9NRUFOKCkKICAgIHsKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheShmdW5jX2dldF9hcmdzKCkpOwoKICAgICAgICAkYU1lYW4gPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9NYXRoVHJpZzo6UFJPRFVDVCgkYUFyZ3MpOwogICAgICAgIGlmIChpc19udW1lcmljKCRhTWVhbikgJiYgKCRhTWVhbiA+IDApKSB7CiAgICAgICAgICAgICRhQ291bnQgPSBzZWxmOjpDT1VOVCgkYUFyZ3MpIDsKICAgICAgICAgICAgaWYgKHNlbGY6Ok1JTigkYUFyZ3MpID4gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBvdygkYU1lYW4sICgxIC8gJGFDb3VudCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgfQoKCiAgICAvKioKICAgICAqIEdST1dUSAogICAgICoKICAgICAqIFJldHVybnMgdmFsdWVzIGFsb25nIGEgcHJlZGljdGVkIGVtcG9uZW50aWFsIHRyZW5kCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBZCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFgKICAgICAqIEBwYXJhbSAgICBhcnJheSBvZiBtaXhlZCAgICAgICAgVmFsdWVzIG9mIFggZm9yIHdoaWNoIHdlIHdhbnQgdG8gZmluZCBZCiAgICAgKiBAcGFyYW0gICAgYm9vbGVhbiAgICAgICAgICAgICAgICBBIGxvZ2ljYWwgdmFsdWUgc3BlY2lmeWluZyB3aGV0aGVyIHRvIGZvcmNlIHRoZSBpbnRlcnNlY3QgdG8gZXF1YWwgMC4KICAgICAqIEByZXR1cm4gICAgYXJyYXkgb2YgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBHUk9XVEgoJHlWYWx1ZXMsICR4VmFsdWVzID0gYXJyYXkoKSwgJG5ld1ZhbHVlcyA9IGFycmF5KCksICRjb25zdCA9IHRydWUpCiAgICB7CiAgICAgICAgJHlWYWx1ZXMgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkeVZhbHVlcyk7CiAgICAgICAgJHhWYWx1ZXMgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkeFZhbHVlcyk7CiAgICAgICAgJG5ld1ZhbHVlcyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCRuZXdWYWx1ZXMpOwogICAgICAgICRjb25zdCA9IChpc19udWxsKCRjb25zdCkpID8gdHJ1ZSA6IChib29sZWFuKSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkY29uc3QpOwoKICAgICAgICAkYmVzdEZpdEV4cG9uZW50aWFsID0gdHJlbmRDbGFzczo6Y2FsY3VsYXRlKHRyZW5kQ2xhc3M6OlRSRU5EX0VYUE9ORU5USUFMLCAkeVZhbHVlcywgJHhWYWx1ZXMsICRjb25zdCk7CiAgICAgICAgaWYgKGVtcHR5KCRuZXdWYWx1ZXMpKSB7CiAgICAgICAgICAgICRuZXdWYWx1ZXMgPSAkYmVzdEZpdEV4cG9uZW50aWFsLT5nZXRYVmFsdWVzKCk7CiAgICAgICAgfQoKICAgICAgICAkcmV0dXJuQXJyYXkgPSBhcnJheSgpOwogICAgICAgIGZvcmVhY2ggKCRuZXdWYWx1ZXMgYXMgJHhWYWx1ZSkgewogICAgICAgICAgICAkcmV0dXJuQXJyYXlbMF1bXSA9ICRiZXN0Rml0RXhwb25lbnRpYWwtPmdldFZhbHVlT2ZZRm9yWCgkeFZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmV0dXJuQXJyYXk7CiAgICB9CgoKICAgIC8qKgogICAgICogSEFSTUVBTgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGhhcm1vbmljIG1lYW4gb2YgYSBkYXRhIHNldC4gVGhlIGhhcm1vbmljIG1lYW4gaXMgdGhlIHJlY2lwcm9jYWwgb2YgdGhlCiAgICAgKiAgICAgICAgYXJpdGhtZXRpYyBtZWFuIG9mIHJlY2lwcm9jYWxzLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIEhBUk1FQU4odmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBIQVJNRUFOKCkKICAgIHsKICAgICAgICAvLyBSZXR1cm4gdmFsdWUKICAgICAgICAkcmV0dXJuVmFsdWUgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5BKCk7CgogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheShmdW5jX2dldF9hcmdzKCkpOwogICAgICAgIGlmIChzZWxmOjpNSU4oJGFBcmdzKSA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgfQogICAgICAgICRhQ291bnQgPSAwOwogICAgICAgIGZvcmVhY2ggKCRhQXJncyBhcyAkYXJnKSB7CiAgICAgICAgICAgIC8vIElzIGl0IGEgbnVtZXJpYyB2YWx1ZT8KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgIGlmICgkYXJnIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSAoMSAvICRhcmcpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgKz0gKDEgLyAkYXJnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICsrJGFDb3VudDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmV0dXJuCiAgICAgICAgaWYgKCRhQ291bnQgPiAwKSB7CiAgICAgICAgICAgIHJldHVybiAxIC8gKCRyZXR1cm5WYWx1ZSAvICRhQ291bnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIEhZUEdFT01ESVNUCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgaHlwZXJnZW9tZXRyaWMgZGlzdHJpYnV0aW9uLiBIWVBHRU9NRElTVCByZXR1cm5zIHRoZSBwcm9iYWJpbGl0eSBvZiBhIGdpdmVuIG51bWJlciBvZgogICAgICogc2FtcGxlIHN1Y2Nlc3NlcywgZ2l2ZW4gdGhlIHNhbXBsZSBzaXplLCBwb3B1bGF0aW9uIHN1Y2Nlc3NlcywgYW5kIHBvcHVsYXRpb24gc2l6ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRzYW1wbGVTdWNjZXNzZXMgICAgICAgIE51bWJlciBvZiBzdWNjZXNzZXMgaW4gdGhlIHNhbXBsZQogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkc2FtcGxlTnVtYmVyICAgICAgICAgICAgU2l6ZSBvZiB0aGUgc2FtcGxlCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRwb3B1bGF0aW9uU3VjY2Vzc2VzICAgIE51bWJlciBvZiBzdWNjZXNzZXMgaW4gdGhlIHBvcHVsYXRpb24KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHBvcHVsYXRpb25OdW1iZXIgICAgICAgIFBvcHVsYXRpb24gc2l6ZQogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICoKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBIWVBHRU9NRElTVCgkc2FtcGxlU3VjY2Vzc2VzLCAkc2FtcGxlTnVtYmVyLCAkcG9wdWxhdGlvblN1Y2Nlc3NlcywgJHBvcHVsYXRpb25OdW1iZXIpCiAgICB7CiAgICAgICAgJHNhbXBsZVN1Y2Nlc3NlcyAgICAgPSBmbG9vcihQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2FtcGxlU3VjY2Vzc2VzKSk7CiAgICAgICAgJHNhbXBsZU51bWJlciAgICAgICAgPSBmbG9vcihQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2FtcGxlTnVtYmVyKSk7CiAgICAgICAgJHBvcHVsYXRpb25TdWNjZXNzZXMgPSBmbG9vcihQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcG9wdWxhdGlvblN1Y2Nlc3NlcykpOwogICAgICAgICRwb3B1bGF0aW9uTnVtYmVyICAgID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHBvcHVsYXRpb25OdW1iZXIpKTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCRzYW1wbGVTdWNjZXNzZXMpKSAmJiAoaXNfbnVtZXJpYygkc2FtcGxlTnVtYmVyKSkgJiYgKGlzX251bWVyaWMoJHBvcHVsYXRpb25TdWNjZXNzZXMpKSAmJiAoaXNfbnVtZXJpYygkcG9wdWxhdGlvbk51bWJlcikpKSB7CiAgICAgICAgICAgIGlmICgoJHNhbXBsZVN1Y2Nlc3NlcyA8IDApIHx8ICgkc2FtcGxlU3VjY2Vzc2VzID4gJHNhbXBsZU51bWJlcikgfHwgKCRzYW1wbGVTdWNjZXNzZXMgPiAkcG9wdWxhdGlvblN1Y2Nlc3NlcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgoJHNhbXBsZU51bWJlciA8PSAwKSB8fCAoJHNhbXBsZU51bWJlciA+ICRwb3B1bGF0aW9uTnVtYmVyKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCgkcG9wdWxhdGlvblN1Y2Nlc3NlcyA8PSAwKSB8fCAoJHBvcHVsYXRpb25TdWNjZXNzZXMgPiAkcG9wdWxhdGlvbk51bWJlcikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9NYXRoVHJpZzo6Q09NQklOKCRwb3B1bGF0aW9uU3VjY2Vzc2VzLCAkc2FtcGxlU3VjY2Vzc2VzKSAqCiAgICAgICAgICAgICAgICAgICBQSFBFeGNlbF9DYWxjdWxhdGlvbl9NYXRoVHJpZzo6Q09NQklOKCRwb3B1bGF0aW9uTnVtYmVyIC0gJHBvcHVsYXRpb25TdWNjZXNzZXMsICRzYW1wbGVOdW1iZXIgLSAkc2FtcGxlU3VjY2Vzc2VzKSAvCiAgICAgICAgICAgICAgICAgICBQSFBFeGNlbF9DYWxjdWxhdGlvbl9NYXRoVHJpZzo6Q09NQklOKCRwb3B1bGF0aW9uTnVtYmVyLCAkc2FtcGxlTnVtYmVyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBJTlRFUkNFUFQKICAgICAqCiAgICAgKiBDYWxjdWxhdGVzIHRoZSBwb2ludCBhdCB3aGljaCBhIGxpbmUgd2lsbCBpbnRlcnNlY3QgdGhlIHktYXhpcyBieSB1c2luZyBleGlzdGluZyB4LXZhbHVlcyBhbmQgeS12YWx1ZXMuCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBZCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFgKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBJTlRFUkNFUFQoJHlWYWx1ZXMsICR4VmFsdWVzKQogICAgewogICAgICAgIGlmICghc2VsZjo6Y2hlY2tUcmVuZEFycmF5cygkeVZhbHVlcywgJHhWYWx1ZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgICR5VmFsdWVDb3VudCA9IGNvdW50KCR5VmFsdWVzKTsKICAgICAgICAkeFZhbHVlQ291bnQgPSBjb3VudCgkeFZhbHVlcyk7CgogICAgICAgIGlmICgoJHlWYWx1ZUNvdW50ID09IDApIHx8ICgkeVZhbHVlQ291bnQgIT0gJHhWYWx1ZUNvdW50KSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwogICAgICAgIH0gZWxzZWlmICgkeVZhbHVlQ291bnQgPT0gMSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgfQoKICAgICAgICAkYmVzdEZpdExpbmVhciA9IHRyZW5kQ2xhc3M6OmNhbGN1bGF0ZSh0cmVuZENsYXNzOjpUUkVORF9MSU5FQVIsICR5VmFsdWVzLCAkeFZhbHVlcyk7CiAgICAgICAgcmV0dXJuICRiZXN0Rml0TGluZWFyLT5nZXRJbnRlcnNlY3QoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBLVVJUCiAgICAgKgogICAgICogUmV0dXJucyB0aGUga3VydG9zaXMgb2YgYSBkYXRhIHNldC4gS3VydG9zaXMgY2hhcmFjdGVyaXplcyB0aGUgcmVsYXRpdmUgcGVha2VkbmVzcwogICAgICogb3IgZmxhdG5lc3Mgb2YgYSBkaXN0cmlidXRpb24gY29tcGFyZWQgd2l0aCB0aGUgbm9ybWFsIGRpc3RyaWJ1dGlvbi4gUG9zaXRpdmUKICAgICAqIGt1cnRvc2lzIGluZGljYXRlcyBhIHJlbGF0aXZlbHkgcGVha2VkIGRpc3RyaWJ1dGlvbi4gTmVnYXRpdmUga3VydG9zaXMgaW5kaWNhdGVzIGEKICAgICAqIHJlbGF0aXZlbHkgZmxhdCBkaXN0cmlidXRpb24uCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5ICAgIERhdGEgU2VyaWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gS1VSVCgpCiAgICB7CiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXlJbmRleGVkKGZ1bmNfZ2V0X2FyZ3MoKSk7CiAgICAgICAgJG1lYW4gPSBzZWxmOjpBVkVSQUdFKCRhQXJncyk7CiAgICAgICAgJHN0ZERldiA9IHNlbGY6OlNUREVWKCRhQXJncyk7CgogICAgICAgIGlmICgkc3RkRGV2ID4gMCkgewogICAgICAgICAgICAkY291bnQgPSAkc3VtbWVyID0gMDsKICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFyZ3VtZW50cwogICAgICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGsgPT4gJGFyZykgewogICAgICAgICAgICAgICAgaWYgKChpc19ib29sKCRhcmcpKSAmJgogICAgICAgICAgICAgICAgICAgICghUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjppc01hdHJpeFZhbHVlKCRrKSkpIHsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdW1tZXIgKz0gcG93KCgoJGFyZyAtICRtZWFuKSAvICRzdGREZXYpLCA0KTsKICAgICAgICAgICAgICAgICAgICAgICAgKyskY291bnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSZXR1cm4KICAgICAgICAgICAgaWYgKCRjb3VudCA+IDMpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkc3VtbWVyICogKCRjb3VudCAqICgkY291bnQrMSkgLyAoKCRjb3VudC0xKSAqICgkY291bnQtMikgKiAoJGNvdW50LTMpKSkgLSAoMyAqIHBvdygkY291bnQtMSwgMikgLyAoKCRjb3VudC0yKSAqICgkY291bnQtMykpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTEFSR0UKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBudGggbGFyZ2VzdCB2YWx1ZSBpbiBhIGRhdGEgc2V0LiBZb3UgY2FuIHVzZSB0aGlzIGZ1bmN0aW9uIHRvCiAgICAgKiAgICAgICAgc2VsZWN0IGEgdmFsdWUgYmFzZWQgb24gaXRzIHJlbGF0aXZlIHN0YW5kaW5nLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIExBUkdFKHZhbHVlMVssdmFsdWUyWywgLi4uXV0sZW50cnkpCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICAgICAgJGVudHJ5ICAgICAgICAgICAgUG9zaXRpb24gKG9yZGVyZWQgZnJvbSB0aGUgbGFyZ2VzdCkgaW4gdGhlIGFycmF5IG9yIHJhbmdlIG9mIGRhdGEgdG8gcmV0dXJuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIExBUkdFKCkKICAgIHsKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheShmdW5jX2dldF9hcmdzKCkpOwoKICAgICAgICAvLyBDYWxjdWxhdGUKICAgICAgICAkZW50cnkgPSBmbG9vcihhcnJheV9wb3AoJGFBcmdzKSk7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkZW50cnkpKSAmJiAoIWlzX3N0cmluZygkZW50cnkpKSkgewogICAgICAgICAgICAkbUFyZ3MgPSBhcnJheSgpOwogICAgICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGFyZykgewogICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgICAgICAkbUFyZ3NbXSA9ICRhcmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGNvdW50ID0gc2VsZjo6Q09VTlQoJG1BcmdzKTsKICAgICAgICAgICAgJGVudHJ5ID0gZmxvb3IoLS0kZW50cnkpOwogICAgICAgICAgICBpZiAoKCRlbnRyeSA8IDApIHx8ICgkZW50cnkgPj0gJGNvdW50KSB8fCAoJGNvdW50ID09IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByc29ydCgkbUFyZ3MpOwogICAgICAgICAgICByZXR1cm4gJG1BcmdzWyRlbnRyeV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTElORVNUCiAgICAgKgogICAgICogQ2FsY3VsYXRlcyB0aGUgc3RhdGlzdGljcyBmb3IgYSBsaW5lIGJ5IHVzaW5nIHRoZSAibGVhc3Qgc3F1YXJlcyIgbWV0aG9kIHRvIGNhbGN1bGF0ZSBhIHN0cmFpZ2h0IGxpbmUgdGhhdCBiZXN0IGZpdHMgeW91ciBkYXRhLAogICAgICogICAgICAgIGFuZCB0aGVuIHJldHVybnMgYW4gYXJyYXkgdGhhdCBkZXNjcmliZXMgdGhlIGxpbmUuCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBZCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFgKICAgICAqIEBwYXJhbSAgICBib29sZWFuICAgICAgICAgICAgICAgIEEgbG9naWNhbCB2YWx1ZSBzcGVjaWZ5aW5nIHdoZXRoZXIgdG8gZm9yY2UgdGhlIGludGVyc2VjdCB0byBlcXVhbCAwLgogICAgICogQHBhcmFtICAgIGJvb2xlYW4gICAgICAgICAgICAgICAgQSBsb2dpY2FsIHZhbHVlIHNwZWNpZnlpbmcgd2hldGhlciB0byByZXR1cm4gYWRkaXRpb25hbCByZWdyZXNzaW9uIHN0YXRpc3RpY3MuCiAgICAgKiBAcmV0dXJuICAgIGFycmF5CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gTElORVNUKCR5VmFsdWVzLCAkeFZhbHVlcyA9IG51bGwsICRjb25zdCA9IHRydWUsICRzdGF0cyA9IGZhbHNlKQogICAgewogICAgICAgICRjb25zdCA9IChpc19udWxsKCRjb25zdCkpID8gdHJ1ZSA6IChib29sZWFuKSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkY29uc3QpOwogICAgICAgICRzdGF0cyA9IChpc19udWxsKCRzdGF0cykpID8gZmFsc2UgOiAoYm9vbGVhbikgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHN0YXRzKTsKICAgICAgICBpZiAoaXNfbnVsbCgkeFZhbHVlcykpIHsKICAgICAgICAgICAgJHhWYWx1ZXMgPSByYW5nZSgxLCBjb3VudChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkeVZhbHVlcykpKTsKICAgICAgICB9CgogICAgICAgIGlmICghc2VsZjo6Y2hlY2tUcmVuZEFycmF5cygkeVZhbHVlcywgJHhWYWx1ZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgICR5VmFsdWVDb3VudCA9IGNvdW50KCR5VmFsdWVzKTsKICAgICAgICAkeFZhbHVlQ291bnQgPSBjb3VudCgkeFZhbHVlcyk7CgoKICAgICAgICBpZiAoKCR5VmFsdWVDb3VudCA9PSAwKSB8fCAoJHlWYWx1ZUNvdW50ICE9ICR4VmFsdWVDb3VudCkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TkEoKTsKICAgICAgICB9IGVsc2VpZiAoJHlWYWx1ZUNvdW50ID09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQoKICAgICAgICAkYmVzdEZpdExpbmVhciA9IHRyZW5kQ2xhc3M6OmNhbGN1bGF0ZSh0cmVuZENsYXNzOjpUUkVORF9MSU5FQVIsICR5VmFsdWVzLCAkeFZhbHVlcywgJGNvbnN0KTsKICAgICAgICBpZiAoJHN0YXRzKSB7CiAgICAgICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgICAgIGFycmF5KAogICAgICAgICAgICAgICAgICAgICRiZXN0Rml0TGluZWFyLT5nZXRTbG9wZSgpLAogICAgICAgICAgICAgICAgICAgICRiZXN0Rml0TGluZWFyLT5nZXRTbG9wZVNFKCksCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRMaW5lYXItPmdldEdvb2RuZXNzT2ZGaXQoKSwKICAgICAgICAgICAgICAgICAgICAkYmVzdEZpdExpbmVhci0+Z2V0RigpLAogICAgICAgICAgICAgICAgICAgICRiZXN0Rml0TGluZWFyLT5nZXRTU1JlZ3Jlc3Npb24oKSwKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBhcnJheSgKICAgICAgICAgICAgICAgICAgICAkYmVzdEZpdExpbmVhci0+Z2V0SW50ZXJzZWN0KCksCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRMaW5lYXItPmdldEludGVyc2VjdFNFKCksCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRMaW5lYXItPmdldFN0ZGV2T2ZSZXNpZHVhbHMoKSwKICAgICAgICAgICAgICAgICAgICAkYmVzdEZpdExpbmVhci0+Z2V0REZSZXNpZHVhbHMoKSwKICAgICAgICAgICAgICAgICAgICAkYmVzdEZpdExpbmVhci0+Z2V0U1NSZXNpZHVhbHMoKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgICAgICRiZXN0Rml0TGluZWFyLT5nZXRTbG9wZSgpLAogICAgICAgICAgICAgICAgJGJlc3RGaXRMaW5lYXItPmdldEludGVyc2VjdCgpCiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIExPR0VTVAogICAgICoKICAgICAqIENhbGN1bGF0ZXMgYW4gZXhwb25lbnRpYWwgY3VydmUgdGhhdCBiZXN0IGZpdHMgdGhlIFggYW5kIFkgZGF0YSBzZXJpZXMsCiAgICAgKiAgICAgICAgYW5kIHRoZW4gcmV0dXJucyBhbiBhcnJheSB0aGF0IGRlc2NyaWJlcyB0aGUgbGluZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFkKICAgICAqIEBwYXJhbSAgICBhcnJheSBvZiBtaXhlZCAgICAgICAgRGF0YSBTZXJpZXMgWAogICAgICogQHBhcmFtICAgIGJvb2xlYW4gICAgICAgICAgICAgICAgQSBsb2dpY2FsIHZhbHVlIHNwZWNpZnlpbmcgd2hldGhlciB0byBmb3JjZSB0aGUgaW50ZXJzZWN0IHRvIGVxdWFsIDAuCiAgICAgKiBAcGFyYW0gICAgYm9vbGVhbiAgICAgICAgICAgICAgICBBIGxvZ2ljYWwgdmFsdWUgc3BlY2lmeWluZyB3aGV0aGVyIHRvIHJldHVybiBhZGRpdGlvbmFsIHJlZ3Jlc3Npb24gc3RhdGlzdGljcy4KICAgICAqIEByZXR1cm4gICAgYXJyYXkKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBMT0dFU1QoJHlWYWx1ZXMsICR4VmFsdWVzID0gbnVsbCwgJGNvbnN0ID0gdHJ1ZSwgJHN0YXRzID0gZmFsc2UpCiAgICB7CiAgICAgICAgJGNvbnN0ID0gKGlzX251bGwoJGNvbnN0KSkgPyB0cnVlIDogKGJvb2xlYW4pIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRjb25zdCk7CiAgICAgICAgJHN0YXRzID0gKGlzX251bGwoJHN0YXRzKSkgPyBmYWxzZSA6IChib29sZWFuKSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc3RhdHMpOwogICAgICAgIGlmIChpc19udWxsKCR4VmFsdWVzKSkgewogICAgICAgICAgICAkeFZhbHVlcyA9IHJhbmdlKDEsIGNvdW50KFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCR5VmFsdWVzKSkpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFzZWxmOjpjaGVja1RyZW5kQXJyYXlzKCR5VmFsdWVzLCAkeFZhbHVlcykpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgJHlWYWx1ZUNvdW50ID0gY291bnQoJHlWYWx1ZXMpOwogICAgICAgICR4VmFsdWVDb3VudCA9IGNvdW50KCR4VmFsdWVzKTsKCiAgICAgICAgZm9yZWFjaCAoJHlWYWx1ZXMgYXMgJHZhbHVlKSB7CiAgICAgICAgICAgIGlmICgkdmFsdWUgPD0gMC4wKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGlmICgoJHlWYWx1ZUNvdW50ID09IDApIHx8ICgkeVZhbHVlQ291bnQgIT0gJHhWYWx1ZUNvdW50KSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwogICAgICAgIH0gZWxzZWlmICgkeVZhbHVlQ291bnQgPT0gMSkgewogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CgogICAgICAgICRiZXN0Rml0RXhwb25lbnRpYWwgPSB0cmVuZENsYXNzOjpjYWxjdWxhdGUodHJlbmRDbGFzczo6VFJFTkRfRVhQT05FTlRJQUwsICR5VmFsdWVzLCAkeFZhbHVlcywgJGNvbnN0KTsKICAgICAgICBpZiAoJHN0YXRzKSB7CiAgICAgICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgICAgIGFycmF5KAogICAgICAgICAgICAgICAgICAgICRiZXN0Rml0RXhwb25lbnRpYWwtPmdldFNsb3BlKCksCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRFeHBvbmVudGlhbC0+Z2V0U2xvcGVTRSgpLAogICAgICAgICAgICAgICAgICAgICRiZXN0Rml0RXhwb25lbnRpYWwtPmdldEdvb2RuZXNzT2ZGaXQoKSwKICAgICAgICAgICAgICAgICAgICAkYmVzdEZpdEV4cG9uZW50aWFsLT5nZXRGKCksCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRFeHBvbmVudGlhbC0+Z2V0U1NSZWdyZXNzaW9uKCksCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgYXJyYXkoCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRFeHBvbmVudGlhbC0+Z2V0SW50ZXJzZWN0KCksCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRFeHBvbmVudGlhbC0+Z2V0SW50ZXJzZWN0U0UoKSwKICAgICAgICAgICAgICAgICAgICAkYmVzdEZpdEV4cG9uZW50aWFsLT5nZXRTdGRldk9mUmVzaWR1YWxzKCksCiAgICAgICAgICAgICAgICAgICAgJGJlc3RGaXRFeHBvbmVudGlhbC0+Z2V0REZSZXNpZHVhbHMoKSwKICAgICAgICAgICAgICAgICAgICAkYmVzdEZpdEV4cG9uZW50aWFsLT5nZXRTU1Jlc2lkdWFscygpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGFycmF5KAogICAgICAgICAgICAgICAgJGJlc3RGaXRFeHBvbmVudGlhbC0+Z2V0U2xvcGUoKSwKICAgICAgICAgICAgICAgICRiZXN0Rml0RXhwb25lbnRpYWwtPmdldEludGVyc2VjdCgpCiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIExPR0lOVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGludmVyc2Ugb2YgdGhlIG5vcm1hbCBjdW11bGF0aXZlIGRpc3RyaWJ1dGlvbgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHByb2JhYmlsaXR5CiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRtZWFuCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRzdGREZXYKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqCiAgICAgKiBAdG9kbyAgICBUcnkgaW1wbGVtZW50aW5nIFAgSiBBY2tsYW0ncyByZWZpbmVtZW50IGFsZ29yaXRobSBmb3IgZ3JlYXRlcgogICAgICogICAgICAgICAgICBhY2N1cmFjeSBpZiBJIGNhbiBnZXQgbXkgaGVhZCByb3VuZCB0aGUgbWF0aGVtYXRpY3MKICAgICAqICAgICAgICAgICAgKGFzIGRlc2NyaWJlZCBhdCkgaHR0cDovL2hvbWUub25saW5lLm5vL35wamFja2xhbS9ub3Rlcy9pbnZub3JtLwogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIExPR0lOVigkcHJvYmFiaWxpdHksICRtZWFuLCAkc3RkRGV2KQogICAgewogICAgICAgICRwcm9iYWJpbGl0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwcm9iYWJpbGl0eSk7CiAgICAgICAgJG1lYW4gICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1lYW4pOwogICAgICAgICRzdGREZXYgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRzdGREZXYpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHByb2JhYmlsaXR5KSkgJiYgKGlzX251bWVyaWMoJG1lYW4pKSAmJiAoaXNfbnVtZXJpYygkc3RkRGV2KSkpIHsKICAgICAgICAgICAgaWYgKCgkcHJvYmFiaWxpdHkgPCAwKSB8fCAoJHByb2JhYmlsaXR5ID4gMSkgfHwgKCRzdGREZXYgPD0gMCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBleHAoJG1lYW4gKyAkc3RkRGV2ICogc2VsZjo6Tk9STVNJTlYoJHByb2JhYmlsaXR5KSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogTE9HTk9STURJU1QKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBjdW11bGF0aXZlIGxvZ25vcm1hbCBkaXN0cmlidXRpb24gb2YgeCwgd2hlcmUgbG4oeCkgaXMgbm9ybWFsbHkgZGlzdHJpYnV0ZWQKICAgICAqIHdpdGggcGFyYW1ldGVycyBtZWFuIGFuZCBzdGFuZGFyZF9kZXYuCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkdmFsdWUKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJG1lYW4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHN0ZERldgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIExPR05PUk1ESVNUKCR2YWx1ZSwgJG1lYW4sICRzdGREZXYpCiAgICB7CiAgICAgICAgJHZhbHVlICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR2YWx1ZSk7CiAgICAgICAgJG1lYW4gICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtZWFuKTsKICAgICAgICAkc3RkRGV2ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHN0ZERldik7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkdmFsdWUpKSAmJiAoaXNfbnVtZXJpYygkbWVhbikpICYmIChpc19udW1lcmljKCRzdGREZXYpKSkgewogICAgICAgICAgICBpZiAoKCR2YWx1ZSA8PSAwKSB8fCAoJHN0ZERldiA8PSAwKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlbGY6Ok5PUk1TRElTVCgobG9nKCR2YWx1ZSkgLSAkbWVhbikgLyAkc3RkRGV2KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBNQVgKICAgICAqCiAgICAgKiBNQVggcmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIGVsZW1lbnQgb2YgdGhlIHZhbHVlcyBwYXNzZWQgdGhhdCBoYXMgdGhlIGhpZ2hlc3QgdmFsdWUsCiAgICAgKiAgICAgICAgd2l0aCBuZWdhdGl2ZSBudW1iZXJzIGNvbnNpZGVyZWQgc21hbGxlciB0aGFuIHBvc2l0aXZlIG51bWJlcnMuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgTUFYKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gTUFYKCkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSBudWxsOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYXJndW1lbnRzCiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoZnVuY19nZXRfYXJncygpKTsKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGFyZykgewogICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICBpZiAoKGlzX251bGwoJHJldHVyblZhbHVlKSkgfHwgKCRhcmcgPiAkcmV0dXJuVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgJHJldHVyblZhbHVlID0gJGFyZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGlzX251bGwoJHJldHVyblZhbHVlKSkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICRyZXR1cm5WYWx1ZTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBNQVhBCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgZ3JlYXRlc3QgdmFsdWUgaW4gYSBsaXN0IG9mIGFyZ3VtZW50cywgaW5jbHVkaW5nIG51bWJlcnMsIHRleHQsIGFuZCBsb2dpY2FsIHZhbHVlcwogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIE1BWEEodmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBNQVhBKCkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSBudWxsOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYXJndW1lbnRzCiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoZnVuY19nZXRfYXJncygpKTsKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGFyZykgewogICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgfHwgKGlzX2Jvb2woJGFyZykpIHx8ICgoaXNfc3RyaW5nKCRhcmcpICYmICgkYXJnICE9ICcnKSkpKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNfYm9vbCgkYXJnKSkgewogICAgICAgICAgICAgICAgICAgICRhcmcgPSAoaW50ZWdlcikgJGFyZzsKICAgICAgICAgICAgICAgIH0gZWxzZWlmIChpc19zdHJpbmcoJGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAkYXJnID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB8fCAoJGFyZyA+ICRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSAkYXJnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKCiAgICAvKioKICAgICAqIE1BWElGCiAgICAgKgogICAgICogQ291bnRzIHRoZSBtYXhpbXVtIHZhbHVlIHdpdGhpbiBhIHJhbmdlIG9mIGNlbGxzIHRoYXQgY29udGFpbiBudW1iZXJzIHdpdGhpbiB0aGUgbGlzdCBvZiBhcmd1bWVudHMKICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBNQVhJRih2YWx1ZTFbLHZhbHVlMlssIC4uLl1dLGNvbmRpdGlvbikKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IE1hdGhlbWF0aWNhbCBhbmQgVHJpZ29ub21ldHJpYyBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcGFyYW0gICAgc3RyaW5nICAgICAgICAkY29uZGl0aW9uICAgICAgICBUaGUgY3JpdGVyaWEgdGhhdCBkZWZpbmVzIHdoaWNoIGNlbGxzIHdpbGwgYmUgY2hlY2tlZC4KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBNQVhJRigkYUFyZ3MsICRjb25kaXRpb24sICRzdW1BcmdzID0gYXJyYXkoKSkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSBudWxsOwoKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkYUFyZ3MpOwogICAgICAgICRzdW1BcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoJHN1bUFyZ3MpOwogICAgICAgIGlmIChlbXB0eSgkc3VtQXJncykpIHsKICAgICAgICAgICAgJHN1bUFyZ3MgPSAkYUFyZ3M7CiAgICAgICAgfQogICAgICAgICRjb25kaXRpb24gPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlmQ29uZGl0aW9uKCRjb25kaXRpb24pOwogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGtleSA9PiAkYXJnKSB7CiAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkYXJnKSkgewogICAgICAgICAgICAgICAgJGFyZyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uOjp3cmFwUmVzdWx0KHN0cnRvdXBwZXIoJGFyZykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICR0ZXN0Q29uZGl0aW9uID0gJz0nLiRhcmcuJGNvbmRpdGlvbjsKICAgICAgICAgICAgaWYgKFBIUEV4Y2VsX0NhbGN1bGF0aW9uOjpnZXRJbnN0YW5jZSgpLT5fY2FsY3VsYXRlRm9ybXVsYVZhbHVlKCR0ZXN0Q29uZGl0aW9uKSkgewogICAgICAgICAgICAgICAgaWYgKChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHx8ICgkYXJnID4gJHJldHVyblZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSA9ICRhcmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBNRURJQU4KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBtZWRpYW4gb2YgdGhlIGdpdmVuIG51bWJlcnMuIFRoZSBtZWRpYW4gaXMgdGhlIG51bWJlciBpbiB0aGUgbWlkZGxlIG9mIGEgc2V0IG9mIG51bWJlcnMuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgTUVESUFOKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gTUVESUFOKCkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwoKICAgICAgICAkbUFyZ3MgPSBhcnJheSgpOwogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheShmdW5jX2dldF9hcmdzKCkpOwogICAgICAgIGZvcmVhY2ggKCRhQXJncyBhcyAkYXJnKSB7CiAgICAgICAgICAgIC8vIElzIGl0IGEgbnVtZXJpYyB2YWx1ZT8KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgICRtQXJnc1tdID0gJGFyZzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJG1WYWx1ZUNvdW50ID0gY291bnQoJG1BcmdzKTsKICAgICAgICBpZiAoJG1WYWx1ZUNvdW50ID4gMCkgewogICAgICAgICAgICBzb3J0KCRtQXJncywgU09SVF9OVU1FUklDKTsKICAgICAgICAgICAgJG1WYWx1ZUNvdW50ID0gJG1WYWx1ZUNvdW50IC8gMjsKICAgICAgICAgICAgaWYgKCRtVmFsdWVDb3VudCA9PSBmbG9vcigkbVZhbHVlQ291bnQpKSB7CiAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSAoJG1BcmdzWyRtVmFsdWVDb3VudC0tXSArICRtQXJnc1skbVZhbHVlQ291bnRdKSAvIDI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkbVZhbHVlQ291bnQgPSBmbG9vcigkbVZhbHVlQ291bnQpOwogICAgICAgICAgICAgICAgJHJldHVyblZhbHVlID0gJG1BcmdzWyRtVmFsdWVDb3VudF07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICB9CgoKICAgIC8qKgogICAgICogTUlOCiAgICAgKgogICAgICogTUlOIHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBlbGVtZW50IG9mIHRoZSB2YWx1ZXMgcGFzc2VkIHRoYXQgaGFzIHRoZSBzbWFsbGVzdCB2YWx1ZSwKICAgICAqICAgICAgICB3aXRoIG5lZ2F0aXZlIG51bWJlcnMgY29uc2lkZXJlZCBzbWFsbGVyIHRoYW4gcG9zaXRpdmUgbnVtYmVycy4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBNSU4odmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBNSU4oKQogICAgewogICAgICAgICRyZXR1cm5WYWx1ZSA9IG51bGw7CgogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheShmdW5jX2dldF9hcmdzKCkpOwogICAgICAgIGZvcmVhY2ggKCRhQXJncyBhcyAkYXJnKSB7CiAgICAgICAgICAgIC8vIElzIGl0IGEgbnVtZXJpYyB2YWx1ZT8KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgIGlmICgoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB8fCAoJGFyZyA8ICRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSAkYXJnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKCiAgICAvKioKICAgICAqIE1JTkEKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBzbWFsbGVzdCB2YWx1ZSBpbiBhIGxpc3Qgb2YgYXJndW1lbnRzLCBpbmNsdWRpbmcgbnVtYmVycywgdGV4dCwgYW5kIGxvZ2ljYWwgdmFsdWVzCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgTUlOQSh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIE1JTkEoKQogICAgewogICAgICAgICRyZXR1cm5WYWx1ZSA9IG51bGw7CgogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheShmdW5jX2dldF9hcmdzKCkpOwogICAgICAgIGZvcmVhY2ggKCRhQXJncyBhcyAkYXJnKSB7CiAgICAgICAgICAgIC8vIElzIGl0IGEgbnVtZXJpYyB2YWx1ZT8KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSB8fCAoaXNfYm9vbCgkYXJnKSkgfHwgKChpc19zdHJpbmcoJGFyZykgJiYgKCRhcmcgIT0gJycpKSkpIHsKICAgICAgICAgICAgICAgIGlmIChpc19ib29sKCRhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgJGFyZyA9IChpbnRlZ2VyKSAkYXJnOwogICAgICAgICAgICAgICAgfSBlbHNlaWYgKGlzX3N0cmluZygkYXJnKSkgewogICAgICAgICAgICAgICAgICAgICRhcmcgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHx8ICgkYXJnIDwgJHJldHVyblZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSA9ICRhcmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICB9CgoKICAgIC8qKgogICAgICogTUlOSUYKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBtaW5pbXVtIHZhbHVlIHdpdGhpbiBhIHJhbmdlIG9mIGNlbGxzIHRoYXQgY29udGFpbiBudW1iZXJzIHdpdGhpbiB0aGUgbGlzdCBvZiBhcmd1bWVudHMKICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBNSU5JRih2YWx1ZTFbLHZhbHVlMlssIC4uLl1dLGNvbmRpdGlvbikKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IE1hdGhlbWF0aWNhbCBhbmQgVHJpZ29ub21ldHJpYyBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcGFyYW0gICAgc3RyaW5nICAgICAgICAkY29uZGl0aW9uICAgICAgICBUaGUgY3JpdGVyaWEgdGhhdCBkZWZpbmVzIHdoaWNoIGNlbGxzIHdpbGwgYmUgY2hlY2tlZC4KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBNSU5JRigkYUFyZ3MsICRjb25kaXRpb24sICRzdW1BcmdzID0gYXJyYXkoKSkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSBudWxsOwoKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkYUFyZ3MpOwogICAgICAgICRzdW1BcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoJHN1bUFyZ3MpOwogICAgICAgIGlmIChlbXB0eSgkc3VtQXJncykpIHsKICAgICAgICAgICAgJHN1bUFyZ3MgPSAkYUFyZ3M7CiAgICAgICAgfQogICAgICAgICRjb25kaXRpb24gPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlmQ29uZGl0aW9uKCRjb25kaXRpb24pOwogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGtleSA9PiAkYXJnKSB7CiAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkYXJnKSkgewogICAgICAgICAgICAgICAgJGFyZyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uOjp3cmFwUmVzdWx0KHN0cnRvdXBwZXIoJGFyZykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICR0ZXN0Q29uZGl0aW9uID0gJz0nLiRhcmcuJGNvbmRpdGlvbjsKICAgICAgICAgICAgaWYgKFBIUEV4Y2VsX0NhbGN1bGF0aW9uOjpnZXRJbnN0YW5jZSgpLT5fY2FsY3VsYXRlRm9ybXVsYVZhbHVlKCR0ZXN0Q29uZGl0aW9uKSkgewogICAgICAgICAgICAgICAgaWYgKChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHx8ICgkYXJnIDwgJHJldHVyblZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSA9ICRhcmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICB9CgoKICAgIC8vCiAgICAvLyAgICBTcGVjaWFsIHZhcmlhbnQgb2YgYXJyYXlfY291bnRfdmFsdWVzIHRoYXQgaXNuJ3QgbGltaXRlZCB0byBzdHJpbmdzIGFuZCBpbnRlZ2VycywKICAgIC8vICAgICAgICBidXQgY2FuIHdvcmsgd2l0aCBmbG9hdGluZyBwb2ludCBudW1iZXJzIGFzIHZhbHVlcwogICAgLy8KICAgIHByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIG1vZGVDYWxjKCRkYXRhKQogICAgewogICAgICAgICRmcmVxdWVuY3lBcnJheSA9IGFycmF5KCk7CiAgICAgICAgZm9yZWFjaCAoJGRhdGEgYXMgJGRhdHVtKSB7CiAgICAgICAgICAgICRmb3VuZCA9IGZhbHNlOwogICAgICAgICAgICBmb3JlYWNoICgkZnJlcXVlbmN5QXJyYXkgYXMgJGtleSA9PiAkdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICgoc3RyaW5nKSAkdmFsdWVbJ3ZhbHVlJ10gPT0gKHN0cmluZykgJGRhdHVtKSB7CiAgICAgICAgICAgICAgICAgICAgKyskZnJlcXVlbmN5QXJyYXlbJGtleV1bJ2ZyZXF1ZW5jeSddOwogICAgICAgICAgICAgICAgICAgICRmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEkZm91bmQpIHsKICAgICAgICAgICAgICAgICRmcmVxdWVuY3lBcnJheVtdID0gYXJyYXkoCiAgICAgICAgICAgICAgICAgICAgJ3ZhbHVlJyAgICAgPT4gJGRhdHVtLAogICAgICAgICAgICAgICAgICAgICdmcmVxdWVuY3knID0+IDEKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvcmVhY2ggKCRmcmVxdWVuY3lBcnJheSBhcyAka2V5ID0+ICR2YWx1ZSkgewogICAgICAgICAgICAkZnJlcXVlbmN5TGlzdFska2V5XSA9ICR2YWx1ZVsnZnJlcXVlbmN5J107CiAgICAgICAgICAgICR2YWx1ZUxpc3RbJGtleV0gPSAkdmFsdWVbJ3ZhbHVlJ107CiAgICAgICAgfQogICAgICAgIGFycmF5X211bHRpc29ydCgkZnJlcXVlbmN5TGlzdCwgU09SVF9ERVNDLCAkdmFsdWVMaXN0LCBTT1JUX0FTQywgU09SVF9OVU1FUklDLCAkZnJlcXVlbmN5QXJyYXkpOwoKICAgICAgICBpZiAoJGZyZXF1ZW5jeUFycmF5WzBdWydmcmVxdWVuY3knXSA9PSAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5BKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkZnJlcXVlbmN5QXJyYXlbMF1bJ3ZhbHVlJ107CiAgICB9CgoKICAgIC8qKgogICAgICogTU9ERQogICAgICoKICAgICAqIFJldHVybnMgdGhlIG1vc3QgZnJlcXVlbnRseSBvY2N1cnJpbmcsIG9yIHJlcGV0aXRpdmUsIHZhbHVlIGluIGFuIGFycmF5IG9yIHJhbmdlIG9mIGRhdGEKICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBNT0RFKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gTU9ERSgpCiAgICB7CiAgICAgICAgJHJldHVyblZhbHVlID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYXJndW1lbnRzCiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoZnVuY19nZXRfYXJncygpKTsKCiAgICAgICAgJG1BcmdzID0gYXJyYXkoKTsKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGFyZykgewogICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICAkbUFyZ3NbXSA9ICRhcmc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghZW1wdHkoJG1BcmdzKSkgewogICAgICAgICAgICByZXR1cm4gc2VsZjo6bW9kZUNhbGMoJG1BcmdzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICB9CgoKICAgIC8qKgogICAgICogTkVHQklOT01ESVNUCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbmVnYXRpdmUgYmlub21pYWwgZGlzdHJpYnV0aW9uLiBORUdCSU5PTURJU1QgcmV0dXJucyB0aGUgcHJvYmFiaWxpdHkgdGhhdAogICAgICogICAgICAgIHRoZXJlIHdpbGwgYmUgbnVtYmVyX2YgZmFpbHVyZXMgYmVmb3JlIHRoZSBudW1iZXJfcy10aCBzdWNjZXNzLCB3aGVuIHRoZSBjb25zdGFudAogICAgICogICAgICAgIHByb2JhYmlsaXR5IG9mIGEgc3VjY2VzcyBpcyBwcm9iYWJpbGl0eV9zLiBUaGlzIGZ1bmN0aW9uIGlzIHNpbWlsYXIgdG8gdGhlIGJpbm9taWFsCiAgICAgKiAgICAgICAgZGlzdHJpYnV0aW9uLCBleGNlcHQgdGhhdCB0aGUgbnVtYmVyIG9mIHN1Y2Nlc3NlcyBpcyBmaXhlZCwgYW5kIHRoZSBudW1iZXIgb2YgdHJpYWxzIGlzCiAgICAgKiAgICAgICAgdmFyaWFibGUuIExpa2UgdGhlIGJpbm9taWFsLCB0cmlhbHMgYXJlIGFzc3VtZWQgdG8gYmUgaW5kZXBlbmRlbnQuCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkZmFpbHVyZXMgICAgICAgIE51bWJlciBvZiBGYWlsdXJlcwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkc3VjY2Vzc2VzICAgICAgICBUaHJlc2hvbGQgbnVtYmVyIG9mIFN1Y2Nlc3NlcwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkcHJvYmFiaWxpdHkgICAgUHJvYmFiaWxpdHkgb2Ygc3VjY2VzcyBvbiBlYWNoIHRyaWFsCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIE5FR0JJTk9NRElTVCgkZmFpbHVyZXMsICRzdWNjZXNzZXMsICRwcm9iYWJpbGl0eSkKICAgIHsKICAgICAgICAkZmFpbHVyZXMgICAgPSBmbG9vcihQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZmFpbHVyZXMpKTsKICAgICAgICAkc3VjY2Vzc2VzICAgPSBmbG9vcihQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc3VjY2Vzc2VzKSk7CiAgICAgICAgJHByb2JhYmlsaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHByb2JhYmlsaXR5KTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCRmYWlsdXJlcykpICYmIChpc19udW1lcmljKCRzdWNjZXNzZXMpKSAmJiAoaXNfbnVtZXJpYygkcHJvYmFiaWxpdHkpKSkgewogICAgICAgICAgICBpZiAoKCRmYWlsdXJlcyA8IDApIHx8ICgkc3VjY2Vzc2VzIDwgMSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9IGVsc2VpZiAoKCRwcm9iYWJpbGl0eSA8IDApIHx8ICgkcHJvYmFiaWxpdHkgPiAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Z2V0Q29tcGF0aWJpbGl0eU1vZGUoKSA9PSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkNPTVBBVElCSUxJVFlfR05VTUVSSUMpIHsKICAgICAgICAgICAgICAgIGlmICgoJGZhaWx1cmVzICsgJHN1Y2Nlc3NlcyAtIDEpIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX01hdGhUcmlnOjpDT01CSU4oJGZhaWx1cmVzICsgJHN1Y2Nlc3NlcyAtIDEsICRzdWNjZXNzZXMgLSAxKSkgKiAocG93KCRwcm9iYWJpbGl0eSwgJHN1Y2Nlc3NlcykpICogKHBvdygxIC0gJHByb2JhYmlsaXR5LCAkZmFpbHVyZXMpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBOT1JNRElTVAogICAgICoKICAgICAqIFJldHVybnMgdGhlIG5vcm1hbCBkaXN0cmlidXRpb24gZm9yIHRoZSBzcGVjaWZpZWQgbWVhbiBhbmQgc3RhbmRhcmQgZGV2aWF0aW9uLiBUaGlzCiAgICAgKiBmdW5jdGlvbiBoYXMgYSB2ZXJ5IHdpZGUgcmFuZ2Ugb2YgYXBwbGljYXRpb25zIGluIHN0YXRpc3RpY3MsIGluY2x1ZGluZyBoeXBvdGhlc2lzCiAgICAgKiB0ZXN0aW5nLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHZhbHVlCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRtZWFuICAgICAgICBNZWFuIFZhbHVlCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRzdGREZXYgICAgICAgIFN0YW5kYXJkIERldmlhdGlvbgogICAgICogQHBhcmFtICAgIGJvb2xlYW4gICAgICAgICRjdW11bGF0aXZlCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIE5PUk1ESVNUKCR2YWx1ZSwgJG1lYW4sICRzdGREZXYsICRjdW11bGF0aXZlKQogICAgewogICAgICAgICR2YWx1ZSAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdmFsdWUpOwogICAgICAgICRtZWFuICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbWVhbik7CiAgICAgICAgJHN0ZERldiA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRzdGREZXYpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHZhbHVlKSkgJiYgKGlzX251bWVyaWMoJG1lYW4pKSAmJiAoaXNfbnVtZXJpYygkc3RkRGV2KSkpIHsKICAgICAgICAgICAgaWYgKCRzdGREZXYgPCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGN1bXVsYXRpdmUpKSB8fCAoaXNfYm9vbCgkY3VtdWxhdGl2ZSkpKSB7CiAgICAgICAgICAgICAgICBpZiAoJGN1bXVsYXRpdmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMC41ICogKDEgKyBQSFBFeGNlbF9DYWxjdWxhdGlvbl9FbmdpbmVlcmluZzo6ZXJmVmFsKCgkdmFsdWUgLSAkbWVhbikgLyAoJHN0ZERldiAqIHNxcnQoMikpKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoMSAvIChTUVJUMlBJICogJHN0ZERldikpICogZXhwKDAgLSAocG93KCR2YWx1ZSAtICRtZWFuLCAyKSAvICgyICogKCRzdGREZXYgKiAkc3RkRGV2KSkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIE5PUk1JTlYKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBpbnZlcnNlIG9mIHRoZSBub3JtYWwgY3VtdWxhdGl2ZSBkaXN0cmlidXRpb24gZm9yIHRoZSBzcGVjaWZpZWQgbWVhbiBhbmQgc3RhbmRhcmQgZGV2aWF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHZhbHVlCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRtZWFuICAgICAgICBNZWFuIFZhbHVlCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRzdGREZXYgICAgICAgIFN0YW5kYXJkIERldmlhdGlvbgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICoKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBOT1JNSU5WKCRwcm9iYWJpbGl0eSwgJG1lYW4sICRzdGREZXYpCiAgICB7CiAgICAgICAgJHByb2JhYmlsaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHByb2JhYmlsaXR5KTsKICAgICAgICAkbWVhbiAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbWVhbik7CiAgICAgICAgJHN0ZERldiAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHN0ZERldik7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkcHJvYmFiaWxpdHkpKSAmJiAoaXNfbnVtZXJpYygkbWVhbikpICYmIChpc19udW1lcmljKCRzdGREZXYpKSkgewogICAgICAgICAgICBpZiAoKCRwcm9iYWJpbGl0eSA8IDApIHx8ICgkcHJvYmFiaWxpdHkgPiAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCRzdGREZXYgPCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHNlbGY6OmludmVyc2VOY2RmKCRwcm9iYWJpbGl0eSkgKiAkc3RkRGV2KSArICRtZWFuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIE5PUk1TRElTVAogICAgICoKICAgICAqIFJldHVybnMgdGhlIHN0YW5kYXJkIG5vcm1hbCBjdW11bGF0aXZlIGRpc3RyaWJ1dGlvbiBmdW5jdGlvbi4gVGhlIGRpc3RyaWJ1dGlvbiBoYXMKICAgICAqIGEgbWVhbiBvZiAwICh6ZXJvKSBhbmQgYSBzdGFuZGFyZCBkZXZpYXRpb24gb2Ygb25lLiBVc2UgdGhpcyBmdW5jdGlvbiBpbiBwbGFjZSBvZiBhCiAgICAgKiB0YWJsZSBvZiBzdGFuZGFyZCBub3JtYWwgY3VydmUgYXJlYXMuCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkdmFsdWUKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBOT1JNU0RJU1QoJHZhbHVlKQogICAgewogICAgICAgICR2YWx1ZSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR2YWx1ZSk7CgogICAgICAgIHJldHVybiBzZWxmOjpOT1JNRElTVCgkdmFsdWUsIDAsIDEsIHRydWUpOwogICAgfQoKCiAgICAvKioKICAgICAqIE5PUk1TSU5WCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgaW52ZXJzZSBvZiB0aGUgc3RhbmRhcmQgbm9ybWFsIGN1bXVsYXRpdmUgZGlzdHJpYnV0aW9uCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkdmFsdWUKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBOT1JNU0lOVigkdmFsdWUpCiAgICB7CiAgICAgICAgcmV0dXJuIHNlbGY6Ok5PUk1JTlYoJHZhbHVlLCAwLCAxKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBQRVJDRU5USUxFCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbnRoIHBlcmNlbnRpbGUgb2YgdmFsdWVzIGluIGEgcmFuZ2UuLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIFBFUkNFTlRJTEUodmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSxlbnRyeSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJGVudHJ5ICAgICAgICAgICAgUGVyY2VudGlsZSB2YWx1ZSBpbiB0aGUgcmFuZ2UgMC4uMSwgaW5jbHVzaXZlLgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFBFUkNFTlRJTEUoKQogICAgewogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KGZ1bmNfZ2V0X2FyZ3MoKSk7CgogICAgICAgIC8vIENhbGN1bGF0ZQogICAgICAgICRlbnRyeSA9IGFycmF5X3BvcCgkYUFyZ3MpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJGVudHJ5KSkgJiYgKCFpc19zdHJpbmcoJGVudHJ5KSkpIHsKICAgICAgICAgICAgaWYgKCgkZW50cnkgPCAwKSB8fCAoJGVudHJ5ID4gMSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRtQXJncyA9IGFycmF5KCk7CiAgICAgICAgICAgIGZvcmVhY2ggKCRhQXJncyBhcyAkYXJnKSB7CiAgICAgICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGFyZykpICYmICghaXNfc3RyaW5nKCRhcmcpKSkgewogICAgICAgICAgICAgICAgICAgICRtQXJnc1tdID0gJGFyZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAkbVZhbHVlQ291bnQgPSBjb3VudCgkbUFyZ3MpOwogICAgICAgICAgICBpZiAoJG1WYWx1ZUNvdW50ID4gMCkgewogICAgICAgICAgICAgICAgc29ydCgkbUFyZ3MpOwogICAgICAgICAgICAgICAgJGNvdW50ID0gc2VsZjo6Q09VTlQoJG1BcmdzKTsKICAgICAgICAgICAgICAgICRpbmRleCA9ICRlbnRyeSAqICgkY291bnQtMSk7CiAgICAgICAgICAgICAgICAkaUJhc2UgPSBmbG9vcigkaW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKCRpbmRleCA9PSAkaUJhc2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJG1BcmdzWyRpbmRleF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRpTmV4dCA9ICRpQmFzZSArIDE7CiAgICAgICAgICAgICAgICAgICAgJGlQcm9wb3J0aW9uID0gJGluZGV4IC0gJGlCYXNlOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAkbUFyZ3NbJGlCYXNlXSArICgoJG1BcmdzWyRpTmV4dF0gLSAkbUFyZ3NbJGlCYXNlXSkgKiAkaVByb3BvcnRpb24pIDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIFBFUkNFTlRSQU5LCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgcmFuayBvZiBhIHZhbHVlIGluIGEgZGF0YSBzZXQgYXMgYSBwZXJjZW50YWdlIG9mIHRoZSBkYXRhIHNldC4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbnVtYmVyICAgICAgICBBbiBhcnJheSBvZiwgb3IgYSByZWZlcmVuY2UgdG8sIGEgbGlzdCBvZiBudW1iZXJzLgogICAgICogQHBhcmFtICAgIG51bWJlciAgICAgICAgICAgICAgICBUaGUgbnVtYmVyIHdob3NlIHJhbmsgeW91IHdhbnQgdG8gZmluZC4KICAgICAqIEBwYXJhbSAgICBudW1iZXIgICAgICAgICAgICAgICAgVGhlIG51bWJlciBvZiBzaWduaWZpY2FudCBkaWdpdHMgZm9yIHRoZSByZXR1cm5lZCBwZXJjZW50YWdlIHZhbHVlLgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFBFUkNFTlRSQU5LKCR2YWx1ZVNldCwgJHZhbHVlLCAkc2lnbmlmaWNhbmNlID0gMykKICAgIHsKICAgICAgICAkdmFsdWVTZXQgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoJHZhbHVlU2V0KTsKICAgICAgICAkdmFsdWUgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKTsKICAgICAgICAkc2lnbmlmaWNhbmNlID0gKGlzX251bGwoJHNpZ25pZmljYW5jZSkpID8gMyA6IChpbnRlZ2VyKSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2lnbmlmaWNhbmNlKTsKCiAgICAgICAgZm9yZWFjaCAoJHZhbHVlU2V0IGFzICRrZXkgPT4gJHZhbHVlRW50cnkpIHsKICAgICAgICAgICAgaWYgKCFpc19udW1lcmljKCR2YWx1ZUVudHJ5KSkgewogICAgICAgICAgICAgICAgdW5zZXQoJHZhbHVlU2V0WyRrZXldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzb3J0KCR2YWx1ZVNldCwgU09SVF9OVU1FUklDKTsKICAgICAgICAkdmFsdWVDb3VudCA9IGNvdW50KCR2YWx1ZVNldCk7CiAgICAgICAgaWYgKCR2YWx1ZUNvdW50ID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgfQoKICAgICAgICAkdmFsdWVBZGp1c3RvciA9ICR2YWx1ZUNvdW50IC0gMTsKICAgICAgICBpZiAoKCR2YWx1ZSA8ICR2YWx1ZVNldFswXSkgfHwgKCR2YWx1ZSA+ICR2YWx1ZVNldFskdmFsdWVBZGp1c3Rvcl0pKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5BKCk7CiAgICAgICAgfQoKICAgICAgICAkcG9zID0gYXJyYXlfc2VhcmNoKCR2YWx1ZSwgJHZhbHVlU2V0KTsKICAgICAgICBpZiAoJHBvcyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgJHBvcyA9IDA7CiAgICAgICAgICAgICR0ZXN0VmFsdWUgPSAkdmFsdWVTZXRbMF07CiAgICAgICAgICAgIHdoaWxlICgkdGVzdFZhbHVlIDwgJHZhbHVlKSB7CiAgICAgICAgICAgICAgICAkdGVzdFZhbHVlID0gJHZhbHVlU2V0WysrJHBvc107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLS0kcG9zOwogICAgICAgICAgICAkcG9zICs9ICgoJHZhbHVlIC0gJHZhbHVlU2V0WyRwb3NdKSAvICgkdGVzdFZhbHVlIC0gJHZhbHVlU2V0WyRwb3NdKSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcm91bmQoJHBvcyAvICR2YWx1ZUFkanVzdG9yLCAkc2lnbmlmaWNhbmNlKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBQRVJNVVQKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgcGVybXV0YXRpb25zIGZvciBhIGdpdmVuIG51bWJlciBvZiBvYmplY3RzIHRoYXQgY2FuIGJlCiAgICAgKiAgICAgICAgc2VsZWN0ZWQgZnJvbSBudW1iZXIgb2JqZWN0cy4gQSBwZXJtdXRhdGlvbiBpcyBhbnkgc2V0IG9yIHN1YnNldCBvZiBvYmplY3RzIG9yCiAgICAgKiAgICAgICAgZXZlbnRzIHdoZXJlIGludGVybmFsIG9yZGVyIGlzIHNpZ25pZmljYW50LiBQZXJtdXRhdGlvbnMgYXJlIGRpZmZlcmVudCBmcm9tCiAgICAgKiAgICAgICAgY29tYmluYXRpb25zLCBmb3Igd2hpY2ggdGhlIGludGVybmFsIG9yZGVyIGlzIG5vdCBzaWduaWZpY2FudC4gVXNlIHRoaXMgZnVuY3Rpb24KICAgICAqICAgICAgICBmb3IgbG90dGVyeS1zdHlsZSBwcm9iYWJpbGl0eSBjYWxjdWxhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtICAgIGludCAgICAgICAgJG51bU9ianMgICAgTnVtYmVyIG9mIGRpZmZlcmVudCBvYmplY3RzCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICAkbnVtSW5TZXQgICAgTnVtYmVyIG9mIG9iamVjdHMgaW4gZWFjaCBwZXJtdXRhdGlvbgogICAgICogQHJldHVybiAgICBpbnQgICAgICAgIE51bWJlciBvZiBwZXJtdXRhdGlvbnMKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBQRVJNVVQoJG51bU9ianMsICRudW1JblNldCkKICAgIHsKICAgICAgICAkbnVtT2JqcyAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbnVtT2Jqcyk7CiAgICAgICAgJG51bUluU2V0ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG51bUluU2V0KTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCRudW1PYmpzKSkgJiYgKGlzX251bWVyaWMoJG51bUluU2V0KSkpIHsKICAgICAgICAgICAgJG51bUluU2V0ID0gZmxvb3IoJG51bUluU2V0KTsKICAgICAgICAgICAgaWYgKCRudW1PYmpzIDwgJG51bUluU2V0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcm91bmQoUEhQRXhjZWxfQ2FsY3VsYXRpb25fTWF0aFRyaWc6OkZBQ1QoJG51bU9ianMpIC8gUEhQRXhjZWxfQ2FsY3VsYXRpb25fTWF0aFRyaWc6OkZBQ1QoJG51bU9ianMgLSAkbnVtSW5TZXQpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBQT0lTU09OCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgUG9pc3NvbiBkaXN0cmlidXRpb24uIEEgY29tbW9uIGFwcGxpY2F0aW9uIG9mIHRoZSBQb2lzc29uIGRpc3RyaWJ1dGlvbgogICAgICogaXMgcHJlZGljdGluZyB0aGUgbnVtYmVyIG9mIGV2ZW50cyBvdmVyIGEgc3BlY2lmaWMgdGltZSwgc3VjaCBhcyB0aGUgbnVtYmVyIG9mCiAgICAgKiBjYXJzIGFycml2aW5nIGF0IGEgdG9sbCBwbGF6YSBpbiAxIG1pbnV0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICR2YWx1ZQogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkbWVhbiAgICAgICAgTWVhbiBWYWx1ZQogICAgICogQHBhcmFtICAgIGJvb2xlYW4gICAgICAgICRjdW11bGF0aXZlCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKgogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFBPSVNTT04oJHZhbHVlLCAkbWVhbiwgJGN1bXVsYXRpdmUpCiAgICB7CiAgICAgICAgJHZhbHVlID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKTsKICAgICAgICAkbWVhbiAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbWVhbik7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkdmFsdWUpKSAmJiAoaXNfbnVtZXJpYygkbWVhbikpKSB7CiAgICAgICAgICAgIGlmICgoJHZhbHVlIDwgMCkgfHwgKCRtZWFuIDw9IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGN1bXVsYXRpdmUpKSB8fCAoaXNfYm9vbCgkY3VtdWxhdGl2ZSkpKSB7CiAgICAgICAgICAgICAgICBpZiAoJGN1bXVsYXRpdmUpIHsKICAgICAgICAgICAgICAgICAgICAkc3VtbWVyID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKCRpID0gMDsgJGkgPD0gZmxvb3IoJHZhbHVlKTsgKyskaSkgewogICAgICAgICAgICAgICAgICAgICAgICAkc3VtbWVyICs9IHBvdygkbWVhbiwgJGkpIC8gUEhQRXhjZWxfQ2FsY3VsYXRpb25fTWF0aFRyaWc6OkZBQ1QoJGkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwKDAtJG1lYW4pICogJHN1bW1lcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChleHAoMC0kbWVhbikgKiBwb3coJG1lYW4sICR2YWx1ZSkpIC8gUEhQRXhjZWxfQ2FsY3VsYXRpb25fTWF0aFRyaWc6OkZBQ1QoJHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIFFVQVJUSUxFCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgcXVhcnRpbGUgb2YgYSBkYXRhIHNldC4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBRVUFSVElMRSh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dLGVudHJ5KQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHBhcmFtICAgIGludCAgICAgICAgICAgICRlbnRyeSAgICAgICAgICAgIFF1YXJ0aWxlIHZhbHVlIGluIHRoZSByYW5nZSAxLi4zLCBpbmNsdXNpdmUuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gUVVBUlRJTEUoKQogICAgewogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KGZ1bmNfZ2V0X2FyZ3MoKSk7CgogICAgICAgIC8vIENhbGN1bGF0ZQogICAgICAgICRlbnRyeSA9IGZsb29yKGFycmF5X3BvcCgkYUFyZ3MpKTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCRlbnRyeSkpICYmICghaXNfc3RyaW5nKCRlbnRyeSkpKSB7CiAgICAgICAgICAgICRlbnRyeSAvPSA0OwogICAgICAgICAgICBpZiAoKCRlbnRyeSA8IDApIHx8ICgkZW50cnkgPiAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlbGY6OlBFUkNFTlRJTEUoJGFBcmdzLCAkZW50cnkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIFJBTksKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSByYW5rIG9mIGEgbnVtYmVyIGluIGEgbGlzdCBvZiBudW1iZXJzLgogICAgICoKICAgICAqIEBwYXJhbSAgICBudW1iZXIgICAgICAgICAgICAgICAgVGhlIG51bWJlciB3aG9zZSByYW5rIHlvdSB3YW50IHRvIGZpbmQuCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbnVtYmVyICAgICAgICBBbiBhcnJheSBvZiwgb3IgYSByZWZlcmVuY2UgdG8sIGEgbGlzdCBvZiBudW1iZXJzLgogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAgICAgICAgIE9yZGVyIHRvIHNvcnQgdGhlIHZhbHVlcyBpbiB0aGUgdmFsdWUgc2V0CiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gUkFOSygkdmFsdWUsICR2YWx1ZVNldCwgJG9yZGVyID0gMCkKICAgIHsKICAgICAgICAkdmFsdWUgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdmFsdWUpOwogICAgICAgICR2YWx1ZVNldCA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCR2YWx1ZVNldCk7CiAgICAgICAgJG9yZGVyID0gKGlzX251bGwoJG9yZGVyKSkgPyAwIDogKGludGVnZXIpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRvcmRlcik7CgogICAgICAgIGZvcmVhY2ggKCR2YWx1ZVNldCBhcyAka2V5ID0+ICR2YWx1ZUVudHJ5KSB7CiAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkdmFsdWVFbnRyeSkpIHsKICAgICAgICAgICAgICAgIHVuc2V0KCR2YWx1ZVNldFska2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICgkb3JkZXIgPT0gMCkgewogICAgICAgICAgICByc29ydCgkdmFsdWVTZXQsIFNPUlRfTlVNRVJJQyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc29ydCgkdmFsdWVTZXQsIFNPUlRfTlVNRVJJQyk7CiAgICAgICAgfQogICAgICAgICRwb3MgPSBhcnJheV9zZWFyY2goJHZhbHVlLCAkdmFsdWVTZXQpOwogICAgICAgIGlmICgkcG9zID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICsrJHBvczsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSU1EKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBzcXVhcmUgb2YgdGhlIFBlYXJzb24gcHJvZHVjdCBtb21lbnQgY29ycmVsYXRpb24gY29lZmZpY2llbnQgdGhyb3VnaCBkYXRhIHBvaW50cyBpbiBrbm93bl95J3MgYW5kIGtub3duX3gncy4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFkKICAgICAqIEBwYXJhbSAgICBhcnJheSBvZiBtaXhlZCAgICAgICAgRGF0YSBTZXJpZXMgWAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFJTUSgkeVZhbHVlcywgJHhWYWx1ZXMpCiAgICB7CiAgICAgICAgaWYgKCFzZWxmOjpjaGVja1RyZW5kQXJyYXlzKCR5VmFsdWVzLCAkeFZhbHVlcykpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgJHlWYWx1ZUNvdW50ID0gY291bnQoJHlWYWx1ZXMpOwogICAgICAgICR4VmFsdWVDb3VudCA9IGNvdW50KCR4VmFsdWVzKTsKCiAgICAgICAgaWYgKCgkeVZhbHVlQ291bnQgPT0gMCkgfHwgKCR5VmFsdWVDb3VudCAhPSAkeFZhbHVlQ291bnQpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5BKCk7CiAgICAgICAgfSBlbHNlaWYgKCR5VmFsdWVDb3VudCA9PSAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkRJVjAoKTsKICAgICAgICB9CgogICAgICAgICRiZXN0Rml0TGluZWFyID0gdHJlbmRDbGFzczo6Y2FsY3VsYXRlKHRyZW5kQ2xhc3M6OlRSRU5EX0xJTkVBUiwgJHlWYWx1ZXMsICR4VmFsdWVzKTsKICAgICAgICByZXR1cm4gJGJlc3RGaXRMaW5lYXItPmdldEdvb2RuZXNzT2ZGaXQoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTS0VXCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgc2tld25lc3Mgb2YgYSBkaXN0cmlidXRpb24uIFNrZXduZXNzIGNoYXJhY3Rlcml6ZXMgdGhlIGRlZ3JlZSBvZiBhc3ltbWV0cnkKICAgICAqIG9mIGEgZGlzdHJpYnV0aW9uIGFyb3VuZCBpdHMgbWVhbi4gUG9zaXRpdmUgc2tld25lc3MgaW5kaWNhdGVzIGEgZGlzdHJpYnV0aW9uIHdpdGggYW4KICAgICAqIGFzeW1tZXRyaWMgdGFpbCBleHRlbmRpbmcgdG93YXJkIG1vcmUgcG9zaXRpdmUgdmFsdWVzLiBOZWdhdGl2ZSBza2V3bmVzcyBpbmRpY2F0ZXMgYQogICAgICogZGlzdHJpYnV0aW9uIHdpdGggYW4gYXN5bW1ldHJpYyB0YWlsIGV4dGVuZGluZyB0b3dhcmQgbW9yZSBuZWdhdGl2ZSB2YWx1ZXMuCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5ICAgIERhdGEgU2VyaWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gU0tFVygpCiAgICB7CiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXlJbmRleGVkKGZ1bmNfZ2V0X2FyZ3MoKSk7CiAgICAgICAgJG1lYW4gPSBzZWxmOjpBVkVSQUdFKCRhQXJncyk7CiAgICAgICAgJHN0ZERldiA9IHNlbGY6OlNUREVWKCRhQXJncyk7CgogICAgICAgICRjb3VudCA9ICRzdW1tZXIgPSAwOwogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGsgPT4gJGFyZykgewogICAgICAgICAgICBpZiAoKGlzX2Jvb2woJGFyZykpICYmCiAgICAgICAgICAgICAgICAoIVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6aXNNYXRyaXhWYWx1ZSgkaykpKSB7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGFyZykpICYmICghaXNfc3RyaW5nKCRhcmcpKSkgewogICAgICAgICAgICAgICAgICAgICRzdW1tZXIgKz0gcG93KCgoJGFyZyAtICRtZWFuKSAvICRzdGREZXYpLCAzKTsKICAgICAgICAgICAgICAgICAgICArKyRjb3VudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCRjb3VudCA+IDIpIHsKICAgICAgICAgICAgcmV0dXJuICRzdW1tZXIgKiAoJGNvdW50IC8gKCgkY291bnQtMSkgKiAoJGNvdW50LTIpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkRJVjAoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTTE9QRQogICAgICoKICAgICAqIFJldHVybnMgdGhlIHNsb3BlIG9mIHRoZSBsaW5lYXIgcmVncmVzc2lvbiBsaW5lIHRocm91Z2ggZGF0YSBwb2ludHMgaW4ga25vd25feSdzIGFuZCBrbm93bl94J3MuCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBZCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFgKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBTTE9QRSgkeVZhbHVlcywgJHhWYWx1ZXMpCiAgICB7CiAgICAgICAgaWYgKCFzZWxmOjpjaGVja1RyZW5kQXJyYXlzKCR5VmFsdWVzLCAkeFZhbHVlcykpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgJHlWYWx1ZUNvdW50ID0gY291bnQoJHlWYWx1ZXMpOwogICAgICAgICR4VmFsdWVDb3VudCA9IGNvdW50KCR4VmFsdWVzKTsKCiAgICAgICAgaWYgKCgkeVZhbHVlQ291bnQgPT0gMCkgfHwgKCR5VmFsdWVDb3VudCAhPSAkeFZhbHVlQ291bnQpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5BKCk7CiAgICAgICAgfSBlbHNlaWYgKCR5VmFsdWVDb3VudCA9PSAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkRJVjAoKTsKICAgICAgICB9CgogICAgICAgICRiZXN0Rml0TGluZWFyID0gdHJlbmRDbGFzczo6Y2FsY3VsYXRlKHRyZW5kQ2xhc3M6OlRSRU5EX0xJTkVBUiwgJHlWYWx1ZXMsICR4VmFsdWVzKTsKICAgICAgICByZXR1cm4gJGJlc3RGaXRMaW5lYXItPmdldFNsb3BlKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogU01BTEwKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBudGggc21hbGxlc3QgdmFsdWUgaW4gYSBkYXRhIHNldC4gWW91IGNhbiB1c2UgdGhpcyBmdW5jdGlvbiB0bwogICAgICogICAgICAgIHNlbGVjdCBhIHZhbHVlIGJhc2VkIG9uIGl0cyByZWxhdGl2ZSBzdGFuZGluZy4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBTTUFMTCh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dLGVudHJ5KQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHBhcmFtICAgIGludCAgICAgICAgICAgICRlbnRyeSAgICAgICAgICAgIFBvc2l0aW9uIChvcmRlcmVkIGZyb20gdGhlIHNtYWxsZXN0KSBpbiB0aGUgYXJyYXkgb3IgcmFuZ2Ugb2YgZGF0YSB0byByZXR1cm4KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBTTUFMTCgpCiAgICB7CiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoZnVuY19nZXRfYXJncygpKTsKCiAgICAgICAgLy8gQ2FsY3VsYXRlCiAgICAgICAgJGVudHJ5ID0gYXJyYXlfcG9wKCRhQXJncyk7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkZW50cnkpKSAmJiAoIWlzX3N0cmluZygkZW50cnkpKSkgewogICAgICAgICAgICAkbUFyZ3MgPSBhcnJheSgpOwogICAgICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGFyZykgewogICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgICAgICAkbUFyZ3NbXSA9ICRhcmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGNvdW50ID0gc2VsZjo6Q09VTlQoJG1BcmdzKTsKICAgICAgICAgICAgJGVudHJ5ID0gZmxvb3IoLS0kZW50cnkpOwogICAgICAgICAgICBpZiAoKCRlbnRyeSA8IDApIHx8ICgkZW50cnkgPj0gJGNvdW50KSB8fCAoJGNvdW50ID09IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzb3J0KCRtQXJncyk7CiAgICAgICAgICAgIHJldHVybiAkbUFyZ3NbJGVudHJ5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTVEFOREFSRElaRQogICAgICoKICAgICAqIFJldHVybnMgYSBub3JtYWxpemVkIHZhbHVlIGZyb20gYSBkaXN0cmlidXRpb24gY2hhcmFjdGVyaXplZCBieSBtZWFuIGFuZCBzdGFuZGFyZF9kZXYuCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICR2YWx1ZSAgICAgICAgVmFsdWUgdG8gbm9ybWFsaXplCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJG1lYW4gICAgICAgIE1lYW4gVmFsdWUKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkc3RkRGV2ICAgICAgICBTdGFuZGFyZCBEZXZpYXRpb24KICAgICAqIEByZXR1cm4gICAgZmxvYXQgICAgU3RhbmRhcmRpemVkIHZhbHVlCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gU1RBTkRBUkRJWkUoJHZhbHVlLCAkbWVhbiwgJHN0ZERldikKICAgIHsKICAgICAgICAkdmFsdWUgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKTsKICAgICAgICAkbWVhbiAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1lYW4pOwogICAgICAgICRzdGREZXYgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc3RkRGV2KTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCR2YWx1ZSkpICYmIChpc19udW1lcmljKCRtZWFuKSkgJiYgKGlzX251bWVyaWMoJHN0ZERldikpKSB7CiAgICAgICAgICAgIGlmICgkc3RkRGV2IDw9IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoJHZhbHVlIC0gJG1lYW4pIC8gJHN0ZERldiA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogU1RERVYKICAgICAqCiAgICAgKiBFc3RpbWF0ZXMgc3RhbmRhcmQgZGV2aWF0aW9uIGJhc2VkIG9uIGEgc2FtcGxlLiBUaGUgc3RhbmRhcmQgZGV2aWF0aW9uIGlzIGEgbWVhc3VyZSBvZiBob3cKICAgICAqICAgICAgICB3aWRlbHkgdmFsdWVzIGFyZSBkaXNwZXJzZWQgZnJvbSB0aGUgYXZlcmFnZSB2YWx1ZSAodGhlIG1lYW4pLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIFNUREVWKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gU1RERVYoKQogICAgewogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5SW5kZXhlZChmdW5jX2dldF9hcmdzKCkpOwoKICAgICAgICAvLyBSZXR1cm4gdmFsdWUKICAgICAgICAkcmV0dXJuVmFsdWUgPSBudWxsOwoKICAgICAgICAkYU1lYW4gPSBzZWxmOjpBVkVSQUdFKCRhQXJncyk7CiAgICAgICAgaWYgKCFpc19udWxsKCRhTWVhbikpIHsKICAgICAgICAgICAgJGFDb3VudCA9IC0xOwogICAgICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGsgPT4gJGFyZykgewogICAgICAgICAgICAgICAgaWYgKChpc19ib29sKCRhcmcpKSAmJgogICAgICAgICAgICAgICAgICAgICgoIVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6aXNDZWxsVmFsdWUoJGspKSB8fCAoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpnZXRDb21wYXRpYmlsaXR5TW9kZSgpID09IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Q09NUEFUSUJJTElUWV9PUEVOT0ZGSUNFKSkpIHsKICAgICAgICAgICAgICAgICAgICAkYXJnID0gKGludGVnZXIpICRhcmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGFyZykpICYmICghaXNfc3RyaW5nKCRhcmcpKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJldHVyblZhbHVlID0gcG93KCgkYXJnIC0gJGFNZWFuKSwgMik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHJldHVyblZhbHVlICs9IHBvdygoJGFyZyAtICRhTWVhbiksIDIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICArKyRhQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJldHVybgogICAgICAgICAgICBpZiAoKCRhQ291bnQgPiAwKSAmJiAoJHJldHVyblZhbHVlID49IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3FydCgkcmV0dXJuVmFsdWUgLyAkYUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogU1RERVZBCiAgICAgKgogICAgICogRXN0aW1hdGVzIHN0YW5kYXJkIGRldmlhdGlvbiBiYXNlZCBvbiBhIHNhbXBsZSwgaW5jbHVkaW5nIG51bWJlcnMsIHRleHQsIGFuZCBsb2dpY2FsIHZhbHVlcwogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIFNUREVWQSh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFNUREVWQSgpCiAgICB7CiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXlJbmRleGVkKGZ1bmNfZ2V0X2FyZ3MoKSk7CgogICAgICAgICRyZXR1cm5WYWx1ZSA9IG51bGw7CgogICAgICAgICRhTWVhbiA9IHNlbGY6OkFWRVJBR0VBKCRhQXJncyk7CiAgICAgICAgaWYgKCFpc19udWxsKCRhTWVhbikpIHsKICAgICAgICAgICAgJGFDb3VudCA9IC0xOwogICAgICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGsgPT4gJGFyZykgewogICAgICAgICAgICAgICAgaWYgKChpc19ib29sKCRhcmcpKSAmJgogICAgICAgICAgICAgICAgICAgICghUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjppc01hdHJpeFZhbHVlKCRrKSkpIHsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgfHwgKGlzX2Jvb2woJGFyZykpIHx8ICgoaXNfc3RyaW5nKCRhcmcpICYgKCRhcmcgIT0gJycpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzX2Jvb2woJGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhcmcgPSAoaW50ZWdlcikgJGFyZzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlaWYgKGlzX3N0cmluZygkYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFyZyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzX251bGwoJHJldHVyblZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJldHVyblZhbHVlID0gcG93KCgkYXJnIC0gJGFNZWFuKSwgMik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmV0dXJuVmFsdWUgKz0gcG93KCgkYXJnIC0gJGFNZWFuKSwgMik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgKyskYUNvdW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCgkYUNvdW50ID4gMCkgJiYgKCRyZXR1cm5WYWx1ZSA+PSAwKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNxcnQoJHJldHVyblZhbHVlIC8gJGFDb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6RElWMCgpOwogICAgfQoKCiAgICAvKioKICAgICAqIFNUREVWUAogICAgICoKICAgICAqIENhbGN1bGF0ZXMgc3RhbmRhcmQgZGV2aWF0aW9uIGJhc2VkIG9uIHRoZSBlbnRpcmUgcG9wdWxhdGlvbgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIFNUREVWUCh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFNUREVWUCgpCiAgICB7CiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXlJbmRleGVkKGZ1bmNfZ2V0X2FyZ3MoKSk7CgogICAgICAgICRyZXR1cm5WYWx1ZSA9IG51bGw7CgogICAgICAgICRhTWVhbiA9IHNlbGY6OkFWRVJBR0UoJGFBcmdzKTsKICAgICAgICBpZiAoIWlzX251bGwoJGFNZWFuKSkgewogICAgICAgICAgICAkYUNvdW50ID0gMDsKICAgICAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRrID0+ICRhcmcpIHsKICAgICAgICAgICAgICAgIGlmICgoaXNfYm9vbCgkYXJnKSkgJiYKICAgICAgICAgICAgICAgICAgICAoKCFQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlzQ2VsbFZhbHVlKCRrKSkgfHwgKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Z2V0Q29tcGF0aWJpbGl0eU1vZGUoKSA9PSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkNPTVBBVElCSUxJVFlfT1BFTk9GRklDRSkpKSB7CiAgICAgICAgICAgICAgICAgICAgJGFyZyA9IChpbnRlZ2VyKSAkYXJnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSAmJiAoIWlzX3N0cmluZygkYXJnKSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNfbnVsbCgkcmV0dXJuVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSA9IHBvdygoJGFyZyAtICRhTWVhbiksIDIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSArPSBwb3coKCRhcmcgLSAkYU1lYW4pLCAyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKyskYUNvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoKCRhQ291bnQgPiAwKSAmJiAoJHJldHVyblZhbHVlID49IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3FydCgkcmV0dXJuVmFsdWUgLyAkYUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogU1RERVZQQQogICAgICoKICAgICAqIENhbGN1bGF0ZXMgc3RhbmRhcmQgZGV2aWF0aW9uIGJhc2VkIG9uIHRoZSBlbnRpcmUgcG9wdWxhdGlvbiwgaW5jbHVkaW5nIG51bWJlcnMsIHRleHQsIGFuZCBsb2dpY2FsIHZhbHVlcwogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIFNUREVWUEEodmFsdWUxWyx2YWx1ZTJbLCAuLi5dXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBTVERFVlBBKCkKICAgIHsKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheUluZGV4ZWQoZnVuY19nZXRfYXJncygpKTsKCiAgICAgICAgJHJldHVyblZhbHVlID0gbnVsbDsKCiAgICAgICAgJGFNZWFuID0gc2VsZjo6QVZFUkFHRUEoJGFBcmdzKTsKICAgICAgICBpZiAoIWlzX251bGwoJGFNZWFuKSkgewogICAgICAgICAgICAkYUNvdW50ID0gMDsKICAgICAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRrID0+ICRhcmcpIHsKICAgICAgICAgICAgICAgIGlmICgoaXNfYm9vbCgkYXJnKSkgJiYKICAgICAgICAgICAgICAgICAgICAoIVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6aXNNYXRyaXhWYWx1ZSgkaykpKSB7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIElzIGl0IGEgbnVtZXJpYyB2YWx1ZT8KICAgICAgICAgICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGFyZykpIHx8IChpc19ib29sKCRhcmcpKSB8fCAoKGlzX3N0cmluZygkYXJnKSAmICgkYXJnICE9ICcnKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc19ib29sKCRhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYXJnID0gKGludGVnZXIpICRhcmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmIChpc19zdHJpbmcoJGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhcmcgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc19udWxsKCRyZXR1cm5WYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXR1cm5WYWx1ZSA9IHBvdygoJGFyZyAtICRhTWVhbiksIDIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJldHVyblZhbHVlICs9IHBvdygoJGFyZyAtICRhTWVhbiksIDIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICsrJGFDb3VudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgoJGFDb3VudCA+IDApICYmICgkcmV0dXJuVmFsdWUgPj0gMCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzcXJ0KCRyZXR1cm5WYWx1ZSAvICRhQ291bnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkRJVjAoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTVEVZWAogICAgICoKICAgICAqIFJldHVybnMgdGhlIHN0YW5kYXJkIGVycm9yIG9mIHRoZSBwcmVkaWN0ZWQgeS12YWx1ZSBmb3IgZWFjaCB4IGluIHRoZSByZWdyZXNzaW9uLgogICAgICoKICAgICAqIEBwYXJhbSAgICBhcnJheSBvZiBtaXhlZCAgICAgICAgRGF0YSBTZXJpZXMgWQogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBYCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gU1RFWVgoJHlWYWx1ZXMsICR4VmFsdWVzKQogICAgewogICAgICAgIGlmICghc2VsZjo6Y2hlY2tUcmVuZEFycmF5cygkeVZhbHVlcywgJHhWYWx1ZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgICR5VmFsdWVDb3VudCA9IGNvdW50KCR5VmFsdWVzKTsKICAgICAgICAkeFZhbHVlQ291bnQgPSBjb3VudCgkeFZhbHVlcyk7CgogICAgICAgIGlmICgoJHlWYWx1ZUNvdW50ID09IDApIHx8ICgkeVZhbHVlQ291bnQgIT0gJHhWYWx1ZUNvdW50KSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOQSgpOwogICAgICAgIH0gZWxzZWlmICgkeVZhbHVlQ291bnQgPT0gMSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgfQoKICAgICAgICAkYmVzdEZpdExpbmVhciA9IHRyZW5kQ2xhc3M6OmNhbGN1bGF0ZSh0cmVuZENsYXNzOjpUUkVORF9MSU5FQVIsICR5VmFsdWVzLCAkeFZhbHVlcyk7CiAgICAgICAgcmV0dXJuICRiZXN0Rml0TGluZWFyLT5nZXRTdGRldk9mUmVzaWR1YWxzKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogVERJU1QKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBwcm9iYWJpbGl0eSBvZiBTdHVkZW50J3MgVCBkaXN0cmlidXRpb24uCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkdmFsdWUgICAgICAgICAgICBWYWx1ZSBmb3IgdGhlIGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRkZWdyZWVzICAgICAgICBkZWdyZWVzIG9mIGZyZWVkb20KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHRhaWxzICAgICAgICAgICAgbnVtYmVyIG9mIHRhaWxzICgxIG9yIDIpCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gVERJU1QoJHZhbHVlLCAkZGVncmVlcywgJHRhaWxzKQogICAgewogICAgICAgICR2YWx1ZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdmFsdWUpOwogICAgICAgICRkZWdyZWVzICAgID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGRlZ3JlZXMpKTsKICAgICAgICAkdGFpbHMgICAgICAgID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHRhaWxzKSk7CgogICAgICAgIGlmICgoaXNfbnVtZXJpYygkdmFsdWUpKSAmJiAoaXNfbnVtZXJpYygkZGVncmVlcykpICYmIChpc19udW1lcmljKCR0YWlscykpKSB7CiAgICAgICAgICAgIGlmICgoJHZhbHVlIDwgMCkgfHwgKCRkZWdyZWVzIDwgMSkgfHwgKCR0YWlscyA8IDEpIHx8ICgkdGFpbHMgPiAyKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gICAgdGRpc3QsIHdoaWNoIGZpbmRzIHRoZSBwcm9iYWJpbGl0eSB0aGF0IGNvcnJlc3BvbmRzIHRvIGEgZ2l2ZW4gdmFsdWUKICAgICAgICAgICAgLy8gICAgb2YgdCB3aXRoIGsgZGVncmVlcyBvZiBmcmVlZG9tLiBUaGlzIGFsZ29yaXRobSBpcyB0cmFuc2xhdGVkIGZyb20gYQogICAgICAgICAgICAvLyAgICBwYXNjYWwgZnVuY3Rpb24gb24gcDgxIG9mICJTdGF0aXN0aWNhbCBDb21wdXRpbmcgaW4gUGFzY2FsIiBieSBECiAgICAgICAgICAgIC8vICAgIENvb2tlLCBBIEggQ3JhdmVuICYgRyBNIENsYXJrICgxOTg1OiBFZHdhcmQgQXJub2xkIChQdWJzLikgTHRkOgogICAgICAgICAgICAvLyAgICBMb25kb24pLiBUaGUgYWJvdmUgUGFzY2FsIGFsZ29yaXRobSBpcyBpdHNlbGYgYSB0cmFuc2xhdGlvbiBvZiB0aGUKICAgICAgICAgICAgLy8gICAgZm9ydHJhbiBhbGdvcml0bSAiQVMgMyIgYnkgQiBFIENvb3BlciBvZiB0aGUgQXRsYXMgQ29tcHV0ZXIKICAgICAgICAgICAgLy8gICAgTGFib3JhdG9yeSBhcyByZXBvcnRlZCBpbiAoYW1vbmcgb3RoZXIgcGxhY2VzKSAiQXBwbGllZCBTdGF0aXN0aWNzCiAgICAgICAgICAgIC8vICAgIEFsZ29yaXRobXMiLCBlZGl0aWVkIGJ5IFAgR3JpZmZpdGhzIGFuZCBJIEQgSGlsbCAoMTk4NTsgRWxsaXMKICAgICAgICAgICAgLy8gICAgSG9yd29vZCBMdGQuOyBXLiBTdXNzZXgsIEVuZ2xhbmQpLgogICAgICAgICAgICAkdHRlcm0gPSAkZGVncmVlczsKICAgICAgICAgICAgJHR0aGV0YSA9IGF0YW4yKCR2YWx1ZSwgc3FydCgkdHRlcm0pKTsKICAgICAgICAgICAgJHRjID0gY29zKCR0dGhldGEpOwogICAgICAgICAgICAkdHMgPSBzaW4oJHR0aGV0YSk7CiAgICAgICAgICAgICR0c3VtID0gMDsKCiAgICAgICAgICAgIGlmICgoJGRlZ3JlZXMgJSAyKSA9PSAxKSB7CiAgICAgICAgICAgICAgICAkdGkgPSAzOwogICAgICAgICAgICAgICAgJHR0ZXJtID0gJHRjOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJHRpID0gMjsKICAgICAgICAgICAgICAgICR0dGVybSA9IDE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICR0c3VtID0gJHR0ZXJtOwogICAgICAgICAgICB3aGlsZSAoJHRpIDwgJGRlZ3JlZXMpIHsKICAgICAgICAgICAgICAgICR0dGVybSAqPSAkdGMgKiAkdGMgKiAoJHRpIC0gMSkgLyAkdGk7CiAgICAgICAgICAgICAgICAkdHN1bSArPSAkdHRlcm07CiAgICAgICAgICAgICAgICAkdGkgKz0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICAkdHN1bSAqPSAkdHM7CiAgICAgICAgICAgIGlmICgoJGRlZ3JlZXMgJSAyKSA9PSAxKSB7CiAgICAgICAgICAgICAgICAkdHN1bSA9IE1fMkRJVlBJICogKCR0c3VtICsgJHR0aGV0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJHRWYWx1ZSA9IDAuNSAqICgxICsgJHRzdW0pOwogICAgICAgICAgICBpZiAoJHRhaWxzID09IDEpIHsKICAgICAgICAgICAgICAgIHJldHVybiAxIC0gYWJzKCR0VmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIDEgLSBhYnMoKDEgLSAkdFZhbHVlKSAtICR0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogVElOVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIG9uZS10YWlsZWQgcHJvYmFiaWxpdHkgb2YgdGhlIGNoaS1zcXVhcmVkIGRpc3RyaWJ1dGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRwcm9iYWJpbGl0eSAgICBQcm9iYWJpbGl0eSBmb3IgdGhlIGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICRkZWdyZWVzICAgICAgICBkZWdyZWVzIG9mIGZyZWVkb20KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBUSU5WKCRwcm9iYWJpbGl0eSwgJGRlZ3JlZXMpCiAgICB7CiAgICAgICAgJHByb2JhYmlsaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHByb2JhYmlsaXR5KTsKICAgICAgICAkZGVncmVlcyAgICAgPSBmbG9vcihQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZGVncmVlcykpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHByb2JhYmlsaXR5KSkgJiYgKGlzX251bWVyaWMoJGRlZ3JlZXMpKSkgewogICAgICAgICAgICAkeExvID0gMTAwOwogICAgICAgICAgICAkeEhpID0gMDsKCiAgICAgICAgICAgICR4ID0gJHhOZXcgPSAxOwogICAgICAgICAgICAkZHggICAgPSAxOwogICAgICAgICAgICAkaSA9IDA7CgogICAgICAgICAgICB3aGlsZSAoKGFicygkZHgpID4gUFJFQ0lTSU9OKSAmJiAoJGkrKyA8IE1BWF9JVEVSQVRJT05TKSkgewogICAgICAgICAgICAgICAgLy8gQXBwbHkgTmV3dG9uLVJhcGhzb24gc3RlcAogICAgICAgICAgICAgICAgJHJlc3VsdCA9IHNlbGY6OlRESVNUKCR4LCAkZGVncmVlcywgMik7CiAgICAgICAgICAgICAgICAkZXJyb3IgPSAkcmVzdWx0IC0gJHByb2JhYmlsaXR5OwogICAgICAgICAgICAgICAgaWYgKCRlcnJvciA9PSAwLjApIHsKICAgICAgICAgICAgICAgICAgICAkZHggPSAwOwogICAgICAgICAgICAgICAgfSBlbHNlaWYgKCRlcnJvciA8IDAuMCkgewogICAgICAgICAgICAgICAgICAgICR4TG8gPSAkeDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJHhIaSA9ICR4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gQXZvaWQgZGl2aXNpb24gYnkgemVybwogICAgICAgICAgICAgICAgaWYgKCRyZXN1bHQgIT0gMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgJGR4ID0gJGVycm9yIC8gJHJlc3VsdDsKICAgICAgICAgICAgICAgICAgICAkeE5ldyA9ICR4IC0gJGR4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gSWYgdGhlIE5SIGZhaWxzIHRvIGNvbnZlcmdlICh3aGljaCBmb3IgZXhhbXBsZSBtYXkgYmUgdGhlCiAgICAgICAgICAgICAgICAvLyBjYXNlIGlmIHRoZSBpbml0aWFsIGd1ZXNzIGlzIHRvbyByb3VnaCkgd2UgYXBwbHkgYSBiaXNlY3Rpb24KICAgICAgICAgICAgICAgIC8vIHN0ZXAgdG8gZGV0ZXJtaW5lIGEgbW9yZSBuYXJyb3cgaW50ZXJ2YWwgYXJvdW5kIHRoZSByb290LgogICAgICAgICAgICAgICAgaWYgKCgkeE5ldyA8ICR4TG8pIHx8ICgkeE5ldyA+ICR4SGkpIHx8ICgkcmVzdWx0ID09IDAuMCkpIHsKICAgICAgICAgICAgICAgICAgICAkeE5ldyA9ICgkeExvICsgJHhIaSkgLyAyOwogICAgICAgICAgICAgICAgICAgICRkeCA9ICR4TmV3IC0gJHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkeCA9ICR4TmV3OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgkaSA9PSBNQVhfSVRFUkFUSU9OUykgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TkEoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcm91bmQoJHgsIDEyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBUUkVORAogICAgICoKICAgICAqIFJldHVybnMgdmFsdWVzIGFsb25nIGEgbGluZWFyIHRyZW5kCiAgICAgKgogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICAgICBEYXRhIFNlcmllcyBZCiAgICAgKiBAcGFyYW0gICAgYXJyYXkgb2YgbWl4ZWQgICAgICAgIERhdGEgU2VyaWVzIFgKICAgICAqIEBwYXJhbSAgICBhcnJheSBvZiBtaXhlZCAgICAgICAgVmFsdWVzIG9mIFggZm9yIHdoaWNoIHdlIHdhbnQgdG8gZmluZCBZCiAgICAgKiBAcGFyYW0gICAgYm9vbGVhbiAgICAgICAgICAgICAgICBBIGxvZ2ljYWwgdmFsdWUgc3BlY2lmeWluZyB3aGV0aGVyIHRvIGZvcmNlIHRoZSBpbnRlcnNlY3QgdG8gZXF1YWwgMC4KICAgICAqIEByZXR1cm4gICAgYXJyYXkgb2YgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBUUkVORCgkeVZhbHVlcywgJHhWYWx1ZXMgPSBhcnJheSgpLCAkbmV3VmFsdWVzID0gYXJyYXkoKSwgJGNvbnN0ID0gdHJ1ZSkKICAgIHsKICAgICAgICAkeVZhbHVlcyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCR5VmFsdWVzKTsKICAgICAgICAkeFZhbHVlcyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCR4VmFsdWVzKTsKICAgICAgICAkbmV3VmFsdWVzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoJG5ld1ZhbHVlcyk7CiAgICAgICAgJGNvbnN0ID0gKGlzX251bGwoJGNvbnN0KSkgPyB0cnVlIDogKGJvb2xlYW4pIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRjb25zdCk7CgogICAgICAgICRiZXN0Rml0TGluZWFyID0gdHJlbmRDbGFzczo6Y2FsY3VsYXRlKHRyZW5kQ2xhc3M6OlRSRU5EX0xJTkVBUiwgJHlWYWx1ZXMsICR4VmFsdWVzLCAkY29uc3QpOwogICAgICAgIGlmIChlbXB0eSgkbmV3VmFsdWVzKSkgewogICAgICAgICAgICAkbmV3VmFsdWVzID0gJGJlc3RGaXRMaW5lYXItPmdldFhWYWx1ZXMoKTsKICAgICAgICB9CgogICAgICAgICRyZXR1cm5BcnJheSA9IGFycmF5KCk7CiAgICAgICAgZm9yZWFjaCAoJG5ld1ZhbHVlcyBhcyAkeFZhbHVlKSB7CiAgICAgICAgICAgICRyZXR1cm5BcnJheVswXVtdID0gJGJlc3RGaXRMaW5lYXItPmdldFZhbHVlT2ZZRm9yWCgkeFZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkcmV0dXJuQXJyYXk7CiAgICB9CgoKICAgIC8qKgogICAgICogVFJJTU1FQU4KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBtZWFuIG9mIHRoZSBpbnRlcmlvciBvZiBhIGRhdGEgc2V0LiBUUklNTUVBTiBjYWxjdWxhdGVzIHRoZSBtZWFuCiAgICAgKiAgICAgICAgdGFrZW4gYnkgZXhjbHVkaW5nIGEgcGVyY2VudGFnZSBvZiBkYXRhIHBvaW50cyBmcm9tIHRoZSB0b3AgYW5kIGJvdHRvbSB0YWlscwogICAgICogICAgICAgIG9mIGEgZGF0YSBzZXQuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgVFJJTUVBTih2YWx1ZTFbLHZhbHVlMlssIC4uLl1dLCAkZGlzY2FyZCkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IFN0YXRpc3RpY2FsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgICAgICAkYXJnLC4uLiAgICAgICAgRGF0YSB2YWx1ZXMKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJGRpc2NhcmQgICAgICAgIFBlcmNlbnRhZ2UgdG8gZGlzY2FyZAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFRSSU1NRUFOKCkKICAgIHsKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheShmdW5jX2dldF9hcmdzKCkpOwoKICAgICAgICAvLyBDYWxjdWxhdGUKICAgICAgICAkcGVyY2VudCA9IGFycmF5X3BvcCgkYUFyZ3MpOwoKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHBlcmNlbnQpKSAmJiAoIWlzX3N0cmluZygkcGVyY2VudCkpKSB7CiAgICAgICAgICAgIGlmICgoJHBlcmNlbnQgPCAwKSB8fCAoJHBlcmNlbnQgPiAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJG1BcmdzID0gYXJyYXkoKTsKICAgICAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRhcmcpIHsKICAgICAgICAgICAgICAgIC8vIElzIGl0IGEgbnVtZXJpYyB2YWx1ZT8KICAgICAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICAgICAgJG1BcmdzW10gPSAkYXJnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICRkaXNjYXJkID0gZmxvb3Ioc2VsZjo6Q09VTlQoJG1BcmdzKSAqICRwZXJjZW50IC8gMik7CiAgICAgICAgICAgIHNvcnQoJG1BcmdzKTsKICAgICAgICAgICAgZm9yICgkaT0wOyAkaSA8ICRkaXNjYXJkOyArKyRpKSB7CiAgICAgICAgICAgICAgICBhcnJheV9wb3AoJG1BcmdzKTsKICAgICAgICAgICAgICAgIGFycmF5X3NoaWZ0KCRtQXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlbGY6OkFWRVJBR0UoJG1BcmdzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBWQVJGdW5jCiAgICAgKgogICAgICogRXN0aW1hdGVzIHZhcmlhbmNlIGJhc2VkIG9uIGEgc2FtcGxlLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIFZBUih2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFZBUkZ1bmMoKQogICAgewogICAgICAgICRyZXR1cm5WYWx1ZSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6RElWMCgpOwoKICAgICAgICAkc3VtbWVyQSA9ICRzdW1tZXJCID0gMDsKCiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFyZ3VtZW50cwogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KGZ1bmNfZ2V0X2FyZ3MoKSk7CiAgICAgICAgJGFDb3VudCA9IDA7CiAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRhcmcpIHsKICAgICAgICAgICAgaWYgKGlzX2Jvb2woJGFyZykpIHsKICAgICAgICAgICAgICAgICRhcmcgPSAoaW50ZWdlcikgJGFyZzsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICAkc3VtbWVyQSArPSAoJGFyZyAqICRhcmcpOwogICAgICAgICAgICAgICAgJHN1bW1lckIgKz0gJGFyZzsKICAgICAgICAgICAgICAgICsrJGFDb3VudDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCRhQ291bnQgPiAxKSB7CiAgICAgICAgICAgICRzdW1tZXJBICo9ICRhQ291bnQ7CiAgICAgICAgICAgICRzdW1tZXJCICo9ICRzdW1tZXJCOwogICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSAoJHN1bW1lckEgLSAkc3VtbWVyQikgLyAoJGFDb3VudCAqICgkYUNvdW50IC0gMSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKCiAgICAvKioKICAgICAqIFZBUkEKICAgICAqCiAgICAgKiBFc3RpbWF0ZXMgdmFyaWFuY2UgYmFzZWQgb24gYSBzYW1wbGUsIGluY2x1ZGluZyBudW1iZXJzLCB0ZXh0LCBhbmQgbG9naWNhbCB2YWx1ZXMKICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBWQVJBKHZhbHVlMVssdmFsdWUyWywgLi4uXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBTdGF0aXN0aWNhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAgICAgJGFyZywuLi4gICAgICAgIERhdGEgdmFsdWVzCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gVkFSQSgpCiAgICB7CiAgICAgICAgJHJldHVyblZhbHVlID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CgogICAgICAgICRzdW1tZXJBID0gJHN1bW1lckIgPSAwOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYXJndW1lbnRzCiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXlJbmRleGVkKGZ1bmNfZ2V0X2FyZ3MoKSk7CiAgICAgICAgJGFDb3VudCA9IDA7CiAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRrID0+ICRhcmcpIHsKICAgICAgICAgICAgaWYgKChpc19zdHJpbmcoJGFyZykpICYmCiAgICAgICAgICAgICAgICAoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjppc1ZhbHVlKCRrKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgICAgIH0gZWxzZWlmICgoaXNfc3RyaW5nKCRhcmcpKSAmJgogICAgICAgICAgICAgICAgKCFQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlzTWF0cml4VmFsdWUoJGspKSkgewogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSXMgaXQgYSBudW1lcmljIHZhbHVlPwogICAgICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRhcmcpKSB8fCAoaXNfYm9vbCgkYXJnKSkgfHwgKChpc19zdHJpbmcoJGFyZykgJiAoJGFyZyAhPSAnJykpKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc19ib29sKCRhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcmcgPSAoaW50ZWdlcikgJGFyZzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2VpZiAoaXNfc3RyaW5nKCRhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhcmcgPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkc3VtbWVyQSArPSAoJGFyZyAqICRhcmcpOwogICAgICAgICAgICAgICAgICAgICRzdW1tZXJCICs9ICRhcmc7CiAgICAgICAgICAgICAgICAgICAgKyskYUNvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoJGFDb3VudCA+IDEpIHsKICAgICAgICAgICAgJHN1bW1lckEgKj0gJGFDb3VudDsKICAgICAgICAgICAgJHN1bW1lckIgKj0gJHN1bW1lckI7CiAgICAgICAgICAgICRyZXR1cm5WYWx1ZSA9ICgkc3VtbWVyQSAtICRzdW1tZXJCKSAvICgkYUNvdW50ICogKCRhQ291bnQgLSAxKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmV0dXJuVmFsdWU7CiAgICB9CgoKICAgIC8qKgogICAgICogVkFSUAogICAgICoKICAgICAqIENhbGN1bGF0ZXMgdmFyaWFuY2UgYmFzZWQgb24gdGhlIGVudGlyZSBwb3B1bGF0aW9uCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgVkFSUCh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFZBUlAoKQogICAgewogICAgICAgIC8vIFJldHVybiB2YWx1ZQogICAgICAgICRyZXR1cm5WYWx1ZSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6RElWMCgpOwoKICAgICAgICAkc3VtbWVyQSA9ICRzdW1tZXJCID0gMDsKCiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFyZ3VtZW50cwogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KGZ1bmNfZ2V0X2FyZ3MoKSk7CiAgICAgICAgJGFDb3VudCA9IDA7CiAgICAgICAgZm9yZWFjaCAoJGFBcmdzIGFzICRhcmcpIHsKICAgICAgICAgICAgaWYgKGlzX2Jvb2woJGFyZykpIHsKICAgICAgICAgICAgICAgICRhcmcgPSAoaW50ZWdlcikgJGFyZzsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgIGlmICgoaXNfbnVtZXJpYygkYXJnKSkgJiYgKCFpc19zdHJpbmcoJGFyZykpKSB7CiAgICAgICAgICAgICAgICAkc3VtbWVyQSArPSAoJGFyZyAqICRhcmcpOwogICAgICAgICAgICAgICAgJHN1bW1lckIgKz0gJGFyZzsKICAgICAgICAgICAgICAgICsrJGFDb3VudDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCRhQ291bnQgPiAwKSB7CiAgICAgICAgICAgICRzdW1tZXJBICo9ICRhQ291bnQ7CiAgICAgICAgICAgICRzdW1tZXJCICo9ICRzdW1tZXJCOwogICAgICAgICAgICAkcmV0dXJuVmFsdWUgPSAoJHN1bW1lckEgLSAkc3VtbWVyQikgLyAoJGFDb3VudCAqICRhQ291bnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKCiAgICAvKioKICAgICAqIFZBUlBBCiAgICAgKgogICAgICogQ2FsY3VsYXRlcyB2YXJpYW5jZSBiYXNlZCBvbiB0aGUgZW50aXJlIHBvcHVsYXRpb24sIGluY2x1ZGluZyBudW1iZXJzLCB0ZXh0LCBhbmQgbG9naWNhbCB2YWx1ZXMKICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBWQVJQQSh2YWx1ZTFbLHZhbHVlMlssIC4uLl1dKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgU3RhdGlzdGljYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgICAgICRhcmcsLi4uICAgICAgICBEYXRhIHZhbHVlcwogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFZBUlBBKCkKICAgIHsKICAgICAgICAkcmV0dXJuVmFsdWUgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkRJVjAoKTsKCiAgICAgICAgJHN1bW1lckEgPSAkc3VtbWVyQiA9IDA7CgogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhcmd1bWVudHMKICAgICAgICAkYUFyZ3MgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheUluZGV4ZWQoZnVuY19nZXRfYXJncygpKTsKICAgICAgICAkYUNvdW50ID0gMDsKICAgICAgICBmb3JlYWNoICgkYUFyZ3MgYXMgJGsgPT4gJGFyZykgewogICAgICAgICAgICBpZiAoKGlzX3N0cmluZygkYXJnKSkgJiYKICAgICAgICAgICAgICAgIChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmlzVmFsdWUoJGspKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICAgICAgfSBlbHNlaWYgKChpc19zdHJpbmcoJGFyZykpICYmCiAgICAgICAgICAgICAgICAoIVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6aXNNYXRyaXhWYWx1ZSgkaykpKSB7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgICAgICBpZiAoKGlzX251bWVyaWMoJGFyZykpIHx8IChpc19ib29sKCRhcmcpKSB8fCAoKGlzX3N0cmluZygkYXJnKSAmICgkYXJnICE9ICcnKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzX2Jvb2woJGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFyZyA9IChpbnRlZ2VyKSAkYXJnOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZWlmIChpc19zdHJpbmcoJGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGFyZyA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRzdW1tZXJBICs9ICgkYXJnICogJGFyZyk7CiAgICAgICAgICAgICAgICAgICAgJHN1bW1lckIgKz0gJGFyZzsKICAgICAgICAgICAgICAgICAgICArKyRhQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICgkYUNvdW50ID4gMCkgewogICAgICAgICAgICAkc3VtbWVyQSAqPSAkYUNvdW50OwogICAgICAgICAgICAkc3VtbWVyQiAqPSAkc3VtbWVyQjsKICAgICAgICAgICAgJHJldHVyblZhbHVlID0gKCRzdW1tZXJBIC0gJHN1bW1lckIpIC8gKCRhQ291bnQgKiAkYUNvdW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICRyZXR1cm5WYWx1ZTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBXRUlCVUxMCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgV2VpYnVsbCBkaXN0cmlidXRpb24uIFVzZSB0aGlzIGRpc3RyaWJ1dGlvbiBpbiByZWxpYWJpbGl0eQogICAgICogYW5hbHlzaXMsIHN1Y2ggYXMgY2FsY3VsYXRpbmcgYSBkZXZpY2UncyBtZWFuIHRpbWUgdG8gZmFpbHVyZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgICAgICR2YWx1ZQogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYWxwaGEgICAgICAgIEFscGhhIFBhcmFtZXRlcgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICAgICAkYmV0YSAgICAgICAgQmV0YSBQYXJhbWV0ZXIKICAgICAqIEBwYXJhbSAgICBib29sZWFuICAgICAgICAkY3VtdWxhdGl2ZQogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICoKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBXRUlCVUxMKCR2YWx1ZSwgJGFscGhhLCAkYmV0YSwgJGN1bXVsYXRpdmUpCiAgICB7CiAgICAgICAgJHZhbHVlID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHZhbHVlKTsKICAgICAgICAkYWxwaGEgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYWxwaGEpOwogICAgICAgICRiZXRhICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiZXRhKTsKCiAgICAgICAgaWYgKChpc19udW1lcmljKCR2YWx1ZSkpICYmIChpc19udW1lcmljKCRhbHBoYSkpICYmIChpc19udW1lcmljKCRiZXRhKSkpIHsKICAgICAgICAgICAgaWYgKCgkdmFsdWUgPCAwKSB8fCAoJGFscGhhIDw9IDApIHx8ICgkYmV0YSA8PSAwKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChpc19udW1lcmljKCRjdW11bGF0aXZlKSkgfHwgKGlzX2Jvb2woJGN1bXVsYXRpdmUpKSkgewogICAgICAgICAgICAgICAgaWYgKCRjdW11bGF0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEgLSBleHAoMCAtIHBvdygkdmFsdWUgLyAkYmV0YSwgJGFscGhhKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoJGFscGhhIC8gcG93KCRiZXRhLCAkYWxwaGEpKSAqIHBvdygkdmFsdWUsICRhbHBoYSAtIDEpICogZXhwKDAgLSBwb3coJHZhbHVlIC8gJGJldGEsICRhbHBoYSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogWlRFU1QKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBXZWlidWxsIGRpc3RyaWJ1dGlvbi4gVXNlIHRoaXMgZGlzdHJpYnV0aW9uIGluIHJlbGlhYmlsaXR5CiAgICAgKiBhbmFseXNpcywgc3VjaCBhcyBjYWxjdWxhdGluZyBhIGRldmljZSdzIG1lYW4gdGltZSB0byBmYWlsdXJlLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJGRhdGFTZXQKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJG0wICAgICAgICBBbHBoYSBQYXJhbWV0ZXIKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgJHNpZ21hICAgIEJldGEgUGFyYW1ldGVyCiAgICAgKiBAcGFyYW0gICAgYm9vbGVhbiAgICAgICAgJGN1bXVsYXRpdmUKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gWlRFU1QoJGRhdGFTZXQsICRtMCwgJHNpZ21hID0gbnVsbCkKICAgIHsKICAgICAgICAkZGF0YVNldCA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5SW5kZXhlZCgkZGF0YVNldCk7CiAgICAgICAgJG0wICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbTApOwogICAgICAgICRzaWdtYSAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNpZ21hKTsKCiAgICAgICAgaWYgKGlzX251bGwoJHNpZ21hKSkgewogICAgICAgICAgICAkc2lnbWEgPSBzZWxmOjpTVERFVigkZGF0YVNldCk7CiAgICAgICAgfQogICAgICAgICRuID0gY291bnQoJGRhdGFTZXQpOwoKICAgICAgICByZXR1cm4gMSAtIHNlbGY6Ok5PUk1TRElTVCgoc2VsZjo6QVZFUkFHRSgkZGF0YVNldCkgLSAkbTApIC8gKCRzaWdtYSAvIFNRUlQoJG4pKSk7CiAgICB9Cn0K",
    "size": "132522"
}