{
    "namaFile": "js\/spectrum\/test\/qunit.js",
    "lastUpdate": "2017-10-27+15:21:05.15",
    "contentFile": "LyoqCiAqIFFVbml0IHYxLjEwLjAgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yawogKgogKiBodHRwOi8vcXVuaXRqcy5jb20KICoKICogQ29weXJpZ2h0IDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgooZnVuY3Rpb24oIHdpbmRvdyApIHsKCnZhciBRVW5pdCwKICAgIGNvbmZpZywKICAgIG9uRXJyb3JGblByZXYsCiAgICB0ZXN0SWQgPSAwLAogICAgZmlsZU5hbWUgPSAoc291cmNlRnJvbVN0YWNrdHJhY2UoIDAgKSB8fCAiIiApLnJlcGxhY2UoLyg6XGQrKStcKT8vLCAiIikucmVwbGFjZSgvLitcLy8sICIiKSwKICAgIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZywKICAgIGhhc093biA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCiAgICAvLyBLZWVwIGEgbG9jYWwgcmVmZXJlbmNlIHRvIERhdGUgKEdILTI4MykKICAgIERhdGUgPSB3aW5kb3cuRGF0ZSwKICAgIGRlZmluZWQgPSB7CiAgICBzZXRUaW1lb3V0OiB0eXBlb2Ygd2luZG93LnNldFRpbWVvdXQgIT09ICJ1bmRlZmluZWQiLAogICAgc2Vzc2lvblN0b3JhZ2U6IChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgeCA9ICJxdW5pdC10ZXN0LXN0cmluZyI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSggeCwgeCApOwogICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCB4ICk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gY2F0Y2goIGUgKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9KCkpCn07CgpmdW5jdGlvbiBUZXN0KCBzZXR0aW5ncyApIHsKICAgIGV4dGVuZCggdGhpcywgc2V0dGluZ3MgKTsKICAgIHRoaXMuYXNzZXJ0aW9ucyA9IFtdOwogICAgdGhpcy50ZXN0TnVtYmVyID0gKytUZXN0LmNvdW50Owp9CgpUZXN0LmNvdW50ID0gMDsKClRlc3QucHJvdG90eXBlID0gewogICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGEsIGIsIGxpLAogICAgICAgIHRlc3RzID0gaWQoICJxdW5pdC10ZXN0cyIgKTsKCiAgICAgICAgaWYgKCB0ZXN0cyApIHsKICAgICAgICAgICAgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzdHJvbmciICk7CiAgICAgICAgICAgIGIuaW5uZXJIVE1MID0gdGhpcy5uYW1lOwoKICAgICAgICAgICAgLy8gYGFgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogICAgICAgICAgICBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CiAgICAgICAgICAgIGEuaW5uZXJIVE1MID0gIlJlcnVuIjsKICAgICAgICAgICAgYS5ocmVmID0gUVVuaXQudXJsKHsgdGVzdE51bWJlcjogdGhpcy50ZXN0TnVtYmVyIH0pOwoKICAgICAgICAgICAgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CiAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKCBiICk7CiAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKCBhICk7CiAgICAgICAgICAgIGxpLmNsYXNzTmFtZSA9ICJydW5uaW5nIjsKICAgICAgICAgICAgbGkuaWQgPSB0aGlzLmlkID0gInF1bml0LXRlc3Qtb3V0cHV0IiArIHRlc3RJZCsrOwoKICAgICAgICAgICAgdGVzdHMuYXBwZW5kQ2hpbGQoIGxpICk7CiAgICAgICAgfQogICAgfSwKICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIHRoaXMubW9kdWxlICE9PSBjb25maWcucHJldmlvdXNNb2R1bGUgKSB7CiAgICAgICAgICAgIGlmICggY29uZmlnLnByZXZpb3VzTW9kdWxlICkgewogICAgICAgICAgICAgICAgcnVuTG9nZ2luZ0NhbGxiYWNrcyggIm1vZHVsZURvbmUiLCBRVW5pdCwgewogICAgICAgICAgICAgICAgICAgIG5hbWU6IGNvbmZpZy5wcmV2aW91c01vZHVsZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsCiAgICAgICAgICAgICAgICAgICAgcGFzc2VkOiBjb25maWcubW9kdWxlU3RhdHMuYWxsIC0gY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwKICAgICAgICAgICAgICAgICAgICB0b3RhbDogY29uZmlnLm1vZHVsZVN0YXRzLmFsbAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uZmlnLnByZXZpb3VzTW9kdWxlID0gdGhpcy5tb2R1bGU7CiAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVTdGF0cyA9IHsgYWxsOiAwLCBiYWQ6IDAgfTsKICAgICAgICAgICAgcnVuTG9nZ2luZ0NhbGxiYWNrcyggIm1vZHVsZVN0YXJ0IiwgUVVuaXQsIHsKICAgICAgICAgICAgICAgIG5hbWU6IHRoaXMubW9kdWxlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAoIGNvbmZpZy5hdXRvcnVuICkgewogICAgICAgICAgICBydW5Mb2dnaW5nQ2FsbGJhY2tzKCAibW9kdWxlU3RhcnQiLCBRVW5pdCwgewogICAgICAgICAgICAgICAgbmFtZTogdGhpcy5tb2R1bGUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBjb25maWcuY3VycmVudCA9IHRoaXM7CgogICAgICAgIHRoaXMudGVzdEVudmlyb25tZW50ID0gZXh0ZW5kKHsKICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgIHRlYXJkb3duOiBmdW5jdGlvbigpIHt9CiAgICAgICAgfSwgdGhpcy5tb2R1bGVUZXN0RW52aXJvbm1lbnQgKTsKCiAgICAgICAgcnVuTG9nZ2luZ0NhbGxiYWNrcyggInRlc3RTdGFydCIsIFFVbml0LCB7CiAgICAgICAgICAgIG5hbWU6IHRoaXMudGVzdE5hbWUsCiAgICAgICAgICAgIG1vZHVsZTogdGhpcy5tb2R1bGUKICAgICAgICB9KTsKCiAgICAgICAgLy8gYWxsb3cgdXRpbGl0eSBmdW5jdGlvbnMgdG8gYWNjZXNzIHRoZSBjdXJyZW50IHRlc3QgZW52aXJvbm1lbnQKICAgICAgICAvLyBUT0RPIHdoeT8\/CiAgICAgICAgUVVuaXQuY3VycmVudF90ZXN0RW52aXJvbm1lbnQgPSB0aGlzLnRlc3RFbnZpcm9ubWVudDsKCiAgICAgICAgaWYgKCAhY29uZmlnLnBvbGx1dGlvbiApIHsKICAgICAgICAgICAgc2F2ZUdsb2JhbCgpOwogICAgICAgIH0KICAgICAgICBpZiAoIGNvbmZpZy5ub3RyeWNhdGNoICkgewogICAgICAgICAgICB0aGlzLnRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKCB0aGlzLnRlc3RFbnZpcm9ubWVudCApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMudGVzdEVudmlyb25tZW50LnNldHVwLmNhbGwoIHRoaXMudGVzdEVudmlyb25tZW50ICk7CiAgICAgICAgfSBjYXRjaCggZSApIHsKICAgICAgICAgICAgUVVuaXQucHVzaEZhaWx1cmUoICJTZXR1cCBmYWlsZWQgb24gIiArIHRoaXMudGVzdE5hbWUgKyAiOiAiICsgZS5tZXNzYWdlLCBleHRyYWN0U3RhY2t0cmFjZSggZSwgMSApICk7CiAgICAgICAgfQogICAgfSwKICAgIHJ1bjogZnVuY3Rpb24oKSB7CiAgICAgICAgY29uZmlnLmN1cnJlbnQgPSB0aGlzOwoKICAgICAgICB2YXIgcnVubmluZyA9IGlkKCAicXVuaXQtdGVzdHJlc3VsdCIgKTsKCiAgICAgICAgaWYgKCBydW5uaW5nICkgewogICAgICAgICAgICBydW5uaW5nLmlubmVySFRNTCA9ICJSdW5uaW5nOiA8YnIvPiIgKyB0aGlzLm5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoIHRoaXMuYXN5bmMgKSB7CiAgICAgICAgICAgIFFVbml0LnN0b3AoKTsKICAgICAgICB9CgogICAgICAgIGlmICggY29uZmlnLm5vdHJ5Y2F0Y2ggKSB7CiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2suY2FsbCggdGhpcy50ZXN0RW52aXJvbm1lbnQsIFFVbml0LmFzc2VydCApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmNhbGxiYWNrLmNhbGwoIHRoaXMudGVzdEVudmlyb25tZW50LCBRVW5pdC5hc3NlcnQgKTsKICAgICAgICB9IGNhdGNoKCBlICkgewogICAgICAgICAgICBRVW5pdC5wdXNoRmFpbHVyZSggIkRpZWQgb24gdGVzdCAjIiArICh0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgMSkgKyAiICIgKyB0aGlzLnN0YWNrICsgIjogIiArIGUubWVzc2FnZSwgZXh0cmFjdFN0YWNrdHJhY2UoIGUsIDAgKSApOwogICAgICAgICAgICAvLyBlbHNlIG5leHQgdGVzdCB3aWxsIGNhcnJ5IHRoZSByZXNwb25zaWJpbGl0eQogICAgICAgICAgICBzYXZlR2xvYmFsKCk7CgogICAgICAgICAgICAvLyBSZXN0YXJ0IHRoZSB0ZXN0cyBpZiB0aGV5J3JlIGJsb2NraW5nCiAgICAgICAgICAgIGlmICggY29uZmlnLmJsb2NraW5nICkgewogICAgICAgICAgICAgICAgUVVuaXQuc3RhcnQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgICAgY29uZmlnLmN1cnJlbnQgPSB0aGlzOwogICAgICAgIGlmICggY29uZmlnLm5vdHJ5Y2F0Y2ggKSB7CiAgICAgICAgICAgIHRoaXMudGVzdEVudmlyb25tZW50LnRlYXJkb3duLmNhbGwoIHRoaXMudGVzdEVudmlyb25tZW50ICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhpcy50ZXN0RW52aXJvbm1lbnQudGVhcmRvd24uY2FsbCggdGhpcy50ZXN0RW52aXJvbm1lbnQgKTsKICAgICAgICAgICAgfSBjYXRjaCggZSApIHsKICAgICAgICAgICAgICAgIFFVbml0LnB1c2hGYWlsdXJlKCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyB0aGlzLnRlc3ROYW1lICsgIjogIiArIGUubWVzc2FnZSwgZXh0cmFjdFN0YWNrdHJhY2UoIGUsIDEgKSApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNoZWNrUG9sbHV0aW9uKCk7CiAgICB9LAogICAgZmluaXNoOiBmdW5jdGlvbigpIHsKICAgICAgICBjb25maWcuY3VycmVudCA9IHRoaXM7CiAgICAgICAgaWYgKCBjb25maWcucmVxdWlyZUV4cGVjdHMgJiYgdGhpcy5leHBlY3RlZCA9PSBudWxsICkgewogICAgICAgICAgICBRVW5pdC5wdXNoRmFpbHVyZSggIkV4cGVjdGVkIG51bWJlciBvZiBhc3NlcnRpb25zIHRvIGJlIGRlZmluZWQsIGJ1dCBleHBlY3QoKSB3YXMgbm90IGNhbGxlZC4iLCB0aGlzLnN0YWNrICk7CiAgICAgICAgfSBlbHNlIGlmICggdGhpcy5leHBlY3RlZCAhPSBudWxsICYmIHRoaXMuZXhwZWN0ZWQgIT0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aCApIHsKICAgICAgICAgICAgUVVuaXQucHVzaEZhaWx1cmUoICJFeHBlY3RlZCAiICsgdGhpcy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIsIHRoaXMuc3RhY2sgKTsKICAgICAgICB9IGVsc2UgaWYgKCB0aGlzLmV4cGVjdGVkID09IG51bGwgJiYgIXRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKSB7CiAgICAgICAgICAgIFFVbml0LnB1c2hGYWlsdXJlKCAiRXhwZWN0ZWQgYXQgbGVhc3Qgb25lIGFzc2VydGlvbiwgYnV0IG5vbmUgd2VyZSBydW4gLSBjYWxsIGV4cGVjdCgwKSB0byBhY2NlcHQgemVybyBhc3NlcnRpb25zLiIsIHRoaXMuc3RhY2sgKTsKICAgICAgICB9CgogICAgICAgIHZhciBhc3NlcnRpb24sIGEsIGIsIGksIGxpLCBvbCwKICAgICAgICAgICAgdGVzdCA9IHRoaXMsCiAgICAgICAgICAgIGdvb2QgPSAwLAogICAgICAgICAgICBiYWQgPSAwLAogICAgICAgICAgICB0ZXN0cyA9IGlkKCAicXVuaXQtdGVzdHMiICk7CgogICAgICAgIGNvbmZpZy5zdGF0cy5hbGwgKz0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsKICAgICAgICBjb25maWcubW9kdWxlU3RhdHMuYWxsICs9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7CgogICAgICAgIGlmICggdGVzdHMgKSB7CiAgICAgICAgICAgIG9sID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIm9sIiApOwoKICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICBhc3NlcnRpb24gPSB0aGlzLmFzc2VydGlvbnNbaV07CgogICAgICAgICAgICAgICAgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CiAgICAgICAgICAgICAgICBsaS5jbGFzc05hbWUgPSBhc3NlcnRpb24ucmVzdWx0ID8gInBhc3MiIDogImZhaWwiOwogICAgICAgICAgICAgICAgbGkuaW5uZXJIVE1MID0gYXNzZXJ0aW9uLm1lc3NhZ2UgfHwgKCBhc3NlcnRpb24ucmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIgKTsKICAgICAgICAgICAgICAgIG9sLmFwcGVuZENoaWxkKCBsaSApOwoKICAgICAgICAgICAgICAgIGlmICggYXNzZXJ0aW9uLnJlc3VsdCApIHsKICAgICAgICAgICAgICAgICAgICBnb29kKys7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJhZCsrOwogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICBjb25maWcubW9kdWxlU3RhdHMuYmFkKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHN0b3JlIHJlc3VsdCB3aGVuIHBvc3NpYmxlCiAgICAgICAgICAgIGlmICggUVVuaXQuY29uZmlnLnJlb3JkZXIgJiYgZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSApIHsKICAgICAgICAgICAgICAgIGlmICggYmFkICkgewogICAgICAgICAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oICJxdW5pdC10ZXN0LSIgKyB0aGlzLm1vZHVsZSArICItIiArIHRoaXMudGVzdE5hbWUsIGJhZCApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCAicXVuaXQtdGVzdC0iICsgdGhpcy5tb2R1bGUgKyAiLSIgKyB0aGlzLnRlc3ROYW1lICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggYmFkID09PSAwICkgewogICAgICAgICAgICAgICAgb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYGJgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogICAgICAgICAgICBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInN0cm9uZyIgKTsKICAgICAgICAgICAgYi5pbm5lckhUTUwgPSB0aGlzLm5hbWUgKyAiIDxiIGNsYXNzPSdjb3VudHMnPig8YiBjbGFzcz0nZmFpbGVkJz4iICsgYmFkICsgIjwvYj4sIDxiIGNsYXNzPSdwYXNzZWQnPiIgKyBnb29kICsgIjwvYj4sICIgKyB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgIik8L2I+IjsKCiAgICAgICAgICAgIGFkZEV2ZW50KGIsICJjbGljayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIG5leHQgPSBiLm5leHRTaWJsaW5nLm5leHRTaWJsaW5nLAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBuZXh0LnN0eWxlLmRpc3BsYXk7CiAgICAgICAgICAgICAgICBuZXh0LnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGFkZEV2ZW50KGIsICJkYmxjbGljayIsIGZ1bmN0aW9uKCBlICkgewogICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGUgJiYgZS50YXJnZXQgPyBlLnRhcmdldCA6IHdpbmRvdy5ldmVudC5zcmNFbGVtZW50OwogICAgICAgICAgICAgICAgaWYgKCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAic3BhbiIgfHwgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImIiICkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCB3aW5kb3cubG9jYXRpb24gJiYgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciICkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IFFVbml0LnVybCh7IHRlc3ROdW1iZXI6IHRlc3QudGVzdE51bWJlciB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBgbGlgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogICAgICAgICAgICBsaSA9IGlkKCB0aGlzLmlkICk7CiAgICAgICAgICAgIGxpLmNsYXNzTmFtZSA9IGJhZCA\/ICJmYWlsIiA6ICJwYXNzIjsKICAgICAgICAgICAgbGkucmVtb3ZlQ2hpbGQoIGxpLmZpcnN0Q2hpbGQgKTsKICAgICAgICAgICAgYSA9IGxpLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKCBiICk7CiAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkICggYSApOwogICAgICAgICAgICBsaS5hcHBlbmRDaGlsZCggb2wgKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICBpZiAoICF0aGlzLmFzc2VydGlvbnNbaV0ucmVzdWx0ICkgewogICAgICAgICAgICAgICAgICAgIGJhZCsrOwogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICBjb25maWcubW9kdWxlU3RhdHMuYmFkKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJ1bkxvZ2dpbmdDYWxsYmFja3MoICJ0ZXN0RG9uZSIsIFFVbml0LCB7CiAgICAgICAgICAgIG5hbWU6IHRoaXMudGVzdE5hbWUsCiAgICAgICAgICAgIG1vZHVsZTogdGhpcy5tb2R1bGUsCiAgICAgICAgICAgIGZhaWxlZDogYmFkLAogICAgICAgICAgICBwYXNzZWQ6IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggLSBiYWQsCiAgICAgICAgICAgIHRvdGFsOiB0aGlzLmFzc2VydGlvbnMubGVuZ3RoCiAgICAgICAgfSk7CgogICAgICAgIFFVbml0LnJlc2V0KCk7CgogICAgICAgIGNvbmZpZy5jdXJyZW50ID0gdW5kZWZpbmVkOwogICAgfSwKCiAgICBxdWV1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGJhZCwKICAgICAgICAgICAgdGVzdCA9IHRoaXM7CgogICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0ZXN0LmluaXQoKTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBydW4oKSB7CiAgICAgICAgICAgIC8vIGVhY2ggb2YgdGhlc2UgY2FuIGJ5IGFzeW5jCiAgICAgICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGVzdC5zZXR1cCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0ZXN0LnJ1bigpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0ZXN0LnRlYXJkb3duKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRlc3QuZmluaXNoKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gYGJhZGAgaW5pdGlhbGl6ZWQgYXQgdG9wIG9mIHNjb3BlCiAgICAgICAgLy8gZGVmZXIgd2hlbiBwcmV2aW91cyB0ZXN0IHJ1biBwYXNzZWQsIGlmIHN0b3JhZ2UgaXMgYXZhaWxhYmxlCiAgICAgICAgYmFkID0gUVVuaXQuY29uZmlnLnJlb3JkZXIgJiYgZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSAmJgogICAgICAgICAgICAgICAgICAgICAgICArc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSggInF1bml0LXRlc3QtIiArIHRoaXMubW9kdWxlICsgIi0iICsgdGhpcy50ZXN0TmFtZSApOwoKICAgICAgICBpZiAoIGJhZCApIHsKICAgICAgICAgICAgcnVuKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3luY2hyb25pemUoIHJ1biwgdHJ1ZSApOwogICAgICAgIH0KICAgIH0KfTsKCi8vIFJvb3QgUVVuaXQgb2JqZWN0LgovLyBgUVVuaXRgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQpRVW5pdCA9IHsKCiAgICAvLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMKICAgIG1vZHVsZTogZnVuY3Rpb24oIG5hbWUsIHRlc3RFbnZpcm9ubWVudCApIHsKICAgICAgICBjb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7CiAgICAgICAgY29uZmlnLmN1cnJlbnRNb2R1bGVUZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7CiAgICAgICAgY29uZmlnLm1vZHVsZXNbbmFtZV0gPSB0cnVlOwogICAgfSwKCiAgICBhc3luY1Rlc3Q6IGZ1bmN0aW9uKCB0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrICkgewogICAgICAgIGlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKICAgICAgICAgICAgY2FsbGJhY2sgPSBleHBlY3RlZDsKICAgICAgICAgICAgZXhwZWN0ZWQgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgUVVuaXQudGVzdCggdGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgdHJ1ZSApOwogICAgfSwKCiAgICB0ZXN0OiBmdW5jdGlvbiggdGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgYXN5bmMgKSB7CiAgICAgICAgdmFyIHRlc3QsCiAgICAgICAgICAgIG5hbWUgPSAiPHNwYW4gY2xhc3M9J3Rlc3QtbmFtZSc+IiArIGVzY2FwZUlubmVyVGV4dCggdGVzdE5hbWUgKSArICI8L3NwYW4+IjsKCiAgICAgICAgaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewogICAgICAgICAgICBjYWxsYmFjayA9IGV4cGVjdGVkOwogICAgICAgICAgICBleHBlY3RlZCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewogICAgICAgICAgICBuYW1lID0gIjxzcGFuIGNsYXNzPSdtb2R1bGUtbmFtZSc+IiArIGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjwvc3Bhbj46ICIgKyBuYW1lOwogICAgICAgIH0KCiAgICAgICAgdGVzdCA9IG5ldyBUZXN0KHsKICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgdGVzdE5hbWU6IHRlc3ROYW1lLAogICAgICAgICAgICBleHBlY3RlZDogZXhwZWN0ZWQsCiAgICAgICAgICAgIGFzeW5jOiBhc3luYywKICAgICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgICBtb2R1bGU6IGNvbmZpZy5jdXJyZW50TW9kdWxlLAogICAgICAgICAgICBtb2R1bGVUZXN0RW52aXJvbm1lbnQ6IGNvbmZpZy5jdXJyZW50TW9kdWxlVGVzdEVudmlyb25tZW50LAogICAgICAgICAgICBzdGFjazogc291cmNlRnJvbVN0YWNrdHJhY2UoIDIgKQogICAgICAgIH0pOwoKICAgICAgICBpZiAoICF2YWxpZFRlc3QoIHRlc3QgKSApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGVzdC5xdWV1ZSgpOwogICAgfSwKCiAgICAvLyBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guCiAgICBleHBlY3Q6IGZ1bmN0aW9uKCBhc3NlcnRzICkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50LmV4cGVjdGVkID0gYXNzZXJ0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gY29uZmlnLmN1cnJlbnQuZXhwZWN0ZWQ7CiAgICAgICAgfQogICAgfSwKCiAgICBzdGFydDogZnVuY3Rpb24oIGNvdW50ICkgewogICAgICAgIGNvbmZpZy5zZW1hcGhvcmUgLT0gY291bnQgfHwgMTsKICAgICAgICAvLyBkb24ndCBzdGFydCB1bnRpbCBlcXVhbCBudW1iZXIgb2Ygc3RvcC1jYWxscwogICAgICAgIGlmICggY29uZmlnLnNlbWFwaG9yZSA+IDAgKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gaWdub3JlIGlmIHN0YXJ0IGlzIGNhbGxlZCBtb3JlIG9mdGVuIHRoZW4gc3RvcAogICAgICAgIGlmICggY29uZmlnLnNlbWFwaG9yZSA8IDAgKSB7CiAgICAgICAgICAgIGNvbmZpZy5zZW1hcGhvcmUgPSAwOwogICAgICAgIH0KICAgICAgICAvLyBBIHNsaWdodCBkZWxheSwgdG8gYXZvaWQgYW55IGN1cnJlbnQgY2FsbGJhY2tzCiAgICAgICAgaWYgKCBkZWZpbmVkLnNldFRpbWVvdXQgKSB7CiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCBjb25maWcuc2VtYXBob3JlID4gMCApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIGNvbmZpZy50aW1lb3V0ICkgewogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCggY29uZmlnLnRpbWVvdXQgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHByb2Nlc3MoIHRydWUgKTsKICAgICAgICAgICAgfSwgMTMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwogICAgICAgICAgICBwcm9jZXNzKCB0cnVlICk7CiAgICAgICAgfQogICAgfSwKCiAgICBzdG9wOiBmdW5jdGlvbiggY291bnQgKSB7CiAgICAgICAgY29uZmlnLnNlbWFwaG9yZSArPSBjb3VudCB8fCAxOwogICAgICAgIGNvbmZpZy5ibG9ja2luZyA9IHRydWU7CgogICAgICAgIGlmICggY29uZmlnLnRlc3RUaW1lb3V0ICYmIGRlZmluZWQuc2V0VGltZW91dCApIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KCBjb25maWcudGltZW91dCApOwogICAgICAgICAgICBjb25maWcudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgUVVuaXQub2soIGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiICk7CiAgICAgICAgICAgICAgICBjb25maWcuc2VtYXBob3JlID0gMTsKICAgICAgICAgICAgICAgIFFVbml0LnN0YXJ0KCk7CiAgICAgICAgICAgIH0sIGNvbmZpZy50ZXN0VGltZW91dCApOwogICAgICAgIH0KICAgIH0KfTsKCi8vIEFzc3NlcnQgaGVscGVycwovLyBBbGwgb2YgdGhlc2UgbXVzdCBjYWxsIGVpdGhlciBRVW5pdC5wdXNoKCkgb3IgbWFudWFsbHkgZG86Ci8vIC0gcnVuTG9nZ2luZ0NhbGxiYWNrcyggImxvZyIsIC4uICk7Ci8vIC0gY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsgLi4gfSk7ClFVbml0LmFzc2VydCA9IHsKICAgIC8qKgogICAgICogQXNzZXJ0cyByb3VnaCB0cnVlLWlzaCByZXN1bHQuCiAgICAgKiBAbmFtZSBvawogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOwogICAgICovCiAgICBvazogZnVuY3Rpb24oIHJlc3VsdCwgbXNnICkgewogICAgICAgIGlmICggIWNvbmZpZy5jdXJyZW50ICkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoICJvaygpIGFzc2VydGlvbiBvdXRzaWRlIHRlc3QgY29udGV4dCwgd2FzICIgKyBzb3VyY2VGcm9tU3RhY2t0cmFjZSgyKSApOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSAhIXJlc3VsdDsKCiAgICAgICAgdmFyIHNvdXJjZSwKICAgICAgICAgICAgZGV0YWlscyA9IHsKICAgICAgICAgICAgICAgIG1vZHVsZTogY29uZmlnLmN1cnJlbnQubW9kdWxlLAogICAgICAgICAgICAgICAgbmFtZTogY29uZmlnLmN1cnJlbnQudGVzdE5hbWUsCiAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdCwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1zZwogICAgICAgICAgICB9OwoKICAgICAgICBtc2cgPSBlc2NhcGVJbm5lclRleHQoIG1zZyB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIgKSApOwogICAgICAgIG1zZyA9ICI8c3BhbiBjbGFzcz0ndGVzdC1tZXNzYWdlJz4iICsgbXNnICsgIjwvc3Bhbj4iOwoKICAgICAgICBpZiAoICFyZXN1bHQgKSB7CiAgICAgICAgICAgIHNvdXJjZSA9IHNvdXJjZUZyb21TdGFja3RyYWNlKCAyICk7CiAgICAgICAgICAgIGlmICggc291cmNlICkgewogICAgICAgICAgICAgICAgZGV0YWlscy5zb3VyY2UgPSBzb3VyY2U7CiAgICAgICAgICAgICAgICBtc2cgKz0gIjx0YWJsZT48dHIgY2xhc3M9J3Rlc3Qtc291cmNlJz48dGg+U291cmNlOiA8L3RoPjx0ZD48cHJlPiIgKyBlc2NhcGVJbm5lclRleHQoIHNvdXJjZSApICsgIjwvcHJlPjwvdGQ+PC90cj48L3RhYmxlPiI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcnVuTG9nZ2luZ0NhbGxiYWNrcyggImxvZyIsIFFVbml0LCBkZXRhaWxzICk7CiAgICAgICAgY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsKICAgICAgICAgICAgcmVzdWx0OiByZXN1bHQsCiAgICAgICAgICAgIG1lc3NhZ2U6IG1zZwogICAgICAgIH0pOwogICAgfSwKCiAgICAvKioKICAgICAqIEFzc2VydCB0aGF0IHRoZSBmaXJzdCB0d28gYXJndW1lbnRzIGFyZSBlcXVhbCwgd2l0aCBhbiBvcHRpb25hbCBtZXNzYWdlLgogICAgICogUHJpbnRzIG91dCBib3RoIGFjdHVhbCBhbmQgZXhwZWN0ZWQgdmFsdWVzLgogICAgICogQG5hbWUgZXF1YWwKICAgICAqIEBmdW5jdGlvbgogICAgICogQGV4YW1wbGUgZXF1YWwoIGZvcm1hdCggIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiwgImZvcm1hdCgpIHJlcGxhY2VzIHswfSB3aXRoIG5leHQgYXJndW1lbnQiICk7CiAgICAgKi8KICAgIGVxdWFsOiBmdW5jdGlvbiggYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSApIHsKICAgICAgICBRVW5pdC5wdXNoKCBleHBlY3RlZCA9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UgKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmFtZSBub3RFcXVhbAogICAgICogQGZ1bmN0aW9uCiAgICAgKi8KICAgIG5vdEVxdWFsOiBmdW5jdGlvbiggYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSApIHsKICAgICAgICBRVW5pdC5wdXNoKCBleHBlY3RlZCAhPSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UgKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmFtZSBkZWVwRXF1YWwKICAgICAqIEBmdW5jdGlvbgogICAgICovCiAgICBkZWVwRXF1YWw6IGZ1bmN0aW9uKCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlICkgewogICAgICAgIFFVbml0LnB1c2goIFFVbml0LmVxdWl2KGFjdHVhbCwgZXhwZWN0ZWQpLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlICk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5hbWUgbm90RGVlcEVxdWFsCiAgICAgKiBAZnVuY3Rpb24KICAgICAqLwogICAgbm90RGVlcEVxdWFsOiBmdW5jdGlvbiggYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSApIHsKICAgICAgICBRVW5pdC5wdXNoKCAhUVVuaXQuZXF1aXYoYWN0dWFsLCBleHBlY3RlZCksIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UgKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAbmFtZSBzdHJpY3RFcXVhbAogICAgICogQGZ1bmN0aW9uCiAgICAgKi8KICAgIHN0cmljdEVxdWFsOiBmdW5jdGlvbiggYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSApIHsKICAgICAgICBRVW5pdC5wdXNoKCBleHBlY3RlZCA9PT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlICk7CiAgICB9LAoKICAgIC8qKgogICAgICogQG5hbWUgbm90U3RyaWN0RXF1YWwKICAgICAqIEBmdW5jdGlvbgogICAgICovCiAgICBub3RTdHJpY3RFcXVhbDogZnVuY3Rpb24oIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UgKSB7CiAgICAgICAgUVVuaXQucHVzaCggZXhwZWN0ZWQgIT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSApOwogICAgfSwKCiAgICB0aHJvd3M6IGZ1bmN0aW9uKCBibG9jaywgZXhwZWN0ZWQsIG1lc3NhZ2UgKSB7CiAgICAgICAgdmFyIGFjdHVhbCwKICAgICAgICAgICAgb2sgPSBmYWxzZTsKCiAgICAgICAgLy8gJ2V4cGVjdGVkJyBpcyBvcHRpb25hbAogICAgICAgIGlmICggdHlwZW9mIGV4cGVjdGVkID09PSAic3RyaW5nIiApIHsKICAgICAgICAgICAgbWVzc2FnZSA9IGV4cGVjdGVkOwogICAgICAgICAgICBleHBlY3RlZCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBjb25maWcuY3VycmVudC5pZ25vcmVHbG9iYWxFcnJvcnMgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGJsb2NrLmNhbGwoIGNvbmZpZy5jdXJyZW50LnRlc3RFbnZpcm9ubWVudCApOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgYWN0dWFsID0gZTsKICAgICAgICB9CiAgICAgICAgY29uZmlnLmN1cnJlbnQuaWdub3JlR2xvYmFsRXJyb3JzID0gZmFsc2U7CgogICAgICAgIGlmICggYWN0dWFsICkgewogICAgICAgICAgICAvLyB3ZSBkb24ndCB3YW50IHRvIHZhbGlkYXRlIHRocm93biBlcnJvcgogICAgICAgICAgICBpZiAoICFleHBlY3RlZCApIHsKICAgICAgICAgICAgICAgIG9rID0gdHJ1ZTsKICAgICAgICAgICAgLy8gZXhwZWN0ZWQgaXMgYSByZWdleHAKICAgICAgICAgICAgfSBlbHNlIGlmICggUVVuaXQub2JqZWN0VHlwZSggZXhwZWN0ZWQgKSA9PT0gInJlZ2V4cCIgKSB7CiAgICAgICAgICAgICAgICBvayA9IGV4cGVjdGVkLnRlc3QoIGFjdHVhbCApOwogICAgICAgICAgICAvLyBleHBlY3RlZCBpcyBhIGNvbnN0cnVjdG9yCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGFjdHVhbCBpbnN0YW5jZW9mIGV4cGVjdGVkICkgewogICAgICAgICAgICAgICAgb2sgPSB0cnVlOwogICAgICAgICAgICAvLyBleHBlY3RlZCBpcyBhIHZhbGlkYXRpb24gZnVuY3Rpb24gd2hpY2ggcmV0dXJucyB0cnVlIGlzIHZhbGlkYXRpb24gcGFzc2VkCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGV4cGVjdGVkLmNhbGwoIHt9LCBhY3R1YWwgKSA9PT0gdHJ1ZSApIHsKICAgICAgICAgICAgICAgIG9rID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgUVVuaXQucHVzaCggb2ssIGFjdHVhbCwgbnVsbCwgbWVzc2FnZSApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFFVbml0LnB1c2hGYWlsdXJlKCBtZXNzYWdlLCBudWxsLCAnTm8gZXhjZXB0aW9uIHdhcyB0aHJvd24uJyApOwogICAgICAgIH0KICAgIH0KfTsKCi8qKgogKiBAZGVwcmVjYXRlIHNpbmNlIDEuOC4wCiAqIEtlcHQgYXNzZXJ0aW9uIGhlbHBlcnMgaW4gcm9vdCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICovCmV4dGVuZCggUVVuaXQsIFFVbml0LmFzc2VydCApOwoKLyoqCiAqIEBkZXByZWNhdGVkIHNpbmNlIDEuOS4wCiAqIEtlcHQgZ2xvYmFsICJyYWlzZXMoKSIgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAqLwpRVW5pdC5yYWlzZXMgPSBRVW5pdC5hc3NlcnQudGhyb3dzOwoKLyoqCiAqIEBkZXByZWNhdGVkIHNpbmNlIDEuMC4wLCByZXBsYWNlZCB3aXRoIGVycm9yIHB1c2hlcyBzaW5jZSAxLjMuMAogKiBLZXB0IHRvIGF2b2lkIFR5cGVFcnJvcnMgZm9yIHVuZGVmaW5lZCBtZXRob2RzLgogKi8KUVVuaXQuZXF1YWxzID0gZnVuY3Rpb24oKSB7CiAgICBRVW5pdC5wdXNoKCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAiUVVuaXQuZXF1YWxzIGhhcyBiZWVuIGRlcHJlY2F0ZWQgc2luY2UgMjAwOSAoZTg4MDQ5YTApLCB1c2UgUVVuaXQuZXF1YWwgaW5zdGVhZCIgKTsKfTsKUVVuaXQuc2FtZSA9IGZ1bmN0aW9uKCkgewogICAgUVVuaXQucHVzaCggZmFsc2UsIGZhbHNlLCBmYWxzZSwgIlFVbml0LnNhbWUgaGFzIGJlZW4gZGVwcmVjYXRlZCBzaW5jZSAyMDA5IChlODgwNDlhMCksIHVzZSBRVW5pdC5kZWVwRXF1YWwgaW5zdGVhZCIgKTsKfTsKCi8vIFdlIHdhbnQgYWNjZXNzIHRvIHRoZSBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZQooZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBGKCkge30KICAgIEYucHJvdG90eXBlID0gUVVuaXQ7CiAgICBRVW5pdCA9IG5ldyBGKCk7CiAgICAvLyBNYWtlIEYgUVVuaXQncyBjb25zdHJ1Y3RvciBzbyB0aGF0IHdlIGNhbiBhZGQgdG8gdGhlIHByb3RvdHlwZSBsYXRlcgogICAgUVVuaXQuY29uc3RydWN0b3IgPSBGOwp9KCkpOwoKLyoqCiAqIENvbmZpZyBvYmplY3Q6IE1haW50YWluIGludGVybmFsIHN0YXRlCiAqIExhdGVyIGV4cG9zZWQgYXMgUVVuaXQuY29uZmlnCiAqIGBjb25maWdgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogKi8KY29uZmlnID0gewogICAgLy8gVGhlIHF1ZXVlIG9mIHRlc3RzIHRvIHJ1bgogICAgcXVldWU6IFtdLAoKICAgIC8vIGJsb2NrIHVudGlsIGRvY3VtZW50IHJlYWR5CiAgICBibG9ja2luZzogdHJ1ZSwKCiAgICAvLyB3aGVuIGVuYWJsZWQsIHNob3cgb25seSBmYWlsaW5nIHRlc3RzCiAgICAvLyBnZXRzIHBlcnNpc3RlZCB0aHJvdWdoIHNlc3Npb25TdG9yYWdlIGFuZCBjYW4gYmUgY2hhbmdlZCBpbiBVSSB2aWEgY2hlY2tib3gKICAgIGhpZGVwYXNzZWQ6IGZhbHNlLAoKICAgIC8vIGJ5IGRlZmF1bHQsIHJ1biBwcmV2aW91c2x5IGZhaWxlZCB0ZXN0cyBmaXJzdAogICAgLy8gdmVyeSB1c2VmdWwgaW4gY29tYmluYXRpb24gd2l0aCAiSGlkZSBwYXNzZWQgdGVzdHMiIGNoZWNrZWQKICAgIHJlb3JkZXI6IHRydWUsCgogICAgLy8gYnkgZGVmYXVsdCwgbW9kaWZ5IGRvY3VtZW50LnRpdGxlIHdoZW4gc3VpdGUgaXMgZG9uZQogICAgYWx0ZXJ0aXRsZTogdHJ1ZSwKCiAgICAvLyB3aGVuIGVuYWJsZWQsIGFsbCB0ZXN0cyBtdXN0IGNhbGwgZXhwZWN0KCkKICAgIHJlcXVpcmVFeHBlY3RzOiBmYWxzZSwKCiAgICAvLyBhZGQgY2hlY2tib3hlcyB0aGF0IGFyZSBwZXJzaXN0ZWQgaW4gdGhlIHF1ZXJ5LXN0cmluZwogICAgLy8gd2hlbiBlbmFibGVkLCB0aGUgaWQgaXMgc2V0IHRvIGB0cnVlYCBhcyBhIGBRVW5pdC5jb25maWdgIHByb3BlcnR5CiAgICB1cmxDb25maWc6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkOiAibm9nbG9iYWxzIiwKICAgICAgICAgICAgbGFiZWw6ICJDaGVjayBmb3IgR2xvYmFscyIsCiAgICAgICAgICAgIHRvb2x0aXA6ICJFbmFibGluZyB0aGlzIHdpbGwgdGVzdCBpZiBhbnkgdGVzdCBpbnRyb2R1Y2VzIG5ldyBwcm9wZXJ0aWVzIG9uIHRoZSBgd2luZG93YCBvYmplY3QuIFN0b3JlZCBhcyBxdWVyeS1zdHJpbmdzLiIKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWQ6ICJub3RyeWNhdGNoIiwKICAgICAgICAgICAgbGFiZWw6ICJObyB0cnktY2F0Y2giLAogICAgICAgICAgICB0b29sdGlwOiAiRW5hYmxpbmcgdGhpcyB3aWxsIHJ1biB0ZXN0cyBvdXRzaWRlIG9mIGEgdHJ5LWNhdGNoIGJsb2NrLiBNYWtlcyBkZWJ1Z2dpbmcgZXhjZXB0aW9ucyBpbiBJRSByZWFzb25hYmxlLiBTdG9yZWQgYXMgcXVlcnktc3RyaW5ncy4iCiAgICAgICAgfQogICAgXSwKCiAgICAvLyBTZXQgb2YgYWxsIG1vZHVsZXMuCiAgICBtb2R1bGVzOiB7fSwKCiAgICAvLyBsb2dnaW5nIGNhbGxiYWNrIHF1ZXVlcwogICAgYmVnaW46IFtdLAogICAgZG9uZTogW10sCiAgICBsb2c6IFtdLAogICAgdGVzdFN0YXJ0OiBbXSwKICAgIHRlc3REb25lOiBbXSwKICAgIG1vZHVsZVN0YXJ0OiBbXSwKICAgIG1vZHVsZURvbmU6IFtdCn07CgovLyBJbml0aWFsaXplIG1vcmUgUVVuaXQuY29uZmlnIGFuZCBRVW5pdC51cmxQYXJhbXMKKGZ1bmN0aW9uKCkgewogICAgdmFyIGksCiAgICAgICAgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LAogICAgICAgIHBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSggMSApLnNwbGl0KCAiJiIgKSwKICAgICAgICBsZW5ndGggPSBwYXJhbXMubGVuZ3RoLAogICAgICAgIHVybFBhcmFtcyA9IHt9LAogICAgICAgIGN1cnJlbnQ7CgogICAgaWYgKCBwYXJhbXNbIDAgXSApIHsKICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewogICAgICAgICAgICBjdXJyZW50ID0gcGFyYW1zWyBpIF0uc3BsaXQoICI9IiApOwogICAgICAgICAgICBjdXJyZW50WyAwIF0gPSBkZWNvZGVVUklDb21wb25lbnQoIGN1cnJlbnRbIDAgXSApOwogICAgICAgICAgICAvLyBhbGxvdyBqdXN0IGEga2V5IHRvIHR1cm4gb24gYSBmbGFnLCBlLmcuLCB0ZXN0Lmh0bWw\/bm9nbG9iYWxzCiAgICAgICAgICAgIGN1cnJlbnRbIDEgXSA9IGN1cnJlbnRbIDEgXSA\/IGRlY29kZVVSSUNvbXBvbmVudCggY3VycmVudFsgMSBdICkgOiB0cnVlOwogICAgICAgICAgICB1cmxQYXJhbXNbIGN1cnJlbnRbIDAgXSBdID0gY3VycmVudFsgMSBdOwogICAgICAgIH0KICAgIH0KCiAgICBRVW5pdC51cmxQYXJhbXMgPSB1cmxQYXJhbXM7CgogICAgLy8gU3RyaW5nIHNlYXJjaCBhbnl3aGVyZSBpbiBtb2R1bGVOYW1lK3Rlc3ROYW1lCiAgICBjb25maWcuZmlsdGVyID0gdXJsUGFyYW1zLmZpbHRlcjsKCiAgICAvLyBFeGFjdCBtYXRjaCBvZiB0aGUgbW9kdWxlIG5hbWUKICAgIGNvbmZpZy5tb2R1bGUgPSB1cmxQYXJhbXMubW9kdWxlOwoKICAgIGNvbmZpZy50ZXN0TnVtYmVyID0gcGFyc2VJbnQoIHVybFBhcmFtcy50ZXN0TnVtYmVyLCAxMCApIHx8IG51bGw7CgogICAgLy8gRmlndXJlIG91dCBpZiB3ZSdyZSBydW5uaW5nIHRoZSB0ZXN0cyBmcm9tIGEgc2VydmVyIG9yIG5vdAogICAgUVVuaXQuaXNMb2NhbCA9IGxvY2F0aW9uLnByb3RvY29sID09PSAiZmlsZToiOwp9KCkpOwoKLy8gRXhwb3J0IGdsb2JhbCB2YXJpYWJsZXMsIHVubGVzcyBhbiAnZXhwb3J0cycgb2JqZWN0IGV4aXN0cywKLy8gaW4gdGhhdCBjYXNlIHdlIGFzc3VtZSB3ZSdyZSBpbiBDb21tb25KUyAoZGVhbHQgd2l0aCBvbiB0aGUgYm90dG9tIG9mIHRoZSBzY3JpcHQpCmlmICggdHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiICkgewogICAgZXh0ZW5kKCB3aW5kb3csIFFVbml0ICk7CgogICAgLy8gRXhwb3NlIFFVbml0IG9iamVjdAogICAgd2luZG93LlFVbml0ID0gUVVuaXQ7Cn0KCi8vIEV4dGVuZCBRVW5pdCBvYmplY3QsCi8vIHRoZXNlIGFmdGVyIHNldCBoZXJlIGJlY2F1c2UgdGhleSBzaG91bGQgbm90IGJlIGV4cG9zZWQgYXMgZ2xvYmFsIGZ1bmN0aW9ucwpleHRlbmQoIFFVbml0LCB7CiAgICBjb25maWc6IGNvbmZpZywKCiAgICAvLyBJbml0aWFsaXplIHRoZSBjb25maWd1cmF0aW9uIG9wdGlvbnMKICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGV4dGVuZCggY29uZmlnLCB7CiAgICAgICAgICAgIHN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sCiAgICAgICAgICAgIG1vZHVsZVN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sCiAgICAgICAgICAgIHN0YXJ0ZWQ6ICtuZXcgRGF0ZSgpLAogICAgICAgICAgICB1cGRhdGVSYXRlOiAxMDAwLAogICAgICAgICAgICBibG9ja2luZzogZmFsc2UsCiAgICAgICAgICAgIGF1dG9zdGFydDogdHJ1ZSwKICAgICAgICAgICAgYXV0b3J1bjogZmFsc2UsCiAgICAgICAgICAgIGZpbHRlcjogIiIsCiAgICAgICAgICAgIHF1ZXVlOiBbXSwKICAgICAgICAgICAgc2VtYXBob3JlOiAwCiAgICAgICAgfSk7CgogICAgICAgIHZhciB0ZXN0cywgYmFubmVyLCByZXN1bHQsCiAgICAgICAgICAgIHF1bml0ID0gaWQoICJxdW5pdCIgKTsKCiAgICAgICAgaWYgKCBxdW5pdCApIHsKICAgICAgICAgICAgcXVuaXQuaW5uZXJIVE1MID0KICAgICAgICAgICAgICAgICI8aDEgaWQ9J3F1bml0LWhlYWRlcic+IiArIGVzY2FwZUlubmVyVGV4dCggZG9jdW1lbnQudGl0bGUgKSArICI8L2gxPiIgKwogICAgICAgICAgICAgICAgIjxoMiBpZD0ncXVuaXQtYmFubmVyJz48L2gyPiIgKwogICAgICAgICAgICAgICAgIjxkaXYgaWQ9J3F1bml0LXRlc3RydW5uZXItdG9vbGJhcic+PC9kaXY+IiArCiAgICAgICAgICAgICAgICAiPGgyIGlkPSdxdW5pdC11c2VyQWdlbnQnPjwvaDI+IiArCiAgICAgICAgICAgICAgICAiPG9sIGlkPSdxdW5pdC10ZXN0cyc+PC9vbD4iOwogICAgICAgIH0KCiAgICAgICAgdGVzdHMgPSBpZCggInF1bml0LXRlc3RzIiApOwogICAgICAgIGJhbm5lciA9IGlkKCAicXVuaXQtYmFubmVyIiApOwogICAgICAgIHJlc3VsdCA9IGlkKCAicXVuaXQtdGVzdHJlc3VsdCIgKTsKCiAgICAgICAgaWYgKCB0ZXN0cyApIHsKICAgICAgICAgICAgdGVzdHMuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIGJhbm5lciApIHsKICAgICAgICAgICAgYmFubmVyLmNsYXNzTmFtZSA9ICIiOwogICAgICAgIH0KCiAgICAgICAgaWYgKCByZXN1bHQgKSB7CiAgICAgICAgICAgIHJlc3VsdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCByZXN1bHQgKTsKICAgICAgICB9CgogICAgICAgIGlmICggdGVzdHMgKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJwIiApOwogICAgICAgICAgICByZXN1bHQuaWQgPSAicXVuaXQtdGVzdHJlc3VsdCI7CiAgICAgICAgICAgIHJlc3VsdC5jbGFzc05hbWUgPSAicmVzdWx0IjsKICAgICAgICAgICAgdGVzdHMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIHJlc3VsdCwgdGVzdHMgKTsKICAgICAgICAgICAgcmVzdWx0LmlubmVySFRNTCA9ICJSdW5uaW5nLi4uPGJyLz4mbmJzcDsiOwogICAgICAgIH0KICAgIH0sCgogICAgLy8gUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCiAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGZpeHR1cmUgPSBpZCggInF1bml0LWZpeHR1cmUiICk7CiAgICAgICAgaWYgKCBmaXh0dXJlICkgewogICAgICAgICAgICBmaXh0dXJlLmlubmVySFRNTCA9IGNvbmZpZy5maXh0dXJlOwogICAgICAgIH0KICAgIH0sCgogICAgLy8gVHJpZ2dlciBhbiBldmVudCBvbiBhbiBlbGVtZW50LgogICAgLy8gQGV4YW1wbGUgdHJpZ2dlckV2ZW50KCBkb2N1bWVudC5ib2R5LCAiY2xpY2siICk7CiAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBldmVudCApIHsKICAgICAgICBpZiAoIGRvY3VtZW50LmNyZWF0ZUV2ZW50ICkgewogICAgICAgICAgICBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCAiTW91c2VFdmVudHMiICk7CiAgICAgICAgICAgIGV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldywKICAgICAgICAgICAgICAgIDAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKCiAgICAgICAgICAgIGVsZW0uZGlzcGF0Y2hFdmVudCggZXZlbnQgKTsKICAgICAgICB9IGVsc2UgaWYgKCBlbGVtLmZpcmVFdmVudCApIHsKICAgICAgICAgICAgZWxlbS5maXJlRXZlbnQoICJvbiIgKyB0eXBlICk7CiAgICAgICAgfQogICAgfSwKCiAgICAvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nCiAgICBpczogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZSggb2JqICkgPT0gdHlwZTsKICAgIH0sCgogICAgb2JqZWN0VHlwZTogZnVuY3Rpb24oIG9iaiApIHsKICAgICAgICBpZiAoIHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiICkgewogICAgICAgICAgICAgICAgcmV0dXJuICJ1bmRlZmluZWQiOwogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CiAgICAgICAgfQogICAgICAgIGlmICggb2JqID09PSBudWxsICkgewogICAgICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKICAgICAgICB9CgogICAgICAgIHZhciB0eXBlID0gdG9TdHJpbmcuY2FsbCggb2JqICkubWF0Y2goL15cW29iamVjdFxzKC4qKVxdJC8pWzFdIHx8ICIiOwoKICAgICAgICBzd2l0Y2ggKCB0eXBlICkgewogICAgICAgICAgICBjYXNlICJOdW1iZXIiOgogICAgICAgICAgICAgICAgaWYgKCBpc05hTihvYmopICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAibmFuIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgY2FzZSAiU3RyaW5nIjoKICAgICAgICAgICAgY2FzZSAiQm9vbGVhbiI6CiAgICAgICAgICAgIGNhc2UgIkFycmF5IjoKICAgICAgICAgICAgY2FzZSAiRGF0ZSI6CiAgICAgICAgICAgIGNhc2UgIlJlZ0V4cCI6CiAgICAgICAgICAgIGNhc2UgIkZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfQogICAgICAgIGlmICggdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgKSB7CiAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0sCgogICAgcHVzaDogZnVuY3Rpb24oIHJlc3VsdCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSApIHsKICAgICAgICBpZiAoICFjb25maWcuY3VycmVudCApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCAiYXNzZXJ0aW9uIG91dHNpZGUgdGVzdCBjb250ZXh0LCB3YXMgIiArIHNvdXJjZUZyb21TdGFja3RyYWNlKCkgKTsKICAgICAgICB9CgogICAgICAgIHZhciBvdXRwdXQsIHNvdXJjZSwKICAgICAgICAgICAgZGV0YWlscyA9IHsKICAgICAgICAgICAgICAgIG1vZHVsZTogY29uZmlnLmN1cnJlbnQubW9kdWxlLAogICAgICAgICAgICAgICAgbmFtZTogY29uZmlnLmN1cnJlbnQudGVzdE5hbWUsCiAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdCwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgICAgICAgICBhY3R1YWw6IGFjdHVhbCwKICAgICAgICAgICAgICAgIGV4cGVjdGVkOiBleHBlY3RlZAogICAgICAgICAgICB9OwoKICAgICAgICBtZXNzYWdlID0gZXNjYXBlSW5uZXJUZXh0KCBtZXNzYWdlICkgfHwgKCByZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIiApOwogICAgICAgIG1lc3NhZ2UgPSAiPHNwYW4gY2xhc3M9J3Rlc3QtbWVzc2FnZSc+IiArIG1lc3NhZ2UgKyAiPC9zcGFuPiI7CiAgICAgICAgb3V0cHV0ID0gbWVzc2FnZTsKCiAgICAgICAgaWYgKCAhcmVzdWx0ICkgewogICAgICAgICAgICBleHBlY3RlZCA9IGVzY2FwZUlubmVyVGV4dCggUVVuaXQuanNEdW1wLnBhcnNlKGV4cGVjdGVkKSApOwogICAgICAgICAgICBhY3R1YWwgPSBlc2NhcGVJbm5lclRleHQoIFFVbml0LmpzRHVtcC5wYXJzZShhY3R1YWwpICk7CiAgICAgICAgICAgIG91dHB1dCArPSAiPHRhYmxlPjx0ciBjbGFzcz0ndGVzdC1leHBlY3RlZCc+PHRoPkV4cGVjdGVkOiA8L3RoPjx0ZD48cHJlPiIgKyBleHBlY3RlZCArICI8L3ByZT48L3RkPjwvdHI+IjsKCiAgICAgICAgICAgIGlmICggYWN0dWFsICE9IGV4cGVjdGVkICkgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9ICI8dHIgY2xhc3M9J3Rlc3QtYWN0dWFsJz48dGg+UmVzdWx0OiA8L3RoPjx0ZD48cHJlPiIgKyBhY3R1YWwgKyAiPC9wcmU+PC90ZD48L3RyPiI7CiAgICAgICAgICAgICAgICBvdXRwdXQgKz0gIjx0ciBjbGFzcz0ndGVzdC1kaWZmJz48dGg+RGlmZjogPC90aD48dGQ+PHByZT4iICsgUVVuaXQuZGlmZiggZXhwZWN0ZWQsIGFjdHVhbCApICsgIjwvcHJlPjwvdGQ+PC90cj4iOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzb3VyY2UgPSBzb3VyY2VGcm9tU3RhY2t0cmFjZSgpOwoKICAgICAgICAgICAgaWYgKCBzb3VyY2UgKSB7CiAgICAgICAgICAgICAgICBkZXRhaWxzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgICAgICAgIG91dHB1dCArPSAiPHRyIGNsYXNzPSd0ZXN0LXNvdXJjZSc+PHRoPlNvdXJjZTogPC90aD48dGQ+PHByZT4iICsgZXNjYXBlSW5uZXJUZXh0KCBzb3VyY2UgKSArICI8L3ByZT48L3RkPjwvdHI+IjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3V0cHV0ICs9ICI8L3RhYmxlPiI7CiAgICAgICAgfQoKICAgICAgICBydW5Mb2dnaW5nQ2FsbGJhY2tzKCAibG9nIiwgUVVuaXQsIGRldGFpbHMgKTsKCiAgICAgICAgY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsKICAgICAgICAgICAgcmVzdWx0OiAhIXJlc3VsdCwKICAgICAgICAgICAgbWVzc2FnZTogb3V0cHV0CiAgICAgICAgfSk7CiAgICB9LAoKICAgIHB1c2hGYWlsdXJlOiBmdW5jdGlvbiggbWVzc2FnZSwgc291cmNlLCBhY3R1YWwgKSB7CiAgICAgICAgaWYgKCAhY29uZmlnLmN1cnJlbnQgKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvciggInB1c2hGYWlsdXJlKCkgYXNzZXJ0aW9uIG91dHNpZGUgdGVzdCBjb250ZXh0LCB3YXMgIiArIHNvdXJjZUZyb21TdGFja3RyYWNlKDIpICk7CiAgICAgICAgfQoKICAgICAgICB2YXIgb3V0cHV0LAogICAgICAgICAgICBkZXRhaWxzID0gewogICAgICAgICAgICAgICAgbW9kdWxlOiBjb25maWcuY3VycmVudC5tb2R1bGUsCiAgICAgICAgICAgICAgICBuYW1lOiBjb25maWcuY3VycmVudC50ZXN0TmFtZSwKICAgICAgICAgICAgICAgIHJlc3VsdDogZmFsc2UsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlCiAgICAgICAgICAgIH07CgogICAgICAgIG1lc3NhZ2UgPSBlc2NhcGVJbm5lclRleHQoIG1lc3NhZ2UgKSB8fCAiZXJyb3IiOwogICAgICAgIG1lc3NhZ2UgPSAiPHNwYW4gY2xhc3M9J3Rlc3QtbWVzc2FnZSc+IiArIG1lc3NhZ2UgKyAiPC9zcGFuPiI7CiAgICAgICAgb3V0cHV0ID0gbWVzc2FnZTsKCiAgICAgICAgb3V0cHV0ICs9ICI8dGFibGU+IjsKCiAgICAgICAgaWYgKCBhY3R1YWwgKSB7CiAgICAgICAgICAgIG91dHB1dCArPSAiPHRyIGNsYXNzPSd0ZXN0LWFjdHVhbCc+PHRoPlJlc3VsdDogPC90aD48dGQ+PHByZT4iICsgZXNjYXBlSW5uZXJUZXh0KCBhY3R1YWwgKSArICI8L3ByZT48L3RkPjwvdHI+IjsKICAgICAgICB9CgogICAgICAgIGlmICggc291cmNlICkgewogICAgICAgICAgICBkZXRhaWxzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgICAgb3V0cHV0ICs9ICI8dHIgY2xhc3M9J3Rlc3Qtc291cmNlJz48dGg+U291cmNlOiA8L3RoPjx0ZD48cHJlPiIgKyBlc2NhcGVJbm5lclRleHQoIHNvdXJjZSApICsgIjwvcHJlPjwvdGQ+PC90cj4iOwogICAgICAgIH0KCiAgICAgICAgb3V0cHV0ICs9ICI8L3RhYmxlPiI7CgogICAgICAgIHJ1bkxvZ2dpbmdDYWxsYmFja3MoICJsb2ciLCBRVW5pdCwgZGV0YWlscyApOwoKICAgICAgICBjb25maWcuY3VycmVudC5hc3NlcnRpb25zLnB1c2goewogICAgICAgICAgICByZXN1bHQ6IGZhbHNlLAogICAgICAgICAgICBtZXNzYWdlOiBvdXRwdXQKICAgICAgICB9KTsKICAgIH0sCgogICAgdXJsOiBmdW5jdGlvbiggcGFyYW1zICkgewogICAgICAgIHBhcmFtcyA9IGV4dGVuZCggZXh0ZW5kKCB7fSwgUVVuaXQudXJsUGFyYW1zICksIHBhcmFtcyApOwogICAgICAgIHZhciBrZXksCiAgICAgICAgICAgIHF1ZXJ5c3RyaW5nID0gIj8iOwoKICAgICAgICBmb3IgKCBrZXkgaW4gcGFyYW1zICkgewogICAgICAgICAgICBpZiAoICFoYXNPd24uY2FsbCggcGFyYW1zLCBrZXkgKSApIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXJ5c3RyaW5nICs9IGVuY29kZVVSSUNvbXBvbmVudCgga2V5ICkgKyAiPSIgKwogICAgICAgICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KCBwYXJhbXNbIGtleSBdICkgKyAiJiI7CiAgICAgICAgfQogICAgICAgIHJldHVybiB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyBxdWVyeXN0cmluZy5zbGljZSggMCwgLTEgKTsKICAgIH0sCgogICAgZXh0ZW5kOiBleHRlbmQsCiAgICBpZDogaWQsCiAgICBhZGRFdmVudDogYWRkRXZlbnQKICAgIC8vIGxvYWQsIGVxdWl2LCBqc0R1bXAsIGRpZmY6IEF0dGFjaGVkIGxhdGVyCn0pOwoKLyoqCiAqIEBkZXByZWNhdGVkOiBDcmVhdGVkIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIHRlc3QgcnVubmVyIHRoYXQgc2V0IHRoZSBob29rIGZ1bmN0aW9uCiAqIGludG8gUVVuaXQue2hvb2t9LCBpbnN0ZWFkIG9mIGludm9raW5nIGl0IGFuZCBwYXNzaW5nIHRoZSBob29rIGZ1bmN0aW9uLgogKiBRVW5pdC5jb25zdHJ1Y3RvciBpcyBzZXQgdG8gdGhlIGVtcHR5IEYoKSBhYm92ZSBzbyB0aGF0IHdlIGNhbiBhZGQgdG8gaXQncyBwcm90b3R5cGUgaGVyZS4KICogRG9pbmcgdGhpcyBhbGxvd3MgdXMgdG8gdGVsbCBpZiB0aGUgZm9sbG93aW5nIG1ldGhvZHMgaGF2ZSBiZWVuIG92ZXJ3cml0dGVuIG9uIHRoZSBhY3R1YWwKICogUVVuaXQgb2JqZWN0LgogKi8KZXh0ZW5kKCBRVW5pdC5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHsKCiAgICAvLyBMb2dnaW5nIGNhbGxiYWNrczsgYWxsIHJlY2VpdmUgYSBzaW5nbGUgYXJndW1lbnQgd2l0aCB0aGUgbGlzdGVkIHByb3BlcnRpZXMKICAgIC8vIHJ1biB0ZXN0L2xvZ3MuaHRtbCBmb3IgYW55IHJlbGF0ZWQgY2hhbmdlcwogICAgYmVnaW46IHJlZ2lzdGVyTG9nZ2luZ0NhbGxiYWNrKCAiYmVnaW4iICksCgogICAgLy8gZG9uZTogeyBmYWlsZWQsIHBhc3NlZCwgdG90YWwsIHJ1bnRpbWUgfQogICAgZG9uZTogcmVnaXN0ZXJMb2dnaW5nQ2FsbGJhY2soICJkb25lIiApLAoKICAgIC8vIGxvZzogeyByZXN1bHQsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UgfQogICAgbG9nOiByZWdpc3RlckxvZ2dpbmdDYWxsYmFjayggImxvZyIgKSwKCiAgICAvLyB0ZXN0U3RhcnQ6IHsgbmFtZSB9CiAgICB0ZXN0U3RhcnQ6IHJlZ2lzdGVyTG9nZ2luZ0NhbGxiYWNrKCAidGVzdFN0YXJ0IiApLAoKICAgIC8vIHRlc3REb25lOiB7IG5hbWUsIGZhaWxlZCwgcGFzc2VkLCB0b3RhbCB9CiAgICB0ZXN0RG9uZTogcmVnaXN0ZXJMb2dnaW5nQ2FsbGJhY2soICJ0ZXN0RG9uZSIgKSwKCiAgICAvLyBtb2R1bGVTdGFydDogeyBuYW1lIH0KICAgIG1vZHVsZVN0YXJ0OiByZWdpc3RlckxvZ2dpbmdDYWxsYmFjayggIm1vZHVsZVN0YXJ0IiApLAoKICAgIC8vIG1vZHVsZURvbmU6IHsgbmFtZSwgZmFpbGVkLCBwYXNzZWQsIHRvdGFsIH0KICAgIG1vZHVsZURvbmU6IHJlZ2lzdGVyTG9nZ2luZ0NhbGxiYWNrKCAibW9kdWxlRG9uZSIgKQp9KTsKCmlmICggdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewogICAgY29uZmlnLmF1dG9ydW4gPSB0cnVlOwp9CgpRVW5pdC5sb2FkID0gZnVuY3Rpb24oKSB7CiAgICBydW5Mb2dnaW5nQ2FsbGJhY2tzKCAiYmVnaW4iLCBRVW5pdCwge30gKTsKCiAgICAvLyBJbml0aWFsaXplIHRoZSBjb25maWcsIHNhdmluZyB0aGUgZXhlY3V0aW9uIHF1ZXVlCiAgICB2YXIgYmFubmVyLCBmaWx0ZXIsIGksIGxhYmVsLCBsZW4sIG1haW4sIG9sLCB0b29sYmFyLCB1c2VyQWdlbnQsIHZhbCwgdXJsQ29uZmlnQ2hlY2tib3hlcywgbW9kdWxlRmlsdGVyLAogICAgICAgIG51bU1vZHVsZXMgPSAwLAogICAgICAgIG1vZHVsZUZpbHRlckh0bWwgPSAiIiwKICAgICAgICB1cmxDb25maWdIdG1sID0gIiIsCiAgICAgICAgb2xkY29uZmlnID0gZXh0ZW5kKCB7fSwgY29uZmlnICk7CgogICAgUVVuaXQuaW5pdCgpOwogICAgZXh0ZW5kKGNvbmZpZywgb2xkY29uZmlnKTsKCiAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCiAgICBsZW4gPSBjb25maWcudXJsQ29uZmlnLmxlbmd0aDsKCiAgICBmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgIHZhbCA9IGNvbmZpZy51cmxDb25maWdbaV07CiAgICAgICAgaWYgKCB0eXBlb2YgdmFsID09PSAic3RyaW5nIiApIHsKICAgICAgICAgICAgdmFsID0gewogICAgICAgICAgICAgICAgaWQ6IHZhbCwKICAgICAgICAgICAgICAgIGxhYmVsOiB2YWwsCiAgICAgICAgICAgICAgICB0b29sdGlwOiAiW25vIHRvb2x0aXAgYXZhaWxhYmxlXSIKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgY29uZmlnWyB2YWwuaWQgXSA9IFFVbml0LnVybFBhcmFtc1sgdmFsLmlkIF07CiAgICAgICAgdXJsQ29uZmlnSHRtbCArPSAiPGlucHV0IGlkPSdxdW5pdC11cmxjb25maWctIiArIHZhbC5pZCArICInIG5hbWU9JyIgKyB2YWwuaWQgKyAiJyB0eXBlPSdjaGVja2JveCciICsgKCBjb25maWdbIHZhbC5pZCBdID8gIiBjaGVja2VkPSdjaGVja2VkJyIgOiAiIiApICsgIiB0aXRsZT0nIiArIHZhbC50b29sdGlwICsgIic+PGxhYmVsIGZvcj0ncXVuaXQtdXJsY29uZmlnLSIgKyB2YWwuaWQgKyAiJyB0aXRsZT0nIiArIHZhbC50b29sdGlwICsgIic+IiArIHZhbC5sYWJlbCArICI8L2xhYmVsPiI7CiAgICB9CgogICAgbW9kdWxlRmlsdGVySHRtbCArPSAiPGxhYmVsIGZvcj0ncXVuaXQtbW9kdWxlZmlsdGVyJz5Nb2R1bGU6IDwvbGFiZWw+PHNlbGVjdCBpZD0ncXVuaXQtbW9kdWxlZmlsdGVyJyBuYW1lPSdtb2R1bGVmaWx0ZXInPjxvcHRpb24gdmFsdWU9JycgIiArICggY29uZmlnLm1vZHVsZSA9PT0gdW5kZWZpbmVkICA\/ICJzZWxlY3RlZCIgOiAiIiApICsgIj48IEFsbCBNb2R1bGVzID48L29wdGlvbj4iOwogICAgZm9yICggaSBpbiBjb25maWcubW9kdWxlcyApIHsKICAgICAgICBpZiAoIGNvbmZpZy5tb2R1bGVzLmhhc093blByb3BlcnR5KCBpICkgKSB7CiAgICAgICAgICAgIG51bU1vZHVsZXMgKz0gMTsKICAgICAgICAgICAgbW9kdWxlRmlsdGVySHRtbCArPSAiPG9wdGlvbiB2YWx1ZT0nIiArIGVuY29kZVVSSUNvbXBvbmVudChpKSArICInICIgKyAoIGNvbmZpZy5tb2R1bGUgPT09IGkgPyAic2VsZWN0ZWQiIDogIiIgKSArICI+IiArIGkgKyAiPC9vcHRpb24+IjsKICAgICAgICB9CiAgICB9CiAgICBtb2R1bGVGaWx0ZXJIdG1sICs9ICI8L3NlbGVjdD4iOwoKICAgIC8vIGB1c2VyQWdlbnRgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogICAgdXNlckFnZW50ID0gaWQoICJxdW5pdC11c2VyQWdlbnQiICk7CiAgICBpZiAoIHVzZXJBZ2VudCApIHsKICAgICAgICB1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgIH0KCiAgICAvLyBgYmFubmVyYCBpbml0aWFsaXplZCBhdCB0b3Agb2Ygc2NvcGUKICAgIGJhbm5lciA9IGlkKCAicXVuaXQtaGVhZGVyIiApOwogICAgaWYgKCBiYW5uZXIgKSB7CiAgICAgICAgYmFubmVyLmlubmVySFRNTCA9ICI8YSBocmVmPSciICsgUVVuaXQudXJsKHsgZmlsdGVyOiB1bmRlZmluZWQsIG1vZHVsZTogdW5kZWZpbmVkLCB0ZXN0TnVtYmVyOiB1bmRlZmluZWQgfSkgKyAiJz4iICsgYmFubmVyLmlubmVySFRNTCArICI8L2E+ICI7CiAgICB9CgogICAgLy8gYHRvb2xiYXJgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogICAgdG9vbGJhciA9IGlkKCAicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIiApOwogICAgaWYgKCB0b29sYmFyICkgewogICAgICAgIC8vIGBmaWx0ZXJgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogICAgICAgIGZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJpbnB1dCIgKTsKICAgICAgICBmaWx0ZXIudHlwZSA9ICJjaGVja2JveCI7CiAgICAgICAgZmlsdGVyLmlkID0gInF1bml0LWZpbHRlci1wYXNzIjsKCiAgICAgICAgYWRkRXZlbnQoIGZpbHRlciwgImNsaWNrIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0bXAsCiAgICAgICAgICAgICAgICBvbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCAicXVuaXQtdGVzdHMiICk7CgogICAgICAgICAgICBpZiAoIGZpbHRlci5jaGVja2VkICkgewogICAgICAgICAgICAgICAgb2wuY2xhc3NOYW1lID0gb2wuY2xhc3NOYW1lICsgIiBoaWRlcGFzcyI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0bXAgPSAiICIgKyBvbC5jbGFzc05hbWUucmVwbGFjZSggL1tcblx0XHJdL2csICIgIiApICsgIiAiOwogICAgICAgICAgICAgICAgb2wuY2xhc3NOYW1lID0gdG1wLnJlcGxhY2UoIC8gaGlkZXBhc3MgLywgIiAiICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCBkZWZpbmVkLnNlc3Npb25TdG9yYWdlICkgewogICAgICAgICAgICAgICAgaWYgKGZpbHRlci5jaGVja2VkKSB7CiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSggInF1bml0LWZpbHRlci1wYXNzZWQtdGVzdHMiLCAidHJ1ZSIgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSggInF1bml0LWZpbHRlci1wYXNzZWQtdGVzdHMiICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKCBjb25maWcuaGlkZXBhc3NlZCB8fCBkZWZpbmVkLnNlc3Npb25TdG9yYWdlICYmIHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oICJxdW5pdC1maWx0ZXItcGFzc2VkLXRlc3RzIiApICkgewogICAgICAgICAgICBmaWx0ZXIuY2hlY2tlZCA9IHRydWU7CiAgICAgICAgICAgIC8vIGBvbGAgaW5pdGlhbGl6ZWQgYXQgdG9wIG9mIHNjb3BlCiAgICAgICAgICAgIG9sID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoICJxdW5pdC10ZXN0cyIgKTsKICAgICAgICAgICAgb2wuY2xhc3NOYW1lID0gb2wuY2xhc3NOYW1lICsgIiBoaWRlcGFzcyI7CiAgICAgICAgfQogICAgICAgIHRvb2xiYXIuYXBwZW5kQ2hpbGQoIGZpbHRlciApOwoKICAgICAgICAvLyBgbGFiZWxgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQogICAgICAgIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxhYmVsIiApOwogICAgICAgIGxhYmVsLnNldEF0dHJpYnV0ZSggImZvciIsICJxdW5pdC1maWx0ZXItcGFzcyIgKTsKICAgICAgICBsYWJlbC5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsICJPbmx5IHNob3cgdGVzdHMgYW5kIGFzc2VydG9ucyB0aGF0IGZhaWwuIFN0b3JlZCBpbiBzZXNzaW9uU3RvcmFnZS4iICk7CiAgICAgICAgbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgcGFzc2VkIHRlc3RzIjsKICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOwoKICAgICAgICB1cmxDb25maWdDaGVja2JveGVzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ3NwYW4nICk7CiAgICAgICAgdXJsQ29uZmlnQ2hlY2tib3hlcy5pbm5lckhUTUwgPSB1cmxDb25maWdIdG1sOwogICAgICAgIGFkZEV2ZW50KCB1cmxDb25maWdDaGVja2JveGVzLCAiY2hhbmdlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewogICAgICAgICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgICAgICAgIHBhcmFtc1sgZXZlbnQudGFyZ2V0Lm5hbWUgXSA9IGV2ZW50LnRhcmdldC5jaGVja2VkID8gdHJ1ZSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gUVVuaXQudXJsKCBwYXJhbXMgKTsKICAgICAgICB9KTsKICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKCB1cmxDb25maWdDaGVja2JveGVzICk7CgogICAgICAgIGlmIChudW1Nb2R1bGVzID4gMSkgewogICAgICAgICAgICBtb2R1bGVGaWx0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnc3BhbicgKTsKICAgICAgICAgICAgbW9kdWxlRmlsdGVyLnNldEF0dHJpYnV0ZSggJ2lkJywgJ3F1bml0LW1vZHVsZWZpbHRlci1jb250YWluZXInICk7CiAgICAgICAgICAgIG1vZHVsZUZpbHRlci5pbm5lckhUTUwgPSBtb2R1bGVGaWx0ZXJIdG1sOwogICAgICAgICAgICBhZGRFdmVudCggbW9kdWxlRmlsdGVyLCAiY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0Qm94ID0gbW9kdWxlRmlsdGVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJzZWxlY3QiKVswXSwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZE1vZHVsZSA9IGRlY29kZVVSSUNvbXBvbmVudChzZWxlY3RCb3gub3B0aW9uc1tzZWxlY3RCb3guc2VsZWN0ZWRJbmRleF0udmFsdWUpOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IFFVbml0LnVybCggeyBtb2R1bGU6ICggc2VsZWN0ZWRNb2R1bGUgPT09ICIiICkgPyB1bmRlZmluZWQgOiBzZWxlY3RlZE1vZHVsZSB9ICk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKG1vZHVsZUZpbHRlcik7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGBtYWluYCBpbml0aWFsaXplZCBhdCB0b3Agb2Ygc2NvcGUKICAgIG1haW4gPSBpZCggInF1bml0LWZpeHR1cmUiICk7CiAgICBpZiAoIG1haW4gKSB7CiAgICAgICAgY29uZmlnLmZpeHR1cmUgPSBtYWluLmlubmVySFRNTDsKICAgIH0KCiAgICBpZiAoIGNvbmZpZy5hdXRvc3RhcnQgKSB7CiAgICAgICAgUVVuaXQuc3RhcnQoKTsKICAgIH0KfTsKCmFkZEV2ZW50KCB3aW5kb3csICJsb2FkIiwgUVVuaXQubG9hZCApOwoKLy8gYG9uRXJyb3JGblByZXZgIGluaXRpYWxpemVkIGF0IHRvcCBvZiBzY29wZQovLyBQcmVzZXJ2ZSBvdGhlciBoYW5kbGVycwpvbkVycm9yRm5QcmV2ID0gd2luZG93Lm9uZXJyb3I7CgovLyBDb3ZlciB1bmNhdWdodCBleGNlcHRpb25zCi8vIFJldHVybmluZyB0cnVlIHdpbGwgc3VycHJlc3MgdGhlIGRlZmF1bHQgYnJvd3NlciBoYW5kbGVyLAovLyByZXR1cm5pbmcgZmFsc2Ugd2lsbCBsZXQgaXQgcnVuLgp3aW5kb3cub25lcnJvciA9IGZ1bmN0aW9uICggZXJyb3IsIGZpbGVQYXRoLCBsaW5lck5yICkgewogICAgdmFyIHJldCA9IGZhbHNlOwogICAgaWYgKCBvbkVycm9yRm5QcmV2ICkgewogICAgICAgIHJldCA9IG9uRXJyb3JGblByZXYoIGVycm9yLCBmaWxlUGF0aCwgbGluZXJOciApOwogICAgfQoKICAgIC8vIFRyZWF0IHJldHVybiB2YWx1ZSBhcyB3aW5kb3cub25lcnJvciBpdHNlbGYgZG9lcywKICAgIC8vIE9ubHkgZG8gb3VyIGhhbmRsaW5nIGlmIG5vdCBzdXJwcmVzc2VkLgogICAgaWYgKCByZXQgIT09IHRydWUgKSB7CiAgICAgICAgaWYgKCBRVW5pdC5jb25maWcuY3VycmVudCApIHsKICAgICAgICAgICAgaWYgKCBRVW5pdC5jb25maWcuY3VycmVudC5pZ25vcmVHbG9iYWxFcnJvcnMgKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBRVW5pdC5wdXNoRmFpbHVyZSggZXJyb3IsIGZpbGVQYXRoICsgIjoiICsgbGluZXJOciApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFFVbml0LnRlc3QoICJnbG9iYWwgZmFpbHVyZSIsIGV4dGVuZCggZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBRVW5pdC5wdXNoRmFpbHVyZSggZXJyb3IsIGZpbGVQYXRoICsgIjoiICsgbGluZXJOciApOwogICAgICAgICAgICB9LCB7IHZhbGlkVGVzdDogdmFsaWRUZXN0IH0gKSApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHJldDsKfTsKCmZ1bmN0aW9uIGRvbmUoKSB7CiAgICBjb25maWcuYXV0b3J1biA9IHRydWU7CgogICAgLy8gTG9nIHRoZSBsYXN0IG1vZHVsZSByZXN1bHRzCiAgICBpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewogICAgICAgIHJ1bkxvZ2dpbmdDYWxsYmFja3MoICJtb2R1bGVEb25lIiwgUVVuaXQsIHsKICAgICAgICAgICAgbmFtZTogY29uZmlnLmN1cnJlbnRNb2R1bGUsCiAgICAgICAgICAgIGZhaWxlZDogY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwKICAgICAgICAgICAgcGFzc2VkOiBjb25maWcubW9kdWxlU3RhdHMuYWxsIC0gY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwKICAgICAgICAgICAgdG90YWw6IGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwKICAgICAgICB9KTsKICAgIH0KCiAgICB2YXIgaSwga2V5LAogICAgICAgIGJhbm5lciA9IGlkKCAicXVuaXQtYmFubmVyIiApLAogICAgICAgIHRlc3RzID0gaWQoICJxdW5pdC10ZXN0cyIgKSwKICAgICAgICBydW50aW1lID0gK25ldyBEYXRlKCkgLSBjb25maWcuc3RhcnRlZCwKICAgICAgICBwYXNzZWQgPSBjb25maWcuc3RhdHMuYWxsIC0gY29uZmlnLnN0YXRzLmJhZCwKICAgICAgICBodG1sID0gWwogICAgICAgICAgICAiVGVzdHMgY29tcGxldGVkIGluICIsCiAgICAgICAgICAgIHJ1bnRpbWUsCiAgICAgICAgICAgICIgbWlsbGlzZWNvbmRzLjxici8+IiwKICAgICAgICAgICAgIjxzcGFuIGNsYXNzPSdwYXNzZWQnPiIsCiAgICAgICAgICAgIHBhc3NlZCwKICAgICAgICAgICAgIjwvc3Bhbj4gdGVzdHMgb2YgPHNwYW4gY2xhc3M9J3RvdGFsJz4iLAogICAgICAgICAgICBjb25maWcuc3RhdHMuYWxsLAogICAgICAgICAgICAiPC9zcGFuPiBwYXNzZWQsIDxzcGFuIGNsYXNzPSdmYWlsZWQnPiIsCiAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5iYWQsCiAgICAgICAgICAgICI8L3NwYW4+IGZhaWxlZC4iCiAgICAgICAgXS5qb2luKCAiIiApOwoKICAgIGlmICggYmFubmVyICkgewogICAgICAgIGJhbm5lci5jbGFzc05hbWUgPSAoIGNvbmZpZy5zdGF0cy5iYWQgPyAicXVuaXQtZmFpbCIgOiAicXVuaXQtcGFzcyIgKTsKICAgIH0KCiAgICBpZiAoIHRlc3RzICkgewogICAgICAgIGlkKCAicXVuaXQtdGVzdHJlc3VsdCIgKS5pbm5lckhUTUwgPSBodG1sOwogICAgfQoKICAgIGlmICggY29uZmlnLmFsdGVydGl0bGUgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudC50aXRsZSApIHsKICAgICAgICAvLyBzaG93IOKcliBmb3IgZ29vZCwg4pyUIGZvciBiYWQgc3VpdGUgcmVzdWx0IGluIHRpdGxlCiAgICAgICAgLy8gdXNlIGVzY2FwZSBzZXF1ZW5jZXMgaW4gY2FzZSBmaWxlIGdldHMgbG9hZGVkIHdpdGggbm9uLXV0Zi04LWNoYXJzZXQKICAgICAgICBkb2N1bWVudC50aXRsZSA9IFsKICAgICAgICAgICAgKCBjb25maWcuc3RhdHMuYmFkID8gIlx1MjcxNiIgOiAiXHUyNzE0IiApLAogICAgICAgICAgICBkb2N1bWVudC50aXRsZS5yZXBsYWNlKCAvXltcdTI3MTRcdTI3MTZdIC9pLCAiIiApCiAgICAgICAgXS5qb2luKCAiICIgKTsKICAgIH0KCiAgICAvLyBjbGVhciBvd24gc2Vzc2lvblN0b3JhZ2UgaXRlbXMgaWYgYWxsIHRlc3RzIHBhc3NlZAogICAgaWYgKCBjb25maWcucmVvcmRlciAmJiBkZWZpbmVkLnNlc3Npb25TdG9yYWdlICYmIGNvbmZpZy5zdGF0cy5iYWQgPT09IDAgKSB7CiAgICAgICAgLy8gYGtleWAgJiBgaWAgaW5pdGlhbGl6ZWQgYXQgdG9wIG9mIHNjb3BlCiAgICAgICAgZm9yICggaSA9IDA7IGkgPCBzZXNzaW9uU3RvcmFnZS5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAga2V5ID0gc2Vzc2lvblN0b3JhZ2Uua2V5KCBpKysgKTsKICAgICAgICAgICAgaWYgKCBrZXkuaW5kZXhPZiggInF1bml0LXRlc3QtIiApID09PSAwICkgewogICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgga2V5ICk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gc2Nyb2xsIGJhY2sgdG8gdG9wIHRvIHNob3cgcmVzdWx0cwogICAgaWYgKCB3aW5kb3cuc2Nyb2xsVG8gKSB7CiAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIDApOwogICAgfQoKICAgIHJ1bkxvZ2dpbmdDYWxsYmFja3MoICJkb25lIiwgUVVuaXQsIHsKICAgICAgICBmYWlsZWQ6IGNvbmZpZy5zdGF0cy5iYWQsCiAgICAgICAgcGFzc2VkOiBwYXNzZWQsCiAgICAgICAgdG90YWw6IGNvbmZpZy5zdGF0cy5hbGwsCiAgICAgICAgcnVudGltZTogcnVudGltZQogICAgfSk7Cn0KCi8qKiBAcmV0dXJuIEJvb2xlYW46IHRydWUgaWYgdGhpcyB0ZXN0IHNob3VsZCBiZSByYW4gKi8KZnVuY3Rpb24gdmFsaWRUZXN0KCB0ZXN0ICkgewogICAgdmFyIGluY2x1ZGUsCiAgICAgICAgZmlsdGVyID0gY29uZmlnLmZpbHRlciAmJiBjb25maWcuZmlsdGVyLnRvTG93ZXJDYXNlKCksCiAgICAgICAgbW9kdWxlID0gY29uZmlnLm1vZHVsZSAmJiBjb25maWcubW9kdWxlLnRvTG93ZXJDYXNlKCksCiAgICAgICAgZnVsbE5hbWUgPSAodGVzdC5tb2R1bGUgKyAiOiAiICsgdGVzdC50ZXN0TmFtZSkudG9Mb3dlckNhc2UoKTsKCiAgICAvLyBJbnRlcm5hbGx5LWdlbmVyYXRlZCB0ZXN0cyBhcmUgYWx3YXlzIHZhbGlkCiAgICBpZiAoIHRlc3QuY2FsbGJhY2sgJiYgdGVzdC5jYWxsYmFjay52YWxpZFRlc3QgPT09IHZhbGlkVGVzdCApIHsKICAgICAgICBkZWxldGUgdGVzdC5jYWxsYmFjay52YWxpZFRlc3Q7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaWYgKCBjb25maWcudGVzdE51bWJlciApIHsKICAgICAgICByZXR1cm4gdGVzdC50ZXN0TnVtYmVyID09PSBjb25maWcudGVzdE51bWJlcjsKICAgIH0KCiAgICBpZiAoIG1vZHVsZSAmJiAoICF0ZXN0Lm1vZHVsZSB8fCB0ZXN0Lm1vZHVsZS50b0xvd2VyQ2FzZSgpICE9PSBtb2R1bGUgKSApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKCAhZmlsdGVyICkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGluY2x1ZGUgPSBmaWx0ZXIuY2hhckF0KCAwICkgIT09ICIhIjsKICAgIGlmICggIWluY2x1ZGUgKSB7CiAgICAgICAgZmlsdGVyID0gZmlsdGVyLnNsaWNlKCAxICk7CiAgICB9CgogICAgLy8gSWYgdGhlIGZpbHRlciBtYXRjaGVzLCB3ZSBuZWVkIHRvIGhvbm91ciBpbmNsdWRlCiAgICBpZiAoIGZ1bGxOYW1lLmluZGV4T2YoIGZpbHRlciApICE9PSAtMSApIHsKICAgICAgICByZXR1cm4gaW5jbHVkZTsKICAgIH0KCiAgICAvLyBPdGhlcndpc2UsIGRvIHRoZSBvcHBvc2l0ZQogICAgcmV0dXJuICFpbmNsdWRlOwp9CgovLyBzbyBmYXIgc3VwcG9ydHMgb25seSBGaXJlZm94LCBDaHJvbWUgYW5kIE9wZXJhIChidWdneSksIFNhZmFyaSAoZm9yIHJlYWwgZXhjZXB0aW9ucykKLy8gTGF0ZXIgU2FmYXJpIGFuZCBJRTEwIGFyZSBzdXBwb3NlZCB0byBzdXBwb3J0IGVycm9yLnN0YWNrIGFzIHdlbGwKLy8gU2VlIGFsc28gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvRXJyb3IvU3RhY2sKZnVuY3Rpb24gZXh0cmFjdFN0YWNrdHJhY2UoIGUsIG9mZnNldCApIHsKICAgIG9mZnNldCA9IG9mZnNldCA9PT0gdW5kZWZpbmVkID8gMyA6IG9mZnNldDsKCiAgICB2YXIgc3RhY2ssIGluY2x1ZGUsIGksIHJlZ2V4OwoKICAgIGlmICggZS5zdGFja3RyYWNlICkgewogICAgICAgIC8vIE9wZXJhCiAgICAgICAgcmV0dXJuIGUuc3RhY2t0cmFjZS5zcGxpdCggIlxuIiApWyBvZmZzZXQgKyAzIF07CiAgICB9IGVsc2UgaWYgKCBlLnN0YWNrICkgewogICAgICAgIC8vIEZpcmVmb3gsIENocm9tZQogICAgICAgIHN0YWNrID0gZS5zdGFjay5zcGxpdCggIlxuIiApOwogICAgICAgIGlmICgvXmVycm9yJC9pLnRlc3QoIHN0YWNrWzBdICkgKSB7CiAgICAgICAgICAgIHN0YWNrLnNoaWZ0KCk7CiAgICAgICAgfQogICAgICAgIGlmICggZmlsZU5hbWUgKSB7CiAgICAgICAgICAgIGluY2x1ZGUgPSBbXTsKICAgICAgICAgICAgZm9yICggaSA9IG9mZnNldDsgaSA8IHN0YWNrLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICAgICAgaWYgKCBzdGFja1sgaSBdLmluZGV4T2YoIGZpbGVOYW1lICkgIT0gLTEgKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmNsdWRlLnB1c2goIHN0YWNrWyBpIF0gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIGluY2x1ZGUubGVuZ3RoICkgewogICAgICAgICAgICAgICAgcmV0dXJuIGluY2x1ZGUuam9pbiggIlxuIiApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdGFja1sgb2Zmc2V0IF07CiAgICB9IGVsc2UgaWYgKCBlLnNvdXJjZVVSTCApIHsKICAgICAgICAvLyBTYWZhcmksIFBoYW50b21KUwogICAgICAgIC8vIGhvcGVmdWxseSBvbmUgZGF5IFNhZmFyaSBwcm92aWRlcyBhY3R1YWwgc3RhY2t0cmFjZXMKICAgICAgICAvLyBleGNsdWRlIHVzZWxlc3Mgc2VsZi1yZWZlcmVuY2UgZm9yIGdlbmVyYXRlZCBFcnJvciBvYmplY3RzCiAgICAgICAgaWYgKCAvcXVuaXQuanMkLy50ZXN0KCBlLnNvdXJjZVVSTCApICkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIGZvciBhY3R1YWwgZXhjZXB0aW9ucywgdGhpcyBpcyB1c2VmdWwKICAgICAgICByZXR1cm4gZS5zb3VyY2VVUkwgKyAiOiIgKyBlLmxpbmU7CiAgICB9Cn0KZnVuY3Rpb24gc291cmNlRnJvbVN0YWNrdHJhY2UoIG9mZnNldCApIHsKICAgIHRyeSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9IGNhdGNoICggZSApIHsKICAgICAgICByZXR1cm4gZXh0cmFjdFN0YWNrdHJhY2UoIGUsIG9mZnNldCApOwogICAgfQp9CgpmdW5jdGlvbiBlc2NhcGVJbm5lclRleHQoIHMgKSB7CiAgICBpZiAoICFzICkgewogICAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIHMgPSBzICsgIiI7CiAgICByZXR1cm4gcy5yZXBsYWNlKCAvW1wmPD5dL2csIGZ1bmN0aW9uKCBzICkgewogICAgICAgIHN3aXRjaCggcyApIHsKICAgICAgICAgICAgY2FzZSAiJiI6IHJldHVybiAiJmFtcDsiOwogICAgICAgICAgICBjYXNlICI8IjogcmV0dXJuICImbHQ7IjsKICAgICAgICAgICAgY2FzZSAiPiI6IHJldHVybiAiJmd0OyI7CiAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBzOwogICAgICAgIH0KICAgIH0pOwp9CgpmdW5jdGlvbiBzeW5jaHJvbml6ZSggY2FsbGJhY2ssIGxhc3QgKSB7CiAgICBjb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsKCiAgICBpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7CiAgICAgICAgcHJvY2VzcyggbGFzdCApOwogICAgfQp9CgpmdW5jdGlvbiBwcm9jZXNzKCBsYXN0ICkgewogICAgZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICBwcm9jZXNzKCBsYXN0ICk7CiAgICB9CiAgICB2YXIgc3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGNvbmZpZy5kZXB0aCA9IGNvbmZpZy5kZXB0aCA\/IGNvbmZpZy5kZXB0aCArIDEgOiAxOwoKICAgIHdoaWxlICggY29uZmlnLnF1ZXVlLmxlbmd0aCAmJiAhY29uZmlnLmJsb2NraW5nICkgewogICAgICAgIGlmICggIWRlZmluZWQuc2V0VGltZW91dCB8fCBjb25maWcudXBkYXRlUmF0ZSA8PSAwIHx8ICggKCBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHN0YXJ0ICkgPCBjb25maWcudXBkYXRlUmF0ZSApICkgewogICAgICAgICAgICBjb25maWcucXVldWUuc2hpZnQoKSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCBuZXh0LCAxMyApOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9CiAgICBjb25maWcuZGVwdGgtLTsKICAgIGlmICggbGFzdCAmJiAhY29uZmlnLmJsb2NraW5nICYmICFjb25maWcucXVldWUubGVuZ3RoICYmIGNvbmZpZy5kZXB0aCA9PT0gMCApIHsKICAgICAgICBkb25lKCk7CiAgICB9Cn0KCmZ1bmN0aW9uIHNhdmVHbG9iYWwoKSB7CiAgICBjb25maWcucG9sbHV0aW9uID0gW107CgogICAgaWYgKCBjb25maWcubm9nbG9iYWxzICkgewogICAgICAgIGZvciAoIHZhciBrZXkgaW4gd2luZG93ICkgewogICAgICAgICAgICAvLyBpbiBPcGVyYSBzb21ldGltZXMgRE9NIGVsZW1lbnQgaWRzIHNob3cgdXAgaGVyZSwgaWdub3JlIHRoZW0KICAgICAgICAgICAgaWYgKCAhaGFzT3duLmNhbGwoIHdpbmRvdywga2V5ICkgfHwgL15xdW5pdC10ZXN0LW91dHB1dC8udGVzdCgga2V5ICkgKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25maWcucG9sbHV0aW9uLnB1c2goIGtleSApOwogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24oIG5hbWUgKSB7CiAgICB2YXIgbmV3R2xvYmFscywKICAgICAgICBkZWxldGVkR2xvYmFscywKICAgICAgICBvbGQgPSBjb25maWcucG9sbHV0aW9uOwoKICAgIHNhdmVHbG9iYWwoKTsKCiAgICBuZXdHbG9iYWxzID0gZGlmZiggY29uZmlnLnBvbGx1dGlvbiwgb2xkICk7CiAgICBpZiAoIG5ld0dsb2JhbHMubGVuZ3RoID4gMCApIHsKICAgICAgICBRVW5pdC5wdXNoRmFpbHVyZSggIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpICk7CiAgICB9CgogICAgZGVsZXRlZEdsb2JhbHMgPSBkaWZmKCBvbGQsIGNvbmZpZy5wb2xsdXRpb24gKTsKICAgIGlmICggZGVsZXRlZEdsb2JhbHMubGVuZ3RoID4gMCApIHsKICAgICAgICBRVW5pdC5wdXNoRmFpbHVyZSggIkRlbGV0ZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgZGVsZXRlZEdsb2JhbHMuam9pbigiLCAiKSApOwogICAgfQp9CgovLyByZXR1cm5zIGEgbmV3IEFycmF5IHdpdGggdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgYnV0IG5vdCBpbiBiCmZ1bmN0aW9uIGRpZmYoIGEsIGIgKSB7CiAgICB2YXIgaSwgaiwKICAgICAgICByZXN1bHQgPSBhLnNsaWNlKCk7CgogICAgZm9yICggaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgZm9yICggaiA9IDA7IGogPCBiLmxlbmd0aDsgaisrICkgewogICAgICAgICAgICBpZiAoIHJlc3VsdFtpXSA9PT0gYltqXSApIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5zcGxpY2UoIGksIDEgKTsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gZXh0ZW5kKCBhLCBiICkgewogICAgZm9yICggdmFyIHByb3AgaW4gYiApIHsKICAgICAgICBpZiAoIGJbIHByb3AgXSA9PT0gdW5kZWZpbmVkICkgewogICAgICAgICAgICBkZWxldGUgYVsgcHJvcCBdOwoKICAgICAgICAvLyBBdm9pZCAiTWVtYmVyIG5vdCBmb3VuZCIgZXJyb3IgaW4gSUU4IGNhdXNlZCBieSBzZXR0aW5nIHdpbmRvdy5jb25zdHJ1Y3RvcgogICAgICAgIH0gZWxzZSBpZiAoIHByb3AgIT09ICJjb25zdHJ1Y3RvciIgfHwgYSAhPT0gd2luZG93ICkgewogICAgICAgICAgICBhWyBwcm9wIF0gPSBiWyBwcm9wIF07CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBhOwp9CgpmdW5jdGlvbiBhZGRFdmVudCggZWxlbSwgdHlwZSwgZm4gKSB7CiAgICBpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGZuLCBmYWxzZSApOwogICAgfSBlbHNlIGlmICggZWxlbS5hdHRhY2hFdmVudCApIHsKICAgICAgICBlbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZm4gKTsKICAgIH0gZWxzZSB7CiAgICAgICAgZm4oKTsKICAgIH0KfQoKZnVuY3Rpb24gaWQoIG5hbWUgKSB7CiAgICByZXR1cm4gISEoIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQgKSAmJgogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBuYW1lICk7Cn0KCmZ1bmN0aW9uIHJlZ2lzdGVyTG9nZ2luZ0NhbGxiYWNrKCBrZXkgKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oIGNhbGxiYWNrICkgewogICAgICAgIGNvbmZpZ1trZXldLnB1c2goIGNhbGxiYWNrICk7CiAgICB9Owp9CgovLyBTdXBwb3J0cyBkZXByZWNhdGVkIG1ldGhvZCBvZiBjb21wbGV0ZWx5IG92ZXJ3cml0aW5nIGxvZ2dpbmcgY2FsbGJhY2tzCmZ1bmN0aW9uIHJ1bkxvZ2dpbmdDYWxsYmFja3MoIGtleSwgc2NvcGUsIGFyZ3MgKSB7CiAgICAvL2RlYnVnZ2VyOwogICAgdmFyIGksIGNhbGxiYWNrczsKICAgIGlmICggUVVuaXQuaGFzT3duUHJvcGVydHkoIGtleSApICkgewogICAgICAgIFFVbml0WyBrZXkgXS5jYWxsKHNjb3BlLCBhcmdzICk7CiAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcyA9IGNvbmZpZ1sga2V5IF07CiAgICAgICAgZm9yICggaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgIGNhbGxiYWNrc1sgaSBdLmNhbGwoIHNjb3BlLCBhcmdzICk7CiAgICAgICAgfQogICAgfQp9CgovLyBUZXN0IGZvciBlcXVhbGl0eSBhbnkgSmF2YVNjcmlwdCB0eXBlLgovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4KUVVuaXQuZXF1aXYgPSAoZnVuY3Rpb24oKSB7CgogICAgLy8gQ2FsbCB0aGUgbyByZWxhdGVkIGNhbGxiYWNrIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgIGZ1bmN0aW9uIGJpbmRDYWxsYmFja3MoIG8sIGNhbGxiYWNrcywgYXJncyApIHsKICAgICAgICB2YXIgcHJvcCA9IFFVbml0Lm9iamVjdFR5cGUoIG8gKTsKICAgICAgICBpZiAoIHByb3AgKSB7CiAgICAgICAgICAgIGlmICggUVVuaXQub2JqZWN0VHlwZSggY2FsbGJhY2tzWyBwcm9wIF0gKSA9PT0gImZ1bmN0aW9uIiApIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbIHByb3AgXS5hcHBseSggY2FsbGJhY2tzLCBhcmdzICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzWyBwcm9wIF07IC8vIG9yIHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uCiAgICB2YXIgaW5uZXJFcXVpdiwKICAgICAgICAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwogICAgICAgIGNhbGxlcnMgPSBbXSwKICAgICAgICAvLyBzdGFjayB0byBhdm9pZGluZyBsb29wcyBmcm9tIGNpcmN1bGFyIHJlZmVyZW5jaW5nCiAgICAgICAgcGFyZW50cyA9IFtdLAoKICAgICAgICBnZXRQcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZiB8fCBmdW5jdGlvbiAoIG9iaiApIHsKICAgICAgICAgICAgcmV0dXJuIG9iai5fX3Byb3RvX187CiAgICAgICAgfSwKICAgICAgICBjYWxsYmFja3MgPSAoZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgLy8gZm9yIHN0cmluZywgYm9vbGVhbiwgbnVtYmVyIGFuZCBudWxsCiAgICAgICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KCBiLCBhICkgewogICAgICAgICAgICAgICAgaWYgKCBiIGluc3RhbmNlb2YgYS5jb25zdHJ1Y3RvciB8fCBhIGluc3RhbmNlb2YgYi5jb25zdHJ1Y3RvciApIHsKICAgICAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhCiAgICAgICAgICAgICAgICAgICAgLy8gZGVjbGFyYXRpb24KICAgICAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgICAgICAvLyB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICAgICAiYm9vbGVhbiI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgIm51bWJlciI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgICAgICJ1bmRlZmluZWQiOiB1c2VTdHJpY3RFcXVhbGl0eSwKCiAgICAgICAgICAgICAgICAibmFuIjogZnVuY3Rpb24oIGIgKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKCBiICk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJkYXRlIjogZnVuY3Rpb24oIGIsIGEgKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoIGIgKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uKCBiLCBhICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBRVW5pdC5vYmplY3RUeXBlKCBiICkgPT09ICJyZWdleHAiICYmCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSByZWdleCBpdHNlbGYKICAgICAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBpdHMgbW9kaWZlcnMKICAgICAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIChnbWkpIC4uLgogICAgICAgICAgICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT09IGIuaWdub3JlQ2FzZSAmJgogICAgICAgICAgICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PT0gYi5tdWx0aWxpbmUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgYS5zdGlja3kgPT09IGIuc3RpY2t5OwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgICAgIC8vIC0gYWJvcnQgb3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgLy8gaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkKICAgICAgICAgICAgICAgICJmdW5jdGlvbiI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBjYWxsZXIgPSBjYWxsZXJzW2NhbGxlcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlciAhPT0gT2JqZWN0ICYmIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAiYXJyYXkiOiBmdW5jdGlvbiggYiwgYSApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbGVuLCBsb29wOwoKICAgICAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUKICAgICAgICAgICAgICAgICAgICBpZiAoIFFVbml0Lm9iamVjdFR5cGUoIGIgKSAhPT0gImFycmF5IiApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKCBsZW4gIT09IGIubGVuZ3RoICkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goIGEgKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewogICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIGogPSAwOyBqIDwgcGFyZW50cy5sZW5ndGg7IGorKyApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggcGFyZW50c1tqXSA9PT0gYVtpXSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsvLyBkb250IHJld2FsayBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggIWxvb3AgJiYgIWlubmVyRXF1aXYoYVtpXSwgYltpXSkgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiggYiwgYSApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcCwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmYXVsdCB0byB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgYVByb3BlcnRpZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gaW5zdGFuY2VvZgogICAgICAgICAgICAgICAgICAgIGlmICggYS5jb25zdHJ1Y3RvciAhPT0gYi5jb25zdHJ1Y3RvciApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWxsb3cgb2JqZWN0cyB3aXRoIG5vIHByb3RvdHlwZSB0byBiZSBlcXVpdmFsZW50IHRvCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9iamVjdHMgd2l0aCBPYmplY3QgYXMgdGhlaXIgY29uc3RydWN0b3IuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggISgoIGdldFByb3RvKGEpID09PSBudWxsICYmIGdldFByb3RvKGIpID09PSBPYmplY3QucHJvdG90eXBlICkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICggZ2V0UHJvdG8oYikgPT09IG51bGwgJiYgZ2V0UHJvdG8oYSkgPT09IE9iamVjdC5wcm90b3R5cGUgKSApICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaCggYS5jb25zdHJ1Y3RvciApOwogICAgICAgICAgICAgICAgICAgIC8vIHRyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzCiAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKCBhICk7CgogICAgICAgICAgICAgICAgICAgIGZvciAoIGkgaW4gYSApIHsgLy8gYmUgc3RyaWN0OiBkb24ndCBlbnN1cmVzIGhhc093blByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBnbyBkZWVwCiAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggaiA9IDA7IGogPCBwYXJlbnRzLmxlbmd0aDsgaisrICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBwYXJlbnRzW2pdID09PSBhW2ldICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGdvIGRvd24gdGhlIHNhbWUgcGF0aCB0d2ljZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYSdzIHByb3BlcnRpZXMKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbG9vcCAmJiAhaW5uZXJFcXVpdiggYVtpXSwgYltpXSApICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXEgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQogICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CgogICAgICAgICAgICAgICAgICAgIGZvciAoIGkgaW4gYiApIHsKICAgICAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaCggaSApOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmVzIGlkZW50aWNhbCBwcm9wZXJ0aWVzIG5hbWUKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdiggYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9KCkpOwoKICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbigpIHsgLy8gY2FuIHRha2UgbXVsdGlwbGUgYXJndW1lbnRzCiAgICAgICAgdmFyIGFyZ3MgPSBbXS5zbGljZS5hcHBseSggYXJndW1lbnRzICk7CiAgICAgICAgaWYgKCBhcmdzLmxlbmd0aCA8IDIgKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBlbmQgdHJhbnNpdGlvbgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChmdW5jdGlvbiggYSwgYiApIHsKICAgICAgICAgICAgaWYgKCBhID09PSBiICkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGNhdGNoIHRoZSBtb3N0IHlvdSBjYW4KICAgICAgICAgICAgfSBlbHNlIGlmICggYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fAogICAgICAgICAgICAgICAgICAgIHR5cGVvZiBiID09PSAidW5kZWZpbmVkIiB8fAogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9iamVjdFR5cGUoYSkgIT09IFFVbml0Lm9iamVjdFR5cGUoYikgKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluZENhbGxiYWNrcyhhLCBjYWxsYmFja3MsIFsgYiwgYSBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiB3aXRoICgxLi5uKSBhcmd1bWVudHMKICAgICAgICB9KCBhcmdzWzBdLCBhcmdzWzFdICkgJiYgYXJndW1lbnRzLmNhbGxlZS5hcHBseSggdGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLSAxICkpICk7CiAgICB9OwoKICAgIHJldHVybiBpbm5lckVxdWl2Owp9KCkpOwoKLyoqCiAqIGpzRHVtcCBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfAogKiBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20gTGljZW5zZWQgdW5kZXIgQlNECiAqIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkgRGF0ZTogNS8xNS8yMDA4CiAqCiAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0LgogKiBAdmVyc2lvbiAxLjAuMAogKiBAYXV0aG9yIEFyaWVsIEZsZXNsZXIKICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQogKi8KUVVuaXQuanNEdW1wID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gcXVvdGUoIHN0ciApIHsKICAgICAgICByZXR1cm4gJyInICsgc3RyLnRvU3RyaW5nKCkucmVwbGFjZSggLyIvZywgJ1xcIicgKSArICciJzsKICAgIH0KICAgIGZ1bmN0aW9uIGxpdGVyYWwoIG8gKSB7CiAgICAgICAgcmV0dXJuIG8gKyAiIjsKICAgIH0KICAgIGZ1bmN0aW9uIGpvaW4oIHByZSwgYXJyLCBwb3N0ICkgewogICAgICAgIHZhciBzID0ganNEdW1wLnNlcGFyYXRvcigpLAogICAgICAgICAgICBiYXNlID0ganNEdW1wLmluZGVudCgpLAogICAgICAgICAgICBpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7CiAgICAgICAgaWYgKCBhcnIuam9pbiApIHsKICAgICAgICAgICAgYXJyID0gYXJyLmpvaW4oICIsIiArIHMgKyBpbm5lciApOwogICAgICAgIH0KICAgICAgICBpZiAoICFhcnIgKSB7CiAgICAgICAgICAgIHJldHVybiBwcmUgKyBwb3N0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gWyBwcmUsIGlubmVyICsgYXJyLCBiYXNlICsgcG9zdCBdLmpvaW4ocyk7CiAgICB9CiAgICBmdW5jdGlvbiBhcnJheSggYXJyLCBzdGFjayApIHsKICAgICAgICB2YXIgaSA9IGFyci5sZW5ndGgsIHJldCA9IG5ldyBBcnJheShpKTsKICAgICAgICB0aGlzLnVwKCk7CiAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgIHJldFtpXSA9IHRoaXMucGFyc2UoIGFycltpXSAsIHVuZGVmaW5lZCAsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5kb3duKCk7CiAgICAgICAgcmV0dXJuIGpvaW4oICJbIiwgcmV0LCAiXSIgKTsKICAgIH0KCiAgICB2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS8sCiAgICAgICAganNEdW1wID0gewogICAgICAgICAgICBwYXJzZTogZnVuY3Rpb24oIG9iaiwgdHlwZSwgc3RhY2sgKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlCiAgICAgICAgICAgICAgICBzdGFjayA9IHN0YWNrIHx8IFsgXTsKICAgICAgICAgICAgICAgIHZhciBpblN0YWNrLCByZXMsCiAgICAgICAgICAgICAgICAgICAgcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsKCiAgICAgICAgICAgICAgICB0eXBlID0gdHlwZW9mIHBhcnNlcjsKICAgICAgICAgICAgICAgIGluU3RhY2sgPSBpbkFycmF5KCBvYmosIHN0YWNrICk7CgogICAgICAgICAgICAgICAgaWYgKCBpblN0YWNrICE9IC0xICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAicmVjdXJzaW9uKCIgKyAoaW5TdGFjayAtIHN0YWNrLmxlbmd0aCkgKyAiKSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL2Vsc2UKICAgICAgICAgICAgICAgIGlmICggdHlwZSA9PSAiZnVuY3Rpb24iICkgIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKCBvYmogKTsKICAgICAgICAgICAgICAgICAgICByZXMgPSBwYXJzZXIuY2FsbCggdGhpcywgb2JqLCBzdGFjayApOwogICAgICAgICAgICAgICAgICAgIHN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBlbHNlCiAgICAgICAgICAgICAgICByZXR1cm4gKCB0eXBlID09ICJzdHJpbmciICkgPyBwYXJzZXIgOiB0aGlzLnBhcnNlcnMuZXJyb3I7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHR5cGVPZjogZnVuY3Rpb24oIG9iaiApIHsKICAgICAgICAgICAgICAgIHZhciB0eXBlOwogICAgICAgICAgICAgICAgaWYgKCBvYmogPT09IG51bGwgKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJudWxsIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiICkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIFFVbml0LmlzKCAicmVnZXhwIiwgb2JqKSApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInJlZ2V4cCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBRVW5pdC5pcyggImRhdGUiLCBvYmopICkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiZGF0ZSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBRVW5pdC5pcyggImZ1bmN0aW9uIiwgb2JqKSApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gImZ1bmN0aW9uIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIHR5cGVvZiBvYmouc2V0SW50ZXJ2YWwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2JqLmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygb2JqLm5vZGVUeXBlID09PSAidW5kZWZpbmVkIiApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gIndpbmRvdyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBvYmoubm9kZVR5cGUgPT09IDkgKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJkb2N1bWVudCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBvYmoubm9kZVR5cGUgKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJub2RlIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgLy8gbmF0aXZlIGFycmF5cwogICAgICAgICAgICAgICAgICAgIHRvU3RyaW5nLmNhbGwoIG9iaiApID09PSAiW29iamVjdCBBcnJheV0iIHx8CiAgICAgICAgICAgICAgICAgICAgLy8gTm9kZUxpc3Qgb2JqZWN0cwogICAgICAgICAgICAgICAgICAgICggdHlwZW9mIG9iai5sZW5ndGggPT09ICJudW1iZXIiICYmIHR5cGVvZiBvYmouaXRlbSAhPT0gInVuZGVmaW5lZCIgJiYgKCBvYmoubGVuZ3RoID8gb2JqLml0ZW0oMCkgPT09IG9ialswXSA6ICggb2JqLml0ZW0oIDAgKSA9PT0gbnVsbCAmJiB0eXBlb2Ygb2JqWzBdID09PSAidW5kZWZpbmVkIiApICkgKQogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJhcnJheSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlb2Ygb2JqOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNlcGFyYXRvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tdWx0aWxpbmUgPyB0aGlzLkhUTUwgPyAiPGJyIC8+IiA6ICJcbiIgOiB0aGlzLkhUTUwgPyAiJm5ic3A7IiA6ICIgIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5kZW50OiBmdW5jdGlvbiggZXh0cmEgKSB7Ly8gZXh0cmEgY2FuIGJlIGEgbnVtYmVyLCBzaG9ydGN1dCBmb3IgaW5jcmVhc2luZy1jYWxsaW5nLWRlY3JlYXNpbmcKICAgICAgICAgICAgICAgIGlmICggIXRoaXMubXVsdGlsaW5lICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7CiAgICAgICAgICAgICAgICBpZiAoIHRoaXMuSFRNTCApIHsKICAgICAgICAgICAgICAgICAgICBjaHIgPSBjaHIucmVwbGFjZSggL1x0L2csICIgICAiICkucmVwbGFjZSggLyAvZywgIiZuYnNwOyIgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVwOiBmdW5jdGlvbiggYSApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RlcHRoXyArPSBhIHx8IDE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRvd246IGZ1bmN0aW9uKCBhICkgewogICAgICAgICAgICAgICAgdGhpcy5fZGVwdGhfIC09IGEgfHwgMTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0UGFyc2VyOiBmdW5jdGlvbiggbmFtZSwgcGFyc2VyICkgewogICAgICAgICAgICAgICAgdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBUaGUgbmV4dCAzIGFyZSBleHBvc2VkIHNvIHlvdSBjYW4gdXNlIHRoZW0KICAgICAgICAgICAgcXVvdGU6IHF1b3RlLAogICAgICAgICAgICBsaXRlcmFsOiBsaXRlcmFsLAogICAgICAgICAgICBqb2luOiBqb2luLAogICAgICAgICAgICAvLwogICAgICAgICAgICBfZGVwdGhfOiAxLAogICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBsaXN0IG9mIHBhcnNlcnMsIHRvIG1vZGlmeSB0aGVtLCB1c2UganNEdW1wLnNldFBhcnNlcgogICAgICAgICAgICBwYXJzZXJzOiB7CiAgICAgICAgICAgICAgICB3aW5kb3c6ICJbV2luZG93XSIsCiAgICAgICAgICAgICAgICBkb2N1bWVudDogIltEb2N1bWVudF0iLAogICAgICAgICAgICAgICAgZXJyb3I6ICJbRVJST1JdIiwgLy93aGVuIG5vIHBhcnNlciBpcyBmb3VuZCwgc2hvdWxkbiJ0IGhhcHBlbgogICAgICAgICAgICAgICAgdW5rbm93bjogIltVbmtub3duXSIsCiAgICAgICAgICAgICAgICAibnVsbCI6ICJudWxsIiwKICAgICAgICAgICAgICAgICJ1bmRlZmluZWQiOiAidW5kZWZpbmVkIiwKICAgICAgICAgICAgICAgICJmdW5jdGlvbiI6IGZ1bmN0aW9uKCBmbiApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gImZ1bmN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9ICJuYW1lIiBpbiBmbiA\/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pIHx8IFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKCiAgICAgICAgICAgICAgICAgICAgaWYgKCBuYW1lICkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQgKz0gIiAiICsgbmFtZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0ICs9ICIoICI7CgogICAgICAgICAgICAgICAgICAgIHJldCA9IFsgcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoIGZuLCAiZnVuY3Rpb25BcmdzIiApLCAiKXsiIF0uam9pbiggIiIgKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gam9pbiggcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoZm4sImZ1bmN0aW9uQ29kZSIgKSwgIn0iICk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYXJyYXk6IGFycmF5LAogICAgICAgICAgICAgICAgbm9kZWxpc3Q6IGFycmF5LAogICAgICAgICAgICAgICAgImFyZ3VtZW50cyI6IGFycmF5LAogICAgICAgICAgICAgICAgb2JqZWN0OiBmdW5jdGlvbiggbWFwLCBzdGFjayApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gWyBdLCBrZXlzLCBrZXksIHZhbCwgaTsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5qc0R1bXAudXAoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIE9iamVjdC5rZXlzICkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXlzID0gT2JqZWN0LmtleXMoIG1hcCApOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICgga2V5IGluIG1hcCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleXMucHVzaCgga2V5ICk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAga2V5cy5zb3J0KCk7CiAgICAgICAgICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBrZXlzWyBpIF07CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IG1hcFsga2V5IF07CiAgICAgICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKCBRVW5pdC5qc0R1bXAucGFyc2UoIGtleSwgImtleSIgKSArICI6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoIHZhbCwgdW5kZWZpbmVkLCBzdGFjayApICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIFFVbml0LmpzRHVtcC5kb3duKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpvaW4oICJ7IiwgcmV0LCAifSIgKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBub2RlOiBmdW5jdGlvbiggbm9kZSApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYSwgdmFsLAogICAgICAgICAgICAgICAgICAgICAgICBvcGVuID0gUVVuaXQuanNEdW1wLkhUTUwgPyAiJmx0OyIgOiAiPCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlID0gUVVuaXQuanNEdW1wLkhUTUwgPyAiJmd0OyIgOiAiPiIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gb3BlbiArIHRhZzsKCiAgICAgICAgICAgICAgICAgICAgZm9yICggYSBpbiBRVW5pdC5qc0R1bXAuRE9NQXR0cnMgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IG5vZGVbIFFVbml0LmpzRHVtcC5ET01BdHRyc1thXSBdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHZhbCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCArPSAiICIgKyBhICsgIj0iICsgUVVuaXQuanNEdW1wLnBhcnNlKCB2YWwsICJhdHRyaWJ1dGUiICk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICIvIiArIHRhZyArIGNsb3NlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJnczogZnVuY3Rpb24oIGZuICkgey8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgYXJndW1lbnRzIHBhcnQgb2YgdGhlIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgIGwgPSBmbi5sZW5ndGg7CgogICAgICAgICAgICAgICAgICAgIGlmICggIWwgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBuZXcgQXJyYXkobCk7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCBsLS0gKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbbF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3K2wpOy8vOTcgaXMgJ2EnCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiAiICIgKyBhcmdzLmpvaW4oICIsICIgKSArICIgIjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBrZXk6IHF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcAogICAgICAgICAgICAgICAgZnVuY3Rpb25Db2RlOiAiW2NvZGVdIiwgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgYXR0cmlidXRlOiBxdW90ZSwgLy9ub2RlIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgYW4gaHRtbCBhdHRyaWJ1dGUgdmFsdWUKICAgICAgICAgICAgICAgIHN0cmluZzogcXVvdGUsCiAgICAgICAgICAgICAgICBkYXRlOiBxdW90ZSwKICAgICAgICAgICAgICAgIHJlZ2V4cDogbGl0ZXJhbCwgLy9yZWdleAogICAgICAgICAgICAgICAgbnVtYmVyOiBsaXRlcmFsLAogICAgICAgICAgICAgICAgImJvb2xlYW4iOiBsaXRlcmFsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIERPTUF0dHJzOiB7CiAgICAgICAgICAgICAgICAvL2F0dHJpYnV0ZXMgdG8gZHVtcCBmcm9tIG5vZGVzLCBuYW1lPT5yZWFsTmFtZQogICAgICAgICAgICAgICAgaWQ6ICJpZCIsCiAgICAgICAgICAgICAgICBuYW1lOiAibmFtZSIsCiAgICAgICAgICAgICAgICAiY2xhc3MiOiAiY2xhc3NOYW1lIgogICAgICAgICAgICB9LAogICAgICAgICAgICBIVE1MOiBmYWxzZSwvL2lmIHRydWUsIGVudGl0aWVzIGFyZSBlc2NhcGVkICggPCwgPiwgXHQsIHNwYWNlIGFuZCBcbiApCiAgICAgICAgICAgIGluZGVudENoYXI6ICIgICIsLy9pbmRlbnRhdGlvbiB1bml0CiAgICAgICAgICAgIG11bHRpbGluZTogdHJ1ZSAvL2lmIHRydWUsIGl0ZW1zIGluIGEgY29sbGVjdGlvbiwgYXJlIHNlcGFyYXRlZCBieSBhIFxuLCBlbHNlIGp1c3QgYSBzcGFjZS4KICAgICAgICB9OwoKICAgIHJldHVybiBqc0R1bXA7Cn0oKSk7CgovLyBmcm9tIFNpenpsZS5qcwpmdW5jdGlvbiBnZXRUZXh0KCBlbGVtcyApIHsKICAgIHZhciBpLCBlbGVtLAogICAgICAgIHJldCA9ICIiOwoKICAgIGZvciAoIGkgPSAwOyBlbGVtc1tpXTsgaSsrICkgewogICAgICAgIGVsZW0gPSBlbGVtc1tpXTsKCiAgICAgICAgLy8gR2V0IHRoZSB0ZXh0IGZyb20gdGV4dCBub2RlcyBhbmQgQ0RBVEEgbm9kZXMKICAgICAgICBpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gNCApIHsKICAgICAgICAgICAgcmV0ICs9IGVsZW0ubm9kZVZhbHVlOwoKICAgICAgICAvLyBUcmF2ZXJzZSBldmVyeXRoaW5nIGVsc2UsIGV4Y2VwdCBjb21tZW50IG5vZGVzCiAgICAgICAgfSBlbHNlIGlmICggZWxlbS5ub2RlVHlwZSAhPT0gOCApIHsKICAgICAgICAgICAgcmV0ICs9IGdldFRleHQoIGVsZW0uY2hpbGROb2RlcyApOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmV0Owp9CgovLyBmcm9tIGpxdWVyeS5qcwpmdW5jdGlvbiBpbkFycmF5KCBlbGVtLCBhcnJheSApIHsKICAgIGlmICggYXJyYXkuaW5kZXhPZiApIHsKICAgICAgICByZXR1cm4gYXJyYXkuaW5kZXhPZiggZWxlbSApOwogICAgfQoKICAgIGZvciAoIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKysgKSB7CiAgICAgICAgaWYgKCBhcnJheVsgaSBdID09PSBlbGVtICkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIC0xOwp9CgovKgogKiBKYXZhc2NyaXB0IERpZmYgQWxnb3JpdGhtCiAqICBCeSBKb2huIFJlc2lnIChodHRwOi8vZWpvaG4ub3JnLykKICogIE1vZGlmaWVkIGJ5IENodSBBbGFuICJzcHJpdGUiCiAqCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICoKICogTW9yZSBJbmZvOgogKiAgaHR0cDovL2Vqb2huLm9yZy9wcm9qZWN0cy9qYXZhc2NyaXB0LWRpZmYtYWxnb3JpdGhtLwogKgogKiBVc2FnZTogUVVuaXQuZGlmZihleHBlY3RlZCwgYWN0dWFsKQogKgogKiBRVW5pdC5kaWZmKCAidGhlIHF1aWNrIGJyb3duIGZveCBqdW1wZWQgb3ZlciIsICJ0aGUgcXVpY2sgZm94IGp1bXBzIG92ZXIiICkgPT0gInRoZSAgcXVpY2sgPGRlbD5icm93biA8L2RlbD4gZm94IDxkZWw+anVtcGVkIDwvZGVsPjxpbnM+anVtcHMgPC9pbnM+IG92ZXIiCiAqLwpRVW5pdC5kaWZmID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gZGlmZiggbywgbiApIHsKICAgICAgICB2YXIgaSwKICAgICAgICAgICAgbnMgPSB7fSwKICAgICAgICAgICAgb3MgPSB7fTsKCiAgICAgICAgZm9yICggaSA9IDA7IGkgPCBuLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICBpZiAoIG5zWyBuW2ldIF0gPT0gbnVsbCApIHsKICAgICAgICAgICAgICAgIG5zWyBuW2ldIF0gPSB7CiAgICAgICAgICAgICAgICAgICAgcm93czogW10sCiAgICAgICAgICAgICAgICAgICAgbzogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuc1sgbltpXSBdLnJvd3MucHVzaCggaSApOwogICAgICAgIH0KCiAgICAgICAgZm9yICggaSA9IDA7IGkgPCBvLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICBpZiAoIG9zWyBvW2ldIF0gPT0gbnVsbCApIHsKICAgICAgICAgICAgICAgIG9zWyBvW2ldIF0gPSB7CiAgICAgICAgICAgICAgICAgICAgcm93czogW10sCiAgICAgICAgICAgICAgICAgICAgbjogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvc1sgb1tpXSBdLnJvd3MucHVzaCggaSApOwogICAgICAgIH0KCiAgICAgICAgZm9yICggaSBpbiBucyApIHsKICAgICAgICAgICAgaWYgKCAhaGFzT3duLmNhbGwoIG5zLCBpICkgKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIG5zW2ldLnJvd3MubGVuZ3RoID09IDEgJiYgdHlwZW9mIG9zW2ldICE9ICJ1bmRlZmluZWQiICYmIG9zW2ldLnJvd3MubGVuZ3RoID09IDEgKSB7CiAgICAgICAgICAgICAgICBuWyBuc1tpXS5yb3dzWzBdIF0gPSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dDogblsgbnNbaV0ucm93c1swXSBdLAogICAgICAgICAgICAgICAgICAgIHJvdzogb3NbaV0ucm93c1swXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIG9bIG9zW2ldLnJvd3NbMF0gXSA9IHsKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBvWyBvc1tpXS5yb3dzWzBdIF0sCiAgICAgICAgICAgICAgICAgICAgcm93OiBuc1tpXS5yb3dzWzBdCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKCBpID0gMDsgaSA8IG4ubGVuZ3RoIC0gMTsgaSsrICkgewogICAgICAgICAgICBpZiAoIG5baV0udGV4dCAhPSBudWxsICYmIG5bIGkgKyAxIF0udGV4dCA9PSBudWxsICYmIG5baV0ucm93ICsgMSA8IG8ubGVuZ3RoICYmIG9bIG5baV0ucm93ICsgMSBdLnRleHQgPT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICAgICAgICBuWyBpICsgMSBdID09IG9bIG5baV0ucm93ICsgMSBdICkgewoKICAgICAgICAgICAgICAgIG5bIGkgKyAxIF0gPSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dDogblsgaSArIDEgXSwKICAgICAgICAgICAgICAgICAgICByb3c6IG5baV0ucm93ICsgMQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIG9bIG5baV0ucm93ICsgMSBdID0gewogICAgICAgICAgICAgICAgICAgIHRleHQ6IG9bIG5baV0ucm93ICsgMSBdLAogICAgICAgICAgICAgICAgICAgIHJvdzogaSArIDEKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAoIGkgPSBuLmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0gKSB7CiAgICAgICAgICAgIGlmICggbltpXS50ZXh0ICE9IG51bGwgJiYgblsgaSAtIDEgXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgPiAwICYmIG9bIG5baV0ucm93IC0gMSBdLnRleHQgPT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICAgICAgICBuWyBpIC0gMSBdID09IG9bIG5baV0ucm93IC0gMSBdKSB7CgogICAgICAgICAgICAgICAgblsgaSAtIDEgXSA9IHsKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBuWyBpIC0gMSBdLAogICAgICAgICAgICAgICAgICAgIHJvdzogbltpXS5yb3cgLSAxCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgb1sgbltpXS5yb3cgLSAxIF0gPSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dDogb1sgbltpXS5yb3cgLSAxIF0sCiAgICAgICAgICAgICAgICAgICAgcm93OiBpIC0gMQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbzogbywKICAgICAgICAgICAgbjogbgogICAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uKCBvLCBuICkgewogICAgICAgIG8gPSBvLnJlcGxhY2UoIC9ccyskLywgIiIgKTsKICAgICAgICBuID0gbi5yZXBsYWNlKCAvXHMrJC8sICIiICk7CgogICAgICAgIHZhciBpLCBwcmUsCiAgICAgICAgICAgIHN0ciA9ICIiLAogICAgICAgICAgICBvdXQgPSBkaWZmKCBvID09PSAiIiA\/IFtdIDogby5zcGxpdCgvXHMrLyksIG4gPT09ICIiID8gW10gOiBuLnNwbGl0KC9ccysvKSApLAogICAgICAgICAgICBvU3BhY2UgPSBvLm1hdGNoKC9ccysvZyksCiAgICAgICAgICAgIG5TcGFjZSA9IG4ubWF0Y2goL1xzKy9nKTsKCiAgICAgICAgaWYgKCBvU3BhY2UgPT0gbnVsbCApIHsKICAgICAgICAgICAgb1NwYWNlID0gWyAiICIgXTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIG9TcGFjZS5wdXNoKCAiICIgKTsKICAgICAgICB9CgogICAgICAgIGlmICggblNwYWNlID09IG51bGwgKSB7CiAgICAgICAgICAgIG5TcGFjZSA9IFsgIiAiIF07CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBuU3BhY2UucHVzaCggIiAiICk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIG91dC5uLmxlbmd0aCA9PT0gMCApIHsKICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBvdXQuby5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgICAgIHN0ciArPSAiPGRlbD4iICsgb3V0Lm9baV0gKyBvU3BhY2VbaV0gKyAiPC9kZWw+IjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgaWYgKCBvdXQublswXS50ZXh0ID09IG51bGwgKSB7CiAgICAgICAgICAgICAgICBmb3IgKCBuID0gMDsgbiA8IG91dC5vLmxlbmd0aCAmJiBvdXQub1tuXS50ZXh0ID09IG51bGw7IG4rKyApIHsKICAgICAgICAgICAgICAgICAgICBzdHIgKz0gIjxkZWw+IiArIG91dC5vW25dICsgb1NwYWNlW25dICsgIjwvZGVsPiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoIGkgPSAwOyBpIDwgb3V0Lm4ubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICBpZiAob3V0Lm5baV0udGV4dCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3RyICs9ICI8aW5zPiIgKyBvdXQubltpXSArIG5TcGFjZVtpXSArICI8L2lucz4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gYHByZWAgaW5pdGlhbGl6ZWQgYXQgdG9wIG9mIHNjb3BlCiAgICAgICAgICAgICAgICAgICAgcHJlID0gIiI7CgogICAgICAgICAgICAgICAgICAgIGZvciAoIG4gPSBvdXQubltpXS5yb3cgKyAxOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrICkgewogICAgICAgICAgICAgICAgICAgICAgICBwcmUgKz0gIjxkZWw+IiArIG91dC5vW25dICsgb1NwYWNlW25dICsgIjwvZGVsPiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0ciArPSAiICIgKyBvdXQubltpXS50ZXh0ICsgblNwYWNlW2ldICsgcHJlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc3RyOwogICAgfTsKfSgpKTsKCi8vIGZvciBDb21tb25KUyBlbnZpcm9tZW50cywgZXhwb3J0IGV2ZXJ5dGhpbmcKaWYgKCB0eXBlb2YgZXhwb3J0cyAhPT0gInVuZGVmaW5lZCIgKSB7CiAgICBleHRlbmQoZXhwb3J0cywgUVVuaXQpOwp9CgovLyBnZXQgYXQgd2hhdGV2ZXIgdGhlIGdsb2JhbCBvYmplY3QgaXMsIGxpa2Ugd2luZG93IGluIGJyb3dzZXJzCn0oIChmdW5jdGlvbigpIHtyZXR1cm4gdGhpczt9LmNhbGwoKSkgKSk7",
    "size": "64494"
}