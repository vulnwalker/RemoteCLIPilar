{
    "namaFile": "pages\/admin\/menu\/assets\/js\/libs\/gmaps\/gmaps.js",
    "lastUpdate": "2018-03-22+14:22:04.52",
    "contentFile": "KGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKICBpZih0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH0KICBlbHNlIGlmKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKCdHTWFwcycsIFtdLCBmYWN0b3J5KTsKICB9CgogIHJvb3QuR01hcHMgPSBmYWN0b3J5KCk7Cgp9KHRoaXMsIGZ1bmN0aW9uKCkgewoKLyohCiAqIEdNYXBzLmpzIHYwLjQuMTYKICogaHR0cDovL2hwbmVvLmdpdGh1Yi5jb20vZ21hcHMvCiAqCiAqIENvcHlyaWdodCAyMDE0LCBHdXN0YXZvIExlb24KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKi8KCmlmICghKHR5cGVvZiB3aW5kb3cuZ29vZ2xlID09PSAnb2JqZWN0JyAmJiB3aW5kb3cuZ29vZ2xlLm1hcHMpKSB7CiAgdGhyb3cgJ0dvb2dsZSBNYXBzIEFQSSBpcyByZXF1aXJlZC4gUGxlYXNlIHJlZ2lzdGVyIHRoZSBmb2xsb3dpbmcgSmF2YVNjcmlwdCBsaWJyYXJ5IGh0dHA6Ly9tYXBzLmdvb2dsZS5jb20vbWFwcy9hcGkvanM\/c2Vuc29yPXRydWUuJwp9Cgp2YXIgZXh0ZW5kX29iamVjdCA9IGZ1bmN0aW9uKG9iaiwgbmV3X29iaikgewogIHZhciBuYW1lOwoKICBpZiAob2JqID09PSBuZXdfb2JqKSB7CiAgICByZXR1cm4gb2JqOwogIH0KCiAgZm9yIChuYW1lIGluIG5ld19vYmopIHsKICAgIG9ialtuYW1lXSA9IG5ld19vYmpbbmFtZV07CiAgfQoKICByZXR1cm4gb2JqOwp9OwoKdmFyIHJlcGxhY2Vfb2JqZWN0ID0gZnVuY3Rpb24ob2JqLCByZXBsYWNlKSB7CiAgdmFyIG5hbWU7CgogIGlmIChvYmogPT09IHJlcGxhY2UpIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICBmb3IgKG5hbWUgaW4gcmVwbGFjZSkgewogICAgaWYgKG9ialtuYW1lXSAhPSB1bmRlZmluZWQpIHsKICAgICAgb2JqW25hbWVdID0gcmVwbGFjZVtuYW1lXTsKICAgIH0KICB9CgogIHJldHVybiBvYmo7Cn07Cgp2YXIgYXJyYXlfbWFwID0gZnVuY3Rpb24oYXJyYXksIGNhbGxiYWNrKSB7CiAgdmFyIG9yaWdpbmFsX2NhbGxiYWNrX3BhcmFtcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMiksCiAgICAgIGFycmF5X3JldHVybiA9IFtdLAogICAgICBhcnJheV9sZW5ndGggPSBhcnJheS5sZW5ndGgsCiAgICAgIGk7CgogIGlmIChBcnJheS5wcm90b3R5cGUubWFwICYmIGFycmF5Lm1hcCA9PT0gQXJyYXkucHJvdG90eXBlLm1hcCkgewogICAgYXJyYXlfcmV0dXJuID0gQXJyYXkucHJvdG90eXBlLm1hcC5jYWxsKGFycmF5LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIGNhbGxiYWNrX3BhcmFtcyA9IG9yaWdpbmFsX2NhbGxiYWNrX3BhcmFtczsKICAgICAgY2FsbGJhY2tfcGFyYW1zLnNwbGljZSgwLCAwLCBpdGVtKTsKCiAgICAgIHJldHVybiBjYWxsYmFjay5hcHBseSh0aGlzLCBjYWxsYmFja19wYXJhbXMpOwogICAgfSk7CiAgfQogIGVsc2UgewogICAgZm9yIChpID0gMDsgaSA8IGFycmF5X2xlbmd0aDsgaSsrKSB7CiAgICAgIGNhbGxiYWNrX3BhcmFtcyA9IG9yaWdpbmFsX2NhbGxiYWNrX3BhcmFtczsKICAgICAgY2FsbGJhY2tfcGFyYW1zLnNwbGljZSgwLCAwLCBhcnJheVtpXSk7CiAgICAgIGFycmF5X3JldHVybi5wdXNoKGNhbGxiYWNrLmFwcGx5KHRoaXMsIGNhbGxiYWNrX3BhcmFtcykpOwogICAgfQogIH0KCiAgcmV0dXJuIGFycmF5X3JldHVybjsKfTsKCnZhciBhcnJheV9mbGF0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICB2YXIgbmV3X2FycmF5ID0gW10sCiAgICAgIGk7CgogIGZvciAoaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgbmV3X2FycmF5ID0gbmV3X2FycmF5LmNvbmNhdChhcnJheVtpXSk7CiAgfQoKICByZXR1cm4gbmV3X2FycmF5Owp9OwoKdmFyIGNvb3Jkc1RvTGF0TG5ncyA9IGZ1bmN0aW9uKGNvb3JkcywgdXNlR2VvSlNPTikgewogIHZhciBmaXJzdF9jb29yZCA9IGNvb3Jkc1swXSwKICAgICAgc2Vjb25kX2Nvb3JkID0gY29vcmRzWzFdOwoKICBpZiAodXNlR2VvSlNPTikgewogICAgZmlyc3RfY29vcmQgPSBjb29yZHNbMV07CiAgICBzZWNvbmRfY29vcmQgPSBjb29yZHNbMF07CiAgfQoKICByZXR1cm4gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhmaXJzdF9jb29yZCwgc2Vjb25kX2Nvb3JkKTsKfTsKCnZhciBhcnJheVRvTGF0TG5nID0gZnVuY3Rpb24oY29vcmRzLCB1c2VHZW9KU09OKSB7CiAgdmFyIGk7CgogIGZvciAoaSA9IDA7IGkgPCBjb29yZHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghKGNvb3Jkc1tpXSBpbnN0YW5jZW9mIGdvb2dsZS5tYXBzLkxhdExuZykpIHsKICAgICAgaWYgKGNvb3Jkc1tpXS5sZW5ndGggPiAwICYmIHR5cGVvZihjb29yZHNbaV1bMF0pID09ICJvYmplY3QiKSB7CiAgICAgICAgY29vcmRzW2ldID0gYXJyYXlUb0xhdExuZyhjb29yZHNbaV0sIHVzZUdlb0pTT04pOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGNvb3Jkc1tpXSA9IGNvb3Jkc1RvTGF0TG5ncyhjb29yZHNbaV0sIHVzZUdlb0pTT04pOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gY29vcmRzOwp9OwoKdmFyIGdldEVsZW1lbnRCeUlkID0gZnVuY3Rpb24oaWQsIGNvbnRleHQpIHsKICB2YXIgZWxlbWVudCwKICBpZCA9IGlkLnJlcGxhY2UoJyMnLCAnJyk7CgogIGlmICgnalF1ZXJ5JyBpbiB0aGlzICYmIGNvbnRleHQpIHsKICAgIGVsZW1lbnQgPSAkKCIjIiArIGlkLCBjb250ZXh0KVswXTsKICB9IGVsc2UgewogICAgZWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKICB9OwoKICByZXR1cm4gZWxlbWVudDsKfTsKCnZhciBmaW5kQWJzb2x1dGVQb3NpdGlvbiA9IGZ1bmN0aW9uKG9iaikgIHsKICB2YXIgY3VybGVmdCA9IDAsCiAgICAgIGN1cnRvcCA9IDA7CgogIGlmIChvYmoub2Zmc2V0UGFyZW50KSB7CiAgICBkbyB7CiAgICAgIGN1cmxlZnQgKz0gb2JqLm9mZnNldExlZnQ7CiAgICAgIGN1cnRvcCArPSBvYmoub2Zmc2V0VG9wOwogICAgfSB3aGlsZSAob2JqID0gb2JqLm9mZnNldFBhcmVudCk7CiAgfQoKICByZXR1cm4gW2N1cmxlZnQsIGN1cnRvcF07Cn07Cgp2YXIgR01hcHMgPSAoZnVuY3Rpb24oZ2xvYmFsKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgZG9jID0gZG9jdW1lbnQ7CgogIHZhciBHTWFwcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIGlmICghdGhpcykgcmV0dXJuIG5ldyBHTWFwcyhvcHRpb25zKTsKCiAgICBvcHRpb25zLnpvb20gPSBvcHRpb25zLnpvb20gfHwgMTU7CiAgICBvcHRpb25zLm1hcFR5cGUgPSBvcHRpb25zLm1hcFR5cGUgfHwgJ3JvYWRtYXAnOwoKICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICBpLAogICAgICAgIGV2ZW50c190aGF0X2hpZGVfY29udGV4dF9tZW51ID0gWydib3VuZHNfY2hhbmdlZCcsICdjZW50ZXJfY2hhbmdlZCcsICdjbGljaycsICdkYmxjbGljaycsICdkcmFnJywgJ2RyYWdlbmQnLCAnZHJhZ3N0YXJ0JywgJ2lkbGUnLCAnbWFwdHlwZWlkX2NoYW5nZWQnLCAncHJvamVjdGlvbl9jaGFuZ2VkJywgJ3Jlc2l6ZScsICd0aWxlc2xvYWRlZCcsICd6b29tX2NoYW5nZWQnXSwKICAgICAgICBldmVudHNfdGhhdF9kb2VzbnRfaGlkZV9jb250ZXh0X21lbnUgPSBbJ21vdXNlbW92ZScsICdtb3VzZW91dCcsICdtb3VzZW92ZXInXSwKICAgICAgICBvcHRpb25zX3RvX2JlX2RlbGV0ZWQgPSBbJ2VsJywgJ2xhdCcsICdsbmcnLCAnbWFwVHlwZScsICd3aWR0aCcsICdoZWlnaHQnLCAnbWFya2VyQ2x1c3RlcmVyJywgJ2VuYWJsZU5ld1N0eWxlJ10sCiAgICAgICAgY29udGFpbmVyX2lkID0gb3B0aW9ucy5lbCB8fCBvcHRpb25zLmRpdiwKICAgICAgICBtYXJrZXJDbHVzdGVyZXJGdW5jdGlvbiA9IG9wdGlvbnMubWFya2VyQ2x1c3RlcmVyLAogICAgICAgIG1hcFR5cGUgPSBnb29nbGUubWFwcy5NYXBUeXBlSWRbb3B0aW9ucy5tYXBUeXBlLnRvVXBwZXJDYXNlKCldLAogICAgICAgIG1hcF9jZW50ZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKG9wdGlvbnMubGF0LCBvcHRpb25zLmxuZyksCiAgICAgICAgem9vbUNvbnRyb2wgPSBvcHRpb25zLnpvb21Db250cm9sIHx8IHRydWUsCiAgICAgICAgem9vbUNvbnRyb2xPcHQgPSBvcHRpb25zLnpvb21Db250cm9sT3B0IHx8IHsKICAgICAgICAgIHN0eWxlOiAnREVGQVVMVCcsCiAgICAgICAgICBwb3NpdGlvbjogJ1RPUF9MRUZUJwogICAgICAgIH0sCiAgICAgICAgem9vbUNvbnRyb2xTdHlsZSA9IHpvb21Db250cm9sT3B0LnN0eWxlIHx8ICdERUZBVUxUJywKICAgICAgICB6b29tQ29udHJvbFBvc2l0aW9uID0gem9vbUNvbnRyb2xPcHQucG9zaXRpb24gfHwgJ1RPUF9MRUZUJywKICAgICAgICBwYW5Db250cm9sID0gb3B0aW9ucy5wYW5Db250cm9sIHx8IHRydWUsCiAgICAgICAgbWFwVHlwZUNvbnRyb2wgPSBvcHRpb25zLm1hcFR5cGVDb250cm9sIHx8IHRydWUsCiAgICAgICAgc2NhbGVDb250cm9sID0gb3B0aW9ucy5zY2FsZUNvbnRyb2wgfHwgdHJ1ZSwKICAgICAgICBzdHJlZXRWaWV3Q29udHJvbCA9IG9wdGlvbnMuc3RyZWV0Vmlld0NvbnRyb2wgfHwgdHJ1ZSwKICAgICAgICBvdmVydmlld01hcENvbnRyb2wgPSBvdmVydmlld01hcENvbnRyb2wgfHwgdHJ1ZSwKICAgICAgICBtYXBfb3B0aW9ucyA9IHt9LAogICAgICAgIG1hcF9iYXNlX29wdGlvbnMgPSB7CiAgICAgICAgICB6b29tOiB0aGlzLnpvb20sCiAgICAgICAgICBjZW50ZXI6IG1hcF9jZW50ZXIsCiAgICAgICAgICBtYXBUeXBlSWQ6IG1hcFR5cGUKICAgICAgICB9LAogICAgICAgIG1hcF9jb250cm9sc19vcHRpb25zID0gewogICAgICAgICAgcGFuQ29udHJvbDogcGFuQ29udHJvbCwKICAgICAgICAgIHpvb21Db250cm9sOiB6b29tQ29udHJvbCwKICAgICAgICAgIHpvb21Db250cm9sT3B0aW9uczogewogICAgICAgICAgICBzdHlsZTogZ29vZ2xlLm1hcHMuWm9vbUNvbnRyb2xTdHlsZVt6b29tQ29udHJvbFN0eWxlXSwKICAgICAgICAgICAgcG9zaXRpb246IGdvb2dsZS5tYXBzLkNvbnRyb2xQb3NpdGlvblt6b29tQ29udHJvbFBvc2l0aW9uXQogICAgICAgICAgfSwKICAgICAgICAgIG1hcFR5cGVDb250cm9sOiBtYXBUeXBlQ29udHJvbCwKICAgICAgICAgIHNjYWxlQ29udHJvbDogc2NhbGVDb250cm9sLAogICAgICAgICAgc3RyZWV0Vmlld0NvbnRyb2w6IHN0cmVldFZpZXdDb250cm9sLAogICAgICAgICAgb3ZlcnZpZXdNYXBDb250cm9sOiBvdmVydmlld01hcENvbnRyb2wKICAgICAgICB9OwoKICAgIGlmICh0eXBlb2Yob3B0aW9ucy5lbCkgPT09ICdzdHJpbmcnIHx8IHR5cGVvZihvcHRpb25zLmRpdikgPT09ICdzdHJpbmcnKSB7CiAgICAgIHRoaXMuZWwgPSBnZXRFbGVtZW50QnlJZChjb250YWluZXJfaWQsIG9wdGlvbnMuY29udGV4dCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmVsID0gY29udGFpbmVyX2lkOwogICAgfQoKICAgIGlmICh0eXBlb2YodGhpcy5lbCkgPT09ICd1bmRlZmluZWQnIHx8IHRoaXMuZWwgPT09IG51bGwpIHsKICAgICAgdGhyb3cgJ05vIGVsZW1lbnQgZGVmaW5lZC4nOwogICAgfQoKICAgIHdpbmRvdy5jb250ZXh0X21lbnUgPSB3aW5kb3cuY29udGV4dF9tZW51IHx8IHt9OwogICAgd2luZG93LmNvbnRleHRfbWVudVtzZWxmLmVsLmlkXSA9IHt9OwoKICAgIHRoaXMuY29udHJvbHMgPSBbXTsKICAgIHRoaXMub3ZlcmxheXMgPSBbXTsKICAgIHRoaXMubGF5ZXJzID0gW107IC8vIGFycmF5IHdpdGgga21sL2dlb3JzcyBhbmQgZnVzaW9udGFibGVzIGxheWVycywgY2FuIGJlIGFzIG1hbnkKICAgIHRoaXMuc2luZ2xlTGF5ZXJzID0ge307IC8vIG9iamVjdCB3aXRoIHRoZSBvdGhlciBsYXllcnMsIG9ubHkgb25lIHBlciBsYXllcgogICAgdGhpcy5tYXJrZXJzID0gW107CiAgICB0aGlzLnBvbHlsaW5lcyA9IFtdOwogICAgdGhpcy5yb3V0ZXMgPSBbXTsKICAgIHRoaXMucG9seWdvbnMgPSBbXTsKICAgIHRoaXMuaW5mb1dpbmRvdyA9IG51bGw7CiAgICB0aGlzLm92ZXJsYXlfZWwgPSBudWxsOwogICAgdGhpcy56b29tID0gb3B0aW9ucy56b29tOwogICAgdGhpcy5yZWdpc3RlcmVkX2V2ZW50cyA9IHt9OwoKICAgIHRoaXMuZWwuc3R5bGUud2lkdGggPSBvcHRpb25zLndpZHRoIHx8IHRoaXMuZWwuc2Nyb2xsV2lkdGggfHwgdGhpcy5lbC5vZmZzZXRXaWR0aDsKICAgIHRoaXMuZWwuc3R5bGUuaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgdGhpcy5lbC5zY3JvbGxIZWlnaHQgfHwgdGhpcy5lbC5vZmZzZXRIZWlnaHQ7CgogICAgZ29vZ2xlLm1hcHMudmlzdWFsUmVmcmVzaCA9IG9wdGlvbnMuZW5hYmxlTmV3U3R5bGU7CgogICAgZm9yIChpID0gMDsgaSA8IG9wdGlvbnNfdG9fYmVfZGVsZXRlZC5sZW5ndGg7IGkrKykgewogICAgICBkZWxldGUgb3B0aW9uc1tvcHRpb25zX3RvX2JlX2RlbGV0ZWRbaV1dOwogICAgfQoKICAgIGlmKG9wdGlvbnMuZGlzYWJsZURlZmF1bHRVSSAhPSB0cnVlKSB7CiAgICAgIG1hcF9iYXNlX29wdGlvbnMgPSBleHRlbmRfb2JqZWN0KG1hcF9iYXNlX29wdGlvbnMsIG1hcF9jb250cm9sc19vcHRpb25zKTsKICAgIH0KCiAgICBtYXBfb3B0aW9ucyA9IGV4dGVuZF9vYmplY3QobWFwX2Jhc2Vfb3B0aW9ucywgb3B0aW9ucyk7CgogICAgZm9yIChpID0gMDsgaSA8IGV2ZW50c190aGF0X2hpZGVfY29udGV4dF9tZW51Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGRlbGV0ZSBtYXBfb3B0aW9uc1tldmVudHNfdGhhdF9oaWRlX2NvbnRleHRfbWVudVtpXV07CiAgICB9CgogICAgZm9yIChpID0gMDsgaSA8IGV2ZW50c190aGF0X2RvZXNudF9oaWRlX2NvbnRleHRfbWVudS5sZW5ndGg7IGkrKykgewogICAgICBkZWxldGUgbWFwX29wdGlvbnNbZXZlbnRzX3RoYXRfZG9lc250X2hpZGVfY29udGV4dF9tZW51W2ldXTsKICAgIH0KCiAgICB0aGlzLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAodGhpcy5lbCwgbWFwX29wdGlvbnMpOwoKICAgIGlmIChtYXJrZXJDbHVzdGVyZXJGdW5jdGlvbikgewogICAgICB0aGlzLm1hcmtlckNsdXN0ZXJlciA9IG1hcmtlckNsdXN0ZXJlckZ1bmN0aW9uLmFwcGx5KHRoaXMsIFt0aGlzLm1hcF0pOwogICAgfQoKICAgIHZhciBidWlsZENvbnRleHRNZW51SFRNTCA9IGZ1bmN0aW9uKGNvbnRyb2wsIGUpIHsKICAgICAgdmFyIGh0bWwgPSAnJywKICAgICAgICAgIG9wdGlvbnMgPSB3aW5kb3cuY29udGV4dF9tZW51W3NlbGYuZWwuaWRdW2NvbnRyb2xdOwoKICAgICAgZm9yICh2YXIgaSBpbiBvcHRpb25zKXsKICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShpKSkgewogICAgICAgICAgdmFyIG9wdGlvbiA9IG9wdGlvbnNbaV07CgogICAgICAgICAgaHRtbCArPSAnPGxpPjxhIGlkPSInICsgY29udHJvbCArICdfJyArIGkgKyAnIiBocmVmPSIjIj4nICsgb3B0aW9uLnRpdGxlICsgJzwvYT48L2xpPic7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWdldEVsZW1lbnRCeUlkKCdnbWFwc19jb250ZXh0X21lbnUnKSkgcmV0dXJuOwoKICAgICAgdmFyIGNvbnRleHRfbWVudV9lbGVtZW50ID0gZ2V0RWxlbWVudEJ5SWQoJ2dtYXBzX2NvbnRleHRfbWVudScpOwogICAgICAKICAgICAgY29udGV4dF9tZW51X2VsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKCiAgICAgIHZhciBjb250ZXh0X21lbnVfaXRlbXMgPSBjb250ZXh0X21lbnVfZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYScpLAogICAgICAgICAgY29udGV4dF9tZW51X2l0ZW1zX2NvdW50ID0gY29udGV4dF9tZW51X2l0ZW1zLmxlbmd0aCwKICAgICAgICAgIGk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgY29udGV4dF9tZW51X2l0ZW1zX2NvdW50OyBpKyspIHsKICAgICAgICB2YXIgY29udGV4dF9tZW51X2l0ZW0gPSBjb250ZXh0X21lbnVfaXRlbXNbaV07CgogICAgICAgIHZhciBhc3NpZ25fbWVudV9pdGVtX2FjdGlvbiA9IGZ1bmN0aW9uKGV2KXsKICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgb3B0aW9uc1t0aGlzLmlkLnJlcGxhY2UoY29udHJvbCArICdfJywgJycpXS5hY3Rpb24uYXBwbHkoc2VsZiwgW2VdKTsKICAgICAgICAgIHNlbGYuaGlkZUNvbnRleHRNZW51KCk7CiAgICAgICAgfTsKCiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuY2xlYXJMaXN0ZW5lcnMoY29udGV4dF9tZW51X2l0ZW0sICdjbGljaycpOwogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZERvbUxpc3RlbmVyT25jZShjb250ZXh0X21lbnVfaXRlbSwgJ2NsaWNrJywgYXNzaWduX21lbnVfaXRlbV9hY3Rpb24sIGZhbHNlKTsKICAgICAgfQoKICAgICAgdmFyIHBvc2l0aW9uID0gZmluZEFic29sdXRlUG9zaXRpb24uYXBwbHkodGhpcywgW3NlbGYuZWxdKSwKICAgICAgICAgIGxlZnQgPSBwb3NpdGlvblswXSArIGUucGl4ZWwueCAtIDE1LAogICAgICAgICAgdG9wID0gcG9zaXRpb25bMV0gKyBlLnBpeGVsLnktIDE1OwoKICAgICAgY29udGV4dF9tZW51X2VsZW1lbnQuc3R5bGUubGVmdCA9IGxlZnQgKyAicHgiOwogICAgICBjb250ZXh0X21lbnVfZWxlbWVudC5zdHlsZS50b3AgPSB0b3AgKyAicHgiOwoKICAgICAgY29udGV4dF9tZW51X2VsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICB9OwoKICAgIHRoaXMuYnVpbGRDb250ZXh0TWVudSA9IGZ1bmN0aW9uKGNvbnRyb2wsIGUpIHsKICAgICAgaWYgKGNvbnRyb2wgPT09ICdtYXJrZXInKSB7CiAgICAgICAgZS5waXhlbCA9IHt9OwoKICAgICAgICB2YXIgb3ZlcmxheSA9IG5ldyBnb29nbGUubWFwcy5PdmVybGF5VmlldygpOwogICAgICAgIG92ZXJsYXkuc2V0TWFwKHNlbGYubWFwKTsKICAgICAgICAKICAgICAgICBvdmVybGF5LmRyYXcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBwcm9qZWN0aW9uID0gb3ZlcmxheS5nZXRQcm9qZWN0aW9uKCksCiAgICAgICAgICAgICAgcG9zaXRpb24gPSBlLm1hcmtlci5nZXRQb3NpdGlvbigpOwogICAgICAgICAgCiAgICAgICAgICBlLnBpeGVsID0gcHJvamVjdGlvbi5mcm9tTGF0TG5nVG9Db250YWluZXJQaXhlbChwb3NpdGlvbik7CgogICAgICAgICAgYnVpbGRDb250ZXh0TWVudUhUTUwoY29udHJvbCwgZSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBidWlsZENvbnRleHRNZW51SFRNTChjb250cm9sLCBlKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnNldENvbnRleHRNZW51ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB3aW5kb3cuY29udGV4dF9tZW51W3NlbGYuZWwuaWRdW29wdGlvbnMuY29udHJvbF0gPSB7fTsKCiAgICAgIHZhciBpLAogICAgICAgICAgdWwgPSBkb2MuY3JlYXRlRWxlbWVudCgndWwnKTsKCiAgICAgIGZvciAoaSBpbiBvcHRpb25zLm9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5vcHRpb25zLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICB2YXIgb3B0aW9uID0gb3B0aW9ucy5vcHRpb25zW2ldOwoKICAgICAgICAgIHdpbmRvdy5jb250ZXh0X21lbnVbc2VsZi5lbC5pZF1bb3B0aW9ucy5jb250cm9sXVtvcHRpb24ubmFtZV0gPSB7CiAgICAgICAgICAgIHRpdGxlOiBvcHRpb24udGl0bGUsCiAgICAgICAgICAgIGFjdGlvbjogb3B0aW9uLmFjdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHVsLmlkID0gJ2dtYXBzX2NvbnRleHRfbWVudSc7CiAgICAgIHVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIHVsLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKICAgICAgdWwuc3R5bGUubWluV2lkdGggPSAnMTAwcHgnOwogICAgICB1bC5zdHlsZS5iYWNrZ3JvdW5kID0gJ3doaXRlJzsKICAgICAgdWwuc3R5bGUubGlzdFN0eWxlID0gJ25vbmUnOwogICAgICB1bC5zdHlsZS5wYWRkaW5nID0gJzhweCc7CiAgICAgIHVsLnN0eWxlLmJveFNoYWRvdyA9ICcycHggMnB4IDZweCAjY2NjJzsKCiAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKHVsKTsKCiAgICAgIHZhciBjb250ZXh0X21lbnVfZWxlbWVudCA9IGdldEVsZW1lbnRCeUlkKCdnbWFwc19jb250ZXh0X21lbnUnKQoKICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkRG9tTGlzdGVuZXIoY29udGV4dF9tZW51X2VsZW1lbnQsICdtb3VzZW91dCcsIGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgaWYgKCFldi5yZWxhdGVkVGFyZ2V0IHx8ICF0aGlzLmNvbnRhaW5zKGV2LnJlbGF0ZWRUYXJnZXQpKSB7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICBjb250ZXh0X21lbnVfZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgfSwgNDAwKTsKICAgICAgICB9CiAgICAgIH0sIGZhbHNlKTsKICAgIH07CgogICAgdGhpcy5oaWRlQ29udGV4dE1lbnUgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHRfbWVudV9lbGVtZW50ID0gZ2V0RWxlbWVudEJ5SWQoJ2dtYXBzX2NvbnRleHRfbWVudScpOwoKICAgICAgaWYgKGNvbnRleHRfbWVudV9lbGVtZW50KSB7CiAgICAgICAgY29udGV4dF9tZW51X2VsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgfQogICAgfTsKCiAgICB2YXIgc2V0dXBMaXN0ZW5lciA9IGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKGUpewogICAgICAgIGlmIChlID09IHVuZGVmaW5lZCkgewogICAgICAgICAgZSA9IHRoaXM7CiAgICAgICAgfQoKICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIFtlXSk7CgogICAgICAgIHNlbGYuaGlkZUNvbnRleHRNZW51KCk7CiAgICAgIH0pOwogICAgfTsKCiAgICAvL2dvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKHRoaXMubWFwLCAnaWRsZScsIHRoaXMuaGlkZUNvbnRleHRNZW51KTsKICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKHRoaXMubWFwLCAnem9vbV9jaGFuZ2VkJywgdGhpcy5oaWRlQ29udGV4dE1lbnUpOwoKICAgIGZvciAodmFyIGV2ID0gMDsgZXYgPCBldmVudHNfdGhhdF9oaWRlX2NvbnRleHRfbWVudS5sZW5ndGg7IGV2KyspIHsKICAgICAgdmFyIG5hbWUgPSBldmVudHNfdGhhdF9oaWRlX2NvbnRleHRfbWVudVtldl07CgogICAgICBpZiAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgc2V0dXBMaXN0ZW5lcih0aGlzLm1hcCwgbmFtZSk7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKHZhciBldiA9IDA7IGV2IDwgZXZlbnRzX3RoYXRfZG9lc250X2hpZGVfY29udGV4dF9tZW51Lmxlbmd0aDsgZXYrKykgewogICAgICB2YXIgbmFtZSA9IGV2ZW50c190aGF0X2RvZXNudF9oaWRlX2NvbnRleHRfbWVudVtldl07CgogICAgICBpZiAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgc2V0dXBMaXN0ZW5lcih0aGlzLm1hcCwgbmFtZSk7CiAgICAgIH0KICAgIH0KCiAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcih0aGlzLm1hcCwgJ3JpZ2h0Y2xpY2snLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChvcHRpb25zLnJpZ2h0Y2xpY2spIHsKICAgICAgICBvcHRpb25zLnJpZ2h0Y2xpY2suYXBwbHkodGhpcywgW2VdKTsKICAgICAgfQoKICAgICAgaWYod2luZG93LmNvbnRleHRfbWVudVtzZWxmLmVsLmlkXVsnbWFwJ10gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgc2VsZi5idWlsZENvbnRleHRNZW51KCdtYXAnLCBlKTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LnRyaWdnZXIodGhpcy5tYXAsICdyZXNpemUnKTsKICAgIH07CgogICAgdGhpcy5maXRab29tID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsYXRMbmdzID0gW10sCiAgICAgICAgICBtYXJrZXJzX2xlbmd0aCA9IHRoaXMubWFya2Vycy5sZW5ndGgsCiAgICAgICAgICBpOwoKICAgICAgZm9yIChpID0gMDsgaSA8IG1hcmtlcnNfbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZih0eXBlb2YodGhpcy5tYXJrZXJzW2ldLnZpc2libGUpID09PSAnYm9vbGVhbicgJiYgdGhpcy5tYXJrZXJzW2ldLnZpc2libGUpIHsKICAgICAgICAgIGxhdExuZ3MucHVzaCh0aGlzLm1hcmtlcnNbaV0uZ2V0UG9zaXRpb24oKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmZpdExhdExuZ0JvdW5kcyhsYXRMbmdzKTsKICAgIH07CgogICAgdGhpcy5maXRMYXRMbmdCb3VuZHMgPSBmdW5jdGlvbihsYXRMbmdzKSB7CiAgICAgIHZhciB0b3RhbCA9IGxhdExuZ3MubGVuZ3RoOwogICAgICB2YXIgYm91bmRzID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZ0JvdW5kcygpOwoKICAgICAgZm9yKHZhciBpPTA7IGkgPCB0b3RhbDsgaSsrKSB7CiAgICAgICAgYm91bmRzLmV4dGVuZChsYXRMbmdzW2ldKTsKICAgICAgfQoKICAgICAgdGhpcy5tYXAuZml0Qm91bmRzKGJvdW5kcyk7CiAgICB9OwoKICAgIHRoaXMuc2V0Q2VudGVyID0gZnVuY3Rpb24obGF0LCBsbmcsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMubWFwLnBhblRvKG5ldyBnb29nbGUubWFwcy5MYXRMbmcobGF0LCBsbmcpKTsKCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0KICAgIH07CgogICAgdGhpcy5nZXRFbGVtZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmVsOwogICAgfTsKCiAgICB0aGlzLnpvb21JbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdmFsdWUgfHwgMTsKCiAgICAgIHRoaXMuem9vbSA9IHRoaXMubWFwLmdldFpvb20oKSArIHZhbHVlOwogICAgICB0aGlzLm1hcC5zZXRab29tKHRoaXMuem9vbSk7CiAgICB9OwoKICAgIHRoaXMuem9vbU91dCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdmFsdWUgfHwgMTsKCiAgICAgIHRoaXMuem9vbSA9IHRoaXMubWFwLmdldFpvb20oKSAtIHZhbHVlOwogICAgICB0aGlzLm1hcC5zZXRab29tKHRoaXMuem9vbSk7CiAgICB9OwoKICAgIHZhciBuYXRpdmVfbWV0aG9kcyA9IFtdLAogICAgICAgIG1ldGhvZDsKCiAgICBmb3IgKG1ldGhvZCBpbiB0aGlzLm1hcCkgewogICAgICBpZiAodHlwZW9mKHRoaXMubWFwW21ldGhvZF0pID09ICdmdW5jdGlvbicgJiYgIXRoaXNbbWV0aG9kXSkgewogICAgICAgIG5hdGl2ZV9tZXRob2RzLnB1c2gobWV0aG9kKTsKICAgICAgfQogICAgfQoKICAgIGZvciAoaT0wOyBpIDwgbmF0aXZlX21ldGhvZHMubGVuZ3RoOyBpKyspIHsKICAgICAgKGZ1bmN0aW9uKGdtYXBzLCBzY29wZSwgbWV0aG9kX25hbWUpIHsKICAgICAgICBnbWFwc1ttZXRob2RfbmFtZV0gPSBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIHNjb3BlW21ldGhvZF9uYW1lXS5hcHBseShzY29wZSwgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9KSh0aGlzLCB0aGlzLm1hcCwgbmF0aXZlX21ldGhvZHNbaV0pOwogICAgfQogIH07CgogIHJldHVybiBHTWFwczsKfSkodGhpcyk7CgpHTWFwcy5wcm90b3R5cGUuY3JlYXRlQ29udHJvbCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgY29udHJvbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKICBjb250cm9sLnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsKICAKICBpZiAob3B0aW9ucy5kaXNhYmxlRGVmYXVsdFN0eWxlcyAhPT0gdHJ1ZSkgewogICAgY29udHJvbC5zdHlsZS5mb250RmFtaWx5ID0gJ1JvYm90bywgQXJpYWwsIHNhbnMtc2VyaWYnOwogICAgY29udHJvbC5zdHlsZS5mb250U2l6ZSA9ICcxMXB4JzsKICAgIGNvbnRyb2wuc3R5bGUuYm94U2hhZG93ID0gJ3JnYmEoMCwgMCwgMCwgMC4yOTgwMzkpIDBweCAxcHggNHB4IC0xcHgnOwogIH0KCiAgZm9yICh2YXIgb3B0aW9uIGluIG9wdGlvbnMuc3R5bGUpIHsKICAgIGNvbnRyb2wuc3R5bGVbb3B0aW9uXSA9IG9wdGlvbnMuc3R5bGVbb3B0aW9uXTsKICB9CgogIGlmIChvcHRpb25zLmlkKSB7CiAgICBjb250cm9sLmlkID0gb3B0aW9ucy5pZDsKICB9CgogIGlmIChvcHRpb25zLmNsYXNzZXMpIHsKICAgIGNvbnRyb2wuY2xhc3NOYW1lID0gb3B0aW9ucy5jbGFzc2VzOwogIH0KCiAgaWYgKG9wdGlvbnMuY29udGVudCkgewogICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbnRlbnQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGNvbnRyb2wuaW5uZXJIVE1MID0gb3B0aW9ucy5jb250ZW50OwogICAgfQogICAgZWxzZSBpZiAob3B0aW9ucy5jb250ZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgY29udHJvbC5hcHBlbmRDaGlsZChvcHRpb25zLmNvbnRlbnQpOwogICAgfQogIH0KCiAgaWYgKG9wdGlvbnMucG9zaXRpb24pIHsKICAgIGNvbnRyb2wucG9zaXRpb24gPSBnb29nbGUubWFwcy5Db250cm9sUG9zaXRpb25bb3B0aW9ucy5wb3NpdGlvbi50b1VwcGVyQ2FzZSgpXTsKICB9CgogIGZvciAodmFyIGV2IGluIG9wdGlvbnMuZXZlbnRzKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZERvbUxpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oKXsKICAgICAgICBvcHRpb25zLmV2ZW50c1tuYW1lXS5hcHBseSh0aGlzLCBbdGhpc10pOwogICAgICB9KTsKICAgIH0pKGNvbnRyb2wsIGV2KTsKICB9CgogIGNvbnRyb2wuaW5kZXggPSAxOwoKICByZXR1cm4gY29udHJvbDsKfTsKCkdNYXBzLnByb3RvdHlwZS5hZGRDb250cm9sID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBjb250cm9sID0gdGhpcy5jcmVhdGVDb250cm9sKG9wdGlvbnMpOwogIHRoaXMuY29udHJvbHMucHVzaChjb250cm9sKTsKICB0aGlzLm1hcC5jb250cm9sc1tjb250cm9sLnBvc2l0aW9uXS5wdXNoKGNvbnRyb2wpOwoKICByZXR1cm4gY29udHJvbDsKfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVDb250cm9sID0gZnVuY3Rpb24oY29udHJvbCkgewogIHZhciBwb3NpdGlvbiA9IG51bGw7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jb250cm9scy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRoaXMuY29udHJvbHNbaV0gPT0gY29udHJvbCkgewogICAgICBwb3NpdGlvbiA9IHRoaXMuY29udHJvbHNbaV0ucG9zaXRpb247CiAgICAgIHRoaXMuY29udHJvbHMuc3BsaWNlKGksIDEpOwogICAgfQogIH0KCiAgaWYgKHBvc2l0aW9uKSB7CiAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5tYXAuY29udHJvbHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGNvbnRyb2xzRm9yUG9zaXRpb24gPSB0aGlzLm1hcC5jb250cm9sc1tjb250cm9sLnBvc2l0aW9uXQogICAgICBpZiAoY29udHJvbHNGb3JQb3NpdGlvbi5nZXRBdChpKSA9PSBjb250cm9sKSB7CiAgICAgICAgY29udHJvbHNGb3JQb3NpdGlvbi5yZW1vdmVBdChpKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIGNvbnRyb2w7Cn07CgpHTWFwcy5wcm90b3R5cGUuY3JlYXRlTWFya2VyID0gZnVuY3Rpb24ob3B0aW9ucykgewogIGlmIChvcHRpb25zLmxhdCA9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5sbmcgPT0gdW5kZWZpbmVkICYmIG9wdGlvbnMucG9zaXRpb24gPT0gdW5kZWZpbmVkKSB7CiAgICB0aHJvdyAnTm8gbGF0aXR1ZGUgb3IgbG9uZ2l0dWRlIGRlZmluZWQuJzsKICB9CgogIHZhciBzZWxmID0gdGhpcywKICAgICAgZGV0YWlscyA9IG9wdGlvbnMuZGV0YWlscywKICAgICAgZmVuY2VzID0gb3B0aW9ucy5mZW5jZXMsCiAgICAgIG91dHNpZGUgPSBvcHRpb25zLm91dHNpZGUsCiAgICAgIGJhc2Vfb3B0aW9ucyA9IHsKICAgICAgICBwb3NpdGlvbjogbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhvcHRpb25zLmxhdCwgb3B0aW9ucy5sbmcpLAogICAgICAgIG1hcDogbnVsbAogICAgICB9LAogICAgICBtYXJrZXJfb3B0aW9ucyA9IGV4dGVuZF9vYmplY3QoYmFzZV9vcHRpb25zLCBvcHRpb25zKTsKCiAgZGVsZXRlIG1hcmtlcl9vcHRpb25zLmxhdDsKICBkZWxldGUgbWFya2VyX29wdGlvbnMubG5nOwogIGRlbGV0ZSBtYXJrZXJfb3B0aW9ucy5mZW5jZXM7CiAgZGVsZXRlIG1hcmtlcl9vcHRpb25zLm91dHNpZGU7CgogIHZhciBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKG1hcmtlcl9vcHRpb25zKTsKCiAgbWFya2VyLmZlbmNlcyA9IGZlbmNlczsKCiAgaWYgKG9wdGlvbnMuaW5mb1dpbmRvdykgewogICAgbWFya2VyLmluZm9XaW5kb3cgPSBuZXcgZ29vZ2xlLm1hcHMuSW5mb1dpbmRvdyhvcHRpb25zLmluZm9XaW5kb3cpOwoKICAgIHZhciBpbmZvX3dpbmRvd19ldmVudHMgPSBbJ2Nsb3NlY2xpY2snLCAnY29udGVudF9jaGFuZ2VkJywgJ2RvbXJlYWR5JywgJ3Bvc2l0aW9uX2NoYW5nZWQnLCAnemluZGV4X2NoYW5nZWQnXTsKCiAgICBmb3IgKHZhciBldiA9IDA7IGV2IDwgaW5mb193aW5kb3dfZXZlbnRzLmxlbmd0aDsgZXYrKykgewogICAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgICAgaWYgKG9wdGlvbnMuaW5mb1dpbmRvd1tuYW1lXSkgewogICAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIob2JqZWN0LCBuYW1lLCBmdW5jdGlvbihlKXsKICAgICAgICAgICAgb3B0aW9ucy5pbmZvV2luZG93W25hbWVdLmFwcGx5KHRoaXMsIFtlXSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pKG1hcmtlci5pbmZvV2luZG93LCBpbmZvX3dpbmRvd19ldmVudHNbZXZdKTsKICAgIH0KICB9CgogIHZhciBtYXJrZXJfZXZlbnRzID0gWydhbmltYXRpb25fY2hhbmdlZCcsICdjbGlja2FibGVfY2hhbmdlZCcsICdjdXJzb3JfY2hhbmdlZCcsICdkcmFnZ2FibGVfY2hhbmdlZCcsICdmbGF0X2NoYW5nZWQnLCAnaWNvbl9jaGFuZ2VkJywgJ3Bvc2l0aW9uX2NoYW5nZWQnLCAnc2hhZG93X2NoYW5nZWQnLCAnc2hhcGVfY2hhbmdlZCcsICd0aXRsZV9jaGFuZ2VkJywgJ3Zpc2libGVfY2hhbmdlZCcsICd6aW5kZXhfY2hhbmdlZCddOwoKICB2YXIgbWFya2VyX2V2ZW50c193aXRoX21vdXNlID0gWydkYmxjbGljaycsICdkcmFnJywgJ2RyYWdlbmQnLCAnZHJhZ3N0YXJ0JywgJ21vdXNlZG93bicsICdtb3VzZW91dCcsICdtb3VzZW92ZXInLCAnbW91c2V1cCddOwoKICBmb3IgKHZhciBldiA9IDA7IGV2IDwgbWFya2VyX2V2ZW50cy5sZW5ndGg7IGV2KyspIHsKICAgIChmdW5jdGlvbihvYmplY3QsIG5hbWUpIHsKICAgICAgaWYgKG9wdGlvbnNbbmFtZV0pIHsKICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKCl7CiAgICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIFt0aGlzXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pKG1hcmtlciwgbWFya2VyX2V2ZW50c1tldl0pOwogIH0KCiAgZm9yICh2YXIgZXYgPSAwOyBldiA8IG1hcmtlcl9ldmVudHNfd2l0aF9tb3VzZS5sZW5ndGg7IGV2KyspIHsKICAgIChmdW5jdGlvbihtYXAsIG9iamVjdCwgbmFtZSkgewogICAgICBpZiAob3B0aW9uc1tuYW1lXSkgewogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24obWUpewogICAgICAgICAgaWYoIW1lLnBpeGVsKXsKICAgICAgICAgICAgbWUucGl4ZWwgPSBtYXAuZ2V0UHJvamVjdGlvbigpLmZyb21MYXRMbmdUb1BvaW50KG1lLmxhdExuZykKICAgICAgICAgIH0KICAgICAgICAgIAogICAgICAgICAgb3B0aW9uc1tuYW1lXS5hcHBseSh0aGlzLCBbbWVdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSkodGhpcy5tYXAsIG1hcmtlciwgbWFya2VyX2V2ZW50c193aXRoX21vdXNlW2V2XSk7CiAgfQoKICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsICdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgdGhpcy5kZXRhaWxzID0gZGV0YWlsczsKCiAgICBpZiAob3B0aW9ucy5jbGljaykgewogICAgICBvcHRpb25zLmNsaWNrLmFwcGx5KHRoaXMsIFt0aGlzXSk7CiAgICB9CgogICAgaWYgKG1hcmtlci5pbmZvV2luZG93KSB7CiAgICAgIHNlbGYuaGlkZUluZm9XaW5kb3dzKCk7CiAgICAgIG1hcmtlci5pbmZvV2luZG93Lm9wZW4oc2VsZi5tYXAsIG1hcmtlcik7CiAgICB9CiAgfSk7CgogIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcmtlciwgJ3JpZ2h0Y2xpY2snLCBmdW5jdGlvbihlKSB7CiAgICBlLm1hcmtlciA9IHRoaXM7CgogICAgaWYgKG9wdGlvbnMucmlnaHRjbGljaykgewogICAgICBvcHRpb25zLnJpZ2h0Y2xpY2suYXBwbHkodGhpcywgW2VdKTsKICAgIH0KCiAgICBpZiAod2luZG93LmNvbnRleHRfbWVudVtzZWxmLmVsLmlkXVsnbWFya2VyJ10gIT0gdW5kZWZpbmVkKSB7CiAgICAgIHNlbGYuYnVpbGRDb250ZXh0TWVudSgnbWFya2VyJywgZSk7CiAgICB9CiAgfSk7CgogIGlmIChtYXJrZXIuZmVuY2VzKSB7CiAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsICdkcmFnZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgIHNlbGYuY2hlY2tNYXJrZXJHZW9mZW5jZShtYXJrZXIsIGZ1bmN0aW9uKG0sIGYpIHsKICAgICAgICBvdXRzaWRlKG0sIGYpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgcmV0dXJuIG1hcmtlcjsKfTsKCkdNYXBzLnByb3RvdHlwZS5hZGRNYXJrZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIG1hcmtlcjsKICBpZihvcHRpb25zLmhhc093blByb3BlcnR5KCdnbV9hY2Nlc3NvcnNfJykpIHsKICAgIC8vIE5hdGl2ZSBnb29nbGUubWFwcy5NYXJrZXIgb2JqZWN0CiAgICBtYXJrZXIgPSBvcHRpb25zOwogIH0KICBlbHNlIHsKICAgIGlmICgob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbGF0JykgJiYgb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbG5nJykpIHx8IG9wdGlvbnMucG9zaXRpb24pIHsKICAgICAgbWFya2VyID0gdGhpcy5jcmVhdGVNYXJrZXIob3B0aW9ucyk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgdGhyb3cgJ05vIGxhdGl0dWRlIG9yIGxvbmdpdHVkZSBkZWZpbmVkLic7CiAgICB9CiAgfQoKICBtYXJrZXIuc2V0TWFwKHRoaXMubWFwKTsKCiAgaWYodGhpcy5tYXJrZXJDbHVzdGVyZXIpIHsKICAgIHRoaXMubWFya2VyQ2x1c3RlcmVyLmFkZE1hcmtlcihtYXJrZXIpOwogIH0KCiAgdGhpcy5tYXJrZXJzLnB1c2gobWFya2VyKTsKCiAgR01hcHMuZmlyZSgnbWFya2VyX2FkZGVkJywgbWFya2VyLCB0aGlzKTsKCiAgcmV0dXJuIG1hcmtlcjsKfTsKCkdNYXBzLnByb3RvdHlwZS5hZGRNYXJrZXJzID0gZnVuY3Rpb24oYXJyYXkpIHsKICBmb3IgKHZhciBpID0gMCwgbWFya2VyOyBtYXJrZXI9YXJyYXlbaV07IGkrKykgewogICAgdGhpcy5hZGRNYXJrZXIobWFya2VyKTsKICB9CgogIHJldHVybiB0aGlzLm1hcmtlcnM7Cn07CgpHTWFwcy5wcm90b3R5cGUuaGlkZUluZm9XaW5kb3dzID0gZnVuY3Rpb24oKSB7CiAgZm9yICh2YXIgaSA9IDAsIG1hcmtlcjsgbWFya2VyID0gdGhpcy5tYXJrZXJzW2ldOyBpKyspewogICAgaWYgKG1hcmtlci5pbmZvV2luZG93KSB7CiAgICAgIG1hcmtlci5pbmZvV2luZG93LmNsb3NlKCk7CiAgICB9CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZU1hcmtlciA9IGZ1bmN0aW9uKG1hcmtlcikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5tYXJrZXJzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGhpcy5tYXJrZXJzW2ldID09PSBtYXJrZXIpIHsKICAgICAgdGhpcy5tYXJrZXJzW2ldLnNldE1hcChudWxsKTsKICAgICAgdGhpcy5tYXJrZXJzLnNwbGljZShpLCAxKTsKCiAgICAgIGlmKHRoaXMubWFya2VyQ2x1c3RlcmVyKSB7CiAgICAgICAgdGhpcy5tYXJrZXJDbHVzdGVyZXIucmVtb3ZlTWFya2VyKG1hcmtlcik7CiAgICAgIH0KCiAgICAgIEdNYXBzLmZpcmUoJ21hcmtlcl9yZW1vdmVkJywgbWFya2VyLCB0aGlzKTsKCiAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgcmV0dXJuIG1hcmtlcjsKfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVNYXJrZXJzID0gZnVuY3Rpb24gKGNvbGxlY3Rpb24pIHsKICB2YXIgbmV3X21hcmtlcnMgPSBbXTsKCiAgaWYgKHR5cGVvZiBjb2xsZWN0aW9uID09ICd1bmRlZmluZWQnKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWFya2Vycy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgbWFya2VyID0gdGhpcy5tYXJrZXJzW2ldOwogICAgICBtYXJrZXIuc2V0TWFwKG51bGwpOwoKICAgICAgaWYodGhpcy5tYXJrZXJDbHVzdGVyZXIpIHsKICAgICAgICB0aGlzLm1hcmtlckNsdXN0ZXJlci5yZW1vdmVNYXJrZXIobWFya2VyKTsKICAgICAgfQoKICAgICAgR01hcHMuZmlyZSgnbWFya2VyX3JlbW92ZWQnLCBtYXJrZXIsIHRoaXMpOwogICAgfQogICAgCiAgICB0aGlzLm1hcmtlcnMgPSBuZXdfbWFya2VyczsKICB9CiAgZWxzZSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbGxlY3Rpb24ubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5tYXJrZXJzLmluZGV4T2YoY29sbGVjdGlvbltpXSk7CgogICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgIHZhciBtYXJrZXIgPSB0aGlzLm1hcmtlcnNbaW5kZXhdOwogICAgICAgIG1hcmtlci5zZXRNYXAobnVsbCk7CgogICAgICAgIGlmKHRoaXMubWFya2VyQ2x1c3RlcmVyKSB7CiAgICAgICAgICB0aGlzLm1hcmtlckNsdXN0ZXJlci5yZW1vdmVNYXJrZXIobWFya2VyKTsKICAgICAgICB9CgogICAgICAgIEdNYXBzLmZpcmUoJ21hcmtlcl9yZW1vdmVkJywgbWFya2VyLCB0aGlzKTsKICAgICAgfQogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5tYXJrZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBtYXJrZXIgPSB0aGlzLm1hcmtlcnNbaV07CiAgICAgIGlmIChtYXJrZXIuZ2V0TWFwKCkgIT0gbnVsbCkgewogICAgICAgIG5ld19tYXJrZXJzLnB1c2gobWFya2VyKTsKICAgICAgfQogICAgfQoKICAgIHRoaXMubWFya2VycyA9IG5ld19tYXJrZXJzOwogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5kcmF3T3ZlcmxheSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgb3ZlcmxheSA9IG5ldyBnb29nbGUubWFwcy5PdmVybGF5VmlldygpLAogICAgICBhdXRvX3Nob3cgPSB0cnVlOwoKICBvdmVybGF5LnNldE1hcCh0aGlzLm1hcCk7CgogIGlmIChvcHRpb25zLmF1dG9fc2hvdyAhPSBudWxsKSB7CiAgICBhdXRvX3Nob3cgPSBvcHRpb25zLmF1dG9fc2hvdzsKICB9CgogIG92ZXJsYXkub25BZGQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKICAgIGVsLnN0eWxlLmJvcmRlclN0eWxlID0gIm5vbmUiOwogICAgZWwuc3R5bGUuYm9yZGVyV2lkdGggPSAiMHB4IjsKICAgIGVsLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgIGVsLnN0eWxlLnpJbmRleCA9IDEwMDsKICAgIGVsLmlubmVySFRNTCA9IG9wdGlvbnMuY29udGVudDsKCiAgICBvdmVybGF5LmVsID0gZWw7CgogICAgaWYgKCFvcHRpb25zLmxheWVyKSB7CiAgICAgIG9wdGlvbnMubGF5ZXIgPSAnb3ZlcmxheUxheWVyJzsKICAgIH0KICAgIAogICAgdmFyIHBhbmVzID0gdGhpcy5nZXRQYW5lcygpLAogICAgICAgIG92ZXJsYXlMYXllciA9IHBhbmVzW29wdGlvbnMubGF5ZXJdLAogICAgICAgIHN0b3Bfb3ZlcmxheV9ldmVudHMgPSBbJ2NvbnRleHRtZW51JywgJ0RPTU1vdXNlU2Nyb2xsJywgJ2RibGNsaWNrJywgJ21vdXNlZG93biddOwoKICAgIG92ZXJsYXlMYXllci5hcHBlbmRDaGlsZChlbCk7CgogICAgZm9yICh2YXIgZXYgPSAwOyBldiA8IHN0b3Bfb3ZlcmxheV9ldmVudHMubGVuZ3RoOyBldisrKSB7CiAgICAgIChmdW5jdGlvbihvYmplY3QsIG5hbWUpIHsKICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGREb21MaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKGUpewogICAgICAgICAgaWYgKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdtc2llJykgIT0gLTEgJiYgZG9jdW1lbnQuYWxsKSB7CiAgICAgICAgICAgIGUuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pKGVsLCBzdG9wX292ZXJsYXlfZXZlbnRzW2V2XSk7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuY2xpY2spIHsKICAgICAgcGFuZXMub3ZlcmxheU1vdXNlVGFyZ2V0LmFwcGVuZENoaWxkKG92ZXJsYXkuZWwpOwogICAgICBnb29nbGUubWFwcy5ldmVudC5hZGREb21MaXN0ZW5lcihvdmVybGF5LmVsLCAnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICBvcHRpb25zLmNsaWNrLmFwcGx5KG92ZXJsYXksIFtvdmVybGF5XSk7CiAgICAgIH0pOwogICAgfQoKICAgIGdvb2dsZS5tYXBzLmV2ZW50LnRyaWdnZXIodGhpcywgJ3JlYWR5Jyk7CiAgfTsKCiAgb3ZlcmxheS5kcmF3ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcHJvamVjdGlvbiA9IHRoaXMuZ2V0UHJvamVjdGlvbigpLAogICAgICAgIHBpeGVsID0gcHJvamVjdGlvbi5mcm9tTGF0TG5nVG9EaXZQaXhlbChuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKG9wdGlvbnMubGF0LCBvcHRpb25zLmxuZykpOwoKICAgIG9wdGlvbnMuaG9yaXpvbnRhbE9mZnNldCA9IG9wdGlvbnMuaG9yaXpvbnRhbE9mZnNldCB8fCAwOwogICAgb3B0aW9ucy52ZXJ0aWNhbE9mZnNldCA9IG9wdGlvbnMudmVydGljYWxPZmZzZXQgfHwgMDsKCiAgICB2YXIgZWwgPSBvdmVybGF5LmVsLAogICAgICAgIGNvbnRlbnQgPSBlbC5jaGlsZHJlblswXSwKICAgICAgICBjb250ZW50X2hlaWdodCA9IGNvbnRlbnQuY2xpZW50SGVpZ2h0LAogICAgICAgIGNvbnRlbnRfd2lkdGggPSBjb250ZW50LmNsaWVudFdpZHRoOwoKICAgIHN3aXRjaCAob3B0aW9ucy52ZXJ0aWNhbEFsaWduKSB7CiAgICAgIGNhc2UgJ3RvcCc6CiAgICAgICAgZWwuc3R5bGUudG9wID0gKHBpeGVsLnkgLSBjb250ZW50X2hlaWdodCArIG9wdGlvbnMudmVydGljYWxPZmZzZXQpICsgJ3B4JzsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgY2FzZSAnbWlkZGxlJzoKICAgICAgICBlbC5zdHlsZS50b3AgPSAocGl4ZWwueSAtIChjb250ZW50X2hlaWdodCAvIDIpICsgb3B0aW9ucy52ZXJ0aWNhbE9mZnNldCkgKyAncHgnOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdib3R0b20nOgogICAgICAgIGVsLnN0eWxlLnRvcCA9IChwaXhlbC55ICsgb3B0aW9ucy52ZXJ0aWNhbE9mZnNldCkgKyAncHgnOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIHN3aXRjaCAob3B0aW9ucy5ob3Jpem9udGFsQWxpZ24pIHsKICAgICAgY2FzZSAnbGVmdCc6CiAgICAgICAgZWwuc3R5bGUubGVmdCA9IChwaXhlbC54IC0gY29udGVudF93aWR0aCArIG9wdGlvbnMuaG9yaXpvbnRhbE9mZnNldCkgKyAncHgnOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICBjYXNlICdjZW50ZXInOgogICAgICAgIGVsLnN0eWxlLmxlZnQgPSAocGl4ZWwueCAtIChjb250ZW50X3dpZHRoIC8gMikgKyBvcHRpb25zLmhvcml6b250YWxPZmZzZXQpICsgJ3B4JzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAncmlnaHQnOgogICAgICAgIGVsLnN0eWxlLmxlZnQgPSAocGl4ZWwueCArIG9wdGlvbnMuaG9yaXpvbnRhbE9mZnNldCkgKyAncHgnOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBhdXRvX3Nob3cgPyAnYmxvY2snIDogJ25vbmUnOwoKICAgIGlmICghYXV0b19zaG93KSB7CiAgICAgIG9wdGlvbnMuc2hvdy5hcHBseSh0aGlzLCBbZWxdKTsKICAgIH0KICB9OwoKICBvdmVybGF5Lm9uUmVtb3ZlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgZWwgPSBvdmVybGF5LmVsOwoKICAgIGlmIChvcHRpb25zLnJlbW92ZSkgewogICAgICBvcHRpb25zLnJlbW92ZS5hcHBseSh0aGlzLCBbZWxdKTsKICAgIH0KICAgIGVsc2UgewogICAgICBvdmVybGF5LmVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQob3ZlcmxheS5lbCk7CiAgICAgIG92ZXJsYXkuZWwgPSBudWxsOwogICAgfQogIH07CgogIHRoaXMub3ZlcmxheXMucHVzaChvdmVybGF5KTsKICByZXR1cm4gb3ZlcmxheTsKfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVPdmVybGF5ID0gZnVuY3Rpb24ob3ZlcmxheSkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5vdmVybGF5cy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRoaXMub3ZlcmxheXNbaV0gPT09IG92ZXJsYXkpIHsKICAgICAgdGhpcy5vdmVybGF5c1tpXS5zZXRNYXAobnVsbCk7CiAgICAgIHRoaXMub3ZlcmxheXMuc3BsaWNlKGksIDEpOwoKICAgICAgYnJlYWs7CiAgICB9CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZU92ZXJsYXlzID0gZnVuY3Rpb24oKSB7CiAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSB0aGlzLm92ZXJsYXlzW2ldOyBpKyspIHsKICAgIGl0ZW0uc2V0TWFwKG51bGwpOwogIH0KCiAgdGhpcy5vdmVybGF5cyA9IFtdOwp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdQb2x5bGluZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgcGF0aCA9IFtdLAogICAgICBwb2ludHMgPSBvcHRpb25zLnBhdGg7CgogIGlmIChwb2ludHMubGVuZ3RoKSB7CiAgICBpZiAocG9pbnRzWzBdWzBdID09PSB1bmRlZmluZWQpIHsKICAgICAgcGF0aCA9IHBvaW50czsKICAgIH0KICAgIGVsc2UgewogICAgICBmb3IgKHZhciBpPTAsIGxhdGxuZzsgbGF0bG5nPXBvaW50c1tpXTsgaSsrKSB7CiAgICAgICAgcGF0aC5wdXNoKG5ldyBnb29nbGUubWFwcy5MYXRMbmcobGF0bG5nWzBdLCBsYXRsbmdbMV0pKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIHBvbHlsaW5lX29wdGlvbnMgPSB7CiAgICBtYXA6IHRoaXMubWFwLAogICAgcGF0aDogcGF0aCwKICAgIHN0cm9rZUNvbG9yOiBvcHRpb25zLnN0cm9rZUNvbG9yLAogICAgc3Ryb2tlT3BhY2l0eTogb3B0aW9ucy5zdHJva2VPcGFjaXR5LAogICAgc3Ryb2tlV2VpZ2h0OiBvcHRpb25zLnN0cm9rZVdlaWdodCwKICAgIGdlb2Rlc2ljOiBvcHRpb25zLmdlb2Rlc2ljLAogICAgY2xpY2thYmxlOiB0cnVlLAogICAgZWRpdGFibGU6IGZhbHNlLAogICAgdmlzaWJsZTogdHJ1ZQogIH07CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJjbGlja2FibGUiKSkgewogICAgcG9seWxpbmVfb3B0aW9ucy5jbGlja2FibGUgPSBvcHRpb25zLmNsaWNrYWJsZTsKICB9CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJlZGl0YWJsZSIpKSB7CiAgICBwb2x5bGluZV9vcHRpb25zLmVkaXRhYmxlID0gb3B0aW9ucy5lZGl0YWJsZTsKICB9CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJpY29ucyIpKSB7CiAgICBwb2x5bGluZV9vcHRpb25zLmljb25zID0gb3B0aW9ucy5pY29uczsKICB9CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJ6SW5kZXgiKSkgewogICAgcG9seWxpbmVfb3B0aW9ucy56SW5kZXggPSBvcHRpb25zLnpJbmRleDsKICB9CgogIHZhciBwb2x5bGluZSA9IG5ldyBnb29nbGUubWFwcy5Qb2x5bGluZShwb2x5bGluZV9vcHRpb25zKTsKCiAgdmFyIHBvbHlsaW5lX2V2ZW50cyA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNlbW92ZScsICdtb3VzZW91dCcsICdtb3VzZW92ZXInLCAnbW91c2V1cCcsICdyaWdodGNsaWNrJ107CgogIGZvciAodmFyIGV2ID0gMDsgZXYgPCBwb2x5bGluZV9ldmVudHMubGVuZ3RoOyBldisrKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGlmIChvcHRpb25zW25hbWVdKSB7CiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIob2JqZWN0LCBuYW1lLCBmdW5jdGlvbihlKXsKICAgICAgICAgIG9wdGlvbnNbbmFtZV0uYXBwbHkodGhpcywgW2VdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSkocG9seWxpbmUsIHBvbHlsaW5lX2V2ZW50c1tldl0pOwogIH0KCiAgdGhpcy5wb2x5bGluZXMucHVzaChwb2x5bGluZSk7CgogIEdNYXBzLmZpcmUoJ3BvbHlsaW5lX2FkZGVkJywgcG9seWxpbmUsIHRoaXMpOwoKICByZXR1cm4gcG9seWxpbmU7Cn07CgpHTWFwcy5wcm90b3R5cGUucmVtb3ZlUG9seWxpbmUgPSBmdW5jdGlvbihwb2x5bGluZSkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wb2x5bGluZXMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0aGlzLnBvbHlsaW5lc1tpXSA9PT0gcG9seWxpbmUpIHsKICAgICAgdGhpcy5wb2x5bGluZXNbaV0uc2V0TWFwKG51bGwpOwogICAgICB0aGlzLnBvbHlsaW5lcy5zcGxpY2UoaSwgMSk7CgogICAgICBHTWFwcy5maXJlKCdwb2x5bGluZV9yZW1vdmVkJywgcG9seWxpbmUsIHRoaXMpOwoKICAgICAgYnJlYWs7CiAgICB9CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZVBvbHlsaW5lcyA9IGZ1bmN0aW9uKCkgewogIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gdGhpcy5wb2x5bGluZXNbaV07IGkrKykgewogICAgaXRlbS5zZXRNYXAobnVsbCk7CiAgfQoKICB0aGlzLnBvbHlsaW5lcyA9IFtdOwp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdDaXJjbGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9ICBleHRlbmRfb2JqZWN0KHsKICAgIG1hcDogdGhpcy5tYXAsCiAgICBjZW50ZXI6IG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5sYXQsIG9wdGlvbnMubG5nKQogIH0sIG9wdGlvbnMpOwoKICBkZWxldGUgb3B0aW9ucy5sYXQ7CiAgZGVsZXRlIG9wdGlvbnMubG5nOwoKICB2YXIgcG9seWdvbiA9IG5ldyBnb29nbGUubWFwcy5DaXJjbGUob3B0aW9ucyksCiAgICAgIHBvbHlnb25fZXZlbnRzID0gWydjbGljaycsICdkYmxjbGljaycsICdtb3VzZWRvd24nLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3V0JywgJ21vdXNlb3ZlcicsICdtb3VzZXVwJywgJ3JpZ2h0Y2xpY2snXTsKCiAgZm9yICh2YXIgZXYgPSAwOyBldiA8IHBvbHlnb25fZXZlbnRzLmxlbmd0aDsgZXYrKykgewogICAgKGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICBpZiAob3B0aW9uc1tuYW1lXSkgewogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSl7CiAgICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIFtlXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pKHBvbHlnb24sIHBvbHlnb25fZXZlbnRzW2V2XSk7CiAgfQoKICB0aGlzLnBvbHlnb25zLnB1c2gocG9seWdvbik7CgogIHJldHVybiBwb2x5Z29uOwp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdSZWN0YW5nbGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IGV4dGVuZF9vYmplY3QoewogICAgbWFwOiB0aGlzLm1hcAogIH0sIG9wdGlvbnMpOwoKICB2YXIgbGF0TG5nQm91bmRzID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZ0JvdW5kcygKICAgIG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5ib3VuZHNbMF1bMF0sIG9wdGlvbnMuYm91bmRzWzBdWzFdKSwKICAgIG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5ib3VuZHNbMV1bMF0sIG9wdGlvbnMuYm91bmRzWzFdWzFdKQogICk7CgogIG9wdGlvbnMuYm91bmRzID0gbGF0TG5nQm91bmRzOwoKICB2YXIgcG9seWdvbiA9IG5ldyBnb29nbGUubWFwcy5SZWN0YW5nbGUob3B0aW9ucyksCiAgICAgIHBvbHlnb25fZXZlbnRzID0gWydjbGljaycsICdkYmxjbGljaycsICdtb3VzZWRvd24nLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3V0JywgJ21vdXNlb3ZlcicsICdtb3VzZXVwJywgJ3JpZ2h0Y2xpY2snXTsKCiAgZm9yICh2YXIgZXYgPSAwOyBldiA8IHBvbHlnb25fZXZlbnRzLmxlbmd0aDsgZXYrKykgewogICAgKGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICBpZiAob3B0aW9uc1tuYW1lXSkgewogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSl7CiAgICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIFtlXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pKHBvbHlnb24sIHBvbHlnb25fZXZlbnRzW2V2XSk7CiAgfQoKICB0aGlzLnBvbHlnb25zLnB1c2gocG9seWdvbik7CgogIHJldHVybiBwb2x5Z29uOwp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdQb2x5Z29uID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB1c2VHZW9KU09OID0gZmFsc2U7CgogIGlmKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoInVzZUdlb0pTT04iKSkgewogICAgdXNlR2VvSlNPTiA9IG9wdGlvbnMudXNlR2VvSlNPTjsKICB9CgogIGRlbGV0ZSBvcHRpb25zLnVzZUdlb0pTT047CgogIG9wdGlvbnMgPSBleHRlbmRfb2JqZWN0KHsKICAgIG1hcDogdGhpcy5tYXAKICB9LCBvcHRpb25zKTsKCiAgaWYgKHVzZUdlb0pTT04gPT0gZmFsc2UpIHsKICAgIG9wdGlvbnMucGF0aHMgPSBbb3B0aW9ucy5wYXRocy5zbGljZSgwKV07CiAgfQoKICBpZiAob3B0aW9ucy5wYXRocy5sZW5ndGggPiAwKSB7CiAgICBpZiAob3B0aW9ucy5wYXRoc1swXS5sZW5ndGggPiAwKSB7CiAgICAgIG9wdGlvbnMucGF0aHMgPSBhcnJheV9mbGF0KGFycmF5X21hcChvcHRpb25zLnBhdGhzLCBhcnJheVRvTGF0TG5nLCB1c2VHZW9KU09OKSk7CiAgICB9CiAgfQoKICB2YXIgcG9seWdvbiA9IG5ldyBnb29nbGUubWFwcy5Qb2x5Z29uKG9wdGlvbnMpLAogICAgICBwb2x5Z29uX2V2ZW50cyA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNlbW92ZScsICdtb3VzZW91dCcsICdtb3VzZW92ZXInLCAnbW91c2V1cCcsICdyaWdodGNsaWNrJ107CgogIGZvciAodmFyIGV2ID0gMDsgZXYgPCBwb2x5Z29uX2V2ZW50cy5sZW5ndGg7IGV2KyspIHsKICAgIChmdW5jdGlvbihvYmplY3QsIG5hbWUpIHsKICAgICAgaWYgKG9wdGlvbnNbbmFtZV0pIHsKICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKGUpewogICAgICAgICAgb3B0aW9uc1tuYW1lXS5hcHBseSh0aGlzLCBbZV0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KShwb2x5Z29uLCBwb2x5Z29uX2V2ZW50c1tldl0pOwogIH0KCiAgdGhpcy5wb2x5Z29ucy5wdXNoKHBvbHlnb24pOwoKICBHTWFwcy5maXJlKCdwb2x5Z29uX2FkZGVkJywgcG9seWdvbiwgdGhpcyk7CgogIHJldHVybiBwb2x5Z29uOwp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZVBvbHlnb24gPSBmdW5jdGlvbihwb2x5Z29uKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGhpcy5wb2x5Z29uc1tpXSA9PT0gcG9seWdvbikgewogICAgICB0aGlzLnBvbHlnb25zW2ldLnNldE1hcChudWxsKTsKICAgICAgdGhpcy5wb2x5Z29ucy5zcGxpY2UoaSwgMSk7CgogICAgICBHTWFwcy5maXJlKCdwb2x5Z29uX3JlbW92ZWQnLCBwb2x5Z29uLCB0aGlzKTsKCiAgICAgIGJyZWFrOwogICAgfQogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVQb2x5Z29ucyA9IGZ1bmN0aW9uKCkgewogIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gdGhpcy5wb2x5Z29uc1tpXTsgaSsrKSB7CiAgICBpdGVtLnNldE1hcChudWxsKTsKICB9CgogIHRoaXMucG9seWdvbnMgPSBbXTsKfTsKCkdNYXBzLnByb3RvdHlwZS5nZXRGcm9tRnVzaW9uVGFibGVzID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBldmVudHMgPSBvcHRpb25zLmV2ZW50czsKCiAgZGVsZXRlIG9wdGlvbnMuZXZlbnRzOwoKICB2YXIgZnVzaW9uX3RhYmxlc19vcHRpb25zID0gb3B0aW9ucywKICAgICAgbGF5ZXIgPSBuZXcgZ29vZ2xlLm1hcHMuRnVzaW9uVGFibGVzTGF5ZXIoZnVzaW9uX3RhYmxlc19vcHRpb25zKTsKCiAgZm9yICh2YXIgZXYgaW4gZXZlbnRzKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSkgewogICAgICAgIGV2ZW50c1tuYW1lXS5hcHBseSh0aGlzLCBbZV0pOwogICAgICB9KTsKICAgIH0pKGxheWVyLCBldik7CiAgfQoKICB0aGlzLmxheWVycy5wdXNoKGxheWVyKTsKCiAgcmV0dXJuIGxheWVyOwp9OwoKR01hcHMucHJvdG90eXBlLmxvYWRGcm9tRnVzaW9uVGFibGVzID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBsYXllciA9IHRoaXMuZ2V0RnJvbUZ1c2lvblRhYmxlcyhvcHRpb25zKTsKICBsYXllci5zZXRNYXAodGhpcy5tYXApOwoKICByZXR1cm4gbGF5ZXI7Cn07CgpHTWFwcy5wcm90b3R5cGUuZ2V0RnJvbUtNTCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdXJsID0gb3B0aW9ucy51cmwsCiAgICAgIGV2ZW50cyA9IG9wdGlvbnMuZXZlbnRzOwoKICBkZWxldGUgb3B0aW9ucy51cmw7CiAgZGVsZXRlIG9wdGlvbnMuZXZlbnRzOwoKICB2YXIga21sX29wdGlvbnMgPSBvcHRpb25zLAogICAgICBsYXllciA9IG5ldyBnb29nbGUubWFwcy5LbWxMYXllcih1cmwsIGttbF9vcHRpb25zKTsKCiAgZm9yICh2YXIgZXYgaW4gZXZlbnRzKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSkgewogICAgICAgIGV2ZW50c1tuYW1lXS5hcHBseSh0aGlzLCBbZV0pOwogICAgICB9KTsKICAgIH0pKGxheWVyLCBldik7CiAgfQoKICB0aGlzLmxheWVycy5wdXNoKGxheWVyKTsKCiAgcmV0dXJuIGxheWVyOwp9OwoKR01hcHMucHJvdG90eXBlLmxvYWRGcm9tS01MID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBsYXllciA9IHRoaXMuZ2V0RnJvbUtNTChvcHRpb25zKTsKICBsYXllci5zZXRNYXAodGhpcy5tYXApOwoKICByZXR1cm4gbGF5ZXI7Cn07CgpHTWFwcy5wcm90b3R5cGUuYWRkTGF5ZXIgPSBmdW5jdGlvbihsYXllck5hbWUsIG9wdGlvbnMpIHsKICAvL3ZhciBkZWZhdWx0X2xheWVycyA9IFsnd2VhdGhlcicsICdjbG91ZHMnLCAndHJhZmZpYycsICd0cmFuc2l0JywgJ2JpY3ljbGluZycsICdwYW5vcmFtaW8nLCAncGxhY2VzJ107CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgdmFyIGxheWVyOwoKICBzd2l0Y2gobGF5ZXJOYW1lKSB7CiAgICBjYXNlICd3ZWF0aGVyJzogdGhpcy5zaW5nbGVMYXllcnMud2VhdGhlciA9IGxheWVyID0gbmV3IGdvb2dsZS5tYXBzLndlYXRoZXIuV2VhdGhlckxheWVyKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnY2xvdWRzJzogdGhpcy5zaW5nbGVMYXllcnMuY2xvdWRzID0gbGF5ZXIgPSBuZXcgZ29vZ2xlLm1hcHMud2VhdGhlci5DbG91ZExheWVyKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAndHJhZmZpYyc6IHRoaXMuc2luZ2xlTGF5ZXJzLnRyYWZmaWMgPSBsYXllciA9IG5ldyBnb29nbGUubWFwcy5UcmFmZmljTGF5ZXIoKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICd0cmFuc2l0JzogdGhpcy5zaW5nbGVMYXllcnMudHJhbnNpdCA9IGxheWVyID0gbmV3IGdvb2dsZS5tYXBzLlRyYW5zaXRMYXllcigpOwogICAgICBicmVhazsKICAgIGNhc2UgJ2JpY3ljbGluZyc6IHRoaXMuc2luZ2xlTGF5ZXJzLmJpY3ljbGluZyA9IGxheWVyID0gbmV3IGdvb2dsZS5tYXBzLkJpY3ljbGluZ0xheWVyKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAncGFub3JhbWlvJzoKICAgICAgICB0aGlzLnNpbmdsZUxheWVycy5wYW5vcmFtaW8gPSBsYXllciA9IG5ldyBnb29nbGUubWFwcy5wYW5vcmFtaW8uUGFub3JhbWlvTGF5ZXIoKTsKICAgICAgICBsYXllci5zZXRUYWcob3B0aW9ucy5maWx0ZXIpOwogICAgICAgIGRlbGV0ZSBvcHRpb25zLmZpbHRlcjsKCiAgICAgICAgLy9jbGljayBldmVudAogICAgICAgIGlmIChvcHRpb25zLmNsaWNrKSB7CiAgICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihsYXllciwgJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgb3B0aW9ucy5jbGljayhldmVudCk7CiAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmNsaWNrOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICBicmVhazsKICAgICAgY2FzZSAncGxhY2VzJzoKICAgICAgICB0aGlzLnNpbmdsZUxheWVycy5wbGFjZXMgPSBsYXllciA9IG5ldyBnb29nbGUubWFwcy5wbGFjZXMuUGxhY2VzU2VydmljZSh0aGlzLm1hcCk7CgogICAgICAgIC8vc2VhcmNoLCBuZWFyYnlTZWFyY2gsIHJhZGFyU2VhcmNoIGNhbGxiYWNrLCBCb3RoIGFyZSB0aGUgc2FtZQogICAgICAgIGlmIChvcHRpb25zLnNlYXJjaCB8fCBvcHRpb25zLm5lYXJieVNlYXJjaCB8fCBvcHRpb25zLnJhZGFyU2VhcmNoKSB7CiAgICAgICAgICB2YXIgcGxhY2VTZWFyY2hSZXF1ZXN0ICA9IHsKICAgICAgICAgICAgYm91bmRzIDogb3B0aW9ucy5ib3VuZHMgfHwgbnVsbCwKICAgICAgICAgICAga2V5d29yZCA6IG9wdGlvbnMua2V5d29yZCB8fCBudWxsLAogICAgICAgICAgICBsb2NhdGlvbiA6IG9wdGlvbnMubG9jYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgbmFtZSA6IG9wdGlvbnMubmFtZSB8fCBudWxsLAogICAgICAgICAgICByYWRpdXMgOiBvcHRpb25zLnJhZGl1cyB8fCBudWxsLAogICAgICAgICAgICByYW5rQnkgOiBvcHRpb25zLnJhbmtCeSB8fCBudWxsLAogICAgICAgICAgICB0eXBlcyA6IG9wdGlvbnMudHlwZXMgfHwgbnVsbAogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAob3B0aW9ucy5yYWRhclNlYXJjaCkgewogICAgICAgICAgICBsYXllci5yYWRhclNlYXJjaChwbGFjZVNlYXJjaFJlcXVlc3QsIG9wdGlvbnMucmFkYXJTZWFyY2gpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChvcHRpb25zLnNlYXJjaCkgewogICAgICAgICAgICBsYXllci5zZWFyY2gocGxhY2VTZWFyY2hSZXF1ZXN0LCBvcHRpb25zLnNlYXJjaCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG9wdGlvbnMubmVhcmJ5U2VhcmNoKSB7CiAgICAgICAgICAgIGxheWVyLm5lYXJieVNlYXJjaChwbGFjZVNlYXJjaFJlcXVlc3QsIG9wdGlvbnMubmVhcmJ5U2VhcmNoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vdGV4dFNlYXJjaCBjYWxsYmFjawogICAgICAgIGlmIChvcHRpb25zLnRleHRTZWFyY2gpIHsKICAgICAgICAgIHZhciB0ZXh0U2VhcmNoUmVxdWVzdCAgPSB7CiAgICAgICAgICAgIGJvdW5kcyA6IG9wdGlvbnMuYm91bmRzIHx8IG51bGwsCiAgICAgICAgICAgIGxvY2F0aW9uIDogb3B0aW9ucy5sb2NhdGlvbiB8fCBudWxsLAogICAgICAgICAgICBxdWVyeSA6IG9wdGlvbnMucXVlcnkgfHwgbnVsbCwKICAgICAgICAgICAgcmFkaXVzIDogb3B0aW9ucy5yYWRpdXMgfHwgbnVsbAogICAgICAgICAgfTsKCiAgICAgICAgICBsYXllci50ZXh0U2VhcmNoKHRleHRTZWFyY2hSZXF1ZXN0LCBvcHRpb25zLnRleHRTZWFyY2gpOwogICAgICAgIH0KICAgICAgYnJlYWs7CiAgfQoKICBpZiAobGF5ZXIgIT09IHVuZGVmaW5lZCkgewogICAgaWYgKHR5cGVvZiBsYXllci5zZXRPcHRpb25zID09ICdmdW5jdGlvbicpIHsKICAgICAgbGF5ZXIuc2V0T3B0aW9ucyhvcHRpb25zKTsKICAgIH0KICAgIGlmICh0eXBlb2YgbGF5ZXIuc2V0TWFwID09ICdmdW5jdGlvbicpIHsKICAgICAgbGF5ZXIuc2V0TWFwKHRoaXMubWFwKTsKICAgIH0KCiAgICByZXR1cm4gbGF5ZXI7CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZUxheWVyID0gZnVuY3Rpb24obGF5ZXIpIHsKICBpZiAodHlwZW9mKGxheWVyKSA9PSAic3RyaW5nIiAmJiB0aGlzLnNpbmdsZUxheWVyc1tsYXllcl0gIT09IHVuZGVmaW5lZCkgewogICAgIHRoaXMuc2luZ2xlTGF5ZXJzW2xheWVyXS5zZXRNYXAobnVsbCk7CgogICAgIGRlbGV0ZSB0aGlzLnNpbmdsZUxheWVyc1tsYXllcl07CiAgfQogIGVsc2UgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxheWVycy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5sYXllcnNbaV0gPT09IGxheWVyKSB7CiAgICAgICAgdGhpcy5sYXllcnNbaV0uc2V0TWFwKG51bGwpOwogICAgICAgIHRoaXMubGF5ZXJzLnNwbGljZShpLCAxKTsKCiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9Cn07Cgp2YXIgdHJhdmVsTW9kZSwgdW5pdFN5c3RlbTsKCkdNYXBzLnByb3RvdHlwZS5nZXRSb3V0ZXMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgc3dpdGNoIChvcHRpb25zLnRyYXZlbE1vZGUpIHsKICAgIGNhc2UgJ2JpY3ljbGluZyc6CiAgICAgIHRyYXZlbE1vZGUgPSBnb29nbGUubWFwcy5UcmF2ZWxNb2RlLkJJQ1lDTElORzsKICAgICAgYnJlYWs7CiAgICBjYXNlICd0cmFuc2l0JzoKICAgICAgdHJhdmVsTW9kZSA9IGdvb2dsZS5tYXBzLlRyYXZlbE1vZGUuVFJBTlNJVDsKICAgICAgYnJlYWs7CiAgICBjYXNlICdkcml2aW5nJzoKICAgICAgdHJhdmVsTW9kZSA9IGdvb2dsZS5tYXBzLlRyYXZlbE1vZGUuRFJJVklORzsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB0cmF2ZWxNb2RlID0gZ29vZ2xlLm1hcHMuVHJhdmVsTW9kZS5XQUxLSU5HOwogICAgICBicmVhazsKICB9CgogIGlmIChvcHRpb25zLnVuaXRTeXN0ZW0gPT09ICdpbXBlcmlhbCcpIHsKICAgIHVuaXRTeXN0ZW0gPSBnb29nbGUubWFwcy5Vbml0U3lzdGVtLklNUEVSSUFMOwogIH0KICBlbHNlIHsKICAgIHVuaXRTeXN0ZW0gPSBnb29nbGUubWFwcy5Vbml0U3lzdGVtLk1FVFJJQzsKICB9CgogIHZhciBiYXNlX29wdGlvbnMgPSB7CiAgICAgICAgYXZvaWRIaWdod2F5czogZmFsc2UsCiAgICAgICAgYXZvaWRUb2xsczogZmFsc2UsCiAgICAgICAgb3B0aW1pemVXYXlwb2ludHM6IGZhbHNlLAogICAgICAgIHdheXBvaW50czogW10KICAgICAgfSwKICAgICAgcmVxdWVzdF9vcHRpb25zID0gIGV4dGVuZF9vYmplY3QoYmFzZV9vcHRpb25zLCBvcHRpb25zKTsKCiAgcmVxdWVzdF9vcHRpb25zLm9yaWdpbiA9IC9zdHJpbmcvLnRlc3QodHlwZW9mIG9wdGlvbnMub3JpZ2luKSA\/IG9wdGlvbnMub3JpZ2luIDogbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhvcHRpb25zLm9yaWdpblswXSwgb3B0aW9ucy5vcmlnaW5bMV0pOwogIHJlcXVlc3Rfb3B0aW9ucy5kZXN0aW5hdGlvbiA9IC9zdHJpbmcvLnRlc3QodHlwZW9mIG9wdGlvbnMuZGVzdGluYXRpb24pID8gb3B0aW9ucy5kZXN0aW5hdGlvbiA6IG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5kZXN0aW5hdGlvblswXSwgb3B0aW9ucy5kZXN0aW5hdGlvblsxXSk7CiAgcmVxdWVzdF9vcHRpb25zLnRyYXZlbE1vZGUgPSB0cmF2ZWxNb2RlOwogIHJlcXVlc3Rfb3B0aW9ucy51bml0U3lzdGVtID0gdW5pdFN5c3RlbTsKCiAgZGVsZXRlIHJlcXVlc3Rfb3B0aW9ucy5jYWxsYmFjazsKICBkZWxldGUgcmVxdWVzdF9vcHRpb25zLmVycm9yOwoKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIHNlcnZpY2UgPSBuZXcgZ29vZ2xlLm1hcHMuRGlyZWN0aW9uc1NlcnZpY2UoKTsKCiAgc2VydmljZS5yb3V0ZShyZXF1ZXN0X29wdGlvbnMsIGZ1bmN0aW9uKHJlc3VsdCwgc3RhdHVzKSB7CiAgICBpZiAoc3RhdHVzID09PSBnb29nbGUubWFwcy5EaXJlY3Rpb25zU3RhdHVzLk9LKSB7CiAgICAgIGZvciAodmFyIHIgaW4gcmVzdWx0LnJvdXRlcykgewogICAgICAgIGlmIChyZXN1bHQucm91dGVzLmhhc093blByb3BlcnR5KHIpKSB7CiAgICAgICAgICBzZWxmLnJvdXRlcy5wdXNoKHJlc3VsdC5yb3V0ZXNbcl0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMuY2FsbGJhY2spIHsKICAgICAgICBvcHRpb25zLmNhbGxiYWNrKHNlbGYucm91dGVzKTsKICAgICAgfQogICAgfQogICAgZWxzZSB7CiAgICAgIGlmIChvcHRpb25zLmVycm9yKSB7CiAgICAgICAgb3B0aW9ucy5lcnJvcihyZXN1bHQsIHN0YXR1cyk7CiAgICAgIH0KICAgIH0KICB9KTsKfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVSb3V0ZXMgPSBmdW5jdGlvbigpIHsKICB0aGlzLnJvdXRlcyA9IFtdOwp9OwoKR01hcHMucHJvdG90eXBlLmdldEVsZXZhdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IGV4dGVuZF9vYmplY3QoewogICAgbG9jYXRpb25zOiBbXSwKICAgIHBhdGggOiBmYWxzZSwKICAgIHNhbXBsZXMgOiAyNTYKICB9LCBvcHRpb25zKTsKCiAgaWYgKG9wdGlvbnMubG9jYXRpb25zLmxlbmd0aCA+IDApIHsKICAgIGlmIChvcHRpb25zLmxvY2F0aW9uc1swXS5sZW5ndGggPiAwKSB7CiAgICAgIG9wdGlvbnMubG9jYXRpb25zID0gYXJyYXlfZmxhdChhcnJheV9tYXAoW29wdGlvbnMubG9jYXRpb25zXSwgYXJyYXlUb0xhdExuZywgIGZhbHNlKSk7CiAgICB9CiAgfQoKICB2YXIgY2FsbGJhY2sgPSBvcHRpb25zLmNhbGxiYWNrOwogIGRlbGV0ZSBvcHRpb25zLmNhbGxiYWNrOwoKICB2YXIgc2VydmljZSA9IG5ldyBnb29nbGUubWFwcy5FbGV2YXRpb25TZXJ2aWNlKCk7CgogIC8vbG9jYXRpb24gcmVxdWVzdAogIGlmICghb3B0aW9ucy5wYXRoKSB7CiAgICBkZWxldGUgb3B0aW9ucy5wYXRoOwogICAgZGVsZXRlIG9wdGlvbnMuc2FtcGxlczsKCiAgICBzZXJ2aWNlLmdldEVsZXZhdGlvbkZvckxvY2F0aW9ucyhvcHRpb25zLCBmdW5jdGlvbihyZXN1bHQsIHN0YXR1cykgewogICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mKGNhbGxiYWNrKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGNhbGxiYWNrKHJlc3VsdCwgc3RhdHVzKTsKICAgICAgfQogICAgfSk7CiAgLy9wYXRoIHJlcXVlc3QKICB9IGVsc2UgewogICAgdmFyIHBhdGhSZXF1ZXN0ID0gewogICAgICBwYXRoIDogb3B0aW9ucy5sb2NhdGlvbnMsCiAgICAgIHNhbXBsZXMgOiBvcHRpb25zLnNhbXBsZXMKICAgIH07CgogICAgc2VydmljZS5nZXRFbGV2YXRpb25BbG9uZ1BhdGgocGF0aFJlcXVlc3QsIGZ1bmN0aW9uKHJlc3VsdCwgc3RhdHVzKSB7CiAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZihjYWxsYmFjaykgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjYWxsYmFjayhyZXN1bHQsIHN0YXR1cyk7CiAgICAgIH0KICAgIH0pOwogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5jbGVhblJvdXRlID0gR01hcHMucHJvdG90eXBlLnJlbW92ZVBvbHlsaW5lczsKCkdNYXBzLnByb3RvdHlwZS5kcmF3Um91dGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwoKICB0aGlzLmdldFJvdXRlcyh7CiAgICBvcmlnaW46IG9wdGlvbnMub3JpZ2luLAogICAgZGVzdGluYXRpb246IG9wdGlvbnMuZGVzdGluYXRpb24sCiAgICB0cmF2ZWxNb2RlOiBvcHRpb25zLnRyYXZlbE1vZGUsCiAgICB3YXlwb2ludHM6IG9wdGlvbnMud2F5cG9pbnRzLAogICAgdW5pdFN5c3RlbTogb3B0aW9ucy51bml0U3lzdGVtLAogICAgZXJyb3I6IG9wdGlvbnMuZXJyb3IsCiAgICBjYWxsYmFjazogZnVuY3Rpb24oZSkgewogICAgICBpZiAoZS5sZW5ndGggPiAwKSB7CiAgICAgICAgc2VsZi5kcmF3UG9seWxpbmUoewogICAgICAgICAgcGF0aDogZVtlLmxlbmd0aCAtIDFdLm92ZXJ2aWV3X3BhdGgsCiAgICAgICAgICBzdHJva2VDb2xvcjogb3B0aW9ucy5zdHJva2VDb2xvciwKICAgICAgICAgIHN0cm9rZU9wYWNpdHk6IG9wdGlvbnMuc3Ryb2tlT3BhY2l0eSwKICAgICAgICAgIHN0cm9rZVdlaWdodDogb3B0aW9ucy5zdHJva2VXZWlnaHQKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBpZiAob3B0aW9ucy5jYWxsYmFjaykgewogICAgICAgICAgb3B0aW9ucy5jYWxsYmFjayhlW2UubGVuZ3RoIC0gMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwp9OwoKR01hcHMucHJvdG90eXBlLnRyYXZlbFJvdXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIGlmIChvcHRpb25zLm9yaWdpbiAmJiBvcHRpb25zLmRlc3RpbmF0aW9uKSB7CiAgICB0aGlzLmdldFJvdXRlcyh7CiAgICAgIG9yaWdpbjogb3B0aW9ucy5vcmlnaW4sCiAgICAgIGRlc3RpbmF0aW9uOiBvcHRpb25zLmRlc3RpbmF0aW9uLAogICAgICB0cmF2ZWxNb2RlOiBvcHRpb25zLnRyYXZlbE1vZGUsCiAgICAgIHdheXBvaW50cyA6IG9wdGlvbnMud2F5cG9pbnRzLAogICAgICB1bml0U3lzdGVtOiBvcHRpb25zLnVuaXRTeXN0ZW0sCiAgICAgIGVycm9yOiBvcHRpb25zLmVycm9yLAogICAgICBjYWxsYmFjazogZnVuY3Rpb24oZSkgewogICAgICAgIC8vc3RhcnQgY2FsbGJhY2sKICAgICAgICBpZiAoZS5sZW5ndGggPiAwICYmIG9wdGlvbnMuc3RhcnQpIHsKICAgICAgICAgIG9wdGlvbnMuc3RhcnQoZVtlLmxlbmd0aCAtIDFdKTsKICAgICAgICB9CgogICAgICAgIC8vc3RlcCBjYWxsYmFjawogICAgICAgIGlmIChlLmxlbmd0aCA+IDAgJiYgb3B0aW9ucy5zdGVwKSB7CiAgICAgICAgICB2YXIgcm91dGUgPSBlW2UubGVuZ3RoIC0gMV07CiAgICAgICAgICBpZiAocm91dGUubGVncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBzdGVwcyA9IHJvdXRlLmxlZ3NbMF0uc3RlcHM7CiAgICAgICAgICAgIGZvciAodmFyIGk9MCwgc3RlcDsgc3RlcD1zdGVwc1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgc3RlcC5zdGVwX251bWJlciA9IGk7CiAgICAgICAgICAgICAgb3B0aW9ucy5zdGVwKHN0ZXAsIChyb3V0ZS5sZWdzWzBdLnN0ZXBzLmxlbmd0aCAtIDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy9lbmQgY2FsbGJhY2sKICAgICAgICBpZiAoZS5sZW5ndGggPiAwICYmIG9wdGlvbnMuZW5kKSB7CiAgICAgICAgICAgb3B0aW9ucy5lbmQoZVtlLmxlbmd0aCAtIDFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICBlbHNlIGlmIChvcHRpb25zLnJvdXRlKSB7CiAgICBpZiAob3B0aW9ucy5yb3V0ZS5sZWdzLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIHN0ZXBzID0gb3B0aW9ucy5yb3V0ZS5sZWdzWzBdLnN0ZXBzOwogICAgICBmb3IgKHZhciBpPTAsIHN0ZXA7IHN0ZXA9c3RlcHNbaV07IGkrKykgewogICAgICAgIHN0ZXAuc3RlcF9udW1iZXIgPSBpOwogICAgICAgIG9wdGlvbnMuc3RlcChzdGVwKTsKICAgICAgfQogICAgfQogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5kcmF3U3RlcHBlZFJvdXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpczsKICAKICBpZiAob3B0aW9ucy5vcmlnaW4gJiYgb3B0aW9ucy5kZXN0aW5hdGlvbikgewogICAgdGhpcy5nZXRSb3V0ZXMoewogICAgICBvcmlnaW46IG9wdGlvbnMub3JpZ2luLAogICAgICBkZXN0aW5hdGlvbjogb3B0aW9ucy5kZXN0aW5hdGlvbiwKICAgICAgdHJhdmVsTW9kZTogb3B0aW9ucy50cmF2ZWxNb2RlLAogICAgICB3YXlwb2ludHMgOiBvcHRpb25zLndheXBvaW50cywKICAgICAgZXJyb3I6IG9wdGlvbnMuZXJyb3IsCiAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihlKSB7CiAgICAgICAgLy9zdGFydCBjYWxsYmFjawogICAgICAgIGlmIChlLmxlbmd0aCA+IDAgJiYgb3B0aW9ucy5zdGFydCkgewogICAgICAgICAgb3B0aW9ucy5zdGFydChlW2UubGVuZ3RoIC0gMV0pOwogICAgICAgIH0KCiAgICAgICAgLy9zdGVwIGNhbGxiYWNrCiAgICAgICAgaWYgKGUubGVuZ3RoID4gMCAmJiBvcHRpb25zLnN0ZXApIHsKICAgICAgICAgIHZhciByb3V0ZSA9IGVbZS5sZW5ndGggLSAxXTsKICAgICAgICAgIGlmIChyb3V0ZS5sZWdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIHN0ZXBzID0gcm91dGUubGVnc1swXS5zdGVwczsKICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBzdGVwOyBzdGVwPXN0ZXBzW2ldOyBpKyspIHsKICAgICAgICAgICAgICBzdGVwLnN0ZXBfbnVtYmVyID0gaTsKICAgICAgICAgICAgICBzZWxmLmRyYXdQb2x5bGluZSh7CiAgICAgICAgICAgICAgICBwYXRoOiBzdGVwLnBhdGgsCiAgICAgICAgICAgICAgICBzdHJva2VDb2xvcjogb3B0aW9ucy5zdHJva2VDb2xvciwKICAgICAgICAgICAgICAgIHN0cm9rZU9wYWNpdHk6IG9wdGlvbnMuc3Ryb2tlT3BhY2l0eSwKICAgICAgICAgICAgICAgIHN0cm9rZVdlaWdodDogb3B0aW9ucy5zdHJva2VXZWlnaHQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBvcHRpb25zLnN0ZXAoc3RlcCwgKHJvdXRlLmxlZ3NbMF0uc3RlcHMubGVuZ3RoIC0gMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL2VuZCBjYWxsYmFjawogICAgICAgIGlmIChlLmxlbmd0aCA+IDAgJiYgb3B0aW9ucy5lbmQpIHsKICAgICAgICAgICBvcHRpb25zLmVuZChlW2UubGVuZ3RoIC0gMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIGVsc2UgaWYgKG9wdGlvbnMucm91dGUpIHsKICAgIGlmIChvcHRpb25zLnJvdXRlLmxlZ3MubGVuZ3RoID4gMCkgewogICAgICB2YXIgc3RlcHMgPSBvcHRpb25zLnJvdXRlLmxlZ3NbMF0uc3RlcHM7CiAgICAgIGZvciAodmFyIGk9MCwgc3RlcDsgc3RlcD1zdGVwc1tpXTsgaSsrKSB7CiAgICAgICAgc3RlcC5zdGVwX251bWJlciA9IGk7CiAgICAgICAgc2VsZi5kcmF3UG9seWxpbmUoewogICAgICAgICAgcGF0aDogc3RlcC5wYXRoLAogICAgICAgICAgc3Ryb2tlQ29sb3I6IG9wdGlvbnMuc3Ryb2tlQ29sb3IsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiBvcHRpb25zLnN0cm9rZU9wYWNpdHksCiAgICAgICAgICBzdHJva2VXZWlnaHQ6IG9wdGlvbnMuc3Ryb2tlV2VpZ2h0CiAgICAgICAgfSk7CiAgICAgICAgb3B0aW9ucy5zdGVwKHN0ZXApOwogICAgICB9CiAgICB9CiAgfQp9OwoKR01hcHMuUm91dGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdGhpcy5vcmlnaW4gPSBvcHRpb25zLm9yaWdpbjsKICB0aGlzLmRlc3RpbmF0aW9uID0gb3B0aW9ucy5kZXN0aW5hdGlvbjsKICB0aGlzLndheXBvaW50cyA9IG9wdGlvbnMud2F5cG9pbnRzOwoKICB0aGlzLm1hcCA9IG9wdGlvbnMubWFwOwogIHRoaXMucm91dGUgPSBvcHRpb25zLnJvdXRlOwogIHRoaXMuc3RlcF9jb3VudCA9IDA7CiAgdGhpcy5zdGVwcyA9IHRoaXMucm91dGUubGVnc1swXS5zdGVwczsKICB0aGlzLnN0ZXBzX2xlbmd0aCA9IHRoaXMuc3RlcHMubGVuZ3RoOwoKICB0aGlzLnBvbHlsaW5lID0gdGhpcy5tYXAuZHJhd1BvbHlsaW5lKHsKICAgIHBhdGg6IG5ldyBnb29nbGUubWFwcy5NVkNBcnJheSgpLAogICAgc3Ryb2tlQ29sb3I6IG9wdGlvbnMuc3Ryb2tlQ29sb3IsCiAgICBzdHJva2VPcGFjaXR5OiBvcHRpb25zLnN0cm9rZU9wYWNpdHksCiAgICBzdHJva2VXZWlnaHQ6IG9wdGlvbnMuc3Ryb2tlV2VpZ2h0CiAgfSkuZ2V0UGF0aCgpOwp9OwoKR01hcHMuUm91dGUucHJvdG90eXBlLmdldFJvdXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpczsKCiAgdGhpcy5tYXAuZ2V0Um91dGVzKHsKICAgIG9yaWdpbiA6IHRoaXMub3JpZ2luLAogICAgZGVzdGluYXRpb24gOiB0aGlzLmRlc3RpbmF0aW9uLAogICAgdHJhdmVsTW9kZSA6IG9wdGlvbnMudHJhdmVsTW9kZSwKICAgIHdheXBvaW50cyA6IHRoaXMud2F5cG9pbnRzIHx8IFtdLAogICAgZXJyb3I6IG9wdGlvbnMuZXJyb3IsCiAgICBjYWxsYmFjayA6IGZ1bmN0aW9uKCkgewogICAgICBzZWxmLnJvdXRlID0gZVswXTsKCiAgICAgIGlmIChvcHRpb25zLmNhbGxiYWNrKSB7CiAgICAgICAgb3B0aW9ucy5jYWxsYmFjay5jYWxsKHNlbGYpOwogICAgICB9CiAgICB9CiAgfSk7Cn07CgpHTWFwcy5Sb3V0ZS5wcm90b3R5cGUuYmFjayA9IGZ1bmN0aW9uKCkgewogIGlmICh0aGlzLnN0ZXBfY291bnQgPiAwKSB7CiAgICB0aGlzLnN0ZXBfY291bnQtLTsKICAgIHZhciBwYXRoID0gdGhpcy5yb3V0ZS5sZWdzWzBdLnN0ZXBzW3RoaXMuc3RlcF9jb3VudF0ucGF0aDsKCiAgICBmb3IgKHZhciBwIGluIHBhdGgpewogICAgICBpZiAocGF0aC5oYXNPd25Qcm9wZXJ0eShwKSl7CiAgICAgICAgdGhpcy5wb2x5bGluZS5wb3AoKTsKICAgICAgfQogICAgfQogIH0KfTsKCkdNYXBzLlJvdXRlLnByb3RvdHlwZS5mb3J3YXJkID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuc3RlcF9jb3VudCA8IHRoaXMuc3RlcHNfbGVuZ3RoKSB7CiAgICB2YXIgcGF0aCA9IHRoaXMucm91dGUubGVnc1swXS5zdGVwc1t0aGlzLnN0ZXBfY291bnRdLnBhdGg7CgogICAgZm9yICh2YXIgcCBpbiBwYXRoKXsKICAgICAgaWYgKHBhdGguaGFzT3duUHJvcGVydHkocCkpewogICAgICAgIHRoaXMucG9seWxpbmUucHVzaChwYXRoW3BdKTsKICAgICAgfQogICAgfQogICAgdGhpcy5zdGVwX2NvdW50Kys7CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLmNoZWNrR2VvZmVuY2UgPSBmdW5jdGlvbihsYXQsIGxuZywgZmVuY2UpIHsKICByZXR1cm4gZmVuY2UuY29udGFpbnNMYXRMbmcobmV3IGdvb2dsZS5tYXBzLkxhdExuZyhsYXQsIGxuZykpOwp9OwoKR01hcHMucHJvdG90eXBlLmNoZWNrTWFya2VyR2VvZmVuY2UgPSBmdW5jdGlvbihtYXJrZXIsIG91dHNpZGVfY2FsbGJhY2spIHsKICBpZiAobWFya2VyLmZlbmNlcykgewogICAgZm9yICh2YXIgaSA9IDAsIGZlbmNlOyBmZW5jZSA9IG1hcmtlci5mZW5jZXNbaV07IGkrKykgewogICAgICB2YXIgcG9zID0gbWFya2VyLmdldFBvc2l0aW9uKCk7CiAgICAgIGlmICghdGhpcy5jaGVja0dlb2ZlbmNlKHBvcy5sYXQoKSwgcG9zLmxuZygpLCBmZW5jZSkpIHsKICAgICAgICBvdXRzaWRlX2NhbGxiYWNrKG1hcmtlciwgZmVuY2UpOwogICAgICB9CiAgICB9CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLnRvSW1hZ2UgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9LAogICAgICBzdGF0aWNfbWFwX29wdGlvbnMgPSB7fTsKCiAgc3RhdGljX21hcF9vcHRpb25zWydzaXplJ10gPSBvcHRpb25zWydzaXplJ10gfHwgW3RoaXMuZWwuY2xpZW50V2lkdGgsIHRoaXMuZWwuY2xpZW50SGVpZ2h0XTsKICBzdGF0aWNfbWFwX29wdGlvbnNbJ2xhdCddID0gdGhpcy5nZXRDZW50ZXIoKS5sYXQoKTsKICBzdGF0aWNfbWFwX29wdGlvbnNbJ2xuZyddID0gdGhpcy5nZXRDZW50ZXIoKS5sbmcoKTsKCiAgaWYgKHRoaXMubWFya2Vycy5sZW5ndGggPiAwKSB7CiAgICBzdGF0aWNfbWFwX29wdGlvbnNbJ21hcmtlcnMnXSA9IFtdOwogICAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWFya2Vycy5sZW5ndGg7IGkrKykgewogICAgICBzdGF0aWNfbWFwX29wdGlvbnNbJ21hcmtlcnMnXS5wdXNoKHsKICAgICAgICBsYXQ6IHRoaXMubWFya2Vyc1tpXS5nZXRQb3NpdGlvbigpLmxhdCgpLAogICAgICAgIGxuZzogdGhpcy5tYXJrZXJzW2ldLmdldFBvc2l0aW9uKCkubG5nKCkKICAgICAgfSk7CiAgICB9CiAgfQoKICBpZiAodGhpcy5wb2x5bGluZXMubGVuZ3RoID4gMCkgewogICAgdmFyIHBvbHlsaW5lID0gdGhpcy5wb2x5bGluZXNbMF07CiAgICAKICAgIHN0YXRpY19tYXBfb3B0aW9uc1sncG9seWxpbmUnXSA9IHt9OwogICAgc3RhdGljX21hcF9vcHRpb25zWydwb2x5bGluZSddWydwYXRoJ10gPSBnb29nbGUubWFwcy5nZW9tZXRyeS5lbmNvZGluZy5lbmNvZGVQYXRoKHBvbHlsaW5lLmdldFBhdGgoKSk7CiAgICBzdGF0aWNfbWFwX29wdGlvbnNbJ3BvbHlsaW5lJ11bJ3N0cm9rZUNvbG9yJ10gPSBwb2x5bGluZS5zdHJva2VDb2xvcgogICAgc3RhdGljX21hcF9vcHRpb25zWydwb2x5bGluZSddWydzdHJva2VPcGFjaXR5J10gPSBwb2x5bGluZS5zdHJva2VPcGFjaXR5CiAgICBzdGF0aWNfbWFwX29wdGlvbnNbJ3BvbHlsaW5lJ11bJ3N0cm9rZVdlaWdodCddID0gcG9seWxpbmUuc3Ryb2tlV2VpZ2h0CiAgfQoKICByZXR1cm4gR01hcHMuc3RhdGljTWFwVVJMKHN0YXRpY19tYXBfb3B0aW9ucyk7Cn07CgpHTWFwcy5zdGF0aWNNYXBVUkwgPSBmdW5jdGlvbihvcHRpb25zKXsKICB2YXIgcGFyYW1ldGVycyA9IFtdLAogICAgICBkYXRhLAogICAgICBzdGF0aWNfcm9vdCA9ICdodHRwOi8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9zdGF0aWNtYXAnOwoKICBpZiAob3B0aW9ucy51cmwpIHsKICAgIHN0YXRpY19yb290ID0gb3B0aW9ucy51cmw7CiAgICBkZWxldGUgb3B0aW9ucy51cmw7CiAgfQoKICBzdGF0aWNfcm9vdCArPSAnPyc7CgogIHZhciBtYXJrZXJzID0gb3B0aW9ucy5tYXJrZXJzOwogIAogIGRlbGV0ZSBvcHRpb25zLm1hcmtlcnM7CgogIGlmICghbWFya2VycyAmJiBvcHRpb25zLm1hcmtlcikgewogICAgbWFya2VycyA9IFtvcHRpb25zLm1hcmtlcl07CiAgICBkZWxldGUgb3B0aW9ucy5tYXJrZXI7CiAgfQoKICB2YXIgc3R5bGVzID0gb3B0aW9ucy5zdHlsZXM7CgogIGRlbGV0ZSBvcHRpb25zLnN0eWxlczsKCiAgdmFyIHBvbHlsaW5lID0gb3B0aW9ucy5wb2x5bGluZTsKICBkZWxldGUgb3B0aW9ucy5wb2x5bGluZTsKCiAgLyoqIE1hcCBvcHRpb25zICoqLwogIGlmIChvcHRpb25zLmNlbnRlcikgewogICAgcGFyYW1ldGVycy5wdXNoKCdjZW50ZXI9JyArIG9wdGlvbnMuY2VudGVyKTsKICAgIGRlbGV0ZSBvcHRpb25zLmNlbnRlcjsKICB9CiAgZWxzZSBpZiAob3B0aW9ucy5hZGRyZXNzKSB7CiAgICBwYXJhbWV0ZXJzLnB1c2goJ2NlbnRlcj0nICsgb3B0aW9ucy5hZGRyZXNzKTsKICAgIGRlbGV0ZSBvcHRpb25zLmFkZHJlc3M7CiAgfQogIGVsc2UgaWYgKG9wdGlvbnMubGF0KSB7CiAgICBwYXJhbWV0ZXJzLnB1c2goWydjZW50ZXI9Jywgb3B0aW9ucy5sYXQsICcsJywgb3B0aW9ucy5sbmddLmpvaW4oJycpKTsKICAgIGRlbGV0ZSBvcHRpb25zLmxhdDsKICAgIGRlbGV0ZSBvcHRpb25zLmxuZzsKICB9CiAgZWxzZSBpZiAob3B0aW9ucy52aXNpYmxlKSB7CiAgICB2YXIgdmlzaWJsZSA9IGVuY29kZVVSSShvcHRpb25zLnZpc2libGUuam9pbignfCcpKTsKICAgIHBhcmFtZXRlcnMucHVzaCgndmlzaWJsZT0nICsgdmlzaWJsZSk7CiAgfQoKICB2YXIgc2l6ZSA9IG9wdGlvbnMuc2l6ZTsKICBpZiAoc2l6ZSkgewogICAgaWYgKHNpemUuam9pbikgewogICAgICBzaXplID0gc2l6ZS5qb2luKCd4Jyk7CiAgICB9CiAgICBkZWxldGUgb3B0aW9ucy5zaXplOwogIH0KICBlbHNlIHsKICAgIHNpemUgPSAnNjMweDMwMCc7CiAgfQogIHBhcmFtZXRlcnMucHVzaCgnc2l6ZT0nICsgc2l6ZSk7CgogIGlmICghb3B0aW9ucy56b29tICYmIG9wdGlvbnMuem9vbSAhPT0gZmFsc2UpIHsKICAgIG9wdGlvbnMuem9vbSA9IDE1OwogIH0KCiAgdmFyIHNlbnNvciA9IG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ3NlbnNvcicpID8gISFvcHRpb25zLnNlbnNvciA6IHRydWU7CiAgZGVsZXRlIG9wdGlvbnMuc2Vuc29yOwogIHBhcmFtZXRlcnMucHVzaCgnc2Vuc29yPScgKyBzZW5zb3IpOwoKICBmb3IgKHZhciBwYXJhbSBpbiBvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgcGFyYW1ldGVycy5wdXNoKHBhcmFtICsgJz0nICsgb3B0aW9uc1twYXJhbV0pOwogICAgfQogIH0KCiAgLyoqIE1hcmtlcnMgKiovCiAgaWYgKG1hcmtlcnMpIHsKICAgIHZhciBtYXJrZXIsIGxvYzsKCiAgICBmb3IgKHZhciBpPTA7IGRhdGE9bWFya2Vyc1tpXTsgaSsrKSB7CiAgICAgIG1hcmtlciA9IFtdOwoKICAgICAgaWYgKGRhdGEuc2l6ZSAmJiBkYXRhLnNpemUgIT09ICdub3JtYWwnKSB7CiAgICAgICAgbWFya2VyLnB1c2goJ3NpemU6JyArIGRhdGEuc2l6ZSk7CiAgICAgICAgZGVsZXRlIGRhdGEuc2l6ZTsKICAgICAgfQogICAgICBlbHNlIGlmIChkYXRhLmljb24pIHsKICAgICAgICBtYXJrZXIucHVzaCgnaWNvbjonICsgZW5jb2RlVVJJKGRhdGEuaWNvbikpOwogICAgICAgIGRlbGV0ZSBkYXRhLmljb247CiAgICAgIH0KCiAgICAgIGlmIChkYXRhLmNvbG9yKSB7CiAgICAgICAgbWFya2VyLnB1c2goJ2NvbG9yOicgKyBkYXRhLmNvbG9yLnJlcGxhY2UoJyMnLCAnMHgnKSk7CiAgICAgICAgZGVsZXRlIGRhdGEuY29sb3I7CiAgICAgIH0KCiAgICAgIGlmIChkYXRhLmxhYmVsKSB7CiAgICAgICAgbWFya2VyLnB1c2goJ2xhYmVsOicgKyBkYXRhLmxhYmVsWzBdLnRvVXBwZXJDYXNlKCkpOwogICAgICAgIGRlbGV0ZSBkYXRhLmxhYmVsOwogICAgICB9CgogICAgICBsb2MgPSAoZGF0YS5hZGRyZXNzID8gZGF0YS5hZGRyZXNzIDogZGF0YS5sYXQgKyAnLCcgKyBkYXRhLmxuZyk7CiAgICAgIGRlbGV0ZSBkYXRhLmFkZHJlc3M7CiAgICAgIGRlbGV0ZSBkYXRhLmxhdDsKICAgICAgZGVsZXRlIGRhdGEubG5nOwoKICAgICAgZm9yKHZhciBwYXJhbSBpbiBkYXRhKXsKICAgICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgICAgIG1hcmtlci5wdXNoKHBhcmFtICsgJzonICsgZGF0YVtwYXJhbV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG1hcmtlci5sZW5ndGggfHwgaSA9PT0gMCkgewogICAgICAgIG1hcmtlci5wdXNoKGxvYyk7CiAgICAgICAgbWFya2VyID0gbWFya2VyLmpvaW4oJ3wnKTsKICAgICAgICBwYXJhbWV0ZXJzLnB1c2goJ21hcmtlcnM9JyArIGVuY29kZVVSSShtYXJrZXIpKTsKICAgICAgfQogICAgICAvLyBOZXcgbWFya2VyIHdpdGhvdXQgc3R5bGVzCiAgICAgIGVsc2UgewogICAgICAgIG1hcmtlciA9IHBhcmFtZXRlcnMucG9wKCkgKyBlbmNvZGVVUkkoJ3wnICsgbG9jKTsKICAgICAgICBwYXJhbWV0ZXJzLnB1c2gobWFya2VyKTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqIE1hcCBTdHlsZXMgKiovCiAgaWYgKHN0eWxlcykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHN0eWxlUnVsZSA9IFtdOwogICAgICBpZiAoc3R5bGVzW2ldLmZlYXR1cmVUeXBlKXsKICAgICAgICBzdHlsZVJ1bGUucHVzaCgnZmVhdHVyZTonICsgc3R5bGVzW2ldLmZlYXR1cmVUeXBlLnRvTG93ZXJDYXNlKCkpOwogICAgICB9CgogICAgICBpZiAoc3R5bGVzW2ldLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgc3R5bGVSdWxlLnB1c2goJ2VsZW1lbnQ6JyArIHN0eWxlc1tpXS5lbGVtZW50VHlwZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBzdHlsZXNbaV0uc3R5bGVycy5sZW5ndGg7IGorKykgewogICAgICAgIGZvciAodmFyIHAgaW4gc3R5bGVzW2ldLnN0eWxlcnNbal0pIHsKICAgICAgICAgIHZhciBydWxlQXJnID0gc3R5bGVzW2ldLnN0eWxlcnNbal1bcF07CiAgICAgICAgICBpZiAocCA9PSAnaHVlJyB8fCBwID09ICdjb2xvcicpIHsKICAgICAgICAgICAgcnVsZUFyZyA9ICcweCcgKyBydWxlQXJnLnN1YnN0cmluZygxKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0eWxlUnVsZS5wdXNoKHAgKyAnOicgKyBydWxlQXJnKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBydWxlID0gc3R5bGVSdWxlLmpvaW4oJ3wnKTsKICAgICAgaWYgKHJ1bGUgIT0gJycpIHsKICAgICAgICBwYXJhbWV0ZXJzLnB1c2goJ3N0eWxlPScgKyBydWxlKTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqIFBvbHlsaW5lcyAqKi8KICBmdW5jdGlvbiBwYXJzZUNvbG9yKGNvbG9yLCBvcGFjaXR5KSB7CiAgICBpZiAoY29sb3JbMF0gPT09ICcjJyl7CiAgICAgIGNvbG9yID0gY29sb3IucmVwbGFjZSgnIycsICcweCcpOwoKICAgICAgaWYgKG9wYWNpdHkpIHsKICAgICAgICBvcGFjaXR5ID0gcGFyc2VGbG9hdChvcGFjaXR5KTsKICAgICAgICBvcGFjaXR5ID0gTWF0aC5taW4oMSwgTWF0aC5tYXgob3BhY2l0eSwgMCkpOwogICAgICAgIGlmIChvcGFjaXR5ID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gJzB4MDAwMDAwMDAnOwogICAgICAgIH0KICAgICAgICBvcGFjaXR5ID0gKG9wYWNpdHkgKiAyNTUpLnRvU3RyaW5nKDE2KTsKICAgICAgICBpZiAob3BhY2l0eS5sZW5ndGggPT09IDEpIHsKICAgICAgICAgIG9wYWNpdHkgKz0gb3BhY2l0eTsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3Iuc2xpY2UoMCw4KSArIG9wYWNpdHk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb2xvcjsKICB9CgogIGlmIChwb2x5bGluZSkgewogICAgZGF0YSA9IHBvbHlsaW5lOwogICAgcG9seWxpbmUgPSBbXTsKCiAgICBpZiAoZGF0YS5zdHJva2VXZWlnaHQpIHsKICAgICAgcG9seWxpbmUucHVzaCgnd2VpZ2h0OicgKyBwYXJzZUludChkYXRhLnN0cm9rZVdlaWdodCwgMTApKTsKICAgIH0KCiAgICBpZiAoZGF0YS5zdHJva2VDb2xvcikgewogICAgICB2YXIgY29sb3IgPSBwYXJzZUNvbG9yKGRhdGEuc3Ryb2tlQ29sb3IsIGRhdGEuc3Ryb2tlT3BhY2l0eSk7CiAgICAgIHBvbHlsaW5lLnB1c2goJ2NvbG9yOicgKyBjb2xvcik7CiAgICB9CgogICAgaWYgKGRhdGEuZmlsbENvbG9yKSB7CiAgICAgIHZhciBmaWxsY29sb3IgPSBwYXJzZUNvbG9yKGRhdGEuZmlsbENvbG9yLCBkYXRhLmZpbGxPcGFjaXR5KTsKICAgICAgcG9seWxpbmUucHVzaCgnZmlsbGNvbG9yOicgKyBmaWxsY29sb3IpOwogICAgfQoKICAgIHZhciBwYXRoID0gZGF0YS5wYXRoOwogICAgaWYgKHBhdGguam9pbikgewogICAgICBmb3IgKHZhciBqPTAsIHBvczsgcG9zPXBhdGhbal07IGorKykgewogICAgICAgIHBvbHlsaW5lLnB1c2gocG9zLmpvaW4oJywnKSk7CiAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICBwb2x5bGluZS5wdXNoKCdlbmM6JyArIHBhdGgpOwogICAgfQoKICAgIHBvbHlsaW5lID0gcG9seWxpbmUuam9pbignfCcpOwogICAgcGFyYW1ldGVycy5wdXNoKCdwYXRoPScgKyBlbmNvZGVVUkkocG9seWxpbmUpKTsKICB9CgogIC8qKiBSZXRpbmEgc3VwcG9ydCAqKi8KICB2YXIgZHBpID0gd2luZG93LmRldmljZVBpeGVsUmF0aW8gfHwgMTsKICBwYXJhbWV0ZXJzLnB1c2goJ3NjYWxlPScgKyBkcGkpOwoKICBwYXJhbWV0ZXJzID0gcGFyYW1ldGVycy5qb2luKCcmJyk7CiAgcmV0dXJuIHN0YXRpY19yb290ICsgcGFyYW1ldGVyczsKfTsKCkdNYXBzLnByb3RvdHlwZS5hZGRNYXBUeXBlID0gZnVuY3Rpb24obWFwVHlwZUlkLCBvcHRpb25zKSB7CiAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoImdldFRpbGVVcmwiKSAmJiB0eXBlb2Yob3B0aW9uc1siZ2V0VGlsZVVybCJdKSA9PSAiZnVuY3Rpb24iKSB7CiAgICBvcHRpb25zLnRpbGVTaXplID0gb3B0aW9ucy50aWxlU2l6ZSB8fCBuZXcgZ29vZ2xlLm1hcHMuU2l6ZSgyNTYsIDI1Nik7CgogICAgdmFyIG1hcFR5cGUgPSBuZXcgZ29vZ2xlLm1hcHMuSW1hZ2VNYXBUeXBlKG9wdGlvbnMpOwoKICAgIHRoaXMubWFwLm1hcFR5cGVzLnNldChtYXBUeXBlSWQsIG1hcFR5cGUpOwogIH0KICBlbHNlIHsKICAgIHRocm93ICInZ2V0VGlsZVVybCcgZnVuY3Rpb24gcmVxdWlyZWQuIjsKICB9Cn07CgpHTWFwcy5wcm90b3R5cGUuYWRkT3ZlcmxheU1hcFR5cGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoImdldFRpbGUiKSAmJiB0eXBlb2Yob3B0aW9uc1siZ2V0VGlsZSJdKSA9PSAiZnVuY3Rpb24iKSB7CiAgICB2YXIgb3ZlcmxheU1hcFR5cGVJbmRleCA9IG9wdGlvbnMuaW5kZXg7CgogICAgZGVsZXRlIG9wdGlvbnMuaW5kZXg7CgogICAgdGhpcy5tYXAub3ZlcmxheU1hcFR5cGVzLmluc2VydEF0KG92ZXJsYXlNYXBUeXBlSW5kZXgsIG9wdGlvbnMpOwogIH0KICBlbHNlIHsKICAgIHRocm93ICInZ2V0VGlsZScgZnVuY3Rpb24gcmVxdWlyZWQuIjsKICB9Cn07CgpHTWFwcy5wcm90b3R5cGUucmVtb3ZlT3ZlcmxheU1hcFR5cGUgPSBmdW5jdGlvbihvdmVybGF5TWFwVHlwZUluZGV4KSB7CiAgdGhpcy5tYXAub3ZlcmxheU1hcFR5cGVzLnJlbW92ZUF0KG92ZXJsYXlNYXBUeXBlSW5kZXgpOwp9OwoKR01hcHMucHJvdG90eXBlLmFkZFN0eWxlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBzdHlsZWRNYXBUeXBlID0gbmV3IGdvb2dsZS5tYXBzLlN0eWxlZE1hcFR5cGUob3B0aW9ucy5zdHlsZXMsIHsgbmFtZTogb3B0aW9ucy5zdHlsZWRNYXBOYW1lIH0pOwoKICB0aGlzLm1hcC5tYXBUeXBlcy5zZXQob3B0aW9ucy5tYXBUeXBlSWQsIHN0eWxlZE1hcFR5cGUpOwp9OwoKR01hcHMucHJvdG90eXBlLnNldFN0eWxlID0gZnVuY3Rpb24obWFwVHlwZUlkKSB7CiAgdGhpcy5tYXAuc2V0TWFwVHlwZUlkKG1hcFR5cGVJZCk7Cn07CgpHTWFwcy5wcm90b3R5cGUuY3JlYXRlUGFub3JhbWEgPSBmdW5jdGlvbihzdHJlZXR2aWV3X29wdGlvbnMpIHsKICBpZiAoIXN0cmVldHZpZXdfb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbGF0JykgfHwgIXN0cmVldHZpZXdfb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbG5nJykpIHsKICAgIHN0cmVldHZpZXdfb3B0aW9ucy5sYXQgPSB0aGlzLmdldENlbnRlcigpLmxhdCgpOwogICAgc3RyZWV0dmlld19vcHRpb25zLmxuZyA9IHRoaXMuZ2V0Q2VudGVyKCkubG5nKCk7CiAgfQoKICB0aGlzLnBhbm9yYW1hID0gR01hcHMuY3JlYXRlUGFub3JhbWEoc3RyZWV0dmlld19vcHRpb25zKTsKCiAgdGhpcy5tYXAuc2V0U3RyZWV0Vmlldyh0aGlzLnBhbm9yYW1hKTsKCiAgcmV0dXJuIHRoaXMucGFub3JhbWE7Cn07CgpHTWFwcy5jcmVhdGVQYW5vcmFtYSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgZWwgPSBnZXRFbGVtZW50QnlJZChvcHRpb25zLmVsLCBvcHRpb25zLmNvbnRleHQpOwoKICBvcHRpb25zLnBvc2l0aW9uID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhvcHRpb25zLmxhdCwgb3B0aW9ucy5sbmcpOwoKICBkZWxldGUgb3B0aW9ucy5lbDsKICBkZWxldGUgb3B0aW9ucy5jb250ZXh0OwogIGRlbGV0ZSBvcHRpb25zLmxhdDsKICBkZWxldGUgb3B0aW9ucy5sbmc7CgogIHZhciBzdHJlZXR2aWV3X2V2ZW50cyA9IFsnY2xvc2VjbGljaycsICdsaW5rc19jaGFuZ2VkJywgJ3Bhbm9fY2hhbmdlZCcsICdwb3NpdGlvbl9jaGFuZ2VkJywgJ3Bvdl9jaGFuZ2VkJywgJ3Jlc2l6ZScsICd2aXNpYmxlX2NoYW5nZWQnXSwKICAgICAgc3RyZWV0dmlld19vcHRpb25zID0gZXh0ZW5kX29iamVjdCh7dmlzaWJsZSA6IHRydWV9LCBvcHRpb25zKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHJlZXR2aWV3X2V2ZW50cy5sZW5ndGg7IGkrKykgewogICAgZGVsZXRlIHN0cmVldHZpZXdfb3B0aW9uc1tzdHJlZXR2aWV3X2V2ZW50c1tpXV07CiAgfQoKICB2YXIgcGFub3JhbWEgPSBuZXcgZ29vZ2xlLm1hcHMuU3RyZWV0Vmlld1Bhbm9yYW1hKGVsLCBzdHJlZXR2aWV3X29wdGlvbnMpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHN0cmVldHZpZXdfZXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGlmIChvcHRpb25zW25hbWVdKSB7CiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIob2JqZWN0LCBuYW1lLCBmdW5jdGlvbigpewogICAgICAgICAgb3B0aW9uc1tuYW1lXS5hcHBseSh0aGlzKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSkocGFub3JhbWEsIHN0cmVldHZpZXdfZXZlbnRzW2ldKTsKICB9CgogIHJldHVybiBwYW5vcmFtYTsKfTsKCkdNYXBzLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uKGV2ZW50X25hbWUsIGhhbmRsZXIpIHsKICByZXR1cm4gR01hcHMub24oZXZlbnRfbmFtZSwgdGhpcywgaGFuZGxlcik7Cn07CgpHTWFwcy5wcm90b3R5cGUub2ZmID0gZnVuY3Rpb24oZXZlbnRfbmFtZSkgewogIEdNYXBzLm9mZihldmVudF9uYW1lLCB0aGlzKTsKfTsKCkdNYXBzLmN1c3RvbV9ldmVudHMgPSBbJ21hcmtlcl9hZGRlZCcsICdtYXJrZXJfcmVtb3ZlZCcsICdwb2x5bGluZV9hZGRlZCcsICdwb2x5bGluZV9yZW1vdmVkJywgJ3BvbHlnb25fYWRkZWQnLCAncG9seWdvbl9yZW1vdmVkJywgJ2dlb2xvY2F0ZWQnLCAnZ2VvbG9jYXRpb25fZmFpbGVkJ107CgpHTWFwcy5vbiA9IGZ1bmN0aW9uKGV2ZW50X25hbWUsIG9iamVjdCwgaGFuZGxlcikgewogIGlmIChHTWFwcy5jdXN0b21fZXZlbnRzLmluZGV4T2YoZXZlbnRfbmFtZSkgPT0gLTEpIHsKICAgIGlmKG9iamVjdCBpbnN0YW5jZW9mIEdNYXBzKSBvYmplY3QgPSBvYmplY3QubWFwOyAKICAgIHJldHVybiBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIGV2ZW50X25hbWUsIGhhbmRsZXIpOwogIH0KICBlbHNlIHsKICAgIHZhciByZWdpc3RlcmVkX2V2ZW50ID0gewogICAgICBoYW5kbGVyIDogaGFuZGxlciwKICAgICAgZXZlbnROYW1lIDogZXZlbnRfbmFtZQogICAgfTsKCiAgICBvYmplY3QucmVnaXN0ZXJlZF9ldmVudHNbZXZlbnRfbmFtZV0gPSBvYmplY3QucmVnaXN0ZXJlZF9ldmVudHNbZXZlbnRfbmFtZV0gfHwgW107CiAgICBvYmplY3QucmVnaXN0ZXJlZF9ldmVudHNbZXZlbnRfbmFtZV0ucHVzaChyZWdpc3RlcmVkX2V2ZW50KTsKCiAgICByZXR1cm4gcmVnaXN0ZXJlZF9ldmVudDsKICB9Cn07CgpHTWFwcy5vZmYgPSBmdW5jdGlvbihldmVudF9uYW1lLCBvYmplY3QpIHsKICBpZiAoR01hcHMuY3VzdG9tX2V2ZW50cy5pbmRleE9mKGV2ZW50X25hbWUpID09IC0xKSB7CiAgICBpZihvYmplY3QgaW5zdGFuY2VvZiBHTWFwcykgb2JqZWN0ID0gb2JqZWN0Lm1hcDsgCiAgICBnb29nbGUubWFwcy5ldmVudC5jbGVhckxpc3RlbmVycyhvYmplY3QsIGV2ZW50X25hbWUpOwogIH0KICBlbHNlIHsKICAgIG9iamVjdC5yZWdpc3RlcmVkX2V2ZW50c1tldmVudF9uYW1lXSA9IFtdOwogIH0KfTsKCkdNYXBzLmZpcmUgPSBmdW5jdGlvbihldmVudF9uYW1lLCBvYmplY3QsIHNjb3BlKSB7CiAgaWYgKEdNYXBzLmN1c3RvbV9ldmVudHMuaW5kZXhPZihldmVudF9uYW1lKSA9PSAtMSkgewogICAgZ29vZ2xlLm1hcHMuZXZlbnQudHJpZ2dlcihvYmplY3QsIGV2ZW50X25hbWUsIEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpLnNsaWNlKDIpKTsKICB9CiAgZWxzZSB7CiAgICBpZihldmVudF9uYW1lIGluIHNjb3BlLnJlZ2lzdGVyZWRfZXZlbnRzKSB7CiAgICAgIHZhciBmaXJpbmdfZXZlbnRzID0gc2NvcGUucmVnaXN0ZXJlZF9ldmVudHNbZXZlbnRfbmFtZV07CgogICAgICBmb3IodmFyIGkgPSAwOyBpIDwgZmlyaW5nX2V2ZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIChmdW5jdGlvbihoYW5kbGVyLCBzY29wZSwgb2JqZWN0KSB7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KHNjb3BlLCBbb2JqZWN0XSk7CiAgICAgICAgfSkoZmlyaW5nX2V2ZW50c1tpXVsnaGFuZGxlciddLCBzY29wZSwgb2JqZWN0KTsKICAgICAgfQogICAgfQogIH0KfTsKCkdNYXBzLmdlb2xvY2F0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgY29tcGxldGVfY2FsbGJhY2sgPSBvcHRpb25zLmFsd2F5cyB8fCBvcHRpb25zLmNvbXBsZXRlOwoKICBpZiAobmF2aWdhdG9yLmdlb2xvY2F0aW9uKSB7CiAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICAgIG9wdGlvbnMuc3VjY2Vzcyhwb3NpdGlvbik7CgogICAgICBpZiAoY29tcGxldGVfY2FsbGJhY2spIHsKICAgICAgICBjb21wbGV0ZV9jYWxsYmFjaygpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICBvcHRpb25zLmVycm9yKGVycm9yKTsKCiAgICAgIGlmIChjb21wbGV0ZV9jYWxsYmFjaykgewogICAgICAgIGNvbXBsZXRlX2NhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0sIG9wdGlvbnMub3B0aW9ucyk7CiAgfQogIGVsc2UgewogICAgb3B0aW9ucy5ub3Rfc3VwcG9ydGVkKCk7CgogICAgaWYgKGNvbXBsZXRlX2NhbGxiYWNrKSB7CiAgICAgIGNvbXBsZXRlX2NhbGxiYWNrKCk7CiAgICB9CiAgfQp9OwoKR01hcHMuZ2VvY29kZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB0aGlzLmdlb2NvZGVyID0gbmV3IGdvb2dsZS5tYXBzLkdlb2NvZGVyKCk7CiAgdmFyIGNhbGxiYWNrID0gb3B0aW9ucy5jYWxsYmFjazsKICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbGF0JykgJiYgb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbG5nJykpIHsKICAgIG9wdGlvbnMubGF0TG5nID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhvcHRpb25zLmxhdCwgb3B0aW9ucy5sbmcpOwogIH0KCiAgZGVsZXRlIG9wdGlvbnMubGF0OwogIGRlbGV0ZSBvcHRpb25zLmxuZzsKICBkZWxldGUgb3B0aW9ucy5jYWxsYmFjazsKICAKICB0aGlzLmdlb2NvZGVyLmdlb2NvZGUob3B0aW9ucywgZnVuY3Rpb24ocmVzdWx0cywgc3RhdHVzKSB7CiAgICBjYWxsYmFjayhyZXN1bHRzLCBzdGF0dXMpOwogIH0pOwp9OwoKLy89PT09PT09PT09PT09PT09PT09PT09PT09PQovLyBQb2x5Z29uIGNvbnRhaW5zTGF0TG5nCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS90cGFya2luL0dvb2dsZS1NYXBzLVBvaW50LWluLVBvbHlnb24KLy8gUG95Z29uIGdldEJvdW5kcyBleHRlbnNpb24gLSBnb29nbGUtbWFwcy1leHRlbnNpb25zCi8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9nb29nbGUtbWFwcy1leHRlbnNpb25zL3NvdXJjZS9icm93c2UvZ29vZ2xlLm1hcHMuUG9seWdvbi5nZXRCb3VuZHMuanMKaWYgKCFnb29nbGUubWFwcy5Qb2x5Z29uLnByb3RvdHlwZS5nZXRCb3VuZHMpIHsKICBnb29nbGUubWFwcy5Qb2x5Z29uLnByb3RvdHlwZS5nZXRCb3VuZHMgPSBmdW5jdGlvbihsYXRMbmcpIHsKICAgIHZhciBib3VuZHMgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nQm91bmRzKCk7CiAgICB2YXIgcGF0aHMgPSB0aGlzLmdldFBhdGhzKCk7CiAgICB2YXIgcGF0aDsKCiAgICBmb3IgKHZhciBwID0gMDsgcCA8IHBhdGhzLmdldExlbmd0aCgpOyBwKyspIHsKICAgICAgcGF0aCA9IHBhdGhzLmdldEF0KHApOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGguZ2V0TGVuZ3RoKCk7IGkrKykgewogICAgICAgIGJvdW5kcy5leHRlbmQocGF0aC5nZXRBdChpKSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYm91bmRzOwogIH07Cn0KCmlmICghZ29vZ2xlLm1hcHMuUG9seWdvbi5wcm90b3R5cGUuY29udGFpbnNMYXRMbmcpIHsKICAvLyBQb2x5Z29uIGNvbnRhaW5zTGF0TG5nIC0gbWV0aG9kIHRvIGRldGVybWluZSBpZiBhIGxhdExuZyBpcyB3aXRoaW4gYSBwb2x5Z29uCiAgZ29vZ2xlLm1hcHMuUG9seWdvbi5wcm90b3R5cGUuY29udGFpbnNMYXRMbmcgPSBmdW5jdGlvbihsYXRMbmcpIHsKICAgIC8vIEV4Y2x1ZGUgcG9pbnRzIG91dHNpZGUgb2YgYm91bmRzIGFzIHRoZXJlIGlzIG5vIHdheSB0aGV5IGFyZSBpbiB0aGUgcG9seQogICAgdmFyIGJvdW5kcyA9IHRoaXMuZ2V0Qm91bmRzKCk7CgogICAgaWYgKGJvdW5kcyAhPT0gbnVsbCAmJiAhYm91bmRzLmNvbnRhaW5zKGxhdExuZykpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIFJheWNhc3QgcG9pbnQgaW4gcG9seWdvbiBtZXRob2QKICAgIHZhciBpblBvbHkgPSBmYWxzZTsKCiAgICB2YXIgbnVtUGF0aHMgPSB0aGlzLmdldFBhdGhzKCkuZ2V0TGVuZ3RoKCk7CiAgICBmb3IgKHZhciBwID0gMDsgcCA8IG51bVBhdGhzOyBwKyspIHsKICAgICAgdmFyIHBhdGggPSB0aGlzLmdldFBhdGhzKCkuZ2V0QXQocCk7CiAgICAgIHZhciBudW1Qb2ludHMgPSBwYXRoLmdldExlbmd0aCgpOwogICAgICB2YXIgaiA9IG51bVBvaW50cyAtIDE7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgICAgdmFyIHZlcnRleDEgPSBwYXRoLmdldEF0KGkpOwogICAgICAgIHZhciB2ZXJ0ZXgyID0gcGF0aC5nZXRBdChqKTsKCiAgICAgICAgaWYgKHZlcnRleDEubG5nKCkgPCBsYXRMbmcubG5nKCkgJiYgdmVydGV4Mi5sbmcoKSA+PSBsYXRMbmcubG5nKCkgfHwgdmVydGV4Mi5sbmcoKSA8IGxhdExuZy5sbmcoKSAmJiB2ZXJ0ZXgxLmxuZygpID49IGxhdExuZy5sbmcoKSkgewogICAgICAgICAgaWYgKHZlcnRleDEubGF0KCkgKyAobGF0TG5nLmxuZygpIC0gdmVydGV4MS5sbmcoKSkgLyAodmVydGV4Mi5sbmcoKSAtIHZlcnRleDEubG5nKCkpICogKHZlcnRleDIubGF0KCkgLSB2ZXJ0ZXgxLmxhdCgpKSA8IGxhdExuZy5sYXQoKSkgewogICAgICAgICAgICBpblBvbHkgPSAhaW5Qb2x5OwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaiA9IGk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gaW5Qb2x5OwogIH07Cn0KCmlmICghZ29vZ2xlLm1hcHMuQ2lyY2xlLnByb3RvdHlwZS5jb250YWluc0xhdExuZykgewogIGdvb2dsZS5tYXBzLkNpcmNsZS5wcm90b3R5cGUuY29udGFpbnNMYXRMbmcgPSBmdW5jdGlvbihsYXRMbmcpIHsKICAgIGlmIChnb29nbGUubWFwcy5nZW9tZXRyeSkgewogICAgICByZXR1cm4gZ29vZ2xlLm1hcHMuZ2VvbWV0cnkuc3BoZXJpY2FsLmNvbXB1dGVEaXN0YW5jZUJldHdlZW4odGhpcy5nZXRDZW50ZXIoKSwgbGF0TG5nKSA8PSB0aGlzLmdldFJhZGl1cygpOwogICAgfQogICAgZWxzZSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH07Cn0KCmdvb2dsZS5tYXBzLkxhdExuZ0JvdW5kcy5wcm90b3R5cGUuY29udGFpbnNMYXRMbmcgPSBmdW5jdGlvbihsYXRMbmcpIHsKICByZXR1cm4gdGhpcy5jb250YWlucyhsYXRMbmcpOwp9OwoKZ29vZ2xlLm1hcHMuTWFya2VyLnByb3RvdHlwZS5zZXRGZW5jZXMgPSBmdW5jdGlvbihmZW5jZXMpIHsKICB0aGlzLmZlbmNlcyA9IGZlbmNlczsKfTsKCmdvb2dsZS5tYXBzLk1hcmtlci5wcm90b3R5cGUuYWRkRmVuY2UgPSBmdW5jdGlvbihmZW5jZSkgewogIHRoaXMuZmVuY2VzLnB1c2goZmVuY2UpOwp9OwoKZ29vZ2xlLm1hcHMuTWFya2VyLnByb3RvdHlwZS5nZXRJZCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzWydfX2dtX2lkJ107Cn07CgovLz09PT09PT09PT09PT09PT09PT09PT09PT09Ci8vIEFycmF5IGluZGV4T2YKLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9KYXZhU2NyaXB0L1JlZmVyZW5jZS9HbG9iYWxfT2JqZWN0cy9BcnJheS9pbmRleE9mCmlmICghQXJyYXkucHJvdG90eXBlLmluZGV4T2YpIHsKICBBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uIChzZWFyY2hFbGVtZW50IC8qLCBmcm9tSW5kZXggKi8gKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgaWYgKHRoaXMgPT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgICB9CiAgICAgIHZhciB0ID0gT2JqZWN0KHRoaXMpOwogICAgICB2YXIgbGVuID0gdC5sZW5ndGggPj4+IDA7CiAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgICB2YXIgbiA9IDA7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgICAgbiA9IE51bWJlcihhcmd1bWVudHNbMV0pOwogICAgICAgICAgaWYgKG4gIT0gbikgeyAvLyBzaG9ydGN1dCBmb3IgdmVyaWZ5aW5nIGlmIGl0J3MgTmFOCiAgICAgICAgICAgICAgbiA9IDA7CiAgICAgICAgICB9IGVsc2UgaWYgKG4gIT0gMCAmJiBuICE9IEluZmluaXR5ICYmIG4gIT0gLUluZmluaXR5KSB7CiAgICAgICAgICAgICAgbiA9IChuID4gMCB8fCAtMSkgKiBNYXRoLmZsb29yKE1hdGguYWJzKG4pKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAobiA+PSBsZW4pIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgICB2YXIgayA9IG4gPj0gMCA\/IG4gOiBNYXRoLm1heChsZW4gLSBNYXRoLmFicyhuKSwgMCk7CiAgICAgIGZvciAoOyBrIDwgbGVuOyBrKyspIHsKICAgICAgICAgIGlmIChrIGluIHQgJiYgdFtrXSA9PT0gc2VhcmNoRWxlbWVudCkgewogICAgICAgICAgICAgIHJldHVybiBrOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICB9Cn0KICAKcmV0dXJuIEdNYXBzOwp9KSk7",
    "size": "57513"
}