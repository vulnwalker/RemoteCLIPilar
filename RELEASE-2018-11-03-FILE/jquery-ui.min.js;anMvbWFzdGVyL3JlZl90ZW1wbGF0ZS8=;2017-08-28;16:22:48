{
    "namaFile": "js\/master\/ref_template\/jquery-ui.min.js",
    "lastUpdate": "2017-08-28+16:22:48.73",
    "contentFile": "CS8qISBqUXVlcnkgVUkgLSB2MS4xMi4xIC0gMjAxNi0wOS0xNA0KKiBodHRwOi8vanF1ZXJ5dWkuY29tDQoqIEluY2x1ZGVzOiB3aWRnZXQuanMsIHBvc2l0aW9uLmpzLCBkYXRhLmpzLCBkaXNhYmxlLXNlbGVjdGlvbi5qcywgZWZmZWN0LmpzLCBlZmZlY3RzL2VmZmVjdC1ibGluZC5qcywgZWZmZWN0cy9lZmZlY3QtYm91bmNlLmpzLCBlZmZlY3RzL2VmZmVjdC1jbGlwLmpzLCBlZmZlY3RzL2VmZmVjdC1kcm9wLmpzLCBlZmZlY3RzL2VmZmVjdC1leHBsb2RlLmpzLCBlZmZlY3RzL2VmZmVjdC1mYWRlLmpzLCBlZmZlY3RzL2VmZmVjdC1mb2xkLmpzLCBlZmZlY3RzL2VmZmVjdC1oaWdobGlnaHQuanMsIGVmZmVjdHMvZWZmZWN0LXB1ZmYuanMsIGVmZmVjdHMvZWZmZWN0LXB1bHNhdGUuanMsIGVmZmVjdHMvZWZmZWN0LXNjYWxlLmpzLCBlZmZlY3RzL2VmZmVjdC1zaGFrZS5qcywgZWZmZWN0cy9lZmZlY3Qtc2l6ZS5qcywgZWZmZWN0cy9lZmZlY3Qtc2xpZGUuanMsIGVmZmVjdHMvZWZmZWN0LXRyYW5zZmVyLmpzLCBmb2N1c2FibGUuanMsIGZvcm0tcmVzZXQtbWl4aW4uanMsIGpxdWVyeS0xLTcuanMsIGtleWNvZGUuanMsIGxhYmVscy5qcywgc2Nyb2xsLXBhcmVudC5qcywgdGFiYmFibGUuanMsIHVuaXF1ZS1pZC5qcywgd2lkZ2V0cy9hY2NvcmRpb24uanMsIHdpZGdldHMvYXV0b2NvbXBsZXRlLmpzLCB3aWRnZXRzL2J1dHRvbi5qcywgd2lkZ2V0cy9jaGVja2JveHJhZGlvLmpzLCB3aWRnZXRzL2NvbnRyb2xncm91cC5qcywgd2lkZ2V0cy9kYXRlcGlja2VyLmpzLCB3aWRnZXRzL2RpYWxvZy5qcywgd2lkZ2V0cy9kcmFnZ2FibGUuanMsIHdpZGdldHMvZHJvcHBhYmxlLmpzLCB3aWRnZXRzL21lbnUuanMsIHdpZGdldHMvbW91c2UuanMsIHdpZGdldHMvcHJvZ3Jlc3NiYXIuanMsIHdpZGdldHMvcmVzaXphYmxlLmpzLCB3aWRnZXRzL3NlbGVjdGFibGUuanMsIHdpZGdldHMvc2VsZWN0bWVudS5qcywgd2lkZ2V0cy9zbGlkZXIuanMsIHdpZGdldHMvc29ydGFibGUuanMsIHdpZGdldHMvc3Bpbm5lci5qcywgd2lkZ2V0cy90YWJzLmpzLCB3aWRnZXRzL3Rvb2x0aXAuanMNCiogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnM7IExpY2Vuc2VkIE1JVCAqLw0KDQooZnVuY3Rpb24oIGZhY3RvcnkgKSB7DQoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7DQoNCgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLg0KCQlkZWZpbmUoWyAianF1ZXJ5IiBdLCBmYWN0b3J5ICk7DQoJfSBlbHNlIHsNCg0KCQkvLyBCcm93c2VyIGdsb2JhbHMNCgkJZmFjdG9yeSggalF1ZXJ5ICk7DQoJfQ0KfShmdW5jdGlvbiggJCApIHsNCg0KJC51aSA9ICQudWkgfHwge307DQoNCnZhciB2ZXJzaW9uID0gJC51aS52ZXJzaW9uID0gIjEuMTIuMSI7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgV2lkZ2V0IDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBXaWRnZXQNCi8vPj5ncm91cDogQ29yZQ0KLy8+PmRlc2NyaXB0aW9uOiBQcm92aWRlcyBhIGZhY3RvcnkgZm9yIGNyZWF0aW5nIHN0YXRlZnVsIHdpZGdldHMgd2l0aCBhIGNvbW1vbiBBUEkuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LndpZGdldC8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS93aWRnZXQvDQoNCg0KDQp2YXIgd2lkZ2V0VXVpZCA9IDA7DQp2YXIgd2lkZ2V0U2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7DQoNCiQuY2xlYW5EYXRhID0gKCBmdW5jdGlvbiggb3JpZyApIHsNCglyZXR1cm4gZnVuY3Rpb24oIGVsZW1zICkgew0KCQl2YXIgZXZlbnRzLCBlbGVtLCBpOw0KCQlmb3IgKCBpID0gMDsgKCBlbGVtID0gZWxlbXNbIGkgXSApICE9IG51bGw7IGkrKyApIHsNCgkJCXRyeSB7DQoNCgkJCQkvLyBPbmx5IHRyaWdnZXIgcmVtb3ZlIHdoZW4gbmVjZXNzYXJ5IHRvIHNhdmUgdGltZQ0KCQkJCWV2ZW50cyA9ICQuX2RhdGEoIGVsZW0sICJldmVudHMiICk7DQoJCQkJaWYgKCBldmVudHMgJiYgZXZlbnRzLnJlbW92ZSApIHsNCgkJCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOw0KCQkJCX0NCg0KCQkJLy8gSHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQ0KCQkJfSBjYXRjaCAoIGUgKSB7fQ0KCQl9DQoJCW9yaWcoIGVsZW1zICk7DQoJfTsNCn0gKSggJC5jbGVhbkRhdGEgKTsNCg0KJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgew0KCXZhciBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZTsNCg0KCS8vIFByb3hpZWRQcm90b3R5cGUgYWxsb3dzIHRoZSBwcm92aWRlZCBwcm90b3R5cGUgdG8gcmVtYWluIHVubW9kaWZpZWQNCgkvLyBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIGFzIGEgbWl4aW4gZm9yIG11bHRpcGxlIHdpZGdldHMgKCM4ODc2KQ0KCXZhciBwcm94aWVkUHJvdG90eXBlID0ge307DQoNCgl2YXIgbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsNCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsNCgl2YXIgZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOw0KDQoJaWYgKCAhcHJvdG90eXBlICkgew0KCQlwcm90b3R5cGUgPSBiYXNlOw0KCQliYXNlID0gJC5XaWRnZXQ7DQoJfQ0KDQoJaWYgKCAkLmlzQXJyYXkoIHByb3RvdHlwZSApICkgew0KCQlwcm90b3R5cGUgPSAkLmV4dGVuZC5hcHBseSggbnVsbCwgWyB7fSBdLmNvbmNhdCggcHJvdG90eXBlICkgKTsNCgl9DQoNCgkvLyBDcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbg0KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgew0KCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7DQoJfTsNCg0KCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307DQoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07DQoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7DQoNCgkJLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQNCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgew0KCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOw0KCQl9DQoNCgkJLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlDQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgew0KCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7DQoJCX0NCgl9Ow0KDQoJLy8gRXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzDQoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7DQoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLA0KDQoJCS8vIENvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bw0KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyDQoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwNCg0KCQkvLyBUcmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMNCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQNCgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQ0KCX0gKTsNCg0KCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOw0KDQoJLy8gV2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlDQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQ0KCS8vIGluaGVyaXRpbmcgZnJvbQ0KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOw0KCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7DQoJCWlmICggISQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsNCgkJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9IHZhbHVlOw0KCQkJcmV0dXJuOw0KCQl9DQoJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9ICggZnVuY3Rpb24oKSB7DQoJCQlmdW5jdGlvbiBfc3VwZXIoKSB7DQoJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJfQ0KDQoJCQlmdW5jdGlvbiBfc3VwZXJBcHBseSggYXJncyApIHsNCgkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOw0KCQkJfQ0KDQoJCQlyZXR1cm4gZnVuY3Rpb24oKSB7DQoJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlcjsNCgkJCQl2YXIgX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseTsNCgkJCQl2YXIgcmV0dXJuVmFsdWU7DQoNCgkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsNCgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7DQoNCgkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCg0KCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsNCgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5Ow0KDQoJCQkJcmV0dXJuIHJldHVyblZhbHVlOw0KCQkJfTsNCgkJfSApKCk7DQoJfSApOw0KCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgew0KDQoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeA0KCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQNCgkJLy8gZG9uJ3QgcHJlZml4IGZvciB3aWRnZXRzIHRoYXQgYXJlbid0IERPTS1iYXNlZA0KCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA\/ICggYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCB8fCBuYW1lICkgOiBuYW1lDQoJfSwgcHJveGllZFByb3RvdHlwZSwgew0KCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsDQoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLA0KCQl3aWRnZXROYW1lOiBuYW1lLA0KCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUNCgl9ICk7DQoNCgkvLyBJZiB0aGlzIHdpZGdldCBpcyBiZWluZyByZWRlZmluZWQgdGhlbiB3ZSBuZWVkIHRvIGZpbmQgYWxsIHdpZGdldHMgdGhhdA0KCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20NCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQ0KCS8vIGxldmVsIGluIHRoZSBwcm90b3R5cGUgY2hhaW4uDQoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgew0KCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7DQoJCQl2YXIgY2hpbGRQcm90b3R5cGUgPSBjaGlsZC5wcm90b3R5cGU7DQoNCgkJCS8vIFJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzDQoJCQkvLyBvcmlnaW5hbGx5IHVzZWQsIGJ1dCBpbmhlcml0IGZyb20gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZSBiYXNlDQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsDQoJCQkJY2hpbGQuX3Byb3RvICk7DQoJCX0gKTsNCg0KCQkvLyBSZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3Rvcg0KCQkvLyBzbyB0aGUgb2xkIGNoaWxkIGNvbnN0cnVjdG9ycyBjYW4gYmUgZ2FyYmFnZSBjb2xsZWN0ZWQNCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOw0KCX0gZWxzZSB7DQoJCWJhc2UuX2NoaWxkQ29uc3RydWN0b3JzLnB1c2goIGNvbnN0cnVjdG9yICk7DQoJfQ0KDQoJJC53aWRnZXQuYnJpZGdlKCBuYW1lLCBjb25zdHJ1Y3RvciApOw0KDQoJcmV0dXJuIGNvbnN0cnVjdG9yOw0KfTsNCg0KJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsNCgl2YXIgaW5wdXQgPSB3aWRnZXRTbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsNCgl2YXIgaW5wdXRJbmRleCA9IDA7DQoJdmFyIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoOw0KCXZhciBrZXk7DQoJdmFyIHZhbHVlOw0KDQoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsNCgkJZm9yICgga2V5IGluIGlucHV0WyBpbnB1dEluZGV4IF0gKSB7DQoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOw0KCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgew0KDQoJCQkJLy8gQ2xvbmUgb2JqZWN0cw0KCQkJCWlmICggJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApICkgew0KCQkJCQl0YXJnZXRbIGtleSBdID0gJC5pc1BsYWluT2JqZWN0KCB0YXJnZXRbIGtleSBdICkgPw0KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6DQoNCgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzDQoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOw0KDQoJCQkJLy8gQ29weSBldmVyeXRoaW5nIGVsc2UgYnkgcmVmZXJlbmNlDQoJCQkJfSBlbHNlIHsNCgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOw0KCQkJCX0NCgkJCX0NCgkJfQ0KCX0NCglyZXR1cm4gdGFyZ2V0Ow0KfTsNCg0KJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsNCgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7DQoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyI7DQoJCXZhciBhcmdzID0gd2lkZ2V0U2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICk7DQoJCXZhciByZXR1cm5WYWx1ZSA9IHRoaXM7DQoNCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7DQoNCgkJCS8vIElmIHRoaXMgaXMgYW4gZW1wdHkgY29sbGVjdGlvbiwgd2UgbmVlZCB0byBoYXZlIHRoZSBpbnN0YW5jZSBtZXRob2QNCgkJCS8vIHJldHVybiB1bmRlZmluZWQgaW5zdGVhZCBvZiB0aGUgalF1ZXJ5IGluc3RhbmNlDQoJCQlpZiAoICF0aGlzLmxlbmd0aCAmJiBvcHRpb25zID09PSAiaW5zdGFuY2UiICkgew0KCQkJCXJldHVyblZhbHVlID0gdW5kZWZpbmVkOw0KCQkJfSBlbHNlIHsNCgkJCQl0aGlzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCQl2YXIgbWV0aG9kVmFsdWU7DQoJCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsNCg0KCQkJCQlpZiAoIG9wdGlvbnMgPT09ICJpbnN0YW5jZSIgKSB7DQoJCQkJCQlyZXR1cm5WYWx1ZSA9IGluc3RhbmNlOw0KCQkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCQl9DQoNCgkJCQkJaWYgKCAhaW5zdGFuY2UgKSB7DQoJCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKw0KCQkJCQkJCSIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKw0KCQkJCQkJCSJhdHRlbXB0ZWQgdG8gY2FsbCBtZXRob2QgJyIgKyBvcHRpb25zICsgIiciICk7DQoJCQkJCX0NCg0KCQkJCQlpZiAoICEkLmlzRnVuY3Rpb24oIGluc3RhbmNlWyBvcHRpb25zIF0gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7DQoJCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArDQoJCQkJCQkJIiB3aWRnZXQgaW5zdGFuY2UiICk7DQoJCQkJCX0NCg0KCQkJCQltZXRob2RWYWx1ZSA9IGluc3RhbmNlWyBvcHRpb25zIF0uYXBwbHkoIGluc3RhbmNlLCBhcmdzICk7DQoNCgkJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsNCgkJCQkJCXJldHVyblZhbHVlID0gbWV0aG9kVmFsdWUgJiYgbWV0aG9kVmFsdWUuanF1ZXJ5ID8NCgkJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOg0KCQkJCQkJCW1ldGhvZFZhbHVlOw0KCQkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCQl9DQoJCQkJfSApOw0KCQkJfQ0KCQl9IGVsc2Ugew0KDQoJCQkvLyBBbGxvdyBtdWx0aXBsZSBoYXNoZXMgdG8gYmUgcGFzc2VkIG9uIGluaXQNCgkJCWlmICggYXJncy5sZW5ndGggKSB7DQoJCQkJb3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZC5hcHBseSggbnVsbCwgWyBvcHRpb25zIF0uY29uY2F0KCBhcmdzICkgKTsNCgkJCX0NCg0KCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7DQoJCQkJaWYgKCBpbnN0YW5jZSApIHsNCgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICk7DQoJCQkJCWlmICggaW5zdGFuY2UuX2luaXQgKSB7DQoJCQkJCQlpbnN0YW5jZS5faW5pdCgpOw0KCQkJCQl9DQoJCQkJfSBlbHNlIHsNCgkJCQkJJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7DQoJCQkJfQ0KCQkJfSApOw0KCQl9DQoNCgkJcmV0dXJuIHJldHVyblZhbHVlOw0KCX07DQp9Ow0KDQokLldpZGdldCA9IGZ1bmN0aW9uKCAvKiBvcHRpb25zLCBlbGVtZW50ICovICkge307DQokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsNCg0KJC5XaWRnZXQucHJvdG90eXBlID0gew0KCXdpZGdldE5hbWU6ICJ3aWRnZXQiLA0KCXdpZGdldEV2ZW50UHJlZml4OiAiIiwNCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwNCg0KCW9wdGlvbnM6IHsNCgkJY2xhc3Nlczoge30sDQoJCWRpc2FibGVkOiBmYWxzZSwNCg0KCQkvLyBDYWxsYmFja3MNCgkJY3JlYXRlOiBudWxsDQoJfSwNCg0KCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgew0KCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOw0KCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7DQoJCXRoaXMudXVpZCA9IHdpZGdldFV1aWQrKzsNCgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsNCg0KCQl0aGlzLmJpbmRpbmdzID0gJCgpOw0KCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsNCgkJdGhpcy5mb2N1c2FibGUgPSAkKCk7DQoJCXRoaXMuY2xhc3Nlc0VsZW1lbnRMb29rdXAgPSB7fTsNCg0KCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7DQoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsNCgkJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmVsZW1lbnQsIHsNCgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7DQoJCQkJCQl0aGlzLmRlc3Ryb3koKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0gKTsNCgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8NCg0KCQkJCS8vIEVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudA0KCQkJCWVsZW1lbnQub3duZXJEb2N1bWVudCA6DQoNCgkJCQkvLyBFbGVtZW50IGlzIHdpbmRvdyBvciBkb2N1bWVudA0KCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOw0KCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFsgMCBdLnBhcmVudFdpbmRvdyApOw0KCQl9DQoNCgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwNCgkJCXRoaXMub3B0aW9ucywNCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwNCgkJCW9wdGlvbnMgKTsNCg0KCQl0aGlzLl9jcmVhdGUoKTsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsNCgkJCXRoaXMuX3NldE9wdGlvbkRpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsNCgkJfQ0KDQoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOw0KCQl0aGlzLl9pbml0KCk7DQoJfSwNCg0KCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHt9Ow0KCX0sDQoNCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiAkLm5vb3AsDQoNCglfY3JlYXRlOiAkLm5vb3AsDQoNCglfaW5pdDogJC5ub29wLA0KDQoJZGVzdHJveTogZnVuY3Rpb24oKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCg0KCQl0aGlzLl9kZXN0cm95KCk7DQoJCSQuZWFjaCggdGhpcy5jbGFzc2VzRWxlbWVudExvb2t1cCwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCQl0aGF0Ll9yZW1vdmVDbGFzcyggdmFsdWUsIGtleSApOw0KCQl9ICk7DQoNCgkJLy8gV2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMA0KCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQ0KCQl0aGlzLmVsZW1lbnQNCgkJCS5vZmYoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQ0KCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKTsNCgkJdGhpcy53aWRnZXQoKQ0KCQkJLm9mZiggdGhpcy5ldmVudE5hbWVzcGFjZSApDQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7DQoNCgkJLy8gQ2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMNCgkJdGhpcy5iaW5kaW5ncy5vZmYoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsNCgl9LA0KDQoJX2Rlc3Ryb3k6ICQubm9vcCwNCg0KCXdpZGdldDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLmVsZW1lbnQ7DQoJfSwNCg0KCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCXZhciBvcHRpb25zID0ga2V5Ow0KCQl2YXIgcGFydHM7DQoJCXZhciBjdXJPcHRpb247DQoJCXZhciBpOw0KDQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsNCg0KCQkJLy8gRG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoDQoJCQlyZXR1cm4gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7DQoJCX0NCg0KCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgew0KDQoJCQkvLyBIYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0NCgkJCW9wdGlvbnMgPSB7fTsNCgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsNCgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7DQoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsNCgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsNCgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsNCgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsNCgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07DQoJCQkJfQ0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOw0KCQkJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMSApIHsNCgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA\/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOw0KCQkJCX0NCgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7DQoJCQl9IGVsc2Ugew0KCQkJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMSApIHsNCgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA\/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOw0KCQkJCX0NCgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOw0KCQkJfQ0KCQl9DQoNCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOw0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoJCXZhciBrZXk7DQoNCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7DQoJCQl0aGlzLl9zZXRPcHRpb24oIGtleSwgb3B0aW9uc1sga2V5IF0gKTsNCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsNCgkJaWYgKCBrZXkgPT09ICJjbGFzc2VzIiApIHsNCgkJCXRoaXMuX3NldE9wdGlvbkNsYXNzZXMoIHZhbHVlICk7DQoJCX0NCg0KCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7DQoNCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7DQoJCQl0aGlzLl9zZXRPcHRpb25EaXNhYmxlZCggdmFsdWUgKTsNCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCglfc2V0T3B0aW9uQ2xhc3NlczogZnVuY3Rpb24oIHZhbHVlICkgew0KCQl2YXIgY2xhc3NLZXksIGVsZW1lbnRzLCBjdXJyZW50RWxlbWVudHM7DQoNCgkJZm9yICggY2xhc3NLZXkgaW4gdmFsdWUgKSB7DQoJCQljdXJyZW50RWxlbWVudHMgPSB0aGlzLmNsYXNzZXNFbGVtZW50TG9va3VwWyBjbGFzc0tleSBdOw0KCQkJaWYgKCB2YWx1ZVsgY2xhc3NLZXkgXSA9PT0gdGhpcy5vcHRpb25zLmNsYXNzZXNbIGNsYXNzS2V5IF0gfHwNCgkJCQkJIWN1cnJlbnRFbGVtZW50cyB8fA0KCQkJCQkhY3VycmVudEVsZW1lbnRzLmxlbmd0aCApIHsNCgkJCQljb250aW51ZTsNCgkJCX0NCg0KCQkJLy8gV2UgYXJlIGRvaW5nIHRoaXMgdG8gY3JlYXRlIGEgbmV3IGpRdWVyeSBvYmplY3QgYmVjYXVzZSB0aGUgX3JlbW92ZUNsYXNzKCkgY2FsbA0KCQkJLy8gb24gdGhlIG5leHQgbGluZSBpcyBnb2luZyB0byBkZXN0cm95IHRoZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgZWxlbWVudHMgYmVpbmcNCgkJCS8vIHRyYWNrZWQuIFdlIG5lZWQgdG8gc2F2ZSBhIGNvcHkgb2YgdGhpcyBjb2xsZWN0aW9uIHNvIHRoYXQgd2UgY2FuIGFkZCB0aGUgbmV3IGNsYXNzZXMNCgkJCS8vIGJlbG93Lg0KCQkJZWxlbWVudHMgPSAkKCBjdXJyZW50RWxlbWVudHMuZ2V0KCkgKTsNCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBjdXJyZW50RWxlbWVudHMsIGNsYXNzS2V5ICk7DQoNCgkJCS8vIFdlIGRvbid0IHVzZSBfYWRkQ2xhc3MoKSBoZXJlLCBiZWNhdXNlIHRoYXQgdXNlcyB0aGlzLm9wdGlvbnMuY2xhc3Nlcw0KCQkJLy8gZm9yIGdlbmVyYXRpbmcgdGhlIHN0cmluZyBvZiBjbGFzc2VzLiBXZSB3YW50IHRvIHVzZSB0aGUgdmFsdWUgcGFzc2VkIGluIGZyb20NCgkJCS8vIF9zZXRPcHRpb24oKSwgdGhpcyBpcyB0aGUgbmV3IHZhbHVlIG9mIHRoZSBjbGFzc2VzIG9wdGlvbiB3aGljaCB3YXMgcGFzc2VkIHRvDQoJCQkvLyBfc2V0T3B0aW9uKCkuIFdlIHBhc3MgdGhpcyB2YWx1ZSBkaXJlY3RseSB0byBfY2xhc3NlcygpLg0KCQkJZWxlbWVudHMuYWRkQ2xhc3MoIHRoaXMuX2NsYXNzZXMoIHsNCgkJCQllbGVtZW50OiBlbGVtZW50cywNCgkJCQlrZXlzOiBjbGFzc0tleSwNCgkJCQljbGFzc2VzOiB2YWx1ZSwNCgkJCQlhZGQ6IHRydWUNCgkJCX0gKSApOw0KCQl9DQoJfSwNCg0KCV9zZXRPcHRpb25EaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgew0KCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy53aWRnZXQoKSwgdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQiLCBudWxsLCAhIXZhbHVlICk7DQoNCgkJLy8gSWYgdGhlIHdpZGdldCBpcyBiZWNvbWluZyBkaXNhYmxlZCwgdGhlbiBub3RoaW5nIGlzIGludGVyYWN0aXZlDQoJCWlmICggdmFsdWUgKSB7DQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5ob3ZlcmFibGUsIG51bGwsICJ1aS1zdGF0ZS1ob3ZlciIgKTsNCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmZvY3VzYWJsZSwgbnVsbCwgInVpLXN0YXRlLWZvY3VzIiApOw0KCQl9DQoJfSwNCg0KCWVuYWJsZTogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKCB7IGRpc2FibGVkOiBmYWxzZSB9ICk7DQoJfSwNCg0KCWRpc2FibGU6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9ucyggeyBkaXNhYmxlZDogdHJ1ZSB9ICk7DQoJfSwNCg0KCV9jbGFzc2VzOiBmdW5jdGlvbiggb3B0aW9ucyApIHsNCgkJdmFyIGZ1bGwgPSBbXTsNCgkJdmFyIHRoYXQgPSB0aGlzOw0KDQoJCW9wdGlvbnMgPSAkLmV4dGVuZCggew0KCQkJZWxlbWVudDogdGhpcy5lbGVtZW50LA0KCQkJY2xhc3NlczogdGhpcy5vcHRpb25zLmNsYXNzZXMgfHwge30NCgkJfSwgb3B0aW9ucyApOw0KDQoJCWZ1bmN0aW9uIHByb2Nlc3NDbGFzc1N0cmluZyggY2xhc3NlcywgY2hlY2tPcHRpb24gKSB7DQoJCQl2YXIgY3VycmVudCwgaTsNCgkJCWZvciAoIGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKyApIHsNCgkJCQljdXJyZW50ID0gdGhhdC5jbGFzc2VzRWxlbWVudExvb2t1cFsgY2xhc3Nlc1sgaSBdIF0gfHwgJCgpOw0KCQkJCWlmICggb3B0aW9ucy5hZGQgKSB7DQoJCQkJCWN1cnJlbnQgPSAkKCAkLnVuaXF1ZSggY3VycmVudC5nZXQoKS5jb25jYXQoIG9wdGlvbnMuZWxlbWVudC5nZXQoKSApICkgKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQljdXJyZW50ID0gJCggY3VycmVudC5ub3QoIG9wdGlvbnMuZWxlbWVudCApLmdldCgpICk7DQoJCQkJfQ0KCQkJCXRoYXQuY2xhc3Nlc0VsZW1lbnRMb29rdXBbIGNsYXNzZXNbIGkgXSBdID0gY3VycmVudDsNCgkJCQlmdWxsLnB1c2goIGNsYXNzZXNbIGkgXSApOw0KCQkJCWlmICggY2hlY2tPcHRpb24gJiYgb3B0aW9ucy5jbGFzc2VzWyBjbGFzc2VzWyBpIF0gXSApIHsNCgkJCQkJZnVsbC5wdXNoKCBvcHRpb25zLmNsYXNzZXNbIGNsYXNzZXNbIGkgXSBdICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJdGhpcy5fb24oIG9wdGlvbnMuZWxlbWVudCwgew0KCQkJInJlbW92ZSI6ICJfdW50cmFja0NsYXNzZXNFbGVtZW50Ig0KCQl9ICk7DQoNCgkJaWYgKCBvcHRpb25zLmtleXMgKSB7DQoJCQlwcm9jZXNzQ2xhc3NTdHJpbmcoIG9wdGlvbnMua2V5cy5tYXRjaCggL1xTKy9nICkgfHwgW10sIHRydWUgKTsNCgkJfQ0KCQlpZiAoIG9wdGlvbnMuZXh0cmEgKSB7DQoJCQlwcm9jZXNzQ2xhc3NTdHJpbmcoIG9wdGlvbnMuZXh0cmEubWF0Y2goIC9cUysvZyApIHx8IFtdICk7DQoJCX0NCg0KCQlyZXR1cm4gZnVsbC5qb2luKCAiICIgKTsNCgl9LA0KDQoJX3VudHJhY2tDbGFzc2VzRWxlbWVudDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgdGhhdCA9IHRoaXM7DQoJCSQuZWFjaCggdGhhdC5jbGFzc2VzRWxlbWVudExvb2t1cCwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCQlpZiAoICQuaW5BcnJheSggZXZlbnQudGFyZ2V0LCB2YWx1ZSApICE9PSAtMSApIHsNCgkJCQl0aGF0LmNsYXNzZXNFbGVtZW50TG9va3VwWyBrZXkgXSA9ICQoIHZhbHVlLm5vdCggZXZlbnQudGFyZ2V0ICkuZ2V0KCkgKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCBlbGVtZW50LCBrZXlzLCBleHRyYSApIHsNCgkJcmV0dXJuIHRoaXMuX3RvZ2dsZUNsYXNzKCBlbGVtZW50LCBrZXlzLCBleHRyYSwgZmFsc2UgKTsNCgl9LA0KDQoJX2FkZENsYXNzOiBmdW5jdGlvbiggZWxlbWVudCwga2V5cywgZXh0cmEgKSB7DQoJCXJldHVybiB0aGlzLl90b2dnbGVDbGFzcyggZWxlbWVudCwga2V5cywgZXh0cmEsIHRydWUgKTsNCgl9LA0KDQoJX3RvZ2dsZUNsYXNzOiBmdW5jdGlvbiggZWxlbWVudCwga2V5cywgZXh0cmEsIGFkZCApIHsNCgkJYWRkID0gKCB0eXBlb2YgYWRkID09PSAiYm9vbGVhbiIgKSA\/IGFkZCA6IGV4dHJhOw0KCQl2YXIgc2hpZnQgPSAoIHR5cGVvZiBlbGVtZW50ID09PSAic3RyaW5nIiB8fCBlbGVtZW50ID09PSBudWxsICksDQoJCQlvcHRpb25zID0gew0KCQkJCWV4dHJhOiBzaGlmdCA\/IGtleXMgOiBleHRyYSwNCgkJCQlrZXlzOiBzaGlmdCA\/IGVsZW1lbnQgOiBrZXlzLA0KCQkJCWVsZW1lbnQ6IHNoaWZ0ID8gdGhpcy5lbGVtZW50IDogZWxlbWVudCwNCgkJCQlhZGQ6IGFkZA0KCQkJfTsNCgkJb3B0aW9ucy5lbGVtZW50LnRvZ2dsZUNsYXNzKCB0aGlzLl9jbGFzc2VzKCBvcHRpb25zICksIGFkZCApOw0KCQlyZXR1cm4gdGhpczsNCgl9LA0KDQoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsNCgkJdmFyIGRlbGVnYXRlRWxlbWVudDsNCgkJdmFyIGluc3RhbmNlID0gdGhpczsNCg0KCQkvLyBObyBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgZmxhZywgc2h1ZmZsZSBhcmd1bWVudHMNCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7DQoJCQloYW5kbGVycyA9IGVsZW1lbnQ7DQoJCQllbGVtZW50ID0gc3VwcHJlc3NEaXNhYmxlZENoZWNrOw0KCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7DQoJCX0NCg0KCQkvLyBObyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50DQoJCWlmICggIWhhbmRsZXJzICkgew0KCQkJaGFuZGxlcnMgPSBlbGVtZW50Ow0KCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsNCgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7DQoJCX0gZWxzZSB7DQoJCQllbGVtZW50ID0gZGVsZWdhdGVFbGVtZW50ID0gJCggZWxlbWVudCApOw0KCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7DQoJCX0NCg0KCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7DQoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7DQoNCgkJCQkvLyBBbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcNCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbg0KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cw0KCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJg0KCQkJCQkJKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8DQoJCQkJCQkkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApICkgew0KCQkJCQlyZXR1cm47DQoJCQkJfQ0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA\/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkNCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7DQoJCQl9DQoNCgkJCS8vIENvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3Jrcw0KCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7DQoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQ0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7DQoJCQl9DQoNCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihbXHc6LV0qKVxzKiguKikkLyApOw0KCQkJdmFyIGV2ZW50TmFtZSA9IG1hdGNoWyAxIF0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZTsNCgkJCXZhciBzZWxlY3RvciA9IG1hdGNoWyAyIF07DQoNCgkJCWlmICggc2VsZWN0b3IgKSB7DQoJCQkJZGVsZWdhdGVFbGVtZW50Lm9uKCBldmVudE5hbWUsIHNlbGVjdG9yLCBoYW5kbGVyUHJveHkgKTsNCgkJCX0gZWxzZSB7DQoJCQkJZWxlbWVudC5vbiggZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgew0KCQlldmVudE5hbWUgPSAoIGV2ZW50TmFtZSB8fCAiIiApLnNwbGl0KCAiICIgKS5qb2luKCB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiAiICkgKw0KCQkJdGhpcy5ldmVudE5hbWVzcGFjZTsNCgkJZWxlbWVudC5vZmYoIGV2ZW50TmFtZSApLm9mZiggZXZlbnROYW1lICk7DQoNCgkJLy8gQ2xlYXIgdGhlIHN0YWNrIHRvIGF2b2lkIG1lbW9yeSBsZWFrcyAoIzEwMDU2KQ0KCQl0aGlzLmJpbmRpbmdzID0gJCggdGhpcy5iaW5kaW5ncy5ub3QoIGVsZW1lbnQgKS5nZXQoKSApOw0KCQl0aGlzLmZvY3VzYWJsZSA9ICQoIHRoaXMuZm9jdXNhYmxlLm5vdCggZWxlbWVudCApLmdldCgpICk7DQoJCXRoaXMuaG92ZXJhYmxlID0gJCggdGhpcy5ob3ZlcmFibGUubm90KCBlbGVtZW50ICkuZ2V0KCkgKTsNCgl9LA0KDQoJX2RlbGF5OiBmdW5jdGlvbiggaGFuZGxlciwgZGVsYXkgKSB7DQoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsNCgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA\/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkNCgkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsNCgkJfQ0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOw0KCQlyZXR1cm4gc2V0VGltZW91dCggaGFuZGxlclByb3h5LCBkZWxheSB8fCAwICk7DQoJfSwNCg0KCV9ob3ZlcmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOw0KCQl0aGlzLl9vbiggZWxlbWVudCwgew0KCQkJbW91c2VlbnRlcjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1ob3ZlciIgKTsNCgkJCX0sDQoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwgbnVsbCwgInVpLXN0YXRlLWhvdmVyIiApOw0KCQkJfQ0KCQl9ICk7DQoJfSwNCg0KCV9mb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOw0KCQl0aGlzLl9vbiggZWxlbWVudCwgew0KCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsNCgkJCX0sDQoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgew0KCQl2YXIgcHJvcCwgb3JpZzsNCgkJdmFyIGNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07DQoNCgkJZGF0YSA9IGRhdGEgfHwge307DQoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsNCgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA\/DQoJCQl0eXBlIDoNCgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsNCg0KCQkvLyBUaGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudA0KCQkvLyBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSB0YXJnZXQgb24gdGhlIG5ldyBldmVudA0KCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsNCg0KCQkvLyBDb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50DQoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50Ow0KCQlpZiAoIG9yaWcgKSB7DQoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7DQoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7DQoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7DQoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYNCgkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLmVsZW1lbnRbIDAgXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8DQoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOw0KCX0NCn07DQoNCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7DQoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsNCgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7DQoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsNCgkJfQ0KDQoJCXZhciBoYXNPcHRpb25zOw0KCQl2YXIgZWZmZWN0TmFtZSA9ICFvcHRpb25zID8NCgkJCW1ldGhvZCA6DQoJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA\/DQoJCQkJZGVmYXVsdEVmZmVjdCA6DQoJCQkJb3B0aW9ucy5lZmZlY3QgfHwgZGVmYXVsdEVmZmVjdDsNCg0KCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsNCgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7DQoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9Ow0KCQl9DQoNCgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsNCgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOw0KDQoJCWlmICggb3B0aW9ucy5kZWxheSApIHsNCgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsNCgkJfQ0KDQoJCWlmICggaGFzT3B0aW9ucyAmJiAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdICkgew0KCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsNCgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsNCgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7DQoJCX0gZWxzZSB7DQoJCQllbGVtZW50LnF1ZXVlKCBmdW5jdGlvbiggbmV4dCApIHsNCgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7DQoJCQkJaWYgKCBjYWxsYmFjayApIHsNCgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7DQoJCQkJfQ0KCQkJCW5leHQoKTsNCgkJCX0gKTsNCgkJfQ0KCX07DQp9ICk7DQoNCnZhciB3aWRnZXQgPSAkLndpZGdldDsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBQb3NpdGlvbiAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICoNCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3Bvc2l0aW9uLw0KICovDQoNCi8vPj5sYWJlbDogUG9zaXRpb24NCi8vPj5ncm91cDogQ29yZQ0KLy8+PmRlc2NyaXB0aW9uOiBQb3NpdGlvbnMgZWxlbWVudHMgcmVsYXRpdmUgdG8gb3RoZXIgZWxlbWVudHMuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vcG9zaXRpb24vDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vcG9zaXRpb24vDQoNCg0KKCBmdW5jdGlvbigpIHsNCnZhciBjYWNoZWRTY3JvbGxiYXJXaWR0aCwNCgltYXggPSBNYXRoLm1heCwNCglhYnMgPSBNYXRoLmFicywNCglyaG9yaXpvbnRhbCA9IC9sZWZ0fGNlbnRlcnxyaWdodC8sDQoJcnZlcnRpY2FsID0gL3RvcHxjZW50ZXJ8Ym90dG9tLywNCglyb2Zmc2V0ID0gL1tcK1wtXVxkKyhcLltcZF0rKT8lPy8sDQoJcnBvc2l0aW9uID0gL15cdysvLA0KCXJwZXJjZW50ID0gLyUkLywNCglfcG9zaXRpb24gPSAkLmZuLnBvc2l0aW9uOw0KDQpmdW5jdGlvbiBnZXRPZmZzZXRzKCBvZmZzZXRzLCB3aWR0aCwgaGVpZ2h0ICkgew0KCXJldHVybiBbDQoJCXBhcnNlRmxvYXQoIG9mZnNldHNbIDAgXSApICogKCBycGVyY2VudC50ZXN0KCBvZmZzZXRzWyAwIF0gKSA\/IHdpZHRoIC8gMTAwIDogMSApLA0KCQlwYXJzZUZsb2F0KCBvZmZzZXRzWyAxIF0gKSAqICggcnBlcmNlbnQudGVzdCggb2Zmc2V0c1sgMSBdICkgPyBoZWlnaHQgLyAxMDAgOiAxICkNCgldOw0KfQ0KDQpmdW5jdGlvbiBwYXJzZUNzcyggZWxlbWVudCwgcHJvcGVydHkgKSB7DQoJcmV0dXJuIHBhcnNlSW50KCAkLmNzcyggZWxlbWVudCwgcHJvcGVydHkgKSwgMTAgKSB8fCAwOw0KfQ0KDQpmdW5jdGlvbiBnZXREaW1lbnNpb25zKCBlbGVtICkgew0KCXZhciByYXcgPSBlbGVtWyAwIF07DQoJaWYgKCByYXcubm9kZVR5cGUgPT09IDkgKSB7DQoJCXJldHVybiB7DQoJCQl3aWR0aDogZWxlbS53aWR0aCgpLA0KCQkJaGVpZ2h0OiBlbGVtLmhlaWdodCgpLA0KCQkJb2Zmc2V0OiB7IHRvcDogMCwgbGVmdDogMCB9DQoJCX07DQoJfQ0KCWlmICggJC5pc1dpbmRvdyggcmF3ICkgKSB7DQoJCXJldHVybiB7DQoJCQl3aWR0aDogZWxlbS53aWR0aCgpLA0KCQkJaGVpZ2h0OiBlbGVtLmhlaWdodCgpLA0KCQkJb2Zmc2V0OiB7IHRvcDogZWxlbS5zY3JvbGxUb3AoKSwgbGVmdDogZWxlbS5zY3JvbGxMZWZ0KCkgfQ0KCQl9Ow0KCX0NCglpZiAoIHJhdy5wcmV2ZW50RGVmYXVsdCApIHsNCgkJcmV0dXJuIHsNCgkJCXdpZHRoOiAwLA0KCQkJaGVpZ2h0OiAwLA0KCQkJb2Zmc2V0OiB7IHRvcDogcmF3LnBhZ2VZLCBsZWZ0OiByYXcucGFnZVggfQ0KCQl9Ow0KCX0NCglyZXR1cm4gew0KCQl3aWR0aDogZWxlbS5vdXRlcldpZHRoKCksDQoJCWhlaWdodDogZWxlbS5vdXRlckhlaWdodCgpLA0KCQlvZmZzZXQ6IGVsZW0ub2Zmc2V0KCkNCgl9Ow0KfQ0KDQokLnBvc2l0aW9uID0gew0KCXNjcm9sbGJhcldpZHRoOiBmdW5jdGlvbigpIHsNCgkJaWYgKCBjYWNoZWRTY3JvbGxiYXJXaWR0aCAhPT0gdW5kZWZpbmVkICkgew0KCQkJcmV0dXJuIGNhY2hlZFNjcm9sbGJhcldpZHRoOw0KCQl9DQoJCXZhciB3MSwgdzIsDQoJCQlkaXYgPSAkKCAiPGRpdiAiICsNCgkJCQkic3R5bGU9J2Rpc3BsYXk6YmxvY2s7cG9zaXRpb246YWJzb2x1dGU7d2lkdGg6NTBweDtoZWlnaHQ6NTBweDtvdmVyZmxvdzpoaWRkZW47Jz4iICsNCgkJCQkiPGRpdiBzdHlsZT0naGVpZ2h0OjEwMHB4O3dpZHRoOmF1dG87Jz48L2Rpdj48L2Rpdj4iICksDQoJCQlpbm5lckRpdiA9IGRpdi5jaGlsZHJlbigpWyAwIF07DQoNCgkJJCggImJvZHkiICkuYXBwZW5kKCBkaXYgKTsNCgkJdzEgPSBpbm5lckRpdi5vZmZzZXRXaWR0aDsNCgkJZGl2LmNzcyggIm92ZXJmbG93IiwgInNjcm9sbCIgKTsNCg0KCQl3MiA9IGlubmVyRGl2Lm9mZnNldFdpZHRoOw0KDQoJCWlmICggdzEgPT09IHcyICkgew0KCQkJdzIgPSBkaXZbIDAgXS5jbGllbnRXaWR0aDsNCgkJfQ0KDQoJCWRpdi5yZW1vdmUoKTsNCg0KCQlyZXR1cm4gKCBjYWNoZWRTY3JvbGxiYXJXaWR0aCA9IHcxIC0gdzIgKTsNCgl9LA0KCWdldFNjcm9sbEluZm86IGZ1bmN0aW9uKCB3aXRoaW4gKSB7DQoJCXZhciBvdmVyZmxvd1ggPSB3aXRoaW4uaXNXaW5kb3cgfHwgd2l0aGluLmlzRG9jdW1lbnQgPyAiIiA6DQoJCQkJd2l0aGluLmVsZW1lbnQuY3NzKCAib3ZlcmZsb3cteCIgKSwNCgkJCW92ZXJmbG93WSA9IHdpdGhpbi5pc1dpbmRvdyB8fCB3aXRoaW4uaXNEb2N1bWVudCA\/ICIiIDoNCgkJCQl3aXRoaW4uZWxlbWVudC5jc3MoICJvdmVyZmxvdy15IiApLA0KCQkJaGFzT3ZlcmZsb3dYID0gb3ZlcmZsb3dYID09PSAic2Nyb2xsIiB8fA0KCQkJCSggb3ZlcmZsb3dYID09PSAiYXV0byIgJiYgd2l0aGluLndpZHRoIDwgd2l0aGluLmVsZW1lbnRbIDAgXS5zY3JvbGxXaWR0aCApLA0KCQkJaGFzT3ZlcmZsb3dZID0gb3ZlcmZsb3dZID09PSAic2Nyb2xsIiB8fA0KCQkJCSggb3ZlcmZsb3dZID09PSAiYXV0byIgJiYgd2l0aGluLmhlaWdodCA8IHdpdGhpbi5lbGVtZW50WyAwIF0uc2Nyb2xsSGVpZ2h0ICk7DQoJCXJldHVybiB7DQoJCQl3aWR0aDogaGFzT3ZlcmZsb3dZID8gJC5wb3NpdGlvbi5zY3JvbGxiYXJXaWR0aCgpIDogMCwNCgkJCWhlaWdodDogaGFzT3ZlcmZsb3dYID8gJC5wb3NpdGlvbi5zY3JvbGxiYXJXaWR0aCgpIDogMA0KCQl9Ow0KCX0sDQoJZ2V0V2l0aGluSW5mbzogZnVuY3Rpb24oIGVsZW1lbnQgKSB7DQoJCXZhciB3aXRoaW5FbGVtZW50ID0gJCggZWxlbWVudCB8fCB3aW5kb3cgKSwNCgkJCWlzV2luZG93ID0gJC5pc1dpbmRvdyggd2l0aGluRWxlbWVudFsgMCBdICksDQoJCQlpc0RvY3VtZW50ID0gISF3aXRoaW5FbGVtZW50WyAwIF0gJiYgd2l0aGluRWxlbWVudFsgMCBdLm5vZGVUeXBlID09PSA5LA0KCQkJaGFzT2Zmc2V0ID0gIWlzV2luZG93ICYmICFpc0RvY3VtZW50Ow0KCQlyZXR1cm4gew0KCQkJZWxlbWVudDogd2l0aGluRWxlbWVudCwNCgkJCWlzV2luZG93OiBpc1dpbmRvdywNCgkJCWlzRG9jdW1lbnQ6IGlzRG9jdW1lbnQsDQoJCQlvZmZzZXQ6IGhhc09mZnNldCA\/ICQoIGVsZW1lbnQgKS5vZmZzZXQoKSA6IHsgbGVmdDogMCwgdG9wOiAwIH0sDQoJCQlzY3JvbGxMZWZ0OiB3aXRoaW5FbGVtZW50LnNjcm9sbExlZnQoKSwNCgkJCXNjcm9sbFRvcDogd2l0aGluRWxlbWVudC5zY3JvbGxUb3AoKSwNCgkJCXdpZHRoOiB3aXRoaW5FbGVtZW50Lm91dGVyV2lkdGgoKSwNCgkJCWhlaWdodDogd2l0aGluRWxlbWVudC5vdXRlckhlaWdodCgpDQoJCX07DQoJfQ0KfTsNCg0KJC5mbi5wb3NpdGlvbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgew0KCWlmICggIW9wdGlvbnMgfHwgIW9wdGlvbnMub2YgKSB7DQoJCXJldHVybiBfcG9zaXRpb24uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCX0NCg0KCS8vIE1ha2UgYSBjb3B5LCB3ZSBkb24ndCB3YW50IHRvIG1vZGlmeSBhcmd1bWVudHMNCglvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7DQoNCgl2YXIgYXRPZmZzZXQsIHRhcmdldFdpZHRoLCB0YXJnZXRIZWlnaHQsIHRhcmdldE9mZnNldCwgYmFzZVBvc2l0aW9uLCBkaW1lbnNpb25zLA0KCQl0YXJnZXQgPSAkKCBvcHRpb25zLm9mICksDQoJCXdpdGhpbiA9ICQucG9zaXRpb24uZ2V0V2l0aGluSW5mbyggb3B0aW9ucy53aXRoaW4gKSwNCgkJc2Nyb2xsSW5mbyA9ICQucG9zaXRpb24uZ2V0U2Nyb2xsSW5mbyggd2l0aGluICksDQoJCWNvbGxpc2lvbiA9ICggb3B0aW9ucy5jb2xsaXNpb24gfHwgImZsaXAiICkuc3BsaXQoICIgIiApLA0KCQlvZmZzZXRzID0ge307DQoNCglkaW1lbnNpb25zID0gZ2V0RGltZW5zaW9ucyggdGFyZ2V0ICk7DQoJaWYgKCB0YXJnZXRbIDAgXS5wcmV2ZW50RGVmYXVsdCApIHsNCg0KCQkvLyBGb3JjZSBsZWZ0IHRvcCB0byBhbGxvdyBmbGlwcGluZw0KCQlvcHRpb25zLmF0ID0gImxlZnQgdG9wIjsNCgl9DQoJdGFyZ2V0V2lkdGggPSBkaW1lbnNpb25zLndpZHRoOw0KCXRhcmdldEhlaWdodCA9IGRpbWVuc2lvbnMuaGVpZ2h0Ow0KCXRhcmdldE9mZnNldCA9IGRpbWVuc2lvbnMub2Zmc2V0Ow0KDQoJLy8gQ2xvbmUgdG8gcmV1c2Ugb3JpZ2luYWwgdGFyZ2V0T2Zmc2V0IGxhdGVyDQoJYmFzZVBvc2l0aW9uID0gJC5leHRlbmQoIHt9LCB0YXJnZXRPZmZzZXQgKTsNCg0KCS8vIEZvcmNlIG15IGFuZCBhdCB0byBoYXZlIHZhbGlkIGhvcml6b250YWwgYW5kIHZlcnRpY2FsIHBvc2l0aW9ucw0KCS8vIGlmIGEgdmFsdWUgaXMgbWlzc2luZyBvciBpbnZhbGlkLCBpdCB3aWxsIGJlIGNvbnZlcnRlZCB0byBjZW50ZXINCgkkLmVhY2goIFsgIm15IiwgImF0IiBdLCBmdW5jdGlvbigpIHsNCgkJdmFyIHBvcyA9ICggb3B0aW9uc1sgdGhpcyBdIHx8ICIiICkuc3BsaXQoICIgIiApLA0KCQkJaG9yaXpvbnRhbE9mZnNldCwNCgkJCXZlcnRpY2FsT2Zmc2V0Ow0KDQoJCWlmICggcG9zLmxlbmd0aCA9PT0gMSApIHsNCgkJCXBvcyA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPw0KCQkJCXBvcy5jb25jYXQoIFsgImNlbnRlciIgXSApIDoNCgkJCQlydmVydGljYWwudGVzdCggcG9zWyAwIF0gKSA\/DQoJCQkJCVsgImNlbnRlciIgXS5jb25jYXQoIHBvcyApIDoNCgkJCQkJWyAiY2VudGVyIiwgImNlbnRlciIgXTsNCgkJfQ0KCQlwb3NbIDAgXSA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPyBwb3NbIDAgXSA6ICJjZW50ZXIiOw0KCQlwb3NbIDEgXSA9IHJ2ZXJ0aWNhbC50ZXN0KCBwb3NbIDEgXSApID8gcG9zWyAxIF0gOiAiY2VudGVyIjsNCg0KCQkvLyBDYWxjdWxhdGUgb2Zmc2V0cw0KCQlob3Jpem9udGFsT2Zmc2V0ID0gcm9mZnNldC5leGVjKCBwb3NbIDAgXSApOw0KCQl2ZXJ0aWNhbE9mZnNldCA9IHJvZmZzZXQuZXhlYyggcG9zWyAxIF0gKTsNCgkJb2Zmc2V0c1sgdGhpcyBdID0gWw0KCQkJaG9yaXpvbnRhbE9mZnNldCA\/IGhvcml6b250YWxPZmZzZXRbIDAgXSA6IDAsDQoJCQl2ZXJ0aWNhbE9mZnNldCA\/IHZlcnRpY2FsT2Zmc2V0WyAwIF0gOiAwDQoJCV07DQoNCgkJLy8gUmVkdWNlIHRvIGp1c3QgdGhlIHBvc2l0aW9ucyB3aXRob3V0IHRoZSBvZmZzZXRzDQoJCW9wdGlvbnNbIHRoaXMgXSA9IFsNCgkJCXJwb3NpdGlvbi5leGVjKCBwb3NbIDAgXSApWyAwIF0sDQoJCQlycG9zaXRpb24uZXhlYyggcG9zWyAxIF0gKVsgMCBdDQoJCV07DQoJfSApOw0KDQoJLy8gTm9ybWFsaXplIGNvbGxpc2lvbiBvcHRpb24NCglpZiAoIGNvbGxpc2lvbi5sZW5ndGggPT09IDEgKSB7DQoJCWNvbGxpc2lvblsgMSBdID0gY29sbGlzaW9uWyAwIF07DQoJfQ0KDQoJaWYgKCBvcHRpb25zLmF0WyAwIF0gPT09ICJyaWdodCIgKSB7DQoJCWJhc2VQb3NpdGlvbi5sZWZ0ICs9IHRhcmdldFdpZHRoOw0KCX0gZWxzZSBpZiAoIG9wdGlvbnMuYXRbIDAgXSA9PT0gImNlbnRlciIgKSB7DQoJCWJhc2VQb3NpdGlvbi5sZWZ0ICs9IHRhcmdldFdpZHRoIC8gMjsNCgl9DQoNCglpZiAoIG9wdGlvbnMuYXRbIDEgXSA9PT0gImJvdHRvbSIgKSB7DQoJCWJhc2VQb3NpdGlvbi50b3AgKz0gdGFyZ2V0SGVpZ2h0Ow0KCX0gZWxzZSBpZiAoIG9wdGlvbnMuYXRbIDEgXSA9PT0gImNlbnRlciIgKSB7DQoJCWJhc2VQb3NpdGlvbi50b3AgKz0gdGFyZ2V0SGVpZ2h0IC8gMjsNCgl9DQoNCglhdE9mZnNldCA9IGdldE9mZnNldHMoIG9mZnNldHMuYXQsIHRhcmdldFdpZHRoLCB0YXJnZXRIZWlnaHQgKTsNCgliYXNlUG9zaXRpb24ubGVmdCArPSBhdE9mZnNldFsgMCBdOw0KCWJhc2VQb3NpdGlvbi50b3AgKz0gYXRPZmZzZXRbIDEgXTsNCg0KCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQl2YXIgY29sbGlzaW9uUG9zaXRpb24sIHVzaW5nLA0KCQkJZWxlbSA9ICQoIHRoaXMgKSwNCgkJCWVsZW1XaWR0aCA9IGVsZW0ub3V0ZXJXaWR0aCgpLA0KCQkJZWxlbUhlaWdodCA9IGVsZW0ub3V0ZXJIZWlnaHQoKSwNCgkJCW1hcmdpbkxlZnQgPSBwYXJzZUNzcyggdGhpcywgIm1hcmdpbkxlZnQiICksDQoJCQltYXJnaW5Ub3AgPSBwYXJzZUNzcyggdGhpcywgIm1hcmdpblRvcCIgKSwNCgkJCWNvbGxpc2lvbldpZHRoID0gZWxlbVdpZHRoICsgbWFyZ2luTGVmdCArIHBhcnNlQ3NzKCB0aGlzLCAibWFyZ2luUmlnaHQiICkgKw0KCQkJCXNjcm9sbEluZm8ud2lkdGgsDQoJCQljb2xsaXNpb25IZWlnaHQgPSBlbGVtSGVpZ2h0ICsgbWFyZ2luVG9wICsgcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5Cb3R0b20iICkgKw0KCQkJCXNjcm9sbEluZm8uaGVpZ2h0LA0KCQkJcG9zaXRpb24gPSAkLmV4dGVuZCgge30sIGJhc2VQb3NpdGlvbiApLA0KCQkJbXlPZmZzZXQgPSBnZXRPZmZzZXRzKCBvZmZzZXRzLm15LCBlbGVtLm91dGVyV2lkdGgoKSwgZWxlbS5vdXRlckhlaWdodCgpICk7DQoNCgkJaWYgKCBvcHRpb25zLm15WyAwIF0gPT09ICJyaWdodCIgKSB7DQoJCQlwb3NpdGlvbi5sZWZ0IC09IGVsZW1XaWR0aDsNCgkJfSBlbHNlIGlmICggb3B0aW9ucy5teVsgMCBdID09PSAiY2VudGVyIiApIHsNCgkJCXBvc2l0aW9uLmxlZnQgLT0gZWxlbVdpZHRoIC8gMjsNCgkJfQ0KDQoJCWlmICggb3B0aW9ucy5teVsgMSBdID09PSAiYm90dG9tIiApIHsNCgkJCXBvc2l0aW9uLnRvcCAtPSBlbGVtSGVpZ2h0Ow0KCQl9IGVsc2UgaWYgKCBvcHRpb25zLm15WyAxIF0gPT09ICJjZW50ZXIiICkgew0KCQkJcG9zaXRpb24udG9wIC09IGVsZW1IZWlnaHQgLyAyOw0KCQl9DQoNCgkJcG9zaXRpb24ubGVmdCArPSBteU9mZnNldFsgMCBdOw0KCQlwb3NpdGlvbi50b3AgKz0gbXlPZmZzZXRbIDEgXTsNCg0KCQljb2xsaXNpb25Qb3NpdGlvbiA9IHsNCgkJCW1hcmdpbkxlZnQ6IG1hcmdpbkxlZnQsDQoJCQltYXJnaW5Ub3A6IG1hcmdpblRvcA0KCQl9Ow0KDQoJCSQuZWFjaCggWyAibGVmdCIsICJ0b3AiIF0sIGZ1bmN0aW9uKCBpLCBkaXIgKSB7DQoJCQlpZiAoICQudWkucG9zaXRpb25bIGNvbGxpc2lvblsgaSBdIF0gKSB7DQoJCQkJJC51aS5wb3NpdGlvblsgY29sbGlzaW9uWyBpIF0gXVsgZGlyIF0oIHBvc2l0aW9uLCB7DQoJCQkJCXRhcmdldFdpZHRoOiB0YXJnZXRXaWR0aCwNCgkJCQkJdGFyZ2V0SGVpZ2h0OiB0YXJnZXRIZWlnaHQsDQoJCQkJCWVsZW1XaWR0aDogZWxlbVdpZHRoLA0KCQkJCQllbGVtSGVpZ2h0OiBlbGVtSGVpZ2h0LA0KCQkJCQljb2xsaXNpb25Qb3NpdGlvbjogY29sbGlzaW9uUG9zaXRpb24sDQoJCQkJCWNvbGxpc2lvbldpZHRoOiBjb2xsaXNpb25XaWR0aCwNCgkJCQkJY29sbGlzaW9uSGVpZ2h0OiBjb2xsaXNpb25IZWlnaHQsDQoJCQkJCW9mZnNldDogWyBhdE9mZnNldFsgMCBdICsgbXlPZmZzZXRbIDAgXSwgYXRPZmZzZXQgWyAxIF0gKyBteU9mZnNldFsgMSBdIF0sDQoJCQkJCW15OiBvcHRpb25zLm15LA0KCQkJCQlhdDogb3B0aW9ucy5hdCwNCgkJCQkJd2l0aGluOiB3aXRoaW4sDQoJCQkJCWVsZW06IGVsZW0NCgkJCQl9ICk7DQoJCQl9DQoJCX0gKTsNCg0KCQlpZiAoIG9wdGlvbnMudXNpbmcgKSB7DQoNCgkJCS8vIEFkZHMgZmVlZGJhY2sgYXMgc2Vjb25kIGFyZ3VtZW50IHRvIHVzaW5nIGNhbGxiYWNrLCBpZiBwcmVzZW50DQoJCQl1c2luZyA9IGZ1bmN0aW9uKCBwcm9wcyApIHsNCgkJCQl2YXIgbGVmdCA9IHRhcmdldE9mZnNldC5sZWZ0IC0gcG9zaXRpb24ubGVmdCwNCgkJCQkJcmlnaHQgPSBsZWZ0ICsgdGFyZ2V0V2lkdGggLSBlbGVtV2lkdGgsDQoJCQkJCXRvcCA9IHRhcmdldE9mZnNldC50b3AgLSBwb3NpdGlvbi50b3AsDQoJCQkJCWJvdHRvbSA9IHRvcCArIHRhcmdldEhlaWdodCAtIGVsZW1IZWlnaHQsDQoJCQkJCWZlZWRiYWNrID0gew0KCQkJCQkJdGFyZ2V0OiB7DQoJCQkJCQkJZWxlbWVudDogdGFyZ2V0LA0KCQkJCQkJCWxlZnQ6IHRhcmdldE9mZnNldC5sZWZ0LA0KCQkJCQkJCXRvcDogdGFyZ2V0T2Zmc2V0LnRvcCwNCgkJCQkJCQl3aWR0aDogdGFyZ2V0V2lkdGgsDQoJCQkJCQkJaGVpZ2h0OiB0YXJnZXRIZWlnaHQNCgkJCQkJCX0sDQoJCQkJCQllbGVtZW50OiB7DQoJCQkJCQkJZWxlbWVudDogZWxlbSwNCgkJCQkJCQlsZWZ0OiBwb3NpdGlvbi5sZWZ0LA0KCQkJCQkJCXRvcDogcG9zaXRpb24udG9wLA0KCQkJCQkJCXdpZHRoOiBlbGVtV2lkdGgsDQoJCQkJCQkJaGVpZ2h0OiBlbGVtSGVpZ2h0DQoJCQkJCQl9LA0KCQkJCQkJaG9yaXpvbnRhbDogcmlnaHQgPCAwID8gImxlZnQiIDogbGVmdCA+IDAgPyAicmlnaHQiIDogImNlbnRlciIsDQoJCQkJCQl2ZXJ0aWNhbDogYm90dG9tIDwgMCA\/ICJ0b3AiIDogdG9wID4gMCA\/ICJib3R0b20iIDogIm1pZGRsZSINCgkJCQkJfTsNCgkJCQlpZiAoIHRhcmdldFdpZHRoIDwgZWxlbVdpZHRoICYmIGFicyggbGVmdCArIHJpZ2h0ICkgPCB0YXJnZXRXaWR0aCApIHsNCgkJCQkJZmVlZGJhY2suaG9yaXpvbnRhbCA9ICJjZW50ZXIiOw0KCQkJCX0NCgkJCQlpZiAoIHRhcmdldEhlaWdodCA8IGVsZW1IZWlnaHQgJiYgYWJzKCB0b3AgKyBib3R0b20gKSA8IHRhcmdldEhlaWdodCApIHsNCgkJCQkJZmVlZGJhY2sudmVydGljYWwgPSAibWlkZGxlIjsNCgkJCQl9DQoJCQkJaWYgKCBtYXgoIGFicyggbGVmdCApLCBhYnMoIHJpZ2h0ICkgKSA+IG1heCggYWJzKCB0b3AgKSwgYWJzKCBib3R0b20gKSApICkgew0KCQkJCQlmZWVkYmFjay5pbXBvcnRhbnQgPSAiaG9yaXpvbnRhbCI7DQoJCQkJfSBlbHNlIHsNCgkJCQkJZmVlZGJhY2suaW1wb3J0YW50ID0gInZlcnRpY2FsIjsNCgkJCQl9DQoJCQkJb3B0aW9ucy51c2luZy5jYWxsKCB0aGlzLCBwcm9wcywgZmVlZGJhY2sgKTsNCgkJCX07DQoJCX0NCg0KCQllbGVtLm9mZnNldCggJC5leHRlbmQoIHBvc2l0aW9uLCB7IHVzaW5nOiB1c2luZyB9ICkgKTsNCgl9ICk7DQp9Ow0KDQokLnVpLnBvc2l0aW9uID0gew0KCWZpdDogew0KCQlsZWZ0OiBmdW5jdGlvbiggcG9zaXRpb24sIGRhdGEgKSB7DQoJCQl2YXIgd2l0aGluID0gZGF0YS53aXRoaW4sDQoJCQkJd2l0aGluT2Zmc2V0ID0gd2l0aGluLmlzV2luZG93ID8gd2l0aGluLnNjcm9sbExlZnQgOiB3aXRoaW4ub2Zmc2V0LmxlZnQsDQoJCQkJb3V0ZXJXaWR0aCA9IHdpdGhpbi53aWR0aCwNCgkJCQljb2xsaXNpb25Qb3NMZWZ0ID0gcG9zaXRpb24ubGVmdCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luTGVmdCwNCgkJCQlvdmVyTGVmdCA9IHdpdGhpbk9mZnNldCAtIGNvbGxpc2lvblBvc0xlZnQsDQoJCQkJb3ZlclJpZ2h0ID0gY29sbGlzaW9uUG9zTGVmdCArIGRhdGEuY29sbGlzaW9uV2lkdGggLSBvdXRlcldpZHRoIC0gd2l0aGluT2Zmc2V0LA0KCQkJCW5ld092ZXJSaWdodDsNCg0KCQkJLy8gRWxlbWVudCBpcyB3aWRlciB0aGFuIHdpdGhpbg0KCQkJaWYgKCBkYXRhLmNvbGxpc2lvbldpZHRoID4gb3V0ZXJXaWR0aCApIHsNCg0KCQkJCS8vIEVsZW1lbnQgaXMgaW5pdGlhbGx5IG92ZXIgdGhlIGxlZnQgc2lkZSBvZiB3aXRoaW4NCgkJCQlpZiAoIG92ZXJMZWZ0ID4gMCAmJiBvdmVyUmlnaHQgPD0gMCApIHsNCgkJCQkJbmV3T3ZlclJpZ2h0ID0gcG9zaXRpb24ubGVmdCArIG92ZXJMZWZ0ICsgZGF0YS5jb2xsaXNpb25XaWR0aCAtIG91dGVyV2lkdGggLQ0KCQkJCQkJd2l0aGluT2Zmc2V0Ow0KCQkJCQlwb3NpdGlvbi5sZWZ0ICs9IG92ZXJMZWZ0IC0gbmV3T3ZlclJpZ2h0Ow0KDQoJCQkJLy8gRWxlbWVudCBpcyBpbml0aWFsbHkgb3ZlciByaWdodCBzaWRlIG9mIHdpdGhpbg0KCQkJCX0gZWxzZSBpZiAoIG92ZXJSaWdodCA+IDAgJiYgb3ZlckxlZnQgPD0gMCApIHsNCgkJCQkJcG9zaXRpb24ubGVmdCA9IHdpdGhpbk9mZnNldDsNCg0KCQkJCS8vIEVsZW1lbnQgaXMgaW5pdGlhbGx5IG92ZXIgYm90aCBsZWZ0IGFuZCByaWdodCBzaWRlcyBvZiB3aXRoaW4NCgkJCQl9IGVsc2Ugew0KCQkJCQlpZiAoIG92ZXJMZWZ0ID4gb3ZlclJpZ2h0ICkgew0KCQkJCQkJcG9zaXRpb24ubGVmdCA9IHdpdGhpbk9mZnNldCArIG91dGVyV2lkdGggLSBkYXRhLmNvbGxpc2lvbldpZHRoOw0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJcG9zaXRpb24ubGVmdCA9IHdpdGhpbk9mZnNldDsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJLy8gVG9vIGZhciBsZWZ0IC0+IGFsaWduIHdpdGggbGVmdCBlZGdlDQoJCQl9IGVsc2UgaWYgKCBvdmVyTGVmdCA+IDAgKSB7DQoJCQkJcG9zaXRpb24ubGVmdCArPSBvdmVyTGVmdDsNCg0KCQkJLy8gVG9vIGZhciByaWdodCAtPiBhbGlnbiB3aXRoIHJpZ2h0IGVkZ2UNCgkJCX0gZWxzZSBpZiAoIG92ZXJSaWdodCA+IDAgKSB7DQoJCQkJcG9zaXRpb24ubGVmdCAtPSBvdmVyUmlnaHQ7DQoNCgkJCS8vIEFkanVzdCBiYXNlZCBvbiBwb3NpdGlvbiBhbmQgbWFyZ2luDQoJCQl9IGVsc2Ugew0KCQkJCXBvc2l0aW9uLmxlZnQgPSBtYXgoIHBvc2l0aW9uLmxlZnQgLSBjb2xsaXNpb25Qb3NMZWZ0LCBwb3NpdGlvbi5sZWZ0ICk7DQoJCQl9DQoJCX0sDQoJCXRvcDogZnVuY3Rpb24oIHBvc2l0aW9uLCBkYXRhICkgew0KCQkJdmFyIHdpdGhpbiA9IGRhdGEud2l0aGluLA0KCQkJCXdpdGhpbk9mZnNldCA9IHdpdGhpbi5pc1dpbmRvdyA\/IHdpdGhpbi5zY3JvbGxUb3AgOiB3aXRoaW4ub2Zmc2V0LnRvcCwNCgkJCQlvdXRlckhlaWdodCA9IGRhdGEud2l0aGluLmhlaWdodCwNCgkJCQljb2xsaXNpb25Qb3NUb3AgPSBwb3NpdGlvbi50b3AgLSBkYXRhLmNvbGxpc2lvblBvc2l0aW9uLm1hcmdpblRvcCwNCgkJCQlvdmVyVG9wID0gd2l0aGluT2Zmc2V0IC0gY29sbGlzaW9uUG9zVG9wLA0KCQkJCW92ZXJCb3R0b20gPSBjb2xsaXNpb25Qb3NUb3AgKyBkYXRhLmNvbGxpc2lvbkhlaWdodCAtIG91dGVySGVpZ2h0IC0gd2l0aGluT2Zmc2V0LA0KCQkJCW5ld092ZXJCb3R0b207DQoNCgkJCS8vIEVsZW1lbnQgaXMgdGFsbGVyIHRoYW4gd2l0aGluDQoJCQlpZiAoIGRhdGEuY29sbGlzaW9uSGVpZ2h0ID4gb3V0ZXJIZWlnaHQgKSB7DQoNCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIHRoZSB0b3Agb2Ygd2l0aGluDQoJCQkJaWYgKCBvdmVyVG9wID4gMCAmJiBvdmVyQm90dG9tIDw9IDAgKSB7DQoJCQkJCW5ld092ZXJCb3R0b20gPSBwb3NpdGlvbi50b3AgKyBvdmVyVG9wICsgZGF0YS5jb2xsaXNpb25IZWlnaHQgLSBvdXRlckhlaWdodCAtDQoJCQkJCQl3aXRoaW5PZmZzZXQ7DQoJCQkJCXBvc2l0aW9uLnRvcCArPSBvdmVyVG9wIC0gbmV3T3ZlckJvdHRvbTsNCg0KCQkJCS8vIEVsZW1lbnQgaXMgaW5pdGlhbGx5IG92ZXIgYm90dG9tIG9mIHdpdGhpbg0KCQkJCX0gZWxzZSBpZiAoIG92ZXJCb3R0b20gPiAwICYmIG92ZXJUb3AgPD0gMCApIHsNCgkJCQkJcG9zaXRpb24udG9wID0gd2l0aGluT2Zmc2V0Ow0KDQoJCQkJLy8gRWxlbWVudCBpcyBpbml0aWFsbHkgb3ZlciBib3RoIHRvcCBhbmQgYm90dG9tIG9mIHdpdGhpbg0KCQkJCX0gZWxzZSB7DQoJCQkJCWlmICggb3ZlclRvcCA+IG92ZXJCb3R0b20gKSB7DQoJCQkJCQlwb3NpdGlvbi50b3AgPSB3aXRoaW5PZmZzZXQgKyBvdXRlckhlaWdodCAtIGRhdGEuY29sbGlzaW9uSGVpZ2h0Ow0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJcG9zaXRpb24udG9wID0gd2l0aGluT2Zmc2V0Ow0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkvLyBUb28gZmFyIHVwIC0+IGFsaWduIHdpdGggdG9wDQoJCQl9IGVsc2UgaWYgKCBvdmVyVG9wID4gMCApIHsNCgkJCQlwb3NpdGlvbi50b3AgKz0gb3ZlclRvcDsNCg0KCQkJLy8gVG9vIGZhciBkb3duIC0+IGFsaWduIHdpdGggYm90dG9tIGVkZ2UNCgkJCX0gZWxzZSBpZiAoIG92ZXJCb3R0b20gPiAwICkgew0KCQkJCXBvc2l0aW9uLnRvcCAtPSBvdmVyQm90dG9tOw0KDQoJCQkvLyBBZGp1c3QgYmFzZWQgb24gcG9zaXRpb24gYW5kIG1hcmdpbg0KCQkJfSBlbHNlIHsNCgkJCQlwb3NpdGlvbi50b3AgPSBtYXgoIHBvc2l0aW9uLnRvcCAtIGNvbGxpc2lvblBvc1RvcCwgcG9zaXRpb24udG9wICk7DQoJCQl9DQoJCX0NCgl9LA0KCWZsaXA6IHsNCgkJbGVmdDogZnVuY3Rpb24oIHBvc2l0aW9uLCBkYXRhICkgew0KCQkJdmFyIHdpdGhpbiA9IGRhdGEud2l0aGluLA0KCQkJCXdpdGhpbk9mZnNldCA9IHdpdGhpbi5vZmZzZXQubGVmdCArIHdpdGhpbi5zY3JvbGxMZWZ0LA0KCQkJCW91dGVyV2lkdGggPSB3aXRoaW4ud2lkdGgsDQoJCQkJb2Zmc2V0TGVmdCA9IHdpdGhpbi5pc1dpbmRvdyA\/IHdpdGhpbi5zY3JvbGxMZWZ0IDogd2l0aGluLm9mZnNldC5sZWZ0LA0KCQkJCWNvbGxpc2lvblBvc0xlZnQgPSBwb3NpdGlvbi5sZWZ0IC0gZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5MZWZ0LA0KCQkJCW92ZXJMZWZ0ID0gY29sbGlzaW9uUG9zTGVmdCAtIG9mZnNldExlZnQsDQoJCQkJb3ZlclJpZ2h0ID0gY29sbGlzaW9uUG9zTGVmdCArIGRhdGEuY29sbGlzaW9uV2lkdGggLSBvdXRlcldpZHRoIC0gb2Zmc2V0TGVmdCwNCgkJCQlteU9mZnNldCA9IGRhdGEubXlbIDAgXSA9PT0gImxlZnQiID8NCgkJCQkJLWRhdGEuZWxlbVdpZHRoIDoNCgkJCQkJZGF0YS5teVsgMCBdID09PSAicmlnaHQiID8NCgkJCQkJCWRhdGEuZWxlbVdpZHRoIDoNCgkJCQkJCTAsDQoJCQkJYXRPZmZzZXQgPSBkYXRhLmF0WyAwIF0gPT09ICJsZWZ0IiA\/DQoJCQkJCWRhdGEudGFyZ2V0V2lkdGggOg0KCQkJCQlkYXRhLmF0WyAwIF0gPT09ICJyaWdodCIgPw0KCQkJCQkJLWRhdGEudGFyZ2V0V2lkdGggOg0KCQkJCQkJMCwNCgkJCQlvZmZzZXQgPSAtMiAqIGRhdGEub2Zmc2V0WyAwIF0sDQoJCQkJbmV3T3ZlclJpZ2h0LA0KCQkJCW5ld092ZXJMZWZ0Ow0KDQoJCQlpZiAoIG92ZXJMZWZ0IDwgMCApIHsNCgkJCQluZXdPdmVyUmlnaHQgPSBwb3NpdGlvbi5sZWZ0ICsgbXlPZmZzZXQgKyBhdE9mZnNldCArIG9mZnNldCArIGRhdGEuY29sbGlzaW9uV2lkdGggLQ0KCQkJCQlvdXRlcldpZHRoIC0gd2l0aGluT2Zmc2V0Ow0KCQkJCWlmICggbmV3T3ZlclJpZ2h0IDwgMCB8fCBuZXdPdmVyUmlnaHQgPCBhYnMoIG92ZXJMZWZ0ICkgKSB7DQoJCQkJCXBvc2l0aW9uLmxlZnQgKz0gbXlPZmZzZXQgKyBhdE9mZnNldCArIG9mZnNldDsNCgkJCQl9DQoJCQl9IGVsc2UgaWYgKCBvdmVyUmlnaHQgPiAwICkgew0KCQkJCW5ld092ZXJMZWZ0ID0gcG9zaXRpb24ubGVmdCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luTGVmdCArIG15T2Zmc2V0ICsNCgkJCQkJYXRPZmZzZXQgKyBvZmZzZXQgLSBvZmZzZXRMZWZ0Ow0KCQkJCWlmICggbmV3T3ZlckxlZnQgPiAwIHx8IGFicyggbmV3T3ZlckxlZnQgKSA8IG92ZXJSaWdodCApIHsNCgkJCQkJcG9zaXRpb24ubGVmdCArPSBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0Ow0KCQkJCX0NCgkJCX0NCgkJfSwNCgkJdG9wOiBmdW5jdGlvbiggcG9zaXRpb24sIGRhdGEgKSB7DQoJCQl2YXIgd2l0aGluID0gZGF0YS53aXRoaW4sDQoJCQkJd2l0aGluT2Zmc2V0ID0gd2l0aGluLm9mZnNldC50b3AgKyB3aXRoaW4uc2Nyb2xsVG9wLA0KCQkJCW91dGVySGVpZ2h0ID0gd2l0aGluLmhlaWdodCwNCgkJCQlvZmZzZXRUb3AgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsVG9wIDogd2l0aGluLm9mZnNldC50b3AsDQoJCQkJY29sbGlzaW9uUG9zVG9wID0gcG9zaXRpb24udG9wIC0gZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5Ub3AsDQoJCQkJb3ZlclRvcCA9IGNvbGxpc2lvblBvc1RvcCAtIG9mZnNldFRvcCwNCgkJCQlvdmVyQm90dG9tID0gY29sbGlzaW9uUG9zVG9wICsgZGF0YS5jb2xsaXNpb25IZWlnaHQgLSBvdXRlckhlaWdodCAtIG9mZnNldFRvcCwNCgkJCQl0b3AgPSBkYXRhLm15WyAxIF0gPT09ICJ0b3AiLA0KCQkJCW15T2Zmc2V0ID0gdG9wID8NCgkJCQkJLWRhdGEuZWxlbUhlaWdodCA6DQoJCQkJCWRhdGEubXlbIDEgXSA9PT0gImJvdHRvbSIgPw0KCQkJCQkJZGF0YS5lbGVtSGVpZ2h0IDoNCgkJCQkJCTAsDQoJCQkJYXRPZmZzZXQgPSBkYXRhLmF0WyAxIF0gPT09ICJ0b3AiID8NCgkJCQkJZGF0YS50YXJnZXRIZWlnaHQgOg0KCQkJCQlkYXRhLmF0WyAxIF0gPT09ICJib3R0b20iID8NCgkJCQkJCS1kYXRhLnRhcmdldEhlaWdodCA6DQoJCQkJCQkwLA0KCQkJCW9mZnNldCA9IC0yICogZGF0YS5vZmZzZXRbIDEgXSwNCgkJCQluZXdPdmVyVG9wLA0KCQkJCW5ld092ZXJCb3R0b207DQoJCQlpZiAoIG92ZXJUb3AgPCAwICkgew0KCQkJCW5ld092ZXJCb3R0b20gPSBwb3NpdGlvbi50b3AgKyBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0ICsgZGF0YS5jb2xsaXNpb25IZWlnaHQgLQ0KCQkJCQlvdXRlckhlaWdodCAtIHdpdGhpbk9mZnNldDsNCgkJCQlpZiAoIG5ld092ZXJCb3R0b20gPCAwIHx8IG5ld092ZXJCb3R0b20gPCBhYnMoIG92ZXJUb3AgKSApIHsNCgkJCQkJcG9zaXRpb24udG9wICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7DQoJCQkJfQ0KCQkJfSBlbHNlIGlmICggb3ZlckJvdHRvbSA+IDAgKSB7DQoJCQkJbmV3T3ZlclRvcCA9IHBvc2l0aW9uLnRvcCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luVG9wICsgbXlPZmZzZXQgKyBhdE9mZnNldCArDQoJCQkJCW9mZnNldCAtIG9mZnNldFRvcDsNCgkJCQlpZiAoIG5ld092ZXJUb3AgPiAwIHx8IGFicyggbmV3T3ZlclRvcCApIDwgb3ZlckJvdHRvbSApIHsNCgkJCQkJcG9zaXRpb24udG9wICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfSwNCglmbGlwZml0OiB7DQoJCWxlZnQ6IGZ1bmN0aW9uKCkgew0KCQkJJC51aS5wb3NpdGlvbi5mbGlwLmxlZnQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJJC51aS5wb3NpdGlvbi5maXQubGVmdC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7DQoJCX0sDQoJCXRvcDogZnVuY3Rpb24oKSB7DQoJCQkkLnVpLnBvc2l0aW9uLmZsaXAudG9wLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCgkJCSQudWkucG9zaXRpb24uZml0LnRvcC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7DQoJCX0NCgl9DQp9Ow0KDQp9ICkoKTsNCg0KdmFyIHBvc2l0aW9uID0gJC51aS5wb3NpdGlvbjsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSA6ZGF0YSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogOmRhdGEgU2VsZWN0b3INCi8vPj5ncm91cDogQ29yZQ0KLy8+PmRlc2NyaXB0aW9uOiBTZWxlY3RzIGVsZW1lbnRzIHdoaWNoIGhhdmUgZGF0YSBzdG9yZWQgdW5kZXIgdGhlIHNwZWNpZmllZCBrZXkuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZGF0YS1zZWxlY3Rvci8NCg0KDQp2YXIgZGF0YSA9ICQuZXh0ZW5kKCAkLmV4cHJbICI6IiBdLCB7DQoJZGF0YTogJC5leHByLmNyZWF0ZVBzZXVkbyA\/DQoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oIGZ1bmN0aW9uKCBkYXRhTmFtZSApIHsNCgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7DQoJCQl9Ow0KCQl9ICkgOg0KDQoJCS8vIFN1cHBvcnQ6IGpRdWVyeSA8MS44DQoJCWZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsNCgkJCXJldHVybiAhISQuZGF0YSggZWxlbSwgbWF0Y2hbIDMgXSApOw0KCQl9DQp9ICk7DQoNCi8qIQ0KICogalF1ZXJ5IFVJIERpc2FibGUgU2VsZWN0aW9uIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBkaXNhYmxlU2VsZWN0aW9uDQovLz4+Z3JvdXA6IENvcmUNCi8vPj5kZXNjcmlwdGlvbjogRGlzYWJsZSBzZWxlY3Rpb24gb2YgdGV4dCBjb250ZW50IHdpdGhpbiB0aGUgc2V0IG9mIG1hdGNoZWQgZWxlbWVudHMuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZGlzYWJsZVNlbGVjdGlvbi8NCg0KLy8gVGhpcyBmaWxlIGlzIGRlcHJlY2F0ZWQNCg0KDQp2YXIgZGlzYWJsZVNlbGVjdGlvbiA9ICQuZm4uZXh0ZW5kKCB7DQoJZGlzYWJsZVNlbGVjdGlvbjogKCBmdW5jdGlvbigpIHsNCgkJdmFyIGV2ZW50VHlwZSA9ICJvbnNlbGVjdHN0YXJ0IiBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApID8NCgkJCSJzZWxlY3RzdGFydCIgOg0KCQkJIm1vdXNlZG93biI7DQoNCgkJcmV0dXJuIGZ1bmN0aW9uKCkgew0KCQkJcmV0dXJuIHRoaXMub24oIGV2ZW50VHlwZSArICIudWktZGlzYWJsZVNlbGVjdGlvbiIsIGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJfSApOw0KCQl9Ow0KCX0gKSgpLA0KDQoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMub2ZmKCAiLnVpLWRpc2FibGVTZWxlY3Rpb24iICk7DQoJfQ0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIEVmZmVjdHMgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IEVmZmVjdHMgQ29yZQ0KLy8+Pmdyb3VwOiBFZmZlY3RzDQovLyBqc2NzOmRpc2FibGUgbWF4aW11bUxpbmVMZW5ndGgNCi8vPj5kZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgaW50ZXJuYWwgalF1ZXJ5IGVmZmVjdHMuIEluY2x1ZGVzIG1vcnBoaW5nIGFuZCBlYXNpbmcuIFJlcXVpcmVkIGJ5IGFsbCBvdGhlciBlZmZlY3RzLg0KLy8ganNjczplbmFibGUgbWF4aW11bUxpbmVMZW5ndGgNCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9jYXRlZ29yeS9lZmZlY3RzLWNvcmUvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGRhdGFTcGFjZSA9ICJ1aS1lZmZlY3RzLSIsDQoJZGF0YVNwYWNlU3R5bGUgPSAidWktZWZmZWN0cy1zdHlsZSIsDQoJZGF0YVNwYWNlQW5pbWF0ZWQgPSAidWktZWZmZWN0cy1hbmltYXRlZCIsDQoNCgkvLyBDcmVhdGUgYSBsb2NhbCBqUXVlcnkgYmVjYXVzZSBqUXVlcnkgQ29sb3IgcmVsaWVzIG9uIGl0IGFuZCB0aGUNCgkvLyBnbG9iYWwgbWF5IG5vdCBleGlzdCB3aXRoIEFNRCBhbmQgYSBjdXN0b20gYnVpbGQgKCMxMDE5OSkNCglqUXVlcnkgPSAkOw0KDQokLmVmZmVjdHMgPSB7DQoJZWZmZWN0OiB7fQ0KfTsNCg0KLyohDQogKiBqUXVlcnkgQ29sb3IgQW5pbWF0aW9ucyB2Mi4xLjINCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LWNvbG9yDQogKg0KICogQ29weXJpZ2h0IDIwMTQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICoNCiAqIERhdGU6IFdlZCBKYW4gMTYgMDg6NDc6MDkgMjAxMyAtMDYwMA0KICovDQooIGZ1bmN0aW9uKCBqUXVlcnksIHVuZGVmaW5lZCApIHsNCg0KCXZhciBzdGVwSG9va3MgPSAiYmFja2dyb3VuZENvbG9yIGJvcmRlckJvdHRvbUNvbG9yIGJvcmRlckxlZnRDb2xvciBib3JkZXJSaWdodENvbG9yICIgKw0KCQkiYm9yZGVyVG9wQ29sb3IgY29sb3IgY29sdW1uUnVsZUNvbG9yIG91dGxpbmVDb2xvciB0ZXh0RGVjb3JhdGlvbkNvbG9yIHRleHRFbXBoYXNpc0NvbG9yIiwNCg0KCS8vIFBsdXNlcXVhbHMgdGVzdCBmb3IgKz0gMTAwIC09IDEwMA0KCXJwbHVzZXF1YWxzID0gL14oW1wtK10pPVxzKihcZCtcLj9cZCopLywNCg0KCS8vIEEgc2V0IG9mIFJFJ3MgdGhhdCBjYW4gbWF0Y2ggc3RyaW5ncyBhbmQgZ2VuZXJhdGUgY29sb3IgdHVwbGVzLg0KCXN0cmluZ1BhcnNlcnMgPSBbIHsNCgkJCXJlOiAvcmdiYT9cKFxzKihcZHsxLDN9KVxzKixccyooXGR7MSwzfSlccyosXHMqKFxkezEsM30pXHMqKD86LFxzKihcZD8oPzpcLlxkKyk\/KVxzKik\/XCkvLA0KCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgew0KCQkJCXJldHVybiBbDQoJCQkJCWV4ZWNSZXN1bHRbIDEgXSwNCgkJCQkJZXhlY1Jlc3VsdFsgMiBdLA0KCQkJCQlleGVjUmVzdWx0WyAzIF0sDQoJCQkJCWV4ZWNSZXN1bHRbIDQgXQ0KCQkJCV07DQoJCQl9DQoJCX0sIHsNCgkJCXJlOiAvcmdiYT9cKFxzKihcZCsoPzpcLlxkKyk\/KVwlXHMqLFxzKihcZCsoPzpcLlxkKyk\/KVwlXHMqLFxzKihcZCsoPzpcLlxkKyk\/KVwlXHMqKD86LFxzKihcZD8oPzpcLlxkKyk\/KVxzKik\/XCkvLA0KCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgew0KCQkJCXJldHVybiBbDQoJCQkJCWV4ZWNSZXN1bHRbIDEgXSAqIDIuNTUsDQoJCQkJCWV4ZWNSZXN1bHRbIDIgXSAqIDIuNTUsDQoJCQkJCWV4ZWNSZXN1bHRbIDMgXSAqIDIuNTUsDQoJCQkJCWV4ZWNSZXN1bHRbIDQgXQ0KCQkJCV07DQoJCQl9DQoJCX0sIHsNCg0KCQkJLy8gVGhpcyByZWdleCBpZ25vcmVzIEEtRiBiZWNhdXNlIGl0J3MgY29tcGFyZWQgYWdhaW5zdCBhbiBhbHJlYWR5IGxvd2VyY2FzZWQgc3RyaW5nDQoJCQlyZTogLyMoW2EtZjAtOV17Mn0pKFthLWYwLTldezJ9KShbYS1mMC05XXsyfSkvLA0KCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgew0KCQkJCXJldHVybiBbDQoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAxIF0sIDE2ICksDQoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAyIF0sIDE2ICksDQoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAzIF0sIDE2ICkNCgkJCQldOw0KCQkJfQ0KCQl9LCB7DQoNCgkJCS8vIFRoaXMgcmVnZXggaWdub3JlcyBBLUYgYmVjYXVzZSBpdCdzIGNvbXBhcmVkIGFnYWluc3QgYW4gYWxyZWFkeSBsb3dlcmNhc2VkIHN0cmluZw0KCQkJcmU6IC8jKFthLWYwLTldKShbYS1mMC05XSkoW2EtZjAtOV0pLywNCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsNCgkJCQlyZXR1cm4gWw0KCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMSBdICsgZXhlY1Jlc3VsdFsgMSBdLCAxNiApLA0KCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMiBdICsgZXhlY1Jlc3VsdFsgMiBdLCAxNiApLA0KCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMyBdICsgZXhlY1Jlc3VsdFsgMyBdLCAxNiApDQoJCQkJXTsNCgkJCX0NCgkJfSwgew0KCQkJcmU6IC9oc2xhP1woXHMqKFxkKyg\/OlwuXGQrKT8pXHMqLFxzKihcZCsoPzpcLlxkKyk\/KVwlXHMqLFxzKihcZCsoPzpcLlxkKyk\/KVwlXHMqKD86LFxzKihcZD8oPzpcLlxkKyk\/KVxzKik\/XCkvLA0KCQkJc3BhY2U6ICJoc2xhIiwNCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsNCgkJCQlyZXR1cm4gWw0KCQkJCQlleGVjUmVzdWx0WyAxIF0sDQoJCQkJCWV4ZWNSZXN1bHRbIDIgXSAvIDEwMCwNCgkJCQkJZXhlY1Jlc3VsdFsgMyBdIC8gMTAwLA0KCQkJCQlleGVjUmVzdWx0WyA0IF0NCgkJCQldOw0KCQkJfQ0KCQl9IF0sDQoNCgkvLyBKUXVlcnkuQ29sb3IoICkNCgljb2xvciA9IGpRdWVyeS5Db2xvciA9IGZ1bmN0aW9uKCBjb2xvciwgZ3JlZW4sIGJsdWUsIGFscGhhICkgew0KCQlyZXR1cm4gbmV3IGpRdWVyeS5Db2xvci5mbi5wYXJzZSggY29sb3IsIGdyZWVuLCBibHVlLCBhbHBoYSApOw0KCX0sDQoJc3BhY2VzID0gew0KCQlyZ2JhOiB7DQoJCQlwcm9wczogew0KCQkJCXJlZDogew0KCQkJCQlpZHg6IDAsDQoJCQkJCXR5cGU6ICJieXRlIg0KCQkJCX0sDQoJCQkJZ3JlZW46IHsNCgkJCQkJaWR4OiAxLA0KCQkJCQl0eXBlOiAiYnl0ZSINCgkJCQl9LA0KCQkJCWJsdWU6IHsNCgkJCQkJaWR4OiAyLA0KCQkJCQl0eXBlOiAiYnl0ZSINCgkJCQl9DQoJCQl9DQoJCX0sDQoNCgkJaHNsYTogew0KCQkJcHJvcHM6IHsNCgkJCQlodWU6IHsNCgkJCQkJaWR4OiAwLA0KCQkJCQl0eXBlOiAiZGVncmVlcyINCgkJCQl9LA0KCQkJCXNhdHVyYXRpb246IHsNCgkJCQkJaWR4OiAxLA0KCQkJCQl0eXBlOiAicGVyY2VudCINCgkJCQl9LA0KCQkJCWxpZ2h0bmVzczogew0KCQkJCQlpZHg6IDIsDQoJCQkJCXR5cGU6ICJwZXJjZW50Ig0KCQkJCX0NCgkJCX0NCgkJfQ0KCX0sDQoJcHJvcFR5cGVzID0gew0KCQkiYnl0ZSI6IHsNCgkJCWZsb29yOiB0cnVlLA0KCQkJbWF4OiAyNTUNCgkJfSwNCgkJInBlcmNlbnQiOiB7DQoJCQltYXg6IDENCgkJfSwNCgkJImRlZ3JlZXMiOiB7DQoJCQltb2Q6IDM2MCwNCgkJCWZsb29yOiB0cnVlDQoJCX0NCgl9LA0KCXN1cHBvcnQgPSBjb2xvci5zdXBwb3J0ID0ge30sDQoNCgkvLyBFbGVtZW50IGZvciBzdXBwb3J0IHRlc3RzDQoJc3VwcG9ydEVsZW0gPSBqUXVlcnkoICI8cD4iIClbIDAgXSwNCg0KCS8vIENvbG9ycyA9IGpRdWVyeS5Db2xvci5uYW1lcw0KCWNvbG9ycywNCg0KCS8vIExvY2FsIGFsaWFzZXMgb2YgZnVuY3Rpb25zIGNhbGxlZCBvZnRlbg0KCWVhY2ggPSBqUXVlcnkuZWFjaDsNCg0KLy8gRGV0ZXJtaW5lIHJnYmEgc3VwcG9ydCBpbW1lZGlhdGVseQ0Kc3VwcG9ydEVsZW0uc3R5bGUuY3NzVGV4dCA9ICJiYWNrZ3JvdW5kLWNvbG9yOnJnYmEoMSwxLDEsLjUpIjsNCnN1cHBvcnQucmdiYSA9IHN1cHBvcnRFbGVtLnN0eWxlLmJhY2tncm91bmRDb2xvci5pbmRleE9mKCAicmdiYSIgKSA+IC0xOw0KDQovLyBEZWZpbmUgY2FjaGUgbmFtZSBhbmQgYWxwaGEgcHJvcGVydGllcw0KLy8gZm9yIHJnYmEgYW5kIGhzbGEgc3BhY2VzDQplYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgew0KCXNwYWNlLmNhY2hlID0gIl8iICsgc3BhY2VOYW1lOw0KCXNwYWNlLnByb3BzLmFscGhhID0gew0KCQlpZHg6IDMsDQoJCXR5cGU6ICJwZXJjZW50IiwNCgkJZGVmOiAxDQoJfTsNCn0gKTsNCg0KZnVuY3Rpb24gY2xhbXAoIHZhbHVlLCBwcm9wLCBhbGxvd0VtcHR5ICkgew0KCXZhciB0eXBlID0gcHJvcFR5cGVzWyBwcm9wLnR5cGUgXSB8fCB7fTsNCg0KCWlmICggdmFsdWUgPT0gbnVsbCApIHsNCgkJcmV0dXJuICggYWxsb3dFbXB0eSB8fCAhcHJvcC5kZWYgKSA\/IG51bGwgOiBwcm9wLmRlZjsNCgl9DQoNCgkvLyB+fiBpcyBhbiBzaG9ydCB3YXkgb2YgZG9pbmcgZmxvb3IgZm9yIHBvc2l0aXZlIG51bWJlcnMNCgl2YWx1ZSA9IHR5cGUuZmxvb3IgPyB+fnZhbHVlIDogcGFyc2VGbG9hdCggdmFsdWUgKTsNCg0KCS8vIElFIHdpbGwgcGFzcyBpbiBlbXB0eSBzdHJpbmdzIGFzIHZhbHVlIGZvciBhbHBoYSwNCgkvLyB3aGljaCB3aWxsIGhpdCB0aGlzIGNhc2UNCglpZiAoIGlzTmFOKCB2YWx1ZSApICkgew0KCQlyZXR1cm4gcHJvcC5kZWY7DQoJfQ0KDQoJaWYgKCB0eXBlLm1vZCApIHsNCg0KCQkvLyBXZSBhZGQgbW9kIGJlZm9yZSBtb2RkaW5nIHRvIG1ha2Ugc3VyZSB0aGF0IG5lZ2F0aXZlcyB2YWx1ZXMNCgkJLy8gZ2V0IGNvbnZlcnRlZCBwcm9wZXJseTogLTEwIC0+IDM1MA0KCQlyZXR1cm4gKCB2YWx1ZSArIHR5cGUubW9kICkgJSB0eXBlLm1vZDsNCgl9DQoNCgkvLyBGb3Igbm93IGFsbCBwcm9wZXJ0eSB0eXBlcyB3aXRob3V0IG1vZCBoYXZlIG1pbiBhbmQgbWF4DQoJcmV0dXJuIDAgPiB2YWx1ZSA\/IDAgOiB0eXBlLm1heCA8IHZhbHVlID8gdHlwZS5tYXggOiB2YWx1ZTsNCn0NCg0KZnVuY3Rpb24gc3RyaW5nUGFyc2UoIHN0cmluZyApIHsNCgl2YXIgaW5zdCA9IGNvbG9yKCksDQoJCXJnYmEgPSBpbnN0Ll9yZ2JhID0gW107DQoNCglzdHJpbmcgPSBzdHJpbmcudG9Mb3dlckNhc2UoKTsNCg0KCWVhY2goIHN0cmluZ1BhcnNlcnMsIGZ1bmN0aW9uKCBpLCBwYXJzZXIgKSB7DQoJCXZhciBwYXJzZWQsDQoJCQltYXRjaCA9IHBhcnNlci5yZS5leGVjKCBzdHJpbmcgKSwNCgkJCXZhbHVlcyA9IG1hdGNoICYmIHBhcnNlci5wYXJzZSggbWF0Y2ggKSwNCgkJCXNwYWNlTmFtZSA9IHBhcnNlci5zcGFjZSB8fCAicmdiYSI7DQoNCgkJaWYgKCB2YWx1ZXMgKSB7DQoJCQlwYXJzZWQgPSBpbnN0WyBzcGFjZU5hbWUgXSggdmFsdWVzICk7DQoNCgkJCS8vIElmIHRoaXMgd2FzIGFuIHJnYmEgcGFyc2UgdGhlIGFzc2lnbm1lbnQgbWlnaHQgaGFwcGVuIHR3aWNlDQoJCQkvLyBvaCB3ZWxsLi4uLg0KCQkJaW5zdFsgc3BhY2VzWyBzcGFjZU5hbWUgXS5jYWNoZSBdID0gcGFyc2VkWyBzcGFjZXNbIHNwYWNlTmFtZSBdLmNhY2hlIF07DQoJCQlyZ2JhID0gaW5zdC5fcmdiYSA9IHBhcnNlZC5fcmdiYTsNCg0KCQkJLy8gRXhpdCBlYWNoKCBzdHJpbmdQYXJzZXJzICkgaGVyZSBiZWNhdXNlIHdlIG1hdGNoZWQNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KCX0gKTsNCg0KCS8vIEZvdW5kIGEgc3RyaW5nUGFyc2VyIHRoYXQgaGFuZGxlZCBpdA0KCWlmICggcmdiYS5sZW5ndGggKSB7DQoNCgkJLy8gSWYgdGhpcyBjYW1lIGZyb20gYSBwYXJzZWQgc3RyaW5nLCBmb3JjZSAidHJhbnNwYXJlbnQiIHdoZW4gYWxwaGEgaXMgMA0KCQkvLyBjaHJvbWUsIChhbmQgbWF5YmUgb3RoZXJzKSByZXR1cm4gInRyYW5zcGFyZW50IiBhcyByZ2JhKDAsMCwwLDApDQoJCWlmICggcmdiYS5qb2luKCkgPT09ICIwLDAsMCwwIiApIHsNCgkJCWpRdWVyeS5leHRlbmQoIHJnYmEsIGNvbG9ycy50cmFuc3BhcmVudCApOw0KCQl9DQoJCXJldHVybiBpbnN0Ow0KCX0NCg0KCS8vIE5hbWVkIGNvbG9ycw0KCXJldHVybiBjb2xvcnNbIHN0cmluZyBdOw0KfQ0KDQpjb2xvci5mbiA9IGpRdWVyeS5leHRlbmQoIGNvbG9yLnByb3RvdHlwZSwgew0KCXBhcnNlOiBmdW5jdGlvbiggcmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEgKSB7DQoJCWlmICggcmVkID09PSB1bmRlZmluZWQgKSB7DQoJCQl0aGlzLl9yZ2JhID0gWyBudWxsLCBudWxsLCBudWxsLCBudWxsIF07DQoJCQlyZXR1cm4gdGhpczsNCgkJfQ0KCQlpZiAoIHJlZC5qcXVlcnkgfHwgcmVkLm5vZGVUeXBlICkgew0KCQkJcmVkID0galF1ZXJ5KCByZWQgKS5jc3MoIGdyZWVuICk7DQoJCQlncmVlbiA9IHVuZGVmaW5lZDsNCgkJfQ0KDQoJCXZhciBpbnN0ID0gdGhpcywNCgkJCXR5cGUgPSBqUXVlcnkudHlwZSggcmVkICksDQoJCQlyZ2JhID0gdGhpcy5fcmdiYSA9IFtdOw0KDQoJCS8vIE1vcmUgdGhhbiAxIGFyZ3VtZW50IHNwZWNpZmllZCAtIGFzc3VtZSAoIHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhICkNCgkJaWYgKCBncmVlbiAhPT0gdW5kZWZpbmVkICkgew0KCQkJcmVkID0gWyByZWQsIGdyZWVuLCBibHVlLCBhbHBoYSBdOw0KCQkJdHlwZSA9ICJhcnJheSI7DQoJCX0NCg0KCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICkgew0KCQkJcmV0dXJuIHRoaXMucGFyc2UoIHN0cmluZ1BhcnNlKCByZWQgKSB8fCBjb2xvcnMuX2RlZmF1bHQgKTsNCgkJfQ0KDQoJCWlmICggdHlwZSA9PT0gImFycmF5IiApIHsNCgkJCWVhY2goIHNwYWNlcy5yZ2JhLnByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgew0KCQkJCXJnYmFbIHByb3AuaWR4IF0gPSBjbGFtcCggcmVkWyBwcm9wLmlkeCBdLCBwcm9wICk7DQoJCQl9ICk7DQoJCQlyZXR1cm4gdGhpczsNCgkJfQ0KDQoJCWlmICggdHlwZSA9PT0gIm9iamVjdCIgKSB7DQoJCQlpZiAoIHJlZCBpbnN0YW5jZW9mIGNvbG9yICkgew0KCQkJCWVhY2goIHNwYWNlcywgZnVuY3Rpb24oIHNwYWNlTmFtZSwgc3BhY2UgKSB7DQoJCQkJCWlmICggcmVkWyBzcGFjZS5jYWNoZSBdICkgew0KCQkJCQkJaW5zdFsgc3BhY2UuY2FjaGUgXSA9IHJlZFsgc3BhY2UuY2FjaGUgXS5zbGljZSgpOw0KCQkJCQl9DQoJCQkJfSApOw0KCQkJfSBlbHNlIHsNCgkJCQllYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgew0KCQkJCQl2YXIgY2FjaGUgPSBzcGFjZS5jYWNoZTsNCgkJCQkJZWFjaCggc3BhY2UucHJvcHMsIGZ1bmN0aW9uKCBrZXksIHByb3AgKSB7DQoNCgkJCQkJCS8vIElmIHRoZSBjYWNoZSBkb2Vzbid0IGV4aXN0LCBhbmQgd2Uga25vdyBob3cgdG8gY29udmVydA0KCQkJCQkJaWYgKCAhaW5zdFsgY2FjaGUgXSAmJiBzcGFjZS50byApIHsNCg0KCQkJCQkJCS8vIElmIHRoZSB2YWx1ZSB3YXMgbnVsbCwgd2UgZG9uJ3QgbmVlZCB0byBjb3B5IGl0DQoJCQkJCQkJLy8gaWYgdGhlIGtleSB3YXMgYWxwaGEsIHdlIGRvbid0IG5lZWQgdG8gY29weSBpdCBlaXRoZXINCgkJCQkJCQlpZiAoIGtleSA9PT0gImFscGhhIiB8fCByZWRbIGtleSBdID09IG51bGwgKSB7DQoJCQkJCQkJCXJldHVybjsNCgkJCQkJCQl9DQoJCQkJCQkJaW5zdFsgY2FjaGUgXSA9IHNwYWNlLnRvKCBpbnN0Ll9yZ2JhICk7DQoJCQkJCQl9DQoNCgkJCQkJCS8vIFRoaXMgaXMgdGhlIG9ubHkgY2FzZSB3aGVyZSB3ZSBhbGxvdyBudWxscyBmb3IgQUxMIHByb3BlcnRpZXMuDQoJCQkJCQkvLyBjYWxsIGNsYW1wIHdpdGggYWx3YXlzQWxsb3dFbXB0eQ0KCQkJCQkJaW5zdFsgY2FjaGUgXVsgcHJvcC5pZHggXSA9IGNsYW1wKCByZWRbIGtleSBdLCBwcm9wLCB0cnVlICk7DQoJCQkJCX0gKTsNCg0KCQkJCQkvLyBFdmVyeXRoaW5nIGRlZmluZWQgYnV0IGFscGhhPw0KCQkJCQlpZiAoIGluc3RbIGNhY2hlIF0gJiYNCgkJCQkJCQlqUXVlcnkuaW5BcnJheSggbnVsbCwgaW5zdFsgY2FjaGUgXS5zbGljZSggMCwgMyApICkgPCAwICkgew0KDQoJCQkJCQkvLyBVc2UgdGhlIGRlZmF1bHQgb2YgMQ0KCQkJCQkJaW5zdFsgY2FjaGUgXVsgMyBdID0gMTsNCgkJCQkJCWlmICggc3BhY2UuZnJvbSApIHsNCgkJCQkJCQlpbnN0Ll9yZ2JhID0gc3BhY2UuZnJvbSggaW5zdFsgY2FjaGUgXSApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfSApOw0KCQkJfQ0KCQkJcmV0dXJuIHRoaXM7DQoJCX0NCgl9LA0KCWlzOiBmdW5jdGlvbiggY29tcGFyZSApIHsNCgkJdmFyIGlzID0gY29sb3IoIGNvbXBhcmUgKSwNCgkJCXNhbWUgPSB0cnVlLA0KCQkJaW5zdCA9IHRoaXM7DQoNCgkJZWFjaCggc3BhY2VzLCBmdW5jdGlvbiggXywgc3BhY2UgKSB7DQoJCQl2YXIgbG9jYWxDYWNoZSwNCgkJCQlpc0NhY2hlID0gaXNbIHNwYWNlLmNhY2hlIF07DQoJCQlpZiAoIGlzQ2FjaGUgKSB7DQoJCQkJbG9jYWxDYWNoZSA9IGluc3RbIHNwYWNlLmNhY2hlIF0gfHwgc3BhY2UudG8gJiYgc3BhY2UudG8oIGluc3QuX3JnYmEgKSB8fCBbXTsNCgkJCQllYWNoKCBzcGFjZS5wcm9wcywgZnVuY3Rpb24oIF8sIHByb3AgKSB7DQoJCQkJCWlmICggaXNDYWNoZVsgcHJvcC5pZHggXSAhPSBudWxsICkgew0KCQkJCQkJc2FtZSA9ICggaXNDYWNoZVsgcHJvcC5pZHggXSA9PT0gbG9jYWxDYWNoZVsgcHJvcC5pZHggXSApOw0KCQkJCQkJcmV0dXJuIHNhbWU7DQoJCQkJCX0NCgkJCQl9ICk7DQoJCQl9DQoJCQlyZXR1cm4gc2FtZTsNCgkJfSApOw0KCQlyZXR1cm4gc2FtZTsNCgl9LA0KCV9zcGFjZTogZnVuY3Rpb24oKSB7DQoJCXZhciB1c2VkID0gW10sDQoJCQlpbnN0ID0gdGhpczsNCgkJZWFjaCggc3BhY2VzLCBmdW5jdGlvbiggc3BhY2VOYW1lLCBzcGFjZSApIHsNCgkJCWlmICggaW5zdFsgc3BhY2UuY2FjaGUgXSApIHsNCgkJCQl1c2VkLnB1c2goIHNwYWNlTmFtZSApOw0KCQkJfQ0KCQl9ICk7DQoJCXJldHVybiB1c2VkLnBvcCgpOw0KCX0sDQoJdHJhbnNpdGlvbjogZnVuY3Rpb24oIG90aGVyLCBkaXN0YW5jZSApIHsNCgkJdmFyIGVuZCA9IGNvbG9yKCBvdGhlciApLA0KCQkJc3BhY2VOYW1lID0gZW5kLl9zcGFjZSgpLA0KCQkJc3BhY2UgPSBzcGFjZXNbIHNwYWNlTmFtZSBdLA0KCQkJc3RhcnRDb2xvciA9IHRoaXMuYWxwaGEoKSA9PT0gMCA\/IGNvbG9yKCAidHJhbnNwYXJlbnQiICkgOiB0aGlzLA0KCQkJc3RhcnQgPSBzdGFydENvbG9yWyBzcGFjZS5jYWNoZSBdIHx8IHNwYWNlLnRvKCBzdGFydENvbG9yLl9yZ2JhICksDQoJCQlyZXN1bHQgPSBzdGFydC5zbGljZSgpOw0KDQoJCWVuZCA9IGVuZFsgc3BhY2UuY2FjaGUgXTsNCgkJZWFjaCggc3BhY2UucHJvcHMsIGZ1bmN0aW9uKCBrZXksIHByb3AgKSB7DQoJCQl2YXIgaW5kZXggPSBwcm9wLmlkeCwNCgkJCQlzdGFydFZhbHVlID0gc3RhcnRbIGluZGV4IF0sDQoJCQkJZW5kVmFsdWUgPSBlbmRbIGluZGV4IF0sDQoJCQkJdHlwZSA9IHByb3BUeXBlc1sgcHJvcC50eXBlIF0gfHwge307DQoNCgkJCS8vIElmIG51bGwsIGRvbid0IG92ZXJyaWRlIHN0YXJ0IHZhbHVlDQoJCQlpZiAoIGVuZFZhbHVlID09PSBudWxsICkgew0KCQkJCXJldHVybjsNCgkJCX0NCg0KCQkJLy8gSWYgbnVsbCAtIHVzZSBlbmQNCgkJCWlmICggc3RhcnRWYWx1ZSA9PT0gbnVsbCApIHsNCgkJCQlyZXN1bHRbIGluZGV4IF0gPSBlbmRWYWx1ZTsNCgkJCX0gZWxzZSB7DQoJCQkJaWYgKCB0eXBlLm1vZCApIHsNCgkJCQkJaWYgKCBlbmRWYWx1ZSAtIHN0YXJ0VmFsdWUgPiB0eXBlLm1vZCAvIDIgKSB7DQoJCQkJCQlzdGFydFZhbHVlICs9IHR5cGUubW9kOw0KCQkJCQl9IGVsc2UgaWYgKCBzdGFydFZhbHVlIC0gZW5kVmFsdWUgPiB0eXBlLm1vZCAvIDIgKSB7DQoJCQkJCQlzdGFydFZhbHVlIC09IHR5cGUubW9kOw0KCQkJCQl9DQoJCQkJfQ0KCQkJCXJlc3VsdFsgaW5kZXggXSA9IGNsYW1wKCAoIGVuZFZhbHVlIC0gc3RhcnRWYWx1ZSApICogZGlzdGFuY2UgKyBzdGFydFZhbHVlLCBwcm9wICk7DQoJCQl9DQoJCX0gKTsNCgkJcmV0dXJuIHRoaXNbIHNwYWNlTmFtZSBdKCByZXN1bHQgKTsNCgl9LA0KCWJsZW5kOiBmdW5jdGlvbiggb3BhcXVlICkgew0KDQoJCS8vIElmIHdlIGFyZSBhbHJlYWR5IG9wYXF1ZSAtIHJldHVybiBvdXJzZWxmDQoJCWlmICggdGhpcy5fcmdiYVsgMyBdID09PSAxICkgew0KCQkJcmV0dXJuIHRoaXM7DQoJCX0NCg0KCQl2YXIgcmdiID0gdGhpcy5fcmdiYS5zbGljZSgpLA0KCQkJYSA9IHJnYi5wb3AoKSwNCgkJCWJsZW5kID0gY29sb3IoIG9wYXF1ZSApLl9yZ2JhOw0KDQoJCXJldHVybiBjb2xvciggalF1ZXJ5Lm1hcCggcmdiLCBmdW5jdGlvbiggdiwgaSApIHsNCgkJCXJldHVybiAoIDEgLSBhICkgKiBibGVuZFsgaSBdICsgYSAqIHY7DQoJCX0gKSApOw0KCX0sDQoJdG9SZ2JhU3RyaW5nOiBmdW5jdGlvbigpIHsNCgkJdmFyIHByZWZpeCA9ICJyZ2JhKCIsDQoJCQlyZ2JhID0galF1ZXJ5Lm1hcCggdGhpcy5fcmdiYSwgZnVuY3Rpb24oIHYsIGkgKSB7DQoJCQkJcmV0dXJuIHYgPT0gbnVsbCA\/ICggaSA+IDIgPyAxIDogMCApIDogdjsNCgkJCX0gKTsNCg0KCQlpZiAoIHJnYmFbIDMgXSA9PT0gMSApIHsNCgkJCXJnYmEucG9wKCk7DQoJCQlwcmVmaXggPSAicmdiKCI7DQoJCX0NCg0KCQlyZXR1cm4gcHJlZml4ICsgcmdiYS5qb2luKCkgKyAiKSI7DQoJfSwNCgl0b0hzbGFTdHJpbmc6IGZ1bmN0aW9uKCkgew0KCQl2YXIgcHJlZml4ID0gImhzbGEoIiwNCgkJCWhzbGEgPSBqUXVlcnkubWFwKCB0aGlzLmhzbGEoKSwgZnVuY3Rpb24oIHYsIGkgKSB7DQoJCQkJaWYgKCB2ID09IG51bGwgKSB7DQoJCQkJCXYgPSBpID4gMiA\/IDEgOiAwOw0KCQkJCX0NCg0KCQkJCS8vIENhdGNoIDEgYW5kIDINCgkJCQlpZiAoIGkgJiYgaSA8IDMgKSB7DQoJCQkJCXYgPSBNYXRoLnJvdW5kKCB2ICogMTAwICkgKyAiJSI7DQoJCQkJfQ0KCQkJCXJldHVybiB2Ow0KCQkJfSApOw0KDQoJCWlmICggaHNsYVsgMyBdID09PSAxICkgew0KCQkJaHNsYS5wb3AoKTsNCgkJCXByZWZpeCA9ICJoc2woIjsNCgkJfQ0KCQlyZXR1cm4gcHJlZml4ICsgaHNsYS5qb2luKCkgKyAiKSI7DQoJfSwNCgl0b0hleFN0cmluZzogZnVuY3Rpb24oIGluY2x1ZGVBbHBoYSApIHsNCgkJdmFyIHJnYmEgPSB0aGlzLl9yZ2JhLnNsaWNlKCksDQoJCQlhbHBoYSA9IHJnYmEucG9wKCk7DQoNCgkJaWYgKCBpbmNsdWRlQWxwaGEgKSB7DQoJCQlyZ2JhLnB1c2goIH5+KCBhbHBoYSAqIDI1NSApICk7DQoJCX0NCg0KCQlyZXR1cm4gIiMiICsgalF1ZXJ5Lm1hcCggcmdiYSwgZnVuY3Rpb24oIHYgKSB7DQoNCgkJCS8vIERlZmF1bHQgdG8gMCB3aGVuIG51bGxzIGV4aXN0DQoJCQl2ID0gKCB2IHx8IDAgKS50b1N0cmluZyggMTYgKTsNCgkJCXJldHVybiB2Lmxlbmd0aCA9PT0gMSA\/ICIwIiArIHYgOiB2Ow0KCQl9ICkuam9pbiggIiIgKTsNCgl9LA0KCXRvU3RyaW5nOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMuX3JnYmFbIDMgXSA9PT0gMCA\/ICJ0cmFuc3BhcmVudCIgOiB0aGlzLnRvUmdiYVN0cmluZygpOw0KCX0NCn0gKTsNCmNvbG9yLmZuLnBhcnNlLnByb3RvdHlwZSA9IGNvbG9yLmZuOw0KDQovLyBIc2xhIGNvbnZlcnNpb25zIGFkYXB0ZWQgZnJvbToNCi8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvbWFhc2hhYWNrL3NvdXJjZS9icm93c2UvcGFja2FnZXMvZ3JhcGhpY3MvdHJ1bmsvc3JjL2dyYXBoaWNzL2NvbG9ycy9IVUUyUkdCLmFzP3I9NTAyMQ0KDQpmdW5jdGlvbiBodWUycmdiKCBwLCBxLCBoICkgew0KCWggPSAoIGggKyAxICkgJSAxOw0KCWlmICggaCAqIDYgPCAxICkgew0KCQlyZXR1cm4gcCArICggcSAtIHAgKSAqIGggKiA2Ow0KCX0NCglpZiAoIGggKiAyIDwgMSApIHsNCgkJcmV0dXJuIHE7DQoJfQ0KCWlmICggaCAqIDMgPCAyICkgew0KCQlyZXR1cm4gcCArICggcSAtIHAgKSAqICggKCAyIC8gMyApIC0gaCApICogNjsNCgl9DQoJcmV0dXJuIHA7DQp9DQoNCnNwYWNlcy5oc2xhLnRvID0gZnVuY3Rpb24oIHJnYmEgKSB7DQoJaWYgKCByZ2JhWyAwIF0gPT0gbnVsbCB8fCByZ2JhWyAxIF0gPT0gbnVsbCB8fCByZ2JhWyAyIF0gPT0gbnVsbCApIHsNCgkJcmV0dXJuIFsgbnVsbCwgbnVsbCwgbnVsbCwgcmdiYVsgMyBdIF07DQoJfQ0KCXZhciByID0gcmdiYVsgMCBdIC8gMjU1LA0KCQlnID0gcmdiYVsgMSBdIC8gMjU1LA0KCQliID0gcmdiYVsgMiBdIC8gMjU1LA0KCQlhID0gcmdiYVsgMyBdLA0KCQltYXggPSBNYXRoLm1heCggciwgZywgYiApLA0KCQltaW4gPSBNYXRoLm1pbiggciwgZywgYiApLA0KCQlkaWZmID0gbWF4IC0gbWluLA0KCQlhZGQgPSBtYXggKyBtaW4sDQoJCWwgPSBhZGQgKiAwLjUsDQoJCWgsIHM7DQoNCglpZiAoIG1pbiA9PT0gbWF4ICkgew0KCQloID0gMDsNCgl9IGVsc2UgaWYgKCByID09PSBtYXggKSB7DQoJCWggPSAoIDYwICogKCBnIC0gYiApIC8gZGlmZiApICsgMzYwOw0KCX0gZWxzZSBpZiAoIGcgPT09IG1heCApIHsNCgkJaCA9ICggNjAgKiAoIGIgLSByICkgLyBkaWZmICkgKyAxMjA7DQoJfSBlbHNlIHsNCgkJaCA9ICggNjAgKiAoIHIgLSBnICkgLyBkaWZmICkgKyAyNDA7DQoJfQ0KDQoJLy8gQ2hyb21hIChkaWZmKSA9PSAwIG1lYW5zIGdyZXlzY2FsZSB3aGljaCwgYnkgZGVmaW5pdGlvbiwgc2F0dXJhdGlvbiA9IDAlDQoJLy8gb3RoZXJ3aXNlLCBzYXR1cmF0aW9uIGlzIGJhc2VkIG9uIHRoZSByYXRpbyBvZiBjaHJvbWEgKGRpZmYpIHRvIGxpZ2h0bmVzcyAoYWRkKQ0KCWlmICggZGlmZiA9PT0gMCApIHsNCgkJcyA9IDA7DQoJfSBlbHNlIGlmICggbCA8PSAwLjUgKSB7DQoJCXMgPSBkaWZmIC8gYWRkOw0KCX0gZWxzZSB7DQoJCXMgPSBkaWZmIC8gKCAyIC0gYWRkICk7DQoJfQ0KCXJldHVybiBbIE1hdGgucm91bmQoIGggKSAlIDM2MCwgcywgbCwgYSA9PSBudWxsID8gMSA6IGEgXTsNCn07DQoNCnNwYWNlcy5oc2xhLmZyb20gPSBmdW5jdGlvbiggaHNsYSApIHsNCglpZiAoIGhzbGFbIDAgXSA9PSBudWxsIHx8IGhzbGFbIDEgXSA9PSBudWxsIHx8IGhzbGFbIDIgXSA9PSBudWxsICkgew0KCQlyZXR1cm4gWyBudWxsLCBudWxsLCBudWxsLCBoc2xhWyAzIF0gXTsNCgl9DQoJdmFyIGggPSBoc2xhWyAwIF0gLyAzNjAsDQoJCXMgPSBoc2xhWyAxIF0sDQoJCWwgPSBoc2xhWyAyIF0sDQoJCWEgPSBoc2xhWyAzIF0sDQoJCXEgPSBsIDw9IDAuNSA\/IGwgKiAoIDEgKyBzICkgOiBsICsgcyAtIGwgKiBzLA0KCQlwID0gMiAqIGwgLSBxOw0KDQoJcmV0dXJuIFsNCgkJTWF0aC5yb3VuZCggaHVlMnJnYiggcCwgcSwgaCArICggMSAvIDMgKSApICogMjU1ICksDQoJCU1hdGgucm91bmQoIGh1ZTJyZ2IoIHAsIHEsIGggKSAqIDI1NSApLA0KCQlNYXRoLnJvdW5kKCBodWUycmdiKCBwLCBxLCBoIC0gKCAxIC8gMyApICkgKiAyNTUgKSwNCgkJYQ0KCV07DQp9Ow0KDQplYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgew0KCXZhciBwcm9wcyA9IHNwYWNlLnByb3BzLA0KCQljYWNoZSA9IHNwYWNlLmNhY2hlLA0KCQl0byA9IHNwYWNlLnRvLA0KCQlmcm9tID0gc3BhY2UuZnJvbTsNCg0KCS8vIE1ha2VzIHJnYmEoKSBhbmQgaHNsYSgpDQoJY29sb3IuZm5bIHNwYWNlTmFtZSBdID0gZnVuY3Rpb24oIHZhbHVlICkgew0KDQoJCS8vIEdlbmVyYXRlIGEgY2FjaGUgZm9yIHRoaXMgc3BhY2UgaWYgaXQgZG9lc24ndCBleGlzdA0KCQlpZiAoIHRvICYmICF0aGlzWyBjYWNoZSBdICkgew0KCQkJdGhpc1sgY2FjaGUgXSA9IHRvKCB0aGlzLl9yZ2JhICk7DQoJCX0NCgkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgew0KCQkJcmV0dXJuIHRoaXNbIGNhY2hlIF0uc2xpY2UoKTsNCgkJfQ0KDQoJCXZhciByZXQsDQoJCQl0eXBlID0galF1ZXJ5LnR5cGUoIHZhbHVlICksDQoJCQlhcnIgPSAoIHR5cGUgPT09ICJhcnJheSIgfHwgdHlwZSA9PT0gIm9iamVjdCIgKSA\/IHZhbHVlIDogYXJndW1lbnRzLA0KCQkJbG9jYWwgPSB0aGlzWyBjYWNoZSBdLnNsaWNlKCk7DQoNCgkJZWFjaCggcHJvcHMsIGZ1bmN0aW9uKCBrZXksIHByb3AgKSB7DQoJCQl2YXIgdmFsID0gYXJyWyB0eXBlID09PSAib2JqZWN0IiA\/IGtleSA6IHByb3AuaWR4IF07DQoJCQlpZiAoIHZhbCA9PSBudWxsICkgew0KCQkJCXZhbCA9IGxvY2FsWyBwcm9wLmlkeCBdOw0KCQkJfQ0KCQkJbG9jYWxbIHByb3AuaWR4IF0gPSBjbGFtcCggdmFsLCBwcm9wICk7DQoJCX0gKTsNCg0KCQlpZiAoIGZyb20gKSB7DQoJCQlyZXQgPSBjb2xvciggZnJvbSggbG9jYWwgKSApOw0KCQkJcmV0WyBjYWNoZSBdID0gbG9jYWw7DQoJCQlyZXR1cm4gcmV0Ow0KCQl9IGVsc2Ugew0KCQkJcmV0dXJuIGNvbG9yKCBsb2NhbCApOw0KCQl9DQoJfTsNCg0KCS8vIE1ha2VzIHJlZCgpIGdyZWVuKCkgYmx1ZSgpIGFscGhhKCkgaHVlKCkgc2F0dXJhdGlvbigpIGxpZ2h0bmVzcygpDQoJZWFjaCggcHJvcHMsIGZ1bmN0aW9uKCBrZXksIHByb3AgKSB7DQoNCgkJLy8gQWxwaGEgaXMgaW5jbHVkZWQgaW4gbW9yZSB0aGFuIG9uZSBzcGFjZQ0KCQlpZiAoIGNvbG9yLmZuWyBrZXkgXSApIHsNCgkJCXJldHVybjsNCgkJfQ0KCQljb2xvci5mblsga2V5IF0gPSBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCQl2YXIgdnR5cGUgPSBqUXVlcnkudHlwZSggdmFsdWUgKSwNCgkJCQlmbiA9ICgga2V5ID09PSAiYWxwaGEiID8gKCB0aGlzLl9oc2xhID8gImhzbGEiIDogInJnYmEiICkgOiBzcGFjZU5hbWUgKSwNCgkJCQlsb2NhbCA9IHRoaXNbIGZuIF0oKSwNCgkJCQljdXIgPSBsb2NhbFsgcHJvcC5pZHggXSwNCgkJCQltYXRjaDsNCg0KCQkJaWYgKCB2dHlwZSA9PT0gInVuZGVmaW5lZCIgKSB7DQoJCQkJcmV0dXJuIGN1cjsNCgkJCX0NCg0KCQkJaWYgKCB2dHlwZSA9PT0gImZ1bmN0aW9uIiApIHsNCgkJCQl2YWx1ZSA9IHZhbHVlLmNhbGwoIHRoaXMsIGN1ciApOw0KCQkJCXZ0eXBlID0galF1ZXJ5LnR5cGUoIHZhbHVlICk7DQoJCQl9DQoJCQlpZiAoIHZhbHVlID09IG51bGwgJiYgcHJvcC5lbXB0eSApIHsNCgkJCQlyZXR1cm4gdGhpczsNCgkJCX0NCgkJCWlmICggdnR5cGUgPT09ICJzdHJpbmciICkgew0KCQkJCW1hdGNoID0gcnBsdXNlcXVhbHMuZXhlYyggdmFsdWUgKTsNCgkJCQlpZiAoIG1hdGNoICkgew0KCQkJCQl2YWx1ZSA9IGN1ciArIHBhcnNlRmxvYXQoIG1hdGNoWyAyIF0gKSAqICggbWF0Y2hbIDEgXSA9PT0gIisiID8gMSA6IC0xICk7DQoJCQkJfQ0KCQkJfQ0KCQkJbG9jYWxbIHByb3AuaWR4IF0gPSB2YWx1ZTsNCgkJCXJldHVybiB0aGlzWyBmbiBdKCBsb2NhbCApOw0KCQl9Ow0KCX0gKTsNCn0gKTsNCg0KLy8gQWRkIGNzc0hvb2sgYW5kIC5meC5zdGVwIGZ1bmN0aW9uIGZvciBlYWNoIG5hbWVkIGhvb2suDQovLyBhY2NlcHQgYSBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG9mIHByb3BlcnRpZXMNCmNvbG9yLmhvb2sgPSBmdW5jdGlvbiggaG9vayApIHsNCgl2YXIgaG9va3MgPSBob29rLnNwbGl0KCAiICIgKTsNCgllYWNoKCBob29rcywgZnVuY3Rpb24oIGksIGhvb2sgKSB7DQoJCWpRdWVyeS5jc3NIb29rc1sgaG9vayBdID0gew0KCQkJc2V0OiBmdW5jdGlvbiggZWxlbSwgdmFsdWUgKSB7DQoJCQkJdmFyIHBhcnNlZCwgY3VyRWxlbSwNCgkJCQkJYmFja2dyb3VuZENvbG9yID0gIiI7DQoNCgkJCQlpZiAoIHZhbHVlICE9PSAidHJhbnNwYXJlbnQiICYmICggalF1ZXJ5LnR5cGUoIHZhbHVlICkgIT09ICJzdHJpbmciIHx8DQoJCQkJCQkoIHBhcnNlZCA9IHN0cmluZ1BhcnNlKCB2YWx1ZSApICkgKSApIHsNCgkJCQkJdmFsdWUgPSBjb2xvciggcGFyc2VkIHx8IHZhbHVlICk7DQoJCQkJCWlmICggIXN1cHBvcnQucmdiYSAmJiB2YWx1ZS5fcmdiYVsgMyBdICE9PSAxICkgew0KCQkJCQkJY3VyRWxlbSA9IGhvb2sgPT09ICJiYWNrZ3JvdW5kQ29sb3IiID8gZWxlbS5wYXJlbnROb2RlIDogZWxlbTsNCgkJCQkJCXdoaWxlICgNCgkJCQkJCQkoIGJhY2tncm91bmRDb2xvciA9PT0gIiIgfHwgYmFja2dyb3VuZENvbG9yID09PSAidHJhbnNwYXJlbnQiICkgJiYNCgkJCQkJCQljdXJFbGVtICYmIGN1ckVsZW0uc3R5bGUNCgkJCQkJCSkgew0KCQkJCQkJCXRyeSB7DQoJCQkJCQkJCWJhY2tncm91bmRDb2xvciA9IGpRdWVyeS5jc3MoIGN1ckVsZW0sICJiYWNrZ3JvdW5kQ29sb3IiICk7DQoJCQkJCQkJCWN1ckVsZW0gPSBjdXJFbGVtLnBhcmVudE5vZGU7DQoJCQkJCQkJfSBjYXRjaCAoIGUgKSB7DQoJCQkJCQkJfQ0KCQkJCQkJfQ0KDQoJCQkJCQl2YWx1ZSA9IHZhbHVlLmJsZW5kKCBiYWNrZ3JvdW5kQ29sb3IgJiYgYmFja2dyb3VuZENvbG9yICE9PSAidHJhbnNwYXJlbnQiID8NCgkJCQkJCQliYWNrZ3JvdW5kQ29sb3IgOg0KCQkJCQkJCSJfZGVmYXVsdCIgKTsNCgkJCQkJfQ0KDQoJCQkJCXZhbHVlID0gdmFsdWUudG9SZ2JhU3RyaW5nKCk7DQoJCQkJfQ0KCQkJCXRyeSB7DQoJCQkJCWVsZW0uc3R5bGVbIGhvb2sgXSA9IHZhbHVlOw0KCQkJCX0gY2F0Y2ggKCBlICkgew0KDQoJCQkJCS8vIFdyYXBwZWQgdG8gcHJldmVudCBJRSBmcm9tIHRocm93aW5nIGVycm9ycyBvbiAiaW52YWxpZCIgdmFsdWVzIGxpa2UNCgkJCQkJLy8gJ2F1dG8nIG9yICdpbmhlcml0Jw0KCQkJCX0NCgkJCX0NCgkJfTsNCgkJalF1ZXJ5LmZ4LnN0ZXBbIGhvb2sgXSA9IGZ1bmN0aW9uKCBmeCApIHsNCgkJCWlmICggIWZ4LmNvbG9ySW5pdCApIHsNCgkJCQlmeC5zdGFydCA9IGNvbG9yKCBmeC5lbGVtLCBob29rICk7DQoJCQkJZnguZW5kID0gY29sb3IoIGZ4LmVuZCApOw0KCQkJCWZ4LmNvbG9ySW5pdCA9IHRydWU7DQoJCQl9DQoJCQlqUXVlcnkuY3NzSG9va3NbIGhvb2sgXS5zZXQoIGZ4LmVsZW0sIGZ4LnN0YXJ0LnRyYW5zaXRpb24oIGZ4LmVuZCwgZngucG9zICkgKTsNCgkJfTsNCgl9ICk7DQoNCn07DQoNCmNvbG9yLmhvb2soIHN0ZXBIb29rcyApOw0KDQpqUXVlcnkuY3NzSG9va3MuYm9yZGVyQ29sb3IgPSB7DQoJZXhwYW5kOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCXZhciBleHBhbmRlZCA9IHt9Ow0KDQoJCWVhY2goIFsgIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCIgXSwgZnVuY3Rpb24oIGksIHBhcnQgKSB7DQoJCQlleHBhbmRlZFsgImJvcmRlciIgKyBwYXJ0ICsgIkNvbG9yIiBdID0gdmFsdWU7DQoJCX0gKTsNCgkJcmV0dXJuIGV4cGFuZGVkOw0KCX0NCn07DQoNCi8vIEJhc2ljIGNvbG9yIG5hbWVzIG9ubHkuDQovLyBVc2FnZSBvZiBhbnkgb2YgdGhlIG90aGVyIGNvbG9yIG5hbWVzIHJlcXVpcmVzIGFkZGluZyB5b3Vyc2VsZiBvciBpbmNsdWRpbmcNCi8vIGpxdWVyeS5jb2xvci5zdmctbmFtZXMuanMuDQpjb2xvcnMgPSBqUXVlcnkuQ29sb3IubmFtZXMgPSB7DQoNCgkvLyA0LjEuIEJhc2ljIGNvbG9yIGtleXdvcmRzDQoJYXF1YTogIiMwMGZmZmYiLA0KCWJsYWNrOiAiIzAwMDAwMCIsDQoJYmx1ZTogIiMwMDAwZmYiLA0KCWZ1Y2hzaWE6ICIjZmYwMGZmIiwNCglncmF5OiAiIzgwODA4MCIsDQoJZ3JlZW46ICIjMDA4MDAwIiwNCglsaW1lOiAiIzAwZmYwMCIsDQoJbWFyb29uOiAiIzgwMDAwMCIsDQoJbmF2eTogIiMwMDAwODAiLA0KCW9saXZlOiAiIzgwODAwMCIsDQoJcHVycGxlOiAiIzgwMDA4MCIsDQoJcmVkOiAiI2ZmMDAwMCIsDQoJc2lsdmVyOiAiI2MwYzBjMCIsDQoJdGVhbDogIiMwMDgwODAiLA0KCXdoaXRlOiAiI2ZmZmZmZiIsDQoJeWVsbG93OiAiI2ZmZmYwMCIsDQoNCgkvLyA0LjIuMy4gInRyYW5zcGFyZW50IiBjb2xvciBrZXl3b3JkDQoJdHJhbnNwYXJlbnQ6IFsgbnVsbCwgbnVsbCwgbnVsbCwgMCBdLA0KDQoJX2RlZmF1bHQ6ICIjZmZmZmZmIg0KfTsNCg0KfSApKCBqUXVlcnkgKTsNCg0KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8NCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogQ0xBU1MgQU5JTUFUSU9OUyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovDQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLw0KKCBmdW5jdGlvbigpIHsNCg0KdmFyIGNsYXNzQW5pbWF0aW9uQWN0aW9ucyA9IFsgImFkZCIsICJyZW1vdmUiLCAidG9nZ2xlIiBdLA0KCXNob3J0aGFuZFN0eWxlcyA9IHsNCgkJYm9yZGVyOiAxLA0KCQlib3JkZXJCb3R0b206IDEsDQoJCWJvcmRlckNvbG9yOiAxLA0KCQlib3JkZXJMZWZ0OiAxLA0KCQlib3JkZXJSaWdodDogMSwNCgkJYm9yZGVyVG9wOiAxLA0KCQlib3JkZXJXaWR0aDogMSwNCgkJbWFyZ2luOiAxLA0KCQlwYWRkaW5nOiAxDQoJfTsNCg0KJC5lYWNoKA0KCVsgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJSaWdodFN0eWxlIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlclRvcFN0eWxlIiBdLA0KCWZ1bmN0aW9uKCBfLCBwcm9wICkgew0KCQkkLmZ4LnN0ZXBbIHByb3AgXSA9IGZ1bmN0aW9uKCBmeCApIHsNCgkJCWlmICggZnguZW5kICE9PSAibm9uZSIgJiYgIWZ4LnNldEF0dHIgfHwgZngucG9zID09PSAxICYmICFmeC5zZXRBdHRyICkgew0KCQkJCWpRdWVyeS5zdHlsZSggZnguZWxlbSwgcHJvcCwgZnguZW5kICk7DQoJCQkJZnguc2V0QXR0ciA9IHRydWU7DQoJCQl9DQoJCX07DQoJfQ0KKTsNCg0KZnVuY3Rpb24gZ2V0RWxlbWVudFN0eWxlcyggZWxlbSApIHsNCgl2YXIga2V5LCBsZW4sDQoJCXN0eWxlID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3ID8NCgkJCWVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICkgOg0KCQkJZWxlbS5jdXJyZW50U3R5bGUsDQoJCXN0eWxlcyA9IHt9Ow0KDQoJaWYgKCBzdHlsZSAmJiBzdHlsZS5sZW5ndGggJiYgc3R5bGVbIDAgXSAmJiBzdHlsZVsgc3R5bGVbIDAgXSBdICkgew0KCQlsZW4gPSBzdHlsZS5sZW5ndGg7DQoJCXdoaWxlICggbGVuLS0gKSB7DQoJCQlrZXkgPSBzdHlsZVsgbGVuIF07DQoJCQlpZiAoIHR5cGVvZiBzdHlsZVsga2V5IF0gPT09ICJzdHJpbmciICkgew0KCQkJCXN0eWxlc1sgJC5jYW1lbENhc2UoIGtleSApIF0gPSBzdHlsZVsga2V5IF07DQoJCQl9DQoJCX0NCg0KCS8vIFN1cHBvcnQ6IE9wZXJhLCBJRSA8OQ0KCX0gZWxzZSB7DQoJCWZvciAoIGtleSBpbiBzdHlsZSApIHsNCgkJCWlmICggdHlwZW9mIHN0eWxlWyBrZXkgXSA9PT0gInN0cmluZyIgKSB7DQoJCQkJc3R5bGVzWyBrZXkgXSA9IHN0eWxlWyBrZXkgXTsNCgkJCX0NCgkJfQ0KCX0NCg0KCXJldHVybiBzdHlsZXM7DQp9DQoNCmZ1bmN0aW9uIHN0eWxlRGlmZmVyZW5jZSggb2xkU3R5bGUsIG5ld1N0eWxlICkgew0KCXZhciBkaWZmID0ge30sDQoJCW5hbWUsIHZhbHVlOw0KDQoJZm9yICggbmFtZSBpbiBuZXdTdHlsZSApIHsNCgkJdmFsdWUgPSBuZXdTdHlsZVsgbmFtZSBdOw0KCQlpZiAoIG9sZFN0eWxlWyBuYW1lIF0gIT09IHZhbHVlICkgew0KCQkJaWYgKCAhc2hvcnRoYW5kU3R5bGVzWyBuYW1lIF0gKSB7DQoJCQkJaWYgKCAkLmZ4LnN0ZXBbIG5hbWUgXSB8fCAhaXNOYU4oIHBhcnNlRmxvYXQoIHZhbHVlICkgKSApIHsNCgkJCQkJZGlmZlsgbmFtZSBdID0gdmFsdWU7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJfQ0KDQoJcmV0dXJuIGRpZmY7DQp9DQoNCi8vIFN1cHBvcnQ6IGpRdWVyeSA8MS44DQppZiAoICEkLmZuLmFkZEJhY2sgKSB7DQoJJC5mbi5hZGRCYWNrID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgew0KCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPw0KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQ0KCQkpOw0KCX07DQp9DQoNCiQuZWZmZWN0cy5hbmltYXRlQ2xhc3MgPSBmdW5jdGlvbiggdmFsdWUsIGR1cmF0aW9uLCBlYXNpbmcsIGNhbGxiYWNrICkgew0KCXZhciBvID0gJC5zcGVlZCggZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2sgKTsNCg0KCXJldHVybiB0aGlzLnF1ZXVlKCBmdW5jdGlvbigpIHsNCgkJdmFyIGFuaW1hdGVkID0gJCggdGhpcyApLA0KCQkJYmFzZUNsYXNzID0gYW5pbWF0ZWQuYXR0ciggImNsYXNzIiApIHx8ICIiLA0KCQkJYXBwbHlDbGFzc0NoYW5nZSwNCgkJCWFsbEFuaW1hdGlvbnMgPSBvLmNoaWxkcmVuID8gYW5pbWF0ZWQuZmluZCggIioiICkuYWRkQmFjaygpIDogYW5pbWF0ZWQ7DQoNCgkJLy8gTWFwIHRoZSBhbmltYXRlZCBvYmplY3RzIHRvIHN0b3JlIHRoZSBvcmlnaW5hbCBzdHlsZXMuDQoJCWFsbEFuaW1hdGlvbnMgPSBhbGxBbmltYXRpb25zLm1hcCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgZWwgPSAkKCB0aGlzICk7DQoJCQlyZXR1cm4gew0KCQkJCWVsOiBlbCwNCgkJCQlzdGFydDogZ2V0RWxlbWVudFN0eWxlcyggdGhpcyApDQoJCQl9Ow0KCQl9ICk7DQoNCgkJLy8gQXBwbHkgY2xhc3MgY2hhbmdlDQoJCWFwcGx5Q2xhc3NDaGFuZ2UgPSBmdW5jdGlvbigpIHsNCgkJCSQuZWFjaCggY2xhc3NBbmltYXRpb25BY3Rpb25zLCBmdW5jdGlvbiggaSwgYWN0aW9uICkgew0KCQkJCWlmICggdmFsdWVbIGFjdGlvbiBdICkgew0KCQkJCQlhbmltYXRlZFsgYWN0aW9uICsgIkNsYXNzIiBdKCB2YWx1ZVsgYWN0aW9uIF0gKTsNCgkJCQl9DQoJCQl9ICk7DQoJCX07DQoJCWFwcGx5Q2xhc3NDaGFuZ2UoKTsNCg0KCQkvLyBNYXAgYWxsIGFuaW1hdGVkIG9iamVjdHMgYWdhaW4gLSBjYWxjdWxhdGUgbmV3IHN0eWxlcyBhbmQgZGlmZg0KCQlhbGxBbmltYXRpb25zID0gYWxsQW5pbWF0aW9ucy5tYXAoIGZ1bmN0aW9uKCkgew0KCQkJdGhpcy5lbmQgPSBnZXRFbGVtZW50U3R5bGVzKCB0aGlzLmVsWyAwIF0gKTsNCgkJCXRoaXMuZGlmZiA9IHN0eWxlRGlmZmVyZW5jZSggdGhpcy5zdGFydCwgdGhpcy5lbmQgKTsNCgkJCXJldHVybiB0aGlzOw0KCQl9ICk7DQoNCgkJLy8gQXBwbHkgb3JpZ2luYWwgY2xhc3MNCgkJYW5pbWF0ZWQuYXR0ciggImNsYXNzIiwgYmFzZUNsYXNzICk7DQoNCgkJLy8gTWFwIGFsbCBhbmltYXRlZCBvYmplY3RzIGFnYWluIC0gdGhpcyB0aW1lIGNvbGxlY3RpbmcgYSBwcm9taXNlDQoJCWFsbEFuaW1hdGlvbnMgPSBhbGxBbmltYXRpb25zLm1hcCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgc3R5bGVJbmZvID0gdGhpcywNCgkJCQlkZmQgPSAkLkRlZmVycmVkKCksDQoJCQkJb3B0cyA9ICQuZXh0ZW5kKCB7fSwgbywgew0KCQkJCQlxdWV1ZTogZmFsc2UsDQoJCQkJCWNvbXBsZXRlOiBmdW5jdGlvbigpIHsNCgkJCQkJCWRmZC5yZXNvbHZlKCBzdHlsZUluZm8gKTsNCgkJCQkJfQ0KCQkJCX0gKTsNCg0KCQkJdGhpcy5lbC5hbmltYXRlKCB0aGlzLmRpZmYsIG9wdHMgKTsNCgkJCXJldHVybiBkZmQucHJvbWlzZSgpOw0KCQl9ICk7DQoNCgkJLy8gT25jZSBhbGwgYW5pbWF0aW9ucyBoYXZlIGNvbXBsZXRlZDoNCgkJJC53aGVuLmFwcGx5KCAkLCBhbGxBbmltYXRpb25zLmdldCgpICkuZG9uZSggZnVuY3Rpb24oKSB7DQoNCgkJCS8vIFNldCB0aGUgZmluYWwgY2xhc3MNCgkJCWFwcGx5Q2xhc3NDaGFuZ2UoKTsNCg0KCQkJLy8gRm9yIGVhY2ggYW5pbWF0ZWQgZWxlbWVudCwNCgkJCS8vIGNsZWFyIGFsbCBjc3MgcHJvcGVydGllcyB0aGF0IHdlcmUgYW5pbWF0ZWQNCgkJCSQuZWFjaCggYXJndW1lbnRzLCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgZWwgPSB0aGlzLmVsOw0KCQkJCSQuZWFjaCggdGhpcy5kaWZmLCBmdW5jdGlvbigga2V5ICkgew0KCQkJCQllbC5jc3MoIGtleSwgIiIgKTsNCgkJCQl9ICk7DQoJCQl9ICk7DQoNCgkJCS8vIFRoaXMgaXMgZ3Vhcm50ZWVkIHRvIGJlIHRoZXJlIGlmIHlvdSB1c2UgalF1ZXJ5LnNwZWVkKCkNCgkJCS8vIGl0IGFsc28gaGFuZGxlcyBkZXF1ZXVpbmcgdGhlIG5leHQgYW5pbS4uLg0KCQkJby5jb21wbGV0ZS5jYWxsKCBhbmltYXRlZFsgMCBdICk7DQoJCX0gKTsNCgl9ICk7DQp9Ow0KDQokLmZuLmV4dGVuZCggew0KCWFkZENsYXNzOiAoIGZ1bmN0aW9uKCBvcmlnICkgew0KCQlyZXR1cm4gZnVuY3Rpb24oIGNsYXNzTmFtZXMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgew0KCQkJcmV0dXJuIHNwZWVkID8NCgkJCQkkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsDQoJCQkJCXsgYWRkOiBjbGFzc05hbWVzIH0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgOg0KCQkJCW9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQl9Ow0KCX0gKSggJC5mbi5hZGRDbGFzcyApLA0KDQoJcmVtb3ZlQ2xhc3M6ICggZnVuY3Rpb24oIG9yaWcgKSB7DQoJCXJldHVybiBmdW5jdGlvbiggY2xhc3NOYW1lcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7DQoJCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgPw0KCQkJCSQuZWZmZWN0cy5hbmltYXRlQ2xhc3MuY2FsbCggdGhpcywNCgkJCQkJeyByZW1vdmU6IGNsYXNzTmFtZXMgfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSA6DQoJCQkJb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7DQoJCX07DQoJfSApKCAkLmZuLnJlbW92ZUNsYXNzICksDQoNCgl0b2dnbGVDbGFzczogKCBmdW5jdGlvbiggb3JpZyApIHsNCgkJcmV0dXJuIGZ1bmN0aW9uKCBjbGFzc05hbWVzLCBmb3JjZSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7DQoJCQlpZiAoIHR5cGVvZiBmb3JjZSA9PT0gImJvb2xlYW4iIHx8IGZvcmNlID09PSB1bmRlZmluZWQgKSB7DQoJCQkJaWYgKCAhc3BlZWQgKSB7DQoNCgkJCQkJLy8gV2l0aG91dCBzcGVlZCBwYXJhbWV0ZXINCgkJCQkJcmV0dXJuIG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXJldHVybiAkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsDQoJCQkJCQkoIGZvcmNlID8geyBhZGQ6IGNsYXNzTmFtZXMgfSA6IHsgcmVtb3ZlOiBjbGFzc05hbWVzIH0gKSwNCgkJCQkJCXNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCg0KCQkJCS8vIFdpdGhvdXQgZm9yY2UgcGFyYW1ldGVyDQoJCQkJcmV0dXJuICQuZWZmZWN0cy5hbmltYXRlQ2xhc3MuY2FsbCggdGhpcywNCgkJCQkJeyB0b2dnbGU6IGNsYXNzTmFtZXMgfSwgZm9yY2UsIHNwZWVkLCBlYXNpbmcgKTsNCgkJCX0NCgkJfTsNCgl9ICkoICQuZm4udG9nZ2xlQ2xhc3MgKSwNCg0KCXN3aXRjaENsYXNzOiBmdW5jdGlvbiggcmVtb3ZlLCBhZGQsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgew0KCQlyZXR1cm4gJC5lZmZlY3RzLmFuaW1hdGVDbGFzcy5jYWxsKCB0aGlzLCB7DQoJCQlhZGQ6IGFkZCwNCgkJCXJlbW92ZTogcmVtb3ZlDQoJCX0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7DQoJfQ0KfSApOw0KDQp9ICkoKTsNCg0KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8NCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiBFRkZFQ1RTICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovDQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLw0KDQooIGZ1bmN0aW9uKCkgew0KDQppZiAoICQuZXhwciAmJiAkLmV4cHIuZmlsdGVycyAmJiAkLmV4cHIuZmlsdGVycy5hbmltYXRlZCApIHsNCgkkLmV4cHIuZmlsdGVycy5hbmltYXRlZCA9ICggZnVuY3Rpb24oIG9yaWcgKSB7DQoJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsNCgkJCXJldHVybiAhISQoIGVsZW0gKS5kYXRhKCBkYXRhU3BhY2VBbmltYXRlZCApIHx8IG9yaWcoIGVsZW0gKTsNCgkJfTsNCgl9ICkoICQuZXhwci5maWx0ZXJzLmFuaW1hdGVkICk7DQp9DQoNCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgew0KCSQuZXh0ZW5kKCAkLmVmZmVjdHMsIHsNCg0KCQkvLyBTYXZlcyBhIHNldCBvZiBwcm9wZXJ0aWVzIGluIGEgZGF0YSBzdG9yYWdlDQoJCXNhdmU6IGZ1bmN0aW9uKCBlbGVtZW50LCBzZXQgKSB7DQoJCQl2YXIgaSA9IDAsIGxlbmd0aCA9IHNldC5sZW5ndGg7DQoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsNCgkJCQlpZiAoIHNldFsgaSBdICE9PSBudWxsICkgew0KCQkJCQllbGVtZW50LmRhdGEoIGRhdGFTcGFjZSArIHNldFsgaSBdLCBlbGVtZW50WyAwIF0uc3R5bGVbIHNldFsgaSBdIF0gKTsNCgkJCQl9DQoJCQl9DQoJCX0sDQoNCgkJLy8gUmVzdG9yZXMgYSBzZXQgb2YgcHJldmlvdXNseSBzYXZlZCBwcm9wZXJ0aWVzIGZyb20gYSBkYXRhIHN0b3JhZ2UNCgkJcmVzdG9yZTogZnVuY3Rpb24oIGVsZW1lbnQsIHNldCApIHsNCgkJCXZhciB2YWwsIGkgPSAwLCBsZW5ndGggPSBzZXQubGVuZ3RoOw0KCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7DQoJCQkJaWYgKCBzZXRbIGkgXSAhPT0gbnVsbCApIHsNCgkJCQkJdmFsID0gZWxlbWVudC5kYXRhKCBkYXRhU3BhY2UgKyBzZXRbIGkgXSApOw0KCQkJCQllbGVtZW50LmNzcyggc2V0WyBpIF0sIHZhbCApOw0KCQkJCX0NCgkJCX0NCgkJfSwNCg0KCQlzZXRNb2RlOiBmdW5jdGlvbiggZWwsIG1vZGUgKSB7DQoJCQlpZiAoIG1vZGUgPT09ICJ0b2dnbGUiICkgew0KCQkJCW1vZGUgPSBlbC5pcyggIjpoaWRkZW4iICkgPyAic2hvdyIgOiAiaGlkZSI7DQoJCQl9DQoJCQlyZXR1cm4gbW9kZTsNCgkJfSwNCg0KCQkvLyBXcmFwcyB0aGUgZWxlbWVudCBhcm91bmQgYSB3cmFwcGVyIHRoYXQgY29waWVzIHBvc2l0aW9uIHByb3BlcnRpZXMNCgkJY3JlYXRlV3JhcHBlcjogZnVuY3Rpb24oIGVsZW1lbnQgKSB7DQoNCgkJCS8vIElmIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgd3JhcHBlZCwgcmV0dXJuIGl0DQoJCQlpZiAoIGVsZW1lbnQucGFyZW50KCkuaXMoICIudWktZWZmZWN0cy13cmFwcGVyIiApICkgew0KCQkJCXJldHVybiBlbGVtZW50LnBhcmVudCgpOw0KCQkJfQ0KDQoJCQkvLyBXcmFwIHRoZSBlbGVtZW50DQoJCQl2YXIgcHJvcHMgPSB7DQoJCQkJCXdpZHRoOiBlbGVtZW50Lm91dGVyV2lkdGgoIHRydWUgKSwNCgkJCQkJaGVpZ2h0OiBlbGVtZW50Lm91dGVySGVpZ2h0KCB0cnVlICksDQoJCQkJCSJmbG9hdCI6IGVsZW1lbnQuY3NzKCAiZmxvYXQiICkNCgkJCQl9LA0KCQkJCXdyYXBwZXIgPSAkKCAiPGRpdj48L2Rpdj4iICkNCgkJCQkJLmFkZENsYXNzKCAidWktZWZmZWN0cy13cmFwcGVyIiApDQoJCQkJCS5jc3MoIHsNCgkJCQkJCWZvbnRTaXplOiAiMTAwJSIsDQoJCQkJCQliYWNrZ3JvdW5kOiAidHJhbnNwYXJlbnQiLA0KCQkJCQkJYm9yZGVyOiAibm9uZSIsDQoJCQkJCQltYXJnaW46IDAsDQoJCQkJCQlwYWRkaW5nOiAwDQoJCQkJCX0gKSwNCg0KCQkJCS8vIFN0b3JlIHRoZSBzaXplIGluIGNhc2Ugd2lkdGgvaGVpZ2h0IGFyZSBkZWZpbmVkIGluICUgLSBGaXhlcyAjNTI0NQ0KCQkJCXNpemUgPSB7DQoJCQkJCXdpZHRoOiBlbGVtZW50LndpZHRoKCksDQoJCQkJCWhlaWdodDogZWxlbWVudC5oZWlnaHQoKQ0KCQkJCX0sDQoJCQkJYWN0aXZlID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsNCg0KCQkJLy8gU3VwcG9ydDogRmlyZWZveA0KCQkJLy8gRmlyZWZveCBpbmNvcnJlY3RseSBleHBvc2VzIGFub255bW91cyBjb250ZW50DQoJCQkvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD01NjE2NjQNCgkJCXRyeSB7DQoJCQkJYWN0aXZlLmlkOw0KCQkJfSBjYXRjaCAoIGUgKSB7DQoJCQkJYWN0aXZlID0gZG9jdW1lbnQuYm9keTsNCgkJCX0NCg0KCQkJZWxlbWVudC53cmFwKCB3cmFwcGVyICk7DQoNCgkJCS8vIEZpeGVzICM3NTk1IC0gRWxlbWVudHMgbG9zZSBmb2N1cyB3aGVuIHdyYXBwZWQuDQoJCQlpZiAoIGVsZW1lbnRbIDAgXSA9PT0gYWN0aXZlIHx8ICQuY29udGFpbnMoIGVsZW1lbnRbIDAgXSwgYWN0aXZlICkgKSB7DQoJCQkJJCggYWN0aXZlICkudHJpZ2dlciggImZvY3VzIiApOw0KCQkJfQ0KDQoJCQkvLyBIb3RmaXggZm9yIGpRdWVyeSAxLjQgc2luY2Ugc29tZSBjaGFuZ2UgaW4gd3JhcCgpIHNlZW1zIHRvIGFjdHVhbGx5DQoJCQkvLyBsb3NlIHRoZSByZWZlcmVuY2UgdG8gdGhlIHdyYXBwZWQgZWxlbWVudA0KCQkJd3JhcHBlciA9IGVsZW1lbnQucGFyZW50KCk7DQoNCgkJCS8vIFRyYW5zZmVyIHBvc2l0aW9uaW5nIHByb3BlcnRpZXMgdG8gdGhlIHdyYXBwZXINCgkJCWlmICggZWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSA9PT0gInN0YXRpYyIgKSB7DQoJCQkJd3JhcHBlci5jc3MoIHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSApOw0KCQkJCWVsZW1lbnQuY3NzKCB7IHBvc2l0aW9uOiAicmVsYXRpdmUiIH0gKTsNCgkJCX0gZWxzZSB7DQoJCQkJJC5leHRlbmQoIHByb3BzLCB7DQoJCQkJCXBvc2l0aW9uOiBlbGVtZW50LmNzcyggInBvc2l0aW9uIiApLA0KCQkJCQl6SW5kZXg6IGVsZW1lbnQuY3NzKCAiei1pbmRleCIgKQ0KCQkJCX0gKTsNCgkJCQkkLmVhY2goIFsgInRvcCIsICJsZWZ0IiwgImJvdHRvbSIsICJyaWdodCIgXSwgZnVuY3Rpb24oIGksIHBvcyApIHsNCgkJCQkJcHJvcHNbIHBvcyBdID0gZWxlbWVudC5jc3MoIHBvcyApOw0KCQkJCQlpZiAoIGlzTmFOKCBwYXJzZUludCggcHJvcHNbIHBvcyBdLCAxMCApICkgKSB7DQoJCQkJCQlwcm9wc1sgcG9zIF0gPSAiYXV0byI7DQoJCQkJCX0NCgkJCQl9ICk7DQoJCQkJZWxlbWVudC5jc3MoIHsNCgkJCQkJcG9zaXRpb246ICJyZWxhdGl2ZSIsDQoJCQkJCXRvcDogMCwNCgkJCQkJbGVmdDogMCwNCgkJCQkJcmlnaHQ6ICJhdXRvIiwNCgkJCQkJYm90dG9tOiAiYXV0byINCgkJCQl9ICk7DQoJCQl9DQoJCQllbGVtZW50LmNzcyggc2l6ZSApOw0KDQoJCQlyZXR1cm4gd3JhcHBlci5jc3MoIHByb3BzICkuc2hvdygpOw0KCQl9LA0KDQoJCXJlbW92ZVdyYXBwZXI6IGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQkJdmFyIGFjdGl2ZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7DQoNCgkJCWlmICggZWxlbWVudC5wYXJlbnQoKS5pcyggIi51aS1lZmZlY3RzLXdyYXBwZXIiICkgKSB7DQoJCQkJZWxlbWVudC5wYXJlbnQoKS5yZXBsYWNlV2l0aCggZWxlbWVudCApOw0KDQoJCQkJLy8gRml4ZXMgIzc1OTUgLSBFbGVtZW50cyBsb3NlIGZvY3VzIHdoZW4gd3JhcHBlZC4NCgkJCQlpZiAoIGVsZW1lbnRbIDAgXSA9PT0gYWN0aXZlIHx8ICQuY29udGFpbnMoIGVsZW1lbnRbIDAgXSwgYWN0aXZlICkgKSB7DQoJCQkJCSQoIGFjdGl2ZSApLnRyaWdnZXIoICJmb2N1cyIgKTsNCgkJCQl9DQoJCQl9DQoNCgkJCXJldHVybiBlbGVtZW50Ow0KCQl9DQoJfSApOw0KfQ0KDQokLmV4dGVuZCggJC5lZmZlY3RzLCB7DQoJdmVyc2lvbjogIjEuMTIuMSIsDQoNCglkZWZpbmU6IGZ1bmN0aW9uKCBuYW1lLCBtb2RlLCBlZmZlY3QgKSB7DQoJCWlmICggIWVmZmVjdCApIHsNCgkJCWVmZmVjdCA9IG1vZGU7DQoJCQltb2RlID0gImVmZmVjdCI7DQoJCX0NCg0KCQkkLmVmZmVjdHMuZWZmZWN0WyBuYW1lIF0gPSBlZmZlY3Q7DQoJCSQuZWZmZWN0cy5lZmZlY3RbIG5hbWUgXS5tb2RlID0gbW9kZTsNCg0KCQlyZXR1cm4gZWZmZWN0Ow0KCX0sDQoNCglzY2FsZWREaW1lbnNpb25zOiBmdW5jdGlvbiggZWxlbWVudCwgcGVyY2VudCwgZGlyZWN0aW9uICkgew0KCQlpZiAoIHBlcmNlbnQgPT09IDAgKSB7DQoJCQlyZXR1cm4gew0KCQkJCWhlaWdodDogMCwNCgkJCQl3aWR0aDogMCwNCgkJCQlvdXRlckhlaWdodDogMCwNCgkJCQlvdXRlcldpZHRoOiAwDQoJCQl9Ow0KCQl9DQoNCgkJdmFyIHggPSBkaXJlY3Rpb24gIT09ICJob3Jpem9udGFsIiA\/ICggKCBwZXJjZW50IHx8IDEwMCApIC8gMTAwICkgOiAxLA0KCQkJeSA9IGRpcmVjdGlvbiAhPT0gInZlcnRpY2FsIiA\/ICggKCBwZXJjZW50IHx8IDEwMCApIC8gMTAwICkgOiAxOw0KDQoJCXJldHVybiB7DQoJCQloZWlnaHQ6IGVsZW1lbnQuaGVpZ2h0KCkgKiB5LA0KCQkJd2lkdGg6IGVsZW1lbnQud2lkdGgoKSAqIHgsDQoJCQlvdXRlckhlaWdodDogZWxlbWVudC5vdXRlckhlaWdodCgpICogeSwNCgkJCW91dGVyV2lkdGg6IGVsZW1lbnQub3V0ZXJXaWR0aCgpICogeA0KCQl9Ow0KDQoJfSwNCg0KCWNsaXBUb0JveDogZnVuY3Rpb24oIGFuaW1hdGlvbiApIHsNCgkJcmV0dXJuIHsNCgkJCXdpZHRoOiBhbmltYXRpb24uY2xpcC5yaWdodCAtIGFuaW1hdGlvbi5jbGlwLmxlZnQsDQoJCQloZWlnaHQ6IGFuaW1hdGlvbi5jbGlwLmJvdHRvbSAtIGFuaW1hdGlvbi5jbGlwLnRvcCwNCgkJCWxlZnQ6IGFuaW1hdGlvbi5jbGlwLmxlZnQsDQoJCQl0b3A6IGFuaW1hdGlvbi5jbGlwLnRvcA0KCQl9Ow0KCX0sDQoNCgkvLyBJbmplY3RzIHJlY2VudGx5IHF1ZXVlZCBmdW5jdGlvbnMgdG8gYmUgZmlyc3QgaW4gbGluZSAoYWZ0ZXIgImlucHJvZ3Jlc3MiKQ0KCXVuc2hpZnQ6IGZ1bmN0aW9uKCBlbGVtZW50LCBxdWV1ZUxlbmd0aCwgY291bnQgKSB7DQoJCXZhciBxdWV1ZSA9IGVsZW1lbnQucXVldWUoKTsNCg0KCQlpZiAoIHF1ZXVlTGVuZ3RoID4gMSApIHsNCgkJCXF1ZXVlLnNwbGljZS5hcHBseSggcXVldWUsDQoJCQkJWyAxLCAwIF0uY29uY2F0KCBxdWV1ZS5zcGxpY2UoIHF1ZXVlTGVuZ3RoLCBjb3VudCApICkgKTsNCgkJfQ0KCQllbGVtZW50LmRlcXVldWUoKTsNCgl9LA0KDQoJc2F2ZVN0eWxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsNCgkJZWxlbWVudC5kYXRhKCBkYXRhU3BhY2VTdHlsZSwgZWxlbWVudFsgMCBdLnN0eWxlLmNzc1RleHQgKTsNCgl9LA0KDQoJcmVzdG9yZVN0eWxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsNCgkJZWxlbWVudFsgMCBdLnN0eWxlLmNzc1RleHQgPSBlbGVtZW50LmRhdGEoIGRhdGFTcGFjZVN0eWxlICkgfHwgIiI7DQoJCWVsZW1lbnQucmVtb3ZlRGF0YSggZGF0YVNwYWNlU3R5bGUgKTsNCgl9LA0KDQoJbW9kZTogZnVuY3Rpb24oIGVsZW1lbnQsIG1vZGUgKSB7DQoJCXZhciBoaWRkZW4gPSBlbGVtZW50LmlzKCAiOmhpZGRlbiIgKTsNCg0KCQlpZiAoIG1vZGUgPT09ICJ0b2dnbGUiICkgew0KCQkJbW9kZSA9IGhpZGRlbiA\/ICJzaG93IiA6ICJoaWRlIjsNCgkJfQ0KCQlpZiAoIGhpZGRlbiA\/IG1vZGUgPT09ICJoaWRlIiA6IG1vZGUgPT09ICJzaG93IiApIHsNCgkJCW1vZGUgPSAibm9uZSI7DQoJCX0NCgkJcmV0dXJuIG1vZGU7DQoJfSwNCg0KCS8vIFRyYW5zbGF0ZXMgYSBbdG9wLGxlZnRdIGFycmF5IGludG8gYSBiYXNlbGluZSB2YWx1ZQ0KCWdldEJhc2VsaW5lOiBmdW5jdGlvbiggb3JpZ2luLCBvcmlnaW5hbCApIHsNCgkJdmFyIHksIHg7DQoNCgkJc3dpdGNoICggb3JpZ2luWyAwIF0gKSB7DQoJCWNhc2UgInRvcCI6DQoJCQl5ID0gMDsNCgkJCWJyZWFrOw0KCQljYXNlICJtaWRkbGUiOg0KCQkJeSA9IDAuNTsNCgkJCWJyZWFrOw0KCQljYXNlICJib3R0b20iOg0KCQkJeSA9IDE7DQoJCQlicmVhazsNCgkJZGVmYXVsdDoNCgkJCXkgPSBvcmlnaW5bIDAgXSAvIG9yaWdpbmFsLmhlaWdodDsNCgkJfQ0KDQoJCXN3aXRjaCAoIG9yaWdpblsgMSBdICkgew0KCQljYXNlICJsZWZ0IjoNCgkJCXggPSAwOw0KCQkJYnJlYWs7DQoJCWNhc2UgImNlbnRlciI6DQoJCQl4ID0gMC41Ow0KCQkJYnJlYWs7DQoJCWNhc2UgInJpZ2h0IjoNCgkJCXggPSAxOw0KCQkJYnJlYWs7DQoJCWRlZmF1bHQ6DQoJCQl4ID0gb3JpZ2luWyAxIF0gLyBvcmlnaW5hbC53aWR0aDsNCgkJfQ0KDQoJCXJldHVybiB7DQoJCQl4OiB4LA0KCQkJeTogeQ0KCQl9Ow0KCX0sDQoNCgkvLyBDcmVhdGVzIGEgcGxhY2Vob2xkZXIgZWxlbWVudCBzbyB0aGF0IHRoZSBvcmlnaW5hbCBlbGVtZW50IGNhbiBiZSBtYWRlIGFic29sdXRlDQoJY3JlYXRlUGxhY2Vob2xkZXI6IGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQl2YXIgcGxhY2Vob2xkZXIsDQoJCQljc3NQb3NpdGlvbiA9IGVsZW1lbnQuY3NzKCAicG9zaXRpb24iICksDQoJCQlwb3NpdGlvbiA9IGVsZW1lbnQucG9zaXRpb24oKTsNCg0KCQkvLyBMb2NrIGluIG1hcmdpbnMgZmlyc3QgdG8gYWNjb3VudCBmb3IgZm9ybSBlbGVtZW50cywgd2hpY2gNCgkJLy8gd2lsbCBjaGFuZ2UgbWFyZ2luIGlmIHlvdSBleHBsaWNpdGx5IHNldCBoZWlnaHQNCgkJLy8gc2VlOiBodHRwOi8vanNmaWRkbGUubmV0L0paU010LzMvIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0xMDczODANCgkJLy8gU3VwcG9ydDogU2FmYXJpDQoJCWVsZW1lbnQuY3NzKCB7DQoJCQltYXJnaW5Ub3A6IGVsZW1lbnQuY3NzKCAibWFyZ2luVG9wIiApLA0KCQkJbWFyZ2luQm90dG9tOiBlbGVtZW50LmNzcyggIm1hcmdpbkJvdHRvbSIgKSwNCgkJCW1hcmdpbkxlZnQ6IGVsZW1lbnQuY3NzKCAibWFyZ2luTGVmdCIgKSwNCgkJCW1hcmdpblJpZ2h0OiBlbGVtZW50LmNzcyggIm1hcmdpblJpZ2h0IiApDQoJCX0gKQ0KCQkub3V0ZXJXaWR0aCggZWxlbWVudC5vdXRlcldpZHRoKCkgKQ0KCQkub3V0ZXJIZWlnaHQoIGVsZW1lbnQub3V0ZXJIZWlnaHQoKSApOw0KDQoJCWlmICggL14oc3RhdGljfHJlbGF0aXZlKS8udGVzdCggY3NzUG9zaXRpb24gKSApIHsNCgkJCWNzc1Bvc2l0aW9uID0gImFic29sdXRlIjsNCg0KCQkJcGxhY2Vob2xkZXIgPSAkKCAiPCIgKyBlbGVtZW50WyAwIF0ubm9kZU5hbWUgKyAiPiIgKS5pbnNlcnRBZnRlciggZWxlbWVudCApLmNzcyggew0KDQoJCQkJLy8gQ29udmVydCBpbmxpbmUgdG8gaW5saW5lIGJsb2NrIHRvIGFjY291bnQgZm9yIGlubGluZSBlbGVtZW50cw0KCQkJCS8vIHRoYXQgdHVybiB0byBpbmxpbmUgYmxvY2sgYmFzZWQgb24gY29udGVudCAobGlrZSBpbWcpDQoJCQkJZGlzcGxheTogL14oaW5saW5lfHJ1YnkpLy50ZXN0KCBlbGVtZW50LmNzcyggImRpc3BsYXkiICkgKSA\/DQoJCQkJCSJpbmxpbmUtYmxvY2siIDoNCgkJCQkJImJsb2NrIiwNCgkJCQl2aXNpYmlsaXR5OiAiaGlkZGVuIiwNCg0KCQkJCS8vIE1hcmdpbnMgbmVlZCB0byBiZSBzZXQgdG8gYWNjb3VudCBmb3IgbWFyZ2luIGNvbGxhcHNlDQoJCQkJbWFyZ2luVG9wOiBlbGVtZW50LmNzcyggIm1hcmdpblRvcCIgKSwNCgkJCQltYXJnaW5Cb3R0b206IGVsZW1lbnQuY3NzKCAibWFyZ2luQm90dG9tIiApLA0KCQkJCW1hcmdpbkxlZnQ6IGVsZW1lbnQuY3NzKCAibWFyZ2luTGVmdCIgKSwNCgkJCQltYXJnaW5SaWdodDogZWxlbWVudC5jc3MoICJtYXJnaW5SaWdodCIgKSwNCgkJCQkiZmxvYXQiOiBlbGVtZW50LmNzcyggImZsb2F0IiApDQoJCQl9ICkNCgkJCS5vdXRlcldpZHRoKCBlbGVtZW50Lm91dGVyV2lkdGgoKSApDQoJCQkub3V0ZXJIZWlnaHQoIGVsZW1lbnQub3V0ZXJIZWlnaHQoKSApDQoJCQkuYWRkQ2xhc3MoICJ1aS1lZmZlY3RzLXBsYWNlaG9sZGVyIiApOw0KDQoJCQllbGVtZW50LmRhdGEoIGRhdGFTcGFjZSArICJwbGFjZWhvbGRlciIsIHBsYWNlaG9sZGVyICk7DQoJCX0NCg0KCQllbGVtZW50LmNzcyggew0KCQkJcG9zaXRpb246IGNzc1Bvc2l0aW9uLA0KCQkJbGVmdDogcG9zaXRpb24ubGVmdCwNCgkJCXRvcDogcG9zaXRpb24udG9wDQoJCX0gKTsNCg0KCQlyZXR1cm4gcGxhY2Vob2xkZXI7DQoJfSwNCg0KCXJlbW92ZVBsYWNlaG9sZGVyOiBmdW5jdGlvbiggZWxlbWVudCApIHsNCgkJdmFyIGRhdGFLZXkgPSBkYXRhU3BhY2UgKyAicGxhY2Vob2xkZXIiLA0KCQkJCXBsYWNlaG9sZGVyID0gZWxlbWVudC5kYXRhKCBkYXRhS2V5ICk7DQoNCgkJaWYgKCBwbGFjZWhvbGRlciApIHsNCgkJCXBsYWNlaG9sZGVyLnJlbW92ZSgpOw0KCQkJZWxlbWVudC5yZW1vdmVEYXRhKCBkYXRhS2V5ICk7DQoJCX0NCgl9LA0KDQoJLy8gUmVtb3ZlcyBhIHBsYWNlaG9sZGVyIGlmIGl0IGV4aXN0cyBhbmQgcmVzdG9yZXMNCgkvLyBwcm9wZXJ0aWVzIHRoYXQgd2VyZSBtb2RpZmllZCBkdXJpbmcgcGxhY2Vob2xkZXIgY3JlYXRpb24NCgljbGVhblVwOiBmdW5jdGlvbiggZWxlbWVudCApIHsNCgkJJC5lZmZlY3RzLnJlc3RvcmVTdHlsZSggZWxlbWVudCApOw0KCQkkLmVmZmVjdHMucmVtb3ZlUGxhY2Vob2xkZXIoIGVsZW1lbnQgKTsNCgl9LA0KDQoJc2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oIGVsZW1lbnQsIGxpc3QsIGZhY3RvciwgdmFsdWUgKSB7DQoJCXZhbHVlID0gdmFsdWUgfHwge307DQoJCSQuZWFjaCggbGlzdCwgZnVuY3Rpb24oIGksIHggKSB7DQoJCQl2YXIgdW5pdCA9IGVsZW1lbnQuY3NzVW5pdCggeCApOw0KCQkJaWYgKCB1bml0WyAwIF0gPiAwICkgew0KCQkJCXZhbHVlWyB4IF0gPSB1bml0WyAwIF0gKiBmYWN0b3IgKyB1bml0WyAxIF07DQoJCQl9DQoJCX0gKTsNCgkJcmV0dXJuIHZhbHVlOw0KCX0NCn0gKTsNCg0KLy8gUmV0dXJuIGFuIGVmZmVjdCBvcHRpb25zIG9iamVjdCBmb3IgdGhlIGdpdmVuIHBhcmFtZXRlcnM6DQpmdW5jdGlvbiBfbm9ybWFsaXplQXJndW1lbnRzKCBlZmZlY3QsIG9wdGlvbnMsIHNwZWVkLCBjYWxsYmFjayApIHsNCg0KCS8vIEFsbG93IHBhc3NpbmcgYWxsIG9wdGlvbnMgYXMgdGhlIGZpcnN0IHBhcmFtZXRlcg0KCWlmICggJC5pc1BsYWluT2JqZWN0KCBlZmZlY3QgKSApIHsNCgkJb3B0aW9ucyA9IGVmZmVjdDsNCgkJZWZmZWN0ID0gZWZmZWN0LmVmZmVjdDsNCgl9DQoNCgkvLyBDb252ZXJ0IHRvIGFuIG9iamVjdA0KCWVmZmVjdCA9IHsgZWZmZWN0OiBlZmZlY3QgfTsNCg0KCS8vIENhdGNoIChlZmZlY3QsIG51bGwsIC4uLikNCglpZiAoIG9wdGlvbnMgPT0gbnVsbCApIHsNCgkJb3B0aW9ucyA9IHt9Ow0KCX0NCg0KCS8vIENhdGNoIChlZmZlY3QsIGNhbGxiYWNrKQ0KCWlmICggJC5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7DQoJCWNhbGxiYWNrID0gb3B0aW9uczsNCgkJc3BlZWQgPSBudWxsOw0KCQlvcHRpb25zID0ge307DQoJfQ0KDQoJLy8gQ2F0Y2ggKGVmZmVjdCwgc3BlZWQsID8pDQoJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgfHwgJC5meC5zcGVlZHNbIG9wdGlvbnMgXSApIHsNCgkJY2FsbGJhY2sgPSBzcGVlZDsNCgkJc3BlZWQgPSBvcHRpb25zOw0KCQlvcHRpb25zID0ge307DQoJfQ0KDQoJLy8gQ2F0Y2ggKGVmZmVjdCwgb3B0aW9ucywgY2FsbGJhY2spDQoJaWYgKCAkLmlzRnVuY3Rpb24oIHNwZWVkICkgKSB7DQoJCWNhbGxiYWNrID0gc3BlZWQ7DQoJCXNwZWVkID0gbnVsbDsNCgl9DQoNCgkvLyBBZGQgb3B0aW9ucyB0byBlZmZlY3QNCglpZiAoIG9wdGlvbnMgKSB7DQoJCSQuZXh0ZW5kKCBlZmZlY3QsIG9wdGlvbnMgKTsNCgl9DQoNCglzcGVlZCA9IHNwZWVkIHx8IG9wdGlvbnMuZHVyYXRpb247DQoJZWZmZWN0LmR1cmF0aW9uID0gJC5meC5vZmYgPyAwIDoNCgkJdHlwZW9mIHNwZWVkID09PSAibnVtYmVyIiA\/IHNwZWVkIDoNCgkJc3BlZWQgaW4gJC5meC5zcGVlZHMgPyAkLmZ4LnNwZWVkc1sgc3BlZWQgXSA6DQoJCSQuZnguc3BlZWRzLl9kZWZhdWx0Ow0KDQoJZWZmZWN0LmNvbXBsZXRlID0gY2FsbGJhY2sgfHwgb3B0aW9ucy5jb21wbGV0ZTsNCg0KCXJldHVybiBlZmZlY3Q7DQp9DQoNCmZ1bmN0aW9uIHN0YW5kYXJkQW5pbWF0aW9uT3B0aW9uKCBvcHRpb24gKSB7DQoNCgkvLyBWYWxpZCBzdGFuZGFyZCBzcGVlZHMgKG5vdGhpbmcsIG51bWJlciwgbmFtZWQgc3BlZWQpDQoJaWYgKCAhb3B0aW9uIHx8IHR5cGVvZiBvcHRpb24gPT09ICJudW1iZXIiIHx8ICQuZnguc3BlZWRzWyBvcHRpb24gXSApIHsNCgkJcmV0dXJuIHRydWU7DQoJfQ0KDQoJLy8gSW52YWxpZCBzdHJpbmdzIC0gdHJlYXQgYXMgIm5vcm1hbCIgc3BlZWQNCglpZiAoIHR5cGVvZiBvcHRpb24gPT09ICJzdHJpbmciICYmICEkLmVmZmVjdHMuZWZmZWN0WyBvcHRpb24gXSApIHsNCgkJcmV0dXJuIHRydWU7DQoJfQ0KDQoJLy8gQ29tcGxldGUgY2FsbGJhY2sNCglpZiAoICQuaXNGdW5jdGlvbiggb3B0aW9uICkgKSB7DQoJCXJldHVybiB0cnVlOw0KCX0NCg0KCS8vIE9wdGlvbnMgaGFzaCAoYnV0IG5vdCBuYW1pbmcgYW4gZWZmZWN0KQ0KCWlmICggdHlwZW9mIG9wdGlvbiA9PT0gIm9iamVjdCIgJiYgIW9wdGlvbi5lZmZlY3QgKSB7DQoJCXJldHVybiB0cnVlOw0KCX0NCg0KCS8vIERpZG4ndCBtYXRjaCBhbnkgc3RhbmRhcmQgQVBJDQoJcmV0dXJuIGZhbHNlOw0KfQ0KDQokLmZuLmV4dGVuZCggew0KCWVmZmVjdDogZnVuY3Rpb24oIC8qIGVmZmVjdCwgb3B0aW9ucywgc3BlZWQsIGNhbGxiYWNrICovICkgew0KCQl2YXIgYXJncyA9IF9ub3JtYWxpemVBcmd1bWVudHMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLA0KCQkJZWZmZWN0TWV0aG9kID0gJC5lZmZlY3RzLmVmZmVjdFsgYXJncy5lZmZlY3QgXSwNCgkJCWRlZmF1bHRNb2RlID0gZWZmZWN0TWV0aG9kLm1vZGUsDQoJCQlxdWV1ZSA9IGFyZ3MucXVldWUsDQoJCQlxdWV1ZU5hbWUgPSBxdWV1ZSB8fCAiZngiLA0KCQkJY29tcGxldGUgPSBhcmdzLmNvbXBsZXRlLA0KCQkJbW9kZSA9IGFyZ3MubW9kZSwNCgkJCW1vZGVzID0gW10sDQoJCQlwcmVmaWx0ZXIgPSBmdW5jdGlvbiggbmV4dCApIHsNCgkJCQl2YXIgZWwgPSAkKCB0aGlzICksDQoJCQkJCW5vcm1hbGl6ZWRNb2RlID0gJC5lZmZlY3RzLm1vZGUoIGVsLCBtb2RlICkgfHwgZGVmYXVsdE1vZGU7DQoNCgkJCQkvLyBTZW50aW5lbCBmb3IgZHVjay1wdW5jaGluZyB0aGUgOmFuaW1hdGVkIHBzdWVkby1zZWxlY3Rvcg0KCQkJCWVsLmRhdGEoIGRhdGFTcGFjZUFuaW1hdGVkLCB0cnVlICk7DQoNCgkJCQkvLyBTYXZlIGVmZmVjdCBtb2RlIGZvciBsYXRlciB1c2UsDQoJCQkJLy8gd2UgY2FuJ3QganVzdCBjYWxsICQuZWZmZWN0cy5tb2RlIGFnYWluIGxhdGVyLA0KCQkJCS8vIGFzIHRoZSAuc2hvdygpIGJlbG93IGRlc3Ryb3lzIHRoZSBpbml0aWFsIHN0YXRlDQoJCQkJbW9kZXMucHVzaCggbm9ybWFsaXplZE1vZGUgKTsNCg0KCQkJCS8vIFNlZSAkLnVpQmFja0NvbXBhdCBpbnNpZGUgb2YgcnVuKCkgZm9yIHJlbW92YWwgb2YgZGVmYXVsdE1vZGUgaW4gMS4xMw0KCQkJCWlmICggZGVmYXVsdE1vZGUgJiYgKCBub3JtYWxpemVkTW9kZSA9PT0gInNob3ciIHx8DQoJCQkJCQkoIG5vcm1hbGl6ZWRNb2RlID09PSBkZWZhdWx0TW9kZSAmJiBub3JtYWxpemVkTW9kZSA9PT0gImhpZGUiICkgKSApIHsNCgkJCQkJZWwuc2hvdygpOw0KCQkJCX0NCg0KCQkJCWlmICggIWRlZmF1bHRNb2RlIHx8IG5vcm1hbGl6ZWRNb2RlICE9PSAibm9uZSIgKSB7DQoJCQkJCSQuZWZmZWN0cy5zYXZlU3R5bGUoIGVsICk7DQoJCQkJfQ0KDQoJCQkJaWYgKCAkLmlzRnVuY3Rpb24oIG5leHQgKSApIHsNCgkJCQkJbmV4dCgpOw0KCQkJCX0NCgkJCX07DQoNCgkJaWYgKCAkLmZ4Lm9mZiB8fCAhZWZmZWN0TWV0aG9kICkgew0KDQoJCQkvLyBEZWxlZ2F0ZSB0byB0aGUgb3JpZ2luYWwgbWV0aG9kIChlLmcuLCAuc2hvdygpKSBpZiBwb3NzaWJsZQ0KCQkJaWYgKCBtb2RlICkgew0KCQkJCXJldHVybiB0aGlzWyBtb2RlIF0oIGFyZ3MuZHVyYXRpb24sIGNvbXBsZXRlICk7DQoJCQl9IGVsc2Ugew0KCQkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCQlpZiAoIGNvbXBsZXRlICkgew0KCQkJCQkJY29tcGxldGUuY2FsbCggdGhpcyApOw0KCQkJCQl9DQoJCQkJfSApOw0KCQkJfQ0KCQl9DQoNCgkJZnVuY3Rpb24gcnVuKCBuZXh0ICkgew0KCQkJdmFyIGVsZW0gPSAkKCB0aGlzICk7DQoNCgkJCWZ1bmN0aW9uIGNsZWFudXAoKSB7DQoJCQkJZWxlbS5yZW1vdmVEYXRhKCBkYXRhU3BhY2VBbmltYXRlZCApOw0KDQoJCQkJJC5lZmZlY3RzLmNsZWFuVXAoIGVsZW0gKTsNCg0KCQkJCWlmICggYXJncy5tb2RlID09PSAiaGlkZSIgKSB7DQoJCQkJCWVsZW0uaGlkZSgpOw0KCQkJCX0NCg0KCQkJCWRvbmUoKTsNCgkJCX0NCg0KCQkJZnVuY3Rpb24gZG9uZSgpIHsNCgkJCQlpZiAoICQuaXNGdW5jdGlvbiggY29tcGxldGUgKSApIHsNCgkJCQkJY29tcGxldGUuY2FsbCggZWxlbVsgMCBdICk7DQoJCQkJfQ0KDQoJCQkJaWYgKCAkLmlzRnVuY3Rpb24oIG5leHQgKSApIHsNCgkJCQkJbmV4dCgpOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gT3ZlcnJpZGUgbW9kZSBvcHRpb24gb24gYSBwZXIgZWxlbWVudCBiYXNpcywNCgkJCS8vIGFzIHRvZ2dsZSBjYW4gYmUgZWl0aGVyIHNob3cgb3IgaGlkZSBkZXBlbmRpbmcgb24gZWxlbWVudCBzdGF0ZQ0KCQkJYXJncy5tb2RlID0gbW9kZXMuc2hpZnQoKTsNCg0KCQkJaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgJiYgIWRlZmF1bHRNb2RlICkgew0KCQkJCWlmICggZWxlbS5pcyggIjpoaWRkZW4iICkgPyBtb2RlID09PSAiaGlkZSIgOiBtb2RlID09PSAic2hvdyIgKSB7DQoNCgkJCQkJLy8gQ2FsbCB0aGUgY29yZSBtZXRob2QgdG8gdHJhY2sgIm9sZGRpc3BsYXkiIHByb3Blcmx5DQoJCQkJCWVsZW1bIG1vZGUgXSgpOw0KCQkJCQlkb25lKCk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJZWZmZWN0TWV0aG9kLmNhbGwoIGVsZW1bIDAgXSwgYXJncywgZG9uZSApOw0KCQkJCX0NCgkJCX0gZWxzZSB7DQoJCQkJaWYgKCBhcmdzLm1vZGUgPT09ICJub25lIiApIHsNCg0KCQkJCQkvLyBDYWxsIHRoZSBjb3JlIG1ldGhvZCB0byB0cmFjayAib2xkZGlzcGxheSIgcHJvcGVybHkNCgkJCQkJZWxlbVsgbW9kZSBdKCk7DQoJCQkJCWRvbmUoKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQllZmZlY3RNZXRob2QuY2FsbCggZWxlbVsgMCBdLCBhcmdzLCBjbGVhbnVwICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJLy8gUnVuIHByZWZpbHRlciBvbiBhbGwgZWxlbWVudHMgZmlyc3QgdG8gZW5zdXJlIHRoYXQNCgkJLy8gYW55IHNob3dpbmcgb3IgaGlkaW5nIGhhcHBlbnMgYmVmb3JlIHBsYWNlaG9sZGVyIGNyZWF0aW9uLA0KCQkvLyB3aGljaCBlbnN1cmVzIHRoYXQgYW55IGxheW91dCBjaGFuZ2VzIGFyZSBjb3JyZWN0bHkgY2FwdHVyZWQuDQoJCXJldHVybiBxdWV1ZSA9PT0gZmFsc2UgPw0KCQkJdGhpcy5lYWNoKCBwcmVmaWx0ZXIgKS5lYWNoKCBydW4gKSA6DQoJCQl0aGlzLnF1ZXVlKCBxdWV1ZU5hbWUsIHByZWZpbHRlciApLnF1ZXVlKCBxdWV1ZU5hbWUsIHJ1biApOw0KCX0sDQoNCglzaG93OiAoIGZ1bmN0aW9uKCBvcmlnICkgew0KCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbiApIHsNCgkJCWlmICggc3RhbmRhcmRBbmltYXRpb25PcHRpb24oIG9wdGlvbiApICkgew0KCQkJCXJldHVybiBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCgkJCX0gZWxzZSB7DQoJCQkJdmFyIGFyZ3MgPSBfbm9ybWFsaXplQXJndW1lbnRzLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCgkJCQlhcmdzLm1vZGUgPSAic2hvdyI7DQoJCQkJcmV0dXJuIHRoaXMuZWZmZWN0LmNhbGwoIHRoaXMsIGFyZ3MgKTsNCgkJCX0NCgkJfTsNCgl9ICkoICQuZm4uc2hvdyApLA0KDQoJaGlkZTogKCBmdW5jdGlvbiggb3JpZyApIHsNCgkJcmV0dXJuIGZ1bmN0aW9uKCBvcHRpb24gKSB7DQoJCQlpZiAoIHN0YW5kYXJkQW5pbWF0aW9uT3B0aW9uKCBvcHRpb24gKSApIHsNCgkJCQlyZXR1cm4gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7DQoJCQl9IGVsc2Ugew0KCQkJCXZhciBhcmdzID0gX25vcm1hbGl6ZUFyZ3VtZW50cy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7DQoJCQkJYXJncy5tb2RlID0gImhpZGUiOw0KCQkJCXJldHVybiB0aGlzLmVmZmVjdC5jYWxsKCB0aGlzLCBhcmdzICk7DQoJCQl9DQoJCX07DQoJfSApKCAkLmZuLmhpZGUgKSwNCg0KCXRvZ2dsZTogKCBmdW5jdGlvbiggb3JpZyApIHsNCgkJcmV0dXJuIGZ1bmN0aW9uKCBvcHRpb24gKSB7DQoJCQlpZiAoIHN0YW5kYXJkQW5pbWF0aW9uT3B0aW9uKCBvcHRpb24gKSB8fCB0eXBlb2Ygb3B0aW9uID09PSAiYm9vbGVhbiIgKSB7DQoJCQkJcmV0dXJuIG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJfSBlbHNlIHsNCgkJCQl2YXIgYXJncyA9IF9ub3JtYWxpemVBcmd1bWVudHMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQkJCWFyZ3MubW9kZSA9ICJ0b2dnbGUiOw0KCQkJCXJldHVybiB0aGlzLmVmZmVjdC5jYWxsKCB0aGlzLCBhcmdzICk7DQoJCQl9DQoJCX07DQoJfSApKCAkLmZuLnRvZ2dsZSApLA0KDQoJY3NzVW5pdDogZnVuY3Rpb24oIGtleSApIHsNCgkJdmFyIHN0eWxlID0gdGhpcy5jc3MoIGtleSApLA0KCQkJdmFsID0gW107DQoNCgkJJC5lYWNoKCBbICJlbSIsICJweCIsICIlIiwgInB0IiBdLCBmdW5jdGlvbiggaSwgdW5pdCApIHsNCgkJCWlmICggc3R5bGUuaW5kZXhPZiggdW5pdCApID4gMCApIHsNCgkJCQl2YWwgPSBbIHBhcnNlRmxvYXQoIHN0eWxlICksIHVuaXQgXTsNCgkJCX0NCgkJfSApOw0KCQlyZXR1cm4gdmFsOw0KCX0sDQoNCgljc3NDbGlwOiBmdW5jdGlvbiggY2xpcE9iaiApIHsNCgkJaWYgKCBjbGlwT2JqICkgew0KCQkJcmV0dXJuIHRoaXMuY3NzKCAiY2xpcCIsICJyZWN0KCIgKyBjbGlwT2JqLnRvcCArICJweCAiICsgY2xpcE9iai5yaWdodCArICJweCAiICsNCgkJCQljbGlwT2JqLmJvdHRvbSArICJweCAiICsgY2xpcE9iai5sZWZ0ICsgInB4KSIgKTsNCgkJfQ0KCQlyZXR1cm4gcGFyc2VDbGlwKCB0aGlzLmNzcyggImNsaXAiICksIHRoaXMgKTsNCgl9LA0KDQoJdHJhbnNmZXI6IGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgew0KCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwNCgkJCXRhcmdldCA9ICQoIG9wdGlvbnMudG8gKSwNCgkJCXRhcmdldEZpeGVkID0gdGFyZ2V0LmNzcyggInBvc2l0aW9uIiApID09PSAiZml4ZWQiLA0KCQkJYm9keSA9ICQoICJib2R5IiApLA0KCQkJZml4VG9wID0gdGFyZ2V0Rml4ZWQgPyBib2R5LnNjcm9sbFRvcCgpIDogMCwNCgkJCWZpeExlZnQgPSB0YXJnZXRGaXhlZCA\/IGJvZHkuc2Nyb2xsTGVmdCgpIDogMCwNCgkJCWVuZFBvc2l0aW9uID0gdGFyZ2V0Lm9mZnNldCgpLA0KCQkJYW5pbWF0aW9uID0gew0KCQkJCXRvcDogZW5kUG9zaXRpb24udG9wIC0gZml4VG9wLA0KCQkJCWxlZnQ6IGVuZFBvc2l0aW9uLmxlZnQgLSBmaXhMZWZ0LA0KCQkJCWhlaWdodDogdGFyZ2V0LmlubmVySGVpZ2h0KCksDQoJCQkJd2lkdGg6IHRhcmdldC5pbm5lcldpZHRoKCkNCgkJCX0sDQoJCQlzdGFydFBvc2l0aW9uID0gZWxlbWVudC5vZmZzZXQoKSwNCgkJCXRyYW5zZmVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWVmZmVjdHMtdHJhbnNmZXInPjwvZGl2PiIgKQ0KCQkJCS5hcHBlbmRUbyggImJvZHkiICkNCgkJCQkuYWRkQ2xhc3MoIG9wdGlvbnMuY2xhc3NOYW1lICkNCgkJCQkuY3NzKCB7DQoJCQkJCXRvcDogc3RhcnRQb3NpdGlvbi50b3AgLSBmaXhUb3AsDQoJCQkJCWxlZnQ6IHN0YXJ0UG9zaXRpb24ubGVmdCAtIGZpeExlZnQsDQoJCQkJCWhlaWdodDogZWxlbWVudC5pbm5lckhlaWdodCgpLA0KCQkJCQl3aWR0aDogZWxlbWVudC5pbm5lcldpZHRoKCksDQoJCQkJCXBvc2l0aW9uOiB0YXJnZXRGaXhlZCA\/ICJmaXhlZCIgOiAiYWJzb2x1dGUiDQoJCQkJfSApDQoJCQkJLmFuaW1hdGUoIGFuaW1hdGlvbiwgb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGZ1bmN0aW9uKCkgew0KCQkJCQl0cmFuc2Zlci5yZW1vdmUoKTsNCgkJCQkJaWYgKCAkLmlzRnVuY3Rpb24oIGRvbmUgKSApIHsNCgkJCQkJCWRvbmUoKTsNCgkJCQkJfQ0KCQkJCX0gKTsNCgl9DQp9ICk7DQoNCmZ1bmN0aW9uIHBhcnNlQ2xpcCggc3RyLCBlbGVtZW50ICkgew0KCQl2YXIgb3V0ZXJXaWR0aCA9IGVsZW1lbnQub3V0ZXJXaWR0aCgpLA0KCQkJb3V0ZXJIZWlnaHQgPSBlbGVtZW50Lm91dGVySGVpZ2h0KCksDQoJCQljbGlwUmVnZXggPSAvXnJlY3RcKCgtP1xkKlwuP1xkKnB4fC0\/XGQrJXxhdXRvKSw\/XHMqKC0\/XGQqXC4\/XGQqcHh8LT9cZCslfGF1dG8pLD9ccyooLT9cZCpcLj9cZCpweHwtP1xkKyV8YXV0byksP1xzKigtP1xkKlwuP1xkKnB4fC0\/XGQrJXxhdXRvKVwpJC8sDQoJCQl2YWx1ZXMgPSBjbGlwUmVnZXguZXhlYyggc3RyICkgfHwgWyAiIiwgMCwgb3V0ZXJXaWR0aCwgb3V0ZXJIZWlnaHQsIDAgXTsNCg0KCQlyZXR1cm4gew0KCQkJdG9wOiBwYXJzZUZsb2F0KCB2YWx1ZXNbIDEgXSApIHx8IDAsDQoJCQlyaWdodDogdmFsdWVzWyAyIF0gPT09ICJhdXRvIiA\/IG91dGVyV2lkdGggOiBwYXJzZUZsb2F0KCB2YWx1ZXNbIDIgXSApLA0KCQkJYm90dG9tOiB2YWx1ZXNbIDMgXSA9PT0gImF1dG8iID8gb3V0ZXJIZWlnaHQgOiBwYXJzZUZsb2F0KCB2YWx1ZXNbIDMgXSApLA0KCQkJbGVmdDogcGFyc2VGbG9hdCggdmFsdWVzWyA0IF0gKSB8fCAwDQoJCX07DQp9DQoNCiQuZnguc3RlcC5jbGlwID0gZnVuY3Rpb24oIGZ4ICkgew0KCWlmICggIWZ4LmNsaXBJbml0ICkgew0KCQlmeC5zdGFydCA9ICQoIGZ4LmVsZW0gKS5jc3NDbGlwKCk7DQoJCWlmICggdHlwZW9mIGZ4LmVuZCA9PT0gInN0cmluZyIgKSB7DQoJCQlmeC5lbmQgPSBwYXJzZUNsaXAoIGZ4LmVuZCwgZnguZWxlbSApOw0KCQl9DQoJCWZ4LmNsaXBJbml0ID0gdHJ1ZTsNCgl9DQoNCgkkKCBmeC5lbGVtICkuY3NzQ2xpcCggew0KCQl0b3A6IGZ4LnBvcyAqICggZnguZW5kLnRvcCAtIGZ4LnN0YXJ0LnRvcCApICsgZnguc3RhcnQudG9wLA0KCQlyaWdodDogZngucG9zICogKCBmeC5lbmQucmlnaHQgLSBmeC5zdGFydC5yaWdodCApICsgZnguc3RhcnQucmlnaHQsDQoJCWJvdHRvbTogZngucG9zICogKCBmeC5lbmQuYm90dG9tIC0gZnguc3RhcnQuYm90dG9tICkgKyBmeC5zdGFydC5ib3R0b20sDQoJCWxlZnQ6IGZ4LnBvcyAqICggZnguZW5kLmxlZnQgLSBmeC5zdGFydC5sZWZ0ICkgKyBmeC5zdGFydC5sZWZ0DQoJfSApOw0KfTsNCg0KfSApKCk7DQoNCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovDQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogRUFTSU5HICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLw0KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8NCg0KKCBmdW5jdGlvbigpIHsNCg0KLy8gQmFzZWQgb24gZWFzaW5nIGVxdWF0aW9ucyBmcm9tIFJvYmVydCBQZW5uZXIgKGh0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcpDQoNCnZhciBiYXNlRWFzaW5ncyA9IHt9Ow0KDQokLmVhY2goIFsgIlF1YWQiLCAiQ3ViaWMiLCAiUXVhcnQiLCAiUXVpbnQiLCAiRXhwbyIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7DQoJYmFzZUVhc2luZ3NbIG5hbWUgXSA9IGZ1bmN0aW9uKCBwICkgew0KCQlyZXR1cm4gTWF0aC5wb3coIHAsIGkgKyAyICk7DQoJfTsNCn0gKTsNCg0KJC5leHRlbmQoIGJhc2VFYXNpbmdzLCB7DQoJU2luZTogZnVuY3Rpb24oIHAgKSB7DQoJCXJldHVybiAxIC0gTWF0aC5jb3MoIHAgKiBNYXRoLlBJIC8gMiApOw0KCX0sDQoJQ2lyYzogZnVuY3Rpb24oIHAgKSB7DQoJCXJldHVybiAxIC0gTWF0aC5zcXJ0KCAxIC0gcCAqIHAgKTsNCgl9LA0KCUVsYXN0aWM6IGZ1bmN0aW9uKCBwICkgew0KCQlyZXR1cm4gcCA9PT0gMCB8fCBwID09PSAxID8gcCA6DQoJCQktTWF0aC5wb3coIDIsIDggKiAoIHAgLSAxICkgKSAqIE1hdGguc2luKCAoICggcCAtIDEgKSAqIDgwIC0gNy41ICkgKiBNYXRoLlBJIC8gMTUgKTsNCgl9LA0KCUJhY2s6IGZ1bmN0aW9uKCBwICkgew0KCQlyZXR1cm4gcCAqIHAgKiAoIDMgKiBwIC0gMiApOw0KCX0sDQoJQm91bmNlOiBmdW5jdGlvbiggcCApIHsNCgkJdmFyIHBvdzIsDQoJCQlib3VuY2UgPSA0Ow0KDQoJCXdoaWxlICggcCA8ICggKCBwb3cyID0gTWF0aC5wb3coIDIsIC0tYm91bmNlICkgKSAtIDEgKSAvIDExICkge30NCgkJcmV0dXJuIDEgLyBNYXRoLnBvdyggNCwgMyAtIGJvdW5jZSApIC0gNy41NjI1ICogTWF0aC5wb3coICggcG93MiAqIDMgLSAyICkgLyAyMiAtIHAsIDIgKTsNCgl9DQp9ICk7DQoNCiQuZWFjaCggYmFzZUVhc2luZ3MsIGZ1bmN0aW9uKCBuYW1lLCBlYXNlSW4gKSB7DQoJJC5lYXNpbmdbICJlYXNlSW4iICsgbmFtZSBdID0gZWFzZUluOw0KCSQuZWFzaW5nWyAiZWFzZU91dCIgKyBuYW1lIF0gPSBmdW5jdGlvbiggcCApIHsNCgkJcmV0dXJuIDEgLSBlYXNlSW4oIDEgLSBwICk7DQoJfTsNCgkkLmVhc2luZ1sgImVhc2VJbk91dCIgKyBuYW1lIF0gPSBmdW5jdGlvbiggcCApIHsNCgkJcmV0dXJuIHAgPCAwLjUgPw0KCQkJZWFzZUluKCBwICogMiApIC8gMiA6DQoJCQkxIC0gZWFzZUluKCBwICogLTIgKyAyICkgLyAyOw0KCX07DQp9ICk7DQoNCn0gKSgpOw0KDQp2YXIgZWZmZWN0ID0gJC5lZmZlY3RzOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIEVmZmVjdHMgQmxpbmQgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IEJsaW5kIEVmZmVjdA0KLy8+Pmdyb3VwOiBFZmZlY3RzDQovLz4+ZGVzY3JpcHRpb246IEJsaW5kcyB0aGUgZWxlbWVudC4NCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9ibGluZC1lZmZlY3QvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGVmZmVjdHNFZmZlY3RCbGluZCA9ICQuZWZmZWN0cy5kZWZpbmUoICJibGluZCIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7DQoJdmFyIG1hcCA9IHsNCgkJCXVwOiBbICJib3R0b20iLCAidG9wIiBdLA0KCQkJdmVydGljYWw6IFsgImJvdHRvbSIsICJ0b3AiIF0sDQoJCQlkb3duOiBbICJ0b3AiLCAiYm90dG9tIiBdLA0KCQkJbGVmdDogWyAicmlnaHQiLCAibGVmdCIgXSwNCgkJCWhvcml6b250YWw6IFsgInJpZ2h0IiwgImxlZnQiIF0sDQoJCQlyaWdodDogWyAibGVmdCIsICJyaWdodCIgXQ0KCQl9LA0KCQllbGVtZW50ID0gJCggdGhpcyApLA0KCQlkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiB8fCAidXAiLA0KCQlzdGFydCA9IGVsZW1lbnQuY3NzQ2xpcCgpLA0KCQlhbmltYXRlID0geyBjbGlwOiAkLmV4dGVuZCgge30sIHN0YXJ0ICkgfSwNCgkJcGxhY2Vob2xkZXIgPSAkLmVmZmVjdHMuY3JlYXRlUGxhY2Vob2xkZXIoIGVsZW1lbnQgKTsNCg0KCWFuaW1hdGUuY2xpcFsgbWFwWyBkaXJlY3Rpb24gXVsgMCBdIF0gPSBhbmltYXRlLmNsaXBbIG1hcFsgZGlyZWN0aW9uIF1bIDEgXSBdOw0KDQoJaWYgKCBvcHRpb25zLm1vZGUgPT09ICJzaG93IiApIHsNCgkJZWxlbWVudC5jc3NDbGlwKCBhbmltYXRlLmNsaXAgKTsNCgkJaWYgKCBwbGFjZWhvbGRlciApIHsNCgkJCXBsYWNlaG9sZGVyLmNzcyggJC5lZmZlY3RzLmNsaXBUb0JveCggYW5pbWF0ZSApICk7DQoJCX0NCg0KCQlhbmltYXRlLmNsaXAgPSBzdGFydDsNCgl9DQoNCglpZiAoIHBsYWNlaG9sZGVyICkgew0KCQlwbGFjZWhvbGRlci5hbmltYXRlKCAkLmVmZmVjdHMuY2xpcFRvQm94KCBhbmltYXRlICksIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICk7DQoJfQ0KDQoJZWxlbWVudC5hbmltYXRlKCBhbmltYXRlLCB7DQoJCXF1ZXVlOiBmYWxzZSwNCgkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sDQoJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsDQoJCWNvbXBsZXRlOiBkb25lDQoJfSApOw0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIEVmZmVjdHMgQm91bmNlIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBCb3VuY2UgRWZmZWN0DQovLz4+Z3JvdXA6IEVmZmVjdHMNCi8vPj5kZXNjcmlwdGlvbjogQm91bmNlcyBhbiBlbGVtZW50IGhvcml6b250YWxseSBvciB2ZXJ0aWNhbGx5IG4gdGltZXMuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vYm91bmNlLWVmZmVjdC8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvDQoNCg0KDQp2YXIgZWZmZWN0c0VmZmVjdEJvdW5jZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJib3VuY2UiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsNCgl2YXIgdXBBbmltLCBkb3duQW5pbSwgcmVmVmFsdWUsDQoJCWVsZW1lbnQgPSAkKCB0aGlzICksDQoNCgkJLy8gRGVmYXVsdHM6DQoJCW1vZGUgPSBvcHRpb25zLm1vZGUsDQoJCWhpZGUgPSBtb2RlID09PSAiaGlkZSIsDQoJCXNob3cgPSBtb2RlID09PSAic2hvdyIsDQoJCWRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJ1cCIsDQoJCWRpc3RhbmNlID0gb3B0aW9ucy5kaXN0YW5jZSwNCgkJdGltZXMgPSBvcHRpb25zLnRpbWVzIHx8IDUsDQoNCgkJLy8gTnVtYmVyIG9mIGludGVybmFsIGFuaW1hdGlvbnMNCgkJYW5pbXMgPSB0aW1lcyAqIDIgKyAoIHNob3cgfHwgaGlkZSA\/IDEgOiAwICksDQoJCXNwZWVkID0gb3B0aW9ucy5kdXJhdGlvbiAvIGFuaW1zLA0KCQllYXNpbmcgPSBvcHRpb25zLmVhc2luZywNCg0KCQkvLyBVdGlsaXR5Og0KCQlyZWYgPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJkb3duIiApID8gInRvcCIgOiAibGVmdCIsDQoJCW1vdGlvbiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImxlZnQiICksDQoJCWkgPSAwLA0KDQoJCXF1ZXVlbGVuID0gZWxlbWVudC5xdWV1ZSgpLmxlbmd0aDsNCg0KCSQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApOw0KDQoJcmVmVmFsdWUgPSBlbGVtZW50LmNzcyggcmVmICk7DQoNCgkvLyBEZWZhdWx0IGRpc3RhbmNlIGZvciB0aGUgQklHR0VTVCBib3VuY2UgaXMgdGhlIG91dGVyIERpc3RhbmNlIC8gMw0KCWlmICggIWRpc3RhbmNlICkgew0KCQlkaXN0YW5jZSA9IGVsZW1lbnRbIHJlZiA9PT0gInRvcCIgPyAib3V0ZXJIZWlnaHQiIDogIm91dGVyV2lkdGgiIF0oKSAvIDM7DQoJfQ0KDQoJaWYgKCBzaG93ICkgew0KCQlkb3duQW5pbSA9IHsgb3BhY2l0eTogMSB9Ow0KCQlkb3duQW5pbVsgcmVmIF0gPSByZWZWYWx1ZTsNCg0KCQkvLyBJZiB3ZSBhcmUgc2hvd2luZywgZm9yY2Ugb3BhY2l0eSAwIGFuZCBzZXQgdGhlIGluaXRpYWwgcG9zaXRpb24NCgkJLy8gdGhlbiBkbyB0aGUgImZpcnN0IiBhbmltYXRpb24NCgkJZWxlbWVudA0KCQkJLmNzcyggIm9wYWNpdHkiLCAwICkNCgkJCS5jc3MoIHJlZiwgbW90aW9uID8gLWRpc3RhbmNlICogMiA6IGRpc3RhbmNlICogMiApDQoJCQkuYW5pbWF0ZSggZG93bkFuaW0sIHNwZWVkLCBlYXNpbmcgKTsNCgl9DQoNCgkvLyBTdGFydCBhdCB0aGUgc21hbGxlc3QgZGlzdGFuY2UgaWYgd2UgYXJlIGhpZGluZw0KCWlmICggaGlkZSApIHsNCgkJZGlzdGFuY2UgPSBkaXN0YW5jZSAvIE1hdGgucG93KCAyLCB0aW1lcyAtIDEgKTsNCgl9DQoNCglkb3duQW5pbSA9IHt9Ow0KCWRvd25BbmltWyByZWYgXSA9IHJlZlZhbHVlOw0KDQoJLy8gQm91bmNlcyB1cC9kb3duL2xlZnQvcmlnaHQgdGhlbiBiYWNrIHRvIDAgLS0gdGltZXMgKiAyIGFuaW1hdGlvbnMgaGFwcGVuIGhlcmUNCglmb3IgKCA7IGkgPCB0aW1lczsgaSsrICkgew0KCQl1cEFuaW0gPSB7fTsNCgkJdXBBbmltWyByZWYgXSA9ICggbW90aW9uID8gIi09IiA6ICIrPSIgKSArIGRpc3RhbmNlOw0KDQoJCWVsZW1lbnQNCgkJCS5hbmltYXRlKCB1cEFuaW0sIHNwZWVkLCBlYXNpbmcgKQ0KCQkJLmFuaW1hdGUoIGRvd25BbmltLCBzcGVlZCwgZWFzaW5nICk7DQoNCgkJZGlzdGFuY2UgPSBoaWRlID8gZGlzdGFuY2UgKiAyIDogZGlzdGFuY2UgLyAyOw0KCX0NCg0KCS8vIExhc3QgQm91bmNlIHdoZW4gSGlkaW5nDQoJaWYgKCBoaWRlICkgew0KCQl1cEFuaW0gPSB7IG9wYWNpdHk6IDAgfTsNCgkJdXBBbmltWyByZWYgXSA9ICggbW90aW9uID8gIi09IiA6ICIrPSIgKSArIGRpc3RhbmNlOw0KDQoJCWVsZW1lbnQuYW5pbWF0ZSggdXBBbmltLCBzcGVlZCwgZWFzaW5nICk7DQoJfQ0KDQoJZWxlbWVudC5xdWV1ZSggZG9uZSApOw0KDQoJJC5lZmZlY3RzLnVuc2hpZnQoIGVsZW1lbnQsIHF1ZXVlbGVuLCBhbmltcyArIDEgKTsNCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBFZmZlY3RzIENsaXAgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IENsaXAgRWZmZWN0DQovLz4+Z3JvdXA6IEVmZmVjdHMNCi8vPj5kZXNjcmlwdGlvbjogQ2xpcHMgdGhlIGVsZW1lbnQgb24gYW5kIG9mZiBsaWtlIGFuIG9sZCBUVi4NCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9jbGlwLWVmZmVjdC8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvDQoNCg0KDQp2YXIgZWZmZWN0c0VmZmVjdENsaXAgPSAkLmVmZmVjdHMuZGVmaW5lKCAiY2xpcCIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7DQoJdmFyIHN0YXJ0LA0KCQlhbmltYXRlID0ge30sDQoJCWVsZW1lbnQgPSAkKCB0aGlzICksDQoJCWRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJ2ZXJ0aWNhbCIsDQoJCWJvdGggPSBkaXJlY3Rpb24gPT09ICJib3RoIiwNCgkJaG9yaXpvbnRhbCA9IGJvdGggfHwgZGlyZWN0aW9uID09PSAiaG9yaXpvbnRhbCIsDQoJCXZlcnRpY2FsID0gYm90aCB8fCBkaXJlY3Rpb24gPT09ICJ2ZXJ0aWNhbCI7DQoNCglzdGFydCA9IGVsZW1lbnQuY3NzQ2xpcCgpOw0KCWFuaW1hdGUuY2xpcCA9IHsNCgkJdG9wOiB2ZXJ0aWNhbCA\/ICggc3RhcnQuYm90dG9tIC0gc3RhcnQudG9wICkgLyAyIDogc3RhcnQudG9wLA0KCQlyaWdodDogaG9yaXpvbnRhbCA\/ICggc3RhcnQucmlnaHQgLSBzdGFydC5sZWZ0ICkgLyAyIDogc3RhcnQucmlnaHQsDQoJCWJvdHRvbTogdmVydGljYWwgPyAoIHN0YXJ0LmJvdHRvbSAtIHN0YXJ0LnRvcCApIC8gMiA6IHN0YXJ0LmJvdHRvbSwNCgkJbGVmdDogaG9yaXpvbnRhbCA\/ICggc3RhcnQucmlnaHQgLSBzdGFydC5sZWZ0ICkgLyAyIDogc3RhcnQubGVmdA0KCX07DQoNCgkkLmVmZmVjdHMuY3JlYXRlUGxhY2Vob2xkZXIoIGVsZW1lbnQgKTsNCg0KCWlmICggb3B0aW9ucy5tb2RlID09PSAic2hvdyIgKSB7DQoJCWVsZW1lbnQuY3NzQ2xpcCggYW5pbWF0ZS5jbGlwICk7DQoJCWFuaW1hdGUuY2xpcCA9IHN0YXJ0Ow0KCX0NCg0KCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0ZSwgew0KCQlxdWV1ZTogZmFsc2UsDQoJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLA0KCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLA0KCQljb21wbGV0ZTogZG9uZQ0KCX0gKTsNCg0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIEVmZmVjdHMgRHJvcCAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogRHJvcCBFZmZlY3QNCi8vPj5ncm91cDogRWZmZWN0cw0KLy8+PmRlc2NyaXB0aW9uOiBNb3ZlcyBhbiBlbGVtZW50IGluIG9uZSBkaXJlY3Rpb24gYW5kIGhpZGVzIGl0IGF0IHRoZSBzYW1lIHRpbWUuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZHJvcC1lZmZlY3QvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGVmZmVjdHNFZmZlY3REcm9wID0gJC5lZmZlY3RzLmRlZmluZSggImRyb3AiLCAiaGlkZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgew0KDQoJdmFyIGRpc3RhbmNlLA0KCQllbGVtZW50ID0gJCggdGhpcyApLA0KCQltb2RlID0gb3B0aW9ucy5tb2RlLA0KCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLA0KCQlkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiB8fCAibGVmdCIsDQoJCXJlZiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImRvd24iICkgPyAidG9wIiA6ICJsZWZ0IiwNCgkJbW90aW9uID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAibGVmdCIgKSA\/ICItPSIgOiAiKz0iLA0KCQlvcHBvc2l0ZU1vdGlvbiA9ICggbW90aW9uID09PSAiKz0iICkgPyAiLT0iIDogIis9IiwNCgkJYW5pbWF0aW9uID0gew0KCQkJb3BhY2l0eTogMA0KCQl9Ow0KDQoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7DQoNCglkaXN0YW5jZSA9IG9wdGlvbnMuZGlzdGFuY2UgfHwNCgkJZWxlbWVudFsgcmVmID09PSAidG9wIiA\/ICJvdXRlckhlaWdodCIgOiAib3V0ZXJXaWR0aCIgXSggdHJ1ZSApIC8gMjsNCg0KCWFuaW1hdGlvblsgcmVmIF0gPSBtb3Rpb24gKyBkaXN0YW5jZTsNCg0KCWlmICggc2hvdyApIHsNCgkJZWxlbWVudC5jc3MoIGFuaW1hdGlvbiApOw0KDQoJCWFuaW1hdGlvblsgcmVmIF0gPSBvcHBvc2l0ZU1vdGlvbiArIGRpc3RhbmNlOw0KCQlhbmltYXRpb24ub3BhY2l0eSA9IDE7DQoJfQ0KDQoJLy8gQW5pbWF0ZQ0KCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0aW9uLCB7DQoJCXF1ZXVlOiBmYWxzZSwNCgkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sDQoJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsDQoJCWNvbXBsZXRlOiBkb25lDQoJfSApOw0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIEVmZmVjdHMgRXhwbG9kZSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogRXhwbG9kZSBFZmZlY3QNCi8vPj5ncm91cDogRWZmZWN0cw0KLy8ganNjczpkaXNhYmxlIG1heGltdW1MaW5lTGVuZ3RoDQovLz4+ZGVzY3JpcHRpb246IEV4cGxvZGVzIGFuIGVsZW1lbnQgaW4gYWxsIGRpcmVjdGlvbnMgaW50byBuIHBpZWNlcy4gSW1wbG9kZXMgYW4gZWxlbWVudCB0byBpdHMgb3JpZ2luYWwgd2hvbGVuZXNzLg0KLy8ganNjczplbmFibGUgbWF4aW11bUxpbmVMZW5ndGgNCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9leHBsb2RlLWVmZmVjdC8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvDQoNCg0KDQp2YXIgZWZmZWN0c0VmZmVjdEV4cGxvZGUgPSAkLmVmZmVjdHMuZGVmaW5lKCAiZXhwbG9kZSIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7DQoNCgl2YXIgaSwgaiwgbGVmdCwgdG9wLCBteCwgbXksDQoJCXJvd3MgPSBvcHRpb25zLnBpZWNlcyA\/IE1hdGgucm91bmQoIE1hdGguc3FydCggb3B0aW9ucy5waWVjZXMgKSApIDogMywNCgkJY2VsbHMgPSByb3dzLA0KCQllbGVtZW50ID0gJCggdGhpcyApLA0KCQltb2RlID0gb3B0aW9ucy5tb2RlLA0KCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLA0KDQoJCS8vIFNob3cgYW5kIHRoZW4gdmlzaWJpbGl0eTpoaWRkZW4gdGhlIGVsZW1lbnQgYmVmb3JlIGNhbGN1bGF0aW5nIG9mZnNldA0KCQlvZmZzZXQgPSBlbGVtZW50LnNob3coKS5jc3MoICJ2aXNpYmlsaXR5IiwgImhpZGRlbiIgKS5vZmZzZXQoKSwNCg0KCQkvLyBXaWR0aCBhbmQgaGVpZ2h0IG9mIGEgcGllY2UNCgkJd2lkdGggPSBNYXRoLmNlaWwoIGVsZW1lbnQub3V0ZXJXaWR0aCgpIC8gY2VsbHMgKSwNCgkJaGVpZ2h0ID0gTWF0aC5jZWlsKCBlbGVtZW50Lm91dGVySGVpZ2h0KCkgLyByb3dzICksDQoJCXBpZWNlcyA9IFtdOw0KDQoJLy8gQ2hpbGRyZW4gYW5pbWF0ZSBjb21wbGV0ZToNCglmdW5jdGlvbiBjaGlsZENvbXBsZXRlKCkgew0KCQlwaWVjZXMucHVzaCggdGhpcyApOw0KCQlpZiAoIHBpZWNlcy5sZW5ndGggPT09IHJvd3MgKiBjZWxscyApIHsNCgkJCWFuaW1Db21wbGV0ZSgpOw0KCQl9DQoJfQ0KDQoJLy8gQ2xvbmUgdGhlIGVsZW1lbnQgZm9yIGVhY2ggcm93IGFuZCBjZWxsLg0KCWZvciAoIGkgPSAwOyBpIDwgcm93czsgaSsrICkgeyAvLyA9PT0+DQoJCXRvcCA9IG9mZnNldC50b3AgKyBpICogaGVpZ2h0Ow0KCQlteSA9IGkgLSAoIHJvd3MgLSAxICkgLyAyOw0KDQoJCWZvciAoIGogPSAwOyBqIDwgY2VsbHM7IGorKyApIHsgLy8gfHx8DQoJCQlsZWZ0ID0gb2Zmc2V0LmxlZnQgKyBqICogd2lkdGg7DQoJCQlteCA9IGogLSAoIGNlbGxzIC0gMSApIC8gMjsNCg0KCQkJLy8gQ3JlYXRlIGEgY2xvbmUgb2YgdGhlIG5vdyBoaWRkZW4gbWFpbiBlbGVtZW50IHRoYXQgd2lsbCBiZSBhYnNvbHV0ZSBwb3NpdGlvbmVkDQoJCQkvLyB3aXRoaW4gYSB3cmFwcGVyIGRpdiBvZmYgdGhlIC1sZWZ0IGFuZCAtdG9wIGVxdWFsIHRvIHNpemUgb2Ygb3VyIHBpZWNlcw0KCQkJZWxlbWVudA0KCQkJCS5jbG9uZSgpDQoJCQkJLmFwcGVuZFRvKCAiYm9keSIgKQ0KCQkJCS53cmFwKCAiPGRpdj48L2Rpdj4iICkNCgkJCQkuY3NzKCB7DQoJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLA0KCQkJCQl2aXNpYmlsaXR5OiAidmlzaWJsZSIsDQoJCQkJCWxlZnQ6IC1qICogd2lkdGgsDQoJCQkJCXRvcDogLWkgKiBoZWlnaHQNCgkJCQl9ICkNCg0KCQkJCS8vIFNlbGVjdCB0aGUgd3JhcHBlciAtIG1ha2UgaXQgb3ZlcmZsb3c6IGhpZGRlbiBhbmQgYWJzb2x1dGUgcG9zaXRpb25lZCBiYXNlZCBvbg0KCQkJCS8vIHdoZXJlIHRoZSBvcmlnaW5hbCB3YXMgbG9jYXRlZCArbGVmdCBhbmQgK3RvcCBlcXVhbCB0byB0aGUgc2l6ZSBvZiBwaWVjZXMNCgkJCQkucGFyZW50KCkNCgkJCQkJLmFkZENsYXNzKCAidWktZWZmZWN0cy1leHBsb2RlIiApDQoJCQkJCS5jc3MoIHsNCgkJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLA0KCQkJCQkJb3ZlcmZsb3c6ICJoaWRkZW4iLA0KCQkJCQkJd2lkdGg6IHdpZHRoLA0KCQkJCQkJaGVpZ2h0OiBoZWlnaHQsDQoJCQkJCQlsZWZ0OiBsZWZ0ICsgKCBzaG93ID8gbXggKiB3aWR0aCA6IDAgKSwNCgkJCQkJCXRvcDogdG9wICsgKCBzaG93ID8gbXkgKiBoZWlnaHQgOiAwICksDQoJCQkJCQlvcGFjaXR5OiBzaG93ID8gMCA6IDENCgkJCQkJfSApDQoJCQkJCS5hbmltYXRlKCB7DQoJCQkJCQlsZWZ0OiBsZWZ0ICsgKCBzaG93ID8gMCA6IG14ICogd2lkdGggKSwNCgkJCQkJCXRvcDogdG9wICsgKCBzaG93ID8gMCA6IG15ICogaGVpZ2h0ICksDQoJCQkJCQlvcGFjaXR5OiBzaG93ID8gMSA6IDANCgkJCQkJfSwgb3B0aW9ucy5kdXJhdGlvbiB8fCA1MDAsIG9wdGlvbnMuZWFzaW5nLCBjaGlsZENvbXBsZXRlICk7DQoJCX0NCgl9DQoNCglmdW5jdGlvbiBhbmltQ29tcGxldGUoKSB7DQoJCWVsZW1lbnQuY3NzKCB7DQoJCQl2aXNpYmlsaXR5OiAidmlzaWJsZSINCgkJfSApOw0KCQkkKCBwaWVjZXMgKS5yZW1vdmUoKTsNCgkJZG9uZSgpOw0KCX0NCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBFZmZlY3RzIEZhZGUgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IEZhZGUgRWZmZWN0DQovLz4+Z3JvdXA6IEVmZmVjdHMNCi8vPj5kZXNjcmlwdGlvbjogRmFkZXMgdGhlIGVsZW1lbnQuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZmFkZS1lZmZlY3QvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGVmZmVjdHNFZmZlY3RGYWRlID0gJC5lZmZlY3RzLmRlZmluZSggImZhZGUiLCAidG9nZ2xlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7DQoJdmFyIHNob3cgPSBvcHRpb25zLm1vZGUgPT09ICJzaG93IjsNCg0KCSQoIHRoaXMgKQ0KCQkuY3NzKCAib3BhY2l0eSIsIHNob3cgPyAwIDogMSApDQoJCS5hbmltYXRlKCB7DQoJCQlvcGFjaXR5OiBzaG93ID8gMSA6IDANCgkJfSwgew0KCQkJcXVldWU6IGZhbHNlLA0KCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sDQoJCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLA0KCQkJY29tcGxldGU6IGRvbmUNCgkJfSApOw0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIEVmZmVjdHMgRm9sZCAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogRm9sZCBFZmZlY3QNCi8vPj5ncm91cDogRWZmZWN0cw0KLy8+PmRlc2NyaXB0aW9uOiBGb2xkcyBhbiBlbGVtZW50IGZpcnN0IGhvcml6b250YWxseSBhbmQgdGhlbiB2ZXJ0aWNhbGx5Lg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2ZvbGQtZWZmZWN0Lw0KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8NCg0KDQoNCnZhciBlZmZlY3RzRWZmZWN0Rm9sZCA9ICQuZWZmZWN0cy5kZWZpbmUoICJmb2xkIiwgImhpZGUiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsNCg0KCS8vIENyZWF0ZSBlbGVtZW50DQoJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksDQoJCW1vZGUgPSBvcHRpb25zLm1vZGUsDQoJCXNob3cgPSBtb2RlID09PSAic2hvdyIsDQoJCWhpZGUgPSBtb2RlID09PSAiaGlkZSIsDQoJCXNpemUgPSBvcHRpb25zLnNpemUgfHwgMTUsDQoJCXBlcmNlbnQgPSAvKFswLTldKyklLy5leGVjKCBzaXplICksDQoJCWhvcml6Rmlyc3QgPSAhIW9wdGlvbnMuaG9yaXpGaXJzdCwNCgkJcmVmID0gaG9yaXpGaXJzdCA\/IFsgInJpZ2h0IiwgImJvdHRvbSIgXSA6IFsgImJvdHRvbSIsICJyaWdodCIgXSwNCgkJZHVyYXRpb24gPSBvcHRpb25zLmR1cmF0aW9uIC8gMiwNCg0KCQlwbGFjZWhvbGRlciA9ICQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApLA0KDQoJCXN0YXJ0ID0gZWxlbWVudC5jc3NDbGlwKCksDQoJCWFuaW1hdGlvbjEgPSB7IGNsaXA6ICQuZXh0ZW5kKCB7fSwgc3RhcnQgKSB9LA0KCQlhbmltYXRpb24yID0geyBjbGlwOiAkLmV4dGVuZCgge30sIHN0YXJ0ICkgfSwNCg0KCQlkaXN0YW5jZSA9IFsgc3RhcnRbIHJlZlsgMCBdIF0sIHN0YXJ0WyByZWZbIDEgXSBdIF0sDQoNCgkJcXVldWVsZW4gPSBlbGVtZW50LnF1ZXVlKCkubGVuZ3RoOw0KDQoJaWYgKCBwZXJjZW50ICkgew0KCQlzaXplID0gcGFyc2VJbnQoIHBlcmNlbnRbIDEgXSwgMTAgKSAvIDEwMCAqIGRpc3RhbmNlWyBoaWRlID8gMCA6IDEgXTsNCgl9DQoJYW5pbWF0aW9uMS5jbGlwWyByZWZbIDAgXSBdID0gc2l6ZTsNCglhbmltYXRpb24yLmNsaXBbIHJlZlsgMCBdIF0gPSBzaXplOw0KCWFuaW1hdGlvbjIuY2xpcFsgcmVmWyAxIF0gXSA9IDA7DQoNCglpZiAoIHNob3cgKSB7DQoJCWVsZW1lbnQuY3NzQ2xpcCggYW5pbWF0aW9uMi5jbGlwICk7DQoJCWlmICggcGxhY2Vob2xkZXIgKSB7DQoJCQlwbGFjZWhvbGRlci5jc3MoICQuZWZmZWN0cy5jbGlwVG9Cb3goIGFuaW1hdGlvbjIgKSApOw0KCQl9DQoNCgkJYW5pbWF0aW9uMi5jbGlwID0gc3RhcnQ7DQoJfQ0KDQoJLy8gQW5pbWF0ZQ0KCWVsZW1lbnQNCgkJLnF1ZXVlKCBmdW5jdGlvbiggbmV4dCApIHsNCgkJCWlmICggcGxhY2Vob2xkZXIgKSB7DQoJCQkJcGxhY2Vob2xkZXINCgkJCQkJLmFuaW1hdGUoICQuZWZmZWN0cy5jbGlwVG9Cb3goIGFuaW1hdGlvbjEgKSwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICkNCgkJCQkJLmFuaW1hdGUoICQuZWZmZWN0cy5jbGlwVG9Cb3goIGFuaW1hdGlvbjIgKSwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICk7DQoJCQl9DQoNCgkJCW5leHQoKTsNCgkJfSApDQoJCS5hbmltYXRlKCBhbmltYXRpb24xLCBkdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcgKQ0KCQkuYW5pbWF0ZSggYW5pbWF0aW9uMiwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICkNCgkJLnF1ZXVlKCBkb25lICk7DQoNCgkkLmVmZmVjdHMudW5zaGlmdCggZWxlbWVudCwgcXVldWVsZW4sIDQgKTsNCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBFZmZlY3RzIEhpZ2hsaWdodCAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogSGlnaGxpZ2h0IEVmZmVjdA0KLy8+Pmdyb3VwOiBFZmZlY3RzDQovLz4+ZGVzY3JpcHRpb246IEhpZ2hsaWdodHMgdGhlIGJhY2tncm91bmQgb2YgYW4gZWxlbWVudCBpbiBhIGRlZmluZWQgY29sb3IgZm9yIGEgY3VzdG9tIGR1cmF0aW9uLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2hpZ2hsaWdodC1lZmZlY3QvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGVmZmVjdHNFZmZlY3RIaWdobGlnaHQgPSAkLmVmZmVjdHMuZGVmaW5lKCAiaGlnaGxpZ2h0IiwgInNob3ciLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsNCgl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwNCgkJYW5pbWF0aW9uID0gew0KCQkJYmFja2dyb3VuZENvbG9yOiBlbGVtZW50LmNzcyggImJhY2tncm91bmRDb2xvciIgKQ0KCQl9Ow0KDQoJaWYgKCBvcHRpb25zLm1vZGUgPT09ICJoaWRlIiApIHsNCgkJYW5pbWF0aW9uLm9wYWNpdHkgPSAwOw0KCX0NCg0KCSQuZWZmZWN0cy5zYXZlU3R5bGUoIGVsZW1lbnQgKTsNCg0KCWVsZW1lbnQNCgkJLmNzcyggew0KCQkJYmFja2dyb3VuZEltYWdlOiAibm9uZSIsDQoJCQliYWNrZ3JvdW5kQ29sb3I6IG9wdGlvbnMuY29sb3IgfHwgIiNmZmZmOTkiDQoJCX0gKQ0KCQkuYW5pbWF0ZSggYW5pbWF0aW9uLCB7DQoJCQlxdWV1ZTogZmFsc2UsDQoJCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwNCgkJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsDQoJCQljb21wbGV0ZTogZG9uZQ0KCQl9ICk7DQp9ICk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgRWZmZWN0cyBTaXplIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBTaXplIEVmZmVjdA0KLy8+Pmdyb3VwOiBFZmZlY3RzDQovLz4+ZGVzY3JpcHRpb246IFJlc2l6ZSBhbiBlbGVtZW50IHRvIGEgc3BlY2lmaWVkIHdpZHRoIGFuZCBoZWlnaHQuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2l6ZS1lZmZlY3QvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGVmZmVjdHNFZmZlY3RTaXplID0gJC5lZmZlY3RzLmRlZmluZSggInNpemUiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsNCg0KCS8vIENyZWF0ZSBlbGVtZW50DQoJdmFyIGJhc2VsaW5lLCBmYWN0b3IsIHRlbXAsDQoJCWVsZW1lbnQgPSAkKCB0aGlzICksDQoNCgkJLy8gQ29weSBmb3IgY2hpbGRyZW4NCgkJY1Byb3BzID0gWyAiZm9udFNpemUiIF0sDQoJCXZQcm9wcyA9IFsgImJvcmRlclRvcFdpZHRoIiwgImJvcmRlckJvdHRvbVdpZHRoIiwgInBhZGRpbmdUb3AiLCAicGFkZGluZ0JvdHRvbSIgXSwNCgkJaFByb3BzID0gWyAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiBdLA0KDQoJCS8vIFNldCBvcHRpb25zDQoJCW1vZGUgPSBvcHRpb25zLm1vZGUsDQoJCXJlc3RvcmUgPSBtb2RlICE9PSAiZWZmZWN0IiwNCgkJc2NhbGUgPSBvcHRpb25zLnNjYWxlIHx8ICJib3RoIiwNCgkJb3JpZ2luID0gb3B0aW9ucy5vcmlnaW4gfHwgWyAibWlkZGxlIiwgImNlbnRlciIgXSwNCgkJcG9zaXRpb24gPSBlbGVtZW50LmNzcyggInBvc2l0aW9uIiApLA0KCQlwb3MgPSBlbGVtZW50LnBvc2l0aW9uKCksDQoJCW9yaWdpbmFsID0gJC5lZmZlY3RzLnNjYWxlZERpbWVuc2lvbnMoIGVsZW1lbnQgKSwNCgkJZnJvbSA9IG9wdGlvbnMuZnJvbSB8fCBvcmlnaW5hbCwNCgkJdG8gPSBvcHRpb25zLnRvIHx8ICQuZWZmZWN0cy5zY2FsZWREaW1lbnNpb25zKCBlbGVtZW50LCAwICk7DQoNCgkkLmVmZmVjdHMuY3JlYXRlUGxhY2Vob2xkZXIoIGVsZW1lbnQgKTsNCg0KCWlmICggbW9kZSA9PT0gInNob3ciICkgew0KCQl0ZW1wID0gZnJvbTsNCgkJZnJvbSA9IHRvOw0KCQl0byA9IHRlbXA7DQoJfQ0KDQoJLy8gU2V0IHNjYWxpbmcgZmFjdG9yDQoJZmFjdG9yID0gew0KCQlmcm9tOiB7DQoJCQl5OiBmcm9tLmhlaWdodCAvIG9yaWdpbmFsLmhlaWdodCwNCgkJCXg6IGZyb20ud2lkdGggLyBvcmlnaW5hbC53aWR0aA0KCQl9LA0KCQl0bzogew0KCQkJeTogdG8uaGVpZ2h0IC8gb3JpZ2luYWwuaGVpZ2h0LA0KCQkJeDogdG8ud2lkdGggLyBvcmlnaW5hbC53aWR0aA0KCQl9DQoJfTsNCg0KCS8vIFNjYWxlIHRoZSBjc3MgYm94DQoJaWYgKCBzY2FsZSA9PT0gImJveCIgfHwgc2NhbGUgPT09ICJib3RoIiApIHsNCg0KCQkvLyBWZXJ0aWNhbCBwcm9wcyBzY2FsaW5nDQoJCWlmICggZmFjdG9yLmZyb20ueSAhPT0gZmFjdG9yLnRvLnkgKSB7DQoJCQlmcm9tID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGVsZW1lbnQsIHZQcm9wcywgZmFjdG9yLmZyb20ueSwgZnJvbSApOw0KCQkJdG8gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWxlbWVudCwgdlByb3BzLCBmYWN0b3IudG8ueSwgdG8gKTsNCgkJfQ0KDQoJCS8vIEhvcml6b250YWwgcHJvcHMgc2NhbGluZw0KCQlpZiAoIGZhY3Rvci5mcm9tLnggIT09IGZhY3Rvci50by54ICkgew0KCQkJZnJvbSA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbGVtZW50LCBoUHJvcHMsIGZhY3Rvci5mcm9tLngsIGZyb20gKTsNCgkJCXRvID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGVsZW1lbnQsIGhQcm9wcywgZmFjdG9yLnRvLngsIHRvICk7DQoJCX0NCgl9DQoNCgkvLyBTY2FsZSB0aGUgY29udGVudA0KCWlmICggc2NhbGUgPT09ICJjb250ZW50IiB8fCBzY2FsZSA9PT0gImJvdGgiICkgew0KDQoJCS8vIFZlcnRpY2FsIHByb3BzIHNjYWxpbmcNCgkJaWYgKCBmYWN0b3IuZnJvbS55ICE9PSBmYWN0b3IudG8ueSApIHsNCgkJCWZyb20gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWxlbWVudCwgY1Byb3BzLCBmYWN0b3IuZnJvbS55LCBmcm9tICk7DQoJCQl0byA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbGVtZW50LCBjUHJvcHMsIGZhY3Rvci50by55LCB0byApOw0KCQl9DQoJfQ0KDQoJLy8gQWRqdXN0IHRoZSBwb3NpdGlvbiBwcm9wZXJ0aWVzIGJhc2VkIG9uIHRoZSBwcm92aWRlZCBvcmlnaW4gcG9pbnRzDQoJaWYgKCBvcmlnaW4gKSB7DQoJCWJhc2VsaW5lID0gJC5lZmZlY3RzLmdldEJhc2VsaW5lKCBvcmlnaW4sIG9yaWdpbmFsICk7DQoJCWZyb20udG9wID0gKCBvcmlnaW5hbC5vdXRlckhlaWdodCAtIGZyb20ub3V0ZXJIZWlnaHQgKSAqIGJhc2VsaW5lLnkgKyBwb3MudG9wOw0KCQlmcm9tLmxlZnQgPSAoIG9yaWdpbmFsLm91dGVyV2lkdGggLSBmcm9tLm91dGVyV2lkdGggKSAqIGJhc2VsaW5lLnggKyBwb3MubGVmdDsNCgkJdG8udG9wID0gKCBvcmlnaW5hbC5vdXRlckhlaWdodCAtIHRvLm91dGVySGVpZ2h0ICkgKiBiYXNlbGluZS55ICsgcG9zLnRvcDsNCgkJdG8ubGVmdCA9ICggb3JpZ2luYWwub3V0ZXJXaWR0aCAtIHRvLm91dGVyV2lkdGggKSAqIGJhc2VsaW5lLnggKyBwb3MubGVmdDsNCgl9DQoJZWxlbWVudC5jc3MoIGZyb20gKTsNCg0KCS8vIEFuaW1hdGUgdGhlIGNoaWxkcmVuIGlmIGRlc2lyZWQNCglpZiAoIHNjYWxlID09PSAiY29udGVudCIgfHwgc2NhbGUgPT09ICJib3RoIiApIHsNCg0KCQl2UHJvcHMgPSB2UHJvcHMuY29uY2F0KCBbICJtYXJnaW5Ub3AiLCAibWFyZ2luQm90dG9tIiBdICkuY29uY2F0KCBjUHJvcHMgKTsNCgkJaFByb3BzID0gaFByb3BzLmNvbmNhdCggWyAibWFyZ2luTGVmdCIsICJtYXJnaW5SaWdodCIgXSApOw0KDQoJCS8vIE9ubHkgYW5pbWF0ZSBjaGlsZHJlbiB3aXRoIHdpZHRoIGF0dHJpYnV0ZXMgc3BlY2lmaWVkDQoJCS8vIFRPRE86IGlzIHRoaXMgcmlnaHQ\/IHNob3VsZCB3ZSBpbmNsdWRlIGFueXRoaW5nIHdpdGggY3NzIHdpZHRoIHNwZWNpZmllZCBhcyB3ZWxsDQoJCWVsZW1lbnQuZmluZCggIipbd2lkdGhdIiApLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJdmFyIGNoaWxkID0gJCggdGhpcyApLA0KCQkJCWNoaWxkT3JpZ2luYWwgPSAkLmVmZmVjdHMuc2NhbGVkRGltZW5zaW9ucyggY2hpbGQgKSwNCgkJCQljaGlsZEZyb20gPSB7DQoJCQkJCWhlaWdodDogY2hpbGRPcmlnaW5hbC5oZWlnaHQgKiBmYWN0b3IuZnJvbS55LA0KCQkJCQl3aWR0aDogY2hpbGRPcmlnaW5hbC53aWR0aCAqIGZhY3Rvci5mcm9tLngsDQoJCQkJCW91dGVySGVpZ2h0OiBjaGlsZE9yaWdpbmFsLm91dGVySGVpZ2h0ICogZmFjdG9yLmZyb20ueSwNCgkJCQkJb3V0ZXJXaWR0aDogY2hpbGRPcmlnaW5hbC5vdXRlcldpZHRoICogZmFjdG9yLmZyb20ueA0KCQkJCX0sDQoJCQkJY2hpbGRUbyA9IHsNCgkJCQkJaGVpZ2h0OiBjaGlsZE9yaWdpbmFsLmhlaWdodCAqIGZhY3Rvci50by55LA0KCQkJCQl3aWR0aDogY2hpbGRPcmlnaW5hbC53aWR0aCAqIGZhY3Rvci50by54LA0KCQkJCQlvdXRlckhlaWdodDogY2hpbGRPcmlnaW5hbC5oZWlnaHQgKiBmYWN0b3IudG8ueSwNCgkJCQkJb3V0ZXJXaWR0aDogY2hpbGRPcmlnaW5hbC53aWR0aCAqIGZhY3Rvci50by54DQoJCQkJfTsNCg0KCQkJLy8gVmVydGljYWwgcHJvcHMgc2NhbGluZw0KCQkJaWYgKCBmYWN0b3IuZnJvbS55ICE9PSBmYWN0b3IudG8ueSApIHsNCgkJCQljaGlsZEZyb20gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggY2hpbGQsIHZQcm9wcywgZmFjdG9yLmZyb20ueSwgY2hpbGRGcm9tICk7DQoJCQkJY2hpbGRUbyA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBjaGlsZCwgdlByb3BzLCBmYWN0b3IudG8ueSwgY2hpbGRUbyApOw0KCQkJfQ0KDQoJCQkvLyBIb3Jpem9udGFsIHByb3BzIHNjYWxpbmcNCgkJCWlmICggZmFjdG9yLmZyb20ueCAhPT0gZmFjdG9yLnRvLnggKSB7DQoJCQkJY2hpbGRGcm9tID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGNoaWxkLCBoUHJvcHMsIGZhY3Rvci5mcm9tLngsIGNoaWxkRnJvbSApOw0KCQkJCWNoaWxkVG8gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggY2hpbGQsIGhQcm9wcywgZmFjdG9yLnRvLngsIGNoaWxkVG8gKTsNCgkJCX0NCg0KCQkJaWYgKCByZXN0b3JlICkgew0KCQkJCSQuZWZmZWN0cy5zYXZlU3R5bGUoIGNoaWxkICk7DQoJCQl9DQoNCgkJCS8vIEFuaW1hdGUgY2hpbGRyZW4NCgkJCWNoaWxkLmNzcyggY2hpbGRGcm9tICk7DQoJCQljaGlsZC5hbmltYXRlKCBjaGlsZFRvLCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgZnVuY3Rpb24oKSB7DQoNCgkJCQkvLyBSZXN0b3JlIGNoaWxkcmVuDQoJCQkJaWYgKCByZXN0b3JlICkgew0KCQkJCQkkLmVmZmVjdHMucmVzdG9yZVN0eWxlKCBjaGlsZCApOw0KCQkJCX0NCgkJCX0gKTsNCgkJfSApOw0KCX0NCg0KCS8vIEFuaW1hdGUNCgllbGVtZW50LmFuaW1hdGUoIHRvLCB7DQoJCXF1ZXVlOiBmYWxzZSwNCgkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sDQoJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsDQoJCWNvbXBsZXRlOiBmdW5jdGlvbigpIHsNCg0KCQkJdmFyIG9mZnNldCA9IGVsZW1lbnQub2Zmc2V0KCk7DQoNCgkJCWlmICggdG8ub3BhY2l0eSA9PT0gMCApIHsNCgkJCQllbGVtZW50LmNzcyggIm9wYWNpdHkiLCBmcm9tLm9wYWNpdHkgKTsNCgkJCX0NCg0KCQkJaWYgKCAhcmVzdG9yZSApIHsNCgkJCQllbGVtZW50DQoJCQkJCS5jc3MoICJwb3NpdGlvbiIsIHBvc2l0aW9uID09PSAic3RhdGljIiA\/ICJyZWxhdGl2ZSIgOiBwb3NpdGlvbiApDQoJCQkJCS5vZmZzZXQoIG9mZnNldCApOw0KDQoJCQkJLy8gTmVlZCB0byBzYXZlIHN0eWxlIGhlcmUgc28gdGhhdCBhdXRvbWF0aWMgc3R5bGUgcmVzdG9yYXRpb24NCgkJCQkvLyBkb2Vzbid0IHJlc3RvcmUgdG8gdGhlIG9yaWdpbmFsIHN0eWxlcyBmcm9tIGJlZm9yZSB0aGUgYW5pbWF0aW9uLg0KCQkJCSQuZWZmZWN0cy5zYXZlU3R5bGUoIGVsZW1lbnQgKTsNCgkJCX0NCg0KCQkJZG9uZSgpOw0KCQl9DQoJfSApOw0KDQp9ICk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgRWZmZWN0cyBTY2FsZSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogU2NhbGUgRWZmZWN0DQovLz4+Z3JvdXA6IEVmZmVjdHMNCi8vPj5kZXNjcmlwdGlvbjogR3Jvd3Mgb3Igc2hyaW5rcyBhbiBlbGVtZW50IGFuZCBpdHMgY29udGVudC4NCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9zY2FsZS1lZmZlY3QvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGVmZmVjdHNFZmZlY3RTY2FsZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJzY2FsZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgew0KDQoJLy8gQ3JlYXRlIGVsZW1lbnQNCgl2YXIgZWwgPSAkKCB0aGlzICksDQoJCW1vZGUgPSBvcHRpb25zLm1vZGUsDQoJCXBlcmNlbnQgPSBwYXJzZUludCggb3B0aW9ucy5wZXJjZW50LCAxMCApIHx8DQoJCQkoIHBhcnNlSW50KCBvcHRpb25zLnBlcmNlbnQsIDEwICkgPT09IDAgPyAwIDogKCBtb2RlICE9PSAiZWZmZWN0IiA\/IDAgOiAxMDAgKSApLA0KDQoJCW5ld09wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwgew0KCQkJZnJvbTogJC5lZmZlY3RzLnNjYWxlZERpbWVuc2lvbnMoIGVsICksDQoJCQl0bzogJC5lZmZlY3RzLnNjYWxlZERpbWVuc2lvbnMoIGVsLCBwZXJjZW50LCBvcHRpb25zLmRpcmVjdGlvbiB8fCAiYm90aCIgKSwNCgkJCW9yaWdpbjogb3B0aW9ucy5vcmlnaW4gfHwgWyAibWlkZGxlIiwgImNlbnRlciIgXQ0KCQl9LCBvcHRpb25zICk7DQoNCgkvLyBGYWRlIG9wdGlvbiB0byBzdXBwb3J0IHB1ZmYNCglpZiAoIG9wdGlvbnMuZmFkZSApIHsNCgkJbmV3T3B0aW9ucy5mcm9tLm9wYWNpdHkgPSAxOw0KCQluZXdPcHRpb25zLnRvLm9wYWNpdHkgPSAwOw0KCX0NCg0KCSQuZWZmZWN0cy5lZmZlY3Quc2l6ZS5jYWxsKCB0aGlzLCBuZXdPcHRpb25zLCBkb25lICk7DQp9ICk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgRWZmZWN0cyBQdWZmIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBQdWZmIEVmZmVjdA0KLy8+Pmdyb3VwOiBFZmZlY3RzDQovLz4+ZGVzY3JpcHRpb246IENyZWF0ZXMgYSBwdWZmIGVmZmVjdCBieSBzY2FsaW5nIHRoZSBlbGVtZW50IHVwIGFuZCBoaWRpbmcgaXQgYXQgdGhlIHNhbWUgdGltZS4NCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wdWZmLWVmZmVjdC8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvDQoNCg0KDQp2YXIgZWZmZWN0c0VmZmVjdFB1ZmYgPSAkLmVmZmVjdHMuZGVmaW5lKCAicHVmZiIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7DQoJdmFyIG5ld09wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sIG9wdGlvbnMsIHsNCgkJZmFkZTogdHJ1ZSwNCgkJcGVyY2VudDogcGFyc2VJbnQoIG9wdGlvbnMucGVyY2VudCwgMTAgKSB8fCAxNTANCgl9ICk7DQoNCgkkLmVmZmVjdHMuZWZmZWN0LnNjYWxlLmNhbGwoIHRoaXMsIG5ld09wdGlvbnMsIGRvbmUgKTsNCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBFZmZlY3RzIFB1bHNhdGUgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IFB1bHNhdGUgRWZmZWN0DQovLz4+Z3JvdXA6IEVmZmVjdHMNCi8vPj5kZXNjcmlwdGlvbjogUHVsc2F0ZXMgYW4gZWxlbWVudCBuIHRpbWVzIGJ5IGNoYW5naW5nIHRoZSBvcGFjaXR5IHRvIHplcm8gYW5kIGJhY2suDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vcHVsc2F0ZS1lZmZlY3QvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0Lw0KDQoNCg0KdmFyIGVmZmVjdHNFZmZlY3RQdWxzYXRlID0gJC5lZmZlY3RzLmRlZmluZSggInB1bHNhdGUiLCAic2hvdyIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgew0KCXZhciBlbGVtZW50ID0gJCggdGhpcyApLA0KCQltb2RlID0gb3B0aW9ucy5tb2RlLA0KCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLA0KCQloaWRlID0gbW9kZSA9PT0gImhpZGUiLA0KCQlzaG93aGlkZSA9IHNob3cgfHwgaGlkZSwNCg0KCQkvLyBTaG93aW5nIG9yIGhpZGluZyBsZWF2ZXMgb2ZmIHRoZSAibGFzdCIgYW5pbWF0aW9uDQoJCWFuaW1zID0gKCAoIG9wdGlvbnMudGltZXMgfHwgNSApICogMiApICsgKCBzaG93aGlkZSA\/IDEgOiAwICksDQoJCWR1cmF0aW9uID0gb3B0aW9ucy5kdXJhdGlvbiAvIGFuaW1zLA0KCQlhbmltYXRlVG8gPSAwLA0KCQlpID0gMSwNCgkJcXVldWVsZW4gPSBlbGVtZW50LnF1ZXVlKCkubGVuZ3RoOw0KDQoJaWYgKCBzaG93IHx8ICFlbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7DQoJCWVsZW1lbnQuY3NzKCAib3BhY2l0eSIsIDAgKS5zaG93KCk7DQoJCWFuaW1hdGVUbyA9IDE7DQoJfQ0KDQoJLy8gQW5pbXMgLSAxIG9wYWNpdHkgInRvZ2dsZXMiDQoJZm9yICggOyBpIDwgYW5pbXM7IGkrKyApIHsNCgkJZWxlbWVudC5hbmltYXRlKCB7IG9wYWNpdHk6IGFuaW1hdGVUbyB9LCBkdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcgKTsNCgkJYW5pbWF0ZVRvID0gMSAtIGFuaW1hdGVUbzsNCgl9DQoNCgllbGVtZW50LmFuaW1hdGUoIHsgb3BhY2l0eTogYW5pbWF0ZVRvIH0sIGR1cmF0aW9uLCBvcHRpb25zLmVhc2luZyApOw0KDQoJZWxlbWVudC5xdWV1ZSggZG9uZSApOw0KDQoJJC5lZmZlY3RzLnVuc2hpZnQoIGVsZW1lbnQsIHF1ZXVlbGVuLCBhbmltcyArIDEgKTsNCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBFZmZlY3RzIFNoYWtlIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBTaGFrZSBFZmZlY3QNCi8vPj5ncm91cDogRWZmZWN0cw0KLy8+PmRlc2NyaXB0aW9uOiBTaGFrZXMgYW4gZWxlbWVudCBob3Jpem9udGFsbHkgb3IgdmVydGljYWxseSBuIHRpbWVzLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NoYWtlLWVmZmVjdC8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvDQoNCg0KDQp2YXIgZWZmZWN0c0VmZmVjdFNoYWtlID0gJC5lZmZlY3RzLmRlZmluZSggInNoYWtlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7DQoNCgl2YXIgaSA9IDEsDQoJCWVsZW1lbnQgPSAkKCB0aGlzICksDQoJCWRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJsZWZ0IiwNCgkJZGlzdGFuY2UgPSBvcHRpb25zLmRpc3RhbmNlIHx8IDIwLA0KCQl0aW1lcyA9IG9wdGlvbnMudGltZXMgfHwgMywNCgkJYW5pbXMgPSB0aW1lcyAqIDIgKyAxLA0KCQlzcGVlZCA9IE1hdGgucm91bmQoIG9wdGlvbnMuZHVyYXRpb24gLyBhbmltcyApLA0KCQlyZWYgPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJkb3duIiApID8gInRvcCIgOiAibGVmdCIsDQoJCXBvc2l0aXZlTW90aW9uID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAibGVmdCIgKSwNCgkJYW5pbWF0aW9uID0ge30sDQoJCWFuaW1hdGlvbjEgPSB7fSwNCgkJYW5pbWF0aW9uMiA9IHt9LA0KDQoJCXF1ZXVlbGVuID0gZWxlbWVudC5xdWV1ZSgpLmxlbmd0aDsNCg0KCSQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApOw0KDQoJLy8gQW5pbWF0aW9uDQoJYW5pbWF0aW9uWyByZWYgXSA9ICggcG9zaXRpdmVNb3Rpb24gPyAiLT0iIDogIis9IiApICsgZGlzdGFuY2U7DQoJYW5pbWF0aW9uMVsgcmVmIF0gPSAoIHBvc2l0aXZlTW90aW9uID8gIis9IiA6ICItPSIgKSArIGRpc3RhbmNlICogMjsNCglhbmltYXRpb24yWyByZWYgXSA9ICggcG9zaXRpdmVNb3Rpb24gPyAiLT0iIDogIis9IiApICsgZGlzdGFuY2UgKiAyOw0KDQoJLy8gQW5pbWF0ZQ0KCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0aW9uLCBzcGVlZCwgb3B0aW9ucy5lYXNpbmcgKTsNCg0KCS8vIFNoYWtlcw0KCWZvciAoIDsgaSA8IHRpbWVzOyBpKysgKSB7DQoJCWVsZW1lbnQNCgkJCS5hbmltYXRlKCBhbmltYXRpb24xLCBzcGVlZCwgb3B0aW9ucy5lYXNpbmcgKQ0KCQkJLmFuaW1hdGUoIGFuaW1hdGlvbjIsIHNwZWVkLCBvcHRpb25zLmVhc2luZyApOw0KCX0NCg0KCWVsZW1lbnQNCgkJLmFuaW1hdGUoIGFuaW1hdGlvbjEsIHNwZWVkLCBvcHRpb25zLmVhc2luZyApDQoJCS5hbmltYXRlKCBhbmltYXRpb24sIHNwZWVkIC8gMiwgb3B0aW9ucy5lYXNpbmcgKQ0KCQkucXVldWUoIGRvbmUgKTsNCg0KCSQuZWZmZWN0cy51bnNoaWZ0KCBlbGVtZW50LCBxdWV1ZWxlbiwgYW5pbXMgKyAxICk7DQp9ICk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgRWZmZWN0cyBTbGlkZSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogU2xpZGUgRWZmZWN0DQovLz4+Z3JvdXA6IEVmZmVjdHMNCi8vPj5kZXNjcmlwdGlvbjogU2xpZGVzIGFuIGVsZW1lbnQgaW4gYW5kIG91dCBvZiB0aGUgdmlld3BvcnQuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2xpZGUtZWZmZWN0Lw0KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8NCg0KDQoNCnZhciBlZmZlY3RzRWZmZWN0U2xpZGUgPSAkLmVmZmVjdHMuZGVmaW5lKCAic2xpZGUiLCAic2hvdyIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgew0KCXZhciBzdGFydENsaXAsIHN0YXJ0UmVmLA0KCQllbGVtZW50ID0gJCggdGhpcyApLA0KCQltYXAgPSB7DQoJCQl1cDogWyAiYm90dG9tIiwgInRvcCIgXSwNCgkJCWRvd246IFsgInRvcCIsICJib3R0b20iIF0sDQoJCQlsZWZ0OiBbICJyaWdodCIsICJsZWZ0IiBdLA0KCQkJcmlnaHQ6IFsgImxlZnQiLCAicmlnaHQiIF0NCgkJfSwNCgkJbW9kZSA9IG9wdGlvbnMubW9kZSwNCgkJZGlyZWN0aW9uID0gb3B0aW9ucy5kaXJlY3Rpb24gfHwgImxlZnQiLA0KCQlyZWYgPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJkb3duIiApID8gInRvcCIgOiAibGVmdCIsDQoJCXBvc2l0aXZlTW90aW9uID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAibGVmdCIgKSwNCgkJZGlzdGFuY2UgPSBvcHRpb25zLmRpc3RhbmNlIHx8DQoJCQllbGVtZW50WyByZWYgPT09ICJ0b3AiID8gIm91dGVySGVpZ2h0IiA6ICJvdXRlcldpZHRoIiBdKCB0cnVlICksDQoJCWFuaW1hdGlvbiA9IHt9Ow0KDQoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7DQoNCglzdGFydENsaXAgPSBlbGVtZW50LmNzc0NsaXAoKTsNCglzdGFydFJlZiA9IGVsZW1lbnQucG9zaXRpb24oKVsgcmVmIF07DQoNCgkvLyBEZWZpbmUgaGlkZSBhbmltYXRpb24NCglhbmltYXRpb25bIHJlZiBdID0gKCBwb3NpdGl2ZU1vdGlvbiA\/IC0xIDogMSApICogZGlzdGFuY2UgKyBzdGFydFJlZjsNCglhbmltYXRpb24uY2xpcCA9IGVsZW1lbnQuY3NzQ2xpcCgpOw0KCWFuaW1hdGlvbi5jbGlwWyBtYXBbIGRpcmVjdGlvbiBdWyAxIF0gXSA9IGFuaW1hdGlvbi5jbGlwWyBtYXBbIGRpcmVjdGlvbiBdWyAwIF0gXTsNCg0KCS8vIFJldmVyc2UgdGhlIGFuaW1hdGlvbiBpZiB3ZSdyZSBzaG93aW5nDQoJaWYgKCBtb2RlID09PSAic2hvdyIgKSB7DQoJCWVsZW1lbnQuY3NzQ2xpcCggYW5pbWF0aW9uLmNsaXAgKTsNCgkJZWxlbWVudC5jc3MoIHJlZiwgYW5pbWF0aW9uWyByZWYgXSApOw0KCQlhbmltYXRpb24uY2xpcCA9IHN0YXJ0Q2xpcDsNCgkJYW5pbWF0aW9uWyByZWYgXSA9IHN0YXJ0UmVmOw0KCX0NCg0KCS8vIEFjdHVhbGx5IGFuaW1hdGUNCgllbGVtZW50LmFuaW1hdGUoIGFuaW1hdGlvbiwgew0KCQlxdWV1ZTogZmFsc2UsDQoJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLA0KCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLA0KCQljb21wbGV0ZTogZG9uZQ0KCX0gKTsNCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBFZmZlY3RzIFRyYW5zZmVyIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBUcmFuc2ZlciBFZmZlY3QNCi8vPj5ncm91cDogRWZmZWN0cw0KLy8+PmRlc2NyaXB0aW9uOiBEaXNwbGF5cyBhIHRyYW5zZmVyIGVmZmVjdCBmcm9tIG9uZSBlbGVtZW50IHRvIGFub3RoZXIuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdHJhbnNmZXItZWZmZWN0Lw0KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8NCg0KDQoNCnZhciBlZmZlY3Q7DQppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsNCgllZmZlY3QgPSAkLmVmZmVjdHMuZGVmaW5lKCAidHJhbnNmZXIiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsNCgkJJCggdGhpcyApLnRyYW5zZmVyKCBvcHRpb25zLCBkb25lICk7DQoJfSApOw0KfQ0KdmFyIGVmZmVjdHNFZmZlY3RUcmFuc2ZlciA9IGVmZmVjdDsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBGb2N1c2FibGUgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IDpmb2N1c2FibGUgU2VsZWN0b3INCi8vPj5ncm91cDogQ29yZQ0KLy8+PmRlc2NyaXB0aW9uOiBTZWxlY3RzIGVsZW1lbnRzIHdoaWNoIGNhbiBiZSBmb2N1c2VkLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2ZvY3VzYWJsZS1zZWxlY3Rvci8NCg0KDQoNCi8vIFNlbGVjdG9ycw0KJC51aS5mb2N1c2FibGUgPSBmdW5jdGlvbiggZWxlbWVudCwgaGFzVGFiaW5kZXggKSB7DQoJdmFyIG1hcCwgbWFwTmFtZSwgaW1nLCBmb2N1c2FibGVJZlZpc2libGUsIGZpZWxkc2V0LA0KCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCg0KCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsNCgkJbWFwID0gZWxlbWVudC5wYXJlbnROb2RlOw0KCQltYXBOYW1lID0gbWFwLm5hbWU7DQoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCgkJaW1nID0gJCggImltZ1t1c2VtYXA9JyMiICsgbWFwTmFtZSArICInXSIgKTsNCgkJcmV0dXJuIGltZy5sZW5ndGggPiAwICYmIGltZy5pcyggIjp2aXNpYmxlIiApOw0KCX0NCg0KCWlmICggL14oaW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbnxvYmplY3QpJC8udGVzdCggbm9kZU5hbWUgKSApIHsNCgkJZm9jdXNhYmxlSWZWaXNpYmxlID0gIWVsZW1lbnQuZGlzYWJsZWQ7DQoNCgkJaWYgKCBmb2N1c2FibGVJZlZpc2libGUgKSB7DQoNCgkJCS8vIEZvcm0gY29udHJvbHMgd2l0aGluIGEgZGlzYWJsZWQgZmllbGRzZXQgYXJlIGRpc2FibGVkLg0KCQkJLy8gSG93ZXZlciwgY29udHJvbHMgd2l0aGluIHRoZSBmaWVsZHNldCdzIGxlZ2VuZCBkbyBub3QgZ2V0IGRpc2FibGVkLg0KCQkJLy8gU2luY2UgY29udHJvbHMgZ2VuZXJhbGx5IGFyZW4ndCBwbGFjZWQgaW5zaWRlIGxlZ2VuZHMsIHdlIHNraXANCgkJCS8vIHRoaXMgcG9ydGlvbiBvZiB0aGUgY2hlY2suDQoJCQlmaWVsZHNldCA9ICQoIGVsZW1lbnQgKS5jbG9zZXN0KCAiZmllbGRzZXQiIClbIDAgXTsNCgkJCWlmICggZmllbGRzZXQgKSB7DQoJCQkJZm9jdXNhYmxlSWZWaXNpYmxlID0gIWZpZWxkc2V0LmRpc2FibGVkOw0KCQkJfQ0KCQl9DQoJfSBlbHNlIGlmICggImEiID09PSBub2RlTmFtZSApIHsNCgkJZm9jdXNhYmxlSWZWaXNpYmxlID0gZWxlbWVudC5ocmVmIHx8IGhhc1RhYmluZGV4Ow0KCX0gZWxzZSB7DQoJCWZvY3VzYWJsZUlmVmlzaWJsZSA9IGhhc1RhYmluZGV4Ow0KCX0NCg0KCXJldHVybiBmb2N1c2FibGVJZlZpc2libGUgJiYgJCggZWxlbWVudCApLmlzKCAiOnZpc2libGUiICkgJiYgdmlzaWJsZSggJCggZWxlbWVudCApICk7DQp9Ow0KDQovLyBTdXBwb3J0OiBJRSA4IG9ubHkNCi8vIElFIDggZG9lc24ndCByZXNvbHZlIGluaGVyaXQgdG8gdmlzaWJsZS9oaWRkZW4gZm9yIGNvbXB1dGVkIHZhbHVlcw0KZnVuY3Rpb24gdmlzaWJsZSggZWxlbWVudCApIHsNCgl2YXIgdmlzaWJpbGl0eSA9IGVsZW1lbnQuY3NzKCAidmlzaWJpbGl0eSIgKTsNCgl3aGlsZSAoIHZpc2liaWxpdHkgPT09ICJpbmhlcml0IiApIHsNCgkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7DQoJCXZpc2liaWxpdHkgPSBlbGVtZW50LmNzcyggInZpc2liaWxpdHkiICk7DQoJfQ0KCXJldHVybiB2aXNpYmlsaXR5ICE9PSAiaGlkZGVuIjsNCn0NCg0KJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsNCglmb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQlyZXR1cm4gJC51aS5mb2N1c2FibGUoIGVsZW1lbnQsICQuYXR0ciggZWxlbWVudCwgInRhYmluZGV4IiApICE9IG51bGwgKTsNCgl9DQp9ICk7DQoNCnZhciBmb2N1c2FibGUgPSAkLnVpLmZvY3VzYWJsZTsNCg0KDQoNCg0KLy8gU3VwcG9ydDogSUU4IE9ubHkNCi8vIElFOCBkb2VzIG5vdCBzdXBwb3J0IHRoZSBmb3JtIGF0dHJpYnV0ZSBhbmQgd2hlbiBpdCBpcyBzdXBwbGllZC4gSXQgb3ZlcndyaXRlcyB0aGUgZm9ybSBwcm9wDQovLyB3aXRoIGEgc3RyaW5nLCBzbyB3ZSBuZWVkIHRvIGZpbmQgdGhlIHByb3BlciBmb3JtLg0KdmFyIGZvcm0gPSAkLmZuLmZvcm0gPSBmdW5jdGlvbigpIHsNCglyZXR1cm4gdHlwZW9mIHRoaXNbIDAgXS5mb3JtID09PSAic3RyaW5nIiA\/IHRoaXMuY2xvc2VzdCggImZvcm0iICkgOiAkKCB0aGlzWyAwIF0uZm9ybSApOw0KfTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBGb3JtIFJlc2V0IE1peGluIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBGb3JtIFJlc2V0IE1peGluDQovLz4+Z3JvdXA6IENvcmUNCi8vPj5kZXNjcmlwdGlvbjogUmVmcmVzaCBpbnB1dCB3aWRnZXRzIHdoZW4gdGhlaXIgZm9ybSBpcyByZXNldA0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2Zvcm0tcmVzZXQtbWl4aW4vDQoNCg0KDQp2YXIgZm9ybVJlc2V0TWl4aW4gPSAkLnVpLmZvcm1SZXNldE1peGluID0gew0KCV9mb3JtUmVzZXRIYW5kbGVyOiBmdW5jdGlvbigpIHsNCgkJdmFyIGZvcm0gPSAkKCB0aGlzICk7DQoNCgkJLy8gV2FpdCBmb3IgdGhlIGZvcm0gcmVzZXQgdG8gYWN0dWFsbHkgaGFwcGVuIGJlZm9yZSByZWZyZXNoaW5nDQoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KCQkJdmFyIGluc3RhbmNlcyA9IGZvcm0uZGF0YSggInVpLWZvcm0tcmVzZXQtaW5zdGFuY2VzIiApOw0KCQkJJC5lYWNoKCBpbnN0YW5jZXMsIGZ1bmN0aW9uKCkgew0KCQkJCXRoaXMucmVmcmVzaCgpOw0KCQkJfSApOw0KCQl9ICk7DQoJfSwNCg0KCV9iaW5kRm9ybVJlc2V0SGFuZGxlcjogZnVuY3Rpb24oKSB7DQoJCXRoaXMuZm9ybSA9IHRoaXMuZWxlbWVudC5mb3JtKCk7DQoJCWlmICggIXRoaXMuZm9ybS5sZW5ndGggKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl2YXIgaW5zdGFuY2VzID0gdGhpcy5mb3JtLmRhdGEoICJ1aS1mb3JtLXJlc2V0LWluc3RhbmNlcyIgKSB8fCBbXTsNCgkJaWYgKCAhaW5zdGFuY2VzLmxlbmd0aCApIHsNCg0KCQkJLy8gV2UgZG9uJ3QgdXNlIF9vbigpIGhlcmUgYmVjYXVzZSB3ZSB1c2UgYSBzaW5nbGUgZXZlbnQgaGFuZGxlciBwZXIgZm9ybQ0KCQkJdGhpcy5mb3JtLm9uKCAicmVzZXQudWktZm9ybS1yZXNldCIsIHRoaXMuX2Zvcm1SZXNldEhhbmRsZXIgKTsNCgkJfQ0KCQlpbnN0YW5jZXMucHVzaCggdGhpcyApOw0KCQl0aGlzLmZvcm0uZGF0YSggInVpLWZvcm0tcmVzZXQtaW5zdGFuY2VzIiwgaW5zdGFuY2VzICk7DQoJfSwNCg0KCV91bmJpbmRGb3JtUmVzZXRIYW5kbGVyOiBmdW5jdGlvbigpIHsNCgkJaWYgKCAhdGhpcy5mb3JtLmxlbmd0aCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXZhciBpbnN0YW5jZXMgPSB0aGlzLmZvcm0uZGF0YSggInVpLWZvcm0tcmVzZXQtaW5zdGFuY2VzIiApOw0KCQlpbnN0YW5jZXMuc3BsaWNlKCAkLmluQXJyYXkoIHRoaXMsIGluc3RhbmNlcyApLCAxICk7DQoJCWlmICggaW5zdGFuY2VzLmxlbmd0aCApIHsNCgkJCXRoaXMuZm9ybS5kYXRhKCAidWktZm9ybS1yZXNldC1pbnN0YW5jZXMiLCBpbnN0YW5jZXMgKTsNCgkJfSBlbHNlIHsNCgkJCXRoaXMuZm9ybQ0KCQkJCS5yZW1vdmVEYXRhKCAidWktZm9ybS1yZXNldC1pbnN0YW5jZXMiICkNCgkJCQkub2ZmKCAicmVzZXQudWktZm9ybS1yZXNldCIgKTsNCgkJfQ0KCX0NCn07DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgU3VwcG9ydCBmb3IgalF1ZXJ5IGNvcmUgMS43LnggMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqDQogKi8NCg0KLy8+PmxhYmVsOiBqUXVlcnkgMS43IFN1cHBvcnQNCi8vPj5ncm91cDogQ29yZQ0KLy8+PmRlc2NyaXB0aW9uOiBTdXBwb3J0IHZlcnNpb24gMS43Lnggb2YgalF1ZXJ5IGNvcmUNCg0KDQoNCi8vIFN1cHBvcnQ6IGpRdWVyeSAxLjcgb25seQ0KLy8gTm90IGEgZ3JlYXQgd2F5IHRvIGNoZWNrIHZlcnNpb25zLCBidXQgc2luY2Ugd2Ugb25seSBzdXBwb3J0IDEuNysgYW5kIG9ubHkNCi8vIG5lZWQgdG8gZGV0ZWN0IDwxLjgsIHRoaXMgaXMgYSBzaW1wbGUgY2hlY2sgdGhhdCBzaG91bGQgc3VmZmljZS4gQ2hlY2tpbmcNCi8vIGZvciAiMS43LiIgd291bGQgYmUgYSBiaXQgc2FmZXIsIGJ1dCB0aGUgdmVyc2lvbiBzdHJpbmcgaXMgMS43LCBub3QgMS43LjANCi8vIGFuZCB3ZSdsbCBuZXZlciByZWFjaCAxLjcwLjAgKGlmIHdlIGRvLCB3ZSBjZXJ0YWlubHkgd29uJ3QgYmUgc3VwcG9ydGluZw0KLy8gMS43IGFueW1vcmUpLiBTZWUgIzExMTk3IGZvciB3aHkgd2UncmUgbm90IHVzaW5nIGZlYXR1cmUgZGV0ZWN0aW9uLg0KaWYgKCAkLmZuLmpxdWVyeS5zdWJzdHJpbmcoIDAsIDMgKSA9PT0gIjEuNyIgKSB7DQoNCgkvLyBTZXR0ZXJzIGZvciAuaW5uZXJXaWR0aCgpLCAuaW5uZXJIZWlnaHQoKSwgLm91dGVyV2lkdGgoKSwgLm91dGVySGVpZ2h0KCkNCgkvLyBVbmxpa2UgalF1ZXJ5IENvcmUgMS44KywgdGhlc2Ugb25seSBzdXBwb3J0IG51bWVyaWMgdmFsdWVzIHRvIHNldCB0aGUNCgkvLyBkaW1lbnNpb25zIGluIHBpeGVscw0KCSQuZWFjaCggWyAiV2lkdGgiLCAiSGVpZ2h0IiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsNCgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sDQoJCQl0eXBlID0gbmFtZS50b0xvd2VyQ2FzZSgpLA0KCQkJb3JpZyA9IHsNCgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsDQoJCQkJaW5uZXJIZWlnaHQ6ICQuZm4uaW5uZXJIZWlnaHQsDQoJCQkJb3V0ZXJXaWR0aDogJC5mbi5vdXRlcldpZHRoLA0KCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0DQoJCQl9Ow0KDQoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7DQoJCQkkLmVhY2goIHNpZGUsIGZ1bmN0aW9uKCkgew0KCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJwYWRkaW5nIiArIHRoaXMgKSApIHx8IDA7DQoJCQkJaWYgKCBib3JkZXIgKSB7DQoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJib3JkZXIiICsgdGhpcyArICJXaWR0aCIgKSApIHx8IDA7DQoJCQkJfQ0KCQkJCWlmICggbWFyZ2luICkgew0KCQkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAibWFyZ2luIiArIHRoaXMgKSApIHx8IDA7DQoJCQkJfQ0KCQkJfSApOw0KCQkJcmV0dXJuIHNpemU7DQoJCX0NCg0KCQkkLmZuWyAiaW5uZXIiICsgbmFtZSBdID0gZnVuY3Rpb24oIHNpemUgKSB7DQoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsNCgkJCQlyZXR1cm4gb3JpZ1sgImlubmVyIiArIG5hbWUgXS5jYWxsKCB0aGlzICk7DQoJCQl9DQoNCgkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOw0KCQkJfSApOw0KCQl9Ow0KDQoJCSQuZm5bICJvdXRlciIgKyBuYW1lIF0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgew0KCQkJaWYgKCB0eXBlb2Ygc2l6ZSAhPT0gIm51bWJlciIgKSB7DQoJCQkJcmV0dXJuIG9yaWdbICJvdXRlciIgKyBuYW1lIF0uY2FsbCggdGhpcywgc2l6ZSApOw0KCQkJfQ0KDQoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQkkKCB0aGlzICkuY3NzKCB0eXBlLCByZWR1Y2UoIHRoaXMsIHNpemUsIHRydWUsIG1hcmdpbiApICsgInB4IiApOw0KCQkJfSApOw0KCQl9Ow0KCX0gKTsNCg0KCSQuZm4uYWRkQmFjayA9IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8NCgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoIHNlbGVjdG9yICkNCgkJKTsNCgl9Ow0KfQ0KDQo7DQovKiENCiAqIGpRdWVyeSBVSSBLZXljb2RlIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBLZXljb2RlDQovLz4+Z3JvdXA6IENvcmUNCi8vPj5kZXNjcmlwdGlvbjogUHJvdmlkZSBrZXljb2RlcyBhcyBrZXluYW1lcw0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS51aS5rZXlDb2RlLw0KDQoNCnZhciBrZXljb2RlID0gJC51aS5rZXlDb2RlID0gew0KCUJBQ0tTUEFDRTogOCwNCglDT01NQTogMTg4LA0KCURFTEVURTogNDYsDQoJRE9XTjogNDAsDQoJRU5EOiAzNSwNCglFTlRFUjogMTMsDQoJRVNDQVBFOiAyNywNCglIT01FOiAzNiwNCglMRUZUOiAzNywNCglQQUdFX0RPV046IDM0LA0KCVBBR0VfVVA6IDMzLA0KCVBFUklPRDogMTkwLA0KCVJJR0hUOiAzOSwNCglTUEFDRTogMzIsDQoJVEFCOiA5LA0KCVVQOiAzOA0KfTsNCg0KDQoNCg0KLy8gSW50ZXJuYWwgdXNlIG9ubHkNCnZhciBlc2NhcGVTZWxlY3RvciA9ICQudWkuZXNjYXBlU2VsZWN0b3IgPSAoIGZ1bmN0aW9uKCkgew0KCXZhciBzZWxlY3RvckVzY2FwZSA9IC8oWyEiIyQlJicoKSorLC4vOjs8PT4\/QFtcXV5ge3x9fl0pL2c7DQoJcmV0dXJuIGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJcmV0dXJuIHNlbGVjdG9yLnJlcGxhY2UoIHNlbGVjdG9yRXNjYXBlLCAiXFwkMSIgKTsNCgl9Ow0KfSApKCk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgTGFiZWxzIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBsYWJlbHMNCi8vPj5ncm91cDogQ29yZQ0KLy8+PmRlc2NyaXB0aW9uOiBGaW5kIGFsbCB0aGUgbGFiZWxzIGFzc29jaWF0ZWQgd2l0aCBhIGdpdmVuIGlucHV0DQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vbGFiZWxzLw0KDQoNCg0KdmFyIGxhYmVscyA9ICQuZm4ubGFiZWxzID0gZnVuY3Rpb24oKSB7DQoJdmFyIGFuY2VzdG9yLCBzZWxlY3RvciwgaWQsIGxhYmVscywgYW5jZXN0b3JzOw0KDQoJLy8gQ2hlY2sgY29udHJvbC5sYWJlbHMgZmlyc3QNCglpZiAoIHRoaXNbIDAgXS5sYWJlbHMgJiYgdGhpc1sgMCBdLmxhYmVscy5sZW5ndGggKSB7DQoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggdGhpc1sgMCBdLmxhYmVscyApOw0KCX0NCg0KCS8vIFN1cHBvcnQ6IElFIDw9IDExLCBGRiA8PSAzNywgQW5kcm9pZCA8PSAyLjMgb25seQ0KCS8vIEFib3ZlIGJyb3dzZXJzIGRvIG5vdCBzdXBwb3J0IGNvbnRyb2wubGFiZWxzLiBFdmVyeXRoaW5nIGJlbG93IGlzIHRvIHN1cHBvcnQgdGhlbQ0KCS8vIGFzIHdlbGwgYXMgZG9jdW1lbnQgZnJhZ21lbnRzLiBjb250cm9sLmxhYmVscyBkb2VzIG5vdCB3b3JrIG9uIGRvY3VtZW50IGZyYWdtZW50cw0KCWxhYmVscyA9IHRoaXMuZXEoIDAgKS5wYXJlbnRzKCAibGFiZWwiICk7DQoNCgkvLyBMb29rIGZvciB0aGUgbGFiZWwgYmFzZWQgb24gdGhlIGlkDQoJaWQgPSB0aGlzLmF0dHIoICJpZCIgKTsNCglpZiAoIGlkICkgew0KDQoJCS8vIFdlIGRvbid0IHNlYXJjaCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBpbiBjYXNlIHRoZSBlbGVtZW50DQoJCS8vIGlzIGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBET00NCgkJYW5jZXN0b3IgPSB0aGlzLmVxKCAwICkucGFyZW50cygpLmxhc3QoKTsNCg0KCQkvLyBHZXQgYSBmdWxsIHNldCBvZiB0b3AgbGV2ZWwgYW5jZXN0b3JzDQoJCWFuY2VzdG9ycyA9IGFuY2VzdG9yLmFkZCggYW5jZXN0b3IubGVuZ3RoID8gYW5jZXN0b3Iuc2libGluZ3MoKSA6IHRoaXMuc2libGluZ3MoKSApOw0KDQoJCS8vIENyZWF0ZSBhIHNlbGVjdG9yIGZvciB0aGUgbGFiZWwgYmFzZWQgb24gdGhlIGlkDQoJCXNlbGVjdG9yID0gImxhYmVsW2Zvcj0nIiArICQudWkuZXNjYXBlU2VsZWN0b3IoIGlkICkgKyAiJ10iOw0KDQoJCWxhYmVscyA9IGxhYmVscy5hZGQoIGFuY2VzdG9ycy5maW5kKCBzZWxlY3RvciApLmFkZEJhY2soIHNlbGVjdG9yICkgKTsNCg0KCX0NCg0KCS8vIFJldHVybiB3aGF0ZXZlciB3ZSBoYXZlIGZvdW5kIGZvciBsYWJlbHMNCglyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGxhYmVscyApOw0KfTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBTY3JvbGwgUGFyZW50IDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBzY3JvbGxQYXJlbnQNCi8vPj5ncm91cDogQ29yZQ0KLy8+PmRlc2NyaXB0aW9uOiBHZXQgdGhlIGNsb3Nlc3QgYW5jZXN0b3IgZWxlbWVudCB0aGF0IGlzIHNjcm9sbGFibGUuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2Nyb2xsUGFyZW50Lw0KDQoNCg0KdmFyIHNjcm9sbFBhcmVudCA9ICQuZm4uc2Nyb2xsUGFyZW50ID0gZnVuY3Rpb24oIGluY2x1ZGVIaWRkZW4gKSB7DQoJdmFyIHBvc2l0aW9uID0gdGhpcy5jc3MoICJwb3NpdGlvbiIgKSwNCgkJZXhjbHVkZVN0YXRpY1BhcmVudCA9IHBvc2l0aW9uID09PSAiYWJzb2x1dGUiLA0KCQlvdmVyZmxvd1JlZ2V4ID0gaW5jbHVkZUhpZGRlbiA\/IC8oYXV0b3xzY3JvbGx8aGlkZGVuKS8gOiAvKGF1dG98c2Nyb2xsKS8sDQoJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlciggZnVuY3Rpb24oKSB7DQoJCQl2YXIgcGFyZW50ID0gJCggdGhpcyApOw0KCQkJaWYgKCBleGNsdWRlU3RhdGljUGFyZW50ICYmIHBhcmVudC5jc3MoICJwb3NpdGlvbiIgKSA9PT0gInN0YXRpYyIgKSB7DQoJCQkJcmV0dXJuIGZhbHNlOw0KCQkJfQ0KCQkJcmV0dXJuIG92ZXJmbG93UmVnZXgudGVzdCggcGFyZW50LmNzcyggIm92ZXJmbG93IiApICsgcGFyZW50LmNzcyggIm92ZXJmbG93LXkiICkgKw0KCQkJCXBhcmVudC5jc3MoICJvdmVyZmxvdy14IiApICk7DQoJCX0gKS5lcSggMCApOw0KDQoJcmV0dXJuIHBvc2l0aW9uID09PSAiZml4ZWQiIHx8ICFzY3JvbGxQYXJlbnQubGVuZ3RoID8NCgkJJCggdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKSA6DQoJCXNjcm9sbFBhcmVudDsNCn07DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgVGFiYmFibGUgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IDp0YWJiYWJsZSBTZWxlY3Rvcg0KLy8+Pmdyb3VwOiBDb3JlDQovLz4+ZGVzY3JpcHRpb246IFNlbGVjdHMgZWxlbWVudHMgd2hpY2ggY2FuIGJlIHRhYmJlZCB0by4NCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS90YWJiYWJsZS1zZWxlY3Rvci8NCg0KDQoNCnZhciB0YWJiYWJsZSA9ICQuZXh0ZW5kKCAkLmV4cHJbICI6IiBdLCB7DQoJdGFiYmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwNCgkJCWhhc1RhYmluZGV4ID0gdGFiSW5kZXggIT0gbnVsbDsNCgkJcmV0dXJuICggIWhhc1RhYmluZGV4IHx8IHRhYkluZGV4ID49IDAgKSAmJiAkLnVpLmZvY3VzYWJsZSggZWxlbWVudCwgaGFzVGFiaW5kZXggKTsNCgl9DQp9ICk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgVW5pcXVlIElEIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiB1bmlxdWVJZA0KLy8+Pmdyb3VwOiBDb3JlDQovLz4+ZGVzY3JpcHRpb246IEZ1bmN0aW9ucyB0byBnZW5lcmF0ZSBhbmQgcmVtb3ZlIHVuaXF1ZUlkJ3MNCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS91bmlxdWVJZC8NCg0KDQoNCnZhciB1bmlxdWVJZCA9ICQuZm4uZXh0ZW5kKCB7DQoJdW5pcXVlSWQ6ICggZnVuY3Rpb24oKSB7DQoJCXZhciB1dWlkID0gMDsNCg0KCQlyZXR1cm4gZnVuY3Rpb24oKSB7DQoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQlpZiAoICF0aGlzLmlkICkgew0KCQkJCQl0aGlzLmlkID0gInVpLWlkLSIgKyAoICsrdXVpZCApOw0KCQkJCX0NCgkJCX0gKTsNCgkJfTsNCgl9ICkoKSwNCg0KCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQlpZiAoIC9edWktaWQtXGQrJC8udGVzdCggdGhpcy5pZCApICkgew0KCQkJCSQoIHRoaXMgKS5yZW1vdmVBdHRyKCAiaWQiICk7DQoJCQl9DQoJCX0gKTsNCgl9DQp9ICk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgQWNjb3JkaW9uIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBBY2NvcmRpb24NCi8vPj5ncm91cDogV2lkZ2V0cw0KLy8ganNjczpkaXNhYmxlIG1heGltdW1MaW5lTGVuZ3RoDQovLz4+ZGVzY3JpcHRpb246IERpc3BsYXlzIGNvbGxhcHNpYmxlIGNvbnRlbnQgcGFuZWxzIGZvciBwcmVzZW50aW5nIGluZm9ybWF0aW9uIGluIGEgbGltaXRlZCBhbW91bnQgb2Ygc3BhY2UuDQovLyBqc2NzOmVuYWJsZSBtYXhpbXVtTGluZUxlbmd0aA0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2FjY29yZGlvbi8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9hY2NvcmRpb24vDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MNCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9hY2NvcmRpb24uY3NzDQovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MNCg0KDQoNCnZhciB3aWRnZXRzQWNjb3JkaW9uID0gJC53aWRnZXQoICJ1aS5hY2NvcmRpb24iLCB7DQoJdmVyc2lvbjogIjEuMTIuMSIsDQoJb3B0aW9uczogew0KCQlhY3RpdmU6IDAsDQoJCWFuaW1hdGU6IHt9LA0KCQljbGFzc2VzOiB7DQoJCQkidWktYWNjb3JkaW9uLWhlYWRlciI6ICJ1aS1jb3JuZXItdG9wIiwNCgkJCSJ1aS1hY2NvcmRpb24taGVhZGVyLWNvbGxhcHNlZCI6ICJ1aS1jb3JuZXItYWxsIiwNCgkJCSJ1aS1hY2NvcmRpb24tY29udGVudCI6ICJ1aS1jb3JuZXItYm90dG9tIg0KCQl9LA0KCQljb2xsYXBzaWJsZTogZmFsc2UsDQoJCWV2ZW50OiAiY2xpY2siLA0KCQloZWFkZXI6ICI+IGxpID4gOmZpcnN0LWNoaWxkLCA+IDpub3QobGkpOmV2ZW4iLA0KCQloZWlnaHRTdHlsZTogImF1dG8iLA0KCQlpY29uczogew0KCQkJYWN0aXZlSGVhZGVyOiAidWktaWNvbi10cmlhbmdsZS0xLXMiLA0KCQkJaGVhZGVyOiAidWktaWNvbi10cmlhbmdsZS0xLWUiDQoJCX0sDQoNCgkJLy8gQ2FsbGJhY2tzDQoJCWFjdGl2YXRlOiBudWxsLA0KCQliZWZvcmVBY3RpdmF0ZTogbnVsbA0KCX0sDQoNCgloaWRlUHJvcHM6IHsNCgkJYm9yZGVyVG9wV2lkdGg6ICJoaWRlIiwNCgkJYm9yZGVyQm90dG9tV2lkdGg6ICJoaWRlIiwNCgkJcGFkZGluZ1RvcDogImhpZGUiLA0KCQlwYWRkaW5nQm90dG9tOiAiaGlkZSIsDQoJCWhlaWdodDogImhpZGUiDQoJfSwNCg0KCXNob3dQcm9wczogew0KCQlib3JkZXJUb3BXaWR0aDogInNob3ciLA0KCQlib3JkZXJCb3R0b21XaWR0aDogInNob3ciLA0KCQlwYWRkaW5nVG9wOiAic2hvdyIsDQoJCXBhZGRpbmdCb3R0b206ICJzaG93IiwNCgkJaGVpZ2h0OiAic2hvdyINCgl9LA0KDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOw0KDQoJCXRoaXMucHJldlNob3cgPSB0aGlzLnByZXZIaWRlID0gJCgpOw0KCQl0aGlzLl9hZGRDbGFzcyggInVpLWFjY29yZGlvbiIsICJ1aS13aWRnZXQgdWktaGVscGVyLXJlc2V0IiApOw0KCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCAidGFibGlzdCIgKTsNCg0KCQkvLyBEb24ndCBhbGxvdyBjb2xsYXBzaWJsZTogZmFsc2UgYW5kIGFjdGl2ZTogZmFsc2UgLyBudWxsDQoJCWlmICggIW9wdGlvbnMuY29sbGFwc2libGUgJiYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgb3B0aW9ucy5hY3RpdmUgPT0gbnVsbCApICkgew0KCQkJb3B0aW9ucy5hY3RpdmUgPSAwOw0KCQl9DQoNCgkJdGhpcy5fcHJvY2Vzc1BhbmVscygpOw0KDQoJCS8vIGhhbmRsZSBuZWdhdGl2ZSB2YWx1ZXMNCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA8IDAgKSB7DQoJCQlvcHRpb25zLmFjdGl2ZSArPSB0aGlzLmhlYWRlcnMubGVuZ3RoOw0KCQl9DQoJCXRoaXMuX3JlZnJlc2goKTsNCgl9LA0KDQoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB7DQoJCQloZWFkZXI6IHRoaXMuYWN0aXZlLA0KCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLmFjdGl2ZS5uZXh0KCkNCgkJfTsNCgl9LA0KDQoJX2NyZWF0ZUljb25zOiBmdW5jdGlvbigpIHsNCgkJdmFyIGljb24sIGNoaWxkcmVuLA0KCQkJaWNvbnMgPSB0aGlzLm9wdGlvbnMuaWNvbnM7DQoNCgkJaWYgKCBpY29ucyApIHsNCgkJCWljb24gPSAkKCAiPHNwYW4+IiApOw0KCQkJdGhpcy5fYWRkQ2xhc3MoIGljb24sICJ1aS1hY2NvcmRpb24taGVhZGVyLWljb24iLCAidWktaWNvbiAiICsgaWNvbnMuaGVhZGVyICk7DQoJCQlpY29uLnByZXBlbmRUbyggdGhpcy5oZWFkZXJzICk7DQoJCQljaGlsZHJlbiA9IHRoaXMuYWN0aXZlLmNoaWxkcmVuKCAiLnVpLWFjY29yZGlvbi1oZWFkZXItaWNvbiIgKTsNCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBjaGlsZHJlbiwgaWNvbnMuaGVhZGVyICkNCgkJCQkuX2FkZENsYXNzKCBjaGlsZHJlbiwgbnVsbCwgaWNvbnMuYWN0aXZlSGVhZGVyICkNCgkJCQkuX2FkZENsYXNzKCB0aGlzLmhlYWRlcnMsICJ1aS1hY2NvcmRpb24taWNvbnMiICk7DQoJCX0NCgl9LA0KDQoJX2Rlc3Ryb3lJY29uczogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmhlYWRlcnMsICJ1aS1hY2NvcmRpb24taWNvbnMiICk7DQoJCXRoaXMuaGVhZGVycy5jaGlsZHJlbiggIi51aS1hY2NvcmRpb24taGVhZGVyLWljb24iICkucmVtb3ZlKCk7DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJdmFyIGNvbnRlbnRzOw0KDQoJCS8vIENsZWFuIHVwIG1haW4gZWxlbWVudA0KCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggInJvbGUiICk7DQoNCgkJLy8gQ2xlYW4gdXAgaGVhZGVycw0KCQl0aGlzLmhlYWRlcnMNCgkJCS5yZW1vdmVBdHRyKCAicm9sZSBhcmlhLWV4cGFuZGVkIGFyaWEtc2VsZWN0ZWQgYXJpYS1jb250cm9scyB0YWJJbmRleCIgKQ0KCQkJLnJlbW92ZVVuaXF1ZUlkKCk7DQoNCgkJdGhpcy5fZGVzdHJveUljb25zKCk7DQoNCgkJLy8gQ2xlYW4gdXAgY29udGVudCBwYW5lbHMNCgkJY29udGVudHMgPSB0aGlzLmhlYWRlcnMubmV4dCgpDQoJCQkuY3NzKCAiZGlzcGxheSIsICIiICkNCgkJCS5yZW1vdmVBdHRyKCAicm9sZSBhcmlhLWhpZGRlbiBhcmlhLWxhYmVsbGVkYnkiICkNCgkJCS5yZW1vdmVVbmlxdWVJZCgpOw0KDQoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7DQoJCQljb250ZW50cy5jc3MoICJoZWlnaHQiLCAiIiApOw0KCQl9DQoJfSwNCg0KCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7DQoNCgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zDQoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlmICgga2V5ID09PSAiZXZlbnQiICkgew0KCQkJaWYgKCB0aGlzLm9wdGlvbnMuZXZlbnQgKSB7DQoJCQkJdGhpcy5fb2ZmKCB0aGlzLmhlYWRlcnMsIHRoaXMub3B0aW9ucy5ldmVudCApOw0KCQkJfQ0KCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7DQoJCX0NCg0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KDQoJCS8vIFNldHRpbmcgY29sbGFwc2libGU6IGZhbHNlIHdoaWxlIGNvbGxhcHNlZDsgb3BlbiBmaXJzdCBwYW5lbA0KCQlpZiAoIGtleSA9PT0gImNvbGxhcHNpYmxlIiAmJiAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7DQoJCQl0aGlzLl9hY3RpdmF0ZSggMCApOw0KCQl9DQoNCgkJaWYgKCBrZXkgPT09ICJpY29ucyIgKSB7DQoJCQl0aGlzLl9kZXN0cm95SWNvbnMoKTsNCgkJCWlmICggdmFsdWUgKSB7DQoJCQkJdGhpcy5fY3JlYXRlSWNvbnMoKTsNCgkJCX0NCgkJfQ0KCX0sDQoNCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7DQoNCgkJdGhpcy5lbGVtZW50LmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsNCg0KCQkvLyBTdXBwb3J0OiBJRTggT25seQ0KCQkvLyAjNTMzMiAvICM2MDU5IC0gb3BhY2l0eSBkb2Vzbid0IGNhc2NhZGUgdG8gcG9zaXRpb25lZCBlbGVtZW50cyBpbiBJRQ0KCQkvLyBzbyB3ZSBuZWVkIHRvIGFkZCB0aGUgZGlzYWJsZWQgY2xhc3MgdG8gdGhlIGhlYWRlcnMgYW5kIHBhbmVscw0KCQl0aGlzLl90b2dnbGVDbGFzcyggbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApOw0KCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy5oZWFkZXJzLmFkZCggdGhpcy5oZWFkZXJzLm5leHQoKSApLCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLA0KCQkJISF2YWx1ZSApOw0KCX0sDQoNCglfa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoIGV2ZW50LmFsdEtleSB8fCBldmVudC5jdHJsS2V5ICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJdmFyIGtleUNvZGUgPSAkLnVpLmtleUNvZGUsDQoJCQlsZW5ndGggPSB0aGlzLmhlYWRlcnMubGVuZ3RoLA0KCQkJY3VycmVudEluZGV4ID0gdGhpcy5oZWFkZXJzLmluZGV4KCBldmVudC50YXJnZXQgKSwNCgkJCXRvRm9jdXMgPSBmYWxzZTsNCg0KCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgew0KCQljYXNlIGtleUNvZGUuUklHSFQ6DQoJCWNhc2Uga2V5Q29kZS5ET1dOOg0KCQkJdG9Gb2N1cyA9IHRoaXMuaGVhZGVyc1sgKCBjdXJyZW50SW5kZXggKyAxICkgJSBsZW5ndGggXTsNCgkJCWJyZWFrOw0KCQljYXNlIGtleUNvZGUuTEVGVDoNCgkJY2FzZSBrZXlDb2RlLlVQOg0KCQkJdG9Gb2N1cyA9IHRoaXMuaGVhZGVyc1sgKCBjdXJyZW50SW5kZXggLSAxICsgbGVuZ3RoICkgJSBsZW5ndGggXTsNCgkJCWJyZWFrOw0KCQljYXNlIGtleUNvZGUuU1BBQ0U6DQoJCWNhc2Uga2V5Q29kZS5FTlRFUjoNCgkJCXRoaXMuX2V2ZW50SGFuZGxlciggZXZlbnQgKTsNCgkJCWJyZWFrOw0KCQljYXNlIGtleUNvZGUuSE9NRToNCgkJCXRvRm9jdXMgPSB0aGlzLmhlYWRlcnNbIDAgXTsNCgkJCWJyZWFrOw0KCQljYXNlIGtleUNvZGUuRU5EOg0KCQkJdG9Gb2N1cyA9IHRoaXMuaGVhZGVyc1sgbGVuZ3RoIC0gMSBdOw0KCQkJYnJlYWs7DQoJCX0NCg0KCQlpZiAoIHRvRm9jdXMgKSB7DQoJCQkkKCBldmVudC50YXJnZXQgKS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOw0KCQkJJCggdG9Gb2N1cyApLmF0dHIoICJ0YWJJbmRleCIsIDAgKTsNCgkJCSQoIHRvRm9jdXMgKS50cmlnZ2VyKCAiZm9jdXMiICk7DQoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQl9DQoJfSwNCg0KCV9wYW5lbEtleURvd246IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJaWYgKCBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuVVAgJiYgZXZlbnQuY3RybEtleSApIHsNCgkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5wcmV2KCkudHJpZ2dlciggImZvY3VzIiApOw0KCQl9DQoJfSwNCg0KCXJlZnJlc2g6IGZ1bmN0aW9uKCkgew0KCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsNCgkJdGhpcy5fcHJvY2Vzc1BhbmVscygpOw0KDQoJCS8vIFdhcyBjb2xsYXBzZWQgb3Igbm8gcGFuZWwNCgkJaWYgKCAoIG9wdGlvbnMuYWN0aXZlID09PSBmYWxzZSAmJiBvcHRpb25zLmNvbGxhcHNpYmxlID09PSB0cnVlICkgfHwNCgkJCQkhdGhpcy5oZWFkZXJzLmxlbmd0aCApIHsNCgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7DQoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsNCg0KCQkvLyBhY3RpdmUgZmFsc2Ugb25seSB3aGVuIGNvbGxhcHNpYmxlIGlzIHRydWUNCgkJfSBlbHNlIGlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgew0KCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsNCg0KCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHBhbmVsIGlzIGdvbmUNCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLmVsZW1lbnRbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgew0KDQoJCQkvLyBhbGwgcmVtYWluaW5nIHBhbmVsIGFyZSBkaXNhYmxlZA0KCQkJaWYgKCB0aGlzLmhlYWRlcnMubGVuZ3RoID09PSB0aGlzLmhlYWRlcnMuZmluZCggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKS5sZW5ndGggKSB7DQoJCQkJb3B0aW9ucy5hY3RpdmUgPSBmYWxzZTsNCgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsNCg0KCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgcGFuZWwNCgkJCX0gZWxzZSB7DQoJCQkJdGhpcy5fYWN0aXZhdGUoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSApOw0KCQkJfQ0KDQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSBwYW5lbCBzdGlsbCBleGlzdHMNCgkJfSBlbHNlIHsNCg0KCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0DQoJCQlvcHRpb25zLmFjdGl2ZSA9IHRoaXMuaGVhZGVycy5pbmRleCggdGhpcy5hY3RpdmUgKTsNCgkJfQ0KDQoJCXRoaXMuX2Rlc3Ryb3lJY29ucygpOw0KDQoJCXRoaXMuX3JlZnJlc2goKTsNCgl9LA0KDQoJX3Byb2Nlc3NQYW5lbHM6IGZ1bmN0aW9uKCkgew0KCQl2YXIgcHJldkhlYWRlcnMgPSB0aGlzLmhlYWRlcnMsDQoJCQlwcmV2UGFuZWxzID0gdGhpcy5wYW5lbHM7DQoNCgkJdGhpcy5oZWFkZXJzID0gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMub3B0aW9ucy5oZWFkZXIgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGVhZGVycywgInVpLWFjY29yZGlvbi1oZWFkZXIgdWktYWNjb3JkaW9uLWhlYWRlci1jb2xsYXBzZWQiLA0KCQkJInVpLXN0YXRlLWRlZmF1bHQiICk7DQoNCgkJdGhpcy5wYW5lbHMgPSB0aGlzLmhlYWRlcnMubmV4dCgpLmZpbHRlciggIjpub3QoLnVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSkiICkuaGlkZSgpOw0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5wYW5lbHMsICJ1aS1hY2NvcmRpb24tY29udGVudCIsICJ1aS1oZWxwZXItcmVzZXQgdWktd2lkZ2V0LWNvbnRlbnQiICk7DQoNCgkJLy8gQXZvaWQgbWVtb3J5IGxlYWtzICgjMTAwNTYpDQoJCWlmICggcHJldlBhbmVscyApIHsNCgkJCXRoaXMuX29mZiggcHJldkhlYWRlcnMubm90KCB0aGlzLmhlYWRlcnMgKSApOw0KCQkJdGhpcy5fb2ZmKCBwcmV2UGFuZWxzLm5vdCggdGhpcy5wYW5lbHMgKSApOw0KCQl9DQoJfSwNCg0KCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsNCgkJdmFyIG1heEhlaWdodCwNCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsDQoJCQloZWlnaHRTdHlsZSA9IG9wdGlvbnMuaGVpZ2h0U3R5bGUsDQoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7DQoNCgkJdGhpcy5hY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBvcHRpb25zLmFjdGl2ZSApOw0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5hY3RpdmUsICJ1aS1hY2NvcmRpb24taGVhZGVyLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICkNCgkJCS5fcmVtb3ZlQ2xhc3MoIHRoaXMuYWN0aXZlLCAidWktYWNjb3JkaW9uLWhlYWRlci1jb2xsYXBzZWQiICk7DQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmFjdGl2ZS5uZXh0KCksICJ1aS1hY2NvcmRpb24tY29udGVudC1hY3RpdmUiICk7DQoJCXRoaXMuYWN0aXZlLm5leHQoKS5zaG93KCk7DQoNCgkJdGhpcy5oZWFkZXJzDQoJCQkuYXR0ciggInJvbGUiLCAidGFiIiApDQoJCQkuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJdmFyIGhlYWRlciA9ICQoIHRoaXMgKSwNCgkJCQkJaGVhZGVySWQgPSBoZWFkZXIudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksDQoJCQkJCXBhbmVsID0gaGVhZGVyLm5leHQoKSwNCgkJCQkJcGFuZWxJZCA9IHBhbmVsLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApOw0KCQkJCWhlYWRlci5hdHRyKCAiYXJpYS1jb250cm9scyIsIHBhbmVsSWQgKTsNCgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiwgaGVhZGVySWQgKTsNCgkJCX0gKQ0KCQkJLm5leHQoKQ0KCQkJCS5hdHRyKCAicm9sZSIsICJ0YWJwYW5lbCIgKTsNCg0KCQl0aGlzLmhlYWRlcnMNCgkJCS5ub3QoIHRoaXMuYWN0aXZlICkNCgkJCQkuYXR0ciggew0KCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsDQoJCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwNCgkJCQkJdGFiSW5kZXg6IC0xDQoJCQkJfSApDQoJCQkJLm5leHQoKQ0KCQkJCQkuYXR0ciggew0KCQkJCQkJImFyaWEtaGlkZGVuIjogInRydWUiDQoJCQkJCX0gKQ0KCQkJCQkuaGlkZSgpOw0KDQoJCS8vIE1ha2Ugc3VyZSBhdCBsZWFzdCBvbmUgaGVhZGVyIGlzIGluIHRoZSB0YWIgb3JkZXINCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgew0KCQkJdGhpcy5oZWFkZXJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOw0KCQl9IGVsc2Ugew0KCQkJdGhpcy5hY3RpdmUuYXR0ciggew0KCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLA0KCQkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLA0KCQkJCXRhYkluZGV4OiAwDQoJCQl9ICkNCgkJCQkubmV4dCgpDQoJCQkJCS5hdHRyKCB7DQoJCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiDQoJCQkJCX0gKTsNCgkJfQ0KDQoJCXRoaXMuX2NyZWF0ZUljb25zKCk7DQoNCgkJdGhpcy5fc2V0dXBFdmVudHMoIG9wdGlvbnMuZXZlbnQgKTsNCg0KCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7DQoJCQltYXhIZWlnaHQgPSBwYXJlbnQuaGVpZ2h0KCk7DQoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgZWxlbSA9ICQoIHRoaXMgKSwNCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOw0KDQoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsNCgkJCQkJcmV0dXJuOw0KCQkJCX0NCgkJCQltYXhIZWlnaHQgLT0gZWxlbS5vdXRlckhlaWdodCggdHJ1ZSApOw0KCQkJfSApOw0KDQoJCQl0aGlzLmhlYWRlcnMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJbWF4SGVpZ2h0IC09ICQoIHRoaXMgKS5vdXRlckhlaWdodCggdHJ1ZSApOw0KCQkJfSApOw0KDQoJCQl0aGlzLmhlYWRlcnMubmV4dCgpDQoJCQkJLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCQkkKCB0aGlzICkuaGVpZ2h0KCBNYXRoLm1heCggMCwgbWF4SGVpZ2h0IC0NCgkJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsNCgkJCQl9ICkNCgkJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsNCgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsNCgkJCW1heEhlaWdodCA9IDA7DQoJCQl0aGlzLmhlYWRlcnMubmV4dCgpDQoJCQkJLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCQl2YXIgaXNWaXNpYmxlID0gJCggdGhpcyApLmlzKCAiOnZpc2libGUiICk7DQoJCQkJCWlmICggIWlzVmlzaWJsZSApIHsNCgkJCQkJCSQoIHRoaXMgKS5zaG93KCk7DQoJCQkJCX0NCgkJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmNzcyggImhlaWdodCIsICIiICkuaGVpZ2h0KCkgKTsNCgkJCQkJaWYgKCAhaXNWaXNpYmxlICkgew0KCQkJCQkJJCggdGhpcyApLmhpZGUoKTsNCgkJCQkJfQ0KCQkJCX0gKQ0KCQkJCS5oZWlnaHQoIG1heEhlaWdodCApOw0KCQl9DQoJfSwNCg0KCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgew0KCQl2YXIgYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggaW5kZXggKVsgMCBdOw0KDQoJCS8vIFRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwNCgkJaWYgKCBhY3RpdmUgPT09IHRoaXMuYWN0aXZlWyAwIF0gKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBUcnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnRseSBhY3RpdmUgaGVhZGVyDQoJCWFjdGl2ZSA9IGFjdGl2ZSB8fCB0aGlzLmFjdGl2ZVsgMCBdOw0KDQoJCXRoaXMuX2V2ZW50SGFuZGxlciggew0KCQkJdGFyZ2V0OiBhY3RpdmUsDQoJCQljdXJyZW50VGFyZ2V0OiBhY3RpdmUsDQoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wDQoJCX0gKTsNCgl9LA0KDQoJX2ZpbmRBY3RpdmU6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJcmV0dXJuIHR5cGVvZiBzZWxlY3RvciA9PT0gIm51bWJlciIgPyB0aGlzLmhlYWRlcnMuZXEoIHNlbGVjdG9yICkgOiAkKCk7DQoJfSwNCg0KCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgZXZlbnRzID0gew0KCQkJa2V5ZG93bjogIl9rZXlkb3duIg0KCQl9Ow0KCQlpZiAoIGV2ZW50ICkgew0KCQkJJC5lYWNoKCBldmVudC5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgew0KCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7DQoJCQl9ICk7DQoJCX0NCg0KCQl0aGlzLl9vZmYoIHRoaXMuaGVhZGVycy5hZGQoIHRoaXMuaGVhZGVycy5uZXh0KCkgKSApOw0KCQl0aGlzLl9vbiggdGhpcy5oZWFkZXJzLCBldmVudHMgKTsNCgkJdGhpcy5fb24oIHRoaXMuaGVhZGVycy5uZXh0KCksIHsga2V5ZG93bjogIl9wYW5lbEtleURvd24iIH0gKTsNCgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLmhlYWRlcnMgKTsNCgkJdGhpcy5fZm9jdXNhYmxlKCB0aGlzLmhlYWRlcnMgKTsNCgl9LA0KDQoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgYWN0aXZlQ2hpbGRyZW4sIGNsaWNrZWRDaGlsZHJlbiwNCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsDQoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwNCgkJCWNsaWNrZWQgPSAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksDQoJCQljbGlja2VkSXNBY3RpdmUgPSBjbGlja2VkWyAwIF0gPT09IGFjdGl2ZVsgMCBdLA0KCQkJY29sbGFwc2luZyA9IGNsaWNrZWRJc0FjdGl2ZSAmJiBvcHRpb25zLmNvbGxhcHNpYmxlLA0KCQkJdG9TaG93ID0gY29sbGFwc2luZyA\/ICQoKSA6IGNsaWNrZWQubmV4dCgpLA0KCQkJdG9IaWRlID0gYWN0aXZlLm5leHQoKSwNCgkJCWV2ZW50RGF0YSA9IHsNCgkJCQlvbGRIZWFkZXI6IGFjdGl2ZSwNCgkJCQlvbGRQYW5lbDogdG9IaWRlLA0KCQkJCW5ld0hlYWRlcjogY29sbGFwc2luZyA\/ICQoKSA6IGNsaWNrZWQsDQoJCQkJbmV3UGFuZWw6IHRvU2hvdw0KCQkJfTsNCg0KCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KDQoJCWlmICgNCg0KCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUNCgkJCQkoIGNsaWNrZWRJc0FjdGl2ZSAmJiAhb3B0aW9ucy5jb2xsYXBzaWJsZSApIHx8DQoNCgkJCQkvLyBhbGxvdyBjYW5jZWxpbmcgYWN0aXZhdGlvbg0KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLmhlYWRlcnMuaW5kZXgoIGNsaWNrZWQgKTsNCg0KCQkvLyBXaGVuIHRoZSBjYWxsIHRvIC5fdG9nZ2xlKCkgY29tZXMgYWZ0ZXIgdGhlIGNsYXNzIGNoYW5nZXMNCgkJLy8gaXQgY2F1c2VzIGEgdmVyeSBvZGQgYnVnIGluIElFIDggKHNlZSAjNjcyMCkNCgkJdGhpcy5hY3RpdmUgPSBjbGlja2VkSXNBY3RpdmUgPyAkKCkgOiBjbGlja2VkOw0KCQl0aGlzLl90b2dnbGUoIGV2ZW50RGF0YSApOw0KDQoJCS8vIFN3aXRjaCBjbGFzc2VzDQoJCS8vIGNvcm5lciBjbGFzc2VzIG9uIHRoZSBwcmV2aW91c2x5IGFjdGl2ZSBoZWFkZXIgc3RheSBhZnRlciB0aGUgYW5pbWF0aW9uDQoJCXRoaXMuX3JlbW92ZUNsYXNzKCBhY3RpdmUsICJ1aS1hY2NvcmRpb24taGVhZGVyLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoJCWlmICggb3B0aW9ucy5pY29ucyApIHsNCgkJCWFjdGl2ZUNoaWxkcmVuID0gYWN0aXZlLmNoaWxkcmVuKCAiLnVpLWFjY29yZGlvbi1oZWFkZXItaWNvbiIgKTsNCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBhY3RpdmVDaGlsZHJlbiwgbnVsbCwgb3B0aW9ucy5pY29ucy5hY3RpdmVIZWFkZXIgKQ0KCQkJCS5fYWRkQ2xhc3MoIGFjdGl2ZUNoaWxkcmVuLCBudWxsLCBvcHRpb25zLmljb25zLmhlYWRlciApOw0KCQl9DQoNCgkJaWYgKCAhY2xpY2tlZElzQWN0aXZlICkgew0KCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGNsaWNrZWQsICJ1aS1hY2NvcmRpb24taGVhZGVyLWNvbGxhcHNlZCIgKQ0KCQkJCS5fYWRkQ2xhc3MoIGNsaWNrZWQsICJ1aS1hY2NvcmRpb24taGVhZGVyLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoJCQlpZiAoIG9wdGlvbnMuaWNvbnMgKSB7DQoJCQkJY2xpY2tlZENoaWxkcmVuID0gY2xpY2tlZC5jaGlsZHJlbiggIi51aS1hY2NvcmRpb24taGVhZGVyLWljb24iICk7DQoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGNsaWNrZWRDaGlsZHJlbiwgbnVsbCwgb3B0aW9ucy5pY29ucy5oZWFkZXIgKQ0KCQkJCQkuX2FkZENsYXNzKCBjbGlja2VkQ2hpbGRyZW4sIG51bGwsIG9wdGlvbnMuaWNvbnMuYWN0aXZlSGVhZGVyICk7DQoJCQl9DQoNCgkJCXRoaXMuX2FkZENsYXNzKCBjbGlja2VkLm5leHQoKSwgInVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSIgKTsNCgkJfQ0KCX0sDQoNCglfdG9nZ2xlOiBmdW5jdGlvbiggZGF0YSApIHsNCgkJdmFyIHRvU2hvdyA9IGRhdGEubmV3UGFuZWwsDQoJCQl0b0hpZGUgPSB0aGlzLnByZXZTaG93Lmxlbmd0aCA\/IHRoaXMucHJldlNob3cgOiBkYXRhLm9sZFBhbmVsOw0KDQoJCS8vIEhhbmRsZSBhY3RpdmF0aW5nIGEgcGFuZWwgZHVyaW5nIHRoZSBhbmltYXRpb24gZm9yIGFub3RoZXIgYWN0aXZhdGlvbg0KCQl0aGlzLnByZXZTaG93LmFkZCggdGhpcy5wcmV2SGlkZSApLnN0b3AoIHRydWUsIHRydWUgKTsNCgkJdGhpcy5wcmV2U2hvdyA9IHRvU2hvdzsNCgkJdGhpcy5wcmV2SGlkZSA9IHRvSGlkZTsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5hbmltYXRlICkgew0KCQkJdGhpcy5fYW5pbWF0ZSggdG9TaG93LCB0b0hpZGUsIGRhdGEgKTsNCgkJfSBlbHNlIHsNCgkJCXRvSGlkZS5oaWRlKCk7DQoJCQl0b1Nob3cuc2hvdygpOw0KCQkJdGhpcy5fdG9nZ2xlQ29tcGxldGUoIGRhdGEgKTsNCgkJfQ0KDQoJCXRvSGlkZS5hdHRyKCB7DQoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSINCgkJfSApOw0KCQl0b0hpZGUucHJldigpLmF0dHIoIHsNCgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwNCgkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIg0KCQl9ICk7DQoNCgkJLy8gaWYgd2UncmUgc3dpdGNoaW5nIHBhbmVscywgcmVtb3ZlIHRoZSBvbGQgaGVhZGVyIGZyb20gdGhlIHRhYiBvcmRlcg0KCQkvLyBpZiB3ZSdyZSBvcGVuaW5nIGZyb20gY29sbGFwc2VkIHN0YXRlLCByZW1vdmUgdGhlIHByZXZpb3VzIGhlYWRlciBmcm9tIHRoZSB0YWIgb3JkZXINCgkJLy8gaWYgd2UncmUgY29sbGFwc2luZywgdGhlbiBrZWVwIHRoZSBjb2xsYXBzaW5nIGhlYWRlciBpbiB0aGUgdGFiIG9yZGVyDQoJCWlmICggdG9TaG93Lmxlbmd0aCAmJiB0b0hpZGUubGVuZ3RoICkgew0KCQkJdG9IaWRlLnByZXYoKS5hdHRyKCB7DQoJCQkJInRhYkluZGV4IjogLTEsDQoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiDQoJCQl9ICk7DQoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7DQoJCQl0aGlzLmhlYWRlcnMuZmlsdGVyKCBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gcGFyc2VJbnQoICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICksIDEwICkgPT09IDA7DQoJCQl9ICkNCgkJCQkuYXR0ciggInRhYkluZGV4IiwgLTEgKTsNCgkJfQ0KDQoJCXRvU2hvdw0KCQkJLmF0dHIoICJhcmlhLWhpZGRlbiIsICJmYWxzZSIgKQ0KCQkJLnByZXYoKQ0KCQkJCS5hdHRyKCB7DQoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLA0KCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwNCgkJCQkJdGFiSW5kZXg6IDANCgkJCQl9ICk7DQoJfSwNCg0KCV9hbmltYXRlOiBmdW5jdGlvbiggdG9TaG93LCB0b0hpZGUsIGRhdGEgKSB7DQoJCXZhciB0b3RhbCwgZWFzaW5nLCBkdXJhdGlvbiwNCgkJCXRoYXQgPSB0aGlzLA0KCQkJYWRqdXN0ID0gMCwNCgkJCWJveFNpemluZyA9IHRvU2hvdy5jc3MoICJib3gtc2l6aW5nIiApLA0KCQkJZG93biA9IHRvU2hvdy5sZW5ndGggJiYNCgkJCQkoICF0b0hpZGUubGVuZ3RoIHx8ICggdG9TaG93LmluZGV4KCkgPCB0b0hpZGUuaW5kZXgoKSApICksDQoJCQlhbmltYXRlID0gdGhpcy5vcHRpb25zLmFuaW1hdGUgfHwge30sDQoJCQlvcHRpb25zID0gZG93biAmJiBhbmltYXRlLmRvd24gfHwgYW5pbWF0ZSwNCgkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7DQoJCQkJdGhhdC5fdG9nZ2xlQ29tcGxldGUoIGRhdGEgKTsNCgkJCX07DQoNCgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7DQoJCQlkdXJhdGlvbiA9IG9wdGlvbnM7DQoJCX0NCgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7DQoJCQllYXNpbmcgPSBvcHRpb25zOw0KCQl9DQoNCgkJLy8gZmFsbCBiYWNrIGZyb20gb3B0aW9ucyB0byBhbmltYXRpb24gaW4gY2FzZSBvZiBwYXJ0aWFsIGRvd24gc2V0dGluZ3MNCgkJZWFzaW5nID0gZWFzaW5nIHx8IG9wdGlvbnMuZWFzaW5nIHx8IGFuaW1hdGUuZWFzaW5nOw0KCQlkdXJhdGlvbiA9IGR1cmF0aW9uIHx8IG9wdGlvbnMuZHVyYXRpb24gfHwgYW5pbWF0ZS5kdXJhdGlvbjsNCg0KCQlpZiAoICF0b0hpZGUubGVuZ3RoICkgew0KCQkJcmV0dXJuIHRvU2hvdy5hbmltYXRlKCB0aGlzLnNob3dQcm9wcywgZHVyYXRpb24sIGVhc2luZywgY29tcGxldGUgKTsNCgkJfQ0KCQlpZiAoICF0b1Nob3cubGVuZ3RoICkgew0KCQkJcmV0dXJuIHRvSGlkZS5hbmltYXRlKCB0aGlzLmhpZGVQcm9wcywgZHVyYXRpb24sIGVhc2luZywgY29tcGxldGUgKTsNCgkJfQ0KDQoJCXRvdGFsID0gdG9TaG93LnNob3coKS5vdXRlckhlaWdodCgpOw0KCQl0b0hpZGUuYW5pbWF0ZSggdGhpcy5oaWRlUHJvcHMsIHsNCgkJCWR1cmF0aW9uOiBkdXJhdGlvbiwNCgkJCWVhc2luZzogZWFzaW5nLA0KCQkJc3RlcDogZnVuY3Rpb24oIG5vdywgZnggKSB7DQoJCQkJZngubm93ID0gTWF0aC5yb3VuZCggbm93ICk7DQoJCQl9DQoJCX0gKTsNCgkJdG9TaG93DQoJCQkuaGlkZSgpDQoJCQkuYW5pbWF0ZSggdGhpcy5zaG93UHJvcHMsIHsNCgkJCQlkdXJhdGlvbjogZHVyYXRpb24sDQoJCQkJZWFzaW5nOiBlYXNpbmcsDQoJCQkJY29tcGxldGU6IGNvbXBsZXRlLA0KCQkJCXN0ZXA6IGZ1bmN0aW9uKCBub3csIGZ4ICkgew0KCQkJCQlmeC5ub3cgPSBNYXRoLnJvdW5kKCBub3cgKTsNCgkJCQkJaWYgKCBmeC5wcm9wICE9PSAiaGVpZ2h0IiApIHsNCgkJCQkJCWlmICggYm94U2l6aW5nID09PSAiY29udGVudC1ib3giICkgew0KCQkJCQkJCWFkanVzdCArPSBmeC5ub3c7DQoJCQkJCQl9DQoJCQkJCX0gZWxzZSBpZiAoIHRoYXQub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgew0KCQkJCQkJZngubm93ID0gTWF0aC5yb3VuZCggdG90YWwgLSB0b0hpZGUub3V0ZXJIZWlnaHQoKSAtIGFkanVzdCApOw0KCQkJCQkJYWRqdXN0ID0gMDsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0gKTsNCgl9LA0KDQoJX3RvZ2dsZUNvbXBsZXRlOiBmdW5jdGlvbiggZGF0YSApIHsNCgkJdmFyIHRvSGlkZSA9IGRhdGEub2xkUGFuZWwsDQoJCQlwcmV2ID0gdG9IaWRlLnByZXYoKTsNCg0KCQl0aGlzLl9yZW1vdmVDbGFzcyggdG9IaWRlLCAidWktYWNjb3JkaW9uLWNvbnRlbnQtYWN0aXZlIiApOw0KCQl0aGlzLl9yZW1vdmVDbGFzcyggcHJldiwgInVpLWFjY29yZGlvbi1oZWFkZXItYWN0aXZlIiApDQoJCQkuX2FkZENsYXNzKCBwcmV2LCAidWktYWNjb3JkaW9uLWhlYWRlci1jb2xsYXBzZWQiICk7DQoNCgkJLy8gV29yayBhcm91bmQgZm9yIHJlbmRlcmluZyBidWcgaW4gSUUgKCM1NDIxKQ0KCQlpZiAoIHRvSGlkZS5sZW5ndGggKSB7DQoJCQl0b0hpZGUucGFyZW50KClbIDAgXS5jbGFzc05hbWUgPSB0b0hpZGUucGFyZW50KClbIDAgXS5jbGFzc05hbWU7DQoJCX0NCgkJdGhpcy5fdHJpZ2dlciggImFjdGl2YXRlIiwgbnVsbCwgZGF0YSApOw0KCX0NCn0gKTsNCg0KDQoNCnZhciBzYWZlQWN0aXZlRWxlbWVudCA9ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQgPSBmdW5jdGlvbiggZG9jdW1lbnQgKSB7DQoJdmFyIGFjdGl2ZUVsZW1lbnQ7DQoNCgkvLyBTdXBwb3J0OiBJRSA5IG9ubHkNCgkvLyBJRTkgdGhyb3dzIGFuICJVbnNwZWNpZmllZCBlcnJvciIgYWNjZXNzaW5nIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgZnJvbSBhbiA8aWZyYW1lPg0KCXRyeSB7DQoJCWFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50Ow0KCX0gY2F0Y2ggKCBlcnJvciApIHsNCgkJYWN0aXZlRWxlbWVudCA9IGRvY3VtZW50LmJvZHk7DQoJfQ0KDQoJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHkNCgkvLyBJRSBtYXkgcmV0dXJuIG51bGwgaW5zdGVhZCBvZiBhbiBlbGVtZW50DQoJLy8gSW50ZXJlc3RpbmdseSwgdGhpcyBvbmx5IHNlZW1zIHRvIG9jY3VyIHdoZW4gTk9UIGluIGFuIGlmcmFtZQ0KCWlmICggIWFjdGl2ZUVsZW1lbnQgKSB7DQoJCWFjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5ib2R5Ow0KCX0NCg0KCS8vIFN1cHBvcnQ6IElFIDExIG9ubHkNCgkvLyBJRTExIHJldHVybnMgYSBzZWVtaW5nbHkgZW1wdHkgb2JqZWN0IGluIHNvbWUgY2FzZXMgd2hlbiBhY2Nlc3NpbmcNCgkvLyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGZyb20gYW4gPGlmcmFtZT4NCglpZiAoICFhY3RpdmVFbGVtZW50Lm5vZGVOYW1lICkgew0KCQlhY3RpdmVFbGVtZW50ID0gZG9jdW1lbnQuYm9keTsNCgl9DQoNCglyZXR1cm4gYWN0aXZlRWxlbWVudDsNCn07DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgTWVudSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogTWVudQ0KLy8+Pmdyb3VwOiBXaWRnZXRzDQovLz4+ZGVzY3JpcHRpb246IENyZWF0ZXMgbmVzdGFibGUgbWVudXMuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vbWVudS8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9tZW51Lw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvbWVudS5jc3MNCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcw0KDQoNCg0KdmFyIHdpZGdldHNNZW51ID0gJC53aWRnZXQoICJ1aS5tZW51Iiwgew0KCXZlcnNpb246ICIxLjEyLjEiLA0KCWRlZmF1bHRFbGVtZW50OiAiPHVsPiIsDQoJZGVsYXk6IDMwMCwNCglvcHRpb25zOiB7DQoJCWljb25zOiB7DQoJCQlzdWJtZW51OiAidWktaWNvbi1jYXJldC0xLWUiDQoJCX0sDQoJCWl0ZW1zOiAiPiAqIiwNCgkJbWVudXM6ICJ1bCIsDQoJCXBvc2l0aW9uOiB7DQoJCQlteTogImxlZnQgdG9wIiwNCgkJCWF0OiAicmlnaHQgdG9wIg0KCQl9LA0KCQlyb2xlOiAibWVudSIsDQoNCgkJLy8gQ2FsbGJhY2tzDQoJCWJsdXI6IG51bGwsDQoJCWZvY3VzOiBudWxsLA0KCQlzZWxlY3Q6IG51bGwNCgl9LA0KDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoJCXRoaXMuYWN0aXZlTWVudSA9IHRoaXMuZWxlbWVudDsNCg0KCQkvLyBGbGFnIHVzZWQgdG8gcHJldmVudCBmaXJpbmcgb2YgdGhlIGNsaWNrIGhhbmRsZXINCgkJLy8gYXMgdGhlIGV2ZW50IGJ1YmJsZXMgdXAgdGhyb3VnaCBuZXN0ZWQgbWVudXMNCgkJdGhpcy5tb3VzZUhhbmRsZWQgPSBmYWxzZTsNCgkJdGhpcy5lbGVtZW50DQoJCQkudW5pcXVlSWQoKQ0KCQkJLmF0dHIoIHsNCgkJCQlyb2xlOiB0aGlzLm9wdGlvbnMucm9sZSwNCgkJCQl0YWJJbmRleDogMA0KCQkJfSApOw0KDQoJCXRoaXMuX2FkZENsYXNzKCAidWktbWVudSIsICJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQiICk7DQoJCXRoaXMuX29uKCB7DQoNCgkJCS8vIFByZXZlbnQgZm9jdXMgZnJvbSBzdGlja2luZyB0byBsaW5rcyBpbnNpZGUgbWVudSBhZnRlciBjbGlja2luZw0KCQkJLy8gdGhlbSAoZm9jdXMgc2hvdWxkIGFsd2F5cyBzdGF5IG9uIFVMIGR1cmluZyBuYXZpZ2F0aW9uKS4NCgkJCSJtb3VzZWRvd24gLnVpLW1lbnUtaXRlbSI6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJfSwNCgkJCSJjbGljayAudWktbWVudS1pdGVtIjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKTsNCgkJCQl2YXIgYWN0aXZlID0gJCggJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgKTsNCgkJCQlpZiAoICF0aGlzLm1vdXNlSGFuZGxlZCAmJiB0YXJnZXQubm90KCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLmxlbmd0aCApIHsNCgkJCQkJdGhpcy5zZWxlY3QoIGV2ZW50ICk7DQoNCgkJCQkJLy8gT25seSBzZXQgdGhlIG1vdXNlSGFuZGxlZCBmbGFnIGlmIHRoZSBldmVudCB3aWxsIGJ1YmJsZSwgc2VlICM5NDY5Lg0KCQkJCQlpZiAoICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgew0KCQkJCQkJdGhpcy5tb3VzZUhhbmRsZWQgPSB0cnVlOw0KCQkJCQl9DQoNCgkJCQkJLy8gT3BlbiBzdWJtZW51IG9uIGNsaWNrDQoJCQkJCWlmICggdGFyZ2V0LmhhcyggIi51aS1tZW51IiApLmxlbmd0aCApIHsNCgkJCQkJCXRoaXMuZXhwYW5kKCBldmVudCApOw0KCQkJCQl9IGVsc2UgaWYgKCAhdGhpcy5lbGVtZW50LmlzKCAiOmZvY3VzIiApICYmDQoJCQkJCQkJYWN0aXZlLmNsb3Nlc3QoICIudWktbWVudSIgKS5sZW5ndGggKSB7DQoNCgkJCQkJCS8vIFJlZGlyZWN0IGZvY3VzIHRvIHRoZSBtZW51DQoJCQkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImZvY3VzIiwgWyB0cnVlIF0gKTsNCg0KCQkJCQkJLy8gSWYgdGhlIGFjdGl2ZSBpdGVtIGlzIG9uIHRoZSB0b3AgbGV2ZWwsIGxldCBpdCBzdGF5IGFjdGl2ZS4NCgkJCQkJCS8vIE90aGVyd2lzZSwgYmx1ciB0aGUgYWN0aXZlIGl0ZW0gc2luY2UgaXQgaXMgbm8gbG9uZ2VyIHZpc2libGUuDQoJCQkJCQlpZiAoIHRoaXMuYWN0aXZlICYmIHRoaXMuYWN0aXZlLnBhcmVudHMoICIudWktbWVudSIgKS5sZW5ndGggPT09IDEgKSB7DQoJCQkJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoJCQl9LA0KCQkJIm1vdXNlZW50ZXIgLnVpLW1lbnUtaXRlbSI6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQkJCS8vIElnbm9yZSBtb3VzZSBldmVudHMgd2hpbGUgdHlwZWFoZWFkIGlzIGFjdGl2ZSwgc2VlICMxMDQ1OC4NCgkJCQkvLyBQcmV2ZW50cyBmb2N1c2luZyB0aGUgd3JvbmcgaXRlbSB3aGVuIHR5cGVhaGVhZCBjYXVzZXMgYSBzY3JvbGwgd2hpbGUgdGhlIG1vdXNlDQoJCQkJLy8gaXMgb3ZlciBhbiBpdGVtIGluIHRoZSBtZW51DQoJCQkJaWYgKCB0aGlzLnByZXZpb3VzRmlsdGVyICkgew0KCQkJCQlyZXR1cm47DQoJCQkJfQ0KDQoJCQkJdmFyIGFjdHVhbFRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiApLA0KCQkJCQl0YXJnZXQgPSAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICk7DQoNCgkJCQkvLyBJZ25vcmUgYnViYmxlZCBldmVudHMgb24gcGFyZW50IGl0ZW1zLCBzZWUgIzExNjQxDQoJCQkJaWYgKCBhY3R1YWxUYXJnZXRbIDAgXSAhPT0gdGFyZ2V0WyAwIF0gKSB7DQoJCQkJCXJldHVybjsNCgkJCQl9DQoNCgkJCQkvLyBSZW1vdmUgdWktc3RhdGUtYWN0aXZlIGNsYXNzIGZyb20gc2libGluZ3Mgb2YgdGhlIG5ld2x5IGZvY3VzZWQgbWVudSBpdGVtDQoJCQkJLy8gdG8gYXZvaWQgYSBqdW1wIGNhdXNlZCBieSBhZGphY2VudCBlbGVtZW50cyBib3RoIGhhdmluZyBhIGNsYXNzIHdpdGggYSBib3JkZXINCgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGFyZ2V0LnNpYmxpbmdzKCkuY2hpbGRyZW4oICIudWktc3RhdGUtYWN0aXZlIiApLA0KCQkJCQludWxsLCAidWktc3RhdGUtYWN0aXZlIiApOw0KCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0YXJnZXQgKTsNCgkJCX0sDQoJCQltb3VzZWxlYXZlOiAiY29sbGFwc2VBbGwiLA0KCQkJIm1vdXNlbGVhdmUgLnVpLW1lbnUiOiAiY29sbGFwc2VBbGwiLA0KCQkJZm9jdXM6IGZ1bmN0aW9uKCBldmVudCwga2VlcEFjdGl2ZUl0ZW0gKSB7DQoNCgkJCQkvLyBJZiB0aGVyZSdzIGFscmVhZHkgYW4gYWN0aXZlIGl0ZW0sIGtlZXAgaXQgYWN0aXZlDQoJCQkJLy8gSWYgbm90LCBhY3RpdmF0ZSB0aGUgZmlyc3QgaXRlbQ0KCQkJCXZhciBpdGVtID0gdGhpcy5hY3RpdmUgfHwgdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApLmVxKCAwICk7DQoNCgkJCQlpZiAoICFrZWVwQWN0aXZlSXRlbSApIHsNCgkJCQkJdGhpcy5mb2N1cyggZXZlbnQsIGl0ZW0gKTsNCgkJCQl9DQoJCQl9LA0KCQkJYmx1cjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsNCgkJCQkJdmFyIG5vdENvbnRhaW5lZCA9ICEkLmNvbnRhaW5zKA0KCQkJCQkJdGhpcy5lbGVtZW50WyAwIF0sDQoJCQkJCQkkLnVpLnNhZmVBY3RpdmVFbGVtZW50KCB0aGlzLmRvY3VtZW50WyAwIF0gKQ0KCQkJCQkpOw0KCQkJCQlpZiAoIG5vdENvbnRhaW5lZCApIHsNCgkJCQkJCXRoaXMuY29sbGFwc2VBbGwoIGV2ZW50ICk7DQoJCQkJCX0NCgkJCQl9ICk7DQoJCQl9LA0KCQkJa2V5ZG93bjogIl9rZXlkb3duIg0KCQl9ICk7DQoNCgkJdGhpcy5yZWZyZXNoKCk7DQoNCgkJLy8gQ2xpY2tzIG91dHNpZGUgb2YgYSBtZW51IGNvbGxhcHNlIGFueSBvcGVuIG1lbnVzDQoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7DQoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCWlmICggdGhpcy5fY2xvc2VPbkRvY3VtZW50Q2xpY2soIGV2ZW50ICkgKSB7DQoJCQkJCXRoaXMuY29sbGFwc2VBbGwoIGV2ZW50ICk7DQoJCQkJfQ0KDQoJCQkJLy8gUmVzZXQgdGhlIG1vdXNlSGFuZGxlZCBmbGFnDQoJCQkJdGhpcy5tb3VzZUhhbmRsZWQgPSBmYWxzZTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfZGVzdHJveTogZnVuY3Rpb24oKSB7DQoJCXZhciBpdGVtcyA9IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLW1lbnUtaXRlbSIgKQ0KCQkJCS5yZW1vdmVBdHRyKCAicm9sZSBhcmlhLWRpc2FibGVkIiApLA0KCQkJc3VibWVudXMgPSBpdGVtcy5jaGlsZHJlbiggIi51aS1tZW51LWl0ZW0td3JhcHBlciIgKQ0KCQkJCS5yZW1vdmVVbmlxdWVJZCgpDQoJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCByb2xlIGFyaWEtaGFzcG9wdXAiICk7DQoNCgkJLy8gRGVzdHJveSAoc3ViKW1lbnVzDQoJCXRoaXMuZWxlbWVudA0KCQkJLnJlbW92ZUF0dHIoICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiICkNCgkJCS5maW5kKCAiLnVpLW1lbnUiICkuYWRkQmFjaygpDQoJCQkJLnJlbW92ZUF0dHIoICJyb2xlIGFyaWEtbGFiZWxsZWRieSBhcmlhLWV4cGFuZGVkIGFyaWEtaGlkZGVuIGFyaWEtZGlzYWJsZWQgIiArDQoJCQkJCSJ0YWJJbmRleCIgKQ0KCQkJCS5yZW1vdmVVbmlxdWVJZCgpDQoJCQkJLnNob3coKTsNCg0KCQlzdWJtZW51cy5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJdmFyIGVsZW0gPSAkKCB0aGlzICk7DQoJCQlpZiAoIGVsZW0uZGF0YSggInVpLW1lbnUtc3VibWVudS1jYXJldCIgKSApIHsNCgkJCQllbGVtLnJlbW92ZSgpOw0KCQkJfQ0KCQl9ICk7DQoJfSwNCg0KCV9rZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBtYXRjaCwgcHJldiwgY2hhcmFjdGVyLCBza2lwLA0KCQkJcHJldmVudERlZmF1bHQgPSB0cnVlOw0KDQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7DQoJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfVVA6DQoJCQl0aGlzLnByZXZpb3VzUGFnZSggZXZlbnQgKTsNCgkJCWJyZWFrOw0KCQljYXNlICQudWkua2V5Q29kZS5QQUdFX0RPV046DQoJCQl0aGlzLm5leHRQYWdlKCBldmVudCApOw0KCQkJYnJlYWs7DQoJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6DQoJCQl0aGlzLl9tb3ZlKCAiZmlyc3QiLCAiZmlyc3QiLCBldmVudCApOw0KCQkJYnJlYWs7DQoJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoNCgkJCXRoaXMuX21vdmUoICJsYXN0IiwgImxhc3QiLCBldmVudCApOw0KCQkJYnJlYWs7DQoJCWNhc2UgJC51aS5rZXlDb2RlLlVQOg0KCQkJdGhpcy5wcmV2aW91cyggZXZlbnQgKTsNCgkJCWJyZWFrOw0KCQljYXNlICQudWkua2V5Q29kZS5ET1dOOg0KCQkJdGhpcy5uZXh0KCBldmVudCApOw0KCQkJYnJlYWs7DQoJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6DQoJCQl0aGlzLmNvbGxhcHNlKCBldmVudCApOw0KCQkJYnJlYWs7DQoJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOg0KCQkJaWYgKCB0aGlzLmFjdGl2ZSAmJiAhdGhpcy5hY3RpdmUuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7DQoJCQkJdGhpcy5leHBhbmQoIGV2ZW50ICk7DQoJCQl9DQoJCQlicmVhazsNCgkJY2FzZSAkLnVpLmtleUNvZGUuRU5URVI6DQoJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOg0KCQkJdGhpcy5fYWN0aXZhdGUoIGV2ZW50ICk7DQoJCQlicmVhazsNCgkJY2FzZSAkLnVpLmtleUNvZGUuRVNDQVBFOg0KCQkJdGhpcy5jb2xsYXBzZSggZXZlbnQgKTsNCgkJCWJyZWFrOw0KCQlkZWZhdWx0Og0KCQkJcHJldmVudERlZmF1bHQgPSBmYWxzZTsNCgkJCXByZXYgPSB0aGlzLnByZXZpb3VzRmlsdGVyIHx8ICIiOw0KCQkJc2tpcCA9IGZhbHNlOw0KDQoJCQkvLyBTdXBwb3J0IG51bWJlciBwYWQgdmFsdWVzDQoJCQljaGFyYWN0ZXIgPSBldmVudC5rZXlDb2RlID49IDk2ICYmIGV2ZW50LmtleUNvZGUgPD0gMTA1ID8NCgkJCQkoIGV2ZW50LmtleUNvZGUgLSA5NiApLnRvU3RyaW5nKCkgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKCBldmVudC5rZXlDb2RlICk7DQoNCgkJCWNsZWFyVGltZW91dCggdGhpcy5maWx0ZXJUaW1lciApOw0KDQoJCQlpZiAoIGNoYXJhY3RlciA9PT0gcHJldiApIHsNCgkJCQlza2lwID0gdHJ1ZTsNCgkJCX0gZWxzZSB7DQoJCQkJY2hhcmFjdGVyID0gcHJldiArIGNoYXJhY3RlcjsNCgkJCX0NCg0KCQkJbWF0Y2ggPSB0aGlzLl9maWx0ZXJNZW51SXRlbXMoIGNoYXJhY3RlciApOw0KCQkJbWF0Y2ggPSBza2lwICYmIG1hdGNoLmluZGV4KCB0aGlzLmFjdGl2ZS5uZXh0KCkgKSAhPT0gLTEgPw0KCQkJCXRoaXMuYWN0aXZlLm5leHRBbGwoICIudWktbWVudS1pdGVtIiApIDoNCgkJCQltYXRjaDsNCg0KCQkJLy8gSWYgbm8gbWF0Y2hlcyBvbiB0aGUgY3VycmVudCBmaWx0ZXIsIHJlc2V0IHRvIHRoZSBsYXN0IGNoYXJhY3RlciBwcmVzc2VkDQoJCQkvLyB0byBtb3ZlIGRvd24gdGhlIG1lbnUgdG8gdGhlIGZpcnN0IGl0ZW0gdGhhdCBzdGFydHMgd2l0aCB0aGF0IGNoYXJhY3Rlcg0KCQkJaWYgKCAhbWF0Y2gubGVuZ3RoICkgew0KCQkJCWNoYXJhY3RlciA9IFN0cmluZy5mcm9tQ2hhckNvZGUoIGV2ZW50LmtleUNvZGUgKTsNCgkJCQltYXRjaCA9IHRoaXMuX2ZpbHRlck1lbnVJdGVtcyggY2hhcmFjdGVyICk7DQoJCQl9DQoNCgkJCWlmICggbWF0Y2gubGVuZ3RoICkgew0KCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCBtYXRjaCApOw0KCQkJCXRoaXMucHJldmlvdXNGaWx0ZXIgPSBjaGFyYWN0ZXI7DQoJCQkJdGhpcy5maWx0ZXJUaW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsNCgkJCQkJZGVsZXRlIHRoaXMucHJldmlvdXNGaWx0ZXI7DQoJCQkJfSwgMTAwMCApOw0KCQkJfSBlbHNlIHsNCgkJCQlkZWxldGUgdGhpcy5wcmV2aW91c0ZpbHRlcjsNCgkJCX0NCgkJfQ0KDQoJCWlmICggcHJldmVudERlZmF1bHQgKSB7DQoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQl9DQoJfSwNCg0KCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoIHRoaXMuYWN0aXZlICYmICF0aGlzLmFjdGl2ZS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsNCgkJCWlmICggdGhpcy5hY3RpdmUuY2hpbGRyZW4oICJbYXJpYS1oYXNwb3B1cD0ndHJ1ZSddIiApLmxlbmd0aCApIHsNCgkJCQl0aGlzLmV4cGFuZCggZXZlbnQgKTsNCgkJCX0gZWxzZSB7DQoJCQkJdGhpcy5zZWxlY3QoIGV2ZW50ICk7DQoJCQl9DQoJCX0NCgl9LA0KDQoJcmVmcmVzaDogZnVuY3Rpb24oKSB7DQoJCXZhciBtZW51cywgaXRlbXMsIG5ld1N1Ym1lbnVzLCBuZXdJdGVtcywgbmV3V3JhcHBlcnMsDQoJCQl0aGF0ID0gdGhpcywNCgkJCWljb24gPSB0aGlzLm9wdGlvbnMuaWNvbnMuc3VibWVudSwNCgkJCXN1Ym1lbnVzID0gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMub3B0aW9ucy5tZW51cyApOw0KDQoJCXRoaXMuX3RvZ2dsZUNsYXNzKCAidWktbWVudS1pY29ucyIsIG51bGwsICEhdGhpcy5lbGVtZW50LmZpbmQoICIudWktaWNvbiIgKS5sZW5ndGggKTsNCg0KCQkvLyBJbml0aWFsaXplIG5lc3RlZCBtZW51cw0KCQluZXdTdWJtZW51cyA9IHN1Ym1lbnVzLmZpbHRlciggIjpub3QoLnVpLW1lbnUpIiApDQoJCQkuaGlkZSgpDQoJCQkuYXR0ciggew0KCQkJCXJvbGU6IHRoaXMub3B0aW9ucy5yb2xlLA0KCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIiwNCgkJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSINCgkJCX0gKQ0KCQkJLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCXZhciBtZW51ID0gJCggdGhpcyApLA0KCQkJCQlpdGVtID0gbWVudS5wcmV2KCksDQoJCQkJCXN1Ym1lbnVDYXJldCA9ICQoICI8c3Bhbj4iICkuZGF0YSggInVpLW1lbnUtc3VibWVudS1jYXJldCIsIHRydWUgKTsNCg0KCQkJCXRoYXQuX2FkZENsYXNzKCBzdWJtZW51Q2FyZXQsICJ1aS1tZW51LWljb24iLCAidWktaWNvbiAiICsgaWNvbiApOw0KCQkJCWl0ZW0NCgkJCQkJLmF0dHIoICJhcmlhLWhhc3BvcHVwIiwgInRydWUiICkNCgkJCQkJLnByZXBlbmQoIHN1Ym1lbnVDYXJldCApOw0KCQkJCW1lbnUuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGl0ZW0uYXR0ciggImlkIiApICk7DQoJCQl9ICk7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoIG5ld1N1Ym1lbnVzLCAidWktbWVudSIsICJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktZnJvbnQiICk7DQoNCgkJbWVudXMgPSBzdWJtZW51cy5hZGQoIHRoaXMuZWxlbWVudCApOw0KCQlpdGVtcyA9IG1lbnVzLmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApOw0KDQoJCS8vIEluaXRpYWxpemUgbWVudS1pdGVtcyBjb250YWluaW5nIHNwYWNlcyBhbmQvb3IgZGFzaGVzIG9ubHkgYXMgZGl2aWRlcnMNCgkJaXRlbXMubm90KCAiLnVpLW1lbnUtaXRlbSIgKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCXZhciBpdGVtID0gJCggdGhpcyApOw0KCQkJaWYgKCB0aGF0Ll9pc0RpdmlkZXIoIGl0ZW0gKSApIHsNCgkJCQl0aGF0Ll9hZGRDbGFzcyggaXRlbSwgInVpLW1lbnUtZGl2aWRlciIsICJ1aS13aWRnZXQtY29udGVudCIgKTsNCgkJCX0NCgkJfSApOw0KDQoJCS8vIERvbid0IHJlZnJlc2ggbGlzdCBpdGVtcyB0aGF0IGFyZSBhbHJlYWR5IGFkYXB0ZWQNCgkJbmV3SXRlbXMgPSBpdGVtcy5ub3QoICIudWktbWVudS1pdGVtLCAudWktbWVudS1kaXZpZGVyIiApOw0KCQluZXdXcmFwcGVycyA9IG5ld0l0ZW1zLmNoaWxkcmVuKCkNCgkJCS5ub3QoICIudWktbWVudSIgKQ0KCQkJCS51bmlxdWVJZCgpDQoJCQkJLmF0dHIoIHsNCgkJCQkJdGFiSW5kZXg6IC0xLA0KCQkJCQlyb2xlOiB0aGlzLl9pdGVtUm9sZSgpDQoJCQkJfSApOw0KCQl0aGlzLl9hZGRDbGFzcyggbmV3SXRlbXMsICJ1aS1tZW51LWl0ZW0iICkNCgkJCS5fYWRkQ2xhc3MoIG5ld1dyYXBwZXJzLCAidWktbWVudS1pdGVtLXdyYXBwZXIiICk7DQoNCgkJLy8gQWRkIGFyaWEtZGlzYWJsZWQgYXR0cmlidXRlIHRvIGFueSBkaXNhYmxlZCBtZW51IGl0ZW0NCgkJaXRlbXMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgInRydWUiICk7DQoNCgkJLy8gSWYgdGhlIGFjdGl2ZSBpdGVtIGhhcyBiZWVuIHJlbW92ZWQsIGJsdXIgdGhlIG1lbnUNCgkJaWYgKCB0aGlzLmFjdGl2ZSAmJiAhJC5jb250YWlucyggdGhpcy5lbGVtZW50WyAwIF0sIHRoaXMuYWN0aXZlWyAwIF0gKSApIHsNCgkJCXRoaXMuYmx1cigpOw0KCQl9DQoJfSwNCg0KCV9pdGVtUm9sZTogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB7DQoJCQltZW51OiAibWVudWl0ZW0iLA0KCQkJbGlzdGJveDogIm9wdGlvbiINCgkJfVsgdGhpcy5vcHRpb25zLnJvbGUgXTsNCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCWlmICgga2V5ID09PSAiaWNvbnMiICkgew0KCQkJdmFyIGljb25zID0gdGhpcy5lbGVtZW50LmZpbmQoICIudWktbWVudS1pY29uIiApOw0KCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGljb25zLCBudWxsLCB0aGlzLm9wdGlvbnMuaWNvbnMuc3VibWVudSApDQoJCQkJLl9hZGRDbGFzcyggaWNvbnMsIG51bGwsIHZhbHVlLnN1Ym1lbnUgKTsNCgkJfQ0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KCX0sDQoNCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7DQoNCgkJdGhpcy5lbGVtZW50LmF0dHIoICJhcmlhLWRpc2FibGVkIiwgU3RyaW5nKCB2YWx1ZSApICk7DQoJCXRoaXMuX3RvZ2dsZUNsYXNzKCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICk7DQoJfSwNCg0KCWZvY3VzOiBmdW5jdGlvbiggZXZlbnQsIGl0ZW0gKSB7DQoJCXZhciBuZXN0ZWQsIGZvY3VzZWQsIGFjdGl2ZVBhcmVudDsNCgkJdGhpcy5ibHVyKCBldmVudCwgZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gImZvY3VzIiApOw0KDQoJCXRoaXMuX3Njcm9sbEludG9WaWV3KCBpdGVtICk7DQoNCgkJdGhpcy5hY3RpdmUgPSBpdGVtLmZpcnN0KCk7DQoNCgkJZm9jdXNlZCA9IHRoaXMuYWN0aXZlLmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbS13cmFwcGVyIiApOw0KCQl0aGlzLl9hZGRDbGFzcyggZm9jdXNlZCwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsNCg0KCQkvLyBPbmx5IHVwZGF0ZSBhcmlhLWFjdGl2ZWRlc2NlbmRhbnQgaWYgdGhlcmUncyBhIHJvbGUNCgkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBmb2N1cyBpcyBtYW5hZ2VkIGVsc2V3aGVyZQ0KCQlpZiAoIHRoaXMub3B0aW9ucy5yb2xlICkgew0KCQkJdGhpcy5lbGVtZW50LmF0dHIoICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLCBmb2N1c2VkLmF0dHIoICJpZCIgKSApOw0KCQl9DQoNCgkJLy8gSGlnaGxpZ2h0IGFjdGl2ZSBwYXJlbnQgbWVudSBpdGVtLCBpZiBhbnkNCgkJYWN0aXZlUGFyZW50ID0gdGhpcy5hY3RpdmUNCgkJCS5wYXJlbnQoKQ0KCQkJCS5jbG9zZXN0KCAiLnVpLW1lbnUtaXRlbSIgKQ0KCQkJCQkuY2hpbGRyZW4oICIudWktbWVudS1pdGVtLXdyYXBwZXIiICk7DQoJCXRoaXMuX2FkZENsYXNzKCBhY3RpdmVQYXJlbnQsIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoNCgkJaWYgKCBldmVudCAmJiBldmVudC50eXBlID09PSAia2V5ZG93biIgKSB7DQoJCQl0aGlzLl9jbG9zZSgpOw0KCQl9IGVsc2Ugew0KCQkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsNCgkJCQl0aGlzLl9jbG9zZSgpOw0KCQkJfSwgdGhpcy5kZWxheSApOw0KCQl9DQoNCgkJbmVzdGVkID0gaXRlbS5jaGlsZHJlbiggIi51aS1tZW51IiApOw0KCQlpZiAoIG5lc3RlZC5sZW5ndGggJiYgZXZlbnQgJiYgKCAvXm1vdXNlLy50ZXN0KCBldmVudC50eXBlICkgKSApIHsNCgkJCXRoaXMuX3N0YXJ0T3BlbmluZyggbmVzdGVkICk7DQoJCX0NCgkJdGhpcy5hY3RpdmVNZW51ID0gaXRlbS5wYXJlbnQoKTsNCg0KCQl0aGlzLl90cmlnZ2VyKCAiZm9jdXMiLCBldmVudCwgeyBpdGVtOiBpdGVtIH0gKTsNCgl9LA0KDQoJX3Njcm9sbEludG9WaWV3OiBmdW5jdGlvbiggaXRlbSApIHsNCgkJdmFyIGJvcmRlclRvcCwgcGFkZGluZ1RvcCwgb2Zmc2V0LCBzY3JvbGwsIGVsZW1lbnRIZWlnaHQsIGl0ZW1IZWlnaHQ7DQoJCWlmICggdGhpcy5faGFzU2Nyb2xsKCkgKSB7DQoJCQlib3JkZXJUb3AgPSBwYXJzZUZsb2F0KCAkLmNzcyggdGhpcy5hY3RpdmVNZW51WyAwIF0sICJib3JkZXJUb3BXaWR0aCIgKSApIHx8IDA7DQoJCQlwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggJC5jc3MoIHRoaXMuYWN0aXZlTWVudVsgMCBdLCAicGFkZGluZ1RvcCIgKSApIHx8IDA7DQoJCQlvZmZzZXQgPSBpdGVtLm9mZnNldCgpLnRvcCAtIHRoaXMuYWN0aXZlTWVudS5vZmZzZXQoKS50b3AgLSBib3JkZXJUb3AgLSBwYWRkaW5nVG9wOw0KCQkJc2Nyb2xsID0gdGhpcy5hY3RpdmVNZW51LnNjcm9sbFRvcCgpOw0KCQkJZWxlbWVudEhlaWdodCA9IHRoaXMuYWN0aXZlTWVudS5oZWlnaHQoKTsNCgkJCWl0ZW1IZWlnaHQgPSBpdGVtLm91dGVySGVpZ2h0KCk7DQoNCgkJCWlmICggb2Zmc2V0IDwgMCApIHsNCgkJCQl0aGlzLmFjdGl2ZU1lbnUuc2Nyb2xsVG9wKCBzY3JvbGwgKyBvZmZzZXQgKTsNCgkJCX0gZWxzZSBpZiAoIG9mZnNldCArIGl0ZW1IZWlnaHQgPiBlbGVtZW50SGVpZ2h0ICkgew0KCQkJCXRoaXMuYWN0aXZlTWVudS5zY3JvbGxUb3AoIHNjcm9sbCArIG9mZnNldCAtIGVsZW1lbnRIZWlnaHQgKyBpdGVtSGVpZ2h0ICk7DQoJCQl9DQoJCX0NCgl9LA0KDQoJYmx1cjogZnVuY3Rpb24oIGV2ZW50LCBmcm9tRm9jdXMgKSB7DQoJCWlmICggIWZyb21Gb2N1cyApIHsNCgkJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOw0KCQl9DQoNCgkJaWYgKCAhdGhpcy5hY3RpdmUgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5hY3RpdmUuY2hpbGRyZW4oICIudWktbWVudS1pdGVtLXdyYXBwZXIiICksDQoJCQludWxsLCAidWktc3RhdGUtYWN0aXZlIiApOw0KDQoJCXRoaXMuX3RyaWdnZXIoICJibHVyIiwgZXZlbnQsIHsgaXRlbTogdGhpcy5hY3RpdmUgfSApOw0KCQl0aGlzLmFjdGl2ZSA9IG51bGw7DQoJfSwNCg0KCV9zdGFydE9wZW5pbmc6IGZ1bmN0aW9uKCBzdWJtZW51ICkgew0KCQljbGVhclRpbWVvdXQoIHRoaXMudGltZXIgKTsNCg0KCQkvLyBEb24ndCBvcGVuIGlmIGFscmVhZHkgb3BlbiBmaXhlcyBhIEZpcmVmb3ggYnVnIHRoYXQgY2F1c2VkIGEgLjUgcGl4ZWwNCgkJLy8gc2hpZnQgaW4gdGhlIHN1Ym1lbnUgcG9zaXRpb24gd2hlbiBtb3VzaW5nIG92ZXIgdGhlIGNhcmV0IGljb24NCgkJaWYgKCBzdWJtZW51LmF0dHIoICJhcmlhLWhpZGRlbiIgKSAhPT0gInRydWUiICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsNCgkJCXRoaXMuX2Nsb3NlKCk7DQoJCQl0aGlzLl9vcGVuKCBzdWJtZW51ICk7DQoJCX0sIHRoaXMuZGVsYXkgKTsNCgl9LA0KDQoJX29wZW46IGZ1bmN0aW9uKCBzdWJtZW51ICkgew0KCQl2YXIgcG9zaXRpb24gPSAkLmV4dGVuZCggew0KCQkJb2Y6IHRoaXMuYWN0aXZlDQoJCX0sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApOw0KDQoJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOw0KCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1tZW51IiApLm5vdCggc3VibWVudS5wYXJlbnRzKCAiLnVpLW1lbnUiICkgKQ0KCQkJLmhpZGUoKQ0KCQkJLmF0dHIoICJhcmlhLWhpZGRlbiIsICJ0cnVlIiApOw0KDQoJCXN1Ym1lbnUNCgkJCS5zaG93KCkNCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkNCgkJCS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsICJ0cnVlIiApDQoJCQkucG9zaXRpb24oIHBvc2l0aW9uICk7DQoJfSwNCg0KCWNvbGxhcHNlQWxsOiBmdW5jdGlvbiggZXZlbnQsIGFsbCApIHsNCgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7DQoJCXRoaXMudGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoNCgkJCS8vIElmIHdlIHdlcmUgcGFzc2VkIGFuIGV2ZW50LCBsb29rIGZvciB0aGUgc3VibWVudSB0aGF0IGNvbnRhaW5zIHRoZSBldmVudA0KCQkJdmFyIGN1cnJlbnRNZW51ID0gYWxsID8gdGhpcy5lbGVtZW50IDoNCgkJCQkkKCBldmVudCAmJiBldmVudC50YXJnZXQgKS5jbG9zZXN0KCB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1tZW51IiApICk7DQoNCgkJCS8vIElmIHdlIGZvdW5kIG5vIHZhbGlkIHN1Ym1lbnUgYW5jZXN0b3IsIHVzZSB0aGUgbWFpbiBtZW51IHRvIGNsb3NlIGFsbA0KCQkJLy8gc3ViIG1lbnVzIGFueXdheQ0KCQkJaWYgKCAhY3VycmVudE1lbnUubGVuZ3RoICkgew0KCQkJCWN1cnJlbnRNZW51ID0gdGhpcy5lbGVtZW50Ow0KCQkJfQ0KDQoJCQl0aGlzLl9jbG9zZSggY3VycmVudE1lbnUgKTsNCg0KCQkJdGhpcy5ibHVyKCBldmVudCApOw0KDQoJCQkvLyBXb3JrIGFyb3VuZCBhY3RpdmUgaXRlbSBzdGF5aW5nIGFjdGl2ZSBhZnRlciBtZW51IGlzIGJsdXJyZWQNCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBjdXJyZW50TWVudS5maW5kKCAiLnVpLXN0YXRlLWFjdGl2ZSIgKSwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsNCg0KCQkJdGhpcy5hY3RpdmVNZW51ID0gY3VycmVudE1lbnU7DQoJCX0sIHRoaXMuZGVsYXkgKTsNCgl9LA0KDQoJLy8gV2l0aCBubyBhcmd1bWVudHMsIGNsb3NlcyB0aGUgY3VycmVudGx5IGFjdGl2ZSBtZW51IC0gaWYgbm90aGluZyBpcyBhY3RpdmUNCgkvLyBpdCBjbG9zZXMgYWxsIG1lbnVzLiAgSWYgcGFzc2VkIGFuIGFyZ3VtZW50LCBpdCB3aWxsIHNlYXJjaCBmb3IgbWVudXMgQkVMT1cNCglfY2xvc2U6IGZ1bmN0aW9uKCBzdGFydE1lbnUgKSB7DQoJCWlmICggIXN0YXJ0TWVudSApIHsNCgkJCXN0YXJ0TWVudSA9IHRoaXMuYWN0aXZlID8gdGhpcy5hY3RpdmUucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQ7DQoJCX0NCg0KCQlzdGFydE1lbnUuZmluZCggIi51aS1tZW51IiApDQoJCQkuaGlkZSgpDQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgInRydWUiICkNCgkJCS5hdHRyKCAiYXJpYS1leHBhbmRlZCIsICJmYWxzZSIgKTsNCgl9LA0KDQoJX2Nsb3NlT25Eb2N1bWVudENsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXJldHVybiAhJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1tZW51IiApLmxlbmd0aDsNCgl9LA0KDQoJX2lzRGl2aWRlcjogZnVuY3Rpb24oIGl0ZW0gKSB7DQoNCgkJLy8gTWF0Y2ggaHlwaGVuLCBlbSBkYXNoLCBlbiBkYXNoDQoJCXJldHVybiAhL1teXC1cdTIwMTRcdTIwMTNcc10vLnRlc3QoIGl0ZW0udGV4dCgpICk7DQoJfSwNCg0KCWNvbGxhcHNlOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBuZXdJdGVtID0gdGhpcy5hY3RpdmUgJiYNCgkJCXRoaXMuYWN0aXZlLnBhcmVudCgpLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiwgdGhpcy5lbGVtZW50ICk7DQoJCWlmICggbmV3SXRlbSAmJiBuZXdJdGVtLmxlbmd0aCApIHsNCgkJCXRoaXMuX2Nsb3NlKCk7DQoJCQl0aGlzLmZvY3VzKCBldmVudCwgbmV3SXRlbSApOw0KCQl9DQoJfSwNCg0KCWV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgbmV3SXRlbSA9IHRoaXMuYWN0aXZlICYmDQoJCQl0aGlzLmFjdGl2ZQ0KCQkJCS5jaGlsZHJlbiggIi51aS1tZW51ICIgKQ0KCQkJCQkuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkNCgkJCQkJCS5maXJzdCgpOw0KDQoJCWlmICggbmV3SXRlbSAmJiBuZXdJdGVtLmxlbmd0aCApIHsNCgkJCXRoaXMuX29wZW4oIG5ld0l0ZW0ucGFyZW50KCkgKTsNCg0KCQkJLy8gRGVsYXkgc28gRmlyZWZveCB3aWxsIG5vdCBoaWRlIGFjdGl2ZWRlc2NlbmRhbnQgY2hhbmdlIGluIGV4cGFuZGluZyBzdWJtZW51IGZyb20gQVQNCgkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsNCgkJCQl0aGlzLmZvY3VzKCBldmVudCwgbmV3SXRlbSApOw0KCQkJfSApOw0KCQl9DQoJfSwNCg0KCW5leHQ6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdGhpcy5fbW92ZSggIm5leHQiLCAiZmlyc3QiLCBldmVudCApOw0KCX0sDQoNCglwcmV2aW91czogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl0aGlzLl9tb3ZlKCAicHJldiIsICJsYXN0IiwgZXZlbnQgKTsNCgl9LA0KDQoJaXNGaXJzdEl0ZW06IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5hY3RpdmUgJiYgIXRoaXMuYWN0aXZlLnByZXZBbGwoICIudWktbWVudS1pdGVtIiApLmxlbmd0aDsNCgl9LA0KDQoJaXNMYXN0SXRlbTogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLmFjdGl2ZSAmJiAhdGhpcy5hY3RpdmUubmV4dEFsbCggIi51aS1tZW51LWl0ZW0iICkubGVuZ3RoOw0KCX0sDQoNCglfbW92ZTogZnVuY3Rpb24oIGRpcmVjdGlvbiwgZmlsdGVyLCBldmVudCApIHsNCgkJdmFyIG5leHQ7DQoJCWlmICggdGhpcy5hY3RpdmUgKSB7DQoJCQlpZiAoIGRpcmVjdGlvbiA9PT0gImZpcnN0IiB8fCBkaXJlY3Rpb24gPT09ICJsYXN0IiApIHsNCgkJCQluZXh0ID0gdGhpcy5hY3RpdmUNCgkJCQkJWyBkaXJlY3Rpb24gPT09ICJmaXJzdCIgPyAicHJldkFsbCIgOiAibmV4dEFsbCIgXSggIi51aS1tZW51LWl0ZW0iICkNCgkJCQkJLmVxKCAtMSApOw0KCQkJfSBlbHNlIHsNCgkJCQluZXh0ID0gdGhpcy5hY3RpdmUNCgkJCQkJWyBkaXJlY3Rpb24gKyAiQWxsIiBdKCAiLnVpLW1lbnUtaXRlbSIgKQ0KCQkJCQkuZXEoIDAgKTsNCgkJCX0NCgkJfQ0KCQlpZiAoICFuZXh0IHx8ICFuZXh0Lmxlbmd0aCB8fCAhdGhpcy5hY3RpdmUgKSB7DQoJCQluZXh0ID0gdGhpcy5hY3RpdmVNZW51LmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApWyBmaWx0ZXIgXSgpOw0KCQl9DQoNCgkJdGhpcy5mb2N1cyggZXZlbnQsIG5leHQgKTsNCgl9LA0KDQoJbmV4dFBhZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIGl0ZW0sIGJhc2UsIGhlaWdodDsNCg0KCQlpZiAoICF0aGlzLmFjdGl2ZSApIHsNCgkJCXRoaXMubmV4dCggZXZlbnQgKTsNCgkJCXJldHVybjsNCgkJfQ0KCQlpZiAoIHRoaXMuaXNMYXN0SXRlbSgpICkgew0KCQkJcmV0dXJuOw0KCQl9DQoJCWlmICggdGhpcy5faGFzU2Nyb2xsKCkgKSB7DQoJCQliYXNlID0gdGhpcy5hY3RpdmUub2Zmc2V0KCkudG9wOw0KCQkJaGVpZ2h0ID0gdGhpcy5lbGVtZW50LmhlaWdodCgpOw0KCQkJdGhpcy5hY3RpdmUubmV4dEFsbCggIi51aS1tZW51LWl0ZW0iICkuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJaXRlbSA9ICQoIHRoaXMgKTsNCgkJCQlyZXR1cm4gaXRlbS5vZmZzZXQoKS50b3AgLSBiYXNlIC0gaGVpZ2h0IDwgMDsNCgkJCX0gKTsNCg0KCQkJdGhpcy5mb2N1cyggZXZlbnQsIGl0ZW0gKTsNCgkJfSBlbHNlIHsNCgkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0aGlzLmFjdGl2ZU1lbnUuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkNCgkJCQlbICF0aGlzLmFjdGl2ZSA\/ICJmaXJzdCIgOiAibGFzdCIgXSgpICk7DQoJCX0NCgl9LA0KDQoJcHJldmlvdXNQYWdlOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBpdGVtLCBiYXNlLCBoZWlnaHQ7DQoJCWlmICggIXRoaXMuYWN0aXZlICkgew0KCQkJdGhpcy5uZXh0KCBldmVudCApOw0KCQkJcmV0dXJuOw0KCQl9DQoJCWlmICggdGhpcy5pc0ZpcnN0SXRlbSgpICkgew0KCQkJcmV0dXJuOw0KCQl9DQoJCWlmICggdGhpcy5faGFzU2Nyb2xsKCkgKSB7DQoJCQliYXNlID0gdGhpcy5hY3RpdmUub2Zmc2V0KCkudG9wOw0KCQkJaGVpZ2h0ID0gdGhpcy5lbGVtZW50LmhlaWdodCgpOw0KCQkJdGhpcy5hY3RpdmUucHJldkFsbCggIi51aS1tZW51LWl0ZW0iICkuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJaXRlbSA9ICQoIHRoaXMgKTsNCgkJCQlyZXR1cm4gaXRlbS5vZmZzZXQoKS50b3AgLSBiYXNlICsgaGVpZ2h0ID4gMDsNCgkJCX0gKTsNCg0KCQkJdGhpcy5mb2N1cyggZXZlbnQsIGl0ZW0gKTsNCgkJfSBlbHNlIHsNCgkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0aGlzLmFjdGl2ZU1lbnUuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkuZmlyc3QoKSApOw0KCQl9DQoJfSwNCg0KCV9oYXNTY3JvbGw6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgPCB0aGlzLmVsZW1lbnQucHJvcCggInNjcm9sbEhlaWdodCIgKTsNCgl9LA0KDQoJc2VsZWN0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJLy8gVE9ETzogSXQgc2hvdWxkIG5ldmVyIGJlIHBvc3NpYmxlIHRvIG5vdCBoYXZlIGFuIGFjdGl2ZSBpdGVtIGF0IHRoaXMNCgkJLy8gcG9pbnQsIGJ1dCB0aGUgdGVzdHMgZG9uJ3QgdHJpZ2dlciBtb3VzZWVudGVyIGJlZm9yZSBjbGljay4NCgkJdGhpcy5hY3RpdmUgPSB0aGlzLmFjdGl2ZSB8fCAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLW1lbnUtaXRlbSIgKTsNCgkJdmFyIHVpID0geyBpdGVtOiB0aGlzLmFjdGl2ZSB9Ow0KCQlpZiAoICF0aGlzLmFjdGl2ZS5oYXMoICIudWktbWVudSIgKS5sZW5ndGggKSB7DQoJCQl0aGlzLmNvbGxhcHNlQWxsKCBldmVudCwgdHJ1ZSApOw0KCQl9DQoJCXRoaXMuX3RyaWdnZXIoICJzZWxlY3QiLCBldmVudCwgdWkgKTsNCgl9LA0KDQoJX2ZpbHRlck1lbnVJdGVtczogZnVuY3Rpb24oIGNoYXJhY3RlciApIHsNCgkJdmFyIGVzY2FwZWRDaGFyYWN0ZXIgPSBjaGFyYWN0ZXIucmVwbGFjZSggL1tcLVxbXF17fSgpKis\/LixcXFxeJHwjXHNdL2csICJcXCQmIiApLA0KCQkJcmVnZXggPSBuZXcgUmVnRXhwKCAiXiIgKyBlc2NhcGVkQ2hhcmFjdGVyLCAiaSIgKTsNCg0KCQlyZXR1cm4gdGhpcy5hY3RpdmVNZW51DQoJCQkuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkNCg0KCQkJCS8vIE9ubHkgbWF0Y2ggb24gaXRlbXMsIG5vdCBkaXZpZGVycyBvciBvdGhlciBjb250ZW50ICgjMTA1NzEpDQoJCQkJLmZpbHRlciggIi51aS1tZW51LWl0ZW0iICkNCgkJCQkJLmZpbHRlciggZnVuY3Rpb24oKSB7DQoJCQkJCQlyZXR1cm4gcmVnZXgudGVzdCgNCgkJCQkJCQkkLnRyaW0oICQoIHRoaXMgKS5jaGlsZHJlbiggIi51aS1tZW51LWl0ZW0td3JhcHBlciIgKS50ZXh0KCkgKSApOw0KCQkJCQl9ICk7DQoJfQ0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIEF1dG9jb21wbGV0ZSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogQXV0b2NvbXBsZXRlDQovLz4+Z3JvdXA6IFdpZGdldHMNCi8vPj5kZXNjcmlwdGlvbjogTGlzdHMgc3VnZ2VzdGVkIHdvcmRzIGFzIHRoZSB1c2VyIGlzIHR5cGluZy4NCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9hdXRvY29tcGxldGUvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vYXV0b2NvbXBsZXRlLw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvYXV0b2NvbXBsZXRlLmNzcw0KLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzDQoNCg0KDQokLndpZGdldCggInVpLmF1dG9jb21wbGV0ZSIsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCglkZWZhdWx0RWxlbWVudDogIjxpbnB1dD4iLA0KCW9wdGlvbnM6IHsNCgkJYXBwZW5kVG86IG51bGwsDQoJCWF1dG9Gb2N1czogZmFsc2UsDQoJCWRlbGF5OiAzMDAsDQoJCW1pbkxlbmd0aDogMSwNCgkJcG9zaXRpb246IHsNCgkJCW15OiAibGVmdCB0b3AiLA0KCQkJYXQ6ICJsZWZ0IGJvdHRvbSIsDQoJCQljb2xsaXNpb246ICJub25lIg0KCQl9LA0KCQlzb3VyY2U6IG51bGwsDQoNCgkJLy8gQ2FsbGJhY2tzDQoJCWNoYW5nZTogbnVsbCwNCgkJY2xvc2U6IG51bGwsDQoJCWZvY3VzOiBudWxsLA0KCQlvcGVuOiBudWxsLA0KCQlyZXNwb25zZTogbnVsbCwNCgkJc2VhcmNoOiBudWxsLA0KCQlzZWxlY3Q6IG51bGwNCgl9LA0KDQoJcmVxdWVzdEluZGV4OiAwLA0KCXBlbmRpbmc6IDAsDQoNCglfY3JlYXRlOiBmdW5jdGlvbigpIHsNCg0KCQkvLyBTb21lIGJyb3dzZXJzIG9ubHkgcmVwZWF0IGtleWRvd24gZXZlbnRzLCBub3Qga2V5cHJlc3MgZXZlbnRzLA0KCQkvLyBzbyB3ZSB1c2UgdGhlIHN1cHByZXNzS2V5UHJlc3MgZmxhZyB0byBkZXRlcm1pbmUgaWYgd2UndmUgYWxyZWFkeQ0KCQkvLyBoYW5kbGVkIHRoZSBrZXlkb3duIGV2ZW50LiAjNzI2OQ0KCQkvLyBVbmZvcnR1bmF0ZWx5IHRoZSBjb2RlIGZvciAmIGluIGtleXByZXNzIGlzIHRoZSBzYW1lIGFzIHRoZSB1cCBhcnJvdywNCgkJLy8gc28gd2UgdXNlIHRoZSBzdXBwcmVzc0tleVByZXNzUmVwZWF0IGZsYWcgdG8gYXZvaWQgaGFuZGxpbmcga2V5cHJlc3MNCgkJLy8gZXZlbnRzIHdoZW4gd2Uga25vdyB0aGUga2V5ZG93biBldmVudCB3YXMgdXNlZCB0byBtb2RpZnkgdGhlDQoJCS8vIHNlYXJjaCB0ZXJtLiAjNzc5OQ0KCQl2YXIgc3VwcHJlc3NLZXlQcmVzcywgc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCwgc3VwcHJlc3NJbnB1dCwNCgkJCW5vZGVOYW1lID0gdGhpcy5lbGVtZW50WyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwNCgkJCWlzVGV4dGFyZWEgPSBub2RlTmFtZSA9PT0gInRleHRhcmVhIiwNCgkJCWlzSW5wdXQgPSBub2RlTmFtZSA9PT0gImlucHV0IjsNCg0KCQkvLyBUZXh0YXJlYXMgYXJlIGFsd2F5cyBtdWx0aS1saW5lDQoJCS8vIElucHV0cyBhcmUgYWx3YXlzIHNpbmdsZS1saW5lLCBldmVuIGlmIGluc2lkZSBhIGNvbnRlbnRFZGl0YWJsZSBlbGVtZW50DQoJCS8vIElFIGFsc28gdHJlYXRzIGlucHV0cyBhcyBjb250ZW50RWRpdGFibGUNCgkJLy8gQWxsIG90aGVyIGVsZW1lbnQgdHlwZXMgYXJlIGRldGVybWluZWQgYnkgd2hldGhlciBvciBub3QgdGhleSdyZSBjb250ZW50RWRpdGFibGUNCgkJdGhpcy5pc011bHRpTGluZSA9IGlzVGV4dGFyZWEgfHwgIWlzSW5wdXQgJiYgdGhpcy5faXNDb250ZW50RWRpdGFibGUoIHRoaXMuZWxlbWVudCApOw0KDQoJCXRoaXMudmFsdWVNZXRob2QgPSB0aGlzLmVsZW1lbnRbIGlzVGV4dGFyZWEgfHwgaXNJbnB1dCA\/ICJ2YWwiIDogInRleHQiIF07DQoJCXRoaXMuaXNOZXdNZW51ID0gdHJ1ZTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggInVpLWF1dG9jb21wbGV0ZS1pbnB1dCIgKTsNCgkJdGhpcy5lbGVtZW50LmF0dHIoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOw0KDQoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQsIHsNCgkJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlpZiAoIHRoaXMuZWxlbWVudC5wcm9wKCAicmVhZE9ubHkiICkgKSB7DQoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOw0KCQkJCQlzdXBwcmVzc0lucHV0ID0gdHJ1ZTsNCgkJCQkJc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCA9IHRydWU7DQoJCQkJCXJldHVybjsNCgkJCQl9DQoNCgkJCQlzdXBwcmVzc0tleVByZXNzID0gZmFsc2U7DQoJCQkJc3VwcHJlc3NJbnB1dCA9IGZhbHNlOw0KCQkJCXN1cHByZXNzS2V5UHJlc3NSZXBlYXQgPSBmYWxzZTsNCgkJCQl2YXIga2V5Q29kZSA9ICQudWkua2V5Q29kZTsNCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgew0KCQkJCWNhc2Uga2V5Q29kZS5QQUdFX1VQOg0KCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsNCgkJCQkJdGhpcy5fbW92ZSggInByZXZpb3VzUGFnZSIsIGV2ZW50ICk7DQoJCQkJCWJyZWFrOw0KCQkJCWNhc2Uga2V5Q29kZS5QQUdFX0RPV046DQoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOw0KCQkJCQl0aGlzLl9tb3ZlKCAibmV4dFBhZ2UiLCBldmVudCApOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIGtleUNvZGUuVVA6DQoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOw0KCQkJCQl0aGlzLl9rZXlFdmVudCggInByZXZpb3VzIiwgZXZlbnQgKTsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSBrZXlDb2RlLkRPV046DQoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOw0KCQkJCQl0aGlzLl9rZXlFdmVudCggIm5leHQiLCBldmVudCApOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIGtleUNvZGUuRU5URVI6DQoNCgkJCQkJLy8gd2hlbiBtZW51IGlzIG9wZW4gYW5kIGhhcyBmb2N1cw0KCQkJCQlpZiAoIHRoaXMubWVudS5hY3RpdmUgKSB7DQoNCgkJCQkJCS8vICM2MDU1IC0gT3BlcmEgc3RpbGwgYWxsb3dzIHRoZSBrZXlwcmVzcyB0byBvY2N1cg0KCQkJCQkJLy8gd2hpY2ggY2F1c2VzIGZvcm1zIHRvIHN1Ym1pdA0KCQkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IHRydWU7DQoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJCQkJdGhpcy5tZW51LnNlbGVjdCggZXZlbnQgKTsNCgkJCQkJfQ0KCQkJCQlicmVhazsNCgkJCQljYXNlIGtleUNvZGUuVEFCOg0KCQkJCQlpZiAoIHRoaXMubWVudS5hY3RpdmUgKSB7DQoJCQkJCQl0aGlzLm1lbnUuc2VsZWN0KCBldmVudCApOw0KCQkJCQl9DQoJCQkJCWJyZWFrOw0KCQkJCWNhc2Uga2V5Q29kZS5FU0NBUEU6DQoJCQkJCWlmICggdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsNCgkJCQkJCWlmICggIXRoaXMuaXNNdWx0aUxpbmUgKSB7DQoJCQkJCQkJdGhpcy5fdmFsdWUoIHRoaXMudGVybSApOw0KCQkJCQkJfQ0KCQkJCQkJdGhpcy5jbG9zZSggZXZlbnQgKTsNCg0KCQkJCQkJLy8gRGlmZmVyZW50IGJyb3dzZXJzIGhhdmUgZGlmZmVyZW50IGRlZmF1bHQgYmVoYXZpb3IgZm9yIGVzY2FwZQ0KCQkJCQkJLy8gU2luZ2xlIHByZXNzIGNhbiBtZWFuIHVuZG8gb3IgY2xlYXINCgkJCQkJCS8vIERvdWJsZSBwcmVzcyBpbiBJRSBtZWFucyBjbGVhciB0aGUgd2hvbGUgZm9ybQ0KCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCQkJfQ0KCQkJCQlicmVhazsNCgkJCQlkZWZhdWx0Og0KCQkJCQlzdXBwcmVzc0tleVByZXNzUmVwZWF0ID0gdHJ1ZTsNCg0KCQkJCQkvLyBzZWFyY2ggdGltZW91dCBzaG91bGQgYmUgdHJpZ2dlcmVkIGJlZm9yZSB0aGUgaW5wdXQgdmFsdWUgaXMgY2hhbmdlZA0KCQkJCQl0aGlzLl9zZWFyY2hUaW1lb3V0KCBldmVudCApOw0KCQkJCQlicmVhazsNCgkJCQl9DQoJCQl9LA0KCQkJa2V5cHJlc3M6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlpZiAoIHN1cHByZXNzS2V5UHJlc3MgKSB7DQoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSBmYWxzZTsNCgkJCQkJaWYgKCAhdGhpcy5pc011bHRpTGluZSB8fCB0aGlzLm1lbnUuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgew0KCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCQkJfQ0KCQkJCQlyZXR1cm47DQoJCQkJfQ0KCQkJCWlmICggc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCApIHsNCgkJCQkJcmV0dXJuOw0KCQkJCX0NCg0KCQkJCS8vIFJlcGxpY2F0ZSBzb21lIGtleSBoYW5kbGVycyB0byBhbGxvdyB0aGVtIHRvIHJlcGVhdCBpbiBGaXJlZm94IGFuZCBPcGVyYQ0KCQkJCXZhciBrZXlDb2RlID0gJC51aS5rZXlDb2RlOw0KCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7DQoJCQkJY2FzZSBrZXlDb2RlLlBBR0VfVVA6DQoJCQkJCXRoaXMuX21vdmUoICJwcmV2aW91c1BhZ2UiLCBldmVudCApOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIGtleUNvZGUuUEFHRV9ET1dOOg0KCQkJCQl0aGlzLl9tb3ZlKCAibmV4dFBhZ2UiLCBldmVudCApOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIGtleUNvZGUuVVA6DQoJCQkJCXRoaXMuX2tleUV2ZW50KCAicHJldmlvdXMiLCBldmVudCApOw0KCQkJCQlicmVhazsNCgkJCQljYXNlIGtleUNvZGUuRE9XTjoNCgkJCQkJdGhpcy5fa2V5RXZlbnQoICJuZXh0IiwgZXZlbnQgKTsNCgkJCQkJYnJlYWs7DQoJCQkJfQ0KCQkJfSwNCgkJCWlucHV0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJaWYgKCBzdXBwcmVzc0lucHV0ICkgew0KCQkJCQlzdXBwcmVzc0lucHV0ID0gZmFsc2U7DQoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQkJCXJldHVybjsNCgkJCQl9DQoJCQkJdGhpcy5fc2VhcmNoVGltZW91dCggZXZlbnQgKTsNCgkJCX0sDQoJCQlmb2N1czogZnVuY3Rpb24oKSB7DQoJCQkJdGhpcy5zZWxlY3RlZEl0ZW0gPSBudWxsOw0KCQkJCXRoaXMucHJldmlvdXMgPSB0aGlzLl92YWx1ZSgpOw0KCQkJfSwNCgkJCWJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlpZiAoIHRoaXMuY2FuY2VsQmx1ciApIHsNCgkJCQkJZGVsZXRlIHRoaXMuY2FuY2VsQmx1cjsNCgkJCQkJcmV0dXJuOw0KCQkJCX0NCg0KCQkJCWNsZWFyVGltZW91dCggdGhpcy5zZWFyY2hpbmcgKTsNCgkJCQl0aGlzLmNsb3NlKCBldmVudCApOw0KCQkJCXRoaXMuX2NoYW5nZSggZXZlbnQgKTsNCgkJCX0NCgkJfSApOw0KDQoJCXRoaXMuX2luaXRTb3VyY2UoKTsNCgkJdGhpcy5tZW51ID0gJCggIjx1bD4iICkNCgkJCS5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApDQoJCQkubWVudSggew0KDQoJCQkJLy8gZGlzYWJsZSBBUklBIHN1cHBvcnQsIHRoZSBsaXZlIHJlZ2lvbiB0YWtlcyBjYXJlIG9mIHRoYXQNCgkJCQlyb2xlOiBudWxsDQoJCQl9ICkNCgkJCS5oaWRlKCkNCgkJCS5tZW51KCAiaW5zdGFuY2UiICk7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubWVudS5lbGVtZW50LCAidWktYXV0b2NvbXBsZXRlIiwgInVpLWZyb250IiApOw0KCQl0aGlzLl9vbiggdGhpcy5tZW51LmVsZW1lbnQsIHsNCgkJCW1vdXNlZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgew0KDQoJCQkJLy8gcHJldmVudCBtb3ZpbmcgZm9jdXMgb3V0IG9mIHRoZSB0ZXh0IGZpZWxkDQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KCQkJCS8vIElFIGRvZXNuJ3QgcHJldmVudCBtb3ZpbmcgZm9jdXMgZXZlbiB3aXRoIGV2ZW50LnByZXZlbnREZWZhdWx0KCkNCgkJCQkvLyBzbyB3ZSBzZXQgYSBmbGFnIHRvIGtub3cgd2hlbiB3ZSBzaG91bGQgaWdub3JlIHRoZSBibHVyIGV2ZW50DQoJCQkJdGhpcy5jYW5jZWxCbHVyID0gdHJ1ZTsNCgkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoJCQkJCWRlbGV0ZSB0aGlzLmNhbmNlbEJsdXI7DQoNCgkJCQkJLy8gU3VwcG9ydDogSUUgOCBvbmx5DQoJCQkJCS8vIFJpZ2h0IGNsaWNraW5nIGEgbWVudSBpdGVtIG9yIHNlbGVjdGluZyB0ZXh0IGZyb20gdGhlIG1lbnUgaXRlbXMgd2lsbA0KCQkJCQkvLyByZXN1bHQgaW4gZm9jdXMgbW92aW5nIG91dCBvZiB0aGUgaW5wdXQuIEhvd2V2ZXIsIHdlJ3ZlIGFscmVhZHkgcmVjZWl2ZWQNCgkJCQkJLy8gYW5kIGlnbm9yZWQgdGhlIGJsdXIgZXZlbnQgYmVjYXVzZSBvZiB0aGUgY2FuY2VsQmx1ciBmbGFnIHNldCBhYm92ZS4gU28NCgkJCQkJLy8gd2UgcmVzdG9yZSBmb2N1cyB0byBlbnN1cmUgdGhhdCB0aGUgbWVudSBjbG9zZXMgcHJvcGVybHkgYmFzZWQgb24gdGhlIHVzZXIncw0KCQkJCQkvLyBuZXh0IGFjdGlvbnMuDQoJCQkJCWlmICggdGhpcy5lbGVtZW50WyAwIF0gIT09ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICkgew0KCQkJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJmb2N1cyIgKTsNCgkJCQkJfQ0KCQkJCX0gKTsNCgkJCX0sDQoJCQltZW51Zm9jdXM6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7DQoJCQkJdmFyIGxhYmVsLCBpdGVtOw0KDQoJCQkJLy8gc3VwcG9ydDogRmlyZWZveA0KCQkJCS8vIFByZXZlbnQgYWNjaWRlbnRhbCBhY3RpdmF0aW9uIG9mIG1lbnUgaXRlbXMgaW4gRmlyZWZveCAoIzcwMjQgIzkxMTgpDQoJCQkJaWYgKCB0aGlzLmlzTmV3TWVudSApIHsNCgkJCQkJdGhpcy5pc05ld01lbnUgPSBmYWxzZTsNCgkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50ICYmIC9ebW91c2UvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApICkgew0KCQkJCQkJdGhpcy5tZW51LmJsdXIoKTsNCg0KCQkJCQkJdGhpcy5kb2N1bWVudC5vbmUoICJtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsNCgkJCQkJCQkkKCBldmVudC50YXJnZXQgKS50cmlnZ2VyKCBldmVudC5vcmlnaW5hbEV2ZW50ICk7DQoJCQkJCQl9ICk7DQoNCgkJCQkJCXJldHVybjsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCWl0ZW0gPSB1aS5pdGVtLmRhdGEoICJ1aS1hdXRvY29tcGxldGUtaXRlbSIgKTsNCgkJCQlpZiAoIGZhbHNlICE9PSB0aGlzLl90cmlnZ2VyKCAiZm9jdXMiLCBldmVudCwgeyBpdGVtOiBpdGVtIH0gKSApIHsNCg0KCQkJCQkvLyB1c2UgdmFsdWUgdG8gbWF0Y2ggd2hhdCB3aWxsIGVuZCB1cCBpbiB0aGUgaW5wdXQsIGlmIGl0IHdhcyBhIGtleSBldmVudA0KCQkJCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL15rZXkvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApICkgew0KCQkJCQkJdGhpcy5fdmFsdWUoIGl0ZW0udmFsdWUgKTsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCS8vIEFubm91bmNlIHRoZSB2YWx1ZSBpbiB0aGUgbGl2ZVJlZ2lvbg0KCQkJCWxhYmVsID0gdWkuaXRlbS5hdHRyKCAiYXJpYS1sYWJlbCIgKSB8fCBpdGVtLnZhbHVlOw0KCQkJCWlmICggbGFiZWwgJiYgJC50cmltKCBsYWJlbCApLmxlbmd0aCApIHsNCgkJCQkJdGhpcy5saXZlUmVnaW9uLmNoaWxkcmVuKCkuaGlkZSgpOw0KCQkJCQkkKCAiPGRpdj4iICkudGV4dCggbGFiZWwgKS5hcHBlbmRUbyggdGhpcy5saXZlUmVnaW9uICk7DQoJCQkJfQ0KCQkJfSwNCgkJCW1lbnVzZWxlY3Q6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7DQoJCQkJdmFyIGl0ZW0gPSB1aS5pdGVtLmRhdGEoICJ1aS1hdXRvY29tcGxldGUtaXRlbSIgKSwNCgkJCQkJcHJldmlvdXMgPSB0aGlzLnByZXZpb3VzOw0KDQoJCQkJLy8gT25seSB0cmlnZ2VyIHdoZW4gZm9jdXMgd2FzIGxvc3QgKGNsaWNrIG9uIG1lbnUpDQoJCQkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXSAhPT0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgKSB7DQoJCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiZm9jdXMiICk7DQoJCQkJCXRoaXMucHJldmlvdXMgPSBwcmV2aW91czsNCg0KCQkJCQkvLyAjNjEwOSAtIElFIHRyaWdnZXJzIHR3byBmb2N1cyBldmVudHMgYW5kIHRoZSBzZWNvbmQNCgkJCQkJLy8gaXMgYXN5bmNocm9ub3VzLCBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSBwcmV2aW91cw0KCQkJCQkvLyB0ZXJtIHN5bmNocm9ub3VzbHkgYW5kIGFzeW5jaHJvbm91c2x5IDotKA0KCQkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoJCQkJCQl0aGlzLnByZXZpb3VzID0gcHJldmlvdXM7DQoJCQkJCQl0aGlzLnNlbGVjdGVkSXRlbSA9IGl0ZW07DQoJCQkJCX0gKTsNCgkJCQl9DQoNCgkJCQlpZiAoIGZhbHNlICE9PSB0aGlzLl90cmlnZ2VyKCAic2VsZWN0IiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICkgKSB7DQoJCQkJCXRoaXMuX3ZhbHVlKCBpdGVtLnZhbHVlICk7DQoJCQkJfQ0KDQoJCQkJLy8gcmVzZXQgdGhlIHRlcm0gYWZ0ZXIgdGhlIHNlbGVjdCBldmVudA0KCQkJCS8vIHRoaXMgYWxsb3dzIGN1c3RvbSBzZWxlY3QgaGFuZGxpbmcgdG8gd29yayBwcm9wZXJseQ0KCQkJCXRoaXMudGVybSA9IHRoaXMuX3ZhbHVlKCk7DQoNCgkJCQl0aGlzLmNsb3NlKCBldmVudCApOw0KCQkJCXRoaXMuc2VsZWN0ZWRJdGVtID0gaXRlbTsNCgkJCX0NCgkJfSApOw0KDQoJCXRoaXMubGl2ZVJlZ2lvbiA9ICQoICI8ZGl2PiIsIHsNCgkJCXJvbGU6ICJzdGF0dXMiLA0KCQkJImFyaWEtbGl2ZSI6ICJhc3NlcnRpdmUiLA0KCQkJImFyaWEtcmVsZXZhbnQiOiAiYWRkaXRpb25zIg0KCQl9ICkNCgkJCS5hcHBlbmRUbyggdGhpcy5kb2N1bWVudFsgMCBdLmJvZHkgKTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5saXZlUmVnaW9uLCBudWxsLCAidWktaGVscGVyLWhpZGRlbi1hY2Nlc3NpYmxlIiApOw0KDQoJCS8vIFR1cm5pbmcgb2ZmIGF1dG9jb21wbGV0ZSBwcmV2ZW50cyB0aGUgYnJvd3NlciBmcm9tIHJlbWVtYmVyaW5nIHRoZQ0KCQkvLyB2YWx1ZSB3aGVuIG5hdmlnYXRpbmcgdGhyb3VnaCBoaXN0b3J5LCBzbyB3ZSByZS1lbmFibGUgYXV0b2NvbXBsZXRlDQoJCS8vIGlmIHRoZSBwYWdlIGlzIHVubG9hZGVkIGJlZm9yZSB0aGUgd2lkZ2V0IGlzIGRlc3Ryb3llZC4gIzc3OTANCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7DQoJCQliZWZvcmV1bmxvYWQ6IGZ1bmN0aW9uKCkgew0KCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAiYXV0b2NvbXBsZXRlIiApOw0KCQkJfQ0KCQl9ICk7DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJY2xlYXJUaW1lb3V0KCB0aGlzLnNlYXJjaGluZyApOw0KCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggImF1dG9jb21wbGV0ZSIgKTsNCgkJdGhpcy5tZW51LmVsZW1lbnQucmVtb3ZlKCk7DQoJCXRoaXMubGl2ZVJlZ2lvbi5yZW1vdmUoKTsNCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7DQoJCWlmICgga2V5ID09PSAic291cmNlIiApIHsNCgkJCXRoaXMuX2luaXRTb3VyY2UoKTsNCgkJfQ0KCQlpZiAoIGtleSA9PT0gImFwcGVuZFRvIiApIHsNCgkJCXRoaXMubWVudS5lbGVtZW50LmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7DQoJCX0NCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgJiYgdmFsdWUgJiYgdGhpcy54aHIgKSB7DQoJCQl0aGlzLnhoci5hYm9ydCgpOw0KCQl9DQoJfSwNCg0KCV9pc0V2ZW50VGFyZ2V0SW5XaWRnZXQ6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIG1lbnVFbGVtZW50ID0gdGhpcy5tZW51LmVsZW1lbnRbIDAgXTsNCg0KCQlyZXR1cm4gZXZlbnQudGFyZ2V0ID09PSB0aGlzLmVsZW1lbnRbIDAgXSB8fA0KCQkJZXZlbnQudGFyZ2V0ID09PSBtZW51RWxlbWVudCB8fA0KCQkJJC5jb250YWlucyggbWVudUVsZW1lbnQsIGV2ZW50LnRhcmdldCApOw0KCX0sDQoNCglfY2xvc2VPbkNsaWNrT3V0c2lkZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoICF0aGlzLl9pc0V2ZW50VGFyZ2V0SW5XaWRnZXQoIGV2ZW50ICkgKSB7DQoJCQl0aGlzLmNsb3NlKCk7DQoJCX0NCgl9LA0KDQoJX2FwcGVuZFRvOiBmdW5jdGlvbigpIHsNCgkJdmFyIGVsZW1lbnQgPSB0aGlzLm9wdGlvbnMuYXBwZW5kVG87DQoNCgkJaWYgKCBlbGVtZW50ICkgew0KCQkJZWxlbWVudCA9IGVsZW1lbnQuanF1ZXJ5IHx8IGVsZW1lbnQubm9kZVR5cGUgPw0KCQkJCSQoIGVsZW1lbnQgKSA6DQoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBlbGVtZW50ICkuZXEoIDAgKTsNCgkJfQ0KDQoJCWlmICggIWVsZW1lbnQgfHwgIWVsZW1lbnRbIDAgXSApIHsNCgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1mcm9udCwgZGlhbG9nIiApOw0KCQl9DQoNCgkJaWYgKCAhZWxlbWVudC5sZW5ndGggKSB7DQoJCQllbGVtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHk7DQoJCX0NCg0KCQlyZXR1cm4gZWxlbWVudDsNCgl9LA0KDQoJX2luaXRTb3VyY2U6IGZ1bmN0aW9uKCkgew0KCQl2YXIgYXJyYXksIHVybCwNCgkJCXRoYXQgPSB0aGlzOw0KCQlpZiAoICQuaXNBcnJheSggdGhpcy5vcHRpb25zLnNvdXJjZSApICkgew0KCQkJYXJyYXkgPSB0aGlzLm9wdGlvbnMuc291cmNlOw0KCQkJdGhpcy5zb3VyY2UgPSBmdW5jdGlvbiggcmVxdWVzdCwgcmVzcG9uc2UgKSB7DQoJCQkJcmVzcG9uc2UoICQudWkuYXV0b2NvbXBsZXRlLmZpbHRlciggYXJyYXksIHJlcXVlc3QudGVybSApICk7DQoJCQl9Ow0KCQl9IGVsc2UgaWYgKCB0eXBlb2YgdGhpcy5vcHRpb25zLnNvdXJjZSA9PT0gInN0cmluZyIgKSB7DQoJCQl1cmwgPSB0aGlzLm9wdGlvbnMuc291cmNlOw0KCQkJdGhpcy5zb3VyY2UgPSBmdW5jdGlvbiggcmVxdWVzdCwgcmVzcG9uc2UgKSB7DQoJCQkJaWYgKCB0aGF0LnhociApIHsNCgkJCQkJdGhhdC54aHIuYWJvcnQoKTsNCgkJCQl9DQoJCQkJdGhhdC54aHIgPSAkLmFqYXgoIHsNCgkJCQkJdXJsOiB1cmwsDQoJCQkJCWRhdGE6IHJlcXVlc3QsDQoJCQkJCWRhdGFUeXBlOiAianNvbiIsDQoJCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBkYXRhICkgew0KCQkJCQkJcmVzcG9uc2UoIGRhdGEgKTsNCgkJCQkJfSwNCgkJCQkJZXJyb3I6IGZ1bmN0aW9uKCkgew0KCQkJCQkJcmVzcG9uc2UoIFtdICk7DQoJCQkJCX0NCgkJCQl9ICk7DQoJCQl9Ow0KCQl9IGVsc2Ugew0KCQkJdGhpcy5zb3VyY2UgPSB0aGlzLm9wdGlvbnMuc291cmNlOw0KCQl9DQoJfSwNCg0KCV9zZWFyY2hUaW1lb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCWNsZWFyVGltZW91dCggdGhpcy5zZWFyY2hpbmcgKTsNCgkJdGhpcy5zZWFyY2hpbmcgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoNCgkJCS8vIFNlYXJjaCBpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQsIG9yIGlmIHRoZSB1c2VyIHJldHlwZXMgdGhlIHNhbWUgdmFsdWUgKHNlZSAjNzQzNCkNCgkJCXZhciBlcXVhbFZhbHVlcyA9IHRoaXMudGVybSA9PT0gdGhpcy5fdmFsdWUoKSwNCgkJCQltZW51VmlzaWJsZSA9IHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICksDQoJCQkJbW9kaWZpZXJLZXkgPSBldmVudC5hbHRLZXkgfHwgZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LnNoaWZ0S2V5Ow0KDQoJCQlpZiAoICFlcXVhbFZhbHVlcyB8fCAoIGVxdWFsVmFsdWVzICYmICFtZW51VmlzaWJsZSAmJiAhbW9kaWZpZXJLZXkgKSApIHsNCgkJCQl0aGlzLnNlbGVjdGVkSXRlbSA9IG51bGw7DQoJCQkJdGhpcy5zZWFyY2goIG51bGwsIGV2ZW50ICk7DQoJCQl9DQoJCX0sIHRoaXMub3B0aW9ucy5kZWxheSApOw0KCX0sDQoNCglzZWFyY2g6IGZ1bmN0aW9uKCB2YWx1ZSwgZXZlbnQgKSB7DQoJCXZhbHVlID0gdmFsdWUgIT0gbnVsbCA\/IHZhbHVlIDogdGhpcy5fdmFsdWUoKTsNCg0KCQkvLyBBbHdheXMgc2F2ZSB0aGUgYWN0dWFsIHZhbHVlLCBub3QgdGhlIG9uZSBwYXNzZWQgYXMgYW4gYXJndW1lbnQNCgkJdGhpcy50ZXJtID0gdGhpcy5fdmFsdWUoKTsNCg0KCQlpZiAoIHZhbHVlLmxlbmd0aCA8IHRoaXMub3B0aW9ucy5taW5MZW5ndGggKSB7DQoJCQlyZXR1cm4gdGhpcy5jbG9zZSggZXZlbnQgKTsNCgkJfQ0KDQoJCWlmICggdGhpcy5fdHJpZ2dlciggInNlYXJjaCIsIGV2ZW50ICkgPT09IGZhbHNlICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXMuX3NlYXJjaCggdmFsdWUgKTsNCgl9LA0KDQoJX3NlYXJjaDogZnVuY3Rpb24oIHZhbHVlICkgew0KCQl0aGlzLnBlbmRpbmcrKzsNCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1hdXRvY29tcGxldGUtbG9hZGluZyIgKTsNCgkJdGhpcy5jYW5jZWxTZWFyY2ggPSBmYWxzZTsNCg0KCQl0aGlzLnNvdXJjZSggeyB0ZXJtOiB2YWx1ZSB9LCB0aGlzLl9yZXNwb25zZSgpICk7DQoJfSwNCg0KCV9yZXNwb25zZTogZnVuY3Rpb24oKSB7DQoJCXZhciBpbmRleCA9ICsrdGhpcy5yZXF1ZXN0SW5kZXg7DQoNCgkJcmV0dXJuICQucHJveHkoIGZ1bmN0aW9uKCBjb250ZW50ICkgew0KCQkJaWYgKCBpbmRleCA9PT0gdGhpcy5yZXF1ZXN0SW5kZXggKSB7DQoJCQkJdGhpcy5fX3Jlc3BvbnNlKCBjb250ZW50ICk7DQoJCQl9DQoNCgkJCXRoaXMucGVuZGluZy0tOw0KCQkJaWYgKCAhdGhpcy5wZW5kaW5nICkgew0KCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAidWktYXV0b2NvbXBsZXRlLWxvYWRpbmciICk7DQoJCQl9DQoJCX0sIHRoaXMgKTsNCgl9LA0KDQoJX19yZXNwb25zZTogZnVuY3Rpb24oIGNvbnRlbnQgKSB7DQoJCWlmICggY29udGVudCApIHsNCgkJCWNvbnRlbnQgPSB0aGlzLl9ub3JtYWxpemUoIGNvbnRlbnQgKTsNCgkJfQ0KCQl0aGlzLl90cmlnZ2VyKCAicmVzcG9uc2UiLCBudWxsLCB7IGNvbnRlbnQ6IGNvbnRlbnQgfSApOw0KCQlpZiAoICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgJiYgY29udGVudCAmJiBjb250ZW50Lmxlbmd0aCAmJiAhdGhpcy5jYW5jZWxTZWFyY2ggKSB7DQoJCQl0aGlzLl9zdWdnZXN0KCBjb250ZW50ICk7DQoJCQl0aGlzLl90cmlnZ2VyKCAib3BlbiIgKTsNCgkJfSBlbHNlIHsNCg0KCQkJLy8gdXNlIC5fY2xvc2UoKSBpbnN0ZWFkIG9mIC5jbG9zZSgpIHNvIHdlIGRvbid0IGNhbmNlbCBmdXR1cmUgc2VhcmNoZXMNCgkJCXRoaXMuX2Nsb3NlKCk7DQoJCX0NCgl9LA0KDQoJY2xvc2U6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdGhpcy5jYW5jZWxTZWFyY2ggPSB0cnVlOw0KCQl0aGlzLl9jbG9zZSggZXZlbnQgKTsNCgl9LA0KDQoJX2Nsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJLy8gUmVtb3ZlIHRoZSBoYW5kbGVyIHRoYXQgY2xvc2VzIHRoZSBtZW51IG9uIG91dHNpZGUgY2xpY2tzDQoJCXRoaXMuX29mZiggdGhpcy5kb2N1bWVudCwgIm1vdXNlZG93biIgKTsNCg0KCQlpZiAoIHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7DQoJCQl0aGlzLm1lbnUuZWxlbWVudC5oaWRlKCk7DQoJCQl0aGlzLm1lbnUuYmx1cigpOw0KCQkJdGhpcy5pc05ld01lbnUgPSB0cnVlOw0KCQkJdGhpcy5fdHJpZ2dlciggImNsb3NlIiwgZXZlbnQgKTsNCgkJfQ0KCX0sDQoNCglfY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCWlmICggdGhpcy5wcmV2aW91cyAhPT0gdGhpcy5fdmFsdWUoKSApIHsNCgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiLCBldmVudCwgeyBpdGVtOiB0aGlzLnNlbGVjdGVkSXRlbSB9ICk7DQoJCX0NCgl9LA0KDQoJX25vcm1hbGl6ZTogZnVuY3Rpb24oIGl0ZW1zICkgew0KDQoJCS8vIGFzc3VtZSBhbGwgaXRlbXMgaGF2ZSB0aGUgcmlnaHQgZm9ybWF0IHdoZW4gdGhlIGZpcnN0IGl0ZW0gaXMgY29tcGxldGUNCgkJaWYgKCBpdGVtcy5sZW5ndGggJiYgaXRlbXNbIDAgXS5sYWJlbCAmJiBpdGVtc1sgMCBdLnZhbHVlICkgew0KCQkJcmV0dXJuIGl0ZW1zOw0KCQl9DQoJCXJldHVybiAkLm1hcCggaXRlbXMsIGZ1bmN0aW9uKCBpdGVtICkgew0KCQkJaWYgKCB0eXBlb2YgaXRlbSA9PT0gInN0cmluZyIgKSB7DQoJCQkJcmV0dXJuIHsNCgkJCQkJbGFiZWw6IGl0ZW0sDQoJCQkJCXZhbHVlOiBpdGVtDQoJCQkJfTsNCgkJCX0NCgkJCXJldHVybiAkLmV4dGVuZCgge30sIGl0ZW0sIHsNCgkJCQlsYWJlbDogaXRlbS5sYWJlbCB8fCBpdGVtLnZhbHVlLA0KCQkJCXZhbHVlOiBpdGVtLnZhbHVlIHx8IGl0ZW0ubGFiZWwNCgkJCX0gKTsNCgkJfSApOw0KCX0sDQoNCglfc3VnZ2VzdDogZnVuY3Rpb24oIGl0ZW1zICkgew0KCQl2YXIgdWwgPSB0aGlzLm1lbnUuZWxlbWVudC5lbXB0eSgpOw0KCQl0aGlzLl9yZW5kZXJNZW51KCB1bCwgaXRlbXMgKTsNCgkJdGhpcy5pc05ld01lbnUgPSB0cnVlOw0KCQl0aGlzLm1lbnUucmVmcmVzaCgpOw0KDQoJCS8vIFNpemUgYW5kIHBvc2l0aW9uIG1lbnUNCgkJdWwuc2hvdygpOw0KCQl0aGlzLl9yZXNpemVNZW51KCk7DQoJCXVsLnBvc2l0aW9uKCAkLmV4dGVuZCggew0KCQkJb2Y6IHRoaXMuZWxlbWVudA0KCQl9LCB0aGlzLm9wdGlvbnMucG9zaXRpb24gKSApOw0KDQoJCWlmICggdGhpcy5vcHRpb25zLmF1dG9Gb2N1cyApIHsNCgkJCXRoaXMubWVudS5uZXh0KCk7DQoJCX0NCg0KCQkvLyBMaXN0ZW4gZm9yIGludGVyYWN0aW9ucyBvdXRzaWRlIG9mIHRoZSB3aWRnZXQgKCM2NjQyKQ0KCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgew0KCQkJbW91c2Vkb3duOiAiX2Nsb3NlT25DbGlja091dHNpZGUiDQoJCX0gKTsNCgl9LA0KDQoJX3Jlc2l6ZU1lbnU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdWwgPSB0aGlzLm1lbnUuZWxlbWVudDsNCgkJdWwub3V0ZXJXaWR0aCggTWF0aC5tYXgoDQoNCgkJCS8vIEZpcmVmb3ggd3JhcHMgbG9uZyB0ZXh0IChwb3NzaWJseSBhIHJvdW5kaW5nIGJ1ZykNCgkJCS8vIHNvIHdlIGFkZCAxcHggdG8gYXZvaWQgdGhlIHdyYXBwaW5nICgjNzUxMykNCgkJCXVsLndpZHRoKCAiIiApLm91dGVyV2lkdGgoKSArIDEsDQoJCQl0aGlzLmVsZW1lbnQub3V0ZXJXaWR0aCgpDQoJCSkgKTsNCgl9LA0KDQoJX3JlbmRlck1lbnU6IGZ1bmN0aW9uKCB1bCwgaXRlbXMgKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCgkJJC5lYWNoKCBpdGVtcywgZnVuY3Rpb24oIGluZGV4LCBpdGVtICkgew0KCQkJdGhhdC5fcmVuZGVySXRlbURhdGEoIHVsLCBpdGVtICk7DQoJCX0gKTsNCgl9LA0KDQoJX3JlbmRlckl0ZW1EYXRhOiBmdW5jdGlvbiggdWwsIGl0ZW0gKSB7DQoJCXJldHVybiB0aGlzLl9yZW5kZXJJdGVtKCB1bCwgaXRlbSApLmRhdGEoICJ1aS1hdXRvY29tcGxldGUtaXRlbSIsIGl0ZW0gKTsNCgl9LA0KDQoJX3JlbmRlckl0ZW06IGZ1bmN0aW9uKCB1bCwgaXRlbSApIHsNCgkJcmV0dXJuICQoICI8bGk+IiApDQoJCQkuYXBwZW5kKCAkKCAiPGRpdj4iICkudGV4dCggaXRlbS5sYWJlbCApICkNCgkJCS5hcHBlbmRUbyggdWwgKTsNCgl9LA0KDQoJX21vdmU6IGZ1bmN0aW9uKCBkaXJlY3Rpb24sIGV2ZW50ICkgew0KCQlpZiAoICF0aGlzLm1lbnUuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgew0KCQkJdGhpcy5zZWFyY2goIG51bGwsIGV2ZW50ICk7DQoJCQlyZXR1cm47DQoJCX0NCgkJaWYgKCB0aGlzLm1lbnUuaXNGaXJzdEl0ZW0oKSAmJiAvXnByZXZpb3VzLy50ZXN0KCBkaXJlY3Rpb24gKSB8fA0KCQkJCXRoaXMubWVudS5pc0xhc3RJdGVtKCkgJiYgL15uZXh0Ly50ZXN0KCBkaXJlY3Rpb24gKSApIHsNCg0KCQkJaWYgKCAhdGhpcy5pc011bHRpTGluZSApIHsNCgkJCQl0aGlzLl92YWx1ZSggdGhpcy50ZXJtICk7DQoJCQl9DQoNCgkJCXRoaXMubWVudS5ibHVyKCk7DQoJCQlyZXR1cm47DQoJCX0NCgkJdGhpcy5tZW51WyBkaXJlY3Rpb24gXSggZXZlbnQgKTsNCgl9LA0KDQoJd2lkZ2V0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMubWVudS5lbGVtZW50Ow0KCX0sDQoNCglfdmFsdWU6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy52YWx1ZU1ldGhvZC5hcHBseSggdGhpcy5lbGVtZW50LCBhcmd1bWVudHMgKTsNCgl9LA0KDQoJX2tleUV2ZW50OiBmdW5jdGlvbigga2V5RXZlbnQsIGV2ZW50ICkgew0KCQlpZiAoICF0aGlzLmlzTXVsdGlMaW5lIHx8IHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7DQoJCQl0aGlzLl9tb3ZlKCBrZXlFdmVudCwgZXZlbnQgKTsNCg0KCQkJLy8gUHJldmVudHMgbW92aW5nIGN1cnNvciB0byBiZWdpbm5pbmcvZW5kIG9mIHRoZSB0ZXh0IGZpZWxkIGluIHNvbWUgYnJvd3NlcnMNCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCX0NCgl9LA0KDQoJLy8gU3VwcG9ydDogQ2hyb21lIDw9NTANCgkvLyBXZSBzaG91bGQgYmUgYWJsZSB0byBqdXN0IHVzZSB0aGlzLmVsZW1lbnQucHJvcCggImlzQ29udGVudEVkaXRhYmxlIiApDQoJLy8gYnV0IGhpZGRlbiBlbGVtZW50cyBhbHdheXMgcmVwb3J0IGZhbHNlIGluIENocm9tZS4NCgkvLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw\/aWQ9MzEzMDgyDQoJX2lzQ29udGVudEVkaXRhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsNCgkJaWYgKCAhZWxlbWVudC5sZW5ndGggKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQl2YXIgZWRpdGFibGUgPSBlbGVtZW50LnByb3AoICJjb250ZW50RWRpdGFibGUiICk7DQoNCgkJaWYgKCBlZGl0YWJsZSA9PT0gImluaGVyaXQiICkgew0KCQkgIHJldHVybiB0aGlzLl9pc0NvbnRlbnRFZGl0YWJsZSggZWxlbWVudC5wYXJlbnQoKSApOw0KCQl9DQoNCgkJcmV0dXJuIGVkaXRhYmxlID09PSAidHJ1ZSI7DQoJfQ0KfSApOw0KDQokLmV4dGVuZCggJC51aS5hdXRvY29tcGxldGUsIHsNCgllc2NhcGVSZWdleDogZnVuY3Rpb24oIHZhbHVlICkgew0KCQlyZXR1cm4gdmFsdWUucmVwbGFjZSggL1tcLVxbXF17fSgpKis\/LixcXFxeJHwjXHNdL2csICJcXCQmIiApOw0KCX0sDQoJZmlsdGVyOiBmdW5jdGlvbiggYXJyYXksIHRlcm0gKSB7DQoJCXZhciBtYXRjaGVyID0gbmV3IFJlZ0V4cCggJC51aS5hdXRvY29tcGxldGUuZXNjYXBlUmVnZXgoIHRlcm0gKSwgImkiICk7DQoJCXJldHVybiAkLmdyZXAoIGFycmF5LCBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCQlyZXR1cm4gbWF0Y2hlci50ZXN0KCB2YWx1ZS5sYWJlbCB8fCB2YWx1ZS52YWx1ZSB8fCB2YWx1ZSApOw0KCQl9ICk7DQoJfQ0KfSApOw0KDQovLyBMaXZlIHJlZ2lvbiBleHRlbnNpb24sIGFkZGluZyBhIGBtZXNzYWdlc2Agb3B0aW9uDQovLyBOT1RFOiBUaGlzIGlzIGFuIGV4cGVyaW1lbnRhbCBBUEkuIFdlIGFyZSBzdGlsbCBpbnZlc3RpZ2F0aW5nDQovLyBhIGZ1bGwgc29sdXRpb24gZm9yIHN0cmluZyBtYW5pcHVsYXRpb24gYW5kIGludGVybmF0aW9uYWxpemF0aW9uLg0KJC53aWRnZXQoICJ1aS5hdXRvY29tcGxldGUiLCAkLnVpLmF1dG9jb21wbGV0ZSwgew0KCW9wdGlvbnM6IHsNCgkJbWVzc2FnZXM6IHsNCgkJCW5vUmVzdWx0czogIk5vIHNlYXJjaCByZXN1bHRzLiIsDQoJCQlyZXN1bHRzOiBmdW5jdGlvbiggYW1vdW50ICkgew0KCQkJCXJldHVybiBhbW91bnQgKyAoIGFtb3VudCA+IDEgPyAiIHJlc3VsdHMgYXJlIiA6ICIgcmVzdWx0IGlzIiApICsNCgkJCQkJIiBhdmFpbGFibGUsIHVzZSB1cCBhbmQgZG93biBhcnJvdyBrZXlzIHRvIG5hdmlnYXRlLiI7DQoJCQl9DQoJCX0NCgl9LA0KDQoJX19yZXNwb25zZTogZnVuY3Rpb24oIGNvbnRlbnQgKSB7DQoJCXZhciBtZXNzYWdlOw0KCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsNCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5jYW5jZWxTZWFyY2ggKSB7DQoJCQlyZXR1cm47DQoJCX0NCgkJaWYgKCBjb250ZW50ICYmIGNvbnRlbnQubGVuZ3RoICkgew0KCQkJbWVzc2FnZSA9IHRoaXMub3B0aW9ucy5tZXNzYWdlcy5yZXN1bHRzKCBjb250ZW50Lmxlbmd0aCApOw0KCQl9IGVsc2Ugew0KCQkJbWVzc2FnZSA9IHRoaXMub3B0aW9ucy5tZXNzYWdlcy5ub1Jlc3VsdHM7DQoJCX0NCgkJdGhpcy5saXZlUmVnaW9uLmNoaWxkcmVuKCkuaGlkZSgpOw0KCQkkKCAiPGRpdj4iICkudGV4dCggbWVzc2FnZSApLmFwcGVuZFRvKCB0aGlzLmxpdmVSZWdpb24gKTsNCgl9DQp9ICk7DQoNCnZhciB3aWRnZXRzQXV0b2NvbXBsZXRlID0gJC51aS5hdXRvY29tcGxldGU7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgQ29udHJvbGdyb3VwIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBDb250cm9sZ3JvdXANCi8vPj5ncm91cDogV2lkZ2V0cw0KLy8+PmRlc2NyaXB0aW9uOiBWaXN1YWxseSBncm91cHMgZm9ybSBjb250cm9sIHdpZGdldHMNCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9jb250cm9sZ3JvdXAvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vY29udHJvbGdyb3VwLw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29udHJvbGdyb3VwLmNzcw0KLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzDQoNCg0KdmFyIGNvbnRyb2xncm91cENvcm5lclJlZ2V4ID0gL3VpLWNvcm5lci0oW2Etel0pezIsNn0vZzsNCg0KdmFyIHdpZGdldHNDb250cm9sZ3JvdXAgPSAkLndpZGdldCggInVpLmNvbnRyb2xncm91cCIsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCglkZWZhdWx0RWxlbWVudDogIjxkaXY+IiwNCglvcHRpb25zOiB7DQoJCWRpcmVjdGlvbjogImhvcml6b250YWwiLA0KCQlkaXNhYmxlZDogbnVsbCwNCgkJb25seVZpc2libGU6IHRydWUsDQoJCWl0ZW1zOiB7DQoJCQkiYnV0dG9uIjogImlucHV0W3R5cGU9YnV0dG9uXSwgaW5wdXRbdHlwZT1zdWJtaXRdLCBpbnB1dFt0eXBlPXJlc2V0XSwgYnV0dG9uLCBhIiwNCgkJCSJjb250cm9sZ3JvdXBMYWJlbCI6ICIudWktY29udHJvbGdyb3VwLWxhYmVsIiwNCgkJCSJjaGVja2JveHJhZGlvIjogImlucHV0W3R5cGU9J2NoZWNrYm94J10sIGlucHV0W3R5cGU9J3JhZGlvJ10iLA0KCQkJInNlbGVjdG1lbnUiOiAic2VsZWN0IiwNCgkJCSJzcGlubmVyIjogIi51aS1zcGlubmVyLWlucHV0Ig0KCQl9DQoJfSwNCg0KCV9jcmVhdGU6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLl9lbmhhbmNlKCk7DQoJfSwNCg0KCS8vIFRvIHN1cHBvcnQgdGhlIGVuaGFuY2VkIG9wdGlvbiBpbiBqUXVlcnkgTW9iaWxlLCB3ZSBpc29sYXRlIERPTSBtYW5pcHVsYXRpb24NCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7DQoJCXRoaXMuZWxlbWVudC5hdHRyKCAicm9sZSIsICJ0b29sYmFyIiApOw0KCQl0aGlzLnJlZnJlc2goKTsNCgl9LA0KDQoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLl9jYWxsQ2hpbGRNZXRob2QoICJkZXN0cm95IiApOw0KCQl0aGlzLmNoaWxkV2lkZ2V0cy5yZW1vdmVEYXRhKCAidWktY29udHJvbGdyb3VwLWRhdGEiICk7DQoJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAicm9sZSIgKTsNCgkJaWYgKCB0aGlzLm9wdGlvbnMuaXRlbXMuY29udHJvbGdyb3VwTGFiZWwgKSB7DQoJCQl0aGlzLmVsZW1lbnQNCgkJCQkuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zLmNvbnRyb2xncm91cExhYmVsICkNCgkJCQkuZmluZCggIi51aS1jb250cm9sZ3JvdXAtbGFiZWwtY29udGVudHMiICkNCgkJCQkuY29udGVudHMoKS51bndyYXAoKTsNCgkJfQ0KCX0sDQoNCglfaW5pdFdpZGdldHM6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9IHRoaXMsDQoJCQljaGlsZFdpZGdldHMgPSBbXTsNCg0KCQkvLyBGaXJzdCB3ZSBpdGVyYXRlIG92ZXIgZWFjaCBvZiB0aGUgaXRlbXMgb3B0aW9ucw0KCQkkLmVhY2goIHRoaXMub3B0aW9ucy5pdGVtcywgZnVuY3Rpb24oIHdpZGdldCwgc2VsZWN0b3IgKSB7DQoJCQl2YXIgbGFiZWxzOw0KCQkJdmFyIG9wdGlvbnMgPSB7fTsNCg0KCQkJLy8gTWFrZSBzdXJlIHRoZSB3aWRnZXQgaGFzIGEgc2VsZWN0b3Igc2V0DQoJCQlpZiAoICFzZWxlY3RvciApIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCWlmICggd2lkZ2V0ID09PSAiY29udHJvbGdyb3VwTGFiZWwiICkgew0KCQkJCWxhYmVscyA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOw0KCQkJCWxhYmVscy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICk7DQoNCgkJCQkJaWYgKCBlbGVtZW50LmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbC1jb250ZW50cyIgKS5sZW5ndGggKSB7DQoJCQkJCQlyZXR1cm47DQoJCQkJCX0NCgkJCQkJZWxlbWVudC5jb250ZW50cygpDQoJCQkJCQkud3JhcEFsbCggIjxzcGFuIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwtY29udGVudHMnPjwvc3Bhbj4iICk7DQoJCQkJfSApOw0KCQkJCXRoYXQuX2FkZENsYXNzKCBsYWJlbHMsIG51bGwsICJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktc3RhdGUtZGVmYXVsdCIgKTsNCgkJCQljaGlsZFdpZGdldHMgPSBjaGlsZFdpZGdldHMuY29uY2F0KCBsYWJlbHMuZ2V0KCkgKTsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCS8vIE1ha2Ugc3VyZSB0aGUgd2lkZ2V0IGFjdHVhbGx5IGV4aXN0cw0KCQkJaWYgKCAhJC5mblsgd2lkZ2V0IF0gKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQkvLyBXZSBhc3N1bWUgZXZlcnl0aGluZyBpcyBpbiB0aGUgbWlkZGxlIHRvIHN0YXJ0IGJlY2F1c2Ugd2UgY2FuJ3QgZGV0ZXJtaW5lDQoJCQkvLyBmaXJzdCAvIGxhc3QgZWxlbWVudHMgdW50aWwgYWxsIGVuaGFuY21lbnRzIGFyZSBkb25lLg0KCQkJaWYgKCB0aGF0WyAiXyIgKyB3aWRnZXQgKyAiT3B0aW9ucyIgXSApIHsNCgkJCQlvcHRpb25zID0gdGhhdFsgIl8iICsgd2lkZ2V0ICsgIk9wdGlvbnMiIF0oICJtaWRkbGUiICk7DQoJCQl9IGVsc2Ugew0KCQkJCW9wdGlvbnMgPSB7IGNsYXNzZXM6IHt9IH07DQoJCQl9DQoNCgkJCS8vIEZpbmQgaW5zdGFuY2VzIG9mIHRoaXMgd2lkZ2V0IGluc2lkZSBjb250cm9sZ3JvdXAgYW5kIGluaXQgdGhlbQ0KCQkJdGhhdC5lbGVtZW50DQoJCQkJLmZpbmQoIHNlbGVjdG9yICkNCgkJCQkuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJCXZhciBlbGVtZW50ID0gJCggdGhpcyApOw0KCQkJCQl2YXIgaW5zdGFuY2UgPSBlbGVtZW50WyB3aWRnZXQgXSggImluc3RhbmNlIiApOw0KDQoJCQkJCS8vIFdlIG5lZWQgdG8gY2xvbmUgdGhlIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhpcyB0eXBlIG9mIHdpZGdldCB0byBhdm9pZA0KCQkJCQkvLyBwb2xsdXRpbmcgdGhlIHZhcmlhYmxlIG9wdGlvbnMgd2hpY2ggaGFzIGEgd2lkZXIgc2NvcGUgdGhhbiBhIHNpbmdsZSB3aWRnZXQuDQoJCQkJCXZhciBpbnN0YW5jZU9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBvcHRpb25zICk7DQoNCgkJCQkJLy8gSWYgdGhlIGJ1dHRvbiBpcyB0aGUgY2hpbGQgb2YgYSBzcGlubmVyIGlnbm9yZSBpdA0KCQkJCQkvLyBUT0RPOiBGaW5kIGEgbW9yZSBnZW5lcmljIHNvbHV0aW9uDQoJCQkJCWlmICggd2lkZ2V0ID09PSAiYnV0dG9uIiAmJiBlbGVtZW50LnBhcmVudCggIi51aS1zcGlubmVyIiApLmxlbmd0aCApIHsNCgkJCQkJCXJldHVybjsNCgkJCQkJfQ0KDQoJCQkJCS8vIENyZWF0ZSB0aGUgd2lkZ2V0IGlmIGl0IGRvZXNuJ3QgZXhpc3QNCgkJCQkJaWYgKCAhaW5zdGFuY2UgKSB7DQoJCQkJCQlpbnN0YW5jZSA9IGVsZW1lbnRbIHdpZGdldCBdKClbIHdpZGdldCBdKCAiaW5zdGFuY2UiICk7DQoJCQkJCX0NCgkJCQkJaWYgKCBpbnN0YW5jZSApIHsNCgkJCQkJCWluc3RhbmNlT3B0aW9ucy5jbGFzc2VzID0NCgkJCQkJCQl0aGF0Ll9yZXNvbHZlQ2xhc3Nlc1ZhbHVlcyggaW5zdGFuY2VPcHRpb25zLmNsYXNzZXMsIGluc3RhbmNlICk7DQoJCQkJCX0NCgkJCQkJZWxlbWVudFsgd2lkZ2V0IF0oIGluc3RhbmNlT3B0aW9ucyApOw0KDQoJCQkJCS8vIFN0b3JlIGFuIGluc3RhbmNlIG9mIHRoZSBjb250cm9sZ3JvdXAgdG8gYmUgYWJsZSB0byByZWZlcmVuY2UNCgkJCQkJLy8gZnJvbSB0aGUgb3V0ZXJtb3N0IGVsZW1lbnQgZm9yIGNoYW5naW5nIG9wdGlvbnMgYW5kIHJlZnJlc2gNCgkJCQkJdmFyIHdpZGdldEVsZW1lbnQgPSBlbGVtZW50WyB3aWRnZXQgXSggIndpZGdldCIgKTsNCgkJCQkJJC5kYXRhKCB3aWRnZXRFbGVtZW50WyAwIF0sICJ1aS1jb250cm9sZ3JvdXAtZGF0YSIsDQoJCQkJCQlpbnN0YW5jZSA\/IGluc3RhbmNlIDogZWxlbWVudFsgd2lkZ2V0IF0oICJpbnN0YW5jZSIgKSApOw0KDQoJCQkJCWNoaWxkV2lkZ2V0cy5wdXNoKCB3aWRnZXRFbGVtZW50WyAwIF0gKTsNCgkJCQl9ICk7DQoJCX0gKTsNCg0KCQl0aGlzLmNoaWxkV2lkZ2V0cyA9ICQoICQudW5pcXVlKCBjaGlsZFdpZGdldHMgKSApOw0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5jaGlsZFdpZGdldHMsICJ1aS1jb250cm9sZ3JvdXAtaXRlbSIgKTsNCgl9LA0KDQoJX2NhbGxDaGlsZE1ldGhvZDogZnVuY3Rpb24oIG1ldGhvZCApIHsNCgkJdGhpcy5jaGlsZFdpZGdldHMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwNCgkJCQlkYXRhID0gZWxlbWVudC5kYXRhKCAidWktY29udHJvbGdyb3VwLWRhdGEiICk7DQoJCQlpZiAoIGRhdGEgJiYgZGF0YVsgbWV0aG9kIF0gKSB7DQoJCQkJZGF0YVsgbWV0aG9kIF0oKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfdXBkYXRlQ29ybmVyQ2xhc3M6IGZ1bmN0aW9uKCBlbGVtZW50LCBwb3NpdGlvbiApIHsNCgkJdmFyIHJlbW92ZSA9ICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWxlZnQgdWktY29ybmVyLXJpZ2h0IHVpLWNvcm5lci1hbGwiOw0KCQl2YXIgYWRkID0gdGhpcy5fYnVpbGRTaW1wbGVPcHRpb25zKCBwb3NpdGlvbiwgImxhYmVsIiApLmNsYXNzZXMubGFiZWw7DQoNCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGVsZW1lbnQsIG51bGwsIHJlbW92ZSApOw0KCQl0aGlzLl9hZGRDbGFzcyggZWxlbWVudCwgbnVsbCwgYWRkICk7DQoJfSwNCg0KCV9idWlsZFNpbXBsZU9wdGlvbnM6IGZ1bmN0aW9uKCBwb3NpdGlvbiwga2V5ICkgew0KCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5vcHRpb25zLmRpcmVjdGlvbiA9PT0gInZlcnRpY2FsIjsNCgkJdmFyIHJlc3VsdCA9IHsNCgkJCWNsYXNzZXM6IHt9DQoJCX07DQoJCXJlc3VsdC5jbGFzc2VzWyBrZXkgXSA9IHsNCgkJCSJtaWRkbGUiOiAiIiwNCgkJCSJmaXJzdCI6ICJ1aS1jb3JuZXItIiArICggZGlyZWN0aW9uID8gInRvcCIgOiAibGVmdCIgKSwNCgkJCSJsYXN0IjogInVpLWNvcm5lci0iICsgKCBkaXJlY3Rpb24gPyAiYm90dG9tIiA6ICJyaWdodCIgKSwNCgkJCSJvbmx5IjogInVpLWNvcm5lci1hbGwiDQoJCX1bIHBvc2l0aW9uIF07DQoNCgkJcmV0dXJuIHJlc3VsdDsNCgl9LA0KDQoJX3NwaW5uZXJPcHRpb25zOiBmdW5jdGlvbiggcG9zaXRpb24gKSB7DQoJCXZhciBvcHRpb25zID0gdGhpcy5fYnVpbGRTaW1wbGVPcHRpb25zKCBwb3NpdGlvbiwgInVpLXNwaW5uZXIiICk7DQoNCgkJb3B0aW9ucy5jbGFzc2VzWyAidWktc3Bpbm5lci11cCIgXSA9ICIiOw0KCQlvcHRpb25zLmNsYXNzZXNbICJ1aS1zcGlubmVyLWRvd24iIF0gPSAiIjsNCg0KCQlyZXR1cm4gb3B0aW9uczsNCgl9LA0KDQoJX2J1dHRvbk9wdGlvbnM6IGZ1bmN0aW9uKCBwb3NpdGlvbiApIHsNCgkJcmV0dXJuIHRoaXMuX2J1aWxkU2ltcGxlT3B0aW9ucyggcG9zaXRpb24sICJ1aS1idXR0b24iICk7DQoJfSwNCg0KCV9jaGVja2JveHJhZGlvT3B0aW9uczogZnVuY3Rpb24oIHBvc2l0aW9uICkgew0KCQlyZXR1cm4gdGhpcy5fYnVpbGRTaW1wbGVPcHRpb25zKCBwb3NpdGlvbiwgInVpLWNoZWNrYm94cmFkaW8tbGFiZWwiICk7DQoJfSwNCg0KCV9zZWxlY3RtZW51T3B0aW9uczogZnVuY3Rpb24oIHBvc2l0aW9uICkgew0KCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5vcHRpb25zLmRpcmVjdGlvbiA9PT0gInZlcnRpY2FsIjsNCgkJcmV0dXJuIHsNCgkJCXdpZHRoOiBkaXJlY3Rpb24gPyAiYXV0byIgOiBmYWxzZSwNCgkJCWNsYXNzZXM6IHsNCgkJCQltaWRkbGU6IHsNCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLW9wZW4iOiAiIiwNCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCI6ICIiDQoJCQkJfSwNCgkJCQlmaXJzdDogew0KCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tb3BlbiI6ICJ1aS1jb3JuZXItIiArICggZGlyZWN0aW9uID8gInRvcCIgOiAidGwiICksDQoJCQkJCSJ1aS1zZWxlY3RtZW51LWJ1dHRvbi1jbG9zZWQiOiAidWktY29ybmVyLSIgKyAoIGRpcmVjdGlvbiA\/ICJ0b3AiIDogImxlZnQiICkNCgkJCQl9LA0KCQkJCWxhc3Q6IHsNCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLW9wZW4iOiBkaXJlY3Rpb24gPyAiIiA6ICJ1aS1jb3JuZXItdHIiLA0KCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tY2xvc2VkIjogInVpLWNvcm5lci0iICsgKCBkaXJlY3Rpb24gPyAiYm90dG9tIiA6ICJyaWdodCIgKQ0KCQkJCX0sDQoJCQkJb25seTogew0KCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tb3BlbiI6ICJ1aS1jb3JuZXItdG9wIiwNCgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCI6ICJ1aS1jb3JuZXItYWxsIg0KCQkJCX0NCg0KCQkJfVsgcG9zaXRpb24gXQ0KCQl9Ow0KCX0sDQoNCglfcmVzb2x2ZUNsYXNzZXNWYWx1ZXM6IGZ1bmN0aW9uKCBjbGFzc2VzLCBpbnN0YW5jZSApIHsNCgkJdmFyIHJlc3VsdCA9IHt9Ow0KCQkkLmVhY2goIGNsYXNzZXMsIGZ1bmN0aW9uKCBrZXkgKSB7DQoJCQl2YXIgY3VycmVudCA9IGluc3RhbmNlLm9wdGlvbnMuY2xhc3Nlc1sga2V5IF0gfHwgIiI7DQoJCQljdXJyZW50ID0gJC50cmltKCBjdXJyZW50LnJlcGxhY2UoIGNvbnRyb2xncm91cENvcm5lclJlZ2V4LCAiIiApICk7DQoJCQlyZXN1bHRbIGtleSBdID0gKCBjdXJyZW50ICsgIiAiICsgY2xhc3Nlc1sga2V5IF0gKS5yZXBsYWNlKCAvXHMrL2csICIgIiApOw0KCQl9ICk7DQoJCXJldHVybiByZXN1bHQ7DQoJfSwNCg0KCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQlpZiAoIGtleSA9PT0gImRpcmVjdGlvbiIgKSB7DQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgdGhpcy5vcHRpb25zLmRpcmVjdGlvbiApOw0KCQl9DQoNCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsNCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7DQoJCQl0aGlzLl9jYWxsQ2hpbGRNZXRob2QoIHZhbHVlID8gImRpc2FibGUiIDogImVuYWJsZSIgKTsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXRoaXMucmVmcmVzaCgpOw0KCX0sDQoNCglyZWZyZXNoOiBmdW5jdGlvbigpIHsNCgkJdmFyIGNoaWxkcmVuLA0KCQkJdGhhdCA9IHRoaXM7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAgdWktY29udHJvbGdyb3VwLSIgKyB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uICk7DQoNCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7DQoJCQl0aGlzLl9hZGRDbGFzcyggbnVsbCwgInVpLWhlbHBlci1jbGVhcmZpeCIgKTsNCgkJfQ0KCQl0aGlzLl9pbml0V2lkZ2V0cygpOw0KDQoJCWNoaWxkcmVuID0gdGhpcy5jaGlsZFdpZGdldHM7DQoNCgkJLy8gV2UgZmlsdGVyIGhlcmUgYmVjYXVzZSB3ZSBuZWVkIHRvIHRyYWNrIGFsbCBjaGlsZFdpZGdldHMgbm90IGp1c3QgdGhlIHZpc2libGUgb25lcw0KCQlpZiAoIHRoaXMub3B0aW9ucy5vbmx5VmlzaWJsZSApIHsNCgkJCWNoaWxkcmVuID0gY2hpbGRyZW4uZmlsdGVyKCAiOnZpc2libGUiICk7DQoJCX0NCg0KCQlpZiAoIGNoaWxkcmVuLmxlbmd0aCApIHsNCg0KCQkJLy8gV2UgZG8gdGhpcyBsYXN0IGJlY2F1c2Ugd2UgbmVlZCB0byBtYWtlIHN1cmUgYWxsIGVuaGFuY21lbnQgaXMgZG9uZQ0KCQkJLy8gYmVmb3JlIGRldGVybWluaW5nIGZpcnN0IGFuZCBsYXN0DQoJCQkkLmVhY2goIFsgImZpcnN0IiwgImxhc3QiIF0sIGZ1bmN0aW9uKCBpbmRleCwgdmFsdWUgKSB7DQoJCQkJdmFyIGluc3RhbmNlID0gY2hpbGRyZW5bIHZhbHVlIF0oKS5kYXRhKCAidWktY29udHJvbGdyb3VwLWRhdGEiICk7DQoNCgkJCQlpZiAoIGluc3RhbmNlICYmIHRoYXRbICJfIiArIGluc3RhbmNlLndpZGdldE5hbWUgKyAiT3B0aW9ucyIgXSApIHsNCgkJCQkJdmFyIG9wdGlvbnMgPSB0aGF0WyAiXyIgKyBpbnN0YW5jZS53aWRnZXROYW1lICsgIk9wdGlvbnMiIF0oDQoJCQkJCQljaGlsZHJlbi5sZW5ndGggPT09IDEgPyAib25seSIgOiB2YWx1ZQ0KCQkJCQkpOw0KCQkJCQlvcHRpb25zLmNsYXNzZXMgPSB0aGF0Ll9yZXNvbHZlQ2xhc3Nlc1ZhbHVlcyggb3B0aW9ucy5jbGFzc2VzLCBpbnN0YW5jZSApOw0KCQkJCQlpbnN0YW5jZS5lbGVtZW50WyBpbnN0YW5jZS53aWRnZXROYW1lIF0oIG9wdGlvbnMgKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQl0aGF0Ll91cGRhdGVDb3JuZXJDbGFzcyggY2hpbGRyZW5bIHZhbHVlIF0oKSwgdmFsdWUgKTsNCgkJCQl9DQoJCQl9ICk7DQoNCgkJCS8vIEZpbmFsbHkgY2FsbCB0aGUgcmVmcmVzaCBtZXRob2Qgb24gZWFjaCBvZiB0aGUgY2hpbGQgd2lkZ2V0cy4NCgkJCXRoaXMuX2NhbGxDaGlsZE1ldGhvZCggInJlZnJlc2giICk7DQoJCX0NCgl9DQp9ICk7DQoNCi8qIQ0KICogalF1ZXJ5IFVJIENoZWNrYm94cmFkaW8gMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IENoZWNrYm94cmFkaW8NCi8vPj5ncm91cDogV2lkZ2V0cw0KLy8+PmRlc2NyaXB0aW9uOiBFbmhhbmNlcyBhIGZvcm0gd2l0aCBtdWx0aXBsZSB0aGVtZWFibGUgY2hlY2tib3hlcyBvciByYWRpbyBidXR0b25zLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NoZWNrYm94cmFkaW8vDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vY2hlY2tib3hyYWRpby8NCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2J1dHRvbi5jc3MNCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jaGVja2JveHJhZGlvLmNzcw0KLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzDQoNCg0KDQokLndpZGdldCggInVpLmNoZWNrYm94cmFkaW8iLCBbICQudWkuZm9ybVJlc2V0TWl4aW4sIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCglvcHRpb25zOiB7DQoJCWRpc2FibGVkOiBudWxsLA0KCQlsYWJlbDogbnVsbCwNCgkJaWNvbjogdHJ1ZSwNCgkJY2xhc3Nlczogew0KCQkJInVpLWNoZWNrYm94cmFkaW8tbGFiZWwiOiAidWktY29ybmVyLWFsbCIsDQoJCQkidWktY2hlY2tib3hyYWRpby1pY29uIjogInVpLWNvcm5lci1hbGwiDQoJCX0NCgl9LA0KDQoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgew0KCQl2YXIgZGlzYWJsZWQsIGxhYmVsczsNCgkJdmFyIHRoYXQgPSB0aGlzOw0KCQl2YXIgb3B0aW9ucyA9IHRoaXMuX3N1cGVyKCkgfHwge307DQoNCgkJLy8gV2UgcmVhZCB0aGUgdHlwZSBoZXJlLCBiZWNhdXNlIGl0IG1ha2VzIG1vcmUgc2Vuc2UgdG8gdGhyb3cgYSBlbGVtZW50IHR5cGUgZXJyb3IgZmlyc3QsDQoJCS8vIHJhdGhlciB0aGVuIHRoZSBlcnJvciBmb3IgbGFjayBvZiBhIGxhYmVsLiBPZnRlbiBpZiBpdHMgdGhlIHdyb25nIHR5cGUsIGl0DQoJCS8vIHdvbid0IGhhdmUgYSBsYWJlbCAoZS5nLiBjYWxsaW5nIG9uIGEgZGl2LCBidG4sIGV0YykNCgkJdGhpcy5fcmVhZFR5cGUoKTsNCg0KCQlsYWJlbHMgPSB0aGlzLmVsZW1lbnQubGFiZWxzKCk7DQoNCgkJLy8gSWYgdGhlcmUgYXJlIG11bHRpcGxlIGxhYmVscywgdXNlIHRoZSBsYXN0IG9uZQ0KCQl0aGlzLmxhYmVsID0gJCggbGFiZWxzWyBsYWJlbHMubGVuZ3RoIC0gMSBdICk7DQoJCWlmICggIXRoaXMubGFiZWwubGVuZ3RoICkgew0KCQkJJC5lcnJvciggIk5vIGxhYmVsIGZvdW5kIGZvciBjaGVja2JveHJhZGlvIHdpZGdldCIgKTsNCgkJfQ0KDQoJCXRoaXMub3JpZ2luYWxMYWJlbCA9ICIiOw0KDQoJCS8vIFdlIG5lZWQgdG8gZ2V0IHRoZSBsYWJlbCB0ZXh0IGJ1dCB0aGlzIG1heSBhbHNvIG5lZWQgdG8gbWFrZSBzdXJlIGl0IGRvZXMgbm90IGNvbnRhaW4gdGhlDQoJCS8vIGlucHV0IGl0c2VsZi4NCgkJdGhpcy5sYWJlbC5jb250ZW50cygpLm5vdCggdGhpcy5lbGVtZW50WyAwIF0gKS5lYWNoKCBmdW5jdGlvbigpIHsNCg0KCQkJLy8gVGhlIGxhYmVsIGNvbnRlbnRzIGNvdWxkIGJlIHRleHQsIGh0bWwsIG9yIGEgbWl4LiBXZSBjb25jYXQgZWFjaCBlbGVtZW50IHRvIGdldCBhDQoJCQkvLyBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGxhYmVsLCB3aXRob3V0IHRoZSBpbnB1dCBhcyBwYXJ0IG9mIGl0Lg0KCQkJdGhhdC5vcmlnaW5hbExhYmVsICs9IHRoaXMubm9kZVR5cGUgPT09IDMgPyAkKCB0aGlzICkudGV4dCgpIDogdGhpcy5vdXRlckhUTUw7DQoJCX0gKTsNCg0KCQkvLyBTZXQgdGhlIGxhYmVsIG9wdGlvbiBpZiB3ZSBmb3VuZCBsYWJlbCB0ZXh0DQoJCWlmICggdGhpcy5vcmlnaW5hbExhYmVsICkgew0KCQkJb3B0aW9ucy5sYWJlbCA9IHRoaXMub3JpZ2luYWxMYWJlbDsNCgkJfQ0KDQoJCWRpc2FibGVkID0gdGhpcy5lbGVtZW50WyAwIF0uZGlzYWJsZWQ7DQoJCWlmICggZGlzYWJsZWQgIT0gbnVsbCApIHsNCgkJCW9wdGlvbnMuZGlzYWJsZWQgPSBkaXNhYmxlZDsNCgkJfQ0KCQlyZXR1cm4gb3B0aW9uczsNCgl9LA0KDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoJCXZhciBjaGVja2VkID0gdGhpcy5lbGVtZW50WyAwIF0uY2hlY2tlZDsNCg0KCQl0aGlzLl9iaW5kRm9ybVJlc2V0SGFuZGxlcigpOw0KDQoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkID09IG51bGwgKSB7DQoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZDsNCgkJfQ0KDQoJCXRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdGhpcy5vcHRpb25zLmRpc2FibGVkICk7DQoJCXRoaXMuX2FkZENsYXNzKCAidWktY2hlY2tib3hyYWRpbyIsICJ1aS1oZWxwZXItaGlkZGVuLWFjY2Vzc2libGUiICk7DQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmxhYmVsLCAidWktY2hlY2tib3hyYWRpby1sYWJlbCIsICJ1aS1idXR0b24gdWktd2lkZ2V0IiApOw0KDQoJCWlmICggdGhpcy50eXBlID09PSAicmFkaW8iICkgew0KCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGFiZWwsICJ1aS1jaGVja2JveHJhZGlvLXJhZGlvLWxhYmVsIiApOw0KCQl9DQoNCgkJaWYgKCB0aGlzLm9wdGlvbnMubGFiZWwgJiYgdGhpcy5vcHRpb25zLmxhYmVsICE9PSB0aGlzLm9yaWdpbmFsTGFiZWwgKSB7DQoJCQl0aGlzLl91cGRhdGVMYWJlbCgpOw0KCQl9IGVsc2UgaWYgKCB0aGlzLm9yaWdpbmFsTGFiZWwgKSB7DQoJCQl0aGlzLm9wdGlvbnMubGFiZWwgPSB0aGlzLm9yaWdpbmFsTGFiZWw7DQoJCX0NCg0KCQl0aGlzLl9lbmhhbmNlKCk7DQoNCgkJaWYgKCBjaGVja2VkICkgew0KCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGFiZWwsICJ1aS1jaGVja2JveHJhZGlvLWNoZWNrZWQiLCAidWktc3RhdGUtYWN0aXZlIiApOw0KCQkJaWYgKCB0aGlzLmljb24gKSB7DQoJCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgInVpLXN0YXRlLWhvdmVyIiApOw0KCQkJfQ0KCQl9DQoNCgkJdGhpcy5fb24oIHsNCgkJCWNoYW5nZTogIl90b2dnbGVDbGFzc2VzIiwNCgkJCWZvY3VzOiBmdW5jdGlvbigpIHsNCgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5sYWJlbCwgbnVsbCwgInVpLXN0YXRlLWZvY3VzIHVpLXZpc3VhbC1mb2N1cyIgKTsNCgkJCX0sDQoJCQlibHVyOiBmdW5jdGlvbigpIHsNCgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5sYWJlbCwgbnVsbCwgInVpLXN0YXRlLWZvY3VzIHVpLXZpc3VhbC1mb2N1cyIgKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfcmVhZFR5cGU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgbm9kZU5hbWUgPSB0aGlzLmVsZW1lbnRbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOw0KCQl0aGlzLnR5cGUgPSB0aGlzLmVsZW1lbnRbIDAgXS50eXBlOw0KCQlpZiAoIG5vZGVOYW1lICE9PSAiaW5wdXQiIHx8ICEvcmFkaW98Y2hlY2tib3gvLnRlc3QoIHRoaXMudHlwZSApICkgew0KCQkJJC5lcnJvciggIkNhbid0IGNyZWF0ZSBjaGVja2JveHJhZGlvIG9uIGVsZW1lbnQubm9kZU5hbWU9IiArIG5vZGVOYW1lICsNCgkJCQkiIGFuZCBlbGVtZW50LnR5cGU9IiArIHRoaXMudHlwZSApOw0KCQl9DQoJfSwNCg0KCS8vIFN1cHBvcnQgalF1ZXJ5IE1vYmlsZSBlbmhhbmNlZCBvcHRpb24NCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX3VwZGF0ZUljb24oIHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQgKTsNCgl9LA0KDQoJd2lkZ2V0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMubGFiZWw7DQoJfSwNCg0KCV9nZXRSYWRpb0dyb3VwOiBmdW5jdGlvbigpIHsNCgkJdmFyIGdyb3VwOw0KCQl2YXIgbmFtZSA9IHRoaXMuZWxlbWVudFsgMCBdLm5hbWU7DQoJCXZhciBuYW1lU2VsZWN0b3IgPSAiaW5wdXRbbmFtZT0nIiArICQudWkuZXNjYXBlU2VsZWN0b3IoIG5hbWUgKSArICInXSI7DQoNCgkJaWYgKCAhbmFtZSApIHsNCgkJCXJldHVybiAkKCBbXSApOw0KCQl9DQoNCgkJaWYgKCB0aGlzLmZvcm0ubGVuZ3RoICkgew0KCQkJZ3JvdXAgPSAkKCB0aGlzLmZvcm1bIDAgXS5lbGVtZW50cyApLmZpbHRlciggbmFtZVNlbGVjdG9yICk7DQoJCX0gZWxzZSB7DQoNCgkJCS8vIE5vdCBpbnNpZGUgYSBmb3JtLCBjaGVjayBhbGwgaW5wdXRzIHRoYXQgYWxzbyBhcmUgbm90IGluc2lkZSBhIGZvcm0NCgkJCWdyb3VwID0gJCggbmFtZVNlbGVjdG9yICkuZmlsdGVyKCBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gJCggdGhpcyApLmZvcm0oKS5sZW5ndGggPT09IDA7DQoJCQl9ICk7DQoJCX0NCg0KCQlyZXR1cm4gZ3JvdXAubm90KCB0aGlzLmVsZW1lbnQgKTsNCgl9LA0KDQoJX3RvZ2dsZUNsYXNzZXM6IGZ1bmN0aW9uKCkgew0KCQl2YXIgY2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQ7DQoJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLmxhYmVsLCAidWktY2hlY2tib3hyYWRpby1jaGVja2VkIiwgInVpLXN0YXRlLWFjdGl2ZSIsIGNoZWNrZWQgKTsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiApIHsNCgkJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLmljb24sIG51bGwsICJ1aS1pY29uLWNoZWNrIHVpLXN0YXRlLWNoZWNrZWQiLCBjaGVja2VkICkNCgkJCQkuX3RvZ2dsZUNsYXNzKCB0aGlzLmljb24sIG51bGwsICJ1aS1pY29uLWJsYW5rIiwgIWNoZWNrZWQgKTsNCgkJfQ0KDQoJCWlmICggdGhpcy50eXBlID09PSAicmFkaW8iICkgew0KCQkJdGhpcy5fZ2V0UmFkaW9Hcm91cCgpDQoJCQkJLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCQl2YXIgaW5zdGFuY2UgPSAkKCB0aGlzICkuY2hlY2tib3hyYWRpbyggImluc3RhbmNlIiApOw0KDQoJCQkJCWlmICggaW5zdGFuY2UgKSB7DQoJCQkJCQlpbnN0YW5jZS5fcmVtb3ZlQ2xhc3MoIGluc3RhbmNlLmxhYmVsLA0KCQkJCQkJCSJ1aS1jaGVja2JveHJhZGlvLWNoZWNrZWQiLCAidWktc3RhdGUtYWN0aXZlIiApOw0KCQkJCQl9DQoJCQkJfSApOw0KCQl9DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fdW5iaW5kRm9ybVJlc2V0SGFuZGxlcigpOw0KDQoJCWlmICggdGhpcy5pY29uICkgew0KCQkJdGhpcy5pY29uLnJlbW92ZSgpOw0KCQkJdGhpcy5pY29uU3BhY2UucmVtb3ZlKCk7DQoJCX0NCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoNCgkJLy8gV2UgZG9uJ3QgYWxsb3cgdGhlIHZhbHVlIHRvIGJlIHNldCB0byBub3RoaW5nDQoJCWlmICgga2V5ID09PSAibGFiZWwiICYmICF2YWx1ZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7DQoNCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7DQoJCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy5sYWJlbCwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgdmFsdWUgKTsNCgkJCXRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkID0gdmFsdWU7DQoNCgkJCS8vIERvbid0IHJlZnJlc2ggd2hlbiBzZXR0aW5nIGRpc2FibGVkDQoJCQlyZXR1cm47DQoJCX0NCgkJdGhpcy5yZWZyZXNoKCk7DQoJfSwNCg0KCV91cGRhdGVJY29uOiBmdW5jdGlvbiggY2hlY2tlZCApIHsNCgkJdmFyIHRvQWRkID0gInVpLWljb24gdWktaWNvbi1iYWNrZ3JvdW5kICI7DQoNCgkJaWYgKCB0aGlzLm9wdGlvbnMuaWNvbiApIHsNCgkJCWlmICggIXRoaXMuaWNvbiApIHsNCgkJCQl0aGlzLmljb24gPSAkKCAiPHNwYW4+IiApOw0KCQkJCXRoaXMuaWNvblNwYWNlID0gJCggIjxzcGFuPiA8L3NwYW4+IiApOw0KCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmljb25TcGFjZSwgInVpLWNoZWNrYm94cmFkaW8taWNvbi1zcGFjZSIgKTsNCgkJCX0NCg0KCQkJaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgKSB7DQoJCQkJdG9BZGQgKz0gY2hlY2tlZCA\/ICJ1aS1pY29uLWNoZWNrIHVpLXN0YXRlLWNoZWNrZWQiIDogInVpLWljb24tYmxhbmsiOw0KCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmljb24sIG51bGwsIGNoZWNrZWQgPyAidWktaWNvbi1ibGFuayIgOiAidWktaWNvbi1jaGVjayIgKTsNCgkJCX0gZWxzZSB7DQoJCQkJdG9BZGQgKz0gInVpLWljb24tYmxhbmsiOw0KCQkJfQ0KCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaWNvbiwgInVpLWNoZWNrYm94cmFkaW8taWNvbiIsIHRvQWRkICk7DQoJCQlpZiAoICFjaGVja2VkICkgew0KCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmljb24sIG51bGwsICJ1aS1pY29uLWNoZWNrIHVpLXN0YXRlLWNoZWNrZWQiICk7DQoJCQl9DQoJCQl0aGlzLmljb24ucHJlcGVuZFRvKCB0aGlzLmxhYmVsICkuYWZ0ZXIoIHRoaXMuaWNvblNwYWNlICk7DQoJCX0gZWxzZSBpZiAoIHRoaXMuaWNvbiAhPT0gdW5kZWZpbmVkICkgew0KCQkJdGhpcy5pY29uLnJlbW92ZSgpOw0KCQkJdGhpcy5pY29uU3BhY2UucmVtb3ZlKCk7DQoJCQlkZWxldGUgdGhpcy5pY29uOw0KCQl9DQoJfSwNCg0KCV91cGRhdGVMYWJlbDogZnVuY3Rpb24oKSB7DQoNCgkJLy8gUmVtb3ZlIHRoZSBjb250ZW50cyBvZiB0aGUgbGFiZWwgKCBtaW51cyB0aGUgaWNvbiwgaWNvbiBzcGFjZSwgYW5kIGlucHV0ICkNCgkJdmFyIGNvbnRlbnRzID0gdGhpcy5sYWJlbC5jb250ZW50cygpLm5vdCggdGhpcy5lbGVtZW50WyAwIF0gKTsNCgkJaWYgKCB0aGlzLmljb24gKSB7DQoJCQljb250ZW50cyA9IGNvbnRlbnRzLm5vdCggdGhpcy5pY29uWyAwIF0gKTsNCgkJfQ0KCQlpZiAoIHRoaXMuaWNvblNwYWNlICkgew0KCQkJY29udGVudHMgPSBjb250ZW50cy5ub3QoIHRoaXMuaWNvblNwYWNlWyAwIF0gKTsNCgkJfQ0KCQljb250ZW50cy5yZW1vdmUoKTsNCg0KCQl0aGlzLmxhYmVsLmFwcGVuZCggdGhpcy5vcHRpb25zLmxhYmVsICk7DQoJfSwNCg0KCXJlZnJlc2g6IGZ1bmN0aW9uKCkgew0KCQl2YXIgY2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQsDQoJCQlpc0Rpc2FibGVkID0gdGhpcy5lbGVtZW50WyAwIF0uZGlzYWJsZWQ7DQoNCgkJdGhpcy5fdXBkYXRlSWNvbiggY2hlY2tlZCApOw0KCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy5sYWJlbCwgInVpLWNoZWNrYm94cmFkaW8tY2hlY2tlZCIsICJ1aS1zdGF0ZS1hY3RpdmUiLCBjaGVja2VkICk7DQoJCWlmICggdGhpcy5vcHRpb25zLmxhYmVsICE9PSBudWxsICkgew0KCQkJdGhpcy5fdXBkYXRlTGFiZWwoKTsNCgkJfQ0KDQoJCWlmICggaXNEaXNhYmxlZCAhPT0gdGhpcy5vcHRpb25zLmRpc2FibGVkICkgew0KCQkJdGhpcy5fc2V0T3B0aW9ucyggeyAiZGlzYWJsZWQiOiBpc0Rpc2FibGVkIH0gKTsNCgkJfQ0KCX0NCg0KfSBdICk7DQoNCnZhciB3aWRnZXRzQ2hlY2tib3hyYWRpbyA9ICQudWkuY2hlY2tib3hyYWRpbzsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBCdXR0b24gMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IEJ1dHRvbg0KLy8+Pmdyb3VwOiBXaWRnZXRzDQovLz4+ZGVzY3JpcHRpb246IEVuaGFuY2VzIGEgZm9ybSB3aXRoIHRoZW1lYWJsZSBidXR0b25zLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2J1dHRvbi8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9idXR0b24vDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MNCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9idXR0b24uY3NzDQovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MNCg0KDQoNCiQud2lkZ2V0KCAidWkuYnV0dG9uIiwgew0KCXZlcnNpb246ICIxLjEyLjEiLA0KCWRlZmF1bHRFbGVtZW50OiAiPGJ1dHRvbj4iLA0KCW9wdGlvbnM6IHsNCgkJY2xhc3Nlczogew0KCQkJInVpLWJ1dHRvbiI6ICJ1aS1jb3JuZXItYWxsIg0KCQl9LA0KCQlkaXNhYmxlZDogbnVsbCwNCgkJaWNvbjogbnVsbCwNCgkJaWNvblBvc2l0aW9uOiAiYmVnaW5uaW5nIiwNCgkJbGFiZWw6IG51bGwsDQoJCXNob3dMYWJlbDogdHJ1ZQ0KCX0sDQoNCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7DQoJCXZhciBkaXNhYmxlZCwNCg0KCQkJLy8gVGhpcyBpcyB0byBzdXBwb3J0IGNhc2VzIGxpa2UgaW4galF1ZXJ5IE1vYmlsZSB3aGVyZSB0aGUgYmFzZSB3aWRnZXQgZG9lcyBoYXZlDQoJCQkvLyBhbiBpbXBsZW1lbnRhdGlvbiBvZiBfZ2V0Q3JlYXRlT3B0aW9ucw0KCQkJb3B0aW9ucyA9IHRoaXMuX3N1cGVyKCkgfHwge307DQoNCgkJdGhpcy5pc0lucHV0ID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQiICk7DQoNCgkJZGlzYWJsZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZDsNCgkJaWYgKCBkaXNhYmxlZCAhPSBudWxsICkgew0KCQkJb3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOw0KCQl9DQoNCgkJdGhpcy5vcmlnaW5hbExhYmVsID0gdGhpcy5pc0lucHV0ID8gdGhpcy5lbGVtZW50LnZhbCgpIDogdGhpcy5lbGVtZW50Lmh0bWwoKTsNCgkJaWYgKCB0aGlzLm9yaWdpbmFsTGFiZWwgKSB7DQoJCQlvcHRpb25zLmxhYmVsID0gdGhpcy5vcmlnaW5hbExhYmVsOw0KCQl9DQoNCgkJcmV0dXJuIG9wdGlvbnM7DQoJfSwNCg0KCV9jcmVhdGU6IGZ1bmN0aW9uKCkgew0KCQlpZiAoICF0aGlzLm9wdGlvbi5zaG93TGFiZWwgJiAhdGhpcy5vcHRpb25zLmljb24gKSB7DQoJCQl0aGlzLm9wdGlvbnMuc2hvd0xhYmVsID0gdHJ1ZTsNCgkJfQ0KDQoJCS8vIFdlIGhhdmUgdG8gY2hlY2sgdGhlIG9wdGlvbiBhZ2FpbiBoZXJlIGV2ZW4gdGhvdWdoIHdlIGRpZCBpbiBfZ2V0Q3JlYXRlT3B0aW9ucywNCgkJLy8gYmVjYXVzZSBudWxsIG1heSBoYXZlIGJlZW4gcGFzc2VkIG9uIGluaXQgd2hpY2ggd291bGQgb3ZlcnJpZGUgd2hhdCB3YXMgc2V0IGluDQoJCS8vIF9nZXRDcmVhdGVPcHRpb25zDQoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkID09IG51bGwgKSB7DQoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZCB8fCBmYWxzZTsNCgkJfQ0KDQoJCXRoaXMuaGFzVGl0bGUgPSAhIXRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiICk7DQoNCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBsYWJlbCBuZWVkcyB0byBiZSBzZXQgb3IgaWYgaXRzIGFscmVhZHkgY29ycmVjdA0KCQlpZiAoIHRoaXMub3B0aW9ucy5sYWJlbCAmJiB0aGlzLm9wdGlvbnMubGFiZWwgIT09IHRoaXMub3JpZ2luYWxMYWJlbCApIHsNCgkJCWlmICggdGhpcy5pc0lucHV0ICkgew0KCQkJCXRoaXMuZWxlbWVudC52YWwoIHRoaXMub3B0aW9ucy5sYWJlbCApOw0KCQkJfSBlbHNlIHsNCgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggdGhpcy5vcHRpb25zLmxhYmVsICk7DQoJCQl9DQoJCX0NCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1idXR0b24iLCAidWktd2lkZ2V0IiApOw0KCQl0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApOw0KCQl0aGlzLl9lbmhhbmNlKCk7DQoNCgkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICJhIiApICkgew0KCQkJdGhpcy5fb24oIHsNCgkJCQkia2V5dXAiOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJCWlmICggZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlNQQUNFICkgew0KCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KCQkJCQkJLy8gU3VwcG9ydDogUGhhbnRvbUpTIDw9IDEuOSwgSUUgOCBPbmx5DQoJCQkJCQkvLyBJZiBhIG5hdGl2ZSBjbGljayBpcyBhdmFpbGFibGUgdXNlIGl0IHNvIHdlIGFjdHVhbGx5IGNhdXNlIG5hdmlnYXRpb24NCgkJCQkJCS8vIG90aGVyd2lzZSBqdXN0IHRyaWdnZXIgYSBjbGljayBldmVudA0KCQkJCQkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXS5jbGljayApIHsNCgkJCQkJCQl0aGlzLmVsZW1lbnRbIDAgXS5jbGljaygpOw0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNsaWNrIiApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KCQkJfSApOw0KCQl9DQoJfSwNCg0KCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsNCgkJaWYgKCAhdGhpcy5lbGVtZW50LmlzKCAiYnV0dG9uIiApICkgew0KCQkJdGhpcy5lbGVtZW50LmF0dHIoICJyb2xlIiwgImJ1dHRvbiIgKTsNCgkJfQ0KDQoJCWlmICggdGhpcy5vcHRpb25zLmljb24gKSB7DQoJCQl0aGlzLl91cGRhdGVJY29uKCAiaWNvbiIsIHRoaXMub3B0aW9ucy5pY29uICk7DQoJCQl0aGlzLl91cGRhdGVUb29sdGlwKCk7DQoJCX0NCgl9LA0KDQoJX3VwZGF0ZVRvb2x0aXA6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLnRpdGxlID0gdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKTsNCg0KCQlpZiAoICF0aGlzLm9wdGlvbnMuc2hvd0xhYmVsICYmICF0aGlzLnRpdGxlICkgew0KCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIsIHRoaXMub3B0aW9ucy5sYWJlbCApOw0KCQl9DQoJfSwNCg0KCV91cGRhdGVJY29uOiBmdW5jdGlvbiggb3B0aW9uLCB2YWx1ZSApIHsNCgkJdmFyIGljb24gPSBvcHRpb24gIT09ICJpY29uUG9zaXRpb24iLA0KCQkJcG9zaXRpb24gPSBpY29uID8gdGhpcy5vcHRpb25zLmljb25Qb3NpdGlvbiA6IHZhbHVlLA0KCQkJZGlzcGxheUJsb2NrID0gcG9zaXRpb24gPT09ICJ0b3AiIHx8IHBvc2l0aW9uID09PSAiYm90dG9tIjsNCg0KCQkvLyBDcmVhdGUgaWNvbg0KCQlpZiAoICF0aGlzLmljb24gKSB7DQoJCQl0aGlzLmljb24gPSAkKCAiPHNwYW4+IiApOw0KDQoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uLCAidWktYnV0dG9uLWljb24iLCAidWktaWNvbiIgKTsNCg0KCQkJaWYgKCAhdGhpcy5vcHRpb25zLnNob3dMYWJlbCApIHsNCgkJCQl0aGlzLl9hZGRDbGFzcyggInVpLWJ1dHRvbi1pY29uLW9ubHkiICk7DQoJCQl9DQoJCX0gZWxzZSBpZiAoIGljb24gKSB7DQoNCgkJCS8vIElmIHdlIGFyZSB1cGRhdGluZyB0aGUgaWNvbiByZW1vdmUgdGhlIG9sZCBpY29uIGNsYXNzDQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5pY29uLCBudWxsLCB0aGlzLm9wdGlvbnMuaWNvbiApOw0KCQl9DQoNCgkJLy8gSWYgd2UgYXJlIHVwZGF0aW5nIHRoZSBpY29uIGFkZCB0aGUgbmV3IGljb24gY2xhc3MNCgkJaWYgKCBpY29uICkgew0KCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgdmFsdWUgKTsNCgkJfQ0KDQoJCXRoaXMuX2F0dGFjaEljb24oIHBvc2l0aW9uICk7DQoNCgkJLy8gSWYgdGhlIGljb24gaXMgb24gdG9wIG9yIGJvdHRvbSB3ZSBuZWVkIHRvIGFkZCB0aGUgdWktd2lkZ2V0LWljb24tYmxvY2sgY2xhc3MgYW5kIHJlbW92ZQ0KCQkvLyB0aGUgaWNvblNwYWNlIGlmIHRoZXJlIGlzIG9uZS4NCgkJaWYgKCBkaXNwbGF5QmxvY2sgKSB7DQoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uLCBudWxsLCAidWktd2lkZ2V0LWljb24tYmxvY2siICk7DQoJCQlpZiAoIHRoaXMuaWNvblNwYWNlICkgew0KCQkJCXRoaXMuaWNvblNwYWNlLnJlbW92ZSgpOw0KCQkJfQ0KCQl9IGVsc2Ugew0KDQoJCQkvLyBQb3NpdGlvbiBpcyBiZWdpbm5pbmcgb3IgZW5kIHNvIHJlbW92ZSB0aGUgdWktd2lkZ2V0LWljb24tYmxvY2sgY2xhc3MgYW5kIGFkZCB0aGUNCgkJCS8vIHNwYWNlIGlmIGl0IGRvZXMgbm90IGV4aXN0DQoJCQlpZiAoICF0aGlzLmljb25TcGFjZSApIHsNCgkJCQl0aGlzLmljb25TcGFjZSA9ICQoICI8c3Bhbj4gPC9zcGFuPiIgKTsNCgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uU3BhY2UsICJ1aS1idXR0b24taWNvbi1zcGFjZSIgKTsNCgkJCX0NCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmljb24sIG51bGwsICJ1aS13aWdldC1pY29uLWJsb2NrIiApOw0KCQkJdGhpcy5fYXR0YWNoSWNvblNwYWNlKCBwb3NpdGlvbiApOw0KCQl9DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJyb2xlIiApOw0KDQoJCWlmICggdGhpcy5pY29uICkgew0KCQkJdGhpcy5pY29uLnJlbW92ZSgpOw0KCQl9DQoJCWlmICggdGhpcy5pY29uU3BhY2UgKSB7DQoJCQl0aGlzLmljb25TcGFjZS5yZW1vdmUoKTsNCgkJfQ0KCQlpZiAoICF0aGlzLmhhc1RpdGxlICkgew0KCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsNCgkJfQ0KCX0sDQoNCglfYXR0YWNoSWNvblNwYWNlOiBmdW5jdGlvbiggaWNvblBvc2l0aW9uICkgew0KCQl0aGlzLmljb25bIC9eKD86ZW5kfGJvdHRvbSkvLnRlc3QoIGljb25Qb3NpdGlvbiApID8gImJlZm9yZSIgOiAiYWZ0ZXIiIF0oIHRoaXMuaWNvblNwYWNlICk7DQoJfSwNCg0KCV9hdHRhY2hJY29uOiBmdW5jdGlvbiggaWNvblBvc2l0aW9uICkgew0KCQl0aGlzLmVsZW1lbnRbIC9eKD86ZW5kfGJvdHRvbSkvLnRlc3QoIGljb25Qb3NpdGlvbiApID8gImFwcGVuZCIgOiAicHJlcGVuZCIgXSggdGhpcy5pY29uICk7DQoJfSwNCg0KCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsNCgkJdmFyIG5ld1Nob3dMYWJlbCA9IG9wdGlvbnMuc2hvd0xhYmVsID09PSB1bmRlZmluZWQgPw0KCQkJCXRoaXMub3B0aW9ucy5zaG93TGFiZWwgOg0KCQkJCW9wdGlvbnMuc2hvd0xhYmVsLA0KCQkJbmV3SWNvbiA9IG9wdGlvbnMuaWNvbiA9PT0gdW5kZWZpbmVkID8gdGhpcy5vcHRpb25zLmljb24gOiBvcHRpb25zLmljb247DQoNCgkJaWYgKCAhbmV3U2hvd0xhYmVsICYmICFuZXdJY29uICkgew0KCQkJb3B0aW9ucy5zaG93TGFiZWwgPSB0cnVlOw0KCQl9DQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7DQoJfSwNCg0KCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQlpZiAoIGtleSA9PT0gImljb24iICkgew0KCQkJaWYgKCB2YWx1ZSApIHsNCgkJCQl0aGlzLl91cGRhdGVJY29uKCBrZXksIHZhbHVlICk7DQoJCQl9IGVsc2UgaWYgKCB0aGlzLmljb24gKSB7DQoJCQkJdGhpcy5pY29uLnJlbW92ZSgpOw0KCQkJCWlmICggdGhpcy5pY29uU3BhY2UgKSB7DQoJCQkJCXRoaXMuaWNvblNwYWNlLnJlbW92ZSgpOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCWlmICgga2V5ID09PSAiaWNvblBvc2l0aW9uIiApIHsNCgkJCXRoaXMuX3VwZGF0ZUljb24oIGtleSwgdmFsdWUgKTsNCgkJfQ0KDQoJCS8vIE1ha2Ugc3VyZSB3ZSBjYW4ndCBlbmQgdXAgd2l0aCBhIGJ1dHRvbiB0aGF0IGhhcyBuZWl0aGVyIHRleHQgbm9yIGljb24NCgkJaWYgKCBrZXkgPT09ICJzaG93TGFiZWwiICkgew0KCQkJCXRoaXMuX3RvZ2dsZUNsYXNzKCAidWktYnV0dG9uLWljb24tb25seSIsIG51bGwsICF2YWx1ZSApOw0KCQkJCXRoaXMuX3VwZGF0ZVRvb2x0aXAoKTsNCgkJfQ0KDQoJCWlmICgga2V5ID09PSAibGFiZWwiICkgew0KCQkJaWYgKCB0aGlzLmlzSW5wdXQgKSB7DQoJCQkJdGhpcy5lbGVtZW50LnZhbCggdmFsdWUgKTsNCgkJCX0gZWxzZSB7DQoNCgkJCQkvLyBJZiB0aGVyZSBpcyBhbiBpY29uLCBhcHBlbmQgaXQsIGVsc2Ugbm90aGluZyB0aGVuIGFwcGVuZCB0aGUgdmFsdWUNCgkJCQkvLyB0aGlzIGF2b2lkcyByZW1vdmFsIG9mIHRoZSBpY29uIHdoZW4gc2V0dGluZyBsYWJlbCB0ZXh0DQoJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIHZhbHVlICk7DQoJCQkJaWYgKCB0aGlzLmljb24gKSB7DQoJCQkJCXRoaXMuX2F0dGFjaEljb24oIHRoaXMub3B0aW9ucy5pY29uUG9zaXRpb24gKTsNCgkJCQkJdGhpcy5fYXR0YWNoSWNvblNwYWNlKCB0aGlzLm9wdGlvbnMuaWNvblBvc2l0aW9uICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsNCg0KCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsNCgkJCXRoaXMuX3RvZ2dsZUNsYXNzKCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCB2YWx1ZSApOw0KCQkJdGhpcy5lbGVtZW50WyAwIF0uZGlzYWJsZWQgPSB2YWx1ZTsNCgkJCWlmICggdmFsdWUgKSB7DQoJCQkJdGhpcy5lbGVtZW50LmJsdXIoKTsNCgkJCX0NCgkJfQ0KCX0sDQoNCglyZWZyZXNoOiBmdW5jdGlvbigpIHsNCg0KCQkvLyBNYWtlIHN1cmUgdG8gb25seSBjaGVjayBkaXNhYmxlZCBpZiBpdHMgYW4gZWxlbWVudCB0aGF0IHN1cHBvcnRzIHRoaXMgb3RoZXJ3aXNlDQoJCS8vIGNoZWNrIGZvciB0aGUgZGlzYWJsZWQgY2xhc3MgdG8gZGV0ZXJtaW5lIHN0YXRlDQoJCXZhciBpc0Rpc2FibGVkID0gdGhpcy5lbGVtZW50LmlzKCAiaW5wdXQsIGJ1dHRvbiIgKSA\/DQoJCQl0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZCA6IHRoaXMuZWxlbWVudC5oYXNDbGFzcyggInVpLWJ1dHRvbi1kaXNhYmxlZCIgKTsNCg0KCQlpZiAoIGlzRGlzYWJsZWQgIT09IHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsNCgkJCXRoaXMuX3NldE9wdGlvbnMoIHsgZGlzYWJsZWQ6IGlzRGlzYWJsZWQgfSApOw0KCQl9DQoNCgkJdGhpcy5fdXBkYXRlVG9vbHRpcCgpOw0KCX0NCn0gKTsNCg0KLy8gREVQUkVDQVRFRA0KaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7DQoNCgkvLyBUZXh0IGFuZCBJY29ucyBvcHRpb25zDQoJJC53aWRnZXQoICJ1aS5idXR0b24iLCAkLnVpLmJ1dHRvbiwgew0KCQlvcHRpb25zOiB7DQoJCQl0ZXh0OiB0cnVlLA0KCQkJaWNvbnM6IHsNCgkJCQlwcmltYXJ5OiBudWxsLA0KCQkJCXNlY29uZGFyeTogbnVsbA0KCQkJfQ0KCQl9LA0KDQoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgew0KCQkJaWYgKCB0aGlzLm9wdGlvbnMuc2hvd0xhYmVsICYmICF0aGlzLm9wdGlvbnMudGV4dCApIHsNCgkJCQl0aGlzLm9wdGlvbnMuc2hvd0xhYmVsID0gdGhpcy5vcHRpb25zLnRleHQ7DQoJCQl9DQoJCQlpZiAoICF0aGlzLm9wdGlvbnMuc2hvd0xhYmVsICYmIHRoaXMub3B0aW9ucy50ZXh0ICkgew0KCQkJCXRoaXMub3B0aW9ucy50ZXh0ID0gdGhpcy5vcHRpb25zLnNob3dMYWJlbDsNCgkJCX0NCgkJCWlmICggIXRoaXMub3B0aW9ucy5pY29uICYmICggdGhpcy5vcHRpb25zLmljb25zLnByaW1hcnkgfHwNCgkJCQkJdGhpcy5vcHRpb25zLmljb25zLnNlY29uZGFyeSApICkgew0KCQkJCWlmICggdGhpcy5vcHRpb25zLmljb25zLnByaW1hcnkgKSB7DQoJCQkJCXRoaXMub3B0aW9ucy5pY29uID0gdGhpcy5vcHRpb25zLmljb25zLnByaW1hcnk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJdGhpcy5vcHRpb25zLmljb24gPSB0aGlzLm9wdGlvbnMuaWNvbnMuc2Vjb25kYXJ5Ow0KCQkJCQl0aGlzLm9wdGlvbnMuaWNvblBvc2l0aW9uID0gImVuZCI7DQoJCQkJfQ0KCQkJfSBlbHNlIGlmICggdGhpcy5vcHRpb25zLmljb24gKSB7DQoJCQkJdGhpcy5vcHRpb25zLmljb25zLnByaW1hcnkgPSB0aGlzLm9wdGlvbnMuaWNvbjsNCgkJCX0NCgkJCXRoaXMuX3N1cGVyKCk7DQoJCX0sDQoNCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCQlpZiAoIGtleSA9PT0gInRleHQiICkgew0KCQkJCXRoaXMuX3N1cGVyKCAic2hvd0xhYmVsIiwgdmFsdWUgKTsNCgkJCQlyZXR1cm47DQoJCQl9DQoJCQlpZiAoIGtleSA9PT0gInNob3dMYWJlbCIgKSB7DQoJCQkJdGhpcy5vcHRpb25zLnRleHQgPSB2YWx1ZTsNCgkJCX0NCgkJCWlmICgga2V5ID09PSAiaWNvbiIgKSB7DQoJCQkJdGhpcy5vcHRpb25zLmljb25zLnByaW1hcnkgPSB2YWx1ZTsNCgkJCX0NCgkJCWlmICgga2V5ID09PSAiaWNvbnMiICkgew0KCQkJCWlmICggdmFsdWUucHJpbWFyeSApIHsNCgkJCQkJdGhpcy5fc3VwZXIoICJpY29uIiwgdmFsdWUucHJpbWFyeSApOw0KCQkJCQl0aGlzLl9zdXBlciggImljb25Qb3NpdGlvbiIsICJiZWdpbm5pbmciICk7DQoJCQkJfSBlbHNlIGlmICggdmFsdWUuc2Vjb25kYXJ5ICkgew0KCQkJCQl0aGlzLl9zdXBlciggImljb24iLCB2YWx1ZS5zZWNvbmRhcnkgKTsNCgkJCQkJdGhpcy5fc3VwZXIoICJpY29uUG9zaXRpb24iLCAiZW5kIiApOw0KCQkJCX0NCgkJCX0NCgkJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOw0KCQl9DQoJfSApOw0KDQoJJC5mbi5idXR0b24gPSAoIGZ1bmN0aW9uKCBvcmlnICkgew0KCQlyZXR1cm4gZnVuY3Rpb24oKSB7DQoJCQlpZiAoICF0aGlzLmxlbmd0aCB8fCAoIHRoaXMubGVuZ3RoICYmIHRoaXNbIDAgXS50YWdOYW1lICE9PSAiSU5QVVQiICkgfHwNCgkJCQkJKCB0aGlzLmxlbmd0aCAmJiB0aGlzWyAwIF0udGFnTmFtZSA9PT0gIklOUFVUIiAmJiAoDQoJCQkJCQl0aGlzLmF0dHIoICJ0eXBlIiApICE9PSAiY2hlY2tib3giICYmIHRoaXMuYXR0ciggInR5cGUiICkgIT09ICJyYWRpbyINCgkJCQkJKSApICkgew0KCQkJCXJldHVybiBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCgkJCX0NCgkJCWlmICggISQudWkuY2hlY2tib3hyYWRpbyApIHsNCgkJCQkkLmVycm9yKCAiQ2hlY2tib3hyYWRpbyB3aWRnZXQgbWlzc2luZyIgKTsNCgkJCX0NCgkJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsNCgkJCQlyZXR1cm4gdGhpcy5jaGVja2JveHJhZGlvKCB7DQoJCQkJCSJpY29uIjogZmFsc2UNCgkJCQl9ICk7DQoJCQl9DQoJCQlyZXR1cm4gdGhpcy5jaGVja2JveHJhZGlvLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCgkJfTsNCgl9ICkoICQuZm4uYnV0dG9uICk7DQoNCgkkLmZuLmJ1dHRvbnNldCA9IGZ1bmN0aW9uKCkgew0KCQlpZiAoICEkLnVpLmNvbnRyb2xncm91cCApIHsNCgkJCSQuZXJyb3IoICJDb250cm9sZ3JvdXAgd2lkZ2V0IG1pc3NpbmciICk7DQoJCX0NCgkJaWYgKCBhcmd1bWVudHNbIDAgXSA9PT0gIm9wdGlvbiIgJiYgYXJndW1lbnRzWyAxIF0gPT09ICJpdGVtcyIgJiYgYXJndW1lbnRzWyAyIF0gKSB7DQoJCQlyZXR1cm4gdGhpcy5jb250cm9sZ3JvdXAuYXBwbHkoIHRoaXMsDQoJCQkJWyBhcmd1bWVudHNbIDAgXSwgIml0ZW1zLmJ1dHRvbiIsIGFyZ3VtZW50c1sgMiBdIF0gKTsNCgkJfQ0KCQlpZiAoIGFyZ3VtZW50c1sgMCBdID09PSAib3B0aW9uIiAmJiBhcmd1bWVudHNbIDEgXSA9PT0gIml0ZW1zIiApIHsNCgkJCXJldHVybiB0aGlzLmNvbnRyb2xncm91cC5hcHBseSggdGhpcywgWyBhcmd1bWVudHNbIDAgXSwgIml0ZW1zLmJ1dHRvbiIgXSApOw0KCQl9DQoJCWlmICggdHlwZW9mIGFyZ3VtZW50c1sgMCBdID09PSAib2JqZWN0IiAmJiBhcmd1bWVudHNbIDAgXS5pdGVtcyApIHsNCgkJCWFyZ3VtZW50c1sgMCBdLml0ZW1zID0gew0KCQkJCWJ1dHRvbjogYXJndW1lbnRzWyAwIF0uaXRlbXMNCgkJCX07DQoJCX0NCgkJcmV0dXJuIHRoaXMuY29udHJvbGdyb3VwLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsNCgl9Ow0KfQ0KDQp2YXIgd2lkZ2V0c0J1dHRvbiA9ICQudWkuYnV0dG9uOw0KDQoNCi8vIGpzY3M6ZGlzYWJsZSBtYXhpbXVtTGluZUxlbmd0aA0KLyoganNjczpkaXNhYmxlIHJlcXVpcmVDYW1lbENhc2VPclVwcGVyQ2FzZUlkZW50aWZpZXJzICovDQovKiENCiAqIGpRdWVyeSBVSSBEYXRlcGlja2VyIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBEYXRlcGlja2VyDQovLz4+Z3JvdXA6IFdpZGdldHMNCi8vPj5kZXNjcmlwdGlvbjogRGlzcGxheXMgYSBjYWxlbmRhciBmcm9tIGFuIGlucHV0IG9yIGlubGluZSBmb3Igc2VsZWN0aW5nIGRhdGVzLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2RhdGVwaWNrZXIvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZGF0ZXBpY2tlci8NCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2RhdGVwaWNrZXIuY3NzDQovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MNCg0KDQoNCiQuZXh0ZW5kKCAkLnVpLCB7IGRhdGVwaWNrZXI6IHsgdmVyc2lvbjogIjEuMTIuMSIgfSB9ICk7DQoNCnZhciBkYXRlcGlja2VyX2luc3RBY3RpdmU7DQoNCmZ1bmN0aW9uIGRhdGVwaWNrZXJfZ2V0WmluZGV4KCBlbGVtICkgew0KCXZhciBwb3NpdGlvbiwgdmFsdWU7DQoJd2hpbGUgKCBlbGVtLmxlbmd0aCAmJiBlbGVtWyAwIF0gIT09IGRvY3VtZW50ICkgew0KDQoJCS8vIElnbm9yZSB6LWluZGV4IGlmIHBvc2l0aW9uIGlzIHNldCB0byBhIHZhbHVlIHdoZXJlIHotaW5kZXggaXMgaWdub3JlZCBieSB0aGUgYnJvd3Nlcg0KCQkvLyBUaGlzIG1ha2VzIGJlaGF2aW9yIG9mIHRoaXMgZnVuY3Rpb24gY29uc2lzdGVudCBhY3Jvc3MgYnJvd3NlcnMNCgkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZA0KCQlwb3NpdGlvbiA9IGVsZW0uY3NzKCAicG9zaXRpb24iICk7DQoJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7DQoNCgkJCS8vIElFIHJldHVybnMgMCB3aGVuIHpJbmRleCBpcyBub3Qgc3BlY2lmaWVkDQoJCQkvLyBvdGhlciBicm93c2VycyByZXR1cm4gYSBzdHJpbmcNCgkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwDQoJCQkvLyA8ZGl2IHN0eWxlPSJ6LWluZGV4OiAtMTA7Ij48ZGl2IHN0eWxlPSJ6LWluZGV4OiAwOyI+PC9kaXY+PC9kaXY+DQoJCQl2YWx1ZSA9IHBhcnNlSW50KCBlbGVtLmNzcyggInpJbmRleCIgKSwgMTAgKTsNCgkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgew0KCQkJCXJldHVybiB2YWx1ZTsNCgkJCX0NCgkJfQ0KCQllbGVtID0gZWxlbS5wYXJlbnQoKTsNCgl9DQoNCglyZXR1cm4gMDsNCn0NCi8qIERhdGUgcGlja2VyIG1hbmFnZXIuDQogICBVc2UgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzLCAkLmRhdGVwaWNrZXIsIHRvIGludGVyYWN0IHdpdGggdGhlIGRhdGUgcGlja2VyLg0KICAgU2V0dGluZ3MgZm9yIChncm91cHMgb2YpIGRhdGUgcGlja2VycyBhcmUgbWFpbnRhaW5lZCBpbiBhbiBpbnN0YW5jZSBvYmplY3QsDQogICBhbGxvd2luZyBtdWx0aXBsZSBkaWZmZXJlbnQgc2V0dGluZ3Mgb24gdGhlIHNhbWUgcGFnZS4gKi8NCg0KZnVuY3Rpb24gRGF0ZXBpY2tlcigpIHsNCgl0aGlzLl9jdXJJbnN0ID0gbnVsbDsgLy8gVGhlIGN1cnJlbnQgaW5zdGFuY2UgaW4gdXNlDQoJdGhpcy5fa2V5RXZlbnQgPSBmYWxzZTsgLy8gSWYgdGhlIGxhc3QgZXZlbnQgd2FzIGEga2V5IGV2ZW50DQoJdGhpcy5fZGlzYWJsZWRJbnB1dHMgPSBbXTsgLy8gTGlzdCBvZiBkYXRlIHBpY2tlciBpbnB1dHMgdGhhdCBoYXZlIGJlZW4gZGlzYWJsZWQNCgl0aGlzLl9kYXRlcGlja2VyU2hvd2luZyA9IGZhbHNlOyAvLyBUcnVlIGlmIHRoZSBwb3B1cCBwaWNrZXIgaXMgc2hvd2luZyAsIGZhbHNlIGlmIG5vdA0KCXRoaXMuX2luRGlhbG9nID0gZmFsc2U7IC8vIFRydWUgaWYgc2hvd2luZyB3aXRoaW4gYSAiZGlhbG9nIiwgZmFsc2UgaWYgbm90DQoJdGhpcy5fbWFpbkRpdklkID0gInVpLWRhdGVwaWNrZXItZGl2IjsgLy8gVGhlIElEIG9mIHRoZSBtYWluIGRhdGVwaWNrZXIgZGl2aXNpb24NCgl0aGlzLl9pbmxpbmVDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWlubGluZSI7IC8vIFRoZSBuYW1lIG9mIHRoZSBpbmxpbmUgbWFya2VyIGNsYXNzDQoJdGhpcy5fYXBwZW5kQ2xhc3MgPSAidWktZGF0ZXBpY2tlci1hcHBlbmQiOyAvLyBUaGUgbmFtZSBvZiB0aGUgYXBwZW5kIG1hcmtlciBjbGFzcw0KCXRoaXMuX3RyaWdnZXJDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLXRyaWdnZXIiOyAvLyBUaGUgbmFtZSBvZiB0aGUgdHJpZ2dlciBtYXJrZXIgY2xhc3MNCgl0aGlzLl9kaWFsb2dDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWRpYWxvZyI7IC8vIFRoZSBuYW1lIG9mIHRoZSBkaWFsb2cgbWFya2VyIGNsYXNzDQoJdGhpcy5fZGlzYWJsZUNsYXNzID0gInVpLWRhdGVwaWNrZXItZGlzYWJsZWQiOyAvLyBUaGUgbmFtZSBvZiB0aGUgZGlzYWJsZWQgY292ZXJpbmcgbWFya2VyIGNsYXNzDQoJdGhpcy5fdW5zZWxlY3RhYmxlQ2xhc3MgPSAidWktZGF0ZXBpY2tlci11bnNlbGVjdGFibGUiOyAvLyBUaGUgbmFtZSBvZiB0aGUgdW5zZWxlY3RhYmxlIGNlbGwgbWFya2VyIGNsYXNzDQoJdGhpcy5fY3VycmVudENsYXNzID0gInVpLWRhdGVwaWNrZXItY3VycmVudC1kYXkiOyAvLyBUaGUgbmFtZSBvZiB0aGUgY3VycmVudCBkYXkgbWFya2VyIGNsYXNzDQoJdGhpcy5fZGF5T3ZlckNsYXNzID0gInVpLWRhdGVwaWNrZXItZGF5cy1jZWxsLW92ZXIiOyAvLyBUaGUgbmFtZSBvZiB0aGUgZGF5IGhvdmVyIG1hcmtlciBjbGFzcw0KCXRoaXMucmVnaW9uYWwgPSBbXTsgLy8gQXZhaWxhYmxlIHJlZ2lvbmFsIHNldHRpbmdzLCBpbmRleGVkIGJ5IGxhbmd1YWdlIGNvZGUNCgl0aGlzLnJlZ2lvbmFsWyAiIiBdID0geyAvLyBEZWZhdWx0IHJlZ2lvbmFsIHNldHRpbmdzDQoJCWNsb3NlVGV4dDogIkRvbmUiLCAvLyBEaXNwbGF5IHRleHQgZm9yIGNsb3NlIGxpbmsNCgkJcHJldlRleHQ6ICJQcmV2IiwgLy8gRGlzcGxheSB0ZXh0IGZvciBwcmV2aW91cyBtb250aCBsaW5rDQoJCW5leHRUZXh0OiAiTmV4dCIsIC8vIERpc3BsYXkgdGV4dCBmb3IgbmV4dCBtb250aCBsaW5rDQoJCWN1cnJlbnRUZXh0OiAiVG9kYXkiLCAvLyBEaXNwbGF5IHRleHQgZm9yIGN1cnJlbnQgbW9udGggbGluaw0KCQltb250aE5hbWVzOiBbICJKYW51YXJ5IiwiRmVicnVhcnkiLCJNYXJjaCIsIkFwcmlsIiwiTWF5IiwiSnVuZSIsDQoJCQkiSnVseSIsIkF1Z3VzdCIsIlNlcHRlbWJlciIsIk9jdG9iZXIiLCJOb3ZlbWJlciIsIkRlY2VtYmVyIiBdLCAvLyBOYW1lcyBvZiBtb250aHMgZm9yIGRyb3AtZG93biBhbmQgZm9ybWF0dGluZw0KCQltb250aE5hbWVzU2hvcnQ6IFsgIkphbiIsICJGZWIiLCAiTWFyIiwgIkFwciIsICJNYXkiLCAiSnVuIiwgIkp1bCIsICJBdWciLCAiU2VwIiwgIk9jdCIsICJOb3YiLCAiRGVjIiBdLCAvLyBGb3IgZm9ybWF0dGluZw0KCQlkYXlOYW1lczogWyAiU3VuZGF5IiwgIk1vbmRheSIsICJUdWVzZGF5IiwgIldlZG5lc2RheSIsICJUaHVyc2RheSIsICJGcmlkYXkiLCAiU2F0dXJkYXkiIF0sIC8vIEZvciBmb3JtYXR0aW5nDQoJCWRheU5hbWVzU2hvcnQ6IFsgIlN1biIsICJNb24iLCAiVHVlIiwgIldlZCIsICJUaHUiLCAiRnJpIiwgIlNhdCIgXSwgLy8gRm9yIGZvcm1hdHRpbmcNCgkJZGF5TmFtZXNNaW46IFsgIlN1IiwiTW8iLCJUdSIsIldlIiwiVGgiLCJGciIsIlNhIiBdLCAvLyBDb2x1bW4gaGVhZGluZ3MgZm9yIGRheXMgc3RhcnRpbmcgYXQgU3VuZGF5DQoJCXdlZWtIZWFkZXI6ICJXayIsIC8vIENvbHVtbiBoZWFkZXIgZm9yIHdlZWsgb2YgdGhlIHllYXINCgkJZGF0ZUZvcm1hdDogIm1tL2RkL3l5IiwgLy8gU2VlIGZvcm1hdCBvcHRpb25zIG9uIHBhcnNlRGF0ZQ0KCQlmaXJzdERheTogMCwgLy8gVGhlIGZpcnN0IGRheSBvZiB0aGUgd2VlaywgU3VuID0gMCwgTW9uID0gMSwgLi4uDQoJCWlzUlRMOiBmYWxzZSwgLy8gVHJ1ZSBpZiByaWdodC10by1sZWZ0IGxhbmd1YWdlLCBmYWxzZSBpZiBsZWZ0LXRvLXJpZ2h0DQoJCXNob3dNb250aEFmdGVyWWVhcjogZmFsc2UsIC8vIFRydWUgaWYgdGhlIHllYXIgc2VsZWN0IHByZWNlZGVzIG1vbnRoLCBmYWxzZSBmb3IgbW9udGggdGhlbiB5ZWFyDQoJCXllYXJTdWZmaXg6ICIiIC8vIEFkZGl0aW9uYWwgdGV4dCB0byBhcHBlbmQgdG8gdGhlIHllYXIgaW4gdGhlIG1vbnRoIGhlYWRlcnMNCgl9Ow0KCXRoaXMuX2RlZmF1bHRzID0geyAvLyBHbG9iYWwgZGVmYXVsdHMgZm9yIGFsbCB0aGUgZGF0ZSBwaWNrZXIgaW5zdGFuY2VzDQoJCXNob3dPbjogImZvY3VzIiwgLy8gImZvY3VzIiBmb3IgcG9wdXAgb24gZm9jdXMsDQoJCQkvLyAiYnV0dG9uIiBmb3IgdHJpZ2dlciBidXR0b24sIG9yICJib3RoIiBmb3IgZWl0aGVyDQoJCXNob3dBbmltOiAiZmFkZUluIiwgLy8gTmFtZSBvZiBqUXVlcnkgYW5pbWF0aW9uIGZvciBwb3B1cA0KCQlzaG93T3B0aW9uczoge30sIC8vIE9wdGlvbnMgZm9yIGVuaGFuY2VkIGFuaW1hdGlvbnMNCgkJZGVmYXVsdERhdGU6IG51bGwsIC8vIFVzZWQgd2hlbiBmaWVsZCBpcyBibGFuazogYWN0dWFsIGRhdGUsDQoJCQkvLyArLy1udW1iZXIgZm9yIG9mZnNldCBmcm9tIHRvZGF5LCBudWxsIGZvciB0b2RheQ0KCQlhcHBlbmRUZXh0OiAiIiwgLy8gRGlzcGxheSB0ZXh0IGZvbGxvd2luZyB0aGUgaW5wdXQgYm94LCBlLmcuIHNob3dpbmcgdGhlIGZvcm1hdA0KCQlidXR0b25UZXh0OiAiLi4uIiwgLy8gVGV4dCBmb3IgdHJpZ2dlciBidXR0b24NCgkJYnV0dG9uSW1hZ2U6ICIiLCAvLyBVUkwgZm9yIHRyaWdnZXIgYnV0dG9uIGltYWdlDQoJCWJ1dHRvbkltYWdlT25seTogZmFsc2UsIC8vIFRydWUgaWYgdGhlIGltYWdlIGFwcGVhcnMgYWxvbmUsIGZhbHNlIGlmIGl0IGFwcGVhcnMgb24gYSBidXR0b24NCgkJaGlkZUlmTm9QcmV2TmV4dDogZmFsc2UsIC8vIFRydWUgdG8gaGlkZSBuZXh0L3ByZXZpb3VzIG1vbnRoIGxpbmtzDQoJCQkvLyBpZiBub3QgYXBwbGljYWJsZSwgZmFsc2UgdG8ganVzdCBkaXNhYmxlIHRoZW0NCgkJbmF2aWdhdGlvbkFzRGF0ZUZvcm1hdDogZmFsc2UsIC8vIFRydWUgaWYgZGF0ZSBmb3JtYXR0aW5nIGFwcGxpZWQgdG8gcHJldi90b2RheS9uZXh0IGxpbmtzDQoJCWdvdG9DdXJyZW50OiBmYWxzZSwgLy8gVHJ1ZSBpZiB0b2RheSBsaW5rIGdvZXMgYmFjayB0byBjdXJyZW50IHNlbGVjdGlvbiBpbnN0ZWFkDQoJCWNoYW5nZU1vbnRoOiBmYWxzZSwgLy8gVHJ1ZSBpZiBtb250aCBjYW4gYmUgc2VsZWN0ZWQgZGlyZWN0bHksIGZhbHNlIGlmIG9ubHkgcHJldi9uZXh0DQoJCWNoYW5nZVllYXI6IGZhbHNlLCAvLyBUcnVlIGlmIHllYXIgY2FuIGJlIHNlbGVjdGVkIGRpcmVjdGx5LCBmYWxzZSBpZiBvbmx5IHByZXYvbmV4dA0KCQl5ZWFyUmFuZ2U6ICJjLTEwOmMrMTAiLCAvLyBSYW5nZSBvZiB5ZWFycyB0byBkaXNwbGF5IGluIGRyb3AtZG93biwNCgkJCS8vIGVpdGhlciByZWxhdGl2ZSB0byB0b2RheSdzIHllYXIgKC1ubjorbm4pLCByZWxhdGl2ZSB0byBjdXJyZW50bHkgZGlzcGxheWVkIHllYXINCgkJCS8vIChjLW5uOmMrbm4pLCBhYnNvbHV0ZSAobm5ubjpubm5uKSwgb3IgYSBjb21iaW5hdGlvbiBvZiB0aGUgYWJvdmUgKG5ubm46LW4pDQoJCXNob3dPdGhlck1vbnRoczogZmFsc2UsIC8vIFRydWUgdG8gc2hvdyBkYXRlcyBpbiBvdGhlciBtb250aHMsIGZhbHNlIHRvIGxlYXZlIGJsYW5rDQoJCXNlbGVjdE90aGVyTW9udGhzOiBmYWxzZSwgLy8gVHJ1ZSB0byBhbGxvdyBzZWxlY3Rpb24gb2YgZGF0ZXMgaW4gb3RoZXIgbW9udGhzLCBmYWxzZSBmb3IgdW5zZWxlY3RhYmxlDQoJCXNob3dXZWVrOiBmYWxzZSwgLy8gVHJ1ZSB0byBzaG93IHdlZWsgb2YgdGhlIHllYXIsIGZhbHNlIHRvIG5vdCBzaG93IGl0DQoJCWNhbGN1bGF0ZVdlZWs6IHRoaXMuaXNvODYwMVdlZWssIC8vIEhvdyB0byBjYWxjdWxhdGUgdGhlIHdlZWsgb2YgdGhlIHllYXIsDQoJCQkvLyB0YWtlcyBhIERhdGUgYW5kIHJldHVybnMgdGhlIG51bWJlciBvZiB0aGUgd2VlayBmb3IgaXQNCgkJc2hvcnRZZWFyQ3V0b2ZmOiAiKzEwIiwgLy8gU2hvcnQgeWVhciB2YWx1ZXMgPCB0aGlzIGFyZSBpbiB0aGUgY3VycmVudCBjZW50dXJ5LA0KCQkJLy8gPiB0aGlzIGFyZSBpbiB0aGUgcHJldmlvdXMgY2VudHVyeSwNCgkJCS8vIHN0cmluZyB2YWx1ZSBzdGFydGluZyB3aXRoICIrIiBmb3IgY3VycmVudCB5ZWFyICsgdmFsdWUNCgkJbWluRGF0ZTogbnVsbCwgLy8gVGhlIGVhcmxpZXN0IHNlbGVjdGFibGUgZGF0ZSwgb3IgbnVsbCBmb3Igbm8gbGltaXQNCgkJbWF4RGF0ZTogbnVsbCwgLy8gVGhlIGxhdGVzdCBzZWxlY3RhYmxlIGRhdGUsIG9yIG51bGwgZm9yIG5vIGxpbWl0DQoJCWR1cmF0aW9uOiAiZmFzdCIsIC8vIER1cmF0aW9uIG9mIGRpc3BsYXkvY2xvc3VyZQ0KCQliZWZvcmVTaG93RGF5OiBudWxsLCAvLyBGdW5jdGlvbiB0aGF0IHRha2VzIGEgZGF0ZSBhbmQgcmV0dXJucyBhbiBhcnJheSB3aXRoDQoJCQkvLyBbMF0gPSB0cnVlIGlmIHNlbGVjdGFibGUsIGZhbHNlIGlmIG5vdCwgWzFdID0gY3VzdG9tIENTUyBjbGFzcyBuYW1lKHMpIG9yICIiLA0KCQkJLy8gWzJdID0gY2VsbCB0aXRsZSAob3B0aW9uYWwpLCBlLmcuICQuZGF0ZXBpY2tlci5ub1dlZWtlbmRzDQoJCWJlZm9yZVNob3c6IG51bGwsIC8vIEZ1bmN0aW9uIHRoYXQgdGFrZXMgYW4gaW5wdXQgZmllbGQgYW5kDQoJCQkvLyByZXR1cm5zIGEgc2V0IG9mIGN1c3RvbSBzZXR0aW5ncyBmb3IgdGhlIGRhdGUgcGlja2VyDQoJCW9uU2VsZWN0OiBudWxsLCAvLyBEZWZpbmUgYSBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIGEgZGF0ZSBpcyBzZWxlY3RlZA0KCQlvbkNoYW5nZU1vbnRoWWVhcjogbnVsbCwgLy8gRGVmaW5lIGEgY2FsbGJhY2sgZnVuY3Rpb24gd2hlbiB0aGUgbW9udGggb3IgeWVhciBpcyBjaGFuZ2VkDQoJCW9uQ2xvc2U6IG51bGwsIC8vIERlZmluZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gdGhlIGRhdGVwaWNrZXIgaXMgY2xvc2VkDQoJCW51bWJlck9mTW9udGhzOiAxLCAvLyBOdW1iZXIgb2YgbW9udGhzIHRvIHNob3cgYXQgYSB0aW1lDQoJCXNob3dDdXJyZW50QXRQb3M6IDAsIC8vIFRoZSBwb3NpdGlvbiBpbiBtdWx0aXBlIG1vbnRocyBhdCB3aGljaCB0byBzaG93IHRoZSBjdXJyZW50IG1vbnRoIChzdGFydGluZyBhdCAwKQ0KCQlzdGVwTW9udGhzOiAxLCAvLyBOdW1iZXIgb2YgbW9udGhzIHRvIHN0ZXAgYmFjay9mb3J3YXJkDQoJCXN0ZXBCaWdNb250aHM6IDEyLCAvLyBOdW1iZXIgb2YgbW9udGhzIHRvIHN0ZXAgYmFjay9mb3J3YXJkIGZvciB0aGUgYmlnIGxpbmtzDQoJCWFsdEZpZWxkOiAiIiwgLy8gU2VsZWN0b3IgZm9yIGFuIGFsdGVybmF0ZSBmaWVsZCB0byBzdG9yZSBzZWxlY3RlZCBkYXRlcyBpbnRvDQoJCWFsdEZvcm1hdDogIiIsIC8vIFRoZSBkYXRlIGZvcm1hdCB0byB1c2UgZm9yIHRoZSBhbHRlcm5hdGUgZmllbGQNCgkJY29uc3RyYWluSW5wdXQ6IHRydWUsIC8vIFRoZSBpbnB1dCBpcyBjb25zdHJhaW5lZCBieSB0aGUgY3VycmVudCBkYXRlIGZvcm1hdA0KCQlzaG93QnV0dG9uUGFuZWw6IGZhbHNlLCAvLyBUcnVlIHRvIHNob3cgYnV0dG9uIHBhbmVsLCBmYWxzZSB0byBub3Qgc2hvdyBpdA0KCQlhdXRvU2l6ZTogZmFsc2UsIC8vIFRydWUgdG8gc2l6ZSB0aGUgaW5wdXQgZm9yIHRoZSBkYXRlIGZvcm1hdCwgZmFsc2UgdG8gbGVhdmUgYXMgaXMNCgkJZGlzYWJsZWQ6IGZhbHNlIC8vIFRoZSBpbml0aWFsIGRpc2FibGVkIHN0YXRlDQoJfTsNCgkkLmV4dGVuZCggdGhpcy5fZGVmYXVsdHMsIHRoaXMucmVnaW9uYWxbICIiIF0gKTsNCgl0aGlzLnJlZ2lvbmFsLmVuID0gJC5leHRlbmQoIHRydWUsIHt9LCB0aGlzLnJlZ2lvbmFsWyAiIiBdICk7DQoJdGhpcy5yZWdpb25hbFsgImVuLVVTIiBdID0gJC5leHRlbmQoIHRydWUsIHt9LCB0aGlzLnJlZ2lvbmFsLmVuICk7DQoJdGhpcy5kcERpdiA9IGRhdGVwaWNrZXJfYmluZEhvdmVyKCAkKCAiPGRpdiBpZD0nIiArIHRoaXMuX21haW5EaXZJZCArICInIGNsYXNzPSd1aS1kYXRlcGlja2VyIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1oZWxwZXItY2xlYXJmaXggdWktY29ybmVyLWFsbCc+PC9kaXY+IiApICk7DQp9DQoNCiQuZXh0ZW5kKCBEYXRlcGlja2VyLnByb3RvdHlwZSwgew0KCS8qIENsYXNzIG5hbWUgYWRkZWQgdG8gZWxlbWVudHMgdG8gaW5kaWNhdGUgYWxyZWFkeSBjb25maWd1cmVkIHdpdGggYSBkYXRlIHBpY2tlci4gKi8NCgltYXJrZXJDbGFzc05hbWU6ICJoYXNEYXRlcGlja2VyIiwNCg0KCS8vS2VlcCB0cmFjayBvZiB0aGUgbWF4aW11bSBudW1iZXIgb2Ygcm93cyBkaXNwbGF5ZWQgKHNlZSAjNzA0MykNCgltYXhSb3dzOiA0LA0KDQoJLy8gVE9ETyByZW5hbWUgdG8gIndpZGdldCIgd2hlbiBzd2l0Y2hpbmcgdG8gd2lkZ2V0IGZhY3RvcnkNCglfd2lkZ2V0RGF0ZXBpY2tlcjogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLmRwRGl2Ow0KCX0sDQoNCgkvKiBPdmVycmlkZSB0aGUgZGVmYXVsdCBzZXR0aW5ncyBmb3IgYWxsIGluc3RhbmNlcyBvZiB0aGUgZGF0ZSBwaWNrZXIuDQoJICogQHBhcmFtICBzZXR0aW5ncyAgb2JqZWN0IC0gdGhlIG5ldyBzZXR0aW5ncyB0byB1c2UgYXMgZGVmYXVsdHMgKGFub255bW91cyBvYmplY3QpDQoJICogQHJldHVybiB0aGUgbWFuYWdlciBvYmplY3QNCgkgKi8NCglzZXREZWZhdWx0czogZnVuY3Rpb24oIHNldHRpbmdzICkgew0KCQlkYXRlcGlja2VyX2V4dGVuZFJlbW92ZSggdGhpcy5fZGVmYXVsdHMsIHNldHRpbmdzIHx8IHt9ICk7DQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCgkvKiBBdHRhY2ggdGhlIGRhdGUgcGlja2VyIHRvIGEgalF1ZXJ5IHNlbGVjdGlvbi4NCgkgKiBAcGFyYW0gIHRhcmdldAllbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuDQoJICogQHBhcmFtICBzZXR0aW5ncyAgb2JqZWN0IC0gdGhlIG5ldyBzZXR0aW5ncyB0byB1c2UgZm9yIHRoaXMgZGF0ZSBwaWNrZXIgaW5zdGFuY2UgKGFub255bW91cykNCgkgKi8NCglfYXR0YWNoRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgc2V0dGluZ3MgKSB7DQoJCXZhciBub2RlTmFtZSwgaW5saW5lLCBpbnN0Ow0KCQlub2RlTmFtZSA9IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOw0KCQlpbmxpbmUgPSAoIG5vZGVOYW1lID09PSAiZGl2IiB8fCBub2RlTmFtZSA9PT0gInNwYW4iICk7DQoJCWlmICggIXRhcmdldC5pZCApIHsNCgkJCXRoaXMudXVpZCArPSAxOw0KCQkJdGFyZ2V0LmlkID0gImRwIiArIHRoaXMudXVpZDsNCgkJfQ0KCQlpbnN0ID0gdGhpcy5fbmV3SW5zdCggJCggdGFyZ2V0ICksIGlubGluZSApOw0KCQlpbnN0LnNldHRpbmdzID0gJC5leHRlbmQoIHt9LCBzZXR0aW5ncyB8fCB7fSApOw0KCQlpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiICkgew0KCQkJdGhpcy5fY29ubmVjdERhdGVwaWNrZXIoIHRhcmdldCwgaW5zdCApOw0KCQl9IGVsc2UgaWYgKCBpbmxpbmUgKSB7DQoJCQl0aGlzLl9pbmxpbmVEYXRlcGlja2VyKCB0YXJnZXQsIGluc3QgKTsNCgkJfQ0KCX0sDQoNCgkvKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2JqZWN0LiAqLw0KCV9uZXdJbnN0OiBmdW5jdGlvbiggdGFyZ2V0LCBpbmxpbmUgKSB7DQoJCXZhciBpZCA9IHRhcmdldFsgMCBdLmlkLnJlcGxhY2UoIC8oW15BLVphLXowLTlfXC1dKS9nLCAiXFxcXCQxIiApOyAvLyBlc2NhcGUgalF1ZXJ5IG1ldGEgY2hhcnMNCgkJcmV0dXJuIHsgaWQ6IGlkLCBpbnB1dDogdGFyZ2V0LCAvLyBhc3NvY2lhdGVkIHRhcmdldA0KCQkJc2VsZWN0ZWREYXk6IDAsIHNlbGVjdGVkTW9udGg6IDAsIHNlbGVjdGVkWWVhcjogMCwgLy8gY3VycmVudCBzZWxlY3Rpb24NCgkJCWRyYXdNb250aDogMCwgZHJhd1llYXI6IDAsIC8vIG1vbnRoIGJlaW5nIGRyYXduDQoJCQlpbmxpbmU6IGlubGluZSwgLy8gaXMgZGF0ZXBpY2tlciBpbmxpbmUgb3Igbm90DQoJCQlkcERpdjogKCAhaW5saW5lID8gdGhpcy5kcERpdiA6IC8vIHByZXNlbnRhdGlvbiBkaXYNCgkJCWRhdGVwaWNrZXJfYmluZEhvdmVyKCAkKCAiPGRpdiBjbGFzcz0nIiArIHRoaXMuX2lubGluZUNsYXNzICsgIiB1aS1kYXRlcGlja2VyIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1oZWxwZXItY2xlYXJmaXggdWktY29ybmVyLWFsbCc+PC9kaXY+IiApICkgKSB9Ow0KCX0sDQoNCgkvKiBBdHRhY2ggdGhlIGRhdGUgcGlja2VyIHRvIGFuIGlucHV0IGZpZWxkLiAqLw0KCV9jb25uZWN0RGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgaW5zdCApIHsNCgkJdmFyIGlucHV0ID0gJCggdGFyZ2V0ICk7DQoJCWluc3QuYXBwZW5kID0gJCggW10gKTsNCgkJaW5zdC50cmlnZ2VyID0gJCggW10gKTsNCgkJaWYgKCBpbnB1dC5oYXNDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KCQl0aGlzLl9hdHRhY2htZW50cyggaW5wdXQsIGluc3QgKTsNCgkJaW5wdXQuYWRkQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkub24oICJrZXlkb3duIiwgdGhpcy5fZG9LZXlEb3duICkuDQoJCQlvbiggImtleXByZXNzIiwgdGhpcy5fZG9LZXlQcmVzcyApLm9uKCAia2V5dXAiLCB0aGlzLl9kb0tleVVwICk7DQoJCXRoaXMuX2F1dG9TaXplKCBpbnN0ICk7DQoJCSQuZGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIsIGluc3QgKTsNCg0KCQkvL0lmIGRpc2FibGVkIG9wdGlvbiBpcyB0cnVlLCBkaXNhYmxlIHRoZSBkYXRlcGlja2VyIG9uY2UgaXQgaGFzIGJlZW4gYXR0YWNoZWQgdG8gdGhlIGlucHV0IChzZWUgdGlja2V0ICM1NjY1KQ0KCQlpZiAoIGluc3Quc2V0dGluZ3MuZGlzYWJsZWQgKSB7DQoJCQl0aGlzLl9kaXNhYmxlRGF0ZXBpY2tlciggdGFyZ2V0ICk7DQoJCX0NCgl9LA0KDQoJLyogTWFrZSBhdHRhY2htZW50cyBiYXNlZCBvbiBzZXR0aW5ncy4gKi8NCglfYXR0YWNobWVudHM6IGZ1bmN0aW9uKCBpbnB1dCwgaW5zdCApIHsNCgkJdmFyIHNob3dPbiwgYnV0dG9uVGV4dCwgYnV0dG9uSW1hZ2UsDQoJCQlhcHBlbmRUZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiYXBwZW5kVGV4dCIgKSwNCgkJCWlzUlRMID0gdGhpcy5fZ2V0KCBpbnN0LCAiaXNSVEwiICk7DQoNCgkJaWYgKCBpbnN0LmFwcGVuZCApIHsNCgkJCWluc3QuYXBwZW5kLnJlbW92ZSgpOw0KCQl9DQoJCWlmICggYXBwZW5kVGV4dCApIHsNCgkJCWluc3QuYXBwZW5kID0gJCggIjxzcGFuIGNsYXNzPSciICsgdGhpcy5fYXBwZW5kQ2xhc3MgKyAiJz4iICsgYXBwZW5kVGV4dCArICI8L3NwYW4+IiApOw0KCQkJaW5wdXRbIGlzUlRMID8gImJlZm9yZSIgOiAiYWZ0ZXIiIF0oIGluc3QuYXBwZW5kICk7DQoJCX0NCg0KCQlpbnB1dC5vZmYoICJmb2N1cyIsIHRoaXMuX3Nob3dEYXRlcGlja2VyICk7DQoNCgkJaWYgKCBpbnN0LnRyaWdnZXIgKSB7DQoJCQlpbnN0LnRyaWdnZXIucmVtb3ZlKCk7DQoJCX0NCg0KCQlzaG93T24gPSB0aGlzLl9nZXQoIGluc3QsICJzaG93T24iICk7DQoJCWlmICggc2hvd09uID09PSAiZm9jdXMiIHx8IHNob3dPbiA9PT0gImJvdGgiICkgeyAvLyBwb3AtdXAgZGF0ZSBwaWNrZXIgd2hlbiBpbiB0aGUgbWFya2VkIGZpZWxkDQoJCQlpbnB1dC5vbiggImZvY3VzIiwgdGhpcy5fc2hvd0RhdGVwaWNrZXIgKTsNCgkJfQ0KCQlpZiAoIHNob3dPbiA9PT0gImJ1dHRvbiIgfHwgc2hvd09uID09PSAiYm90aCIgKSB7IC8vIHBvcC11cCBkYXRlIHBpY2tlciB3aGVuIGJ1dHRvbiBjbGlja2VkDQoJCQlidXR0b25UZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiYnV0dG9uVGV4dCIgKTsNCgkJCWJ1dHRvbkltYWdlID0gdGhpcy5fZ2V0KCBpbnN0LCAiYnV0dG9uSW1hZ2UiICk7DQoJCQlpbnN0LnRyaWdnZXIgPSAkKCB0aGlzLl9nZXQoIGluc3QsICJidXR0b25JbWFnZU9ubHkiICkgPw0KCQkJCSQoICI8aW1nLz4iICkuYWRkQ2xhc3MoIHRoaXMuX3RyaWdnZXJDbGFzcyApLg0KCQkJCQlhdHRyKCB7IHNyYzogYnV0dG9uSW1hZ2UsIGFsdDogYnV0dG9uVGV4dCwgdGl0bGU6IGJ1dHRvblRleHQgfSApIDoNCgkJCQkkKCAiPGJ1dHRvbiB0eXBlPSdidXR0b24nPjwvYnV0dG9uPiIgKS5hZGRDbGFzcyggdGhpcy5fdHJpZ2dlckNsYXNzICkuDQoJCQkJCWh0bWwoICFidXR0b25JbWFnZSA\/IGJ1dHRvblRleHQgOiAkKCAiPGltZy8+IiApLmF0dHIoDQoJCQkJCXsgc3JjOmJ1dHRvbkltYWdlLCBhbHQ6YnV0dG9uVGV4dCwgdGl0bGU6YnV0dG9uVGV4dCB9ICkgKSApOw0KCQkJaW5wdXRbIGlzUlRMID8gImJlZm9yZSIgOiAiYWZ0ZXIiIF0oIGluc3QudHJpZ2dlciApOw0KCQkJaW5zdC50cmlnZ2VyLm9uKCAiY2xpY2siLCBmdW5jdGlvbigpIHsNCgkJCQlpZiAoICQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgJC5kYXRlcGlja2VyLl9sYXN0SW5wdXQgPT09IGlucHV0WyAwIF0gKSB7DQoJCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsNCgkJCQl9IGVsc2UgaWYgKCAkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nICYmICQuZGF0ZXBpY2tlci5fbGFzdElucHV0ICE9PSBpbnB1dFsgMCBdICkgew0KCQkJCQkkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7DQoJCQkJCSQuZGF0ZXBpY2tlci5fc2hvd0RhdGVwaWNrZXIoIGlucHV0WyAwIF0gKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQkkLmRhdGVwaWNrZXIuX3Nob3dEYXRlcGlja2VyKCBpbnB1dFsgMCBdICk7DQoJCQkJfQ0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0gKTsNCgkJfQ0KCX0sDQoNCgkvKiBBcHBseSB0aGUgbWF4aW11bSBsZW5ndGggZm9yIHRoZSBkYXRlIGZvcm1hdC4gKi8NCglfYXV0b1NpemU6IGZ1bmN0aW9uKCBpbnN0ICkgew0KCQlpZiAoIHRoaXMuX2dldCggaW5zdCwgImF1dG9TaXplIiApICYmICFpbnN0LmlubGluZSApIHsNCgkJCXZhciBmaW5kTWF4LCBtYXgsIG1heEksIGksDQoJCQkJZGF0ZSA9IG5ldyBEYXRlKCAyMDA5LCAxMiAtIDEsIDIwICksIC8vIEVuc3VyZSBkb3VibGUgZGlnaXRzDQoJCQkJZGF0ZUZvcm1hdCA9IHRoaXMuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICk7DQoNCgkJCWlmICggZGF0ZUZvcm1hdC5tYXRjaCggL1tETV0vICkgKSB7DQoJCQkJZmluZE1heCA9IGZ1bmN0aW9uKCBuYW1lcyApIHsNCgkJCQkJbWF4ID0gMDsNCgkJCQkJbWF4SSA9IDA7DQoJCQkJCWZvciAoIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKysgKSB7DQoJCQkJCQlpZiAoIG5hbWVzWyBpIF0ubGVuZ3RoID4gbWF4ICkgew0KCQkJCQkJCW1heCA9IG5hbWVzWyBpIF0ubGVuZ3RoOw0KCQkJCQkJCW1heEkgPSBpOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCXJldHVybiBtYXhJOw0KCQkJCX07DQoJCQkJZGF0ZS5zZXRNb250aCggZmluZE1heCggdGhpcy5fZ2V0KCBpbnN0LCAoIGRhdGVGb3JtYXQubWF0Y2goIC9NTS8gKSA\/DQoJCQkJCSJtb250aE5hbWVzIiA6ICJtb250aE5hbWVzU2hvcnQiICkgKSApICk7DQoJCQkJZGF0ZS5zZXREYXRlKCBmaW5kTWF4KCB0aGlzLl9nZXQoIGluc3QsICggZGF0ZUZvcm1hdC5tYXRjaCggL0RELyApID8NCgkJCQkJImRheU5hbWVzIiA6ICJkYXlOYW1lc1Nob3J0IiApICkgKSArIDIwIC0gZGF0ZS5nZXREYXkoKSApOw0KCQkJfQ0KCQkJaW5zdC5pbnB1dC5hdHRyKCAic2l6ZSIsIHRoaXMuX2Zvcm1hdERhdGUoIGluc3QsIGRhdGUgKS5sZW5ndGggKTsNCgkJfQ0KCX0sDQoNCgkvKiBBdHRhY2ggYW4gaW5saW5lIGRhdGUgcGlja2VyIHRvIGEgZGl2LiAqLw0KCV9pbmxpbmVEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0LCBpbnN0ICkgew0KCQl2YXIgZGl2U3BhbiA9ICQoIHRhcmdldCApOw0KCQlpZiAoIGRpdlNwYW4uaGFzQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkgKSB7DQoJCQlyZXR1cm47DQoJCX0NCgkJZGl2U3Bhbi5hZGRDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKS5hcHBlbmQoIGluc3QuZHBEaXYgKTsNCgkJJC5kYXRhKCB0YXJnZXQsICJkYXRlcGlja2VyIiwgaW5zdCApOw0KCQl0aGlzLl9zZXREYXRlKCBpbnN0LCB0aGlzLl9nZXREZWZhdWx0RGF0ZSggaW5zdCApLCB0cnVlICk7DQoJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsNCgkJdGhpcy5fdXBkYXRlQWx0ZXJuYXRlKCBpbnN0ICk7DQoNCgkJLy9JZiBkaXNhYmxlZCBvcHRpb24gaXMgdHJ1ZSwgZGlzYWJsZSB0aGUgZGF0ZXBpY2tlciBiZWZvcmUgc2hvd2luZyBpdCAoc2VlIHRpY2tldCAjNTY2NSkNCgkJaWYgKCBpbnN0LnNldHRpbmdzLmRpc2FibGVkICkgew0KCQkJdGhpcy5fZGlzYWJsZURhdGVwaWNrZXIoIHRhcmdldCApOw0KCQl9DQoNCgkJLy8gU2V0IGRpc3BsYXk6YmxvY2sgaW4gcGxhY2Ugb2YgaW5zdC5kcERpdi5zaG93KCkgd2hpY2ggd29uJ3Qgd29yayBvbiBkaXNjb25uZWN0ZWQgZWxlbWVudHMNCgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5dWkuY29tL3RpY2tldC83NTUyIC0gQSBEYXRlcGlja2VyIGNyZWF0ZWQgb24gYSBkZXRhY2hlZCBkaXYgaGFzIHplcm8gaGVpZ2h0DQoJCWluc3QuZHBEaXYuY3NzKCAiZGlzcGxheSIsICJibG9jayIgKTsNCgl9LA0KDQoJLyogUG9wLXVwIHRoZSBkYXRlIHBpY2tlciBpbiBhICJkaWFsb2ciIGJveC4NCgkgKiBAcGFyYW0gIGlucHV0IGVsZW1lbnQgLSBpZ25vcmVkDQoJICogQHBhcmFtICBkYXRlCXN0cmluZyBvciBEYXRlIC0gdGhlIGluaXRpYWwgZGF0ZSB0byBkaXNwbGF5DQoJICogQHBhcmFtICBvblNlbGVjdCAgZnVuY3Rpb24gLSB0aGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIGEgZGF0ZSBpcyBzZWxlY3RlZA0KCSAqIEBwYXJhbSAgc2V0dGluZ3MgIG9iamVjdCAtIHVwZGF0ZSB0aGUgZGlhbG9nIGRhdGUgcGlja2VyIGluc3RhbmNlJ3Mgc2V0dGluZ3MgKGFub255bW91cyBvYmplY3QpDQoJICogQHBhcmFtICBwb3MgaW50WzJdIC0gY29vcmRpbmF0ZXMgZm9yIHRoZSBkaWFsb2cncyBwb3NpdGlvbiB3aXRoaW4gdGhlIHNjcmVlbiBvcg0KCSAqCQkJCQlldmVudCAtIHdpdGggeC95IGNvb3JkaW5hdGVzIG9yDQoJICoJCQkJCWxlYXZlIGVtcHR5IGZvciBkZWZhdWx0IChzY3JlZW4gY2VudHJlKQ0KCSAqIEByZXR1cm4gdGhlIG1hbmFnZXIgb2JqZWN0DQoJICovDQoJX2RpYWxvZ0RhdGVwaWNrZXI6IGZ1bmN0aW9uKCBpbnB1dCwgZGF0ZSwgb25TZWxlY3QsIHNldHRpbmdzLCBwb3MgKSB7DQoJCXZhciBpZCwgYnJvd3NlcldpZHRoLCBicm93c2VySGVpZ2h0LCBzY3JvbGxYLCBzY3JvbGxZLA0KCQkJaW5zdCA9IHRoaXMuX2RpYWxvZ0luc3Q7IC8vIGludGVybmFsIGluc3RhbmNlDQoNCgkJaWYgKCAhaW5zdCApIHsNCgkJCXRoaXMudXVpZCArPSAxOw0KCQkJaWQgPSAiZHAiICsgdGhpcy51dWlkOw0KCQkJdGhpcy5fZGlhbG9nSW5wdXQgPSAkKCAiPGlucHV0IHR5cGU9J3RleHQnIGlkPSciICsgaWQgKw0KCQkJCSInIHN0eWxlPSdwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogLTEwMHB4OyB3aWR0aDogMHB4OycvPiIgKTsNCgkJCXRoaXMuX2RpYWxvZ0lucHV0Lm9uKCAia2V5ZG93biIsIHRoaXMuX2RvS2V5RG93biApOw0KCQkJJCggImJvZHkiICkuYXBwZW5kKCB0aGlzLl9kaWFsb2dJbnB1dCApOw0KCQkJaW5zdCA9IHRoaXMuX2RpYWxvZ0luc3QgPSB0aGlzLl9uZXdJbnN0KCB0aGlzLl9kaWFsb2dJbnB1dCwgZmFsc2UgKTsNCgkJCWluc3Quc2V0dGluZ3MgPSB7fTsNCgkJCSQuZGF0YSggdGhpcy5fZGlhbG9nSW5wdXRbIDAgXSwgImRhdGVwaWNrZXIiLCBpbnN0ICk7DQoJCX0NCgkJZGF0ZXBpY2tlcl9leHRlbmRSZW1vdmUoIGluc3Quc2V0dGluZ3MsIHNldHRpbmdzIHx8IHt9ICk7DQoJCWRhdGUgPSAoIGRhdGUgJiYgZGF0ZS5jb25zdHJ1Y3RvciA9PT0gRGF0ZSA\/IHRoaXMuX2Zvcm1hdERhdGUoIGluc3QsIGRhdGUgKSA6IGRhdGUgKTsNCgkJdGhpcy5fZGlhbG9nSW5wdXQudmFsKCBkYXRlICk7DQoNCgkJdGhpcy5fcG9zID0gKCBwb3MgPyAoIHBvcy5sZW5ndGggPyBwb3MgOiBbIHBvcy5wYWdlWCwgcG9zLnBhZ2VZIF0gKSA6IG51bGwgKTsNCgkJaWYgKCAhdGhpcy5fcG9zICkgew0KCQkJYnJvd3NlcldpZHRoID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoOw0KCQkJYnJvd3NlckhlaWdodCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQ7DQoJCQlzY3JvbGxYID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0Ow0KCQkJc2Nyb2xsWSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7DQoJCQl0aGlzLl9wb3MgPSAvLyBzaG91bGQgdXNlIGFjdHVhbCB3aWR0aC9oZWlnaHQgYmVsb3cNCgkJCQlbICggYnJvd3NlcldpZHRoIC8gMiApIC0gMTAwICsgc2Nyb2xsWCwgKCBicm93c2VySGVpZ2h0IC8gMiApIC0gMTUwICsgc2Nyb2xsWSBdOw0KCQl9DQoNCgkJLy8gTW92ZSBpbnB1dCBvbiBzY3JlZW4gZm9yIGZvY3VzLCBidXQgaGlkZGVuIGJlaGluZCBkaWFsb2cNCgkJdGhpcy5fZGlhbG9nSW5wdXQuY3NzKCAibGVmdCIsICggdGhpcy5fcG9zWyAwIF0gKyAyMCApICsgInB4IiApLmNzcyggInRvcCIsIHRoaXMuX3Bvc1sgMSBdICsgInB4IiApOw0KCQlpbnN0LnNldHRpbmdzLm9uU2VsZWN0ID0gb25TZWxlY3Q7DQoJCXRoaXMuX2luRGlhbG9nID0gdHJ1ZTsNCgkJdGhpcy5kcERpdi5hZGRDbGFzcyggdGhpcy5fZGlhbG9nQ2xhc3MgKTsNCgkJdGhpcy5fc2hvd0RhdGVwaWNrZXIoIHRoaXMuX2RpYWxvZ0lucHV0WyAwIF0gKTsNCgkJaWYgKCAkLmJsb2NrVUkgKSB7DQoJCQkkLmJsb2NrVUkoIHRoaXMuZHBEaXYgKTsNCgkJfQ0KCQkkLmRhdGEoIHRoaXMuX2RpYWxvZ0lucHV0WyAwIF0sICJkYXRlcGlja2VyIiwgaW5zdCApOw0KCQlyZXR1cm4gdGhpczsNCgl9LA0KDQoJLyogRGV0YWNoIGEgZGF0ZXBpY2tlciBmcm9tIGl0cyBjb250cm9sLg0KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4NCgkgKi8NCglfZGVzdHJveURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7DQoJCXZhciBub2RlTmFtZSwNCgkJCSR0YXJnZXQgPSAkKCB0YXJnZXQgKSwNCgkJCWluc3QgPSAkLmRhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiICk7DQoNCgkJaWYgKCAhJHRhcmdldC5oYXNDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCW5vZGVOYW1lID0gdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7DQoJCSQucmVtb3ZlRGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIgKTsNCgkJaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiApIHsNCgkJCWluc3QuYXBwZW5kLnJlbW92ZSgpOw0KCQkJaW5zdC50cmlnZ2VyLnJlbW92ZSgpOw0KCQkJJHRhcmdldC5yZW1vdmVDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKS4NCgkJCQlvZmYoICJmb2N1cyIsIHRoaXMuX3Nob3dEYXRlcGlja2VyICkuDQoJCQkJb2ZmKCAia2V5ZG93biIsIHRoaXMuX2RvS2V5RG93biApLg0KCQkJCW9mZiggImtleXByZXNzIiwgdGhpcy5fZG9LZXlQcmVzcyApLg0KCQkJCW9mZiggImtleXVwIiwgdGhpcy5fZG9LZXlVcCApOw0KCQl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImRpdiIgfHwgbm9kZU5hbWUgPT09ICJzcGFuIiApIHsNCgkJCSR0YXJnZXQucmVtb3ZlQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkuZW1wdHkoKTsNCgkJfQ0KDQoJCWlmICggZGF0ZXBpY2tlcl9pbnN0QWN0aXZlID09PSBpbnN0ICkgew0KCQkJZGF0ZXBpY2tlcl9pbnN0QWN0aXZlID0gbnVsbDsNCgkJfQ0KCX0sDQoNCgkvKiBFbmFibGUgdGhlIGRhdGUgcGlja2VyIHRvIGEgalF1ZXJ5IHNlbGVjdGlvbi4NCgkgKiBAcGFyYW0gIHRhcmdldAllbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuDQoJICovDQoJX2VuYWJsZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7DQoJCXZhciBub2RlTmFtZSwgaW5saW5lLA0KCQkJJHRhcmdldCA9ICQoIHRhcmdldCApLA0KCQkJaW5zdCA9ICQuZGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIgKTsNCg0KCQlpZiAoICEkdGFyZ2V0Lmhhc0NsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJbm9kZU5hbWUgPSB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCgkJaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiApIHsNCgkJCXRhcmdldC5kaXNhYmxlZCA9IGZhbHNlOw0KCQkJaW5zdC50cmlnZ2VyLmZpbHRlciggImJ1dHRvbiIgKS4NCgkJCQllYWNoKCBmdW5jdGlvbigpIHsgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOyB9ICkuZW5kKCkuDQoJCQkJZmlsdGVyKCAiaW1nIiApLmNzcyggeyBvcGFjaXR5OiAiMS4wIiwgY3Vyc29yOiAiIiB9ICk7DQoJCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiZGl2IiB8fCBub2RlTmFtZSA9PT0gInNwYW4iICkgew0KCQkJaW5saW5lID0gJHRhcmdldC5jaGlsZHJlbiggIi4iICsgdGhpcy5faW5saW5lQ2xhc3MgKTsNCgkJCWlubGluZS5jaGlsZHJlbigpLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7DQoJCQlpbmxpbmUuZmluZCggInNlbGVjdC51aS1kYXRlcGlja2VyLW1vbnRoLCBzZWxlY3QudWktZGF0ZXBpY2tlci15ZWFyIiApLg0KCQkJCXByb3AoICJkaXNhYmxlZCIsIGZhbHNlICk7DQoJCX0NCgkJdGhpcy5fZGlzYWJsZWRJbnB1dHMgPSAkLm1hcCggdGhpcy5fZGlzYWJsZWRJbnB1dHMsDQoJCQlmdW5jdGlvbiggdmFsdWUgKSB7IHJldHVybiAoIHZhbHVlID09PSB0YXJnZXQgPyBudWxsIDogdmFsdWUgKTsgfSApOyAvLyBkZWxldGUgZW50cnkNCgl9LA0KDQoJLyogRGlzYWJsZSB0aGUgZGF0ZSBwaWNrZXIgdG8gYSBqUXVlcnkgc2VsZWN0aW9uLg0KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4NCgkgKi8NCglfZGlzYWJsZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7DQoJCXZhciBub2RlTmFtZSwgaW5saW5lLA0KCQkJJHRhcmdldCA9ICQoIHRhcmdldCApLA0KCQkJaW5zdCA9ICQuZGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIgKTsNCg0KCQlpZiAoICEkdGFyZ2V0Lmhhc0NsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJbm9kZU5hbWUgPSB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsNCgkJaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiApIHsNCgkJCXRhcmdldC5kaXNhYmxlZCA9IHRydWU7DQoJCQlpbnN0LnRyaWdnZXIuZmlsdGVyKCAiYnV0dG9uIiApLg0KCQkJCWVhY2goIGZ1bmN0aW9uKCkgeyB0aGlzLmRpc2FibGVkID0gdHJ1ZTsgfSApLmVuZCgpLg0KCQkJCWZpbHRlciggImltZyIgKS5jc3MoIHsgb3BhY2l0eTogIjAuNSIsIGN1cnNvcjogImRlZmF1bHQiIH0gKTsNCgkJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJkaXYiIHx8IG5vZGVOYW1lID09PSAic3BhbiIgKSB7DQoJCQlpbmxpbmUgPSAkdGFyZ2V0LmNoaWxkcmVuKCAiLiIgKyB0aGlzLl9pbmxpbmVDbGFzcyApOw0KCQkJaW5saW5lLmNoaWxkcmVuKCkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsNCgkJCWlubGluZS5maW5kKCAic2VsZWN0LnVpLWRhdGVwaWNrZXItbW9udGgsIHNlbGVjdC51aS1kYXRlcGlja2VyLXllYXIiICkuDQoJCQkJcHJvcCggImRpc2FibGVkIiwgdHJ1ZSApOw0KCQl9DQoJCXRoaXMuX2Rpc2FibGVkSW5wdXRzID0gJC5tYXAoIHRoaXMuX2Rpc2FibGVkSW5wdXRzLA0KCQkJZnVuY3Rpb24oIHZhbHVlICkgeyByZXR1cm4gKCB2YWx1ZSA9PT0gdGFyZ2V0ID8gbnVsbCA6IHZhbHVlICk7IH0gKTsgLy8gZGVsZXRlIGVudHJ5DQoJCXRoaXMuX2Rpc2FibGVkSW5wdXRzWyB0aGlzLl9kaXNhYmxlZElucHV0cy5sZW5ndGggXSA9IHRhcmdldDsNCgl9LA0KDQoJLyogSXMgdGhlIGZpcnN0IGZpZWxkIGluIGEgalF1ZXJ5IGNvbGxlY3Rpb24gZGlzYWJsZWQgYXMgYSBkYXRlcGlja2VyPw0KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4NCgkgKiBAcmV0dXJuIGJvb2xlYW4gLSB0cnVlIGlmIGRpc2FibGVkLCBmYWxzZSBpZiBlbmFibGVkDQoJICovDQoJX2lzRGlzYWJsZWREYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0ICkgew0KCQlpZiAoICF0YXJnZXQgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCgkJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5fZGlzYWJsZWRJbnB1dHMubGVuZ3RoOyBpKysgKSB7DQoJCQlpZiAoIHRoaXMuX2Rpc2FibGVkSW5wdXRzWyBpIF0gPT09IHRhcmdldCApIHsNCgkJCQlyZXR1cm4gdHJ1ZTsNCgkJCX0NCgkJfQ0KCQlyZXR1cm4gZmFsc2U7DQoJfSwNCg0KCS8qIFJldHJpZXZlIHRoZSBpbnN0YW5jZSBkYXRhIGZvciB0aGUgdGFyZ2V0IGNvbnRyb2wuDQoJICogQHBhcmFtICB0YXJnZXQgIGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4NCgkgKiBAcmV0dXJuICBvYmplY3QgLSB0aGUgYXNzb2NpYXRlZCBpbnN0YW5jZSBkYXRhDQoJICogQHRocm93cyAgZXJyb3IgaWYgYSBqUXVlcnkgcHJvYmxlbSBnZXR0aW5nIGRhdGENCgkgKi8NCglfZ2V0SW5zdDogZnVuY3Rpb24oIHRhcmdldCApIHsNCgkJdHJ5IHsNCgkJCXJldHVybiAkLmRhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiICk7DQoJCX0NCgkJY2F0Y2ggKCBlcnIgKSB7DQoJCQl0aHJvdyAiTWlzc2luZyBpbnN0YW5jZSBkYXRhIGZvciB0aGlzIGRhdGVwaWNrZXIiOw0KCQl9DQoJfSwNCg0KCS8qIFVwZGF0ZSBvciByZXRyaWV2ZSB0aGUgc2V0dGluZ3MgZm9yIGEgZGF0ZSBwaWNrZXIgYXR0YWNoZWQgdG8gYW4gaW5wdXQgZmllbGQgb3IgZGl2aXNpb24uDQoJICogQHBhcmFtICB0YXJnZXQgIGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4NCgkgKiBAcGFyYW0gIG5hbWUJb2JqZWN0IC0gdGhlIG5ldyBzZXR0aW5ncyB0byB1cGRhdGUgb3INCgkgKgkJCQlzdHJpbmcgLSB0aGUgbmFtZSBvZiB0aGUgc2V0dGluZyB0byBjaGFuZ2Ugb3IgcmV0cmlldmUsDQoJICoJCQkJd2hlbiByZXRyaWV2aW5nIGFsc28gImFsbCIgZm9yIGFsbCBpbnN0YW5jZSBzZXR0aW5ncyBvcg0KCSAqCQkJCSJkZWZhdWx0cyIgZm9yIGFsbCBnbG9iYWwgZGVmYXVsdHMNCgkgKiBAcGFyYW0gIHZhbHVlICAgYW55IC0gdGhlIG5ldyB2YWx1ZSBmb3IgdGhlIHNldHRpbmcNCgkgKgkJCQkob21pdCBpZiBhYm92ZSBpcyBhbiBvYmplY3Qgb3IgdG8gcmV0cmlldmUgYSB2YWx1ZSkNCgkgKi8NCglfb3B0aW9uRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgbmFtZSwgdmFsdWUgKSB7DQoJCXZhciBzZXR0aW5ncywgZGF0ZSwgbWluRGF0ZSwgbWF4RGF0ZSwNCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXQgKTsNCg0KCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciICkgew0KCQkJcmV0dXJuICggbmFtZSA9PT0gImRlZmF1bHRzIiA\/ICQuZXh0ZW5kKCB7fSwgJC5kYXRlcGlja2VyLl9kZWZhdWx0cyApIDoNCgkJCQkoIGluc3QgPyAoIG5hbWUgPT09ICJhbGwiID8gJC5leHRlbmQoIHt9LCBpbnN0LnNldHRpbmdzICkgOg0KCQkJCXRoaXMuX2dldCggaW5zdCwgbmFtZSApICkgOiBudWxsICkgKTsNCgkJfQ0KDQoJCXNldHRpbmdzID0gbmFtZSB8fCB7fTsNCgkJaWYgKCB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgKSB7DQoJCQlzZXR0aW5ncyA9IHt9Ow0KCQkJc2V0dGluZ3NbIG5hbWUgXSA9IHZhbHVlOw0KCQl9DQoNCgkJaWYgKCBpbnN0ICkgew0KCQkJaWYgKCB0aGlzLl9jdXJJbnN0ID09PSBpbnN0ICkgew0KCQkJCXRoaXMuX2hpZGVEYXRlcGlja2VyKCk7DQoJCQl9DQoNCgkJCWRhdGUgPSB0aGlzLl9nZXREYXRlRGF0ZXBpY2tlciggdGFyZ2V0LCB0cnVlICk7DQoJCQltaW5EYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZSggaW5zdCwgIm1pbiIgKTsNCgkJCW1heERhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKCBpbnN0LCAibWF4IiApOw0KCQkJZGF0ZXBpY2tlcl9leHRlbmRSZW1vdmUoIGluc3Quc2V0dGluZ3MsIHNldHRpbmdzICk7DQoNCgkJCS8vIHJlZm9ybWF0IHRoZSBvbGQgbWluRGF0ZS9tYXhEYXRlIHZhbHVlcyBpZiBkYXRlRm9ybWF0IGNoYW5nZXMgYW5kIGEgbmV3IG1pbkRhdGUvbWF4RGF0ZSBpc24ndCBwcm92aWRlZA0KCQkJaWYgKCBtaW5EYXRlICE9PSBudWxsICYmIHNldHRpbmdzLmRhdGVGb3JtYXQgIT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy5taW5EYXRlID09PSB1bmRlZmluZWQgKSB7DQoJCQkJaW5zdC5zZXR0aW5ncy5taW5EYXRlID0gdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwgbWluRGF0ZSApOw0KCQkJfQ0KCQkJaWYgKCBtYXhEYXRlICE9PSBudWxsICYmIHNldHRpbmdzLmRhdGVGb3JtYXQgIT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy5tYXhEYXRlID09PSB1bmRlZmluZWQgKSB7DQoJCQkJaW5zdC5zZXR0aW5ncy5tYXhEYXRlID0gdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwgbWF4RGF0ZSApOw0KCQkJfQ0KCQkJaWYgKCAiZGlzYWJsZWQiIGluIHNldHRpbmdzICkgew0KCQkJCWlmICggc2V0dGluZ3MuZGlzYWJsZWQgKSB7DQoJCQkJCXRoaXMuX2Rpc2FibGVEYXRlcGlja2VyKCB0YXJnZXQgKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQl0aGlzLl9lbmFibGVEYXRlcGlja2VyKCB0YXJnZXQgKTsNCgkJCQl9DQoJCQl9DQoJCQl0aGlzLl9hdHRhY2htZW50cyggJCggdGFyZ2V0ICksIGluc3QgKTsNCgkJCXRoaXMuX2F1dG9TaXplKCBpbnN0ICk7DQoJCQl0aGlzLl9zZXREYXRlKCBpbnN0LCBkYXRlICk7DQoJCQl0aGlzLl91cGRhdGVBbHRlcm5hdGUoIGluc3QgKTsNCgkJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsNCgkJfQ0KCX0sDQoNCgkvLyBDaGFuZ2UgbWV0aG9kIGRlcHJlY2F0ZWQNCglfY2hhbmdlRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgbmFtZSwgdmFsdWUgKSB7DQoJCXRoaXMuX29wdGlvbkRhdGVwaWNrZXIoIHRhcmdldCwgbmFtZSwgdmFsdWUgKTsNCgl9LA0KDQoJLyogUmVkcmF3IHRoZSBkYXRlIHBpY2tlciBhdHRhY2hlZCB0byBhbiBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbi4NCgkgKiBAcGFyYW0gIHRhcmdldCAgZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3Bhbg0KCSAqLw0KCV9yZWZyZXNoRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCApIHsNCgkJdmFyIGluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXQgKTsNCgkJaWYgKCBpbnN0ICkgew0KCQkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOw0KCQl9DQoJfSwNCg0KCS8qIFNldCB0aGUgZGF0ZXMgZm9yIGEgalF1ZXJ5IHNlbGVjdGlvbi4NCgkgKiBAcGFyYW0gIHRhcmdldCBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuDQoJICogQHBhcmFtICBkYXRlCURhdGUgLSB0aGUgbmV3IGRhdGUNCgkgKi8NCglfc2V0RGF0ZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQsIGRhdGUgKSB7DQoJCXZhciBpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0ICk7DQoJCWlmICggaW5zdCApIHsNCgkJCXRoaXMuX3NldERhdGUoIGluc3QsIGRhdGUgKTsNCgkJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsNCgkJCXRoaXMuX3VwZGF0ZUFsdGVybmF0ZSggaW5zdCApOw0KCQl9DQoJfSwNCg0KCS8qIEdldCB0aGUgZGF0ZShzKSBmb3IgdGhlIGZpcnN0IGVudHJ5IGluIGEgalF1ZXJ5IHNlbGVjdGlvbi4NCgkgKiBAcGFyYW0gIHRhcmdldCBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuDQoJICogQHBhcmFtICBub0RlZmF1bHQgYm9vbGVhbiAtIHRydWUgaWYgbm8gZGVmYXVsdCBkYXRlIGlzIHRvIGJlIHVzZWQNCgkgKiBAcmV0dXJuIERhdGUgLSB0aGUgY3VycmVudCBkYXRlDQoJICovDQoJX2dldERhdGVEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0LCBub0RlZmF1bHQgKSB7DQoJCXZhciBpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0ICk7DQoJCWlmICggaW5zdCAmJiAhaW5zdC5pbmxpbmUgKSB7DQoJCQl0aGlzLl9zZXREYXRlRnJvbUZpZWxkKCBpbnN0LCBub0RlZmF1bHQgKTsNCgkJfQ0KCQlyZXR1cm4gKCBpbnN0ID8gdGhpcy5fZ2V0RGF0ZSggaW5zdCApIDogbnVsbCApOw0KCX0sDQoNCgkvKiBIYW5kbGUga2V5c3Ryb2tlcy4gKi8NCglfZG9LZXlEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBvblNlbGVjdCwgZGF0ZVN0ciwgc2VsLA0KCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggZXZlbnQudGFyZ2V0ICksDQoJCQloYW5kbGVkID0gdHJ1ZSwNCgkJCWlzUlRMID0gaW5zdC5kcERpdi5pcyggIi51aS1kYXRlcGlja2VyLXJ0bCIgKTsNCg0KCQlpbnN0Ll9rZXlFdmVudCA9IHRydWU7DQoJCWlmICggJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyApIHsNCgkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7DQoJCQkJY2FzZSA5OiAkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7DQoJCQkJCQloYW5kbGVkID0gZmFsc2U7DQoJCQkJCQlicmVhazsgLy8gaGlkZSBvbiB0YWIgb3V0DQoJCQkJY2FzZSAxMzogc2VsID0gJCggInRkLiIgKyAkLmRhdGVwaWNrZXIuX2RheU92ZXJDbGFzcyArICI6bm90KC4iICsNCgkJCQkJCQkJCSQuZGF0ZXBpY2tlci5fY3VycmVudENsYXNzICsgIikiLCBpbnN0LmRwRGl2ICk7DQoJCQkJCQlpZiAoIHNlbFsgMCBdICkgew0KCQkJCQkJCSQuZGF0ZXBpY2tlci5fc2VsZWN0RGF5KCBldmVudC50YXJnZXQsIGluc3Quc2VsZWN0ZWRNb250aCwgaW5zdC5zZWxlY3RlZFllYXIsIHNlbFsgMCBdICk7DQoJCQkJCQl9DQoNCgkJCQkJCW9uU2VsZWN0ID0gJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJvblNlbGVjdCIgKTsNCgkJCQkJCWlmICggb25TZWxlY3QgKSB7DQoJCQkJCQkJZGF0ZVN0ciA9ICQuZGF0ZXBpY2tlci5fZm9ybWF0RGF0ZSggaW5zdCApOw0KDQoJCQkJCQkJLy8gVHJpZ2dlciBjdXN0b20gY2FsbGJhY2sNCgkJCQkJCQlvblNlbGVjdC5hcHBseSggKCBpbnN0LmlucHV0ID8gaW5zdC5pbnB1dFsgMCBdIDogbnVsbCApLCBbIGRhdGVTdHIsIGluc3QgXSApOw0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7DQoJCQkJCQl9DQoNCgkJCQkJCXJldHVybiBmYWxzZTsgLy8gZG9uJ3Qgc3VibWl0IHRoZSBmb3JtDQoJCQkJY2FzZSAyNzogJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOw0KCQkJCQkJYnJlYWs7IC8vIGhpZGUgb24gZXNjYXBlDQoJCQkJY2FzZSAzMzogJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggZXZlbnQuY3RybEtleSA\/DQoJCQkJCQkJLSQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcEJpZ01vbnRocyIgKSA6DQoJCQkJCQkJLSQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcE1vbnRocyIgKSApLCAiTSIgKTsNCgkJCQkJCWJyZWFrOyAvLyBwcmV2aW91cyBtb250aC95ZWFyIG9uIHBhZ2UgdXAvKyBjdHJsDQoJCQkJY2FzZSAzNDogJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggZXZlbnQuY3RybEtleSA\/DQoJCQkJCQkJKyQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcEJpZ01vbnRocyIgKSA6DQoJCQkJCQkJKyQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcE1vbnRocyIgKSApLCAiTSIgKTsNCgkJCQkJCWJyZWFrOyAvLyBuZXh0IG1vbnRoL3llYXIgb24gcGFnZSBkb3duLysgY3RybA0KCQkJCWNhc2UgMzU6IGlmICggZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5ICkgew0KCQkJCQkJCSQuZGF0ZXBpY2tlci5fY2xlYXJEYXRlKCBldmVudC50YXJnZXQgKTsNCgkJCQkJCX0NCgkJCQkJCWhhbmRsZWQgPSBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXk7DQoJCQkJCQlicmVhazsgLy8gY2xlYXIgb24gY3RybCBvciBjb21tYW5kICtlbmQNCgkJCQljYXNlIDM2OiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsNCgkJCQkJCQkkLmRhdGVwaWNrZXIuX2dvdG9Ub2RheSggZXZlbnQudGFyZ2V0ICk7DQoJCQkJCQl9DQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5Ow0KCQkJCQkJYnJlYWs7IC8vIGN1cnJlbnQgb24gY3RybCBvciBjb21tYW5kICtob21lDQoJCQkJY2FzZSAzNzogaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgKSB7DQoJCQkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggaXNSVEwgPyArMSA6IC0xICksICJEIiApOw0KCQkJCQkJfQ0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsNCg0KCQkJCQkJLy8gLTEgZGF5IG9uIGN0cmwgb3IgY29tbWFuZCArbGVmdA0KCQkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50LmFsdEtleSApIHsNCgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKCBldmVudC5jdHJsS2V5ID8NCgkJCQkJCQkJLSQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcEJpZ01vbnRocyIgKSA6DQoJCQkJCQkJCS0kLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICkgKSwgIk0iICk7DQoJCQkJCQl9DQoNCgkJCQkJCS8vIG5leHQgbW9udGgveWVhciBvbiBhbHQgK2xlZnQgb24gTWFjDQoJCQkJCQlicmVhazsNCgkJCQljYXNlIDM4OiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsNCgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgLTcsICJEIiApOw0KCQkJCQkJfQ0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsNCgkJCQkJCWJyZWFrOyAvLyAtMSB3ZWVrIG9uIGN0cmwgb3IgY29tbWFuZCArdXANCgkJCQljYXNlIDM5OiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsNCgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKCBpc1JUTCA\/IC0xIDogKzEgKSwgIkQiICk7DQoJCQkJCQl9DQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5Ow0KDQoJCQkJCQkvLyArMSBkYXkgb24gY3RybCBvciBjb21tYW5kICtyaWdodA0KCQkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50LmFsdEtleSApIHsNCgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKCBldmVudC5jdHJsS2V5ID8NCgkJCQkJCQkJKyQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcEJpZ01vbnRocyIgKSA6DQoJCQkJCQkJCSskLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICkgKSwgIk0iICk7DQoJCQkJCQl9DQoNCgkJCQkJCS8vIG5leHQgbW9udGgveWVhciBvbiBhbHQgK3JpZ2h0DQoJCQkJCQlicmVhazsNCgkJCQljYXNlIDQwOiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsNCgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKzcsICJEIiApOw0KCQkJCQkJfQ0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsNCgkJCQkJCWJyZWFrOyAvLyArMSB3ZWVrIG9uIGN0cmwgb3IgY29tbWFuZCArZG93bg0KCQkJCWRlZmF1bHQ6IGhhbmRsZWQgPSBmYWxzZTsNCgkJCX0NCgkJfSBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PT0gMzYgJiYgZXZlbnQuY3RybEtleSApIHsgLy8gZGlzcGxheSB0aGUgZGF0ZSBwaWNrZXIgb24gY3RybCtob21lDQoJCQkkLmRhdGVwaWNrZXIuX3Nob3dEYXRlcGlja2VyKCB0aGlzICk7DQoJCX0gZWxzZSB7DQoJCQloYW5kbGVkID0gZmFsc2U7DQoJCX0NCg0KCQlpZiAoIGhhbmRsZWQgKSB7DQoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7DQoJCX0NCgl9LA0KDQoJLyogRmlsdGVyIGVudGVyZWQgY2hhcmFjdGVycyAtIGJhc2VkIG9uIGRhdGUgZm9ybWF0LiAqLw0KCV9kb0tleVByZXNzOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBjaGFycywgY2hyLA0KCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggZXZlbnQudGFyZ2V0ICk7DQoNCgkJaWYgKCAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgImNvbnN0cmFpbklucHV0IiApICkgew0KCQkJY2hhcnMgPSAkLmRhdGVwaWNrZXIuX3Bvc3NpYmxlQ2hhcnMoICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAiZGF0ZUZvcm1hdCIgKSApOw0KCQkJY2hyID0gU3RyaW5nLmZyb21DaGFyQ29kZSggZXZlbnQuY2hhckNvZGUgPT0gbnVsbCA\/IGV2ZW50LmtleUNvZGUgOiBldmVudC5jaGFyQ29kZSApOw0KCQkJcmV0dXJuIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCAoIGNociA8ICIgIiB8fCAhY2hhcnMgfHwgY2hhcnMuaW5kZXhPZiggY2hyICkgPiAtMSApOw0KCQl9DQoJfSwNCg0KCS8qIFN5bmNocm9uaXNlIG1hbnVhbCBlbnRyeSBhbmQgZmllbGQvYWx0ZXJuYXRlIGZpZWxkLiAqLw0KCV9kb0tleVVwOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBkYXRlLA0KCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggZXZlbnQudGFyZ2V0ICk7DQoNCgkJaWYgKCBpbnN0LmlucHV0LnZhbCgpICE9PSBpbnN0Lmxhc3RWYWwgKSB7DQoJCQl0cnkgew0KCQkJCWRhdGUgPSAkLmRhdGVwaWNrZXIucGFyc2VEYXRlKCAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICksDQoJCQkJCSggaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQudmFsKCkgOiBudWxsICksDQoJCQkJCSQuZGF0ZXBpY2tlci5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICkgKTsNCg0KCQkJCWlmICggZGF0ZSApIHsgLy8gb25seSBpZiB2YWxpZA0KCQkJCQkkLmRhdGVwaWNrZXIuX3NldERhdGVGcm9tRmllbGQoIGluc3QgKTsNCgkJCQkJJC5kYXRlcGlja2VyLl91cGRhdGVBbHRlcm5hdGUoIGluc3QgKTsNCgkJCQkJJC5kYXRlcGlja2VyLl91cGRhdGVEYXRlcGlja2VyKCBpbnN0ICk7DQoJCQkJfQ0KCQkJfQ0KCQkJY2F0Y2ggKCBlcnIgKSB7DQoJCQl9DQoJCX0NCgkJcmV0dXJuIHRydWU7DQoJfSwNCg0KCS8qIFBvcC11cCB0aGUgZGF0ZSBwaWNrZXIgZm9yIGEgZ2l2ZW4gaW5wdXQgZmllbGQuDQoJICogSWYgZmFsc2UgcmV0dXJuZWQgZnJvbSBiZWZvcmVTaG93IGV2ZW50IGhhbmRsZXIgZG8gbm90IHNob3cuDQoJICogQHBhcmFtICBpbnB1dCAgZWxlbWVudCAtIHRoZSBpbnB1dCBmaWVsZCBhdHRhY2hlZCB0byB0aGUgZGF0ZSBwaWNrZXIgb3INCgkgKgkJCQkJZXZlbnQgLSBpZiB0cmlnZ2VyZWQgYnkgZm9jdXMNCgkgKi8NCglfc2hvd0RhdGVwaWNrZXI6IGZ1bmN0aW9uKCBpbnB1dCApIHsNCgkJaW5wdXQgPSBpbnB1dC50YXJnZXQgfHwgaW5wdXQ7DQoJCWlmICggaW5wdXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImlucHV0IiApIHsgLy8gZmluZCBmcm9tIGJ1dHRvbi9pbWFnZSB0cmlnZ2VyDQoJCQlpbnB1dCA9ICQoICJpbnB1dCIsIGlucHV0LnBhcmVudE5vZGUgKVsgMCBdOw0KCQl9DQoNCgkJaWYgKCAkLmRhdGVwaWNrZXIuX2lzRGlzYWJsZWREYXRlcGlja2VyKCBpbnB1dCApIHx8ICQuZGF0ZXBpY2tlci5fbGFzdElucHV0ID09PSBpbnB1dCApIHsgLy8gYWxyZWFkeSBoZXJlDQoJCQlyZXR1cm47DQoJCX0NCg0KCQl2YXIgaW5zdCwgYmVmb3JlU2hvdywgYmVmb3JlU2hvd1NldHRpbmdzLCBpc0ZpeGVkLA0KCQkJb2Zmc2V0LCBzaG93QW5pbSwgZHVyYXRpb247DQoNCgkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggaW5wdXQgKTsNCgkJaWYgKCAkLmRhdGVwaWNrZXIuX2N1ckluc3QgJiYgJC5kYXRlcGlja2VyLl9jdXJJbnN0ICE9PSBpbnN0ICkgew0KCQkJJC5kYXRlcGlja2VyLl9jdXJJbnN0LmRwRGl2LnN0b3AoIHRydWUsIHRydWUgKTsNCgkJCWlmICggaW5zdCAmJiAkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nICkgew0KCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoICQuZGF0ZXBpY2tlci5fY3VySW5zdC5pbnB1dFsgMCBdICk7DQoJCQl9DQoJCX0NCg0KCQliZWZvcmVTaG93ID0gJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJiZWZvcmVTaG93IiApOw0KCQliZWZvcmVTaG93U2V0dGluZ3MgPSBiZWZvcmVTaG93ID8gYmVmb3JlU2hvdy5hcHBseSggaW5wdXQsIFsgaW5wdXQsIGluc3QgXSApIDoge307DQoJCWlmICggYmVmb3JlU2hvd1NldHRpbmdzID09PSBmYWxzZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KCQlkYXRlcGlja2VyX2V4dGVuZFJlbW92ZSggaW5zdC5zZXR0aW5ncywgYmVmb3JlU2hvd1NldHRpbmdzICk7DQoNCgkJaW5zdC5sYXN0VmFsID0gbnVsbDsNCgkJJC5kYXRlcGlja2VyLl9sYXN0SW5wdXQgPSBpbnB1dDsNCgkJJC5kYXRlcGlja2VyLl9zZXREYXRlRnJvbUZpZWxkKCBpbnN0ICk7DQoNCgkJaWYgKCAkLmRhdGVwaWNrZXIuX2luRGlhbG9nICkgeyAvLyBoaWRlIGN1cnNvcg0KCQkJaW5wdXQudmFsdWUgPSAiIjsNCgkJfQ0KCQlpZiAoICEkLmRhdGVwaWNrZXIuX3BvcyApIHsgLy8gcG9zaXRpb24gYmVsb3cgaW5wdXQNCgkJCSQuZGF0ZXBpY2tlci5fcG9zID0gJC5kYXRlcGlja2VyLl9maW5kUG9zKCBpbnB1dCApOw0KCQkJJC5kYXRlcGlja2VyLl9wb3NbIDEgXSArPSBpbnB1dC5vZmZzZXRIZWlnaHQ7IC8vIGFkZCB0aGUgaGVpZ2h0DQoJCX0NCg0KCQlpc0ZpeGVkID0gZmFsc2U7DQoJCSQoIGlucHV0ICkucGFyZW50cygpLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJaXNGaXhlZCB8PSAkKCB0aGlzICkuY3NzKCAicG9zaXRpb24iICkgPT09ICJmaXhlZCI7DQoJCQlyZXR1cm4gIWlzRml4ZWQ7DQoJCX0gKTsNCg0KCQlvZmZzZXQgPSB7IGxlZnQ6ICQuZGF0ZXBpY2tlci5fcG9zWyAwIF0sIHRvcDogJC5kYXRlcGlja2VyLl9wb3NbIDEgXSB9Ow0KCQkkLmRhdGVwaWNrZXIuX3BvcyA9IG51bGw7DQoNCgkJLy90byBhdm9pZCBmbGFzaGVzIG9uIEZpcmVmb3gNCgkJaW5zdC5kcERpdi5lbXB0eSgpOw0KDQoJCS8vIGRldGVybWluZSBzaXppbmcgb2Zmc2NyZWVuDQoJCWluc3QuZHBEaXYuY3NzKCB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCBkaXNwbGF5OiAiYmxvY2siLCB0b3A6ICItMTAwMHB4IiB9ICk7DQoJCSQuZGF0ZXBpY2tlci5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOw0KDQoJCS8vIGZpeCB3aWR0aCBmb3IgZHluYW1pYyBudW1iZXIgb2YgZGF0ZSBwaWNrZXJzDQoJCS8vIGFuZCBhZGp1c3QgcG9zaXRpb24gYmVmb3JlIHNob3dpbmcNCgkJb2Zmc2V0ID0gJC5kYXRlcGlja2VyLl9jaGVja09mZnNldCggaW5zdCwgb2Zmc2V0LCBpc0ZpeGVkICk7DQoJCWluc3QuZHBEaXYuY3NzKCB7IHBvc2l0aW9uOiAoICQuZGF0ZXBpY2tlci5faW5EaWFsb2cgJiYgJC5ibG9ja1VJID8NCgkJCSJzdGF0aWMiIDogKCBpc0ZpeGVkID8gImZpeGVkIiA6ICJhYnNvbHV0ZSIgKSApLCBkaXNwbGF5OiAibm9uZSIsDQoJCQlsZWZ0OiBvZmZzZXQubGVmdCArICJweCIsIHRvcDogb2Zmc2V0LnRvcCArICJweCIgfSApOw0KDQoJCWlmICggIWluc3QuaW5saW5lICkgew0KCQkJc2hvd0FuaW0gPSAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInNob3dBbmltIiApOw0KCQkJZHVyYXRpb24gPSAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgImR1cmF0aW9uIiApOw0KCQkJaW5zdC5kcERpdi5jc3MoICJ6LWluZGV4IiwgZGF0ZXBpY2tlcl9nZXRaaW5kZXgoICQoIGlucHV0ICkgKSArIDEgKTsNCgkJCSQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgPSB0cnVlOw0KDQoJCQlpZiAoICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBzaG93QW5pbSBdICkgew0KCQkJCWluc3QuZHBEaXYuc2hvdyggc2hvd0FuaW0sICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic2hvd09wdGlvbnMiICksIGR1cmF0aW9uICk7DQoJCQl9IGVsc2Ugew0KCQkJCWluc3QuZHBEaXZbIHNob3dBbmltIHx8ICJzaG93IiBdKCBzaG93QW5pbSA\/IGR1cmF0aW9uIDogbnVsbCApOw0KCQkJfQ0KDQoJCQlpZiAoICQuZGF0ZXBpY2tlci5fc2hvdWxkRm9jdXNJbnB1dCggaW5zdCApICkgew0KCQkJCWluc3QuaW5wdXQudHJpZ2dlciggImZvY3VzIiApOw0KCQkJfQ0KDQoJCQkkLmRhdGVwaWNrZXIuX2N1ckluc3QgPSBpbnN0Ow0KCQl9DQoJfSwNCg0KCS8qIEdlbmVyYXRlIHRoZSBkYXRlIHBpY2tlciBjb250ZW50LiAqLw0KCV91cGRhdGVEYXRlcGlja2VyOiBmdW5jdGlvbiggaW5zdCApIHsNCgkJdGhpcy5tYXhSb3dzID0gNDsgLy9SZXNldCB0aGUgbWF4IG51bWJlciBvZiByb3dzIGJlaW5nIGRpc3BsYXllZCAoc2VlICM3MDQzKQ0KCQlkYXRlcGlja2VyX2luc3RBY3RpdmUgPSBpbnN0OyAvLyBmb3IgZGVsZWdhdGUgaG92ZXIgZXZlbnRzDQoJCWluc3QuZHBEaXYuZW1wdHkoKS5hcHBlbmQoIHRoaXMuX2dlbmVyYXRlSFRNTCggaW5zdCApICk7DQoJCXRoaXMuX2F0dGFjaEhhbmRsZXJzKCBpbnN0ICk7DQoNCgkJdmFyIG9yaWd5ZWFyc2h0bWwsDQoJCQludW1Nb250aHMgPSB0aGlzLl9nZXROdW1iZXJPZk1vbnRocyggaW5zdCApLA0KCQkJY29scyA9IG51bU1vbnRoc1sgMSBdLA0KCQkJd2lkdGggPSAxNywNCgkJCWFjdGl2ZUNlbGwgPSBpbnN0LmRwRGl2LmZpbmQoICIuIiArIHRoaXMuX2RheU92ZXJDbGFzcyArICIgYSIgKTsNCg0KCQlpZiAoIGFjdGl2ZUNlbGwubGVuZ3RoID4gMCApIHsNCgkJCWRhdGVwaWNrZXJfaGFuZGxlTW91c2VvdmVyLmFwcGx5KCBhY3RpdmVDZWxsLmdldCggMCApICk7DQoJCX0NCg0KCQlpbnN0LmRwRGl2LnJlbW92ZUNsYXNzKCAidWktZGF0ZXBpY2tlci1tdWx0aS0yIHVpLWRhdGVwaWNrZXItbXVsdGktMyB1aS1kYXRlcGlja2VyLW11bHRpLTQiICkud2lkdGgoICIiICk7DQoJCWlmICggY29scyA+IDEgKSB7DQoJCQlpbnN0LmRwRGl2LmFkZENsYXNzKCAidWktZGF0ZXBpY2tlci1tdWx0aS0iICsgY29scyApLmNzcyggIndpZHRoIiwgKCB3aWR0aCAqIGNvbHMgKSArICJlbSIgKTsNCgkJfQ0KCQlpbnN0LmRwRGl2WyAoIG51bU1vbnRoc1sgMCBdICE9PSAxIHx8IG51bU1vbnRoc1sgMSBdICE9PSAxID8gImFkZCIgOiAicmVtb3ZlIiApICsNCgkJCSJDbGFzcyIgXSggInVpLWRhdGVwaWNrZXItbXVsdGkiICk7DQoJCWluc3QuZHBEaXZbICggdGhpcy5fZ2V0KCBpbnN0LCAiaXNSVEwiICkgPyAiYWRkIiA6ICJyZW1vdmUiICkgKw0KCQkJIkNsYXNzIiBdKCAidWktZGF0ZXBpY2tlci1ydGwiICk7DQoNCgkJaWYgKCBpbnN0ID09PSAkLmRhdGVwaWNrZXIuX2N1ckluc3QgJiYgJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyAmJiAkLmRhdGVwaWNrZXIuX3Nob3VsZEZvY3VzSW5wdXQoIGluc3QgKSApIHsNCgkJCWluc3QuaW5wdXQudHJpZ2dlciggImZvY3VzIiApOw0KCQl9DQoNCgkJLy8gRGVmZmVyZWQgcmVuZGVyIG9mIHRoZSB5ZWFycyBzZWxlY3QgKHRvIGF2b2lkIGZsYXNoZXMgb24gRmlyZWZveCkNCgkJaWYgKCBpbnN0LnllYXJzaHRtbCApIHsNCgkJCW9yaWd5ZWFyc2h0bWwgPSBpbnN0LnllYXJzaHRtbDsNCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KDQoJCQkJLy9hc3N1cmUgdGhhdCBpbnN0LnllYXJzaHRtbCBkaWRuJ3QgY2hhbmdlLg0KCQkJCWlmICggb3JpZ3llYXJzaHRtbCA9PT0gaW5zdC55ZWFyc2h0bWwgJiYgaW5zdC55ZWFyc2h0bWwgKSB7DQoJCQkJCWluc3QuZHBEaXYuZmluZCggInNlbGVjdC51aS1kYXRlcGlja2VyLXllYXI6Zmlyc3QiICkucmVwbGFjZVdpdGgoIGluc3QueWVhcnNodG1sICk7DQoJCQkJfQ0KCQkJCW9yaWd5ZWFyc2h0bWwgPSBpbnN0LnllYXJzaHRtbCA9IG51bGw7DQoJCQl9LCAwICk7DQoJCX0NCgl9LA0KDQoJLy8gIzY2OTQgLSBkb24ndCBmb2N1cyB0aGUgaW5wdXQgaWYgaXQncyBhbHJlYWR5IGZvY3VzZWQNCgkvLyB0aGlzIGJyZWFrcyB0aGUgY2hhbmdlIGV2ZW50IGluIElFDQoJLy8gU3VwcG9ydDogSUUgYW5kIGpRdWVyeSA8MS45DQoJX3Nob3VsZEZvY3VzSW5wdXQ6IGZ1bmN0aW9uKCBpbnN0ICkgew0KCQlyZXR1cm4gaW5zdC5pbnB1dCAmJiBpbnN0LmlucHV0LmlzKCAiOnZpc2libGUiICkgJiYgIWluc3QuaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgJiYgIWluc3QuaW5wdXQuaXMoICI6Zm9jdXMiICk7DQoJfSwNCg0KCS8qIENoZWNrIHBvc2l0aW9uaW5nIHRvIHJlbWFpbiBvbiBzY3JlZW4uICovDQoJX2NoZWNrT2Zmc2V0OiBmdW5jdGlvbiggaW5zdCwgb2Zmc2V0LCBpc0ZpeGVkICkgew0KCQl2YXIgZHBXaWR0aCA9IGluc3QuZHBEaXYub3V0ZXJXaWR0aCgpLA0KCQkJZHBIZWlnaHQgPSBpbnN0LmRwRGl2Lm91dGVySGVpZ2h0KCksDQoJCQlpbnB1dFdpZHRoID0gaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQub3V0ZXJXaWR0aCgpIDogMCwNCgkJCWlucHV0SGVpZ2h0ID0gaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQub3V0ZXJIZWlnaHQoKSA6IDAsDQoJCQl2aWV3V2lkdGggPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGggKyAoIGlzRml4ZWQgPyAwIDogJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgKSwNCgkJCXZpZXdIZWlnaHQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0ICsgKCBpc0ZpeGVkID8gMCA6ICQoIGRvY3VtZW50ICkuc2Nyb2xsVG9wKCkgKTsNCg0KCQlvZmZzZXQubGVmdCAtPSAoIHRoaXMuX2dldCggaW5zdCwgImlzUlRMIiApID8gKCBkcFdpZHRoIC0gaW5wdXRXaWR0aCApIDogMCApOw0KCQlvZmZzZXQubGVmdCAtPSAoIGlzRml4ZWQgJiYgb2Zmc2V0LmxlZnQgPT09IGluc3QuaW5wdXQub2Zmc2V0KCkubGVmdCApID8gJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgOiAwOw0KCQlvZmZzZXQudG9wIC09ICggaXNGaXhlZCAmJiBvZmZzZXQudG9wID09PSAoIGluc3QuaW5wdXQub2Zmc2V0KCkudG9wICsgaW5wdXRIZWlnaHQgKSApID8gJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSA6IDA7DQoNCgkJLy8gTm93IGNoZWNrIGlmIGRhdGVwaWNrZXIgaXMgc2hvd2luZyBvdXRzaWRlIHdpbmRvdyB2aWV3cG9ydCAtIG1vdmUgdG8gYSBiZXR0ZXIgcGxhY2UgaWYgc28uDQoJCW9mZnNldC5sZWZ0IC09IE1hdGgubWluKCBvZmZzZXQubGVmdCwgKCBvZmZzZXQubGVmdCArIGRwV2lkdGggPiB2aWV3V2lkdGggJiYgdmlld1dpZHRoID4gZHBXaWR0aCApID8NCgkJCU1hdGguYWJzKCBvZmZzZXQubGVmdCArIGRwV2lkdGggLSB2aWV3V2lkdGggKSA6IDAgKTsNCgkJb2Zmc2V0LnRvcCAtPSBNYXRoLm1pbiggb2Zmc2V0LnRvcCwgKCBvZmZzZXQudG9wICsgZHBIZWlnaHQgPiB2aWV3SGVpZ2h0ICYmIHZpZXdIZWlnaHQgPiBkcEhlaWdodCApID8NCgkJCU1hdGguYWJzKCBkcEhlaWdodCArIGlucHV0SGVpZ2h0ICkgOiAwICk7DQoNCgkJcmV0dXJuIG9mZnNldDsNCgl9LA0KDQoJLyogRmluZCBhbiBvYmplY3QncyBwb3NpdGlvbiBvbiB0aGUgc2NyZWVuLiAqLw0KCV9maW5kUG9zOiBmdW5jdGlvbiggb2JqICkgew0KCQl2YXIgcG9zaXRpb24sDQoJCQlpbnN0ID0gdGhpcy5fZ2V0SW5zdCggb2JqICksDQoJCQlpc1JUTCA9IHRoaXMuX2dldCggaW5zdCwgImlzUlRMIiApOw0KDQoJCXdoaWxlICggb2JqICYmICggb2JqLnR5cGUgPT09ICJoaWRkZW4iIHx8IG9iai5ub2RlVHlwZSAhPT0gMSB8fCAkLmV4cHIuZmlsdGVycy5oaWRkZW4oIG9iaiApICkgKSB7DQoJCQlvYmogPSBvYmpbIGlzUlRMID8gInByZXZpb3VzU2libGluZyIgOiAibmV4dFNpYmxpbmciIF07DQoJCX0NCg0KCQlwb3NpdGlvbiA9ICQoIG9iaiApLm9mZnNldCgpOw0KCQlyZXR1cm4gWyBwb3NpdGlvbi5sZWZ0LCBwb3NpdGlvbi50b3AgXTsNCgl9LA0KDQoJLyogSGlkZSB0aGUgZGF0ZSBwaWNrZXIgZnJvbSB2aWV3Lg0KCSAqIEBwYXJhbSAgaW5wdXQgIGVsZW1lbnQgLSB0aGUgaW5wdXQgZmllbGQgYXR0YWNoZWQgdG8gdGhlIGRhdGUgcGlja2VyDQoJICovDQoJX2hpZGVEYXRlcGlja2VyOiBmdW5jdGlvbiggaW5wdXQgKSB7DQoJCXZhciBzaG93QW5pbSwgZHVyYXRpb24sIHBvc3RQcm9jZXNzLCBvbkNsb3NlLA0KCQkJaW5zdCA9IHRoaXMuX2N1ckluc3Q7DQoNCgkJaWYgKCAhaW5zdCB8fCAoIGlucHV0ICYmIGluc3QgIT09ICQuZGF0YSggaW5wdXQsICJkYXRlcGlja2VyIiApICkgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlpZiAoIHRoaXMuX2RhdGVwaWNrZXJTaG93aW5nICkgew0KCQkJc2hvd0FuaW0gPSB0aGlzLl9nZXQoIGluc3QsICJzaG93QW5pbSIgKTsNCgkJCWR1cmF0aW9uID0gdGhpcy5fZ2V0KCBpbnN0LCAiZHVyYXRpb24iICk7DQoJCQlwb3N0UHJvY2VzcyA9IGZ1bmN0aW9uKCkgew0KCQkJCSQuZGF0ZXBpY2tlci5fdGlkeURpYWxvZyggaW5zdCApOw0KCQkJfTsNCg0KCQkJLy8gREVQUkVDQVRFRDogYWZ0ZXIgQkMgZm9yIDEuOC54ICQuZWZmZWN0c1sgc2hvd0FuaW0gXSBpcyBub3QgbmVlZGVkDQoJCQlpZiAoICQuZWZmZWN0cyAmJiAoICQuZWZmZWN0cy5lZmZlY3RbIHNob3dBbmltIF0gfHwgJC5lZmZlY3RzWyBzaG93QW5pbSBdICkgKSB7DQoJCQkJaW5zdC5kcERpdi5oaWRlKCBzaG93QW5pbSwgJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzaG93T3B0aW9ucyIgKSwgZHVyYXRpb24sIHBvc3RQcm9jZXNzICk7DQoJCQl9IGVsc2Ugew0KCQkJCWluc3QuZHBEaXZbICggc2hvd0FuaW0gPT09ICJzbGlkZURvd24iID8gInNsaWRlVXAiIDoNCgkJCQkJKCBzaG93QW5pbSA9PT0gImZhZGVJbiIgPyAiZmFkZU91dCIgOiAiaGlkZSIgKSApIF0oICggc2hvd0FuaW0gPyBkdXJhdGlvbiA6IG51bGwgKSwgcG9zdFByb2Nlc3MgKTsNCgkJCX0NCg0KCQkJaWYgKCAhc2hvd0FuaW0gKSB7DQoJCQkJcG9zdFByb2Nlc3MoKTsNCgkJCX0NCgkJCXRoaXMuX2RhdGVwaWNrZXJTaG93aW5nID0gZmFsc2U7DQoNCgkJCW9uQ2xvc2UgPSB0aGlzLl9nZXQoIGluc3QsICJvbkNsb3NlIiApOw0KCQkJaWYgKCBvbkNsb3NlICkgew0KCQkJCW9uQ2xvc2UuYXBwbHkoICggaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXRbIDAgXSA6IG51bGwgKSwgWyAoIGluc3QuaW5wdXQgPyBpbnN0LmlucHV0LnZhbCgpIDogIiIgKSwgaW5zdCBdICk7DQoJCQl9DQoNCgkJCXRoaXMuX2xhc3RJbnB1dCA9IG51bGw7DQoJCQlpZiAoIHRoaXMuX2luRGlhbG9nICkgew0KCQkJCXRoaXMuX2RpYWxvZ0lucHV0LmNzcyggeyBwb3NpdGlvbjogImFic29sdXRlIiwgbGVmdDogIjAiLCB0b3A6ICItMTAwcHgiIH0gKTsNCgkJCQlpZiAoICQuYmxvY2tVSSApIHsNCgkJCQkJJC51bmJsb2NrVUkoKTsNCgkJCQkJJCggImJvZHkiICkuYXBwZW5kKCB0aGlzLmRwRGl2ICk7DQoJCQkJfQ0KCQkJfQ0KCQkJdGhpcy5faW5EaWFsb2cgPSBmYWxzZTsNCgkJfQ0KCX0sDQoNCgkvKiBUaWR5IHVwIGFmdGVyIGEgZGlhbG9nIGRpc3BsYXkuICovDQoJX3RpZHlEaWFsb2c6IGZ1bmN0aW9uKCBpbnN0ICkgew0KCQlpbnN0LmRwRGl2LnJlbW92ZUNsYXNzKCB0aGlzLl9kaWFsb2dDbGFzcyApLm9mZiggIi51aS1kYXRlcGlja2VyLWNhbGVuZGFyIiApOw0KCX0sDQoNCgkvKiBDbG9zZSBkYXRlIHBpY2tlciBpZiBjbGlja2VkIGVsc2V3aGVyZS4gKi8NCglfY2hlY2tFeHRlcm5hbENsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCWlmICggISQuZGF0ZXBpY2tlci5fY3VySW5zdCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksDQoJCQlpbnN0ID0gJC5kYXRlcGlja2VyLl9nZXRJbnN0KCAkdGFyZ2V0WyAwIF0gKTsNCg0KCQlpZiAoICggKCAkdGFyZ2V0WyAwIF0uaWQgIT09ICQuZGF0ZXBpY2tlci5fbWFpbkRpdklkICYmDQoJCQkJJHRhcmdldC5wYXJlbnRzKCAiIyIgKyAkLmRhdGVwaWNrZXIuX21haW5EaXZJZCApLmxlbmd0aCA9PT0gMCAmJg0KCQkJCSEkdGFyZ2V0Lmhhc0NsYXNzKCAkLmRhdGVwaWNrZXIubWFya2VyQ2xhc3NOYW1lICkgJiYNCgkJCQkhJHRhcmdldC5jbG9zZXN0KCAiLiIgKyAkLmRhdGVwaWNrZXIuX3RyaWdnZXJDbGFzcyApLmxlbmd0aCAmJg0KCQkJCSQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgISggJC5kYXRlcGlja2VyLl9pbkRpYWxvZyAmJiAkLmJsb2NrVUkgKSApICkgfHwNCgkJCSggJHRhcmdldC5oYXNDbGFzcyggJC5kYXRlcGlja2VyLm1hcmtlckNsYXNzTmFtZSApICYmICQuZGF0ZXBpY2tlci5fY3VySW5zdCAhPT0gaW5zdCApICkgew0KCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsNCgkJfQ0KCX0sDQoNCgkvKiBBZGp1c3Qgb25lIG9mIHRoZSBkYXRlIHN1Yi1maWVsZHMuICovDQoJX2FkanVzdERhdGU6IGZ1bmN0aW9uKCBpZCwgb2Zmc2V0LCBwZXJpb2QgKSB7DQoJCXZhciB0YXJnZXQgPSAkKCBpZCApLA0KCQkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldFsgMCBdICk7DQoNCgkJaWYgKCB0aGlzLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggdGFyZ2V0WyAwIF0gKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KCQl0aGlzLl9hZGp1c3RJbnN0RGF0ZSggaW5zdCwgb2Zmc2V0ICsNCgkJCSggcGVyaW9kID09PSAiTSIgPyB0aGlzLl9nZXQoIGluc3QsICJzaG93Q3VycmVudEF0UG9zIiApIDogMCApLCAvLyB1bmRvIHBvc2l0aW9uaW5nDQoJCQlwZXJpb2QgKTsNCgkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOw0KCX0sDQoNCgkvKiBBY3Rpb24gZm9yIGN1cnJlbnQgbGluay4gKi8NCglfZ290b1RvZGF5OiBmdW5jdGlvbiggaWQgKSB7DQoJCXZhciBkYXRlLA0KCQkJdGFyZ2V0ID0gJCggaWQgKSwNCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXRbIDAgXSApOw0KDQoJCWlmICggdGhpcy5fZ2V0KCBpbnN0LCAiZ290b0N1cnJlbnQiICkgJiYgaW5zdC5jdXJyZW50RGF5ICkgew0KCQkJaW5zdC5zZWxlY3RlZERheSA9IGluc3QuY3VycmVudERheTsNCgkJCWluc3QuZHJhd01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoID0gaW5zdC5jdXJyZW50TW9udGg7DQoJCQlpbnN0LmRyYXdZZWFyID0gaW5zdC5zZWxlY3RlZFllYXIgPSBpbnN0LmN1cnJlbnRZZWFyOw0KCQl9IGVsc2Ugew0KCQkJZGF0ZSA9IG5ldyBEYXRlKCk7DQoJCQlpbnN0LnNlbGVjdGVkRGF5ID0gZGF0ZS5nZXREYXRlKCk7DQoJCQlpbnN0LmRyYXdNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCA9IGRhdGUuZ2V0TW9udGgoKTsNCgkJCWluc3QuZHJhd1llYXIgPSBpbnN0LnNlbGVjdGVkWWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTsNCgkJfQ0KCQl0aGlzLl9ub3RpZnlDaGFuZ2UoIGluc3QgKTsNCgkJdGhpcy5fYWRqdXN0RGF0ZSggdGFyZ2V0ICk7DQoJfSwNCg0KCS8qIEFjdGlvbiBmb3Igc2VsZWN0aW5nIGEgbmV3IG1vbnRoL3llYXIuICovDQoJX3NlbGVjdE1vbnRoWWVhcjogZnVuY3Rpb24oIGlkLCBzZWxlY3QsIHBlcmlvZCApIHsNCgkJdmFyIHRhcmdldCA9ICQoIGlkICksDQoJCQlpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0WyAwIF0gKTsNCg0KCQlpbnN0WyAic2VsZWN0ZWQiICsgKCBwZXJpb2QgPT09ICJNIiA\/ICJNb250aCIgOiAiWWVhciIgKSBdID0NCgkJaW5zdFsgImRyYXciICsgKCBwZXJpb2QgPT09ICJNIiA\/ICJNb250aCIgOiAiWWVhciIgKSBdID0NCgkJCXBhcnNlSW50KCBzZWxlY3Qub3B0aW9uc1sgc2VsZWN0LnNlbGVjdGVkSW5kZXggXS52YWx1ZSwgMTAgKTsNCg0KCQl0aGlzLl9ub3RpZnlDaGFuZ2UoIGluc3QgKTsNCgkJdGhpcy5fYWRqdXN0RGF0ZSggdGFyZ2V0ICk7DQoJfSwNCg0KCS8qIEFjdGlvbiBmb3Igc2VsZWN0aW5nIGEgZGF5LiAqLw0KCV9zZWxlY3REYXk6IGZ1bmN0aW9uKCBpZCwgbW9udGgsIHllYXIsIHRkICkgew0KCQl2YXIgaW5zdCwNCgkJCXRhcmdldCA9ICQoIGlkICk7DQoNCgkJaWYgKCAkKCB0ZCApLmhhc0NsYXNzKCB0aGlzLl91bnNlbGVjdGFibGVDbGFzcyApIHx8IHRoaXMuX2lzRGlzYWJsZWREYXRlcGlja2VyKCB0YXJnZXRbIDAgXSApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldFsgMCBdICk7DQoJCWluc3Quc2VsZWN0ZWREYXkgPSBpbnN0LmN1cnJlbnREYXkgPSAkKCAiYSIsIHRkICkuaHRtbCgpOw0KCQlpbnN0LnNlbGVjdGVkTW9udGggPSBpbnN0LmN1cnJlbnRNb250aCA9IG1vbnRoOw0KCQlpbnN0LnNlbGVjdGVkWWVhciA9IGluc3QuY3VycmVudFllYXIgPSB5ZWFyOw0KCQl0aGlzLl9zZWxlY3REYXRlKCBpZCwgdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwNCgkJCWluc3QuY3VycmVudERheSwgaW5zdC5jdXJyZW50TW9udGgsIGluc3QuY3VycmVudFllYXIgKSApOw0KCX0sDQoNCgkvKiBFcmFzZSB0aGUgaW5wdXQgZmllbGQgYW5kIGhpZGUgdGhlIGRhdGUgcGlja2VyLiAqLw0KCV9jbGVhckRhdGU6IGZ1bmN0aW9uKCBpZCApIHsNCgkJdmFyIHRhcmdldCA9ICQoIGlkICk7DQoJCXRoaXMuX3NlbGVjdERhdGUoIHRhcmdldCwgIiIgKTsNCgl9LA0KDQoJLyogVXBkYXRlIHRoZSBpbnB1dCBmaWVsZCB3aXRoIHRoZSBzZWxlY3RlZCBkYXRlLiAqLw0KCV9zZWxlY3REYXRlOiBmdW5jdGlvbiggaWQsIGRhdGVTdHIgKSB7DQoJCXZhciBvblNlbGVjdCwNCgkJCXRhcmdldCA9ICQoIGlkICksDQoJCQlpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0WyAwIF0gKTsNCg0KCQlkYXRlU3RyID0gKCBkYXRlU3RyICE9IG51bGwgPyBkYXRlU3RyIDogdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCApICk7DQoJCWlmICggaW5zdC5pbnB1dCApIHsNCgkJCWluc3QuaW5wdXQudmFsKCBkYXRlU3RyICk7DQoJCX0NCgkJdGhpcy5fdXBkYXRlQWx0ZXJuYXRlKCBpbnN0ICk7DQoNCgkJb25TZWxlY3QgPSB0aGlzLl9nZXQoIGluc3QsICJvblNlbGVjdCIgKTsNCgkJaWYgKCBvblNlbGVjdCApIHsNCgkJCW9uU2VsZWN0LmFwcGx5KCAoIGluc3QuaW5wdXQgPyBpbnN0LmlucHV0WyAwIF0gOiBudWxsICksIFsgZGF0ZVN0ciwgaW5zdCBdICk7ICAvLyB0cmlnZ2VyIGN1c3RvbSBjYWxsYmFjaw0KCQl9IGVsc2UgaWYgKCBpbnN0LmlucHV0ICkgew0KCQkJaW5zdC5pbnB1dC50cmlnZ2VyKCAiY2hhbmdlIiApOyAvLyBmaXJlIHRoZSBjaGFuZ2UgZXZlbnQNCgkJfQ0KDQoJCWlmICggaW5zdC5pbmxpbmUgKSB7DQoJCQl0aGlzLl91cGRhdGVEYXRlcGlja2VyKCBpbnN0ICk7DQoJCX0gZWxzZSB7DQoJCQl0aGlzLl9oaWRlRGF0ZXBpY2tlcigpOw0KCQkJdGhpcy5fbGFzdElucHV0ID0gaW5zdC5pbnB1dFsgMCBdOw0KCQkJaWYgKCB0eXBlb2YoIGluc3QuaW5wdXRbIDAgXSApICE9PSAib2JqZWN0IiApIHsNCgkJCQlpbnN0LmlucHV0LnRyaWdnZXIoICJmb2N1cyIgKTsgLy8gcmVzdG9yZSBmb2N1cw0KCQkJfQ0KCQkJdGhpcy5fbGFzdElucHV0ID0gbnVsbDsNCgkJfQ0KCX0sDQoNCgkvKiBVcGRhdGUgYW55IGFsdGVybmF0ZSBmaWVsZCB0byBzeW5jaHJvbmlzZSB3aXRoIHRoZSBtYWluIGZpZWxkLiAqLw0KCV91cGRhdGVBbHRlcm5hdGU6IGZ1bmN0aW9uKCBpbnN0ICkgew0KCQl2YXIgYWx0Rm9ybWF0LCBkYXRlLCBkYXRlU3RyLA0KCQkJYWx0RmllbGQgPSB0aGlzLl9nZXQoIGluc3QsICJhbHRGaWVsZCIgKTsNCg0KCQlpZiAoIGFsdEZpZWxkICkgeyAvLyB1cGRhdGUgYWx0ZXJuYXRlIGZpZWxkIHRvbw0KCQkJYWx0Rm9ybWF0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiYWx0Rm9ybWF0IiApIHx8IHRoaXMuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICk7DQoJCQlkYXRlID0gdGhpcy5fZ2V0RGF0ZSggaW5zdCApOw0KCQkJZGF0ZVN0ciA9IHRoaXMuZm9ybWF0RGF0ZSggYWx0Rm9ybWF0LCBkYXRlLCB0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApOw0KCQkJJCggYWx0RmllbGQgKS52YWwoIGRhdGVTdHIgKTsNCgkJfQ0KCX0sDQoNCgkvKiBTZXQgYXMgYmVmb3JlU2hvd0RheSBmdW5jdGlvbiB0byBwcmV2ZW50IHNlbGVjdGlvbiBvZiB3ZWVrZW5kcy4NCgkgKiBAcGFyYW0gIGRhdGUgIERhdGUgLSB0aGUgZGF0ZSB0byBjdXN0b21pc2UNCgkgKiBAcmV0dXJuIFtib29sZWFuLCBzdHJpbmddIC0gaXMgdGhpcyBkYXRlIHNlbGVjdGFibGU\/LCB3aGF0IGlzIGl0cyBDU1MgY2xhc3M\/DQoJICovDQoJbm9XZWVrZW5kczogZnVuY3Rpb24oIGRhdGUgKSB7DQoJCXZhciBkYXkgPSBkYXRlLmdldERheSgpOw0KCQlyZXR1cm4gWyAoIGRheSA+IDAgJiYgZGF5IDwgNiApLCAiIiBdOw0KCX0sDQoNCgkvKiBTZXQgYXMgY2FsY3VsYXRlV2VlayB0byBkZXRlcm1pbmUgdGhlIHdlZWsgb2YgdGhlIHllYXIgYmFzZWQgb24gdGhlIElTTyA4NjAxIGRlZmluaXRpb24uDQoJICogQHBhcmFtICBkYXRlICBEYXRlIC0gdGhlIGRhdGUgdG8gZ2V0IHRoZSB3ZWVrIGZvcg0KCSAqIEByZXR1cm4gIG51bWJlciAtIHRoZSBudW1iZXIgb2YgdGhlIHdlZWsgd2l0aGluIHRoZSB5ZWFyIHRoYXQgY29udGFpbnMgdGhpcyBkYXRlDQoJICovDQoJaXNvODYwMVdlZWs6IGZ1bmN0aW9uKCBkYXRlICkgew0KCQl2YXIgdGltZSwNCgkJCWNoZWNrRGF0ZSA9IG5ldyBEYXRlKCBkYXRlLmdldFRpbWUoKSApOw0KDQoJCS8vIEZpbmQgVGh1cnNkYXkgb2YgdGhpcyB3ZWVrIHN0YXJ0aW5nIG9uIE1vbmRheQ0KCQljaGVja0RhdGUuc2V0RGF0ZSggY2hlY2tEYXRlLmdldERhdGUoKSArIDQgLSAoIGNoZWNrRGF0ZS5nZXREYXkoKSB8fCA3ICkgKTsNCg0KCQl0aW1lID0gY2hlY2tEYXRlLmdldFRpbWUoKTsNCgkJY2hlY2tEYXRlLnNldE1vbnRoKCAwICk7IC8vIENvbXBhcmUgd2l0aCBKYW4gMQ0KCQljaGVja0RhdGUuc2V0RGF0ZSggMSApOw0KCQlyZXR1cm4gTWF0aC5mbG9vciggTWF0aC5yb3VuZCggKCB0aW1lIC0gY2hlY2tEYXRlICkgLyA4NjQwMDAwMCApIC8gNyApICsgMTsNCgl9LA0KDQoJLyogUGFyc2UgYSBzdHJpbmcgdmFsdWUgaW50byBhIGRhdGUgb2JqZWN0Lg0KCSAqIFNlZSBmb3JtYXREYXRlIGJlbG93IGZvciB0aGUgcG9zc2libGUgZm9ybWF0cy4NCgkgKg0KCSAqIEBwYXJhbSAgZm9ybWF0IHN0cmluZyAtIHRoZSBleHBlY3RlZCBmb3JtYXQgb2YgdGhlIGRhdGUNCgkgKiBAcGFyYW0gIHZhbHVlIHN0cmluZyAtIHRoZSBkYXRlIGluIHRoZSBhYm92ZSBmb3JtYXQNCgkgKiBAcGFyYW0gIHNldHRpbmdzIE9iamVjdCAtIGF0dHJpYnV0ZXMgaW5jbHVkZToNCgkgKgkJCQkJc2hvcnRZZWFyQ3V0b2ZmICBudW1iZXIgLSB0aGUgY3V0b2ZmIHllYXIgZm9yIGRldGVybWluaW5nIHRoZSBjZW50dXJ5IChvcHRpb25hbCkNCgkgKgkJCQkJZGF5TmFtZXNTaG9ydAlzdHJpbmdbN10gLSBhYmJyZXZpYXRlZCBuYW1lcyBvZiB0aGUgZGF5cyBmcm9tIFN1bmRheSAob3B0aW9uYWwpDQoJICoJCQkJCWRheU5hbWVzCQlzdHJpbmdbN10gLSBuYW1lcyBvZiB0aGUgZGF5cyBmcm9tIFN1bmRheSAob3B0aW9uYWwpDQoJICoJCQkJCW1vbnRoTmFtZXNTaG9ydCBzdHJpbmdbMTJdIC0gYWJicmV2aWF0ZWQgbmFtZXMgb2YgdGhlIG1vbnRocyAob3B0aW9uYWwpDQoJICoJCQkJCW1vbnRoTmFtZXMJCXN0cmluZ1sxMl0gLSBuYW1lcyBvZiB0aGUgbW9udGhzIChvcHRpb25hbCkNCgkgKiBAcmV0dXJuICBEYXRlIC0gdGhlIGV4dHJhY3RlZCBkYXRlIHZhbHVlIG9yIG51bGwgaWYgdmFsdWUgaXMgYmxhbmsNCgkgKi8NCglwYXJzZURhdGU6IGZ1bmN0aW9uKCBmb3JtYXQsIHZhbHVlLCBzZXR0aW5ncyApIHsNCgkJaWYgKCBmb3JtYXQgPT0gbnVsbCB8fCB2YWx1ZSA9PSBudWxsICkgew0KCQkJdGhyb3cgIkludmFsaWQgYXJndW1lbnRzIjsNCgkJfQ0KDQoJCXZhbHVlID0gKCB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiID8gdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlICsgIiIgKTsNCgkJaWYgKCB2YWx1ZSA9PT0gIiIgKSB7DQoJCQlyZXR1cm4gbnVsbDsNCgkJfQ0KDQoJCXZhciBpRm9ybWF0LCBkaW0sIGV4dHJhLA0KCQkJaVZhbHVlID0gMCwNCgkJCXNob3J0WWVhckN1dG9mZlRlbXAgPSAoIHNldHRpbmdzID8gc2V0dGluZ3Muc2hvcnRZZWFyQ3V0b2ZmIDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLnNob3J0WWVhckN1dG9mZiwNCgkJCXNob3J0WWVhckN1dG9mZiA9ICggdHlwZW9mIHNob3J0WWVhckN1dG9mZlRlbXAgIT09ICJzdHJpbmciID8gc2hvcnRZZWFyQ3V0b2ZmVGVtcCA6DQoJCQkJbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpICUgMTAwICsgcGFyc2VJbnQoIHNob3J0WWVhckN1dG9mZlRlbXAsIDEwICkgKSwNCgkJCWRheU5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXNTaG9ydCA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lc1Nob3J0LA0KCQkJZGF5TmFtZXMgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXMgOiBudWxsICkgfHwgdGhpcy5fZGVmYXVsdHMuZGF5TmFtZXMsDQoJCQltb250aE5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lc1Nob3J0IDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXNTaG9ydCwNCgkJCW1vbnRoTmFtZXMgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lcyA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5tb250aE5hbWVzLA0KCQkJeWVhciA9IC0xLA0KCQkJbW9udGggPSAtMSwNCgkJCWRheSA9IC0xLA0KCQkJZG95ID0gLTEsDQoJCQlsaXRlcmFsID0gZmFsc2UsDQoJCQlkYXRlLA0KDQoJCQkvLyBDaGVjayB3aGV0aGVyIGEgZm9ybWF0IGNoYXJhY3RlciBpcyBkb3VibGVkDQoJCQlsb29rQWhlYWQgPSBmdW5jdGlvbiggbWF0Y2ggKSB7DQoJCQkJdmFyIG1hdGNoZXMgPSAoIGlGb3JtYXQgKyAxIDwgZm9ybWF0Lmxlbmd0aCAmJiBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICsgMSApID09PSBtYXRjaCApOw0KCQkJCWlmICggbWF0Y2hlcyApIHsNCgkJCQkJaUZvcm1hdCsrOw0KCQkJCX0NCgkJCQlyZXR1cm4gbWF0Y2hlczsNCgkJCX0sDQoNCgkJCS8vIEV4dHJhY3QgYSBudW1iZXIgZnJvbSB0aGUgc3RyaW5nIHZhbHVlDQoJCQlnZXROdW1iZXIgPSBmdW5jdGlvbiggbWF0Y2ggKSB7DQoJCQkJdmFyIGlzRG91YmxlZCA9IGxvb2tBaGVhZCggbWF0Y2ggKSwNCgkJCQkJc2l6ZSA9ICggbWF0Y2ggPT09ICJAIiA\/IDE0IDogKCBtYXRjaCA9PT0gIiEiID8gMjAgOg0KCQkJCQkoIG1hdGNoID09PSAieSIgJiYgaXNEb3VibGVkID8gNCA6ICggbWF0Y2ggPT09ICJvIiA\/IDMgOiAyICkgKSApICksDQoJCQkJCW1pblNpemUgPSAoIG1hdGNoID09PSAieSIgPyBzaXplIDogMSApLA0KCQkJCQlkaWdpdHMgPSBuZXcgUmVnRXhwKCAiXlxcZHsiICsgbWluU2l6ZSArICIsIiArIHNpemUgKyAifSIgKSwNCgkJCQkJbnVtID0gdmFsdWUuc3Vic3RyaW5nKCBpVmFsdWUgKS5tYXRjaCggZGlnaXRzICk7DQoJCQkJaWYgKCAhbnVtICkgew0KCQkJCQl0aHJvdyAiTWlzc2luZyBudW1iZXIgYXQgcG9zaXRpb24gIiArIGlWYWx1ZTsNCgkJCQl9DQoJCQkJaVZhbHVlICs9IG51bVsgMCBdLmxlbmd0aDsNCgkJCQlyZXR1cm4gcGFyc2VJbnQoIG51bVsgMCBdLCAxMCApOw0KCQkJfSwNCg0KCQkJLy8gRXh0cmFjdCBhIG5hbWUgZnJvbSB0aGUgc3RyaW5nIHZhbHVlIGFuZCBjb252ZXJ0IHRvIGFuIGluZGV4DQoJCQlnZXROYW1lID0gZnVuY3Rpb24oIG1hdGNoLCBzaG9ydE5hbWVzLCBsb25nTmFtZXMgKSB7DQoJCQkJdmFyIGluZGV4ID0gLTEsDQoJCQkJCW5hbWVzID0gJC5tYXAoIGxvb2tBaGVhZCggbWF0Y2ggKSA\/IGxvbmdOYW1lcyA6IHNob3J0TmFtZXMsIGZ1bmN0aW9uKCB2LCBrICkgew0KCQkJCQkJcmV0dXJuIFsgWyBrLCB2IF0gXTsNCgkJCQkJfSApLnNvcnQoIGZ1bmN0aW9uKCBhLCBiICkgew0KCQkJCQkJcmV0dXJuIC0oIGFbIDEgXS5sZW5ndGggLSBiWyAxIF0ubGVuZ3RoICk7DQoJCQkJCX0gKTsNCg0KCQkJCSQuZWFjaCggbmFtZXMsIGZ1bmN0aW9uKCBpLCBwYWlyICkgew0KCQkJCQl2YXIgbmFtZSA9IHBhaXJbIDEgXTsNCgkJCQkJaWYgKCB2YWx1ZS5zdWJzdHIoIGlWYWx1ZSwgbmFtZS5sZW5ndGggKS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkgKSB7DQoJCQkJCQlpbmRleCA9IHBhaXJbIDAgXTsNCgkJCQkJCWlWYWx1ZSArPSBuYW1lLmxlbmd0aDsNCgkJCQkJCXJldHVybiBmYWxzZTsNCgkJCQkJfQ0KCQkJCX0gKTsNCgkJCQlpZiAoIGluZGV4ICE9PSAtMSApIHsNCgkJCQkJcmV0dXJuIGluZGV4ICsgMTsNCgkJCQl9IGVsc2Ugew0KCQkJCQl0aHJvdyAiVW5rbm93biBuYW1lIGF0IHBvc2l0aW9uICIgKyBpVmFsdWU7DQoJCQkJfQ0KCQkJfSwNCg0KCQkJLy8gQ29uZmlybSB0aGF0IGEgbGl0ZXJhbCBjaGFyYWN0ZXIgbWF0Y2hlcyB0aGUgc3RyaW5nIHZhbHVlDQoJCQljaGVja0xpdGVyYWwgPSBmdW5jdGlvbigpIHsNCgkJCQlpZiAoIHZhbHVlLmNoYXJBdCggaVZhbHVlICkgIT09IGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKSApIHsNCgkJCQkJdGhyb3cgIlVuZXhwZWN0ZWQgbGl0ZXJhbCBhdCBwb3NpdGlvbiAiICsgaVZhbHVlOw0KCQkJCX0NCgkJCQlpVmFsdWUrKzsNCgkJCX07DQoNCgkJZm9yICggaUZvcm1hdCA9IDA7IGlGb3JtYXQgPCBmb3JtYXQubGVuZ3RoOyBpRm9ybWF0KysgKSB7DQoJCQlpZiAoIGxpdGVyYWwgKSB7DQoJCQkJaWYgKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgPT09ICInIiAmJiAhbG9va0FoZWFkKCAiJyIgKSApIHsNCgkJCQkJbGl0ZXJhbCA9IGZhbHNlOw0KCQkJCX0gZWxzZSB7DQoJCQkJCWNoZWNrTGl0ZXJhbCgpOw0KCQkJCX0NCgkJCX0gZWxzZSB7DQoJCQkJc3dpdGNoICggZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApICkgew0KCQkJCQljYXNlICJkIjoNCgkJCQkJCWRheSA9IGdldE51bWJlciggImQiICk7DQoJCQkJCQlicmVhazsNCgkJCQkJY2FzZSAiRCI6DQoJCQkJCQlnZXROYW1lKCAiRCIsIGRheU5hbWVzU2hvcnQsIGRheU5hbWVzICk7DQoJCQkJCQlicmVhazsNCgkJCQkJY2FzZSAibyI6DQoJCQkJCQlkb3kgPSBnZXROdW1iZXIoICJvIiApOw0KCQkJCQkJYnJlYWs7DQoJCQkJCWNhc2UgIm0iOg0KCQkJCQkJbW9udGggPSBnZXROdW1iZXIoICJtIiApOw0KCQkJCQkJYnJlYWs7DQoJCQkJCWNhc2UgIk0iOg0KCQkJCQkJbW9udGggPSBnZXROYW1lKCAiTSIsIG1vbnRoTmFtZXNTaG9ydCwgbW9udGhOYW1lcyApOw0KCQkJCQkJYnJlYWs7DQoJCQkJCWNhc2UgInkiOg0KCQkJCQkJeWVhciA9IGdldE51bWJlciggInkiICk7DQoJCQkJCQlicmVhazsNCgkJCQkJY2FzZSAiQCI6DQoJCQkJCQlkYXRlID0gbmV3IERhdGUoIGdldE51bWJlciggIkAiICkgKTsNCgkJCQkJCXllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7DQoJCQkJCQltb250aCA9IGRhdGUuZ2V0TW9udGgoKSArIDE7DQoJCQkJCQlkYXkgPSBkYXRlLmdldERhdGUoKTsNCgkJCQkJCWJyZWFrOw0KCQkJCQljYXNlICIhIjoNCgkJCQkJCWRhdGUgPSBuZXcgRGF0ZSggKCBnZXROdW1iZXIoICIhIiApIC0gdGhpcy5fdGlja3NUbzE5NzAgKSAvIDEwMDAwICk7DQoJCQkJCQl5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOw0KCQkJCQkJbW9udGggPSBkYXRlLmdldE1vbnRoKCkgKyAxOw0KCQkJCQkJZGF5ID0gZGF0ZS5nZXREYXRlKCk7DQoJCQkJCQlicmVhazsNCgkJCQkJY2FzZSAiJyI6DQoJCQkJCQlpZiAoIGxvb2tBaGVhZCggIiciICkgKSB7DQoJCQkJCQkJY2hlY2tMaXRlcmFsKCk7DQoJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCWxpdGVyYWwgPSB0cnVlOw0KCQkJCQkJfQ0KCQkJCQkJYnJlYWs7DQoJCQkJCWRlZmF1bHQ6DQoJCQkJCQljaGVja0xpdGVyYWwoKTsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlpZiAoIGlWYWx1ZSA8IHZhbHVlLmxlbmd0aCApIHsNCgkJCWV4dHJhID0gdmFsdWUuc3Vic3RyKCBpVmFsdWUgKTsNCgkJCWlmICggIS9eXHMrLy50ZXN0KCBleHRyYSApICkgew0KCQkJCXRocm93ICJFeHRyYS91bnBhcnNlZCBjaGFyYWN0ZXJzIGZvdW5kIGluIGRhdGU6ICIgKyBleHRyYTsNCgkJCX0NCgkJfQ0KDQoJCWlmICggeWVhciA9PT0gLTEgKSB7DQoJCQl5ZWFyID0gbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpOw0KCQl9IGVsc2UgaWYgKCB5ZWFyIDwgMTAwICkgew0KCQkJeWVhciArPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgLSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgJSAxMDAgKw0KCQkJCSggeWVhciA8PSBzaG9ydFllYXJDdXRvZmYgPyAwIDogLTEwMCApOw0KCQl9DQoNCgkJaWYgKCBkb3kgPiAtMSApIHsNCgkJCW1vbnRoID0gMTsNCgkJCWRheSA9IGRveTsNCgkJCWRvIHsNCgkJCQlkaW0gPSB0aGlzLl9nZXREYXlzSW5Nb250aCggeWVhciwgbW9udGggLSAxICk7DQoJCQkJaWYgKCBkYXkgPD0gZGltICkgew0KCQkJCQlicmVhazsNCgkJCQl9DQoJCQkJbW9udGgrKzsNCgkJCQlkYXkgLT0gZGltOw0KCQkJfSB3aGlsZSAoIHRydWUgKTsNCgkJfQ0KDQoJCWRhdGUgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIHllYXIsIG1vbnRoIC0gMSwgZGF5ICkgKTsNCgkJaWYgKCBkYXRlLmdldEZ1bGxZZWFyKCkgIT09IHllYXIgfHwgZGF0ZS5nZXRNb250aCgpICsgMSAhPT0gbW9udGggfHwgZGF0ZS5nZXREYXRlKCkgIT09IGRheSApIHsNCgkJCXRocm93ICJJbnZhbGlkIGRhdGUiOyAvLyBFLmcuIDMxLzAyLzAwDQoJCX0NCgkJcmV0dXJuIGRhdGU7DQoJfSwNCg0KCS8qIFN0YW5kYXJkIGRhdGUgZm9ybWF0cy4gKi8NCglBVE9NOiAieXktbW0tZGQiLCAvLyBSRkMgMzMzOSAoSVNPIDg2MDEpDQoJQ09PS0lFOiAiRCwgZGQgTSB5eSIsDQoJSVNPXzg2MDE6ICJ5eS1tbS1kZCIsDQoJUkZDXzgyMjogIkQsIGQgTSB5IiwNCglSRkNfODUwOiAiREQsIGRkLU0teSIsDQoJUkZDXzEwMzY6ICJELCBkIE0geSIsDQoJUkZDXzExMjM6ICJELCBkIE0geXkiLA0KCVJGQ18yODIyOiAiRCwgZCBNIHl5IiwNCglSU1M6ICJELCBkIE0geSIsIC8vIFJGQyA4MjINCglUSUNLUzogIiEiLA0KCVRJTUVTVEFNUDogIkAiLA0KCVczQzogInl5LW1tLWRkIiwgLy8gSVNPIDg2MDENCg0KCV90aWNrc1RvMTk3MDogKCAoICggMTk3MCAtIDEgKSAqIDM2NSArIE1hdGguZmxvb3IoIDE5NzAgLyA0ICkgLSBNYXRoLmZsb29yKCAxOTcwIC8gMTAwICkgKw0KCQlNYXRoLmZsb29yKCAxOTcwIC8gNDAwICkgKSAqIDI0ICogNjAgKiA2MCAqIDEwMDAwMDAwICksDQoNCgkvKiBGb3JtYXQgYSBkYXRlIG9iamVjdCBpbnRvIGEgc3RyaW5nIHZhbHVlLg0KCSAqIFRoZSBmb3JtYXQgY2FuIGJlIGNvbWJpbmF0aW9ucyBvZiB0aGUgZm9sbG93aW5nOg0KCSAqIGQgIC0gZGF5IG9mIG1vbnRoIChubyBsZWFkaW5nIHplcm8pDQoJICogZGQgLSBkYXkgb2YgbW9udGggKHR3byBkaWdpdCkNCgkgKiBvICAtIGRheSBvZiB5ZWFyIChubyBsZWFkaW5nIHplcm9zKQ0KCSAqIG9vIC0gZGF5IG9mIHllYXIgKHRocmVlIGRpZ2l0KQ0KCSAqIEQgIC0gZGF5IG5hbWUgc2hvcnQNCgkgKiBERCAtIGRheSBuYW1lIGxvbmcNCgkgKiBtICAtIG1vbnRoIG9mIHllYXIgKG5vIGxlYWRpbmcgemVybykNCgkgKiBtbSAtIG1vbnRoIG9mIHllYXIgKHR3byBkaWdpdCkNCgkgKiBNICAtIG1vbnRoIG5hbWUgc2hvcnQNCgkgKiBNTSAtIG1vbnRoIG5hbWUgbG9uZw0KCSAqIHkgIC0geWVhciAodHdvIGRpZ2l0KQ0KCSAqIHl5IC0geWVhciAoZm91ciBkaWdpdCkNCgkgKiBAIC0gVW5peCB0aW1lc3RhbXAgKG1zIHNpbmNlIDAxLzAxLzE5NzApDQoJICogISAtIFdpbmRvd3MgdGlja3MgKDEwMG5zIHNpbmNlIDAxLzAxLzAwMDEpDQoJICogIi4uLiIgLSBsaXRlcmFsIHRleHQNCgkgKiAnJyAtIHNpbmdsZSBxdW90ZQ0KCSAqDQoJICogQHBhcmFtICBmb3JtYXQgc3RyaW5nIC0gdGhlIGRlc2lyZWQgZm9ybWF0IG9mIHRoZSBkYXRlDQoJICogQHBhcmFtICBkYXRlIERhdGUgLSB0aGUgZGF0ZSB2YWx1ZSB0byBmb3JtYXQNCgkgKiBAcGFyYW0gIHNldHRpbmdzIE9iamVjdCAtIGF0dHJpYnV0ZXMgaW5jbHVkZToNCgkgKgkJCQkJZGF5TmFtZXNTaG9ydAlzdHJpbmdbN10gLSBhYmJyZXZpYXRlZCBuYW1lcyBvZiB0aGUgZGF5cyBmcm9tIFN1bmRheSAob3B0aW9uYWwpDQoJICoJCQkJCWRheU5hbWVzCQlzdHJpbmdbN10gLSBuYW1lcyBvZiB0aGUgZGF5cyBmcm9tIFN1bmRheSAob3B0aW9uYWwpDQoJICoJCQkJCW1vbnRoTmFtZXNTaG9ydCBzdHJpbmdbMTJdIC0gYWJicmV2aWF0ZWQgbmFtZXMgb2YgdGhlIG1vbnRocyAob3B0aW9uYWwpDQoJICoJCQkJCW1vbnRoTmFtZXMJCXN0cmluZ1sxMl0gLSBuYW1lcyBvZiB0aGUgbW9udGhzIChvcHRpb25hbCkNCgkgKiBAcmV0dXJuICBzdHJpbmcgLSB0aGUgZGF0ZSBpbiB0aGUgYWJvdmUgZm9ybWF0DQoJICovDQoJZm9ybWF0RGF0ZTogZnVuY3Rpb24oIGZvcm1hdCwgZGF0ZSwgc2V0dGluZ3MgKSB7DQoJCWlmICggIWRhdGUgKSB7DQoJCQlyZXR1cm4gIiI7DQoJCX0NCg0KCQl2YXIgaUZvcm1hdCwNCgkJCWRheU5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXNTaG9ydCA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lc1Nob3J0LA0KCQkJZGF5TmFtZXMgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXMgOiBudWxsICkgfHwgdGhpcy5fZGVmYXVsdHMuZGF5TmFtZXMsDQoJCQltb250aE5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lc1Nob3J0IDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXNTaG9ydCwNCgkJCW1vbnRoTmFtZXMgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lcyA6IG51bGwgKSB8fCB0aGlzLl9kZWZhdWx0cy5tb250aE5hbWVzLA0KDQoJCQkvLyBDaGVjayB3aGV0aGVyIGEgZm9ybWF0IGNoYXJhY3RlciBpcyBkb3VibGVkDQoJCQlsb29rQWhlYWQgPSBmdW5jdGlvbiggbWF0Y2ggKSB7DQoJCQkJdmFyIG1hdGNoZXMgPSAoIGlGb3JtYXQgKyAxIDwgZm9ybWF0Lmxlbmd0aCAmJiBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICsgMSApID09PSBtYXRjaCApOw0KCQkJCWlmICggbWF0Y2hlcyApIHsNCgkJCQkJaUZvcm1hdCsrOw0KCQkJCX0NCgkJCQlyZXR1cm4gbWF0Y2hlczsNCgkJCX0sDQoNCgkJCS8vIEZvcm1hdCBhIG51bWJlciwgd2l0aCBsZWFkaW5nIHplcm8gaWYgbmVjZXNzYXJ5DQoJCQlmb3JtYXROdW1iZXIgPSBmdW5jdGlvbiggbWF0Y2gsIHZhbHVlLCBsZW4gKSB7DQoJCQkJdmFyIG51bSA9ICIiICsgdmFsdWU7DQoJCQkJaWYgKCBsb29rQWhlYWQoIG1hdGNoICkgKSB7DQoJCQkJCXdoaWxlICggbnVtLmxlbmd0aCA8IGxlbiApIHsNCgkJCQkJCW51bSA9ICIwIiArIG51bTsNCgkJCQkJfQ0KCQkJCX0NCgkJCQlyZXR1cm4gbnVtOw0KCQkJfSwNCg0KCQkJLy8gRm9ybWF0IGEgbmFtZSwgc2hvcnQgb3IgbG9uZyBhcyByZXF1ZXN0ZWQNCgkJCWZvcm1hdE5hbWUgPSBmdW5jdGlvbiggbWF0Y2gsIHZhbHVlLCBzaG9ydE5hbWVzLCBsb25nTmFtZXMgKSB7DQoJCQkJcmV0dXJuICggbG9va0FoZWFkKCBtYXRjaCApID8gbG9uZ05hbWVzWyB2YWx1ZSBdIDogc2hvcnROYW1lc1sgdmFsdWUgXSApOw0KCQkJfSwNCgkJCW91dHB1dCA9ICIiLA0KCQkJbGl0ZXJhbCA9IGZhbHNlOw0KDQoJCWlmICggZGF0ZSApIHsNCgkJCWZvciAoIGlGb3JtYXQgPSAwOyBpRm9ybWF0IDwgZm9ybWF0Lmxlbmd0aDsgaUZvcm1hdCsrICkgew0KCQkJCWlmICggbGl0ZXJhbCApIHsNCgkJCQkJaWYgKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgPT09ICInIiAmJiAhbG9va0FoZWFkKCAiJyIgKSApIHsNCgkJCQkJCWxpdGVyYWwgPSBmYWxzZTsNCgkJCQkJfSBlbHNlIHsNCgkJCQkJCW91dHB1dCArPSBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICk7DQoJCQkJCX0NCgkJCQl9IGVsc2Ugew0KCQkJCQlzd2l0Y2ggKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgKSB7DQoJCQkJCQljYXNlICJkIjoNCgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TnVtYmVyKCAiZCIsIGRhdGUuZ2V0RGF0ZSgpLCAyICk7DQoJCQkJCQkJYnJlYWs7DQoJCQkJCQljYXNlICJEIjoNCgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TmFtZSggIkQiLCBkYXRlLmdldERheSgpLCBkYXlOYW1lc1Nob3J0LCBkYXlOYW1lcyApOw0KCQkJCQkJCWJyZWFrOw0KCQkJCQkJY2FzZSAibyI6DQoJCQkJCQkJb3V0cHV0ICs9IGZvcm1hdE51bWJlciggIm8iLA0KCQkJCQkJCQlNYXRoLnJvdW5kKCAoIG5ldyBEYXRlKCBkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSwgZGF0ZS5nZXREYXRlKCkgKS5nZXRUaW1lKCkgLSBuZXcgRGF0ZSggZGF0ZS5nZXRGdWxsWWVhcigpLCAwLCAwICkuZ2V0VGltZSgpICkgLyA4NjQwMDAwMCApLCAzICk7DQoJCQkJCQkJYnJlYWs7DQoJCQkJCQljYXNlICJtIjoNCgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TnVtYmVyKCAibSIsIGRhdGUuZ2V0TW9udGgoKSArIDEsIDIgKTsNCgkJCQkJCQlicmVhazsNCgkJCQkJCWNhc2UgIk0iOg0KCQkJCQkJCW91dHB1dCArPSBmb3JtYXROYW1lKCAiTSIsIGRhdGUuZ2V0TW9udGgoKSwgbW9udGhOYW1lc1Nob3J0LCBtb250aE5hbWVzICk7DQoJCQkJCQkJYnJlYWs7DQoJCQkJCQljYXNlICJ5IjoNCgkJCQkJCQlvdXRwdXQgKz0gKCBsb29rQWhlYWQoICJ5IiApID8gZGF0ZS5nZXRGdWxsWWVhcigpIDoNCgkJCQkJCQkJKCBkYXRlLmdldEZ1bGxZZWFyKCkgJSAxMDAgPCAxMCA\/ICIwIiA6ICIiICkgKyBkYXRlLmdldEZ1bGxZZWFyKCkgJSAxMDAgKTsNCgkJCQkJCQlicmVhazsNCgkJCQkJCWNhc2UgIkAiOg0KCQkJCQkJCW91dHB1dCArPSBkYXRlLmdldFRpbWUoKTsNCgkJCQkJCQlicmVhazsNCgkJCQkJCWNhc2UgIiEiOg0KCQkJCQkJCW91dHB1dCArPSBkYXRlLmdldFRpbWUoKSAqIDEwMDAwICsgdGhpcy5fdGlja3NUbzE5NzA7DQoJCQkJCQkJYnJlYWs7DQoJCQkJCQljYXNlICInIjoNCgkJCQkJCQlpZiAoIGxvb2tBaGVhZCggIiciICkgKSB7DQoJCQkJCQkJCW91dHB1dCArPSAiJyI7DQoJCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkJbGl0ZXJhbCA9IHRydWU7DQoJCQkJCQkJfQ0KCQkJCQkJCWJyZWFrOw0KCQkJCQkJZGVmYXVsdDoNCgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9DQoJCXJldHVybiBvdXRwdXQ7DQoJfSwNCg0KCS8qIEV4dHJhY3QgYWxsIHBvc3NpYmxlIGNoYXJhY3RlcnMgZnJvbSB0aGUgZGF0ZSBmb3JtYXQuICovDQoJX3Bvc3NpYmxlQ2hhcnM6IGZ1bmN0aW9uKCBmb3JtYXQgKSB7DQoJCXZhciBpRm9ybWF0LA0KCQkJY2hhcnMgPSAiIiwNCgkJCWxpdGVyYWwgPSBmYWxzZSwNCg0KCQkJLy8gQ2hlY2sgd2hldGhlciBhIGZvcm1hdCBjaGFyYWN0ZXIgaXMgZG91YmxlZA0KCQkJbG9va0FoZWFkID0gZnVuY3Rpb24oIG1hdGNoICkgew0KCQkJCXZhciBtYXRjaGVzID0gKCBpRm9ybWF0ICsgMSA8IGZvcm1hdC5sZW5ndGggJiYgZm9ybWF0LmNoYXJBdCggaUZvcm1hdCArIDEgKSA9PT0gbWF0Y2ggKTsNCgkJCQlpZiAoIG1hdGNoZXMgKSB7DQoJCQkJCWlGb3JtYXQrKzsNCgkJCQl9DQoJCQkJcmV0dXJuIG1hdGNoZXM7DQoJCQl9Ow0KDQoJCWZvciAoIGlGb3JtYXQgPSAwOyBpRm9ybWF0IDwgZm9ybWF0Lmxlbmd0aDsgaUZvcm1hdCsrICkgew0KCQkJaWYgKCBsaXRlcmFsICkgew0KCQkJCWlmICggZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApID09PSAiJyIgJiYgIWxvb2tBaGVhZCggIiciICkgKSB7DQoJCQkJCWxpdGVyYWwgPSBmYWxzZTsNCgkJCQl9IGVsc2Ugew0KCQkJCQljaGFycyArPSBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICk7DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCgkJCQlzd2l0Y2ggKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgKSB7DQoJCQkJCWNhc2UgImQiOiBjYXNlICJtIjogY2FzZSAieSI6IGNhc2UgIkAiOg0KCQkJCQkJY2hhcnMgKz0gIjAxMjM0NTY3ODkiOw0KCQkJCQkJYnJlYWs7DQoJCQkJCWNhc2UgIkQiOiBjYXNlICJNIjoNCgkJCQkJCXJldHVybiBudWxsOyAvLyBBY2NlcHQgYW55dGhpbmcNCgkJCQkJY2FzZSAiJyI6DQoJCQkJCQlpZiAoIGxvb2tBaGVhZCggIiciICkgKSB7DQoJCQkJCQkJY2hhcnMgKz0gIiciOw0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQlsaXRlcmFsID0gdHJ1ZTsNCgkJCQkJCX0NCgkJCQkJCWJyZWFrOw0KCQkJCQlkZWZhdWx0Og0KCQkJCQkJY2hhcnMgKz0gZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KCQlyZXR1cm4gY2hhcnM7DQoJfSwNCg0KCS8qIEdldCBhIHNldHRpbmcgdmFsdWUsIGRlZmF1bHRpbmcgaWYgbmVjZXNzYXJ5LiAqLw0KCV9nZXQ6IGZ1bmN0aW9uKCBpbnN0LCBuYW1lICkgew0KCQlyZXR1cm4gaW5zdC5zZXR0aW5nc1sgbmFtZSBdICE9PSB1bmRlZmluZWQgPw0KCQkJaW5zdC5zZXR0aW5nc1sgbmFtZSBdIDogdGhpcy5fZGVmYXVsdHNbIG5hbWUgXTsNCgl9LA0KDQoJLyogUGFyc2UgZXhpc3RpbmcgZGF0ZSBhbmQgaW5pdGlhbGlzZSBkYXRlIHBpY2tlci4gKi8NCglfc2V0RGF0ZUZyb21GaWVsZDogZnVuY3Rpb24oIGluc3QsIG5vRGVmYXVsdCApIHsNCgkJaWYgKCBpbnN0LmlucHV0LnZhbCgpID09PSBpbnN0Lmxhc3RWYWwgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl2YXIgZGF0ZUZvcm1hdCA9IHRoaXMuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICksDQoJCQlkYXRlcyA9IGluc3QubGFzdFZhbCA9IGluc3QuaW5wdXQgPyBpbnN0LmlucHV0LnZhbCgpIDogbnVsbCwNCgkJCWRlZmF1bHREYXRlID0gdGhpcy5fZ2V0RGVmYXVsdERhdGUoIGluc3QgKSwNCgkJCWRhdGUgPSBkZWZhdWx0RGF0ZSwNCgkJCXNldHRpbmdzID0gdGhpcy5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICk7DQoNCgkJdHJ5IHsNCgkJCWRhdGUgPSB0aGlzLnBhcnNlRGF0ZSggZGF0ZUZvcm1hdCwgZGF0ZXMsIHNldHRpbmdzICkgfHwgZGVmYXVsdERhdGU7DQoJCX0gY2F0Y2ggKCBldmVudCApIHsNCgkJCWRhdGVzID0gKCBub0RlZmF1bHQgPyAiIiA6IGRhdGVzICk7DQoJCX0NCgkJaW5zdC5zZWxlY3RlZERheSA9IGRhdGUuZ2V0RGF0ZSgpOw0KCQlpbnN0LmRyYXdNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCA9IGRhdGUuZ2V0TW9udGgoKTsNCgkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOw0KCQlpbnN0LmN1cnJlbnREYXkgPSAoIGRhdGVzID8gZGF0ZS5nZXREYXRlKCkgOiAwICk7DQoJCWluc3QuY3VycmVudE1vbnRoID0gKCBkYXRlcyA\/IGRhdGUuZ2V0TW9udGgoKSA6IDAgKTsNCgkJaW5zdC5jdXJyZW50WWVhciA9ICggZGF0ZXMgPyBkYXRlLmdldEZ1bGxZZWFyKCkgOiAwICk7DQoJCXRoaXMuX2FkanVzdEluc3REYXRlKCBpbnN0ICk7DQoJfSwNCg0KCS8qIFJldHJpZXZlIHRoZSBkZWZhdWx0IGRhdGUgc2hvd24gb24gb3BlbmluZy4gKi8NCglfZ2V0RGVmYXVsdERhdGU6IGZ1bmN0aW9uKCBpbnN0ICkgew0KCQlyZXR1cm4gdGhpcy5fcmVzdHJpY3RNaW5NYXgoIGluc3QsDQoJCQl0aGlzLl9kZXRlcm1pbmVEYXRlKCBpbnN0LCB0aGlzLl9nZXQoIGluc3QsICJkZWZhdWx0RGF0ZSIgKSwgbmV3IERhdGUoKSApICk7DQoJfSwNCg0KCS8qIEEgZGF0ZSBtYXkgYmUgc3BlY2lmaWVkIGFzIGFuIGV4YWN0IHZhbHVlIG9yIGEgcmVsYXRpdmUgb25lLiAqLw0KCV9kZXRlcm1pbmVEYXRlOiBmdW5jdGlvbiggaW5zdCwgZGF0ZSwgZGVmYXVsdERhdGUgKSB7DQoJCXZhciBvZmZzZXROdW1lcmljID0gZnVuY3Rpb24oIG9mZnNldCApIHsNCgkJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7DQoJCQkJZGF0ZS5zZXREYXRlKCBkYXRlLmdldERhdGUoKSArIG9mZnNldCApOw0KCQkJCXJldHVybiBkYXRlOw0KCQkJfSwNCgkJCW9mZnNldFN0cmluZyA9IGZ1bmN0aW9uKCBvZmZzZXQgKSB7DQoJCQkJdHJ5IHsNCgkJCQkJcmV0dXJuICQuZGF0ZXBpY2tlci5wYXJzZURhdGUoICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAiZGF0ZUZvcm1hdCIgKSwNCgkJCQkJCW9mZnNldCwgJC5kYXRlcGlja2VyLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApOw0KCQkJCX0NCgkJCQljYXRjaCAoIGUgKSB7DQoNCgkJCQkJLy8gSWdub3JlDQoJCQkJfQ0KDQoJCQkJdmFyIGRhdGUgPSAoIG9mZnNldC50b0xvd2VyQ2FzZSgpLm1hdGNoKCAvXmMvICkgPw0KCQkJCQkkLmRhdGVwaWNrZXIuX2dldERhdGUoIGluc3QgKSA6IG51bGwgKSB8fCBuZXcgRGF0ZSgpLA0KCQkJCQl5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLA0KCQkJCQltb250aCA9IGRhdGUuZ2V0TW9udGgoKSwNCgkJCQkJZGF5ID0gZGF0ZS5nZXREYXRlKCksDQoJCQkJCXBhdHRlcm4gPSAvKFsrXC1dP1swLTldKylccyooZHxEfHd8V3xtfE18eXxZKT8vZywNCgkJCQkJbWF0Y2hlcyA9IHBhdHRlcm4uZXhlYyggb2Zmc2V0ICk7DQoNCgkJCQl3aGlsZSAoIG1hdGNoZXMgKSB7DQoJCQkJCXN3aXRjaCAoIG1hdGNoZXNbIDIgXSB8fCAiZCIgKSB7DQoJCQkJCQljYXNlICJkIiA6IGNhc2UgIkQiIDoNCgkJCQkJCQlkYXkgKz0gcGFyc2VJbnQoIG1hdGNoZXNbIDEgXSwgMTAgKTsgYnJlYWs7DQoJCQkJCQljYXNlICJ3IiA6IGNhc2UgIlciIDoNCgkJCQkJCQlkYXkgKz0gcGFyc2VJbnQoIG1hdGNoZXNbIDEgXSwgMTAgKSAqIDc7IGJyZWFrOw0KCQkJCQkJY2FzZSAibSIgOiBjYXNlICJNIiA6DQoJCQkJCQkJbW9udGggKz0gcGFyc2VJbnQoIG1hdGNoZXNbIDEgXSwgMTAgKTsNCgkJCQkJCQlkYXkgPSBNYXRoLm1pbiggZGF5LCAkLmRhdGVwaWNrZXIuX2dldERheXNJbk1vbnRoKCB5ZWFyLCBtb250aCApICk7DQoJCQkJCQkJYnJlYWs7DQoJCQkJCQljYXNlICJ5IjogY2FzZSAiWSIgOg0KCQkJCQkJCXllYXIgKz0gcGFyc2VJbnQoIG1hdGNoZXNbIDEgXSwgMTAgKTsNCgkJCQkJCQlkYXkgPSBNYXRoLm1pbiggZGF5LCAkLmRhdGVwaWNrZXIuX2dldERheXNJbk1vbnRoKCB5ZWFyLCBtb250aCApICk7DQoJCQkJCQkJYnJlYWs7DQoJCQkJCX0NCgkJCQkJbWF0Y2hlcyA9IHBhdHRlcm4uZXhlYyggb2Zmc2V0ICk7DQoJCQkJfQ0KCQkJCXJldHVybiBuZXcgRGF0ZSggeWVhciwgbW9udGgsIGRheSApOw0KCQkJfSwNCgkJCW5ld0RhdGUgPSAoIGRhdGUgPT0gbnVsbCB8fCBkYXRlID09PSAiIiA\/IGRlZmF1bHREYXRlIDogKCB0eXBlb2YgZGF0ZSA9PT0gInN0cmluZyIgPyBvZmZzZXRTdHJpbmcoIGRhdGUgKSA6DQoJCQkJKCB0eXBlb2YgZGF0ZSA9PT0gIm51bWJlciIgPyAoIGlzTmFOKCBkYXRlICkgPyBkZWZhdWx0RGF0ZSA6IG9mZnNldE51bWVyaWMoIGRhdGUgKSApIDogbmV3IERhdGUoIGRhdGUuZ2V0VGltZSgpICkgKSApICk7DQoNCgkJbmV3RGF0ZSA9ICggbmV3RGF0ZSAmJiBuZXdEYXRlLnRvU3RyaW5nKCkgPT09ICJJbnZhbGlkIERhdGUiID8gZGVmYXVsdERhdGUgOiBuZXdEYXRlICk7DQoJCWlmICggbmV3RGF0ZSApIHsNCgkJCW5ld0RhdGUuc2V0SG91cnMoIDAgKTsNCgkJCW5ld0RhdGUuc2V0TWludXRlcyggMCApOw0KCQkJbmV3RGF0ZS5zZXRTZWNvbmRzKCAwICk7DQoJCQluZXdEYXRlLnNldE1pbGxpc2Vjb25kcyggMCApOw0KCQl9DQoJCXJldHVybiB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3RGF0ZSApOw0KCX0sDQoNCgkvKiBIYW5kbGUgc3dpdGNoIHRvL2Zyb20gZGF5bGlnaHQgc2F2aW5nLg0KCSAqIEhvdXJzIG1heSBiZSBub24temVybyBvbiBkYXlsaWdodCBzYXZpbmcgY3V0LW92ZXI6DQoJICogPiAxMiB3aGVuIG1pZG5pZ2h0IGNoYW5nZW92ZXIsIGJ1dCB0aGVuIGNhbm5vdCBnZW5lcmF0ZQ0KCSAqIG1pZG5pZ2h0IGRhdGV0aW1lLCBzbyBqdW1wIHRvIDFBTSwgb3RoZXJ3aXNlIHJlc2V0Lg0KCSAqIEBwYXJhbSAgZGF0ZSAgKERhdGUpIHRoZSBkYXRlIHRvIGNoZWNrDQoJICogQHJldHVybiAgKERhdGUpIHRoZSBjb3JyZWN0ZWQgZGF0ZQ0KCSAqLw0KCV9kYXlsaWdodFNhdmluZ0FkanVzdDogZnVuY3Rpb24oIGRhdGUgKSB7DQoJCWlmICggIWRhdGUgKSB7DQoJCQlyZXR1cm4gbnVsbDsNCgkJfQ0KCQlkYXRlLnNldEhvdXJzKCBkYXRlLmdldEhvdXJzKCkgPiAxMiA\/IGRhdGUuZ2V0SG91cnMoKSArIDIgOiAwICk7DQoJCXJldHVybiBkYXRlOw0KCX0sDQoNCgkvKiBTZXQgdGhlIGRhdGUocykgZGlyZWN0bHkuICovDQoJX3NldERhdGU6IGZ1bmN0aW9uKCBpbnN0LCBkYXRlLCBub0NoYW5nZSApIHsNCgkJdmFyIGNsZWFyID0gIWRhdGUsDQoJCQlvcmlnTW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGgsDQoJCQlvcmlnWWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyLA0KCQkJbmV3RGF0ZSA9IHRoaXMuX3Jlc3RyaWN0TWluTWF4KCBpbnN0LCB0aGlzLl9kZXRlcm1pbmVEYXRlKCBpbnN0LCBkYXRlLCBuZXcgRGF0ZSgpICkgKTsNCg0KCQlpbnN0LnNlbGVjdGVkRGF5ID0gaW5zdC5jdXJyZW50RGF5ID0gbmV3RGF0ZS5nZXREYXRlKCk7DQoJCWluc3QuZHJhd01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoID0gaW5zdC5jdXJyZW50TW9udGggPSBuZXdEYXRlLmdldE1vbnRoKCk7DQoJCWluc3QuZHJhd1llYXIgPSBpbnN0LnNlbGVjdGVkWWVhciA9IGluc3QuY3VycmVudFllYXIgPSBuZXdEYXRlLmdldEZ1bGxZZWFyKCk7DQoJCWlmICggKCBvcmlnTW9udGggIT09IGluc3Quc2VsZWN0ZWRNb250aCB8fCBvcmlnWWVhciAhPT0gaW5zdC5zZWxlY3RlZFllYXIgKSAmJiAhbm9DaGFuZ2UgKSB7DQoJCQl0aGlzLl9ub3RpZnlDaGFuZ2UoIGluc3QgKTsNCgkJfQ0KCQl0aGlzLl9hZGp1c3RJbnN0RGF0ZSggaW5zdCApOw0KCQlpZiAoIGluc3QuaW5wdXQgKSB7DQoJCQlpbnN0LmlucHV0LnZhbCggY2xlYXIgPyAiIiA6IHRoaXMuX2Zvcm1hdERhdGUoIGluc3QgKSApOw0KCQl9DQoJfSwNCg0KCS8qIFJldHJpZXZlIHRoZSBkYXRlKHMpIGRpcmVjdGx5LiAqLw0KCV9nZXREYXRlOiBmdW5jdGlvbiggaW5zdCApIHsNCgkJdmFyIHN0YXJ0RGF0ZSA9ICggIWluc3QuY3VycmVudFllYXIgfHwgKCBpbnN0LmlucHV0ICYmIGluc3QuaW5wdXQudmFsKCkgPT09ICIiICkgPyBudWxsIDoNCgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSgNCgkJCWluc3QuY3VycmVudFllYXIsIGluc3QuY3VycmVudE1vbnRoLCBpbnN0LmN1cnJlbnREYXkgKSApICk7DQoJCQlyZXR1cm4gc3RhcnREYXRlOw0KCX0sDQoNCgkvKiBBdHRhY2ggdGhlIG9ueHh4IGhhbmRsZXJzLiAgVGhlc2UgYXJlIGRlY2xhcmVkIHN0YXRpY2FsbHkgc28NCgkgKiB0aGV5IHdvcmsgd2l0aCBzdGF0aWMgY29kZSB0cmFuc2Zvcm1lcnMgbGlrZSBDYWphLg0KCSAqLw0KCV9hdHRhY2hIYW5kbGVyczogZnVuY3Rpb24oIGluc3QgKSB7DQoJCXZhciBzdGVwTW9udGhzID0gdGhpcy5fZ2V0KCBpbnN0LCAic3RlcE1vbnRocyIgKSwNCgkJCWlkID0gIiMiICsgaW5zdC5pZC5yZXBsYWNlKCAvXFxcXC9nLCAiXFwiICk7DQoJCWluc3QuZHBEaXYuZmluZCggIltkYXRhLWhhbmRsZXJdIiApLm1hcCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgaGFuZGxlciA9IHsNCgkJCQlwcmV2OiBmdW5jdGlvbigpIHsNCgkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBpZCwgLXN0ZXBNb250aHMsICJNIiApOw0KCQkJCX0sDQoJCQkJbmV4dDogZnVuY3Rpb24oKSB7DQoJCQkJCSQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZSggaWQsICtzdGVwTW9udGhzLCAiTSIgKTsNCgkJCQl9LA0KCQkJCWhpZGU6IGZ1bmN0aW9uKCkgew0KCQkJCQkkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7DQoJCQkJfSwNCgkJCQl0b2RheTogZnVuY3Rpb24oKSB7DQoJCQkJCSQuZGF0ZXBpY2tlci5fZ290b1RvZGF5KCBpZCApOw0KCQkJCX0sDQoJCQkJc2VsZWN0RGF5OiBmdW5jdGlvbigpIHsNCgkJCQkJJC5kYXRlcGlja2VyLl9zZWxlY3REYXkoIGlkLCArdGhpcy5nZXRBdHRyaWJ1dGUoICJkYXRhLW1vbnRoIiApLCArdGhpcy5nZXRBdHRyaWJ1dGUoICJkYXRhLXllYXIiICksIHRoaXMgKTsNCgkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCX0sDQoJCQkJc2VsZWN0TW9udGg6IGZ1bmN0aW9uKCkgew0KCQkJCQkkLmRhdGVwaWNrZXIuX3NlbGVjdE1vbnRoWWVhciggaWQsIHRoaXMsICJNIiApOw0KCQkJCQlyZXR1cm4gZmFsc2U7DQoJCQkJfSwNCgkJCQlzZWxlY3RZZWFyOiBmdW5jdGlvbigpIHsNCgkJCQkJJC5kYXRlcGlja2VyLl9zZWxlY3RNb250aFllYXIoIGlkLCB0aGlzLCAiWSIgKTsNCgkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCX0NCgkJCX07DQoJCQkkKCB0aGlzICkub24oIHRoaXMuZ2V0QXR0cmlidXRlKCAiZGF0YS1ldmVudCIgKSwgaGFuZGxlclsgdGhpcy5nZXRBdHRyaWJ1dGUoICJkYXRhLWhhbmRsZXIiICkgXSApOw0KCQl9ICk7DQoJfSwNCg0KCS8qIEdlbmVyYXRlIHRoZSBIVE1MIGZvciB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgZGF0ZSBwaWNrZXIuICovDQoJX2dlbmVyYXRlSFRNTDogZnVuY3Rpb24oIGluc3QgKSB7DQoJCXZhciBtYXhEcmF3LCBwcmV2VGV4dCwgcHJldiwgbmV4dFRleHQsIG5leHQsIGN1cnJlbnRUZXh0LCBnb3RvRGF0ZSwNCgkJCWNvbnRyb2xzLCBidXR0b25QYW5lbCwgZmlyc3REYXksIHNob3dXZWVrLCBkYXlOYW1lcywgZGF5TmFtZXNNaW4sDQoJCQltb250aE5hbWVzLCBtb250aE5hbWVzU2hvcnQsIGJlZm9yZVNob3dEYXksIHNob3dPdGhlck1vbnRocywNCgkJCXNlbGVjdE90aGVyTW9udGhzLCBkZWZhdWx0RGF0ZSwgaHRtbCwgZG93LCByb3csIGdyb3VwLCBjb2wsIHNlbGVjdGVkRGF0ZSwNCgkJCWNvcm5lckNsYXNzLCBjYWxlbmRlciwgdGhlYWQsIGRheSwgZGF5c0luTW9udGgsIGxlYWREYXlzLCBjdXJSb3dzLCBudW1Sb3dzLA0KCQkJcHJpbnREYXRlLCBkUm93LCB0Ym9keSwgZGF5U2V0dGluZ3MsIG90aGVyTW9udGgsIHVuc2VsZWN0YWJsZSwNCgkJCXRlbXBEYXRlID0gbmV3IERhdGUoKSwNCgkJCXRvZGF5ID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoDQoJCQkJbmV3IERhdGUoIHRlbXBEYXRlLmdldEZ1bGxZZWFyKCksIHRlbXBEYXRlLmdldE1vbnRoKCksIHRlbXBEYXRlLmdldERhdGUoKSApICksIC8vIGNsZWFyIHRpbWUNCgkJCWlzUlRMID0gdGhpcy5fZ2V0KCBpbnN0LCAiaXNSVEwiICksDQoJCQlzaG93QnV0dG9uUGFuZWwgPSB0aGlzLl9nZXQoIGluc3QsICJzaG93QnV0dG9uUGFuZWwiICksDQoJCQloaWRlSWZOb1ByZXZOZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiaGlkZUlmTm9QcmV2TmV4dCIgKSwNCgkJCW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQgPSB0aGlzLl9nZXQoIGluc3QsICJuYXZpZ2F0aW9uQXNEYXRlRm9ybWF0IiApLA0KCQkJbnVtTW9udGhzID0gdGhpcy5fZ2V0TnVtYmVyT2ZNb250aHMoIGluc3QgKSwNCgkJCXNob3dDdXJyZW50QXRQb3MgPSB0aGlzLl9nZXQoIGluc3QsICJzaG93Q3VycmVudEF0UG9zIiApLA0KCQkJc3RlcE1vbnRocyA9IHRoaXMuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICksDQoJCQlpc011bHRpTW9udGggPSAoIG51bU1vbnRoc1sgMCBdICE9PSAxIHx8IG51bU1vbnRoc1sgMSBdICE9PSAxICksDQoJCQljdXJyZW50RGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCAoICFpbnN0LmN1cnJlbnREYXkgPyBuZXcgRGF0ZSggOTk5OSwgOSwgOSApIDoNCgkJCQluZXcgRGF0ZSggaW5zdC5jdXJyZW50WWVhciwgaW5zdC5jdXJyZW50TW9udGgsIGluc3QuY3VycmVudERheSApICkgKSwNCgkJCW1pbkRhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKCBpbnN0LCAibWluIiApLA0KCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtYXgiICksDQoJCQlkcmF3TW9udGggPSBpbnN0LmRyYXdNb250aCAtIHNob3dDdXJyZW50QXRQb3MsDQoJCQlkcmF3WWVhciA9IGluc3QuZHJhd1llYXI7DQoNCgkJaWYgKCBkcmF3TW9udGggPCAwICkgew0KCQkJZHJhd01vbnRoICs9IDEyOw0KCQkJZHJhd1llYXItLTsNCgkJfQ0KCQlpZiAoIG1heERhdGUgKSB7DQoJCQltYXhEcmF3ID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBtYXhEYXRlLmdldEZ1bGxZZWFyKCksDQoJCQkJbWF4RGF0ZS5nZXRNb250aCgpIC0gKCBudW1Nb250aHNbIDAgXSAqIG51bU1vbnRoc1sgMSBdICkgKyAxLCBtYXhEYXRlLmdldERhdGUoKSApICk7DQoJCQltYXhEcmF3ID0gKCBtaW5EYXRlICYmIG1heERyYXcgPCBtaW5EYXRlID8gbWluRGF0ZSA6IG1heERyYXcgKTsNCgkJCXdoaWxlICggdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBkcmF3WWVhciwgZHJhd01vbnRoLCAxICkgKSA+IG1heERyYXcgKSB7DQoJCQkJZHJhd01vbnRoLS07DQoJCQkJaWYgKCBkcmF3TW9udGggPCAwICkgew0KCQkJCQlkcmF3TW9udGggPSAxMTsNCgkJCQkJZHJhd1llYXItLTsNCgkJCQl9DQoJCQl9DQoJCX0NCgkJaW5zdC5kcmF3TW9udGggPSBkcmF3TW9udGg7DQoJCWluc3QuZHJhd1llYXIgPSBkcmF3WWVhcjsNCg0KCQlwcmV2VGV4dCA9IHRoaXMuX2dldCggaW5zdCwgInByZXZUZXh0IiApOw0KCQlwcmV2VGV4dCA9ICggIW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQgPyBwcmV2VGV4dCA6IHRoaXMuZm9ybWF0RGF0ZSggcHJldlRleHQsDQoJCQl0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIGRyYXdZZWFyLCBkcmF3TW9udGggLSBzdGVwTW9udGhzLCAxICkgKSwNCgkJCXRoaXMuX2dldEZvcm1hdENvbmZpZyggaW5zdCApICkgKTsNCg0KCQlwcmV2ID0gKCB0aGlzLl9jYW5BZGp1c3RNb250aCggaW5zdCwgLTEsIGRyYXdZZWFyLCBkcmF3TW9udGggKSA\/DQoJCQkiPGEgY2xhc3M9J3VpLWRhdGVwaWNrZXItcHJldiB1aS1jb3JuZXItYWxsJyBkYXRhLWhhbmRsZXI9J3ByZXYnIGRhdGEtZXZlbnQ9J2NsaWNrJyIgKw0KCQkJIiB0aXRsZT0nIiArIHByZXZUZXh0ICsgIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1jaXJjbGUtdHJpYW5nbGUtIiArICggaXNSVEwgPyAiZSIgOiAidyIgKSArICInPiIgKyBwcmV2VGV4dCArICI8L3NwYW4+PC9hPiIgOg0KCQkJKCBoaWRlSWZOb1ByZXZOZXh0ID8gIiIgOiAiPGEgY2xhc3M9J3VpLWRhdGVwaWNrZXItcHJldiB1aS1jb3JuZXItYWxsIHVpLXN0YXRlLWRpc2FibGVkJyB0aXRsZT0nIiArIHByZXZUZXh0ICsgIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1jaXJjbGUtdHJpYW5nbGUtIiArICggaXNSVEwgPyAiZSIgOiAidyIgKSArICInPiIgKyBwcmV2VGV4dCArICI8L3NwYW4+PC9hPiIgKSApOw0KDQoJCW5leHRUZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAibmV4dFRleHQiICk7DQoJCW5leHRUZXh0ID0gKCAhbmF2aWdhdGlvbkFzRGF0ZUZvcm1hdCA\/IG5leHRUZXh0IDogdGhpcy5mb3JtYXREYXRlKCBuZXh0VGV4dCwNCgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggZHJhd1llYXIsIGRyYXdNb250aCArIHN0ZXBNb250aHMsIDEgKSApLA0KCQkJdGhpcy5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICkgKSApOw0KDQoJCW5leHQgPSAoIHRoaXMuX2NhbkFkanVzdE1vbnRoKCBpbnN0LCArMSwgZHJhd1llYXIsIGRyYXdNb250aCApID8NCgkJCSI8YSBjbGFzcz0ndWktZGF0ZXBpY2tlci1uZXh0IHVpLWNvcm5lci1hbGwnIGRhdGEtaGFuZGxlcj0nbmV4dCcgZGF0YS1ldmVudD0nY2xpY2snIiArDQoJCQkiIHRpdGxlPSciICsgbmV4dFRleHQgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWNpcmNsZS10cmlhbmdsZS0iICsgKCBpc1JUTCA\/ICJ3IiA6ICJlIiApICsgIic+IiArIG5leHRUZXh0ICsgIjwvc3Bhbj48L2E+IiA6DQoJCQkoIGhpZGVJZk5vUHJldk5leHQgPyAiIiA6ICI8YSBjbGFzcz0ndWktZGF0ZXBpY2tlci1uZXh0IHVpLWNvcm5lci1hbGwgdWktc3RhdGUtZGlzYWJsZWQnIHRpdGxlPSciICsgbmV4dFRleHQgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWNpcmNsZS10cmlhbmdsZS0iICsgKCBpc1JUTCA\/ICJ3IiA6ICJlIiApICsgIic+IiArIG5leHRUZXh0ICsgIjwvc3Bhbj48L2E+IiApICk7DQoNCgkJY3VycmVudFRleHQgPSB0aGlzLl9nZXQoIGluc3QsICJjdXJyZW50VGV4dCIgKTsNCgkJZ290b0RhdGUgPSAoIHRoaXMuX2dldCggaW5zdCwgImdvdG9DdXJyZW50IiApICYmIGluc3QuY3VycmVudERheSA\/IGN1cnJlbnREYXRlIDogdG9kYXkgKTsNCgkJY3VycmVudFRleHQgPSAoICFuYXZpZ2F0aW9uQXNEYXRlRm9ybWF0ID8gY3VycmVudFRleHQgOg0KCQkJdGhpcy5mb3JtYXREYXRlKCBjdXJyZW50VGV4dCwgZ290b0RhdGUsIHRoaXMuX2dldEZvcm1hdENvbmZpZyggaW5zdCApICkgKTsNCg0KCQljb250cm9scyA9ICggIWluc3QuaW5saW5lID8gIjxidXR0b24gdHlwZT0nYnV0dG9uJyBjbGFzcz0ndWktZGF0ZXBpY2tlci1jbG9zZSB1aS1zdGF0ZS1kZWZhdWx0IHVpLXByaW9yaXR5LXByaW1hcnkgdWktY29ybmVyLWFsbCcgZGF0YS1oYW5kbGVyPSdoaWRlJyBkYXRhLWV2ZW50PSdjbGljayc+IiArDQoJCQl0aGlzLl9nZXQoIGluc3QsICJjbG9zZVRleHQiICkgKyAiPC9idXR0b24+IiA6ICIiICk7DQoNCgkJYnV0dG9uUGFuZWwgPSAoIHNob3dCdXR0b25QYW5lbCApID8gIjxkaXYgY2xhc3M9J3VpLWRhdGVwaWNrZXItYnV0dG9ucGFuZSB1aS13aWRnZXQtY29udGVudCc+IiArICggaXNSVEwgPyBjb250cm9scyA6ICIiICkgKw0KCQkJKCB0aGlzLl9pc0luUmFuZ2UoIGluc3QsIGdvdG9EYXRlICkgPyAiPGJ1dHRvbiB0eXBlPSdidXR0b24nIGNsYXNzPSd1aS1kYXRlcGlja2VyLWN1cnJlbnQgdWktc3RhdGUtZGVmYXVsdCB1aS1wcmlvcml0eS1zZWNvbmRhcnkgdWktY29ybmVyLWFsbCcgZGF0YS1oYW5kbGVyPSd0b2RheScgZGF0YS1ldmVudD0nY2xpY2snIiArDQoJCQkiPiIgKyBjdXJyZW50VGV4dCArICI8L2J1dHRvbj4iIDogIiIgKSArICggaXNSVEwgPyAiIiA6IGNvbnRyb2xzICkgKyAiPC9kaXY+IiA6ICIiOw0KDQoJCWZpcnN0RGF5ID0gcGFyc2VJbnQoIHRoaXMuX2dldCggaW5zdCwgImZpcnN0RGF5IiApLCAxMCApOw0KCQlmaXJzdERheSA9ICggaXNOYU4oIGZpcnN0RGF5ICkgPyAwIDogZmlyc3REYXkgKTsNCg0KCQlzaG93V2VlayA9IHRoaXMuX2dldCggaW5zdCwgInNob3dXZWVrIiApOw0KCQlkYXlOYW1lcyA9IHRoaXMuX2dldCggaW5zdCwgImRheU5hbWVzIiApOw0KCQlkYXlOYW1lc01pbiA9IHRoaXMuX2dldCggaW5zdCwgImRheU5hbWVzTWluIiApOw0KCQltb250aE5hbWVzID0gdGhpcy5fZ2V0KCBpbnN0LCAibW9udGhOYW1lcyIgKTsNCgkJbW9udGhOYW1lc1Nob3J0ID0gdGhpcy5fZ2V0KCBpbnN0LCAibW9udGhOYW1lc1Nob3J0IiApOw0KCQliZWZvcmVTaG93RGF5ID0gdGhpcy5fZ2V0KCBpbnN0LCAiYmVmb3JlU2hvd0RheSIgKTsNCgkJc2hvd090aGVyTW9udGhzID0gdGhpcy5fZ2V0KCBpbnN0LCAic2hvd090aGVyTW9udGhzIiApOw0KCQlzZWxlY3RPdGhlck1vbnRocyA9IHRoaXMuX2dldCggaW5zdCwgInNlbGVjdE90aGVyTW9udGhzIiApOw0KCQlkZWZhdWx0RGF0ZSA9IHRoaXMuX2dldERlZmF1bHREYXRlKCBpbnN0ICk7DQoJCWh0bWwgPSAiIjsNCg0KCQlmb3IgKCByb3cgPSAwOyByb3cgPCBudW1Nb250aHNbIDAgXTsgcm93KysgKSB7DQoJCQlncm91cCA9ICIiOw0KCQkJdGhpcy5tYXhSb3dzID0gNDsNCgkJCWZvciAoIGNvbCA9IDA7IGNvbCA8IG51bU1vbnRoc1sgMSBdOyBjb2wrKyApIHsNCgkJCQlzZWxlY3RlZERhdGUgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIGRyYXdZZWFyLCBkcmF3TW9udGgsIGluc3Quc2VsZWN0ZWREYXkgKSApOw0KCQkJCWNvcm5lckNsYXNzID0gIiB1aS1jb3JuZXItYWxsIjsNCgkJCQljYWxlbmRlciA9ICIiOw0KCQkJCWlmICggaXNNdWx0aU1vbnRoICkgew0KCQkJCQljYWxlbmRlciArPSAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci1ncm91cCI7DQoJCQkJCWlmICggbnVtTW9udGhzWyAxIF0gPiAxICkgew0KCQkJCQkJc3dpdGNoICggY29sICkgew0KCQkJCQkJCWNhc2UgMDogY2FsZW5kZXIgKz0gIiB1aS1kYXRlcGlja2VyLWdyb3VwLWZpcnN0IjsNCgkJCQkJCQkJY29ybmVyQ2xhc3MgPSAiIHVpLWNvcm5lci0iICsgKCBpc1JUTCA\/ICJyaWdodCIgOiAibGVmdCIgKTsgYnJlYWs7DQoJCQkJCQkJY2FzZSBudW1Nb250aHNbIDEgXSAtIDE6IGNhbGVuZGVyICs9ICIgdWktZGF0ZXBpY2tlci1ncm91cC1sYXN0IjsNCgkJCQkJCQkJY29ybmVyQ2xhc3MgPSAiIHVpLWNvcm5lci0iICsgKCBpc1JUTCA\/ICJsZWZ0IiA6ICJyaWdodCIgKTsgYnJlYWs7DQoJCQkJCQkJZGVmYXVsdDogY2FsZW5kZXIgKz0gIiB1aS1kYXRlcGlja2VyLWdyb3VwLW1pZGRsZSI7IGNvcm5lckNsYXNzID0gIiI7IGJyZWFrOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJCWNhbGVuZGVyICs9ICInPiI7DQoJCQkJfQ0KCQkJCWNhbGVuZGVyICs9ICI8ZGl2IGNsYXNzPSd1aS1kYXRlcGlja2VyLWhlYWRlciB1aS13aWRnZXQtaGVhZGVyIHVpLWhlbHBlci1jbGVhcmZpeCIgKyBjb3JuZXJDbGFzcyArICInPiIgKw0KCQkJCQkoIC9hbGx8bGVmdC8udGVzdCggY29ybmVyQ2xhc3MgKSAmJiByb3cgPT09IDAgPyAoIGlzUlRMID8gbmV4dCA6IHByZXYgKSA6ICIiICkgKw0KCQkJCQkoIC9hbGx8cmlnaHQvLnRlc3QoIGNvcm5lckNsYXNzICkgJiYgcm93ID09PSAwID8gKCBpc1JUTCA\/IHByZXYgOiBuZXh0ICkgOiAiIiApICsNCgkJCQkJdGhpcy5fZ2VuZXJhdGVNb250aFllYXJIZWFkZXIoIGluc3QsIGRyYXdNb250aCwgZHJhd1llYXIsIG1pbkRhdGUsIG1heERhdGUsDQoJCQkJCXJvdyA+IDAgfHwgY29sID4gMCwgbW9udGhOYW1lcywgbW9udGhOYW1lc1Nob3J0ICkgKyAvLyBkcmF3IG1vbnRoIGhlYWRlcnMNCgkJCQkJIjwvZGl2Pjx0YWJsZSBjbGFzcz0ndWktZGF0ZXBpY2tlci1jYWxlbmRhcic+PHRoZWFkPiIgKw0KCQkJCQkiPHRyPiI7DQoJCQkJdGhlYWQgPSAoIHNob3dXZWVrID8gIjx0aCBjbGFzcz0ndWktZGF0ZXBpY2tlci13ZWVrLWNvbCc+IiArIHRoaXMuX2dldCggaW5zdCwgIndlZWtIZWFkZXIiICkgKyAiPC90aD4iIDogIiIgKTsNCgkJCQlmb3IgKCBkb3cgPSAwOyBkb3cgPCA3OyBkb3crKyApIHsgLy8gZGF5cyBvZiB0aGUgd2Vlaw0KCQkJCQlkYXkgPSAoIGRvdyArIGZpcnN0RGF5ICkgJSA3Ow0KCQkJCQl0aGVhZCArPSAiPHRoIHNjb3BlPSdjb2wnIiArICggKCBkb3cgKyBmaXJzdERheSArIDYgKSAlIDcgPj0gNSA\/ICIgY2xhc3M9J3VpLWRhdGVwaWNrZXItd2Vlay1lbmQnIiA6ICIiICkgKyAiPiIgKw0KCQkJCQkJIjxzcGFuIHRpdGxlPSciICsgZGF5TmFtZXNbIGRheSBdICsgIic+IiArIGRheU5hbWVzTWluWyBkYXkgXSArICI8L3NwYW4+PC90aD4iOw0KCQkJCX0NCgkJCQljYWxlbmRlciArPSB0aGVhZCArICI8L3RyPjwvdGhlYWQ+PHRib2R5PiI7DQoJCQkJZGF5c0luTW9udGggPSB0aGlzLl9nZXREYXlzSW5Nb250aCggZHJhd1llYXIsIGRyYXdNb250aCApOw0KCQkJCWlmICggZHJhd1llYXIgPT09IGluc3Quc2VsZWN0ZWRZZWFyICYmIGRyYXdNb250aCA9PT0gaW5zdC5zZWxlY3RlZE1vbnRoICkgew0KCQkJCQlpbnN0LnNlbGVjdGVkRGF5ID0gTWF0aC5taW4oIGluc3Quc2VsZWN0ZWREYXksIGRheXNJbk1vbnRoICk7DQoJCQkJfQ0KCQkJCWxlYWREYXlzID0gKCB0aGlzLl9nZXRGaXJzdERheU9mTW9udGgoIGRyYXdZZWFyLCBkcmF3TW9udGggKSAtIGZpcnN0RGF5ICsgNyApICUgNzsNCgkJCQljdXJSb3dzID0gTWF0aC5jZWlsKCAoIGxlYWREYXlzICsgZGF5c0luTW9udGggKSAvIDcgKTsgLy8gY2FsY3VsYXRlIHRoZSBudW1iZXIgb2Ygcm93cyB0byBnZW5lcmF0ZQ0KCQkJCW51bVJvd3MgPSAoIGlzTXVsdGlNb250aCA\/IHRoaXMubWF4Um93cyA+IGN1clJvd3MgPyB0aGlzLm1heFJvd3MgOiBjdXJSb3dzIDogY3VyUm93cyApOyAvL0lmIG11bHRpcGxlIG1vbnRocywgdXNlIHRoZSBoaWdoZXIgbnVtYmVyIG9mIHJvd3MgKHNlZSAjNzA0MykNCgkJCQl0aGlzLm1heFJvd3MgPSBudW1Sb3dzOw0KCQkJCXByaW50RGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggZHJhd1llYXIsIGRyYXdNb250aCwgMSAtIGxlYWREYXlzICkgKTsNCgkJCQlmb3IgKCBkUm93ID0gMDsgZFJvdyA8IG51bVJvd3M7IGRSb3crKyApIHsgLy8gY3JlYXRlIGRhdGUgcGlja2VyIHJvd3MNCgkJCQkJY2FsZW5kZXIgKz0gIjx0cj4iOw0KCQkJCQl0Ym9keSA9ICggIXNob3dXZWVrID8gIiIgOiAiPHRkIGNsYXNzPSd1aS1kYXRlcGlja2VyLXdlZWstY29sJz4iICsNCgkJCQkJCXRoaXMuX2dldCggaW5zdCwgImNhbGN1bGF0ZVdlZWsiICkoIHByaW50RGF0ZSApICsgIjwvdGQ+IiApOw0KCQkJCQlmb3IgKCBkb3cgPSAwOyBkb3cgPCA3OyBkb3crKyApIHsgLy8gY3JlYXRlIGRhdGUgcGlja2VyIGRheXMNCgkJCQkJCWRheVNldHRpbmdzID0gKCBiZWZvcmVTaG93RGF5ID8NCgkJCQkJCQliZWZvcmVTaG93RGF5LmFwcGx5KCAoIGluc3QuaW5wdXQgPyBpbnN0LmlucHV0WyAwIF0gOiBudWxsICksIFsgcHJpbnREYXRlIF0gKSA6IFsgdHJ1ZSwgIiIgXSApOw0KCQkJCQkJb3RoZXJNb250aCA9ICggcHJpbnREYXRlLmdldE1vbnRoKCkgIT09IGRyYXdNb250aCApOw0KCQkJCQkJdW5zZWxlY3RhYmxlID0gKCBvdGhlck1vbnRoICYmICFzZWxlY3RPdGhlck1vbnRocyApIHx8ICFkYXlTZXR0aW5nc1sgMCBdIHx8DQoJCQkJCQkJKCBtaW5EYXRlICYmIHByaW50RGF0ZSA8IG1pbkRhdGUgKSB8fCAoIG1heERhdGUgJiYgcHJpbnREYXRlID4gbWF4RGF0ZSApOw0KCQkJCQkJdGJvZHkgKz0gIjx0ZCBjbGFzcz0nIiArDQoJCQkJCQkJKCAoIGRvdyArIGZpcnN0RGF5ICsgNiApICUgNyA+PSA1ID8gIiB1aS1kYXRlcGlja2VyLXdlZWstZW5kIiA6ICIiICkgKyAvLyBoaWdobGlnaHQgd2Vla2VuZHMNCgkJCQkJCQkoIG90aGVyTW9udGggPyAiIHVpLWRhdGVwaWNrZXItb3RoZXItbW9udGgiIDogIiIgKSArIC8vIGhpZ2hsaWdodCBkYXlzIGZyb20gb3RoZXIgbW9udGhzDQoJCQkJCQkJKCAoIHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IHNlbGVjdGVkRGF0ZS5nZXRUaW1lKCkgJiYgZHJhd01vbnRoID09PSBpbnN0LnNlbGVjdGVkTW9udGggJiYgaW5zdC5fa2V5RXZlbnQgKSB8fCAvLyB1c2VyIHByZXNzZWQga2V5DQoJCQkJCQkJKCBkZWZhdWx0RGF0ZS5nZXRUaW1lKCkgPT09IHByaW50RGF0ZS5nZXRUaW1lKCkgJiYgZGVmYXVsdERhdGUuZ2V0VGltZSgpID09PSBzZWxlY3RlZERhdGUuZ2V0VGltZSgpICkgPw0KDQoJCQkJCQkJLy8gb3IgZGVmYXVsdERhdGUgaXMgY3VycmVudCBwcmludGVkRGF0ZSBhbmQgZGVmYXVsdERhdGUgaXMgc2VsZWN0ZWREYXRlDQoJCQkJCQkJIiAiICsgdGhpcy5fZGF5T3ZlckNsYXNzIDogIiIgKSArIC8vIGhpZ2hsaWdodCBzZWxlY3RlZCBkYXkNCgkJCQkJCQkoIHVuc2VsZWN0YWJsZSA\/ICIgIiArIHRoaXMuX3Vuc2VsZWN0YWJsZUNsYXNzICsgIiB1aS1zdGF0ZS1kaXNhYmxlZCIgOiAiIiApICsgIC8vIGhpZ2hsaWdodCB1bnNlbGVjdGFibGUgZGF5cw0KCQkJCQkJCSggb3RoZXJNb250aCAmJiAhc2hvd090aGVyTW9udGhzID8gIiIgOiAiICIgKyBkYXlTZXR0aW5nc1sgMSBdICsgLy8gaGlnaGxpZ2h0IGN1c3RvbSBkYXRlcw0KCQkJCQkJCSggcHJpbnREYXRlLmdldFRpbWUoKSA9PT0gY3VycmVudERhdGUuZ2V0VGltZSgpID8gIiAiICsgdGhpcy5fY3VycmVudENsYXNzIDogIiIgKSArIC8vIGhpZ2hsaWdodCBzZWxlY3RlZCBkYXkNCgkJCQkJCQkoIHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IHRvZGF5LmdldFRpbWUoKSA\/ICIgdWktZGF0ZXBpY2tlci10b2RheSIgOiAiIiApICkgKyAiJyIgKyAvLyBoaWdobGlnaHQgdG9kYXkgKGlmIGRpZmZlcmVudCkNCgkJCQkJCQkoICggIW90aGVyTW9udGggfHwgc2hvd090aGVyTW9udGhzICkgJiYgZGF5U2V0dGluZ3NbIDIgXSA\/ICIgdGl0bGU9JyIgKyBkYXlTZXR0aW5nc1sgMiBdLnJlcGxhY2UoIC8nL2csICImIzM5OyIgKSArICInIiA6ICIiICkgKyAvLyBjZWxsIHRpdGxlDQoJCQkJCQkJKCB1bnNlbGVjdGFibGUgPyAiIiA6ICIgZGF0YS1oYW5kbGVyPSdzZWxlY3REYXknIGRhdGEtZXZlbnQ9J2NsaWNrJyBkYXRhLW1vbnRoPSciICsgcHJpbnREYXRlLmdldE1vbnRoKCkgKyAiJyBkYXRhLXllYXI9JyIgKyBwcmludERhdGUuZ2V0RnVsbFllYXIoKSArICInIiApICsgIj4iICsgLy8gYWN0aW9ucw0KCQkJCQkJCSggb3RoZXJNb250aCAmJiAhc2hvd090aGVyTW9udGhzID8gIiYjeGEwOyIgOiAvLyBkaXNwbGF5IGZvciBvdGhlciBtb250aHMNCgkJCQkJCQkoIHVuc2VsZWN0YWJsZSA\/ICI8c3BhbiBjbGFzcz0ndWktc3RhdGUtZGVmYXVsdCc+IiArIHByaW50RGF0ZS5nZXREYXRlKCkgKyAiPC9zcGFuPiIgOiAiPGEgY2xhc3M9J3VpLXN0YXRlLWRlZmF1bHQiICsNCgkJCQkJCQkoIHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IHRvZGF5LmdldFRpbWUoKSA\/ICIgdWktc3RhdGUtaGlnaGxpZ2h0IiA6ICIiICkgKw0KCQkJCQkJCSggcHJpbnREYXRlLmdldFRpbWUoKSA9PT0gY3VycmVudERhdGUuZ2V0VGltZSgpID8gIiB1aS1zdGF0ZS1hY3RpdmUiIDogIiIgKSArIC8vIGhpZ2hsaWdodCBzZWxlY3RlZCBkYXkNCgkJCQkJCQkoIG90aGVyTW9udGggPyAiIHVpLXByaW9yaXR5LXNlY29uZGFyeSIgOiAiIiApICsgLy8gZGlzdGluZ3Vpc2ggZGF0ZXMgZnJvbSBvdGhlciBtb250aHMNCgkJCQkJCQkiJyBocmVmPScjJz4iICsgcHJpbnREYXRlLmdldERhdGUoKSArICI8L2E+IiApICkgKyAiPC90ZD4iOyAvLyBkaXNwbGF5IHNlbGVjdGFibGUgZGF0ZQ0KCQkJCQkJcHJpbnREYXRlLnNldERhdGUoIHByaW50RGF0ZS5nZXREYXRlKCkgKyAxICk7DQoJCQkJCQlwcmludERhdGUgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggcHJpbnREYXRlICk7DQoJCQkJCX0NCgkJCQkJY2FsZW5kZXIgKz0gdGJvZHkgKyAiPC90cj4iOw0KCQkJCX0NCgkJCQlkcmF3TW9udGgrKzsNCgkJCQlpZiAoIGRyYXdNb250aCA+IDExICkgew0KCQkJCQlkcmF3TW9udGggPSAwOw0KCQkJCQlkcmF3WWVhcisrOw0KCQkJCX0NCgkJCQljYWxlbmRlciArPSAiPC90Ym9keT48L3RhYmxlPiIgKyAoIGlzTXVsdGlNb250aCA\/ICI8L2Rpdj4iICsNCgkJCQkJCQkoICggbnVtTW9udGhzWyAwIF0gPiAwICYmIGNvbCA9PT0gbnVtTW9udGhzWyAxIF0gLSAxICkgPyAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci1yb3ctYnJlYWsnPjwvZGl2PiIgOiAiIiApIDogIiIgKTsNCgkJCQlncm91cCArPSBjYWxlbmRlcjsNCgkJCX0NCgkJCWh0bWwgKz0gZ3JvdXA7DQoJCX0NCgkJaHRtbCArPSBidXR0b25QYW5lbDsNCgkJaW5zdC5fa2V5RXZlbnQgPSBmYWxzZTsNCgkJcmV0dXJuIGh0bWw7DQoJfSwNCg0KCS8qIEdlbmVyYXRlIHRoZSBtb250aCBhbmQgeWVhciBoZWFkZXIuICovDQoJX2dlbmVyYXRlTW9udGhZZWFySGVhZGVyOiBmdW5jdGlvbiggaW5zdCwgZHJhd01vbnRoLCBkcmF3WWVhciwgbWluRGF0ZSwgbWF4RGF0ZSwNCgkJCXNlY29uZGFyeSwgbW9udGhOYW1lcywgbW9udGhOYW1lc1Nob3J0ICkgew0KDQoJCXZhciBpbk1pblllYXIsIGluTWF4WWVhciwgbW9udGgsIHllYXJzLCB0aGlzWWVhciwgZGV0ZXJtaW5lWWVhciwgeWVhciwgZW5kWWVhciwNCgkJCWNoYW5nZU1vbnRoID0gdGhpcy5fZ2V0KCBpbnN0LCAiY2hhbmdlTW9udGgiICksDQoJCQljaGFuZ2VZZWFyID0gdGhpcy5fZ2V0KCBpbnN0LCAiY2hhbmdlWWVhciIgKSwNCgkJCXNob3dNb250aEFmdGVyWWVhciA9IHRoaXMuX2dldCggaW5zdCwgInNob3dNb250aEFmdGVyWWVhciIgKSwNCgkJCWh0bWwgPSAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci10aXRsZSc+IiwNCgkJCW1vbnRoSHRtbCA9ICIiOw0KDQoJCS8vIE1vbnRoIHNlbGVjdGlvbg0KCQlpZiAoIHNlY29uZGFyeSB8fCAhY2hhbmdlTW9udGggKSB7DQoJCQltb250aEh0bWwgKz0gIjxzcGFuIGNsYXNzPSd1aS1kYXRlcGlja2VyLW1vbnRoJz4iICsgbW9udGhOYW1lc1sgZHJhd01vbnRoIF0gKyAiPC9zcGFuPiI7DQoJCX0gZWxzZSB7DQoJCQlpbk1pblllYXIgPSAoIG1pbkRhdGUgJiYgbWluRGF0ZS5nZXRGdWxsWWVhcigpID09PSBkcmF3WWVhciApOw0KCQkJaW5NYXhZZWFyID0gKCBtYXhEYXRlICYmIG1heERhdGUuZ2V0RnVsbFllYXIoKSA9PT0gZHJhd1llYXIgKTsNCgkJCW1vbnRoSHRtbCArPSAiPHNlbGVjdCBjbGFzcz0ndWktZGF0ZXBpY2tlci1tb250aCcgZGF0YS1oYW5kbGVyPSdzZWxlY3RNb250aCcgZGF0YS1ldmVudD0nY2hhbmdlJz4iOw0KCQkJZm9yICggbW9udGggPSAwOyBtb250aCA8IDEyOyBtb250aCsrICkgew0KCQkJCWlmICggKCAhaW5NaW5ZZWFyIHx8IG1vbnRoID49IG1pbkRhdGUuZ2V0TW9udGgoKSApICYmICggIWluTWF4WWVhciB8fCBtb250aCA8PSBtYXhEYXRlLmdldE1vbnRoKCkgKSApIHsNCgkJCQkJbW9udGhIdG1sICs9ICI8b3B0aW9uIHZhbHVlPSciICsgbW9udGggKyAiJyIgKw0KCQkJCQkJKCBtb250aCA9PT0gZHJhd01vbnRoID8gIiBzZWxlY3RlZD0nc2VsZWN0ZWQnIiA6ICIiICkgKw0KCQkJCQkJIj4iICsgbW9udGhOYW1lc1Nob3J0WyBtb250aCBdICsgIjwvb3B0aW9uPiI7DQoJCQkJfQ0KCQkJfQ0KCQkJbW9udGhIdG1sICs9ICI8L3NlbGVjdD4iOw0KCQl9DQoNCgkJaWYgKCAhc2hvd01vbnRoQWZ0ZXJZZWFyICkgew0KCQkJaHRtbCArPSBtb250aEh0bWwgKyAoIHNlY29uZGFyeSB8fCAhKCBjaGFuZ2VNb250aCAmJiBjaGFuZ2VZZWFyICkgPyAiJiN4YTA7IiA6ICIiICk7DQoJCX0NCg0KCQkvLyBZZWFyIHNlbGVjdGlvbg0KCQlpZiAoICFpbnN0LnllYXJzaHRtbCApIHsNCgkJCWluc3QueWVhcnNodG1sID0gIiI7DQoJCQlpZiAoIHNlY29uZGFyeSB8fCAhY2hhbmdlWWVhciApIHsNCgkJCQlodG1sICs9ICI8c3BhbiBjbGFzcz0ndWktZGF0ZXBpY2tlci15ZWFyJz4iICsgZHJhd1llYXIgKyAiPC9zcGFuPiI7DQoJCQl9IGVsc2Ugew0KDQoJCQkJLy8gZGV0ZXJtaW5lIHJhbmdlIG9mIHllYXJzIHRvIGRpc3BsYXkNCgkJCQl5ZWFycyA9IHRoaXMuX2dldCggaW5zdCwgInllYXJSYW5nZSIgKS5zcGxpdCggIjoiICk7DQoJCQkJdGhpc1llYXIgPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7DQoJCQkJZGV0ZXJtaW5lWWVhciA9IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJCQkJdmFyIHllYXIgPSAoIHZhbHVlLm1hdGNoKCAvY1srXC1dLiovICkgPyBkcmF3WWVhciArIHBhcnNlSW50KCB2YWx1ZS5zdWJzdHJpbmcoIDEgKSwgMTAgKSA6DQoJCQkJCQkoIHZhbHVlLm1hdGNoKCAvWytcLV0uKi8gKSA\/IHRoaXNZZWFyICsgcGFyc2VJbnQoIHZhbHVlLCAxMCApIDoNCgkJCQkJCXBhcnNlSW50KCB2YWx1ZSwgMTAgKSApICk7DQoJCQkJCXJldHVybiAoIGlzTmFOKCB5ZWFyICkgPyB0aGlzWWVhciA6IHllYXIgKTsNCgkJCQl9Ow0KCQkJCXllYXIgPSBkZXRlcm1pbmVZZWFyKCB5ZWFyc1sgMCBdICk7DQoJCQkJZW5kWWVhciA9IE1hdGgubWF4KCB5ZWFyLCBkZXRlcm1pbmVZZWFyKCB5ZWFyc1sgMSBdIHx8ICIiICkgKTsNCgkJCQl5ZWFyID0gKCBtaW5EYXRlID8gTWF0aC5tYXgoIHllYXIsIG1pbkRhdGUuZ2V0RnVsbFllYXIoKSApIDogeWVhciApOw0KCQkJCWVuZFllYXIgPSAoIG1heERhdGUgPyBNYXRoLm1pbiggZW5kWWVhciwgbWF4RGF0ZS5nZXRGdWxsWWVhcigpICkgOiBlbmRZZWFyICk7DQoJCQkJaW5zdC55ZWFyc2h0bWwgKz0gIjxzZWxlY3QgY2xhc3M9J3VpLWRhdGVwaWNrZXIteWVhcicgZGF0YS1oYW5kbGVyPSdzZWxlY3RZZWFyJyBkYXRhLWV2ZW50PSdjaGFuZ2UnPiI7DQoJCQkJZm9yICggOyB5ZWFyIDw9IGVuZFllYXI7IHllYXIrKyApIHsNCgkJCQkJaW5zdC55ZWFyc2h0bWwgKz0gIjxvcHRpb24gdmFsdWU9JyIgKyB5ZWFyICsgIiciICsNCgkJCQkJCSggeWVhciA9PT0gZHJhd1llYXIgPyAiIHNlbGVjdGVkPSdzZWxlY3RlZCciIDogIiIgKSArDQoJCQkJCQkiPiIgKyB5ZWFyICsgIjwvb3B0aW9uPiI7DQoJCQkJfQ0KCQkJCWluc3QueWVhcnNodG1sICs9ICI8L3NlbGVjdD4iOw0KDQoJCQkJaHRtbCArPSBpbnN0LnllYXJzaHRtbDsNCgkJCQlpbnN0LnllYXJzaHRtbCA9IG51bGw7DQoJCQl9DQoJCX0NCg0KCQlodG1sICs9IHRoaXMuX2dldCggaW5zdCwgInllYXJTdWZmaXgiICk7DQoJCWlmICggc2hvd01vbnRoQWZ0ZXJZZWFyICkgew0KCQkJaHRtbCArPSAoIHNlY29uZGFyeSB8fCAhKCBjaGFuZ2VNb250aCAmJiBjaGFuZ2VZZWFyICkgPyAiJiN4YTA7IiA6ICIiICkgKyBtb250aEh0bWw7DQoJCX0NCgkJaHRtbCArPSAiPC9kaXY+IjsgLy8gQ2xvc2UgZGF0ZXBpY2tlcl9oZWFkZXINCgkJcmV0dXJuIGh0bWw7DQoJfSwNCg0KCS8qIEFkanVzdCBvbmUgb2YgdGhlIGRhdGUgc3ViLWZpZWxkcy4gKi8NCglfYWRqdXN0SW5zdERhdGU6IGZ1bmN0aW9uKCBpbnN0LCBvZmZzZXQsIHBlcmlvZCApIHsNCgkJdmFyIHllYXIgPSBpbnN0LnNlbGVjdGVkWWVhciArICggcGVyaW9kID09PSAiWSIgPyBvZmZzZXQgOiAwICksDQoJCQltb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCArICggcGVyaW9kID09PSAiTSIgPyBvZmZzZXQgOiAwICksDQoJCQlkYXkgPSBNYXRoLm1pbiggaW5zdC5zZWxlY3RlZERheSwgdGhpcy5fZ2V0RGF5c0luTW9udGgoIHllYXIsIG1vbnRoICkgKSArICggcGVyaW9kID09PSAiRCIgPyBvZmZzZXQgOiAwICksDQoJCQlkYXRlID0gdGhpcy5fcmVzdHJpY3RNaW5NYXgoIGluc3QsIHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggeWVhciwgbW9udGgsIGRheSApICkgKTsNCg0KCQlpbnN0LnNlbGVjdGVkRGF5ID0gZGF0ZS5nZXREYXRlKCk7DQoJCWluc3QuZHJhd01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoID0gZGF0ZS5nZXRNb250aCgpOw0KCQlpbnN0LmRyYXdZZWFyID0gaW5zdC5zZWxlY3RlZFllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7DQoJCWlmICggcGVyaW9kID09PSAiTSIgfHwgcGVyaW9kID09PSAiWSIgKSB7DQoJCQl0aGlzLl9ub3RpZnlDaGFuZ2UoIGluc3QgKTsNCgkJfQ0KCX0sDQoNCgkvKiBFbnN1cmUgYSBkYXRlIGlzIHdpdGhpbiBhbnkgbWluL21heCBib3VuZHMuICovDQoJX3Jlc3RyaWN0TWluTWF4OiBmdW5jdGlvbiggaW5zdCwgZGF0ZSApIHsNCgkJdmFyIG1pbkRhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKCBpbnN0LCAibWluIiApLA0KCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtYXgiICksDQoJCQluZXdEYXRlID0gKCBtaW5EYXRlICYmIGRhdGUgPCBtaW5EYXRlID8gbWluRGF0ZSA6IGRhdGUgKTsNCgkJcmV0dXJuICggbWF4RGF0ZSAmJiBuZXdEYXRlID4gbWF4RGF0ZSA\/IG1heERhdGUgOiBuZXdEYXRlICk7DQoJfSwNCg0KCS8qIE5vdGlmeSBjaGFuZ2Ugb2YgbW9udGgveWVhci4gKi8NCglfbm90aWZ5Q2hhbmdlOiBmdW5jdGlvbiggaW5zdCApIHsNCgkJdmFyIG9uQ2hhbmdlID0gdGhpcy5fZ2V0KCBpbnN0LCAib25DaGFuZ2VNb250aFllYXIiICk7DQoJCWlmICggb25DaGFuZ2UgKSB7DQoJCQlvbkNoYW5nZS5hcHBseSggKCBpbnN0LmlucHV0ID8gaW5zdC5pbnB1dFsgMCBdIDogbnVsbCApLA0KCQkJCVsgaW5zdC5zZWxlY3RlZFllYXIsIGluc3Quc2VsZWN0ZWRNb250aCArIDEsIGluc3QgXSApOw0KCQl9DQoJfSwNCg0KCS8qIERldGVybWluZSB0aGUgbnVtYmVyIG9mIG1vbnRocyB0byBzaG93LiAqLw0KCV9nZXROdW1iZXJPZk1vbnRoczogZnVuY3Rpb24oIGluc3QgKSB7DQoJCXZhciBudW1Nb250aHMgPSB0aGlzLl9nZXQoIGluc3QsICJudW1iZXJPZk1vbnRocyIgKTsNCgkJcmV0dXJuICggbnVtTW9udGhzID09IG51bGwgPyBbIDEsIDEgXSA6ICggdHlwZW9mIG51bU1vbnRocyA9PT0gIm51bWJlciIgPyBbIDEsIG51bU1vbnRocyBdIDogbnVtTW9udGhzICkgKTsNCgl9LA0KDQoJLyogRGV0ZXJtaW5lIHRoZSBjdXJyZW50IG1heGltdW0gZGF0ZSAtIGVuc3VyZSBubyB0aW1lIGNvbXBvbmVudHMgYXJlIHNldC4gKi8NCglfZ2V0TWluTWF4RGF0ZTogZnVuY3Rpb24oIGluc3QsIG1pbk1heCApIHsNCgkJcmV0dXJuIHRoaXMuX2RldGVybWluZURhdGUoIGluc3QsIHRoaXMuX2dldCggaW5zdCwgbWluTWF4ICsgIkRhdGUiICksIG51bGwgKTsNCgl9LA0KDQoJLyogRmluZCB0aGUgbnVtYmVyIG9mIGRheXMgaW4gYSBnaXZlbiBtb250aC4gKi8NCglfZ2V0RGF5c0luTW9udGg6IGZ1bmN0aW9uKCB5ZWFyLCBtb250aCApIHsNCgkJcmV0dXJuIDMyIC0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCB5ZWFyLCBtb250aCwgMzIgKSApLmdldERhdGUoKTsNCgl9LA0KDQoJLyogRmluZCB0aGUgZGF5IG9mIHRoZSB3ZWVrIG9mIHRoZSBmaXJzdCBvZiBhIG1vbnRoLiAqLw0KCV9nZXRGaXJzdERheU9mTW9udGg6IGZ1bmN0aW9uKCB5ZWFyLCBtb250aCApIHsNCgkJcmV0dXJuIG5ldyBEYXRlKCB5ZWFyLCBtb250aCwgMSApLmdldERheSgpOw0KCX0sDQoNCgkvKiBEZXRlcm1pbmVzIGlmIHdlIHNob3VsZCBhbGxvdyBhICJuZXh0L3ByZXYiIG1vbnRoIGRpc3BsYXkgY2hhbmdlLiAqLw0KCV9jYW5BZGp1c3RNb250aDogZnVuY3Rpb24oIGluc3QsIG9mZnNldCwgY3VyWWVhciwgY3VyTW9udGggKSB7DQoJCXZhciBudW1Nb250aHMgPSB0aGlzLl9nZXROdW1iZXJPZk1vbnRocyggaW5zdCApLA0KCQkJZGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggY3VyWWVhciwNCgkJCWN1ck1vbnRoICsgKCBvZmZzZXQgPCAwID8gb2Zmc2V0IDogbnVtTW9udGhzWyAwIF0gKiBudW1Nb250aHNbIDEgXSApLCAxICkgKTsNCg0KCQlpZiAoIG9mZnNldCA8IDAgKSB7DQoJCQlkYXRlLnNldERhdGUoIHRoaXMuX2dldERheXNJbk1vbnRoKCBkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSApICk7DQoJCX0NCgkJcmV0dXJuIHRoaXMuX2lzSW5SYW5nZSggaW5zdCwgZGF0ZSApOw0KCX0sDQoNCgkvKiBJcyB0aGUgZ2l2ZW4gZGF0ZSBpbiB0aGUgYWNjZXB0ZWQgcmFuZ2U\/ICovDQoJX2lzSW5SYW5nZTogZnVuY3Rpb24oIGluc3QsIGRhdGUgKSB7DQoJCXZhciB5ZWFyU3BsaXQsIGN1cnJlbnRZZWFyLA0KCQkJbWluRGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtaW4iICksDQoJCQltYXhEYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZSggaW5zdCwgIm1heCIgKSwNCgkJCW1pblllYXIgPSBudWxsLA0KCQkJbWF4WWVhciA9IG51bGwsDQoJCQl5ZWFycyA9IHRoaXMuX2dldCggaW5zdCwgInllYXJSYW5nZSIgKTsNCgkJCWlmICggeWVhcnMgKSB7DQoJCQkJeWVhclNwbGl0ID0geWVhcnMuc3BsaXQoICI6IiApOw0KCQkJCWN1cnJlbnRZZWFyID0gbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpOw0KCQkJCW1pblllYXIgPSBwYXJzZUludCggeWVhclNwbGl0WyAwIF0sIDEwICk7DQoJCQkJbWF4WWVhciA9IHBhcnNlSW50KCB5ZWFyU3BsaXRbIDEgXSwgMTAgKTsNCgkJCQlpZiAoIHllYXJTcGxpdFsgMCBdLm1hdGNoKCAvWytcLV0uKi8gKSApIHsNCgkJCQkJbWluWWVhciArPSBjdXJyZW50WWVhcjsNCgkJCQl9DQoJCQkJaWYgKCB5ZWFyU3BsaXRbIDEgXS5tYXRjaCggL1srXC1dLiovICkgKSB7DQoJCQkJCW1heFllYXIgKz0gY3VycmVudFllYXI7DQoJCQkJfQ0KCQkJfQ0KDQoJCXJldHVybiAoICggIW1pbkRhdGUgfHwgZGF0ZS5nZXRUaW1lKCkgPj0gbWluRGF0ZS5nZXRUaW1lKCkgKSAmJg0KCQkJKCAhbWF4RGF0ZSB8fCBkYXRlLmdldFRpbWUoKSA8PSBtYXhEYXRlLmdldFRpbWUoKSApICYmDQoJCQkoICFtaW5ZZWFyIHx8IGRhdGUuZ2V0RnVsbFllYXIoKSA+PSBtaW5ZZWFyICkgJiYNCgkJCSggIW1heFllYXIgfHwgZGF0ZS5nZXRGdWxsWWVhcigpIDw9IG1heFllYXIgKSApOw0KCX0sDQoNCgkvKiBQcm92aWRlIHRoZSBjb25maWd1cmF0aW9uIHNldHRpbmdzIGZvciBmb3JtYXR0aW5nL3BhcnNpbmcuICovDQoJX2dldEZvcm1hdENvbmZpZzogZnVuY3Rpb24oIGluc3QgKSB7DQoJCXZhciBzaG9ydFllYXJDdXRvZmYgPSB0aGlzLl9nZXQoIGluc3QsICJzaG9ydFllYXJDdXRvZmYiICk7DQoJCXNob3J0WWVhckN1dG9mZiA9ICggdHlwZW9mIHNob3J0WWVhckN1dG9mZiAhPT0gInN0cmluZyIgPyBzaG9ydFllYXJDdXRvZmYgOg0KCQkJbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpICUgMTAwICsgcGFyc2VJbnQoIHNob3J0WWVhckN1dG9mZiwgMTAgKSApOw0KCQlyZXR1cm4geyBzaG9ydFllYXJDdXRvZmY6IHNob3J0WWVhckN1dG9mZiwNCgkJCWRheU5hbWVzU2hvcnQ6IHRoaXMuX2dldCggaW5zdCwgImRheU5hbWVzU2hvcnQiICksIGRheU5hbWVzOiB0aGlzLl9nZXQoIGluc3QsICJkYXlOYW1lcyIgKSwNCgkJCW1vbnRoTmFtZXNTaG9ydDogdGhpcy5fZ2V0KCBpbnN0LCAibW9udGhOYW1lc1Nob3J0IiApLCBtb250aE5hbWVzOiB0aGlzLl9nZXQoIGluc3QsICJtb250aE5hbWVzIiApIH07DQoJfSwNCg0KCS8qIEZvcm1hdCB0aGUgZ2l2ZW4gZGF0ZSBmb3IgZGlzcGxheS4gKi8NCglfZm9ybWF0RGF0ZTogZnVuY3Rpb24oIGluc3QsIGRheSwgbW9udGgsIHllYXIgKSB7DQoJCWlmICggIWRheSApIHsNCgkJCWluc3QuY3VycmVudERheSA9IGluc3Quc2VsZWN0ZWREYXk7DQoJCQlpbnN0LmN1cnJlbnRNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aDsNCgkJCWluc3QuY3VycmVudFllYXIgPSBpbnN0LnNlbGVjdGVkWWVhcjsNCgkJfQ0KCQl2YXIgZGF0ZSA9ICggZGF5ID8gKCB0eXBlb2YgZGF5ID09PSAib2JqZWN0IiA\/IGRheSA6DQoJCQl0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIHllYXIsIG1vbnRoLCBkYXkgKSApICkgOg0KCQkJdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBpbnN0LmN1cnJlbnRZZWFyLCBpbnN0LmN1cnJlbnRNb250aCwgaW5zdC5jdXJyZW50RGF5ICkgKSApOw0KCQlyZXR1cm4gdGhpcy5mb3JtYXREYXRlKCB0aGlzLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApLCBkYXRlLCB0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApOw0KCX0NCn0gKTsNCg0KLyoNCiAqIEJpbmQgaG92ZXIgZXZlbnRzIGZvciBkYXRlcGlja2VyIGVsZW1lbnRzLg0KICogRG9uZSB2aWEgZGVsZWdhdGUgc28gdGhlIGJpbmRpbmcgb25seSBvY2N1cnMgb25jZSBpbiB0aGUgbGlmZXRpbWUgb2YgdGhlIHBhcmVudCBkaXYuDQogKiBHbG9iYWwgZGF0ZXBpY2tlcl9pbnN0QWN0aXZlLCBzZXQgYnkgX3VwZGF0ZURhdGVwaWNrZXIgYWxsb3dzIHRoZSBoYW5kbGVycyB0byBmaW5kIHRoZWlyIHdheSBiYWNrIHRvIHRoZSBhY3RpdmUgcGlja2VyLg0KICovDQpmdW5jdGlvbiBkYXRlcGlja2VyX2JpbmRIb3ZlciggZHBEaXYgKSB7DQoJdmFyIHNlbGVjdG9yID0gImJ1dHRvbiwgLnVpLWRhdGVwaWNrZXItcHJldiwgLnVpLWRhdGVwaWNrZXItbmV4dCwgLnVpLWRhdGVwaWNrZXItY2FsZW5kYXIgdGQgYSI7DQoJcmV0dXJuIGRwRGl2Lm9uKCAibW91c2VvdXQiLCBzZWxlY3RvciwgZnVuY3Rpb24oKSB7DQoJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsNCgkJCWlmICggdGhpcy5jbGFzc05hbWUuaW5kZXhPZiggInVpLWRhdGVwaWNrZXItcHJldiIgKSAhPT0gLTEgKSB7DQoJCQkJJCggdGhpcyApLnJlbW92ZUNsYXNzKCAidWktZGF0ZXBpY2tlci1wcmV2LWhvdmVyIiApOw0KCQkJfQ0KCQkJaWYgKCB0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCAidWktZGF0ZXBpY2tlci1uZXh0IiApICE9PSAtMSApIHsNCgkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1kYXRlcGlja2VyLW5leHQtaG92ZXIiICk7DQoJCQl9DQoJCX0gKQ0KCQkub24oICJtb3VzZW92ZXIiLCBzZWxlY3RvciwgZGF0ZXBpY2tlcl9oYW5kbGVNb3VzZW92ZXIgKTsNCn0NCg0KZnVuY3Rpb24gZGF0ZXBpY2tlcl9oYW5kbGVNb3VzZW92ZXIoKSB7DQoJaWYgKCAhJC5kYXRlcGlja2VyLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggZGF0ZXBpY2tlcl9pbnN0QWN0aXZlLmlubGluZSA\/IGRhdGVwaWNrZXJfaW5zdEFjdGl2ZS5kcERpdi5wYXJlbnQoKVsgMCBdIDogZGF0ZXBpY2tlcl9pbnN0QWN0aXZlLmlucHV0WyAwIF0gKSApIHsNCgkJJCggdGhpcyApLnBhcmVudHMoICIudWktZGF0ZXBpY2tlci1jYWxlbmRhciIgKS5maW5kKCAiYSIgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOw0KCQkkKCB0aGlzICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsNCgkJaWYgKCB0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCAidWktZGF0ZXBpY2tlci1wcmV2IiApICE9PSAtMSApIHsNCgkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLWRhdGVwaWNrZXItcHJldi1ob3ZlciIgKTsNCgkJfQ0KCQlpZiAoIHRoaXMuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1kYXRlcGlja2VyLW5leHQiICkgIT09IC0xICkgew0KCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktZGF0ZXBpY2tlci1uZXh0LWhvdmVyIiApOw0KCQl9DQoJfQ0KfQ0KDQovKiBqUXVlcnkgZXh0ZW5kIG5vdyBpZ25vcmVzIG51bGxzISAqLw0KZnVuY3Rpb24gZGF0ZXBpY2tlcl9leHRlbmRSZW1vdmUoIHRhcmdldCwgcHJvcHMgKSB7DQoJJC5leHRlbmQoIHRhcmdldCwgcHJvcHMgKTsNCglmb3IgKCB2YXIgbmFtZSBpbiBwcm9wcyApIHsNCgkJaWYgKCBwcm9wc1sgbmFtZSBdID09IG51bGwgKSB7DQoJCQl0YXJnZXRbIG5hbWUgXSA9IHByb3BzWyBuYW1lIF07DQoJCX0NCgl9DQoJcmV0dXJuIHRhcmdldDsNCn0NCg0KLyogSW52b2tlIHRoZSBkYXRlcGlja2VyIGZ1bmN0aW9uYWxpdHkuDQogICBAcGFyYW0gIG9wdGlvbnMgIHN0cmluZyAtIGEgY29tbWFuZCwgb3B0aW9uYWxseSBmb2xsb3dlZCBieSBhZGRpdGlvbmFsIHBhcmFtZXRlcnMgb3INCgkJCQkJT2JqZWN0IC0gc2V0dGluZ3MgZm9yIGF0dGFjaGluZyBuZXcgZGF0ZXBpY2tlciBmdW5jdGlvbmFsaXR5DQogICBAcmV0dXJuICBqUXVlcnkgb2JqZWN0ICovDQokLmZuLmRhdGVwaWNrZXIgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsNCg0KCS8qIFZlcmlmeSBhbiBlbXB0eSBjb2xsZWN0aW9uIHdhc24ndCBwYXNzZWQgLSBGaXhlcyAjNjk3NiAqLw0KCWlmICggIXRoaXMubGVuZ3RoICkgew0KCQlyZXR1cm4gdGhpczsNCgl9DQoNCgkvKiBJbml0aWFsaXNlIHRoZSBkYXRlIHBpY2tlci4gKi8NCglpZiAoICEkLmRhdGVwaWNrZXIuaW5pdGlhbGl6ZWQgKSB7DQoJCSQoIGRvY3VtZW50ICkub24oICJtb3VzZWRvd24iLCAkLmRhdGVwaWNrZXIuX2NoZWNrRXh0ZXJuYWxDbGljayApOw0KCQkkLmRhdGVwaWNrZXIuaW5pdGlhbGl6ZWQgPSB0cnVlOw0KCX0NCg0KCS8qIEFwcGVuZCBkYXRlcGlja2VyIG1haW4gY29udGFpbmVyIHRvIGJvZHkgaWYgbm90IGV4aXN0LiAqLw0KCWlmICggJCggIiMiICsgJC5kYXRlcGlja2VyLl9tYWluRGl2SWQgKS5sZW5ndGggPT09IDAgKSB7DQoJCSQoICJib2R5IiApLmFwcGVuZCggJC5kYXRlcGlja2VyLmRwRGl2ICk7DQoJfQ0KDQoJdmFyIG90aGVyQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsNCglpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiAmJiAoIG9wdGlvbnMgPT09ICJpc0Rpc2FibGVkIiB8fCBvcHRpb25zID09PSAiZ2V0RGF0ZSIgfHwgb3B0aW9ucyA9PT0gIndpZGdldCIgKSApIHsNCgkJcmV0dXJuICQuZGF0ZXBpY2tlclsgIl8iICsgb3B0aW9ucyArICJEYXRlcGlja2VyIiBdLg0KCQkJYXBwbHkoICQuZGF0ZXBpY2tlciwgWyB0aGlzWyAwIF0gXS5jb25jYXQoIG90aGVyQXJncyApICk7DQoJfQ0KCWlmICggb3B0aW9ucyA9PT0gIm9wdGlvbiIgJiYgYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgYXJndW1lbnRzWyAxIF0gPT09ICJzdHJpbmciICkgew0KCQlyZXR1cm4gJC5kYXRlcGlja2VyWyAiXyIgKyBvcHRpb25zICsgIkRhdGVwaWNrZXIiIF0uDQoJCQlhcHBseSggJC5kYXRlcGlja2VyLCBbIHRoaXNbIDAgXSBdLmNvbmNhdCggb3RoZXJBcmdzICkgKTsNCgl9DQoJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCXR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiA\/DQoJCQkkLmRhdGVwaWNrZXJbICJfIiArIG9wdGlvbnMgKyAiRGF0ZXBpY2tlciIgXS4NCgkJCQlhcHBseSggJC5kYXRlcGlja2VyLCBbIHRoaXMgXS5jb25jYXQoIG90aGVyQXJncyApICkgOg0KCQkJJC5kYXRlcGlja2VyLl9hdHRhY2hEYXRlcGlja2VyKCB0aGlzLCBvcHRpb25zICk7DQoJfSApOw0KfTsNCg0KJC5kYXRlcGlja2VyID0gbmV3IERhdGVwaWNrZXIoKTsgLy8gc2luZ2xldG9uIGluc3RhbmNlDQokLmRhdGVwaWNrZXIuaW5pdGlhbGl6ZWQgPSBmYWxzZTsNCiQuZGF0ZXBpY2tlci51dWlkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7DQokLmRhdGVwaWNrZXIudmVyc2lvbiA9ICIxLjEyLjEiOw0KDQp2YXIgd2lkZ2V0c0RhdGVwaWNrZXIgPSAkLmRhdGVwaWNrZXI7DQoNCg0KDQoNCi8vIFRoaXMgZmlsZSBpcyBkZXByZWNhdGVkDQp2YXIgaWUgPSAkLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOw0KDQovKiENCiAqIGpRdWVyeSBVSSBNb3VzZSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogTW91c2UNCi8vPj5ncm91cDogV2lkZ2V0cw0KLy8+PmRlc2NyaXB0aW9uOiBBYnN0cmFjdHMgbW91c2UtYmFzZWQgaW50ZXJhY3Rpb25zIHRvIGFzc2lzdCBpbiBjcmVhdGluZyBjZXJ0YWluIHdpZGdldHMuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vbW91c2UvDQoNCg0KDQp2YXIgbW91c2VIYW5kbGVkID0gZmFsc2U7DQokKCBkb2N1bWVudCApLm9uKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgew0KCW1vdXNlSGFuZGxlZCA9IGZhbHNlOw0KfSApOw0KDQp2YXIgd2lkZ2V0c01vdXNlID0gJC53aWRnZXQoICJ1aS5tb3VzZSIsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCglvcHRpb25zOiB7DQoJCWNhbmNlbDogImlucHV0LCB0ZXh0YXJlYSwgYnV0dG9uLCBzZWxlY3QsIG9wdGlvbiIsDQoJCWRpc3RhbmNlOiAxLA0KCQlkZWxheTogMA0KCX0sDQoJX21vdXNlSW5pdDogZnVuY3Rpb24oKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCg0KCQl0aGlzLmVsZW1lbnQNCgkJCS5vbiggIm1vdXNlZG93bi4iICsgdGhpcy53aWRnZXROYW1lLCBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJcmV0dXJuIHRoYXQuX21vdXNlRG93biggZXZlbnQgKTsNCgkJCX0gKQ0KCQkJLm9uKCAiY2xpY2suIiArIHRoaXMud2lkZ2V0TmFtZSwgZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCWlmICggdHJ1ZSA9PT0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRoYXQud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICkgKSB7DQoJCQkJCSQucmVtb3ZlRGF0YSggZXZlbnQudGFyZ2V0LCB0aGF0LndpZGdldE5hbWUgKyAiLnByZXZlbnRDbGlja0V2ZW50IiApOw0KCQkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsNCgkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCX0NCgkJCX0gKTsNCg0KCQl0aGlzLnN0YXJ0ZWQgPSBmYWxzZTsNCgl9LA0KDQoJLy8gVE9ETzogbWFrZSBzdXJlIGRlc3Ryb3lpbmcgb25lIGluc3RhbmNlIG9mIG1vdXNlIGRvZXNuJ3QgbWVzcyB3aXRoDQoJLy8gb3RoZXIgaW5zdGFuY2VzIG9mIG1vdXNlDQoJX21vdXNlRGVzdHJveTogZnVuY3Rpb24oKSB7DQoJCXRoaXMuZWxlbWVudC5vZmYoICIuIiArIHRoaXMud2lkZ2V0TmFtZSApOw0KCQlpZiAoIHRoaXMuX21vdXNlTW92ZURlbGVnYXRlICkgew0KCQkJdGhpcy5kb2N1bWVudA0KCQkJCS5vZmYoICJtb3VzZW1vdmUuIiArIHRoaXMud2lkZ2V0TmFtZSwgdGhpcy5fbW91c2VNb3ZlRGVsZWdhdGUgKQ0KCQkJCS5vZmYoICJtb3VzZXVwLiIgKyB0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlVXBEZWxlZ2F0ZSApOw0KCQl9DQoJfSwNCg0KCV9tb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQkvLyBkb24ndCBsZXQgbW9yZSB0aGFuIG9uZSB3aWRnZXQgaGFuZGxlIG1vdXNlU3RhcnQNCgkJaWYgKCBtb3VzZUhhbmRsZWQgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl0aGlzLl9tb3VzZU1vdmVkID0gZmFsc2U7DQoNCgkJLy8gV2UgbWF5IGhhdmUgbWlzc2VkIG1vdXNldXAgKG91dCBvZiB3aW5kb3cpDQoJCSggdGhpcy5fbW91c2VTdGFydGVkICYmIHRoaXMuX21vdXNlVXAoIGV2ZW50ICkgKTsNCg0KCQl0aGlzLl9tb3VzZURvd25FdmVudCA9IGV2ZW50Ow0KDQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCWJ0bklzTGVmdCA9ICggZXZlbnQud2hpY2ggPT09IDEgKSwNCg0KCQkJLy8gZXZlbnQudGFyZ2V0Lm5vZGVOYW1lIHdvcmtzIGFyb3VuZCBhIGJ1ZyBpbiBJRSA4IHdpdGgNCgkJCS8vIGRpc2FibGVkIGlucHV0cyAoIzc2MjApDQoJCQllbElzQ2FuY2VsID0gKCB0eXBlb2YgdGhpcy5vcHRpb25zLmNhbmNlbCA9PT0gInN0cmluZyIgJiYgZXZlbnQudGFyZ2V0Lm5vZGVOYW1lID8NCgkJCQkkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCB0aGlzLm9wdGlvbnMuY2FuY2VsICkubGVuZ3RoIDogZmFsc2UgKTsNCgkJaWYgKCAhYnRuSXNMZWZ0IHx8IGVsSXNDYW5jZWwgfHwgIXRoaXMuX21vdXNlQ2FwdHVyZSggZXZlbnQgKSApIHsNCgkJCXJldHVybiB0cnVlOw0KCQl9DQoNCgkJdGhpcy5tb3VzZURlbGF5TWV0ID0gIXRoaXMub3B0aW9ucy5kZWxheTsNCgkJaWYgKCAhdGhpcy5tb3VzZURlbGF5TWV0ICkgew0KCQkJdGhpcy5fbW91c2VEZWxheVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7DQoJCQkJdGhhdC5tb3VzZURlbGF5TWV0ID0gdHJ1ZTsNCgkJCX0sIHRoaXMub3B0aW9ucy5kZWxheSApOw0KCQl9DQoNCgkJaWYgKCB0aGlzLl9tb3VzZURpc3RhbmNlTWV0KCBldmVudCApICYmIHRoaXMuX21vdXNlRGVsYXlNZXQoIGV2ZW50ICkgKSB7DQoJCQl0aGlzLl9tb3VzZVN0YXJ0ZWQgPSAoIHRoaXMuX21vdXNlU3RhcnQoIGV2ZW50ICkgIT09IGZhbHNlICk7DQoJCQlpZiAoICF0aGlzLl9tb3VzZVN0YXJ0ZWQgKSB7DQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCQlyZXR1cm4gdHJ1ZTsNCgkJCX0NCgkJfQ0KDQoJCS8vIENsaWNrIGV2ZW50IG1heSBuZXZlciBoYXZlIGZpcmVkIChHZWNrbyAmIE9wZXJhKQ0KCQlpZiAoIHRydWUgPT09ICQuZGF0YSggZXZlbnQudGFyZ2V0LCB0aGlzLndpZGdldE5hbWUgKyAiLnByZXZlbnRDbGlja0V2ZW50IiApICkgew0KCQkJJC5yZW1vdmVEYXRhKCBldmVudC50YXJnZXQsIHRoaXMud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICk7DQoJCX0NCg0KCQkvLyBUaGVzZSBkZWxlZ2F0ZXMgYXJlIHJlcXVpcmVkIHRvIGtlZXAgY29udGV4dA0KCQl0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSA9IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCXJldHVybiB0aGF0Ll9tb3VzZU1vdmUoIGV2ZW50ICk7DQoJCX07DQoJCXRoaXMuX21vdXNlVXBEZWxlZ2F0ZSA9IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCXJldHVybiB0aGF0Ll9tb3VzZVVwKCBldmVudCApOw0KCQl9Ow0KDQoJCXRoaXMuZG9jdW1lbnQNCgkJCS5vbiggIm1vdXNlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSApDQoJCQkub24oICJtb3VzZXVwLiIgKyB0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlVXBEZWxlZ2F0ZSApOw0KDQoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoNCgkJbW91c2VIYW5kbGVkID0gdHJ1ZTsNCgkJcmV0dXJuIHRydWU7DQoJfSwNCg0KCV9tb3VzZU1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQkvLyBPbmx5IGNoZWNrIGZvciBtb3VzZXVwcyBvdXRzaWRlIHRoZSBkb2N1bWVudCBpZiB5b3UndmUgbW92ZWQgaW5zaWRlIHRoZSBkb2N1bWVudA0KCQkvLyBhdCBsZWFzdCBvbmNlLiBUaGlzIHByZXZlbnRzIHRoZSBmaXJpbmcgb2YgbW91c2V1cCBpbiB0aGUgY2FzZSBvZiBJRTw5LCB3aGljaCB3aWxsDQoJCS8vIGZpcmUgYSBtb3VzZW1vdmUgZXZlbnQgaWYgY29udGVudCBpcyBwbGFjZWQgdW5kZXIgdGhlIGN1cnNvci4gU2VlICM3Nzc4DQoJCS8vIFN1cHBvcnQ6IElFIDw5DQoJCWlmICggdGhpcy5fbW91c2VNb3ZlZCApIHsNCg0KCQkJLy8gSUUgbW91c2V1cCBjaGVjayAtIG1vdXNldXAgaGFwcGVuZWQgd2hlbiBtb3VzZSB3YXMgb3V0IG9mIHdpbmRvdw0KCQkJaWYgKCAkLnVpLmllICYmICggIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPCA5ICkgJiYNCgkJCQkJIWV2ZW50LmJ1dHRvbiApIHsNCgkJCQlyZXR1cm4gdGhpcy5fbW91c2VVcCggZXZlbnQgKTsNCg0KCQkJLy8gSWZyYW1lIG1vdXNldXAgY2hlY2sgLSBtb3VzZXVwIG9jY3VycmVkIGluIGFub3RoZXIgZG9jdW1lbnQNCgkJCX0gZWxzZSBpZiAoICFldmVudC53aGljaCApIHsNCg0KCQkJCS8vIFN1cHBvcnQ6IFNhZmFyaSA8PTggLSA5DQoJCQkJLy8gU2FmYXJpIHNldHMgd2hpY2ggdG8gMCBpZiB5b3UgcHJlc3MgYW55IG9mIHRoZSBmb2xsb3dpbmcga2V5cw0KCQkJCS8vIGR1cmluZyBhIGRyYWcgKCMxNDQ2MSkNCgkJCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQuYWx0S2V5IHx8IGV2ZW50Lm9yaWdpbmFsRXZlbnQuY3RybEtleSB8fA0KCQkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC5tZXRhS2V5IHx8IGV2ZW50Lm9yaWdpbmFsRXZlbnQuc2hpZnRLZXkgKSB7DQoJCQkJCXRoaXMuaWdub3JlTWlzc2luZ1doaWNoID0gdHJ1ZTsNCgkJCQl9IGVsc2UgaWYgKCAhdGhpcy5pZ25vcmVNaXNzaW5nV2hpY2ggKSB7DQoJCQkJCXJldHVybiB0aGlzLl9tb3VzZVVwKCBldmVudCApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCWlmICggZXZlbnQud2hpY2ggfHwgZXZlbnQuYnV0dG9uICkgew0KCQkJdGhpcy5fbW91c2VNb3ZlZCA9IHRydWU7DQoJCX0NCg0KCQlpZiAoIHRoaXMuX21vdXNlU3RhcnRlZCApIHsNCgkJCXRoaXMuX21vdXNlRHJhZyggZXZlbnQgKTsNCgkJCXJldHVybiBldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQl9DQoNCgkJaWYgKCB0aGlzLl9tb3VzZURpc3RhbmNlTWV0KCBldmVudCApICYmIHRoaXMuX21vdXNlRGVsYXlNZXQoIGV2ZW50ICkgKSB7DQoJCQl0aGlzLl9tb3VzZVN0YXJ0ZWQgPQ0KCQkJCSggdGhpcy5fbW91c2VTdGFydCggdGhpcy5fbW91c2VEb3duRXZlbnQsIGV2ZW50ICkgIT09IGZhbHNlICk7DQoJCQkoIHRoaXMuX21vdXNlU3RhcnRlZCA\/IHRoaXMuX21vdXNlRHJhZyggZXZlbnQgKSA6IHRoaXMuX21vdXNlVXAoIGV2ZW50ICkgKTsNCgkJfQ0KDQoJCXJldHVybiAhdGhpcy5fbW91c2VTdGFydGVkOw0KCX0sDQoNCglfbW91c2VVcDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl0aGlzLmRvY3VtZW50DQoJCQkub2ZmKCAibW91c2Vtb3ZlLiIgKyB0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlTW92ZURlbGVnYXRlICkNCgkJCS5vZmYoICJtb3VzZXVwLiIgKyB0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlVXBEZWxlZ2F0ZSApOw0KDQoJCWlmICggdGhpcy5fbW91c2VTdGFydGVkICkgew0KCQkJdGhpcy5fbW91c2VTdGFydGVkID0gZmFsc2U7DQoNCgkJCWlmICggZXZlbnQudGFyZ2V0ID09PSB0aGlzLl9tb3VzZURvd25FdmVudC50YXJnZXQgKSB7DQoJCQkJJC5kYXRhKCBldmVudC50YXJnZXQsIHRoaXMud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiLCB0cnVlICk7DQoJCQl9DQoNCgkJCXRoaXMuX21vdXNlU3RvcCggZXZlbnQgKTsNCgkJfQ0KDQoJCWlmICggdGhpcy5fbW91c2VEZWxheVRpbWVyICkgew0KCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9tb3VzZURlbGF5VGltZXIgKTsNCgkJCWRlbGV0ZSB0aGlzLl9tb3VzZURlbGF5VGltZXI7DQoJCX0NCg0KCQl0aGlzLmlnbm9yZU1pc3NpbmdXaGljaCA9IGZhbHNlOw0KCQltb3VzZUhhbmRsZWQgPSBmYWxzZTsNCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgl9LA0KDQoJX21vdXNlRGlzdGFuY2VNZXQ6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJcmV0dXJuICggTWF0aC5tYXgoDQoJCQkJTWF0aC5hYnMoIHRoaXMuX21vdXNlRG93bkV2ZW50LnBhZ2VYIC0gZXZlbnQucGFnZVggKSwNCgkJCQlNYXRoLmFicyggdGhpcy5fbW91c2VEb3duRXZlbnQucGFnZVkgLSBldmVudC5wYWdlWSApDQoJCQkpID49IHRoaXMub3B0aW9ucy5kaXN0YW5jZQ0KCQkpOw0KCX0sDQoNCglfbW91c2VEZWxheU1ldDogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgew0KCQlyZXR1cm4gdGhpcy5tb3VzZURlbGF5TWV0Ow0KCX0sDQoNCgkvLyBUaGVzZSBhcmUgcGxhY2Vob2xkZXIgbWV0aG9kcywgdG8gYmUgb3ZlcnJpZGVuIGJ5IGV4dGVuZGluZyBwbHVnaW4NCglfbW91c2VTdGFydDogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkge30sDQoJX21vdXNlRHJhZzogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkge30sDQoJX21vdXNlU3RvcDogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkge30sDQoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgeyByZXR1cm4gdHJ1ZTsgfQ0KfSApOw0KDQoNCg0KDQovLyAkLnVpLnBsdWdpbiBpcyBkZXByZWNhdGVkLiBVc2UgJC53aWRnZXQoKSBleHRlbnNpb25zIGluc3RlYWQuDQp2YXIgcGx1Z2luID0gJC51aS5wbHVnaW4gPSB7DQoJYWRkOiBmdW5jdGlvbiggbW9kdWxlLCBvcHRpb24sIHNldCApIHsNCgkJdmFyIGksDQoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsNCgkJZm9yICggaSBpbiBzZXQgKSB7DQoJCQlwcm90by5wbHVnaW5zWyBpIF0gPSBwcm90by5wbHVnaW5zWyBpIF0gfHwgW107DQoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsNCgkJfQ0KCX0sDQoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsNCgkJdmFyIGksDQoJCQlzZXQgPSBpbnN0YW5jZS5wbHVnaW5zWyBuYW1lIF07DQoNCgkJaWYgKCAhc2V0ICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCAhYWxsb3dEaXNjb25uZWN0ZWQgJiYgKCAhaW5zdGFuY2UuZWxlbWVudFsgMCBdLnBhcmVudE5vZGUgfHwNCgkJCQlpbnN0YW5jZS5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZS5ub2RlVHlwZSA9PT0gMTEgKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWZvciAoIGkgPSAwOyBpIDwgc2V0Lmxlbmd0aDsgaSsrICkgew0KCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7DQoJCQkJc2V0WyBpIF1bIDEgXS5hcHBseSggaW5zdGFuY2UuZWxlbWVudCwgYXJncyApOw0KCQkJfQ0KCQl9DQoJfQ0KfTsNCg0KDQoNCnZhciBzYWZlQmx1ciA9ICQudWkuc2FmZUJsdXIgPSBmdW5jdGlvbiggZWxlbWVudCApIHsNCg0KCS8vIFN1cHBvcnQ6IElFOSAtIDEwIG9ubHkNCgkvLyBJZiB0aGUgPGJvZHk+IGlzIGJsdXJyZWQsIElFIHdpbGwgc3dpdGNoIHdpbmRvd3MsIHNlZSAjOTQyMA0KCWlmICggZWxlbWVudCAmJiBlbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJib2R5IiApIHsNCgkJJCggZWxlbWVudCApLnRyaWdnZXIoICJibHVyIiApOw0KCX0NCn07DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgRHJhZ2dhYmxlIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBEcmFnZ2FibGUNCi8vPj5ncm91cDogSW50ZXJhY3Rpb25zDQovLz4+ZGVzY3JpcHRpb246IEVuYWJsZXMgZHJhZ2dpbmcgZnVuY3Rpb25hbGl0eSBmb3IgYW55IGVsZW1lbnQuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZHJhZ2dhYmxlLw0KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2RyYWdnYWJsZS8NCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9kcmFnZ2FibGUuY3NzDQoNCg0KDQokLndpZGdldCggInVpLmRyYWdnYWJsZSIsICQudWkubW91c2UsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCgl3aWRnZXRFdmVudFByZWZpeDogImRyYWciLA0KCW9wdGlvbnM6IHsNCgkJYWRkQ2xhc3NlczogdHJ1ZSwNCgkJYXBwZW5kVG86ICJwYXJlbnQiLA0KCQlheGlzOiBmYWxzZSwNCgkJY29ubmVjdFRvU29ydGFibGU6IGZhbHNlLA0KCQljb250YWlubWVudDogZmFsc2UsDQoJCWN1cnNvcjogImF1dG8iLA0KCQljdXJzb3JBdDogZmFsc2UsDQoJCWdyaWQ6IGZhbHNlLA0KCQloYW5kbGU6IGZhbHNlLA0KCQloZWxwZXI6ICJvcmlnaW5hbCIsDQoJCWlmcmFtZUZpeDogZmFsc2UsDQoJCW9wYWNpdHk6IGZhbHNlLA0KCQlyZWZyZXNoUG9zaXRpb25zOiBmYWxzZSwNCgkJcmV2ZXJ0OiBmYWxzZSwNCgkJcmV2ZXJ0RHVyYXRpb246IDUwMCwNCgkJc2NvcGU6ICJkZWZhdWx0IiwNCgkJc2Nyb2xsOiB0cnVlLA0KCQlzY3JvbGxTZW5zaXRpdml0eTogMjAsDQoJCXNjcm9sbFNwZWVkOiAyMCwNCgkJc25hcDogZmFsc2UsDQoJCXNuYXBNb2RlOiAiYm90aCIsDQoJCXNuYXBUb2xlcmFuY2U6IDIwLA0KCQlzdGFjazogZmFsc2UsDQoJCXpJbmRleDogZmFsc2UsDQoNCgkJLy8gQ2FsbGJhY2tzDQoJCWRyYWc6IG51bGwsDQoJCXN0YXJ0OiBudWxsLA0KCQlzdG9wOiBudWxsDQoJfSwNCglfY3JlYXRlOiBmdW5jdGlvbigpIHsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5oZWxwZXIgPT09ICJvcmlnaW5hbCIgKSB7DQoJCQl0aGlzLl9zZXRQb3NpdGlvblJlbGF0aXZlKCk7DQoJCX0NCgkJaWYgKCB0aGlzLm9wdGlvbnMuYWRkQ2xhc3NlcyApIHsNCgkJCXRoaXMuX2FkZENsYXNzKCAidWktZHJhZ2dhYmxlIiApOw0KCQl9DQoJCXRoaXMuX3NldEhhbmRsZUNsYXNzTmFtZSgpOw0KDQoJCXRoaXMuX21vdXNlSW5pdCgpOw0KCX0sDQoNCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsNCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsNCgkJaWYgKCBrZXkgPT09ICJoYW5kbGUiICkgew0KCQkJdGhpcy5fcmVtb3ZlSGFuZGxlQ2xhc3NOYW1lKCk7DQoJCQl0aGlzLl9zZXRIYW5kbGVDbGFzc05hbWUoKTsNCgkJfQ0KCX0sDQoNCglfZGVzdHJveTogZnVuY3Rpb24oKSB7DQoJCWlmICggKCB0aGlzLmhlbHBlciB8fCB0aGlzLmVsZW1lbnQgKS5pcyggIi51aS1kcmFnZ2FibGUtZHJhZ2dpbmciICkgKSB7DQoJCQl0aGlzLmRlc3Ryb3lPbkNsZWFyID0gdHJ1ZTsNCgkJCXJldHVybjsNCgkJfQ0KCQl0aGlzLl9yZW1vdmVIYW5kbGVDbGFzc05hbWUoKTsNCgkJdGhpcy5fbW91c2VEZXN0cm95KCk7DQoJfSwNCg0KCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7DQoNCgkJLy8gQW1vbmcgb3RoZXJzLCBwcmV2ZW50IGEgZHJhZyBvbiBhIHJlc2l6YWJsZS1oYW5kbGUNCgkJaWYgKCB0aGlzLmhlbHBlciB8fCBvLmRpc2FibGVkIHx8DQoJCQkJJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1yZXNpemFibGUtaGFuZGxlIiApLmxlbmd0aCA+IDAgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQkvL1F1aXQgaWYgd2UncmUgbm90IG9uIGEgdmFsaWQgaGFuZGxlDQoJCXRoaXMuaGFuZGxlID0gdGhpcy5fZ2V0SGFuZGxlKCBldmVudCApOw0KCQlpZiAoICF0aGlzLmhhbmRsZSApIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KDQoJCXRoaXMuX2JsdXJBY3RpdmVFbGVtZW50KCBldmVudCApOw0KDQoJCXRoaXMuX2Jsb2NrRnJhbWVzKCBvLmlmcmFtZUZpeCA9PT0gdHJ1ZSA\/ICJpZnJhbWUiIDogby5pZnJhbWVGaXggKTsNCg0KCQlyZXR1cm4gdHJ1ZTsNCg0KCX0sDQoNCglfYmxvY2tGcmFtZXM6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsNCgkJdGhpcy5pZnJhbWVCbG9ja3MgPSB0aGlzLmRvY3VtZW50LmZpbmQoIHNlbGVjdG9yICkubWFwKCBmdW5jdGlvbigpIHsNCgkJCXZhciBpZnJhbWUgPSAkKCB0aGlzICk7DQoNCgkJCXJldHVybiAkKCAiPGRpdj4iICkNCgkJCQkuY3NzKCAicG9zaXRpb24iLCAiYWJzb2x1dGUiICkNCgkJCQkuYXBwZW5kVG8oIGlmcmFtZS5wYXJlbnQoKSApDQoJCQkJLm91dGVyV2lkdGgoIGlmcmFtZS5vdXRlcldpZHRoKCkgKQ0KCQkJCS5vdXRlckhlaWdodCggaWZyYW1lLm91dGVySGVpZ2h0KCkgKQ0KCQkJCS5vZmZzZXQoIGlmcmFtZS5vZmZzZXQoKSApWyAwIF07DQoJCX0gKTsNCgl9LA0KDQoJX3VuYmxvY2tGcmFtZXM6IGZ1bmN0aW9uKCkgew0KCQlpZiAoIHRoaXMuaWZyYW1lQmxvY2tzICkgew0KCQkJdGhpcy5pZnJhbWVCbG9ja3MucmVtb3ZlKCk7DQoJCQlkZWxldGUgdGhpcy5pZnJhbWVCbG9ja3M7DQoJCX0NCgl9LA0KDQoJX2JsdXJBY3RpdmVFbGVtZW50OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBhY3RpdmVFbGVtZW50ID0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICksDQoJCQl0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKTsNCg0KCQkvLyBEb24ndCBibHVyIGlmIHRoZSBldmVudCBvY2N1cnJlZCBvbiBhbiBlbGVtZW50IHRoYXQgaXMgd2l0aGluDQoJCS8vIHRoZSBjdXJyZW50bHkgZm9jdXNlZCBlbGVtZW50DQoJCS8vIFNlZSAjMTA1MjcsICMxMjQ3Mg0KCQlpZiAoIHRhcmdldC5jbG9zZXN0KCBhY3RpdmVFbGVtZW50ICkubGVuZ3RoICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gQmx1ciBhbnkgZWxlbWVudCB0aGF0IGN1cnJlbnRseSBoYXMgZm9jdXMsIHNlZSAjNDI2MQ0KCQkkLnVpLnNhZmVCbHVyKCBhY3RpdmVFbGVtZW50ICk7DQoJfSwNCg0KCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7DQoNCgkJLy9DcmVhdGUgYW5kIGFwcGVuZCB0aGUgdmlzaWJsZSBoZWxwZXINCgkJdGhpcy5oZWxwZXIgPSB0aGlzLl9jcmVhdGVIZWxwZXIoIGV2ZW50ICk7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGVscGVyLCAidWktZHJhZ2dhYmxlLWRyYWdnaW5nIiApOw0KDQoJCS8vQ2FjaGUgdGhlIGhlbHBlciBzaXplDQoJCXRoaXMuX2NhY2hlSGVscGVyUHJvcG9ydGlvbnMoKTsNCg0KCQkvL0lmIGRkbWFuYWdlciBpcyB1c2VkIGZvciBkcm9wcGFibGVzLCBzZXQgdGhlIGdsb2JhbCBkcmFnZ2FibGUNCgkJaWYgKCAkLnVpLmRkbWFuYWdlciApIHsNCgkJCSQudWkuZGRtYW5hZ2VyLmN1cnJlbnQgPSB0aGlzOw0KCQl9DQoNCgkJLyoNCgkJICogLSBQb3NpdGlvbiBnZW5lcmF0aW9uIC0NCgkJICogVGhpcyBibG9jayBnZW5lcmF0ZXMgZXZlcnl0aGluZyBwb3NpdGlvbiByZWxhdGVkIC0gaXQncyB0aGUgY29yZSBvZiBkcmFnZ2FibGVzLg0KCQkgKi8NCg0KCQkvL0NhY2hlIHRoZSBtYXJnaW5zIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50DQoJCXRoaXMuX2NhY2hlTWFyZ2lucygpOw0KDQoJCS8vU3RvcmUgdGhlIGhlbHBlcidzIGNzcyBwb3NpdGlvbg0KCQl0aGlzLmNzc1Bvc2l0aW9uID0gdGhpcy5oZWxwZXIuY3NzKCAicG9zaXRpb24iICk7DQoJCXRoaXMuc2Nyb2xsUGFyZW50ID0gdGhpcy5oZWxwZXIuc2Nyb2xsUGFyZW50KCB0cnVlICk7DQoJCXRoaXMub2Zmc2V0UGFyZW50ID0gdGhpcy5oZWxwZXIub2Zmc2V0UGFyZW50KCk7DQoJCXRoaXMuaGFzRml4ZWRBbmNlc3RvciA9IHRoaXMuaGVscGVyLnBhcmVudHMoKS5maWx0ZXIoIGZ1bmN0aW9uKCkgew0KCQkJCXJldHVybiAkKCB0aGlzICkuY3NzKCAicG9zaXRpb24iICkgPT09ICJmaXhlZCI7DQoJCQl9ICkubGVuZ3RoID4gMDsNCg0KCQkvL1RoZSBlbGVtZW50J3MgYWJzb2x1dGUgcG9zaXRpb24gb24gdGhlIHBhZ2UgbWludXMgbWFyZ2lucw0KCQl0aGlzLnBvc2l0aW9uQWJzID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOw0KCQl0aGlzLl9yZWZyZXNoT2Zmc2V0cyggZXZlbnQgKTsNCg0KCQkvL0dlbmVyYXRlIHRoZSBvcmlnaW5hbCBwb3NpdGlvbg0KCQl0aGlzLm9yaWdpbmFsUG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uID0gdGhpcy5fZ2VuZXJhdGVQb3NpdGlvbiggZXZlbnQsIGZhbHNlICk7DQoJCXRoaXMub3JpZ2luYWxQYWdlWCA9IGV2ZW50LnBhZ2VYOw0KCQl0aGlzLm9yaWdpbmFsUGFnZVkgPSBldmVudC5wYWdlWTsNCg0KCQkvL0FkanVzdCB0aGUgbW91c2Ugb2Zmc2V0IHJlbGF0aXZlIHRvIHRoZSBoZWxwZXIgaWYgImN1cnNvckF0IiBpcyBzdXBwbGllZA0KCQkoIG8uY3Vyc29yQXQgJiYgdGhpcy5fYWRqdXN0T2Zmc2V0RnJvbUhlbHBlciggby5jdXJzb3JBdCApICk7DQoNCgkJLy9TZXQgYSBjb250YWlubWVudCBpZiBnaXZlbiBpbiB0aGUgb3B0aW9ucw0KCQl0aGlzLl9zZXRDb250YWlubWVudCgpOw0KDQoJCS8vVHJpZ2dlciBldmVudCArIGNhbGxiYWNrcw0KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJzdGFydCIsIGV2ZW50ICkgPT09IGZhbHNlICkgew0KCQkJdGhpcy5fY2xlYXIoKTsNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KDQoJCS8vUmVjYWNoZSB0aGUgaGVscGVyIHNpemUNCgkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOw0KDQoJCS8vUHJlcGFyZSB0aGUgZHJvcHBhYmxlIG9mZnNldHMNCgkJaWYgKCAkLnVpLmRkbWFuYWdlciAmJiAhby5kcm9wQmVoYXZpb3VyICkgew0KCQkJJC51aS5kZG1hbmFnZXIucHJlcGFyZU9mZnNldHMoIHRoaXMsIGV2ZW50ICk7DQoJCX0NCg0KCQkvLyBFeGVjdXRlIHRoZSBkcmFnIG9uY2UgLSB0aGlzIGNhdXNlcyB0aGUgaGVscGVyIG5vdCB0byBiZSB2aXNpYmxlIGJlZm9yZSBnZXR0aW5nIGl0cw0KCQkvLyBjb3JyZWN0IHBvc2l0aW9uDQoJCXRoaXMuX21vdXNlRHJhZyggZXZlbnQsIHRydWUgKTsNCg0KCQkvLyBJZiB0aGUgZGRtYW5hZ2VyIGlzIHVzZWQgZm9yIGRyb3BwYWJsZXMsIGluZm9ybSB0aGUgbWFuYWdlciB0aGF0IGRyYWdnaW5nIGhhcyBzdGFydGVkDQoJCS8vIChzZWUgIzUwMDMpDQoJCWlmICggJC51aS5kZG1hbmFnZXIgKSB7DQoJCQkkLnVpLmRkbWFuYWdlci5kcmFnU3RhcnQoIHRoaXMsIGV2ZW50ICk7DQoJCX0NCg0KCQlyZXR1cm4gdHJ1ZTsNCgl9LA0KDQoJX3JlZnJlc2hPZmZzZXRzOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXRoaXMub2Zmc2V0ID0gew0KCQkJdG9wOiB0aGlzLnBvc2l0aW9uQWJzLnRvcCAtIHRoaXMubWFyZ2lucy50b3AsDQoJCQlsZWZ0OiB0aGlzLnBvc2l0aW9uQWJzLmxlZnQgLSB0aGlzLm1hcmdpbnMubGVmdCwNCgkJCXNjcm9sbDogZmFsc2UsDQoJCQlwYXJlbnQ6IHRoaXMuX2dldFBhcmVudE9mZnNldCgpLA0KCQkJcmVsYXRpdmU6IHRoaXMuX2dldFJlbGF0aXZlT2Zmc2V0KCkNCgkJfTsNCg0KCQl0aGlzLm9mZnNldC5jbGljayA9IHsNCgkJCWxlZnQ6IGV2ZW50LnBhZ2VYIC0gdGhpcy5vZmZzZXQubGVmdCwNCgkJCXRvcDogZXZlbnQucGFnZVkgLSB0aGlzLm9mZnNldC50b3ANCgkJfTsNCgl9LA0KDQoJX21vdXNlRHJhZzogZnVuY3Rpb24oIGV2ZW50LCBub1Byb3BhZ2F0aW9uICkgew0KDQoJCS8vIHJlc2V0IGFueSBuZWNlc3NhcnkgY2FjaGVkIHByb3BlcnRpZXMgKHNlZSAjNTAwOSkNCgkJaWYgKCB0aGlzLmhhc0ZpeGVkQW5jZXN0b3IgKSB7DQoJCQl0aGlzLm9mZnNldC5wYXJlbnQgPSB0aGlzLl9nZXRQYXJlbnRPZmZzZXQoKTsNCgkJfQ0KDQoJCS8vQ29tcHV0ZSB0aGUgaGVscGVycyBwb3NpdGlvbg0KCQl0aGlzLnBvc2l0aW9uID0gdGhpcy5fZ2VuZXJhdGVQb3NpdGlvbiggZXZlbnQsIHRydWUgKTsNCgkJdGhpcy5wb3NpdGlvbkFicyA9IHRoaXMuX2NvbnZlcnRQb3NpdGlvblRvKCAiYWJzb2x1dGUiICk7DQoNCgkJLy9DYWxsIHBsdWdpbnMgYW5kIGNhbGxiYWNrcyBhbmQgdXNlIHRoZSByZXN1bHRpbmcgcG9zaXRpb24gaWYgc29tZXRoaW5nIGlzIHJldHVybmVkDQoJCWlmICggIW5vUHJvcGFnYXRpb24gKSB7DQoJCQl2YXIgdWkgPSB0aGlzLl91aUhhc2goKTsNCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCwgdWkgKSA9PT0gZmFsc2UgKSB7DQoJCQkJdGhpcy5fbW91c2VVcCggbmV3ICQuRXZlbnQoICJtb3VzZXVwIiwgZXZlbnQgKSApOw0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0NCgkJCXRoaXMucG9zaXRpb24gPSB1aS5wb3NpdGlvbjsNCgkJfQ0KDQoJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUubGVmdCA9IHRoaXMucG9zaXRpb24ubGVmdCArICJweCI7DQoJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUudG9wID0gdGhpcy5wb3NpdGlvbi50b3AgKyAicHgiOw0KDQoJCWlmICggJC51aS5kZG1hbmFnZXIgKSB7DQoJCQkkLnVpLmRkbWFuYWdlci5kcmFnKCB0aGlzLCBldmVudCApOw0KCQl9DQoNCgkJcmV0dXJuIGZhbHNlOw0KCX0sDQoNCglfbW91c2VTdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJLy9JZiB3ZSBhcmUgdXNpbmcgZHJvcHBhYmxlcywgaW5mb3JtIHRoZSBtYW5hZ2VyIGFib3V0IHRoZSBkcm9wDQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCWRyb3BwZWQgPSBmYWxzZTsNCgkJaWYgKCAkLnVpLmRkbWFuYWdlciAmJiAhdGhpcy5vcHRpb25zLmRyb3BCZWhhdmlvdXIgKSB7DQoJCQlkcm9wcGVkID0gJC51aS5kZG1hbmFnZXIuZHJvcCggdGhpcywgZXZlbnQgKTsNCgkJfQ0KDQoJCS8vaWYgYSBkcm9wIGNvbWVzIGZyb20gb3V0c2lkZSAoYSBzb3J0YWJsZSkNCgkJaWYgKCB0aGlzLmRyb3BwZWQgKSB7DQoJCQlkcm9wcGVkID0gdGhpcy5kcm9wcGVkOw0KCQkJdGhpcy5kcm9wcGVkID0gZmFsc2U7DQoJCX0NCg0KCQlpZiAoICggdGhpcy5vcHRpb25zLnJldmVydCA9PT0gImludmFsaWQiICYmICFkcm9wcGVkICkgfHwNCgkJCQkoIHRoaXMub3B0aW9ucy5yZXZlcnQgPT09ICJ2YWxpZCIgJiYgZHJvcHBlZCApIHx8DQoJCQkJdGhpcy5vcHRpb25zLnJldmVydCA9PT0gdHJ1ZSB8fCAoICQuaXNGdW5jdGlvbiggdGhpcy5vcHRpb25zLnJldmVydCApICYmDQoJCQkJdGhpcy5vcHRpb25zLnJldmVydC5jYWxsKCB0aGlzLmVsZW1lbnQsIGRyb3BwZWQgKSApDQoJCSkgew0KCQkJJCggdGhpcy5oZWxwZXIgKS5hbmltYXRlKA0KCQkJCXRoaXMub3JpZ2luYWxQb3NpdGlvbiwNCgkJCQlwYXJzZUludCggdGhpcy5vcHRpb25zLnJldmVydER1cmF0aW9uLCAxMCApLA0KCQkJCWZ1bmN0aW9uKCkgew0KCQkJCQlpZiAoIHRoYXQuX3RyaWdnZXIoICJzdG9wIiwgZXZlbnQgKSAhPT0gZmFsc2UgKSB7DQoJCQkJCQl0aGF0Ll9jbGVhcigpOw0KCQkJCQl9DQoJCQkJfQ0KCQkJKTsNCgkJfSBlbHNlIHsNCgkJCWlmICggdGhpcy5fdHJpZ2dlciggInN0b3AiLCBldmVudCApICE9PSBmYWxzZSApIHsNCgkJCQl0aGlzLl9jbGVhcigpOw0KCQkJfQ0KCQl9DQoNCgkJcmV0dXJuIGZhbHNlOw0KCX0sDQoNCglfbW91c2VVcDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl0aGlzLl91bmJsb2NrRnJhbWVzKCk7DQoNCgkJLy8gSWYgdGhlIGRkbWFuYWdlciBpcyB1c2VkIGZvciBkcm9wcGFibGVzLCBpbmZvcm0gdGhlIG1hbmFnZXIgdGhhdCBkcmFnZ2luZyBoYXMgc3RvcHBlZA0KCQkvLyAoc2VlICM1MDAzKQ0KCQlpZiAoICQudWkuZGRtYW5hZ2VyICkgew0KCQkJJC51aS5kZG1hbmFnZXIuZHJhZ1N0b3AoIHRoaXMsIGV2ZW50ICk7DQoJCX0NCg0KCQkvLyBPbmx5IG5lZWQgdG8gZm9jdXMgaWYgdGhlIGV2ZW50IG9jY3VycmVkIG9uIHRoZSBkcmFnZ2FibGUgaXRzZWxmLCBzZWUgIzEwNTI3DQoJCWlmICggdGhpcy5oYW5kbGVFbGVtZW50LmlzKCBldmVudC50YXJnZXQgKSApIHsNCg0KCQkJLy8gVGhlIGludGVyYWN0aW9uIGlzIG92ZXI7IHdoZXRoZXIgb3Igbm90IHRoZSBjbGljayByZXN1bHRlZCBpbiBhIGRyYWcsDQoJCQkvLyBmb2N1cyB0aGUgZWxlbWVudA0KCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJmb2N1cyIgKTsNCgkJfQ0KDQoJCXJldHVybiAkLnVpLm1vdXNlLnByb3RvdHlwZS5fbW91c2VVcC5jYWxsKCB0aGlzLCBldmVudCApOw0KCX0sDQoNCgljYW5jZWw6IGZ1bmN0aW9uKCkgew0KDQoJCWlmICggdGhpcy5oZWxwZXIuaXMoICIudWktZHJhZ2dhYmxlLWRyYWdnaW5nIiApICkgew0KCQkJdGhpcy5fbW91c2VVcCggbmV3ICQuRXZlbnQoICJtb3VzZXVwIiwgeyB0YXJnZXQ6IHRoaXMuZWxlbWVudFsgMCBdIH0gKSApOw0KCQl9IGVsc2Ugew0KCQkJdGhpcy5fY2xlYXIoKTsNCgkJfQ0KDQoJCXJldHVybiB0aGlzOw0KDQoJfSwNCg0KCV9nZXRIYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJcmV0dXJuIHRoaXMub3B0aW9ucy5oYW5kbGUgPw0KCQkJISEkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLmhhbmRsZSApICkubGVuZ3RoIDoNCgkJCXRydWU7DQoJfSwNCg0KCV9zZXRIYW5kbGVDbGFzc05hbWU6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLmhhbmRsZUVsZW1lbnQgPSB0aGlzLm9wdGlvbnMuaGFuZGxlID8NCgkJCXRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaGFuZGxlICkgOiB0aGlzLmVsZW1lbnQ7DQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmhhbmRsZUVsZW1lbnQsICJ1aS1kcmFnZ2FibGUtaGFuZGxlIiApOw0KCX0sDQoNCglfcmVtb3ZlSGFuZGxlQ2xhc3NOYW1lOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuaGFuZGxlRWxlbWVudCwgInVpLWRyYWdnYWJsZS1oYW5kbGUiICk7DQoJfSwNCg0KCV9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQl2YXIgbyA9IHRoaXMub3B0aW9ucywNCgkJCWhlbHBlcklzRnVuY3Rpb24gPSAkLmlzRnVuY3Rpb24oIG8uaGVscGVyICksDQoJCQloZWxwZXIgPSBoZWxwZXJJc0Z1bmN0aW9uID8NCgkJCQkkKCBvLmhlbHBlci5hcHBseSggdGhpcy5lbGVtZW50WyAwIF0sIFsgZXZlbnQgXSApICkgOg0KCQkJCSggby5oZWxwZXIgPT09ICJjbG9uZSIgPw0KCQkJCQl0aGlzLmVsZW1lbnQuY2xvbmUoKS5yZW1vdmVBdHRyKCAiaWQiICkgOg0KCQkJCQl0aGlzLmVsZW1lbnQgKTsNCg0KCQlpZiAoICFoZWxwZXIucGFyZW50cyggImJvZHkiICkubGVuZ3RoICkgew0KCQkJaGVscGVyLmFwcGVuZFRvKCAoIG8uYXBwZW5kVG8gPT09ICJwYXJlbnQiID8NCgkJCQl0aGlzLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIDoNCgkJCQlvLmFwcGVuZFRvICkgKTsNCgkJfQ0KDQoJCS8vIEh0dHA6Ly9idWdzLmpxdWVyeXVpLmNvbS90aWNrZXQvOTQ0Ng0KCQkvLyBhIGhlbHBlciBmdW5jdGlvbiBjYW4gcmV0dXJuIHRoZSBvcmlnaW5hbCBlbGVtZW50DQoJCS8vIHdoaWNoIHdvdWxkbid0IGhhdmUgYmVlbiBzZXQgdG8gcmVsYXRpdmUgaW4gX2NyZWF0ZQ0KCQlpZiAoIGhlbHBlcklzRnVuY3Rpb24gJiYgaGVscGVyWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgew0KCQkJdGhpcy5fc2V0UG9zaXRpb25SZWxhdGl2ZSgpOw0KCQl9DQoNCgkJaWYgKCBoZWxwZXJbIDAgXSAhPT0gdGhpcy5lbGVtZW50WyAwIF0gJiYNCgkJCQkhKCAvKGZpeGVkfGFic29sdXRlKS8gKS50ZXN0KCBoZWxwZXIuY3NzKCAicG9zaXRpb24iICkgKSApIHsNCgkJCWhlbHBlci5jc3MoICJwb3NpdGlvbiIsICJhYnNvbHV0ZSIgKTsNCgkJfQ0KDQoJCXJldHVybiBoZWxwZXI7DQoNCgl9LA0KDQoJX3NldFBvc2l0aW9uUmVsYXRpdmU6IGZ1bmN0aW9uKCkgew0KCQlpZiAoICEoIC9eKD86cnxhfGYpLyApLnRlc3QoIHRoaXMuZWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSApICkgew0KCQkJdGhpcy5lbGVtZW50WyAwIF0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOw0KCQl9DQoJfSwNCg0KCV9hZGp1c3RPZmZzZXRGcm9tSGVscGVyOiBmdW5jdGlvbiggb2JqICkgew0KCQlpZiAoIHR5cGVvZiBvYmogPT09ICJzdHJpbmciICkgew0KCQkJb2JqID0gb2JqLnNwbGl0KCAiICIgKTsNCgkJfQ0KCQlpZiAoICQuaXNBcnJheSggb2JqICkgKSB7DQoJCQlvYmogPSB7IGxlZnQ6ICtvYmpbIDAgXSwgdG9wOiArb2JqWyAxIF0gfHwgMCB9Ow0KCQl9DQoJCWlmICggImxlZnQiIGluIG9iaiApIHsNCgkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPSBvYmoubGVmdCArIHRoaXMubWFyZ2lucy5sZWZ0Ow0KCQl9DQoJCWlmICggInJpZ2h0IiBpbiBvYmogKSB7DQoJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0ID0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIG9iai5yaWdodCArIHRoaXMubWFyZ2lucy5sZWZ0Ow0KCQl9DQoJCWlmICggInRvcCIgaW4gb2JqICkgew0KCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wID0gb2JqLnRvcCArIHRoaXMubWFyZ2lucy50b3A7DQoJCX0NCgkJaWYgKCAiYm90dG9tIiBpbiBvYmogKSB7DQoJCQl0aGlzLm9mZnNldC5jbGljay50b3AgPSB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIG9iai5ib3R0b20gKyB0aGlzLm1hcmdpbnMudG9wOw0KCQl9DQoJfSwNCg0KCV9pc1Jvb3ROb2RlOiBmdW5jdGlvbiggZWxlbWVudCApIHsNCgkJcmV0dXJuICggLyhodG1sfGJvZHkpL2kgKS50ZXN0KCBlbGVtZW50LnRhZ05hbWUgKSB8fCBlbGVtZW50ID09PSB0aGlzLmRvY3VtZW50WyAwIF07DQoJfSwNCg0KCV9nZXRQYXJlbnRPZmZzZXQ6IGZ1bmN0aW9uKCkgew0KDQoJCS8vR2V0IHRoZSBvZmZzZXRQYXJlbnQgYW5kIGNhY2hlIGl0cyBwb3NpdGlvbg0KCQl2YXIgcG8gPSB0aGlzLm9mZnNldFBhcmVudC5vZmZzZXQoKSwNCgkJCWRvY3VtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdOw0KDQoJCS8vIFRoaXMgaXMgYSBzcGVjaWFsIGNhc2Ugd2hlcmUgd2UgbmVlZCB0byBtb2RpZnkgYSBvZmZzZXQgY2FsY3VsYXRlZCBvbiBzdGFydCwgc2luY2UgdGhlDQoJCS8vIGZvbGxvd2luZyBoYXBwZW5lZDoNCgkJLy8gMS4gVGhlIHBvc2l0aW9uIG9mIHRoZSBoZWxwZXIgaXMgYWJzb2x1dGUsIHNvIGl0J3MgcG9zaXRpb24gaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiB0aGUNCgkJLy8gbmV4dCBwb3NpdGlvbmVkIHBhcmVudA0KCQkvLyAyLiBUaGUgYWN0dWFsIG9mZnNldCBwYXJlbnQgaXMgYSBjaGlsZCBvZiB0aGUgc2Nyb2xsIHBhcmVudCwgYW5kIHRoZSBzY3JvbGwgcGFyZW50IGlzbid0DQoJCS8vIHRoZSBkb2N1bWVudCwgd2hpY2ggbWVhbnMgdGhhdCB0aGUgc2Nyb2xsIGlzIGluY2x1ZGVkIGluIHRoZSBpbml0aWFsIGNhbGN1bGF0aW9uIG9mIHRoZQ0KCQkvLyBvZmZzZXQgb2YgdGhlIHBhcmVudCwgYW5kIG5ldmVyIHJlY2FsY3VsYXRlZCB1cG9uIGRyYWcNCgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IGRvY3VtZW50ICYmDQoJCQkJJC5jb250YWlucyggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSwgdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgew0KCQkJcG8ubGVmdCArPSB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCk7DQoJCQlwby50b3AgKz0gdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCk7DQoJCX0NCg0KCQlpZiAoIHRoaXMuX2lzUm9vdE5vZGUoIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gKSApIHsNCgkJCXBvID0geyB0b3A6IDAsIGxlZnQ6IDAgfTsNCgkJfQ0KDQoJCXJldHVybiB7DQoJCQl0b3A6IHBvLnRvcCArICggcGFyc2VJbnQoIHRoaXMub2Zmc2V0UGFyZW50LmNzcyggImJvcmRlclRvcFdpZHRoIiApLCAxMCApIHx8IDAgKSwNCgkJCWxlZnQ6IHBvLmxlZnQgKyAoIHBhcnNlSW50KCB0aGlzLm9mZnNldFBhcmVudC5jc3MoICJib3JkZXJMZWZ0V2lkdGgiICksIDEwICkgfHwgMCApDQoJCX07DQoNCgl9LA0KDQoJX2dldFJlbGF0aXZlT2Zmc2V0OiBmdW5jdGlvbigpIHsNCgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uICE9PSAicmVsYXRpdmUiICkgew0KCQkJcmV0dXJuIHsgdG9wOiAwLCBsZWZ0OiAwIH07DQoJCX0NCg0KCQl2YXIgcCA9IHRoaXMuZWxlbWVudC5wb3NpdGlvbigpLA0KCQkJc2Nyb2xsSXNSb290Tm9kZSA9IHRoaXMuX2lzUm9vdE5vZGUoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gKTsNCg0KCQlyZXR1cm4gew0KCQkJdG9wOiBwLnRvcCAtICggcGFyc2VJbnQoIHRoaXMuaGVscGVyLmNzcyggInRvcCIgKSwgMTAgKSB8fCAwICkgKw0KCQkJCSggIXNjcm9sbElzUm9vdE5vZGUgPyB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSA6IDAgKSwNCgkJCWxlZnQ6IHAubGVmdCAtICggcGFyc2VJbnQoIHRoaXMuaGVscGVyLmNzcyggImxlZnQiICksIDEwICkgfHwgMCApICsNCgkJCQkoICFzY3JvbGxJc1Jvb3ROb2RlID8gdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCgpIDogMCApDQoJCX07DQoNCgl9LA0KDQoJX2NhY2hlTWFyZ2luczogZnVuY3Rpb24oKSB7DQoJCXRoaXMubWFyZ2lucyA9IHsNCgkJCWxlZnQ6ICggcGFyc2VJbnQoIHRoaXMuZWxlbWVudC5jc3MoICJtYXJnaW5MZWZ0IiApLCAxMCApIHx8IDAgKSwNCgkJCXRvcDogKCBwYXJzZUludCggdGhpcy5lbGVtZW50LmNzcyggIm1hcmdpblRvcCIgKSwgMTAgKSB8fCAwICksDQoJCQlyaWdodDogKCBwYXJzZUludCggdGhpcy5lbGVtZW50LmNzcyggIm1hcmdpblJpZ2h0IiApLCAxMCApIHx8IDAgKSwNCgkJCWJvdHRvbTogKCBwYXJzZUludCggdGhpcy5lbGVtZW50LmNzcyggIm1hcmdpbkJvdHRvbSIgKSwgMTAgKSB8fCAwICkNCgkJfTsNCgl9LA0KDQoJX2NhY2hlSGVscGVyUHJvcG9ydGlvbnM6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLmhlbHBlclByb3BvcnRpb25zID0gew0KCQkJd2lkdGg6IHRoaXMuaGVscGVyLm91dGVyV2lkdGgoKSwNCgkJCWhlaWdodDogdGhpcy5oZWxwZXIub3V0ZXJIZWlnaHQoKQ0KCQl9Ow0KCX0sDQoNCglfc2V0Q29udGFpbm1lbnQ6IGZ1bmN0aW9uKCkgew0KDQoJCXZhciBpc1VzZXJTY3JvbGxhYmxlLCBjLCBjZSwNCgkJCW8gPSB0aGlzLm9wdGlvbnMsDQoJCQlkb2N1bWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXTsNCg0KCQl0aGlzLnJlbGF0aXZlQ29udGFpbmVyID0gbnVsbDsNCg0KCQlpZiAoICFvLmNvbnRhaW5tZW50ICkgew0KCQkJdGhpcy5jb250YWlubWVudCA9IG51bGw7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlpZiAoIG8uY29udGFpbm1lbnQgPT09ICJ3aW5kb3ciICkgew0KCQkJdGhpcy5jb250YWlubWVudCA9IFsNCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxMZWZ0KCkgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQsDQoJCQkJJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgLSB0aGlzLm9mZnNldC5wYXJlbnQudG9wLA0KCQkJCSQoIHdpbmRvdyApLnNjcm9sbExlZnQoKSArICQoIHdpbmRvdyApLndpZHRoKCkgLQ0KCQkJCQl0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gdGhpcy5tYXJnaW5zLmxlZnQsDQoJCQkJJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKw0KCQkJCQkoICQoIHdpbmRvdyApLmhlaWdodCgpIHx8IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5zY3JvbGxIZWlnaHQgKSAtDQoJCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcA0KCQkJXTsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlmICggby5jb250YWlubWVudCA9PT0gImRvY3VtZW50IiApIHsNCgkJCXRoaXMuY29udGFpbm1lbnQgPSBbDQoJCQkJMCwNCgkJCQkwLA0KCQkJCSQoIGRvY3VtZW50ICkud2lkdGgoKSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLSB0aGlzLm1hcmdpbnMubGVmdCwNCgkJCQkoICQoIGRvY3VtZW50ICkuaGVpZ2h0KCkgfHwgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodCApIC0NCgkJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLSB0aGlzLm1hcmdpbnMudG9wDQoJCQldOw0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCBvLmNvbnRhaW5tZW50LmNvbnN0cnVjdG9yID09PSBBcnJheSApIHsNCgkJCXRoaXMuY29udGFpbm1lbnQgPSBvLmNvbnRhaW5tZW50Ow0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCBvLmNvbnRhaW5tZW50ID09PSAicGFyZW50IiApIHsNCgkJCW8uY29udGFpbm1lbnQgPSB0aGlzLmhlbHBlclsgMCBdLnBhcmVudE5vZGU7DQoJCX0NCg0KCQljID0gJCggby5jb250YWlubWVudCApOw0KCQljZSA9IGNbIDAgXTsNCg0KCQlpZiAoICFjZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlzVXNlclNjcm9sbGFibGUgPSAvKHNjcm9sbHxhdXRvKS8udGVzdCggYy5jc3MoICJvdmVyZmxvdyIgKSApOw0KDQoJCXRoaXMuY29udGFpbm1lbnQgPSBbDQoJCQkoIHBhcnNlSW50KCBjLmNzcyggImJvcmRlckxlZnRXaWR0aCIgKSwgMTAgKSB8fCAwICkgKw0KCQkJCSggcGFyc2VJbnQoIGMuY3NzKCAicGFkZGluZ0xlZnQiICksIDEwICkgfHwgMCApLA0KCQkJKCBwYXJzZUludCggYy5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICkgKw0KCQkJCSggcGFyc2VJbnQoIGMuY3NzKCAicGFkZGluZ1RvcCIgKSwgMTAgKSB8fCAwICksDQoJCQkoIGlzVXNlclNjcm9sbGFibGUgPyBNYXRoLm1heCggY2Uuc2Nyb2xsV2lkdGgsIGNlLm9mZnNldFdpZHRoICkgOiBjZS5vZmZzZXRXaWR0aCApIC0NCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggImJvcmRlclJpZ2h0V2lkdGgiICksIDEwICkgfHwgMCApIC0NCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggInBhZGRpbmdSaWdodCIgKSwgMTAgKSB8fCAwICkgLQ0KCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLQ0KCQkJCXRoaXMubWFyZ2lucy5sZWZ0IC0NCgkJCQl0aGlzLm1hcmdpbnMucmlnaHQsDQoJCQkoIGlzVXNlclNjcm9sbGFibGUgPyBNYXRoLm1heCggY2Uuc2Nyb2xsSGVpZ2h0LCBjZS5vZmZzZXRIZWlnaHQgKSA6IGNlLm9mZnNldEhlaWdodCApIC0NCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggImJvcmRlckJvdHRvbVdpZHRoIiApLCAxMCApIHx8IDAgKSAtDQoJCQkJKCBwYXJzZUludCggYy5jc3MoICJwYWRkaW5nQm90dG9tIiApLCAxMCApIHx8IDAgKSAtDQoJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLQ0KCQkJCXRoaXMubWFyZ2lucy50b3AgLQ0KCQkJCXRoaXMubWFyZ2lucy5ib3R0b20NCgkJXTsNCgkJdGhpcy5yZWxhdGl2ZUNvbnRhaW5lciA9IGM7DQoJfSwNCg0KCV9jb252ZXJ0UG9zaXRpb25UbzogZnVuY3Rpb24oIGQsIHBvcyApIHsNCg0KCQlpZiAoICFwb3MgKSB7DQoJCQlwb3MgPSB0aGlzLnBvc2l0aW9uOw0KCQl9DQoNCgkJdmFyIG1vZCA9IGQgPT09ICJhYnNvbHV0ZSIgPyAxIDogLTEsDQoJCQlzY3JvbGxJc1Jvb3ROb2RlID0gdGhpcy5faXNSb290Tm9kZSggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSApOw0KDQoJCXJldHVybiB7DQoJCQl0b3A6ICgNCg0KCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbg0KCQkJCXBvcy50b3AJKw0KDQoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50DQoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUudG9wICogbW9kICsNCg0KCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpDQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LnRvcCAqIG1vZCAtDQoJCQkJKCAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPw0KCQkJCQktdGhpcy5vZmZzZXQuc2Nyb2xsLnRvcCA6DQoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiB0aGlzLm9mZnNldC5zY3JvbGwudG9wICkgKSAqIG1vZCApDQoJCQkpLA0KCQkJbGVmdDogKA0KDQoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uDQoJCQkJcG9zLmxlZnQgKw0KDQoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50DQoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdCAqIG1vZCArDQoNCgkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQ0KCQkJCXRoaXMub2Zmc2V0LnBhcmVudC5sZWZ0ICogbW9kCS0NCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/DQoJCQkJCS10aGlzLm9mZnNldC5zY3JvbGwubGVmdCA6DQoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiB0aGlzLm9mZnNldC5zY3JvbGwubGVmdCApICkgKiBtb2QgKQ0KCQkJKQ0KCQl9Ow0KDQoJfSwNCg0KCV9nZW5lcmF0ZVBvc2l0aW9uOiBmdW5jdGlvbiggZXZlbnQsIGNvbnN0cmFpblBvc2l0aW9uICkgew0KDQoJCXZhciBjb250YWlubWVudCwgY28sIHRvcCwgbGVmdCwNCgkJCW8gPSB0aGlzLm9wdGlvbnMsDQoJCQlzY3JvbGxJc1Jvb3ROb2RlID0gdGhpcy5faXNSb290Tm9kZSggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSApLA0KCQkJcGFnZVggPSBldmVudC5wYWdlWCwNCgkJCXBhZ2VZID0gZXZlbnQucGFnZVk7DQoNCgkJLy8gQ2FjaGUgdGhlIHNjcm9sbA0KCQlpZiAoICFzY3JvbGxJc1Jvb3ROb2RlIHx8ICF0aGlzLm9mZnNldC5zY3JvbGwgKSB7DQoJCQl0aGlzLm9mZnNldC5zY3JvbGwgPSB7DQoJCQkJdG9wOiB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSwNCgkJCQlsZWZ0OiB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkNCgkJCX07DQoJCX0NCg0KCQkvKg0KCQkgKiAtIFBvc2l0aW9uIGNvbnN0cmFpbmluZyAtDQoJCSAqIENvbnN0cmFpbiB0aGUgcG9zaXRpb24gdG8gYSBtaXggb2YgZ3JpZCwgY29udGFpbm1lbnQuDQoJCSAqLw0KDQoJCS8vIElmIHdlIGFyZSBub3QgZHJhZ2dpbmcgeWV0LCB3ZSB3b24ndCBjaGVjayBmb3Igb3B0aW9ucw0KCQlpZiAoIGNvbnN0cmFpblBvc2l0aW9uICkgew0KCQkJaWYgKCB0aGlzLmNvbnRhaW5tZW50ICkgew0KCQkJCWlmICggdGhpcy5yZWxhdGl2ZUNvbnRhaW5lciApIHsNCgkJCQkJY28gPSB0aGlzLnJlbGF0aXZlQ29udGFpbmVyLm9mZnNldCgpOw0KCQkJCQljb250YWlubWVudCA9IFsNCgkJCQkJCXRoaXMuY29udGFpbm1lbnRbIDAgXSArIGNvLmxlZnQsDQoJCQkJCQl0aGlzLmNvbnRhaW5tZW50WyAxIF0gKyBjby50b3AsDQoJCQkJCQl0aGlzLmNvbnRhaW5tZW50WyAyIF0gKyBjby5sZWZ0LA0KCQkJCQkJdGhpcy5jb250YWlubWVudFsgMyBdICsgY28udG9wDQoJCQkJCV07DQoJCQkJfSBlbHNlIHsNCgkJCQkJY29udGFpbm1lbnQgPSB0aGlzLmNvbnRhaW5tZW50Ow0KCQkJCX0NCg0KCQkJCWlmICggZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0IDwgY29udGFpbm1lbnRbIDAgXSApIHsNCgkJCQkJcGFnZVggPSBjb250YWlubWVudFsgMCBdICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdDsNCgkJCQl9DQoJCQkJaWYgKCBldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA8IGNvbnRhaW5tZW50WyAxIF0gKSB7DQoJCQkJCXBhZ2VZID0gY29udGFpbm1lbnRbIDEgXSArIHRoaXMub2Zmc2V0LmNsaWNrLnRvcDsNCgkJCQl9DQoJCQkJaWYgKCBldmVudC5wYWdlWCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPiBjb250YWlubWVudFsgMiBdICkgew0KCQkJCQlwYWdlWCA9IGNvbnRhaW5tZW50WyAyIF0gKyB0aGlzLm9mZnNldC5jbGljay5sZWZ0Ow0KCQkJCX0NCgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID4gY29udGFpbm1lbnRbIDMgXSApIHsNCgkJCQkJcGFnZVkgPSBjb250YWlubWVudFsgMyBdICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wOw0KCQkJCX0NCgkJCX0NCg0KCQkJaWYgKCBvLmdyaWQgKSB7DQoNCgkJCQkvL0NoZWNrIGZvciBncmlkIGVsZW1lbnRzIHNldCB0byAwIHRvIHByZXZlbnQgZGl2aWRlIGJ5IDAgZXJyb3IgY2F1c2luZyBpbnZhbGlkDQoJCQkJLy8gYXJndW1lbnQgZXJyb3JzIGluIElFIChzZWUgdGlja2V0ICM2OTUwKQ0KCQkJCXRvcCA9IG8uZ3JpZFsgMSBdID8gdGhpcy5vcmlnaW5hbFBhZ2VZICsgTWF0aC5yb3VuZCggKCBwYWdlWSAtDQoJCQkJCXRoaXMub3JpZ2luYWxQYWdlWSApIC8gby5ncmlkWyAxIF0gKSAqIG8uZ3JpZFsgMSBdIDogdGhpcy5vcmlnaW5hbFBhZ2VZOw0KCQkJCXBhZ2VZID0gY29udGFpbm1lbnQgPyAoICggdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID49IGNvbnRhaW5tZW50WyAxIF0gfHwNCgkJCQkJdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID4gY29udGFpbm1lbnRbIDMgXSApID8NCgkJCQkJCXRvcCA6DQoJCQkJCQkoICggdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID49IGNvbnRhaW5tZW50WyAxIF0gKSA\/DQoJCQkJCQkJdG9wIC0gby5ncmlkWyAxIF0gOiB0b3AgKyBvLmdyaWRbIDEgXSApICkgOiB0b3A7DQoNCgkJCQlsZWZ0ID0gby5ncmlkWyAwIF0gPyB0aGlzLm9yaWdpbmFsUGFnZVggKw0KCQkJCQlNYXRoLnJvdW5kKCAoIHBhZ2VYIC0gdGhpcy5vcmlnaW5hbFBhZ2VYICkgLyBvLmdyaWRbIDAgXSApICogby5ncmlkWyAwIF0gOg0KCQkJCQl0aGlzLm9yaWdpbmFsUGFnZVg7DQoJCQkJcGFnZVggPSBjb250YWlubWVudCA\/ICggKCBsZWZ0IC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+PSBjb250YWlubWVudFsgMCBdIHx8DQoJCQkJCWxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID4gY29udGFpbm1lbnRbIDIgXSApID8NCgkJCQkJCWxlZnQgOg0KCQkJCQkJKCAoIGxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID49IGNvbnRhaW5tZW50WyAwIF0gKSA\/DQoJCQkJCQkJbGVmdCAtIG8uZ3JpZFsgMCBdIDogbGVmdCArIG8uZ3JpZFsgMCBdICkgKSA6IGxlZnQ7DQoJCQl9DQoNCgkJCWlmICggby5heGlzID09PSAieSIgKSB7DQoJCQkJcGFnZVggPSB0aGlzLm9yaWdpbmFsUGFnZVg7DQoJCQl9DQoNCgkJCWlmICggby5heGlzID09PSAieCIgKSB7DQoJCQkJcGFnZVkgPSB0aGlzLm9yaWdpbmFsUGFnZVk7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gew0KCQkJdG9wOiAoDQoNCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24NCgkJCQlwYWdlWSAtDQoNCgkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQ0KCQkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCAtDQoNCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQNCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgLQ0KDQoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikNCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQudG9wICsNCgkJCQkoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPw0KCQkJCQktdGhpcy5vZmZzZXQuc2Nyb2xsLnRvcCA6DQoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiB0aGlzLm9mZnNldC5zY3JvbGwudG9wICkgKQ0KCQkJKSwNCgkJCWxlZnQ6ICgNCg0KCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbg0KCQkJCXBhZ2VYIC0NCg0KCQkJCS8vIENsaWNrIG9mZnNldCAocmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQpDQoJCQkJdGhpcy5vZmZzZXQuY2xpY2subGVmdCAtDQoNCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQNCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0NCg0KCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpDQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgKw0KCQkJCSggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/DQoJCQkJCS10aGlzLm9mZnNldC5zY3JvbGwubGVmdCA6DQoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiB0aGlzLm9mZnNldC5zY3JvbGwubGVmdCApICkNCgkJCSkNCgkJfTsNCg0KCX0sDQoNCglfY2xlYXI6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5oZWxwZXIsICJ1aS1kcmFnZ2FibGUtZHJhZ2dpbmciICk7DQoJCWlmICggdGhpcy5oZWxwZXJbIDAgXSAhPT0gdGhpcy5lbGVtZW50WyAwIF0gJiYgIXRoaXMuY2FuY2VsSGVscGVyUmVtb3ZhbCApIHsNCgkJCXRoaXMuaGVscGVyLnJlbW92ZSgpOw0KCQl9DQoJCXRoaXMuaGVscGVyID0gbnVsbDsNCgkJdGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsID0gZmFsc2U7DQoJCWlmICggdGhpcy5kZXN0cm95T25DbGVhciApIHsNCgkJCXRoaXMuZGVzdHJveSgpOw0KCQl9DQoJfSwNCg0KCS8vIEZyb20gbm93IG9uIGJ1bGsgc3R1ZmYgLSBtYWlubHkgaGVscGVycw0KDQoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgdWkgKSB7DQoJCXVpID0gdWkgfHwgdGhpcy5fdWlIYXNoKCk7DQoJCSQudWkucGx1Z2luLmNhbGwoIHRoaXMsIHR5cGUsIFsgZXZlbnQsIHVpLCB0aGlzIF0sIHRydWUgKTsNCg0KCQkvLyBBYnNvbHV0ZSBwb3NpdGlvbiBhbmQgb2Zmc2V0IChzZWUgIzY4ODQgKSBoYXZlIHRvIGJlIHJlY2FsY3VsYXRlZCBhZnRlciBwbHVnaW5zDQoJCWlmICggL14oZHJhZ3xzdGFydHxzdG9wKS8udGVzdCggdHlwZSApICkgew0KCQkJdGhpcy5wb3NpdGlvbkFicyA9IHRoaXMuX2NvbnZlcnRQb3NpdGlvblRvKCAiYWJzb2x1dGUiICk7DQoJCQl1aS5vZmZzZXQgPSB0aGlzLnBvc2l0aW9uQWJzOw0KCQl9DQoJCXJldHVybiAkLldpZGdldC5wcm90b3R5cGUuX3RyaWdnZXIuY2FsbCggdGhpcywgdHlwZSwgZXZlbnQsIHVpICk7DQoJfSwNCg0KCXBsdWdpbnM6IHt9LA0KDQoJX3VpSGFzaDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB7DQoJCQloZWxwZXI6IHRoaXMuaGVscGVyLA0KCQkJcG9zaXRpb246IHRoaXMucG9zaXRpb24sDQoJCQlvcmlnaW5hbFBvc2l0aW9uOiB0aGlzLm9yaWdpbmFsUG9zaXRpb24sDQoJCQlvZmZzZXQ6IHRoaXMucG9zaXRpb25BYnMNCgkJfTsNCgl9DQoNCn0gKTsNCg0KJC51aS5wbHVnaW4uYWRkKCAiZHJhZ2dhYmxlIiwgImNvbm5lY3RUb1NvcnRhYmxlIiwgew0KCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBkcmFnZ2FibGUgKSB7DQoJCXZhciB1aVNvcnRhYmxlID0gJC5leHRlbmQoIHt9LCB1aSwgew0KCQkJaXRlbTogZHJhZ2dhYmxlLmVsZW1lbnQNCgkJfSApOw0KDQoJCWRyYWdnYWJsZS5zb3J0YWJsZXMgPSBbXTsNCgkJJCggZHJhZ2dhYmxlLm9wdGlvbnMuY29ubmVjdFRvU29ydGFibGUgKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCXZhciBzb3J0YWJsZSA9ICQoIHRoaXMgKS5zb3J0YWJsZSggImluc3RhbmNlIiApOw0KDQoJCQlpZiAoIHNvcnRhYmxlICYmICFzb3J0YWJsZS5vcHRpb25zLmRpc2FibGVkICkgew0KCQkJCWRyYWdnYWJsZS5zb3J0YWJsZXMucHVzaCggc29ydGFibGUgKTsNCg0KCQkJCS8vIFJlZnJlc2hQb3NpdGlvbnMgaXMgY2FsbGVkIGF0IGRyYWcgc3RhcnQgdG8gcmVmcmVzaCB0aGUgY29udGFpbmVyQ2FjaGUNCgkJCQkvLyB3aGljaCBpcyB1c2VkIGluIGRyYWcuIFRoaXMgZW5zdXJlcyBpdCdzIGluaXRpYWxpemVkIGFuZCBzeW5jaHJvbml6ZWQNCgkJCQkvLyB3aXRoIGFueSBjaGFuZ2VzIHRoYXQgbWlnaHQgaGF2ZSBoYXBwZW5lZCBvbiB0aGUgcGFnZSBzaW5jZSBpbml0aWFsaXphdGlvbi4NCgkJCQlzb3J0YWJsZS5yZWZyZXNoUG9zaXRpb25zKCk7DQoJCQkJc29ydGFibGUuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCB1aVNvcnRhYmxlICk7DQoJCQl9DQoJCX0gKTsNCgl9LA0KCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWksIGRyYWdnYWJsZSApIHsNCgkJdmFyIHVpU29ydGFibGUgPSAkLmV4dGVuZCgge30sIHVpLCB7DQoJCQlpdGVtOiBkcmFnZ2FibGUuZWxlbWVudA0KCQl9ICk7DQoNCgkJZHJhZ2dhYmxlLmNhbmNlbEhlbHBlclJlbW92YWwgPSBmYWxzZTsNCg0KCQkkLmVhY2goIGRyYWdnYWJsZS5zb3J0YWJsZXMsIGZ1bmN0aW9uKCkgew0KCQkJdmFyIHNvcnRhYmxlID0gdGhpczsNCg0KCQkJaWYgKCBzb3J0YWJsZS5pc092ZXIgKSB7DQoJCQkJc29ydGFibGUuaXNPdmVyID0gMDsNCg0KCQkJCS8vIEFsbG93IHRoaXMgc29ydGFibGUgdG8gaGFuZGxlIHJlbW92aW5nIHRoZSBoZWxwZXINCgkJCQlkcmFnZ2FibGUuY2FuY2VsSGVscGVyUmVtb3ZhbCA9IHRydWU7DQoJCQkJc29ydGFibGUuY2FuY2VsSGVscGVyUmVtb3ZhbCA9IGZhbHNlOw0KDQoJCQkJLy8gVXNlIF9zdG9yZWRDU1MgVG8gcmVzdG9yZSBwcm9wZXJ0aWVzIGluIHRoZSBzb3J0YWJsZSwNCgkJCQkvLyBhcyB0aGlzIGFsc28gaGFuZGxlcyByZXZlcnQgKCM5Njc1KSBzaW5jZSB0aGUgZHJhZ2dhYmxlDQoJCQkJLy8gbWF5IGhhdmUgbW9kaWZpZWQgdGhlbSBpbiB1bmV4cGVjdGVkIHdheXMgKCM4ODA5KQ0KCQkJCXNvcnRhYmxlLl9zdG9yZWRDU1MgPSB7DQoJCQkJCXBvc2l0aW9uOiBzb3J0YWJsZS5wbGFjZWhvbGRlci5jc3MoICJwb3NpdGlvbiIgKSwNCgkJCQkJdG9wOiBzb3J0YWJsZS5wbGFjZWhvbGRlci5jc3MoICJ0b3AiICksDQoJCQkJCWxlZnQ6IHNvcnRhYmxlLnBsYWNlaG9sZGVyLmNzcyggImxlZnQiICkNCgkJCQl9Ow0KDQoJCQkJc29ydGFibGUuX21vdXNlU3RvcCggZXZlbnQgKTsNCg0KCQkJCS8vIE9uY2UgZHJhZyBoYXMgZW5kZWQsIHRoZSBzb3J0YWJsZSBzaG91bGQgcmV0dXJuIHRvIHVzaW5nDQoJCQkJLy8gaXRzIG9yaWdpbmFsIGhlbHBlciwgbm90IHRoZSBzaGFyZWQgaGVscGVyIGZyb20gZHJhZ2dhYmxlDQoJCQkJc29ydGFibGUub3B0aW9ucy5oZWxwZXIgPSBzb3J0YWJsZS5vcHRpb25zLl9oZWxwZXI7DQoJCQl9IGVsc2Ugew0KDQoJCQkJLy8gUHJldmVudCB0aGlzIFNvcnRhYmxlIGZyb20gcmVtb3ZpbmcgdGhlIGhlbHBlci4NCgkJCQkvLyBIb3dldmVyLCBkb24ndCBzZXQgdGhlIGRyYWdnYWJsZSB0byByZW1vdmUgdGhlIGhlbHBlcg0KCQkJCS8vIGVpdGhlciBhcyBhbm90aGVyIGNvbm5lY3RlZCBTb3J0YWJsZSBtYXkgeWV0IGhhbmRsZSB0aGUgcmVtb3ZhbC4NCgkJCQlzb3J0YWJsZS5jYW5jZWxIZWxwZXJSZW1vdmFsID0gdHJ1ZTsNCg0KCQkJCXNvcnRhYmxlLl90cmlnZ2VyKCAiZGVhY3RpdmF0ZSIsIGV2ZW50LCB1aVNvcnRhYmxlICk7DQoJCQl9DQoJCX0gKTsNCgl9LA0KCWRyYWc6IGZ1bmN0aW9uKCBldmVudCwgdWksIGRyYWdnYWJsZSApIHsNCgkJJC5lYWNoKCBkcmFnZ2FibGUuc29ydGFibGVzLCBmdW5jdGlvbigpIHsNCgkJCXZhciBpbm5lcm1vc3RJbnRlcnNlY3RpbmcgPSBmYWxzZSwNCgkJCQlzb3J0YWJsZSA9IHRoaXM7DQoNCgkJCS8vIENvcHkgb3ZlciB2YXJpYWJsZXMgdGhhdCBzb3J0YWJsZSdzIF9pbnRlcnNlY3RzV2l0aCB1c2VzDQoJCQlzb3J0YWJsZS5wb3NpdGlvbkFicyA9IGRyYWdnYWJsZS5wb3NpdGlvbkFiczsNCgkJCXNvcnRhYmxlLmhlbHBlclByb3BvcnRpb25zID0gZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zOw0KCQkJc29ydGFibGUub2Zmc2V0LmNsaWNrID0gZHJhZ2dhYmxlLm9mZnNldC5jbGljazsNCg0KCQkJaWYgKCBzb3J0YWJsZS5faW50ZXJzZWN0c1dpdGgoIHNvcnRhYmxlLmNvbnRhaW5lckNhY2hlICkgKSB7DQoJCQkJaW5uZXJtb3N0SW50ZXJzZWN0aW5nID0gdHJ1ZTsNCg0KCQkJCSQuZWFjaCggZHJhZ2dhYmxlLnNvcnRhYmxlcywgZnVuY3Rpb24oKSB7DQoNCgkJCQkJLy8gQ29weSBvdmVyIHZhcmlhYmxlcyB0aGF0IHNvcnRhYmxlJ3MgX2ludGVyc2VjdHNXaXRoIHVzZXMNCgkJCQkJdGhpcy5wb3NpdGlvbkFicyA9IGRyYWdnYWJsZS5wb3NpdGlvbkFiczsNCgkJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucyA9IGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9uczsNCgkJCQkJdGhpcy5vZmZzZXQuY2xpY2sgPSBkcmFnZ2FibGUub2Zmc2V0LmNsaWNrOw0KDQoJCQkJCWlmICggdGhpcyAhPT0gc29ydGFibGUgJiYNCgkJCQkJCQl0aGlzLl9pbnRlcnNlY3RzV2l0aCggdGhpcy5jb250YWluZXJDYWNoZSApICYmDQoJCQkJCQkJJC5jb250YWlucyggc29ydGFibGUuZWxlbWVudFsgMCBdLCB0aGlzLmVsZW1lbnRbIDAgXSApICkgew0KCQkJCQkJaW5uZXJtb3N0SW50ZXJzZWN0aW5nID0gZmFsc2U7DQoJCQkJCX0NCg0KCQkJCQlyZXR1cm4gaW5uZXJtb3N0SW50ZXJzZWN0aW5nOw0KCQkJCX0gKTsNCgkJCX0NCg0KCQkJaWYgKCBpbm5lcm1vc3RJbnRlcnNlY3RpbmcgKSB7DQoNCgkJCQkvLyBJZiBpdCBpbnRlcnNlY3RzLCB3ZSB1c2UgYSBsaXR0bGUgaXNPdmVyIHZhcmlhYmxlIGFuZCBzZXQgaXQgb25jZSwNCgkJCQkvLyBzbyB0aGF0IHRoZSBtb3ZlLWluIHN0dWZmIGdldHMgZmlyZWQgb25seSBvbmNlLg0KCQkJCWlmICggIXNvcnRhYmxlLmlzT3ZlciApIHsNCgkJCQkJc29ydGFibGUuaXNPdmVyID0gMTsNCg0KCQkJCQkvLyBTdG9yZSBkcmFnZ2FibGUncyBwYXJlbnQgaW4gY2FzZSB3ZSBuZWVkIHRvIHJlYXBwZW5kIHRvIGl0IGxhdGVyLg0KCQkJCQlkcmFnZ2FibGUuX3BhcmVudCA9IHVpLmhlbHBlci5wYXJlbnQoKTsNCg0KCQkJCQlzb3J0YWJsZS5jdXJyZW50SXRlbSA9IHVpLmhlbHBlcg0KCQkJCQkJLmFwcGVuZFRvKCBzb3J0YWJsZS5lbGVtZW50ICkNCgkJCQkJCS5kYXRhKCAidWktc29ydGFibGUtaXRlbSIsIHRydWUgKTsNCg0KCQkJCQkvLyBTdG9yZSBoZWxwZXIgb3B0aW9uIHRvIGxhdGVyIHJlc3RvcmUgaXQNCgkJCQkJc29ydGFibGUub3B0aW9ucy5faGVscGVyID0gc29ydGFibGUub3B0aW9ucy5oZWxwZXI7DQoNCgkJCQkJc29ydGFibGUub3B0aW9ucy5oZWxwZXIgPSBmdW5jdGlvbigpIHsNCgkJCQkJCXJldHVybiB1aS5oZWxwZXJbIDAgXTsNCgkJCQkJfTsNCg0KCQkJCQkvLyBGaXJlIHRoZSBzdGFydCBldmVudHMgb2YgdGhlIHNvcnRhYmxlIHdpdGggb3VyIHBhc3NlZCBicm93c2VyIGV2ZW50LA0KCQkJCQkvLyBhbmQgb3VyIG93biBoZWxwZXIgKHNvIGl0IGRvZXNuJ3QgY3JlYXRlIGEgbmV3IG9uZSkNCgkJCQkJZXZlbnQudGFyZ2V0ID0gc29ydGFibGUuY3VycmVudEl0ZW1bIDAgXTsNCgkJCQkJc29ydGFibGUuX21vdXNlQ2FwdHVyZSggZXZlbnQsIHRydWUgKTsNCgkJCQkJc29ydGFibGUuX21vdXNlU3RhcnQoIGV2ZW50LCB0cnVlLCB0cnVlICk7DQoNCgkJCQkJLy8gQmVjYXVzZSB0aGUgYnJvd3NlciBldmVudCBpcyB3YXkgb2ZmIHRoZSBuZXcgYXBwZW5kZWQgcG9ydGxldCwNCgkJCQkJLy8gbW9kaWZ5IG5lY2Vzc2FyeSB2YXJpYWJsZXMgdG8gcmVmbGVjdCB0aGUgY2hhbmdlcw0KCQkJCQlzb3J0YWJsZS5vZmZzZXQuY2xpY2sudG9wID0gZHJhZ2dhYmxlLm9mZnNldC5jbGljay50b3A7DQoJCQkJCXNvcnRhYmxlLm9mZnNldC5jbGljay5sZWZ0ID0gZHJhZ2dhYmxlLm9mZnNldC5jbGljay5sZWZ0Ow0KCQkJCQlzb3J0YWJsZS5vZmZzZXQucGFyZW50LmxlZnQgLT0gZHJhZ2dhYmxlLm9mZnNldC5wYXJlbnQubGVmdCAtDQoJCQkJCQlzb3J0YWJsZS5vZmZzZXQucGFyZW50LmxlZnQ7DQoJCQkJCXNvcnRhYmxlLm9mZnNldC5wYXJlbnQudG9wIC09IGRyYWdnYWJsZS5vZmZzZXQucGFyZW50LnRvcCAtDQoJCQkJCQlzb3J0YWJsZS5vZmZzZXQucGFyZW50LnRvcDsNCg0KCQkJCQlkcmFnZ2FibGUuX3RyaWdnZXIoICJ0b1NvcnRhYmxlIiwgZXZlbnQgKTsNCg0KCQkJCQkvLyBJbmZvcm0gZHJhZ2dhYmxlIHRoYXQgdGhlIGhlbHBlciBpcyBpbiBhIHZhbGlkIGRyb3Agem9uZSwNCgkJCQkJLy8gdXNlZCBzb2xlbHkgaW4gdGhlIHJldmVydCBvcHRpb24gdG8gaGFuZGxlICJ2YWxpZC9pbnZhbGlkIi4NCgkJCQkJZHJhZ2dhYmxlLmRyb3BwZWQgPSBzb3J0YWJsZS5lbGVtZW50Ow0KDQoJCQkJCS8vIE5lZWQgdG8gcmVmcmVzaFBvc2l0aW9ucyBvZiBhbGwgc29ydGFibGVzIGluIHRoZSBjYXNlIHRoYXQNCgkJCQkJLy8gYWRkaW5nIHRvIG9uZSBzb3J0YWJsZSBjaGFuZ2VzIHRoZSBsb2NhdGlvbiBvZiB0aGUgb3RoZXIgc29ydGFibGVzICgjOTY3NSkNCgkJCQkJJC5lYWNoKCBkcmFnZ2FibGUuc29ydGFibGVzLCBmdW5jdGlvbigpIHsNCgkJCQkJCXRoaXMucmVmcmVzaFBvc2l0aW9ucygpOw0KCQkJCQl9ICk7DQoNCgkJCQkJLy8gSGFjayBzbyByZWNlaXZlL3VwZGF0ZSBjYWxsYmFja3Mgd29yayAobW9zdGx5KQ0KCQkJCQlkcmFnZ2FibGUuY3VycmVudEl0ZW0gPSBkcmFnZ2FibGUuZWxlbWVudDsNCgkJCQkJc29ydGFibGUuZnJvbU91dHNpZGUgPSBkcmFnZ2FibGU7DQoJCQkJfQ0KDQoJCQkJaWYgKCBzb3J0YWJsZS5jdXJyZW50SXRlbSApIHsNCgkJCQkJc29ydGFibGUuX21vdXNlRHJhZyggZXZlbnQgKTsNCg0KCQkJCQkvLyBDb3B5IHRoZSBzb3J0YWJsZSdzIHBvc2l0aW9uIGJlY2F1c2UgdGhlIGRyYWdnYWJsZSdzIGNhbiBwb3RlbnRpYWxseSByZWZsZWN0DQoJCQkJCS8vIGEgcmVsYXRpdmUgcG9zaXRpb24sIHdoaWxlIHNvcnRhYmxlIGlzIGFsd2F5cyBhYnNvbHV0ZSwgd2hpY2ggdGhlIGRyYWdnZWQNCgkJCQkJLy8gZWxlbWVudCBoYXMgbm93IGJlY29tZS4gKCM4ODA5KQ0KCQkJCQl1aS5wb3NpdGlvbiA9IHNvcnRhYmxlLnBvc2l0aW9uOw0KCQkJCX0NCgkJCX0gZWxzZSB7DQoNCgkJCQkvLyBJZiBpdCBkb2Vzbid0IGludGVyc2VjdCB3aXRoIHRoZSBzb3J0YWJsZSwgYW5kIGl0IGludGVyc2VjdGVkIGJlZm9yZSwNCgkJCQkvLyB3ZSBmYWtlIHRoZSBkcmFnIHN0b3Agb2YgdGhlIHNvcnRhYmxlLCBidXQgbWFrZSBzdXJlIGl0IGRvZXNuJ3QgcmVtb3ZlDQoJCQkJLy8gdGhlIGhlbHBlciBieSB1c2luZyBjYW5jZWxIZWxwZXJSZW1vdmFsLg0KCQkJCWlmICggc29ydGFibGUuaXNPdmVyICkgew0KDQoJCQkJCXNvcnRhYmxlLmlzT3ZlciA9IDA7DQoJCQkJCXNvcnRhYmxlLmNhbmNlbEhlbHBlclJlbW92YWwgPSB0cnVlOw0KDQoJCQkJCS8vIENhbGxpbmcgc29ydGFibGUncyBtb3VzZVN0b3Agd291bGQgdHJpZ2dlciBhIHJldmVydCwNCgkJCQkJLy8gc28gcmV2ZXJ0IG11c3QgYmUgdGVtcG9yYXJpbHkgZmFsc2UgdW50aWwgYWZ0ZXIgbW91c2VTdG9wIGlzIGNhbGxlZC4NCgkJCQkJc29ydGFibGUub3B0aW9ucy5fcmV2ZXJ0ID0gc29ydGFibGUub3B0aW9ucy5yZXZlcnQ7DQoJCQkJCXNvcnRhYmxlLm9wdGlvbnMucmV2ZXJ0ID0gZmFsc2U7DQoNCgkJCQkJc29ydGFibGUuX3RyaWdnZXIoICJvdXQiLCBldmVudCwgc29ydGFibGUuX3VpSGFzaCggc29ydGFibGUgKSApOw0KCQkJCQlzb3J0YWJsZS5fbW91c2VTdG9wKCBldmVudCwgdHJ1ZSApOw0KDQoJCQkJCS8vIFJlc3RvcmUgc29ydGFibGUgYmVoYXZpb3JzIHRoYXQgd2VyZSBtb2RmaWVkDQoJCQkJCS8vIHdoZW4gdGhlIGRyYWdnYWJsZSBlbnRlcmVkIHRoZSBzb3J0YWJsZSBhcmVhICgjOTQ4MSkNCgkJCQkJc29ydGFibGUub3B0aW9ucy5yZXZlcnQgPSBzb3J0YWJsZS5vcHRpb25zLl9yZXZlcnQ7DQoJCQkJCXNvcnRhYmxlLm9wdGlvbnMuaGVscGVyID0gc29ydGFibGUub3B0aW9ucy5faGVscGVyOw0KDQoJCQkJCWlmICggc29ydGFibGUucGxhY2Vob2xkZXIgKSB7DQoJCQkJCQlzb3J0YWJsZS5wbGFjZWhvbGRlci5yZW1vdmUoKTsNCgkJCQkJfQ0KDQoJCQkJCS8vIFJlc3RvcmUgYW5kIHJlY2FsY3VsYXRlIHRoZSBkcmFnZ2FibGUncyBvZmZzZXQgY29uc2lkZXJpbmcgdGhlIHNvcnRhYmxlDQoJCQkJCS8vIG1heSBoYXZlIG1vZGlmaWVkIHRoZW0gaW4gdW5leHBlY3RlZCB3YXlzLiAoIzg4MDksICMxMDY2OSkNCgkJCQkJdWkuaGVscGVyLmFwcGVuZFRvKCBkcmFnZ2FibGUuX3BhcmVudCApOw0KCQkJCQlkcmFnZ2FibGUuX3JlZnJlc2hPZmZzZXRzKCBldmVudCApOw0KCQkJCQl1aS5wb3NpdGlvbiA9IGRyYWdnYWJsZS5fZ2VuZXJhdGVQb3NpdGlvbiggZXZlbnQsIHRydWUgKTsNCg0KCQkJCQlkcmFnZ2FibGUuX3RyaWdnZXIoICJmcm9tU29ydGFibGUiLCBldmVudCApOw0KDQoJCQkJCS8vIEluZm9ybSBkcmFnZ2FibGUgdGhhdCB0aGUgaGVscGVyIGlzIG5vIGxvbmdlciBpbiBhIHZhbGlkIGRyb3Agem9uZQ0KCQkJCQlkcmFnZ2FibGUuZHJvcHBlZCA9IGZhbHNlOw0KDQoJCQkJCS8vIE5lZWQgdG8gcmVmcmVzaFBvc2l0aW9ucyBvZiBhbGwgc29ydGFibGVzIGp1c3QgaW4gY2FzZSByZW1vdmluZw0KCQkJCQkvLyBmcm9tIG9uZSBzb3J0YWJsZSBjaGFuZ2VzIHRoZSBsb2NhdGlvbiBvZiBvdGhlciBzb3J0YWJsZXMgKCM5Njc1KQ0KCQkJCQkkLmVhY2goIGRyYWdnYWJsZS5zb3J0YWJsZXMsIGZ1bmN0aW9uKCkgew0KCQkJCQkJdGhpcy5yZWZyZXNoUG9zaXRpb25zKCk7DQoJCQkJCX0gKTsNCgkJCQl9DQoJCQl9DQoJCX0gKTsNCgl9DQp9ICk7DQoNCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJjdXJzb3IiLCB7DQoJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgew0KCQl2YXIgdCA9ICQoICJib2R5IiApLA0KCQkJbyA9IGluc3RhbmNlLm9wdGlvbnM7DQoNCgkJaWYgKCB0LmNzcyggImN1cnNvciIgKSApIHsNCgkJCW8uX2N1cnNvciA9IHQuY3NzKCAiY3Vyc29yIiApOw0KCQl9DQoJCXQuY3NzKCAiY3Vyc29yIiwgby5jdXJzb3IgKTsNCgl9LA0KCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgew0KCQl2YXIgbyA9IGluc3RhbmNlLm9wdGlvbnM7DQoJCWlmICggby5fY3Vyc29yICkgew0KCQkJJCggImJvZHkiICkuY3NzKCAiY3Vyc29yIiwgby5fY3Vyc29yICk7DQoJCX0NCgl9DQp9ICk7DQoNCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJvcGFjaXR5Iiwgew0KCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsNCgkJdmFyIHQgPSAkKCB1aS5oZWxwZXIgKSwNCgkJCW8gPSBpbnN0YW5jZS5vcHRpb25zOw0KCQlpZiAoIHQuY3NzKCAib3BhY2l0eSIgKSApIHsNCgkJCW8uX29wYWNpdHkgPSB0LmNzcyggIm9wYWNpdHkiICk7DQoJCX0NCgkJdC5jc3MoICJvcGFjaXR5Iiwgby5vcGFjaXR5ICk7DQoJfSwNCglzdG9wOiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsNCgkJdmFyIG8gPSBpbnN0YW5jZS5vcHRpb25zOw0KCQlpZiAoIG8uX29wYWNpdHkgKSB7DQoJCQkkKCB1aS5oZWxwZXIgKS5jc3MoICJvcGFjaXR5Iiwgby5fb3BhY2l0eSApOw0KCQl9DQoJfQ0KfSApOw0KDQokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAic2Nyb2xsIiwgew0KCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpICkgew0KCQlpZiAoICFpLnNjcm9sbFBhcmVudE5vdEhpZGRlbiApIHsNCgkJCWkuc2Nyb2xsUGFyZW50Tm90SGlkZGVuID0gaS5oZWxwZXIuc2Nyb2xsUGFyZW50KCBmYWxzZSApOw0KCQl9DQoNCgkJaWYgKCBpLnNjcm9sbFBhcmVudE5vdEhpZGRlblsgMCBdICE9PSBpLmRvY3VtZW50WyAwIF0gJiYNCgkJCQlpLnNjcm9sbFBhcmVudE5vdEhpZGRlblsgMCBdLnRhZ05hbWUgIT09ICJIVE1MIiApIHsNCgkJCWkub3ZlcmZsb3dPZmZzZXQgPSBpLnNjcm9sbFBhcmVudE5vdEhpZGRlbi5vZmZzZXQoKTsNCgkJfQ0KCX0sDQoJZHJhZzogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaSAgKSB7DQoNCgkJdmFyIG8gPSBpLm9wdGlvbnMsDQoJCQlzY3JvbGxlZCA9IGZhbHNlLA0KCQkJc2Nyb2xsUGFyZW50ID0gaS5zY3JvbGxQYXJlbnROb3RIaWRkZW5bIDAgXSwNCgkJCWRvY3VtZW50ID0gaS5kb2N1bWVudFsgMCBdOw0KDQoJCWlmICggc2Nyb2xsUGFyZW50ICE9PSBkb2N1bWVudCAmJiBzY3JvbGxQYXJlbnQudGFnTmFtZSAhPT0gIkhUTUwiICkgew0KCQkJaWYgKCAhby5heGlzIHx8IG8uYXhpcyAhPT0gIngiICkgew0KCQkJCWlmICggKCBpLm92ZXJmbG93T2Zmc2V0LnRvcCArIHNjcm9sbFBhcmVudC5vZmZzZXRIZWlnaHQgKSAtIGV2ZW50LnBhZ2VZIDwNCgkJCQkJCW8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7DQoJCQkJCXNjcm9sbFBhcmVudC5zY3JvbGxUb3AgPSBzY3JvbGxlZCA9IHNjcm9sbFBhcmVudC5zY3JvbGxUb3AgKyBvLnNjcm9sbFNwZWVkOw0KCQkJCX0gZWxzZSBpZiAoIGV2ZW50LnBhZ2VZIC0gaS5vdmVyZmxvd09mZnNldC50b3AgPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgew0KCQkJCQlzY3JvbGxQYXJlbnQuc2Nyb2xsVG9wID0gc2Nyb2xsZWQgPSBzY3JvbGxQYXJlbnQuc2Nyb2xsVG9wIC0gby5zY3JvbGxTcGVlZDsNCgkJCQl9DQoJCQl9DQoNCgkJCWlmICggIW8uYXhpcyB8fCBvLmF4aXMgIT09ICJ5IiApIHsNCgkJCQlpZiAoICggaS5vdmVyZmxvd09mZnNldC5sZWZ0ICsgc2Nyb2xsUGFyZW50Lm9mZnNldFdpZHRoICkgLSBldmVudC5wYWdlWCA8DQoJCQkJCQlvLnNjcm9sbFNlbnNpdGl2aXR5ICkgew0KCQkJCQlzY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCA9IHNjcm9sbGVkID0gc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQgKyBvLnNjcm9sbFNwZWVkOw0KCQkJCX0gZWxzZSBpZiAoIGV2ZW50LnBhZ2VYIC0gaS5vdmVyZmxvd09mZnNldC5sZWZ0IDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsNCgkJCQkJc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQgPSBzY3JvbGxlZCA9IHNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0IC0gby5zY3JvbGxTcGVlZDsNCgkJCQl9DQoJCQl9DQoNCgkJfSBlbHNlIHsNCg0KCQkJaWYgKCAhby5heGlzIHx8IG8uYXhpcyAhPT0gIngiICkgew0KCQkJCWlmICggZXZlbnQucGFnZVkgLSAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCgpIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsNCgkJCQkJc2Nyb2xsZWQgPSAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCggJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSAtIG8uc2Nyb2xsU3BlZWQgKTsNCgkJCQl9IGVsc2UgaWYgKCAkKCB3aW5kb3cgKS5oZWlnaHQoKSAtICggZXZlbnQucGFnZVkgLSAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCgpICkgPA0KCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsNCgkJCQkJc2Nyb2xsZWQgPSAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCggJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSArIG8uc2Nyb2xsU3BlZWQgKTsNCgkJCQl9DQoJCQl9DQoNCgkJCWlmICggIW8uYXhpcyB8fCBvLmF4aXMgIT09ICJ5IiApIHsNCgkJCQlpZiAoIGV2ZW50LnBhZ2VYIC0gJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgew0KCQkJCQlzY3JvbGxlZCA9ICQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgNCgkJCQkJCSQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgpIC0gby5zY3JvbGxTcGVlZA0KCQkJCQkpOw0KCQkJCX0gZWxzZSBpZiAoICQoIHdpbmRvdyApLndpZHRoKCkgLSAoIGV2ZW50LnBhZ2VYIC0gJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgKSA8DQoJCQkJCQlvLnNjcm9sbFNlbnNpdGl2aXR5ICkgew0KCQkJCQlzY3JvbGxlZCA9ICQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgNCgkJCQkJCSQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgpICsgby5zY3JvbGxTcGVlZA0KCQkJCQkpOw0KCQkJCX0NCgkJCX0NCg0KCQl9DQoNCgkJaWYgKCBzY3JvbGxlZCAhPT0gZmFsc2UgJiYgJC51aS5kZG1hbmFnZXIgJiYgIW8uZHJvcEJlaGF2aW91ciApIHsNCgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBpLCBldmVudCApOw0KCQl9DQoNCgl9DQp9ICk7DQoNCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJzbmFwIiwgew0KCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpICkgew0KDQoJCXZhciBvID0gaS5vcHRpb25zOw0KDQoJCWkuc25hcEVsZW1lbnRzID0gW107DQoNCgkJJCggby5zbmFwLmNvbnN0cnVjdG9yICE9PSBTdHJpbmcgPyAoIG8uc25hcC5pdGVtcyB8fCAiOmRhdGEodWktZHJhZ2dhYmxlKSIgKSA6IG8uc25hcCApDQoJCQkuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJdmFyICR0ID0gJCggdGhpcyApLA0KCQkJCQkkbyA9ICR0Lm9mZnNldCgpOw0KCQkJCWlmICggdGhpcyAhPT0gaS5lbGVtZW50WyAwIF0gKSB7DQoJCQkJCWkuc25hcEVsZW1lbnRzLnB1c2goIHsNCgkJCQkJCWl0ZW06IHRoaXMsDQoJCQkJCQl3aWR0aDogJHQub3V0ZXJXaWR0aCgpLCBoZWlnaHQ6ICR0Lm91dGVySGVpZ2h0KCksDQoJCQkJCQl0b3A6ICRvLnRvcCwgbGVmdDogJG8ubGVmdA0KCQkJCQl9ICk7DQoJCQkJfQ0KCQkJfSApOw0KDQoJfSwNCglkcmFnOiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0ICkgew0KDQoJCXZhciB0cywgYnMsIGxzLCBycywgbCwgciwgdCwgYiwgaSwgZmlyc3QsDQoJCQlvID0gaW5zdC5vcHRpb25zLA0KCQkJZCA9IG8uc25hcFRvbGVyYW5jZSwNCgkJCXgxID0gdWkub2Zmc2V0LmxlZnQsIHgyID0geDEgKyBpbnN0LmhlbHBlclByb3BvcnRpb25zLndpZHRoLA0KCQkJeTEgPSB1aS5vZmZzZXQudG9wLCB5MiA9IHkxICsgaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQ7DQoNCgkJZm9yICggaSA9IGluc3Quc25hcEVsZW1lbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgew0KDQoJCQlsID0gaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5sZWZ0IC0gaW5zdC5tYXJnaW5zLmxlZnQ7DQoJCQlyID0gbCArIGluc3Quc25hcEVsZW1lbnRzWyBpIF0ud2lkdGg7DQoJCQl0ID0gaW5zdC5zbmFwRWxlbWVudHNbIGkgXS50b3AgLSBpbnN0Lm1hcmdpbnMudG9wOw0KCQkJYiA9IHQgKyBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLmhlaWdodDsNCg0KCQkJaWYgKCB4MiA8IGwgLSBkIHx8IHgxID4gciArIGQgfHwgeTIgPCB0IC0gZCB8fCB5MSA+IGIgKyBkIHx8DQoJCQkJCSEkLmNvbnRhaW5zKCBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLml0ZW0ub3duZXJEb2N1bWVudCwNCgkJCQkJaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5pdGVtICkgKSB7DQoJCQkJaWYgKCBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLnNuYXBwaW5nICkgew0KCQkJCQkoIGluc3Qub3B0aW9ucy5zbmFwLnJlbGVhc2UgJiYNCgkJCQkJCWluc3Qub3B0aW9ucy5zbmFwLnJlbGVhc2UuY2FsbCgNCgkJCQkJCQlpbnN0LmVsZW1lbnQsDQoJCQkJCQkJZXZlbnQsDQoJCQkJCQkJJC5leHRlbmQoIGluc3QuX3VpSGFzaCgpLCB7IHNuYXBJdGVtOiBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLml0ZW0gfSApDQoJCQkJCQkpICk7DQoJCQkJfQ0KCQkJCWluc3Quc25hcEVsZW1lbnRzWyBpIF0uc25hcHBpbmcgPSBmYWxzZTsNCgkJCQljb250aW51ZTsNCgkJCX0NCg0KCQkJaWYgKCBvLnNuYXBNb2RlICE9PSAiaW5uZXIiICkgew0KCQkJCXRzID0gTWF0aC5hYnMoIHQgLSB5MiApIDw9IGQ7DQoJCQkJYnMgPSBNYXRoLmFicyggYiAtIHkxICkgPD0gZDsNCgkJCQlscyA9IE1hdGguYWJzKCBsIC0geDIgKSA8PSBkOw0KCQkJCXJzID0gTWF0aC5hYnMoIHIgLSB4MSApIDw9IGQ7DQoJCQkJaWYgKCB0cyApIHsNCgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsNCgkJCQkJCXRvcDogdCAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LA0KCQkJCQkJbGVmdDogMA0KCQkJCQl9ICkudG9wOw0KCQkJCX0NCgkJCQlpZiAoIGJzICkgew0KCQkJCQl1aS5wb3NpdGlvbi50b3AgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbyggInJlbGF0aXZlIiwgew0KCQkJCQkJdG9wOiBiLA0KCQkJCQkJbGVmdDogMA0KCQkJCQl9ICkudG9wOw0KCQkJCX0NCgkJCQlpZiAoIGxzICkgew0KCQkJCQl1aS5wb3NpdGlvbi5sZWZ0ID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsNCgkJCQkJCXRvcDogMCwNCgkJCQkJCWxlZnQ6IGwgLSBpbnN0LmhlbHBlclByb3BvcnRpb25zLndpZHRoDQoJCQkJCX0gKS5sZWZ0Ow0KCQkJCX0NCgkJCQlpZiAoIHJzICkgew0KCQkJCQl1aS5wb3NpdGlvbi5sZWZ0ID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsNCgkJCQkJCXRvcDogMCwNCgkJCQkJCWxlZnQ6IHINCgkJCQkJfSApLmxlZnQ7DQoJCQkJfQ0KCQkJfQ0KDQoJCQlmaXJzdCA9ICggdHMgfHwgYnMgfHwgbHMgfHwgcnMgKTsNCg0KCQkJaWYgKCBvLnNuYXBNb2RlICE9PSAib3V0ZXIiICkgew0KCQkJCXRzID0gTWF0aC5hYnMoIHQgLSB5MSApIDw9IGQ7DQoJCQkJYnMgPSBNYXRoLmFicyggYiAtIHkyICkgPD0gZDsNCgkJCQlscyA9IE1hdGguYWJzKCBsIC0geDEgKSA8PSBkOw0KCQkJCXJzID0gTWF0aC5hYnMoIHIgLSB4MiApIDw9IGQ7DQoJCQkJaWYgKCB0cyApIHsNCgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsNCgkJCQkJCXRvcDogdCwNCgkJCQkJCWxlZnQ6IDANCgkJCQkJfSApLnRvcDsNCgkJCQl9DQoJCQkJaWYgKCBicyApIHsNCgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsNCgkJCQkJCXRvcDogYiAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LA0KCQkJCQkJbGVmdDogMA0KCQkJCQl9ICkudG9wOw0KCQkJCX0NCgkJCQlpZiAoIGxzICkgew0KCQkJCQl1aS5wb3NpdGlvbi5sZWZ0ID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsNCgkJCQkJCXRvcDogMCwNCgkJCQkJCWxlZnQ6IGwNCgkJCQkJfSApLmxlZnQ7DQoJCQkJfQ0KCQkJCWlmICggcnMgKSB7DQoJCQkJCXVpLnBvc2l0aW9uLmxlZnQgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbyggInJlbGF0aXZlIiwgew0KCQkJCQkJdG9wOiAwLA0KCQkJCQkJbGVmdDogciAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgNCgkJCQkJfSApLmxlZnQ7DQoJCQkJfQ0KCQkJfQ0KDQoJCQlpZiAoICFpbnN0LnNuYXBFbGVtZW50c1sgaSBdLnNuYXBwaW5nICYmICggdHMgfHwgYnMgfHwgbHMgfHwgcnMgfHwgZmlyc3QgKSApIHsNCgkJCQkoIGluc3Qub3B0aW9ucy5zbmFwLnNuYXAgJiYNCgkJCQkJaW5zdC5vcHRpb25zLnNuYXAuc25hcC5jYWxsKA0KCQkJCQkJaW5zdC5lbGVtZW50LA0KCQkJCQkJZXZlbnQsDQoJCQkJCQkkLmV4dGVuZCggaW5zdC5fdWlIYXNoKCksIHsNCgkJCQkJCQlzbmFwSXRlbTogaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5pdGVtDQoJCQkJCQl9ICkgKSApOw0KCQkJfQ0KCQkJaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5zbmFwcGluZyA9ICggdHMgfHwgYnMgfHwgbHMgfHwgcnMgfHwgZmlyc3QgKTsNCg0KCQl9DQoNCgl9DQp9ICk7DQoNCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJzdGFjayIsIHsNCglzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaW5zdGFuY2UgKSB7DQoJCXZhciBtaW4sDQoJCQlvID0gaW5zdGFuY2Uub3B0aW9ucywNCgkJCWdyb3VwID0gJC5tYWtlQXJyYXkoICQoIG8uc3RhY2sgKSApLnNvcnQoIGZ1bmN0aW9uKCBhLCBiICkgew0KCQkJCXJldHVybiAoIHBhcnNlSW50KCAkKCBhICkuY3NzKCAiekluZGV4IiApLCAxMCApIHx8IDAgKSAtDQoJCQkJCSggcGFyc2VJbnQoICQoIGIgKS5jc3MoICJ6SW5kZXgiICksIDEwICkgfHwgMCApOw0KCQkJfSApOw0KDQoJCWlmICggIWdyb3VwLmxlbmd0aCApIHsgcmV0dXJuOyB9DQoNCgkJbWluID0gcGFyc2VJbnQoICQoIGdyb3VwWyAwIF0gKS5jc3MoICJ6SW5kZXgiICksIDEwICkgfHwgMDsNCgkJJCggZ3JvdXAgKS5lYWNoKCBmdW5jdGlvbiggaSApIHsNCgkJCSQoIHRoaXMgKS5jc3MoICJ6SW5kZXgiLCBtaW4gKyBpICk7DQoJCX0gKTsNCgkJdGhpcy5jc3MoICJ6SW5kZXgiLCAoIG1pbiArIGdyb3VwLmxlbmd0aCApICk7DQoJfQ0KfSApOw0KDQokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAiekluZGV4Iiwgew0KCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsNCgkJdmFyIHQgPSAkKCB1aS5oZWxwZXIgKSwNCgkJCW8gPSBpbnN0YW5jZS5vcHRpb25zOw0KDQoJCWlmICggdC5jc3MoICJ6SW5kZXgiICkgKSB7DQoJCQlvLl96SW5kZXggPSB0LmNzcyggInpJbmRleCIgKTsNCgkJfQ0KCQl0LmNzcyggInpJbmRleCIsIG8uekluZGV4ICk7DQoJfSwNCglzdG9wOiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsNCgkJdmFyIG8gPSBpbnN0YW5jZS5vcHRpb25zOw0KDQoJCWlmICggby5fekluZGV4ICkgew0KCQkJJCggdWkuaGVscGVyICkuY3NzKCAiekluZGV4Iiwgby5fekluZGV4ICk7DQoJCX0NCgl9DQp9ICk7DQoNCnZhciB3aWRnZXRzRHJhZ2dhYmxlID0gJC51aS5kcmFnZ2FibGU7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgUmVzaXphYmxlIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBSZXNpemFibGUNCi8vPj5ncm91cDogSW50ZXJhY3Rpb25zDQovLz4+ZGVzY3JpcHRpb246IEVuYWJsZXMgcmVzaXplIGZ1bmN0aW9uYWxpdHkgZm9yIGFueSBlbGVtZW50Lg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3Jlc2l6YWJsZS8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9yZXNpemFibGUvDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MNCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9yZXNpemFibGUuY3NzDQovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MNCg0KDQoNCiQud2lkZ2V0KCAidWkucmVzaXphYmxlIiwgJC51aS5tb3VzZSwgew0KCXZlcnNpb246ICIxLjEyLjEiLA0KCXdpZGdldEV2ZW50UHJlZml4OiAicmVzaXplIiwNCglvcHRpb25zOiB7DQoJCWFsc29SZXNpemU6IGZhbHNlLA0KCQlhbmltYXRlOiBmYWxzZSwNCgkJYW5pbWF0ZUR1cmF0aW9uOiAic2xvdyIsDQoJCWFuaW1hdGVFYXNpbmc6ICJzd2luZyIsDQoJCWFzcGVjdFJhdGlvOiBmYWxzZSwNCgkJYXV0b0hpZGU6IGZhbHNlLA0KCQljbGFzc2VzOiB7DQoJCQkidWktcmVzaXphYmxlLXNlIjogInVpLWljb24gdWktaWNvbi1ncmlwc21hbGwtZGlhZ29uYWwtc2UiDQoJCX0sDQoJCWNvbnRhaW5tZW50OiBmYWxzZSwNCgkJZ2hvc3Q6IGZhbHNlLA0KCQlncmlkOiBmYWxzZSwNCgkJaGFuZGxlczogImUscyxzZSIsDQoJCWhlbHBlcjogZmFsc2UsDQoJCW1heEhlaWdodDogbnVsbCwNCgkJbWF4V2lkdGg6IG51bGwsDQoJCW1pbkhlaWdodDogMTAsDQoJCW1pbldpZHRoOiAxMCwNCg0KCQkvLyBTZWUgIzc5NjANCgkJekluZGV4OiA5MCwNCg0KCQkvLyBDYWxsYmFja3MNCgkJcmVzaXplOiBudWxsLA0KCQlzdGFydDogbnVsbCwNCgkJc3RvcDogbnVsbA0KCX0sDQoNCglfbnVtOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCXJldHVybiBwYXJzZUZsb2F0KCB2YWx1ZSApIHx8IDA7DQoJfSwNCg0KCV9pc051bWJlcjogZnVuY3Rpb24oIHZhbHVlICkgew0KCQlyZXR1cm4gIWlzTmFOKCBwYXJzZUZsb2F0KCB2YWx1ZSApICk7DQoJfSwNCg0KCV9oYXNTY3JvbGw6IGZ1bmN0aW9uKCBlbCwgYSApIHsNCg0KCQlpZiAoICQoIGVsICkuY3NzKCAib3ZlcmZsb3ciICkgPT09ICJoaWRkZW4iICkgew0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoNCgkJdmFyIHNjcm9sbCA9ICggYSAmJiBhID09PSAibGVmdCIgKSA\/ICJzY3JvbGxMZWZ0IiA6ICJzY3JvbGxUb3AiLA0KCQkJaGFzID0gZmFsc2U7DQoNCgkJaWYgKCBlbFsgc2Nyb2xsIF0gPiAwICkgew0KCQkJcmV0dXJuIHRydWU7DQoJCX0NCg0KCQkvLyBUT0RPOiBkZXRlcm1pbmUgd2hpY2ggY2FzZXMgYWN0dWFsbHkgY2F1c2UgdGhpcyB0byBoYXBwZW4NCgkJLy8gaWYgdGhlIGVsZW1lbnQgZG9lc24ndCBoYXZlIHRoZSBzY3JvbGwgc2V0LCBzZWUgaWYgaXQncyBwb3NzaWJsZSB0bw0KCQkvLyBzZXQgdGhlIHNjcm9sbA0KCQllbFsgc2Nyb2xsIF0gPSAxOw0KCQloYXMgPSAoIGVsWyBzY3JvbGwgXSA+IDAgKTsNCgkJZWxbIHNjcm9sbCBdID0gMDsNCgkJcmV0dXJuIGhhczsNCgl9LA0KDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoNCgkJdmFyIG1hcmdpbnMsDQoJCQlvID0gdGhpcy5vcHRpb25zLA0KCQkJdGhhdCA9IHRoaXM7DQoJCXRoaXMuX2FkZENsYXNzKCAidWktcmVzaXphYmxlIiApOw0KDQoJCSQuZXh0ZW5kKCB0aGlzLCB7DQoJCQlfYXNwZWN0UmF0aW86ICEhKCBvLmFzcGVjdFJhdGlvICksDQoJCQlhc3BlY3RSYXRpbzogby5hc3BlY3RSYXRpbywNCgkJCW9yaWdpbmFsRWxlbWVudDogdGhpcy5lbGVtZW50LA0KCQkJX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHM6IFtdLA0KCQkJX2hlbHBlcjogby5oZWxwZXIgfHwgby5naG9zdCB8fCBvLmFuaW1hdGUgPyBvLmhlbHBlciB8fCAidWktcmVzaXphYmxlLWhlbHBlciIgOiBudWxsDQoJCX0gKTsNCg0KCQkvLyBXcmFwIHRoZSBlbGVtZW50IGlmIGl0IGNhbm5vdCBob2xkIGNoaWxkIG5vZGVzDQoJCWlmICggdGhpcy5lbGVtZW50WyAwIF0ubm9kZU5hbWUubWF0Y2goIC9eKGNhbnZhc3x0ZXh0YXJlYXxpbnB1dHxzZWxlY3R8YnV0dG9ufGltZykkL2kgKSApIHsNCg0KCQkJdGhpcy5lbGVtZW50LndyYXAoDQoJCQkJJCggIjxkaXYgY2xhc3M9J3VpLXdyYXBwZXInIHN0eWxlPSdvdmVyZmxvdzogaGlkZGVuOyc+PC9kaXY+IiApLmNzcyggew0KCQkJCQlwb3NpdGlvbjogdGhpcy5lbGVtZW50LmNzcyggInBvc2l0aW9uIiApLA0KCQkJCQl3aWR0aDogdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKSwNCgkJCQkJaGVpZ2h0OiB0aGlzLmVsZW1lbnQub3V0ZXJIZWlnaHQoKSwNCgkJCQkJdG9wOiB0aGlzLmVsZW1lbnQuY3NzKCAidG9wIiApLA0KCQkJCQlsZWZ0OiB0aGlzLmVsZW1lbnQuY3NzKCAibGVmdCIgKQ0KCQkJCX0gKQ0KCQkJKTsNCg0KCQkJdGhpcy5lbGVtZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpLmRhdGEoDQoJCQkJInVpLXJlc2l6YWJsZSIsIHRoaXMuZWxlbWVudC5yZXNpemFibGUoICJpbnN0YW5jZSIgKQ0KCQkJKTsNCg0KCQkJdGhpcy5lbGVtZW50SXNXcmFwcGVyID0gdHJ1ZTsNCg0KCQkJbWFyZ2lucyA9IHsNCgkJCQltYXJnaW5Ub3A6IHRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggIm1hcmdpblRvcCIgKSwNCgkJCQltYXJnaW5SaWdodDogdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAibWFyZ2luUmlnaHQiICksDQoJCQkJbWFyZ2luQm90dG9tOiB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoICJtYXJnaW5Cb3R0b20iICksDQoJCQkJbWFyZ2luTGVmdDogdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAibWFyZ2luTGVmdCIgKQ0KCQkJfTsNCg0KCQkJdGhpcy5lbGVtZW50LmNzcyggbWFyZ2lucyApOw0KCQkJdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAibWFyZ2luIiwgMCApOw0KDQoJCQkvLyBzdXBwb3J0OiBTYWZhcmkNCgkJCS8vIFByZXZlbnQgU2FmYXJpIHRleHRhcmVhIHJlc2l6ZQ0KCQkJdGhpcy5vcmlnaW5hbFJlc2l6ZVN0eWxlID0gdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAicmVzaXplIiApOw0KCQkJdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAicmVzaXplIiwgIm5vbmUiICk7DQoNCgkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMucHVzaCggdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCB7DQoJCQkJcG9zaXRpb246ICJzdGF0aWMiLA0KCQkJCXpvb206IDEsDQoJCQkJZGlzcGxheTogImJsb2NrIg0KCQkJfSApICk7DQoNCgkJCS8vIFN1cHBvcnQ6IElFOQ0KCQkJLy8gYXZvaWQgSUUganVtcCAoaGFyZCBzZXQgdGhlIG1hcmdpbikNCgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggbWFyZ2lucyApOw0KDQoJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOw0KCQl9DQoNCgkJdGhpcy5fc2V0dXBIYW5kbGVzKCk7DQoNCgkJaWYgKCBvLmF1dG9IaWRlICkgew0KCQkJJCggdGhpcy5lbGVtZW50ICkNCgkJCQkub24oICJtb3VzZWVudGVyIiwgZnVuY3Rpb24oKSB7DQoJCQkJCWlmICggby5kaXNhYmxlZCApIHsNCgkJCQkJCXJldHVybjsNCgkJCQkJfQ0KCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggInVpLXJlc2l6YWJsZS1hdXRvaGlkZSIgKTsNCgkJCQkJdGhhdC5faGFuZGxlcy5zaG93KCk7DQoJCQkJfSApDQoJCQkJLm9uKCAibW91c2VsZWF2ZSIsIGZ1bmN0aW9uKCkgew0KCQkJCQlpZiAoIG8uZGlzYWJsZWQgKSB7DQoJCQkJCQlyZXR1cm47DQoJCQkJCX0NCgkJCQkJaWYgKCAhdGhhdC5yZXNpemluZyApIHsNCgkJCQkJCXRoYXQuX2FkZENsYXNzKCAidWktcmVzaXphYmxlLWF1dG9oaWRlIiApOw0KCQkJCQkJdGhhdC5faGFuZGxlcy5oaWRlKCk7DQoJCQkJCX0NCgkJCQl9ICk7DQoJCX0NCg0KCQl0aGlzLl9tb3VzZUluaXQoKTsNCgl9LA0KDQoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgew0KDQoJCXRoaXMuX21vdXNlRGVzdHJveSgpOw0KDQoJCXZhciB3cmFwcGVyLA0KCQkJX2Rlc3Ryb3kgPSBmdW5jdGlvbiggZXhwICkgew0KCQkJCSQoIGV4cCApDQoJCQkJCS5yZW1vdmVEYXRhKCAicmVzaXphYmxlIiApDQoJCQkJCS5yZW1vdmVEYXRhKCAidWktcmVzaXphYmxlIiApDQoJCQkJCS5vZmYoICIucmVzaXphYmxlIiApDQoJCQkJCS5maW5kKCAiLnVpLXJlc2l6YWJsZS1oYW5kbGUiICkNCgkJCQkJCS5yZW1vdmUoKTsNCgkJCX07DQoNCgkJLy8gVE9ETzogVW53cmFwIGF0IHNhbWUgRE9NIHBvc2l0aW9uDQoJCWlmICggdGhpcy5lbGVtZW50SXNXcmFwcGVyICkgew0KCQkJX2Rlc3Ryb3koIHRoaXMuZWxlbWVudCApOw0KCQkJd3JhcHBlciA9IHRoaXMuZWxlbWVudDsNCgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggew0KCQkJCXBvc2l0aW9uOiB3cmFwcGVyLmNzcyggInBvc2l0aW9uIiApLA0KCQkJCXdpZHRoOiB3cmFwcGVyLm91dGVyV2lkdGgoKSwNCgkJCQloZWlnaHQ6IHdyYXBwZXIub3V0ZXJIZWlnaHQoKSwNCgkJCQl0b3A6IHdyYXBwZXIuY3NzKCAidG9wIiApLA0KCQkJCWxlZnQ6IHdyYXBwZXIuY3NzKCAibGVmdCIgKQ0KCQkJfSApLmluc2VydEFmdGVyKCB3cmFwcGVyICk7DQoJCQl3cmFwcGVyLnJlbW92ZSgpOw0KCQl9DQoNCgkJdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAicmVzaXplIiwgdGhpcy5vcmlnaW5hbFJlc2l6ZVN0eWxlICk7DQoJCV9kZXN0cm95KCB0aGlzLm9yaWdpbmFsRWxlbWVudCApOw0KDQoJCXJldHVybiB0aGlzOw0KCX0sDQoNCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsNCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsNCg0KCQlzd2l0Y2ggKCBrZXkgKSB7DQoJCWNhc2UgImhhbmRsZXMiOg0KCQkJdGhpcy5fcmVtb3ZlSGFuZGxlcygpOw0KCQkJdGhpcy5fc2V0dXBIYW5kbGVzKCk7DQoJCQlicmVhazsNCgkJZGVmYXVsdDoNCgkJCWJyZWFrOw0KCQl9DQoJfSwNCg0KCV9zZXR1cEhhbmRsZXM6IGZ1bmN0aW9uKCkgew0KCQl2YXIgbyA9IHRoaXMub3B0aW9ucywgaGFuZGxlLCBpLCBuLCBobmFtZSwgYXhpcywgdGhhdCA9IHRoaXM7DQoJCXRoaXMuaGFuZGxlcyA9IG8uaGFuZGxlcyB8fA0KCQkJKCAhJCggIi51aS1yZXNpemFibGUtaGFuZGxlIiwgdGhpcy5lbGVtZW50ICkubGVuZ3RoID8NCgkJCQkiZSxzLHNlIiA6IHsNCgkJCQkJbjogIi51aS1yZXNpemFibGUtbiIsDQoJCQkJCWU6ICIudWktcmVzaXphYmxlLWUiLA0KCQkJCQlzOiAiLnVpLXJlc2l6YWJsZS1zIiwNCgkJCQkJdzogIi51aS1yZXNpemFibGUtdyIsDQoJCQkJCXNlOiAiLnVpLXJlc2l6YWJsZS1zZSIsDQoJCQkJCXN3OiAiLnVpLXJlc2l6YWJsZS1zdyIsDQoJCQkJCW5lOiAiLnVpLXJlc2l6YWJsZS1uZSIsDQoJCQkJCW53OiAiLnVpLXJlc2l6YWJsZS1udyINCgkJCQl9ICk7DQoNCgkJdGhpcy5faGFuZGxlcyA9ICQoKTsNCgkJaWYgKCB0aGlzLmhhbmRsZXMuY29uc3RydWN0b3IgPT09IFN0cmluZyApIHsNCg0KCQkJaWYgKCB0aGlzLmhhbmRsZXMgPT09ICJhbGwiICkgew0KCQkJCXRoaXMuaGFuZGxlcyA9ICJuLGUscyx3LHNlLHN3LG5lLG53IjsNCgkJCX0NCg0KCQkJbiA9IHRoaXMuaGFuZGxlcy5zcGxpdCggIiwiICk7DQoJCQl0aGlzLmhhbmRsZXMgPSB7fTsNCg0KCQkJZm9yICggaSA9IDA7IGkgPCBuLmxlbmd0aDsgaSsrICkgew0KDQoJCQkJaGFuZGxlID0gJC50cmltKCBuWyBpIF0gKTsNCgkJCQlobmFtZSA9ICJ1aS1yZXNpemFibGUtIiArIGhhbmRsZTsNCgkJCQlheGlzID0gJCggIjxkaXY+IiApOw0KCQkJCXRoaXMuX2FkZENsYXNzKCBheGlzLCAidWktcmVzaXphYmxlLWhhbmRsZSAiICsgaG5hbWUgKTsNCg0KCQkJCWF4aXMuY3NzKCB7IHpJbmRleDogby56SW5kZXggfSApOw0KDQoJCQkJdGhpcy5oYW5kbGVzWyBoYW5kbGUgXSA9ICIudWktcmVzaXphYmxlLSIgKyBoYW5kbGU7DQoJCQkJdGhpcy5lbGVtZW50LmFwcGVuZCggYXhpcyApOw0KCQkJfQ0KDQoJCX0NCg0KCQl0aGlzLl9yZW5kZXJBeGlzID0gZnVuY3Rpb24oIHRhcmdldCApIHsNCg0KCQkJdmFyIGksIGF4aXMsIHBhZFBvcywgcGFkV3JhcHBlcjsNCg0KCQkJdGFyZ2V0ID0gdGFyZ2V0IHx8IHRoaXMuZWxlbWVudDsNCg0KCQkJZm9yICggaSBpbiB0aGlzLmhhbmRsZXMgKSB7DQoNCgkJCQlpZiAoIHRoaXMuaGFuZGxlc1sgaSBdLmNvbnN0cnVjdG9yID09PSBTdHJpbmcgKSB7DQoJCQkJCXRoaXMuaGFuZGxlc1sgaSBdID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCB0aGlzLmhhbmRsZXNbIGkgXSApLmZpcnN0KCkuc2hvdygpOw0KCQkJCX0gZWxzZSBpZiAoIHRoaXMuaGFuZGxlc1sgaSBdLmpxdWVyeSB8fCB0aGlzLmhhbmRsZXNbIGkgXS5ub2RlVHlwZSApIHsNCgkJCQkJdGhpcy5oYW5kbGVzWyBpIF0gPSAkKCB0aGlzLmhhbmRsZXNbIGkgXSApOw0KCQkJCQl0aGlzLl9vbiggdGhpcy5oYW5kbGVzWyBpIF0sIHsgIm1vdXNlZG93biI6IHRoYXQuX21vdXNlRG93biB9ICk7DQoJCQkJfQ0KDQoJCQkJaWYgKCB0aGlzLmVsZW1lbnRJc1dyYXBwZXIgJiYNCgkJCQkJCXRoaXMub3JpZ2luYWxFbGVtZW50WyAwIF0NCgkJCQkJCQkubm9kZU5hbWUNCgkJCQkJCQkubWF0Y2goIC9eKHRleHRhcmVhfGlucHV0fHNlbGVjdHxidXR0b24pJC9pICkgKSB7DQoJCQkJCWF4aXMgPSAkKCB0aGlzLmhhbmRsZXNbIGkgXSwgdGhpcy5lbGVtZW50ICk7DQoNCgkJCQkJcGFkV3JhcHBlciA9IC9zd3xuZXxud3xzZXxufHMvLnRlc3QoIGkgKSA\/DQoJCQkJCQlheGlzLm91dGVySGVpZ2h0KCkgOg0KCQkJCQkJYXhpcy5vdXRlcldpZHRoKCk7DQoNCgkJCQkJcGFkUG9zID0gWyAicGFkZGluZyIsDQoJCQkJCQkvbmV8bnd8bi8udGVzdCggaSApID8gIlRvcCIgOg0KCQkJCQkJL3NlfHN3fHMvLnRlc3QoIGkgKSA\/ICJCb3R0b20iIDoNCgkJCQkJCS9eZSQvLnRlc3QoIGkgKSA\/ICJSaWdodCIgOiAiTGVmdCIgXS5qb2luKCAiIiApOw0KDQoJCQkJCXRhcmdldC5jc3MoIHBhZFBvcywgcGFkV3JhcHBlciApOw0KDQoJCQkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplKCk7DQoJCQkJfQ0KDQoJCQkJdGhpcy5faGFuZGxlcyA9IHRoaXMuX2hhbmRsZXMuYWRkKCB0aGlzLmhhbmRsZXNbIGkgXSApOw0KCQkJfQ0KCQl9Ow0KDQoJCS8vIFRPRE86IG1ha2UgcmVuZGVyQXhpcyBhIHByb3RvdHlwZSBmdW5jdGlvbg0KCQl0aGlzLl9yZW5kZXJBeGlzKCB0aGlzLmVsZW1lbnQgKTsNCg0KCQl0aGlzLl9oYW5kbGVzID0gdGhpcy5faGFuZGxlcy5hZGQoIHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXJlc2l6YWJsZS1oYW5kbGUiICkgKTsNCgkJdGhpcy5faGFuZGxlcy5kaXNhYmxlU2VsZWN0aW9uKCk7DQoNCgkJdGhpcy5faGFuZGxlcy5vbiggIm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCkgew0KCQkJaWYgKCAhdGhhdC5yZXNpemluZyApIHsNCgkJCQlpZiAoIHRoaXMuY2xhc3NOYW1lICkgew0KCQkJCQlheGlzID0gdGhpcy5jbGFzc05hbWUubWF0Y2goIC91aS1yZXNpemFibGUtKHNlfHN3fG5lfG53fG58ZXxzfHcpL2kgKTsNCgkJCQl9DQoJCQkJdGhhdC5heGlzID0gYXhpcyAmJiBheGlzWyAxIF0gPyBheGlzWyAxIF0gOiAic2UiOw0KCQkJfQ0KCQl9ICk7DQoNCgkJaWYgKCBvLmF1dG9IaWRlICkgew0KCQkJdGhpcy5faGFuZGxlcy5oaWRlKCk7DQoJCQl0aGlzLl9hZGRDbGFzcyggInVpLXJlc2l6YWJsZS1hdXRvaGlkZSIgKTsNCgkJfQ0KCX0sDQoNCglfcmVtb3ZlSGFuZGxlczogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX2hhbmRsZXMucmVtb3ZlKCk7DQoJfSwNCg0KCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIGksIGhhbmRsZSwNCgkJCWNhcHR1cmUgPSBmYWxzZTsNCg0KCQlmb3IgKCBpIGluIHRoaXMuaGFuZGxlcyApIHsNCgkJCWhhbmRsZSA9ICQoIHRoaXMuaGFuZGxlc1sgaSBdIClbIDAgXTsNCgkJCWlmICggaGFuZGxlID09PSBldmVudC50YXJnZXQgfHwgJC5jb250YWlucyggaGFuZGxlLCBldmVudC50YXJnZXQgKSApIHsNCgkJCQljYXB0dXJlID0gdHJ1ZTsNCgkJCX0NCgkJfQ0KDQoJCXJldHVybiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICYmIGNhcHR1cmU7DQoJfSwNCg0KCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJdmFyIGN1cmxlZnQsIGN1cnRvcCwgY3Vyc29yLA0KCQkJbyA9IHRoaXMub3B0aW9ucywNCgkJCWVsID0gdGhpcy5lbGVtZW50Ow0KDQoJCXRoaXMucmVzaXppbmcgPSB0cnVlOw0KDQoJCXRoaXMuX3JlbmRlclByb3h5KCk7DQoNCgkJY3VybGVmdCA9IHRoaXMuX251bSggdGhpcy5oZWxwZXIuY3NzKCAibGVmdCIgKSApOw0KCQljdXJ0b3AgPSB0aGlzLl9udW0oIHRoaXMuaGVscGVyLmNzcyggInRvcCIgKSApOw0KDQoJCWlmICggby5jb250YWlubWVudCApIHsNCgkJCWN1cmxlZnQgKz0gJCggby5jb250YWlubWVudCApLnNjcm9sbExlZnQoKSB8fCAwOw0KCQkJY3VydG9wICs9ICQoIG8uY29udGFpbm1lbnQgKS5zY3JvbGxUb3AoKSB8fCAwOw0KCQl9DQoNCgkJdGhpcy5vZmZzZXQgPSB0aGlzLmhlbHBlci5vZmZzZXQoKTsNCgkJdGhpcy5wb3NpdGlvbiA9IHsgbGVmdDogY3VybGVmdCwgdG9wOiBjdXJ0b3AgfTsNCg0KCQl0aGlzLnNpemUgPSB0aGlzLl9oZWxwZXIgPyB7DQoJCQkJd2lkdGg6IHRoaXMuaGVscGVyLndpZHRoKCksDQoJCQkJaGVpZ2h0OiB0aGlzLmhlbHBlci5oZWlnaHQoKQ0KCQkJfSA6IHsNCgkJCQl3aWR0aDogZWwud2lkdGgoKSwNCgkJCQloZWlnaHQ6IGVsLmhlaWdodCgpDQoJCQl9Ow0KDQoJCXRoaXMub3JpZ2luYWxTaXplID0gdGhpcy5faGVscGVyID8gew0KCQkJCXdpZHRoOiBlbC5vdXRlcldpZHRoKCksDQoJCQkJaGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpDQoJCQl9IDogew0KCQkJCXdpZHRoOiBlbC53aWR0aCgpLA0KCQkJCWhlaWdodDogZWwuaGVpZ2h0KCkNCgkJCX07DQoNCgkJdGhpcy5zaXplRGlmZiA9IHsNCgkJCXdpZHRoOiBlbC5vdXRlcldpZHRoKCkgLSBlbC53aWR0aCgpLA0KCQkJaGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpIC0gZWwuaGVpZ2h0KCkNCgkJfTsNCg0KCQl0aGlzLm9yaWdpbmFsUG9zaXRpb24gPSB7IGxlZnQ6IGN1cmxlZnQsIHRvcDogY3VydG9wIH07DQoJCXRoaXMub3JpZ2luYWxNb3VzZVBvc2l0aW9uID0geyBsZWZ0OiBldmVudC5wYWdlWCwgdG9wOiBldmVudC5wYWdlWSB9Ow0KDQoJCXRoaXMuYXNwZWN0UmF0aW8gPSAoIHR5cGVvZiBvLmFzcGVjdFJhdGlvID09PSAibnVtYmVyIiApID8NCgkJCW8uYXNwZWN0UmF0aW8gOg0KCQkJKCAoIHRoaXMub3JpZ2luYWxTaXplLndpZHRoIC8gdGhpcy5vcmlnaW5hbFNpemUuaGVpZ2h0ICkgfHwgMSApOw0KDQoJCWN1cnNvciA9ICQoICIudWktcmVzaXphYmxlLSIgKyB0aGlzLmF4aXMgKS5jc3MoICJjdXJzb3IiICk7DQoJCSQoICJib2R5IiApLmNzcyggImN1cnNvciIsIGN1cnNvciA9PT0gImF1dG8iID8gdGhpcy5heGlzICsgIi1yZXNpemUiIDogY3Vyc29yICk7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1yZXNpemFibGUtcmVzaXppbmciICk7DQoJCXRoaXMuX3Byb3BhZ2F0ZSggInN0YXJ0IiwgZXZlbnQgKTsNCgkJcmV0dXJuIHRydWU7DQoJfSwNCg0KCV9tb3VzZURyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQl2YXIgZGF0YSwgcHJvcHMsDQoJCQlzbXAgPSB0aGlzLm9yaWdpbmFsTW91c2VQb3NpdGlvbiwNCgkJCWEgPSB0aGlzLmF4aXMsDQoJCQlkeCA9ICggZXZlbnQucGFnZVggLSBzbXAubGVmdCApIHx8IDAsDQoJCQlkeSA9ICggZXZlbnQucGFnZVkgLSBzbXAudG9wICkgfHwgMCwNCgkJCXRyaWdnZXIgPSB0aGlzLl9jaGFuZ2VbIGEgXTsNCg0KCQl0aGlzLl91cGRhdGVQcmV2UHJvcGVydGllcygpOw0KDQoJCWlmICggIXRyaWdnZXIgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQlkYXRhID0gdHJpZ2dlci5hcHBseSggdGhpcywgWyBldmVudCwgZHgsIGR5IF0gKTsNCg0KCQl0aGlzLl91cGRhdGVWaXJ0dWFsQm91bmRhcmllcyggZXZlbnQuc2hpZnRLZXkgKTsNCgkJaWYgKCB0aGlzLl9hc3BlY3RSYXRpbyB8fCBldmVudC5zaGlmdEtleSApIHsNCgkJCWRhdGEgPSB0aGlzLl91cGRhdGVSYXRpbyggZGF0YSwgZXZlbnQgKTsNCgkJfQ0KDQoJCWRhdGEgPSB0aGlzLl9yZXNwZWN0U2l6ZSggZGF0YSwgZXZlbnQgKTsNCg0KCQl0aGlzLl91cGRhdGVDYWNoZSggZGF0YSApOw0KDQoJCXRoaXMuX3Byb3BhZ2F0ZSggInJlc2l6ZSIsIGV2ZW50ICk7DQoNCgkJcHJvcHMgPSB0aGlzLl9hcHBseUNoYW5nZXMoKTsNCg0KCQlpZiAoICF0aGlzLl9oZWxwZXIgJiYgdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50cy5sZW5ndGggKSB7DQoJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOw0KCQl9DQoNCgkJaWYgKCAhJC5pc0VtcHR5T2JqZWN0KCBwcm9wcyApICkgew0KCQkJdGhpcy5fdXBkYXRlUHJldlByb3BlcnRpZXMoKTsNCgkJCXRoaXMuX3RyaWdnZXIoICJyZXNpemUiLCBldmVudCwgdGhpcy51aSgpICk7DQoJCQl0aGlzLl9hcHBseUNoYW5nZXMoKTsNCgkJfQ0KDQoJCXJldHVybiBmYWxzZTsNCgl9LA0KDQoJX21vdXNlU3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgew0KDQoJCXRoaXMucmVzaXppbmcgPSBmYWxzZTsNCgkJdmFyIHByLCBpc3RhLCBzb2Zmc2V0aCwgc29mZnNldHcsIHMsIGxlZnQsIHRvcCwNCgkJCW8gPSB0aGlzLm9wdGlvbnMsIHRoYXQgPSB0aGlzOw0KDQoJCWlmICggdGhpcy5faGVscGVyICkgew0KDQoJCQlwciA9IHRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHM7DQoJCQlpc3RhID0gcHIubGVuZ3RoICYmICggL3RleHRhcmVhL2kgKS50ZXN0KCBwclsgMCBdLm5vZGVOYW1lICk7DQoJCQlzb2Zmc2V0aCA9IGlzdGEgJiYgdGhpcy5faGFzU2Nyb2xsKCBwclsgMCBdLCAibGVmdCIgKSA\/IDAgOiB0aGF0LnNpemVEaWZmLmhlaWdodDsNCgkJCXNvZmZzZXR3ID0gaXN0YSA\/IDAgOiB0aGF0LnNpemVEaWZmLndpZHRoOw0KDQoJCQlzID0gew0KCQkJCXdpZHRoOiAoIHRoYXQuaGVscGVyLndpZHRoKCkgIC0gc29mZnNldHcgKSwNCgkJCQloZWlnaHQ6ICggdGhhdC5oZWxwZXIuaGVpZ2h0KCkgLSBzb2Zmc2V0aCApDQoJCQl9Ow0KCQkJbGVmdCA9ICggcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggImxlZnQiICkgKSArDQoJCQkJKCB0aGF0LnBvc2l0aW9uLmxlZnQgLSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24ubGVmdCApICkgfHwgbnVsbDsNCgkJCXRvcCA9ICggcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggInRvcCIgKSApICsNCgkJCQkoIHRoYXQucG9zaXRpb24udG9wIC0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLnRvcCApICkgfHwgbnVsbDsNCg0KCQkJaWYgKCAhby5hbmltYXRlICkgew0KCQkJCXRoaXMuZWxlbWVudC5jc3MoICQuZXh0ZW5kKCBzLCB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH0gKSApOw0KCQkJfQ0KDQoJCQl0aGF0LmhlbHBlci5oZWlnaHQoIHRoYXQuc2l6ZS5oZWlnaHQgKTsNCgkJCXRoYXQuaGVscGVyLndpZHRoKCB0aGF0LnNpemUud2lkdGggKTsNCg0KCQkJaWYgKCB0aGlzLl9oZWxwZXIgJiYgIW8uYW5pbWF0ZSApIHsNCgkJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOw0KCQkJfQ0KCQl9DQoNCgkJJCggImJvZHkiICkuY3NzKCAiY3Vyc29yIiwgImF1dG8iICk7DQoNCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1yZXNpemFibGUtcmVzaXppbmciICk7DQoNCgkJdGhpcy5fcHJvcGFnYXRlKCAic3RvcCIsIGV2ZW50ICk7DQoNCgkJaWYgKCB0aGlzLl9oZWxwZXIgKSB7DQoJCQl0aGlzLmhlbHBlci5yZW1vdmUoKTsNCgkJfQ0KDQoJCXJldHVybiBmYWxzZTsNCg0KCX0sDQoNCglfdXBkYXRlUHJldlByb3BlcnRpZXM6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLnByZXZQb3NpdGlvbiA9IHsNCgkJCXRvcDogdGhpcy5wb3NpdGlvbi50b3AsDQoJCQlsZWZ0OiB0aGlzLnBvc2l0aW9uLmxlZnQNCgkJfTsNCgkJdGhpcy5wcmV2U2l6ZSA9IHsNCgkJCXdpZHRoOiB0aGlzLnNpemUud2lkdGgsDQoJCQloZWlnaHQ6IHRoaXMuc2l6ZS5oZWlnaHQNCgkJfTsNCgl9LA0KDQoJX2FwcGx5Q2hhbmdlczogZnVuY3Rpb24oKSB7DQoJCXZhciBwcm9wcyA9IHt9Ow0KDQoJCWlmICggdGhpcy5wb3NpdGlvbi50b3AgIT09IHRoaXMucHJldlBvc2l0aW9uLnRvcCApIHsNCgkJCXByb3BzLnRvcCA9IHRoaXMucG9zaXRpb24udG9wICsgInB4IjsNCgkJfQ0KCQlpZiAoIHRoaXMucG9zaXRpb24ubGVmdCAhPT0gdGhpcy5wcmV2UG9zaXRpb24ubGVmdCApIHsNCgkJCXByb3BzLmxlZnQgPSB0aGlzLnBvc2l0aW9uLmxlZnQgKyAicHgiOw0KCQl9DQoJCWlmICggdGhpcy5zaXplLndpZHRoICE9PSB0aGlzLnByZXZTaXplLndpZHRoICkgew0KCQkJcHJvcHMud2lkdGggPSB0aGlzLnNpemUud2lkdGggKyAicHgiOw0KCQl9DQoJCWlmICggdGhpcy5zaXplLmhlaWdodCAhPT0gdGhpcy5wcmV2U2l6ZS5oZWlnaHQgKSB7DQoJCQlwcm9wcy5oZWlnaHQgPSB0aGlzLnNpemUuaGVpZ2h0ICsgInB4IjsNCgkJfQ0KDQoJCXRoaXMuaGVscGVyLmNzcyggcHJvcHMgKTsNCg0KCQlyZXR1cm4gcHJvcHM7DQoJfSwNCg0KCV91cGRhdGVWaXJ0dWFsQm91bmRhcmllczogZnVuY3Rpb24oIGZvcmNlQXNwZWN0UmF0aW8gKSB7DQoJCXZhciBwTWluV2lkdGgsIHBNYXhXaWR0aCwgcE1pbkhlaWdodCwgcE1heEhlaWdodCwgYiwNCgkJCW8gPSB0aGlzLm9wdGlvbnM7DQoNCgkJYiA9IHsNCgkJCW1pbldpZHRoOiB0aGlzLl9pc051bWJlciggby5taW5XaWR0aCApID8gby5taW5XaWR0aCA6IDAsDQoJCQltYXhXaWR0aDogdGhpcy5faXNOdW1iZXIoIG8ubWF4V2lkdGggKSA\/IG8ubWF4V2lkdGggOiBJbmZpbml0eSwNCgkJCW1pbkhlaWdodDogdGhpcy5faXNOdW1iZXIoIG8ubWluSGVpZ2h0ICkgPyBvLm1pbkhlaWdodCA6IDAsDQoJCQltYXhIZWlnaHQ6IHRoaXMuX2lzTnVtYmVyKCBvLm1heEhlaWdodCApID8gby5tYXhIZWlnaHQgOiBJbmZpbml0eQ0KCQl9Ow0KDQoJCWlmICggdGhpcy5fYXNwZWN0UmF0aW8gfHwgZm9yY2VBc3BlY3RSYXRpbyApIHsNCgkJCXBNaW5XaWR0aCA9IGIubWluSGVpZ2h0ICogdGhpcy5hc3BlY3RSYXRpbzsNCgkJCXBNaW5IZWlnaHQgPSBiLm1pbldpZHRoIC8gdGhpcy5hc3BlY3RSYXRpbzsNCgkJCXBNYXhXaWR0aCA9IGIubWF4SGVpZ2h0ICogdGhpcy5hc3BlY3RSYXRpbzsNCgkJCXBNYXhIZWlnaHQgPSBiLm1heFdpZHRoIC8gdGhpcy5hc3BlY3RSYXRpbzsNCg0KCQkJaWYgKCBwTWluV2lkdGggPiBiLm1pbldpZHRoICkgew0KCQkJCWIubWluV2lkdGggPSBwTWluV2lkdGg7DQoJCQl9DQoJCQlpZiAoIHBNaW5IZWlnaHQgPiBiLm1pbkhlaWdodCApIHsNCgkJCQliLm1pbkhlaWdodCA9IHBNaW5IZWlnaHQ7DQoJCQl9DQoJCQlpZiAoIHBNYXhXaWR0aCA8IGIubWF4V2lkdGggKSB7DQoJCQkJYi5tYXhXaWR0aCA9IHBNYXhXaWR0aDsNCgkJCX0NCgkJCWlmICggcE1heEhlaWdodCA8IGIubWF4SGVpZ2h0ICkgew0KCQkJCWIubWF4SGVpZ2h0ID0gcE1heEhlaWdodDsNCgkJCX0NCgkJfQ0KCQl0aGlzLl92Qm91bmRhcmllcyA9IGI7DQoJfSwNCg0KCV91cGRhdGVDYWNoZTogZnVuY3Rpb24oIGRhdGEgKSB7DQoJCXRoaXMub2Zmc2V0ID0gdGhpcy5oZWxwZXIub2Zmc2V0KCk7DQoJCWlmICggdGhpcy5faXNOdW1iZXIoIGRhdGEubGVmdCApICkgew0KCQkJdGhpcy5wb3NpdGlvbi5sZWZ0ID0gZGF0YS5sZWZ0Ow0KCQl9DQoJCWlmICggdGhpcy5faXNOdW1iZXIoIGRhdGEudG9wICkgKSB7DQoJCQl0aGlzLnBvc2l0aW9uLnRvcCA9IGRhdGEudG9wOw0KCQl9DQoJCWlmICggdGhpcy5faXNOdW1iZXIoIGRhdGEuaGVpZ2h0ICkgKSB7DQoJCQl0aGlzLnNpemUuaGVpZ2h0ID0gZGF0YS5oZWlnaHQ7DQoJCX0NCgkJaWYgKCB0aGlzLl9pc051bWJlciggZGF0YS53aWR0aCApICkgew0KCQkJdGhpcy5zaXplLndpZHRoID0gZGF0YS53aWR0aDsNCgkJfQ0KCX0sDQoNCglfdXBkYXRlUmF0aW86IGZ1bmN0aW9uKCBkYXRhICkgew0KDQoJCXZhciBjcG9zID0gdGhpcy5wb3NpdGlvbiwNCgkJCWNzaXplID0gdGhpcy5zaXplLA0KCQkJYSA9IHRoaXMuYXhpczsNCg0KCQlpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLmhlaWdodCApICkgew0KCQkJZGF0YS53aWR0aCA9ICggZGF0YS5oZWlnaHQgKiB0aGlzLmFzcGVjdFJhdGlvICk7DQoJCX0gZWxzZSBpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLndpZHRoICkgKSB7DQoJCQlkYXRhLmhlaWdodCA9ICggZGF0YS53aWR0aCAvIHRoaXMuYXNwZWN0UmF0aW8gKTsNCgkJfQ0KDQoJCWlmICggYSA9PT0gInN3IiApIHsNCgkJCWRhdGEubGVmdCA9IGNwb3MubGVmdCArICggY3NpemUud2lkdGggLSBkYXRhLndpZHRoICk7DQoJCQlkYXRhLnRvcCA9IG51bGw7DQoJCX0NCgkJaWYgKCBhID09PSAibnciICkgew0KCQkJZGF0YS50b3AgPSBjcG9zLnRvcCArICggY3NpemUuaGVpZ2h0IC0gZGF0YS5oZWlnaHQgKTsNCgkJCWRhdGEubGVmdCA9IGNwb3MubGVmdCArICggY3NpemUud2lkdGggLSBkYXRhLndpZHRoICk7DQoJCX0NCg0KCQlyZXR1cm4gZGF0YTsNCgl9LA0KDQoJX3Jlc3BlY3RTaXplOiBmdW5jdGlvbiggZGF0YSApIHsNCg0KCQl2YXIgbyA9IHRoaXMuX3ZCb3VuZGFyaWVzLA0KCQkJYSA9IHRoaXMuYXhpcywNCgkJCWlzbWF4dyA9IHRoaXMuX2lzTnVtYmVyKCBkYXRhLndpZHRoICkgJiYgby5tYXhXaWR0aCAmJiAoIG8ubWF4V2lkdGggPCBkYXRhLndpZHRoICksDQoJCQlpc21heGggPSB0aGlzLl9pc051bWJlciggZGF0YS5oZWlnaHQgKSAmJiBvLm1heEhlaWdodCAmJiAoIG8ubWF4SGVpZ2h0IDwgZGF0YS5oZWlnaHQgKSwNCgkJCWlzbWludyA9IHRoaXMuX2lzTnVtYmVyKCBkYXRhLndpZHRoICkgJiYgby5taW5XaWR0aCAmJiAoIG8ubWluV2lkdGggPiBkYXRhLndpZHRoICksDQoJCQlpc21pbmggPSB0aGlzLl9pc051bWJlciggZGF0YS5oZWlnaHQgKSAmJiBvLm1pbkhlaWdodCAmJiAoIG8ubWluSGVpZ2h0ID4gZGF0YS5oZWlnaHQgKSwNCgkJCWR3ID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uLmxlZnQgKyB0aGlzLm9yaWdpbmFsU2l6ZS53aWR0aCwNCgkJCWRoID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uLnRvcCArIHRoaXMub3JpZ2luYWxTaXplLmhlaWdodCwNCgkJCWN3ID0gL3N3fG53fHcvLnRlc3QoIGEgKSwgY2ggPSAvbnd8bmV8bi8udGVzdCggYSApOw0KCQlpZiAoIGlzbWludyApIHsNCgkJCWRhdGEud2lkdGggPSBvLm1pbldpZHRoOw0KCQl9DQoJCWlmICggaXNtaW5oICkgew0KCQkJZGF0YS5oZWlnaHQgPSBvLm1pbkhlaWdodDsNCgkJfQ0KCQlpZiAoIGlzbWF4dyApIHsNCgkJCWRhdGEud2lkdGggPSBvLm1heFdpZHRoOw0KCQl9DQoJCWlmICggaXNtYXhoICkgew0KCQkJZGF0YS5oZWlnaHQgPSBvLm1heEhlaWdodDsNCgkJfQ0KDQoJCWlmICggaXNtaW53ICYmIGN3ICkgew0KCQkJZGF0YS5sZWZ0ID0gZHcgLSBvLm1pbldpZHRoOw0KCQl9DQoJCWlmICggaXNtYXh3ICYmIGN3ICkgew0KCQkJZGF0YS5sZWZ0ID0gZHcgLSBvLm1heFdpZHRoOw0KCQl9DQoJCWlmICggaXNtaW5oICYmIGNoICkgew0KCQkJZGF0YS50b3AgPSBkaCAtIG8ubWluSGVpZ2h0Ow0KCQl9DQoJCWlmICggaXNtYXhoICYmIGNoICkgew0KCQkJZGF0YS50b3AgPSBkaCAtIG8ubWF4SGVpZ2h0Ow0KCQl9DQoNCgkJLy8gRml4aW5nIGp1bXAgZXJyb3Igb24gdG9wL2xlZnQgLSBidWcgIzIzMzANCgkJaWYgKCAhZGF0YS53aWR0aCAmJiAhZGF0YS5oZWlnaHQgJiYgIWRhdGEubGVmdCAmJiBkYXRhLnRvcCApIHsNCgkJCWRhdGEudG9wID0gbnVsbDsNCgkJfSBlbHNlIGlmICggIWRhdGEud2lkdGggJiYgIWRhdGEuaGVpZ2h0ICYmICFkYXRhLnRvcCAmJiBkYXRhLmxlZnQgKSB7DQoJCQlkYXRhLmxlZnQgPSBudWxsOw0KCQl9DQoNCgkJcmV0dXJuIGRhdGE7DQoJfSwNCg0KCV9nZXRQYWRkaW5nUGx1c0JvcmRlckRpbWVuc2lvbnM6IGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQl2YXIgaSA9IDAsDQoJCQl3aWR0aHMgPSBbXSwNCgkJCWJvcmRlcnMgPSBbDQoJCQkJZWxlbWVudC5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwNCgkJCQllbGVtZW50LmNzcyggImJvcmRlclJpZ2h0V2lkdGgiICksDQoJCQkJZWxlbWVudC5jc3MoICJib3JkZXJCb3R0b21XaWR0aCIgKSwNCgkJCQllbGVtZW50LmNzcyggImJvcmRlckxlZnRXaWR0aCIgKQ0KCQkJXSwNCgkJCXBhZGRpbmdzID0gWw0KCQkJCWVsZW1lbnQuY3NzKCAicGFkZGluZ1RvcCIgKSwNCgkJCQllbGVtZW50LmNzcyggInBhZGRpbmdSaWdodCIgKSwNCgkJCQllbGVtZW50LmNzcyggInBhZGRpbmdCb3R0b20iICksDQoJCQkJZWxlbWVudC5jc3MoICJwYWRkaW5nTGVmdCIgKQ0KCQkJXTsNCg0KCQlmb3IgKCA7IGkgPCA0OyBpKysgKSB7DQoJCQl3aWR0aHNbIGkgXSA9ICggcGFyc2VGbG9hdCggYm9yZGVyc1sgaSBdICkgfHwgMCApOw0KCQkJd2lkdGhzWyBpIF0gKz0gKCBwYXJzZUZsb2F0KCBwYWRkaW5nc1sgaSBdICkgfHwgMCApOw0KCQl9DQoNCgkJcmV0dXJuIHsNCgkJCWhlaWdodDogd2lkdGhzWyAwIF0gKyB3aWR0aHNbIDIgXSwNCgkJCXdpZHRoOiB3aWR0aHNbIDEgXSArIHdpZHRoc1sgMyBdDQoJCX07DQoJfSwNCg0KCV9wcm9wb3J0aW9uYWxseVJlc2l6ZTogZnVuY3Rpb24oKSB7DQoNCgkJaWYgKCAhdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50cy5sZW5ndGggKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl2YXIgcHJlbCwNCgkJCWkgPSAwLA0KCQkJZWxlbWVudCA9IHRoaXMuaGVscGVyIHx8IHRoaXMuZWxlbWVudDsNCg0KCQlmb3IgKCA7IGkgPCB0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZUVsZW1lbnRzLmxlbmd0aDsgaSsrICkgew0KDQoJCQlwcmVsID0gdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50c1sgaSBdOw0KDQoJCQkvLyBUT0RPOiBTZWVtcyBsaWtlIGEgYnVnIHRvIGNhY2hlIHRoaXMub3V0ZXJEaW1lbnNpb25zDQoJCQkvLyBjb25zaWRlcmluZyB0aGF0IHdlIGFyZSBpbiBhIGxvb3AuDQoJCQlpZiAoICF0aGlzLm91dGVyRGltZW5zaW9ucyApIHsNCgkJCQl0aGlzLm91dGVyRGltZW5zaW9ucyA9IHRoaXMuX2dldFBhZGRpbmdQbHVzQm9yZGVyRGltZW5zaW9ucyggcHJlbCApOw0KCQkJfQ0KDQoJCQlwcmVsLmNzcyggew0KCQkJCWhlaWdodDogKCBlbGVtZW50LmhlaWdodCgpIC0gdGhpcy5vdXRlckRpbWVuc2lvbnMuaGVpZ2h0ICkgfHwgMCwNCgkJCQl3aWR0aDogKCBlbGVtZW50LndpZHRoKCkgLSB0aGlzLm91dGVyRGltZW5zaW9ucy53aWR0aCApIHx8IDANCgkJCX0gKTsNCg0KCQl9DQoNCgl9LA0KDQoJX3JlbmRlclByb3h5OiBmdW5jdGlvbigpIHsNCg0KCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQsIG8gPSB0aGlzLm9wdGlvbnM7DQoJCXRoaXMuZWxlbWVudE9mZnNldCA9IGVsLm9mZnNldCgpOw0KDQoJCWlmICggdGhpcy5faGVscGVyICkgew0KDQoJCQl0aGlzLmhlbHBlciA9IHRoaXMuaGVscGVyIHx8ICQoICI8ZGl2IHN0eWxlPSdvdmVyZmxvdzpoaWRkZW47Jz48L2Rpdj4iICk7DQoNCgkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmhlbHBlciwgdGhpcy5faGVscGVyICk7DQoJCQl0aGlzLmhlbHBlci5jc3MoIHsNCgkJCQl3aWR0aDogdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKSwNCgkJCQloZWlnaHQ6IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpLA0KCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLA0KCQkJCWxlZnQ6IHRoaXMuZWxlbWVudE9mZnNldC5sZWZ0ICsgInB4IiwNCgkJCQl0b3A6IHRoaXMuZWxlbWVudE9mZnNldC50b3AgKyAicHgiLA0KCQkJCXpJbmRleDogKytvLnpJbmRleCAvL1RPRE86IERvbid0IG1vZGlmeSBvcHRpb24NCgkJCX0gKTsNCg0KCQkJdGhpcy5oZWxwZXINCgkJCQkuYXBwZW5kVG8oICJib2R5IiApDQoJCQkJLmRpc2FibGVTZWxlY3Rpb24oKTsNCg0KCQl9IGVsc2Ugew0KCQkJdGhpcy5oZWxwZXIgPSB0aGlzLmVsZW1lbnQ7DQoJCX0NCg0KCX0sDQoNCglfY2hhbmdlOiB7DQoJCWU6IGZ1bmN0aW9uKCBldmVudCwgZHggKSB7DQoJCQlyZXR1cm4geyB3aWR0aDogdGhpcy5vcmlnaW5hbFNpemUud2lkdGggKyBkeCB9Ow0KCQl9LA0KCQl3OiBmdW5jdGlvbiggZXZlbnQsIGR4ICkgew0KCQkJdmFyIGNzID0gdGhpcy5vcmlnaW5hbFNpemUsIHNwID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uOw0KCQkJcmV0dXJuIHsgbGVmdDogc3AubGVmdCArIGR4LCB3aWR0aDogY3Mud2lkdGggLSBkeCB9Ow0KCQl9LA0KCQluOiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsNCgkJCXZhciBjcyA9IHRoaXMub3JpZ2luYWxTaXplLCBzcCA9IHRoaXMub3JpZ2luYWxQb3NpdGlvbjsNCgkJCXJldHVybiB7IHRvcDogc3AudG9wICsgZHksIGhlaWdodDogY3MuaGVpZ2h0IC0gZHkgfTsNCgkJfSwNCgkJczogZnVuY3Rpb24oIGV2ZW50LCBkeCwgZHkgKSB7DQoJCQlyZXR1cm4geyBoZWlnaHQ6IHRoaXMub3JpZ2luYWxTaXplLmhlaWdodCArIGR5IH07DQoJCX0sDQoJCXNlOiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsNCgkJCXJldHVybiAkLmV4dGVuZCggdGhpcy5fY2hhbmdlLnMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLA0KCQkJCXRoaXMuX2NoYW5nZS5lLmFwcGx5KCB0aGlzLCBbIGV2ZW50LCBkeCwgZHkgXSApICk7DQoJCX0sDQoJCXN3OiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsNCgkJCXJldHVybiAkLmV4dGVuZCggdGhpcy5fY2hhbmdlLnMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLA0KCQkJCXRoaXMuX2NoYW5nZS53LmFwcGx5KCB0aGlzLCBbIGV2ZW50LCBkeCwgZHkgXSApICk7DQoJCX0sDQoJCW5lOiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsNCgkJCXJldHVybiAkLmV4dGVuZCggdGhpcy5fY2hhbmdlLm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLA0KCQkJCXRoaXMuX2NoYW5nZS5lLmFwcGx5KCB0aGlzLCBbIGV2ZW50LCBkeCwgZHkgXSApICk7DQoJCX0sDQoJCW53OiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsNCgkJCXJldHVybiAkLmV4dGVuZCggdGhpcy5fY2hhbmdlLm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLA0KCQkJCXRoaXMuX2NoYW5nZS53LmFwcGx5KCB0aGlzLCBbIGV2ZW50LCBkeCwgZHkgXSApICk7DQoJCX0NCgl9LA0KDQoJX3Byb3BhZ2F0ZTogZnVuY3Rpb24oIG4sIGV2ZW50ICkgew0KCQkkLnVpLnBsdWdpbi5jYWxsKCB0aGlzLCBuLCBbIGV2ZW50LCB0aGlzLnVpKCkgXSApOw0KCQkoIG4gIT09ICJyZXNpemUiICYmIHRoaXMuX3RyaWdnZXIoIG4sIGV2ZW50LCB0aGlzLnVpKCkgKSApOw0KCX0sDQoNCglwbHVnaW5zOiB7fSwNCg0KCXVpOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHsNCgkJCW9yaWdpbmFsRWxlbWVudDogdGhpcy5vcmlnaW5hbEVsZW1lbnQsDQoJCQllbGVtZW50OiB0aGlzLmVsZW1lbnQsDQoJCQloZWxwZXI6IHRoaXMuaGVscGVyLA0KCQkJcG9zaXRpb246IHRoaXMucG9zaXRpb24sDQoJCQlzaXplOiB0aGlzLnNpemUsDQoJCQlvcmlnaW5hbFNpemU6IHRoaXMub3JpZ2luYWxTaXplLA0KCQkJb3JpZ2luYWxQb3NpdGlvbjogdGhpcy5vcmlnaW5hbFBvc2l0aW9uDQoJCX07DQoJfQ0KDQp9ICk7DQoNCi8qDQogKiBSZXNpemFibGUgRXh0ZW5zaW9ucw0KICovDQoNCiQudWkucGx1Z2luLmFkZCggInJlc2l6YWJsZSIsICJhbmltYXRlIiwgew0KDQoJc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKSwNCgkJCW8gPSB0aGF0Lm9wdGlvbnMsDQoJCQlwciA9IHRoYXQuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMsDQoJCQlpc3RhID0gcHIubGVuZ3RoICYmICggL3RleHRhcmVhL2kgKS50ZXN0KCBwclsgMCBdLm5vZGVOYW1lICksDQoJCQlzb2Zmc2V0aCA9IGlzdGEgJiYgdGhhdC5faGFzU2Nyb2xsKCBwclsgMCBdLCAibGVmdCIgKSA\/IDAgOiB0aGF0LnNpemVEaWZmLmhlaWdodCwNCgkJCXNvZmZzZXR3ID0gaXN0YSA\/IDAgOiB0aGF0LnNpemVEaWZmLndpZHRoLA0KCQkJc3R5bGUgPSB7DQoJCQkJd2lkdGg6ICggdGhhdC5zaXplLndpZHRoIC0gc29mZnNldHcgKSwNCgkJCQloZWlnaHQ6ICggdGhhdC5zaXplLmhlaWdodCAtIHNvZmZzZXRoICkNCgkJCX0sDQoJCQlsZWZ0ID0gKCBwYXJzZUZsb2F0KCB0aGF0LmVsZW1lbnQuY3NzKCAibGVmdCIgKSApICsNCgkJCQkoIHRoYXQucG9zaXRpb24ubGVmdCAtIHRoYXQub3JpZ2luYWxQb3NpdGlvbi5sZWZ0ICkgKSB8fCBudWxsLA0KCQkJdG9wID0gKCBwYXJzZUZsb2F0KCB0aGF0LmVsZW1lbnQuY3NzKCAidG9wIiApICkgKw0KCQkJCSggdGhhdC5wb3NpdGlvbi50b3AgLSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24udG9wICkgKSB8fCBudWxsOw0KDQoJCXRoYXQuZWxlbWVudC5hbmltYXRlKA0KCQkJJC5leHRlbmQoIHN0eWxlLCB0b3AgJiYgbGVmdCA\/IHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfSA6IHt9ICksIHsNCgkJCQlkdXJhdGlvbjogby5hbmltYXRlRHVyYXRpb24sDQoJCQkJZWFzaW5nOiBvLmFuaW1hdGVFYXNpbmcsDQoJCQkJc3RlcDogZnVuY3Rpb24oKSB7DQoNCgkJCQkJdmFyIGRhdGEgPSB7DQoJCQkJCQl3aWR0aDogcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggIndpZHRoIiApICksDQoJCQkJCQloZWlnaHQ6IHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJoZWlnaHQiICkgKSwNCgkJCQkJCXRvcDogcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggInRvcCIgKSApLA0KCQkJCQkJbGVmdDogcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggImxlZnQiICkgKQ0KCQkJCQl9Ow0KDQoJCQkJCWlmICggcHIgJiYgcHIubGVuZ3RoICkgew0KCQkJCQkJJCggcHJbIDAgXSApLmNzcyggeyB3aWR0aDogZGF0YS53aWR0aCwgaGVpZ2h0OiBkYXRhLmhlaWdodCB9ICk7DQoJCQkJCX0NCg0KCQkJCQkvLyBQcm9wYWdhdGluZyByZXNpemUsIGFuZCB1cGRhdGluZyB2YWx1ZXMgZm9yIGVhY2ggYW5pbWF0aW9uIHN0ZXANCgkJCQkJdGhhdC5fdXBkYXRlQ2FjaGUoIGRhdGEgKTsNCgkJCQkJdGhhdC5fcHJvcGFnYXRlKCAicmVzaXplIiwgZXZlbnQgKTsNCg0KCQkJCX0NCgkJCX0NCgkJKTsNCgl9DQoNCn0gKTsNCg0KJC51aS5wbHVnaW4uYWRkKCAicmVzaXphYmxlIiwgImNvbnRhaW5tZW50Iiwgew0KDQoJc3RhcnQ6IGZ1bmN0aW9uKCkgew0KCQl2YXIgZWxlbWVudCwgcCwgY28sIGNoLCBjdywgd2lkdGgsIGhlaWdodCwNCgkJCXRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksDQoJCQlvID0gdGhhdC5vcHRpb25zLA0KCQkJZWwgPSB0aGF0LmVsZW1lbnQsDQoJCQlvYyA9IG8uY29udGFpbm1lbnQsDQoJCQljZSA9ICggb2MgaW5zdGFuY2VvZiAkICkgPw0KCQkJCW9jLmdldCggMCApIDoNCgkJCQkoIC9wYXJlbnQvLnRlc3QoIG9jICkgKSA\/IGVsLnBhcmVudCgpLmdldCggMCApIDogb2M7DQoNCgkJaWYgKCAhY2UgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl0aGF0LmNvbnRhaW5lckVsZW1lbnQgPSAkKCBjZSApOw0KDQoJCWlmICggL2RvY3VtZW50Ly50ZXN0KCBvYyApIHx8IG9jID09PSBkb2N1bWVudCApIHsNCgkJCXRoYXQuY29udGFpbmVyT2Zmc2V0ID0gew0KCQkJCWxlZnQ6IDAsDQoJCQkJdG9wOiAwDQoJCQl9Ow0KCQkJdGhhdC5jb250YWluZXJQb3NpdGlvbiA9IHsNCgkJCQlsZWZ0OiAwLA0KCQkJCXRvcDogMA0KCQkJfTsNCg0KCQkJdGhhdC5wYXJlbnREYXRhID0gew0KCQkJCWVsZW1lbnQ6ICQoIGRvY3VtZW50ICksDQoJCQkJbGVmdDogMCwNCgkJCQl0b3A6IDAsDQoJCQkJd2lkdGg6ICQoIGRvY3VtZW50ICkud2lkdGgoKSwNCgkJCQloZWlnaHQ6ICQoIGRvY3VtZW50ICkuaGVpZ2h0KCkgfHwgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodA0KCQkJfTsNCgkJfSBlbHNlIHsNCgkJCWVsZW1lbnQgPSAkKCBjZSApOw0KCQkJcCA9IFtdOw0KCQkJJCggWyAiVG9wIiwgIlJpZ2h0IiwgIkxlZnQiLCAiQm90dG9tIiBdICkuZWFjaCggZnVuY3Rpb24oIGksIG5hbWUgKSB7DQoJCQkJcFsgaSBdID0gdGhhdC5fbnVtKCBlbGVtZW50LmNzcyggInBhZGRpbmciICsgbmFtZSApICk7DQoJCQl9ICk7DQoNCgkJCXRoYXQuY29udGFpbmVyT2Zmc2V0ID0gZWxlbWVudC5vZmZzZXQoKTsNCgkJCXRoYXQuY29udGFpbmVyUG9zaXRpb24gPSBlbGVtZW50LnBvc2l0aW9uKCk7DQoJCQl0aGF0LmNvbnRhaW5lclNpemUgPSB7DQoJCQkJaGVpZ2h0OiAoIGVsZW1lbnQuaW5uZXJIZWlnaHQoKSAtIHBbIDMgXSApLA0KCQkJCXdpZHRoOiAoIGVsZW1lbnQuaW5uZXJXaWR0aCgpIC0gcFsgMSBdICkNCgkJCX07DQoNCgkJCWNvID0gdGhhdC5jb250YWluZXJPZmZzZXQ7DQoJCQljaCA9IHRoYXQuY29udGFpbmVyU2l6ZS5oZWlnaHQ7DQoJCQljdyA9IHRoYXQuY29udGFpbmVyU2l6ZS53aWR0aDsNCgkJCXdpZHRoID0gKCB0aGF0Ll9oYXNTY3JvbGwgKCBjZSwgImxlZnQiICkgPyBjZS5zY3JvbGxXaWR0aCA6IGN3ICk7DQoJCQloZWlnaHQgPSAoIHRoYXQuX2hhc1Njcm9sbCAoIGNlICkgPyBjZS5zY3JvbGxIZWlnaHQgOiBjaCApIDsNCg0KCQkJdGhhdC5wYXJlbnREYXRhID0gew0KCQkJCWVsZW1lbnQ6IGNlLA0KCQkJCWxlZnQ6IGNvLmxlZnQsDQoJCQkJdG9wOiBjby50b3AsDQoJCQkJd2lkdGg6IHdpZHRoLA0KCQkJCWhlaWdodDogaGVpZ2h0DQoJCQl9Ow0KCQl9DQoJfSwNCg0KCXJlc2l6ZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgd29zZXQsIGhvc2V0LCBpc1BhcmVudCwgaXNPZmZzZXRSZWxhdGl2ZSwNCgkJCXRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksDQoJCQlvID0gdGhhdC5vcHRpb25zLA0KCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldCwNCgkJCWNwID0gdGhhdC5wb3NpdGlvbiwNCgkJCXBSYXRpbyA9IHRoYXQuX2FzcGVjdFJhdGlvIHx8IGV2ZW50LnNoaWZ0S2V5LA0KCQkJY29wID0gew0KCQkJCXRvcDogMCwNCgkJCQlsZWZ0OiAwDQoJCQl9LA0KCQkJY2UgPSB0aGF0LmNvbnRhaW5lckVsZW1lbnQsDQoJCQljb250aW51ZVJlc2l6ZSA9IHRydWU7DQoNCgkJaWYgKCBjZVsgMCBdICE9PSBkb2N1bWVudCAmJiAoIC9zdGF0aWMvICkudGVzdCggY2UuY3NzKCAicG9zaXRpb24iICkgKSApIHsNCgkJCWNvcCA9IGNvOw0KCQl9DQoNCgkJaWYgKCBjcC5sZWZ0IDwgKCB0aGF0Ll9oZWxwZXIgPyBjby5sZWZ0IDogMCApICkgew0KCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5zaXplLndpZHRoICsNCgkJCQkoIHRoYXQuX2hlbHBlciA\/DQoJCQkJCSggdGhhdC5wb3NpdGlvbi5sZWZ0IC0gY28ubGVmdCApIDoNCgkJCQkJKCB0aGF0LnBvc2l0aW9uLmxlZnQgLSBjb3AubGVmdCApICk7DQoNCgkJCWlmICggcFJhdGlvICkgew0KCQkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnNpemUud2lkdGggLyB0aGF0LmFzcGVjdFJhdGlvOw0KCQkJCWNvbnRpbnVlUmVzaXplID0gZmFsc2U7DQoJCQl9DQoJCQl0aGF0LnBvc2l0aW9uLmxlZnQgPSBvLmhlbHBlciA\/IGNvLmxlZnQgOiAwOw0KCQl9DQoNCgkJaWYgKCBjcC50b3AgPCAoIHRoYXQuX2hlbHBlciA\/IGNvLnRvcCA6IDAgKSApIHsNCgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnNpemUuaGVpZ2h0ICsNCgkJCQkoIHRoYXQuX2hlbHBlciA\/DQoJCQkJCSggdGhhdC5wb3NpdGlvbi50b3AgLSBjby50b3AgKSA6DQoJCQkJCXRoYXQucG9zaXRpb24udG9wICk7DQoNCgkJCWlmICggcFJhdGlvICkgew0KCQkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQuc2l6ZS5oZWlnaHQgKiB0aGF0LmFzcGVjdFJhdGlvOw0KCQkJCWNvbnRpbnVlUmVzaXplID0gZmFsc2U7DQoJCQl9DQoJCQl0aGF0LnBvc2l0aW9uLnRvcCA9IHRoYXQuX2hlbHBlciA\/IGNvLnRvcCA6IDA7DQoJCX0NCg0KCQlpc1BhcmVudCA9IHRoYXQuY29udGFpbmVyRWxlbWVudC5nZXQoIDAgKSA9PT0gdGhhdC5lbGVtZW50LnBhcmVudCgpLmdldCggMCApOw0KCQlpc09mZnNldFJlbGF0aXZlID0gL3JlbGF0aXZlfGFic29sdXRlLy50ZXN0KCB0aGF0LmNvbnRhaW5lckVsZW1lbnQuY3NzKCAicG9zaXRpb24iICkgKTsNCg0KCQlpZiAoIGlzUGFyZW50ICYmIGlzT2Zmc2V0UmVsYXRpdmUgKSB7DQoJCQl0aGF0Lm9mZnNldC5sZWZ0ID0gdGhhdC5wYXJlbnREYXRhLmxlZnQgKyB0aGF0LnBvc2l0aW9uLmxlZnQ7DQoJCQl0aGF0Lm9mZnNldC50b3AgPSB0aGF0LnBhcmVudERhdGEudG9wICsgdGhhdC5wb3NpdGlvbi50b3A7DQoJCX0gZWxzZSB7DQoJCQl0aGF0Lm9mZnNldC5sZWZ0ID0gdGhhdC5lbGVtZW50Lm9mZnNldCgpLmxlZnQ7DQoJCQl0aGF0Lm9mZnNldC50b3AgPSB0aGF0LmVsZW1lbnQub2Zmc2V0KCkudG9wOw0KCQl9DQoNCgkJd29zZXQgPSBNYXRoLmFicyggdGhhdC5zaXplRGlmZi53aWR0aCArDQoJCQkoIHRoYXQuX2hlbHBlciA\/DQoJCQkJdGhhdC5vZmZzZXQubGVmdCAtIGNvcC5sZWZ0IDoNCgkJCQkoIHRoYXQub2Zmc2V0LmxlZnQgLSBjby5sZWZ0ICkgKSApOw0KDQoJCWhvc2V0ID0gTWF0aC5hYnMoIHRoYXQuc2l6ZURpZmYuaGVpZ2h0ICsNCgkJCSggdGhhdC5faGVscGVyID8NCgkJCQl0aGF0Lm9mZnNldC50b3AgLSBjb3AudG9wIDoNCgkJCQkoIHRoYXQub2Zmc2V0LnRvcCAtIGNvLnRvcCApICkgKTsNCg0KCQlpZiAoIHdvc2V0ICsgdGhhdC5zaXplLndpZHRoID49IHRoYXQucGFyZW50RGF0YS53aWR0aCApIHsNCgkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQucGFyZW50RGF0YS53aWR0aCAtIHdvc2V0Ow0KCQkJaWYgKCBwUmF0aW8gKSB7DQoJCQkJdGhhdC5zaXplLmhlaWdodCA9IHRoYXQuc2l6ZS53aWR0aCAvIHRoYXQuYXNwZWN0UmF0aW87DQoJCQkJY29udGludWVSZXNpemUgPSBmYWxzZTsNCgkJCX0NCgkJfQ0KDQoJCWlmICggaG9zZXQgKyB0aGF0LnNpemUuaGVpZ2h0ID49IHRoYXQucGFyZW50RGF0YS5oZWlnaHQgKSB7DQoJCQl0aGF0LnNpemUuaGVpZ2h0ID0gdGhhdC5wYXJlbnREYXRhLmhlaWdodCAtIGhvc2V0Ow0KCQkJaWYgKCBwUmF0aW8gKSB7DQoJCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5zaXplLmhlaWdodCAqIHRoYXQuYXNwZWN0UmF0aW87DQoJCQkJY29udGludWVSZXNpemUgPSBmYWxzZTsNCgkJCX0NCgkJfQ0KDQoJCWlmICggIWNvbnRpbnVlUmVzaXplICkgew0KCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gdGhhdC5wcmV2UG9zaXRpb24ubGVmdDsNCgkJCXRoYXQucG9zaXRpb24udG9wID0gdGhhdC5wcmV2UG9zaXRpb24udG9wOw0KCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5wcmV2U2l6ZS53aWR0aDsNCgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnByZXZTaXplLmhlaWdodDsNCgkJfQ0KCX0sDQoNCglzdG9wOiBmdW5jdGlvbigpIHsNCgkJdmFyIHRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksDQoJCQlvID0gdGhhdC5vcHRpb25zLA0KCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldCwNCgkJCWNvcCA9IHRoYXQuY29udGFpbmVyUG9zaXRpb24sDQoJCQljZSA9IHRoYXQuY29udGFpbmVyRWxlbWVudCwNCgkJCWhlbHBlciA9ICQoIHRoYXQuaGVscGVyICksDQoJCQlobyA9IGhlbHBlci5vZmZzZXQoKSwNCgkJCXcgPSBoZWxwZXIub3V0ZXJXaWR0aCgpIC0gdGhhdC5zaXplRGlmZi53aWR0aCwNCgkJCWggPSBoZWxwZXIub3V0ZXJIZWlnaHQoKSAtIHRoYXQuc2l6ZURpZmYuaGVpZ2h0Ow0KDQoJCWlmICggdGhhdC5faGVscGVyICYmICFvLmFuaW1hdGUgJiYgKCAvcmVsYXRpdmUvICkudGVzdCggY2UuY3NzKCAicG9zaXRpb24iICkgKSApIHsNCgkJCSQoIHRoaXMgKS5jc3MoIHsNCgkJCQlsZWZ0OiBoby5sZWZ0IC0gY29wLmxlZnQgLSBjby5sZWZ0LA0KCQkJCXdpZHRoOiB3LA0KCQkJCWhlaWdodDogaA0KCQkJfSApOw0KCQl9DQoNCgkJaWYgKCB0aGF0Ll9oZWxwZXIgJiYgIW8uYW5pbWF0ZSAmJiAoIC9zdGF0aWMvICkudGVzdCggY2UuY3NzKCAicG9zaXRpb24iICkgKSApIHsNCgkJCSQoIHRoaXMgKS5jc3MoIHsNCgkJCQlsZWZ0OiBoby5sZWZ0IC0gY29wLmxlZnQgLSBjby5sZWZ0LA0KCQkJCXdpZHRoOiB3LA0KCQkJCWhlaWdodDogaA0KCQkJfSApOw0KCQl9DQoJfQ0KfSApOw0KDQokLnVpLnBsdWdpbi5hZGQoICJyZXNpemFibGUiLCAiYWxzb1Jlc2l6ZSIsIHsNCg0KCXN0YXJ0OiBmdW5jdGlvbigpIHsNCgkJdmFyIHRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksDQoJCQlvID0gdGhhdC5vcHRpb25zOw0KDQoJCSQoIG8uYWxzb1Jlc2l6ZSApLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJdmFyIGVsID0gJCggdGhpcyApOw0KCQkJZWwuZGF0YSggInVpLXJlc2l6YWJsZS1hbHNvcmVzaXplIiwgew0KCQkJCXdpZHRoOiBwYXJzZUZsb2F0KCBlbC53aWR0aCgpICksIGhlaWdodDogcGFyc2VGbG9hdCggZWwuaGVpZ2h0KCkgKSwNCgkJCQlsZWZ0OiBwYXJzZUZsb2F0KCBlbC5jc3MoICJsZWZ0IiApICksIHRvcDogcGFyc2VGbG9hdCggZWwuY3NzKCAidG9wIiApICkNCgkJCX0gKTsNCgkJfSApOw0KCX0sDQoNCglyZXNpemU6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7DQoJCXZhciB0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLA0KCQkJbyA9IHRoYXQub3B0aW9ucywNCgkJCW9zID0gdGhhdC5vcmlnaW5hbFNpemUsDQoJCQlvcCA9IHRoYXQub3JpZ2luYWxQb3NpdGlvbiwNCgkJCWRlbHRhID0gew0KCQkJCWhlaWdodDogKCB0aGF0LnNpemUuaGVpZ2h0IC0gb3MuaGVpZ2h0ICkgfHwgMCwNCgkJCQl3aWR0aDogKCB0aGF0LnNpemUud2lkdGggLSBvcy53aWR0aCApIHx8IDAsDQoJCQkJdG9wOiAoIHRoYXQucG9zaXRpb24udG9wIC0gb3AudG9wICkgfHwgMCwNCgkJCQlsZWZ0OiAoIHRoYXQucG9zaXRpb24ubGVmdCAtIG9wLmxlZnQgKSB8fCAwDQoJCQl9Ow0KDQoJCQkkKCBvLmFsc29SZXNpemUgKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgZWwgPSAkKCB0aGlzICksIHN0YXJ0ID0gJCggdGhpcyApLmRhdGEoICJ1aS1yZXNpemFibGUtYWxzb3Jlc2l6ZSIgKSwgc3R5bGUgPSB7fSwNCgkJCQkJY3NzID0gZWwucGFyZW50cyggdWkub3JpZ2luYWxFbGVtZW50WyAwIF0gKS5sZW5ndGggPw0KCQkJCQkJCVsgIndpZHRoIiwgImhlaWdodCIgXSA6DQoJCQkJCQkJWyAid2lkdGgiLCAiaGVpZ2h0IiwgInRvcCIsICJsZWZ0IiBdOw0KDQoJCQkJJC5lYWNoKCBjc3MsIGZ1bmN0aW9uKCBpLCBwcm9wICkgew0KCQkJCQl2YXIgc3VtID0gKCBzdGFydFsgcHJvcCBdIHx8IDAgKSArICggZGVsdGFbIHByb3AgXSB8fCAwICk7DQoJCQkJCWlmICggc3VtICYmIHN1bSA+PSAwICkgew0KCQkJCQkJc3R5bGVbIHByb3AgXSA9IHN1bSB8fCBudWxsOw0KCQkJCQl9DQoJCQkJfSApOw0KDQoJCQkJZWwuY3NzKCBzdHlsZSApOw0KCQkJfSApOw0KCX0sDQoNCglzdG9wOiBmdW5jdGlvbigpIHsNCgkJJCggdGhpcyApLnJlbW92ZURhdGEoICJ1aS1yZXNpemFibGUtYWxzb3Jlc2l6ZSIgKTsNCgl9DQp9ICk7DQoNCiQudWkucGx1Z2luLmFkZCggInJlc2l6YWJsZSIsICJnaG9zdCIsIHsNCg0KCXN0YXJ0OiBmdW5jdGlvbigpIHsNCg0KCQl2YXIgdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKSwgY3MgPSB0aGF0LnNpemU7DQoNCgkJdGhhdC5naG9zdCA9IHRoYXQub3JpZ2luYWxFbGVtZW50LmNsb25lKCk7DQoJCXRoYXQuZ2hvc3QuY3NzKCB7DQoJCQlvcGFjaXR5OiAwLjI1LA0KCQkJZGlzcGxheTogImJsb2NrIiwNCgkJCXBvc2l0aW9uOiAicmVsYXRpdmUiLA0KCQkJaGVpZ2h0OiBjcy5oZWlnaHQsDQoJCQl3aWR0aDogY3Mud2lkdGgsDQoJCQltYXJnaW46IDAsDQoJCQlsZWZ0OiAwLA0KCQkJdG9wOiAwDQoJCX0gKTsNCg0KCQl0aGF0Ll9hZGRDbGFzcyggdGhhdC5naG9zdCwgInVpLXJlc2l6YWJsZS1naG9zdCIgKTsNCg0KCQkvLyBERVBSRUNBVEVEDQoJCS8vIFRPRE86IHJlbW92ZSBhZnRlciAxLjEyDQoJCWlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICYmIHR5cGVvZiB0aGF0Lm9wdGlvbnMuZ2hvc3QgPT09ICJzdHJpbmciICkgew0KDQoJCQkvLyBHaG9zdCBvcHRpb24NCgkJCXRoYXQuZ2hvc3QuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5naG9zdCApOw0KCQl9DQoNCgkJdGhhdC5naG9zdC5hcHBlbmRUbyggdGhhdC5oZWxwZXIgKTsNCg0KCX0sDQoNCglyZXNpemU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKTsNCgkJaWYgKCB0aGF0Lmdob3N0ICkgew0KCQkJdGhhdC5naG9zdC5jc3MoIHsNCgkJCQlwb3NpdGlvbjogInJlbGF0aXZlIiwNCgkJCQloZWlnaHQ6IHRoYXQuc2l6ZS5oZWlnaHQsDQoJCQkJd2lkdGg6IHRoYXQuc2l6ZS53aWR0aA0KCQkJfSApOw0KCQl9DQoJfSwNCg0KCXN0b3A6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKTsNCgkJaWYgKCB0aGF0Lmdob3N0ICYmIHRoYXQuaGVscGVyICkgew0KCQkJdGhhdC5oZWxwZXIuZ2V0KCAwICkucmVtb3ZlQ2hpbGQoIHRoYXQuZ2hvc3QuZ2V0KCAwICkgKTsNCgkJfQ0KCX0NCg0KfSApOw0KDQokLnVpLnBsdWdpbi5hZGQoICJyZXNpemFibGUiLCAiZ3JpZCIsIHsNCg0KCXJlc2l6ZTogZnVuY3Rpb24oKSB7DQoJCXZhciBvdXRlckRpbWVuc2lvbnMsDQoJCQl0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLA0KCQkJbyA9IHRoYXQub3B0aW9ucywNCgkJCWNzID0gdGhhdC5zaXplLA0KCQkJb3MgPSB0aGF0Lm9yaWdpbmFsU2l6ZSwNCgkJCW9wID0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLA0KCQkJYSA9IHRoYXQuYXhpcywNCgkJCWdyaWQgPSB0eXBlb2Ygby5ncmlkID09PSAibnVtYmVyIiA\/IFsgby5ncmlkLCBvLmdyaWQgXSA6IG8uZ3JpZCwNCgkJCWdyaWRYID0gKCBncmlkWyAwIF0gfHwgMSApLA0KCQkJZ3JpZFkgPSAoIGdyaWRbIDEgXSB8fCAxICksDQoJCQlveCA9IE1hdGgucm91bmQoICggY3Mud2lkdGggLSBvcy53aWR0aCApIC8gZ3JpZFggKSAqIGdyaWRYLA0KCQkJb3kgPSBNYXRoLnJvdW5kKCAoIGNzLmhlaWdodCAtIG9zLmhlaWdodCApIC8gZ3JpZFkgKSAqIGdyaWRZLA0KCQkJbmV3V2lkdGggPSBvcy53aWR0aCArIG94LA0KCQkJbmV3SGVpZ2h0ID0gb3MuaGVpZ2h0ICsgb3ksDQoJCQlpc01heFdpZHRoID0gby5tYXhXaWR0aCAmJiAoIG8ubWF4V2lkdGggPCBuZXdXaWR0aCApLA0KCQkJaXNNYXhIZWlnaHQgPSBvLm1heEhlaWdodCAmJiAoIG8ubWF4SGVpZ2h0IDwgbmV3SGVpZ2h0ICksDQoJCQlpc01pbldpZHRoID0gby5taW5XaWR0aCAmJiAoIG8ubWluV2lkdGggPiBuZXdXaWR0aCApLA0KCQkJaXNNaW5IZWlnaHQgPSBvLm1pbkhlaWdodCAmJiAoIG8ubWluSGVpZ2h0ID4gbmV3SGVpZ2h0ICk7DQoNCgkJby5ncmlkID0gZ3JpZDsNCg0KCQlpZiAoIGlzTWluV2lkdGggKSB7DQoJCQluZXdXaWR0aCArPSBncmlkWDsNCgkJfQ0KCQlpZiAoIGlzTWluSGVpZ2h0ICkgew0KCQkJbmV3SGVpZ2h0ICs9IGdyaWRZOw0KCQl9DQoJCWlmICggaXNNYXhXaWR0aCApIHsNCgkJCW5ld1dpZHRoIC09IGdyaWRYOw0KCQl9DQoJCWlmICggaXNNYXhIZWlnaHQgKSB7DQoJCQluZXdIZWlnaHQgLT0gZ3JpZFk7DQoJCX0NCg0KCQlpZiAoIC9eKHNlfHN8ZSkkLy50ZXN0KCBhICkgKSB7DQoJCQl0aGF0LnNpemUud2lkdGggPSBuZXdXaWR0aDsNCgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7DQoJCX0gZWxzZSBpZiAoIC9eKG5lKSQvLnRlc3QoIGEgKSApIHsNCgkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOw0KCQkJdGhhdC5zaXplLmhlaWdodCA9IG5ld0hlaWdodDsNCgkJCXRoYXQucG9zaXRpb24udG9wID0gb3AudG9wIC0gb3k7DQoJCX0gZWxzZSBpZiAoIC9eKHN3KSQvLnRlc3QoIGEgKSApIHsNCgkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOw0KCQkJdGhhdC5zaXplLmhlaWdodCA9IG5ld0hlaWdodDsNCgkJCXRoYXQucG9zaXRpb24ubGVmdCA9IG9wLmxlZnQgLSBveDsNCgkJfSBlbHNlIHsNCgkJCWlmICggbmV3SGVpZ2h0IC0gZ3JpZFkgPD0gMCB8fCBuZXdXaWR0aCAtIGdyaWRYIDw9IDAgKSB7DQoJCQkJb3V0ZXJEaW1lbnNpb25zID0gdGhhdC5fZ2V0UGFkZGluZ1BsdXNCb3JkZXJEaW1lbnNpb25zKCB0aGlzICk7DQoJCQl9DQoNCgkJCWlmICggbmV3SGVpZ2h0IC0gZ3JpZFkgPiAwICkgew0KCQkJCXRoYXQuc2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7DQoJCQkJdGhhdC5wb3NpdGlvbi50b3AgPSBvcC50b3AgLSBveTsNCgkJCX0gZWxzZSB7DQoJCQkJbmV3SGVpZ2h0ID0gZ3JpZFkgLSBvdXRlckRpbWVuc2lvbnMuaGVpZ2h0Ow0KCQkJCXRoYXQuc2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7DQoJCQkJdGhhdC5wb3NpdGlvbi50b3AgPSBvcC50b3AgKyBvcy5oZWlnaHQgLSBuZXdIZWlnaHQ7DQoJCQl9DQoJCQlpZiAoIG5ld1dpZHRoIC0gZ3JpZFggPiAwICkgew0KCQkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOw0KCQkJCXRoYXQucG9zaXRpb24ubGVmdCA9IG9wLmxlZnQgLSBveDsNCgkJCX0gZWxzZSB7DQoJCQkJbmV3V2lkdGggPSBncmlkWCAtIG91dGVyRGltZW5zaW9ucy53aWR0aDsNCgkJCQl0aGF0LnNpemUud2lkdGggPSBuZXdXaWR0aDsNCgkJCQl0aGF0LnBvc2l0aW9uLmxlZnQgPSBvcC5sZWZ0ICsgb3Mud2lkdGggLSBuZXdXaWR0aDsNCgkJCX0NCgkJfQ0KCX0NCg0KfSApOw0KDQp2YXIgd2lkZ2V0c1Jlc2l6YWJsZSA9ICQudWkucmVzaXphYmxlOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIERpYWxvZyAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogRGlhbG9nDQovLz4+Z3JvdXA6IFdpZGdldHMNCi8vPj5kZXNjcmlwdGlvbjogRGlzcGxheXMgY3VzdG9taXphYmxlIGRpYWxvZyB3aW5kb3dzLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2RpYWxvZy8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9kaWFsb2cvDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MNCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9kaWFsb2cuY3NzDQovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MNCg0KDQoNCiQud2lkZ2V0KCAidWkuZGlhbG9nIiwgew0KCXZlcnNpb246ICIxLjEyLjEiLA0KCW9wdGlvbnM6IHsNCgkJYXBwZW5kVG86ICJib2R5IiwNCgkJYXV0b09wZW46IHRydWUsDQoJCWJ1dHRvbnM6IFtdLA0KCQljbGFzc2VzOiB7DQoJCQkidWktZGlhbG9nIjogInVpLWNvcm5lci1hbGwiLA0KCQkJInVpLWRpYWxvZy10aXRsZWJhciI6ICJ1aS1jb3JuZXItYWxsIg0KCQl9LA0KCQljbG9zZU9uRXNjYXBlOiB0cnVlLA0KCQljbG9zZVRleHQ6ICJDbG9zZSIsDQoJCWRyYWdnYWJsZTogdHJ1ZSwNCgkJaGlkZTogbnVsbCwNCgkJaGVpZ2h0OiAiYXV0byIsDQoJCW1heEhlaWdodDogbnVsbCwNCgkJbWF4V2lkdGg6IG51bGwsDQoJCW1pbkhlaWdodDogMTUwLA0KCQltaW5XaWR0aDogMTUwLA0KCQltb2RhbDogZmFsc2UsDQoJCXBvc2l0aW9uOiB7DQoJCQlteTogImNlbnRlciIsDQoJCQlhdDogImNlbnRlciIsDQoJCQlvZjogd2luZG93LA0KCQkJY29sbGlzaW9uOiAiZml0IiwNCg0KCQkJLy8gRW5zdXJlIHRoZSB0aXRsZWJhciBpcyBhbHdheXMgdmlzaWJsZQ0KCQkJdXNpbmc6IGZ1bmN0aW9uKCBwb3MgKSB7DQoJCQkJdmFyIHRvcE9mZnNldCA9ICQoIHRoaXMgKS5jc3MoIHBvcyApLm9mZnNldCgpLnRvcDsNCgkJCQlpZiAoIHRvcE9mZnNldCA8IDAgKSB7DQoJCQkJCSQoIHRoaXMgKS5jc3MoICJ0b3AiLCBwb3MudG9wIC0gdG9wT2Zmc2V0ICk7DQoJCQkJfQ0KCQkJfQ0KCQl9LA0KCQlyZXNpemFibGU6IHRydWUsDQoJCXNob3c6IG51bGwsDQoJCXRpdGxlOiBudWxsLA0KCQl3aWR0aDogMzAwLA0KDQoJCS8vIENhbGxiYWNrcw0KCQliZWZvcmVDbG9zZTogbnVsbCwNCgkJY2xvc2U6IG51bGwsDQoJCWRyYWc6IG51bGwsDQoJCWRyYWdTdGFydDogbnVsbCwNCgkJZHJhZ1N0b3A6IG51bGwsDQoJCWZvY3VzOiBudWxsLA0KCQlvcGVuOiBudWxsLA0KCQlyZXNpemU6IG51bGwsDQoJCXJlc2l6ZVN0YXJ0OiBudWxsLA0KCQlyZXNpemVTdG9wOiBudWxsDQoJfSwNCg0KCXNpemVSZWxhdGVkT3B0aW9uczogew0KCQlidXR0b25zOiB0cnVlLA0KCQloZWlnaHQ6IHRydWUsDQoJCW1heEhlaWdodDogdHJ1ZSwNCgkJbWF4V2lkdGg6IHRydWUsDQoJCW1pbkhlaWdodDogdHJ1ZSwNCgkJbWluV2lkdGg6IHRydWUsDQoJCXdpZHRoOiB0cnVlDQoJfSwNCg0KCXJlc2l6YWJsZVJlbGF0ZWRPcHRpb25zOiB7DQoJCW1heEhlaWdodDogdHJ1ZSwNCgkJbWF4V2lkdGg6IHRydWUsDQoJCW1pbkhlaWdodDogdHJ1ZSwNCgkJbWluV2lkdGg6IHRydWUNCgl9LA0KDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoJCXRoaXMub3JpZ2luYWxDc3MgPSB7DQoJCQlkaXNwbGF5OiB0aGlzLmVsZW1lbnRbIDAgXS5zdHlsZS5kaXNwbGF5LA0KCQkJd2lkdGg6IHRoaXMuZWxlbWVudFsgMCBdLnN0eWxlLndpZHRoLA0KCQkJbWluSGVpZ2h0OiB0aGlzLmVsZW1lbnRbIDAgXS5zdHlsZS5taW5IZWlnaHQsDQoJCQltYXhIZWlnaHQ6IHRoaXMuZWxlbWVudFsgMCBdLnN0eWxlLm1heEhlaWdodCwNCgkJCWhlaWdodDogdGhpcy5lbGVtZW50WyAwIF0uc3R5bGUuaGVpZ2h0DQoJCX07DQoJCXRoaXMub3JpZ2luYWxQb3NpdGlvbiA9IHsNCgkJCXBhcmVudDogdGhpcy5lbGVtZW50LnBhcmVudCgpLA0KCQkJaW5kZXg6IHRoaXMuZWxlbWVudC5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4KCB0aGlzLmVsZW1lbnQgKQ0KCQl9Ow0KCQl0aGlzLm9yaWdpbmFsVGl0bGUgPSB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApOw0KCQlpZiAoIHRoaXMub3B0aW9ucy50aXRsZSA9PSBudWxsICYmIHRoaXMub3JpZ2luYWxUaXRsZSAhPSBudWxsICkgew0KCQkJdGhpcy5vcHRpb25zLnRpdGxlID0gdGhpcy5vcmlnaW5hbFRpdGxlOw0KCQl9DQoNCgkJLy8gRGlhbG9ncyBjYW4ndCBiZSBkaXNhYmxlZA0KCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsNCgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGZhbHNlOw0KCQl9DQoNCgkJdGhpcy5fY3JlYXRlV3JhcHBlcigpOw0KDQoJCXRoaXMuZWxlbWVudA0KCQkJLnNob3coKQ0KCQkJLnJlbW92ZUF0dHIoICJ0aXRsZSIgKQ0KCQkJLmFwcGVuZFRvKCB0aGlzLnVpRGlhbG9nICk7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1kaWFsb2ctY29udGVudCIsICJ1aS13aWRnZXQtY29udGVudCIgKTsNCg0KCQl0aGlzLl9jcmVhdGVUaXRsZWJhcigpOw0KCQl0aGlzLl9jcmVhdGVCdXR0b25QYW5lKCk7DQoNCgkJaWYgKCB0aGlzLm9wdGlvbnMuZHJhZ2dhYmxlICYmICQuZm4uZHJhZ2dhYmxlICkgew0KCQkJdGhpcy5fbWFrZURyYWdnYWJsZSgpOw0KCQl9DQoJCWlmICggdGhpcy5vcHRpb25zLnJlc2l6YWJsZSAmJiAkLmZuLnJlc2l6YWJsZSApIHsNCgkJCXRoaXMuX21ha2VSZXNpemFibGUoKTsNCgkJfQ0KDQoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOw0KDQoJCXRoaXMuX3RyYWNrRm9jdXMoKTsNCgl9LA0KDQoJX2luaXQ6IGZ1bmN0aW9uKCkgew0KCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvT3BlbiApIHsNCgkJCXRoaXMub3BlbigpOw0KCQl9DQoJfSwNCg0KCV9hcHBlbmRUbzogZnVuY3Rpb24oKSB7DQoJCXZhciBlbGVtZW50ID0gdGhpcy5vcHRpb25zLmFwcGVuZFRvOw0KCQlpZiAoIGVsZW1lbnQgJiYgKCBlbGVtZW50LmpxdWVyeSB8fCBlbGVtZW50Lm5vZGVUeXBlICkgKSB7DQoJCQlyZXR1cm4gJCggZWxlbWVudCApOw0KCQl9DQoJCXJldHVybiB0aGlzLmRvY3VtZW50LmZpbmQoIGVsZW1lbnQgfHwgImJvZHkiICkuZXEoIDAgKTsNCgl9LA0KDQoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgew0KCQl2YXIgbmV4dCwNCgkJCW9yaWdpbmFsUG9zaXRpb24gPSB0aGlzLm9yaWdpbmFsUG9zaXRpb247DQoNCgkJdGhpcy5fdW50cmFja0luc3RhbmNlKCk7DQoJCXRoaXMuX2Rlc3Ryb3lPdmVybGF5KCk7DQoNCgkJdGhpcy5lbGVtZW50DQoJCQkucmVtb3ZlVW5pcXVlSWQoKQ0KCQkJLmNzcyggdGhpcy5vcmlnaW5hbENzcyApDQoNCgkJCS8vIFdpdGhvdXQgZGV0YWNoaW5nIGZpcnN0LCB0aGUgZm9sbG93aW5nIGJlY29tZXMgcmVhbGx5IHNsb3cNCgkJCS5kZXRhY2goKTsNCg0KCQl0aGlzLnVpRGlhbG9nLnJlbW92ZSgpOw0KDQoJCWlmICggdGhpcy5vcmlnaW5hbFRpdGxlICkgew0KCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIsIHRoaXMub3JpZ2luYWxUaXRsZSApOw0KCQl9DQoNCgkJbmV4dCA9IG9yaWdpbmFsUG9zaXRpb24ucGFyZW50LmNoaWxkcmVuKCkuZXEoIG9yaWdpbmFsUG9zaXRpb24uaW5kZXggKTsNCg0KCQkvLyBEb24ndCB0cnkgdG8gcGxhY2UgdGhlIGRpYWxvZyBuZXh0IHRvIGl0c2VsZiAoIzg2MTMpDQoJCWlmICggbmV4dC5sZW5ndGggJiYgbmV4dFsgMCBdICE9PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsNCgkJCW5leHQuYmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsNCgkJfSBlbHNlIHsNCgkJCW9yaWdpbmFsUG9zaXRpb24ucGFyZW50LmFwcGVuZCggdGhpcy5lbGVtZW50ICk7DQoJCX0NCgl9LA0KDQoJd2lkZ2V0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMudWlEaWFsb2c7DQoJfSwNCg0KCWRpc2FibGU6ICQubm9vcCwNCgllbmFibGU6ICQubm9vcCwNCg0KCWNsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCg0KCQlpZiAoICF0aGlzLl9pc09wZW4gfHwgdGhpcy5fdHJpZ2dlciggImJlZm9yZUNsb3NlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsNCgkJdGhpcy5fZm9jdXNlZEVsZW1lbnQgPSBudWxsOw0KCQl0aGlzLl9kZXN0cm95T3ZlcmxheSgpOw0KCQl0aGlzLl91bnRyYWNrSW5zdGFuY2UoKTsNCg0KCQlpZiAoICF0aGlzLm9wZW5lci5maWx0ZXIoICI6Zm9jdXNhYmxlIiApLnRyaWdnZXIoICJmb2N1cyIgKS5sZW5ndGggKSB7DQoNCgkJCS8vIEhpZGluZyBhIGZvY3VzZWQgZWxlbWVudCBkb2Vzbid0IHRyaWdnZXIgYmx1ciBpbiBXZWJLaXQNCgkJCS8vIHNvIGluIGNhc2Ugd2UgaGF2ZSBub3RoaW5nIHRvIGZvY3VzIG9uLCBleHBsaWNpdGx5IGJsdXIgdGhlIGFjdGl2ZSBlbGVtZW50DQoJCQkvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k\/aWQ9NDcxODINCgkJCSQudWkuc2FmZUJsdXIoICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICk7DQoJCX0NCg0KCQl0aGlzLl9oaWRlKCB0aGlzLnVpRGlhbG9nLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7DQoJCQl0aGF0Ll90cmlnZ2VyKCAiY2xvc2UiLCBldmVudCApOw0KCQl9ICk7DQoJfSwNCg0KCWlzT3BlbjogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLl9pc09wZW47DQoJfSwNCg0KCW1vdmVUb1RvcDogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX21vdmVUb1RvcCgpOw0KCX0sDQoNCglfbW92ZVRvVG9wOiBmdW5jdGlvbiggZXZlbnQsIHNpbGVudCApIHsNCgkJdmFyIG1vdmVkID0gZmFsc2UsDQoJCQl6SW5kaWNlcyA9IHRoaXMudWlEaWFsb2cuc2libGluZ3MoICIudWktZnJvbnQ6dmlzaWJsZSIgKS5tYXAoIGZ1bmN0aW9uKCkgew0KCQkJCXJldHVybiArJCggdGhpcyApLmNzcyggInotaW5kZXgiICk7DQoJCQl9ICkuZ2V0KCksDQoJCQl6SW5kZXhNYXggPSBNYXRoLm1heC5hcHBseSggbnVsbCwgekluZGljZXMgKTsNCg0KCQlpZiAoIHpJbmRleE1heCA+PSArdGhpcy51aURpYWxvZy5jc3MoICJ6LWluZGV4IiApICkgew0KCQkJdGhpcy51aURpYWxvZy5jc3MoICJ6LWluZGV4IiwgekluZGV4TWF4ICsgMSApOw0KCQkJbW92ZWQgPSB0cnVlOw0KCQl9DQoNCgkJaWYgKCBtb3ZlZCAmJiAhc2lsZW50ICkgew0KCQkJdGhpcy5fdHJpZ2dlciggImZvY3VzIiwgZXZlbnQgKTsNCgkJfQ0KCQlyZXR1cm4gbW92ZWQ7DQoJfSwNCg0KCW9wZW46IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9IHRoaXM7DQoJCWlmICggdGhpcy5faXNPcGVuICkgew0KCQkJaWYgKCB0aGlzLl9tb3ZlVG9Ub3AoKSApIHsNCgkJCQl0aGlzLl9mb2N1c1RhYmJhYmxlKCk7DQoJCQl9DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl0aGlzLl9pc09wZW4gPSB0cnVlOw0KCQl0aGlzLm9wZW5lciA9ICQoICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICk7DQoNCgkJdGhpcy5fc2l6ZSgpOw0KCQl0aGlzLl9wb3NpdGlvbigpOw0KCQl0aGlzLl9jcmVhdGVPdmVybGF5KCk7DQoJCXRoaXMuX21vdmVUb1RvcCggbnVsbCwgdHJ1ZSApOw0KDQoJCS8vIEVuc3VyZSB0aGUgb3ZlcmxheSBpcyBtb3ZlZCB0byB0aGUgdG9wIHdpdGggdGhlIGRpYWxvZywgYnV0IG9ubHkgd2hlbg0KCQkvLyBvcGVuaW5nLiBUaGUgb3ZlcmxheSBzaG91bGRuJ3QgbW92ZSBhZnRlciB0aGUgZGlhbG9nIGlzIG9wZW4gc28gdGhhdA0KCQkvLyBtb2RlbGVzcyBkaWFsb2dzIG9wZW5lZCBhZnRlciB0aGUgbW9kYWwgZGlhbG9nIHN0YWNrIHByb3Blcmx5Lg0KCQlpZiAoIHRoaXMub3ZlcmxheSApIHsNCgkJCXRoaXMub3ZlcmxheS5jc3MoICJ6LWluZGV4IiwgdGhpcy51aURpYWxvZy5jc3MoICJ6LWluZGV4IiApIC0gMSApOw0KCQl9DQoNCgkJdGhpcy5fc2hvdyggdGhpcy51aURpYWxvZywgdGhpcy5vcHRpb25zLnNob3csIGZ1bmN0aW9uKCkgew0KCQkJdGhhdC5fZm9jdXNUYWJiYWJsZSgpOw0KCQkJdGhhdC5fdHJpZ2dlciggImZvY3VzIiApOw0KCQl9ICk7DQoNCgkJLy8gVHJhY2sgdGhlIGRpYWxvZyBpbW1lZGlhdGVseSB1cG9uIG9wZW5lbmluZyBpbiBjYXNlIGEgZm9jdXMgZXZlbnQNCgkJLy8gc29tZWhvdyBvY2N1cnMgb3V0c2lkZSBvZiB0aGUgZGlhbG9nIGJlZm9yZSBhbiBlbGVtZW50IGluc2lkZSB0aGUNCgkJLy8gZGlhbG9nIGlzIGZvY3VzZWQgKCMxMDE1MikNCgkJdGhpcy5fbWFrZUZvY3VzVGFyZ2V0KCk7DQoNCgkJdGhpcy5fdHJpZ2dlciggIm9wZW4iICk7DQoJfSwNCg0KCV9mb2N1c1RhYmJhYmxlOiBmdW5jdGlvbigpIHsNCg0KCQkvLyBTZXQgZm9jdXMgdG8gdGhlIGZpcnN0IG1hdGNoOg0KCQkvLyAxLiBBbiBlbGVtZW50IHRoYXQgd2FzIGZvY3VzZWQgcHJldmlvdXNseQ0KCQkvLyAyLiBGaXJzdCBlbGVtZW50IGluc2lkZSB0aGUgZGlhbG9nIG1hdGNoaW5nIFthdXRvZm9jdXNdDQoJCS8vIDMuIFRhYmJhYmxlIGVsZW1lbnQgaW5zaWRlIHRoZSBjb250ZW50IGVsZW1lbnQNCgkJLy8gNC4gVGFiYmFibGUgZWxlbWVudCBpbnNpZGUgdGhlIGJ1dHRvbnBhbmUNCgkJLy8gNS4gVGhlIGNsb3NlIGJ1dHRvbg0KCQkvLyA2LiBUaGUgZGlhbG9nIGl0c2VsZg0KCQl2YXIgaGFzRm9jdXMgPSB0aGlzLl9mb2N1c2VkRWxlbWVudDsNCgkJaWYgKCAhaGFzRm9jdXMgKSB7DQoJCQloYXNGb2N1cyA9IHRoaXMuZWxlbWVudC5maW5kKCAiW2F1dG9mb2N1c10iICk7DQoJCX0NCgkJaWYgKCAhaGFzRm9jdXMubGVuZ3RoICkgew0KCQkJaGFzRm9jdXMgPSB0aGlzLmVsZW1lbnQuZmluZCggIjp0YWJiYWJsZSIgKTsNCgkJfQ0KCQlpZiAoICFoYXNGb2N1cy5sZW5ndGggKSB7DQoJCQloYXNGb2N1cyA9IHRoaXMudWlEaWFsb2dCdXR0b25QYW5lLmZpbmQoICI6dGFiYmFibGUiICk7DQoJCX0NCgkJaWYgKCAhaGFzRm9jdXMubGVuZ3RoICkgew0KCQkJaGFzRm9jdXMgPSB0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZS5maWx0ZXIoICI6dGFiYmFibGUiICk7DQoJCX0NCgkJaWYgKCAhaGFzRm9jdXMubGVuZ3RoICkgew0KCQkJaGFzRm9jdXMgPSB0aGlzLnVpRGlhbG9nOw0KCQl9DQoJCWhhc0ZvY3VzLmVxKCAwICkudHJpZ2dlciggImZvY3VzIiApOw0KCX0sDQoNCglfa2VlcEZvY3VzOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCWZ1bmN0aW9uIGNoZWNrRm9jdXMoKSB7DQoJCQl2YXIgYWN0aXZlRWxlbWVudCA9ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApLA0KCQkJCWlzQWN0aXZlID0gdGhpcy51aURpYWxvZ1sgMCBdID09PSBhY3RpdmVFbGVtZW50IHx8DQoJCQkJCSQuY29udGFpbnMoIHRoaXMudWlEaWFsb2dbIDAgXSwgYWN0aXZlRWxlbWVudCApOw0KCQkJaWYgKCAhaXNBY3RpdmUgKSB7DQoJCQkJdGhpcy5fZm9jdXNUYWJiYWJsZSgpOw0KCQkJfQ0KCQl9DQoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCWNoZWNrRm9jdXMuY2FsbCggdGhpcyApOw0KDQoJCS8vIHN1cHBvcnQ6IElFDQoJCS8vIElFIDw9IDggZG9lc24ndCBwcmV2ZW50IG1vdmluZyBmb2N1cyBldmVuIHdpdGggZXZlbnQucHJldmVudERlZmF1bHQoKQ0KCQkvLyBzbyB3ZSBjaGVjayBhZ2FpbiBsYXRlcg0KCQl0aGlzLl9kZWxheSggY2hlY2tGb2N1cyApOw0KCX0sDQoNCglfY3JlYXRlV3JhcHBlcjogZnVuY3Rpb24oKSB7DQoJCXRoaXMudWlEaWFsb2cgPSAkKCAiPGRpdj4iICkNCgkJCS5oaWRlKCkNCgkJCS5hdHRyKCB7DQoNCgkJCQkvLyBTZXR0aW5nIHRhYkluZGV4IG1ha2VzIHRoZSBkaXYgZm9jdXNhYmxlDQoJCQkJdGFiSW5kZXg6IC0xLA0KCQkJCXJvbGU6ICJkaWFsb2ciDQoJCQl9ICkNCgkJCS5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOw0KDQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpRGlhbG9nLCAidWktZGlhbG9nIiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1mcm9udCIgKTsNCgkJdGhpcy5fb24oIHRoaXMudWlEaWFsb2csIHsNCgkJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlpZiAoIHRoaXMub3B0aW9ucy5jbG9zZU9uRXNjYXBlICYmICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSAmJiBldmVudC5rZXlDb2RlICYmDQoJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuRVNDQVBFICkgew0KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJCQl0aGlzLmNsb3NlKCBldmVudCApOw0KCQkJCQlyZXR1cm47DQoJCQkJfQ0KDQoJCQkJLy8gUHJldmVudCB0YWJiaW5nIG91dCBvZiBkaWFsb2dzDQoJCQkJaWYgKCBldmVudC5rZXlDb2RlICE9PSAkLnVpLmtleUNvZGUuVEFCIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgew0KCQkJCQlyZXR1cm47DQoJCQkJfQ0KCQkJCXZhciB0YWJiYWJsZXMgPSB0aGlzLnVpRGlhbG9nLmZpbmQoICI6dGFiYmFibGUiICksDQoJCQkJCWZpcnN0ID0gdGFiYmFibGVzLmZpbHRlciggIjpmaXJzdCIgKSwNCgkJCQkJbGFzdCA9IHRhYmJhYmxlcy5maWx0ZXIoICI6bGFzdCIgKTsNCg0KCQkJCWlmICggKCBldmVudC50YXJnZXQgPT09IGxhc3RbIDAgXSB8fCBldmVudC50YXJnZXQgPT09IHRoaXMudWlEaWFsb2dbIDAgXSApICYmDQoJCQkJCQkhZXZlbnQuc2hpZnRLZXkgKSB7DQoJCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsNCgkJCQkJCWZpcnN0LnRyaWdnZXIoICJmb2N1cyIgKTsNCgkJCQkJfSApOw0KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJCX0gZWxzZSBpZiAoICggZXZlbnQudGFyZ2V0ID09PSBmaXJzdFsgMCBdIHx8DQoJCQkJCQlldmVudC50YXJnZXQgPT09IHRoaXMudWlEaWFsb2dbIDAgXSApICYmIGV2ZW50LnNoaWZ0S2V5ICkgew0KCQkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoJCQkJCQlsYXN0LnRyaWdnZXIoICJmb2N1cyIgKTsNCgkJCQkJfSApOw0KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJCX0NCgkJCX0sDQoJCQltb3VzZWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlpZiAoIHRoaXMuX21vdmVUb1RvcCggZXZlbnQgKSApIHsNCgkJCQkJdGhpcy5fZm9jdXNUYWJiYWJsZSgpOw0KCQkJCX0NCgkJCX0NCgkJfSApOw0KDQoJCS8vIFdlIGFzc3VtZSB0aGF0IGFueSBleGlzdGluZyBhcmlhLWRlc2NyaWJlZGJ5IGF0dHJpYnV0ZSBtZWFucw0KCQkvLyB0aGF0IHRoZSBkaWFsb2cgY29udGVudCBpcyBtYXJrZWQgdXAgcHJvcGVybHkNCgkJLy8gb3RoZXJ3aXNlIHdlIGJydXRlIGZvcmNlIHRoZSBjb250ZW50IGFzIHRoZSBkZXNjcmlwdGlvbg0KCQlpZiAoICF0aGlzLmVsZW1lbnQuZmluZCggIlthcmlhLWRlc2NyaWJlZGJ5XSIgKS5sZW5ndGggKSB7DQoJCQl0aGlzLnVpRGlhbG9nLmF0dHIoIHsNCgkJCQkiYXJpYS1kZXNjcmliZWRieSI6IHRoaXMuZWxlbWVudC51bmlxdWVJZCgpLmF0dHIoICJpZCIgKQ0KCQkJfSApOw0KCQl9DQoJfSwNCg0KCV9jcmVhdGVUaXRsZWJhcjogZnVuY3Rpb24oKSB7DQoJCXZhciB1aURpYWxvZ1RpdGxlOw0KDQoJCXRoaXMudWlEaWFsb2dUaXRsZWJhciA9ICQoICI8ZGl2PiIgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2dUaXRsZWJhciwNCgkJCSJ1aS1kaWFsb2ctdGl0bGViYXIiLCAidWktd2lkZ2V0LWhlYWRlciB1aS1oZWxwZXItY2xlYXJmaXgiICk7DQoJCXRoaXMuX29uKCB0aGlzLnVpRGlhbG9nVGl0bGViYXIsIHsNCgkJCW1vdXNlZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgew0KDQoJCQkJLy8gRG9uJ3QgcHJldmVudCBjbGljayBvbiBjbG9zZSBidXR0b24gKCM4ODM4KQ0KCQkJCS8vIEZvY3VzaW5nIGEgZGlhbG9nIHRoYXQgaXMgcGFydGlhbGx5IHNjcm9sbGVkIG91dCBvZiB2aWV3DQoJCQkJLy8gY2F1c2VzIHRoZSBicm93c2VyIHRvIHNjcm9sbCBpdCBpbnRvIHZpZXcsIHByZXZlbnRpbmcgdGhlIGNsaWNrIGV2ZW50DQoJCQkJaWYgKCAhJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1kaWFsb2ctdGl0bGViYXItY2xvc2UiICkgKSB7DQoNCgkJCQkJLy8gRGlhbG9nIGlzbid0IGdldHRpbmcgZm9jdXMgd2hlbiBkcmFnZ2luZyAoIzgwNjMpDQoJCQkJCXRoaXMudWlEaWFsb2cudHJpZ2dlciggImZvY3VzIiApOw0KCQkJCX0NCgkJCX0NCgkJfSApOw0KDQoJCS8vIFN1cHBvcnQ6IElFDQoJCS8vIFVzZSB0eXBlPSJidXR0b24iIHRvIHByZXZlbnQgZW50ZXIga2V5cHJlc3NlcyBpbiB0ZXh0Ym94ZXMgZnJvbSBjbG9zaW5nIHRoZQ0KCQkvLyBkaWFsb2cgaW4gSUUgKCM5MzEyKQ0KCQl0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZSA9ICQoICI8YnV0dG9uIHR5cGU9J2J1dHRvbic+PC9idXR0b24+IiApDQoJCQkuYnV0dG9uKCB7DQoJCQkJbGFiZWw6ICQoICI8YT4iICkudGV4dCggdGhpcy5vcHRpb25zLmNsb3NlVGV4dCApLmh0bWwoKSwNCgkJCQlpY29uOiAidWktaWNvbi1jbG9zZXRoaWNrIiwNCgkJCQlzaG93TGFiZWw6IGZhbHNlDQoJCQl9ICkNCgkJCS5hcHBlbmRUbyggdGhpcy51aURpYWxvZ1RpdGxlYmFyICk7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2dUaXRsZWJhckNsb3NlLCAidWktZGlhbG9nLXRpdGxlYmFyLWNsb3NlIiApOw0KCQl0aGlzLl9vbiggdGhpcy51aURpYWxvZ1RpdGxlYmFyQ2xvc2UsIHsNCgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCQl0aGlzLmNsb3NlKCBldmVudCApOw0KCQkJfQ0KCQl9ICk7DQoNCgkJdWlEaWFsb2dUaXRsZSA9ICQoICI8c3Bhbj4iICkudW5pcXVlSWQoKS5wcmVwZW5kVG8oIHRoaXMudWlEaWFsb2dUaXRsZWJhciApOw0KCQl0aGlzLl9hZGRDbGFzcyggdWlEaWFsb2dUaXRsZSwgInVpLWRpYWxvZy10aXRsZSIgKTsNCgkJdGhpcy5fdGl0bGUoIHVpRGlhbG9nVGl0bGUgKTsNCg0KCQl0aGlzLnVpRGlhbG9nVGl0bGViYXIucHJlcGVuZFRvKCB0aGlzLnVpRGlhbG9nICk7DQoNCgkJdGhpcy51aURpYWxvZy5hdHRyKCB7DQoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogdWlEaWFsb2dUaXRsZS5hdHRyKCAiaWQiICkNCgkJfSApOw0KCX0sDQoNCglfdGl0bGU6IGZ1bmN0aW9uKCB0aXRsZSApIHsNCgkJaWYgKCB0aGlzLm9wdGlvbnMudGl0bGUgKSB7DQoJCQl0aXRsZS50ZXh0KCB0aGlzLm9wdGlvbnMudGl0bGUgKTsNCgkJfSBlbHNlIHsNCgkJCXRpdGxlLmh0bWwoICImIzE2MDsiICk7DQoJCX0NCgl9LA0KDQoJX2NyZWF0ZUJ1dHRvblBhbmU6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZSA9ICQoICI8ZGl2PiIgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2dCdXR0b25QYW5lLCAidWktZGlhbG9nLWJ1dHRvbnBhbmUiLA0KCQkJInVpLXdpZGdldC1jb250ZW50IHVpLWhlbHBlci1jbGVhcmZpeCIgKTsNCg0KCQl0aGlzLnVpQnV0dG9uU2V0ID0gJCggIjxkaXY+IiApDQoJCQkuYXBwZW5kVG8oIHRoaXMudWlEaWFsb2dCdXR0b25QYW5lICk7DQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpQnV0dG9uU2V0LCAidWktZGlhbG9nLWJ1dHRvbnNldCIgKTsNCg0KCQl0aGlzLl9jcmVhdGVCdXR0b25zKCk7DQoJfSwNCg0KCV9jcmVhdGVCdXR0b25zOiBmdW5jdGlvbigpIHsNCgkJdmFyIHRoYXQgPSB0aGlzLA0KCQkJYnV0dG9ucyA9IHRoaXMub3B0aW9ucy5idXR0b25zOw0KDQoJCS8vIElmIHdlIGFscmVhZHkgaGF2ZSBhIGJ1dHRvbiBwYW5lLCByZW1vdmUgaXQNCgkJdGhpcy51aURpYWxvZ0J1dHRvblBhbmUucmVtb3ZlKCk7DQoJCXRoaXMudWlCdXR0b25TZXQuZW1wdHkoKTsNCg0KCQlpZiAoICQuaXNFbXB0eU9iamVjdCggYnV0dG9ucyApIHx8ICggJC5pc0FycmF5KCBidXR0b25zICkgJiYgIWJ1dHRvbnMubGVuZ3RoICkgKSB7DQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy51aURpYWxvZywgInVpLWRpYWxvZy1idXR0b25zIiApOw0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJJC5lYWNoKCBidXR0b25zLCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7DQoJCQl2YXIgY2xpY2ssIGJ1dHRvbk9wdGlvbnM7DQoJCQlwcm9wcyA9ICQuaXNGdW5jdGlvbiggcHJvcHMgKSA\/DQoJCQkJeyBjbGljazogcHJvcHMsIHRleHQ6IG5hbWUgfSA6DQoJCQkJcHJvcHM7DQoNCgkJCS8vIERlZmF1bHQgdG8gYSBub24tc3VibWl0dGluZyBidXR0b24NCgkJCXByb3BzID0gJC5leHRlbmQoIHsgdHlwZTogImJ1dHRvbiIgfSwgcHJvcHMgKTsNCg0KCQkJLy8gQ2hhbmdlIHRoZSBjb250ZXh0IGZvciB0aGUgY2xpY2sgY2FsbGJhY2sgdG8gYmUgdGhlIG1haW4gZWxlbWVudA0KCQkJY2xpY2sgPSBwcm9wcy5jbGljazsNCgkJCWJ1dHRvbk9wdGlvbnMgPSB7DQoJCQkJaWNvbjogcHJvcHMuaWNvbiwNCgkJCQlpY29uUG9zaXRpb246IHByb3BzLmljb25Qb3NpdGlvbiwNCgkJCQlzaG93TGFiZWw6IHByb3BzLnNob3dMYWJlbCwNCg0KCQkJCS8vIERlcHJlY2F0ZWQgb3B0aW9ucw0KCQkJCWljb25zOiBwcm9wcy5pY29ucywNCgkJCQl0ZXh0OiBwcm9wcy50ZXh0DQoJCQl9Ow0KDQoJCQlkZWxldGUgcHJvcHMuY2xpY2s7DQoJCQlkZWxldGUgcHJvcHMuaWNvbjsNCgkJCWRlbGV0ZSBwcm9wcy5pY29uUG9zaXRpb247DQoJCQlkZWxldGUgcHJvcHMuc2hvd0xhYmVsOw0KDQoJCQkvLyBEZXByZWNhdGVkIG9wdGlvbnMNCgkJCWRlbGV0ZSBwcm9wcy5pY29uczsNCgkJCWlmICggdHlwZW9mIHByb3BzLnRleHQgPT09ICJib29sZWFuIiApIHsNCgkJCQlkZWxldGUgcHJvcHMudGV4dDsNCgkJCX0NCg0KCQkJJCggIjxidXR0b24+PC9idXR0b24+IiwgcHJvcHMgKQ0KCQkJCS5idXR0b24oIGJ1dHRvbk9wdGlvbnMgKQ0KCQkJCS5hcHBlbmRUbyggdGhhdC51aUJ1dHRvblNldCApDQoJCQkJLm9uKCAiY2xpY2siLCBmdW5jdGlvbigpIHsNCgkJCQkJY2xpY2suYXBwbHkoIHRoYXQuZWxlbWVudFsgMCBdLCBhcmd1bWVudHMgKTsNCgkJCQl9ICk7DQoJCX0gKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2csICJ1aS1kaWFsb2ctYnV0dG9ucyIgKTsNCgkJdGhpcy51aURpYWxvZ0J1dHRvblBhbmUuYXBwZW5kVG8oIHRoaXMudWlEaWFsb2cgKTsNCgl9LA0KDQoJX21ha2VEcmFnZ2FibGU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9IHRoaXMsDQoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOw0KDQoJCWZ1bmN0aW9uIGZpbHRlcmVkVWkoIHVpICkgew0KCQkJcmV0dXJuIHsNCgkJCQlwb3NpdGlvbjogdWkucG9zaXRpb24sDQoJCQkJb2Zmc2V0OiB1aS5vZmZzZXQNCgkJCX07DQoJCX0NCg0KCQl0aGlzLnVpRGlhbG9nLmRyYWdnYWJsZSggew0KCQkJY2FuY2VsOiAiLnVpLWRpYWxvZy1jb250ZW50LCAudWktZGlhbG9nLXRpdGxlYmFyLWNsb3NlIiwNCgkJCWhhbmRsZTogIi51aS1kaWFsb2ctdGl0bGViYXIiLA0KCQkJY29udGFpbm1lbnQ6ICJkb2N1bWVudCIsDQoJCQlzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsNCgkJCQl0aGF0Ll9hZGRDbGFzcyggJCggdGhpcyApLCAidWktZGlhbG9nLWRyYWdnaW5nIiApOw0KCQkJCXRoYXQuX2Jsb2NrRnJhbWVzKCk7DQoJCQkJdGhhdC5fdHJpZ2dlciggImRyYWdTdGFydCIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7DQoJCQl9LA0KCQkJZHJhZzogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsNCgkJCQl0aGF0Ll90cmlnZ2VyKCAiZHJhZyIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7DQoJCQl9LA0KCQkJc3RvcDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsNCgkJCQl2YXIgbGVmdCA9IHVpLm9mZnNldC5sZWZ0IC0gdGhhdC5kb2N1bWVudC5zY3JvbGxMZWZ0KCksDQoJCQkJCXRvcCA9IHVpLm9mZnNldC50b3AgLSB0aGF0LmRvY3VtZW50LnNjcm9sbFRvcCgpOw0KDQoJCQkJb3B0aW9ucy5wb3NpdGlvbiA9IHsNCgkJCQkJbXk6ICJsZWZ0IHRvcCIsDQoJCQkJCWF0OiAibGVmdCIgKyAoIGxlZnQgPj0gMCA\/ICIrIiA6ICIiICkgKyBsZWZ0ICsgIiAiICsNCgkJCQkJCSJ0b3AiICsgKCB0b3AgPj0gMCA\/ICIrIiA6ICIiICkgKyB0b3AsDQoJCQkJCW9mOiB0aGF0LndpbmRvdw0KCQkJCX07DQoJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoICQoIHRoaXMgKSwgInVpLWRpYWxvZy1kcmFnZ2luZyIgKTsNCgkJCQl0aGF0Ll91bmJsb2NrRnJhbWVzKCk7DQoJCQkJdGhhdC5fdHJpZ2dlciggImRyYWdTdG9wIiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfbWFrZVJlc2l6YWJsZTogZnVuY3Rpb24oKSB7DQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsDQoJCQloYW5kbGVzID0gb3B0aW9ucy5yZXNpemFibGUsDQoNCgkJCS8vIC51aS1yZXNpemFibGUgaGFzIHBvc2l0aW9uOiByZWxhdGl2ZSBkZWZpbmVkIGluIHRoZSBzdHlsZXNoZWV0DQoJCQkvLyBidXQgZGlhbG9ncyBoYXZlIHRvIHVzZSBhYnNvbHV0ZSBvciBmaXhlZCBwb3NpdGlvbmluZw0KCQkJcG9zaXRpb24gPSB0aGlzLnVpRGlhbG9nLmNzcyggInBvc2l0aW9uIiApLA0KCQkJcmVzaXplSGFuZGxlcyA9IHR5cGVvZiBoYW5kbGVzID09PSAic3RyaW5nIiA\/DQoJCQkJaGFuZGxlcyA6DQoJCQkJIm4sZSxzLHcsc2Usc3csbmUsbnciOw0KDQoJCWZ1bmN0aW9uIGZpbHRlcmVkVWkoIHVpICkgew0KCQkJcmV0dXJuIHsNCgkJCQlvcmlnaW5hbFBvc2l0aW9uOiB1aS5vcmlnaW5hbFBvc2l0aW9uLA0KCQkJCW9yaWdpbmFsU2l6ZTogdWkub3JpZ2luYWxTaXplLA0KCQkJCXBvc2l0aW9uOiB1aS5wb3NpdGlvbiwNCgkJCQlzaXplOiB1aS5zaXplDQoJCQl9Ow0KCQl9DQoNCgkJdGhpcy51aURpYWxvZy5yZXNpemFibGUoIHsNCgkJCWNhbmNlbDogIi51aS1kaWFsb2ctY29udGVudCIsDQoJCQljb250YWlubWVudDogImRvY3VtZW50IiwNCgkJCWFsc29SZXNpemU6IHRoaXMuZWxlbWVudCwNCgkJCW1heFdpZHRoOiBvcHRpb25zLm1heFdpZHRoLA0KCQkJbWF4SGVpZ2h0OiBvcHRpb25zLm1heEhlaWdodCwNCgkJCW1pbldpZHRoOiBvcHRpb25zLm1pbldpZHRoLA0KCQkJbWluSGVpZ2h0OiB0aGlzLl9taW5IZWlnaHQoKSwNCgkJCWhhbmRsZXM6IHJlc2l6ZUhhbmRsZXMsDQoJCQlzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsNCgkJCQl0aGF0Ll9hZGRDbGFzcyggJCggdGhpcyApLCAidWktZGlhbG9nLXJlc2l6aW5nIiApOw0KCQkJCXRoYXQuX2Jsb2NrRnJhbWVzKCk7DQoJCQkJdGhhdC5fdHJpZ2dlciggInJlc2l6ZVN0YXJ0IiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsNCgkJCX0sDQoJCQlyZXNpemU6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7DQoJCQkJdGhhdC5fdHJpZ2dlciggInJlc2l6ZSIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7DQoJCQl9LA0KCQkJc3RvcDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsNCgkJCQl2YXIgb2Zmc2V0ID0gdGhhdC51aURpYWxvZy5vZmZzZXQoKSwNCgkJCQkJbGVmdCA9IG9mZnNldC5sZWZ0IC0gdGhhdC5kb2N1bWVudC5zY3JvbGxMZWZ0KCksDQoJCQkJCXRvcCA9IG9mZnNldC50b3AgLSB0aGF0LmRvY3VtZW50LnNjcm9sbFRvcCgpOw0KDQoJCQkJb3B0aW9ucy5oZWlnaHQgPSB0aGF0LnVpRGlhbG9nLmhlaWdodCgpOw0KCQkJCW9wdGlvbnMud2lkdGggPSB0aGF0LnVpRGlhbG9nLndpZHRoKCk7DQoJCQkJb3B0aW9ucy5wb3NpdGlvbiA9IHsNCgkJCQkJbXk6ICJsZWZ0IHRvcCIsDQoJCQkJCWF0OiAibGVmdCIgKyAoIGxlZnQgPj0gMCA\/ICIrIiA6ICIiICkgKyBsZWZ0ICsgIiAiICsNCgkJCQkJCSJ0b3AiICsgKCB0b3AgPj0gMCA\/ICIrIiA6ICIiICkgKyB0b3AsDQoJCQkJCW9mOiB0aGF0LndpbmRvdw0KCQkJCX07DQoJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoICQoIHRoaXMgKSwgInVpLWRpYWxvZy1yZXNpemluZyIgKTsNCgkJCQl0aGF0Ll91bmJsb2NrRnJhbWVzKCk7DQoJCQkJdGhhdC5fdHJpZ2dlciggInJlc2l6ZVN0b3AiLCBldmVudCwgZmlsdGVyZWRVaSggdWkgKSApOw0KCQkJfQ0KCQl9ICkNCgkJCS5jc3MoICJwb3NpdGlvbiIsIHBvc2l0aW9uICk7DQoJfSwNCg0KCV90cmFja0ZvY3VzOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fb24oIHRoaXMud2lkZ2V0KCksIHsNCgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQl0aGlzLl9tYWtlRm9jdXNUYXJnZXQoKTsNCgkJCQl0aGlzLl9mb2N1c2VkRWxlbWVudCA9ICQoIGV2ZW50LnRhcmdldCApOw0KCQkJfQ0KCQl9ICk7DQoJfSwNCg0KCV9tYWtlRm9jdXNUYXJnZXQ6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLl91bnRyYWNrSW5zdGFuY2UoKTsNCgkJdGhpcy5fdHJhY2tpbmdJbnN0YW5jZXMoKS51bnNoaWZ0KCB0aGlzICk7DQoJfSwNCg0KCV91bnRyYWNrSW5zdGFuY2U6IGZ1bmN0aW9uKCkgew0KCQl2YXIgaW5zdGFuY2VzID0gdGhpcy5fdHJhY2tpbmdJbnN0YW5jZXMoKSwNCgkJCWV4aXN0cyA9ICQuaW5BcnJheSggdGhpcywgaW5zdGFuY2VzICk7DQoJCWlmICggZXhpc3RzICE9PSAtMSApIHsNCgkJCWluc3RhbmNlcy5zcGxpY2UoIGV4aXN0cywgMSApOw0KCQl9DQoJfSwNCg0KCV90cmFja2luZ0luc3RhbmNlczogZnVuY3Rpb24oKSB7DQoJCXZhciBpbnN0YW5jZXMgPSB0aGlzLmRvY3VtZW50LmRhdGEoICJ1aS1kaWFsb2ctaW5zdGFuY2VzIiApOw0KCQlpZiAoICFpbnN0YW5jZXMgKSB7DQoJCQlpbnN0YW5jZXMgPSBbXTsNCgkJCXRoaXMuZG9jdW1lbnQuZGF0YSggInVpLWRpYWxvZy1pbnN0YW5jZXMiLCBpbnN0YW5jZXMgKTsNCgkJfQ0KCQlyZXR1cm4gaW5zdGFuY2VzOw0KCX0sDQoNCglfbWluSGVpZ2h0OiBmdW5jdGlvbigpIHsNCgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7DQoNCgkJcmV0dXJuIG9wdGlvbnMuaGVpZ2h0ID09PSAiYXV0byIgPw0KCQkJb3B0aW9ucy5taW5IZWlnaHQgOg0KCQkJTWF0aC5taW4oIG9wdGlvbnMubWluSGVpZ2h0LCBvcHRpb25zLmhlaWdodCApOw0KCX0sDQoNCglfcG9zaXRpb246IGZ1bmN0aW9uKCkgew0KDQoJCS8vIE5lZWQgdG8gc2hvdyB0aGUgZGlhbG9nIHRvIGdldCB0aGUgYWN0dWFsIG9mZnNldCBpbiB0aGUgcG9zaXRpb24gcGx1Z2luDQoJCXZhciBpc1Zpc2libGUgPSB0aGlzLnVpRGlhbG9nLmlzKCAiOnZpc2libGUiICk7DQoJCWlmICggIWlzVmlzaWJsZSApIHsNCgkJCXRoaXMudWlEaWFsb2cuc2hvdygpOw0KCQl9DQoJCXRoaXMudWlEaWFsb2cucG9zaXRpb24oIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApOw0KCQlpZiAoICFpc1Zpc2libGUgKSB7DQoJCQl0aGlzLnVpRGlhbG9nLmhpZGUoKTsNCgkJfQ0KCX0sDQoNCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCXJlc2l6ZSA9IGZhbHNlLA0KCQkJcmVzaXphYmxlT3B0aW9ucyA9IHt9Ow0KDQoJCSQuZWFjaCggb3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCQl0aGF0Ll9zZXRPcHRpb24oIGtleSwgdmFsdWUgKTsNCg0KCQkJaWYgKCBrZXkgaW4gdGhhdC5zaXplUmVsYXRlZE9wdGlvbnMgKSB7DQoJCQkJcmVzaXplID0gdHJ1ZTsNCgkJCX0NCgkJCWlmICgga2V5IGluIHRoYXQucmVzaXphYmxlUmVsYXRlZE9wdGlvbnMgKSB7DQoJCQkJcmVzaXphYmxlT3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsNCgkJCX0NCgkJfSApOw0KDQoJCWlmICggcmVzaXplICkgew0KCQkJdGhpcy5fc2l6ZSgpOw0KCQkJdGhpcy5fcG9zaXRpb24oKTsNCgkJfQ0KCQlpZiAoIHRoaXMudWlEaWFsb2cuaXMoICI6ZGF0YSh1aS1yZXNpemFibGUpIiApICkgew0KCQkJdGhpcy51aURpYWxvZy5yZXNpemFibGUoICJvcHRpb24iLCByZXNpemFibGVPcHRpb25zICk7DQoJCX0NCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCXZhciBpc0RyYWdnYWJsZSwgaXNSZXNpemFibGUsDQoJCQl1aURpYWxvZyA9IHRoaXMudWlEaWFsb2c7DQoNCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KDQoJCWlmICgga2V5ID09PSAiYXBwZW5kVG8iICkgew0KCQkJdGhpcy51aURpYWxvZy5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOw0KCQl9DQoNCgkJaWYgKCBrZXkgPT09ICJidXR0b25zIiApIHsNCgkJCXRoaXMuX2NyZWF0ZUJ1dHRvbnMoKTsNCgkJfQ0KDQoJCWlmICgga2V5ID09PSAiY2xvc2VUZXh0IiApIHsNCgkJCXRoaXMudWlEaWFsb2dUaXRsZWJhckNsb3NlLmJ1dHRvbiggew0KDQoJCQkJLy8gRW5zdXJlIHRoYXQgd2UgYWx3YXlzIHBhc3MgYSBzdHJpbmcNCgkJCQlsYWJlbDogJCggIjxhPiIgKS50ZXh0KCAiIiArIHRoaXMub3B0aW9ucy5jbG9zZVRleHQgKS5odG1sKCkNCgkJCX0gKTsNCgkJfQ0KDQoJCWlmICgga2V5ID09PSAiZHJhZ2dhYmxlIiApIHsNCgkJCWlzRHJhZ2dhYmxlID0gdWlEaWFsb2cuaXMoICI6ZGF0YSh1aS1kcmFnZ2FibGUpIiApOw0KCQkJaWYgKCBpc0RyYWdnYWJsZSAmJiAhdmFsdWUgKSB7DQoJCQkJdWlEaWFsb2cuZHJhZ2dhYmxlKCAiZGVzdHJveSIgKTsNCgkJCX0NCg0KCQkJaWYgKCAhaXNEcmFnZ2FibGUgJiYgdmFsdWUgKSB7DQoJCQkJdGhpcy5fbWFrZURyYWdnYWJsZSgpOw0KCQkJfQ0KCQl9DQoNCgkJaWYgKCBrZXkgPT09ICJwb3NpdGlvbiIgKSB7DQoJCQl0aGlzLl9wb3NpdGlvbigpOw0KCQl9DQoNCgkJaWYgKCBrZXkgPT09ICJyZXNpemFibGUiICkgew0KDQoJCQkvLyBjdXJyZW50bHkgcmVzaXphYmxlLCBiZWNvbWluZyBub24tcmVzaXphYmxlDQoJCQlpc1Jlc2l6YWJsZSA9IHVpRGlhbG9nLmlzKCAiOmRhdGEodWktcmVzaXphYmxlKSIgKTsNCgkJCWlmICggaXNSZXNpemFibGUgJiYgIXZhbHVlICkgew0KCQkJCXVpRGlhbG9nLnJlc2l6YWJsZSggImRlc3Ryb3kiICk7DQoJCQl9DQoNCgkJCS8vIEN1cnJlbnRseSByZXNpemFibGUsIGNoYW5naW5nIGhhbmRsZXMNCgkJCWlmICggaXNSZXNpemFibGUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiApIHsNCgkJCQl1aURpYWxvZy5yZXNpemFibGUoICJvcHRpb24iLCAiaGFuZGxlcyIsIHZhbHVlICk7DQoJCQl9DQoNCgkJCS8vIEN1cnJlbnRseSBub24tcmVzaXphYmxlLCBiZWNvbWluZyByZXNpemFibGUNCgkJCWlmICggIWlzUmVzaXphYmxlICYmIHZhbHVlICE9PSBmYWxzZSApIHsNCgkJCQl0aGlzLl9tYWtlUmVzaXphYmxlKCk7DQoJCQl9DQoJCX0NCg0KCQlpZiAoIGtleSA9PT0gInRpdGxlIiApIHsNCgkJCXRoaXMuX3RpdGxlKCB0aGlzLnVpRGlhbG9nVGl0bGViYXIuZmluZCggIi51aS1kaWFsb2ctdGl0bGUiICkgKTsNCgkJfQ0KCX0sDQoNCglfc2l6ZTogZnVuY3Rpb24oKSB7DQoNCgkJLy8gSWYgdGhlIHVzZXIgaGFzIHJlc2l6ZWQgdGhlIGRpYWxvZywgdGhlIC51aS1kaWFsb2cgYW5kIC51aS1kaWFsb2ctY29udGVudA0KCQkvLyBkaXZzIHdpbGwgYm90aCBoYXZlIHdpZHRoIGFuZCBoZWlnaHQgc2V0LCBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZW0NCgkJdmFyIG5vbkNvbnRlbnRIZWlnaHQsIG1pbkNvbnRlbnRIZWlnaHQsIG1heENvbnRlbnRIZWlnaHQsDQoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOw0KDQoJCS8vIFJlc2V0IGNvbnRlbnQgc2l6aW5nDQoJCXRoaXMuZWxlbWVudC5zaG93KCkuY3NzKCB7DQoJCQl3aWR0aDogImF1dG8iLA0KCQkJbWluSGVpZ2h0OiAwLA0KCQkJbWF4SGVpZ2h0OiAibm9uZSIsDQoJCQloZWlnaHQ6IDANCgkJfSApOw0KDQoJCWlmICggb3B0aW9ucy5taW5XaWR0aCA+IG9wdGlvbnMud2lkdGggKSB7DQoJCQlvcHRpb25zLndpZHRoID0gb3B0aW9ucy5taW5XaWR0aDsNCgkJfQ0KDQoJCS8vIFJlc2V0IHdyYXBwZXIgc2l6aW5nDQoJCS8vIGRldGVybWluZSB0aGUgaGVpZ2h0IG9mIGFsbCB0aGUgbm9uLWNvbnRlbnQgZWxlbWVudHMNCgkJbm9uQ29udGVudEhlaWdodCA9IHRoaXMudWlEaWFsb2cuY3NzKCB7DQoJCQloZWlnaHQ6ICJhdXRvIiwNCgkJCXdpZHRoOiBvcHRpb25zLndpZHRoDQoJCX0gKQ0KCQkJLm91dGVySGVpZ2h0KCk7DQoJCW1pbkNvbnRlbnRIZWlnaHQgPSBNYXRoLm1heCggMCwgb3B0aW9ucy5taW5IZWlnaHQgLSBub25Db250ZW50SGVpZ2h0ICk7DQoJCW1heENvbnRlbnRIZWlnaHQgPSB0eXBlb2Ygb3B0aW9ucy5tYXhIZWlnaHQgPT09ICJudW1iZXIiID8NCgkJCU1hdGgubWF4KCAwLCBvcHRpb25zLm1heEhlaWdodCAtIG5vbkNvbnRlbnRIZWlnaHQgKSA6DQoJCQkibm9uZSI7DQoNCgkJaWYgKCBvcHRpb25zLmhlaWdodCA9PT0gImF1dG8iICkgew0KCQkJdGhpcy5lbGVtZW50LmNzcyggew0KCQkJCW1pbkhlaWdodDogbWluQ29udGVudEhlaWdodCwNCgkJCQltYXhIZWlnaHQ6IG1heENvbnRlbnRIZWlnaHQsDQoJCQkJaGVpZ2h0OiAiYXV0byINCgkJCX0gKTsNCgkJfSBlbHNlIHsNCgkJCXRoaXMuZWxlbWVudC5oZWlnaHQoIE1hdGgubWF4KCAwLCBvcHRpb25zLmhlaWdodCAtIG5vbkNvbnRlbnRIZWlnaHQgKSApOw0KCQl9DQoNCgkJaWYgKCB0aGlzLnVpRGlhbG9nLmlzKCAiOmRhdGEodWktcmVzaXphYmxlKSIgKSApIHsNCgkJCXRoaXMudWlEaWFsb2cucmVzaXphYmxlKCAib3B0aW9uIiwgIm1pbkhlaWdodCIsIHRoaXMuX21pbkhlaWdodCgpICk7DQoJCX0NCgl9LA0KDQoJX2Jsb2NrRnJhbWVzOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5pZnJhbWVCbG9ja3MgPSB0aGlzLmRvY3VtZW50LmZpbmQoICJpZnJhbWUiICkubWFwKCBmdW5jdGlvbigpIHsNCgkJCXZhciBpZnJhbWUgPSAkKCB0aGlzICk7DQoNCgkJCXJldHVybiAkKCAiPGRpdj4iICkNCgkJCQkuY3NzKCB7DQoJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLA0KCQkJCQl3aWR0aDogaWZyYW1lLm91dGVyV2lkdGgoKSwNCgkJCQkJaGVpZ2h0OiBpZnJhbWUub3V0ZXJIZWlnaHQoKQ0KCQkJCX0gKQ0KCQkJCS5hcHBlbmRUbyggaWZyYW1lLnBhcmVudCgpICkNCgkJCQkub2Zmc2V0KCBpZnJhbWUub2Zmc2V0KCkgKVsgMCBdOw0KCQl9ICk7DQoJfSwNCg0KCV91bmJsb2NrRnJhbWVzOiBmdW5jdGlvbigpIHsNCgkJaWYgKCB0aGlzLmlmcmFtZUJsb2NrcyApIHsNCgkJCXRoaXMuaWZyYW1lQmxvY2tzLnJlbW92ZSgpOw0KCQkJZGVsZXRlIHRoaXMuaWZyYW1lQmxvY2tzOw0KCQl9DQoJfSwNCg0KCV9hbGxvd0ludGVyYWN0aW9uOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCWlmICggJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1kaWFsb2ciICkubGVuZ3RoICkgew0KCQkJcmV0dXJuIHRydWU7DQoJCX0NCg0KCQkvLyBUT0RPOiBSZW1vdmUgaGFjayB3aGVuIGRhdGVwaWNrZXIgaW1wbGVtZW50cw0KCQkvLyB0aGUgLnVpLWZyb250IGxvZ2ljICgjODk4OSkNCgkJcmV0dXJuICEhJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1kYXRlcGlja2VyIiApLmxlbmd0aDsNCgl9LA0KDQoJX2NyZWF0ZU92ZXJsYXk6IGZ1bmN0aW9uKCkgew0KCQlpZiAoICF0aGlzLm9wdGlvbnMubW9kYWwgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBXZSB1c2UgYSBkZWxheSBpbiBjYXNlIHRoZSBvdmVybGF5IGlzIGNyZWF0ZWQgZnJvbSBhbg0KCQkvLyBldmVudCB0aGF0IHdlJ3JlIGdvaW5nIHRvIGJlIGNhbmNlbGxpbmcgKCMyODA0KQ0KCQl2YXIgaXNPcGVuaW5nID0gdHJ1ZTsNCgkJdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgew0KCQkJaXNPcGVuaW5nID0gZmFsc2U7DQoJCX0gKTsNCg0KCQlpZiAoICF0aGlzLmRvY3VtZW50LmRhdGEoICJ1aS1kaWFsb2ctb3ZlcmxheXMiICkgKSB7DQoNCgkJCS8vIFByZXZlbnQgdXNlIG9mIGFuY2hvcnMgYW5kIGlucHV0cw0KCQkJLy8gVXNpbmcgX29uKCkgZm9yIGFuIGV2ZW50IGhhbmRsZXIgc2hhcmVkIGFjcm9zcyBtYW55IGluc3RhbmNlcyBpcw0KCQkJLy8gc2FmZSBiZWNhdXNlIHRoZSBkaWFsb2dzIHN0YWNrIGFuZCBtdXN0IGJlIGNsb3NlZCBpbiByZXZlcnNlIG9yZGVyDQoJCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgew0KCQkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQkJaWYgKCBpc09wZW5pbmcgKSB7DQoJCQkJCQlyZXR1cm47DQoJCQkJCX0NCg0KCQkJCQlpZiAoICF0aGlzLl9hbGxvd0ludGVyYWN0aW9uKCBldmVudCApICkgew0KCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCQkJCXRoaXMuX3RyYWNraW5nSW5zdGFuY2VzKClbIDAgXS5fZm9jdXNUYWJiYWJsZSgpOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfSApOw0KCQl9DQoNCgkJdGhpcy5vdmVybGF5ID0gJCggIjxkaXY+IiApDQoJCQkuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCkgKTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5vdmVybGF5LCBudWxsLCAidWktd2lkZ2V0LW92ZXJsYXkgdWktZnJvbnQiICk7DQoJCXRoaXMuX29uKCB0aGlzLm92ZXJsYXksIHsNCgkJCW1vdXNlZG93bjogIl9rZWVwRm9jdXMiDQoJCX0gKTsNCgkJdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiwNCgkJCSggdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiApIHx8IDAgKSArIDEgKTsNCgl9LA0KDQoJX2Rlc3Ryb3lPdmVybGF5OiBmdW5jdGlvbigpIHsNCgkJaWYgKCAhdGhpcy5vcHRpb25zLm1vZGFsICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCB0aGlzLm92ZXJsYXkgKSB7DQoJCQl2YXIgb3ZlcmxheXMgPSB0aGlzLmRvY3VtZW50LmRhdGEoICJ1aS1kaWFsb2ctb3ZlcmxheXMiICkgLSAxOw0KDQoJCQlpZiAoICFvdmVybGF5cyApIHsNCgkJCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQsICJmb2N1c2luIiApOw0KCQkJCXRoaXMuZG9jdW1lbnQucmVtb3ZlRGF0YSggInVpLWRpYWxvZy1vdmVybGF5cyIgKTsNCgkJCX0gZWxzZSB7DQoJCQkJdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiwgb3ZlcmxheXMgKTsNCgkJCX0NCg0KCQkJdGhpcy5vdmVybGF5LnJlbW92ZSgpOw0KCQkJdGhpcy5vdmVybGF5ID0gbnVsbDsNCgkJfQ0KCX0NCn0gKTsNCg0KLy8gREVQUkVDQVRFRA0KLy8gVE9ETzogc3dpdGNoIHJldHVybiBiYWNrIHRvIHdpZGdldCBkZWNsYXJhdGlvbiBhdCB0b3Agb2YgZmlsZSB3aGVuIHRoaXMgaXMgcmVtb3ZlZA0KaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7DQoNCgkvLyBCYWNrY29tcGF0IGZvciBkaWFsb2dDbGFzcyBvcHRpb24NCgkkLndpZGdldCggInVpLmRpYWxvZyIsICQudWkuZGlhbG9nLCB7DQoJCW9wdGlvbnM6IHsNCgkJCWRpYWxvZ0NsYXNzOiAiIg0KCQl9LA0KCQlfY3JlYXRlV3JhcHBlcjogZnVuY3Rpb24oKSB7DQoJCQl0aGlzLl9zdXBlcigpOw0KCQkJdGhpcy51aURpYWxvZy5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmRpYWxvZ0NsYXNzICk7DQoJCX0sDQoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQkJaWYgKCBrZXkgPT09ICJkaWFsb2dDbGFzcyIgKSB7DQoJCQkJdGhpcy51aURpYWxvZw0KCQkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5kaWFsb2dDbGFzcyApDQoJCQkJCS5hZGRDbGFzcyggdmFsdWUgKTsNCgkJCX0NCgkJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOw0KCQl9DQoJfSApOw0KfQ0KDQp2YXIgd2lkZ2V0c0RpYWxvZyA9ICQudWkuZGlhbG9nOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIERyb3BwYWJsZSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogRHJvcHBhYmxlDQovLz4+Z3JvdXA6IEludGVyYWN0aW9ucw0KLy8+PmRlc2NyaXB0aW9uOiBFbmFibGVzIGRyb3AgdGFyZ2V0cyBmb3IgZHJhZ2dhYmxlIGVsZW1lbnRzLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2Ryb3BwYWJsZS8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9kcm9wcGFibGUvDQoNCg0KDQokLndpZGdldCggInVpLmRyb3BwYWJsZSIsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCgl3aWRnZXRFdmVudFByZWZpeDogImRyb3AiLA0KCW9wdGlvbnM6IHsNCgkJYWNjZXB0OiAiKiIsDQoJCWFkZENsYXNzZXM6IHRydWUsDQoJCWdyZWVkeTogZmFsc2UsDQoJCXNjb3BlOiAiZGVmYXVsdCIsDQoJCXRvbGVyYW5jZTogImludGVyc2VjdCIsDQoNCgkJLy8gQ2FsbGJhY2tzDQoJCWFjdGl2YXRlOiBudWxsLA0KCQlkZWFjdGl2YXRlOiBudWxsLA0KCQlkcm9wOiBudWxsLA0KCQlvdXQ6IG51bGwsDQoJCW92ZXI6IG51bGwNCgl9LA0KCV9jcmVhdGU6IGZ1bmN0aW9uKCkgew0KDQoJCXZhciBwcm9wb3J0aW9ucywNCgkJCW8gPSB0aGlzLm9wdGlvbnMsDQoJCQlhY2NlcHQgPSBvLmFjY2VwdDsNCg0KCQl0aGlzLmlzb3ZlciA9IGZhbHNlOw0KCQl0aGlzLmlzb3V0ID0gdHJ1ZTsNCg0KCQl0aGlzLmFjY2VwdCA9ICQuaXNGdW5jdGlvbiggYWNjZXB0ICkgPyBhY2NlcHQgOiBmdW5jdGlvbiggZCApIHsNCgkJCXJldHVybiBkLmlzKCBhY2NlcHQgKTsNCgkJfTsNCg0KCQl0aGlzLnByb3BvcnRpb25zID0gZnVuY3Rpb24oIC8qIHZhbHVlVG9Xcml0ZSAqLyApIHsNCgkJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsNCg0KCQkJCS8vIFN0b3JlIHRoZSBkcm9wcGFibGUncyBwcm9wb3J0aW9ucw0KCQkJCXByb3BvcnRpb25zID0gYXJndW1lbnRzWyAwIF07DQoJCQl9IGVsc2Ugew0KDQoJCQkJLy8gUmV0cmlldmUgb3IgZGVyaXZlIHRoZSBkcm9wcGFibGUncyBwcm9wb3J0aW9ucw0KCQkJCXJldHVybiBwcm9wb3J0aW9ucyA\/DQoJCQkJCXByb3BvcnRpb25zIDoNCgkJCQkJcHJvcG9ydGlvbnMgPSB7DQoJCQkJCQl3aWR0aDogdGhpcy5lbGVtZW50WyAwIF0ub2Zmc2V0V2lkdGgsDQoJCQkJCQloZWlnaHQ6IHRoaXMuZWxlbWVudFsgMCBdLm9mZnNldEhlaWdodA0KCQkJCQl9Ow0KCQkJfQ0KCQl9Ow0KDQoJCXRoaXMuX2FkZFRvTWFuYWdlciggby5zY29wZSApOw0KDQoJCW8uYWRkQ2xhc3NlcyAmJiB0aGlzLl9hZGRDbGFzcyggInVpLWRyb3BwYWJsZSIgKTsNCg0KCX0sDQoNCglfYWRkVG9NYW5hZ2VyOiBmdW5jdGlvbiggc2NvcGUgKSB7DQoNCgkJLy8gQWRkIHRoZSByZWZlcmVuY2UgYW5kIHBvc2l0aW9ucyB0byB0aGUgbWFuYWdlcg0KCQkkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyBzY29wZSBdID0gJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1sgc2NvcGUgXSB8fCBbXTsNCgkJJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1sgc2NvcGUgXS5wdXNoKCB0aGlzICk7DQoJfSwNCg0KCV9zcGxpY2U6IGZ1bmN0aW9uKCBkcm9wICkgew0KCQl2YXIgaSA9IDA7DQoJCWZvciAoIDsgaSA8IGRyb3AubGVuZ3RoOyBpKysgKSB7DQoJCQlpZiAoIGRyb3BbIGkgXSA9PT0gdGhpcyApIHsNCgkJCQlkcm9wLnNwbGljZSggaSwgMSApOw0KCQkJfQ0KCQl9DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJdmFyIGRyb3AgPSAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyB0aGlzLm9wdGlvbnMuc2NvcGUgXTsNCg0KCQl0aGlzLl9zcGxpY2UoIGRyb3AgKTsNCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoNCgkJaWYgKCBrZXkgPT09ICJhY2NlcHQiICkgew0KCQkJdGhpcy5hY2NlcHQgPSAkLmlzRnVuY3Rpb24oIHZhbHVlICkgPyB2YWx1ZSA6IGZ1bmN0aW9uKCBkICkgew0KCQkJCXJldHVybiBkLmlzKCB2YWx1ZSApOw0KCQkJfTsNCgkJfSBlbHNlIGlmICgga2V5ID09PSAic2NvcGUiICkgew0KCQkJdmFyIGRyb3AgPSAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyB0aGlzLm9wdGlvbnMuc2NvcGUgXTsNCg0KCQkJdGhpcy5fc3BsaWNlKCBkcm9wICk7DQoJCQl0aGlzLl9hZGRUb01hbmFnZXIoIHZhbHVlICk7DQoJCX0NCg0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KCX0sDQoNCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIGRyYWdnYWJsZSA9ICQudWkuZGRtYW5hZ2VyLmN1cnJlbnQ7DQoNCgkJdGhpcy5fYWRkQWN0aXZlQ2xhc3MoKTsNCgkJaWYgKCBkcmFnZ2FibGUgKSB7DQoJCQl0aGlzLl90cmlnZ2VyKCAiYWN0aXZhdGUiLCBldmVudCwgdGhpcy51aSggZHJhZ2dhYmxlICkgKTsNCgkJfQ0KCX0sDQoNCglfZGVhY3RpdmF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsNCg0KCQl0aGlzLl9yZW1vdmVBY3RpdmVDbGFzcygpOw0KCQlpZiAoIGRyYWdnYWJsZSApIHsNCgkJCXRoaXMuX3RyaWdnZXIoICJkZWFjdGl2YXRlIiwgZXZlbnQsIHRoaXMudWkoIGRyYWdnYWJsZSApICk7DQoJCX0NCgl9LA0KDQoJX292ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsNCg0KCQkvLyBCYWlsIGlmIGRyYWdnYWJsZSBhbmQgZHJvcHBhYmxlIGFyZSBzYW1lIGVsZW1lbnQNCgkJaWYgKCAhZHJhZ2dhYmxlIHx8ICggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8DQoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlmICggdGhpcy5hY2NlcHQuY2FsbCggdGhpcy5lbGVtZW50WyAwIF0sICggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8DQoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKSApICkgew0KCQkJdGhpcy5fYWRkSG92ZXJDbGFzcygpOw0KCQkJdGhpcy5fdHJpZ2dlciggIm92ZXIiLCBldmVudCwgdGhpcy51aSggZHJhZ2dhYmxlICkgKTsNCgkJfQ0KDQoJfSwNCg0KCV9vdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsNCg0KCQkvLyBCYWlsIGlmIGRyYWdnYWJsZSBhbmQgZHJvcHBhYmxlIGFyZSBzYW1lIGVsZW1lbnQNCgkJaWYgKCAhZHJhZ2dhYmxlIHx8ICggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8DQoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlmICggdGhpcy5hY2NlcHQuY2FsbCggdGhpcy5lbGVtZW50WyAwIF0sICggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8DQoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKSApICkgew0KCQkJdGhpcy5fcmVtb3ZlSG92ZXJDbGFzcygpOw0KCQkJdGhpcy5fdHJpZ2dlciggIm91dCIsIGV2ZW50LCB0aGlzLnVpKCBkcmFnZ2FibGUgKSApOw0KCQl9DQoNCgl9LA0KDQoJX2Ryb3A6IGZ1bmN0aW9uKCBldmVudCwgY3VzdG9tICkgew0KDQoJCXZhciBkcmFnZ2FibGUgPSBjdXN0b20gfHwgJC51aS5kZG1hbmFnZXIuY3VycmVudCwNCgkJCWNoaWxkcmVuSW50ZXJzZWN0aW9uID0gZmFsc2U7DQoNCgkJLy8gQmFpbCBpZiBkcmFnZ2FibGUgYW5kIGRyb3BwYWJsZSBhcmUgc2FtZSBlbGVtZW50DQoJCWlmICggIWRyYWdnYWJsZSB8fCAoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fA0KCQkJCWRyYWdnYWJsZS5lbGVtZW50IClbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQl0aGlzLmVsZW1lbnQNCgkJCS5maW5kKCAiOmRhdGEodWktZHJvcHBhYmxlKSIgKQ0KCQkJLm5vdCggIi51aS1kcmFnZ2FibGUtZHJhZ2dpbmciICkNCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgaW5zdCA9ICQoIHRoaXMgKS5kcm9wcGFibGUoICJpbnN0YW5jZSIgKTsNCgkJCQlpZiAoDQoJCQkJCWluc3Qub3B0aW9ucy5ncmVlZHkgJiYNCgkJCQkJIWluc3Qub3B0aW9ucy5kaXNhYmxlZCAmJg0KCQkJCQlpbnN0Lm9wdGlvbnMuc2NvcGUgPT09IGRyYWdnYWJsZS5vcHRpb25zLnNjb3BlICYmDQoJCQkJCWluc3QuYWNjZXB0LmNhbGwoDQoJCQkJCQlpbnN0LmVsZW1lbnRbIDAgXSwgKCBkcmFnZ2FibGUuY3VycmVudEl0ZW0gfHwgZHJhZ2dhYmxlLmVsZW1lbnQgKQ0KCQkJCQkpICYmDQoJCQkJCWludGVyc2VjdCgNCgkJCQkJCWRyYWdnYWJsZSwNCgkJCQkJCSQuZXh0ZW5kKCBpbnN0LCB7IG9mZnNldDogaW5zdC5lbGVtZW50Lm9mZnNldCgpIH0gKSwNCgkJCQkJCWluc3Qub3B0aW9ucy50b2xlcmFuY2UsIGV2ZW50DQoJCQkJCSkNCgkJCQkpIHsNCgkJCQkJY2hpbGRyZW5JbnRlcnNlY3Rpb24gPSB0cnVlOw0KCQkJCQlyZXR1cm4gZmFsc2U7IH0NCgkJCX0gKTsNCgkJaWYgKCBjaGlsZHJlbkludGVyc2VjdGlvbiApIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KDQoJCWlmICggdGhpcy5hY2NlcHQuY2FsbCggdGhpcy5lbGVtZW50WyAwIF0sDQoJCQkJKCBkcmFnZ2FibGUuY3VycmVudEl0ZW0gfHwgZHJhZ2dhYmxlLmVsZW1lbnQgKSApICkgew0KCQkJdGhpcy5fcmVtb3ZlQWN0aXZlQ2xhc3MoKTsNCgkJCXRoaXMuX3JlbW92ZUhvdmVyQ2xhc3MoKTsNCg0KCQkJdGhpcy5fdHJpZ2dlciggImRyb3AiLCBldmVudCwgdGhpcy51aSggZHJhZ2dhYmxlICkgKTsNCgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7DQoJCX0NCg0KCQlyZXR1cm4gZmFsc2U7DQoNCgl9LA0KDQoJdWk6IGZ1bmN0aW9uKCBjICkgew0KCQlyZXR1cm4gew0KCQkJZHJhZ2dhYmxlOiAoIGMuY3VycmVudEl0ZW0gfHwgYy5lbGVtZW50ICksDQoJCQloZWxwZXI6IGMuaGVscGVyLA0KCQkJcG9zaXRpb246IGMucG9zaXRpb24sDQoJCQlvZmZzZXQ6IGMucG9zaXRpb25BYnMNCgkJfTsNCgl9LA0KDQoJLy8gRXh0ZW5zaW9uIHBvaW50cyBqdXN0IHRvIG1ha2UgYmFja2NvbXBhdCBzYW5lIGFuZCBhdm9pZCBkdXBsaWNhdGluZyBsb2dpYw0KCS8vIFRPRE86IFJlbW92ZSBpbiAxLjEzIGFsb25nIHdpdGggY2FsbCB0byBpdCBiZWxvdw0KCV9hZGRIb3ZlckNsYXNzOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1kcm9wcGFibGUtaG92ZXIiICk7DQoJfSwNCg0KCV9yZW1vdmVIb3ZlckNsYXNzOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1kcm9wcGFibGUtaG92ZXIiICk7DQoJfSwNCg0KCV9hZGRBY3RpdmVDbGFzczogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX2FkZENsYXNzKCAidWktZHJvcHBhYmxlLWFjdGl2ZSIgKTsNCgl9LA0KDQoJX3JlbW92ZUFjdGl2ZUNsYXNzOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1kcm9wcGFibGUtYWN0aXZlIiApOw0KCX0NCn0gKTsNCg0KdmFyIGludGVyc2VjdCA9ICQudWkuaW50ZXJzZWN0ID0gKCBmdW5jdGlvbigpIHsNCglmdW5jdGlvbiBpc092ZXJBeGlzKCB4LCByZWZlcmVuY2UsIHNpemUgKSB7DQoJCXJldHVybiAoIHggPj0gcmVmZXJlbmNlICkgJiYgKCB4IDwgKCByZWZlcmVuY2UgKyBzaXplICkgKTsNCgl9DQoNCglyZXR1cm4gZnVuY3Rpb24oIGRyYWdnYWJsZSwgZHJvcHBhYmxlLCB0b2xlcmFuY2VNb2RlLCBldmVudCApIHsNCg0KCQlpZiAoICFkcm9wcGFibGUub2Zmc2V0ICkgew0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoNCgkJdmFyIHgxID0gKCBkcmFnZ2FibGUucG9zaXRpb25BYnMgfHwNCgkJCQlkcmFnZ2FibGUucG9zaXRpb24uYWJzb2x1dGUgKS5sZWZ0ICsgZHJhZ2dhYmxlLm1hcmdpbnMubGVmdCwNCgkJCXkxID0gKCBkcmFnZ2FibGUucG9zaXRpb25BYnMgfHwNCgkJCQlkcmFnZ2FibGUucG9zaXRpb24uYWJzb2x1dGUgKS50b3AgKyBkcmFnZ2FibGUubWFyZ2lucy50b3AsDQoJCQl4MiA9IHgxICsgZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLndpZHRoLA0KCQkJeTIgPSB5MSArIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQsDQoJCQlsID0gZHJvcHBhYmxlLm9mZnNldC5sZWZ0LA0KCQkJdCA9IGRyb3BwYWJsZS5vZmZzZXQudG9wLA0KCQkJciA9IGwgKyBkcm9wcGFibGUucHJvcG9ydGlvbnMoKS53aWR0aCwNCgkJCWIgPSB0ICsgZHJvcHBhYmxlLnByb3BvcnRpb25zKCkuaGVpZ2h0Ow0KDQoJCXN3aXRjaCAoIHRvbGVyYW5jZU1vZGUgKSB7DQoJCWNhc2UgImZpdCI6DQoJCQlyZXR1cm4gKCBsIDw9IHgxICYmIHgyIDw9IHIgJiYgdCA8PSB5MSAmJiB5MiA8PSBiICk7DQoJCWNhc2UgImludGVyc2VjdCI6DQoJCQlyZXR1cm4gKCBsIDwgeDEgKyAoIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAvIDIgKSAmJiAvLyBSaWdodCBIYWxmDQoJCQkJeDIgLSAoIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAvIDIgKSA8IHIgJiYgLy8gTGVmdCBIYWxmDQoJCQkJdCA8IHkxICsgKCBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC8gMiApICYmIC8vIEJvdHRvbSBIYWxmDQoJCQkJeTIgLSAoIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLyAyICkgPCBiICk7IC8vIFRvcCBIYWxmDQoJCWNhc2UgInBvaW50ZXIiOg0KCQkJcmV0dXJuIGlzT3ZlckF4aXMoIGV2ZW50LnBhZ2VZLCB0LCBkcm9wcGFibGUucHJvcG9ydGlvbnMoKS5oZWlnaHQgKSAmJg0KCQkJCWlzT3ZlckF4aXMoIGV2ZW50LnBhZ2VYLCBsLCBkcm9wcGFibGUucHJvcG9ydGlvbnMoKS53aWR0aCApOw0KCQljYXNlICJ0b3VjaCI6DQoJCQlyZXR1cm4gKA0KCQkJCSggeTEgPj0gdCAmJiB5MSA8PSBiICkgfHwgLy8gVG9wIGVkZ2UgdG91Y2hpbmcNCgkJCQkoIHkyID49IHQgJiYgeTIgPD0gYiApIHx8IC8vIEJvdHRvbSBlZGdlIHRvdWNoaW5nDQoJCQkJKCB5MSA8IHQgJiYgeTIgPiBiICkgLy8gU3Vycm91bmRlZCB2ZXJ0aWNhbGx5DQoJCQkpICYmICgNCgkJCQkoIHgxID49IGwgJiYgeDEgPD0gciApIHx8IC8vIExlZnQgZWRnZSB0b3VjaGluZw0KCQkJCSggeDIgPj0gbCAmJiB4MiA8PSByICkgfHwgLy8gUmlnaHQgZWRnZSB0b3VjaGluZw0KCQkJCSggeDEgPCBsICYmIHgyID4gciApIC8vIFN1cnJvdW5kZWQgaG9yaXpvbnRhbGx5DQoJCQkpOw0KCQlkZWZhdWx0Og0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoJfTsNCn0gKSgpOw0KDQovKg0KCVRoaXMgbWFuYWdlciB0cmFja3Mgb2Zmc2V0cyBvZiBkcmFnZ2FibGVzIGFuZCBkcm9wcGFibGVzDQoqLw0KJC51aS5kZG1hbmFnZXIgPSB7DQoJY3VycmVudDogbnVsbCwNCglkcm9wcGFibGVzOiB7ICJkZWZhdWx0IjogW10gfSwNCglwcmVwYXJlT2Zmc2V0czogZnVuY3Rpb24oIHQsIGV2ZW50ICkgew0KDQoJCXZhciBpLCBqLA0KCQkJbSA9ICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIHQub3B0aW9ucy5zY29wZSBdIHx8IFtdLA0KCQkJdHlwZSA9IGV2ZW50ID8gZXZlbnQudHlwZSA6IG51bGwsIC8vIHdvcmthcm91bmQgZm9yICMyMzE3DQoJCQlsaXN0ID0gKCB0LmN1cnJlbnRJdGVtIHx8IHQuZWxlbWVudCApLmZpbmQoICI6ZGF0YSh1aS1kcm9wcGFibGUpIiApLmFkZEJhY2soKTsNCg0KCQlkcm9wcGFibGVzTG9vcDogZm9yICggaSA9IDA7IGkgPCBtLmxlbmd0aDsgaSsrICkgew0KDQoJCQkvLyBObyBkaXNhYmxlZCBhbmQgbm9uLWFjY2VwdGVkDQoJCQlpZiAoIG1bIGkgXS5vcHRpb25zLmRpc2FibGVkIHx8ICggdCAmJiAhbVsgaSBdLmFjY2VwdC5jYWxsKCBtWyBpIF0uZWxlbWVudFsgMCBdLA0KCQkJCQkoIHQuY3VycmVudEl0ZW0gfHwgdC5lbGVtZW50ICkgKSApICkgew0KCQkJCWNvbnRpbnVlOw0KCQkJfQ0KDQoJCQkvLyBGaWx0ZXIgb3V0IGVsZW1lbnRzIGluIHRoZSBjdXJyZW50IGRyYWdnZWQgaXRlbQ0KCQkJZm9yICggaiA9IDA7IGogPCBsaXN0Lmxlbmd0aDsgaisrICkgew0KCQkJCWlmICggbGlzdFsgaiBdID09PSBtWyBpIF0uZWxlbWVudFsgMCBdICkgew0KCQkJCQltWyBpIF0ucHJvcG9ydGlvbnMoKS5oZWlnaHQgPSAwOw0KCQkJCQljb250aW51ZSBkcm9wcGFibGVzTG9vcDsNCgkJCQl9DQoJCQl9DQoNCgkJCW1bIGkgXS52aXNpYmxlID0gbVsgaSBdLmVsZW1lbnQuY3NzKCAiZGlzcGxheSIgKSAhPT0gIm5vbmUiOw0KCQkJaWYgKCAhbVsgaSBdLnZpc2libGUgKSB7DQoJCQkJY29udGludWU7DQoJCQl9DQoNCgkJCS8vIEFjdGl2YXRlIHRoZSBkcm9wcGFibGUgaWYgdXNlZCBkaXJlY3RseSBmcm9tIGRyYWdnYWJsZXMNCgkJCWlmICggdHlwZSA9PT0gIm1vdXNlZG93biIgKSB7DQoJCQkJbVsgaSBdLl9hY3RpdmF0ZS5jYWxsKCBtWyBpIF0sIGV2ZW50ICk7DQoJCQl9DQoNCgkJCW1bIGkgXS5vZmZzZXQgPSBtWyBpIF0uZWxlbWVudC5vZmZzZXQoKTsNCgkJCW1bIGkgXS5wcm9wb3J0aW9ucyggew0KCQkJCXdpZHRoOiBtWyBpIF0uZWxlbWVudFsgMCBdLm9mZnNldFdpZHRoLA0KCQkJCWhlaWdodDogbVsgaSBdLmVsZW1lbnRbIDAgXS5vZmZzZXRIZWlnaHQNCgkJCX0gKTsNCg0KCQl9DQoNCgl9LA0KCWRyb3A6IGZ1bmN0aW9uKCBkcmFnZ2FibGUsIGV2ZW50ICkgew0KDQoJCXZhciBkcm9wcGVkID0gZmFsc2U7DQoNCgkJLy8gQ3JlYXRlIGEgY29weSBvZiB0aGUgZHJvcHBhYmxlcyBpbiBjYXNlIHRoZSBsaXN0IGNoYW5nZXMgZHVyaW5nIHRoZSBkcm9wICgjOTExNikNCgkJJC5lYWNoKCAoICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIGRyYWdnYWJsZS5vcHRpb25zLnNjb3BlIF0gfHwgW10gKS5zbGljZSgpLCBmdW5jdGlvbigpIHsNCg0KCQkJaWYgKCAhdGhpcy5vcHRpb25zICkgew0KCQkJCXJldHVybjsNCgkJCX0NCgkJCWlmICggIXRoaXMub3B0aW9ucy5kaXNhYmxlZCAmJiB0aGlzLnZpc2libGUgJiYNCgkJCQkJaW50ZXJzZWN0KCBkcmFnZ2FibGUsIHRoaXMsIHRoaXMub3B0aW9ucy50b2xlcmFuY2UsIGV2ZW50ICkgKSB7DQoJCQkJZHJvcHBlZCA9IHRoaXMuX2Ryb3AuY2FsbCggdGhpcywgZXZlbnQgKSB8fCBkcm9wcGVkOw0KCQkJfQ0KDQoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgJiYgdGhpcy52aXNpYmxlICYmIHRoaXMuYWNjZXB0LmNhbGwoIHRoaXMuZWxlbWVudFsgMCBdLA0KCQkJCQkoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudCApICkgKSB7DQoJCQkJdGhpcy5pc291dCA9IHRydWU7DQoJCQkJdGhpcy5pc292ZXIgPSBmYWxzZTsNCgkJCQl0aGlzLl9kZWFjdGl2YXRlLmNhbGwoIHRoaXMsIGV2ZW50ICk7DQoJCQl9DQoNCgkJfSApOw0KCQlyZXR1cm4gZHJvcHBlZDsNCg0KCX0sDQoJZHJhZ1N0YXJ0OiBmdW5jdGlvbiggZHJhZ2dhYmxlLCBldmVudCApIHsNCg0KCQkvLyBMaXN0ZW4gZm9yIHNjcm9sbGluZyBzbyB0aGF0IGlmIHRoZSBkcmFnZ2luZyBjYXVzZXMgc2Nyb2xsaW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUNCgkJLy8gZHJvcHBhYmxlcyBjYW4gYmUgcmVjYWxjdWxhdGVkIChzZWUgIzUwMDMpDQoJCWRyYWdnYWJsZS5lbGVtZW50LnBhcmVudHNVbnRpbCggImJvZHkiICkub24oICJzY3JvbGwuZHJvcHBhYmxlIiwgZnVuY3Rpb24oKSB7DQoJCQlpZiAoICFkcmFnZ2FibGUub3B0aW9ucy5yZWZyZXNoUG9zaXRpb25zICkgew0KCQkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBkcmFnZ2FibGUsIGV2ZW50ICk7DQoJCQl9DQoJCX0gKTsNCgl9LA0KCWRyYWc6IGZ1bmN0aW9uKCBkcmFnZ2FibGUsIGV2ZW50ICkgew0KDQoJCS8vIElmIHlvdSBoYXZlIGEgaGlnaGx5IGR5bmFtaWMgcGFnZSwgeW91IG1pZ2h0IHRyeSB0aGlzIG9wdGlvbi4gSXQgcmVuZGVycyBwb3NpdGlvbnMNCgkJLy8gZXZlcnkgdGltZSB5b3UgbW92ZSB0aGUgbW91c2UuDQoJCWlmICggZHJhZ2dhYmxlLm9wdGlvbnMucmVmcmVzaFBvc2l0aW9ucyApIHsNCgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBkcmFnZ2FibGUsIGV2ZW50ICk7DQoJCX0NCg0KCQkvLyBSdW4gdGhyb3VnaCBhbGwgZHJvcHBhYmxlcyBhbmQgY2hlY2sgdGhlaXIgcG9zaXRpb25zIGJhc2VkIG9uIHNwZWNpZmljIHRvbGVyYW5jZSBvcHRpb25zDQoJCSQuZWFjaCggJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1sgZHJhZ2dhYmxlLm9wdGlvbnMuc2NvcGUgXSB8fCBbXSwgZnVuY3Rpb24oKSB7DQoNCgkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMuZ3JlZWR5Q2hpbGQgfHwgIXRoaXMudmlzaWJsZSApIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCXZhciBwYXJlbnRJbnN0YW5jZSwgc2NvcGUsIHBhcmVudCwNCgkJCQlpbnRlcnNlY3RzID0gaW50ZXJzZWN0KCBkcmFnZ2FibGUsIHRoaXMsIHRoaXMub3B0aW9ucy50b2xlcmFuY2UsIGV2ZW50ICksDQoJCQkJYyA9ICFpbnRlcnNlY3RzICYmIHRoaXMuaXNvdmVyID8NCgkJCQkJImlzb3V0IiA6DQoJCQkJCSggaW50ZXJzZWN0cyAmJiAhdGhpcy5pc292ZXIgPyAiaXNvdmVyIiA6IG51bGwgKTsNCgkJCWlmICggIWMgKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQlpZiAoIHRoaXMub3B0aW9ucy5ncmVlZHkgKSB7DQoNCgkJCQkvLyBmaW5kIGRyb3BwYWJsZSBwYXJlbnRzIHdpdGggc2FtZSBzY29wZQ0KCQkJCXNjb3BlID0gdGhpcy5vcHRpb25zLnNjb3BlOw0KCQkJCXBhcmVudCA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiOmRhdGEodWktZHJvcHBhYmxlKSIgKS5maWx0ZXIoIGZ1bmN0aW9uKCkgew0KCQkJCQlyZXR1cm4gJCggdGhpcyApLmRyb3BwYWJsZSggImluc3RhbmNlIiApLm9wdGlvbnMuc2NvcGUgPT09IHNjb3BlOw0KCQkJCX0gKTsNCg0KCQkJCWlmICggcGFyZW50Lmxlbmd0aCApIHsNCgkJCQkJcGFyZW50SW5zdGFuY2UgPSAkKCBwYXJlbnRbIDAgXSApLmRyb3BwYWJsZSggImluc3RhbmNlIiApOw0KCQkJCQlwYXJlbnRJbnN0YW5jZS5ncmVlZHlDaGlsZCA9ICggYyA9PT0gImlzb3ZlciIgKTsNCgkJCQl9DQoJCQl9DQoNCgkJCS8vIFdlIGp1c3QgbW92ZWQgaW50byBhIGdyZWVkeSBjaGlsZA0KCQkJaWYgKCBwYXJlbnRJbnN0YW5jZSAmJiBjID09PSAiaXNvdmVyIiApIHsNCgkJCQlwYXJlbnRJbnN0YW5jZS5pc292ZXIgPSBmYWxzZTsNCgkJCQlwYXJlbnRJbnN0YW5jZS5pc291dCA9IHRydWU7DQoJCQkJcGFyZW50SW5zdGFuY2UuX291dC5jYWxsKCBwYXJlbnRJbnN0YW5jZSwgZXZlbnQgKTsNCgkJCX0NCg0KCQkJdGhpc1sgYyBdID0gdHJ1ZTsNCgkJCXRoaXNbIGMgPT09ICJpc291dCIgPyAiaXNvdmVyIiA6ICJpc291dCIgXSA9IGZhbHNlOw0KCQkJdGhpc1sgYyA9PT0gImlzb3ZlciIgPyAiX292ZXIiIDogIl9vdXQiIF0uY2FsbCggdGhpcywgZXZlbnQgKTsNCg0KCQkJLy8gV2UganVzdCBtb3ZlZCBvdXQgb2YgYSBncmVlZHkgY2hpbGQNCgkJCWlmICggcGFyZW50SW5zdGFuY2UgJiYgYyA9PT0gImlzb3V0IiApIHsNCgkJCQlwYXJlbnRJbnN0YW5jZS5pc291dCA9IGZhbHNlOw0KCQkJCXBhcmVudEluc3RhbmNlLmlzb3ZlciA9IHRydWU7DQoJCQkJcGFyZW50SW5zdGFuY2UuX292ZXIuY2FsbCggcGFyZW50SW5zdGFuY2UsIGV2ZW50ICk7DQoJCQl9DQoJCX0gKTsNCg0KCX0sDQoJZHJhZ1N0b3A6IGZ1bmN0aW9uKCBkcmFnZ2FibGUsIGV2ZW50ICkgew0KCQlkcmFnZ2FibGUuZWxlbWVudC5wYXJlbnRzVW50aWwoICJib2R5IiApLm9mZiggInNjcm9sbC5kcm9wcGFibGUiICk7DQoNCgkJLy8gQ2FsbCBwcmVwYXJlT2Zmc2V0cyBvbmUgZmluYWwgdGltZSBzaW5jZSBJRSBkb2VzIG5vdCBmaXJlIHJldHVybiBzY3JvbGwgZXZlbnRzIHdoZW4NCgkJLy8gb3ZlcmZsb3cgd2FzIGNhdXNlZCBieSBkcmFnIChzZWUgIzUwMDMpDQoJCWlmICggIWRyYWdnYWJsZS5vcHRpb25zLnJlZnJlc2hQb3NpdGlvbnMgKSB7DQoJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggZHJhZ2dhYmxlLCBldmVudCApOw0KCQl9DQoJfQ0KfTsNCg0KLy8gREVQUkVDQVRFRA0KLy8gVE9ETzogc3dpdGNoIHJldHVybiBiYWNrIHRvIHdpZGdldCBkZWNsYXJhdGlvbiBhdCB0b3Agb2YgZmlsZSB3aGVuIHRoaXMgaXMgcmVtb3ZlZA0KaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7DQoNCgkvLyBCYWNrY29tcGF0IGZvciBhY3RpdmVDbGFzcyBhbmQgaG92ZXJDbGFzcyBvcHRpb25zDQoJJC53aWRnZXQoICJ1aS5kcm9wcGFibGUiLCAkLnVpLmRyb3BwYWJsZSwgew0KCQlvcHRpb25zOiB7DQoJCQlob3ZlckNsYXNzOiBmYWxzZSwNCgkJCWFjdGl2ZUNsYXNzOiBmYWxzZQ0KCQl9LA0KCQlfYWRkQWN0aXZlQ2xhc3M6IGZ1bmN0aW9uKCkgew0KCQkJdGhpcy5fc3VwZXIoKTsNCgkJCWlmICggdGhpcy5vcHRpb25zLmFjdGl2ZUNsYXNzICkgew0KCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmFjdGl2ZUNsYXNzICk7DQoJCQl9DQoJCX0sDQoJCV9yZW1vdmVBY3RpdmVDbGFzczogZnVuY3Rpb24oKSB7DQoJCQl0aGlzLl9zdXBlcigpOw0KCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlQ2xhc3MgKSB7DQoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuYWN0aXZlQ2xhc3MgKTsNCgkJCX0NCgkJfSwNCgkJX2FkZEhvdmVyQ2xhc3M6IGZ1bmN0aW9uKCkgew0KCQkJdGhpcy5fc3VwZXIoKTsNCgkJCWlmICggdGhpcy5vcHRpb25zLmhvdmVyQ2xhc3MgKSB7DQoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuaG92ZXJDbGFzcyApOw0KCQkJfQ0KCQl9LA0KCQlfcmVtb3ZlSG92ZXJDbGFzczogZnVuY3Rpb24oKSB7DQoJCQl0aGlzLl9zdXBlcigpOw0KCQkJaWYgKCB0aGlzLm9wdGlvbnMuaG92ZXJDbGFzcyApIHsNCgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5ob3ZlckNsYXNzICk7DQoJCQl9DQoJCX0NCgl9ICk7DQp9DQoNCnZhciB3aWRnZXRzRHJvcHBhYmxlID0gJC51aS5kcm9wcGFibGU7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgUHJvZ3Jlc3NiYXIgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IFByb2dyZXNzYmFyDQovLz4+Z3JvdXA6IFdpZGdldHMNCi8vIGpzY3M6ZGlzYWJsZSBtYXhpbXVtTGluZUxlbmd0aA0KLy8+PmRlc2NyaXB0aW9uOiBEaXNwbGF5cyBhIHN0YXR1cyBpbmRpY2F0b3IgZm9yIGxvYWRpbmcgc3RhdGUsIHN0YW5kYXJkIHBlcmNlbnRhZ2UsIGFuZCBvdGhlciBwcm9ncmVzcyBpbmRpY2F0b3JzLg0KLy8ganNjczplbmFibGUgbWF4aW11bUxpbmVMZW5ndGgNCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wcm9ncmVzc2Jhci8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9wcm9ncmVzc2Jhci8NCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3Byb2dyZXNzYmFyLmNzcw0KLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzDQoNCg0KDQp2YXIgd2lkZ2V0c1Byb2dyZXNzYmFyID0gJC53aWRnZXQoICJ1aS5wcm9ncmVzc2JhciIsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCglvcHRpb25zOiB7DQoJCWNsYXNzZXM6IHsNCgkJCSJ1aS1wcm9ncmVzc2JhciI6ICJ1aS1jb3JuZXItYWxsIiwNCgkJCSJ1aS1wcm9ncmVzc2Jhci12YWx1ZSI6ICJ1aS1jb3JuZXItbGVmdCIsDQoJCQkidWktcHJvZ3Jlc3NiYXItY29tcGxldGUiOiAidWktY29ybmVyLXJpZ2h0Ig0KCQl9LA0KCQltYXg6IDEwMCwNCgkJdmFsdWU6IDAsDQoNCgkJY2hhbmdlOiBudWxsLA0KCQljb21wbGV0ZTogbnVsbA0KCX0sDQoNCgltaW46IDAsDQoNCglfY3JlYXRlOiBmdW5jdGlvbigpIHsNCg0KCQkvLyBDb25zdHJhaW4gaW5pdGlhbCB2YWx1ZQ0KCQl0aGlzLm9sZFZhbHVlID0gdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fY29uc3RyYWluZWRWYWx1ZSgpOw0KDQoJCXRoaXMuZWxlbWVudC5hdHRyKCB7DQoNCgkJCS8vIE9ubHkgc2V0IHN0YXRpYyB2YWx1ZXM7IGFyaWEtdmFsdWVub3cgYW5kIGFyaWEtdmFsdWVtYXggYXJlDQoJCQkvLyBzZXQgaW5zaWRlIF9yZWZyZXNoVmFsdWUoKQ0KCQkJcm9sZTogInByb2dyZXNzYmFyIiwNCgkJCSJhcmlhLXZhbHVlbWluIjogdGhpcy5taW4NCgkJfSApOw0KCQl0aGlzLl9hZGRDbGFzcyggInVpLXByb2dyZXNzYmFyIiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCIgKTsNCg0KCQl0aGlzLnZhbHVlRGl2ID0gJCggIjxkaXY+IiApLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudmFsdWVEaXYsICJ1aS1wcm9ncmVzc2Jhci12YWx1ZSIsICJ1aS13aWRnZXQtaGVhZGVyIiApOw0KCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsNCgl9LA0KDQoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggInJvbGUgYXJpYS12YWx1ZW1pbiBhcmlhLXZhbHVlbWF4IGFyaWEtdmFsdWVub3ciICk7DQoNCgkJdGhpcy52YWx1ZURpdi5yZW1vdmUoKTsNCgl9LA0KDQoJdmFsdWU6IGZ1bmN0aW9uKCBuZXdWYWx1ZSApIHsNCgkJaWYgKCBuZXdWYWx1ZSA9PT0gdW5kZWZpbmVkICkgew0KCQkJcmV0dXJuIHRoaXMub3B0aW9ucy52YWx1ZTsNCgkJfQ0KDQoJCXRoaXMub3B0aW9ucy52YWx1ZSA9IHRoaXMuX2NvbnN0cmFpbmVkVmFsdWUoIG5ld1ZhbHVlICk7DQoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOw0KCX0sDQoNCglfY29uc3RyYWluZWRWYWx1ZTogZnVuY3Rpb24oIG5ld1ZhbHVlICkgew0KCQlpZiAoIG5ld1ZhbHVlID09PSB1bmRlZmluZWQgKSB7DQoJCQluZXdWYWx1ZSA9IHRoaXMub3B0aW9ucy52YWx1ZTsNCgkJfQ0KDQoJCXRoaXMuaW5kZXRlcm1pbmF0ZSA9IG5ld1ZhbHVlID09PSBmYWxzZTsNCg0KCQkvLyBTYW5pdGl6ZSB2YWx1ZQ0KCQlpZiAoIHR5cGVvZiBuZXdWYWx1ZSAhPT0gIm51bWJlciIgKSB7DQoJCQluZXdWYWx1ZSA9IDA7DQoJCX0NCg0KCQlyZXR1cm4gdGhpcy5pbmRldGVybWluYXRlID8gZmFsc2UgOg0KCQkJTWF0aC5taW4oIHRoaXMub3B0aW9ucy5tYXgsIE1hdGgubWF4KCB0aGlzLm1pbiwgbmV3VmFsdWUgKSApOw0KCX0sDQoNCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoNCgkJLy8gRW5zdXJlICJ2YWx1ZSIgb3B0aW9uIGlzIHNldCBhZnRlciBvdGhlciB2YWx1ZXMgKGxpa2UgbWF4KQ0KCQl2YXIgdmFsdWUgPSBvcHRpb25zLnZhbHVlOw0KCQlkZWxldGUgb3B0aW9ucy52YWx1ZTsNCg0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOw0KDQoJCXRoaXMub3B0aW9ucy52YWx1ZSA9IHRoaXMuX2NvbnN0cmFpbmVkVmFsdWUoIHZhbHVlICk7DQoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOw0KCX0sDQoNCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsNCgkJaWYgKCBrZXkgPT09ICJtYXgiICkgew0KDQoJCQkvLyBEb24ndCBhbGxvdyBhIG1heCBsZXNzIHRoYW4gbWluDQoJCQl2YWx1ZSA9IE1hdGgubWF4KCB0aGlzLm1pbiwgdmFsdWUgKTsNCgkJfQ0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KCX0sDQoNCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7DQoNCgkJdGhpcy5lbGVtZW50LmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsNCgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKTsNCgl9LA0KDQoJX3BlcmNlbnRhZ2U6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5pbmRldGVybWluYXRlID8NCgkJCTEwMCA6DQoJCQkxMDAgKiAoIHRoaXMub3B0aW9ucy52YWx1ZSAtIHRoaXMubWluICkgLyAoIHRoaXMub3B0aW9ucy5tYXggLSB0aGlzLm1pbiApOw0KCX0sDQoNCglfcmVmcmVzaFZhbHVlOiBmdW5jdGlvbigpIHsNCgkJdmFyIHZhbHVlID0gdGhpcy5vcHRpb25zLnZhbHVlLA0KCQkJcGVyY2VudGFnZSA9IHRoaXMuX3BlcmNlbnRhZ2UoKTsNCg0KCQl0aGlzLnZhbHVlRGl2DQoJCQkudG9nZ2xlKCB0aGlzLmluZGV0ZXJtaW5hdGUgfHwgdmFsdWUgPiB0aGlzLm1pbiApDQoJCQkud2lkdGgoIHBlcmNlbnRhZ2UudG9GaXhlZCggMCApICsgIiUiICk7DQoNCgkJdGhpcw0KCQkJLl90b2dnbGVDbGFzcyggdGhpcy52YWx1ZURpdiwgInVpLXByb2dyZXNzYmFyLWNvbXBsZXRlIiwgbnVsbCwNCgkJCQl2YWx1ZSA9PT0gdGhpcy5vcHRpb25zLm1heCApDQoJCQkuX3RvZ2dsZUNsYXNzKCAidWktcHJvZ3Jlc3NiYXItaW5kZXRlcm1pbmF0ZSIsIG51bGwsIHRoaXMuaW5kZXRlcm1pbmF0ZSApOw0KDQoJCWlmICggdGhpcy5pbmRldGVybWluYXRlICkgew0KCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJhcmlhLXZhbHVlbm93IiApOw0KCQkJaWYgKCAhdGhpcy5vdmVybGF5RGl2ICkgew0KCQkJCXRoaXMub3ZlcmxheURpdiA9ICQoICI8ZGl2PiIgKS5hcHBlbmRUbyggdGhpcy52YWx1ZURpdiApOw0KCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLm92ZXJsYXlEaXYsICJ1aS1wcm9ncmVzc2Jhci1vdmVybGF5IiApOw0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJdGhpcy5lbGVtZW50LmF0dHIoIHsNCgkJCQkiYXJpYS12YWx1ZW1heCI6IHRoaXMub3B0aW9ucy5tYXgsDQoJCQkJImFyaWEtdmFsdWVub3ciOiB2YWx1ZQ0KCQkJfSApOw0KCQkJaWYgKCB0aGlzLm92ZXJsYXlEaXYgKSB7DQoJCQkJdGhpcy5vdmVybGF5RGl2LnJlbW92ZSgpOw0KCQkJCXRoaXMub3ZlcmxheURpdiA9IG51bGw7DQoJCQl9DQoJCX0NCg0KCQlpZiAoIHRoaXMub2xkVmFsdWUgIT09IHZhbHVlICkgew0KCQkJdGhpcy5vbGRWYWx1ZSA9IHZhbHVlOw0KCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIgKTsNCgkJfQ0KCQlpZiAoIHZhbHVlID09PSB0aGlzLm9wdGlvbnMubWF4ICkgew0KCQkJdGhpcy5fdHJpZ2dlciggImNvbXBsZXRlIiApOw0KCQl9DQoJfQ0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIFNlbGVjdGFibGUgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IFNlbGVjdGFibGUNCi8vPj5ncm91cDogSW50ZXJhY3Rpb25zDQovLz4+ZGVzY3JpcHRpb246IEFsbG93cyBncm91cHMgb2YgZWxlbWVudHMgdG8gYmUgc2VsZWN0ZWQgd2l0aCB0aGUgbW91c2UuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2VsZWN0YWJsZS8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9zZWxlY3RhYmxlLw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3NlbGVjdGFibGUuY3NzDQoNCg0KDQp2YXIgd2lkZ2V0c1NlbGVjdGFibGUgPSAkLndpZGdldCggInVpLnNlbGVjdGFibGUiLCAkLnVpLm1vdXNlLCB7DQoJdmVyc2lvbjogIjEuMTIuMSIsDQoJb3B0aW9uczogew0KCQlhcHBlbmRUbzogImJvZHkiLA0KCQlhdXRvUmVmcmVzaDogdHJ1ZSwNCgkJZGlzdGFuY2U6IDAsDQoJCWZpbHRlcjogIioiLA0KCQl0b2xlcmFuY2U6ICJ0b3VjaCIsDQoNCgkJLy8gQ2FsbGJhY2tzDQoJCXNlbGVjdGVkOiBudWxsLA0KCQlzZWxlY3Rpbmc6IG51bGwsDQoJCXN0YXJ0OiBudWxsLA0KCQlzdG9wOiBudWxsLA0KCQl1bnNlbGVjdGVkOiBudWxsLA0KCQl1bnNlbGVjdGluZzogbnVsbA0KCX0sDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCg0KCQl0aGlzLl9hZGRDbGFzcyggInVpLXNlbGVjdGFibGUiICk7DQoNCgkJdGhpcy5kcmFnZ2VkID0gZmFsc2U7DQoNCgkJLy8gQ2FjaGUgc2VsZWN0ZWUgY2hpbGRyZW4gYmFzZWQgb24gZmlsdGVyDQoJCXRoaXMucmVmcmVzaCA9IGZ1bmN0aW9uKCkgew0KCQkJdGhhdC5lbGVtZW50UG9zID0gJCggdGhhdC5lbGVtZW50WyAwIF0gKS5vZmZzZXQoKTsNCgkJCXRoYXQuc2VsZWN0ZWVzID0gJCggdGhhdC5vcHRpb25zLmZpbHRlciwgdGhhdC5lbGVtZW50WyAwIF0gKTsNCgkJCXRoYXQuX2FkZENsYXNzKCB0aGF0LnNlbGVjdGVlcywgInVpLXNlbGVjdGVlIiApOw0KCQkJdGhhdC5zZWxlY3RlZXMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLA0KCQkJCQlzZWxlY3RlZU9mZnNldCA9ICR0aGlzLm9mZnNldCgpLA0KCQkJCQlwb3MgPSB7DQoJCQkJCQlsZWZ0OiBzZWxlY3RlZU9mZnNldC5sZWZ0IC0gdGhhdC5lbGVtZW50UG9zLmxlZnQsDQoJCQkJCQl0b3A6IHNlbGVjdGVlT2Zmc2V0LnRvcCAtIHRoYXQuZWxlbWVudFBvcy50b3ANCgkJCQkJfTsNCgkJCQkkLmRhdGEoIHRoaXMsICJzZWxlY3RhYmxlLWl0ZW0iLCB7DQoJCQkJCWVsZW1lbnQ6IHRoaXMsDQoJCQkJCSRlbGVtZW50OiAkdGhpcywNCgkJCQkJbGVmdDogcG9zLmxlZnQsDQoJCQkJCXRvcDogcG9zLnRvcCwNCgkJCQkJcmlnaHQ6IHBvcy5sZWZ0ICsgJHRoaXMub3V0ZXJXaWR0aCgpLA0KCQkJCQlib3R0b206IHBvcy50b3AgKyAkdGhpcy5vdXRlckhlaWdodCgpLA0KCQkJCQlzdGFydHNlbGVjdGVkOiBmYWxzZSwNCgkJCQkJc2VsZWN0ZWQ6ICR0aGlzLmhhc0NsYXNzKCAidWktc2VsZWN0ZWQiICksDQoJCQkJCXNlbGVjdGluZzogJHRoaXMuaGFzQ2xhc3MoICJ1aS1zZWxlY3RpbmciICksDQoJCQkJCXVuc2VsZWN0aW5nOiAkdGhpcy5oYXNDbGFzcyggInVpLXVuc2VsZWN0aW5nIiApDQoJCQkJfSApOw0KCQkJfSApOw0KCQl9Ow0KCQl0aGlzLnJlZnJlc2goKTsNCg0KCQl0aGlzLl9tb3VzZUluaXQoKTsNCg0KCQl0aGlzLmhlbHBlciA9ICQoICI8ZGl2PiIgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGVscGVyLCAidWktc2VsZWN0YWJsZS1oZWxwZXIiICk7DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJdGhpcy5zZWxlY3RlZXMucmVtb3ZlRGF0YSggInNlbGVjdGFibGUtaXRlbSIgKTsNCgkJdGhpcy5fbW91c2VEZXN0cm95KCk7DQoJfSwNCg0KCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7DQoNCgkJdGhpcy5vcG9zID0gWyBldmVudC5wYWdlWCwgZXZlbnQucGFnZVkgXTsNCgkJdGhpcy5lbGVtZW50UG9zID0gJCggdGhpcy5lbGVtZW50WyAwIF0gKS5vZmZzZXQoKTsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXRoaXMuc2VsZWN0ZWVzID0gJCggb3B0aW9ucy5maWx0ZXIsIHRoaXMuZWxlbWVudFsgMCBdICk7DQoNCgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiwgZXZlbnQgKTsNCg0KCQkkKCBvcHRpb25zLmFwcGVuZFRvICkuYXBwZW5kKCB0aGlzLmhlbHBlciApOw0KDQoJCS8vIHBvc2l0aW9uIGhlbHBlciAobGFzc28pDQoJCXRoaXMuaGVscGVyLmNzcyggew0KCQkJImxlZnQiOiBldmVudC5wYWdlWCwNCgkJCSJ0b3AiOiBldmVudC5wYWdlWSwNCgkJCSJ3aWR0aCI6IDAsDQoJCQkiaGVpZ2h0IjogMA0KCQl9ICk7DQoNCgkJaWYgKCBvcHRpb25zLmF1dG9SZWZyZXNoICkgew0KCQkJdGhpcy5yZWZyZXNoKCk7DQoJCX0NCg0KCQl0aGlzLnNlbGVjdGVlcy5maWx0ZXIoICIudWktc2VsZWN0ZWQiICkuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgc2VsZWN0ZWUgPSAkLmRhdGEoIHRoaXMsICJzZWxlY3RhYmxlLWl0ZW0iICk7DQoJCQlzZWxlY3RlZS5zdGFydHNlbGVjdGVkID0gdHJ1ZTsNCgkJCWlmICggIWV2ZW50Lm1ldGFLZXkgJiYgIWV2ZW50LmN0cmxLZXkgKSB7DQoJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0ZWQiICk7DQoJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSBmYWxzZTsNCgkJCQl0aGF0Ll9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS11bnNlbGVjdGluZyIgKTsNCgkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IHRydWU7DQoNCgkJCQkvLyBzZWxlY3RhYmxlIFVOU0VMRUNUSU5HIGNhbGxiYWNrDQoJCQkJdGhhdC5fdHJpZ2dlciggInVuc2VsZWN0aW5nIiwgZXZlbnQsIHsNCgkJCQkJdW5zZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQNCgkJCQl9ICk7DQoJCQl9DQoJCX0gKTsNCg0KCQkkKCBldmVudC50YXJnZXQgKS5wYXJlbnRzKCkuYWRkQmFjaygpLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJdmFyIGRvU2VsZWN0LA0KCQkJCXNlbGVjdGVlID0gJC5kYXRhKCB0aGlzLCAic2VsZWN0YWJsZS1pdGVtIiApOw0KCQkJaWYgKCBzZWxlY3RlZSApIHsNCgkJCQlkb1NlbGVjdCA9ICggIWV2ZW50Lm1ldGFLZXkgJiYgIWV2ZW50LmN0cmxLZXkgKSB8fA0KCQkJCQkhc2VsZWN0ZWUuJGVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1zZWxlY3RlZCIgKTsNCgkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsIGRvU2VsZWN0ID8gInVpLXVuc2VsZWN0aW5nIiA6ICJ1aS1zZWxlY3RlZCIgKQ0KCQkJCQkuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgZG9TZWxlY3QgPyAidWktc2VsZWN0aW5nIiA6ICJ1aS11bnNlbGVjdGluZyIgKTsNCgkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9ICFkb1NlbGVjdDsNCgkJCQlzZWxlY3RlZS5zZWxlY3RpbmcgPSBkb1NlbGVjdDsNCgkJCQlzZWxlY3RlZS5zZWxlY3RlZCA9IGRvU2VsZWN0Ow0KDQoJCQkJLy8gc2VsZWN0YWJsZSAoVU4pU0VMRUNUSU5HIGNhbGxiYWNrDQoJCQkJaWYgKCBkb1NlbGVjdCApIHsNCgkJCQkJdGhhdC5fdHJpZ2dlciggInNlbGVjdGluZyIsIGV2ZW50LCB7DQoJCQkJCQlzZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQNCgkJCQkJfSApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXRoYXQuX3RyaWdnZXIoICJ1bnNlbGVjdGluZyIsIGV2ZW50LCB7DQoJCQkJCQl1bnNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudA0KCQkJCQl9ICk7DQoJCQkJfQ0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0NCgkJfSApOw0KDQoJfSwNCg0KCV9tb3VzZURyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQl0aGlzLmRyYWdnZWQgPSB0cnVlOw0KDQoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJdmFyIHRtcCwNCgkJCXRoYXQgPSB0aGlzLA0KCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywNCgkJCXgxID0gdGhpcy5vcG9zWyAwIF0sDQoJCQl5MSA9IHRoaXMub3Bvc1sgMSBdLA0KCQkJeDIgPSBldmVudC5wYWdlWCwNCgkJCXkyID0gZXZlbnQucGFnZVk7DQoNCgkJaWYgKCB4MSA+IHgyICkgeyB0bXAgPSB4MjsgeDIgPSB4MTsgeDEgPSB0bXA7IH0NCgkJaWYgKCB5MSA+IHkyICkgeyB0bXAgPSB5MjsgeTIgPSB5MTsgeTEgPSB0bXA7IH0NCgkJdGhpcy5oZWxwZXIuY3NzKCB7IGxlZnQ6IHgxLCB0b3A6IHkxLCB3aWR0aDogeDIgLSB4MSwgaGVpZ2h0OiB5MiAtIHkxIH0gKTsNCg0KCQl0aGlzLnNlbGVjdGVlcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCXZhciBzZWxlY3RlZSA9ICQuZGF0YSggdGhpcywgInNlbGVjdGFibGUtaXRlbSIgKSwNCgkJCQloaXQgPSBmYWxzZSwNCgkJCQlvZmZzZXQgPSB7fTsNCg0KCQkJLy9wcmV2ZW50IGhlbHBlciBmcm9tIGJlaW5nIHNlbGVjdGVkIGlmIGFwcGVuZFRvOiBzZWxlY3RhYmxlDQoJCQlpZiAoICFzZWxlY3RlZSB8fCBzZWxlY3RlZS5lbGVtZW50ID09PSB0aGF0LmVsZW1lbnRbIDAgXSApIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCW9mZnNldC5sZWZ0ICAgPSBzZWxlY3RlZS5sZWZ0ICAgKyB0aGF0LmVsZW1lbnRQb3MubGVmdDsNCgkJCW9mZnNldC5yaWdodCAgPSBzZWxlY3RlZS5yaWdodCAgKyB0aGF0LmVsZW1lbnRQb3MubGVmdDsNCgkJCW9mZnNldC50b3AgICAgPSBzZWxlY3RlZS50b3AgICAgKyB0aGF0LmVsZW1lbnRQb3MudG9wOw0KCQkJb2Zmc2V0LmJvdHRvbSA9IHNlbGVjdGVlLmJvdHRvbSArIHRoYXQuZWxlbWVudFBvcy50b3A7DQoNCgkJCWlmICggb3B0aW9ucy50b2xlcmFuY2UgPT09ICJ0b3VjaCIgKSB7DQoJCQkJaGl0ID0gKCAhKCBvZmZzZXQubGVmdCA+IHgyIHx8IG9mZnNldC5yaWdodCA8IHgxIHx8IG9mZnNldC50b3AgPiB5MiB8fA0KICAgICAgICAgICAgICAgICAgICBvZmZzZXQuYm90dG9tIDwgeTEgKSApOw0KCQkJfSBlbHNlIGlmICggb3B0aW9ucy50b2xlcmFuY2UgPT09ICJmaXQiICkgew0KCQkJCWhpdCA9ICggb2Zmc2V0LmxlZnQgPiB4MSAmJiBvZmZzZXQucmlnaHQgPCB4MiAmJiBvZmZzZXQudG9wID4geTEgJiYNCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LmJvdHRvbSA8IHkyICk7DQoJCQl9DQoNCgkJCWlmICggaGl0ICkgew0KDQoJCQkJLy8gU0VMRUNUDQoJCQkJaWYgKCBzZWxlY3RlZS5zZWxlY3RlZCApIHsNCgkJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0ZWQiICk7DQoJCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gZmFsc2U7DQoJCQkJfQ0KCQkJCWlmICggc2VsZWN0ZWUudW5zZWxlY3RpbmcgKSB7DQoJCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXVuc2VsZWN0aW5nIiApOw0KCQkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IGZhbHNlOw0KCQkJCX0NCgkJCQlpZiAoICFzZWxlY3RlZS5zZWxlY3RpbmcgKSB7DQoJCQkJCXRoYXQuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXNlbGVjdGluZyIgKTsNCgkJCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gdHJ1ZTsNCg0KCQkJCQkvLyBzZWxlY3RhYmxlIFNFTEVDVElORyBjYWxsYmFjaw0KCQkJCQl0aGF0Ll90cmlnZ2VyKCAic2VsZWN0aW5nIiwgZXZlbnQsIHsNCgkJCQkJCXNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudA0KCQkJCQl9ICk7DQoJCQkJfQ0KCQkJfSBlbHNlIHsNCg0KCQkJCS8vIFVOU0VMRUNUDQoJCQkJaWYgKCBzZWxlY3RlZS5zZWxlY3RpbmcgKSB7DQoJCQkJCWlmICggKCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LmN0cmxLZXkgKSAmJiBzZWxlY3RlZS5zdGFydHNlbGVjdGVkICkgew0KCQkJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0aW5nIiApOw0KCQkJCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gZmFsc2U7DQoJCQkJCQl0aGF0Ll9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RlZCIgKTsNCgkJCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gdHJ1ZTsNCgkJCQkJfSBlbHNlIHsNCgkJCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXNlbGVjdGluZyIgKTsNCgkJCQkJCXNlbGVjdGVlLnNlbGVjdGluZyA9IGZhbHNlOw0KCQkJCQkJaWYgKCBzZWxlY3RlZS5zdGFydHNlbGVjdGVkICkgew0KCQkJCQkJCXRoYXQuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXVuc2VsZWN0aW5nIiApOw0KCQkJCQkJCXNlbGVjdGVlLnVuc2VsZWN0aW5nID0gdHJ1ZTsNCgkJCQkJCX0NCg0KCQkJCQkJLy8gc2VsZWN0YWJsZSBVTlNFTEVDVElORyBjYWxsYmFjaw0KCQkJCQkJdGhhdC5fdHJpZ2dlciggInVuc2VsZWN0aW5nIiwgZXZlbnQsIHsNCgkJCQkJCQl1bnNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudA0KCQkJCQkJfSApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJCWlmICggc2VsZWN0ZWUuc2VsZWN0ZWQgKSB7DQoJCQkJCWlmICggIWV2ZW50Lm1ldGFLZXkgJiYgIWV2ZW50LmN0cmxLZXkgJiYgIXNlbGVjdGVlLnN0YXJ0c2VsZWN0ZWQgKSB7DQoJCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RlZCIgKTsNCgkJCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gZmFsc2U7DQoNCgkJCQkJCXRoYXQuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXVuc2VsZWN0aW5nIiApOw0KCQkJCQkJc2VsZWN0ZWUudW5zZWxlY3RpbmcgPSB0cnVlOw0KDQoJCQkJCQkvLyBzZWxlY3RhYmxlIFVOU0VMRUNUSU5HIGNhbGxiYWNrDQoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAidW5zZWxlY3RpbmciLCBldmVudCwgew0KCQkJCQkJCXVuc2VsZWN0aW5nOiBzZWxlY3RlZS5lbGVtZW50DQoJCQkJCQl9ICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0gKTsNCg0KCQlyZXR1cm4gZmFsc2U7DQoJfSwNCg0KCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIHRoYXQgPSB0aGlzOw0KDQoJCXRoaXMuZHJhZ2dlZCA9IGZhbHNlOw0KDQoJCSQoICIudWktdW5zZWxlY3RpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJdmFyIHNlbGVjdGVlID0gJC5kYXRhKCB0aGlzLCAic2VsZWN0YWJsZS1pdGVtIiApOw0KCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktdW5zZWxlY3RpbmciICk7DQoJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IGZhbHNlOw0KCQkJc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCA9IGZhbHNlOw0KCQkJdGhhdC5fdHJpZ2dlciggInVuc2VsZWN0ZWQiLCBldmVudCwgew0KCQkJCXVuc2VsZWN0ZWQ6IHNlbGVjdGVlLmVsZW1lbnQNCgkJCX0gKTsNCgkJfSApOw0KCQkkKCAiLnVpLXNlbGVjdGluZyIsIHRoaXMuZWxlbWVudFsgMCBdICkuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgc2VsZWN0ZWUgPSAkLmRhdGEoIHRoaXMsICJzZWxlY3RhYmxlLWl0ZW0iICk7DQoJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RpbmciICkNCgkJCQkuX2FkZENsYXNzKCBzZWxlY3RlZS4kZWxlbWVudCwgInVpLXNlbGVjdGVkIiApOw0KCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gZmFsc2U7DQoJCQlzZWxlY3RlZS5zZWxlY3RlZCA9IHRydWU7DQoJCQlzZWxlY3RlZS5zdGFydHNlbGVjdGVkID0gdHJ1ZTsNCgkJCXRoYXQuX3RyaWdnZXIoICJzZWxlY3RlZCIsIGV2ZW50LCB7DQoJCQkJc2VsZWN0ZWQ6IHNlbGVjdGVlLmVsZW1lbnQNCgkJCX0gKTsNCgkJfSApOw0KCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50ICk7DQoNCgkJdGhpcy5oZWxwZXIucmVtb3ZlKCk7DQoNCgkJcmV0dXJuIGZhbHNlOw0KCX0NCg0KfSApOw0KDQoNCi8qIQ0KICogalF1ZXJ5IFVJIFNlbGVjdG1lbnUgMS4xMi4xDQogKiBodHRwOi8vanF1ZXJ5dWkuY29tDQogKg0KICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMNCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UNCiAqLw0KDQovLz4+bGFiZWw6IFNlbGVjdG1lbnUNCi8vPj5ncm91cDogV2lkZ2V0cw0KLy8ganNjczpkaXNhYmxlIG1heGltdW1MaW5lTGVuZ3RoDQovLz4+ZGVzY3JpcHRpb246IER1cGxpY2F0ZXMgYW5kIGV4dGVuZHMgdGhlIGZ1bmN0aW9uYWxpdHkgb2YgYSBuYXRpdmUgSFRNTCBzZWxlY3QgZWxlbWVudCwgYWxsb3dpbmcgaXQgdG8gYmUgY3VzdG9taXphYmxlIGluIGJlaGF2aW9yIGFuZCBhcHBlYXJhbmNlIGZhciBiZXlvbmQgdGhlIGxpbWl0YXRpb25zIG9mIGEgbmF0aXZlIHNlbGVjdC4NCi8vIGpzY3M6ZW5hYmxlIG1heGltdW1MaW5lTGVuZ3RoDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2VsZWN0bWVudS8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9zZWxlY3RtZW51Lw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2Uvc2VsZWN0bWVudS5jc3MsIC4uLy4uL3RoZW1lcy9iYXNlL2J1dHRvbi5jc3MNCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcw0KDQoNCg0KdmFyIHdpZGdldHNTZWxlY3RtZW51ID0gJC53aWRnZXQoICJ1aS5zZWxlY3RtZW51IiwgWyAkLnVpLmZvcm1SZXNldE1peGluLCB7DQoJdmVyc2lvbjogIjEuMTIuMSIsDQoJZGVmYXVsdEVsZW1lbnQ6ICI8c2VsZWN0PiIsDQoJb3B0aW9uczogew0KCQlhcHBlbmRUbzogbnVsbCwNCgkJY2xhc3Nlczogew0KCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLW9wZW4iOiAidWktY29ybmVyLXRvcCIsDQoJCQkidWktc2VsZWN0bWVudS1idXR0b24tY2xvc2VkIjogInVpLWNvcm5lci1hbGwiDQoJCX0sDQoJCWRpc2FibGVkOiBudWxsLA0KCQlpY29uczogew0KCQkJYnV0dG9uOiAidWktaWNvbi10cmlhbmdsZS0xLXMiDQoJCX0sDQoJCXBvc2l0aW9uOiB7DQoJCQlteTogImxlZnQgdG9wIiwNCgkJCWF0OiAibGVmdCBib3R0b20iLA0KCQkJY29sbGlzaW9uOiAibm9uZSINCgkJfSwNCgkJd2lkdGg6IGZhbHNlLA0KDQoJCS8vIENhbGxiYWNrcw0KCQljaGFuZ2U6IG51bGwsDQoJCWNsb3NlOiBudWxsLA0KCQlmb2N1czogbnVsbCwNCgkJb3BlbjogbnVsbCwNCgkJc2VsZWN0OiBudWxsDQoJfSwNCg0KCV9jcmVhdGU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgc2VsZWN0bWVudUlkID0gdGhpcy5lbGVtZW50LnVuaXF1ZUlkKCkuYXR0ciggImlkIiApOw0KCQl0aGlzLmlkcyA9IHsNCgkJCWVsZW1lbnQ6IHNlbGVjdG1lbnVJZCwNCgkJCWJ1dHRvbjogc2VsZWN0bWVudUlkICsgIi1idXR0b24iLA0KCQkJbWVudTogc2VsZWN0bWVudUlkICsgIi1tZW51Ig0KCQl9Ow0KDQoJCXRoaXMuX2RyYXdCdXR0b24oKTsNCgkJdGhpcy5fZHJhd01lbnUoKTsNCgkJdGhpcy5fYmluZEZvcm1SZXNldEhhbmRsZXIoKTsNCg0KCQl0aGlzLl9yZW5kZXJlZCA9IGZhbHNlOw0KCQl0aGlzLm1lbnVJdGVtcyA9ICQoKTsNCgl9LA0KDQoJX2RyYXdCdXR0b246IGZ1bmN0aW9uKCkgew0KCQl2YXIgaWNvbiwNCgkJCXRoYXQgPSB0aGlzLA0KCQkJaXRlbSA9IHRoaXMuX3BhcnNlT3B0aW9uKA0KCQkJCXRoaXMuZWxlbWVudC5maW5kKCAib3B0aW9uOnNlbGVjdGVkIiApLA0KCQkJCXRoaXMuZWxlbWVudFsgMCBdLnNlbGVjdGVkSW5kZXgNCgkJCSk7DQoNCgkJLy8gQXNzb2NpYXRlIGV4aXN0aW5nIGxhYmVsIHdpdGggdGhlIG5ldyBidXR0b24NCgkJdGhpcy5sYWJlbHMgPSB0aGlzLmVsZW1lbnQubGFiZWxzKCkuYXR0ciggImZvciIsIHRoaXMuaWRzLmJ1dHRvbiApOw0KCQl0aGlzLl9vbiggdGhpcy5sYWJlbHMsIHsNCgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJdGhpcy5idXR0b24uZm9jdXMoKTsNCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQkJfQ0KCQl9ICk7DQoNCgkJLy8gSGlkZSBvcmlnaW5hbCBzZWxlY3QgZWxlbWVudA0KCQl0aGlzLmVsZW1lbnQuaGlkZSgpOw0KDQoJCS8vIENyZWF0ZSBidXR0b24NCgkJdGhpcy5idXR0b24gPSAkKCAiPHNwYW4+Iiwgew0KCQkJdGFiaW5kZXg6IHRoaXMub3B0aW9ucy5kaXNhYmxlZCA\/IC0xIDogMCwNCgkJCWlkOiB0aGlzLmlkcy5idXR0b24sDQoJCQlyb2xlOiAiY29tYm9ib3giLA0KCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLA0KCQkJImFyaWEtYXV0b2NvbXBsZXRlIjogImxpc3QiLA0KCQkJImFyaWEtb3ducyI6IHRoaXMuaWRzLm1lbnUsDQoJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwNCgkJCXRpdGxlOiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApDQoJCX0gKQ0KCQkJLmluc2VydEFmdGVyKCB0aGlzLmVsZW1lbnQgKTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5idXR0b24sICJ1aS1zZWxlY3RtZW51LWJ1dHRvbiB1aS1zZWxlY3RtZW51LWJ1dHRvbi1jbG9zZWQiLA0KCQkJInVpLWJ1dHRvbiB1aS13aWRnZXQiICk7DQoNCgkJaWNvbiA9ICQoICI8c3Bhbj4iICkuYXBwZW5kVG8oIHRoaXMuYnV0dG9uICk7DQoJCXRoaXMuX2FkZENsYXNzKCBpY29uLCAidWktc2VsZWN0bWVudS1pY29uIiwgInVpLWljb24gIiArIHRoaXMub3B0aW9ucy5pY29ucy5idXR0b24gKTsNCgkJdGhpcy5idXR0b25JdGVtID0gdGhpcy5fcmVuZGVyQnV0dG9uSXRlbSggaXRlbSApDQoJCQkuYXBwZW5kVG8oIHRoaXMuYnV0dG9uICk7DQoNCgkJaWYgKCB0aGlzLm9wdGlvbnMud2lkdGggIT09IGZhbHNlICkgew0KCQkJdGhpcy5fcmVzaXplQnV0dG9uKCk7DQoJCX0NCg0KCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHRoaXMuX2J1dHRvbkV2ZW50cyApOw0KCQl0aGlzLmJ1dHRvbi5vbmUoICJmb2N1c2luIiwgZnVuY3Rpb24oKSB7DQoNCgkJCS8vIERlbGF5IHJlbmRlcmluZyB0aGUgbWVudSBpdGVtcyB1bnRpbCB0aGUgYnV0dG9uIHJlY2VpdmVzIGZvY3VzLg0KCQkJLy8gVGhlIG1lbnUgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIHJlbmRlcmVkIHZpYSBhIHByb2dyYW1tYXRpYyBvcGVuLg0KCQkJaWYgKCAhdGhhdC5fcmVuZGVyZWQgKSB7DQoJCQkJdGhhdC5fcmVmcmVzaE1lbnUoKTsNCgkJCX0NCgkJfSApOw0KCX0sDQoNCglfZHJhd01lbnU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9IHRoaXM7DQoNCgkJLy8gQ3JlYXRlIG1lbnUNCgkJdGhpcy5tZW51ID0gJCggIjx1bD4iLCB7DQoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIsDQoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogdGhpcy5pZHMuYnV0dG9uLA0KCQkJaWQ6IHRoaXMuaWRzLm1lbnUNCgkJfSApOw0KDQoJCS8vIFdyYXAgbWVudQ0KCQl0aGlzLm1lbnVXcmFwID0gJCggIjxkaXY+IiApLmFwcGVuZCggdGhpcy5tZW51ICk7DQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLm1lbnVXcmFwLCAidWktc2VsZWN0bWVudS1tZW51IiwgInVpLWZyb250IiApOw0KCQl0aGlzLm1lbnVXcmFwLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7DQoNCgkJLy8gSW5pdGlhbGl6ZSBtZW51IHdpZGdldA0KCQl0aGlzLm1lbnVJbnN0YW5jZSA9IHRoaXMubWVudQ0KCQkJLm1lbnUoIHsNCgkJCQljbGFzc2VzOiB7DQoJCQkJCSJ1aS1tZW51IjogInVpLWNvcm5lci1ib3R0b20iDQoJCQkJfSwNCgkJCQlyb2xlOiAibGlzdGJveCIsDQoJCQkJc2VsZWN0OiBmdW5jdGlvbiggZXZlbnQsIHVpICkgew0KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KDQoJCQkJCS8vIFN1cHBvcnQ6IElFOA0KCQkJCQkvLyBJZiB0aGUgaXRlbSB3YXMgc2VsZWN0ZWQgdmlhIGEgY2xpY2ssIHRoZSB0ZXh0IHNlbGVjdGlvbg0KCQkJCQkvLyB3aWxsIGJlIGRlc3Ryb3llZCBpbiBJRQ0KCQkJCQl0aGF0Ll9zZXRTZWxlY3Rpb24oKTsNCg0KCQkJCQl0aGF0Ll9zZWxlY3QoIHVpLml0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKSwgZXZlbnQgKTsNCgkJCQl9LA0KCQkJCWZvY3VzOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgew0KCQkJCQl2YXIgaXRlbSA9IHVpLml0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKTsNCg0KCQkJCQkvLyBQcmV2ZW50IGluaXRhbCBmb2N1cyBmcm9tIGZpcmluZyBhbmQgY2hlY2sgaWYgaXRzIGEgbmV3bHkgZm9jdXNlZCBpdGVtDQoJCQkJCWlmICggdGhhdC5mb2N1c0luZGV4ICE9IG51bGwgJiYgaXRlbS5pbmRleCAhPT0gdGhhdC5mb2N1c0luZGV4ICkgew0KCQkJCQkJdGhhdC5fdHJpZ2dlciggImZvY3VzIiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICk7DQoJCQkJCQlpZiAoICF0aGF0LmlzT3BlbiApIHsNCgkJCQkJCQl0aGF0Ll9zZWxlY3QoIGl0ZW0sIGV2ZW50ICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJdGhhdC5mb2N1c0luZGV4ID0gaXRlbS5pbmRleDsNCg0KCQkJCQl0aGF0LmJ1dHRvbi5hdHRyKCAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwNCgkJCQkJCXRoYXQubWVudUl0ZW1zLmVxKCBpdGVtLmluZGV4ICkuYXR0ciggImlkIiApICk7DQoJCQkJfQ0KCQkJfSApDQoJCQkubWVudSggImluc3RhbmNlIiApOw0KDQoJCS8vIERvbid0IGNsb3NlIHRoZSBtZW51IG9uIG1vdXNlbGVhdmUNCgkJdGhpcy5tZW51SW5zdGFuY2UuX29mZiggdGhpcy5tZW51LCAibW91c2VsZWF2ZSIgKTsNCg0KCQkvLyBDYW5jZWwgdGhlIG1lbnUncyBjb2xsYXBzZUFsbCBvbiBkb2N1bWVudCBjbGljaw0KCQl0aGlzLm1lbnVJbnN0YW5jZS5fY2xvc2VPbkRvY3VtZW50Q2xpY2sgPSBmdW5jdGlvbigpIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfTsNCg0KCQkvLyBTZWxlY3RzIG9mdGVuIGNvbnRhaW4gZW1wdHkgaXRlbXMsIGJ1dCBuZXZlciBjb250YWluIGRpdmlkZXJzDQoJCXRoaXMubWVudUluc3RhbmNlLl9pc0RpdmlkZXIgPSBmdW5jdGlvbigpIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfTsNCgl9LA0KDQoJcmVmcmVzaDogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX3JlZnJlc2hNZW51KCk7DQoJCXRoaXMuYnV0dG9uSXRlbS5yZXBsYWNlV2l0aCgNCgkJCXRoaXMuYnV0dG9uSXRlbSA9IHRoaXMuX3JlbmRlckJ1dHRvbkl0ZW0oDQoNCgkJCQkvLyBGYWxsIGJhY2sgdG8gYW4gZW1wdHkgb2JqZWN0IGluIGNhc2UgdGhlcmUgYXJlIG5vIG9wdGlvbnMNCgkJCQl0aGlzLl9nZXRTZWxlY3RlZEl0ZW0oKS5kYXRhKCAidWktc2VsZWN0bWVudS1pdGVtIiApIHx8IHt9DQoJCQkpDQoJCSk7DQoJCWlmICggdGhpcy5vcHRpb25zLndpZHRoID09PSBudWxsICkgew0KCQkJdGhpcy5fcmVzaXplQnV0dG9uKCk7DQoJCX0NCgl9LA0KDQoJX3JlZnJlc2hNZW51OiBmdW5jdGlvbigpIHsNCgkJdmFyIGl0ZW0sDQoJCQlvcHRpb25zID0gdGhpcy5lbGVtZW50LmZpbmQoICJvcHRpb24iICk7DQoNCgkJdGhpcy5tZW51LmVtcHR5KCk7DQoNCgkJdGhpcy5fcGFyc2VPcHRpb25zKCBvcHRpb25zICk7DQoJCXRoaXMuX3JlbmRlck1lbnUoIHRoaXMubWVudSwgdGhpcy5pdGVtcyApOw0KDQoJCXRoaXMubWVudUluc3RhbmNlLnJlZnJlc2goKTsNCgkJdGhpcy5tZW51SXRlbXMgPSB0aGlzLm1lbnUuZmluZCggImxpIiApDQoJCQkubm90KCAiLnVpLXNlbGVjdG1lbnUtb3B0Z3JvdXAiICkNCgkJCQkuZmluZCggIi51aS1tZW51LWl0ZW0td3JhcHBlciIgKTsNCg0KCQl0aGlzLl9yZW5kZXJlZCA9IHRydWU7DQoNCgkJaWYgKCAhb3B0aW9ucy5sZW5ndGggKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlpdGVtID0gdGhpcy5fZ2V0U2VsZWN0ZWRJdGVtKCk7DQoNCgkJLy8gVXBkYXRlIHRoZSBtZW51IHRvIGhhdmUgdGhlIGNvcnJlY3QgaXRlbSBmb2N1c2VkDQoJCXRoaXMubWVudUluc3RhbmNlLmZvY3VzKCBudWxsLCBpdGVtICk7DQoJCXRoaXMuX3NldEFyaWEoIGl0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKSApOw0KDQoJCS8vIFNldCBkaXNhYmxlZCBzdGF0ZQ0KCQl0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKTsNCgl9LA0KDQoJb3BlbjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHRpbWUgdGhlIG1lbnUgaXMgYmVpbmcgb3BlbmVkLCByZW5kZXIgdGhlIGl0ZW1zDQoJCWlmICggIXRoaXMuX3JlbmRlcmVkICkgew0KCQkJdGhpcy5fcmVmcmVzaE1lbnUoKTsNCgkJfSBlbHNlIHsNCg0KCQkJLy8gTWVudSBjbGVhcnMgZm9jdXMgb24gY2xvc2UsIHJlc2V0IGZvY3VzIHRvIHNlbGVjdGVkIGl0ZW0NCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLm1lbnUuZmluZCggIi51aS1zdGF0ZS1hY3RpdmUiICksIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoJCQl0aGlzLm1lbnVJbnN0YW5jZS5mb2N1cyggbnVsbCwgdGhpcy5fZ2V0U2VsZWN0ZWRJdGVtKCkgKTsNCgkJfQ0KDQoJCS8vIElmIHRoZXJlIGFyZSBubyBvcHRpb25zLCBkb24ndCBvcGVuIHRoZSBtZW51DQoJCWlmICggIXRoaXMubWVudUl0ZW1zLmxlbmd0aCApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXRoaXMuaXNPcGVuID0gdHJ1ZTsNCgkJdGhpcy5fdG9nZ2xlQXR0cigpOw0KCQl0aGlzLl9yZXNpemVNZW51KCk7DQoJCXRoaXMuX3Bvc2l0aW9uKCk7DQoNCgkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHRoaXMuX2RvY3VtZW50Q2xpY2sgKTsNCg0KCQl0aGlzLl90cmlnZ2VyKCAib3BlbiIsIGV2ZW50ICk7DQoJfSwNCg0KCV9wb3NpdGlvbjogZnVuY3Rpb24oKSB7DQoJCXRoaXMubWVudVdyYXAucG9zaXRpb24oICQuZXh0ZW5kKCB7IG9mOiB0aGlzLmJ1dHRvbiB9LCB0aGlzLm9wdGlvbnMucG9zaXRpb24gKSApOw0KCX0sDQoNCgljbG9zZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoICF0aGlzLmlzT3BlbiApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXRoaXMuaXNPcGVuID0gZmFsc2U7DQoJCXRoaXMuX3RvZ2dsZUF0dHIoKTsNCg0KCQl0aGlzLnJhbmdlID0gbnVsbDsNCgkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50ICk7DQoNCgkJdGhpcy5fdHJpZ2dlciggImNsb3NlIiwgZXZlbnQgKTsNCgl9LA0KDQoJd2lkZ2V0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMuYnV0dG9uOw0KCX0sDQoNCgltZW51V2lkZ2V0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMubWVudTsNCgl9LA0KDQoJX3JlbmRlckJ1dHRvbkl0ZW06IGZ1bmN0aW9uKCBpdGVtICkgew0KCQl2YXIgYnV0dG9uSXRlbSA9ICQoICI8c3Bhbj4iICk7DQoNCgkJdGhpcy5fc2V0VGV4dCggYnV0dG9uSXRlbSwgaXRlbS5sYWJlbCApOw0KCQl0aGlzLl9hZGRDbGFzcyggYnV0dG9uSXRlbSwgInVpLXNlbGVjdG1lbnUtdGV4dCIgKTsNCg0KCQlyZXR1cm4gYnV0dG9uSXRlbTsNCgl9LA0KDQoJX3JlbmRlck1lbnU6IGZ1bmN0aW9uKCB1bCwgaXRlbXMgKSB7DQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCWN1cnJlbnRPcHRncm91cCA9ICIiOw0KDQoJCSQuZWFjaCggaXRlbXMsIGZ1bmN0aW9uKCBpbmRleCwgaXRlbSApIHsNCgkJCXZhciBsaTsNCg0KCQkJaWYgKCBpdGVtLm9wdGdyb3VwICE9PSBjdXJyZW50T3B0Z3JvdXAgKSB7DQoJCQkJbGkgPSAkKCAiPGxpPiIsIHsNCgkJCQkJdGV4dDogaXRlbS5vcHRncm91cA0KCQkJCX0gKTsNCgkJCQl0aGF0Ll9hZGRDbGFzcyggbGksICJ1aS1zZWxlY3RtZW51LW9wdGdyb3VwIiwgInVpLW1lbnUtZGl2aWRlciIgKw0KCQkJCQkoIGl0ZW0uZWxlbWVudC5wYXJlbnQoICJvcHRncm91cCIgKS5wcm9wKCAiZGlzYWJsZWQiICkgPw0KCQkJCQkJIiB1aS1zdGF0ZS1kaXNhYmxlZCIgOg0KCQkJCQkJIiIgKSApOw0KDQoJCQkJbGkuYXBwZW5kVG8oIHVsICk7DQoNCgkJCQljdXJyZW50T3B0Z3JvdXAgPSBpdGVtLm9wdGdyb3VwOw0KCQkJfQ0KDQoJCQl0aGF0Ll9yZW5kZXJJdGVtRGF0YSggdWwsIGl0ZW0gKTsNCgkJfSApOw0KCX0sDQoNCglfcmVuZGVySXRlbURhdGE6IGZ1bmN0aW9uKCB1bCwgaXRlbSApIHsNCgkJcmV0dXJuIHRoaXMuX3JlbmRlckl0ZW0oIHVsLCBpdGVtICkuZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIsIGl0ZW0gKTsNCgl9LA0KDQoJX3JlbmRlckl0ZW06IGZ1bmN0aW9uKCB1bCwgaXRlbSApIHsNCgkJdmFyIGxpID0gJCggIjxsaT4iICksDQoJCQl3cmFwcGVyID0gJCggIjxkaXY+Iiwgew0KCQkJCXRpdGxlOiBpdGVtLmVsZW1lbnQuYXR0ciggInRpdGxlIiApDQoJCQl9ICk7DQoNCgkJaWYgKCBpdGVtLmRpc2FibGVkICkgew0KCQkJdGhpcy5fYWRkQ2xhc3MoIGxpLCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiICk7DQoJCX0NCgkJdGhpcy5fc2V0VGV4dCggd3JhcHBlciwgaXRlbS5sYWJlbCApOw0KDQoJCXJldHVybiBsaS5hcHBlbmQoIHdyYXBwZXIgKS5hcHBlbmRUbyggdWwgKTsNCgl9LA0KDQoJX3NldFRleHQ6IGZ1bmN0aW9uKCBlbGVtZW50LCB2YWx1ZSApIHsNCgkJaWYgKCB2YWx1ZSApIHsNCgkJCWVsZW1lbnQudGV4dCggdmFsdWUgKTsNCgkJfSBlbHNlIHsNCgkJCWVsZW1lbnQuaHRtbCggIiYjMTYwOyIgKTsNCgkJfQ0KCX0sDQoNCglfbW92ZTogZnVuY3Rpb24oIGRpcmVjdGlvbiwgZXZlbnQgKSB7DQoJCXZhciBpdGVtLCBuZXh0LA0KCQkJZmlsdGVyID0gIi51aS1tZW51LWl0ZW0iOw0KDQoJCWlmICggdGhpcy5pc09wZW4gKSB7DQoJCQlpdGVtID0gdGhpcy5tZW51SXRlbXMuZXEoIHRoaXMuZm9jdXNJbmRleCApLnBhcmVudCggImxpIiApOw0KCQl9IGVsc2Ugew0KCQkJaXRlbSA9IHRoaXMubWVudUl0ZW1zLmVxKCB0aGlzLmVsZW1lbnRbIDAgXS5zZWxlY3RlZEluZGV4ICkucGFyZW50KCAibGkiICk7DQoJCQlmaWx0ZXIgKz0gIjpub3QoLnVpLXN0YXRlLWRpc2FibGVkKSI7DQoJCX0NCg0KCQlpZiAoIGRpcmVjdGlvbiA9PT0gImZpcnN0IiB8fCBkaXJlY3Rpb24gPT09ICJsYXN0IiApIHsNCgkJCW5leHQgPSBpdGVtWyBkaXJlY3Rpb24gPT09ICJmaXJzdCIgPyAicHJldkFsbCIgOiAibmV4dEFsbCIgXSggZmlsdGVyICkuZXEoIC0xICk7DQoJCX0gZWxzZSB7DQoJCQluZXh0ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSggZmlsdGVyICkuZXEoIDAgKTsNCgkJfQ0KDQoJCWlmICggbmV4dC5sZW5ndGggKSB7DQoJCQl0aGlzLm1lbnVJbnN0YW5jZS5mb2N1cyggZXZlbnQsIG5leHQgKTsNCgkJfQ0KCX0sDQoNCglfZ2V0U2VsZWN0ZWRJdGVtOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMubWVudUl0ZW1zLmVxKCB0aGlzLmVsZW1lbnRbIDAgXS5zZWxlY3RlZEluZGV4ICkucGFyZW50KCAibGkiICk7DQoJfSwNCg0KCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdGhpc1sgdGhpcy5pc09wZW4gPyAiY2xvc2UiIDogIm9wZW4iIF0oIGV2ZW50ICk7DQoJfSwNCg0KCV9zZXRTZWxlY3Rpb246IGZ1bmN0aW9uKCkgew0KCQl2YXIgc2VsZWN0aW9uOw0KDQoJCWlmICggIXRoaXMucmFuZ2UgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlpZiAoIHdpbmRvdy5nZXRTZWxlY3Rpb24gKSB7DQoJCQlzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7DQoJCQlzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7DQoJCQlzZWxlY3Rpb24uYWRkUmFuZ2UoIHRoaXMucmFuZ2UgKTsNCg0KCQkvLyBTdXBwb3J0OiBJRTgNCgkJfSBlbHNlIHsNCgkJCXRoaXMucmFuZ2Uuc2VsZWN0KCk7DQoJCX0NCg0KCQkvLyBTdXBwb3J0OiBJRQ0KCQkvLyBTZXR0aW5nIHRoZSB0ZXh0IHNlbGVjdGlvbiBraWxscyB0aGUgYnV0dG9uIGZvY3VzIGluIElFLCBidXQNCgkJLy8gcmVzdG9yaW5nIHRoZSBmb2N1cyBkb2Vzbid0IGtpbGwgdGhlIHNlbGVjdGlvbi4NCgkJdGhpcy5idXR0b24uZm9jdXMoKTsNCgl9LA0KDQoJX2RvY3VtZW50Q2xpY2s6IHsNCgkJbW91c2Vkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQlpZiAoICF0aGlzLmlzT3BlbiApIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoNCgkJCWlmICggISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktc2VsZWN0bWVudS1tZW51LCAjIiArDQoJCQkJCSQudWkuZXNjYXBlU2VsZWN0b3IoIHRoaXMuaWRzLmJ1dHRvbiApICkubGVuZ3RoICkgew0KCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7DQoJCQl9DQoJCX0NCgl9LA0KDQoJX2J1dHRvbkV2ZW50czogew0KDQoJCS8vIFByZXZlbnQgdGV4dCBzZWxlY3Rpb24gZnJvbSBiZWluZyByZXNldCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIHNlbGVjdG1lbnUgKCMxMDE0NCkNCgkJbW91c2Vkb3duOiBmdW5jdGlvbigpIHsNCgkJCXZhciBzZWxlY3Rpb247DQoNCgkJCWlmICggd2luZG93LmdldFNlbGVjdGlvbiApIHsNCgkJCQlzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7DQoJCQkJaWYgKCBzZWxlY3Rpb24ucmFuZ2VDb3VudCApIHsNCgkJCQkJdGhpcy5yYW5nZSA9IHNlbGVjdGlvbi5nZXRSYW5nZUF0KCAwICk7DQoJCQkJfQ0KDQoJCQkvLyBTdXBwb3J0OiBJRTgNCgkJCX0gZWxzZSB7DQoJCQkJdGhpcy5yYW5nZSA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOw0KCQkJfQ0KCQl9LA0KDQoJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQl0aGlzLl9zZXRTZWxlY3Rpb24oKTsNCgkJCXRoaXMuX3RvZ2dsZSggZXZlbnQgKTsNCgkJfSwNCg0KCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQl2YXIgcHJldmVudERlZmF1bHQgPSB0cnVlOw0KCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsNCgkJCWNhc2UgJC51aS5rZXlDb2RlLlRBQjoNCgkJCWNhc2UgJC51aS5rZXlDb2RlLkVTQ0FQRToNCgkJCQl0aGlzLmNsb3NlKCBldmVudCApOw0KCQkJCXByZXZlbnREZWZhdWx0ID0gZmFsc2U7DQoJCQkJYnJlYWs7DQoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoNCgkJCQlpZiAoIHRoaXMuaXNPcGVuICkgew0KCQkJCQl0aGlzLl9zZWxlY3RGb2N1c2VkSXRlbSggZXZlbnQgKTsNCgkJCQl9DQoJCQkJYnJlYWs7DQoJCQljYXNlICQudWkua2V5Q29kZS5VUDoNCgkJCQlpZiAoIGV2ZW50LmFsdEtleSApIHsNCgkJCQkJdGhpcy5fdG9nZ2xlKCBldmVudCApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXRoaXMuX21vdmUoICJwcmV2IiwgZXZlbnQgKTsNCgkJCQl9DQoJCQkJYnJlYWs7DQoJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOg0KCQkJCWlmICggZXZlbnQuYWx0S2V5ICkgew0KCQkJCQl0aGlzLl90b2dnbGUoIGV2ZW50ICk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJdGhpcy5fbW92ZSggIm5leHQiLCBldmVudCApOw0KCQkJCX0NCgkJCQlicmVhazsNCgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOg0KCQkJCWlmICggdGhpcy5pc09wZW4gKSB7DQoJCQkJCXRoaXMuX3NlbGVjdEZvY3VzZWRJdGVtKCBldmVudCApOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXRoaXMuX3RvZ2dsZSggZXZlbnQgKTsNCgkJCQl9DQoJCQkJYnJlYWs7DQoJCQljYXNlICQudWkua2V5Q29kZS5MRUZUOg0KCQkJCXRoaXMuX21vdmUoICJwcmV2IiwgZXZlbnQgKTsNCgkJCQlicmVhazsNCgkJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOg0KCQkJCXRoaXMuX21vdmUoICJuZXh0IiwgZXZlbnQgKTsNCgkJCQlicmVhazsNCgkJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6DQoJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX1VQOg0KCQkJCXRoaXMuX21vdmUoICJmaXJzdCIsIGV2ZW50ICk7DQoJCQkJYnJlYWs7DQoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6DQoJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX0RPV046DQoJCQkJdGhpcy5fbW92ZSggImxhc3QiLCBldmVudCApOw0KCQkJCWJyZWFrOw0KCQkJZGVmYXVsdDoNCgkJCQl0aGlzLm1lbnUudHJpZ2dlciggZXZlbnQgKTsNCgkJCQlwcmV2ZW50RGVmYXVsdCA9IGZhbHNlOw0KCQkJfQ0KDQoJCQlpZiAoIHByZXZlbnREZWZhdWx0ICkgew0KCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQl9DQoJCX0NCgl9LA0KDQoJX3NlbGVjdEZvY3VzZWRJdGVtOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBpdGVtID0gdGhpcy5tZW51SXRlbXMuZXEoIHRoaXMuZm9jdXNJbmRleCApLnBhcmVudCggImxpIiApOw0KCQlpZiAoICFpdGVtLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7DQoJCQl0aGlzLl9zZWxlY3QoIGl0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKSwgZXZlbnQgKTsNCgkJfQ0KCX0sDQoNCglfc2VsZWN0OiBmdW5jdGlvbiggaXRlbSwgZXZlbnQgKSB7DQoJCXZhciBvbGRJbmRleCA9IHRoaXMuZWxlbWVudFsgMCBdLnNlbGVjdGVkSW5kZXg7DQoNCgkJLy8gQ2hhbmdlIG5hdGl2ZSBzZWxlY3QgZWxlbWVudA0KCQl0aGlzLmVsZW1lbnRbIDAgXS5zZWxlY3RlZEluZGV4ID0gaXRlbS5pbmRleDsNCgkJdGhpcy5idXR0b25JdGVtLnJlcGxhY2VXaXRoKCB0aGlzLmJ1dHRvbkl0ZW0gPSB0aGlzLl9yZW5kZXJCdXR0b25JdGVtKCBpdGVtICkgKTsNCgkJdGhpcy5fc2V0QXJpYSggaXRlbSApOw0KCQl0aGlzLl90cmlnZ2VyKCAic2VsZWN0IiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICk7DQoNCgkJaWYgKCBpdGVtLmluZGV4ICE9PSBvbGRJbmRleCApIHsNCgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiLCBldmVudCwgeyBpdGVtOiBpdGVtIH0gKTsNCgkJfQ0KDQoJCXRoaXMuY2xvc2UoIGV2ZW50ICk7DQoJfSwNCg0KCV9zZXRBcmlhOiBmdW5jdGlvbiggaXRlbSApIHsNCgkJdmFyIGlkID0gdGhpcy5tZW51SXRlbXMuZXEoIGl0ZW0uaW5kZXggKS5hdHRyKCAiaWQiICk7DQoNCgkJdGhpcy5idXR0b24uYXR0ciggew0KCQkJImFyaWEtbGFiZWxsZWRieSI6IGlkLA0KCQkJImFyaWEtYWN0aXZlZGVzY2VuZGFudCI6IGlkDQoJCX0gKTsNCgkJdGhpcy5tZW51LmF0dHIoICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLCBpZCApOw0KCX0sDQoNCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsNCgkJaWYgKCBrZXkgPT09ICJpY29ucyIgKSB7DQoJCQl2YXIgaWNvbiA9IHRoaXMuYnV0dG9uLmZpbmQoICJzcGFuLnVpLWljb24iICk7DQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggaWNvbiwgbnVsbCwgdGhpcy5vcHRpb25zLmljb25zLmJ1dHRvbiApDQoJCQkJLl9hZGRDbGFzcyggaWNvbiwgbnVsbCwgdmFsdWUuYnV0dG9uICk7DQoJCX0NCg0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KDQoJCWlmICgga2V5ID09PSAiYXBwZW5kVG8iICkgew0KCQkJdGhpcy5tZW51V3JhcC5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOw0KCQl9DQoNCgkJaWYgKCBrZXkgPT09ICJ3aWR0aCIgKSB7DQoJCQl0aGlzLl9yZXNpemVCdXR0b24oKTsNCgkJfQ0KCX0sDQoNCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7DQoNCgkJdGhpcy5tZW51SW5zdGFuY2Uub3B0aW9uKCAiZGlzYWJsZWQiLCB2YWx1ZSApOw0KCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7DQoJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLmJ1dHRvbiwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgdmFsdWUgKTsNCg0KCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsNCgkJaWYgKCB2YWx1ZSApIHsNCgkJCXRoaXMuYnV0dG9uLmF0dHIoICJ0YWJpbmRleCIsIC0xICk7DQoJCQl0aGlzLmNsb3NlKCk7DQoJCX0gZWxzZSB7DQoJCQl0aGlzLmJ1dHRvbi5hdHRyKCAidGFiaW5kZXgiLCAwICk7DQoJCX0NCgl9LA0KDQoJX2FwcGVuZFRvOiBmdW5jdGlvbigpIHsNCgkJdmFyIGVsZW1lbnQgPSB0aGlzLm9wdGlvbnMuYXBwZW5kVG87DQoNCgkJaWYgKCBlbGVtZW50ICkgew0KCQkJZWxlbWVudCA9IGVsZW1lbnQuanF1ZXJ5IHx8IGVsZW1lbnQubm9kZVR5cGUgPw0KCQkJCSQoIGVsZW1lbnQgKSA6DQoJCQkJdGhpcy5kb2N1bWVudC5maW5kKCBlbGVtZW50ICkuZXEoIDAgKTsNCgkJfQ0KDQoJCWlmICggIWVsZW1lbnQgfHwgIWVsZW1lbnRbIDAgXSApIHsNCgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1mcm9udCwgZGlhbG9nIiApOw0KCQl9DQoNCgkJaWYgKCAhZWxlbWVudC5sZW5ndGggKSB7DQoJCQllbGVtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHk7DQoJCX0NCg0KCQlyZXR1cm4gZWxlbWVudDsNCgl9LA0KDQoJX3RvZ2dsZUF0dHI6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1leHBhbmRlZCIsIHRoaXMuaXNPcGVuICk7DQoNCgkJLy8gV2UgY2FuJ3QgdXNlIHR3byBfdG9nZ2xlQ2xhc3MoKSBjYWxscyBoZXJlLCBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlDQoJCS8vIHdlIGFsd2F5cyByZW1vdmUgY2xhc3NlcyBmaXJzdCBhbmQgYWRkIHRoZW0gc2Vjb25kLCBvdGhlcndpc2UgaWYgYm90aCBjbGFzc2VzIGhhdmUgdGhlDQoJCS8vIHNhbWUgdGhlbWUgY2xhc3MsIGl0IHdpbGwgYmUgcmVtb3ZlZCBhZnRlciB3ZSBhZGQgaXQuDQoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmJ1dHRvbiwgInVpLXNlbGVjdG1lbnUtYnV0dG9uLSIgKw0KCQkJKCB0aGlzLmlzT3BlbiA\/ICJjbG9zZWQiIDogIm9wZW4iICkgKQ0KCQkJLl9hZGRDbGFzcyggdGhpcy5idXR0b24sICJ1aS1zZWxlY3RtZW51LWJ1dHRvbi0iICsNCgkJCQkoIHRoaXMuaXNPcGVuID8gIm9wZW4iIDogImNsb3NlZCIgKSApDQoJCQkuX3RvZ2dsZUNsYXNzKCB0aGlzLm1lbnVXcmFwLCAidWktc2VsZWN0bWVudS1vcGVuIiwgbnVsbCwgdGhpcy5pc09wZW4gKTsNCg0KCQl0aGlzLm1lbnUuYXR0ciggImFyaWEtaGlkZGVuIiwgIXRoaXMuaXNPcGVuICk7DQoJfSwNCg0KCV9yZXNpemVCdXR0b246IGZ1bmN0aW9uKCkgew0KCQl2YXIgd2lkdGggPSB0aGlzLm9wdGlvbnMud2lkdGg7DQoNCgkJLy8gRm9yIGB3aWR0aDogZmFsc2VgLCBqdXN0IHJlbW92ZSBpbmxpbmUgc3R5bGUgYW5kIHN0b3ANCgkJaWYgKCB3aWR0aCA9PT0gZmFsc2UgKSB7DQoJCQl0aGlzLmJ1dHRvbi5jc3MoICJ3aWR0aCIsICIiICk7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBGb3IgYHdpZHRoOiBudWxsYCwgbWF0Y2ggdGhlIHdpZHRoIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50DQoJCWlmICggd2lkdGggPT09IG51bGwgKSB7DQoJCQl3aWR0aCA9IHRoaXMuZWxlbWVudC5zaG93KCkub3V0ZXJXaWR0aCgpOw0KCQkJdGhpcy5lbGVtZW50LmhpZGUoKTsNCgkJfQ0KDQoJCXRoaXMuYnV0dG9uLm91dGVyV2lkdGgoIHdpZHRoICk7DQoJfSwNCg0KCV9yZXNpemVNZW51OiBmdW5jdGlvbigpIHsNCgkJdGhpcy5tZW51Lm91dGVyV2lkdGgoIE1hdGgubWF4KA0KCQkJdGhpcy5idXR0b24ub3V0ZXJXaWR0aCgpLA0KDQoJCQkvLyBTdXBwb3J0OiBJRTEwDQoJCQkvLyBJRTEwIHdyYXBzIGxvbmcgdGV4dCAocG9zc2libHkgYSByb3VuZGluZyBidWcpDQoJCQkvLyBzbyB3ZSBhZGQgMXB4IHRvIGF2b2lkIHRoZSB3cmFwcGluZw0KCQkJdGhpcy5tZW51LndpZHRoKCAiIiApLm91dGVyV2lkdGgoKSArIDENCgkJKSApOw0KCX0sDQoNCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7DQoJCXZhciBvcHRpb25zID0gdGhpcy5fc3VwZXIoKTsNCg0KCQlvcHRpb25zLmRpc2FibGVkID0gdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKTsNCg0KCQlyZXR1cm4gb3B0aW9uczsNCgl9LA0KDQoJX3BhcnNlT3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCWRhdGEgPSBbXTsNCgkJb3B0aW9ucy5lYWNoKCBmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7DQoJCQlkYXRhLnB1c2goIHRoYXQuX3BhcnNlT3B0aW9uKCAkKCBpdGVtICksIGluZGV4ICkgKTsNCgkJfSApOw0KCQl0aGlzLml0ZW1zID0gZGF0YTsNCgl9LA0KDQoJX3BhcnNlT3B0aW9uOiBmdW5jdGlvbiggb3B0aW9uLCBpbmRleCApIHsNCgkJdmFyIG9wdGdyb3VwID0gb3B0aW9uLnBhcmVudCggIm9wdGdyb3VwIiApOw0KDQoJCXJldHVybiB7DQoJCQllbGVtZW50OiBvcHRpb24sDQoJCQlpbmRleDogaW5kZXgsDQoJCQl2YWx1ZTogb3B0aW9uLnZhbCgpLA0KCQkJbGFiZWw6IG9wdGlvbi50ZXh0KCksDQoJCQlvcHRncm91cDogb3B0Z3JvdXAuYXR0ciggImxhYmVsIiApIHx8ICIiLA0KCQkJZGlzYWJsZWQ6IG9wdGdyb3VwLnByb3AoICJkaXNhYmxlZCIgKSB8fCBvcHRpb24ucHJvcCggImRpc2FibGVkIiApDQoJCX07DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fdW5iaW5kRm9ybVJlc2V0SGFuZGxlcigpOw0KCQl0aGlzLm1lbnVXcmFwLnJlbW92ZSgpOw0KCQl0aGlzLmJ1dHRvbi5yZW1vdmUoKTsNCgkJdGhpcy5lbGVtZW50LnNob3coKTsNCgkJdGhpcy5lbGVtZW50LnJlbW92ZVVuaXF1ZUlkKCk7DQoJCXRoaXMubGFiZWxzLmF0dHIoICJmb3IiLCB0aGlzLmlkcy5lbGVtZW50ICk7DQoJfQ0KfSBdICk7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgU2xpZGVyIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBTbGlkZXINCi8vPj5ncm91cDogV2lkZ2V0cw0KLy8+PmRlc2NyaXB0aW9uOiBEaXNwbGF5cyBhIGZsZXhpYmxlIHNsaWRlciB3aXRoIHJhbmdlcyBhbmQgYWNjZXNzaWJpbGl0eSB2aWEga2V5Ym9hcmQuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2xpZGVyLw0KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3NsaWRlci8NCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3NsaWRlci5jc3MNCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcw0KDQoNCg0KdmFyIHdpZGdldHNTbGlkZXIgPSAkLndpZGdldCggInVpLnNsaWRlciIsICQudWkubW91c2UsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCgl3aWRnZXRFdmVudFByZWZpeDogInNsaWRlIiwNCg0KCW9wdGlvbnM6IHsNCgkJYW5pbWF0ZTogZmFsc2UsDQoJCWNsYXNzZXM6IHsNCgkJCSJ1aS1zbGlkZXIiOiAidWktY29ybmVyLWFsbCIsDQoJCQkidWktc2xpZGVyLWhhbmRsZSI6ICJ1aS1jb3JuZXItYWxsIiwNCg0KCQkJLy8gTm90ZTogdWktd2lkZ2V0LWhlYWRlciBpc24ndCB0aGUgbW9zdCBmaXR0aW5nbHkgc2VtYW50aWMgZnJhbWV3b3JrIGNsYXNzIGZvciB0aGlzDQoJCQkvLyBlbGVtZW50LCBidXQgd29ya2VkIGJlc3QgdmlzdWFsbHkgd2l0aCBhIHZhcmlldHkgb2YgdGhlbWVzDQoJCQkidWktc2xpZGVyLXJhbmdlIjogInVpLWNvcm5lci1hbGwgdWktd2lkZ2V0LWhlYWRlciINCgkJfSwNCgkJZGlzdGFuY2U6IDAsDQoJCW1heDogMTAwLA0KCQltaW46IDAsDQoJCW9yaWVudGF0aW9uOiAiaG9yaXpvbnRhbCIsDQoJCXJhbmdlOiBmYWxzZSwNCgkJc3RlcDogMSwNCgkJdmFsdWU6IDAsDQoJCXZhbHVlczogbnVsbCwNCg0KCQkvLyBDYWxsYmFja3MNCgkJY2hhbmdlOiBudWxsLA0KCQlzbGlkZTogbnVsbCwNCgkJc3RhcnQ6IG51bGwsDQoJCXN0b3A6IG51bGwNCgl9LA0KDQoJLy8gTnVtYmVyIG9mIHBhZ2VzIGluIGEgc2xpZGVyDQoJLy8gKGhvdyBtYW55IHRpbWVzIGNhbiB5b3UgcGFnZSB1cC9kb3duIHRvIGdvIHRocm91Z2ggdGhlIHdob2xlIHJhbmdlKQ0KCW51bVBhZ2VzOiA1LA0KDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsNCgkJdGhpcy5fbW91c2VTbGlkaW5nID0gZmFsc2U7DQoJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOw0KCQl0aGlzLl9oYW5kbGVJbmRleCA9IG51bGw7DQoJCXRoaXMuX2RldGVjdE9yaWVudGF0aW9uKCk7DQoJCXRoaXMuX21vdXNlSW5pdCgpOw0KCQl0aGlzLl9jYWxjdWxhdGVOZXdNYXgoKTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggInVpLXNsaWRlciB1aS1zbGlkZXItIiArIHRoaXMub3JpZW50YXRpb24sDQoJCQkidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IiApOw0KDQoJCXRoaXMuX3JlZnJlc2goKTsNCg0KCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7DQoJfSwNCg0KCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fY3JlYXRlUmFuZ2UoKTsNCgkJdGhpcy5fY3JlYXRlSGFuZGxlcygpOw0KCQl0aGlzLl9zZXR1cEV2ZW50cygpOw0KCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsNCgl9LA0KDQoJX2NyZWF0ZUhhbmRsZXM6IGZ1bmN0aW9uKCkgew0KCQl2YXIgaSwgaGFuZGxlQ291bnQsDQoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLA0KCQkJZXhpc3RpbmdIYW5kbGVzID0gdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWhhbmRsZSIgKSwNCgkJCWhhbmRsZSA9ICI8c3BhbiB0YWJpbmRleD0nMCc+PC9zcGFuPiIsDQoJCQloYW5kbGVzID0gW107DQoNCgkJaGFuZGxlQ291bnQgPSAoIG9wdGlvbnMudmFsdWVzICYmIG9wdGlvbnMudmFsdWVzLmxlbmd0aCApIHx8IDE7DQoNCgkJaWYgKCBleGlzdGluZ0hhbmRsZXMubGVuZ3RoID4gaGFuZGxlQ291bnQgKSB7DQoJCQlleGlzdGluZ0hhbmRsZXMuc2xpY2UoIGhhbmRsZUNvdW50ICkucmVtb3ZlKCk7DQoJCQlleGlzdGluZ0hhbmRsZXMgPSBleGlzdGluZ0hhbmRsZXMuc2xpY2UoIDAsIGhhbmRsZUNvdW50ICk7DQoJCX0NCg0KCQlmb3IgKCBpID0gZXhpc3RpbmdIYW5kbGVzLmxlbmd0aDsgaSA8IGhhbmRsZUNvdW50OyBpKysgKSB7DQoJCQloYW5kbGVzLnB1c2goIGhhbmRsZSApOw0KCQl9DQoNCgkJdGhpcy5oYW5kbGVzID0gZXhpc3RpbmdIYW5kbGVzLmFkZCggJCggaGFuZGxlcy5qb2luKCAiIiApICkuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApICk7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGFuZGxlcywgInVpLXNsaWRlci1oYW5kbGUiLCAidWktc3RhdGUtZGVmYXVsdCIgKTsNCg0KCQl0aGlzLmhhbmRsZSA9IHRoaXMuaGFuZGxlcy5lcSggMCApOw0KDQoJCXRoaXMuaGFuZGxlcy5lYWNoKCBmdW5jdGlvbiggaSApIHsNCgkJCSQoIHRoaXMgKQ0KCQkJCS5kYXRhKCAidWktc2xpZGVyLWhhbmRsZS1pbmRleCIsIGkgKQ0KCQkJCS5hdHRyKCAidGFiSW5kZXgiLCAwICk7DQoJCX0gKTsNCgl9LA0KDQoJX2NyZWF0ZVJhbmdlOiBmdW5jdGlvbigpIHsNCgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7DQoNCgkJaWYgKCBvcHRpb25zLnJhbmdlICkgew0KCQkJaWYgKCBvcHRpb25zLnJhbmdlID09PSB0cnVlICkgew0KCQkJCWlmICggIW9wdGlvbnMudmFsdWVzICkgew0KCQkJCQlvcHRpb25zLnZhbHVlcyA9IFsgdGhpcy5fdmFsdWVNaW4oKSwgdGhpcy5fdmFsdWVNaW4oKSBdOw0KCQkJCX0gZWxzZSBpZiAoIG9wdGlvbnMudmFsdWVzLmxlbmd0aCAmJiBvcHRpb25zLnZhbHVlcy5sZW5ndGggIT09IDIgKSB7DQoJCQkJCW9wdGlvbnMudmFsdWVzID0gWyBvcHRpb25zLnZhbHVlc1sgMCBdLCBvcHRpb25zLnZhbHVlc1sgMCBdIF07DQoJCQkJfSBlbHNlIGlmICggJC5pc0FycmF5KCBvcHRpb25zLnZhbHVlcyApICkgew0KCQkJCQlvcHRpb25zLnZhbHVlcyA9IG9wdGlvbnMudmFsdWVzLnNsaWNlKCAwICk7DQoJCQkJfQ0KCQkJfQ0KDQoJCQlpZiAoICF0aGlzLnJhbmdlIHx8ICF0aGlzLnJhbmdlLmxlbmd0aCApIHsNCgkJCQl0aGlzLnJhbmdlID0gJCggIjxkaXY+IiApDQoJCQkJCS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7DQoNCgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5yYW5nZSwgInVpLXNsaWRlci1yYW5nZSIgKTsNCgkJCX0gZWxzZSB7DQoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMucmFuZ2UsICJ1aS1zbGlkZXItcmFuZ2UtbWluIHVpLXNsaWRlci1yYW5nZS1tYXgiICk7DQoNCgkJCQkvLyBIYW5kbGUgcmFuZ2Ugc3dpdGNoaW5nIGZyb20gdHJ1ZSB0byBtaW4vbWF4DQoJCQkJdGhpcy5yYW5nZS5jc3MoIHsNCgkJCQkJImxlZnQiOiAiIiwNCgkJCQkJImJvdHRvbSI6ICIiDQoJCQkJfSApOw0KCQkJfQ0KCQkJaWYgKCBvcHRpb25zLnJhbmdlID09PSAibWluIiB8fCBvcHRpb25zLnJhbmdlID09PSAibWF4IiApIHsNCgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5yYW5nZSwgInVpLXNsaWRlci1yYW5nZS0iICsgb3B0aW9ucy5yYW5nZSApOw0KCQkJfQ0KCQl9IGVsc2Ugew0KCQkJaWYgKCB0aGlzLnJhbmdlICkgew0KCQkJCXRoaXMucmFuZ2UucmVtb3ZlKCk7DQoJCQl9DQoJCQl0aGlzLnJhbmdlID0gbnVsbDsNCgkJfQ0KCX0sDQoNCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLl9vZmYoIHRoaXMuaGFuZGxlcyApOw0KCQl0aGlzLl9vbiggdGhpcy5oYW5kbGVzLCB0aGlzLl9oYW5kbGVFdmVudHMgKTsNCgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLmhhbmRsZXMgKTsNCgkJdGhpcy5fZm9jdXNhYmxlKCB0aGlzLmhhbmRsZXMgKTsNCgl9LA0KDQoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLmhhbmRsZXMucmVtb3ZlKCk7DQoJCWlmICggdGhpcy5yYW5nZSApIHsNCgkJCXRoaXMucmFuZ2UucmVtb3ZlKCk7DQoJCX0NCg0KCQl0aGlzLl9tb3VzZURlc3Ryb3koKTsNCgl9LA0KDQoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgcG9zaXRpb24sIG5vcm1WYWx1ZSwgZGlzdGFuY2UsIGNsb3Nlc3RIYW5kbGUsIGluZGV4LCBhbGxvd2VkLCBvZmZzZXQsIG1vdXNlT3ZlckhhbmRsZSwNCgkJCXRoYXQgPSB0aGlzLA0KCQkJbyA9IHRoaXMub3B0aW9uczsNCg0KCQlpZiAoIG8uZGlzYWJsZWQgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQl0aGlzLmVsZW1lbnRTaXplID0gew0KCQkJd2lkdGg6IHRoaXMuZWxlbWVudC5vdXRlcldpZHRoKCksDQoJCQloZWlnaHQ6IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpDQoJCX07DQoJCXRoaXMuZWxlbWVudE9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsNCg0KCQlwb3NpdGlvbiA9IHsgeDogZXZlbnQucGFnZVgsIHk6IGV2ZW50LnBhZ2VZIH07DQoJCW5vcm1WYWx1ZSA9IHRoaXMuX25vcm1WYWx1ZUZyb21Nb3VzZSggcG9zaXRpb24gKTsNCgkJZGlzdGFuY2UgPSB0aGlzLl92YWx1ZU1heCgpIC0gdGhpcy5fdmFsdWVNaW4oKSArIDE7DQoJCXRoaXMuaGFuZGxlcy5lYWNoKCBmdW5jdGlvbiggaSApIHsNCgkJCXZhciB0aGlzRGlzdGFuY2UgPSBNYXRoLmFicyggbm9ybVZhbHVlIC0gdGhhdC52YWx1ZXMoIGkgKSApOw0KCQkJaWYgKCAoIGRpc3RhbmNlID4gdGhpc0Rpc3RhbmNlICkgfHwNCgkJCQkoIGRpc3RhbmNlID09PSB0aGlzRGlzdGFuY2UgJiYNCgkJCQkJKCBpID09PSB0aGF0Ll9sYXN0Q2hhbmdlZFZhbHVlIHx8IHRoYXQudmFsdWVzKCBpICkgPT09IG8ubWluICkgKSApIHsNCgkJCQlkaXN0YW5jZSA9IHRoaXNEaXN0YW5jZTsNCgkJCQljbG9zZXN0SGFuZGxlID0gJCggdGhpcyApOw0KCQkJCWluZGV4ID0gaTsNCgkJCX0NCgkJfSApOw0KDQoJCWFsbG93ZWQgPSB0aGlzLl9zdGFydCggZXZlbnQsIGluZGV4ICk7DQoJCWlmICggYWxsb3dlZCA9PT0gZmFsc2UgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCgkJdGhpcy5fbW91c2VTbGlkaW5nID0gdHJ1ZTsNCg0KCQl0aGlzLl9oYW5kbGVJbmRleCA9IGluZGV4Ow0KDQoJCXRoaXMuX2FkZENsYXNzKCBjbG9zZXN0SGFuZGxlLCBudWxsLCAidWktc3RhdGUtYWN0aXZlIiApOw0KCQljbG9zZXN0SGFuZGxlLnRyaWdnZXIoICJmb2N1cyIgKTsNCg0KCQlvZmZzZXQgPSBjbG9zZXN0SGFuZGxlLm9mZnNldCgpOw0KCQltb3VzZU92ZXJIYW5kbGUgPSAhJCggZXZlbnQudGFyZ2V0ICkucGFyZW50cygpLmFkZEJhY2soKS5pcyggIi51aS1zbGlkZXItaGFuZGxlIiApOw0KCQl0aGlzLl9jbGlja09mZnNldCA9IG1vdXNlT3ZlckhhbmRsZSA\/IHsgbGVmdDogMCwgdG9wOiAwIH0gOiB7DQoJCQlsZWZ0OiBldmVudC5wYWdlWCAtIG9mZnNldC5sZWZ0IC0gKCBjbG9zZXN0SGFuZGxlLndpZHRoKCkgLyAyICksDQoJCQl0b3A6IGV2ZW50LnBhZ2VZIC0gb2Zmc2V0LnRvcCAtDQoJCQkJKCBjbG9zZXN0SGFuZGxlLmhlaWdodCgpIC8gMiApIC0NCgkJCQkoIHBhcnNlSW50KCBjbG9zZXN0SGFuZGxlLmNzcyggImJvcmRlclRvcFdpZHRoIiApLCAxMCApIHx8IDAgKSAtDQoJCQkJKCBwYXJzZUludCggY2xvc2VzdEhhbmRsZS5jc3MoICJib3JkZXJCb3R0b21XaWR0aCIgKSwgMTAgKSB8fCAwICkgKw0KCQkJCSggcGFyc2VJbnQoIGNsb3Nlc3RIYW5kbGUuY3NzKCAibWFyZ2luVG9wIiApLCAxMCApIHx8IDAgKQ0KCQl9Ow0KDQoJCWlmICggIXRoaXMuaGFuZGxlcy5oYXNDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApICkgew0KCQkJdGhpcy5fc2xpZGUoIGV2ZW50LCBpbmRleCwgbm9ybVZhbHVlICk7DQoJCX0NCgkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7DQoJCXJldHVybiB0cnVlOw0KCX0sDQoNCglfbW91c2VTdGFydDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0cnVlOw0KCX0sDQoNCglfbW91c2VEcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBwb3NpdGlvbiA9IHsgeDogZXZlbnQucGFnZVgsIHk6IGV2ZW50LnBhZ2VZIH0sDQoJCQlub3JtVmFsdWUgPSB0aGlzLl9ub3JtVmFsdWVGcm9tTW91c2UoIHBvc2l0aW9uICk7DQoNCgkJdGhpcy5fc2xpZGUoIGV2ZW50LCB0aGlzLl9oYW5kbGVJbmRleCwgbm9ybVZhbHVlICk7DQoNCgkJcmV0dXJuIGZhbHNlOw0KCX0sDQoNCglfbW91c2VTdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmhhbmRsZXMsIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoJCXRoaXMuX21vdXNlU2xpZGluZyA9IGZhbHNlOw0KDQoJCXRoaXMuX3N0b3AoIGV2ZW50LCB0aGlzLl9oYW5kbGVJbmRleCApOw0KCQl0aGlzLl9jaGFuZ2UoIGV2ZW50LCB0aGlzLl9oYW5kbGVJbmRleCApOw0KDQoJCXRoaXMuX2hhbmRsZUluZGV4ID0gbnVsbDsNCgkJdGhpcy5fY2xpY2tPZmZzZXQgPSBudWxsOw0KCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7DQoNCgkJcmV0dXJuIGZhbHNlOw0KCX0sDQoNCglfZGV0ZWN0T3JpZW50YXRpb246IGZ1bmN0aW9uKCkgew0KCQl0aGlzLm9yaWVudGF0aW9uID0gKCB0aGlzLm9wdGlvbnMub3JpZW50YXRpb24gPT09ICJ2ZXJ0aWNhbCIgKSA\/ICJ2ZXJ0aWNhbCIgOiAiaG9yaXpvbnRhbCI7DQoJfSwNCg0KCV9ub3JtVmFsdWVGcm9tTW91c2U6IGZ1bmN0aW9uKCBwb3NpdGlvbiApIHsNCgkJdmFyIHBpeGVsVG90YWwsDQoJCQlwaXhlbE1vdXNlLA0KCQkJcGVyY2VudE1vdXNlLA0KCQkJdmFsdWVUb3RhbCwNCgkJCXZhbHVlTW91c2U7DQoNCgkJaWYgKCB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7DQoJCQlwaXhlbFRvdGFsID0gdGhpcy5lbGVtZW50U2l6ZS53aWR0aDsNCgkJCXBpeGVsTW91c2UgPSBwb3NpdGlvbi54IC0gdGhpcy5lbGVtZW50T2Zmc2V0LmxlZnQgLQ0KCQkJCSggdGhpcy5fY2xpY2tPZmZzZXQgPyB0aGlzLl9jbGlja09mZnNldC5sZWZ0IDogMCApOw0KCQl9IGVsc2Ugew0KCQkJcGl4ZWxUb3RhbCA9IHRoaXMuZWxlbWVudFNpemUuaGVpZ2h0Ow0KCQkJcGl4ZWxNb3VzZSA9IHBvc2l0aW9uLnkgLSB0aGlzLmVsZW1lbnRPZmZzZXQudG9wIC0NCgkJCQkoIHRoaXMuX2NsaWNrT2Zmc2V0ID8gdGhpcy5fY2xpY2tPZmZzZXQudG9wIDogMCApOw0KCQl9DQoNCgkJcGVyY2VudE1vdXNlID0gKCBwaXhlbE1vdXNlIC8gcGl4ZWxUb3RhbCApOw0KCQlpZiAoIHBlcmNlbnRNb3VzZSA+IDEgKSB7DQoJCQlwZXJjZW50TW91c2UgPSAxOw0KCQl9DQoJCWlmICggcGVyY2VudE1vdXNlIDwgMCApIHsNCgkJCXBlcmNlbnRNb3VzZSA9IDA7DQoJCX0NCgkJaWYgKCB0aGlzLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgew0KCQkJcGVyY2VudE1vdXNlID0gMSAtIHBlcmNlbnRNb3VzZTsNCgkJfQ0KDQoJCXZhbHVlVG90YWwgPSB0aGlzLl92YWx1ZU1heCgpIC0gdGhpcy5fdmFsdWVNaW4oKTsNCgkJdmFsdWVNb3VzZSA9IHRoaXMuX3ZhbHVlTWluKCkgKyBwZXJjZW50TW91c2UgKiB2YWx1ZVRvdGFsOw0KDQoJCXJldHVybiB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsdWVNb3VzZSApOw0KCX0sDQoNCglfdWlIYXNoOiBmdW5jdGlvbiggaW5kZXgsIHZhbHVlLCB2YWx1ZXMgKSB7DQoJCXZhciB1aUhhc2ggPSB7DQoJCQloYW5kbGU6IHRoaXMuaGFuZGxlc1sgaW5kZXggXSwNCgkJCWhhbmRsZUluZGV4OiBpbmRleCwNCgkJCXZhbHVlOiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8gdmFsdWUgOiB0aGlzLnZhbHVlKCkNCgkJfTsNCg0KCQlpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7DQoJCQl1aUhhc2gudmFsdWUgPSB2YWx1ZSAhPT0gdW5kZWZpbmVkID8gdmFsdWUgOiB0aGlzLnZhbHVlcyggaW5kZXggKTsNCgkJCXVpSGFzaC52YWx1ZXMgPSB2YWx1ZXMgfHwgdGhpcy52YWx1ZXMoKTsNCgkJfQ0KDQoJCXJldHVybiB1aUhhc2g7DQoJfSwNCg0KCV9oYXNNdWx0aXBsZVZhbHVlczogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLm9wdGlvbnMudmFsdWVzICYmIHRoaXMub3B0aW9ucy52YWx1ZXMubGVuZ3RoOw0KCX0sDQoNCglfc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgaW5kZXggKSB7DQoJCXJldHVybiB0aGlzLl90cmlnZ2VyKCAic3RhcnQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCBpbmRleCApICk7DQoJfSwNCg0KCV9zbGlkZTogZnVuY3Rpb24oIGV2ZW50LCBpbmRleCwgbmV3VmFsICkgew0KCQl2YXIgYWxsb3dlZCwgb3RoZXJWYWwsDQoJCQljdXJyZW50VmFsdWUgPSB0aGlzLnZhbHVlKCksDQoJCQluZXdWYWx1ZXMgPSB0aGlzLnZhbHVlcygpOw0KDQoJCWlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsNCgkJCW90aGVyVmFsID0gdGhpcy52YWx1ZXMoIGluZGV4ID8gMCA6IDEgKTsNCgkJCWN1cnJlbnRWYWx1ZSA9IHRoaXMudmFsdWVzKCBpbmRleCApOw0KDQoJCQlpZiAoIHRoaXMub3B0aW9ucy52YWx1ZXMubGVuZ3RoID09PSAyICYmIHRoaXMub3B0aW9ucy5yYW5nZSA9PT0gdHJ1ZSApIHsNCgkJCQluZXdWYWwgPSAgaW5kZXggPT09IDAgPyBNYXRoLm1pbiggb3RoZXJWYWwsIG5ld1ZhbCApIDogTWF0aC5tYXgoIG90aGVyVmFsLCBuZXdWYWwgKTsNCgkJCX0NCg0KCQkJbmV3VmFsdWVzWyBpbmRleCBdID0gbmV3VmFsOw0KCQl9DQoNCgkJaWYgKCBuZXdWYWwgPT09IGN1cnJlbnRWYWx1ZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWFsbG93ZWQgPSB0aGlzLl90cmlnZ2VyKCAic2xpZGUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCBpbmRleCwgbmV3VmFsLCBuZXdWYWx1ZXMgKSApOw0KDQoJCS8vIEEgc2xpZGUgY2FuIGJlIGNhbmNlbGVkIGJ5IHJldHVybmluZyBmYWxzZSBmcm9tIHRoZSBzbGlkZSBjYWxsYmFjaw0KCQlpZiAoIGFsbG93ZWQgPT09IGZhbHNlICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCB0aGlzLl9oYXNNdWx0aXBsZVZhbHVlcygpICkgew0KCQkJdGhpcy52YWx1ZXMoIGluZGV4LCBuZXdWYWwgKTsNCgkJfSBlbHNlIHsNCgkJCXRoaXMudmFsdWUoIG5ld1ZhbCApOw0KCQl9DQoJfSwNCg0KCV9zdG9wOiBmdW5jdGlvbiggZXZlbnQsIGluZGV4ICkgew0KCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50LCB0aGlzLl91aUhhc2goIGluZGV4ICkgKTsNCgl9LA0KDQoJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBpbmRleCApIHsNCgkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyAmJiAhdGhpcy5fbW91c2VTbGlkaW5nICkgew0KDQoJCQkvL3N0b3JlIHRoZSBsYXN0IGNoYW5nZWQgdmFsdWUgaW5kZXggZm9yIHJlZmVyZW5jZSB3aGVuIGhhbmRsZXMgb3ZlcmxhcA0KCQkJdGhpcy5fbGFzdENoYW5nZWRWYWx1ZSA9IGluZGV4Ow0KCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goIGluZGV4ICkgKTsNCgkJfQ0KCX0sDQoNCgl2YWx1ZTogZnVuY3Rpb24oIG5ld1ZhbHVlICkgew0KCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7DQoJCQl0aGlzLm9wdGlvbnMudmFsdWUgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggbmV3VmFsdWUgKTsNCgkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOw0KCQkJdGhpcy5fY2hhbmdlKCBudWxsLCAwICk7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlyZXR1cm4gdGhpcy5fdmFsdWUoKTsNCgl9LA0KDQoJdmFsdWVzOiBmdW5jdGlvbiggaW5kZXgsIG5ld1ZhbHVlICkgew0KCQl2YXIgdmFscywNCgkJCW5ld1ZhbHVlcywNCgkJCWk7DQoNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID4gMSApIHsNCgkJCXRoaXMub3B0aW9ucy52YWx1ZXNbIGluZGV4IF0gPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggbmV3VmFsdWUgKTsNCgkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOw0KCQkJdGhpcy5fY2hhbmdlKCBudWxsLCBpbmRleCApOw0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgew0KCQkJaWYgKCAkLmlzQXJyYXkoIGFyZ3VtZW50c1sgMCBdICkgKSB7DQoJCQkJdmFscyA9IHRoaXMub3B0aW9ucy52YWx1ZXM7DQoJCQkJbmV3VmFsdWVzID0gYXJndW1lbnRzWyAwIF07DQoJCQkJZm9yICggaSA9IDA7IGkgPCB2YWxzLmxlbmd0aDsgaSArPSAxICkgew0KCQkJCQl2YWxzWyBpIF0gPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggbmV3VmFsdWVzWyBpIF0gKTsNCgkJCQkJdGhpcy5fY2hhbmdlKCBudWxsLCBpICk7DQoJCQkJfQ0KCQkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOw0KCQkJfSBlbHNlIHsNCgkJCQlpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7DQoJCQkJCXJldHVybiB0aGlzLl92YWx1ZXMoIGluZGV4ICk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJcmV0dXJuIHRoaXMudmFsdWUoKTsNCgkJCQl9DQoJCQl9DQoJCX0gZWxzZSB7DQoJCQlyZXR1cm4gdGhpcy5fdmFsdWVzKCk7DQoJCX0NCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCXZhciBpLA0KCQkJdmFsc0xlbmd0aCA9IDA7DQoNCgkJaWYgKCBrZXkgPT09ICJyYW5nZSIgJiYgdGhpcy5vcHRpb25zLnJhbmdlID09PSB0cnVlICkgew0KCQkJaWYgKCB2YWx1ZSA9PT0gIm1pbiIgKSB7DQoJCQkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fdmFsdWVzKCAwICk7DQoJCQkJdGhpcy5vcHRpb25zLnZhbHVlcyA9IG51bGw7DQoJCQl9IGVsc2UgaWYgKCB2YWx1ZSA9PT0gIm1heCIgKSB7DQoJCQkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fdmFsdWVzKCB0aGlzLm9wdGlvbnMudmFsdWVzLmxlbmd0aCAtIDEgKTsNCgkJCQl0aGlzLm9wdGlvbnMudmFsdWVzID0gbnVsbDsNCgkJCX0NCgkJfQ0KDQoJCWlmICggJC5pc0FycmF5KCB0aGlzLm9wdGlvbnMudmFsdWVzICkgKSB7DQoJCQl2YWxzTGVuZ3RoID0gdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGg7DQoJCX0NCg0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KDQoJCXN3aXRjaCAoIGtleSApIHsNCgkJCWNhc2UgIm9yaWVudGF0aW9uIjoNCgkJCQl0aGlzLl9kZXRlY3RPcmllbnRhdGlvbigpOw0KCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhvcml6b250YWwgdWktc2xpZGVyLXZlcnRpY2FsIiApDQoJCQkJCS5fYWRkQ2xhc3MoICJ1aS1zbGlkZXItIiArIHRoaXMub3JpZW50YXRpb24gKTsNCgkJCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsNCgkJCQlpZiAoIHRoaXMub3B0aW9ucy5yYW5nZSApIHsNCgkJCQkJdGhpcy5fcmVmcmVzaFJhbmdlKCB2YWx1ZSApOw0KCQkJCX0NCg0KCQkJCS8vIFJlc2V0IHBvc2l0aW9uaW5nIGZyb20gcHJldmlvdXMgb3JpZW50YXRpb24NCgkJCQl0aGlzLmhhbmRsZXMuY3NzKCB2YWx1ZSA9PT0gImhvcml6b250YWwiID8gImJvdHRvbSIgOiAibGVmdCIsICIiICk7DQoJCQkJYnJlYWs7DQoJCQljYXNlICJ2YWx1ZSI6DQoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7DQoJCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7DQoJCQkJdGhpcy5fY2hhbmdlKCBudWxsLCAwICk7DQoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOw0KCQkJCWJyZWFrOw0KCQkJY2FzZSAidmFsdWVzIjoNCgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gdHJ1ZTsNCgkJCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsNCg0KCQkJCS8vIFN0YXJ0IGZyb20gdGhlIGxhc3QgaGFuZGxlIHRvIHByZXZlbnQgdW5yZWFjaGFibGUgaGFuZGxlcyAoIzkwNDYpDQoJCQkJZm9yICggaSA9IHZhbHNMZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsNCgkJCQkJdGhpcy5fY2hhbmdlKCBudWxsLCBpICk7DQoJCQkJfQ0KCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSBmYWxzZTsNCgkJCQlicmVhazsNCgkJCWNhc2UgInN0ZXAiOg0KCQkJY2FzZSAibWluIjoNCgkJCWNhc2UgIm1heCI6DQoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7DQoJCQkJdGhpcy5fY2FsY3VsYXRlTmV3TWF4KCk7DQoJCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7DQoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOw0KCQkJCWJyZWFrOw0KCQkJY2FzZSAicmFuZ2UiOg0KCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOw0KCQkJCXRoaXMuX3JlZnJlc2goKTsNCgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7DQoJCQkJYnJlYWs7DQoJCX0NCgl9LA0KDQoJX3NldE9wdGlvbkRpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCXRoaXMuX3N1cGVyKCB2YWx1ZSApOw0KDQoJCXRoaXMuX3RvZ2dsZUNsYXNzKCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICk7DQoJfSwNCg0KCS8vaW50ZXJuYWwgdmFsdWUgZ2V0dGVyDQoJLy8gX3ZhbHVlKCkgcmV0dXJucyB2YWx1ZSB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4LCBhbGlnbmVkIGJ5IHN0ZXANCglfdmFsdWU6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdmFsID0gdGhpcy5vcHRpb25zLnZhbHVlOw0KCQl2YWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsICk7DQoNCgkJcmV0dXJuIHZhbDsNCgl9LA0KDQoJLy9pbnRlcm5hbCB2YWx1ZXMgZ2V0dGVyDQoJLy8gX3ZhbHVlcygpIHJldHVybnMgYXJyYXkgb2YgdmFsdWVzIHRyaW1tZWQgYnkgbWluIGFuZCBtYXgsIGFsaWduZWQgYnkgc3RlcA0KCS8vIF92YWx1ZXMoIGluZGV4ICkgcmV0dXJucyBzaW5nbGUgdmFsdWUgdHJpbW1lZCBieSBtaW4gYW5kIG1heCwgYWxpZ25lZCBieSBzdGVwDQoJX3ZhbHVlczogZnVuY3Rpb24oIGluZGV4ICkgew0KCQl2YXIgdmFsLA0KCQkJdmFscywNCgkJCWk7DQoNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgew0KCQkJdmFsID0gdGhpcy5vcHRpb25zLnZhbHVlc1sgaW5kZXggXTsNCgkJCXZhbCA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCB2YWwgKTsNCg0KCQkJcmV0dXJuIHZhbDsNCgkJfSBlbHNlIGlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsNCg0KCQkJLy8gLnNsaWNlKCkgY3JlYXRlcyBhIGNvcHkgb2YgdGhlIGFycmF5DQoJCQkvLyB0aGlzIGNvcHkgZ2V0cyB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4IGFuZCB0aGVuIHJldHVybmVkDQoJCQl2YWxzID0gdGhpcy5vcHRpb25zLnZhbHVlcy5zbGljZSgpOw0KCQkJZm9yICggaSA9IDA7IGkgPCB2YWxzLmxlbmd0aDsgaSArPSAxICkgew0KCQkJCXZhbHNbIGkgXSA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCB2YWxzWyBpIF0gKTsNCgkJCX0NCg0KCQkJcmV0dXJuIHZhbHM7DQoJCX0gZWxzZSB7DQoJCQlyZXR1cm4gW107DQoJCX0NCgl9LA0KDQoJLy8gUmV0dXJucyB0aGUgc3RlcC1hbGlnbmVkIHZhbHVlIHRoYXQgdmFsIGlzIGNsb3Nlc3QgdG8sIGJldHdlZW4gKGluY2x1c2l2ZSkgbWluIGFuZCBtYXgNCglfdHJpbUFsaWduVmFsdWU6IGZ1bmN0aW9uKCB2YWwgKSB7DQoJCWlmICggdmFsIDw9IHRoaXMuX3ZhbHVlTWluKCkgKSB7DQoJCQlyZXR1cm4gdGhpcy5fdmFsdWVNaW4oKTsNCgkJfQ0KCQlpZiAoIHZhbCA+PSB0aGlzLl92YWx1ZU1heCgpICkgew0KCQkJcmV0dXJuIHRoaXMuX3ZhbHVlTWF4KCk7DQoJCX0NCgkJdmFyIHN0ZXAgPSAoIHRoaXMub3B0aW9ucy5zdGVwID4gMCApID8gdGhpcy5vcHRpb25zLnN0ZXAgOiAxLA0KCQkJdmFsTW9kU3RlcCA9ICggdmFsIC0gdGhpcy5fdmFsdWVNaW4oKSApICUgc3RlcCwNCgkJCWFsaWduVmFsdWUgPSB2YWwgLSB2YWxNb2RTdGVwOw0KDQoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsNCgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsNCgkJfQ0KDQoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZA0KCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSAjNDEyNCkNCgkJcmV0dXJuIHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCggNSApICk7DQoJfSwNCg0KCV9jYWxjdWxhdGVOZXdNYXg6IGZ1bmN0aW9uKCkgew0KCQl2YXIgbWF4ID0gdGhpcy5vcHRpb25zLm1heCwNCgkJCW1pbiA9IHRoaXMuX3ZhbHVlTWluKCksDQoJCQlzdGVwID0gdGhpcy5vcHRpb25zLnN0ZXAsDQoJCQlhYm92ZU1pbiA9IE1hdGgucm91bmQoICggbWF4IC0gbWluICkgLyBzdGVwICkgKiBzdGVwOw0KCQltYXggPSBhYm92ZU1pbiArIG1pbjsNCgkJaWYgKCBtYXggPiB0aGlzLm9wdGlvbnMubWF4ICkgew0KDQoJCQkvL0lmIG1heCBpcyBub3QgZGl2aXNpYmxlIGJ5IHN0ZXAsIHJvdW5kaW5nIG9mZiBtYXkgaW5jcmVhc2UgaXRzIHZhbHVlDQoJCQltYXggLT0gc3RlcDsNCgkJfQ0KCQl0aGlzLm1heCA9IHBhcnNlRmxvYXQoIG1heC50b0ZpeGVkKCB0aGlzLl9wcmVjaXNpb24oKSApICk7DQoJfSwNCg0KCV9wcmVjaXNpb246IGZ1bmN0aW9uKCkgew0KCQl2YXIgcHJlY2lzaW9uID0gdGhpcy5fcHJlY2lzaW9uT2YoIHRoaXMub3B0aW9ucy5zdGVwICk7DQoJCWlmICggdGhpcy5vcHRpb25zLm1pbiAhPT0gbnVsbCApIHsNCgkJCXByZWNpc2lvbiA9IE1hdGgubWF4KCBwcmVjaXNpb24sIHRoaXMuX3ByZWNpc2lvbk9mKCB0aGlzLm9wdGlvbnMubWluICkgKTsNCgkJfQ0KCQlyZXR1cm4gcHJlY2lzaW9uOw0KCX0sDQoNCglfcHJlY2lzaW9uT2Y6IGZ1bmN0aW9uKCBudW0gKSB7DQoJCXZhciBzdHIgPSBudW0udG9TdHJpbmcoKSwNCgkJCWRlY2ltYWwgPSBzdHIuaW5kZXhPZiggIi4iICk7DQoJCXJldHVybiBkZWNpbWFsID09PSAtMSA\/IDAgOiBzdHIubGVuZ3RoIC0gZGVjaW1hbCAtIDE7DQoJfSwNCg0KCV92YWx1ZU1pbjogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLm9wdGlvbnMubWluOw0KCX0sDQoNCglfdmFsdWVNYXg6IGZ1bmN0aW9uKCkgew0KCQlyZXR1cm4gdGhpcy5tYXg7DQoJfSwNCg0KCV9yZWZyZXNoUmFuZ2U6IGZ1bmN0aW9uKCBvcmllbnRhdGlvbiApIHsNCgkJaWYgKCBvcmllbnRhdGlvbiA9PT0gInZlcnRpY2FsIiApIHsNCgkJCXRoaXMucmFuZ2UuY3NzKCB7ICJ3aWR0aCI6ICIiLCAibGVmdCI6ICIiIH0gKTsNCgkJfQ0KCQlpZiAoIG9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7DQoJCQl0aGlzLnJhbmdlLmNzcyggeyAiaGVpZ2h0IjogIiIsICJib3R0b20iOiAiIiB9ICk7DQoJCX0NCgl9LA0KDQoJX3JlZnJlc2hWYWx1ZTogZnVuY3Rpb24oKSB7DQoJCXZhciBsYXN0VmFsUGVyY2VudCwgdmFsUGVyY2VudCwgdmFsdWUsIHZhbHVlTWluLCB2YWx1ZU1heCwNCgkJCW9SYW5nZSA9IHRoaXMub3B0aW9ucy5yYW5nZSwNCgkJCW8gPSB0aGlzLm9wdGlvbnMsDQoJCQl0aGF0ID0gdGhpcywNCgkJCWFuaW1hdGUgPSAoICF0aGlzLl9hbmltYXRlT2ZmICkgPyBvLmFuaW1hdGUgOiBmYWxzZSwNCgkJCV9zZXQgPSB7fTsNCg0KCQlpZiAoIHRoaXMuX2hhc011bHRpcGxlVmFsdWVzKCkgKSB7DQoJCQl0aGlzLmhhbmRsZXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7DQoJCQkJdmFsUGVyY2VudCA9ICggdGhhdC52YWx1ZXMoIGkgKSAtIHRoYXQuX3ZhbHVlTWluKCkgKSAvICggdGhhdC5fdmFsdWVNYXgoKSAtDQoJCQkJCXRoYXQuX3ZhbHVlTWluKCkgKSAqIDEwMDsNCgkJCQlfc2V0WyB0aGF0Lm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgPyAibGVmdCIgOiAiYm90dG9tIiBdID0gdmFsUGVyY2VudCArICIlIjsNCgkJCQkkKCB0aGlzICkuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggX3NldCwgby5hbmltYXRlICk7DQoJCQkJaWYgKCB0aGF0Lm9wdGlvbnMucmFuZ2UgPT09IHRydWUgKSB7DQoJCQkJCWlmICggdGhhdC5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiICkgew0KCQkJCQkJaWYgKCBpID09PSAwICkgew0KCQkJCQkJCXRoYXQucmFuZ2Uuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggew0KCQkJCQkJCQlsZWZ0OiB2YWxQZXJjZW50ICsgIiUiDQoJCQkJCQkJfSwgby5hbmltYXRlICk7DQoJCQkJCQl9DQoJCQkJCQlpZiAoIGkgPT09IDEgKSB7DQoJCQkJCQkJdGhhdC5yYW5nZVsgYW5pbWF0ZSA\/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsNCgkJCQkJCQkJd2lkdGg6ICggdmFsUGVyY2VudCAtIGxhc3RWYWxQZXJjZW50ICkgKyAiJSINCgkJCQkJCQl9LCB7DQoJCQkJCQkJCXF1ZXVlOiBmYWxzZSwNCgkJCQkJCQkJZHVyYXRpb246IG8uYW5pbWF0ZQ0KCQkJCQkJCX0gKTsNCgkJCQkJCX0NCgkJCQkJfSBlbHNlIHsNCgkJCQkJCWlmICggaSA9PT0gMCApIHsNCgkJCQkJCQl0aGF0LnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA\/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsNCgkJCQkJCQkJYm90dG9tOiAoIHZhbFBlcmNlbnQgKSArICIlIg0KCQkJCQkJCX0sIG8uYW5pbWF0ZSApOw0KCQkJCQkJfQ0KCQkJCQkJaWYgKCBpID09PSAxICkgew0KCQkJCQkJCXRoYXQucmFuZ2VbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7DQoJCQkJCQkJCWhlaWdodDogKCB2YWxQZXJjZW50IC0gbGFzdFZhbFBlcmNlbnQgKSArICIlIg0KCQkJCQkJCX0sIHsNCgkJCQkJCQkJcXVldWU6IGZhbHNlLA0KCQkJCQkJCQlkdXJhdGlvbjogby5hbmltYXRlDQoJCQkJCQkJfSApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KCQkJCWxhc3RWYWxQZXJjZW50ID0gdmFsUGVyY2VudDsNCgkJCX0gKTsNCgkJfSBlbHNlIHsNCgkJCXZhbHVlID0gdGhpcy52YWx1ZSgpOw0KCQkJdmFsdWVNaW4gPSB0aGlzLl92YWx1ZU1pbigpOw0KCQkJdmFsdWVNYXggPSB0aGlzLl92YWx1ZU1heCgpOw0KCQkJdmFsUGVyY2VudCA9ICggdmFsdWVNYXggIT09IHZhbHVlTWluICkgPw0KCQkJCQkoIHZhbHVlIC0gdmFsdWVNaW4gKSAvICggdmFsdWVNYXggLSB2YWx1ZU1pbiApICogMTAwIDoNCgkJCQkJMDsNCgkJCV9zZXRbIHRoaXMub3JpZW50YXRpb24gPT09ICJob3Jpem9udGFsIiA\/ICJsZWZ0IiA6ICJib3R0b20iIF0gPSB2YWxQZXJjZW50ICsgIiUiOw0KCQkJdGhpcy5oYW5kbGUuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggX3NldCwgby5hbmltYXRlICk7DQoNCgkJCWlmICggb1JhbmdlID09PSAibWluIiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7DQoJCQkJdGhpcy5yYW5nZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7DQoJCQkJCXdpZHRoOiB2YWxQZXJjZW50ICsgIiUiDQoJCQkJfSwgby5hbmltYXRlICk7DQoJCQl9DQoJCQlpZiAoIG9SYW5nZSA9PT0gIm1heCIgJiYgdGhpcy5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiICkgew0KCQkJCXRoaXMucmFuZ2Uuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggew0KCQkJCQl3aWR0aDogKCAxMDAgLSB2YWxQZXJjZW50ICkgKyAiJSINCgkJCQl9LCBvLmFuaW1hdGUgKTsNCgkJCX0NCgkJCWlmICggb1JhbmdlID09PSAibWluIiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgew0KCQkJCXRoaXMucmFuZ2Uuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggew0KCQkJCQloZWlnaHQ6IHZhbFBlcmNlbnQgKyAiJSINCgkJCQl9LCBvLmFuaW1hdGUgKTsNCgkJCX0NCgkJCWlmICggb1JhbmdlID09PSAibWF4IiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgew0KCQkJCXRoaXMucmFuZ2Uuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggew0KCQkJCQloZWlnaHQ6ICggMTAwIC0gdmFsUGVyY2VudCApICsgIiUiDQoJCQkJfSwgby5hbmltYXRlICk7DQoJCQl9DQoJCX0NCgl9LA0KDQoJX2hhbmRsZUV2ZW50czogew0KCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQl2YXIgYWxsb3dlZCwgY3VyVmFsLCBuZXdWYWwsIHN0ZXAsDQoJCQkJaW5kZXggPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAidWktc2xpZGVyLWhhbmRsZS1pbmRleCIgKTsNCg0KCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsNCgkJCQljYXNlICQudWkua2V5Q29kZS5IT01FOg0KCQkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoNCgkJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX1VQOg0KCQkJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfRE9XTjoNCgkJCQljYXNlICQudWkua2V5Q29kZS5VUDoNCgkJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoNCgkJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOg0KCQkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6DQoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQkJCWlmICggIXRoaXMuX2tleVNsaWRpbmcgKSB7DQoJCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsNCgkJCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC50YXJnZXQgKSwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsNCgkJCQkJCWFsbG93ZWQgPSB0aGlzLl9zdGFydCggZXZlbnQsIGluZGV4ICk7DQoJCQkJCQlpZiAoIGFsbG93ZWQgPT09IGZhbHNlICkgew0KCQkJCQkJCXJldHVybjsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCQlicmVhazsNCgkJCX0NCg0KCQkJc3RlcCA9IHRoaXMub3B0aW9ucy5zdGVwOw0KCQkJaWYgKCB0aGlzLl9oYXNNdWx0aXBsZVZhbHVlcygpICkgew0KCQkJCWN1clZhbCA9IG5ld1ZhbCA9IHRoaXMudmFsdWVzKCBpbmRleCApOw0KCQkJfSBlbHNlIHsNCgkJCQljdXJWYWwgPSBuZXdWYWwgPSB0aGlzLnZhbHVlKCk7DQoJCQl9DQoNCgkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7DQoJCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToNCgkJCQkJbmV3VmFsID0gdGhpcy5fdmFsdWVNaW4oKTsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSAkLnVpLmtleUNvZGUuRU5EOg0KCQkJCQluZXdWYWwgPSB0aGlzLl92YWx1ZU1heCgpOw0KCQkJCQlicmVhazsNCgkJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX1VQOg0KCQkJCQluZXdWYWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSgNCgkJCQkJCWN1clZhbCArICggKCB0aGlzLl92YWx1ZU1heCgpIC0gdGhpcy5fdmFsdWVNaW4oKSApIC8gdGhpcy5udW1QYWdlcyApDQoJCQkJCSk7DQoJCQkJCWJyZWFrOw0KCQkJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfRE9XTjoNCgkJCQkJbmV3VmFsID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoDQoJCQkJCQljdXJWYWwgLSAoICggdGhpcy5fdmFsdWVNYXgoKSAtIHRoaXMuX3ZhbHVlTWluKCkgKSAvIHRoaXMubnVtUGFnZXMgKSApOw0KCQkJCQlicmVhazsNCgkJCQljYXNlICQudWkua2V5Q29kZS5VUDoNCgkJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoNCgkJCQkJaWYgKCBjdXJWYWwgPT09IHRoaXMuX3ZhbHVlTWF4KCkgKSB7DQoJCQkJCQlyZXR1cm47DQoJCQkJCX0NCgkJCQkJbmV3VmFsID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIGN1clZhbCArIHN0ZXAgKTsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoNCgkJCQljYXNlICQudWkua2V5Q29kZS5MRUZUOg0KCQkJCQlpZiAoIGN1clZhbCA9PT0gdGhpcy5fdmFsdWVNaW4oKSApIHsNCgkJCQkJCXJldHVybjsNCgkJCQkJfQ0KCQkJCQluZXdWYWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggY3VyVmFsIC0gc3RlcCApOw0KCQkJCQlicmVhazsNCgkJCX0NCg0KCQkJdGhpcy5fc2xpZGUoIGV2ZW50LCBpbmRleCwgbmV3VmFsICk7DQoJCX0sDQoJCWtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQl2YXIgaW5kZXggPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAidWktc2xpZGVyLWhhbmRsZS1pbmRleCIgKTsNCg0KCQkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgew0KCQkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsNCgkJCQl0aGlzLl9zdG9wKCBldmVudCwgaW5kZXggKTsNCgkJCQl0aGlzLl9jaGFuZ2UoIGV2ZW50LCBpbmRleCApOw0KCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAkKCBldmVudC50YXJnZXQgKSwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsNCgkJCX0NCgkJfQ0KCX0NCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBTb3J0YWJsZSAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogU29ydGFibGUNCi8vPj5ncm91cDogSW50ZXJhY3Rpb25zDQovLz4+ZGVzY3JpcHRpb246IEVuYWJsZXMgaXRlbXMgaW4gYSBsaXN0IHRvIGJlIHNvcnRlZCB1c2luZyB0aGUgbW91c2UuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc29ydGFibGUvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vc29ydGFibGUvDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2Uvc29ydGFibGUuY3NzDQoNCg0KDQp2YXIgd2lkZ2V0c1NvcnRhYmxlID0gJC53aWRnZXQoICJ1aS5zb3J0YWJsZSIsICQudWkubW91c2UsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCgl3aWRnZXRFdmVudFByZWZpeDogInNvcnQiLA0KCXJlYWR5OiBmYWxzZSwNCglvcHRpb25zOiB7DQoJCWFwcGVuZFRvOiAicGFyZW50IiwNCgkJYXhpczogZmFsc2UsDQoJCWNvbm5lY3RXaXRoOiBmYWxzZSwNCgkJY29udGFpbm1lbnQ6IGZhbHNlLA0KCQljdXJzb3I6ICJhdXRvIiwNCgkJY3Vyc29yQXQ6IGZhbHNlLA0KCQlkcm9wT25FbXB0eTogdHJ1ZSwNCgkJZm9yY2VQbGFjZWhvbGRlclNpemU6IGZhbHNlLA0KCQlmb3JjZUhlbHBlclNpemU6IGZhbHNlLA0KCQlncmlkOiBmYWxzZSwNCgkJaGFuZGxlOiBmYWxzZSwNCgkJaGVscGVyOiAib3JpZ2luYWwiLA0KCQlpdGVtczogIj4gKiIsDQoJCW9wYWNpdHk6IGZhbHNlLA0KCQlwbGFjZWhvbGRlcjogZmFsc2UsDQoJCXJldmVydDogZmFsc2UsDQoJCXNjcm9sbDogdHJ1ZSwNCgkJc2Nyb2xsU2Vuc2l0aXZpdHk6IDIwLA0KCQlzY3JvbGxTcGVlZDogMjAsDQoJCXNjb3BlOiAiZGVmYXVsdCIsDQoJCXRvbGVyYW5jZTogImludGVyc2VjdCIsDQoJCXpJbmRleDogMTAwMCwNCg0KCQkvLyBDYWxsYmFja3MNCgkJYWN0aXZhdGU6IG51bGwsDQoJCWJlZm9yZVN0b3A6IG51bGwsDQoJCWNoYW5nZTogbnVsbCwNCgkJZGVhY3RpdmF0ZTogbnVsbCwNCgkJb3V0OiBudWxsLA0KCQlvdmVyOiBudWxsLA0KCQlyZWNlaXZlOiBudWxsLA0KCQlyZW1vdmU6IG51bGwsDQoJCXNvcnQ6IG51bGwsDQoJCXN0YXJ0OiBudWxsLA0KCQlzdG9wOiBudWxsLA0KCQl1cGRhdGU6IG51bGwNCgl9LA0KDQoJX2lzT3ZlckF4aXM6IGZ1bmN0aW9uKCB4LCByZWZlcmVuY2UsIHNpemUgKSB7DQoJCXJldHVybiAoIHggPj0gcmVmZXJlbmNlICkgJiYgKCB4IDwgKCByZWZlcmVuY2UgKyBzaXplICkgKTsNCgl9LA0KDQoJX2lzRmxvYXRpbmc6IGZ1bmN0aW9uKCBpdGVtICkgew0KCQlyZXR1cm4gKCAvbGVmdHxyaWdodC8gKS50ZXN0KCBpdGVtLmNzcyggImZsb2F0IiApICkgfHwNCgkJCSggL2lubGluZXx0YWJsZS1jZWxsLyApLnRlc3QoIGl0ZW0uY3NzKCAiZGlzcGxheSIgKSApOw0KCX0sDQoNCglfY3JlYXRlOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5jb250YWluZXJDYWNoZSA9IHt9Ow0KCQl0aGlzLl9hZGRDbGFzcyggInVpLXNvcnRhYmxlIiApOw0KDQoJCS8vR2V0IHRoZSBpdGVtcw0KCQl0aGlzLnJlZnJlc2goKTsNCg0KCQkvL0xldCdzIGRldGVybWluZSB0aGUgcGFyZW50J3Mgb2Zmc2V0DQoJCXRoaXMub2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOw0KDQoJCS8vSW5pdGlhbGl6ZSBtb3VzZSBldmVudHMgZm9yIGludGVyYWN0aW9uDQoJCXRoaXMuX21vdXNlSW5pdCgpOw0KDQoJCXRoaXMuX3NldEhhbmRsZUNsYXNzTmFtZSgpOw0KDQoJCS8vV2UncmUgcmVhZHkgdG8gZ28NCgkJdGhpcy5yZWFkeSA9IHRydWU7DQoNCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7DQoNCgkJaWYgKCBrZXkgPT09ICJoYW5kbGUiICkgew0KCQkJdGhpcy5fc2V0SGFuZGxlQ2xhc3NOYW1lKCk7DQoJCX0NCgl9LA0KDQoJX3NldEhhbmRsZUNsYXNzTmFtZTogZnVuY3Rpb24oKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNvcnRhYmxlLWhhbmRsZSIgKSwgInVpLXNvcnRhYmxlLWhhbmRsZSIgKTsNCgkJJC5lYWNoKCB0aGlzLml0ZW1zLCBmdW5jdGlvbigpIHsNCgkJCXRoYXQuX2FkZENsYXNzKA0KCQkJCXRoaXMuaW5zdGFuY2Uub3B0aW9ucy5oYW5kbGUgPw0KCQkJCQl0aGlzLml0ZW0uZmluZCggdGhpcy5pbnN0YW5jZS5vcHRpb25zLmhhbmRsZSApIDoNCgkJCQkJdGhpcy5pdGVtLA0KCQkJCSJ1aS1zb3J0YWJsZS1oYW5kbGUiDQoJCQkpOw0KCQl9ICk7DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fbW91c2VEZXN0cm95KCk7DQoNCgkJZm9yICggdmFyIGkgPSB0aGlzLml0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgew0KCQkJdGhpcy5pdGVtc1sgaSBdLml0ZW0ucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICsgIi1pdGVtIiApOw0KCQl9DQoNCgkJcmV0dXJuIHRoaXM7DQoJfSwNCg0KCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKCBldmVudCwgb3ZlcnJpZGVIYW5kbGUgKSB7DQoJCXZhciBjdXJyZW50SXRlbSA9IG51bGwsDQoJCQl2YWxpZEhhbmRsZSA9IGZhbHNlLA0KCQkJdGhhdCA9IHRoaXM7DQoNCgkJaWYgKCB0aGlzLnJldmVydGluZyApIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KDQoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMub3B0aW9ucy50eXBlID09PSAic3RhdGljIiApIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KDQoJCS8vV2UgaGF2ZSB0byByZWZyZXNoIHRoZSBpdGVtcyBkYXRhIG9uY2UgZmlyc3QNCgkJdGhpcy5fcmVmcmVzaEl0ZW1zKCBldmVudCApOw0KDQoJCS8vRmluZCBvdXQgaWYgdGhlIGNsaWNrZWQgbm9kZSAob3Igb25lIG9mIGl0cyBwYXJlbnRzKSBpcyBhIGFjdHVhbCBpdGVtIGluIHRoaXMuaXRlbXMNCgkJJCggZXZlbnQudGFyZ2V0ICkucGFyZW50cygpLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJaWYgKCAkLmRhdGEoIHRoaXMsIHRoYXQud2lkZ2V0TmFtZSArICItaXRlbSIgKSA9PT0gdGhhdCApIHsNCgkJCQljdXJyZW50SXRlbSA9ICQoIHRoaXMgKTsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoJCX0gKTsNCgkJaWYgKCAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdGhhdC53aWRnZXROYW1lICsgIi1pdGVtIiApID09PSB0aGF0ICkgew0KCQkJY3VycmVudEl0ZW0gPSAkKCBldmVudC50YXJnZXQgKTsNCgkJfQ0KDQoJCWlmICggIWN1cnJlbnRJdGVtICkgew0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoJCWlmICggdGhpcy5vcHRpb25zLmhhbmRsZSAmJiAhb3ZlcnJpZGVIYW5kbGUgKSB7DQoJCQkkKCB0aGlzLm9wdGlvbnMuaGFuZGxlLCBjdXJyZW50SXRlbSApLmZpbmQoICIqIiApLmFkZEJhY2soKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQlpZiAoIHRoaXMgPT09IGV2ZW50LnRhcmdldCApIHsNCgkJCQkJdmFsaWRIYW5kbGUgPSB0cnVlOw0KCQkJCX0NCgkJCX0gKTsNCgkJCWlmICggIXZhbGlkSGFuZGxlICkgew0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0NCgkJfQ0KDQoJCXRoaXMuY3VycmVudEl0ZW0gPSBjdXJyZW50SXRlbTsNCgkJdGhpcy5fcmVtb3ZlQ3VycmVudHNGcm9tSXRlbXMoKTsNCgkJcmV0dXJuIHRydWU7DQoNCgl9LA0KDQoJX21vdXNlU3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgb3ZlcnJpZGVIYW5kbGUsIG5vQWN0aXZhdGlvbiApIHsNCg0KCQl2YXIgaSwgYm9keSwNCgkJCW8gPSB0aGlzLm9wdGlvbnM7DQoNCgkJdGhpcy5jdXJyZW50Q29udGFpbmVyID0gdGhpczsNCg0KCQkvL1dlIG9ubHkgbmVlZCB0byBjYWxsIHJlZnJlc2hQb3NpdGlvbnMsIGJlY2F1c2UgdGhlIHJlZnJlc2hJdGVtcyBjYWxsIGhhcyBiZWVuIG1vdmVkIHRvDQoJCS8vIG1vdXNlQ2FwdHVyZQ0KCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoKTsNCg0KCQkvL0NyZWF0ZSBhbmQgYXBwZW5kIHRoZSB2aXNpYmxlIGhlbHBlcg0KCQl0aGlzLmhlbHBlciA9IHRoaXMuX2NyZWF0ZUhlbHBlciggZXZlbnQgKTsNCg0KCQkvL0NhY2hlIHRoZSBoZWxwZXIgc2l6ZQ0KCQl0aGlzLl9jYWNoZUhlbHBlclByb3BvcnRpb25zKCk7DQoNCgkJLyoNCgkJICogLSBQb3NpdGlvbiBnZW5lcmF0aW9uIC0NCgkJICogVGhpcyBibG9jayBnZW5lcmF0ZXMgZXZlcnl0aGluZyBwb3NpdGlvbiByZWxhdGVkIC0gaXQncyB0aGUgY29yZSBvZiBkcmFnZ2FibGVzLg0KCQkgKi8NCg0KCQkvL0NhY2hlIHRoZSBtYXJnaW5zIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50DQoJCXRoaXMuX2NhY2hlTWFyZ2lucygpOw0KDQoJCS8vR2V0IHRoZSBuZXh0IHNjcm9sbGluZyBwYXJlbnQNCgkJdGhpcy5zY3JvbGxQYXJlbnQgPSB0aGlzLmhlbHBlci5zY3JvbGxQYXJlbnQoKTsNCg0KCQkvL1RoZSBlbGVtZW50J3MgYWJzb2x1dGUgcG9zaXRpb24gb24gdGhlIHBhZ2UgbWludXMgbWFyZ2lucw0KCQl0aGlzLm9mZnNldCA9IHRoaXMuY3VycmVudEl0ZW0ub2Zmc2V0KCk7DQoJCXRoaXMub2Zmc2V0ID0gew0KCQkJdG9wOiB0aGlzLm9mZnNldC50b3AgLSB0aGlzLm1hcmdpbnMudG9wLA0KCQkJbGVmdDogdGhpcy5vZmZzZXQubGVmdCAtIHRoaXMubWFyZ2lucy5sZWZ0DQoJCX07DQoNCgkJJC5leHRlbmQoIHRoaXMub2Zmc2V0LCB7DQoJCQljbGljazogeyAvL1doZXJlIHRoZSBjbGljayBoYXBwZW5lZCwgcmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQNCgkJCQlsZWZ0OiBldmVudC5wYWdlWCAtIHRoaXMub2Zmc2V0LmxlZnQsDQoJCQkJdG9wOiBldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LnRvcA0KCQkJfSwNCgkJCXBhcmVudDogdGhpcy5fZ2V0UGFyZW50T2Zmc2V0KCksDQoNCgkJCS8vIFRoaXMgaXMgYSByZWxhdGl2ZSB0byBhYnNvbHV0ZSBwb3NpdGlvbiBtaW51cyB0aGUgYWN0dWFsIHBvc2l0aW9uIGNhbGN1bGF0aW9uIC0NCgkJCS8vIG9ubHkgdXNlZCBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBoZWxwZXINCgkJCXJlbGF0aXZlOiB0aGlzLl9nZXRSZWxhdGl2ZU9mZnNldCgpDQoJCX0gKTsNCg0KCQkvLyBPbmx5IGFmdGVyIHdlIGdvdCB0aGUgb2Zmc2V0LCB3ZSBjYW4gY2hhbmdlIHRoZSBoZWxwZXIncyBwb3NpdGlvbiB0byBhYnNvbHV0ZQ0KCQkvLyBUT0RPOiBTdGlsbCBuZWVkIHRvIGZpZ3VyZSBvdXQgYSB3YXkgdG8gbWFrZSByZWxhdGl2ZSBzb3J0aW5nIHBvc3NpYmxlDQoJCXRoaXMuaGVscGVyLmNzcyggInBvc2l0aW9uIiwgImFic29sdXRlIiApOw0KCQl0aGlzLmNzc1Bvc2l0aW9uID0gdGhpcy5oZWxwZXIuY3NzKCAicG9zaXRpb24iICk7DQoNCgkJLy9HZW5lcmF0ZSB0aGUgb3JpZ2luYWwgcG9zaXRpb24NCgkJdGhpcy5vcmlnaW5hbFBvc2l0aW9uID0gdGhpcy5fZ2VuZXJhdGVQb3NpdGlvbiggZXZlbnQgKTsNCgkJdGhpcy5vcmlnaW5hbFBhZ2VYID0gZXZlbnQucGFnZVg7DQoJCXRoaXMub3JpZ2luYWxQYWdlWSA9IGV2ZW50LnBhZ2VZOw0KDQoJCS8vQWRqdXN0IHRoZSBtb3VzZSBvZmZzZXQgcmVsYXRpdmUgdG8gdGhlIGhlbHBlciBpZiAiY3Vyc29yQXQiIGlzIHN1cHBsaWVkDQoJCSggby5jdXJzb3JBdCAmJiB0aGlzLl9hZGp1c3RPZmZzZXRGcm9tSGVscGVyKCBvLmN1cnNvckF0ICkgKTsNCg0KCQkvL0NhY2hlIHRoZSBmb3JtZXIgRE9NIHBvc2l0aW9uDQoJCXRoaXMuZG9tUG9zaXRpb24gPSB7DQoJCQlwcmV2OiB0aGlzLmN1cnJlbnRJdGVtLnByZXYoKVsgMCBdLA0KCQkJcGFyZW50OiB0aGlzLmN1cnJlbnRJdGVtLnBhcmVudCgpWyAwIF0NCgkJfTsNCg0KCQkvLyBJZiB0aGUgaGVscGVyIGlzIG5vdCB0aGUgb3JpZ2luYWwsIGhpZGUgdGhlIG9yaWdpbmFsIHNvIGl0J3Mgbm90IHBsYXlpbmcgYW55IHJvbGUgZHVyaW5nDQoJCS8vIHRoZSBkcmFnLCB3b24ndCBjYXVzZSBhbnl0aGluZyBiYWQgdGhpcyB3YXkNCgkJaWYgKCB0aGlzLmhlbHBlclsgMCBdICE9PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7DQoJCQl0aGlzLmN1cnJlbnRJdGVtLmhpZGUoKTsNCgkJfQ0KDQoJCS8vQ3JlYXRlIHRoZSBwbGFjZWhvbGRlcg0KCQl0aGlzLl9jcmVhdGVQbGFjZWhvbGRlcigpOw0KDQoJCS8vU2V0IGEgY29udGFpbm1lbnQgaWYgZ2l2ZW4gaW4gdGhlIG9wdGlvbnMNCgkJaWYgKCBvLmNvbnRhaW5tZW50ICkgew0KCQkJdGhpcy5fc2V0Q29udGFpbm1lbnQoKTsNCgkJfQ0KDQoJCWlmICggby5jdXJzb3IgJiYgby5jdXJzb3IgIT09ICJhdXRvIiApIHsgLy8gY3Vyc29yIG9wdGlvbg0KCQkJYm9keSA9IHRoaXMuZG9jdW1lbnQuZmluZCggImJvZHkiICk7DQoNCgkJCS8vIFN1cHBvcnQ6IElFDQoJCQl0aGlzLnN0b3JlZEN1cnNvciA9IGJvZHkuY3NzKCAiY3Vyc29yIiApOw0KCQkJYm9keS5jc3MoICJjdXJzb3IiLCBvLmN1cnNvciApOw0KDQoJCQl0aGlzLnN0b3JlZFN0eWxlc2hlZXQgPQ0KCQkJCSQoICI8c3R5bGU+KnsgY3Vyc29yOiAiICsgby5jdXJzb3IgKyAiICFpbXBvcnRhbnQ7IH08L3N0eWxlPiIgKS5hcHBlbmRUbyggYm9keSApOw0KCQl9DQoNCgkJaWYgKCBvLm9wYWNpdHkgKSB7IC8vIG9wYWNpdHkgb3B0aW9uDQoJCQlpZiAoIHRoaXMuaGVscGVyLmNzcyggIm9wYWNpdHkiICkgKSB7DQoJCQkJdGhpcy5fc3RvcmVkT3BhY2l0eSA9IHRoaXMuaGVscGVyLmNzcyggIm9wYWNpdHkiICk7DQoJCQl9DQoJCQl0aGlzLmhlbHBlci5jc3MoICJvcGFjaXR5Iiwgby5vcGFjaXR5ICk7DQoJCX0NCg0KCQlpZiAoIG8uekluZGV4ICkgeyAvLyB6SW5kZXggb3B0aW9uDQoJCQlpZiAoIHRoaXMuaGVscGVyLmNzcyggInpJbmRleCIgKSApIHsNCgkJCQl0aGlzLl9zdG9yZWRaSW5kZXggPSB0aGlzLmhlbHBlci5jc3MoICJ6SW5kZXgiICk7DQoJCQl9DQoJCQl0aGlzLmhlbHBlci5jc3MoICJ6SW5kZXgiLCBvLnpJbmRleCApOw0KCQl9DQoNCgkJLy9QcmVwYXJlIHNjcm9sbGluZw0KCQlpZiAoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IHRoaXMuZG9jdW1lbnRbIDAgXSAmJg0KCQkJCXRoaXMuc2Nyb2xsUGFyZW50WyAwIF0udGFnTmFtZSAhPT0gIkhUTUwiICkgew0KCQkJdGhpcy5vdmVyZmxvd09mZnNldCA9IHRoaXMuc2Nyb2xsUGFyZW50Lm9mZnNldCgpOw0KCQl9DQoNCgkJLy9DYWxsIGNhbGxiYWNrcw0KCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsNCg0KCQkvL1JlY2FjaGUgdGhlIGhlbHBlciBzaXplDQoJCWlmICggIXRoaXMuX3ByZXNlcnZlSGVscGVyUHJvcG9ydGlvbnMgKSB7DQoJCQl0aGlzLl9jYWNoZUhlbHBlclByb3BvcnRpb25zKCk7DQoJCX0NCg0KCQkvL1Bvc3QgImFjdGl2YXRlIiBldmVudHMgdG8gcG9zc2libGUgY29udGFpbmVycw0KCQlpZiAoICFub0FjdGl2YXRpb24gKSB7DQoJCQlmb3IgKCBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgew0KCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLl90cmlnZ2VyKCAiYWN0aXZhdGUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsNCgkJCX0NCgkJfQ0KDQoJCS8vUHJlcGFyZSBwb3NzaWJsZSBkcm9wcGFibGVzDQoJCWlmICggJC51aS5kZG1hbmFnZXIgKSB7DQoJCQkkLnVpLmRkbWFuYWdlci5jdXJyZW50ID0gdGhpczsNCgkJfQ0KDQoJCWlmICggJC51aS5kZG1hbmFnZXIgJiYgIW8uZHJvcEJlaGF2aW91ciApIHsNCgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCB0aGlzLCBldmVudCApOw0KCQl9DQoNCgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7DQoNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGVscGVyLCAidWktc29ydGFibGUtaGVscGVyIiApOw0KDQoJCS8vIEV4ZWN1dGUgdGhlIGRyYWcgb25jZSAtIHRoaXMgY2F1c2VzIHRoZSBoZWxwZXIgbm90IHRvIGJlIHZpc2libGViZWZvcmUgZ2V0dGluZyBpdHMNCgkJLy8gY29ycmVjdCBwb3NpdGlvbg0KCQl0aGlzLl9tb3VzZURyYWcoIGV2ZW50ICk7DQoJCXJldHVybiB0cnVlOw0KDQoJfSwNCg0KCV9tb3VzZURyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIGksIGl0ZW0sIGl0ZW1FbGVtZW50LCBpbnRlcnNlY3Rpb24sDQoJCQlvID0gdGhpcy5vcHRpb25zLA0KCQkJc2Nyb2xsZWQgPSBmYWxzZTsNCg0KCQkvL0NvbXB1dGUgdGhlIGhlbHBlcnMgcG9zaXRpb24NCgkJdGhpcy5wb3NpdGlvbiA9IHRoaXMuX2dlbmVyYXRlUG9zaXRpb24oIGV2ZW50ICk7DQoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbyggImFic29sdXRlIiApOw0KDQoJCWlmICggIXRoaXMubGFzdFBvc2l0aW9uQWJzICkgew0KCQkJdGhpcy5sYXN0UG9zaXRpb25BYnMgPSB0aGlzLnBvc2l0aW9uQWJzOw0KCQl9DQoNCgkJLy9EbyBzY3JvbGxpbmcNCgkJaWYgKCB0aGlzLm9wdGlvbnMuc2Nyb2xsICkgew0KCQkJaWYgKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICE9PSB0aGlzLmRvY3VtZW50WyAwIF0gJiYNCgkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS50YWdOYW1lICE9PSAiSFRNTCIgKSB7DQoNCgkJCQlpZiAoICggdGhpcy5vdmVyZmxvd09mZnNldC50b3AgKyB0aGlzLnNjcm9sbFBhcmVudFsgMCBdLm9mZnNldEhlaWdodCApIC0NCgkJCQkJCWV2ZW50LnBhZ2VZIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsNCgkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxUb3AgPQ0KCQkJCQkJc2Nyb2xsZWQgPSB0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbFRvcCArIG8uc2Nyb2xsU3BlZWQ7DQoJCQkJfSBlbHNlIGlmICggZXZlbnQucGFnZVkgLSB0aGlzLm92ZXJmbG93T2Zmc2V0LnRvcCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7DQoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WyAwIF0uc2Nyb2xsVG9wID0NCgkJCQkJCXNjcm9sbGVkID0gdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxUb3AgLSBvLnNjcm9sbFNwZWVkOw0KCQkJCX0NCg0KCQkJCWlmICggKCB0aGlzLm92ZXJmbG93T2Zmc2V0LmxlZnQgKyB0aGlzLnNjcm9sbFBhcmVudFsgMCBdLm9mZnNldFdpZHRoICkgLQ0KCQkJCQkJZXZlbnQucGFnZVggPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgew0KCQkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbExlZnQgPSBzY3JvbGxlZCA9DQoJCQkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbExlZnQgKyBvLnNjcm9sbFNwZWVkOw0KCQkJCX0gZWxzZSBpZiAoIGV2ZW50LnBhZ2VYIC0gdGhpcy5vdmVyZmxvd09mZnNldC5sZWZ0IDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsNCgkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxMZWZ0ID0gc2Nyb2xsZWQgPQ0KCQkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxMZWZ0IC0gby5zY3JvbGxTcGVlZDsNCgkJCQl9DQoNCgkJCX0gZWxzZSB7DQoNCgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7DQoJCQkJCXNjcm9sbGVkID0gdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoIHRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKCkgLSBvLnNjcm9sbFNwZWVkICk7DQoJCQkJfSBlbHNlIGlmICggdGhpcy53aW5kb3cuaGVpZ2h0KCkgLSAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoKSApIDwNCgkJCQkJCW8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7DQoJCQkJCXNjcm9sbGVkID0gdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoIHRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKCkgKyBvLnNjcm9sbFNwZWVkICk7DQoJCQkJfQ0KDQoJCQkJaWYgKCBldmVudC5wYWdlWCAtIHRoaXMuZG9jdW1lbnQuc2Nyb2xsTGVmdCgpIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsNCgkJCQkJc2Nyb2xsZWQgPSB0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoDQoJCQkJCQl0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoKSAtIG8uc2Nyb2xsU3BlZWQNCgkJCQkJKTsNCgkJCQl9IGVsc2UgaWYgKCB0aGlzLndpbmRvdy53aWR0aCgpIC0gKCBldmVudC5wYWdlWCAtIHRoaXMuZG9jdW1lbnQuc2Nyb2xsTGVmdCgpICkgPA0KCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsNCgkJCQkJc2Nyb2xsZWQgPSB0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoDQoJCQkJCQl0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoKSArIG8uc2Nyb2xsU3BlZWQNCgkJCQkJKTsNCgkJCQl9DQoNCgkJCX0NCg0KCQkJaWYgKCBzY3JvbGxlZCAhPT0gZmFsc2UgJiYgJC51aS5kZG1hbmFnZXIgJiYgIW8uZHJvcEJlaGF2aW91ciApIHsNCgkJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggdGhpcywgZXZlbnQgKTsNCgkJCX0NCgkJfQ0KDQoJCS8vUmVnZW5lcmF0ZSB0aGUgYWJzb2x1dGUgcG9zaXRpb24gdXNlZCBmb3IgcG9zaXRpb24gY2hlY2tzDQoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbyggImFic29sdXRlIiApOw0KDQoJCS8vU2V0IHRoZSBoZWxwZXIgcG9zaXRpb24NCgkJaWYgKCAhdGhpcy5vcHRpb25zLmF4aXMgfHwgdGhpcy5vcHRpb25zLmF4aXMgIT09ICJ5IiApIHsNCgkJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUubGVmdCA9IHRoaXMucG9zaXRpb24ubGVmdCArICJweCI7DQoJCX0NCgkJaWYgKCAhdGhpcy5vcHRpb25zLmF4aXMgfHwgdGhpcy5vcHRpb25zLmF4aXMgIT09ICJ4IiApIHsNCgkJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUudG9wID0gdGhpcy5wb3NpdGlvbi50b3AgKyAicHgiOw0KCQl9DQoNCgkJLy9SZWFycmFuZ2UNCgkJZm9yICggaSA9IHRoaXMuaXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7DQoNCgkJCS8vQ2FjaGUgdmFyaWFibGVzIGFuZCBpbnRlcnNlY3Rpb24sIGNvbnRpbnVlIGlmIG5vIGludGVyc2VjdGlvbg0KCQkJaXRlbSA9IHRoaXMuaXRlbXNbIGkgXTsNCgkJCWl0ZW1FbGVtZW50ID0gaXRlbS5pdGVtWyAwIF07DQoJCQlpbnRlcnNlY3Rpb24gPSB0aGlzLl9pbnRlcnNlY3RzV2l0aFBvaW50ZXIoIGl0ZW0gKTsNCgkJCWlmICggIWludGVyc2VjdGlvbiApIHsNCgkJCQljb250aW51ZTsNCgkJCX0NCg0KCQkJLy8gT25seSBwdXQgdGhlIHBsYWNlaG9sZGVyIGluc2lkZSB0aGUgY3VycmVudCBDb250YWluZXIsIHNraXAgYWxsDQoJCQkvLyBpdGVtcyBmcm9tIG90aGVyIGNvbnRhaW5lcnMuIFRoaXMgd29ya3MgYmVjYXVzZSB3aGVuIG1vdmluZw0KCQkJLy8gYW4gaXRlbSBmcm9tIG9uZSBjb250YWluZXIgdG8gYW5vdGhlciB0aGUNCgkJCS8vIGN1cnJlbnRDb250YWluZXIgaXMgc3dpdGNoZWQgYmVmb3JlIHRoZSBwbGFjZWhvbGRlciBpcyBtb3ZlZC4NCgkJCS8vDQoJCQkvLyBXaXRob3V0IHRoaXMsIG1vdmluZyBpdGVtcyBpbiAic3ViLXNvcnRhYmxlcyIgY2FuIGNhdXNlDQoJCQkvLyB0aGUgcGxhY2Vob2xkZXIgdG8gaml0dGVyIGJldHdlZW4gdGhlIG91dGVyIGFuZCBpbm5lciBjb250YWluZXIuDQoJCQlpZiAoIGl0ZW0uaW5zdGFuY2UgIT09IHRoaXMuY3VycmVudENvbnRhaW5lciApIHsNCgkJCQljb250aW51ZTsNCgkJCX0NCg0KCQkJLy8gQ2Fubm90IGludGVyc2VjdCB3aXRoIGl0c2VsZg0KCQkJLy8gbm8gdXNlbGVzcyBhY3Rpb25zIHRoYXQgaGF2ZSBiZWVuIGRvbmUgYmVmb3JlDQoJCQkvLyBubyBhY3Rpb24gaWYgdGhlIGl0ZW0gbW92ZWQgaXMgdGhlIHBhcmVudCBvZiB0aGUgaXRlbSBjaGVja2VkDQoJCQlpZiAoIGl0ZW1FbGVtZW50ICE9PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gJiYNCgkJCQl0aGlzLnBsYWNlaG9sZGVyWyBpbnRlcnNlY3Rpb24gPT09IDEgPyAibmV4dCIgOiAicHJldiIgXSgpWyAwIF0gIT09IGl0ZW1FbGVtZW50ICYmDQoJCQkJISQuY29udGFpbnMoIHRoaXMucGxhY2Vob2xkZXJbIDAgXSwgaXRlbUVsZW1lbnQgKSAmJg0KCQkJCSggdGhpcy5vcHRpb25zLnR5cGUgPT09ICJzZW1pLWR5bmFtaWMiID8NCgkJCQkJISQuY29udGFpbnMoIHRoaXMuZWxlbWVudFsgMCBdLCBpdGVtRWxlbWVudCApIDoNCgkJCQkJdHJ1ZQ0KCQkJCSkNCgkJCSkgew0KDQoJCQkJdGhpcy5kaXJlY3Rpb24gPSBpbnRlcnNlY3Rpb24gPT09IDEgPyAiZG93biIgOiAidXAiOw0KDQoJCQkJaWYgKCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlID09PSAicG9pbnRlciIgfHwgdGhpcy5faW50ZXJzZWN0c1dpdGhTaWRlcyggaXRlbSApICkgew0KCQkJCQl0aGlzLl9yZWFycmFuZ2UoIGV2ZW50LCBpdGVtICk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJYnJlYWs7DQoJCQkJfQ0KDQoJCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOw0KCQkJCWJyZWFrOw0KCQkJfQ0KCQl9DQoNCgkJLy9Qb3N0IGV2ZW50cyB0byBjb250YWluZXJzDQoJCXRoaXMuX2NvbnRhY3RDb250YWluZXJzKCBldmVudCApOw0KDQoJCS8vSW50ZXJjb25uZWN0IHdpdGggZHJvcHBhYmxlcw0KCQlpZiAoICQudWkuZGRtYW5hZ2VyICkgew0KCQkJJC51aS5kZG1hbmFnZXIuZHJhZyggdGhpcywgZXZlbnQgKTsNCgkJfQ0KDQoJCS8vQ2FsbCBjYWxsYmFja3MNCgkJdGhpcy5fdHJpZ2dlciggInNvcnQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsNCg0KCQl0aGlzLmxhc3RQb3NpdGlvbkFicyA9IHRoaXMucG9zaXRpb25BYnM7DQoJCXJldHVybiBmYWxzZTsNCg0KCX0sDQoNCglfbW91c2VTdG9wOiBmdW5jdGlvbiggZXZlbnQsIG5vUHJvcGFnYXRpb24gKSB7DQoNCgkJaWYgKCAhZXZlbnQgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvL0lmIHdlIGFyZSB1c2luZyBkcm9wcGFibGVzLCBpbmZvcm0gdGhlIG1hbmFnZXIgYWJvdXQgdGhlIGRyb3ANCgkJaWYgKCAkLnVpLmRkbWFuYWdlciAmJiAhdGhpcy5vcHRpb25zLmRyb3BCZWhhdmlvdXIgKSB7DQoJCQkkLnVpLmRkbWFuYWdlci5kcm9wKCB0aGlzLCBldmVudCApOw0KCQl9DQoNCgkJaWYgKCB0aGlzLm9wdGlvbnMucmV2ZXJ0ICkgew0KCQkJdmFyIHRoYXQgPSB0aGlzLA0KCQkJCWN1ciA9IHRoaXMucGxhY2Vob2xkZXIub2Zmc2V0KCksDQoJCQkJYXhpcyA9IHRoaXMub3B0aW9ucy5heGlzLA0KCQkJCWFuaW1hdGlvbiA9IHt9Ow0KDQoJCQlpZiAoICFheGlzIHx8IGF4aXMgPT09ICJ4IiApIHsNCgkJCQlhbmltYXRpb24ubGVmdCA9IGN1ci5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgLSB0aGlzLm1hcmdpbnMubGVmdCArDQoJCQkJCSggdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSA9PT0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHkgPw0KCQkJCQkJMCA6DQoJCQkJCQl0aGlzLm9mZnNldFBhcmVudFsgMCBdLnNjcm9sbExlZnQNCgkJCQkJKTsNCgkJCX0NCgkJCWlmICggIWF4aXMgfHwgYXhpcyA9PT0gInkiICkgew0KCQkJCWFuaW1hdGlvbi50b3AgPSBjdXIudG9wIC0gdGhpcy5vZmZzZXQucGFyZW50LnRvcCAtIHRoaXMubWFyZ2lucy50b3AgKw0KCQkJCQkoIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gPT09IHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5ID8NCgkJCQkJCTAgOg0KCQkJCQkJdGhpcy5vZmZzZXRQYXJlbnRbIDAgXS5zY3JvbGxUb3ANCgkJCQkJKTsNCgkJCX0NCgkJCXRoaXMucmV2ZXJ0aW5nID0gdHJ1ZTsNCgkJCSQoIHRoaXMuaGVscGVyICkuYW5pbWF0ZSgNCgkJCQlhbmltYXRpb24sDQoJCQkJcGFyc2VJbnQoIHRoaXMub3B0aW9ucy5yZXZlcnQsIDEwICkgfHwgNTAwLA0KCQkJCWZ1bmN0aW9uKCkgew0KCQkJCQl0aGF0Ll9jbGVhciggZXZlbnQgKTsNCgkJCQl9DQoJCQkpOw0KCQl9IGVsc2Ugew0KCQkJdGhpcy5fY2xlYXIoIGV2ZW50LCBub1Byb3BhZ2F0aW9uICk7DQoJCX0NCg0KCQlyZXR1cm4gZmFsc2U7DQoNCgl9LA0KDQoJY2FuY2VsOiBmdW5jdGlvbigpIHsNCg0KCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7DQoNCgkJCXRoaXMuX21vdXNlVXAoIG5ldyAkLkV2ZW50KCAibW91c2V1cCIsIHsgdGFyZ2V0OiBudWxsIH0gKSApOw0KDQoJCQlpZiAoIHRoaXMub3B0aW9ucy5oZWxwZXIgPT09ICJvcmlnaW5hbCIgKSB7DQoJCQkJdGhpcy5jdXJyZW50SXRlbS5jc3MoIHRoaXMuX3N0b3JlZENTUyApOw0KCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmN1cnJlbnRJdGVtLCAidWktc29ydGFibGUtaGVscGVyIiApOw0KCQkJfSBlbHNlIHsNCgkJCQl0aGlzLmN1cnJlbnRJdGVtLnNob3coKTsNCgkJCX0NCg0KCQkJLy9Qb3N0IGRlYWN0aXZhdGluZyBldmVudHMgdG8gY29udGFpbmVycw0KCQkJZm9yICggdmFyIGkgPSB0aGlzLmNvbnRhaW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7DQoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uX3RyaWdnZXIoICJkZWFjdGl2YXRlIiwgbnVsbCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsNCgkJCQlpZiAoIHRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7DQoJCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLl90cmlnZ2VyKCAib3V0IiwgbnVsbCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsNCgkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDA7DQoJCQkJfQ0KCQkJfQ0KDQoJCX0NCg0KCQlpZiAoIHRoaXMucGxhY2Vob2xkZXIgKSB7DQoNCgkJCS8vJCh0aGlzLnBsYWNlaG9sZGVyWzBdKS5yZW1vdmUoKTsgd291bGQgaGF2ZSBiZWVuIHRoZSBqUXVlcnkgd2F5IC0gdW5mb3J0dW5hdGVseSwNCgkJCS8vIGl0IHVuYmluZHMgQUxMIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIQ0KCQkJaWYgKCB0aGlzLnBsYWNlaG9sZGVyWyAwIF0ucGFyZW50Tm9kZSApIHsNCgkJCQl0aGlzLnBsYWNlaG9sZGVyWyAwIF0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggdGhpcy5wbGFjZWhvbGRlclsgMCBdICk7DQoJCQl9DQoJCQlpZiAoIHRoaXMub3B0aW9ucy5oZWxwZXIgIT09ICJvcmlnaW5hbCIgJiYgdGhpcy5oZWxwZXIgJiYNCgkJCQkJdGhpcy5oZWxwZXJbIDAgXS5wYXJlbnROb2RlICkgew0KCQkJCXRoaXMuaGVscGVyLnJlbW92ZSgpOw0KCQkJfQ0KDQoJCQkkLmV4dGVuZCggdGhpcywgew0KCQkJCWhlbHBlcjogbnVsbCwNCgkJCQlkcmFnZ2luZzogZmFsc2UsDQoJCQkJcmV2ZXJ0aW5nOiBmYWxzZSwNCgkJCQlfbm9GaW5hbFNvcnQ6IG51bGwNCgkJCX0gKTsNCg0KCQkJaWYgKCB0aGlzLmRvbVBvc2l0aW9uLnByZXYgKSB7DQoJCQkJJCggdGhpcy5kb21Qb3NpdGlvbi5wcmV2ICkuYWZ0ZXIoIHRoaXMuY3VycmVudEl0ZW0gKTsNCgkJCX0gZWxzZSB7DQoJCQkJJCggdGhpcy5kb21Qb3NpdGlvbi5wYXJlbnQgKS5wcmVwZW5kKCB0aGlzLmN1cnJlbnRJdGVtICk7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gdGhpczsNCg0KCX0sDQoNCglzZXJpYWxpemU6IGZ1bmN0aW9uKCBvICkgew0KDQoJCXZhciBpdGVtcyA9IHRoaXMuX2dldEl0ZW1zQXNqUXVlcnkoIG8gJiYgby5jb25uZWN0ZWQgKSwNCgkJCXN0ciA9IFtdOw0KCQlvID0gbyB8fCB7fTsNCg0KCQkkKCBpdGVtcyApLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJdmFyIHJlcyA9ICggJCggby5pdGVtIHx8IHRoaXMgKS5hdHRyKCBvLmF0dHJpYnV0ZSB8fCAiaWQiICkgfHwgIiIgKQ0KCQkJCS5tYXRjaCggby5leHByZXNzaW9uIHx8ICggLyguKylbXC09X10oLispLyApICk7DQoJCQlpZiAoIHJlcyApIHsNCgkJCQlzdHIucHVzaCgNCgkJCQkJKCBvLmtleSB8fCByZXNbIDEgXSArICJbXSIgKSArDQoJCQkJCSI9IiArICggby5rZXkgJiYgby5leHByZXNzaW9uID8gcmVzWyAxIF0gOiByZXNbIDIgXSApICk7DQoJCQl9DQoJCX0gKTsNCg0KCQlpZiAoICFzdHIubGVuZ3RoICYmIG8ua2V5ICkgew0KCQkJc3RyLnB1c2goIG8ua2V5ICsgIj0iICk7DQoJCX0NCg0KCQlyZXR1cm4gc3RyLmpvaW4oICImIiApOw0KDQoJfSwNCg0KCXRvQXJyYXk6IGZ1bmN0aW9uKCBvICkgew0KDQoJCXZhciBpdGVtcyA9IHRoaXMuX2dldEl0ZW1zQXNqUXVlcnkoIG8gJiYgby5jb25uZWN0ZWQgKSwNCgkJCXJldCA9IFtdOw0KDQoJCW8gPSBvIHx8IHt9Ow0KDQoJCWl0ZW1zLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJcmV0LnB1c2goICQoIG8uaXRlbSB8fCB0aGlzICkuYXR0ciggby5hdHRyaWJ1dGUgfHwgImlkIiApIHx8ICIiICk7DQoJCX0gKTsNCgkJcmV0dXJuIHJldDsNCg0KCX0sDQoNCgkvKiBCZSBjYXJlZnVsIHdpdGggdGhlIGZvbGxvd2luZyBjb3JlIGZ1bmN0aW9ucyAqLw0KCV9pbnRlcnNlY3RzV2l0aDogZnVuY3Rpb24oIGl0ZW0gKSB7DQoNCgkJdmFyIHgxID0gdGhpcy5wb3NpdGlvbkFicy5sZWZ0LA0KCQkJeDIgPSB4MSArIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgsDQoJCQl5MSA9IHRoaXMucG9zaXRpb25BYnMudG9wLA0KCQkJeTIgPSB5MSArIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LA0KCQkJbCA9IGl0ZW0ubGVmdCwNCgkJCXIgPSBsICsgaXRlbS53aWR0aCwNCgkJCXQgPSBpdGVtLnRvcCwNCgkJCWIgPSB0ICsgaXRlbS5oZWlnaHQsDQoJCQlkeUNsaWNrID0gdGhpcy5vZmZzZXQuY2xpY2sudG9wLA0KCQkJZHhDbGljayA9IHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQsDQoJCQlpc092ZXJFbGVtZW50SGVpZ2h0ID0gKCB0aGlzLm9wdGlvbnMuYXhpcyA9PT0gIngiICkgfHwgKCAoIHkxICsgZHlDbGljayApID4gdCAmJg0KCQkJCSggeTEgKyBkeUNsaWNrICkgPCBiICksDQoJCQlpc092ZXJFbGVtZW50V2lkdGggPSAoIHRoaXMub3B0aW9ucy5heGlzID09PSAieSIgKSB8fCAoICggeDEgKyBkeENsaWNrICkgPiBsICYmDQoJCQkJKCB4MSArIGR4Q2xpY2sgKSA8IHIgKSwNCgkJCWlzT3ZlckVsZW1lbnQgPSBpc092ZXJFbGVtZW50SGVpZ2h0ICYmIGlzT3ZlckVsZW1lbnRXaWR0aDsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy50b2xlcmFuY2UgPT09ICJwb2ludGVyIiB8fA0KCQkJdGhpcy5vcHRpb25zLmZvcmNlUG9pbnRlckZvckNvbnRhaW5lcnMgfHwNCgkJCSggdGhpcy5vcHRpb25zLnRvbGVyYW5jZSAhPT0gInBvaW50ZXIiICYmDQoJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9uc1sgdGhpcy5mbG9hdGluZyA\/ICJ3aWR0aCIgOiAiaGVpZ2h0IiBdID4NCgkJCQlpdGVtWyB0aGlzLmZsb2F0aW5nID8gIndpZHRoIiA6ICJoZWlnaHQiIF0gKQ0KCQkpIHsNCgkJCXJldHVybiBpc092ZXJFbGVtZW50Ow0KCQl9IGVsc2Ugew0KDQoJCQlyZXR1cm4gKCBsIDwgeDEgKyAoIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLyAyICkgJiYgLy8gUmlnaHQgSGFsZg0KCQkJCXgyIC0gKCB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC8gMiApIDwgciAmJiAvLyBMZWZ0IEhhbGYNCgkJCQl0IDwgeTEgKyAoIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC8gMiApICYmIC8vIEJvdHRvbSBIYWxmDQoJCQkJeTIgLSAoIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC8gMiApIDwgYiApOyAvLyBUb3AgSGFsZg0KDQoJCX0NCgl9LA0KDQoJX2ludGVyc2VjdHNXaXRoUG9pbnRlcjogZnVuY3Rpb24oIGl0ZW0gKSB7DQoJCXZhciB2ZXJ0aWNhbERpcmVjdGlvbiwgaG9yaXpvbnRhbERpcmVjdGlvbiwNCgkJCWlzT3ZlckVsZW1lbnRIZWlnaHQgPSAoIHRoaXMub3B0aW9ucy5heGlzID09PSAieCIgKSB8fA0KCQkJCXRoaXMuX2lzT3ZlckF4aXMoDQoJCQkJCXRoaXMucG9zaXRpb25BYnMudG9wICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wLCBpdGVtLnRvcCwgaXRlbS5oZWlnaHQgKSwNCgkJCWlzT3ZlckVsZW1lbnRXaWR0aCA9ICggdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ5IiApIHx8DQoJCQkJdGhpcy5faXNPdmVyQXhpcygNCgkJCQkJdGhpcy5wb3NpdGlvbkFicy5sZWZ0ICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdCwgaXRlbS5sZWZ0LCBpdGVtLndpZHRoICksDQoJCQlpc092ZXJFbGVtZW50ID0gaXNPdmVyRWxlbWVudEhlaWdodCAmJiBpc092ZXJFbGVtZW50V2lkdGg7DQoNCgkJaWYgKCAhaXNPdmVyRWxlbWVudCApIHsNCgkJCXJldHVybiBmYWxzZTsNCgkJfQ0KDQoJCXZlcnRpY2FsRGlyZWN0aW9uID0gdGhpcy5fZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uKCk7DQoJCWhvcml6b250YWxEaXJlY3Rpb24gPSB0aGlzLl9nZXREcmFnSG9yaXpvbnRhbERpcmVjdGlvbigpOw0KDQoJCXJldHVybiB0aGlzLmZsb2F0aW5nID8NCgkJCSggKCBob3Jpem9udGFsRGlyZWN0aW9uID09PSAicmlnaHQiIHx8IHZlcnRpY2FsRGlyZWN0aW9uID09PSAiZG93biIgKSA\/IDIgOiAxICkNCgkJCTogKCB2ZXJ0aWNhbERpcmVjdGlvbiAmJiAoIHZlcnRpY2FsRGlyZWN0aW9uID09PSAiZG93biIgPyAyIDogMSApICk7DQoNCgl9LA0KDQoJX2ludGVyc2VjdHNXaXRoU2lkZXM6IGZ1bmN0aW9uKCBpdGVtICkgew0KDQoJCXZhciBpc092ZXJCb3R0b21IYWxmID0gdGhpcy5faXNPdmVyQXhpcyggdGhpcy5wb3NpdGlvbkFicy50b3AgKw0KCQkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCwgaXRlbS50b3AgKyAoIGl0ZW0uaGVpZ2h0IC8gMiApLCBpdGVtLmhlaWdodCApLA0KCQkJaXNPdmVyUmlnaHRIYWxmID0gdGhpcy5faXNPdmVyQXhpcyggdGhpcy5wb3NpdGlvbkFicy5sZWZ0ICsNCgkJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0LCBpdGVtLmxlZnQgKyAoIGl0ZW0ud2lkdGggLyAyICksIGl0ZW0ud2lkdGggKSwNCgkJCXZlcnRpY2FsRGlyZWN0aW9uID0gdGhpcy5fZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uKCksDQoJCQlob3Jpem9udGFsRGlyZWN0aW9uID0gdGhpcy5fZ2V0RHJhZ0hvcml6b250YWxEaXJlY3Rpb24oKTsNCg0KCQlpZiAoIHRoaXMuZmxvYXRpbmcgJiYgaG9yaXpvbnRhbERpcmVjdGlvbiApIHsNCgkJCXJldHVybiAoICggaG9yaXpvbnRhbERpcmVjdGlvbiA9PT0gInJpZ2h0IiAmJiBpc092ZXJSaWdodEhhbGYgKSB8fA0KCQkJCSggaG9yaXpvbnRhbERpcmVjdGlvbiA9PT0gImxlZnQiICYmICFpc092ZXJSaWdodEhhbGYgKSApOw0KCQl9IGVsc2Ugew0KCQkJcmV0dXJuIHZlcnRpY2FsRGlyZWN0aW9uICYmICggKCB2ZXJ0aWNhbERpcmVjdGlvbiA9PT0gImRvd24iICYmIGlzT3ZlckJvdHRvbUhhbGYgKSB8fA0KCQkJCSggdmVydGljYWxEaXJlY3Rpb24gPT09ICJ1cCIgJiYgIWlzT3ZlckJvdHRvbUhhbGYgKSApOw0KCQl9DQoNCgl9LA0KDQoJX2dldERyYWdWZXJ0aWNhbERpcmVjdGlvbjogZnVuY3Rpb24oKSB7DQoJCXZhciBkZWx0YSA9IHRoaXMucG9zaXRpb25BYnMudG9wIC0gdGhpcy5sYXN0UG9zaXRpb25BYnMudG9wOw0KCQlyZXR1cm4gZGVsdGEgIT09IDAgJiYgKCBkZWx0YSA+IDAgPyAiZG93biIgOiAidXAiICk7DQoJfSwNCg0KCV9nZXREcmFnSG9yaXpvbnRhbERpcmVjdGlvbjogZnVuY3Rpb24oKSB7DQoJCXZhciBkZWx0YSA9IHRoaXMucG9zaXRpb25BYnMubGVmdCAtIHRoaXMubGFzdFBvc2l0aW9uQWJzLmxlZnQ7DQoJCXJldHVybiBkZWx0YSAhPT0gMCAmJiAoIGRlbHRhID4gMCA\/ICJyaWdodCIgOiAibGVmdCIgKTsNCgl9LA0KDQoJcmVmcmVzaDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl0aGlzLl9yZWZyZXNoSXRlbXMoIGV2ZW50ICk7DQoJCXRoaXMuX3NldEhhbmRsZUNsYXNzTmFtZSgpOw0KCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoKTsNCgkJcmV0dXJuIHRoaXM7DQoJfSwNCg0KCV9jb25uZWN0V2l0aDogZnVuY3Rpb24oKSB7DQoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOw0KCQlyZXR1cm4gb3B0aW9ucy5jb25uZWN0V2l0aC5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nID8NCgkJCVsgb3B0aW9ucy5jb25uZWN0V2l0aCBdIDoNCgkJCW9wdGlvbnMuY29ubmVjdFdpdGg7DQoJfSwNCg0KCV9nZXRJdGVtc0FzalF1ZXJ5OiBmdW5jdGlvbiggY29ubmVjdGVkICkgew0KDQoJCXZhciBpLCBqLCBjdXIsIGluc3QsDQoJCQlpdGVtcyA9IFtdLA0KCQkJcXVlcmllcyA9IFtdLA0KCQkJY29ubmVjdFdpdGggPSB0aGlzLl9jb25uZWN0V2l0aCgpOw0KDQoJCWlmICggY29ubmVjdFdpdGggJiYgY29ubmVjdGVkICkgew0KCQkJZm9yICggaSA9IGNvbm5lY3RXaXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgew0KCQkJCWN1ciA9ICQoIGNvbm5lY3RXaXRoWyBpIF0sIHRoaXMuZG9jdW1lbnRbIDAgXSApOw0KCQkJCWZvciAoIGogPSBjdXIubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0gKSB7DQoJCQkJCWluc3QgPSAkLmRhdGEoIGN1clsgaiBdLCB0aGlzLndpZGdldEZ1bGxOYW1lICk7DQoJCQkJCWlmICggaW5zdCAmJiBpbnN0ICE9PSB0aGlzICYmICFpbnN0Lm9wdGlvbnMuZGlzYWJsZWQgKSB7DQoJCQkJCQlxdWVyaWVzLnB1c2goIFsgJC5pc0Z1bmN0aW9uKCBpbnN0Lm9wdGlvbnMuaXRlbXMgKSA\/DQoJCQkJCQkJaW5zdC5vcHRpb25zLml0ZW1zLmNhbGwoIGluc3QuZWxlbWVudCApIDoNCgkJCQkJCQkkKCBpbnN0Lm9wdGlvbnMuaXRlbXMsIGluc3QuZWxlbWVudCApDQoJCQkJCQkJCS5ub3QoICIudWktc29ydGFibGUtaGVscGVyIiApDQoJCQkJCQkJCS5ub3QoICIudWktc29ydGFibGUtcGxhY2Vob2xkZXIiICksIGluc3QgXSApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgkJcXVlcmllcy5wdXNoKCBbICQuaXNGdW5jdGlvbiggdGhpcy5vcHRpb25zLml0ZW1zICkgPw0KCQkJdGhpcy5vcHRpb25zLml0ZW1zDQoJCQkJLmNhbGwoIHRoaXMuZWxlbWVudCwgbnVsbCwgeyBvcHRpb25zOiB0aGlzLm9wdGlvbnMsIGl0ZW06IHRoaXMuY3VycmVudEl0ZW0gfSApIDoNCgkJCSQoIHRoaXMub3B0aW9ucy5pdGVtcywgdGhpcy5lbGVtZW50ICkNCgkJCQkubm90KCAiLnVpLXNvcnRhYmxlLWhlbHBlciIgKQ0KCQkJCS5ub3QoICIudWktc29ydGFibGUtcGxhY2Vob2xkZXIiICksIHRoaXMgXSApOw0KDQoJCWZ1bmN0aW9uIGFkZEl0ZW1zKCkgew0KCQkJaXRlbXMucHVzaCggdGhpcyApOw0KCQl9DQoJCWZvciAoIGkgPSBxdWVyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgew0KCQkJcXVlcmllc1sgaSBdWyAwIF0uZWFjaCggYWRkSXRlbXMgKTsNCgkJfQ0KDQoJCXJldHVybiAkKCBpdGVtcyApOw0KDQoJfSwNCg0KCV9yZW1vdmVDdXJyZW50c0Zyb21JdGVtczogZnVuY3Rpb24oKSB7DQoNCgkJdmFyIGxpc3QgPSB0aGlzLmN1cnJlbnRJdGVtLmZpbmQoICI6ZGF0YSgiICsgdGhpcy53aWRnZXROYW1lICsgIi1pdGVtKSIgKTsNCg0KCQl0aGlzLml0ZW1zID0gJC5ncmVwKCB0aGlzLml0ZW1zLCBmdW5jdGlvbiggaXRlbSApIHsNCgkJCWZvciAoIHZhciBqID0gMDsgaiA8IGxpc3QubGVuZ3RoOyBqKysgKSB7DQoJCQkJaWYgKCBsaXN0WyBqIF0gPT09IGl0ZW0uaXRlbVsgMCBdICkgew0KCQkJCQlyZXR1cm4gZmFsc2U7DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIHRydWU7DQoJCX0gKTsNCg0KCX0sDQoNCglfcmVmcmVzaEl0ZW1zOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJdGhpcy5pdGVtcyA9IFtdOw0KCQl0aGlzLmNvbnRhaW5lcnMgPSBbIHRoaXMgXTsNCg0KCQl2YXIgaSwgaiwgY3VyLCBpbnN0LCB0YXJnZXREYXRhLCBfcXVlcmllcywgaXRlbSwgcXVlcmllc0xlbmd0aCwNCgkJCWl0ZW1zID0gdGhpcy5pdGVtcywNCgkJCXF1ZXJpZXMgPSBbIFsgJC5pc0Z1bmN0aW9uKCB0aGlzLm9wdGlvbnMuaXRlbXMgKSA\/DQoJCQkJdGhpcy5vcHRpb25zLml0ZW1zLmNhbGwoIHRoaXMuZWxlbWVudFsgMCBdLCBldmVudCwgeyBpdGVtOiB0aGlzLmN1cnJlbnRJdGVtIH0gKSA6DQoJCQkJJCggdGhpcy5vcHRpb25zLml0ZW1zLCB0aGlzLmVsZW1lbnQgKSwgdGhpcyBdIF0sDQoJCQljb25uZWN0V2l0aCA9IHRoaXMuX2Nvbm5lY3RXaXRoKCk7DQoNCgkJLy9TaG91bGRuJ3QgYmUgcnVuIHRoZSBmaXJzdCB0aW1lIHRocm91Z2ggZHVlIHRvIG1hc3NpdmUgc2xvdy1kb3duDQoJCWlmICggY29ubmVjdFdpdGggJiYgdGhpcy5yZWFkeSApIHsNCgkJCWZvciAoIGkgPSBjb25uZWN0V2l0aC5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsNCgkJCQljdXIgPSAkKCBjb25uZWN0V2l0aFsgaSBdLCB0aGlzLmRvY3VtZW50WyAwIF0gKTsNCgkJCQlmb3IgKCBqID0gY3VyLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tICkgew0KCQkJCQlpbnN0ID0gJC5kYXRhKCBjdXJbIGogXSwgdGhpcy53aWRnZXRGdWxsTmFtZSApOw0KCQkJCQlpZiAoIGluc3QgJiYgaW5zdCAhPT0gdGhpcyAmJiAhaW5zdC5vcHRpb25zLmRpc2FibGVkICkgew0KCQkJCQkJcXVlcmllcy5wdXNoKCBbICQuaXNGdW5jdGlvbiggaW5zdC5vcHRpb25zLml0ZW1zICkgPw0KCQkJCQkJCWluc3Qub3B0aW9ucy5pdGVtcw0KCQkJCQkJCQkuY2FsbCggaW5zdC5lbGVtZW50WyAwIF0sIGV2ZW50LCB7IGl0ZW06IHRoaXMuY3VycmVudEl0ZW0gfSApIDoNCgkJCQkJCQkkKCBpbnN0Lm9wdGlvbnMuaXRlbXMsIGluc3QuZWxlbWVudCApLCBpbnN0IF0gKTsNCgkJCQkJCXRoaXMuY29udGFpbmVycy5wdXNoKCBpbnN0ICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlmb3IgKCBpID0gcXVlcmllcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsNCgkJCXRhcmdldERhdGEgPSBxdWVyaWVzWyBpIF1bIDEgXTsNCgkJCV9xdWVyaWVzID0gcXVlcmllc1sgaSBdWyAwIF07DQoNCgkJCWZvciAoIGogPSAwLCBxdWVyaWVzTGVuZ3RoID0gX3F1ZXJpZXMubGVuZ3RoOyBqIDwgcXVlcmllc0xlbmd0aDsgaisrICkgew0KCQkJCWl0ZW0gPSAkKCBfcXVlcmllc1sgaiBdICk7DQoNCgkJCQkvLyBEYXRhIGZvciB0YXJnZXQgY2hlY2tpbmcgKG1vdXNlIG1hbmFnZXIpDQoJCQkJaXRlbS5kYXRhKCB0aGlzLndpZGdldE5hbWUgKyAiLWl0ZW0iLCB0YXJnZXREYXRhICk7DQoNCgkJCQlpdGVtcy5wdXNoKCB7DQoJCQkJCWl0ZW06IGl0ZW0sDQoJCQkJCWluc3RhbmNlOiB0YXJnZXREYXRhLA0KCQkJCQl3aWR0aDogMCwgaGVpZ2h0OiAwLA0KCQkJCQlsZWZ0OiAwLCB0b3A6IDANCgkJCQl9ICk7DQoJCQl9DQoJCX0NCg0KCX0sDQoNCglyZWZyZXNoUG9zaXRpb25zOiBmdW5jdGlvbiggZmFzdCApIHsNCg0KCQkvLyBEZXRlcm1pbmUgd2hldGhlciBpdGVtcyBhcmUgYmVpbmcgZGlzcGxheWVkIGhvcml6b250YWxseQ0KCQl0aGlzLmZsb2F0aW5nID0gdGhpcy5pdGVtcy5sZW5ndGggPw0KCQkJdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ4IiB8fCB0aGlzLl9pc0Zsb2F0aW5nKCB0aGlzLml0ZW1zWyAwIF0uaXRlbSApIDoNCgkJCWZhbHNlOw0KDQoJCS8vVGhpcyBoYXMgdG8gYmUgcmVkb25lIGJlY2F1c2UgZHVlIHRvIHRoZSBpdGVtIGJlaW5nIG1vdmVkIG91dC9pbnRvIHRoZSBvZmZzZXRQYXJlbnQsDQoJCS8vIHRoZSBvZmZzZXRQYXJlbnQncyBwb3NpdGlvbiB3aWxsIGNoYW5nZQ0KCQlpZiAoIHRoaXMub2Zmc2V0UGFyZW50ICYmIHRoaXMuaGVscGVyICkgew0KCQkJdGhpcy5vZmZzZXQucGFyZW50ID0gdGhpcy5fZ2V0UGFyZW50T2Zmc2V0KCk7DQoJCX0NCg0KCQl2YXIgaSwgaXRlbSwgdCwgcDsNCg0KCQlmb3IgKCBpID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsNCgkJCWl0ZW0gPSB0aGlzLml0ZW1zWyBpIF07DQoNCgkJCS8vV2UgaWdub3JlIGNhbGN1bGF0aW5nIHBvc2l0aW9ucyBvZiBhbGwgY29ubmVjdGVkIGNvbnRhaW5lcnMgd2hlbiB3ZSdyZSBub3Qgb3ZlciB0aGVtDQoJCQlpZiAoIGl0ZW0uaW5zdGFuY2UgIT09IHRoaXMuY3VycmVudENvbnRhaW5lciAmJiB0aGlzLmN1cnJlbnRDb250YWluZXIgJiYNCgkJCQkJaXRlbS5pdGVtWyAwIF0gIT09IHRoaXMuY3VycmVudEl0ZW1bIDAgXSApIHsNCgkJCQljb250aW51ZTsNCgkJCX0NCg0KCQkJdCA9IHRoaXMub3B0aW9ucy50b2xlcmFuY2VFbGVtZW50ID8NCgkJCQkkKCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlRWxlbWVudCwgaXRlbS5pdGVtICkgOg0KCQkJCWl0ZW0uaXRlbTsNCg0KCQkJaWYgKCAhZmFzdCApIHsNCgkJCQlpdGVtLndpZHRoID0gdC5vdXRlcldpZHRoKCk7DQoJCQkJaXRlbS5oZWlnaHQgPSB0Lm91dGVySGVpZ2h0KCk7DQoJCQl9DQoNCgkJCXAgPSB0Lm9mZnNldCgpOw0KCQkJaXRlbS5sZWZ0ID0gcC5sZWZ0Ow0KCQkJaXRlbS50b3AgPSBwLnRvcDsNCgkJfQ0KDQoJCWlmICggdGhpcy5vcHRpb25zLmN1c3RvbSAmJiB0aGlzLm9wdGlvbnMuY3VzdG9tLnJlZnJlc2hDb250YWluZXJzICkgew0KCQkJdGhpcy5vcHRpb25zLmN1c3RvbS5yZWZyZXNoQ29udGFpbmVycy5jYWxsKCB0aGlzICk7DQoJCX0gZWxzZSB7DQoJCQlmb3IgKCBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgew0KCQkJCXAgPSB0aGlzLmNvbnRhaW5lcnNbIGkgXS5lbGVtZW50Lm9mZnNldCgpOw0KCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLmxlZnQgPSBwLmxlZnQ7DQoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUudG9wID0gcC50b3A7DQoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUud2lkdGggPQ0KCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5lbGVtZW50Lm91dGVyV2lkdGgoKTsNCgkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5jb250YWluZXJDYWNoZS5oZWlnaHQgPQ0KCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5lbGVtZW50Lm91dGVySGVpZ2h0KCk7DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4gdGhpczsNCgl9LA0KDQoJX2NyZWF0ZVBsYWNlaG9sZGVyOiBmdW5jdGlvbiggdGhhdCApIHsNCgkJdGhhdCA9IHRoYXQgfHwgdGhpczsNCgkJdmFyIGNsYXNzTmFtZSwNCgkJCW8gPSB0aGF0Lm9wdGlvbnM7DQoNCgkJaWYgKCAhby5wbGFjZWhvbGRlciB8fCBvLnBsYWNlaG9sZGVyLmNvbnN0cnVjdG9yID09PSBTdHJpbmcgKSB7DQoJCQljbGFzc05hbWUgPSBvLnBsYWNlaG9sZGVyOw0KCQkJby5wbGFjZWhvbGRlciA9IHsNCgkJCQllbGVtZW50OiBmdW5jdGlvbigpIHsNCg0KCQkJCQl2YXIgbm9kZU5hbWUgPSB0aGF0LmN1cnJlbnRJdGVtWyAwIF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwNCgkJCQkJCWVsZW1lbnQgPSAkKCAiPCIgKyBub2RlTmFtZSArICI+IiwgdGhhdC5kb2N1bWVudFsgMCBdICk7DQoNCgkJCQkJCXRoYXQuX2FkZENsYXNzKCBlbGVtZW50LCAidWktc29ydGFibGUtcGxhY2Vob2xkZXIiLA0KCQkJCQkJCQljbGFzc05hbWUgfHwgdGhhdC5jdXJyZW50SXRlbVsgMCBdLmNsYXNzTmFtZSApDQoJCQkJCQkJLl9yZW1vdmVDbGFzcyggZWxlbWVudCwgInVpLXNvcnRhYmxlLWhlbHBlciIgKTsNCg0KCQkJCQlpZiAoIG5vZGVOYW1lID09PSAidGJvZHkiICkgew0KCQkJCQkJdGhhdC5fY3JlYXRlVHJQbGFjZWhvbGRlcigNCgkJCQkJCQl0aGF0LmN1cnJlbnRJdGVtLmZpbmQoICJ0ciIgKS5lcSggMCApLA0KCQkJCQkJCSQoICI8dHI+IiwgdGhhdC5kb2N1bWVudFsgMCBdICkuYXBwZW5kVG8oIGVsZW1lbnQgKQ0KCQkJCQkJKTsNCgkJCQkJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJ0ciIgKSB7DQoJCQkJCQl0aGF0Ll9jcmVhdGVUclBsYWNlaG9sZGVyKCB0aGF0LmN1cnJlbnRJdGVtLCBlbGVtZW50ICk7DQoJCQkJCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW1nIiApIHsNCgkJCQkJCWVsZW1lbnQuYXR0ciggInNyYyIsIHRoYXQuY3VycmVudEl0ZW0uYXR0ciggInNyYyIgKSApOw0KCQkJCQl9DQoNCgkJCQkJaWYgKCAhY2xhc3NOYW1lICkgew0KCQkJCQkJZWxlbWVudC5jc3MoICJ2aXNpYmlsaXR5IiwgImhpZGRlbiIgKTsNCgkJCQkJfQ0KDQoJCQkJCXJldHVybiBlbGVtZW50Ow0KCQkJCX0sDQoJCQkJdXBkYXRlOiBmdW5jdGlvbiggY29udGFpbmVyLCBwICkgew0KDQoJCQkJCS8vIDEuIElmIGEgY2xhc3NOYW1lIGlzIHNldCBhcyAncGxhY2Vob2xkZXIgb3B0aW9uLCB3ZSBkb24ndCBmb3JjZSBzaXplcyAtDQoJCQkJCS8vIHRoZSBjbGFzcyBpcyByZXNwb25zaWJsZSBmb3IgdGhhdA0KCQkJCQkvLyAyLiBUaGUgb3B0aW9uICdmb3JjZVBsYWNlaG9sZGVyU2l6ZSBjYW4gYmUgZW5hYmxlZCB0byBmb3JjZSBpdCBldmVuIGlmIGENCgkJCQkJLy8gY2xhc3MgbmFtZSBpcyBzcGVjaWZpZWQNCgkJCQkJaWYgKCBjbGFzc05hbWUgJiYgIW8uZm9yY2VQbGFjZWhvbGRlclNpemUgKSB7DQoJCQkJCQlyZXR1cm47DQoJCQkJCX0NCg0KCQkJCQkvL0lmIHRoZSBlbGVtZW50IGRvZXNuJ3QgaGF2ZSBhIGFjdHVhbCBoZWlnaHQgYnkgaXRzZWxmICh3aXRob3V0IHN0eWxlcyBjb21pbmcNCgkJCQkJLy8gZnJvbSBhIHN0eWxlc2hlZXQpLCBpdCByZWNlaXZlcyB0aGUgaW5saW5lIGhlaWdodCBmcm9tIHRoZSBkcmFnZ2VkIGl0ZW0NCgkJCQkJaWYgKCAhcC5oZWlnaHQoKSApIHsNCgkJCQkJCXAuaGVpZ2h0KA0KCQkJCQkJCXRoYXQuY3VycmVudEl0ZW0uaW5uZXJIZWlnaHQoKSAtDQoJCQkJCQkJcGFyc2VJbnQoIHRoYXQuY3VycmVudEl0ZW0uY3NzKCAicGFkZGluZ1RvcCIgKSB8fCAwLCAxMCApIC0NCgkJCQkJCQlwYXJzZUludCggdGhhdC5jdXJyZW50SXRlbS5jc3MoICJwYWRkaW5nQm90dG9tIiApIHx8IDAsIDEwICkgKTsNCgkJCQkJfQ0KCQkJCQlpZiAoICFwLndpZHRoKCkgKSB7DQoJCQkJCQlwLndpZHRoKA0KCQkJCQkJCXRoYXQuY3VycmVudEl0ZW0uaW5uZXJXaWR0aCgpIC0NCgkJCQkJCQlwYXJzZUludCggdGhhdC5jdXJyZW50SXRlbS5jc3MoICJwYWRkaW5nTGVmdCIgKSB8fCAwLCAxMCApIC0NCgkJCQkJCQlwYXJzZUludCggdGhhdC5jdXJyZW50SXRlbS5jc3MoICJwYWRkaW5nUmlnaHQiICkgfHwgMCwgMTAgKSApOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfTsNCgkJfQ0KDQoJCS8vQ3JlYXRlIHRoZSBwbGFjZWhvbGRlcg0KCQl0aGF0LnBsYWNlaG9sZGVyID0gJCggby5wbGFjZWhvbGRlci5lbGVtZW50LmNhbGwoIHRoYXQuZWxlbWVudCwgdGhhdC5jdXJyZW50SXRlbSApICk7DQoNCgkJLy9BcHBlbmQgaXQgYWZ0ZXIgdGhlIGFjdHVhbCBjdXJyZW50IGl0ZW0NCgkJdGhhdC5jdXJyZW50SXRlbS5hZnRlciggdGhhdC5wbGFjZWhvbGRlciApOw0KDQoJCS8vVXBkYXRlIHRoZSBzaXplIG9mIHRoZSBwbGFjZWhvbGRlciAoVE9ETzogTG9naWMgdG8gZnV6enksIHNlZSBsaW5lIDMxNi8zMTcpDQoJCW8ucGxhY2Vob2xkZXIudXBkYXRlKCB0aGF0LCB0aGF0LnBsYWNlaG9sZGVyICk7DQoNCgl9LA0KDQoJX2NyZWF0ZVRyUGxhY2Vob2xkZXI6IGZ1bmN0aW9uKCBzb3VyY2VUciwgdGFyZ2V0VHIgKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCg0KCQlzb3VyY2VUci5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJJCggIjx0ZD4mIzE2MDs8L3RkPiIsIHRoYXQuZG9jdW1lbnRbIDAgXSApDQoJCQkJLmF0dHIoICJjb2xzcGFuIiwgJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApIHx8IDEgKQ0KCQkJCS5hcHBlbmRUbyggdGFyZ2V0VHIgKTsNCgkJfSApOw0KCX0sDQoNCglfY29udGFjdENvbnRhaW5lcnM6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIGksIGosIGRpc3QsIGl0ZW1XaXRoTGVhc3REaXN0YW5jZSwgcG9zUHJvcGVydHksIHNpemVQcm9wZXJ0eSwgY3VyLCBuZWFyQm90dG9tLA0KCQkJZmxvYXRpbmcsIGF4aXMsDQoJCQlpbm5lcm1vc3RDb250YWluZXIgPSBudWxsLA0KCQkJaW5uZXJtb3N0SW5kZXggPSBudWxsOw0KDQoJCS8vIEdldCBpbm5lcm1vc3QgY29udGFpbmVyIHRoYXQgaW50ZXJzZWN0cyB3aXRoIGl0ZW0NCgkJZm9yICggaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsNCg0KCQkJLy8gTmV2ZXIgY29uc2lkZXIgYSBjb250YWluZXIgdGhhdCdzIGxvY2F0ZWQgd2l0aGluIHRoZSBpdGVtIGl0c2VsZg0KCQkJaWYgKCAkLmNvbnRhaW5zKCB0aGlzLmN1cnJlbnRJdGVtWyAwIF0sIHRoaXMuY29udGFpbmVyc1sgaSBdLmVsZW1lbnRbIDAgXSApICkgew0KCQkJCWNvbnRpbnVlOw0KCQkJfQ0KDQoJCQlpZiAoIHRoaXMuX2ludGVyc2VjdHNXaXRoKCB0aGlzLmNvbnRhaW5lcnNbIGkgXS5jb250YWluZXJDYWNoZSApICkgew0KDQoJCQkJLy8gSWYgd2UndmUgYWxyZWFkeSBmb3VuZCBhIGNvbnRhaW5lciBhbmQgaXQncyBtb3JlICJpbm5lciIgdGhhbiB0aGlzLCB0aGVuIGNvbnRpbnVlDQoJCQkJaWYgKCBpbm5lcm1vc3RDb250YWluZXIgJiYNCgkJCQkJCSQuY29udGFpbnMoDQoJCQkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uZWxlbWVudFsgMCBdLA0KCQkJCQkJCWlubmVybW9zdENvbnRhaW5lci5lbGVtZW50WyAwIF0gKSApIHsNCgkJCQkJY29udGludWU7DQoJCQkJfQ0KDQoJCQkJaW5uZXJtb3N0Q29udGFpbmVyID0gdGhpcy5jb250YWluZXJzWyBpIF07DQoJCQkJaW5uZXJtb3N0SW5kZXggPSBpOw0KDQoJCQl9IGVsc2Ugew0KDQoJCQkJLy8gY29udGFpbmVyIGRvZXNuJ3QgaW50ZXJzZWN0LiB0cmlnZ2VyICJvdXQiIGV2ZW50IGlmIG5lY2Vzc2FyeQ0KCQkJCWlmICggdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciApIHsNCgkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uX3RyaWdnZXIoICJvdXQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsNCgkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDA7DQoJCQkJfQ0KCQkJfQ0KDQoJCX0NCg0KCQkvLyBJZiBubyBpbnRlcnNlY3RpbmcgY29udGFpbmVycyBmb3VuZCwgcmV0dXJuDQoJCWlmICggIWlubmVybW9zdENvbnRhaW5lciApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCS8vIE1vdmUgdGhlIGl0ZW0gaW50byB0aGUgY29udGFpbmVyIGlmIGl0J3Mgbm90IHRoZXJlIGFscmVhZHkNCgkJaWYgKCB0aGlzLmNvbnRhaW5lcnMubGVuZ3RoID09PSAxICkgew0KCQkJaWYgKCAhdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7DQoJCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLl90cmlnZ2VyKCAib3ZlciIsIGV2ZW50LCB0aGlzLl91aUhhc2goIHRoaXMgKSApOw0KCQkJCXRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXS5jb250YWluZXJDYWNoZS5vdmVyID0gMTsNCgkJCX0NCgkJfSBlbHNlIHsNCg0KCQkJLy8gV2hlbiBlbnRlcmluZyBhIG5ldyBjb250YWluZXIsIHdlIHdpbGwgZmluZCB0aGUgaXRlbSB3aXRoIHRoZSBsZWFzdCBkaXN0YW5jZSBhbmQNCgkJCS8vIGFwcGVuZCBvdXIgaXRlbSBuZWFyIGl0DQoJCQlkaXN0ID0gMTAwMDA7DQoJCQlpdGVtV2l0aExlYXN0RGlzdGFuY2UgPSBudWxsOw0KCQkJZmxvYXRpbmcgPSBpbm5lcm1vc3RDb250YWluZXIuZmxvYXRpbmcgfHwgdGhpcy5faXNGbG9hdGluZyggdGhpcy5jdXJyZW50SXRlbSApOw0KCQkJcG9zUHJvcGVydHkgPSBmbG9hdGluZyA\/ICJsZWZ0IiA6ICJ0b3AiOw0KCQkJc2l6ZVByb3BlcnR5ID0gZmxvYXRpbmcgPyAid2lkdGgiIDogImhlaWdodCI7DQoJCQlheGlzID0gZmxvYXRpbmcgPyAicGFnZVgiIDogInBhZ2VZIjsNCg0KCQkJZm9yICggaiA9IHRoaXMuaXRlbXMubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0gKSB7DQoJCQkJaWYgKCAhJC5jb250YWlucygNCgkJCQkJCXRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXS5lbGVtZW50WyAwIF0sIHRoaXMuaXRlbXNbIGogXS5pdGVtWyAwIF0gKQ0KCQkJCSkgew0KCQkJCQljb250aW51ZTsNCgkJCQl9DQoJCQkJaWYgKCB0aGlzLml0ZW1zWyBqIF0uaXRlbVsgMCBdID09PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7DQoJCQkJCWNvbnRpbnVlOw0KCQkJCX0NCg0KCQkJCWN1ciA9IHRoaXMuaXRlbXNbIGogXS5pdGVtLm9mZnNldCgpWyBwb3NQcm9wZXJ0eSBdOw0KCQkJCW5lYXJCb3R0b20gPSBmYWxzZTsNCgkJCQlpZiAoIGV2ZW50WyBheGlzIF0gLSBjdXIgPiB0aGlzLml0ZW1zWyBqIF1bIHNpemVQcm9wZXJ0eSBdIC8gMiApIHsNCgkJCQkJbmVhckJvdHRvbSA9IHRydWU7DQoJCQkJfQ0KDQoJCQkJaWYgKCBNYXRoLmFicyggZXZlbnRbIGF4aXMgXSAtIGN1ciApIDwgZGlzdCApIHsNCgkJCQkJZGlzdCA9IE1hdGguYWJzKCBldmVudFsgYXhpcyBdIC0gY3VyICk7DQoJCQkJCWl0ZW1XaXRoTGVhc3REaXN0YW5jZSA9IHRoaXMuaXRlbXNbIGogXTsNCgkJCQkJdGhpcy5kaXJlY3Rpb24gPSBuZWFyQm90dG9tID8gInVwIiA6ICJkb3duIjsNCgkJCQl9DQoJCQl9DQoNCgkJCS8vQ2hlY2sgaWYgZHJvcE9uRW1wdHkgaXMgZW5hYmxlZA0KCQkJaWYgKCAhaXRlbVdpdGhMZWFzdERpc3RhbmNlICYmICF0aGlzLm9wdGlvbnMuZHJvcE9uRW1wdHkgKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQlpZiAoIHRoaXMuY3VycmVudENvbnRhaW5lciA9PT0gdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdICkgew0KCQkJCWlmICggIXRoaXMuY3VycmVudENvbnRhaW5lci5jb250YWluZXJDYWNoZS5vdmVyICkgew0KCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uX3RyaWdnZXIoICJvdmVyIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpICk7DQoJCQkJCXRoaXMuY3VycmVudENvbnRhaW5lci5jb250YWluZXJDYWNoZS5vdmVyID0gMTsNCgkJCQl9DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQlpdGVtV2l0aExlYXN0RGlzdGFuY2UgPw0KCQkJCXRoaXMuX3JlYXJyYW5nZSggZXZlbnQsIGl0ZW1XaXRoTGVhc3REaXN0YW5jZSwgbnVsbCwgdHJ1ZSApIDoNCgkJCQl0aGlzLl9yZWFycmFuZ2UoIGV2ZW50LCBudWxsLCB0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF0uZWxlbWVudCwgdHJ1ZSApOw0KCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOw0KCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLl90cmlnZ2VyKCAiY2hhbmdlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7DQoJCQl0aGlzLmN1cnJlbnRDb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcnNbIGlubmVybW9zdEluZGV4IF07DQoNCgkJCS8vVXBkYXRlIHRoZSBwbGFjZWhvbGRlcg0KCQkJdGhpcy5vcHRpb25zLnBsYWNlaG9sZGVyLnVwZGF0ZSggdGhpcy5jdXJyZW50Q29udGFpbmVyLCB0aGlzLnBsYWNlaG9sZGVyICk7DQoNCgkJCXRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXS5fdHJpZ2dlciggIm92ZXIiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsNCgkJCXRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXS5jb250YWluZXJDYWNoZS5vdmVyID0gMTsNCgkJfQ0KDQoJfSwNCg0KCV9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKCBldmVudCApIHsNCg0KCQl2YXIgbyA9IHRoaXMub3B0aW9ucywNCgkJCWhlbHBlciA9ICQuaXNGdW5jdGlvbiggby5oZWxwZXIgKSA\/DQoJCQkJJCggby5oZWxwZXIuYXBwbHkoIHRoaXMuZWxlbWVudFsgMCBdLCBbIGV2ZW50LCB0aGlzLmN1cnJlbnRJdGVtIF0gKSApIDoNCgkJCQkoIG8uaGVscGVyID09PSAiY2xvbmUiID8gdGhpcy5jdXJyZW50SXRlbS5jbG9uZSgpIDogdGhpcy5jdXJyZW50SXRlbSApOw0KDQoJCS8vQWRkIHRoZSBoZWxwZXIgdG8gdGhlIERPTSBpZiB0aGF0IGRpZG4ndCBoYXBwZW4gYWxyZWFkeQ0KCQlpZiAoICFoZWxwZXIucGFyZW50cyggImJvZHkiICkubGVuZ3RoICkgew0KCQkJJCggby5hcHBlbmRUbyAhPT0gInBhcmVudCIgPw0KCQkJCW8uYXBwZW5kVG8gOg0KCQkJCXRoaXMuY3VycmVudEl0ZW1bIDAgXS5wYXJlbnROb2RlIClbIDAgXS5hcHBlbmRDaGlsZCggaGVscGVyWyAwIF0gKTsNCgkJfQ0KDQoJCWlmICggaGVscGVyWyAwIF0gPT09IHRoaXMuY3VycmVudEl0ZW1bIDAgXSApIHsNCgkJCXRoaXMuX3N0b3JlZENTUyA9IHsNCgkJCQl3aWR0aDogdGhpcy5jdXJyZW50SXRlbVsgMCBdLnN0eWxlLndpZHRoLA0KCQkJCWhlaWdodDogdGhpcy5jdXJyZW50SXRlbVsgMCBdLnN0eWxlLmhlaWdodCwNCgkJCQlwb3NpdGlvbjogdGhpcy5jdXJyZW50SXRlbS5jc3MoICJwb3NpdGlvbiIgKSwNCgkJCQl0b3A6IHRoaXMuY3VycmVudEl0ZW0uY3NzKCAidG9wIiApLA0KCQkJCWxlZnQ6IHRoaXMuY3VycmVudEl0ZW0uY3NzKCAibGVmdCIgKQ0KCQkJfTsNCgkJfQ0KDQoJCWlmICggIWhlbHBlclsgMCBdLnN0eWxlLndpZHRoIHx8IG8uZm9yY2VIZWxwZXJTaXplICkgew0KCQkJaGVscGVyLndpZHRoKCB0aGlzLmN1cnJlbnRJdGVtLndpZHRoKCkgKTsNCgkJfQ0KCQlpZiAoICFoZWxwZXJbIDAgXS5zdHlsZS5oZWlnaHQgfHwgby5mb3JjZUhlbHBlclNpemUgKSB7DQoJCQloZWxwZXIuaGVpZ2h0KCB0aGlzLmN1cnJlbnRJdGVtLmhlaWdodCgpICk7DQoJCX0NCg0KCQlyZXR1cm4gaGVscGVyOw0KDQoJfSwNCg0KCV9hZGp1c3RPZmZzZXRGcm9tSGVscGVyOiBmdW5jdGlvbiggb2JqICkgew0KCQlpZiAoIHR5cGVvZiBvYmogPT09ICJzdHJpbmciICkgew0KCQkJb2JqID0gb2JqLnNwbGl0KCAiICIgKTsNCgkJfQ0KCQlpZiAoICQuaXNBcnJheSggb2JqICkgKSB7DQoJCQlvYmogPSB7IGxlZnQ6ICtvYmpbIDAgXSwgdG9wOiArb2JqWyAxIF0gfHwgMCB9Ow0KCQl9DQoJCWlmICggImxlZnQiIGluIG9iaiApIHsNCgkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPSBvYmoubGVmdCArIHRoaXMubWFyZ2lucy5sZWZ0Ow0KCQl9DQoJCWlmICggInJpZ2h0IiBpbiBvYmogKSB7DQoJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0ID0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIG9iai5yaWdodCArIHRoaXMubWFyZ2lucy5sZWZ0Ow0KCQl9DQoJCWlmICggInRvcCIgaW4gb2JqICkgew0KCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wID0gb2JqLnRvcCArIHRoaXMubWFyZ2lucy50b3A7DQoJCX0NCgkJaWYgKCAiYm90dG9tIiBpbiBvYmogKSB7DQoJCQl0aGlzLm9mZnNldC5jbGljay50b3AgPSB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIG9iai5ib3R0b20gKyB0aGlzLm1hcmdpbnMudG9wOw0KCQl9DQoJfSwNCg0KCV9nZXRQYXJlbnRPZmZzZXQ6IGZ1bmN0aW9uKCkgew0KDQoJCS8vR2V0IHRoZSBvZmZzZXRQYXJlbnQgYW5kIGNhY2hlIGl0cyBwb3NpdGlvbg0KCQl0aGlzLm9mZnNldFBhcmVudCA9IHRoaXMuaGVscGVyLm9mZnNldFBhcmVudCgpOw0KCQl2YXIgcG8gPSB0aGlzLm9mZnNldFBhcmVudC5vZmZzZXQoKTsNCg0KCQkvLyBUaGlzIGlzIGEgc3BlY2lhbCBjYXNlIHdoZXJlIHdlIG5lZWQgdG8gbW9kaWZ5IGEgb2Zmc2V0IGNhbGN1bGF0ZWQgb24gc3RhcnQsIHNpbmNlIHRoZQ0KCQkvLyBmb2xsb3dpbmcgaGFwcGVuZWQ6DQoJCS8vIDEuIFRoZSBwb3NpdGlvbiBvZiB0aGUgaGVscGVyIGlzIGFic29sdXRlLCBzbyBpdCdzIHBvc2l0aW9uIGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gdGhlDQoJCS8vIG5leHQgcG9zaXRpb25lZCBwYXJlbnQNCgkJLy8gMi4gVGhlIGFjdHVhbCBvZmZzZXQgcGFyZW50IGlzIGEgY2hpbGQgb2YgdGhlIHNjcm9sbCBwYXJlbnQsIGFuZCB0aGUgc2Nyb2xsIHBhcmVudCBpc24ndA0KCQkvLyB0aGUgZG9jdW1lbnQsIHdoaWNoIG1lYW5zIHRoYXQgdGhlIHNjcm9sbCBpcyBpbmNsdWRlZCBpbiB0aGUgaW5pdGlhbCBjYWxjdWxhdGlvbiBvZiB0aGUNCgkJLy8gb2Zmc2V0IG9mIHRoZSBwYXJlbnQsIGFuZCBuZXZlciByZWNhbGN1bGF0ZWQgdXBvbiBkcmFnDQoJCWlmICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImFic29sdXRlIiAmJiB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICE9PSB0aGlzLmRvY3VtZW50WyAwIF0gJiYNCgkJCQkkLmNvbnRhaW5zKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdLCB0aGlzLm9mZnNldFBhcmVudFsgMCBdICkgKSB7DQoJCQlwby5sZWZ0ICs9IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKTsNCgkJCXBvLnRvcCArPSB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKTsNCgkJfQ0KDQoJCS8vIFRoaXMgbmVlZHMgdG8gYmUgYWN0dWFsbHkgZG9uZSBmb3IgYWxsIGJyb3dzZXJzLCBzaW5jZSBwYWdlWC9wYWdlWSBpbmNsdWRlcyB0aGlzDQoJCS8vIGluZm9ybWF0aW9uIHdpdGggYW4gdWdseSBJRSBmaXgNCgkJaWYgKCB0aGlzLm9mZnNldFBhcmVudFsgMCBdID09PSB0aGlzLmRvY3VtZW50WyAwIF0uYm9keSB8fA0KCQkJCSggdGhpcy5vZmZzZXRQYXJlbnRbIDAgXS50YWdOYW1lICYmDQoJCQkJdGhpcy5vZmZzZXRQYXJlbnRbIDAgXS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJodG1sIiAmJiAkLnVpLmllICkgKSB7DQoJCQlwbyA9IHsgdG9wOiAwLCBsZWZ0OiAwIH07DQoJCX0NCg0KCQlyZXR1cm4gew0KCQkJdG9wOiBwby50b3AgKyAoIHBhcnNlSW50KCB0aGlzLm9mZnNldFBhcmVudC5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICksDQoJCQlsZWZ0OiBwby5sZWZ0ICsgKCBwYXJzZUludCggdGhpcy5vZmZzZXRQYXJlbnQuY3NzKCAiYm9yZGVyTGVmdFdpZHRoIiApLCAxMCApIHx8IDAgKQ0KCQl9Ow0KDQoJfSwNCg0KCV9nZXRSZWxhdGl2ZU9mZnNldDogZnVuY3Rpb24oKSB7DQoNCgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAicmVsYXRpdmUiICkgew0KCQkJdmFyIHAgPSB0aGlzLmN1cnJlbnRJdGVtLnBvc2l0aW9uKCk7DQoJCQlyZXR1cm4gew0KCQkJCXRvcDogcC50b3AgLSAoIHBhcnNlSW50KCB0aGlzLmhlbHBlci5jc3MoICJ0b3AiICksIDEwICkgfHwgMCApICsNCgkJCQkJdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCksDQoJCQkJbGVmdDogcC5sZWZ0IC0gKCBwYXJzZUludCggdGhpcy5oZWxwZXIuY3NzKCAibGVmdCIgKSwgMTAgKSB8fCAwICkgKw0KCQkJCQl0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkNCgkJCX07DQoJCX0gZWxzZSB7DQoJCQlyZXR1cm4geyB0b3A6IDAsIGxlZnQ6IDAgfTsNCgkJfQ0KDQoJfSwNCg0KCV9jYWNoZU1hcmdpbnM6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLm1hcmdpbnMgPSB7DQoJCQlsZWZ0OiAoIHBhcnNlSW50KCB0aGlzLmN1cnJlbnRJdGVtLmNzcyggIm1hcmdpbkxlZnQiICksIDEwICkgfHwgMCApLA0KCQkJdG9wOiAoIHBhcnNlSW50KCB0aGlzLmN1cnJlbnRJdGVtLmNzcyggIm1hcmdpblRvcCIgKSwgMTAgKSB8fCAwICkNCgkJfTsNCgl9LA0KDQoJX2NhY2hlSGVscGVyUHJvcG9ydGlvbnM6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLmhlbHBlclByb3BvcnRpb25zID0gew0KCQkJd2lkdGg6IHRoaXMuaGVscGVyLm91dGVyV2lkdGgoKSwNCgkJCWhlaWdodDogdGhpcy5oZWxwZXIub3V0ZXJIZWlnaHQoKQ0KCQl9Ow0KCX0sDQoNCglfc2V0Q29udGFpbm1lbnQ6IGZ1bmN0aW9uKCkgew0KDQoJCXZhciBjZSwgY28sIG92ZXIsDQoJCQlvID0gdGhpcy5vcHRpb25zOw0KCQlpZiAoIG8uY29udGFpbm1lbnQgPT09ICJwYXJlbnQiICkgew0KCQkJby5jb250YWlubWVudCA9IHRoaXMuaGVscGVyWyAwIF0ucGFyZW50Tm9kZTsNCgkJfQ0KCQlpZiAoIG8uY29udGFpbm1lbnQgPT09ICJkb2N1bWVudCIgfHwgby5jb250YWlubWVudCA9PT0gIndpbmRvdyIgKSB7DQoJCQl0aGlzLmNvbnRhaW5tZW50ID0gWw0KCQkJCTAgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQsDQoJCQkJMCAtIHRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAtIHRoaXMub2Zmc2V0LnBhcmVudC50b3AsDQoJCQkJby5jb250YWlubWVudCA9PT0gImRvY3VtZW50IiA\/DQoJCQkJCXRoaXMuZG9jdW1lbnQud2lkdGgoKSA6DQoJCQkJCXRoaXMud2luZG93LndpZHRoKCkgLSB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gdGhpcy5tYXJnaW5zLmxlZnQsDQoJCQkJKCBvLmNvbnRhaW5tZW50ID09PSAiZG9jdW1lbnQiID8NCgkJCQkJKCB0aGlzLmRvY3VtZW50LmhlaWdodCgpIHx8IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5zY3JvbGxIZWlnaHQgKSA6DQoJCQkJCXRoaXMud2luZG93LmhlaWdodCgpIHx8IHRoaXMuZG9jdW1lbnRbIDAgXS5ib2R5LnBhcmVudE5vZGUuc2Nyb2xsSGVpZ2h0DQoJCQkJKSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcA0KCQkJXTsNCgkJfQ0KDQoJCWlmICggISggL14oZG9jdW1lbnR8d2luZG93fHBhcmVudCkkLyApLnRlc3QoIG8uY29udGFpbm1lbnQgKSApIHsNCgkJCWNlID0gJCggby5jb250YWlubWVudCApWyAwIF07DQoJCQljbyA9ICQoIG8uY29udGFpbm1lbnQgKS5vZmZzZXQoKTsNCgkJCW92ZXIgPSAoICQoIGNlICkuY3NzKCAib3ZlcmZsb3ciICkgIT09ICJoaWRkZW4iICk7DQoNCgkJCXRoaXMuY29udGFpbm1lbnQgPSBbDQoJCQkJY28ubGVmdCArICggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAiYm9yZGVyTGVmdFdpZHRoIiApLCAxMCApIHx8IDAgKSArDQoJCQkJCSggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAicGFkZGluZ0xlZnQiICksIDEwICkgfHwgMCApIC0gdGhpcy5tYXJnaW5zLmxlZnQsDQoJCQkJY28udG9wICsgKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICkgKw0KCQkJCQkoIHBhcnNlSW50KCAkKCBjZSApLmNzcyggInBhZGRpbmdUb3AiICksIDEwICkgfHwgMCApIC0gdGhpcy5tYXJnaW5zLnRvcCwNCgkJCQljby5sZWZ0ICsgKCBvdmVyID8gTWF0aC5tYXgoIGNlLnNjcm9sbFdpZHRoLCBjZS5vZmZzZXRXaWR0aCApIDogY2Uub2Zmc2V0V2lkdGggKSAtDQoJCQkJCSggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAiYm9yZGVyTGVmdFdpZHRoIiApLCAxMCApIHx8IDAgKSAtDQoJCQkJCSggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAicGFkZGluZ1JpZ2h0IiApLCAxMCApIHx8IDAgKSAtDQoJCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLSB0aGlzLm1hcmdpbnMubGVmdCwNCgkJCQljby50b3AgKyAoIG92ZXIgPyBNYXRoLm1heCggY2Uuc2Nyb2xsSGVpZ2h0LCBjZS5vZmZzZXRIZWlnaHQgKSA6IGNlLm9mZnNldEhlaWdodCApIC0NCgkJCQkJKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICkgLQ0KCQkJCQkoIHBhcnNlSW50KCAkKCBjZSApLmNzcyggInBhZGRpbmdCb3R0b20iICksIDEwICkgfHwgMCApIC0NCgkJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLSB0aGlzLm1hcmdpbnMudG9wDQoJCQldOw0KCQl9DQoNCgl9LA0KDQoJX2NvbnZlcnRQb3NpdGlvblRvOiBmdW5jdGlvbiggZCwgcG9zICkgew0KDQoJCWlmICggIXBvcyApIHsNCgkJCXBvcyA9IHRoaXMucG9zaXRpb247DQoJCX0NCgkJdmFyIG1vZCA9IGQgPT09ICJhYnNvbHV0ZSIgPyAxIDogLTEsDQoJCQlzY3JvbGwgPSB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmDQoJCQkJISggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5kb2N1bWVudFsgMCBdICYmDQoJCQkJJC5jb250YWlucyggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSwgdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgPw0KCQkJCQl0aGlzLm9mZnNldFBhcmVudCA6DQoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50LA0KCQkJc2Nyb2xsSXNSb290Tm9kZSA9ICggLyhodG1sfGJvZHkpL2kgKS50ZXN0KCBzY3JvbGxbIDAgXS50YWdOYW1lICk7DQoNCgkJcmV0dXJuIHsNCgkJCXRvcDogKA0KDQoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uDQoJCQkJcG9zLnRvcAkrDQoNCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQNCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgKiBtb2QgKw0KDQoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikNCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQudG9wICogbW9kIC0NCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/DQoJCQkJCS10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSA6DQoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiBzY3JvbGwuc2Nyb2xsVG9wKCkgKSApICogbW9kICkNCgkJCSksDQoJCQlsZWZ0OiAoDQoNCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24NCgkJCQlwb3MubGVmdCArDQoNCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQNCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0ICogbW9kICsNCg0KCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpDQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgKiBtb2QJLQ0KCQkJCSggKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8NCgkJCQkJLXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKSA6IHNjcm9sbElzUm9vdE5vZGUgPyAwIDoNCgkJCQkJc2Nyb2xsLnNjcm9sbExlZnQoKSApICogbW9kICkNCgkJCSkNCgkJfTsNCg0KCX0sDQoNCglfZ2VuZXJhdGVQb3NpdGlvbjogZnVuY3Rpb24oIGV2ZW50ICkgew0KDQoJCXZhciB0b3AsIGxlZnQsDQoJCQlvID0gdGhpcy5vcHRpb25zLA0KCQkJcGFnZVggPSBldmVudC5wYWdlWCwNCgkJCXBhZ2VZID0gZXZlbnQucGFnZVksDQoJCQlzY3JvbGwgPSB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmDQoJCQkJISggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5kb2N1bWVudFsgMCBdICYmDQoJCQkJJC5jb250YWlucyggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSwgdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgPw0KCQkJCQl0aGlzLm9mZnNldFBhcmVudCA6DQoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50LA0KCQkJCXNjcm9sbElzUm9vdE5vZGUgPSAoIC8oaHRtbHxib2R5KS9pICkudGVzdCggc2Nyb2xsWyAwIF0udGFnTmFtZSApOw0KDQoJCS8vIFRoaXMgaXMgYW5vdGhlciB2ZXJ5IHdlaXJkIHNwZWNpYWwgY2FzZSB0aGF0IG9ubHkgaGFwcGVucyBmb3IgcmVsYXRpdmUgZWxlbWVudHM6DQoJCS8vIDEuIElmIHRoZSBjc3MgcG9zaXRpb24gaXMgcmVsYXRpdmUNCgkJLy8gMi4gYW5kIHRoZSBzY3JvbGwgcGFyZW50IGlzIHRoZSBkb2N1bWVudCBvciBzaW1pbGFyIHRvIHRoZSBvZmZzZXQgcGFyZW50DQoJCS8vIHdlIGhhdmUgdG8gcmVmcmVzaCB0aGUgcmVsYXRpdmUgb2Zmc2V0IGR1cmluZyB0aGUgc2Nyb2xsIHNvIHRoZXJlIGFyZSBubyBqdW1wcw0KCQlpZiAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgJiYgISggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5kb2N1bWVudFsgMCBdICYmDQoJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgew0KCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUgPSB0aGlzLl9nZXRSZWxhdGl2ZU9mZnNldCgpOw0KCQl9DQoNCgkJLyoNCgkJICogLSBQb3NpdGlvbiBjb25zdHJhaW5pbmcgLQ0KCQkgKiBDb25zdHJhaW4gdGhlIHBvc2l0aW9uIHRvIGEgbWl4IG9mIGdyaWQsIGNvbnRhaW5tZW50Lg0KCQkgKi8NCg0KCQlpZiAoIHRoaXMub3JpZ2luYWxQb3NpdGlvbiApIHsgLy9JZiB3ZSBhcmUgbm90IGRyYWdnaW5nIHlldCwgd2Ugd29uJ3QgY2hlY2sgZm9yIG9wdGlvbnMNCg0KCQkJaWYgKCB0aGlzLmNvbnRhaW5tZW50ICkgew0KCQkJCWlmICggZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0IDwgdGhpcy5jb250YWlubWVudFsgMCBdICkgew0KCQkJCQlwYWdlWCA9IHRoaXMuY29udGFpbm1lbnRbIDAgXSArIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQ7DQoJCQkJfQ0KCQkJCWlmICggZXZlbnQucGFnZVkgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPCB0aGlzLmNvbnRhaW5tZW50WyAxIF0gKSB7DQoJCQkJCXBhZ2VZID0gdGhpcy5jb250YWlubWVudFsgMSBdICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wOw0KCQkJCX0NCgkJCQlpZiAoIGV2ZW50LnBhZ2VYIC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+IHRoaXMuY29udGFpbm1lbnRbIDIgXSApIHsNCgkJCQkJcGFnZVggPSB0aGlzLmNvbnRhaW5tZW50WyAyIF0gKyB0aGlzLm9mZnNldC5jbGljay5sZWZ0Ow0KCQkJCX0NCgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID4gdGhpcy5jb250YWlubWVudFsgMyBdICkgew0KCQkJCQlwYWdlWSA9IHRoaXMuY29udGFpbm1lbnRbIDMgXSArIHRoaXMub2Zmc2V0LmNsaWNrLnRvcDsNCgkJCQl9DQoJCQl9DQoNCgkJCWlmICggby5ncmlkICkgew0KCQkJCXRvcCA9IHRoaXMub3JpZ2luYWxQYWdlWSArIE1hdGgucm91bmQoICggcGFnZVkgLSB0aGlzLm9yaWdpbmFsUGFnZVkgKSAvDQoJCQkJCW8uZ3JpZFsgMSBdICkgKiBvLmdyaWRbIDEgXTsNCgkJCQlwYWdlWSA9IHRoaXMuY29udGFpbm1lbnQgPw0KCQkJCQkoICggdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID49IHRoaXMuY29udGFpbm1lbnRbIDEgXSAmJg0KCQkJCQkJdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wIDw9IHRoaXMuY29udGFpbm1lbnRbIDMgXSApID8NCgkJCQkJCQl0b3AgOg0KCQkJCQkJCSggKCB0b3AgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPj0gdGhpcy5jb250YWlubWVudFsgMSBdICkgPw0KCQkJCQkJCQl0b3AgLSBvLmdyaWRbIDEgXSA6IHRvcCArIG8uZ3JpZFsgMSBdICkgKSA6DQoJCQkJCQkJCXRvcDsNCg0KCQkJCWxlZnQgPSB0aGlzLm9yaWdpbmFsUGFnZVggKyBNYXRoLnJvdW5kKCAoIHBhZ2VYIC0gdGhpcy5vcmlnaW5hbFBhZ2VYICkgLw0KCQkJCQlvLmdyaWRbIDAgXSApICogby5ncmlkWyAwIF07DQoJCQkJcGFnZVggPSB0aGlzLmNvbnRhaW5tZW50ID8NCgkJCQkJKCAoIGxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID49IHRoaXMuY29udGFpbm1lbnRbIDAgXSAmJg0KCQkJCQkJbGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPD0gdGhpcy5jb250YWlubWVudFsgMiBdICkgPw0KCQkJCQkJCWxlZnQgOg0KCQkJCQkJCSggKCBsZWZ0IC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+PSB0aGlzLmNvbnRhaW5tZW50WyAwIF0gKSA\/DQoJCQkJCQkJCWxlZnQgLSBvLmdyaWRbIDAgXSA6IGxlZnQgKyBvLmdyaWRbIDAgXSApICkgOg0KCQkJCQkJCQlsZWZ0Ow0KCQkJfQ0KDQoJCX0NCg0KCQlyZXR1cm4gew0KCQkJdG9wOiAoDQoNCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24NCgkJCQlwYWdlWSAtDQoNCgkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQ0KCQkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCAtDQoNCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQNCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgLQ0KDQoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikNCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQudG9wICsNCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/DQoJCQkJCS10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSA6DQoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiBzY3JvbGwuc2Nyb2xsVG9wKCkgKSApICkNCgkJCSksDQoJCQlsZWZ0OiAoDQoNCgkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24NCgkJCQlwYWdlWCAtDQoNCgkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQ0KCQkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgLQ0KDQoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50DQoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdCAtDQoNCgkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQ0KCQkJCXRoaXMub2Zmc2V0LnBhcmVudC5sZWZ0ICsNCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/DQoJCQkJCS10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkgOg0KCQkJCQlzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHNjcm9sbC5zY3JvbGxMZWZ0KCkgKSApDQoJCQkpDQoJCX07DQoNCgl9LA0KDQoJX3JlYXJyYW5nZTogZnVuY3Rpb24oIGV2ZW50LCBpLCBhLCBoYXJkUmVmcmVzaCApIHsNCg0KCQlhID8gYVsgMCBdLmFwcGVuZENoaWxkKCB0aGlzLnBsYWNlaG9sZGVyWyAwIF0gKSA6DQoJCQlpLml0ZW1bIDAgXS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggdGhpcy5wbGFjZWhvbGRlclsgMCBdLA0KCQkJCSggdGhpcy5kaXJlY3Rpb24gPT09ICJkb3duIiA\/IGkuaXRlbVsgMCBdIDogaS5pdGVtWyAwIF0ubmV4dFNpYmxpbmcgKSApOw0KDQoJCS8vVmFyaW91cyB0aGluZ3MgZG9uZSBoZXJlIHRvIGltcHJvdmUgdGhlIHBlcmZvcm1hbmNlOg0KCQkvLyAxLiB3ZSBjcmVhdGUgYSBzZXRUaW1lb3V0LCB0aGF0IGNhbGxzIHJlZnJlc2hQb3NpdGlvbnMNCgkJLy8gMi4gb24gdGhlIGluc3RhbmNlLCB3ZSBoYXZlIGEgY291bnRlciB2YXJpYWJsZSwgdGhhdCBnZXQncyBoaWdoZXIgYWZ0ZXIgZXZlcnkgYXBwZW5kDQoJCS8vIDMuIG9uIHRoZSBsb2NhbCBzY29wZSwgd2UgY29weSB0aGUgY291bnRlciB2YXJpYWJsZSwgYW5kIGNoZWNrIGluIHRoZSB0aW1lb3V0LA0KCQkvLyBpZiBpdCdzIHN0aWxsIHRoZSBzYW1lDQoJCS8vIDQuIHRoaXMgbGV0cyBvbmx5IHRoZSBsYXN0IGFkZGl0aW9uIHRvIHRoZSB0aW1lb3V0IHN0YWNrIHRocm91Z2gNCgkJdGhpcy5jb3VudGVyID0gdGhpcy5jb3VudGVyID8gKyt0aGlzLmNvdW50ZXIgOiAxOw0KCQl2YXIgY291bnRlciA9IHRoaXMuY291bnRlcjsNCg0KCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoJCQlpZiAoIGNvdW50ZXIgPT09IHRoaXMuY291bnRlciApIHsNCg0KCQkJCS8vUHJlY29tcHV0ZSBhZnRlciBlYWNoIERPTSBpbnNlcnRpb24sIE5PVCBvbiBtb3VzZW1vdmUNCgkJCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoICFoYXJkUmVmcmVzaCApOw0KCQkJfQ0KCQl9ICk7DQoNCgl9LA0KDQoJX2NsZWFyOiBmdW5jdGlvbiggZXZlbnQsIG5vUHJvcGFnYXRpb24gKSB7DQoNCgkJdGhpcy5yZXZlcnRpbmcgPSBmYWxzZTsNCg0KCQkvLyBXZSBkZWxheSBhbGwgZXZlbnRzIHRoYXQgaGF2ZSB0byBiZSB0cmlnZ2VyZWQgdG8gYWZ0ZXIgdGhlIHBvaW50IHdoZXJlIHRoZSBwbGFjZWhvbGRlcg0KCQkvLyBoYXMgYmVlbiByZW1vdmVkIGFuZCBldmVyeXRoaW5nIGVsc2Ugbm9ybWFsaXplZCBhZ2Fpbg0KCQl2YXIgaSwNCgkJCWRlbGF5ZWRUcmlnZ2VycyA9IFtdOw0KDQoJCS8vIFdlIGZpcnN0IGhhdmUgdG8gdXBkYXRlIHRoZSBkb20gcG9zaXRpb24gb2YgdGhlIGFjdHVhbCBjdXJyZW50SXRlbQ0KCQkvLyBOb3RlOiBkb24ndCBkbyBpdCBpZiB0aGUgY3VycmVudCBpdGVtIGlzIGFscmVhZHkgcmVtb3ZlZCAoYnkgYSB1c2VyKSwgb3IgaXQgZ2V0cw0KCQkvLyByZWFwcGVuZGVkIChzZWUgIzQwODgpDQoJCWlmICggIXRoaXMuX25vRmluYWxTb3J0ICYmIHRoaXMuY3VycmVudEl0ZW0ucGFyZW50KCkubGVuZ3RoICkgew0KCQkJdGhpcy5wbGFjZWhvbGRlci5iZWZvcmUoIHRoaXMuY3VycmVudEl0ZW0gKTsNCgkJfQ0KCQl0aGlzLl9ub0ZpbmFsU29ydCA9IG51bGw7DQoNCgkJaWYgKCB0aGlzLmhlbHBlclsgMCBdID09PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7DQoJCQlmb3IgKCBpIGluIHRoaXMuX3N0b3JlZENTUyApIHsNCgkJCQlpZiAoIHRoaXMuX3N0b3JlZENTU1sgaSBdID09PSAiYXV0byIgfHwgdGhpcy5fc3RvcmVkQ1NTWyBpIF0gPT09ICJzdGF0aWMiICkgew0KCQkJCQl0aGlzLl9zdG9yZWRDU1NbIGkgXSA9ICIiOw0KCQkJCX0NCgkJCX0NCgkJCXRoaXMuY3VycmVudEl0ZW0uY3NzKCB0aGlzLl9zdG9yZWRDU1MgKTsNCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmN1cnJlbnRJdGVtLCAidWktc29ydGFibGUtaGVscGVyIiApOw0KCQl9IGVsc2Ugew0KCQkJdGhpcy5jdXJyZW50SXRlbS5zaG93KCk7DQoJCX0NCg0KCQlpZiAoIHRoaXMuZnJvbU91dHNpZGUgJiYgIW5vUHJvcGFnYXRpb24gKSB7DQoJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXRoaXMuX3RyaWdnZXIoICJyZWNlaXZlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcy5mcm9tT3V0c2lkZSApICk7DQoJCQl9ICk7DQoJCX0NCgkJaWYgKCAoIHRoaXMuZnJvbU91dHNpZGUgfHwNCgkJCQl0aGlzLmRvbVBvc2l0aW9uLnByZXYgIT09DQoJCQkJdGhpcy5jdXJyZW50SXRlbS5wcmV2KCkubm90KCAiLnVpLXNvcnRhYmxlLWhlbHBlciIgKVsgMCBdIHx8DQoJCQkJdGhpcy5kb21Qb3NpdGlvbi5wYXJlbnQgIT09IHRoaXMuY3VycmVudEl0ZW0ucGFyZW50KClbIDAgXSApICYmICFub1Byb3BhZ2F0aW9uICkgew0KDQoJCQkvLyBUcmlnZ2VyIHVwZGF0ZSBjYWxsYmFjayBpZiB0aGUgRE9NIHBvc2l0aW9uIGhhcyBjaGFuZ2VkDQoJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCXRoaXMuX3RyaWdnZXIoICJ1cGRhdGUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsNCgkJCX0gKTsNCgkJfQ0KDQoJCS8vIENoZWNrIGlmIHRoZSBpdGVtcyBDb250YWluZXIgaGFzIENoYW5nZWQgYW5kIHRyaWdnZXIgYXBwcm9wcmlhdGUNCgkJLy8gZXZlbnRzLg0KCQlpZiAoIHRoaXMgIT09IHRoaXMuY3VycmVudENvbnRhaW5lciApIHsNCgkJCWlmICggIW5vUHJvcGFnYXRpb24gKSB7DQoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goIGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQkJdGhpcy5fdHJpZ2dlciggInJlbW92ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOw0KCQkJCX0gKTsNCgkJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggKCBmdW5jdGlvbiggYyApIHsNCgkJCQkJcmV0dXJuIGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQkJCWMuX3RyaWdnZXIoICJyZWNlaXZlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7DQoJCQkJCX07DQoJCQkJfSApLmNhbGwoIHRoaXMsIHRoaXMuY3VycmVudENvbnRhaW5lciApICk7DQoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goICggZnVuY3Rpb24oIGMgKSB7DQoJCQkJCXJldHVybiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJCQljLl90cmlnZ2VyKCAidXBkYXRlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7DQoJCQkJCX07DQoJCQkJfSApLmNhbGwoIHRoaXMsIHRoaXMuY3VycmVudENvbnRhaW5lciApICk7DQoJCQl9DQoJCX0NCg0KCQkvL1Bvc3QgZXZlbnRzIHRvIGNvbnRhaW5lcnMNCgkJZnVuY3Rpb24gZGVsYXlFdmVudCggdHlwZSwgaW5zdGFuY2UsIGNvbnRhaW5lciApIHsNCgkJCXJldHVybiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJY29udGFpbmVyLl90cmlnZ2VyKCB0eXBlLCBldmVudCwgaW5zdGFuY2UuX3VpSGFzaCggaW5zdGFuY2UgKSApOw0KCQkJfTsNCgkJfQ0KCQlmb3IgKCBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgew0KCQkJaWYgKCAhbm9Qcm9wYWdhdGlvbiApIHsNCgkJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggZGVsYXlFdmVudCggImRlYWN0aXZhdGUiLCB0aGlzLCB0aGlzLmNvbnRhaW5lcnNbIGkgXSApICk7DQoJCQl9DQoJCQlpZiAoIHRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7DQoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goIGRlbGF5RXZlbnQoICJvdXQiLCB0aGlzLCB0aGlzLmNvbnRhaW5lcnNbIGkgXSApICk7DQoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDA7DQoJCQl9DQoJCX0NCg0KCQkvL0RvIHdoYXQgd2FzIG9yaWdpbmFsbHkgaW4gcGx1Z2lucw0KCQlpZiAoIHRoaXMuc3RvcmVkQ3Vyc29yICkgew0KCQkJdGhpcy5kb2N1bWVudC5maW5kKCAiYm9keSIgKS5jc3MoICJjdXJzb3IiLCB0aGlzLnN0b3JlZEN1cnNvciApOw0KCQkJdGhpcy5zdG9yZWRTdHlsZXNoZWV0LnJlbW92ZSgpOw0KCQl9DQoJCWlmICggdGhpcy5fc3RvcmVkT3BhY2l0eSApIHsNCgkJCXRoaXMuaGVscGVyLmNzcyggIm9wYWNpdHkiLCB0aGlzLl9zdG9yZWRPcGFjaXR5ICk7DQoJCX0NCgkJaWYgKCB0aGlzLl9zdG9yZWRaSW5kZXggKSB7DQoJCQl0aGlzLmhlbHBlci5jc3MoICJ6SW5kZXgiLCB0aGlzLl9zdG9yZWRaSW5kZXggPT09ICJhdXRvIiA\/ICIiIDogdGhpcy5fc3RvcmVkWkluZGV4ICk7DQoJCX0NCg0KCQl0aGlzLmRyYWdnaW5nID0gZmFsc2U7DQoNCgkJaWYgKCAhbm9Qcm9wYWdhdGlvbiApIHsNCgkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVTdG9wIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpICk7DQoJCX0NCg0KCQkvLyQodGhpcy5wbGFjZWhvbGRlclswXSkucmVtb3ZlKCk7IHdvdWxkIGhhdmUgYmVlbiB0aGUgalF1ZXJ5IHdheSAtIHVuZm9ydHVuYXRlbHksDQoJCS8vIGl0IHVuYmluZHMgQUxMIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIQ0KCQl0aGlzLnBsYWNlaG9sZGVyWyAwIF0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggdGhpcy5wbGFjZWhvbGRlclsgMCBdICk7DQoNCgkJaWYgKCAhdGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsICkgew0KCQkJaWYgKCB0aGlzLmhlbHBlclsgMCBdICE9PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7DQoJCQkJdGhpcy5oZWxwZXIucmVtb3ZlKCk7DQoJCQl9DQoJCQl0aGlzLmhlbHBlciA9IG51bGw7DQoJCX0NCg0KCQlpZiAoICFub1Byb3BhZ2F0aW9uICkgew0KCQkJZm9yICggaSA9IDA7IGkgPCBkZWxheWVkVHJpZ2dlcnMubGVuZ3RoOyBpKysgKSB7DQoNCgkJCQkvLyBUcmlnZ2VyIGFsbCBkZWxheWVkIGV2ZW50cw0KCQkJCWRlbGF5ZWRUcmlnZ2Vyc1sgaSBdLmNhbGwoIHRoaXMsIGV2ZW50ICk7DQoJCQl9DQoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOw0KCQl9DQoNCgkJdGhpcy5mcm9tT3V0c2lkZSA9IGZhbHNlOw0KCQlyZXR1cm4gIXRoaXMuY2FuY2VsSGVscGVyUmVtb3ZhbDsNCg0KCX0sDQoNCglfdHJpZ2dlcjogZnVuY3Rpb24oKSB7DQoJCWlmICggJC5XaWRnZXQucHJvdG90eXBlLl90cmlnZ2VyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA9PT0gZmFsc2UgKSB7DQoJCQl0aGlzLmNhbmNlbCgpOw0KCQl9DQoJfSwNCg0KCV91aUhhc2g6IGZ1bmN0aW9uKCBfaW5zdCApIHsNCgkJdmFyIGluc3QgPSBfaW5zdCB8fCB0aGlzOw0KCQlyZXR1cm4gew0KCQkJaGVscGVyOiBpbnN0LmhlbHBlciwNCgkJCXBsYWNlaG9sZGVyOiBpbnN0LnBsYWNlaG9sZGVyIHx8ICQoIFtdICksDQoJCQlwb3NpdGlvbjogaW5zdC5wb3NpdGlvbiwNCgkJCW9yaWdpbmFsUG9zaXRpb246IGluc3Qub3JpZ2luYWxQb3NpdGlvbiwNCgkJCW9mZnNldDogaW5zdC5wb3NpdGlvbkFicywNCgkJCWl0ZW06IGluc3QuY3VycmVudEl0ZW0sDQoJCQlzZW5kZXI6IF9pbnN0ID8gX2luc3QuZWxlbWVudCA6IG51bGwNCgkJfTsNCgl9DQoNCn0gKTsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBTcGlubmVyIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBTcGlubmVyDQovLz4+Z3JvdXA6IFdpZGdldHMNCi8vPj5kZXNjcmlwdGlvbjogRGlzcGxheXMgYnV0dG9ucyB0byBlYXNpbHkgaW5wdXQgbnVtYmVycyB2aWEgdGhlIGtleWJvYXJkIG9yIG1vdXNlLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NwaW5uZXIvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vc3Bpbm5lci8NCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3NwaW5uZXIuY3NzDQovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MNCg0KDQoNCmZ1bmN0aW9uIHNwaW5uZXJNb2RpZmVyKCBmbiApIHsNCglyZXR1cm4gZnVuY3Rpb24oKSB7DQoJCXZhciBwcmV2aW91cyA9IHRoaXMuZWxlbWVudC52YWwoKTsNCgkJZm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOw0KCQl0aGlzLl9yZWZyZXNoKCk7DQoJCWlmICggcHJldmlvdXMgIT09IHRoaXMuZWxlbWVudC52YWwoKSApIHsNCgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiICk7DQoJCX0NCgl9Ow0KfQ0KDQokLndpZGdldCggInVpLnNwaW5uZXIiLCB7DQoJdmVyc2lvbjogIjEuMTIuMSIsDQoJZGVmYXVsdEVsZW1lbnQ6ICI8aW5wdXQ+IiwNCgl3aWRnZXRFdmVudFByZWZpeDogInNwaW4iLA0KCW9wdGlvbnM6IHsNCgkJY2xhc3Nlczogew0KCQkJInVpLXNwaW5uZXIiOiAidWktY29ybmVyLWFsbCIsDQoJCQkidWktc3Bpbm5lci1kb3duIjogInVpLWNvcm5lci1iciIsDQoJCQkidWktc3Bpbm5lci11cCI6ICJ1aS1jb3JuZXItdHIiDQoJCX0sDQoJCWN1bHR1cmU6IG51bGwsDQoJCWljb25zOiB7DQoJCQlkb3duOiAidWktaWNvbi10cmlhbmdsZS0xLXMiLA0KCQkJdXA6ICJ1aS1pY29uLXRyaWFuZ2xlLTEtbiINCgkJfSwNCgkJaW5jcmVtZW50YWw6IHRydWUsDQoJCW1heDogbnVsbCwNCgkJbWluOiBudWxsLA0KCQludW1iZXJGb3JtYXQ6IG51bGwsDQoJCXBhZ2U6IDEwLA0KCQlzdGVwOiAxLA0KDQoJCWNoYW5nZTogbnVsbCwNCgkJc3BpbjogbnVsbCwNCgkJc3RhcnQ6IG51bGwsDQoJCXN0b3A6IG51bGwNCgl9LA0KDQoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7DQoNCgkJLy8gaGFuZGxlIHN0cmluZyB2YWx1ZXMgdGhhdCBuZWVkIHRvIGJlIHBhcnNlZA0KCQl0aGlzLl9zZXRPcHRpb24oICJtYXgiLCB0aGlzLm9wdGlvbnMubWF4ICk7DQoJCXRoaXMuX3NldE9wdGlvbiggIm1pbiIsIHRoaXMub3B0aW9ucy5taW4gKTsNCgkJdGhpcy5fc2V0T3B0aW9uKCAic3RlcCIsIHRoaXMub3B0aW9ucy5zdGVwICk7DQoNCgkJLy8gT25seSBmb3JtYXQgaWYgdGhlcmUgaXMgYSB2YWx1ZSwgcHJldmVudHMgdGhlIGZpZWxkIGZyb20gYmVpbmcgbWFya2VkDQoJCS8vIGFzIGludmFsaWQgaW4gRmlyZWZveCwgc2VlICM5NTczLg0KCQlpZiAoIHRoaXMudmFsdWUoKSAhPT0gIiIgKSB7DQoNCgkJCS8vIEZvcm1hdCB0aGUgdmFsdWUsIGJ1dCBkb24ndCBjb25zdHJhaW4uDQoJCQl0aGlzLl92YWx1ZSggdGhpcy5lbGVtZW50LnZhbCgpLCB0cnVlICk7DQoJCX0NCg0KCQl0aGlzLl9kcmF3KCk7DQoJCXRoaXMuX29uKCB0aGlzLl9ldmVudHMgKTsNCgkJdGhpcy5fcmVmcmVzaCgpOw0KDQoJCS8vIFR1cm5pbmcgb2ZmIGF1dG9jb21wbGV0ZSBwcmV2ZW50cyB0aGUgYnJvd3NlciBmcm9tIHJlbWVtYmVyaW5nIHRoZQ0KCQkvLyB2YWx1ZSB3aGVuIG5hdmlnYXRpbmcgdGhyb3VnaCBoaXN0b3J5LCBzbyB3ZSByZS1lbmFibGUgYXV0b2NvbXBsZXRlDQoJCS8vIGlmIHRoZSBwYWdlIGlzIHVubG9hZGVkIGJlZm9yZSB0aGUgd2lkZ2V0IGlzIGRlc3Ryb3llZC4gIzc3OTANCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7DQoJCQliZWZvcmV1bmxvYWQ6IGZ1bmN0aW9uKCkgew0KCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAiYXV0b2NvbXBsZXRlIiApOw0KCQkJfQ0KCQl9ICk7DQoJfSwNCg0KCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsNCgkJdmFyIG9wdGlvbnMgPSB0aGlzLl9zdXBlcigpOw0KCQl2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsNCg0KCQkkLmVhY2goIFsgIm1pbiIsICJtYXgiLCAic3RlcCIgXSwgZnVuY3Rpb24oIGksIG9wdGlvbiApIHsNCgkJCXZhciB2YWx1ZSA9IGVsZW1lbnQuYXR0ciggb3B0aW9uICk7DQoJCQlpZiAoIHZhbHVlICE9IG51bGwgJiYgdmFsdWUubGVuZ3RoICkgew0KCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7DQoJCQl9DQoJCX0gKTsNCg0KCQlyZXR1cm4gb3B0aW9uczsNCgl9LA0KDQoJX2V2ZW50czogew0KCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQlpZiAoIHRoaXMuX3N0YXJ0KCBldmVudCApICYmIHRoaXMuX2tleWRvd24oIGV2ZW50ICkgKSB7DQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCX0NCgkJfSwNCgkJa2V5dXA6ICJfc3RvcCIsDQoJCWZvY3VzOiBmdW5jdGlvbigpIHsNCgkJCXRoaXMucHJldmlvdXMgPSB0aGlzLmVsZW1lbnQudmFsKCk7DQoJCX0sDQoJCWJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCWlmICggdGhpcy5jYW5jZWxCbHVyICkgew0KCQkJCWRlbGV0ZSB0aGlzLmNhbmNlbEJsdXI7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQl0aGlzLl9zdG9wKCk7DQoJCQl0aGlzLl9yZWZyZXNoKCk7DQoJCQlpZiAoIHRoaXMucHJldmlvdXMgIT09IHRoaXMuZWxlbWVudC52YWwoKSApIHsNCgkJCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiwgZXZlbnQgKTsNCgkJCX0NCgkJfSwNCgkJbW91c2V3aGVlbDogZnVuY3Rpb24oIGV2ZW50LCBkZWx0YSApIHsNCgkJCWlmICggIWRlbHRhICkgew0KCQkJCXJldHVybjsNCgkJCX0NCgkJCWlmICggIXRoaXMuc3Bpbm5pbmcgJiYgIXRoaXMuX3N0YXJ0KCBldmVudCApICkgew0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0NCg0KCQkJdGhpcy5fc3BpbiggKCBkZWx0YSA+IDAgPyAxIDogLTEgKSAqIHRoaXMub3B0aW9ucy5zdGVwLCBldmVudCApOw0KCQkJY2xlYXJUaW1lb3V0KCB0aGlzLm1vdXNld2hlZWxUaW1lciApOw0KCQkJdGhpcy5tb3VzZXdoZWVsVGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoJCQkJaWYgKCB0aGlzLnNwaW5uaW5nICkgew0KCQkJCQl0aGlzLl9zdG9wKCBldmVudCApOw0KCQkJCX0NCgkJCX0sIDEwMCApOw0KCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJfSwNCgkJIm1vdXNlZG93biAudWktc3Bpbm5lci1idXR0b24iOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQl2YXIgcHJldmlvdXM7DQoNCgkJCS8vIFdlIG5ldmVyIHdhbnQgdGhlIGJ1dHRvbnMgdG8gaGF2ZSBmb2N1czsgd2hlbmV2ZXIgdGhlIHVzZXIgaXMNCgkJCS8vIGludGVyYWN0aW5nIHdpdGggdGhlIHNwaW5uZXIsIHRoZSBmb2N1cyBzaG91bGQgYmUgb24gdGhlIGlucHV0Lg0KCQkJLy8gSWYgdGhlIGlucHV0IGlzIGZvY3VzZWQgdGhlbiB0aGlzLnByZXZpb3VzIGlzIHByb3Blcmx5IHNldCBmcm9tDQoJCQkvLyB3aGVuIHRoZSBpbnB1dCBmaXJzdCByZWNlaXZlZCBmb2N1cy4gSWYgdGhlIGlucHV0IGlzIG5vdCBmb2N1c2VkDQoJCQkvLyB0aGVuIHdlIG5lZWQgdG8gc2V0IHRoaXMucHJldmlvdXMgYmFzZWQgb24gdGhlIHZhbHVlIGJlZm9yZSBzcGlubmluZy4NCgkJCXByZXZpb3VzID0gdGhpcy5lbGVtZW50WyAwIF0gPT09ICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApID8NCgkJCQl0aGlzLnByZXZpb3VzIDogdGhpcy5lbGVtZW50LnZhbCgpOw0KCQkJZnVuY3Rpb24gY2hlY2tGb2N1cygpIHsNCgkJCQl2YXIgaXNBY3RpdmUgPSB0aGlzLmVsZW1lbnRbIDAgXSA9PT0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICk7DQoJCQkJaWYgKCAhaXNBY3RpdmUgKSB7DQoJCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiZm9jdXMiICk7DQoJCQkJCXRoaXMucHJldmlvdXMgPSBwcmV2aW91czsNCg0KCQkJCQkvLyBzdXBwb3J0OiBJRQ0KCQkJCQkvLyBJRSBzZXRzIGZvY3VzIGFzeW5jaHJvbm91c2x5LCBzbyB3ZSBuZWVkIHRvIGNoZWNrIGlmIGZvY3VzDQoJCQkJCS8vIG1vdmVkIG9mZiBvZiB0aGUgaW5wdXQgYmVjYXVzZSB0aGUgdXNlciBjbGlja2VkIG9uIHRoZSBidXR0b24uDQoJCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsNCgkJCQkJCXRoaXMucHJldmlvdXMgPSBwcmV2aW91czsNCgkJCQkJfSApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gRW5zdXJlIGZvY3VzIGlzIG9uIChvciBzdGF5cyBvbikgdGhlIHRleHQgZmllbGQNCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQljaGVja0ZvY3VzLmNhbGwoIHRoaXMgKTsNCg0KCQkJLy8gU3VwcG9ydDogSUUNCgkJCS8vIElFIGRvZXNuJ3QgcHJldmVudCBtb3ZpbmcgZm9jdXMgZXZlbiB3aXRoIGV2ZW50LnByZXZlbnREZWZhdWx0KCkNCgkJCS8vIHNvIHdlIHNldCBhIGZsYWcgdG8ga25vdyB3aGVuIHdlIHNob3VsZCBpZ25vcmUgdGhlIGJsdXIgZXZlbnQNCgkJCS8vIGFuZCBjaGVjayAoYWdhaW4pIGlmIGZvY3VzIG1vdmVkIG9mZiBvZiB0aGUgaW5wdXQuDQoJCQl0aGlzLmNhbmNlbEJsdXIgPSB0cnVlOw0KCQkJdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgew0KCQkJCWRlbGV0ZSB0aGlzLmNhbmNlbEJsdXI7DQoJCQkJY2hlY2tGb2N1cy5jYWxsKCB0aGlzICk7DQoJCQl9ICk7DQoNCgkJCWlmICggdGhpcy5fc3RhcnQoIGV2ZW50ICkgPT09IGZhbHNlICkgew0KCQkJCXJldHVybjsNCgkJCX0NCg0KCQkJdGhpcy5fcmVwZWF0KCBudWxsLCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkNCgkJCQkuaGFzQ2xhc3MoICJ1aS1zcGlubmVyLXVwIiApID8gMSA6IC0xLCBldmVudCApOw0KCQl9LA0KCQkibW91c2V1cCAudWktc3Bpbm5lci1idXR0b24iOiAiX3N0b3AiLA0KCQkibW91c2VlbnRlciAudWktc3Bpbm5lci1idXR0b24iOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoNCgkJCS8vIGJ1dHRvbiB3aWxsIGFkZCB1aS1zdGF0ZS1hY3RpdmUgaWYgbW91c2Ugd2FzIGRvd24gd2hpbGUgbW91c2VsZWF2ZSBhbmQga2VwdCBkb3duDQoJCQlpZiAoICEkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICkgKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KDQoJCQlpZiAoIHRoaXMuX3N0YXJ0KCBldmVudCApID09PSBmYWxzZSApIHsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoJCQl0aGlzLl9yZXBlYXQoIG51bGwsICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKQ0KCQkJCS5oYXNDbGFzcyggInVpLXNwaW5uZXItdXAiICkgPyAxIDogLTEsIGV2ZW50ICk7DQoJCX0sDQoNCgkJLy8gVE9ETzogZG8gd2UgcmVhbGx5IHdhbnQgdG8gY29uc2lkZXIgdGhpcyBhIHN0b3A\/DQoJCS8vIHNob3VsZG4ndCB3ZSBqdXN0IHN0b3AgdGhlIHJlcGVhdGVyIGFuZCB3YWl0IHVudGlsIG1vdXNldXAgYmVmb3JlDQoJCS8vIHdlIHRyaWdnZXIgdGhlIHN0b3AgZXZlbnQ\/DQoJCSJtb3VzZWxlYXZlIC51aS1zcGlubmVyLWJ1dHRvbiI6ICJfc3RvcCINCgl9LA0KDQoJLy8gU3VwcG9ydCBtb2JpbGUgZW5oYW5jZWQgb3B0aW9uIGFuZCBtYWtlIGJhY2tjb21wYXQgbW9yZSBzYW5lDQoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLnVpU3Bpbm5lciA9IHRoaXMuZWxlbWVudA0KCQkJLmF0dHIoICJhdXRvY29tcGxldGUiLCAib2ZmIiApDQoJCQkud3JhcCggIjxzcGFuPiIgKQ0KCQkJLnBhcmVudCgpDQoNCgkJCQkvLyBBZGQgYnV0dG9ucw0KCQkJCS5hcHBlbmQoDQoJCQkJCSI8YT48L2E+PGE+PC9hPiINCgkJCQkpOw0KCX0sDQoNCglfZHJhdzogZnVuY3Rpb24oKSB7DQoJCXRoaXMuX2VuaGFuY2UoKTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy51aVNwaW5uZXIsICJ1aS1zcGlubmVyIiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCIgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1zcGlubmVyLWlucHV0IiApOw0KDQoJCXRoaXMuZWxlbWVudC5hdHRyKCAicm9sZSIsICJzcGluYnV0dG9uIiApOw0KDQoJCS8vIEJ1dHRvbiBiaW5kaW5ncw0KCQl0aGlzLmJ1dHRvbnMgPSB0aGlzLnVpU3Bpbm5lci5jaGlsZHJlbiggImEiICkNCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApDQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgdHJ1ZSApDQoJCQkuYnV0dG9uKCB7DQoJCQkJY2xhc3Nlczogew0KCQkJCQkidWktYnV0dG9uIjogIiINCgkJCQl9DQoJCQl9ICk7DQoNCgkJLy8gVE9ETzogUmlnaHQgbm93IGJ1dHRvbiBkb2VzIG5vdCBzdXBwb3J0IGNsYXNzZXMgdGhpcyBpcyBhbHJlYWR5IHVwZGF0ZWQgaW4gYnV0dG9uIFBSDQoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmJ1dHRvbnMsICJ1aS1jb3JuZXItYWxsIiApOw0KDQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmJ1dHRvbnMuZmlyc3QoKSwgInVpLXNwaW5uZXItYnV0dG9uIHVpLXNwaW5uZXItdXAiICk7DQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmJ1dHRvbnMubGFzdCgpLCAidWktc3Bpbm5lci1idXR0b24gdWktc3Bpbm5lci1kb3duIiApOw0KCQl0aGlzLmJ1dHRvbnMuZmlyc3QoKS5idXR0b24oIHsNCgkJCSJpY29uIjogdGhpcy5vcHRpb25zLmljb25zLnVwLA0KCQkJInNob3dMYWJlbCI6IGZhbHNlDQoJCX0gKTsNCgkJdGhpcy5idXR0b25zLmxhc3QoKS5idXR0b24oIHsNCgkJCSJpY29uIjogdGhpcy5vcHRpb25zLmljb25zLmRvd24sDQoJCQkic2hvd0xhYmVsIjogZmFsc2UNCgkJfSApOw0KDQoJCS8vIElFIDYgZG9lc24ndCB1bmRlcnN0YW5kIGhlaWdodDogNTAlIGZvciB0aGUgYnV0dG9ucw0KCQkvLyB1bmxlc3MgdGhlIHdyYXBwZXIgaGFzIGFuIGV4cGxpY2l0IGhlaWdodA0KCQlpZiAoIHRoaXMuYnV0dG9ucy5oZWlnaHQoKSA+IE1hdGguY2VpbCggdGhpcy51aVNwaW5uZXIuaGVpZ2h0KCkgKiAwLjUgKSAmJg0KCQkJCXRoaXMudWlTcGlubmVyLmhlaWdodCgpID4gMCApIHsNCgkJCXRoaXMudWlTcGlubmVyLmhlaWdodCggdGhpcy51aVNwaW5uZXIuaGVpZ2h0KCkgKTsNCgkJfQ0KCX0sDQoNCglfa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywNCgkJCWtleUNvZGUgPSAkLnVpLmtleUNvZGU7DQoNCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsNCgkJY2FzZSBrZXlDb2RlLlVQOg0KCQkJdGhpcy5fcmVwZWF0KCBudWxsLCAxLCBldmVudCApOw0KCQkJcmV0dXJuIHRydWU7DQoJCWNhc2Uga2V5Q29kZS5ET1dOOg0KCQkJdGhpcy5fcmVwZWF0KCBudWxsLCAtMSwgZXZlbnQgKTsNCgkJCXJldHVybiB0cnVlOw0KCQljYXNlIGtleUNvZGUuUEFHRV9VUDoNCgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgb3B0aW9ucy5wYWdlLCBldmVudCApOw0KCQkJcmV0dXJuIHRydWU7DQoJCWNhc2Uga2V5Q29kZS5QQUdFX0RPV046DQoJCQl0aGlzLl9yZXBlYXQoIG51bGwsIC1vcHRpb25zLnBhZ2UsIGV2ZW50ICk7DQoJCQlyZXR1cm4gdHJ1ZTsNCgkJfQ0KDQoJCXJldHVybiBmYWxzZTsNCgl9LA0KDQoJX3N0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCWlmICggIXRoaXMuc3Bpbm5pbmcgJiYgdGhpcy5fdHJpZ2dlciggInN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQlpZiAoICF0aGlzLmNvdW50ZXIgKSB7DQoJCQl0aGlzLmNvdW50ZXIgPSAxOw0KCQl9DQoJCXRoaXMuc3Bpbm5pbmcgPSB0cnVlOw0KCQlyZXR1cm4gdHJ1ZTsNCgl9LA0KDQoJX3JlcGVhdDogZnVuY3Rpb24oIGksIHN0ZXBzLCBldmVudCApIHsNCgkJaSA9IGkgfHwgNTAwOw0KDQoJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOw0KCQl0aGlzLnRpbWVyID0gdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgew0KCQkJdGhpcy5fcmVwZWF0KCA0MCwgc3RlcHMsIGV2ZW50ICk7DQoJCX0sIGkgKTsNCg0KCQl0aGlzLl9zcGluKCBzdGVwcyAqIHRoaXMub3B0aW9ucy5zdGVwLCBldmVudCApOw0KCX0sDQoNCglfc3BpbjogZnVuY3Rpb24oIHN0ZXAsIGV2ZW50ICkgew0KCQl2YXIgdmFsdWUgPSB0aGlzLnZhbHVlKCkgfHwgMDsNCg0KCQlpZiAoICF0aGlzLmNvdW50ZXIgKSB7DQoJCQl0aGlzLmNvdW50ZXIgPSAxOw0KCQl9DQoNCgkJdmFsdWUgPSB0aGlzLl9hZGp1c3RWYWx1ZSggdmFsdWUgKyBzdGVwICogdGhpcy5faW5jcmVtZW50KCB0aGlzLmNvdW50ZXIgKSApOw0KDQoJCWlmICggIXRoaXMuc3Bpbm5pbmcgfHwgdGhpcy5fdHJpZ2dlciggInNwaW4iLCBldmVudCwgeyB2YWx1ZTogdmFsdWUgfSApICE9PSBmYWxzZSApIHsNCgkJCXRoaXMuX3ZhbHVlKCB2YWx1ZSApOw0KCQkJdGhpcy5jb3VudGVyKys7DQoJCX0NCgl9LA0KDQoJX2luY3JlbWVudDogZnVuY3Rpb24oIGkgKSB7DQoJCXZhciBpbmNyZW1lbnRhbCA9IHRoaXMub3B0aW9ucy5pbmNyZW1lbnRhbDsNCg0KCQlpZiAoIGluY3JlbWVudGFsICkgew0KCQkJcmV0dXJuICQuaXNGdW5jdGlvbiggaW5jcmVtZW50YWwgKSA\/DQoJCQkJaW5jcmVtZW50YWwoIGkgKSA6DQoJCQkJTWF0aC5mbG9vciggaSAqIGkgKiBpIC8gNTAwMDAgLSBpICogaSAvIDUwMCArIDE3ICogaSAvIDIwMCArIDEgKTsNCgkJfQ0KDQoJCXJldHVybiAxOw0KCX0sDQoNCglfcHJlY2lzaW9uOiBmdW5jdGlvbigpIHsNCgkJdmFyIHByZWNpc2lvbiA9IHRoaXMuX3ByZWNpc2lvbk9mKCB0aGlzLm9wdGlvbnMuc3RlcCApOw0KCQlpZiAoIHRoaXMub3B0aW9ucy5taW4gIT09IG51bGwgKSB7DQoJCQlwcmVjaXNpb24gPSBNYXRoLm1heCggcHJlY2lzaW9uLCB0aGlzLl9wcmVjaXNpb25PZiggdGhpcy5vcHRpb25zLm1pbiApICk7DQoJCX0NCgkJcmV0dXJuIHByZWNpc2lvbjsNCgl9LA0KDQoJX3ByZWNpc2lvbk9mOiBmdW5jdGlvbiggbnVtICkgew0KCQl2YXIgc3RyID0gbnVtLnRvU3RyaW5nKCksDQoJCQlkZWNpbWFsID0gc3RyLmluZGV4T2YoICIuIiApOw0KCQlyZXR1cm4gZGVjaW1hbCA9PT0gLTEgPyAwIDogc3RyLmxlbmd0aCAtIGRlY2ltYWwgLSAxOw0KCX0sDQoNCglfYWRqdXN0VmFsdWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsNCgkJdmFyIGJhc2UsIGFib3ZlTWluLA0KCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsNCg0KCQkvLyBNYWtlIHN1cmUgd2UncmUgYXQgYSB2YWxpZCBzdGVwDQoJCS8vIC0gZmluZCBvdXQgd2hlcmUgd2UgYXJlIHJlbGF0aXZlIHRvIHRoZSBiYXNlIChtaW4gb3IgMCkNCgkJYmFzZSA9IG9wdGlvbnMubWluICE9PSBudWxsID8gb3B0aW9ucy5taW4gOiAwOw0KCQlhYm92ZU1pbiA9IHZhbHVlIC0gYmFzZTsNCg0KCQkvLyAtIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXANCgkJYWJvdmVNaW4gPSBNYXRoLnJvdW5kKCBhYm92ZU1pbiAvIG9wdGlvbnMuc3RlcCApICogb3B0aW9ucy5zdGVwOw0KDQoJCS8vIC0gcm91bmRpbmcgaXMgYmFzZWQgb24gMCwgc28gYWRqdXN0IGJhY2sgdG8gb3VyIGJhc2UNCgkJdmFsdWUgPSBiYXNlICsgYWJvdmVNaW47DQoNCgkJLy8gRml4IHByZWNpc2lvbiBmcm9tIGJhZCBKUyBmbG9hdGluZyBwb2ludCBtYXRoDQoJCXZhbHVlID0gcGFyc2VGbG9hdCggdmFsdWUudG9GaXhlZCggdGhpcy5fcHJlY2lzaW9uKCkgKSApOw0KDQoJCS8vIENsYW1wIHRoZSB2YWx1ZQ0KCQlpZiAoIG9wdGlvbnMubWF4ICE9PSBudWxsICYmIHZhbHVlID4gb3B0aW9ucy5tYXggKSB7DQoJCQlyZXR1cm4gb3B0aW9ucy5tYXg7DQoJCX0NCgkJaWYgKCBvcHRpb25zLm1pbiAhPT0gbnVsbCAmJiB2YWx1ZSA8IG9wdGlvbnMubWluICkgew0KCQkJcmV0dXJuIG9wdGlvbnMubWluOw0KCQl9DQoNCgkJcmV0dXJuIHZhbHVlOw0KCX0sDQoNCglfc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoICF0aGlzLnNwaW5uaW5nICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7DQoJCWNsZWFyVGltZW91dCggdGhpcy5tb3VzZXdoZWVsVGltZXIgKTsNCgkJdGhpcy5jb3VudGVyID0gMDsNCgkJdGhpcy5zcGlubmluZyA9IGZhbHNlOw0KCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50ICk7DQoJfSwNCg0KCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQl2YXIgcHJldlZhbHVlLCBmaXJzdCwgbGFzdDsNCg0KCQlpZiAoIGtleSA9PT0gImN1bHR1cmUiIHx8IGtleSA9PT0gIm51bWJlckZvcm1hdCIgKSB7DQoJCQlwcmV2VmFsdWUgPSB0aGlzLl9wYXJzZSggdGhpcy5lbGVtZW50LnZhbCgpICk7DQoJCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7DQoJCQl0aGlzLmVsZW1lbnQudmFsKCB0aGlzLl9mb3JtYXQoIHByZXZWYWx1ZSApICk7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlpZiAoIGtleSA9PT0gIm1heCIgfHwga2V5ID09PSAibWluIiB8fCBrZXkgPT09ICJzdGVwIiApIHsNCgkJCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiApIHsNCgkJCQl2YWx1ZSA9IHRoaXMuX3BhcnNlKCB2YWx1ZSApOw0KCQkJfQ0KCQl9DQoJCWlmICgga2V5ID09PSAiaWNvbnMiICkgew0KCQkJZmlyc3QgPSB0aGlzLmJ1dHRvbnMuZmlyc3QoKS5maW5kKCAiLnVpLWljb24iICk7DQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggZmlyc3QsIG51bGwsIHRoaXMub3B0aW9ucy5pY29ucy51cCApOw0KCQkJdGhpcy5fYWRkQ2xhc3MoIGZpcnN0LCBudWxsLCB2YWx1ZS51cCApOw0KCQkJbGFzdCA9IHRoaXMuYnV0dG9ucy5sYXN0KCkuZmluZCggIi51aS1pY29uIiApOw0KCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGxhc3QsIG51bGwsIHRoaXMub3B0aW9ucy5pY29ucy5kb3duICk7DQoJCQl0aGlzLl9hZGRDbGFzcyggbGFzdCwgbnVsbCwgdmFsdWUuZG93biApOw0KCQl9DQoNCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsNCgl9LA0KDQoJX3NldE9wdGlvbkRpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCXRoaXMuX3N1cGVyKCB2YWx1ZSApOw0KDQoJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLnVpU3Bpbm5lciwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApOw0KCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISF2YWx1ZSApOw0KCQl0aGlzLmJ1dHRvbnMuYnV0dG9uKCB2YWx1ZSA\/ICJkaXNhYmxlIiA6ICJlbmFibGUiICk7DQoJfSwNCg0KCV9zZXRPcHRpb25zOiBzcGlubmVyTW9kaWZlciggZnVuY3Rpb24oIG9wdGlvbnMgKSB7DQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7DQoJfSApLA0KDQoJX3BhcnNlOiBmdW5jdGlvbiggdmFsICkgew0KCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJzdHJpbmciICYmIHZhbCAhPT0gIiIgKSB7DQoJCQl2YWwgPSB3aW5kb3cuR2xvYmFsaXplICYmIHRoaXMub3B0aW9ucy5udW1iZXJGb3JtYXQgPw0KCQkJCUdsb2JhbGl6ZS5wYXJzZUZsb2F0KCB2YWwsIDEwLCB0aGlzLm9wdGlvbnMuY3VsdHVyZSApIDogK3ZhbDsNCgkJfQ0KCQlyZXR1cm4gdmFsID09PSAiIiB8fCBpc05hTiggdmFsICkgPyBudWxsIDogdmFsOw0KCX0sDQoNCglfZm9ybWF0OiBmdW5jdGlvbiggdmFsdWUgKSB7DQoJCWlmICggdmFsdWUgPT09ICIiICkgew0KCQkJcmV0dXJuICIiOw0KCQl9DQoJCXJldHVybiB3aW5kb3cuR2xvYmFsaXplICYmIHRoaXMub3B0aW9ucy5udW1iZXJGb3JtYXQgPw0KCQkJR2xvYmFsaXplLmZvcm1hdCggdmFsdWUsIHRoaXMub3B0aW9ucy5udW1iZXJGb3JtYXQsIHRoaXMub3B0aW9ucy5jdWx0dXJlICkgOg0KCQkJdmFsdWU7DQoJfSwNCg0KCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5lbGVtZW50LmF0dHIoIHsNCgkJCSJhcmlhLXZhbHVlbWluIjogdGhpcy5vcHRpb25zLm1pbiwNCgkJCSJhcmlhLXZhbHVlbWF4IjogdGhpcy5vcHRpb25zLm1heCwNCg0KCQkJLy8gVE9ETzogd2hhdCBzaG91bGQgd2UgZG8gd2l0aCB2YWx1ZXMgdGhhdCBjYW4ndCBiZSBwYXJzZWQ\/DQoJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3BhcnNlKCB0aGlzLmVsZW1lbnQudmFsKCkgKQ0KCQl9ICk7DQoJfSwNCg0KCWlzVmFsaWQ6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdmFsdWUgPSB0aGlzLnZhbHVlKCk7DQoNCgkJLy8gTnVsbCBpcyBpbnZhbGlkDQoJCWlmICggdmFsdWUgPT09IG51bGwgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQkvLyBJZiB2YWx1ZSBnZXRzIGFkanVzdGVkLCBpdCdzIGludmFsaWQNCgkJcmV0dXJuIHZhbHVlID09PSB0aGlzLl9hZGp1c3RWYWx1ZSggdmFsdWUgKTsNCgl9LA0KDQoJLy8gVXBkYXRlIHRoZSB2YWx1ZSB3aXRob3V0IHRyaWdnZXJpbmcgY2hhbmdlDQoJX3ZhbHVlOiBmdW5jdGlvbiggdmFsdWUsIGFsbG93QW55ICkgew0KCQl2YXIgcGFyc2VkOw0KCQlpZiAoIHZhbHVlICE9PSAiIiApIHsNCgkJCXBhcnNlZCA9IHRoaXMuX3BhcnNlKCB2YWx1ZSApOw0KCQkJaWYgKCBwYXJzZWQgIT09IG51bGwgKSB7DQoJCQkJaWYgKCAhYWxsb3dBbnkgKSB7DQoJCQkJCXBhcnNlZCA9IHRoaXMuX2FkanVzdFZhbHVlKCBwYXJzZWQgKTsNCgkJCQl9DQoJCQkJdmFsdWUgPSB0aGlzLl9mb3JtYXQoIHBhcnNlZCApOw0KCQkJfQ0KCQl9DQoJCXRoaXMuZWxlbWVudC52YWwoIHZhbHVlICk7DQoJCXRoaXMuX3JlZnJlc2goKTsNCgl9LA0KDQoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgew0KCQl0aGlzLmVsZW1lbnQNCgkJCS5wcm9wKCAiZGlzYWJsZWQiLCBmYWxzZSApDQoJCQkucmVtb3ZlQXR0ciggImF1dG9jb21wbGV0ZSByb2xlIGFyaWEtdmFsdWVtaW4gYXJpYS12YWx1ZW1heCBhcmlhLXZhbHVlbm93IiApOw0KDQoJCXRoaXMudWlTcGlubmVyLnJlcGxhY2VXaXRoKCB0aGlzLmVsZW1lbnQgKTsNCgl9LA0KDQoJc3RlcFVwOiBzcGlubmVyTW9kaWZlciggZnVuY3Rpb24oIHN0ZXBzICkgew0KCQl0aGlzLl9zdGVwVXAoIHN0ZXBzICk7DQoJfSApLA0KCV9zdGVwVXA6IGZ1bmN0aW9uKCBzdGVwcyApIHsNCgkJaWYgKCB0aGlzLl9zdGFydCgpICkgew0KCQkJdGhpcy5fc3BpbiggKCBzdGVwcyB8fCAxICkgKiB0aGlzLm9wdGlvbnMuc3RlcCApOw0KCQkJdGhpcy5fc3RvcCgpOw0KCQl9DQoJfSwNCg0KCXN0ZXBEb3duOiBzcGlubmVyTW9kaWZlciggZnVuY3Rpb24oIHN0ZXBzICkgew0KCQl0aGlzLl9zdGVwRG93biggc3RlcHMgKTsNCgl9ICksDQoJX3N0ZXBEb3duOiBmdW5jdGlvbiggc3RlcHMgKSB7DQoJCWlmICggdGhpcy5fc3RhcnQoKSApIHsNCgkJCXRoaXMuX3NwaW4oICggc3RlcHMgfHwgMSApICogLXRoaXMub3B0aW9ucy5zdGVwICk7DQoJCQl0aGlzLl9zdG9wKCk7DQoJCX0NCgl9LA0KDQoJcGFnZVVwOiBzcGlubmVyTW9kaWZlciggZnVuY3Rpb24oIHBhZ2VzICkgew0KCQl0aGlzLl9zdGVwVXAoICggcGFnZXMgfHwgMSApICogdGhpcy5vcHRpb25zLnBhZ2UgKTsNCgl9ICksDQoNCglwYWdlRG93bjogc3Bpbm5lck1vZGlmZXIoIGZ1bmN0aW9uKCBwYWdlcyApIHsNCgkJdGhpcy5fc3RlcERvd24oICggcGFnZXMgfHwgMSApICogdGhpcy5vcHRpb25zLnBhZ2UgKTsNCgl9ICksDQoNCgl2YWx1ZTogZnVuY3Rpb24oIG5ld1ZhbCApIHsNCgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsNCgkJCXJldHVybiB0aGlzLl9wYXJzZSggdGhpcy5lbGVtZW50LnZhbCgpICk7DQoJCX0NCgkJc3Bpbm5lck1vZGlmZXIoIHRoaXMuX3ZhbHVlICkuY2FsbCggdGhpcywgbmV3VmFsICk7DQoJfSwNCg0KCXdpZGdldDogZnVuY3Rpb24oKSB7DQoJCXJldHVybiB0aGlzLnVpU3Bpbm5lcjsNCgl9DQp9ICk7DQoNCi8vIERFUFJFQ0FURUQNCi8vIFRPRE86IHN3aXRjaCByZXR1cm4gYmFjayB0byB3aWRnZXQgZGVjbGFyYXRpb24gYXQgdG9wIG9mIGZpbGUgd2hlbiB0aGlzIGlzIHJlbW92ZWQNCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgew0KDQoJLy8gQmFja2NvbXBhdCBmb3Igc3Bpbm5lciBodG1sIGV4dGVuc2lvbiBwb2ludHMNCgkkLndpZGdldCggInVpLnNwaW5uZXIiLCAkLnVpLnNwaW5uZXIsIHsNCgkJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgew0KCQkJdGhpcy51aVNwaW5uZXIgPSB0aGlzLmVsZW1lbnQNCgkJCQkuYXR0ciggImF1dG9jb21wbGV0ZSIsICJvZmYiICkNCgkJCQkud3JhcCggdGhpcy5fdWlTcGlubmVySHRtbCgpICkNCgkJCQkucGFyZW50KCkNCg0KCQkJCQkvLyBBZGQgYnV0dG9ucw0KCQkJCQkuYXBwZW5kKCB0aGlzLl9idXR0b25IdG1sKCkgKTsNCgkJfSwNCgkJX3VpU3Bpbm5lckh0bWw6IGZ1bmN0aW9uKCkgew0KCQkJcmV0dXJuICI8c3Bhbj4iOw0KCQl9LA0KDQoJCV9idXR0b25IdG1sOiBmdW5jdGlvbigpIHsNCgkJCXJldHVybiAiPGE+PC9hPjxhPjwvYT4iOw0KCQl9DQoJfSApOw0KfQ0KDQp2YXIgd2lkZ2V0c1NwaW5uZXIgPSAkLnVpLnNwaW5uZXI7DQoNCg0KLyohDQogKiBqUXVlcnkgVUkgVGFicyAxLjEyLjENCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20NCiAqDQogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycw0KICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLg0KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQ0KICovDQoNCi8vPj5sYWJlbDogVGFicw0KLy8+Pmdyb3VwOiBXaWRnZXRzDQovLz4+ZGVzY3JpcHRpb246IFRyYW5zZm9ybXMgYSBzZXQgb2YgY29udGFpbmVyIGVsZW1lbnRzIGludG8gYSB0YWIgc3RydWN0dXJlLg0KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RhYnMvDQovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vdGFicy8NCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3RhYnMuY3NzDQovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MNCg0KDQoNCiQud2lkZ2V0KCAidWkudGFicyIsIHsNCgl2ZXJzaW9uOiAiMS4xMi4xIiwNCglkZWxheTogMzAwLA0KCW9wdGlvbnM6IHsNCgkJYWN0aXZlOiBudWxsLA0KCQljbGFzc2VzOiB7DQoJCQkidWktdGFicyI6ICJ1aS1jb3JuZXItYWxsIiwNCgkJCSJ1aS10YWJzLW5hdiI6ICJ1aS1jb3JuZXItYWxsIiwNCgkJCSJ1aS10YWJzLXBhbmVsIjogInVpLWNvcm5lci1ib3R0b20iLA0KCQkJInVpLXRhYnMtdGFiIjogInVpLWNvcm5lci10b3AiDQoJCX0sDQoJCWNvbGxhcHNpYmxlOiBmYWxzZSwNCgkJZXZlbnQ6ICJjbGljayIsDQoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsDQoJCWhpZGU6IG51bGwsDQoJCXNob3c6IG51bGwsDQoNCgkJLy8gQ2FsbGJhY2tzDQoJCWFjdGl2YXRlOiBudWxsLA0KCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwNCgkJYmVmb3JlTG9hZDogbnVsbCwNCgkJbG9hZDogbnVsbA0KCX0sDQoNCglfaXNMb2NhbDogKCBmdW5jdGlvbigpIHsNCgkJdmFyIHJoYXNoID0gLyMuKiQvOw0KDQoJCXJldHVybiBmdW5jdGlvbiggYW5jaG9yICkgew0KCQkJdmFyIGFuY2hvclVybCwgbG9jYXRpb25Vcmw7DQoNCgkJCWFuY2hvclVybCA9IGFuY2hvci5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApOw0KCQkJbG9jYXRpb25VcmwgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApOw0KDQoJCQkvLyBEZWNvZGluZyBtYXkgdGhyb3cgYW4gZXJyb3IgaWYgdGhlIFVSTCBpc24ndCBVVEYtOCAoIzk1MTgpDQoJCQl0cnkgew0KCQkJCWFuY2hvclVybCA9IGRlY29kZVVSSUNvbXBvbmVudCggYW5jaG9yVXJsICk7DQoJCQl9IGNhdGNoICggZXJyb3IgKSB7fQ0KCQkJdHJ5IHsNCgkJCQlsb2NhdGlvblVybCA9IGRlY29kZVVSSUNvbXBvbmVudCggbG9jYXRpb25VcmwgKTsNCgkJCX0gY2F0Y2ggKCBlcnJvciApIHt9DQoNCgkJCXJldHVybiBhbmNob3IuaGFzaC5sZW5ndGggPiAxICYmIGFuY2hvclVybCA9PT0gbG9jYXRpb25Vcmw7DQoJCX07DQoJfSApKCksDQoNCglfY3JlYXRlOiBmdW5jdGlvbigpIHsNCgkJdmFyIHRoYXQgPSB0aGlzLA0KCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsNCg0KCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggInVpLXRhYnMiLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IiApOw0KCQl0aGlzLl90b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCBudWxsLCBvcHRpb25zLmNvbGxhcHNpYmxlICk7DQoNCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsNCgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7DQoNCgkJLy8gVGFrZSBkaXNhYmxpbmcgdGFicyB2aWEgY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTA0KCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuDQoJCWlmICggJC5pc0FycmF5KCBvcHRpb25zLmRpc2FibGVkICkgKSB7DQoJCQlvcHRpb25zLmRpc2FibGVkID0gJC51bmlxdWUoIG9wdGlvbnMuZGlzYWJsZWQuY29uY2F0KA0KCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7DQoJCQkJCXJldHVybiB0aGF0LnRhYnMuaW5kZXgoIGxpICk7DQoJCQkJfSApDQoJCQkpICkuc29ydCgpOw0KCQl9DQoNCgkJLy8gQ2hlY2sgZm9yIGxlbmd0aCBhdm9pZHMgZXJyb3Igd2hlbiBpbml0aWFsaXppbmcgZW1wdHkgbGlzdA0KCQlpZiAoIHRoaXMub3B0aW9ucy5hY3RpdmUgIT09IGZhbHNlICYmIHRoaXMuYW5jaG9ycy5sZW5ndGggKSB7DQoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7DQoJCX0gZWxzZSB7DQoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsNCgkJfQ0KDQoJCXRoaXMuX3JlZnJlc2goKTsNCg0KCQlpZiAoIHRoaXMuYWN0aXZlLmxlbmd0aCApIHsNCgkJCXRoaXMubG9hZCggb3B0aW9ucy5hY3RpdmUgKTsNCgkJfQ0KCX0sDQoNCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7DQoJCXZhciBhY3RpdmUgPSB0aGlzLm9wdGlvbnMuYWN0aXZlLA0KCQkJY29sbGFwc2libGUgPSB0aGlzLm9wdGlvbnMuY29sbGFwc2libGUsDQoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOw0KDQoJCWlmICggYWN0aXZlID09PSBudWxsICkgew0KDQoJCQkvLyBjaGVjayB0aGUgZnJhZ21lbnQgaWRlbnRpZmllciBpbiB0aGUgVVJMDQoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsNCgkJCQl0aGlzLnRhYnMuZWFjaCggZnVuY3Rpb24oIGksIHRhYiApIHsNCgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgew0KCQkJCQkJYWN0aXZlID0gaTsNCgkJCQkJCXJldHVybiBmYWxzZTsNCgkJCQkJfQ0KCQkJCX0gKTsNCgkJCX0NCg0KCQkJLy8gQ2hlY2sgZm9yIGEgdGFiIG1hcmtlZCBhY3RpdmUgdmlhIGEgY2xhc3MNCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgew0KCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmZpbHRlciggIi51aS10YWJzLWFjdGl2ZSIgKSApOw0KCQkJfQ0KDQoJCQkvLyBObyBhY3RpdmUgdGFiLCBzZXQgdG8gZmFsc2UNCgkJCWlmICggYWN0aXZlID09PSBudWxsIHx8IGFjdGl2ZSA9PT0gLTEgKSB7DQoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA\/IDAgOiBmYWxzZTsNCgkJCX0NCgkJfQ0KDQoJCS8vIEhhbmRsZSBudW1iZXJzOiBuZWdhdGl2ZSwgb3V0IG9mIHJhbmdlDQoJCWlmICggYWN0aXZlICE9PSBmYWxzZSApIHsNCgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOw0KCQkJaWYgKCBhY3RpdmUgPT09IC0xICkgew0KCQkJCWFjdGl2ZSA9IGNvbGxhcHNpYmxlID8gZmFsc2UgOiAwOw0KCQkJfQ0KCQl9DQoNCgkJLy8gRG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlDQoJCWlmICggIWNvbGxhcHNpYmxlICYmIGFjdGl2ZSA9PT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsNCgkJCWFjdGl2ZSA9IDA7DQoJCX0NCg0KCQlyZXR1cm4gYWN0aXZlOw0KCX0sDQoNCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHsNCgkJCXRhYjogdGhpcy5hY3RpdmUsDQoJCQlwYW5lbDogIXRoaXMuYWN0aXZlLmxlbmd0aCA\/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApDQoJCX07DQoJfSwNCg0KCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBmb2N1c2VkVGFiID0gJCggJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgKS5jbG9zZXN0KCAibGkiICksDQoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy50YWJzLmluZGV4KCBmb2N1c2VkVGFiICksDQoJCQlnb2luZ0ZvcndhcmQgPSB0cnVlOw0KDQoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7DQoJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOg0KCQljYXNlICQudWkua2V5Q29kZS5ET1dOOg0KCQkJc2VsZWN0ZWRJbmRleCsrOw0KCQkJYnJlYWs7DQoJCWNhc2UgJC51aS5rZXlDb2RlLlVQOg0KCQljYXNlICQudWkua2V5Q29kZS5MRUZUOg0KCQkJZ29pbmdGb3J3YXJkID0gZmFsc2U7DQoJCQlzZWxlY3RlZEluZGV4LS07DQoJCQlicmVhazsNCgkJY2FzZSAkLnVpLmtleUNvZGUuRU5EOg0KCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuYW5jaG9ycy5sZW5ndGggLSAxOw0KCQkJYnJlYWs7DQoJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6DQoJCQlzZWxlY3RlZEluZGV4ID0gMDsNCgkJCWJyZWFrOw0KCQljYXNlICQudWkua2V5Q29kZS5TUEFDRToNCg0KCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZw0KCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7DQoJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOw0KCQkJcmV0dXJuOw0KCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoNCg0KCQkJLy8gVG9nZ2xlIChjYW5jZWwgZGVsYXllZCBhY3RpdmF0aW9uLCBhbGxvdyBjb2xsYXBzaW5nKQ0KCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7DQoNCgkJCS8vIERldGVybWluZSBpZiB3ZSBzaG91bGQgY29sbGFwc2Ugb3IgYWN0aXZhdGUNCgkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ID09PSB0aGlzLm9wdGlvbnMuYWN0aXZlID8gZmFsc2UgOiBzZWxlY3RlZEluZGV4ICk7DQoJCQlyZXR1cm47DQoJCWRlZmF1bHQ6DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBGb2N1cyB0aGUgYXBwcm9wcmlhdGUgdGFiLCBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQNCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsNCgkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuX2ZvY3VzTmV4dFRhYiggc2VsZWN0ZWRJbmRleCwgZ29pbmdGb3J3YXJkICk7DQoNCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wvY29tbWFuZCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uDQoJCWlmICggIWV2ZW50LmN0cmxLZXkgJiYgIWV2ZW50Lm1ldGFLZXkgKSB7DQoNCgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLg0KCQkJLy8gT3RoZXJ3aXNlIEFUIG1heSBjb25mdXNlIHRoZSB1c2VyIGJ5IHN0YXRpbmcgdGhhdCB0aGV5IG5lZWQgdG8gYWN0aXZhdGUgdGhlIHRhYiwNCgkJCS8vIGJ1dCB0aGUgdGFiIHdpbGwgYWxyZWFkeSBiZSBhY3RpdmF0ZWQgYnkgdGhlIHRpbWUgdGhlIGFubm91bmNlbWVudCBmaW5pc2hlcy4NCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7DQoJCQl0aGlzLnRhYnMuZXEoIHNlbGVjdGVkSW5kZXggKS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJ0cnVlIiApOw0KDQoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7DQoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7DQoJCQl9LCB0aGlzLmRlbGF5ICk7DQoJCX0NCgl9LA0KDQoJX3BhbmVsS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBDdHJsK3VwIG1vdmVzIGZvY3VzIHRvIHRoZSBjdXJyZW50IHRhYg0KCQlpZiAoIGV2ZW50LmN0cmxLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlVQICkgew0KCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCXRoaXMuYWN0aXZlLnRyaWdnZXIoICJmb2N1cyIgKTsNCgkJfQ0KCX0sDQoNCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykNCglfaGFuZGxlUGFnZU5hdjogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9VUCApIHsNCgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7DQoJCQlyZXR1cm4gdHJ1ZTsNCgkJfQ0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgew0KCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSArIDEsIHRydWUgKSApOw0KCQkJcmV0dXJuIHRydWU7DQoJCX0NCgl9LA0KDQoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsNCgkJdmFyIGxhc3RUYWJJbmRleCA9IHRoaXMudGFicy5sZW5ndGggLSAxOw0KDQoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsNCgkJCWlmICggaW5kZXggPiBsYXN0VGFiSW5kZXggKSB7DQoJCQkJaW5kZXggPSAwOw0KCQkJfQ0KCQkJaWYgKCBpbmRleCA8IDAgKSB7DQoJCQkJaW5kZXggPSBsYXN0VGFiSW5kZXg7DQoJCQl9DQoJCQlyZXR1cm4gaW5kZXg7DQoJCX0NCg0KCQl3aGlsZSAoICQuaW5BcnJheSggY29uc3RyYWluKCksIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApICE9PSAtMSApIHsNCgkJCWluZGV4ID0gZ29pbmdGb3J3YXJkID8gaW5kZXggKyAxIDogaW5kZXggLSAxOw0KCQl9DQoNCgkJcmV0dXJuIGluZGV4Ow0KCX0sDQoNCglfZm9jdXNOZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsNCgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOw0KCQl0aGlzLnRhYnMuZXEoIGluZGV4ICkudHJpZ2dlciggImZvY3VzIiApOw0KCQlyZXR1cm4gaW5kZXg7DQoJfSwNCg0KCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgew0KCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7DQoNCgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zDQoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7DQoNCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7DQoJCQl0aGlzLl90b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCBudWxsLCB2YWx1ZSApOw0KDQoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwNCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgew0KCQkJCXRoaXMuX2FjdGl2YXRlKCAwICk7DQoJCQl9DQoJCX0NCg0KCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsNCgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOw0KCQl9DQoNCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7DQoJCQl0aGlzLl9zZXR1cEhlaWdodFN0eWxlKCB2YWx1ZSApOw0KCQl9DQoJfSwNCg0KCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsNCgkJcmV0dXJuIGhhc2ggPyBoYXNoLnJlcGxhY2UoIC9bISIkJSYnKCkqKywuXC86Ozw9Pj9AXFtcXVxeYHt8fX5dL2csICJcXCQmIiApIDogIiI7DQoJfSwNCg0KCXJlZnJlc2g6IGZ1bmN0aW9uKCkgew0KCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywNCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7DQoNCgkJLy8gR2V0IGRpc2FibGVkIHRhYnMgZnJvbSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MDQoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQ0KCQlvcHRpb25zLmRpc2FibGVkID0gJC5tYXAoIGxpcy5maWx0ZXIoICIudWktc3RhdGUtZGlzYWJsZWQiICksIGZ1bmN0aW9uKCB0YWIgKSB7DQoJCQlyZXR1cm4gbGlzLmluZGV4KCB0YWIgKTsNCgkJfSApOw0KDQoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7DQoNCgkJLy8gV2FzIGNvbGxhcHNlZCBvciBubyB0YWJzDQoJCWlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8ICF0aGlzLmFuY2hvcnMubGVuZ3RoICkgew0KCQkJb3B0aW9ucy5hY3RpdmUgPSBmYWxzZTsNCgkJCXRoaXMuYWN0aXZlID0gJCgpOw0KDQoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUNCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgew0KDQoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkDQoJCQlpZiAoIHRoaXMudGFicy5sZW5ndGggPT09IG9wdGlvbnMuZGlzYWJsZWQubGVuZ3RoICkgew0KCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7DQoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7DQoNCgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHRhYg0KCQkJfSBlbHNlIHsNCgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOw0KCQkJfQ0KDQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzDQoJCX0gZWxzZSB7DQoNCgkJCS8vIG1ha2Ugc3VyZSBhY3RpdmUgaW5kZXggaXMgY29ycmVjdA0KCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7DQoJCX0NCg0KCQl0aGlzLl9yZWZyZXNoKCk7DQoJfSwNCg0KCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fc2V0T3B0aW9uRGlzYWJsZWQoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApOw0KCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7DQoJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSApOw0KDQoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0ciggew0KCQkJImFyaWEtc2VsZWN0ZWQiOiAiZmFsc2UiLA0KCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLA0KCQkJdGFiSW5kZXg6IC0xDQoJCX0gKTsNCgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApDQoJCQkuaGlkZSgpDQoJCQkuYXR0ciggew0KCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIg0KCQkJfSApOw0KDQoJCS8vIE1ha2Ugc3VyZSBvbmUgdGFiIGlzIGluIHRoZSB0YWIgb3JkZXINCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgew0KCQkJdGhpcy50YWJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOw0KCQl9IGVsc2Ugew0KCQkJdGhpcy5hY3RpdmUNCgkJCQkuYXR0ciggew0KCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwNCgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsDQoJCQkJCXRhYkluZGV4OiAwDQoJCQkJfSApOw0KCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuYWN0aXZlLCAidWktdGFicy1hY3RpdmUiLCAidWktc3RhdGUtYWN0aXZlIiApOw0KCQkJdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkNCgkJCQkuc2hvdygpDQoJCQkJLmF0dHIoIHsNCgkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIg0KCQkJCX0gKTsNCgkJfQ0KCX0sDQoNCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9IHRoaXMsDQoJCQlwcmV2VGFicyA9IHRoaXMudGFicywNCgkJCXByZXZBbmNob3JzID0gdGhpcy5hbmNob3JzLA0KCQkJcHJldlBhbmVscyA9IHRoaXMucGFuZWxzOw0KDQoJCXRoaXMudGFibGlzdCA9IHRoaXMuX2dldExpc3QoKS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOw0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy50YWJsaXN0LCAidWktdGFicy1uYXYiLA0KCQkJInVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciIgKTsNCg0KCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sNCgkJdGhpcy50YWJsaXN0DQoJCQkub24oICJtb3VzZWRvd24iICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgIj4gbGkiLCBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJaWYgKCAkKCB0aGlzICkuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7DQoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQkJfQ0KCQkJfSApDQoNCgkJCS8vIFN1cHBvcnQ6IElFIDw5DQoJCQkvLyBQcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbiBpbiBtb3VzZWRvd24gZG9lc24ndCBwcmV2ZW50IElFDQoJCQkvLyBmcm9tIGZvY3VzaW5nIHRoZSBlbGVtZW50LCBzbyBpZiB0aGUgYW5jaG9yIGdldHMgZm9jdXNlZCwgYmx1ci4NCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZA0KCQkJLy8gZWxlbWVudCBzaW5jZSBjbGlja2luZyBvbiBhIG5vbi1mb2N1c2FibGUgZWxlbWVudCBzaG91bGQgZm9jdXMNCgkJCS8vIHRoZSBib2R5IGFueXdheS4NCgkJCS5vbiggImZvY3VzIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsICIudWktdGFicy1hbmNob3IiLCBmdW5jdGlvbigpIHsNCgkJCQlpZiAoICQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7DQoJCQkJCXRoaXMuYmx1cigpOw0KCQkJCX0NCgkJCX0gKTsNCg0KCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApDQoJCQkuYXR0ciggew0KCQkJCXJvbGU6ICJ0YWIiLA0KCQkJCXRhYkluZGV4OiAtMQ0KCQkJfSApOw0KCQl0aGlzLl9hZGRDbGFzcyggdGhpcy50YWJzLCAidWktdGFicy10YWIiLCAidWktc3RhdGUtZGVmYXVsdCIgKTsNCg0KCQl0aGlzLmFuY2hvcnMgPSB0aGlzLnRhYnMubWFwKCBmdW5jdGlvbigpIHsNCgkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOw0KCQl9ICkNCgkJCS5hdHRyKCB7DQoJCQkJcm9sZTogInByZXNlbnRhdGlvbiIsDQoJCQkJdGFiSW5kZXg6IC0xDQoJCQl9ICk7DQoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmFuY2hvcnMsICJ1aS10YWJzLWFuY2hvciIgKTsNCg0KCQl0aGlzLnBhbmVscyA9ICQoKTsNCg0KCQl0aGlzLmFuY2hvcnMuZWFjaCggZnVuY3Rpb24oIGksIGFuY2hvciApIHsNCgkJCXZhciBzZWxlY3RvciwgcGFuZWwsIHBhbmVsSWQsDQoJCQkJYW5jaG9ySWQgPSAkKCBhbmNob3IgKS51bmlxdWVJZCgpLmF0dHIoICJpZCIgKSwNCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksDQoJCQkJb3JpZ2luYWxBcmlhQ29udHJvbHMgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICk7DQoNCgkJCS8vIElubGluZSB0YWINCgkJCWlmICggdGhhdC5faXNMb2NhbCggYW5jaG9yICkgKSB7DQoJCQkJc2VsZWN0b3IgPSBhbmNob3IuaGFzaDsNCgkJCQlwYW5lbElkID0gc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICk7DQoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggdGhhdC5fc2FuaXRpemVTZWxlY3Rvciggc2VsZWN0b3IgKSApOw0KDQoJCQkvLyByZW1vdGUgdGFiDQoJCQl9IGVsc2Ugew0KDQoJCQkJLy8gSWYgdGhlIHRhYiBkb2Vzbid0IGFscmVhZHkgaGF2ZSBhcmlhLWNvbnRyb2xzLA0KCQkJCS8vIGdlbmVyYXRlIGFuIGlkIGJ5IHVzaW5nIGEgdGhyb3ctYXdheSBlbGVtZW50DQoJCQkJcGFuZWxJZCA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAkKCB7fSApLnVuaXF1ZUlkKClbIDAgXS5pZDsNCgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7DQoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggc2VsZWN0b3IgKTsNCgkJCQlpZiAoICFwYW5lbC5sZW5ndGggKSB7DQoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsNCgkJCQkJcGFuZWwuaW5zZXJ0QWZ0ZXIoIHRoYXQucGFuZWxzWyBpIC0gMSBdIHx8IHRoYXQudGFibGlzdCApOw0KCQkJCX0NCgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsNCgkJCX0NCg0KCQkJaWYgKCBwYW5lbC5sZW5ndGggKSB7DQoJCQkJdGhhdC5wYW5lbHMgPSB0aGF0LnBhbmVscy5hZGQoIHBhbmVsICk7DQoJCQl9DQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgew0KCQkJCXRhYi5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiwgb3JpZ2luYWxBcmlhQ29udHJvbHMgKTsNCgkJCX0NCgkJCXRhYi5hdHRyKCB7DQoJCQkJImFyaWEtY29udHJvbHMiOiBwYW5lbElkLA0KCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZA0KCQkJfSApOw0KCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGFuY2hvcklkICk7DQoJCX0gKTsNCg0KCQl0aGlzLnBhbmVscy5hdHRyKCAicm9sZSIsICJ0YWJwYW5lbCIgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMucGFuZWxzLCAidWktdGFicy1wYW5lbCIsICJ1aS13aWRnZXQtY29udGVudCIgKTsNCg0KCQkvLyBBdm9pZCBtZW1vcnkgbGVha3MgKCMxMDA1NikNCgkJaWYgKCBwcmV2VGFicyApIHsNCgkJCXRoaXMuX29mZiggcHJldlRhYnMubm90KCB0aGlzLnRhYnMgKSApOw0KCQkJdGhpcy5fb2ZmKCBwcmV2QW5jaG9ycy5ub3QoIHRoaXMuYW5jaG9ycyApICk7DQoJCQl0aGlzLl9vZmYoIHByZXZQYW5lbHMubm90KCB0aGlzLnBhbmVscyApICk7DQoJCX0NCgl9LA0KDQoJLy8gQWxsb3cgb3ZlcnJpZGluZyBob3cgdG8gZmluZCB0aGUgbGlzdCBmb3IgcmFyZSB1c2FnZSBzY2VuYXJpb3MgKCM3NzE1KQ0KCV9nZXRMaXN0OiBmdW5jdGlvbigpIHsNCgkJcmV0dXJuIHRoaXMudGFibGlzdCB8fCB0aGlzLmVsZW1lbnQuZmluZCggIm9sLCB1bCIgKS5lcSggMCApOw0KCX0sDQoNCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsNCgkJcmV0dXJuICQoICI8ZGl2PiIgKQ0KCQkJLmF0dHIoICJpZCIsIGlkICkNCgkJCS5kYXRhKCAidWktdGFicy1kZXN0cm95IiwgdHJ1ZSApOw0KCX0sDQoNCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsNCgkJdmFyIGN1cnJlbnRJdGVtLCBsaSwgaTsNCg0KCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsNCgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsNCgkJCQlkaXNhYmxlZCA9IGZhbHNlOw0KCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgew0KCQkJCWRpc2FibGVkID0gdHJ1ZTsNCgkJCX0NCgkJfQ0KDQoJCS8vIERpc2FibGUgdGFicw0KCQlmb3IgKCBpID0gMDsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsNCgkJCWN1cnJlbnRJdGVtID0gJCggbGkgKTsNCgkJCWlmICggZGlzYWJsZWQgPT09IHRydWUgfHwgJC5pbkFycmF5KCBpLCBkaXNhYmxlZCApICE9PSAtMSApIHsNCgkJCQljdXJyZW50SXRlbS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsICJ0cnVlIiApOw0KCQkJCXRoaXMuX2FkZENsYXNzKCBjdXJyZW50SXRlbSwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiApOw0KCQkJfSBlbHNlIHsNCgkJCQljdXJyZW50SXRlbS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsNCgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggY3VycmVudEl0ZW0sIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsNCgkJCX0NCgkJfQ0KDQoJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOw0KDQoJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLndpZGdldCgpLCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCIsIG51bGwsDQoJCQlkaXNhYmxlZCA9PT0gdHJ1ZSApOw0KCX0sDQoNCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJdmFyIGV2ZW50cyA9IHt9Ow0KCQlpZiAoIGV2ZW50ICkgew0KCQkJJC5lYWNoKCBldmVudC5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgew0KCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7DQoJCQl9ICk7DQoJCX0NCg0KCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOw0KDQoJCS8vIEFsd2F5cyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFjdGlvbiwgZXZlbiB3aGVuIGRpc2FibGVkDQoJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmFuY2hvcnMsIHsNCgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCX0NCgkJfSApOw0KCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsNCgkJdGhpcy5fb24oIHRoaXMudGFicywgeyBrZXlkb3duOiAiX3RhYktleWRvd24iIH0gKTsNCgkJdGhpcy5fb24oIHRoaXMucGFuZWxzLCB7IGtleWRvd246ICJfcGFuZWxLZXlkb3duIiB9ICk7DQoNCgkJdGhpcy5fZm9jdXNhYmxlKCB0aGlzLnRhYnMgKTsNCgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLnRhYnMgKTsNCgl9LA0KDQoJX3NldHVwSGVpZ2h0U3R5bGU6IGZ1bmN0aW9uKCBoZWlnaHRTdHlsZSApIHsNCgkJdmFyIG1heEhlaWdodCwNCgkJCXBhcmVudCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsNCg0KCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7DQoJCQltYXhIZWlnaHQgPSBwYXJlbnQuaGVpZ2h0KCk7DQoJCQltYXhIZWlnaHQgLT0gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgLSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7DQoNCgkJCXRoaXMuZWxlbWVudC5zaWJsaW5ncyggIjp2aXNpYmxlIiApLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCXZhciBlbGVtID0gJCggdGhpcyApLA0KCQkJCQlwb3NpdGlvbiA9IGVsZW0uY3NzKCAicG9zaXRpb24iICk7DQoNCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgew0KCQkJCQlyZXR1cm47DQoJCQkJfQ0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7DQoJCQl9ICk7DQoNCgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbigpLm5vdCggdGhpcy5wYW5lbHMgKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7DQoJCQl9ICk7DQoNCgkJCXRoaXMucGFuZWxzLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQ0KCQkJCQkkKCB0aGlzICkuaW5uZXJIZWlnaHQoKSArICQoIHRoaXMgKS5oZWlnaHQoKSApICk7DQoJCQl9ICkNCgkJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsNCgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsNCgkJCW1heEhlaWdodCA9IDA7DQoJCQl0aGlzLnBhbmVscy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQltYXhIZWlnaHQgPSBNYXRoLm1heCggbWF4SGVpZ2h0LCAkKCB0aGlzICkuaGVpZ2h0KCAiIiApLmhlaWdodCgpICk7DQoJCQl9ICkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsNCgkJfQ0KCX0sDQoNCglfZXZlbnRIYW5kbGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLA0KCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsDQoJCQlhbmNob3IgPSAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksDQoJCQl0YWIgPSBhbmNob3IuY2xvc2VzdCggImxpIiApLA0KCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLA0KCQkJY29sbGFwc2luZyA9IGNsaWNrZWRJc0FjdGl2ZSAmJiBvcHRpb25zLmNvbGxhcHNpYmxlLA0KCQkJdG9TaG93ID0gY29sbGFwc2luZyA\/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwNCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLA0KCQkJZXZlbnREYXRhID0gew0KCQkJCW9sZFRhYjogYWN0aXZlLA0KCQkJCW9sZFBhbmVsOiB0b0hpZGUsDQoJCQkJbmV3VGFiOiBjb2xsYXBzaW5nID8gJCgpIDogdGFiLA0KCQkJCW5ld1BhbmVsOiB0b1Nob3cNCgkJCX07DQoNCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KCQlpZiAoIHRhYi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApIHx8DQoNCgkJCQkvLyB0YWIgaXMgYWxyZWFkeSBsb2FkaW5nDQoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8DQoNCgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24NCgkJCQl0aGlzLnJ1bm5pbmcgfHwNCg0KCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUNCgkJCQkoIGNsaWNrZWRJc0FjdGl2ZSAmJiAhb3B0aW9ucy5jb2xsYXBzaWJsZSApIHx8DQoNCgkJCQkvLyBhbGxvdyBjYW5jZWxpbmcgYWN0aXZhdGlvbg0KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLnRhYnMuaW5kZXgoIHRhYiApOw0KDQoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOw0KCQlpZiAoIHRoaXMueGhyICkgew0KCQkJdGhpcy54aHIuYWJvcnQoKTsNCgkJfQ0KDQoJCWlmICggIXRvSGlkZS5sZW5ndGggJiYgIXRvU2hvdy5sZW5ndGggKSB7DQoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOw0KCQl9DQoNCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgew0KCQkJdGhpcy5sb2FkKCB0aGlzLnRhYnMuaW5kZXgoIHRhYiApLCBldmVudCApOw0KCQl9DQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOw0KCX0sDQoNCgkvLyBIYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMNCglfdG9nZ2xlOiBmdW5jdGlvbiggZXZlbnQsIGV2ZW50RGF0YSApIHsNCgkJdmFyIHRoYXQgPSB0aGlzLA0KCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLA0KCQkJdG9IaWRlID0gZXZlbnREYXRhLm9sZFBhbmVsOw0KDQoJCXRoaXMucnVubmluZyA9IHRydWU7DQoNCgkJZnVuY3Rpb24gY29tcGxldGUoKSB7DQoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsNCgkJCXRoYXQuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKTsNCgkJfQ0KDQoJCWZ1bmN0aW9uIHNob3coKSB7DQoJCQl0aGF0Ll9hZGRDbGFzcyggZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICksICJ1aS10YWJzLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoNCgkJCWlmICggdG9TaG93Lmxlbmd0aCAmJiB0aGF0Lm9wdGlvbnMuc2hvdyApIHsNCgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOw0KCQkJfSBlbHNlIHsNCgkJCQl0b1Nob3cuc2hvdygpOw0KCQkJCWNvbXBsZXRlKCk7DQoJCQl9DQoJCX0NCg0KCQkvLyBTdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZw0KCQlpZiAoIHRvSGlkZS5sZW5ndGggJiYgdGhpcy5vcHRpb25zLmhpZGUgKSB7DQoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsNCgkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICksDQoJCQkJCSJ1aS10YWJzLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoJCQkJc2hvdygpOw0KCQkJfSApOw0KCQl9IGVsc2Ugew0KCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLA0KCQkJCSJ1aS10YWJzLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7DQoJCQl0b0hpZGUuaGlkZSgpOw0KCQkJc2hvdygpOw0KCQl9DQoNCgkJdG9IaWRlLmF0dHIoICJhcmlhLWhpZGRlbiIsICJ0cnVlIiApOw0KCQlldmVudERhdGEub2xkVGFiLmF0dHIoIHsNCgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwNCgkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIg0KCQl9ICk7DQoNCgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuDQoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4NCgkJLy8gSWYgd2UncmUgY29sbGFwc2luZywgdGhlbiBrZWVwIHRoZSBjb2xsYXBzaW5nIHRhYiBpbiB0aGUgdGFiIG9yZGVyLg0KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsNCgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsNCgkJfSBlbHNlIGlmICggdG9TaG93Lmxlbmd0aCApIHsNCgkJCXRoaXMudGFicy5maWx0ZXIoIGZ1bmN0aW9uKCkgew0KCQkJCXJldHVybiAkKCB0aGlzICkuYXR0ciggInRhYkluZGV4IiApID09PSAwOw0KCQkJfSApDQoJCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7DQoJCX0NCg0KCQl0b1Nob3cuYXR0ciggImFyaWEtaGlkZGVuIiwgImZhbHNlIiApOw0KCQlldmVudERhdGEubmV3VGFiLmF0dHIoIHsNCgkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLA0KCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsDQoJCQl0YWJJbmRleDogMA0KCQl9ICk7DQoJfSwNCg0KCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgew0KCQl2YXIgYW5jaG9yLA0KCQkJYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggaW5kZXggKTsNCg0KCQkvLyBUcnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsDQoJCWlmICggYWN0aXZlWyAwIF0gPT09IHRoaXMuYWN0aXZlWyAwIF0gKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBUcnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnQgYWN0aXZlIGhlYWRlcg0KCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgew0KCQkJYWN0aXZlID0gdGhpcy5hY3RpdmU7DQoJCX0NCg0KCQlhbmNob3IgPSBhY3RpdmUuZmluZCggIi51aS10YWJzLWFuY2hvciIgKVsgMCBdOw0KCQl0aGlzLl9ldmVudEhhbmRsZXIoIHsNCgkJCXRhcmdldDogYW5jaG9yLA0KCQkJY3VycmVudFRhcmdldDogYW5jaG9yLA0KCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcA0KCQl9ICk7DQoJfSwNCg0KCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7DQoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7DQoJfSwNCg0KCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgew0KDQoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguDQoJCWlmICggdHlwZW9mIGluZGV4ID09PSAic3RyaW5nIiApIHsNCgkJCWluZGV4ID0gdGhpcy5hbmNob3JzLmluZGV4KCB0aGlzLmFuY2hvcnMuZmlsdGVyKCAiW2hyZWYkPSciICsNCgkJCQkkLnVpLmVzY2FwZVNlbGVjdG9yKCBpbmRleCApICsgIiddIiApICk7DQoJCX0NCg0KCQlyZXR1cm4gaW5kZXg7DQoJfSwNCg0KCV9kZXN0cm95OiBmdW5jdGlvbigpIHsNCgkJaWYgKCB0aGlzLnhociApIHsNCgkJCXRoaXMueGhyLmFib3J0KCk7DQoJCX0NCg0KCQl0aGlzLnRhYmxpc3QNCgkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKQ0KCQkJLm9mZiggdGhpcy5ldmVudE5hbWVzcGFjZSApOw0KDQoJCXRoaXMuYW5jaG9ycw0KCQkJLnJlbW92ZUF0dHIoICJyb2xlIHRhYkluZGV4IiApDQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsNCg0KCQl0aGlzLnRhYnMuYWRkKCB0aGlzLnBhbmVscyApLmVhY2goIGZ1bmN0aW9uKCkgew0KCQkJaWYgKCAkLmRhdGEoIHRoaXMsICJ1aS10YWJzLWRlc3Ryb3kiICkgKSB7DQoJCQkJJCggdGhpcyApLnJlbW92ZSgpOw0KCQkJfSBlbHNlIHsNCgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggInJvbGUgdGFiSW5kZXggIiArDQoJCQkJCSJhcmlhLWxpdmUgYXJpYS1idXN5IGFyaWEtc2VsZWN0ZWQgYXJpYS1sYWJlbGxlZGJ5IGFyaWEtaGlkZGVuIGFyaWEtZXhwYW5kZWQiICk7DQoJCQl9DQoJCX0gKTsNCg0KCQl0aGlzLnRhYnMuZWFjaCggZnVuY3Rpb24oKSB7DQoJCQl2YXIgbGkgPSAkKCB0aGlzICksDQoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7DQoJCQlpZiAoIHByZXYgKSB7DQoJCQkJbGkNCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApDQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOw0KCQkJfSBlbHNlIHsNCgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsNCgkJCX0NCgkJfSApOw0KDQoJCXRoaXMucGFuZWxzLnNob3coKTsNCg0KCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgew0KCQkJdGhpcy5wYW5lbHMuY3NzKCAiaGVpZ2h0IiwgIiIgKTsNCgkJfQ0KCX0sDQoNCgllbmFibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsNCgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOw0KCQlpZiAoIGRpc2FibGVkID09PSBmYWxzZSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsNCgkJCWRpc2FibGVkID0gZmFsc2U7DQoJCX0gZWxzZSB7DQoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOw0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7DQoJCQkJZGlzYWJsZWQgPSAkLm1hcCggZGlzYWJsZWQsIGZ1bmN0aW9uKCBudW0gKSB7DQoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsNCgkJCQl9ICk7DQoJCQl9IGVsc2Ugew0KCQkJCWRpc2FibGVkID0gJC5tYXAoIHRoaXMudGFicywgZnVuY3Rpb24oIGxpLCBudW0gKSB7DQoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsNCgkJCQl9ICk7DQoJCQl9DQoJCX0NCgkJdGhpcy5fc2V0T3B0aW9uRGlzYWJsZWQoIGRpc2FibGVkICk7DQoJfSwNCg0KCWRpc2FibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsNCgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOw0KCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCBpbmRleCA9PT0gdW5kZWZpbmVkICkgew0KCQkJZGlzYWJsZWQgPSB0cnVlOw0KCQl9IGVsc2Ugew0KCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsNCgkJCWlmICggJC5pbkFycmF5KCBpbmRleCwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7DQoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOw0KCQkJfSBlbHNlIHsNCgkJCQlkaXNhYmxlZCA9IFsgaW5kZXggXTsNCgkJCX0NCgkJfQ0KCQl0aGlzLl9zZXRPcHRpb25EaXNhYmxlZCggZGlzYWJsZWQgKTsNCgl9LA0KDQoJbG9hZDogZnVuY3Rpb24oIGluZGV4LCBldmVudCApIHsNCgkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsNCgkJdmFyIHRoYXQgPSB0aGlzLA0KCQkJdGFiID0gdGhpcy50YWJzLmVxKCBpbmRleCApLA0KCQkJYW5jaG9yID0gdGFiLmZpbmQoICIudWktdGFicy1hbmNob3IiICksDQoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwNCgkJCWV2ZW50RGF0YSA9IHsNCgkJCQl0YWI6IHRhYiwNCgkJCQlwYW5lbDogcGFuZWwNCgkJCX0sDQoJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgew0KCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgew0KCQkJCQl0aGF0LnBhbmVscy5zdG9wKCBmYWxzZSwgdHJ1ZSApOw0KCQkJCX0NCg0KCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCB0YWIsICJ1aS10YWJzLWxvYWRpbmciICk7DQoJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsNCg0KCQkJCWlmICgganFYSFIgPT09IHRoYXQueGhyICkgew0KCQkJCQlkZWxldGUgdGhhdC54aHI7DQoJCQkJfQ0KCQkJfTsNCg0KCQkvLyBOb3QgcmVtb3RlDQoJCWlmICggdGhpcy5faXNMb2NhbCggYW5jaG9yWyAwIF0gKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7DQoNCgkJLy8gU3VwcG9ydDogalF1ZXJ5IDwxLjgNCgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLA0KCQkvLyBidXQgYXMgb2YgMS44LCAkLmFqYXgoKSBhbHdheXMgcmV0dXJucyBhIGpxWEhSIG9iamVjdC4NCgkJaWYgKCB0aGlzLnhociAmJiB0aGlzLnhoci5zdGF0dXNUZXh0ICE9PSAiY2FuY2VsZWQiICkgew0KCQkJdGhpcy5fYWRkQ2xhc3MoIHRhYiwgInVpLXRhYnMtbG9hZGluZyIgKTsNCgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsNCg0KCQkJdGhpcy54aHINCgkJCQkuZG9uZSggZnVuY3Rpb24oIHJlc3BvbnNlLCBzdGF0dXMsIGpxWEhSICkgew0KDQoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44DQoJCQkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzExNzc4DQoJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KCQkJCQkJcGFuZWwuaHRtbCggcmVzcG9uc2UgKTsNCgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOw0KDQoJCQkJCQljb21wbGV0ZSgganFYSFIsIHN0YXR1cyApOw0KCQkJCQl9LCAxICk7DQoJCQkJfSApDQoJCQkJLmZhaWwoIGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgew0KDQoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44DQoJCQkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzExNzc4DQoJCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KCQkJCQkJY29tcGxldGUoIGpxWEhSLCBzdGF0dXMgKTsNCgkJCQkJfSwgMSApOw0KCQkJCX0gKTsNCgkJfQ0KCX0sDQoNCglfYWpheFNldHRpbmdzOiBmdW5jdGlvbiggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgew0KCQl2YXIgdGhhdCA9IHRoaXM7DQoJCXJldHVybiB7DQoNCgkJCS8vIFN1cHBvcnQ6IElFIDwxMSBvbmx5DQoJCQkvLyBTdHJpcCBhbnkgaGFzaCB0aGF0IGV4aXN0cyB0byBwcmV2ZW50IGVycm9ycyB3aXRoIHRoZSBBamF4IHJlcXVlc3QNCgkJCXVybDogYW5jaG9yLmF0dHIoICJocmVmIiApLnJlcGxhY2UoIC8jLiokLywgIiIgKSwNCgkJCWJlZm9yZVNlbmQ6IGZ1bmN0aW9uKCBqcVhIUiwgc2V0dGluZ3MgKSB7DQoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsDQoJCQkJCSQuZXh0ZW5kKCB7IGpxWEhSOiBqcVhIUiwgYWpheFNldHRpbmdzOiBzZXR0aW5ncyB9LCBldmVudERhdGEgKSApOw0KCQkJfQ0KCQl9Ow0KCX0sDQoNCglfZ2V0UGFuZWxGb3JUYWI6IGZ1bmN0aW9uKCB0YWIgKSB7DQoJCXZhciBpZCA9ICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOw0KCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsNCgl9DQp9ICk7DQoNCi8vIERFUFJFQ0FURUQNCi8vIFRPRE86IFN3aXRjaCByZXR1cm4gYmFjayB0byB3aWRnZXQgZGVjbGFyYXRpb24gYXQgdG9wIG9mIGZpbGUgd2hlbiB0aGlzIGlzIHJlbW92ZWQNCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgew0KDQoJLy8gQmFja2NvbXBhdCBmb3IgdWktdGFiIGNsYXNzIChub3cgdWktdGFicy10YWIpDQoJJC53aWRnZXQoICJ1aS50YWJzIiwgJC51aS50YWJzLCB7DQoJCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7DQoJCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsNCgkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnRhYnMsICJ1aS10YWIiICk7DQoJCX0NCgl9ICk7DQp9DQoNCnZhciB3aWRnZXRzVGFicyA9ICQudWkudGFiczsNCg0KDQovKiENCiAqIGpRdWVyeSBVSSBUb29sdGlwIDEuMTIuMQ0KICogaHR0cDovL2pxdWVyeXVpLmNvbQ0KICoNCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzDQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlDQogKi8NCg0KLy8+PmxhYmVsOiBUb29sdGlwDQovLz4+Z3JvdXA6IFdpZGdldHMNCi8vPj5kZXNjcmlwdGlvbjogU2hvd3MgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiBmb3IgYW55IGVsZW1lbnQgb24gaG92ZXIgb3IgZm9jdXMuDQovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdG9vbHRpcC8NCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS90b29sdGlwLw0KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzDQovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvdG9vbHRpcC5jc3MNCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcw0KDQoNCg0KJC53aWRnZXQoICJ1aS50b29sdGlwIiwgew0KCXZlcnNpb246ICIxLjEyLjEiLA0KCW9wdGlvbnM6IHsNCgkJY2xhc3Nlczogew0KCQkJInVpLXRvb2x0aXAiOiAidWktY29ybmVyLWFsbCB1aS13aWRnZXQtc2hhZG93Ig0KCQl9LA0KCQljb250ZW50OiBmdW5jdGlvbigpIHsNCg0KCQkJLy8gc3VwcG9ydDogSUU8OSwgT3BlcmEgaW4galF1ZXJ5IDwxLjcNCgkJCS8vIC50ZXh0KCkgY2FuJ3QgYWNjZXB0IHVuZGVmaW5lZCwgc28gY29lcmNlIHRvIGEgc3RyaW5nDQoJCQl2YXIgdGl0bGUgPSAkKCB0aGlzICkuYXR0ciggInRpdGxlIiApIHx8ICIiOw0KDQoJCQkvLyBFc2NhcGUgdGl0bGUsIHNpbmNlIHdlJ3JlIGdvaW5nIGZyb20gYW4gYXR0cmlidXRlIHRvIHJhdyBIVE1MDQoJCQlyZXR1cm4gJCggIjxhPiIgKS50ZXh0KCB0aXRsZSApLmh0bWwoKTsNCgkJfSwNCgkJaGlkZTogdHJ1ZSwNCg0KCQkvLyBEaXNhYmxlZCBlbGVtZW50cyBoYXZlIGluY29uc2lzdGVudCBiZWhhdmlvciBhY3Jvc3MgYnJvd3NlcnMgKCM4NjYxKQ0KCQlpdGVtczogIlt0aXRsZV06bm90KFtkaXNhYmxlZF0pIiwNCgkJcG9zaXRpb246IHsNCgkJCW15OiAibGVmdCB0b3ArMTUiLA0KCQkJYXQ6ICJsZWZ0IGJvdHRvbSIsDQoJCQljb2xsaXNpb246ICJmbGlwZml0IGZsaXAiDQoJCX0sDQoJCXNob3c6IHRydWUsDQoJCXRyYWNrOiBmYWxzZSwNCg0KCQkvLyBDYWxsYmFja3MNCgkJY2xvc2U6IG51bGwsDQoJCW9wZW46IG51bGwNCgl9LA0KDQoJX2FkZERlc2NyaWJlZEJ5OiBmdW5jdGlvbiggZWxlbSwgaWQgKSB7DQoJCXZhciBkZXNjcmliZWRieSA9ICggZWxlbS5hdHRyKCAiYXJpYS1kZXNjcmliZWRieSIgKSB8fCAiIiApLnNwbGl0KCAvXHMrLyApOw0KCQlkZXNjcmliZWRieS5wdXNoKCBpZCApOw0KCQllbGVtDQoJCQkuZGF0YSggInVpLXRvb2x0aXAtaWQiLCBpZCApDQoJCQkuYXR0ciggImFyaWEtZGVzY3JpYmVkYnkiLCAkLnRyaW0oIGRlc2NyaWJlZGJ5LmpvaW4oICIgIiApICkgKTsNCgl9LA0KDQoJX3JlbW92ZURlc2NyaWJlZEJ5OiBmdW5jdGlvbiggZWxlbSApIHsNCgkJdmFyIGlkID0gZWxlbS5kYXRhKCAidWktdG9vbHRpcC1pZCIgKSwNCgkJCWRlc2NyaWJlZGJ5ID0gKCBlbGVtLmF0dHIoICJhcmlhLWRlc2NyaWJlZGJ5IiApIHx8ICIiICkuc3BsaXQoIC9ccysvICksDQoJCQlpbmRleCA9ICQuaW5BcnJheSggaWQsIGRlc2NyaWJlZGJ5ICk7DQoNCgkJaWYgKCBpbmRleCAhPT0gLTEgKSB7DQoJCQlkZXNjcmliZWRieS5zcGxpY2UoIGluZGV4LCAxICk7DQoJCX0NCg0KCQllbGVtLnJlbW92ZURhdGEoICJ1aS10b29sdGlwLWlkIiApOw0KCQlkZXNjcmliZWRieSA9ICQudHJpbSggZGVzY3JpYmVkYnkuam9pbiggIiAiICkgKTsNCgkJaWYgKCBkZXNjcmliZWRieSApIHsNCgkJCWVsZW0uYXR0ciggImFyaWEtZGVzY3JpYmVkYnkiLCBkZXNjcmliZWRieSApOw0KCQl9IGVsc2Ugew0KCQkJZWxlbS5yZW1vdmVBdHRyKCAiYXJpYS1kZXNjcmliZWRieSIgKTsNCgkJfQ0KCX0sDQoNCglfY3JlYXRlOiBmdW5jdGlvbigpIHsNCgkJdGhpcy5fb24oIHsNCgkJCW1vdXNlb3ZlcjogIm9wZW4iLA0KCQkJZm9jdXNpbjogIm9wZW4iDQoJCX0gKTsNCg0KCQkvLyBJRHMgb2YgZ2VuZXJhdGVkIHRvb2x0aXBzLCBuZWVkZWQgZm9yIGRlc3Ryb3kNCgkJdGhpcy50b29sdGlwcyA9IHt9Ow0KDQoJCS8vIElEcyBvZiBwYXJlbnQgdG9vbHRpcHMgd2hlcmUgd2UgcmVtb3ZlZCB0aGUgdGl0bGUgYXR0cmlidXRlDQoJCXRoaXMucGFyZW50cyA9IHt9Ow0KDQoJCS8vIEFwcGVuZCB0aGUgYXJpYS1saXZlIHJlZ2lvbiBzbyB0b29sdGlwcyBhbm5vdW5jZSBjb3JyZWN0bHkNCgkJdGhpcy5saXZlUmVnaW9uID0gJCggIjxkaXY+IiApDQoJCQkuYXR0ciggew0KCQkJCXJvbGU6ICJsb2ciLA0KCQkJCSJhcmlhLWxpdmUiOiAiYXNzZXJ0aXZlIiwNCgkJCQkiYXJpYS1yZWxldmFudCI6ICJhZGRpdGlvbnMiDQoJCQl9ICkNCgkJCS5hcHBlbmRUbyggdGhpcy5kb2N1bWVudFsgMCBdLmJvZHkgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGl2ZVJlZ2lvbiwgbnVsbCwgInVpLWhlbHBlci1oaWRkZW4tYWNjZXNzaWJsZSIgKTsNCg0KCQl0aGlzLmRpc2FibGVkVGl0bGVzID0gJCggW10gKTsNCgl9LA0KDQoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCg0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOw0KDQoJCWlmICgga2V5ID09PSAiY29udGVudCIgKSB7DQoJCQkkLmVhY2goIHRoaXMudG9vbHRpcHMsIGZ1bmN0aW9uKCBpZCwgdG9vbHRpcERhdGEgKSB7DQoJCQkJdGhhdC5fdXBkYXRlQ29udGVudCggdG9vbHRpcERhdGEuZWxlbWVudCApOw0KCQkJfSApOw0KCQl9DQoJfSwNCg0KCV9zZXRPcHRpb25EaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgew0KCQl0aGlzWyB2YWx1ZSA\/ICJfZGlzYWJsZSIgOiAiX2VuYWJsZSIgXSgpOw0KCX0sDQoNCglfZGlzYWJsZTogZnVuY3Rpb24oKSB7DQoJCXZhciB0aGF0ID0gdGhpczsNCg0KCQkvLyBDbG9zZSBvcGVuIHRvb2x0aXBzDQoJCSQuZWFjaCggdGhpcy50b29sdGlwcywgZnVuY3Rpb24oIGlkLCB0b29sdGlwRGF0YSApIHsNCgkJCXZhciBldmVudCA9ICQuRXZlbnQoICJibHVyIiApOw0KCQkJZXZlbnQudGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldCA9IHRvb2x0aXBEYXRhLmVsZW1lbnRbIDAgXTsNCgkJCXRoYXQuY2xvc2UoIGV2ZW50LCB0cnVlICk7DQoJCX0gKTsNCg0KCQkvLyBSZW1vdmUgdGl0bGUgYXR0cmlidXRlcyB0byBwcmV2ZW50IG5hdGl2ZSB0b29sdGlwcw0KCQl0aGlzLmRpc2FibGVkVGl0bGVzID0gdGhpcy5kaXNhYmxlZFRpdGxlcy5hZGQoDQoJCQl0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkuYWRkQmFjaygpDQoJCQkJLmZpbHRlciggZnVuY3Rpb24oKSB7DQoJCQkJCXZhciBlbGVtZW50ID0gJCggdGhpcyApOw0KCQkJCQlpZiAoIGVsZW1lbnQuaXMoICJbdGl0bGVdIiApICkgew0KCQkJCQkJcmV0dXJuIGVsZW1lbnQNCgkJCQkJCQkuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiLCBlbGVtZW50LmF0dHIoICJ0aXRsZSIgKSApDQoJCQkJCQkJLnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsNCgkJCQkJfQ0KCQkJCX0gKQ0KCQkpOw0KCX0sDQoNCglfZW5hYmxlOiBmdW5jdGlvbigpIHsNCg0KCQkvLyByZXN0b3JlIHRpdGxlIGF0dHJpYnV0ZXMNCgkJdGhpcy5kaXNhYmxlZFRpdGxlcy5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCXZhciBlbGVtZW50ID0gJCggdGhpcyApOw0KCQkJaWYgKCBlbGVtZW50LmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiApICkgew0KCQkJCWVsZW1lbnQuYXR0ciggInRpdGxlIiwgZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOw0KCQkJfQ0KCQl9ICk7DQoJCXRoaXMuZGlzYWJsZWRUaXRsZXMgPSAkKCBbXSApOw0KCX0sDQoNCglvcGVuOiBmdW5jdGlvbiggZXZlbnQgKSB7DQoJCXZhciB0aGF0ID0gdGhpcywNCgkJCXRhcmdldCA9ICQoIGV2ZW50ID8gZXZlbnQudGFyZ2V0IDogdGhpcy5lbGVtZW50ICkNCg0KCQkJCS8vIHdlIG5lZWQgY2xvc2VzdCBoZXJlIGR1ZSB0byBtb3VzZW92ZXIgYnViYmxpbmcsDQoJCQkJLy8gYnV0IGFsd2F5cyBwb2ludGluZyBhdCB0aGUgc2FtZSBldmVudCB0YXJnZXQNCgkJCQkuY2xvc2VzdCggdGhpcy5vcHRpb25zLml0ZW1zICk7DQoNCgkJLy8gTm8gZWxlbWVudCB0byBzaG93IGEgdG9vbHRpcCBmb3Igb3IgdGhlIHRvb2x0aXAgaXMgYWxyZWFkeSBvcGVuDQoJCWlmICggIXRhcmdldC5sZW5ndGggfHwgdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLWlkIiApICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJaWYgKCB0YXJnZXQuYXR0ciggInRpdGxlIiApICkgew0KCQkJdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiwgdGFyZ2V0LmF0dHIoICJ0aXRsZSIgKSApOw0KCQl9DQoNCgkJdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLW9wZW4iLCB0cnVlICk7DQoNCgkJLy8gS2lsbCBwYXJlbnQgdG9vbHRpcHMsIGN1c3RvbSBvciBuYXRpdmUsIGZvciBob3Zlcg0KCQlpZiAoIGV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW92ZXIiICkgew0KCQkJdGFyZ2V0LnBhcmVudHMoKS5lYWNoKCBmdW5jdGlvbigpIHsNCgkJCQl2YXIgcGFyZW50ID0gJCggdGhpcyApLA0KCQkJCQlibHVyRXZlbnQ7DQoJCQkJaWYgKCBwYXJlbnQuZGF0YSggInVpLXRvb2x0aXAtb3BlbiIgKSApIHsNCgkJCQkJYmx1ckV2ZW50ID0gJC5FdmVudCggImJsdXIiICk7DQoJCQkJCWJsdXJFdmVudC50YXJnZXQgPSBibHVyRXZlbnQuY3VycmVudFRhcmdldCA9IHRoaXM7DQoJCQkJCXRoYXQuY2xvc2UoIGJsdXJFdmVudCwgdHJ1ZSApOw0KCQkJCX0NCgkJCQlpZiAoIHBhcmVudC5hdHRyKCAidGl0bGUiICkgKSB7DQoJCQkJCXBhcmVudC51bmlxdWVJZCgpOw0KCQkJCQl0aGF0LnBhcmVudHNbIHRoaXMuaWQgXSA9IHsNCgkJCQkJCWVsZW1lbnQ6IHRoaXMsDQoJCQkJCQl0aXRsZTogcGFyZW50LmF0dHIoICJ0aXRsZSIgKQ0KCQkJCQl9Ow0KCQkJCQlwYXJlbnQuYXR0ciggInRpdGxlIiwgIiIgKTsNCgkJCQl9DQoJCQl9ICk7DQoJCX0NCg0KCQl0aGlzLl9yZWdpc3RlckNsb3NlSGFuZGxlcnMoIGV2ZW50LCB0YXJnZXQgKTsNCgkJdGhpcy5fdXBkYXRlQ29udGVudCggdGFyZ2V0LCBldmVudCApOw0KCX0sDQoNCglfdXBkYXRlQ29udGVudDogZnVuY3Rpb24oIHRhcmdldCwgZXZlbnQgKSB7DQoJCXZhciBjb250ZW50LA0KCQkJY29udGVudE9wdGlvbiA9IHRoaXMub3B0aW9ucy5jb250ZW50LA0KCQkJdGhhdCA9IHRoaXMsDQoJCQlldmVudFR5cGUgPSBldmVudCA\/IGV2ZW50LnR5cGUgOiBudWxsOw0KDQoJCWlmICggdHlwZW9mIGNvbnRlbnRPcHRpb24gPT09ICJzdHJpbmciIHx8IGNvbnRlbnRPcHRpb24ubm9kZVR5cGUgfHwNCgkJCQljb250ZW50T3B0aW9uLmpxdWVyeSApIHsNCgkJCXJldHVybiB0aGlzLl9vcGVuKCBldmVudCwgdGFyZ2V0LCBjb250ZW50T3B0aW9uICk7DQoJCX0NCg0KCQljb250ZW50ID0gY29udGVudE9wdGlvbi5jYWxsKCB0YXJnZXRbIDAgXSwgZnVuY3Rpb24oIHJlc3BvbnNlICkgew0KDQoJCQkvLyBJRSBtYXkgaW5zdGFudGx5IHNlcnZlIGEgY2FjaGVkIHJlc3BvbnNlIGZvciBhamF4IHJlcXVlc3RzDQoJCQkvLyBkZWxheSB0aGlzIGNhbGwgdG8gX29wZW4gc28gdGhlIG90aGVyIGNhbGwgdG8gX29wZW4gcnVucyBmaXJzdA0KCQkJdGhhdC5fZGVsYXkoIGZ1bmN0aW9uKCkgew0KDQoJCQkJLy8gSWdub3JlIGFzeW5jIHJlc3BvbnNlIGlmIHRvb2x0aXAgd2FzIGNsb3NlZCBhbHJlYWR5DQoJCQkJaWYgKCAhdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLW9wZW4iICkgKSB7DQoJCQkJCXJldHVybjsNCgkJCQl9DQoNCgkJCQkvLyBKUXVlcnkgY3JlYXRlcyBhIHNwZWNpYWwgZXZlbnQgZm9yIGZvY3VzaW4gd2hlbiBpdCBkb2Vzbid0DQoJCQkJLy8gZXhpc3QgbmF0aXZlbHkuIFRvIGltcHJvdmUgcGVyZm9ybWFuY2UsIHRoZSBuYXRpdmUgZXZlbnQNCgkJCQkvLyBvYmplY3QgaXMgcmV1c2VkIGFuZCB0aGUgdHlwZSBpcyBjaGFuZ2VkLiBUaGVyZWZvcmUsIHdlIGNhbid0DQoJCQkJLy8gcmVseSBvbiB0aGUgdHlwZSBiZWluZyBjb3JyZWN0IGFmdGVyIHRoZSBldmVudCBmaW5pc2hlZA0KCQkJCS8vIGJ1YmJsaW5nLCBzbyB3ZSBzZXQgaXQgYmFjayB0byB0aGUgcHJldmlvdXMgdmFsdWUuICgjODc0MCkNCgkJCQlpZiAoIGV2ZW50ICkgew0KCQkJCQlldmVudC50eXBlID0gZXZlbnRUeXBlOw0KCQkJCX0NCgkJCQl0aGlzLl9vcGVuKCBldmVudCwgdGFyZ2V0LCByZXNwb25zZSApOw0KCQkJfSApOw0KCQl9ICk7DQoJCWlmICggY29udGVudCApIHsNCgkJCXRoaXMuX29wZW4oIGV2ZW50LCB0YXJnZXQsIGNvbnRlbnQgKTsNCgkJfQ0KCX0sDQoNCglfb3BlbjogZnVuY3Rpb24oIGV2ZW50LCB0YXJnZXQsIGNvbnRlbnQgKSB7DQoJCXZhciB0b29sdGlwRGF0YSwgdG9vbHRpcCwgZGVsYXllZFNob3csIGExMXlDb250ZW50LA0KCQkJcG9zaXRpb25PcHRpb24gPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApOw0KDQoJCWlmICggIWNvbnRlbnQgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBDb250ZW50IGNhbiBiZSB1cGRhdGVkIG11bHRpcGxlIHRpbWVzLiBJZiB0aGUgdG9vbHRpcCBhbHJlYWR5DQoJCS8vIGV4aXN0cywgdGhlbiBqdXN0IHVwZGF0ZSB0aGUgY29udGVudCBhbmQgYmFpbC4NCgkJdG9vbHRpcERhdGEgPSB0aGlzLl9maW5kKCB0YXJnZXQgKTsNCgkJaWYgKCB0b29sdGlwRGF0YSApIHsNCgkJCXRvb2x0aXBEYXRhLnRvb2x0aXAuZmluZCggIi51aS10b29sdGlwLWNvbnRlbnQiICkuaHRtbCggY29udGVudCApOw0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gSWYgd2UgaGF2ZSBhIHRpdGxlLCBjbGVhciBpdCB0byBwcmV2ZW50IHRoZSBuYXRpdmUgdG9vbHRpcA0KCQkvLyB3ZSBoYXZlIHRvIGNoZWNrIGZpcnN0IHRvIGF2b2lkIGRlZmluaW5nIGEgdGl0bGUgaWYgbm9uZSBleGlzdHMNCgkJLy8gKHdlIGRvbid0IHdhbnQgdG8gY2F1c2UgYW4gZWxlbWVudCB0byBzdGFydCBtYXRjaGluZyBbdGl0bGVdKQ0KCQkvLw0KCQkvLyBXZSB1c2UgcmVtb3ZlQXR0ciBvbmx5IGZvciBrZXkgZXZlbnRzLCB0byBhbGxvdyBJRSB0byBleHBvcnQgdGhlIGNvcnJlY3QNCgkJLy8gYWNjZXNzaWJsZSBhdHRyaWJ1dGVzLiBGb3IgbW91c2UgZXZlbnRzLCBzZXQgdG8gZW1wdHkgc3RyaW5nIHRvIGF2b2lkDQoJCS8vIG5hdGl2ZSB0b29sdGlwIHNob3dpbmcgdXAgKGhhcHBlbnMgb25seSB3aGVuIHJlbW92aW5nIGluc2lkZSBtb3VzZW92ZXIpLg0KCQlpZiAoIHRhcmdldC5pcyggIlt0aXRsZV0iICkgKSB7DQoJCQlpZiAoIGV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW92ZXIiICkgew0KCQkJCXRhcmdldC5hdHRyKCAidGl0bGUiLCAiIiApOw0KCQkJfSBlbHNlIHsNCgkJCQl0YXJnZXQucmVtb3ZlQXR0ciggInRpdGxlIiApOw0KCQkJfQ0KCQl9DQoNCgkJdG9vbHRpcERhdGEgPSB0aGlzLl90b29sdGlwKCB0YXJnZXQgKTsNCgkJdG9vbHRpcCA9IHRvb2x0aXBEYXRhLnRvb2x0aXA7DQoJCXRoaXMuX2FkZERlc2NyaWJlZEJ5KCB0YXJnZXQsIHRvb2x0aXAuYXR0ciggImlkIiApICk7DQoJCXRvb2x0aXAuZmluZCggIi51aS10b29sdGlwLWNvbnRlbnQiICkuaHRtbCggY29udGVudCApOw0KDQoJCS8vIFN1cHBvcnQ6IFZvaWNlb3ZlciBvbiBPUyBYLCBKQVdTIG9uIElFIDw9IDkNCgkJLy8gSkFXUyBhbm5vdW5jZXMgZGVsZXRpb25zIGV2ZW4gd2hlbiBhcmlhLXJlbGV2YW50PSJhZGRpdGlvbnMiDQoJCS8vIFZvaWNlb3ZlciB3aWxsIHNvbWV0aW1lcyByZS1yZWFkIHRoZSBlbnRpcmUgbG9nIHJlZ2lvbidzIGNvbnRlbnRzIGZyb20gdGhlIGJlZ2lubmluZw0KCQl0aGlzLmxpdmVSZWdpb24uY2hpbGRyZW4oKS5oaWRlKCk7DQoJCWExMXlDb250ZW50ID0gJCggIjxkaXY+IiApLmh0bWwoIHRvb2x0aXAuZmluZCggIi51aS10b29sdGlwLWNvbnRlbnQiICkuaHRtbCgpICk7DQoJCWExMXlDb250ZW50LnJlbW92ZUF0dHIoICJuYW1lIiApLmZpbmQoICJbbmFtZV0iICkucmVtb3ZlQXR0ciggIm5hbWUiICk7DQoJCWExMXlDb250ZW50LnJlbW92ZUF0dHIoICJpZCIgKS5maW5kKCAiW2lkXSIgKS5yZW1vdmVBdHRyKCAiaWQiICk7DQoJCWExMXlDb250ZW50LmFwcGVuZFRvKCB0aGlzLmxpdmVSZWdpb24gKTsNCg0KCQlmdW5jdGlvbiBwb3NpdGlvbiggZXZlbnQgKSB7DQoJCQlwb3NpdGlvbk9wdGlvbi5vZiA9IGV2ZW50Ow0KCQkJaWYgKCB0b29sdGlwLmlzKCAiOmhpZGRlbiIgKSApIHsNCgkJCQlyZXR1cm47DQoJCQl9DQoJCQl0b29sdGlwLnBvc2l0aW9uKCBwb3NpdGlvbk9wdGlvbiApOw0KCQl9DQoJCWlmICggdGhpcy5vcHRpb25zLnRyYWNrICYmIGV2ZW50ICYmIC9ebW91c2UvLnRlc3QoIGV2ZW50LnR5cGUgKSApIHsNCgkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7DQoJCQkJbW91c2Vtb3ZlOiBwb3NpdGlvbg0KCQkJfSApOw0KDQoJCQkvLyB0cmlnZ2VyIG9uY2UgdG8gb3ZlcnJpZGUgZWxlbWVudC1yZWxhdGl2ZSBwb3NpdGlvbmluZw0KCQkJcG9zaXRpb24oIGV2ZW50ICk7DQoJCX0gZWxzZSB7DQoJCQl0b29sdGlwLnBvc2l0aW9uKCAkLmV4dGVuZCggew0KCQkJCW9mOiB0YXJnZXQNCgkJCX0sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApICk7DQoJCX0NCg0KCQl0b29sdGlwLmhpZGUoKTsNCg0KCQl0aGlzLl9zaG93KCB0b29sdGlwLCB0aGlzLm9wdGlvbnMuc2hvdyApOw0KDQoJCS8vIEhhbmRsZSB0cmFja2luZyB0b29sdGlwcyB0aGF0IGFyZSBzaG93biB3aXRoIGEgZGVsYXkgKCM4NjQ0KS4gQXMgc29vbg0KCQkvLyBhcyB0aGUgdG9vbHRpcCBpcyB2aXNpYmxlLCBwb3NpdGlvbiB0aGUgdG9vbHRpcCB1c2luZyB0aGUgbW9zdCByZWNlbnQNCgkJLy8gZXZlbnQuDQoJCS8vIEFkZHMgdGhlIGNoZWNrIHRvIGFkZCB0aGUgdGltZXJzIG9ubHkgd2hlbiBib3RoIGRlbGF5IGFuZCB0cmFjayBvcHRpb25zIGFyZSBzZXQgKCMxNDY4MikNCgkJaWYgKCB0aGlzLm9wdGlvbnMudHJhY2sgJiYgdGhpcy5vcHRpb25zLnNob3cgJiYgdGhpcy5vcHRpb25zLnNob3cuZGVsYXkgKSB7DQoJCQlkZWxheWVkU2hvdyA9IHRoaXMuZGVsYXllZFNob3cgPSBzZXRJbnRlcnZhbCggZnVuY3Rpb24oKSB7DQoJCQkJaWYgKCB0b29sdGlwLmlzKCAiOnZpc2libGUiICkgKSB7DQoJCQkJCXBvc2l0aW9uKCBwb3NpdGlvbk9wdGlvbi5vZiApOw0KCQkJCQljbGVhckludGVydmFsKCBkZWxheWVkU2hvdyApOw0KCQkJCX0NCgkJCX0sICQuZnguaW50ZXJ2YWwgKTsNCgkJfQ0KDQoJCXRoaXMuX3RyaWdnZXIoICJvcGVuIiwgZXZlbnQsIHsgdG9vbHRpcDogdG9vbHRpcCB9ICk7DQoJfSwNCg0KCV9yZWdpc3RlckNsb3NlSGFuZGxlcnM6IGZ1bmN0aW9uKCBldmVudCwgdGFyZ2V0ICkgew0KCQl2YXIgZXZlbnRzID0gew0KCQkJa2V5dXA6IGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCQlpZiAoIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5FU0NBUEUgKSB7DQoJCQkJCXZhciBmYWtlRXZlbnQgPSAkLkV2ZW50KCBldmVudCApOw0KCQkJCQlmYWtlRXZlbnQuY3VycmVudFRhcmdldCA9IHRhcmdldFsgMCBdOw0KCQkJCQl0aGlzLmNsb3NlKCBmYWtlRXZlbnQsIHRydWUgKTsNCgkJCQl9DQoJCQl9DQoJCX07DQoNCgkJLy8gT25seSBiaW5kIHJlbW92ZSBoYW5kbGVyIGZvciBkZWxlZ2F0ZWQgdGFyZ2V0cy4gTm9uLWRlbGVnYXRlZA0KCQkvLyB0b29sdGlwcyB3aWxsIGhhbmRsZSB0aGlzIGluIGRlc3Ryb3kuDQoJCWlmICggdGFyZ2V0WyAwIF0gIT09IHRoaXMuZWxlbWVudFsgMCBdICkgew0KCQkJZXZlbnRzLnJlbW92ZSA9IGZ1bmN0aW9uKCkgew0KCQkJCXRoaXMuX3JlbW92ZVRvb2x0aXAoIHRoaXMuX2ZpbmQoIHRhcmdldCApLnRvb2x0aXAgKTsNCgkJCX07DQoJCX0NCg0KCQlpZiAoICFldmVudCB8fCBldmVudC50eXBlID09PSAibW91c2VvdmVyIiApIHsNCgkJCWV2ZW50cy5tb3VzZWxlYXZlID0gImNsb3NlIjsNCgkJfQ0KCQlpZiAoICFldmVudCB8fCBldmVudC50eXBlID09PSAiZm9jdXNpbiIgKSB7DQoJCQlldmVudHMuZm9jdXNvdXQgPSAiY2xvc2UiOw0KCQl9DQoJCXRoaXMuX29uKCB0cnVlLCB0YXJnZXQsIGV2ZW50cyApOw0KCX0sDQoNCgljbG9zZTogZnVuY3Rpb24oIGV2ZW50ICkgew0KCQl2YXIgdG9vbHRpcCwNCgkJCXRoYXQgPSB0aGlzLA0KCQkJdGFyZ2V0ID0gJCggZXZlbnQgPyBldmVudC5jdXJyZW50VGFyZ2V0IDogdGhpcy5lbGVtZW50ICksDQoJCQl0b29sdGlwRGF0YSA9IHRoaXMuX2ZpbmQoIHRhcmdldCApOw0KDQoJCS8vIFRoZSB0b29sdGlwIG1heSBhbHJlYWR5IGJlIGNsb3NlZA0KCQlpZiAoICF0b29sdGlwRGF0YSApIHsNCg0KCQkJLy8gV2Ugc2V0IHVpLXRvb2x0aXAtb3BlbiBpbW1lZGlhdGVseSB1cG9uIG9wZW4gKGluIG9wZW4oKSksIGJ1dCBvbmx5IHNldCB0aGUNCgkJCS8vIGFkZGl0aW9uYWwgZGF0YSBvbmNlIHRoZXJlJ3MgYWN0dWFsbHkgY29udGVudCB0byBzaG93IChpbiBfb3BlbigpKS4gU28gZXZlbiBpZiB0aGUNCgkJCS8vIHRvb2x0aXAgZG9lc24ndCBoYXZlIGZ1bGwgZGF0YSwgd2UgYWx3YXlzIHJlbW92ZSB1aS10b29sdGlwLW9wZW4gaW4gY2FzZSB3ZSdyZSBpbg0KCQkJLy8gdGhlIHBlcmlvZCBiZXR3ZWVuIG9wZW4oKSBhbmQgX29wZW4oKS4NCgkJCXRhcmdldC5yZW1vdmVEYXRhKCAidWktdG9vbHRpcC1vcGVuIiApOw0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJdG9vbHRpcCA9IHRvb2x0aXBEYXRhLnRvb2x0aXA7DQoNCgkJLy8gRGlzYWJsaW5nIGNsb3NlcyB0aGUgdG9vbHRpcCwgc28gd2UgbmVlZCB0byB0cmFjayB3aGVuIHdlJ3JlIGNsb3NpbmcNCgkJLy8gdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCBpbiBjYXNlIHRoZSB0b29sdGlwIGJlY29tZXMgZGlzYWJsZWQgb24gY2xvc2UNCgkJaWYgKCB0b29sdGlwRGF0YS5jbG9zaW5nICkgew0KCQkJcmV0dXJuOw0KCQl9DQoNCgkJLy8gQ2xlYXIgdGhlIGludGVydmFsIGZvciBkZWxheWVkIHRyYWNraW5nIHRvb2x0aXBzDQoJCWNsZWFySW50ZXJ2YWwoIHRoaXMuZGVsYXllZFNob3cgKTsNCg0KCQkvLyBPbmx5IHNldCB0aXRsZSBpZiB3ZSBoYWQgb25lIGJlZm9yZSAoc2VlIGNvbW1lbnQgaW4gX29wZW4oKSkNCgkJLy8gSWYgdGhlIHRpdGxlIGF0dHJpYnV0ZSBoYXMgY2hhbmdlZCBzaW5jZSBvcGVuKCksIGRvbid0IHJlc3RvcmUNCgkJaWYgKCB0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiICkgJiYgIXRhcmdldC5hdHRyKCAidGl0bGUiICkgKSB7DQoJCQl0YXJnZXQuYXR0ciggInRpdGxlIiwgdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiApICk7DQoJCX0NCg0KCQl0aGlzLl9yZW1vdmVEZXNjcmliZWRCeSggdGFyZ2V0ICk7DQoNCgkJdG9vbHRpcERhdGEuaGlkaW5nID0gdHJ1ZTsNCgkJdG9vbHRpcC5zdG9wKCB0cnVlICk7DQoJCXRoaXMuX2hpZGUoIHRvb2x0aXAsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsNCgkJCXRoYXQuX3JlbW92ZVRvb2x0aXAoICQoIHRoaXMgKSApOw0KCQl9ICk7DQoNCgkJdGFyZ2V0LnJlbW92ZURhdGEoICJ1aS10b29sdGlwLW9wZW4iICk7DQoJCXRoaXMuX29mZiggdGFyZ2V0LCAibW91c2VsZWF2ZSBmb2N1c291dCBrZXl1cCIgKTsNCg0KCQkvLyBSZW1vdmUgJ3JlbW92ZScgYmluZGluZyBvbmx5IG9uIGRlbGVnYXRlZCB0YXJnZXRzDQoJCWlmICggdGFyZ2V0WyAwIF0gIT09IHRoaXMuZWxlbWVudFsgMCBdICkgew0KCQkJdGhpcy5fb2ZmKCB0YXJnZXQsICJyZW1vdmUiICk7DQoJCX0NCgkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LCAibW91c2Vtb3ZlIiApOw0KDQoJCWlmICggZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlbGVhdmUiICkgew0KCQkJJC5lYWNoKCB0aGlzLnBhcmVudHMsIGZ1bmN0aW9uKCBpZCwgcGFyZW50ICkgew0KCQkJCSQoIHBhcmVudC5lbGVtZW50ICkuYXR0ciggInRpdGxlIiwgcGFyZW50LnRpdGxlICk7DQoJCQkJZGVsZXRlIHRoYXQucGFyZW50c1sgaWQgXTsNCgkJCX0gKTsNCgkJfQ0KDQoJCXRvb2x0aXBEYXRhLmNsb3NpbmcgPSB0cnVlOw0KCQl0aGlzLl90cmlnZ2VyKCAiY2xvc2UiLCBldmVudCwgeyB0b29sdGlwOiB0b29sdGlwIH0gKTsNCgkJaWYgKCAhdG9vbHRpcERhdGEuaGlkaW5nICkgew0KCQkJdG9vbHRpcERhdGEuY2xvc2luZyA9IGZhbHNlOw0KCQl9DQoJfSwNCg0KCV90b29sdGlwOiBmdW5jdGlvbiggZWxlbWVudCApIHsNCgkJdmFyIHRvb2x0aXAgPSAkKCAiPGRpdj4iICkuYXR0ciggInJvbGUiLCAidG9vbHRpcCIgKSwNCgkJCWNvbnRlbnQgPSAkKCAiPGRpdj4iICkuYXBwZW5kVG8oIHRvb2x0aXAgKSwNCgkJCWlkID0gdG9vbHRpcC51bmlxdWVJZCgpLmF0dHIoICJpZCIgKTsNCg0KCQl0aGlzLl9hZGRDbGFzcyggY29udGVudCwgInVpLXRvb2x0aXAtY29udGVudCIgKTsNCgkJdGhpcy5fYWRkQ2xhc3MoIHRvb2x0aXAsICJ1aS10b29sdGlwIiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCIgKTsNCg0KCQl0b29sdGlwLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbyggZWxlbWVudCApICk7DQoNCgkJcmV0dXJuIHRoaXMudG9vbHRpcHNbIGlkIF0gPSB7DQoJCQllbGVtZW50OiBlbGVtZW50LA0KCQkJdG9vbHRpcDogdG9vbHRpcA0KCQl9Ow0KCX0sDQoNCglfZmluZDogZnVuY3Rpb24oIHRhcmdldCApIHsNCgkJdmFyIGlkID0gdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLWlkIiApOw0KCQlyZXR1cm4gaWQgPyB0aGlzLnRvb2x0aXBzWyBpZCBdIDogbnVsbDsNCgl9LA0KDQoJX3JlbW92ZVRvb2x0aXA6IGZ1bmN0aW9uKCB0b29sdGlwICkgew0KCQl0b29sdGlwLnJlbW92ZSgpOw0KCQlkZWxldGUgdGhpcy50b29sdGlwc1sgdG9vbHRpcC5hdHRyKCAiaWQiICkgXTsNCgl9LA0KDQoJX2FwcGVuZFRvOiBmdW5jdGlvbiggdGFyZ2V0ICkgew0KCQl2YXIgZWxlbWVudCA9IHRhcmdldC5jbG9zZXN0KCAiLnVpLWZyb250LCBkaWFsb2ciICk7DQoNCgkJaWYgKCAhZWxlbWVudC5sZW5ndGggKSB7DQoJCQllbGVtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHk7DQoJCX0NCg0KCQlyZXR1cm4gZWxlbWVudDsNCgl9LA0KDQoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgew0KCQl2YXIgdGhhdCA9IHRoaXM7DQoNCgkJLy8gQ2xvc2Ugb3BlbiB0b29sdGlwcw0KCQkkLmVhY2goIHRoaXMudG9vbHRpcHMsIGZ1bmN0aW9uKCBpZCwgdG9vbHRpcERhdGEgKSB7DQoNCgkJCS8vIERlbGVnYXRlIHRvIGNsb3NlIG1ldGhvZCB0byBoYW5kbGUgY29tbW9uIGNsZWFudXANCgkJCXZhciBldmVudCA9ICQuRXZlbnQoICJibHVyIiApLA0KCQkJCWVsZW1lbnQgPSB0b29sdGlwRGF0YS5lbGVtZW50Ow0KCQkJZXZlbnQudGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldCA9IGVsZW1lbnRbIDAgXTsNCgkJCXRoYXQuY2xvc2UoIGV2ZW50LCB0cnVlICk7DQoNCgkJCS8vIFJlbW92ZSBpbW1lZGlhdGVseTsgZGVzdHJveWluZyBhbiBvcGVuIHRvb2x0aXAgZG9lc24ndCB1c2UgdGhlDQoJCQkvLyBoaWRlIGFuaW1hdGlvbg0KCQkJJCggIiMiICsgaWQgKS5yZW1vdmUoKTsNCg0KCQkJLy8gUmVzdG9yZSB0aGUgdGl0bGUNCgkJCWlmICggZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApIHsNCg0KCQkJCS8vIElmIHRoZSB0aXRsZSBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQgc2luY2Ugb3BlbigpLCBkb24ndCByZXN0b3JlDQoJCQkJaWYgKCAhZWxlbWVudC5hdHRyKCAidGl0bGUiICkgKSB7DQoJCQkJCWVsZW1lbnQuYXR0ciggInRpdGxlIiwgZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOw0KCQkJCX0NCgkJCQllbGVtZW50LnJlbW92ZURhdGEoICJ1aS10b29sdGlwLXRpdGxlIiApOw0KCQkJfQ0KCQl9ICk7DQoJCXRoaXMubGl2ZVJlZ2lvbi5yZW1vdmUoKTsNCgl9DQp9ICk7DQoNCi8vIERFUFJFQ0FURUQNCi8vIFRPRE86IFN3aXRjaCByZXR1cm4gYmFjayB0byB3aWRnZXQgZGVjbGFyYXRpb24gYXQgdG9wIG9mIGZpbGUgd2hlbiB0aGlzIGlzIHJlbW92ZWQNCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgew0KDQoJLy8gQmFja2NvbXBhdCBmb3IgdG9vbHRpcENsYXNzIG9wdGlvbg0KCSQud2lkZ2V0KCAidWkudG9vbHRpcCIsICQudWkudG9vbHRpcCwgew0KCQlvcHRpb25zOiB7DQoJCQl0b29sdGlwQ2xhc3M6IG51bGwNCgkJfSwNCgkJX3Rvb2x0aXA6IGZ1bmN0aW9uKCkgew0KCQkJdmFyIHRvb2x0aXBEYXRhID0gdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7DQoJCQlpZiAoIHRoaXMub3B0aW9ucy50b29sdGlwQ2xhc3MgKSB7DQoJCQkJdG9vbHRpcERhdGEudG9vbHRpcC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLnRvb2x0aXBDbGFzcyApOw0KCQkJfQ0KCQkJcmV0dXJuIHRvb2x0aXBEYXRhOw0KCQl9DQoJfSApOw0KfQ0KDQp2YXIgd2lkZ2V0c1Rvb2x0aXAgPSAkLnVpLnRvb2x0aXA7DQoNCg0KDQoNCn0pKTs=",
    "size": "539420"
}