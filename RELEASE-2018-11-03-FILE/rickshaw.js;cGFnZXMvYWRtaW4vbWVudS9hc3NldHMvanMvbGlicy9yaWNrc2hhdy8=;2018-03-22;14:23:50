{
    "namaFile": "pages\/admin\/menu\/assets\/js\/libs\/rickshaw\/rickshaw.js",
    "lastUpdate": "2018-03-22+14:23:50.11",
    "contentFile": "KGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKFsnZDMnXSwgZnVuY3Rpb24gKGQzKSB7CiAgICAgICAgICAgIHJldHVybiAocm9vdC5SaWNrc2hhdyA9IGZhY3RvcnkoZDMpKTsKICAgICAgICB9KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoJ2QzJykpOwogICAgfSBlbHNlIHsKICAgICAgICByb290LlJpY2tzaGF3ID0gZmFjdG9yeShkMyk7CiAgICB9Cn0odGhpcywgZnVuY3Rpb24gKGQzKSB7Ci8qIGpzaGludCAtVzA3OSAqLyAKCnZhciBSaWNrc2hhdyA9IHsKCgluYW1lc3BhY2U6IGZ1bmN0aW9uKG5hbWVzcGFjZSwgb2JqKSB7CgoJCXZhciBwYXJ0cyA9IG5hbWVzcGFjZS5zcGxpdCgnLicpOwoKCQl2YXIgcGFyZW50ID0gUmlja3NoYXc7CgoJCWZvcih2YXIgaSA9IDEsIGxlbmd0aCA9IHBhcnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CgkJCXZhciBjdXJyZW50UGFydCA9IHBhcnRzW2ldOwoJCQlwYXJlbnRbY3VycmVudFBhcnRdID0gcGFyZW50W2N1cnJlbnRQYXJ0XSB8fCB7fTsKCQkJcGFyZW50ID0gcGFyZW50W2N1cnJlbnRQYXJ0XTsKCQl9CgkJcmV0dXJuIHBhcmVudDsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqKSB7CgkJdmFyIGtleXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqKSBrZXlzLnB1c2goa2V5KTsKCQlyZXR1cm4ga2V5czsKCX0sCgoJZXh0ZW5kOiBmdW5jdGlvbihkZXN0aW5hdGlvbiwgc291cmNlKSB7CgoJCWZvciAodmFyIHByb3BlcnR5IGluIHNvdXJjZSkgewoJCQlkZXN0aW5hdGlvbltwcm9wZXJ0eV0gPSBzb3VyY2VbcHJvcGVydHldOwoJCX0KCQlyZXR1cm4gZGVzdGluYXRpb247Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihvYmopIHsKCQlyZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTsKCX0KfTsKLyogQWRhcHRlZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9KYWtvYm8vUFRDbGFzcyAqLwoKLyoKQ29weXJpZ2h0IChjKSAyMDA1LTIwMTAgU2FtIFN0ZXBoZW5zb24KClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCk9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFClNPRlRXQVJFLgoqLwovKiBCYXNlZCBvbiBBbGV4IEFybmVsbCdzIGluaGVyaXRhbmNlIGltcGxlbWVudGF0aW9uLiAqLwovKiogc2VjdGlvbjogTGFuZ3VhZ2UKICogY2xhc3MgQ2xhc3MKICoKICogIE1hbmFnZXMgUHJvdG90eXBlJ3MgY2xhc3MtYmFzZWQgT09QIHN5c3RlbS4KICoKICogIFJlZmVyIHRvIFByb3RvdHlwZSdzIHdlYiBzaXRlIGZvciBhIFt0dXRvcmlhbCBvbiBjbGFzc2VzIGFuZAogKiAgaW5oZXJpdGFuY2VdKGh0dHA6Ly9wcm90b3R5cGVqcy5vcmcvbGVhcm4vY2xhc3MtaW5oZXJpdGFuY2UpLgoqKi8KKGZ1bmN0aW9uKGdsb2JhbENvbnRleHQpIHsKLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCi8qIEltcG9ydCBmcm9tIG9iamVjdC5qcyAgICAgICAgICAgICAgICAqLwovKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KdmFyIF90b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCiAgICBOVUxMX1RZUEUgPSAnTnVsbCcsCiAgICBVTkRFRklORURfVFlQRSA9ICdVbmRlZmluZWQnLAogICAgQk9PTEVBTl9UWVBFID0gJ0Jvb2xlYW4nLAogICAgTlVNQkVSX1RZUEUgPSAnTnVtYmVyJywKICAgIFNUUklOR19UWVBFID0gJ1N0cmluZycsCiAgICBPQkpFQ1RfVFlQRSA9ICdPYmplY3QnLAogICAgRlVOQ1RJT05fQ0xBU1MgPSAnW29iamVjdCBGdW5jdGlvbl0nOwpmdW5jdGlvbiBpc0Z1bmN0aW9uKG9iamVjdCkgewogIHJldHVybiBfdG9TdHJpbmcuY2FsbChvYmplY3QpID09PSBGVU5DVElPTl9DTEFTUzsKfQpmdW5jdGlvbiBleHRlbmQoZGVzdGluYXRpb24sIHNvdXJjZSkgewogIGZvciAodmFyIHByb3BlcnR5IGluIHNvdXJjZSkgaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIC8vIG1vZGlmeSBwcm90ZWN0IHByaW1pdGl2ZSBzbGF1Z2h0ZXIKICAgIGRlc3RpbmF0aW9uW3Byb3BlcnR5XSA9IHNvdXJjZVtwcm9wZXJ0eV07CiAgcmV0dXJuIGRlc3RpbmF0aW9uOwp9CmZ1bmN0aW9uIGtleXMob2JqZWN0KSB7CiAgaWYgKFR5cGUob2JqZWN0KSAhPT0gT0JKRUNUX1RZUEUpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigpOyB9CiAgdmFyIHJlc3VsdHMgPSBbXTsKICBmb3IgKHZhciBwcm9wZXJ0eSBpbiBvYmplY3QpIHsKICAgIGlmIChvYmplY3QuaGFzT3duUHJvcGVydHkocHJvcGVydHkpKSB7CiAgICAgIHJlc3VsdHMucHVzaChwcm9wZXJ0eSk7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHRzOwp9CmZ1bmN0aW9uIFR5cGUobykgewogIHN3aXRjaChvKSB7CiAgICBjYXNlIG51bGw6IHJldHVybiBOVUxMX1RZUEU7CiAgICBjYXNlICh2b2lkIDApOiByZXR1cm4gVU5ERUZJTkVEX1RZUEU7CiAgfQogIHZhciB0eXBlID0gdHlwZW9mIG87CiAgc3dpdGNoKHR5cGUpIHsKICAgIGNhc2UgJ2Jvb2xlYW4nOiByZXR1cm4gQk9PTEVBTl9UWVBFOwogICAgY2FzZSAnbnVtYmVyJzogIHJldHVybiBOVU1CRVJfVFlQRTsKICAgIGNhc2UgJ3N0cmluZyc6ICByZXR1cm4gU1RSSU5HX1RZUEU7CiAgfQogIHJldHVybiBPQkpFQ1RfVFlQRTsKfQpmdW5jdGlvbiBpc1VuZGVmaW5lZChvYmplY3QpIHsKICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gInVuZGVmaW5lZCI7Cn0KLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCi8qIEltcG9ydCBmcm9tIEZ1bmN0aW9uLmpzICAgICAgICAgICAgICAqLwovKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwpmdW5jdGlvbiBhcmd1bWVudE5hbWVzKGZuKSB7CiAgdmFyIG5hbWVzID0gZm4udG9TdHJpbmcoKS5tYXRjaCgvXltcc1woXSpmdW5jdGlvblteKF0qXCgoW14pXSopXCkvKVsxXQogICAgLnJlcGxhY2UoL1wvXC8uKj9bXHJcbl18XC9cKig\/Oi58W1xyXG5dKSo\/XCpcLy9nLCAnJykKICAgIC5yZXBsYWNlKC9ccysvZywgJycpLnNwbGl0KCcsJyk7CiAgcmV0dXJuIG5hbWVzLmxlbmd0aCA9PSAxICYmICFuYW1lc1swXSA\/IFtdIDogbmFtZXM7Cn0KZnVuY3Rpb24gd3JhcChmbiwgd3JhcHBlcikgewogIHZhciBfX21ldGhvZCA9IGZuOwogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBhID0gdXBkYXRlKFtiaW5kKF9fbWV0aG9kLCB0aGlzKV0sIGFyZ3VtZW50cyk7CiAgICByZXR1cm4gd3JhcHBlci5hcHBseSh0aGlzLCBhKTsKICB9Cn0KZnVuY3Rpb24gdXBkYXRlKGFycmF5LCBhcmdzKSB7CiAgdmFyIGFycmF5TGVuZ3RoID0gYXJyYXkubGVuZ3RoLCBsZW5ndGggPSBhcmdzLmxlbmd0aDsKICB3aGlsZSAobGVuZ3RoLS0pIGFycmF5W2FycmF5TGVuZ3RoICsgbGVuZ3RoXSA9IGFyZ3NbbGVuZ3RoXTsKICByZXR1cm4gYXJyYXk7Cn0KZnVuY3Rpb24gbWVyZ2UoYXJyYXksIGFyZ3MpIHsKICBhcnJheSA9IHNsaWNlLmNhbGwoYXJyYXksIDApOwogIHJldHVybiB1cGRhdGUoYXJyYXksIGFyZ3MpOwp9CmZ1bmN0aW9uIGJpbmQoZm4sIGNvbnRleHQpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIgJiYgaXNVbmRlZmluZWQoYXJndW1lbnRzWzBdKSkgcmV0dXJuIHRoaXM7CiAgdmFyIF9fbWV0aG9kID0gZm4sIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdmFyIGEgPSBtZXJnZShhcmdzLCBhcmd1bWVudHMpOwogICAgcmV0dXJuIF9fbWV0aG9kLmFwcGx5KGNvbnRleHQsIGEpOwogIH0KfQoKLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCi8qIEltcG9ydCBmcm9tIFByb3RvdHlwZS5qcyAgICAgICAgICAgICAqLwovKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KdmFyIGVtcHR5RnVuY3Rpb24gPSBmdW5jdGlvbigpe307Cgp2YXIgQ2xhc3MgPSAoZnVuY3Rpb24oKSB7CiAgCiAgLy8gU29tZSB2ZXJzaW9ucyBvZiBKU2NyaXB0IGZhaWwgdG8gZW51bWVyYXRlIG92ZXIgcHJvcGVydGllcywgbmFtZXMgb2Ygd2hpY2ggCiAgLy8gY29ycmVzcG9uZCB0byBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGluIHRoZSBwcm90b3R5cGUgY2hhaW4KICB2YXIgSVNfRE9OVEVOVU1fQlVHR1kgPSAoZnVuY3Rpb24oKXsKICAgIGZvciAodmFyIHAgaW4geyB0b1N0cmluZzogMSB9KSB7CiAgICAgIC8vIGNoZWNrIGFjdHVhbCBwcm9wZXJ0eSBuYW1lLCBzbyB0aGF0IGl0IHdvcmtzIHdpdGggYXVnbWVudGVkIE9iamVjdC5wcm90b3R5cGUKICAgICAgaWYgKHAgPT09ICd0b1N0cmluZycpIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0pKCk7CiAgCiAgZnVuY3Rpb24gc3ViY2xhc3MoKSB7fTsKICBmdW5jdGlvbiBjcmVhdGUoKSB7CiAgICB2YXIgcGFyZW50ID0gbnVsbCwgcHJvcGVydGllcyA9IFtdLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICBpZiAoaXNGdW5jdGlvbihwcm9wZXJ0aWVzWzBdKSkKICAgICAgcGFyZW50ID0gcHJvcGVydGllcy5zaGlmdCgpOwoKICAgIGZ1bmN0aW9uIGtsYXNzKCkgewogICAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgICBleHRlbmQoa2xhc3MsIENsYXNzLk1ldGhvZHMpOwogICAga2xhc3Muc3VwZXJjbGFzcyA9IHBhcmVudDsKICAgIGtsYXNzLnN1YmNsYXNzZXMgPSBbXTsKCiAgICBpZiAocGFyZW50KSB7CiAgICAgIHN1YmNsYXNzLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CiAgICAgIGtsYXNzLnByb3RvdHlwZSA9IG5ldyBzdWJjbGFzczsKICAgICAgdHJ5IHsgcGFyZW50LnN1YmNsYXNzZXMucHVzaChrbGFzcykgfSBjYXRjaChlKSB7fQogICAgfQoKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBwcm9wZXJ0aWVzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKQogICAgICBrbGFzcy5hZGRNZXRob2RzKHByb3BlcnRpZXNbaV0pOwoKICAgIGlmICgha2xhc3MucHJvdG90eXBlLmluaXRpYWxpemUpCiAgICAgIGtsYXNzLnByb3RvdHlwZS5pbml0aWFsaXplID0gZW1wdHlGdW5jdGlvbjsKCiAgICBrbGFzcy5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBrbGFzczsKICAgIHJldHVybiBrbGFzczsKICB9CgogIGZ1bmN0aW9uIGFkZE1ldGhvZHMoc291cmNlKSB7CiAgICB2YXIgYW5jZXN0b3IgICA9IHRoaXMuc3VwZXJjbGFzcyAmJiB0aGlzLnN1cGVyY2xhc3MucHJvdG90eXBlLAogICAgICAgIHByb3BlcnRpZXMgPSBrZXlzKHNvdXJjZSk7CgogICAgLy8gSUU2IGRvZXNuJ3QgZW51bWVyYXRlIGB0b1N0cmluZ2AgYW5kIGB2YWx1ZU9mYCAoYW1vbmcgb3RoZXIgYnVpbHQtaW4gYE9iamVjdC5wcm90b3R5cGVgKSBwcm9wZXJ0aWVzLAogICAgLy8gRm9yY2UgY29weSBpZiB0aGV5J3JlIG5vdCBPYmplY3QucHJvdG90eXBlIG9uZXMuCiAgICAvLyBEbyBub3QgY29weSBvdGhlciBPYmplY3QucHJvdG90eXBlLiogZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMKICAgIGlmIChJU19ET05URU5VTV9CVUdHWSkgewogICAgICBpZiAoc291cmNlLnRvU3RyaW5nICE9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcpCiAgICAgICAgcHJvcGVydGllcy5wdXNoKCJ0b1N0cmluZyIpOwogICAgICBpZiAoc291cmNlLnZhbHVlT2YgIT0gT2JqZWN0LnByb3RvdHlwZS52YWx1ZU9mKQogICAgICAgIHByb3BlcnRpZXMucHVzaCgidmFsdWVPZiIpOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBwcm9wZXJ0aWVzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBwcm9wZXJ0eSA9IHByb3BlcnRpZXNbaV0sIHZhbHVlID0gc291cmNlW3Byb3BlcnR5XTsKICAgICAgaWYgKGFuY2VzdG9yICYmIGlzRnVuY3Rpb24odmFsdWUpICYmCiAgICAgICAgICBhcmd1bWVudE5hbWVzKHZhbHVlKVswXSA9PSAiJHN1cGVyIikgewogICAgICAgIHZhciBtZXRob2QgPSB2YWx1ZTsKICAgICAgICB2YWx1ZSA9IHdyYXAoKGZ1bmN0aW9uKG0pIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsgcmV0dXJuIGFuY2VzdG9yW21dLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CiAgICAgICAgfSkocHJvcGVydHkpLCBtZXRob2QpOwoKICAgICAgICB2YWx1ZS52YWx1ZU9mID0gYmluZChtZXRob2QudmFsdWVPZiwgbWV0aG9kKTsKICAgICAgICB2YWx1ZS50b1N0cmluZyA9IGJpbmQobWV0aG9kLnRvU3RyaW5nLCBtZXRob2QpOwogICAgICB9CiAgICAgIHRoaXMucHJvdG90eXBlW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0KCiAgcmV0dXJuIHsKICAgIGNyZWF0ZTogY3JlYXRlLAogICAgTWV0aG9kczogewogICAgICBhZGRNZXRob2RzOiBhZGRNZXRob2RzCiAgICB9CiAgfTsKfSkoKTsKCmlmIChnbG9iYWxDb250ZXh0LmV4cG9ydHMpIHsKICBnbG9iYWxDb250ZXh0LmV4cG9ydHMuQ2xhc3MgPSBDbGFzczsKfQplbHNlIHsKICBnbG9iYWxDb250ZXh0LkNsYXNzID0gQ2xhc3M7Cn0KfSkoUmlja3NoYXcpOwpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkNvbXBhdC5DbGFzc0xpc3QnKTsKClJpY2tzaGF3LkNvbXBhdC5DbGFzc0xpc3QgPSBmdW5jdGlvbigpIHsKCgkvKiBhZGFwdGVkIGZyb20gaHR0cDovL3B1cmwuZWxpZ3JleS5jb20vZ2l0aHViL2NsYXNzTGlzdC5qcy9ibG9iL21hc3Rlci9jbGFzc0xpc3QuanMgKi8KCglpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiAhKCJjbGFzc0xpc3QiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKSkpIHsKCgkoZnVuY3Rpb24gKHZpZXcpIHsKCgkidXNlIHN0cmljdCI7CgoJdmFyCgkJICBjbGFzc0xpc3RQcm9wID0gImNsYXNzTGlzdCIKCQksIHByb3RvUHJvcCA9ICJwcm90b3R5cGUiCgkJLCBlbGVtQ3RyUHJvdG8gPSAodmlldy5IVE1MRWxlbWVudCB8fCB2aWV3LkVsZW1lbnQpW3Byb3RvUHJvcF0KCQksIG9iakN0ciA9IE9iamVjdAoJCSwgc3RyVHJpbSA9IFN0cmluZ1twcm90b1Byb3BdLnRyaW0gfHwgZnVuY3Rpb24gKCkgewoJCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9eXHMrfFxzKyQvZywgIiIpOwoJCX0KCQksIGFyckluZGV4T2YgPSBBcnJheVtwcm90b1Byb3BdLmluZGV4T2YgfHwgZnVuY3Rpb24gKGl0ZW0pIHsKCQkJdmFyCgkJCQkgIGkgPSAwCgkJCQksIGxlbiA9IHRoaXMubGVuZ3RoCgkJCTsKCQkJZm9yICg7IGkgPCBsZW47IGkrKykgewoJCQkJaWYgKGkgaW4gdGhpcyAmJiB0aGlzW2ldID09PSBpdGVtKSB7CgkJCQkJcmV0dXJuIGk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIC0xOwoJCX0KCQkvLyBWZW5kb3JzOiBwbGVhc2UgYWxsb3cgY29udGVudCBjb2RlIHRvIGluc3RhbnRpYXRlIERPTUV4Y2VwdGlvbnMKCQksIERPTUV4ID0gZnVuY3Rpb24gKHR5cGUsIG1lc3NhZ2UpIHsKCQkJdGhpcy5uYW1lID0gdHlwZTsKCQkJdGhpcy5jb2RlID0gRE9NRXhjZXB0aW9uW3R5cGVdOwoJCQl0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwoJCX0KCQksIGNoZWNrVG9rZW5BbmRHZXRJbmRleCA9IGZ1bmN0aW9uIChjbGFzc0xpc3QsIHRva2VuKSB7CgkJCWlmICh0b2tlbiA9PT0gIiIpIHsKCQkJCXRocm93IG5ldyBET01FeCgKCQkJCQkgICJTWU5UQVhfRVJSIgoJCQkJCSwgIkFuIGludmFsaWQgb3IgaWxsZWdhbCBzdHJpbmcgd2FzIHNwZWNpZmllZCIKCQkJCSk7CgkJCX0KCQkJaWYgKC9ccy8udGVzdCh0b2tlbikpIHsKCQkJCXRocm93IG5ldyBET01FeCgKCQkJCQkgICJJTlZBTElEX0NIQVJBQ1RFUl9FUlIiCgkJCQkJLCAiU3RyaW5nIGNvbnRhaW5zIGFuIGludmFsaWQgY2hhcmFjdGVyIgoJCQkJKTsKCQkJfQoJCQlyZXR1cm4gYXJySW5kZXhPZi5jYWxsKGNsYXNzTGlzdCwgdG9rZW4pOwoJCX0KCQksIENsYXNzTGlzdCA9IGZ1bmN0aW9uIChlbGVtKSB7CgkJCXZhcgoJCQkJICB0cmltbWVkQ2xhc3NlcyA9IHN0clRyaW0uY2FsbChlbGVtLmNsYXNzTmFtZSkKCQkJCSwgY2xhc3NlcyA9IHRyaW1tZWRDbGFzc2VzID8gdHJpbW1lZENsYXNzZXMuc3BsaXQoL1xzKy8pIDogW10KCQkJCSwgaSA9IDAKCQkJCSwgbGVuID0gY2xhc3Nlcy5sZW5ndGgKCQkJOwoJCQlmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CgkJCQl0aGlzLnB1c2goY2xhc3Nlc1tpXSk7CgkJCX0KCQkJdGhpcy5fdXBkYXRlQ2xhc3NOYW1lID0gZnVuY3Rpb24gKCkgewoJCQkJZWxlbS5jbGFzc05hbWUgPSB0aGlzLnRvU3RyaW5nKCk7CgkJCX07CgkJfQoJCSwgY2xhc3NMaXN0UHJvdG8gPSBDbGFzc0xpc3RbcHJvdG9Qcm9wXSA9IFtdCgkJLCBjbGFzc0xpc3RHZXR0ZXIgPSBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBuZXcgQ2xhc3NMaXN0KHRoaXMpOwoJCX0KCTsKCS8vIE1vc3QgRE9NRXhjZXB0aW9uIGltcGxlbWVudGF0aW9ucyBkb24ndCBhbGxvdyBjYWxsaW5nIERPTUV4Y2VwdGlvbidzIHRvU3RyaW5nKCkKCS8vIG9uIG5vbi1ET01FeGNlcHRpb25zLiBFcnJvcidzIHRvU3RyaW5nKCkgaXMgc3VmZmljaWVudCBoZXJlLgoJRE9NRXhbcHJvdG9Qcm9wXSA9IEVycm9yW3Byb3RvUHJvcF07CgljbGFzc0xpc3RQcm90by5pdGVtID0gZnVuY3Rpb24gKGkpIHsKCQlyZXR1cm4gdGhpc1tpXSB8fCBudWxsOwoJfTsKCWNsYXNzTGlzdFByb3RvLmNvbnRhaW5zID0gZnVuY3Rpb24gKHRva2VuKSB7CgkJdG9rZW4gKz0gIiI7CgkJcmV0dXJuIGNoZWNrVG9rZW5BbmRHZXRJbmRleCh0aGlzLCB0b2tlbikgIT09IC0xOwoJfTsKCWNsYXNzTGlzdFByb3RvLmFkZCA9IGZ1bmN0aW9uICh0b2tlbikgewoJCXRva2VuICs9ICIiOwoJCWlmIChjaGVja1Rva2VuQW5kR2V0SW5kZXgodGhpcywgdG9rZW4pID09PSAtMSkgewoJCQl0aGlzLnB1c2godG9rZW4pOwoJCQl0aGlzLl91cGRhdGVDbGFzc05hbWUoKTsKCQl9Cgl9OwoJY2xhc3NMaXN0UHJvdG8ucmVtb3ZlID0gZnVuY3Rpb24gKHRva2VuKSB7CgkJdG9rZW4gKz0gIiI7CgkJdmFyIGluZGV4ID0gY2hlY2tUb2tlbkFuZEdldEluZGV4KHRoaXMsIHRva2VuKTsKCQlpZiAoaW5kZXggIT09IC0xKSB7CgkJCXRoaXMuc3BsaWNlKGluZGV4LCAxKTsKCQkJdGhpcy5fdXBkYXRlQ2xhc3NOYW1lKCk7CgkJfQoJfTsKCWNsYXNzTGlzdFByb3RvLnRvZ2dsZSA9IGZ1bmN0aW9uICh0b2tlbikgewoJCXRva2VuICs9ICIiOwoJCWlmIChjaGVja1Rva2VuQW5kR2V0SW5kZXgodGhpcywgdG9rZW4pID09PSAtMSkgewoJCQl0aGlzLmFkZCh0b2tlbik7CgkJfSBlbHNlIHsKCQkJdGhpcy5yZW1vdmUodG9rZW4pOwoJCX0KCX07CgljbGFzc0xpc3RQcm90by50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy5qb2luKCIgIik7Cgl9OwoKCWlmIChvYmpDdHIuZGVmaW5lUHJvcGVydHkpIHsKCQl2YXIgY2xhc3NMaXN0UHJvcERlc2MgPSB7CgkJCSAgZ2V0OiBjbGFzc0xpc3RHZXR0ZXIKCQkJLCBlbnVtZXJhYmxlOiB0cnVlCgkJCSwgY29uZmlndXJhYmxlOiB0cnVlCgkJfTsKCQl0cnkgewoJCQlvYmpDdHIuZGVmaW5lUHJvcGVydHkoZWxlbUN0clByb3RvLCBjbGFzc0xpc3RQcm9wLCBjbGFzc0xpc3RQcm9wRGVzYyk7CgkJfSBjYXRjaCAoZXgpIHsgLy8gSUUgOCBkb2Vzbid0IHN1cHBvcnQgZW51bWVyYWJsZTp0cnVlCgkJCWlmIChleC5udW1iZXIgPT09IC0weDdGRjVFQzU0KSB7CgkJCQljbGFzc0xpc3RQcm9wRGVzYy5lbnVtZXJhYmxlID0gZmFsc2U7CgkJCQlvYmpDdHIuZGVmaW5lUHJvcGVydHkoZWxlbUN0clByb3RvLCBjbGFzc0xpc3RQcm9wLCBjbGFzc0xpc3RQcm9wRGVzYyk7CgkJCX0KCQl9Cgl9IGVsc2UgaWYgKG9iakN0cltwcm90b1Byb3BdLl9fZGVmaW5lR2V0dGVyX18pIHsKCQllbGVtQ3RyUHJvdG8uX19kZWZpbmVHZXR0ZXJfXyhjbGFzc0xpc3RQcm9wLCBjbGFzc0xpc3RHZXR0ZXIpOwoJfQoKCX0od2luZG93KSk7CgoJfQp9OwoKaWYgKCAodHlwZW9mIFJJQ0tTSEFXX05PX0NPTVBBVCAhPT0gInVuZGVmaW5lZCIgJiYgIVJJQ0tTSEFXX05PX0NPTVBBVCkgfHwgdHlwZW9mIFJJQ0tTSEFXX05PX0NPTVBBVCA9PT0gInVuZGVmaW5lZCIpIHsKCW5ldyBSaWNrc2hhdy5Db21wYXQuQ2xhc3NMaXN0KCk7Cn0KUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaCcpOwoKUmlja3NoYXcuR3JhcGggPSBmdW5jdGlvbihhcmdzKSB7CgoJdmFyIHNlbGYgPSB0aGlzOwoKCXRoaXMuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGFyZ3MpIHsKCgkJaWYgKCFhcmdzLmVsZW1lbnQpIHRocm93ICJSaWNrc2hhdy5HcmFwaCBuZWVkcyBhIHJlZmVyZW5jZSB0byBhbiBlbGVtZW50IjsKCQlpZiAoYXJncy5lbGVtZW50Lm5vZGVUeXBlICE9PSAxKSB0aHJvdyAiUmlja3NoYXcuR3JhcGggZWxlbWVudCB3YXMgZGVmaW5lZCBidXQgbm90IGFuIEhUTUwgZWxlbWVudCI7CgoJCXRoaXMuZWxlbWVudCA9IGFyZ3MuZWxlbWVudDsKCQl0aGlzLnNlcmllcyA9IGFyZ3Muc2VyaWVzOwoJCXRoaXMud2luZG93ID0ge307CgoJCXRoaXMudXBkYXRlQ2FsbGJhY2tzID0gW107CgkJdGhpcy5jb25maWd1cmVDYWxsYmFja3MgPSBbXTsKCgkJdGhpcy5kZWZhdWx0cyA9IHsKCQkJaW50ZXJwb2xhdGlvbjogJ2NhcmRpbmFsJywKCQkJb2Zmc2V0OiAnemVybycsCgkJCW1pbjogdW5kZWZpbmVkLAoJCQltYXg6IHVuZGVmaW5lZCwKCQkJcHJlc2VydmU6IGZhbHNlLAoJCQl4U2NhbGU6IHVuZGVmaW5lZCwKCQkJeVNjYWxlOiB1bmRlZmluZWQsCgkJCXN0YWNrOiB0cnVlCgkJfTsKCgkJdGhpcy5fbG9hZFJlbmRlcmVycygpOwoJCXRoaXMuY29uZmlndXJlKGFyZ3MpOwoJCXRoaXMudmFsaWRhdGVTZXJpZXMoYXJncy5zZXJpZXMpOwoKCQl0aGlzLnNlcmllcy5hY3RpdmUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHNlbGYuc2VyaWVzLmZpbHRlciggZnVuY3Rpb24ocykgeyByZXR1cm4gIXMuZGlzYWJsZWQgfSApIH07CgkJdGhpcy5zZXRTaXplKHsgd2lkdGg6IGFyZ3Mud2lkdGgsIGhlaWdodDogYXJncy5oZWlnaHQgfSk7CgkJdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoJ3JpY2tzaGF3X2dyYXBoJyk7CgoJCXRoaXMudmlzID0gZDMuc2VsZWN0KHRoaXMuZWxlbWVudCkKCQkJLmFwcGVuZCgic3ZnOnN2ZyIpCgkJCS5hdHRyKCd3aWR0aCcsIHRoaXMud2lkdGgpCgkJCS5hdHRyKCdoZWlnaHQnLCB0aGlzLmhlaWdodCk7CgoJCXRoaXMuZGlzY292ZXJSYW5nZSgpOwoJfTsKCgl0aGlzLl9sb2FkUmVuZGVyZXJzID0gZnVuY3Rpb24oKSB7CgoJCWZvciAodmFyIG5hbWUgaW4gUmlja3NoYXcuR3JhcGguUmVuZGVyZXIpIHsKCQkJaWYgKCFuYW1lIHx8ICFSaWNrc2hhdy5HcmFwaC5SZW5kZXJlci5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgY29udGludWU7CgkJCXZhciByID0gUmlja3NoYXcuR3JhcGguUmVuZGVyZXJbbmFtZV07CgkJCWlmICghciB8fCAhci5wcm90b3R5cGUgfHwgIXIucHJvdG90eXBlLnJlbmRlcikgY29udGludWU7CgkJCXNlbGYucmVnaXN0ZXJSZW5kZXJlcihuZXcgciggeyBncmFwaDogc2VsZiB9ICkpOwoJCX0KCX07CgoJdGhpcy52YWxpZGF0ZVNlcmllcyA9IGZ1bmN0aW9uKHNlcmllcykgewoKCQlpZiAoIUFycmF5LmlzQXJyYXkoc2VyaWVzKSAmJiAhKHNlcmllcyBpbnN0YW5jZW9mIFJpY2tzaGF3LlNlcmllcykpIHsKCQkJdmFyIHNlcmllc1NpZ25hdHVyZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuYXBwbHkoc2VyaWVzKTsKCQkJdGhyb3cgInNlcmllcyBpcyBub3QgYW4gYXJyYXk6ICIgKyBzZXJpZXNTaWduYXR1cmU7CgkJfQoKCQl2YXIgcG9pbnRzQ291bnQ7CgoJCXNlcmllcy5mb3JFYWNoKCBmdW5jdGlvbihzKSB7CgoJCQlpZiAoIShzIGluc3RhbmNlb2YgT2JqZWN0KSkgewoJCQkJdGhyb3cgInNlcmllcyBlbGVtZW50IGlzIG5vdCBhbiBvYmplY3Q6ICIgKyBzOwoJCQl9CgkJCWlmICghKHMuZGF0YSkpIHsKCQkJCXRocm93ICJzZXJpZXMgaGFzIG5vIGRhdGE6ICIgKyBKU09OLnN0cmluZ2lmeShzKTsKCQkJfQoJCQlpZiAoIUFycmF5LmlzQXJyYXkocy5kYXRhKSkgewoJCQkJdGhyb3cgInNlcmllcyBkYXRhIGlzIG5vdCBhbiBhcnJheTogIiArIEpTT04uc3RyaW5naWZ5KHMuZGF0YSk7CgkJCX0KCQkJCgkJCWlmIChzLmRhdGEubGVuZ3RoID4gMCkgewoJCQkJdmFyIHggPSBzLmRhdGFbMF0ueDsKCQkJCXZhciB5ID0gcy5kYXRhWzBdLnk7CgoJCQkJaWYgKHR5cGVvZiB4ICE9ICdudW1iZXInIHx8ICggdHlwZW9mIHkgIT0gJ251bWJlcicgJiYgeSAhPT0gbnVsbCApICkgewoJCQkJCXRocm93ICJ4IGFuZCB5IHByb3BlcnRpZXMgb2YgcG9pbnRzIHNob3VsZCBiZSBudW1iZXJzIGluc3RlYWQgb2YgIiArCgkJCQkJCSh0eXBlb2YgeCkgKyAiIGFuZCAiICsgKHR5cGVvZiB5KTsKCQkJCX0KCQkJfQoKCQkJaWYgKHMuZGF0YS5sZW5ndGggPj0gMykgewoJCQkJLy8gcHJvYmUgdG8gc2FuaXR5IGNoZWNrIHNvcnQgb3JkZXIKCQkJCWlmIChzLmRhdGFbMl0ueCA8IHMuZGF0YVsxXS54IHx8IHMuZGF0YVsxXS54IDwgcy5kYXRhWzBdLnggfHwgcy5kYXRhW3MuZGF0YS5sZW5ndGggLSAxXS54IDwgcy5kYXRhWzBdLngpIHsKCQkJCQl0aHJvdyAic2VyaWVzIGRhdGEgbmVlZHMgdG8gYmUgc29ydGVkIG9uIHggdmFsdWVzIGZvciBzZXJpZXMgbmFtZTogIiArIHMubmFtZTsKCQkJCX0KCQkJfQoKCQl9LCB0aGlzICk7Cgl9OwoKCXRoaXMuZGF0YURvbWFpbiA9IGZ1bmN0aW9uKCkgewoKCQl2YXIgZGF0YSA9IHRoaXMuc2VyaWVzLm1hcCggZnVuY3Rpb24ocykgeyByZXR1cm4gcy5kYXRhIH0gKTsKCgkJdmFyIG1pbiA9IGQzLm1pbiggZGF0YS5tYXAoIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGRbMF0ueCB9ICkgKTsKCQl2YXIgbWF4ID0gZDMubWF4KCBkYXRhLm1hcCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZFtkLmxlbmd0aCAtIDFdLnggfSApICk7CgoJCXJldHVybiBbbWluLCBtYXhdOwoJfTsKCgl0aGlzLmRpc2NvdmVyUmFuZ2UgPSBmdW5jdGlvbigpIHsKCgkJdmFyIGRvbWFpbiA9IHRoaXMucmVuZGVyZXIuZG9tYWluKCk7CgoJCS8vIHRoaXMuKlNjYWxlIGlzIGNvbWluZyBmcm9tIHRoZSBjb25maWd1cmF0aW9uIGRpY3Rpb25hcnkKCQkvLyB3aGljaCBtYXkgYmUgcmVmZXJlbmNlZCBieSB0aGUgR3JhcGggY3JlYXRvciwgb3Igc2hhcmVkCgkJLy8gd2l0aCBvdGhlciBHcmFwaHMuIFdlIG5lZWQgdG8gZW5zdXJlIHdlIGNvcHkgdGhlIHNjYWxlCgkJLy8gc28gdGhhdCBvdXIgbXV0YXRpb25zIGRvIG5vdCBjaGFuZ2UgdGhlIG9iamVjdCBnaXZlbiB0byB1cy4KCQkvLyBIZW5jZSB0aGUgLmNvcHkoKQoJCXRoaXMueCA9ICh0aGlzLnhTY2FsZSB8fCBkMy5zY2FsZS5saW5lYXIoKSkuY29weSgpLmRvbWFpbihkb21haW4ueCkucmFuZ2UoWzAsIHRoaXMud2lkdGhdKTsKCQl0aGlzLnkgPSAodGhpcy55U2NhbGUgfHwgZDMuc2NhbGUubGluZWFyKCkpLmNvcHkoKS5kb21haW4oZG9tYWluLnkpLnJhbmdlKFt0aGlzLmhlaWdodCwgMF0pOwoKCQl0aGlzLngubWFnbml0dWRlID0gZDMuc2NhbGUubGluZWFyKCkKCQkJLmRvbWFpbihbZG9tYWluLnhbMF0gLSBkb21haW4ueFswXSwgZG9tYWluLnhbMV0gLSBkb21haW4ueFswXV0pCgkJCS5yYW5nZShbMCwgdGhpcy53aWR0aF0pOwoKCQl0aGlzLnkubWFnbml0dWRlID0gZDMuc2NhbGUubGluZWFyKCkKCQkJLmRvbWFpbihbZG9tYWluLnlbMF0gLSBkb21haW4ueVswXSwgZG9tYWluLnlbMV0gLSBkb21haW4ueVswXV0pCgkJCS5yYW5nZShbMCwgdGhpcy5oZWlnaHRdKTsKCX07CgoJdGhpcy5yZW5kZXIgPSBmdW5jdGlvbigpIHsKCgkJdmFyIHN0YWNrZWREYXRhID0gdGhpcy5zdGFja0RhdGEoKTsKCQl0aGlzLmRpc2NvdmVyUmFuZ2UoKTsKCgkJdGhpcy5yZW5kZXJlci5yZW5kZXIoKTsKCgkJdGhpcy51cGRhdGVDYWxsYmFja3MuZm9yRWFjaCggZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJY2FsbGJhY2soKTsKCQl9ICk7CgoJfTsKCgl0aGlzLnVwZGF0ZSA9IHRoaXMucmVuZGVyOwoKCXRoaXMuc3RhY2tEYXRhID0gZnVuY3Rpb24oKSB7CgoJCXZhciBkYXRhID0gdGhpcy5zZXJpZXMuYWN0aXZlKCkKCQkJLm1hcCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5kYXRhIH0gKQoJCQkubWFwKCBmdW5jdGlvbihkKSB7IHJldHVybiBkLmZpbHRlciggZnVuY3Rpb24oZCkgeyByZXR1cm4gdGhpcy5fc2xpY2UoZCkgfSwgdGhpcyApIH0sIHRoaXMpOwoKCQl2YXIgcHJlc2VydmUgPSB0aGlzLnByZXNlcnZlOwoJCWlmICghcHJlc2VydmUpIHsKCQkJdGhpcy5zZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24oc2VyaWVzKSB7CgkJCQlpZiAoc2VyaWVzLnNjYWxlKSB7CgkJCQkJLy8gZGF0YSBtdXN0IGJlIHByZXNlcnZlZCB3aGVuIGEgc2NhbGUgaXMgdXNlZAoJCQkJCXByZXNlcnZlID0gdHJ1ZTsKCQkJCX0KCQkJfSApOwoJCX0KCgkJZGF0YSA9IHByZXNlcnZlID8gUmlja3NoYXcuY2xvbmUoZGF0YSkgOiBkYXRhOwoKCQl0aGlzLnNlcmllcy5hY3RpdmUoKS5mb3JFYWNoKCBmdW5jdGlvbihzZXJpZXMsIGluZGV4KSB7CgkJCWlmIChzZXJpZXMuc2NhbGUpIHsKCQkJCS8vIGFwcGx5IHNjYWxlIHRvIGVhY2ggc2VyaWVzCgkJCQl2YXIgc2VyaWVzRGF0YSA9IGRhdGFbaW5kZXhdOwoJCQkJaWYoc2VyaWVzRGF0YSkgewoJCQkJCXNlcmllc0RhdGEuZm9yRWFjaCggZnVuY3Rpb24oZCkgewoJCQkJCQlkLnkgPSBzZXJpZXMuc2NhbGUoZC55KTsKCQkJCQl9ICk7CgkJCQl9CgkJCX0KCQl9ICk7CgoJCXRoaXMuc3RhY2tEYXRhLmhvb2tzLmRhdGEuZm9yRWFjaCggZnVuY3Rpb24oZW50cnkpIHsKCQkJZGF0YSA9IGVudHJ5LmYuYXBwbHkoc2VsZiwgW2RhdGFdKTsKCQl9ICk7CgoJCXZhciBzdGFja2VkRGF0YTsKCgkJaWYgKCF0aGlzLnJlbmRlcmVyLnVuc3RhY2spIHsKCgkJCXRoaXMuX3ZhbGlkYXRlU3RhY2thYmxlKCk7CgoJCQl2YXIgbGF5b3V0ID0gZDMubGF5b3V0LnN0YWNrKCk7CgkJCWxheW91dC5vZmZzZXQoIHNlbGYub2Zmc2V0ICk7CgkJCXN0YWNrZWREYXRhID0gbGF5b3V0KGRhdGEpOwoJCX0KCgkJc3RhY2tlZERhdGEgPSBzdGFja2VkRGF0YSB8fCBkYXRhOwoKCQlpZiAodGhpcy5yZW5kZXJlci51bnN0YWNrKSB7CgkJCXN0YWNrZWREYXRhLmZvckVhY2goIGZ1bmN0aW9uKHNlcmllc0RhdGEpIHsKCQkJCXNlcmllc0RhdGEuZm9yRWFjaCggZnVuY3Rpb24oZCkgewoJCQkJCWQueTAgPSBkLnkwID09PSB1bmRlZmluZWQgPyAwIDogZC55MDsKCQkJCX0gKTsKCQkJfSApOwoJCX0KCgkJdGhpcy5zdGFja0RhdGEuaG9va3MuYWZ0ZXIuZm9yRWFjaCggZnVuY3Rpb24oZW50cnkpIHsKCQkJc3RhY2tlZERhdGEgPSBlbnRyeS5mLmFwcGx5KHNlbGYsIFtkYXRhXSk7CgkJfSApOwoKCQl2YXIgaSA9IDA7CgkJdGhpcy5zZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24oc2VyaWVzKSB7CgkJCWlmIChzZXJpZXMuZGlzYWJsZWQpIHJldHVybjsKCQkJc2VyaWVzLnN0YWNrID0gc3RhY2tlZERhdGFbaSsrXTsKCQl9ICk7CgoJCXRoaXMuc3RhY2tlZERhdGEgPSBzdGFja2VkRGF0YTsKCQlyZXR1cm4gc3RhY2tlZERhdGE7Cgl9OwoKCXRoaXMuX3ZhbGlkYXRlU3RhY2thYmxlID0gZnVuY3Rpb24oKSB7CgoJCXZhciBzZXJpZXMgPSB0aGlzLnNlcmllczsKCQl2YXIgcG9pbnRzQ291bnQ7CgoJCXNlcmllcy5mb3JFYWNoKCBmdW5jdGlvbihzKSB7CgoJCQlwb2ludHNDb3VudCA9IHBvaW50c0NvdW50IHx8IHMuZGF0YS5sZW5ndGg7CgoJCQlpZiAocG9pbnRzQ291bnQgJiYgcy5kYXRhLmxlbmd0aCAhPSBwb2ludHNDb3VudCkgewoJCQkJdGhyb3cgInN0YWNrZWQgc2VyaWVzIGNhbm5vdCBoYXZlIGRpZmZlcmluZyBudW1iZXJzIG9mIHBvaW50czogIiArCgkJCQkJcG9pbnRzQ291bnQgKyAiIHZzICIgKyBzLmRhdGEubGVuZ3RoICsgIjsgc2VlIFJpY2tzaGF3LlNlcmllcy5maWxsKCkiOwoJCQl9CgoJCX0sIHRoaXMgKTsKCX07CgoJdGhpcy5zdGFja0RhdGEuaG9va3MgPSB7IGRhdGE6IFtdLCBhZnRlcjogW10gfTsKCgl0aGlzLl9zbGljZSA9IGZ1bmN0aW9uKGQpIHsKCgkJaWYgKHRoaXMud2luZG93LnhNaW4gfHwgdGhpcy53aW5kb3cueE1heCkgewoKCQkJdmFyIGlzSW5SYW5nZSA9IHRydWU7CgoJCQlpZiAodGhpcy53aW5kb3cueE1pbiAmJiBkLnggPCB0aGlzLndpbmRvdy54TWluKSBpc0luUmFuZ2UgPSBmYWxzZTsKCQkJaWYgKHRoaXMud2luZG93LnhNYXggJiYgZC54ID4gdGhpcy53aW5kb3cueE1heCkgaXNJblJhbmdlID0gZmFsc2U7CgoJCQlyZXR1cm4gaXNJblJhbmdlOwoJCX0KCgkJcmV0dXJuIHRydWU7Cgl9OwoKCXRoaXMub25VcGRhdGUgPSBmdW5jdGlvbihjYWxsYmFjaykgewoJCXRoaXMudXBkYXRlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwoJfTsKCgl0aGlzLm9uQ29uZmlndXJlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKCQl0aGlzLmNvbmZpZ3VyZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKCX07CgoJdGhpcy5yZWdpc3RlclJlbmRlcmVyID0gZnVuY3Rpb24ocmVuZGVyZXIpIHsKCQl0aGlzLl9yZW5kZXJlcnMgPSB0aGlzLl9yZW5kZXJlcnMgfHwge307CgkJdGhpcy5fcmVuZGVyZXJzW3JlbmRlcmVyLm5hbWVdID0gcmVuZGVyZXI7Cgl9OwoKCXRoaXMuY29uZmlndXJlID0gZnVuY3Rpb24oYXJncykgewoKCQl0aGlzLmNvbmZpZyA9IHRoaXMuY29uZmlnIHx8IHt9OwoKCQlpZiAoYXJncy53aWR0aCB8fCBhcmdzLmhlaWdodCkgewoJCQl0aGlzLnNldFNpemUoYXJncyk7CgkJfQoKCQlSaWNrc2hhdy5rZXlzKHRoaXMuZGVmYXVsdHMpLmZvckVhY2goIGZ1bmN0aW9uKGspIHsKCQkJdGhpcy5jb25maWdba10gPSBrIGluIGFyZ3MgPyBhcmdzW2tdCgkJCQk6IGsgaW4gdGhpcyA\/IHRoaXNba10KCQkJCTogdGhpcy5kZWZhdWx0c1trXTsKCQl9LCB0aGlzICk7CgoJCVJpY2tzaGF3LmtleXModGhpcy5jb25maWcpLmZvckVhY2goIGZ1bmN0aW9uKGspIHsKCQkJdGhpc1trXSA9IHRoaXMuY29uZmlnW2tdOwoJCX0sIHRoaXMgKTsKCgkJaWYgKCdzdGFjaycgaW4gYXJncykgYXJncy51bnN0YWNrID0gIWFyZ3Muc3RhY2s7CgoJCXZhciByZW5kZXJlciA9IGFyZ3MucmVuZGVyZXIgfHwgKHRoaXMucmVuZGVyZXIgJiYgdGhpcy5yZW5kZXJlci5uYW1lKSB8fCAnc3RhY2snOwoJCXRoaXMuc2V0UmVuZGVyZXIocmVuZGVyZXIsIGFyZ3MpOwoKCQl0aGlzLmNvbmZpZ3VyZUNhbGxiYWNrcy5mb3JFYWNoKCBmdW5jdGlvbihjYWxsYmFjaykgewoJCQljYWxsYmFjayhhcmdzKTsKCQl9ICk7Cgl9OwoKCXRoaXMuc2V0UmVuZGVyZXIgPSBmdW5jdGlvbihyLCBhcmdzKSB7CgkJaWYgKHR5cGVvZiByID09ICdmdW5jdGlvbicpIHsKCQkJdGhpcy5yZW5kZXJlciA9IG5ldyByKCB7IGdyYXBoOiBzZWxmIH0gKTsKCQkJdGhpcy5yZWdpc3RlclJlbmRlcmVyKHRoaXMucmVuZGVyZXIpOwoJCX0gZWxzZSB7CgkJCWlmICghdGhpcy5fcmVuZGVyZXJzW3JdKSB7CgkJCQl0aHJvdyAiY291bGRuJ3QgZmluZCByZW5kZXJlciAiICsgcjsKCQkJfQoJCQl0aGlzLnJlbmRlcmVyID0gdGhpcy5fcmVuZGVyZXJzW3JdOwoJCX0KCgkJaWYgKHR5cGVvZiBhcmdzID09ICdvYmplY3QnKSB7CgkJCXRoaXMucmVuZGVyZXIuY29uZmlndXJlKGFyZ3MpOwoJCX0KCX07CgoJdGhpcy5zZXRTaXplID0gZnVuY3Rpb24oYXJncykgewoKCQlhcmdzID0gYXJncyB8fCB7fTsKCgkJaWYgKHR5cGVvZiB3aW5kb3cgIT09IHVuZGVmaW5lZCkgewoJCQl2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLmVsZW1lbnQsIG51bGwpOwoJCQl2YXIgZWxlbWVudFdpZHRoID0gcGFyc2VJbnQoc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgnd2lkdGgnKSwgMTApOwoJCQl2YXIgZWxlbWVudEhlaWdodCA9IHBhcnNlSW50KHN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2hlaWdodCcpLCAxMCk7CgkJfQoKCQl0aGlzLndpZHRoID0gYXJncy53aWR0aCB8fCBlbGVtZW50V2lkdGggfHwgNDAwOwoJCXRoaXMuaGVpZ2h0ID0gYXJncy5oZWlnaHQgfHwgZWxlbWVudEhlaWdodCB8fCAyNTA7CgoJCXRoaXMudmlzICYmIHRoaXMudmlzCgkJCS5hdHRyKCd3aWR0aCcsIHRoaXMud2lkdGgpCgkJCS5hdHRyKCdoZWlnaHQnLCB0aGlzLmhlaWdodCk7Cgl9OwoKCXRoaXMuaW5pdGlhbGl6ZShhcmdzKTsKfTsKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5GaXh0dXJlcy5Db2xvcicpOwoKUmlja3NoYXcuRml4dHVyZXMuQ29sb3IgPSBmdW5jdGlvbigpIHsKCgl0aGlzLnNjaGVtZXMgPSB7fTsKCgl0aGlzLnNjaGVtZXMuc3BlY3RydW0xNCA9IFsKCQknI2VjYjc5NicsCgkJJyNkYzhmNzAnLAoJCScjYjJhNDcwJywKCQknIzkyODc1YScsCgkJJyM3MTZjNDknLAoJCScjZDJlZDgyJywKCQknI2JiZTQ2OCcsCgkJJyNhMWQwNWQnLAoJCScjZTdjYmU2JywKCQknI2Q4YWFkNicsCgkJJyNhODg4YzInLAoJCScjOWRjMmQzJywKCQknIzY0OWViOScsCgkJJyMzODdhYTMnCgldLnJldmVyc2UoKTsKCgl0aGlzLnNjaGVtZXMuc3BlY3RydW0yMDAwID0gWwoJCScjNTczMDZmJywKCQknIzUxNGM3NicsCgkJJyM2NDY1ODMnLAoJCScjNzM4Mzk0JywKCQknIzZiOWM3ZCcsCgkJJyM4NGI2NjUnLAoJCScjYTdjYTUwJywKCQknI2JmZTc0NicsCgkJJyNlMmY1MjgnLAoJCScjZmZmNzI2JywKCQknI2VjZGQwMCcsCgkJJyNkNGIxMWQnLAoJCScjZGU4ODAwJywKCQknI2RlNDgwMCcsCgkJJyNjOTE1MTUnLAoJCScjOWEwMDAwJywKCQknIzdiMDQyOScsCgkJJyM1ODA4MzknLAoJCScjMzEwODJiJwoJXTsKCgl0aGlzLnNjaGVtZXMuc3BlY3RydW0yMDAxID0gWwoJCScjMmYyNDNmJywKCQknIzNjMmM1NScsCgkJJyM0YTM3NjgnLAoJCScjNTY1MjcwJywKCQknIzZiNmI3YycsCgkJJyM3Mjk1N2YnLAoJCScjODZhZDZlJywKCQknI2ExYmM1ZScsCgkJJyNiOGQ5NTQnLAoJCScjZDNlMDRlJywKCQknI2NjYWQyYScsCgkJJyNjYzg0MTInLAoJCScjYzE1MjFkJywKCQknI2FkMzgyMScsCgkJJyM4YTEwMTAnLAoJCScjNjgxNzE3JywKCQknIzUzMWUxZScsCgkJJyMzZDE4MTgnLAoJCScjMzIwYTFiJwoJXTsKCgl0aGlzLnNjaGVtZXMuY2xhc3NpYzkgPSBbCgkJJyM0MjNkNGYnLAoJCScjNGE2ODYwJywKCQknIzg0OGYzOScsCgkJJyNhMmI3M2MnLAoJCScjZGRjYjUzJywKCQknI2M1YTMyZicsCgkJJyM3ZDU4MzYnLAoJCScjOTYzYjIwJywKCQknIzdjMjYyNicsCgkJJyM0OTFkMzcnLAoJCScjMmYyNTRhJwoJXS5yZXZlcnNlKCk7CgoJdGhpcy5zY2hlbWVzLmh0dHBTdGF0dXMgPSB7CgkJNTAzOiAnI2VhNTAyOScsCgkJNTAyOiAnI2QyM2YxNCcsCgkJNTAwOiAnI2JmMzYxMycsCgkJNDEwOiAnI2VmYWNlYScsCgkJNDA5OiAnI2UyOTFkYycsCgkJNDAzOiAnI2Y0NTdlOCcsCgkJNDA4OiAnI2UxMjFkMicsCgkJNDAxOiAnI2I5MmRhZScsCgkJNDA1OiAnI2Y0N2NlYicsCgkJNDA0OiAnI2E4MmE5ZicsCgkJNDAwOiAnI2IyNjNjNicsCgkJMzAxOiAnIzZmYTAyNCcsCgkJMzAyOiAnIzg3YzMyYicsCgkJMzA3OiAnI2EwZDg0YycsCgkJMzA0OiAnIzI4YjU1YycsCgkJMjAwOiAnIzFhNGY3NCcsCgkJMjA2OiAnIzI3ODM5ZicsCgkJMjAxOiAnIzUyYWRjOScsCgkJMjAyOiAnIzdjOTc5ZicsCgkJMjAzOiAnI2E1YjhiZCcsCgkJMjA0OiAnI2MxY2RkMScKCX07CgoJdGhpcy5zY2hlbWVzLmNvbG9yd2hlZWwgPSBbCgkJJyNiNWI2YTknLAoJCScjODU4NzcyJywKCQknIzc4NWY0MycsCgkJJyM5NjU1N2UnLAoJCScjNDY4MmI0JywKCQknIzY1YjlhYycsCgkJJyM3M2MwM2EnLAoJCScjY2I1MTNhJwoJXS5yZXZlcnNlKCk7CgoJdGhpcy5zY2hlbWVzLmNvb2wgPSBbCgkJJyM1ZTlkMmYnLAoJCScjNzNjMDNhJywKCQknIzQ2ODJiNCcsCgkJJyM3YmMzYjgnLAoJCScjYTk4ODRlJywKCQknI2MxYjI2NicsCgkJJyNhNDc0OTMnLAoJCScjYzA5ZmI1JwoJXTsKCgl0aGlzLnNjaGVtZXMubXVuaW4gPSBbCgkJJyMwMGNjMDAnLAoJCScjMDA2NmIzJywKCQknI2ZmODAwMCcsCgkJJyNmZmNjMDAnLAoJCScjMzMwMDk5JywKCQknIzk5MDA5OScsCgkJJyNjY2ZmMDAnLAoJCScjZmYwMDAwJywKCQknIzgwODA4MCcsCgkJJyMwMDhmMDAnLAoJCScjMDA0ODdkJywKCQknI2IzNWEwMCcsCgkJJyNiMzhmMDAnLAoJCScjNmIwMDZiJywKCQknIzhmYjMwMCcsCgkJJyNiMzAwMDAnLAoJCScjYmViZWJlJywKCQknIzgwZmY4MCcsCgkJJyM4MGM5ZmYnLAoJCScjZmZjMDgwJywKCQknI2ZmZTY4MCcsCgkJJyNhYTgwZmYnLAoJCScjZWUwMGNjJywKCQknI2ZmODA4MCcsCgkJJyM2NjY2MDAnLAoJCScjZmZiZmZmJywKCQknIzAwZmZjYycsCgkJJyNjYzY2OTknLAoJCScjOTk5OTAwJwoJXTsKfTsKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5GaXh0dXJlcy5SYW5kb21EYXRhJyk7CgpSaWNrc2hhdy5GaXh0dXJlcy5SYW5kb21EYXRhID0gZnVuY3Rpb24odGltZUludGVydmFsKSB7CgoJdmFyIGFkZERhdGE7Cgl0aW1lSW50ZXJ2YWwgPSB0aW1lSW50ZXJ2YWwgfHwgMTsKCgl2YXIgbGFzdFJhbmRvbVZhbHVlID0gMjAwOwoKCXZhciB0aW1lQmFzZSA9IE1hdGguZmxvb3IobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKTsKCgl0aGlzLmFkZERhdGEgPSBmdW5jdGlvbihkYXRhKSB7CgoJCXZhciByYW5kb21WYWx1ZSA9IE1hdGgucmFuZG9tKCkgKiAxMDAgKyAxNSArIGxhc3RSYW5kb21WYWx1ZTsKCQl2YXIgaW5kZXggPSBkYXRhWzBdLmxlbmd0aDsKCgkJdmFyIGNvdW50ZXIgPSAxOwoKCQlkYXRhLmZvckVhY2goIGZ1bmN0aW9uKHNlcmllcykgewoJCQl2YXIgcmFuZG9tVmFyaWFuY2UgPSBNYXRoLnJhbmRvbSgpICogMjA7CgkJCXZhciB2ID0gcmFuZG9tVmFsdWUgLyAyNSAgKyBjb3VudGVyKysgKwoJCQkJKE1hdGguY29zKChpbmRleCAqIGNvdW50ZXIgKiAxMSkgLyA5NjApICsgMikgKiAxNSArCgkJCQkoTWF0aC5jb3MoaW5kZXggLyA3KSArIDIpICogNyArCgkJCQkoTWF0aC5jb3MoaW5kZXggLyAxNykgKyAyKSAqIDE7CgoJCQlzZXJpZXMucHVzaCggeyB4OiAoaW5kZXggKiB0aW1lSW50ZXJ2YWwpICsgdGltZUJhc2UsIHk6IHYgKyByYW5kb21WYXJpYW5jZSB9ICk7CgkJfSApOwoKCQlsYXN0UmFuZG9tVmFsdWUgPSByYW5kb21WYWx1ZSAqIDAuODU7Cgl9OwoKCXRoaXMucmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKGRhdGEpIHsKCQlkYXRhLmZvckVhY2goIGZ1bmN0aW9uKHNlcmllcykgewoJCQlzZXJpZXMuc2hpZnQoKTsKCQl9ICk7CgkJdGltZUJhc2UgKz0gdGltZUludGVydmFsOwoJfTsKfTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuRml4dHVyZXMuVGltZScpOwoKUmlja3NoYXcuRml4dHVyZXMuVGltZSA9IGZ1bmN0aW9uKCkgewoKCXZhciBzZWxmID0gdGhpczsKCgl0aGlzLm1vbnRocyA9IFsnSmFuJywgJ0ZlYicsICdNYXInLCAnQXByJywgJ01heScsICdKdW4nLCAnSnVsJywgJ0F1ZycsICdTZXAnLCAnT2N0JywgJ05vdicsICdEZWMnXTsKCgl0aGlzLnVuaXRzID0gWwoJCXsKCQkJbmFtZTogJ2RlY2FkZScsCgkJCXNlY29uZHM6IDg2NDAwICogMzY1LjI1ICogMTAsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gKHBhcnNlSW50KGQuZ2V0VVRDRnVsbFllYXIoKSAvIDEwLCAxMCkgKiAxMCkgfQoJCX0sIHsKCQkJbmFtZTogJ3llYXInLAoJCQlzZWNvbmRzOiA4NjQwMCAqIDM2NS4yNSwKCQkJZm9ybWF0dGVyOiBmdW5jdGlvbihkKSB7IHJldHVybiBkLmdldFVUQ0Z1bGxZZWFyKCkgfQoJCX0sIHsKCQkJbmFtZTogJ21vbnRoJywKCQkJc2Vjb25kczogODY0MDAgKiAzMC41LAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIHNlbGYubW9udGhzW2QuZ2V0VVRDTW9udGgoKV0gfQoJCX0sIHsKCQkJbmFtZTogJ3dlZWsnLAoJCQlzZWNvbmRzOiA4NjQwMCAqIDcsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gc2VsZi5mb3JtYXREYXRlKGQpIH0KCQl9LCB7CgkJCW5hbWU6ICdkYXknLAoJCQlzZWNvbmRzOiA4NjQwMCwKCQkJZm9ybWF0dGVyOiBmdW5jdGlvbihkKSB7IHJldHVybiBkLmdldFVUQ0RhdGUoKSB9CgkJfSwgewoJCQluYW1lOiAnNiBob3VyJywKCQkJc2Vjb25kczogMzYwMCAqIDYsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gc2VsZi5mb3JtYXRUaW1lKGQpIH0KCQl9LCB7CgkJCW5hbWU6ICdob3VyJywKCQkJc2Vjb25kczogMzYwMCwKCQkJZm9ybWF0dGVyOiBmdW5jdGlvbihkKSB7IHJldHVybiBzZWxmLmZvcm1hdFRpbWUoZCkgfQoJCX0sIHsKCQkJbmFtZTogJzE1IG1pbnV0ZScsCgkJCXNlY29uZHM6IDYwICogMTUsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gc2VsZi5mb3JtYXRUaW1lKGQpIH0KCQl9LCB7CgkJCW5hbWU6ICdtaW51dGUnLAoJCQlzZWNvbmRzOiA2MCwKCQkJZm9ybWF0dGVyOiBmdW5jdGlvbihkKSB7IHJldHVybiBkLmdldFVUQ01pbnV0ZXMoKSB9CgkJfSwgewoJCQluYW1lOiAnMTUgc2Vjb25kJywKCQkJc2Vjb25kczogMTUsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5nZXRVVENTZWNvbmRzKCkgKyAncycgfQoJCX0sIHsKCQkJbmFtZTogJ3NlY29uZCcsCgkJCXNlY29uZHM6IDEsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5nZXRVVENTZWNvbmRzKCkgKyAncycgfQoJCX0sIHsKCQkJbmFtZTogJ2RlY2lzZWNvbmQnLAoJCQlzZWNvbmRzOiAxLzEwLAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQuZ2V0VVRDTWlsbGlzZWNvbmRzKCkgKyAnbXMnIH0KCQl9LCB7CgkJCW5hbWU6ICdjZW50aXNlY29uZCcsCgkJCXNlY29uZHM6IDEvMTAwLAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQuZ2V0VVRDTWlsbGlzZWNvbmRzKCkgKyAnbXMnIH0KCQl9CgldOwoKCXRoaXMudW5pdCA9IGZ1bmN0aW9uKHVuaXROYW1lKSB7CgkJcmV0dXJuIHRoaXMudW5pdHMuZmlsdGVyKCBmdW5jdGlvbih1bml0KSB7IHJldHVybiB1bml0TmFtZSA9PSB1bml0Lm5hbWUgfSApLnNoaWZ0KCk7Cgl9OwoKCXRoaXMuZm9ybWF0RGF0ZSA9IGZ1bmN0aW9uKGQpIHsKCQlyZXR1cm4gZDMudGltZS5mb3JtYXQoJyViICVlJykoZCk7Cgl9OwoKCXRoaXMuZm9ybWF0VGltZSA9IGZ1bmN0aW9uKGQpIHsKCQlyZXR1cm4gZC50b1VUQ1N0cmluZygpLm1hdGNoKC8oXGQrOlxkKyk6LylbMV07Cgl9OwoKCXRoaXMuY2VpbCA9IGZ1bmN0aW9uKHRpbWUsIHVuaXQpIHsKCgkJdmFyIGRhdGUsIGZsb29yLCB5ZWFyOwoKCQlpZiAodW5pdC5uYW1lID09ICdtb250aCcpIHsKCgkJCWRhdGUgPSBuZXcgRGF0ZSh0aW1lICogMTAwMCk7CgoJCQlmbG9vciA9IERhdGUuVVRDKGRhdGUuZ2V0VVRDRnVsbFllYXIoKSwgZGF0ZS5nZXRVVENNb250aCgpKSAvIDEwMDA7CgkJCWlmIChmbG9vciA9PSB0aW1lKSByZXR1cm4gdGltZTsKCgkJCXllYXIgPSBkYXRlLmdldFVUQ0Z1bGxZZWFyKCk7CgkJCXZhciBtb250aCA9IGRhdGUuZ2V0VVRDTW9udGgoKTsKCgkJCWlmIChtb250aCA9PSAxMSkgewoJCQkJbW9udGggPSAwOwoJCQkJeWVhciA9IHllYXIgKyAxOwoJCQl9IGVsc2UgewoJCQkJbW9udGggKz0gMTsKCQkJfQoKCQkJcmV0dXJuIERhdGUuVVRDKHllYXIsIG1vbnRoKSAvIDEwMDA7CgkJfQoKCQlpZiAodW5pdC5uYW1lID09ICd5ZWFyJykgewoKCQkJZGF0ZSA9IG5ldyBEYXRlKHRpbWUgKiAxMDAwKTsKCgkJCWZsb29yID0gRGF0ZS5VVEMoZGF0ZS5nZXRVVENGdWxsWWVhcigpLCAwKSAvIDEwMDA7CgkJCWlmIChmbG9vciA9PSB0aW1lKSByZXR1cm4gdGltZTsKCgkJCXllYXIgPSBkYXRlLmdldFVUQ0Z1bGxZZWFyKCkgKyAxOwoKCQkJcmV0dXJuIERhdGUuVVRDKHllYXIsIDApIC8gMTAwMDsKCQl9CgoJCXJldHVybiBNYXRoLmNlaWwodGltZSAvIHVuaXQuc2Vjb25kcykgKiB1bml0LnNlY29uZHM7Cgl9Owp9OwpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkZpeHR1cmVzLlRpbWUuTG9jYWwnKTsKClJpY2tzaGF3LkZpeHR1cmVzLlRpbWUuTG9jYWwgPSBmdW5jdGlvbigpIHsKCgl2YXIgc2VsZiA9IHRoaXM7CgoJdGhpcy5tb250aHMgPSBbJ0phbicsICdGZWInLCAnTWFyJywgJ0FwcicsICdNYXknLCAnSnVuJywgJ0p1bCcsICdBdWcnLCAnU2VwJywgJ09jdCcsICdOb3YnLCAnRGVjJ107CgoJdGhpcy51bml0cyA9IFsKCQl7CgkJCW5hbWU6ICdkZWNhZGUnLAoJCQlzZWNvbmRzOiA4NjQwMCAqIDM2NS4yNSAqIDEwLAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIChwYXJzZUludChkLmdldEZ1bGxZZWFyKCkgLyAxMCwgMTApICogMTApIH0KCQl9LCB7CgkJCW5hbWU6ICd5ZWFyJywKCQkJc2Vjb25kczogODY0MDAgKiAzNjUuMjUsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5nZXRGdWxsWWVhcigpIH0KCQl9LCB7CgkJCW5hbWU6ICdtb250aCcsCgkJCXNlY29uZHM6IDg2NDAwICogMzAuNSwKCQkJZm9ybWF0dGVyOiBmdW5jdGlvbihkKSB7IHJldHVybiBzZWxmLm1vbnRoc1tkLmdldE1vbnRoKCldIH0KCQl9LCB7CgkJCW5hbWU6ICd3ZWVrJywKCQkJc2Vjb25kczogODY0MDAgKiA3LAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIHNlbGYuZm9ybWF0RGF0ZShkKSB9CgkJfSwgewoJCQluYW1lOiAnZGF5JywKCQkJc2Vjb25kczogODY0MDAsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5nZXREYXRlKCkgfQoJCX0sIHsKCQkJbmFtZTogJzYgaG91cicsCgkJCXNlY29uZHM6IDM2MDAgKiA2LAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIHNlbGYuZm9ybWF0VGltZShkKSB9CgkJfSwgewoJCQluYW1lOiAnaG91cicsCgkJCXNlY29uZHM6IDM2MDAsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gc2VsZi5mb3JtYXRUaW1lKGQpIH0KCQl9LCB7CgkJCW5hbWU6ICcxNSBtaW51dGUnLAoJCQlzZWNvbmRzOiA2MCAqIDE1LAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIHNlbGYuZm9ybWF0VGltZShkKSB9CgkJfSwgewoJCQluYW1lOiAnbWludXRlJywKCQkJc2Vjb25kczogNjAsCgkJCWZvcm1hdHRlcjogZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5nZXRNaW51dGVzKCkgfQoJCX0sIHsKCQkJbmFtZTogJzE1IHNlY29uZCcsCgkJCXNlY29uZHM6IDE1LAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQuZ2V0U2Vjb25kcygpICsgJ3MnIH0KCQl9LCB7CgkJCW5hbWU6ICdzZWNvbmQnLAoJCQlzZWNvbmRzOiAxLAoJCQlmb3JtYXR0ZXI6IGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQuZ2V0U2Vjb25kcygpICsgJ3MnIH0KCQl9LCB7CgkJCW5hbWU6ICdkZWNpc2Vjb25kJywKCQkJc2Vjb25kczogMS8xMCwKCQkJZm9ybWF0dGVyOiBmdW5jdGlvbihkKSB7IHJldHVybiBkLmdldE1pbGxpc2Vjb25kcygpICsgJ21zJyB9CgkJfSwgewoJCQluYW1lOiAnY2VudGlzZWNvbmQnLAoJCQlzZWNvbmRzOiAxLzEwMCwKCQkJZm9ybWF0dGVyOiBmdW5jdGlvbihkKSB7IHJldHVybiBkLmdldE1pbGxpc2Vjb25kcygpICsgJ21zJyB9CgkJfQoJXTsKCgl0aGlzLnVuaXQgPSBmdW5jdGlvbih1bml0TmFtZSkgewoJCXJldHVybiB0aGlzLnVuaXRzLmZpbHRlciggZnVuY3Rpb24odW5pdCkgeyByZXR1cm4gdW5pdE5hbWUgPT0gdW5pdC5uYW1lIH0gKS5zaGlmdCgpOwoJfTsKCgl0aGlzLmZvcm1hdERhdGUgPSBmdW5jdGlvbihkKSB7CgkJcmV0dXJuIGQzLnRpbWUuZm9ybWF0KCclYiAlZScpKGQpOwoJfTsKCgl0aGlzLmZvcm1hdFRpbWUgPSBmdW5jdGlvbihkKSB7CgkJcmV0dXJuIGQudG9TdHJpbmcoKS5tYXRjaCgvKFxkKzpcZCspOi8pWzFdOwoJfTsKCgl0aGlzLmNlaWwgPSBmdW5jdGlvbih0aW1lLCB1bml0KSB7CgoJCXZhciBkYXRlLCBmbG9vciwgeWVhcjsKCgkJaWYgKHVuaXQubmFtZSA9PSAnZGF5JykgewoKCQkJdmFyIG5lYXJGdXR1cmUgPSBuZXcgRGF0ZSgodGltZSArIHVuaXQuc2Vjb25kcyAtIDEpICogMTAwMCk7CgoJCQl2YXIgcm91bmRlZCA9IG5ldyBEYXRlKDApOwoJCQlyb3VuZGVkLnNldE1pbGxpc2Vjb25kcygwKTsKCQkJcm91bmRlZC5zZXRTZWNvbmRzKDApOwoJCQlyb3VuZGVkLnNldE1pbnV0ZXMoMCk7CgkJCXJvdW5kZWQuc2V0SG91cnMoMCk7CgkJCXJvdW5kZWQuc2V0RGF0ZShuZWFyRnV0dXJlLmdldERhdGUoKSk7CgkJCXJvdW5kZWQuc2V0TW9udGgobmVhckZ1dHVyZS5nZXRNb250aCgpKTsKCQkJcm91bmRlZC5zZXRGdWxsWWVhcihuZWFyRnV0dXJlLmdldEZ1bGxZZWFyKCkpOwoKCQkJcmV0dXJuIHJvdW5kZWQuZ2V0VGltZSgpIC8gMTAwMDsKCQl9CgoJCWlmICh1bml0Lm5hbWUgPT0gJ21vbnRoJykgewoKCQkJZGF0ZSA9IG5ldyBEYXRlKHRpbWUgKiAxMDAwKTsKCgkJCWZsb29yID0gbmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCkpLmdldFRpbWUoKSAvIDEwMDA7CgkJCWlmIChmbG9vciA9PSB0aW1lKSByZXR1cm4gdGltZTsKCgkJCXllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7CgkJCXZhciBtb250aCA9IGRhdGUuZ2V0TW9udGgoKTsKCgkJCWlmIChtb250aCA9PSAxMSkgewoJCQkJbW9udGggPSAwOwoJCQkJeWVhciA9IHllYXIgKyAxOwoJCQl9IGVsc2UgewoJCQkJbW9udGggKz0gMTsKCQkJfQoKCQkJcmV0dXJuIG5ldyBEYXRlKHllYXIsIG1vbnRoKS5nZXRUaW1lKCkgLyAxMDAwOwoJCX0KCgkJaWYgKHVuaXQubmFtZSA9PSAneWVhcicpIHsKCgkJCWRhdGUgPSBuZXcgRGF0ZSh0aW1lICogMTAwMCk7CgoJCQlmbG9vciA9IG5ldyBEYXRlKGRhdGUuZ2V0VVRDRnVsbFllYXIoKSwgMCkuZ2V0VGltZSgpIC8gMTAwMDsKCQkJaWYgKGZsb29yID09IHRpbWUpIHJldHVybiB0aW1lOwoKCQkJeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSArIDE7CgoJCQlyZXR1cm4gbmV3IERhdGUoeWVhciwgMCkuZ2V0VGltZSgpIC8gMTAwMDsKCQl9CgoJCXJldHVybiBNYXRoLmNlaWwodGltZSAvIHVuaXQuc2Vjb25kcykgKiB1bml0LnNlY29uZHM7Cgl9Owp9OwpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkZpeHR1cmVzLk51bWJlcicpOwoKUmlja3NoYXcuRml4dHVyZXMuTnVtYmVyLmZvcm1hdEtNQlQgPSBmdW5jdGlvbih5KSB7Cgl2YXIgYWJzX3kgPSBNYXRoLmFicyh5KTsKCWlmIChhYnNfeSA+PSAxMDAwMDAwMDAwMDAwKSAgIHsgcmV0dXJuIHkgLyAxMDAwMDAwMDAwMDAwICsgIlQiIH0KCWVsc2UgaWYgKGFic195ID49IDEwMDAwMDAwMDApIHsgcmV0dXJuIHkgLyAxMDAwMDAwMDAwICsgIkIiIH0KCWVsc2UgaWYgKGFic195ID49IDEwMDAwMDApICAgIHsgcmV0dXJuIHkgLyAxMDAwMDAwICsgIk0iIH0KCWVsc2UgaWYgKGFic195ID49IDEwMDApICAgICAgIHsgcmV0dXJuIHkgLyAxMDAwICsgIksiIH0KCWVsc2UgaWYgKGFic195IDwgMSAmJiB5ID4gMCkgIHsgcmV0dXJuIHkudG9GaXhlZCgyKSB9CgllbHNlIGlmIChhYnNfeSA9PT0gMCkgICAgICAgICB7IHJldHVybiAnJyB9CgllbHNlICAgICAgICAgICAgICAgICAgICAgIHsgcmV0dXJuIHkgfQp9OwoKUmlja3NoYXcuRml4dHVyZXMuTnVtYmVyLmZvcm1hdEJhc2UxMDI0S01HVFAgPSBmdW5jdGlvbih5KSB7CiAgICB2YXIgYWJzX3kgPSBNYXRoLmFicyh5KTsKICAgIGlmIChhYnNfeSA+PSAxMTI1ODk5OTA2ODQyNjI0KSAgeyByZXR1cm4geSAvIDExMjU4OTk5MDY4NDI2MjQgKyAiUCIgfQogICAgZWxzZSBpZiAoYWJzX3kgPj0gMTA5OTUxMTYyNzc3Nil7IHJldHVybiB5IC8gMTA5OTUxMTYyNzc3NiArICJUIiB9CiAgICBlbHNlIGlmIChhYnNfeSA+PSAxMDczNzQxODI0KSAgIHsgcmV0dXJuIHkgLyAxMDczNzQxODI0ICsgIkciIH0KICAgIGVsc2UgaWYgKGFic195ID49IDEwNDg1NzYpICAgICAgeyByZXR1cm4geSAvIDEwNDg1NzYgKyAiTSIgfQogICAgZWxzZSBpZiAoYWJzX3kgPj0gMTAyNCkgICAgICAgICB7IHJldHVybiB5IC8gMTAyNCArICJLIiB9CiAgICBlbHNlIGlmIChhYnNfeSA8IDEgJiYgeSA+IDApICAgIHsgcmV0dXJuIHkudG9GaXhlZCgyKSB9CiAgICBlbHNlIGlmIChhYnNfeSA9PT0gMCkgICAgICAgICAgIHsgcmV0dXJuICcnIH0KICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICB7IHJldHVybiB5IH0KfTsKUmlja3NoYXcubmFtZXNwYWNlKCJSaWNrc2hhdy5Db2xvci5QYWxldHRlIik7CgpSaWNrc2hhdy5Db2xvci5QYWxldHRlID0gZnVuY3Rpb24oYXJncykgewoKCXZhciBjb2xvciA9IG5ldyBSaWNrc2hhdy5GaXh0dXJlcy5Db2xvcigpOwoKCWFyZ3MgPSBhcmdzIHx8IHt9OwoJdGhpcy5zY2hlbWVzID0ge307CgoJdGhpcy5zY2hlbWUgPSBjb2xvci5zY2hlbWVzW2FyZ3Muc2NoZW1lXSB8fCBhcmdzLnNjaGVtZSB8fCBjb2xvci5zY2hlbWVzLmNvbG9yd2hlZWw7Cgl0aGlzLnJ1bm5pbmdJbmRleCA9IDA7Cgl0aGlzLmdlbmVyYXRvckluZGV4ID0gMDsKCglpZiAoYXJncy5pbnRlcnBvbGF0ZWRTdG9wQ291bnQpIHsKCQl2YXIgc2NoZW1lQ291bnQgPSB0aGlzLnNjaGVtZS5sZW5ndGggLSAxOwoJCXZhciBpLCBqLCBzY2hlbWUgPSBbXTsKCQlmb3IgKGkgPSAwOyBpIDwgc2NoZW1lQ291bnQ7IGkrKykgewoJCQlzY2hlbWUucHVzaCh0aGlzLnNjaGVtZVtpXSk7CgkJCXZhciBnZW5lcmF0b3IgPSBkMy5pbnRlcnBvbGF0ZUhzbCh0aGlzLnNjaGVtZVtpXSwgdGhpcy5zY2hlbWVbaSArIDFdKTsKCQkJZm9yIChqID0gMTsgaiA8IGFyZ3MuaW50ZXJwb2xhdGVkU3RvcENvdW50OyBqKyspIHsKCQkJCXNjaGVtZS5wdXNoKGdlbmVyYXRvcigoMSAvIGFyZ3MuaW50ZXJwb2xhdGVkU3RvcENvdW50KSAqIGopKTsKCQkJfQoJCX0KCQlzY2hlbWUucHVzaCh0aGlzLnNjaGVtZVt0aGlzLnNjaGVtZS5sZW5ndGggLSAxXSk7CgkJdGhpcy5zY2hlbWUgPSBzY2hlbWU7Cgl9Cgl0aGlzLnJvdGF0ZUNvdW50ID0gdGhpcy5zY2hlbWUubGVuZ3RoOwoKCXRoaXMuY29sb3IgPSBmdW5jdGlvbihrZXkpIHsKCQlyZXR1cm4gdGhpcy5zY2hlbWVba2V5XSB8fCB0aGlzLnNjaGVtZVt0aGlzLnJ1bm5pbmdJbmRleCsrXSB8fCB0aGlzLmludGVycG9sYXRlQ29sb3IoKSB8fCAnIzgwODA4MCc7Cgl9OwoKCXRoaXMuaW50ZXJwb2xhdGVDb2xvciA9IGZ1bmN0aW9uKCkgewoJCWlmICghQXJyYXkuaXNBcnJheSh0aGlzLnNjaGVtZSkpIHJldHVybjsKCQl2YXIgY29sb3I7CgkJaWYgKHRoaXMuZ2VuZXJhdG9ySW5kZXggPT0gdGhpcy5yb3RhdGVDb3VudCAqIDIgLSAxKSB7CgkJCWNvbG9yID0gZDMuaW50ZXJwb2xhdGVIc2wodGhpcy5zY2hlbWVbdGhpcy5nZW5lcmF0b3JJbmRleF0sIHRoaXMuc2NoZW1lWzBdKSgwLjUpOwoJCQl0aGlzLmdlbmVyYXRvckluZGV4ID0gMDsKCQkJdGhpcy5yb3RhdGVDb3VudCAqPSAyOwoJCX0gZWxzZSB7CgkJCWNvbG9yID0gZDMuaW50ZXJwb2xhdGVIc2wodGhpcy5zY2hlbWVbdGhpcy5nZW5lcmF0b3JJbmRleF0sIHRoaXMuc2NoZW1lW3RoaXMuZ2VuZXJhdG9ySW5kZXggKyAxXSkoMC41KTsKCQkJdGhpcy5nZW5lcmF0b3JJbmRleCsrOwoJCX0KCQl0aGlzLnNjaGVtZS5wdXNoKGNvbG9yKTsKCQlyZXR1cm4gY29sb3I7Cgl9OwoKfTsKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaC5BamF4Jyk7CgpSaWNrc2hhdy5HcmFwaC5BamF4ID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCB7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oYXJncykgewoKCQl0aGlzLmRhdGFVUkwgPSBhcmdzLmRhdGFVUkw7CgoJCXRoaXMub25EYXRhID0gYXJncy5vbkRhdGEgfHwgZnVuY3Rpb24oZCkgeyByZXR1cm4gZCB9OwoJCXRoaXMub25Db21wbGV0ZSA9IGFyZ3Mub25Db21wbGV0ZSB8fCBmdW5jdGlvbigpIHt9OwoJCXRoaXMub25FcnJvciA9IGFyZ3Mub25FcnJvciB8fCBmdW5jdGlvbigpIHt9OwoKCQl0aGlzLmFyZ3MgPSBhcmdzOyAvLyBwYXNzIHRocm91Z2ggdG8gUmlja3NoYXcuR3JhcGgKCgkJdGhpcy5yZXF1ZXN0KCk7Cgl9LAoKCXJlcXVlc3Q6IGZ1bmN0aW9uKCkgewoKCQlqUXVlcnkuYWpheCggewoJCQl1cmw6IHRoaXMuZGF0YVVSTCwKCQkJZGF0YVR5cGU6ICdqc29uJywKCQkJc3VjY2VzczogdGhpcy5zdWNjZXNzLmJpbmQodGhpcyksCgkJCWVycm9yOiB0aGlzLmVycm9yLmJpbmQodGhpcykKCQl9ICk7Cgl9LAoKCWVycm9yOiBmdW5jdGlvbigpIHsKCgkJY29uc29sZS5sb2coImVycm9yIGxvYWRpbmcgZGF0YVVSTDogIiArIHRoaXMuZGF0YVVSTCk7CgkJdGhpcy5vbkVycm9yKHRoaXMpOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKCgkJZGF0YSA9IHRoaXMub25EYXRhKGRhdGEpOwoJCXRoaXMuYXJncy5zZXJpZXMgPSB0aGlzLl9zcGxpY2UoeyBkYXRhOiBkYXRhLCBzZXJpZXM6IHRoaXMuYXJncy5zZXJpZXMgfSk7CgoJCXRoaXMuZ3JhcGggPSB0aGlzLmdyYXBoIHx8IG5ldyBSaWNrc2hhdy5HcmFwaCh0aGlzLmFyZ3MpOwoJCXRoaXMuZ3JhcGgucmVuZGVyKCk7CgoJCXRoaXMub25Db21wbGV0ZSh0aGlzKTsKCX0sCgoJX3NwbGljZTogZnVuY3Rpb24oYXJncykgewoKCQl2YXIgZGF0YSA9IGFyZ3MuZGF0YTsKCQl2YXIgc2VyaWVzID0gYXJncy5zZXJpZXM7CgoJCWlmICghYXJncy5zZXJpZXMpIHJldHVybiBkYXRhOwoKCQlzZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24ocykgewoKCQkJdmFyIHNlcmllc0tleSA9IHMua2V5IHx8IHMubmFtZTsKCQkJaWYgKCFzZXJpZXNLZXkpIHRocm93ICJzZXJpZXMgbmVlZHMgYSBrZXkgb3IgYSBuYW1lIjsKCgkJCWRhdGEuZm9yRWFjaCggZnVuY3Rpb24oZCkgewoKCQkJCXZhciBkYXRhS2V5ID0gZC5rZXkgfHwgZC5uYW1lOwoJCQkJaWYgKCFkYXRhS2V5KSB0aHJvdyAiZGF0YSBuZWVkcyBhIGtleSBvciBhIG5hbWUiOwoKCQkJCWlmIChzZXJpZXNLZXkgPT0gZGF0YUtleSkgewoJCQkJCXZhciBwcm9wZXJ0aWVzID0gWydjb2xvcicsICduYW1lJywgJ2RhdGEnXTsKCQkJCQlwcm9wZXJ0aWVzLmZvckVhY2goIGZ1bmN0aW9uKHApIHsKCQkJCQkJaWYgKGRbcF0pIHNbcF0gPSBkW3BdOwoJCQkJCX0gKTsKCQkJCX0KCQkJfSApOwoJCX0gKTsKCgkJcmV0dXJuIHNlcmllczsKCX0KfSApOwoKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaC5Bbm5vdGF0ZScpOwoKUmlja3NoYXcuR3JhcGguQW5ub3RhdGUgPSBmdW5jdGlvbihhcmdzKSB7CgoJdmFyIGdyYXBoID0gdGhpcy5ncmFwaCA9IGFyZ3MuZ3JhcGg7Cgl0aGlzLmVsZW1lbnRzID0geyB0aW1lbGluZTogYXJncy5lbGVtZW50IH07CgkKCXZhciBzZWxmID0gdGhpczsKCgl0aGlzLmRhdGEgPSB7fTsKCgl0aGlzLmVsZW1lbnRzLnRpbWVsaW5lLmNsYXNzTGlzdC5hZGQoJ3JpY2tzaGF3X2Fubm90YXRpb25fdGltZWxpbmUnKTsKCgl0aGlzLmFkZCA9IGZ1bmN0aW9uKHRpbWUsIGNvbnRlbnQsIGVuZF90aW1lKSB7CgkJc2VsZi5kYXRhW3RpbWVdID0gc2VsZi5kYXRhW3RpbWVdIHx8IHsnYm94ZXMnOiBbXX07CgkJc2VsZi5kYXRhW3RpbWVdLmJveGVzLnB1c2goe2NvbnRlbnQ6IGNvbnRlbnQsIGVuZDogZW5kX3RpbWV9KTsKCX07CgoJdGhpcy51cGRhdGUgPSBmdW5jdGlvbigpIHsKCgkJUmlja3NoYXcua2V5cyhzZWxmLmRhdGEpLmZvckVhY2goIGZ1bmN0aW9uKHRpbWUpIHsKCgkJCXZhciBhbm5vdGF0aW9uID0gc2VsZi5kYXRhW3RpbWVdOwoJCQl2YXIgbGVmdCA9IHNlbGYuZ3JhcGgueCh0aW1lKTsKCgkJCWlmIChsZWZ0IDwgMCB8fCBsZWZ0ID4gc2VsZi5ncmFwaC54LnJhbmdlKClbMV0pIHsKCQkJCWlmIChhbm5vdGF0aW9uLmVsZW1lbnQpIHsKCQkJCQlhbm5vdGF0aW9uLmxpbmUuY2xhc3NMaXN0LmFkZCgnb2Zmc2NyZWVuJyk7CgkJCQkJYW5ub3RhdGlvbi5lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgkJCQl9CgoJCQkJYW5ub3RhdGlvbi5ib3hlcy5mb3JFYWNoKCBmdW5jdGlvbihib3gpIHsKCQkJCQlpZiAoIGJveC5yYW5nZUVsZW1lbnQgKSBib3gucmFuZ2VFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ29mZnNjcmVlbicpOwoJCQkJfSk7CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIWFubm90YXRpb24uZWxlbWVudCkgewoJCQkJdmFyIGVsZW1lbnQgPSBhbm5vdGF0aW9uLmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCWVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnYW5ub3RhdGlvbicpOwoJCQkJdGhpcy5lbGVtZW50cy50aW1lbGluZS5hcHBlbmRDaGlsZChlbGVtZW50KTsKCQkJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbihlKSB7CgkJCQkJZWxlbWVudC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnKTsKCQkJCQlhbm5vdGF0aW9uLmxpbmUuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJyk7CgkJCQkJYW5ub3RhdGlvbi5ib3hlcy5mb3JFYWNoKCBmdW5jdGlvbihib3gpIHsKCQkJCQkJaWYgKCBib3gucmFuZ2VFbGVtZW50ICkgYm94LnJhbmdlRWxlbWVudC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnKTsKCQkJCQl9KTsKCQkJCX0sIGZhbHNlKTsKCQkJCQkKCQkJfQoKCQkJYW5ub3RhdGlvbi5lbGVtZW50LnN0eWxlLmxlZnQgPSBsZWZ0ICsgJ3B4JzsKCQkJYW5ub3RhdGlvbi5lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwoKCQkJYW5ub3RhdGlvbi5ib3hlcy5mb3JFYWNoKCBmdW5jdGlvbihib3gpIHsKCgoJCQkJdmFyIGVsZW1lbnQgPSBib3guZWxlbWVudDsKCgkJCQlpZiAoIWVsZW1lbnQpIHsKCQkJCQllbGVtZW50ID0gYm94LmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQllbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2NvbnRlbnQnKTsKCQkJCQllbGVtZW50LmlubmVySFRNTCA9IGJveC5jb250ZW50OwoJCQkJCWFubm90YXRpb24uZWxlbWVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKCgkJCQkJYW5ub3RhdGlvbi5saW5lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCQkJYW5ub3RhdGlvbi5saW5lLmNsYXNzTGlzdC5hZGQoJ2Fubm90YXRpb25fbGluZScpOwoJCQkJCXNlbGYuZ3JhcGguZWxlbWVudC5hcHBlbmRDaGlsZChhbm5vdGF0aW9uLmxpbmUpOwoKCQkJCQlpZiAoIGJveC5lbmQgKSB7CgkJCQkJCWJveC5yYW5nZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCQkJYm94LnJhbmdlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdhbm5vdGF0aW9uX3JhbmdlJyk7CgkJCQkJCXNlbGYuZ3JhcGguZWxlbWVudC5hcHBlbmRDaGlsZChib3gucmFuZ2VFbGVtZW50KTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICggYm94LmVuZCApIHsKCgkJCQkJdmFyIGFubm90YXRpb25SYW5nZVN0YXJ0ID0gbGVmdDsKCQkJCQl2YXIgYW5ub3RhdGlvblJhbmdlRW5kICAgPSBNYXRoLm1pbiggc2VsZi5ncmFwaC54KGJveC5lbmQpLCBzZWxmLmdyYXBoLngucmFuZ2UoKVsxXSApOwoKCQkJCQkvLyBhbm5vdGF0aW9uIG1ha2VzIG1vcmUgc2Vuc2UgYXQgZW5kCgkJCQkJaWYgKCBhbm5vdGF0aW9uUmFuZ2VTdGFydCA+IGFubm90YXRpb25SYW5nZUVuZCApIHsKCQkJCQkJYW5ub3RhdGlvblJhbmdlRW5kICAgPSBsZWZ0OwoJCQkJCQlhbm5vdGF0aW9uUmFuZ2VTdGFydCA9IE1hdGgubWF4KCBzZWxmLmdyYXBoLngoYm94LmVuZCksIHNlbGYuZ3JhcGgueC5yYW5nZSgpWzBdICk7CgkJCQkJfQoKCQkJCQl2YXIgYW5ub3RhdGlvblJhbmdlV2lkdGggPSBhbm5vdGF0aW9uUmFuZ2VFbmQgLSBhbm5vdGF0aW9uUmFuZ2VTdGFydDsKCgkJCQkJYm94LnJhbmdlRWxlbWVudC5zdHlsZS5sZWZ0ICA9IGFubm90YXRpb25SYW5nZVN0YXJ0ICsgJ3B4JzsKCQkJCQlib3gucmFuZ2VFbGVtZW50LnN0eWxlLndpZHRoID0gYW5ub3RhdGlvblJhbmdlV2lkdGggKyAncHgnOwoKCQkJCQlib3gucmFuZ2VFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ29mZnNjcmVlbicpOwoJCQkJfQoKCQkJCWFubm90YXRpb24ubGluZS5jbGFzc0xpc3QucmVtb3ZlKCdvZmZzY3JlZW4nKTsKCQkJCWFubm90YXRpb24ubGluZS5zdHlsZS5sZWZ0ID0gbGVmdCArICdweCc7CgkJCX0gKTsKCQl9LCB0aGlzICk7Cgl9OwoKCXRoaXMuZ3JhcGgub25VcGRhdGUoIGZ1bmN0aW9uKCkgeyBzZWxmLnVwZGF0ZSgpIH0gKTsKfTsKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaC5BeGlzLlRpbWUnKTsKClJpY2tzaGF3LkdyYXBoLkF4aXMuVGltZSA9IGZ1bmN0aW9uKGFyZ3MpIHsKCgl2YXIgc2VsZiA9IHRoaXM7CgoJdGhpcy5ncmFwaCA9IGFyZ3MuZ3JhcGg7Cgl0aGlzLmVsZW1lbnRzID0gW107Cgl0aGlzLnRpY2tzVHJlYXRtZW50ID0gYXJncy50aWNrc1RyZWF0bWVudCB8fCAncGxhaW4nOwoJdGhpcy5maXhlZFRpbWVVbml0ID0gYXJncy50aW1lVW5pdDsKCgl2YXIgdGltZSA9IGFyZ3MudGltZUZpeHR1cmUgfHwgbmV3IFJpY2tzaGF3LkZpeHR1cmVzLlRpbWUoKTsKCgl0aGlzLmFwcHJvcHJpYXRlVGltZVVuaXQgPSBmdW5jdGlvbigpIHsKCgkJdmFyIHVuaXQ7CgkJdmFyIHVuaXRzID0gdGltZS51bml0czsKCgkJdmFyIGRvbWFpbiA9IHRoaXMuZ3JhcGgueC5kb21haW4oKTsKCQl2YXIgcmFuZ2VTZWNvbmRzID0gZG9tYWluWzFdIC0gZG9tYWluWzBdOwoKCQl1bml0cy5mb3JFYWNoKCBmdW5jdGlvbih1KSB7CgkJCWlmIChNYXRoLmZsb29yKHJhbmdlU2Vjb25kcyAvIHUuc2Vjb25kcykgPj0gMikgewoJCQkJdW5pdCA9IHVuaXQgfHwgdTsKCQkJfQoJCX0gKTsKCgkJcmV0dXJuICh1bml0IHx8IHRpbWUudW5pdHNbdGltZS51bml0cy5sZW5ndGggLSAxXSk7Cgl9OwoKCXRoaXMudGlja09mZnNldHMgPSBmdW5jdGlvbigpIHsKCgkJdmFyIGRvbWFpbiA9IHRoaXMuZ3JhcGgueC5kb21haW4oKTsKCgkJdmFyIHVuaXQgPSB0aGlzLmZpeGVkVGltZVVuaXQgfHwgdGhpcy5hcHByb3ByaWF0ZVRpbWVVbml0KCk7CgkJdmFyIGNvdW50ID0gTWF0aC5jZWlsKChkb21haW5bMV0gLSBkb21haW5bMF0pIC8gdW5pdC5zZWNvbmRzKTsKCgkJdmFyIHJ1bm5pbmdUaWNrID0gZG9tYWluWzBdOwoKCQl2YXIgb2Zmc2V0cyA9IFtdOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKCgkJCXZhciB0aWNrVmFsdWUgPSB0aW1lLmNlaWwocnVubmluZ1RpY2ssIHVuaXQpOwoJCQlydW5uaW5nVGljayA9IHRpY2tWYWx1ZSArIHVuaXQuc2Vjb25kcyAvIDI7CgoJCQlvZmZzZXRzLnB1c2goIHsgdmFsdWU6IHRpY2tWYWx1ZSwgdW5pdDogdW5pdCB9ICk7CgkJfQoKCQlyZXR1cm4gb2Zmc2V0czsKCX07CgoJdGhpcy5yZW5kZXIgPSBmdW5jdGlvbigpIHsKCgkJdGhpcy5lbGVtZW50cy5mb3JFYWNoKCBmdW5jdGlvbihlKSB7CgkJCWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlKTsKCQl9ICk7CgoJCXRoaXMuZWxlbWVudHMgPSBbXTsKCgkJdmFyIG9mZnNldHMgPSB0aGlzLnRpY2tPZmZzZXRzKCk7CgoJCW9mZnNldHMuZm9yRWFjaCggZnVuY3Rpb24obykgewoJCQkKCQkJaWYgKHNlbGYuZ3JhcGgueChvLnZhbHVlKSA+IHNlbGYuZ3JhcGgueC5yYW5nZSgpWzFdKSByZXR1cm47CgkKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJZWxlbWVudC5zdHlsZS5sZWZ0ID0gc2VsZi5ncmFwaC54KG8udmFsdWUpICsgJ3B4JzsKCQkJZWxlbWVudC5jbGFzc0xpc3QuYWRkKCd4X3RpY2snKTsKCQkJZWxlbWVudC5jbGFzc0xpc3QuYWRkKHNlbGYudGlja3NUcmVhdG1lbnQpOwoKCQkJdmFyIHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJCXRpdGxlLmNsYXNzTGlzdC5hZGQoJ3RpdGxlJyk7CgkJCXRpdGxlLmlubmVySFRNTCA9IG8udW5pdC5mb3JtYXR0ZXIobmV3IERhdGUoby52YWx1ZSAqIDEwMDApKTsKCQkJZWxlbWVudC5hcHBlbmRDaGlsZCh0aXRsZSk7CgoJCQlzZWxmLmdyYXBoLmVsZW1lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJCXNlbGYuZWxlbWVudHMucHVzaChlbGVtZW50KTsKCgkJfSApOwoJfTsKCgl0aGlzLmdyYXBoLm9uVXBkYXRlKCBmdW5jdGlvbigpIHsgc2VsZi5yZW5kZXIoKSB9ICk7Cn07CgpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkdyYXBoLkF4aXMuWCcpOwoKUmlja3NoYXcuR3JhcGguQXhpcy5YID0gZnVuY3Rpb24oYXJncykgewoKCXZhciBzZWxmID0gdGhpczsKCXZhciBiZXJ0aFJhdGUgPSAwLjEwOwoKCXRoaXMuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGFyZ3MpIHsKCgkJdGhpcy5ncmFwaCA9IGFyZ3MuZ3JhcGg7CgkJdGhpcy5vcmllbnRhdGlvbiA9IGFyZ3Mub3JpZW50YXRpb24gfHwgJ3RvcCc7CgoJCXRoaXMucGl4ZWxzUGVyVGljayA9IGFyZ3MucGl4ZWxzUGVyVGljayB8fCA3NTsKCQlpZiAoYXJncy50aWNrcykgdGhpcy5zdGF0aWNUaWNrcyA9IGFyZ3MudGlja3M7CgkJaWYgKGFyZ3MudGlja1ZhbHVlcykgdGhpcy50aWNrVmFsdWVzID0gYXJncy50aWNrVmFsdWVzOwoKCQl0aGlzLnRpY2tTaXplID0gYXJncy50aWNrU2l6ZSB8fCA0OwoJCXRoaXMudGlja3NUcmVhdG1lbnQgPSBhcmdzLnRpY2tzVHJlYXRtZW50IHx8ICdwbGFpbic7CgoJCWlmIChhcmdzLmVsZW1lbnQpIHsKCgkJCXRoaXMuZWxlbWVudCA9IGFyZ3MuZWxlbWVudDsKCQkJdGhpcy5fZGlzY292ZXJTaXplKGFyZ3MuZWxlbWVudCwgYXJncyk7CgoJCQl0aGlzLnZpcyA9IGQzLnNlbGVjdChhcmdzLmVsZW1lbnQpCgkJCQkuYXBwZW5kKCJzdmc6c3ZnIikKCQkJCS5hdHRyKCdoZWlnaHQnLCB0aGlzLmhlaWdodCkKCQkJCS5hdHRyKCd3aWR0aCcsIHRoaXMud2lkdGgpCgkJCQkuYXR0cignY2xhc3MnLCAncmlja3NoYXdfZ3JhcGggeF9heGlzX2QzJyk7CgoJCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnZpc1swXVswXTsKCQkJdGhpcy5lbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJzsKCgkJCXRoaXMuc2V0U2l6ZSh7IHdpZHRoOiBhcmdzLndpZHRoLCBoZWlnaHQ6IGFyZ3MuaGVpZ2h0IH0pOwoKCQl9IGVsc2UgewoJCQl0aGlzLnZpcyA9IHRoaXMuZ3JhcGgudmlzOwoJCX0KCgkJdGhpcy5ncmFwaC5vblVwZGF0ZSggZnVuY3Rpb24oKSB7IHNlbGYucmVuZGVyKCkgfSApOwoJfTsKCgl0aGlzLnNldFNpemUgPSBmdW5jdGlvbihhcmdzKSB7CgoJCWFyZ3MgPSBhcmdzIHx8IHt9OwoJCWlmICghdGhpcy5lbGVtZW50KSByZXR1cm47CgoJCXRoaXMuX2Rpc2NvdmVyU2l6ZSh0aGlzLmVsZW1lbnQucGFyZW50Tm9kZSwgYXJncyk7CgoJCXRoaXMudmlzCgkJCS5hdHRyKCdoZWlnaHQnLCB0aGlzLmhlaWdodCkKCQkJLmF0dHIoJ3dpZHRoJywgdGhpcy53aWR0aCAqICgxICsgYmVydGhSYXRlKSk7CgoJCXZhciBiZXJ0aCA9IE1hdGguZmxvb3IodGhpcy53aWR0aCAqIGJlcnRoUmF0ZSAvIDIpOwoJCXRoaXMuZWxlbWVudC5zdHlsZS5sZWZ0ID0gLTEgKiBiZXJ0aCArICdweCc7Cgl9OwoKCXRoaXMucmVuZGVyID0gZnVuY3Rpb24oKSB7CgoJCWlmICh0aGlzLl9yZW5kZXJXaWR0aCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuZ3JhcGgud2lkdGggIT09IHRoaXMuX3JlbmRlcldpZHRoKSB0aGlzLnNldFNpemUoeyBhdXRvOiB0cnVlIH0pOwoKCQl2YXIgYXhpcyA9IGQzLnN2Zy5heGlzKCkuc2NhbGUodGhpcy5ncmFwaC54KS5vcmllbnQodGhpcy5vcmllbnRhdGlvbik7CgkJYXhpcy50aWNrRm9ybWF0KCBhcmdzLnRpY2tGb3JtYXQgfHwgZnVuY3Rpb24oeCkgeyByZXR1cm4geCB9ICk7CgkJaWYgKHRoaXMudGlja1ZhbHVlcykgYXhpcy50aWNrVmFsdWVzKHRoaXMudGlja1ZhbHVlcyk7CgoJCXRoaXMudGlja3MgPSB0aGlzLnN0YXRpY1RpY2tzIHx8IE1hdGguZmxvb3IodGhpcy5ncmFwaC53aWR0aCAvIHRoaXMucGl4ZWxzUGVyVGljayk7CgoJCXZhciBiZXJ0aCA9IE1hdGguZmxvb3IodGhpcy53aWR0aCAqIGJlcnRoUmF0ZSAvIDIpIHx8IDA7CgkJdmFyIHRyYW5zZm9ybTsKCgkJaWYgKHRoaXMub3JpZW50YXRpb24gPT0gJ3RvcCcpIHsKCQkJdmFyIHlPZmZzZXQgPSB0aGlzLmhlaWdodCB8fCB0aGlzLmdyYXBoLmhlaWdodDsKCQkJdHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgnICsgYmVydGggKyAnLCcgKyB5T2Zmc2V0ICsgJyknOwoJCX0gZWxzZSB7CgkJCXRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoJyArIGJlcnRoICsgJywgMCknOwoJCX0KCgkJaWYgKHRoaXMuZWxlbWVudCkgewoJCQl0aGlzLnZpcy5zZWxlY3RBbGwoJyonKS5yZW1vdmUoKTsKCQl9CgoJCXRoaXMudmlzCgkJCS5hcHBlbmQoInN2ZzpnIikKCQkJLmF0dHIoImNsYXNzIiwgWyJ4X3RpY2tzX2QzIiwgdGhpcy50aWNrc1RyZWF0bWVudF0uam9pbigiICIpKQoJCQkuYXR0cigidHJhbnNmb3JtIiwgdHJhbnNmb3JtKQoJCQkuY2FsbChheGlzLnRpY2tzKHRoaXMudGlja3MpLnRpY2tTdWJkaXZpZGUoMCkudGlja1NpemUodGhpcy50aWNrU2l6ZSkpOwoKCQl2YXIgZ3JpZFNpemUgPSAodGhpcy5vcmllbnRhdGlvbiA9PSAnYm90dG9tJyA\/IDEgOiAtMSkgKiB0aGlzLmdyYXBoLmhlaWdodDsKCgkJdGhpcy5ncmFwaC52aXMKCQkJLmFwcGVuZCgic3ZnOmciKQoJCQkuYXR0cigiY2xhc3MiLCAieF9ncmlkX2QzIikKCQkJLmNhbGwoYXhpcy50aWNrcyh0aGlzLnRpY2tzKS50aWNrU3ViZGl2aWRlKDApLnRpY2tTaXplKGdyaWRTaXplKSkKCQkJLnNlbGVjdEFsbCgndGV4dCcpCgkJCS5lYWNoKGZ1bmN0aW9uKCkgeyB0aGlzLnBhcmVudE5vZGUuc2V0QXR0cmlidXRlKCdkYXRhLXgtdmFsdWUnLCB0aGlzLnRleHRDb250ZW50KSB9KTsKCgkJdGhpcy5fcmVuZGVySGVpZ2h0ID0gdGhpcy5ncmFwaC5oZWlnaHQ7Cgl9OwoKCXRoaXMuX2Rpc2NvdmVyU2l6ZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIGFyZ3MpIHsKCgkJaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CgoJCQl2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCBudWxsKTsKCQkJdmFyIGVsZW1lbnRIZWlnaHQgPSBwYXJzZUludChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdoZWlnaHQnKSwgMTApOwoKCQkJaWYgKCFhcmdzLmF1dG8pIHsKCQkJCXZhciBlbGVtZW50V2lkdGggPSBwYXJzZUludChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCd3aWR0aCcpLCAxMCk7CgkJCX0KCQl9CgoJCXRoaXMud2lkdGggPSAoYXJncy53aWR0aCB8fCBlbGVtZW50V2lkdGggfHwgdGhpcy5ncmFwaC53aWR0aCkgKiAoMSArIGJlcnRoUmF0ZSk7CgkJdGhpcy5oZWlnaHQgPSBhcmdzLmhlaWdodCB8fCBlbGVtZW50SGVpZ2h0IHx8IDQwOwoJfTsKCgl0aGlzLmluaXRpYWxpemUoYXJncyk7Cn07CgpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkdyYXBoLkF4aXMuWScpOwoKUmlja3NoYXcuR3JhcGguQXhpcy5ZID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCB7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oYXJncykgewoKCQl0aGlzLmdyYXBoID0gYXJncy5ncmFwaDsKCQl0aGlzLm9yaWVudGF0aW9uID0gYXJncy5vcmllbnRhdGlvbiB8fCAncmlnaHQnOwoKCQl0aGlzLnBpeGVsc1BlclRpY2sgPSBhcmdzLnBpeGVsc1BlclRpY2sgfHwgNzU7CgkJaWYgKGFyZ3MudGlja3MpIHRoaXMuc3RhdGljVGlja3MgPSBhcmdzLnRpY2tzOwoJCWlmIChhcmdzLnRpY2tWYWx1ZXMpIHRoaXMudGlja1ZhbHVlcyA9IGFyZ3MudGlja1ZhbHVlczsKCgkJdGhpcy50aWNrU2l6ZSA9IGFyZ3MudGlja1NpemUgfHwgNDsKCQl0aGlzLnRpY2tzVHJlYXRtZW50ID0gYXJncy50aWNrc1RyZWF0bWVudCB8fCAncGxhaW4nOwoKCQl0aGlzLnRpY2tGb3JtYXQgPSBhcmdzLnRpY2tGb3JtYXQgfHwgZnVuY3Rpb24oeSkgeyByZXR1cm4geSB9OwoKCQl0aGlzLmJlcnRoUmF0ZSA9IDAuMTA7CgoJCWlmIChhcmdzLmVsZW1lbnQpIHsKCgkJCXRoaXMuZWxlbWVudCA9IGFyZ3MuZWxlbWVudDsKCQkJdGhpcy52aXMgPSBkMy5zZWxlY3QoYXJncy5lbGVtZW50KQoJCQkJLmFwcGVuZCgic3ZnOnN2ZyIpCgkJCQkuYXR0cignY2xhc3MnLCAncmlja3NoYXdfZ3JhcGggeV9heGlzJyk7CgoJCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnZpc1swXVswXTsKCQkJdGhpcy5lbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ3JlbGF0aXZlJzsKCgkJCXRoaXMuc2V0U2l6ZSh7IHdpZHRoOiBhcmdzLndpZHRoLCBoZWlnaHQ6IGFyZ3MuaGVpZ2h0IH0pOwoKCQl9IGVsc2UgewoJCQl0aGlzLnZpcyA9IHRoaXMuZ3JhcGgudmlzOwoJCX0KCgkJdmFyIHNlbGYgPSB0aGlzOwoJCXRoaXMuZ3JhcGgub25VcGRhdGUoIGZ1bmN0aW9uKCkgeyBzZWxmLnJlbmRlcigpIH0gKTsKCX0sCgoJc2V0U2l6ZTogZnVuY3Rpb24oYXJncykgewoKCQlhcmdzID0gYXJncyB8fCB7fTsKCgkJaWYgKCF0aGlzLmVsZW1lbnQpIHJldHVybjsKCgkJaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CgoJCQl2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLmVsZW1lbnQucGFyZW50Tm9kZSwgbnVsbCk7CgkJCXZhciBlbGVtZW50V2lkdGggPSBwYXJzZUludChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCd3aWR0aCcpLCAxMCk7CgoJCQlpZiAoIWFyZ3MuYXV0bykgewoJCQkJdmFyIGVsZW1lbnRIZWlnaHQgPSBwYXJzZUludChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCdoZWlnaHQnKSwgMTApOwoJCQl9CgkJfQoKCQl0aGlzLndpZHRoID0gYXJncy53aWR0aCB8fCBlbGVtZW50V2lkdGggfHwgdGhpcy5ncmFwaC53aWR0aCAqIHRoaXMuYmVydGhSYXRlOwoJCXRoaXMuaGVpZ2h0ID0gYXJncy5oZWlnaHQgfHwgZWxlbWVudEhlaWdodCB8fCB0aGlzLmdyYXBoLmhlaWdodDsKCgkJdGhpcy52aXMKCQkJLmF0dHIoJ3dpZHRoJywgdGhpcy53aWR0aCkKCQkJLmF0dHIoJ2hlaWdodCcsIHRoaXMuaGVpZ2h0ICogKDEgKyB0aGlzLmJlcnRoUmF0ZSkpOwoKCQl2YXIgYmVydGggPSB0aGlzLmhlaWdodCAqIHRoaXMuYmVydGhSYXRlOwoKCQlpZiAodGhpcy5vcmllbnRhdGlvbiA9PSAnbGVmdCcpIHsKCQkJdGhpcy5lbGVtZW50LnN0eWxlLnRvcCA9IC0xICogYmVydGggKyAncHgnOwoJCX0KCX0sCgoJcmVuZGVyOiBmdW5jdGlvbigpIHsKCgkJaWYgKHRoaXMuX3JlbmRlckhlaWdodCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuZ3JhcGguaGVpZ2h0ICE9PSB0aGlzLl9yZW5kZXJIZWlnaHQpIHRoaXMuc2V0U2l6ZSh7IGF1dG86IHRydWUgfSk7CgoJCXRoaXMudGlja3MgPSB0aGlzLnN0YXRpY1RpY2tzIHx8IE1hdGguZmxvb3IodGhpcy5ncmFwaC5oZWlnaHQgLyB0aGlzLnBpeGVsc1BlclRpY2spOwoKCQl2YXIgYXhpcyA9IHRoaXMuX2RyYXdBeGlzKHRoaXMuZ3JhcGgueSk7CgoJCXRoaXMuX2RyYXdHcmlkKGF4aXMpOwoKCQl0aGlzLl9yZW5kZXJIZWlnaHQgPSB0aGlzLmdyYXBoLmhlaWdodDsKCX0sCgoJX2RyYXdBeGlzOiBmdW5jdGlvbihzY2FsZSkgewoJCXZhciBheGlzID0gZDMuc3ZnLmF4aXMoKS5zY2FsZShzY2FsZSkub3JpZW50KHRoaXMub3JpZW50YXRpb24pOwoJCWF4aXMudGlja0Zvcm1hdCh0aGlzLnRpY2tGb3JtYXQpOwoJCWlmICh0aGlzLnRpY2tWYWx1ZXMpIGF4aXMudGlja1ZhbHVlcyh0aGlzLnRpY2tWYWx1ZXMpOwoKCQlpZiAodGhpcy5vcmllbnRhdGlvbiA9PSAnbGVmdCcpIHsKCQkJdmFyIGJlcnRoID0gdGhpcy5oZWlnaHQgKiB0aGlzLmJlcnRoUmF0ZTsKCQkJdmFyIHRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoJyArIHRoaXMud2lkdGggKyAnLCAnICsgYmVydGggKyAnKSc7CgkJfQoKCQlpZiAodGhpcy5lbGVtZW50KSB7CgkJCXRoaXMudmlzLnNlbGVjdEFsbCgnKicpLnJlbW92ZSgpOwoJCX0KCgkJdGhpcy52aXMKCQkJLmFwcGVuZCgic3ZnOmciKQoJCQkuYXR0cigiY2xhc3MiLCBbInlfdGlja3MiLCB0aGlzLnRpY2tzVHJlYXRtZW50XS5qb2luKCIgIikpCgkJCS5hdHRyKCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0pCgkJCS5jYWxsKGF4aXMudGlja3ModGhpcy50aWNrcykudGlja1N1YmRpdmlkZSgwKS50aWNrU2l6ZSh0aGlzLnRpY2tTaXplKSk7CgoJCXJldHVybiBheGlzOwoJfSwKCglfZHJhd0dyaWQ6IGZ1bmN0aW9uKGF4aXMpIHsKCQl2YXIgZ3JpZFNpemUgPSAodGhpcy5vcmllbnRhdGlvbiA9PSAncmlnaHQnID8gMSA6IC0xKSAqIHRoaXMuZ3JhcGgud2lkdGg7CgoJCXRoaXMuZ3JhcGgudmlzCgkJCS5hcHBlbmQoInN2ZzpnIikKCQkJLmF0dHIoImNsYXNzIiwgInlfZ3JpZCIpCgkJCS5jYWxsKGF4aXMudGlja3ModGhpcy50aWNrcykudGlja1N1YmRpdmlkZSgwKS50aWNrU2l6ZShncmlkU2l6ZSkpCgkJCS5zZWxlY3RBbGwoJ3RleHQnKQoJCQkuZWFjaChmdW5jdGlvbigpIHsgdGhpcy5wYXJlbnROb2RlLnNldEF0dHJpYnV0ZSgnZGF0YS15LXZhbHVlJywgdGhpcy50ZXh0Q29udGVudCkgfSk7Cgl9Cn0gKTsKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaC5BeGlzLlkuU2NhbGVkJyk7CgpSaWNrc2hhdy5HcmFwaC5BeGlzLlkuU2NhbGVkID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCBSaWNrc2hhdy5HcmFwaC5BeGlzLlksIHsKCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oJHN1cGVyLCBhcmdzKSB7CgogICAgaWYgKHR5cGVvZihhcmdzLnNjYWxlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdTY2FsZWQgcmVxdWlyZXMgc2NhbGUnKTsKICAgIH0KCiAgICB0aGlzLnNjYWxlID0gYXJncy5zY2FsZTsKCiAgICBpZiAodHlwZW9mKGFyZ3MuZ3JpZCkgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMuZ3JpZCA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmdyaWQgPSBhcmdzLmdyaWQ7CiAgICB9CgogICAgJHN1cGVyKGFyZ3MpOwoKICB9LAoKICBfZHJhd0F4aXM6IGZ1bmN0aW9uKCRzdXBlciwgc2NhbGUpIHsKICAgIC8vIEFkanVzdCBzY2FsZSdzIGRvbWFpbiB0byBjb21wZW5zYXRlIGZvciBhZGp1c3RtZW50cyB0byB0aGUKICAgIC8vIHJlbmRlcmVyJ3MgZG9tYWluIChlLmcuIHBhZGRpbmcpLgogICAgdmFyIGRvbWFpbiA9IHRoaXMuc2NhbGUuZG9tYWluKCk7CiAgICB2YXIgcmVuZGVyRG9tYWluID0gdGhpcy5ncmFwaC5yZW5kZXJlci5kb21haW4oKS55OwoKICAgIHZhciBleHRlbnRzID0gWwogICAgICBNYXRoLm1pbi5hcHBseShNYXRoLCBkb21haW4pLAogICAgICBNYXRoLm1heC5hcHBseShNYXRoLCBkb21haW4pXTsKCiAgICAvLyBBIG1hcHBpbmcgZnJvbSB0aGUgaWRlYWwgcmVuZGVyIGRvbWFpbiBbMCwgMV0gdG8gdGhlIGV4dGVudAogICAgLy8gb2YgdGhlIG9yaWdpbmFsIHNjYWxlJ3MgZG9tYWluLiAgVGhpcyBpcyB1c2VkIHRvIGNhbGN1bGF0ZQogICAgLy8gdGhlIGV4dGVudHMgb2YgdGhlIGFkanVzdGVkIGRvbWFpbi4KICAgIHZhciBleHRlbnRNYXAgPSBkMy5zY2FsZS5saW5lYXIoKS5kb21haW4oWzAsIDFdKS5yYW5nZShleHRlbnRzKTsKCiAgICB2YXIgYWRqRXh0ZW50cyA9IFsKICAgICAgZXh0ZW50TWFwKHJlbmRlckRvbWFpblswXSksCiAgICAgIGV4dGVudE1hcChyZW5kZXJEb21haW5bMV0pXTsKCiAgICAvLyBBIG1hcHBpbmcgZnJvbSB0aGUgb3JpZ2luYWwgZG9tYWluIHRvIHRoZSBhZGp1c3RlZCBkb21haW4uCiAgICB2YXIgYWRqdXN0bWVudCA9IGQzLnNjYWxlLmxpbmVhcigpLmRvbWFpbihleHRlbnRzKS5yYW5nZShhZGpFeHRlbnRzKTsKCiAgICAvLyBNYWtlIGEgY29weSBvZiB0aGUgY3VzdG9tIHNjYWxlLCBhcHBseSB0aGUgYWRqdXN0ZWQgZG9tYWluLCBhbmQKICAgIC8vIGNvcHkgdGhlIHJhbmdlIHRvIG1hdGNoIHRoZSBncmFwaCdzIHNjYWxlLgogICAgdmFyIGFkanVzdGVkU2NhbGUgPSB0aGlzLnNjYWxlLmNvcHkoKQogICAgICAuZG9tYWluKGRvbWFpbi5tYXAoYWRqdXN0bWVudCkpCiAgICAgIC5yYW5nZShzY2FsZS5yYW5nZSgpKTsKCiAgICByZXR1cm4gJHN1cGVyKGFkanVzdGVkU2NhbGUpOwogIH0sCgogIF9kcmF3R3JpZDogZnVuY3Rpb24oJHN1cGVyLCBheGlzKSB7CiAgICBpZiAodGhpcy5ncmlkKSB7CiAgICAgIC8vIG9ubHkgZHJhdyB0aGUgYXhpcyBpZiB0aGUgZ3JpZCBvcHRpb24gaXMgdHJ1ZQogICAgICAkc3VwZXIoYXhpcyk7CiAgICB9CiAgfQp9ICk7ClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguQmVoYXZpb3IuU2VyaWVzLkhpZ2hsaWdodCcpOwoKUmlja3NoYXcuR3JhcGguQmVoYXZpb3IuU2VyaWVzLkhpZ2hsaWdodCA9IGZ1bmN0aW9uKGFyZ3MpIHsKCgl0aGlzLmdyYXBoID0gYXJncy5ncmFwaDsKCXRoaXMubGVnZW5kID0gYXJncy5sZWdlbmQ7CgoJdmFyIHNlbGYgPSB0aGlzOwoKCXZhciBjb2xvclNhZmUgPSB7fTsKCXZhciBhY3RpdmVMaW5lID0gbnVsbDsKCgl2YXIgZGlzYWJsZWRDb2xvciA9IGFyZ3MuZGlzYWJsZWRDb2xvciB8fCBmdW5jdGlvbihzZXJpZXNDb2xvcikgewoJCXJldHVybiBkMy5pbnRlcnBvbGF0ZVJnYihzZXJpZXNDb2xvciwgZDMucmdiKCcjZDhkOGQ4JykpKDAuOCkudG9TdHJpbmcoKTsKCX07CgoJdGhpcy5hZGRIaWdobGlnaHRFdmVudHMgPSBmdW5jdGlvbiAobCkgewoKCQlsLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKGUpIHsKCgkJCWlmIChhY3RpdmVMaW5lKSByZXR1cm47CgkJCWVsc2UgYWN0aXZlTGluZSA9IGw7CgoJCQlzZWxmLmxlZ2VuZC5saW5lcy5mb3JFYWNoKCBmdW5jdGlvbihsaW5lKSB7CgoJCQkJaWYgKGwgPT09IGxpbmUpIHsKCgkJCQkJLy8gaWYgd2UncmUgbm90IGluIGEgc3RhY2tlZCByZW5kZXJlciBicmluZyBhY3RpdmUgbGluZSB0byB0aGUgdG9wCgkJCQkJaWYgKHNlbGYuZ3JhcGgucmVuZGVyZXIudW5zdGFjayAmJiAobGluZS5zZXJpZXMucmVuZGVyZXIgPyBsaW5lLnNlcmllcy5yZW5kZXJlci51bnN0YWNrIDogdHJ1ZSkpIHsKCgkJCQkJCXZhciBzZXJpZXNJbmRleCA9IHNlbGYuZ3JhcGguc2VyaWVzLmluZGV4T2YobGluZS5zZXJpZXMpOwoJCQkJCQlsaW5lLm9yaWdpbmFsSW5kZXggPSBzZXJpZXNJbmRleDsKCgkJCQkJCXZhciBzZXJpZXMgPSBzZWxmLmdyYXBoLnNlcmllcy5zcGxpY2Uoc2VyaWVzSW5kZXgsIDEpWzBdOwoJCQkJCQlzZWxmLmdyYXBoLnNlcmllcy5wdXNoKHNlcmllcyk7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQljb2xvclNhZmVbbGluZS5zZXJpZXMubmFtZV0gPSBjb2xvclNhZmVbbGluZS5zZXJpZXMubmFtZV0gfHwgbGluZS5zZXJpZXMuY29sb3I7CgkJCQlsaW5lLnNlcmllcy5jb2xvciA9IGRpc2FibGVkQ29sb3IobGluZS5zZXJpZXMuY29sb3IpOwoKCQkJfSApOwoKCQkJc2VsZi5ncmFwaC51cGRhdGUoKTsKCgkJfSwgZmFsc2UgKTsKCgkJbC5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdtb3VzZW91dCcsIGZ1bmN0aW9uKGUpIHsKCgkJCWlmICghYWN0aXZlTGluZSkgcmV0dXJuOwoJCQllbHNlIGFjdGl2ZUxpbmUgPSBudWxsOwoKCQkJc2VsZi5sZWdlbmQubGluZXMuZm9yRWFjaCggZnVuY3Rpb24obGluZSkgewoKCQkJCS8vIHJldHVybiByZW9yZGVyZWQgc2VyaWVzIHRvIGl0cyBvcmlnaW5hbCBwbGFjZQoJCQkJaWYgKGwgPT09IGxpbmUgJiYgbGluZS5oYXNPd25Qcm9wZXJ0eSgnb3JpZ2luYWxJbmRleCcpKSB7CgoJCQkJCXZhciBzZXJpZXMgPSBzZWxmLmdyYXBoLnNlcmllcy5wb3AoKTsKCQkJCQlzZWxmLmdyYXBoLnNlcmllcy5zcGxpY2UobGluZS5vcmlnaW5hbEluZGV4LCAwLCBzZXJpZXMpOwoJCQkJCWRlbGV0ZSBsaW5lLm9yaWdpbmFsSW5kZXg7CgkJCQl9CgoJCQkJaWYgKGNvbG9yU2FmZVtsaW5lLnNlcmllcy5uYW1lXSkgewoJCQkJCWxpbmUuc2VyaWVzLmNvbG9yID0gY29sb3JTYWZlW2xpbmUuc2VyaWVzLm5hbWVdOwoJCQkJfQoJCQl9ICk7CgoJCQlzZWxmLmdyYXBoLnVwZGF0ZSgpOwoKCQl9LCBmYWxzZSApOwoJfTsKCglpZiAodGhpcy5sZWdlbmQpIHsKCQl0aGlzLmxlZ2VuZC5saW5lcy5mb3JFYWNoKCBmdW5jdGlvbihsKSB7CgkJCXNlbGYuYWRkSGlnaGxpZ2h0RXZlbnRzKGwpOwoJCX0gKTsKCX0KCn07ClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguQmVoYXZpb3IuU2VyaWVzLk9yZGVyJyk7CgpSaWNrc2hhdy5HcmFwaC5CZWhhdmlvci5TZXJpZXMuT3JkZXIgPSBmdW5jdGlvbihhcmdzKSB7CgoJdGhpcy5ncmFwaCA9IGFyZ3MuZ3JhcGg7Cgl0aGlzLmxlZ2VuZCA9IGFyZ3MubGVnZW5kOwoKCXZhciBzZWxmID0gdGhpczsKCglpZiAodHlwZW9mIHdpbmRvdy5qUXVlcnkgPT0gJ3VuZGVmaW5lZCcpIHsKCQl0aHJvdyAiY291bGRuJ3QgZmluZCBqUXVlcnkgYXQgd2luZG93LmpRdWVyeSI7Cgl9CgoJaWYgKHR5cGVvZiB3aW5kb3cualF1ZXJ5LnVpID09ICd1bmRlZmluZWQnKSB7CgkJdGhyb3cgImNvdWxkbid0IGZpbmQgalF1ZXJ5IFVJIGF0IHdpbmRvdy5qUXVlcnkudWkiOwoJfQoKCWpRdWVyeShmdW5jdGlvbigpIHsKCQlqUXVlcnkoc2VsZi5sZWdlbmQubGlzdCkuc29ydGFibGUoIHsKCQkJY29udGFpbm1lbnQ6ICdwYXJlbnQnLAoJCQl0b2xlcmFuY2U6ICdwb2ludGVyJywKCQkJdXBkYXRlOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdmFyIHNlcmllcyA9IFtdOwoJCQkJalF1ZXJ5KHNlbGYubGVnZW5kLmxpc3QpLmZpbmQoJ2xpJykuZWFjaCggZnVuY3Rpb24oaW5kZXgsIGl0ZW0pIHsKCQkJCQlpZiAoIWl0ZW0uc2VyaWVzKSByZXR1cm47CgkJCQkJc2VyaWVzLnB1c2goaXRlbS5zZXJpZXMpOwoJCQkJfSApOwoKCQkJCWZvciAodmFyIGkgPSBzZWxmLmdyYXBoLnNlcmllcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoJCQkJCXNlbGYuZ3JhcGguc2VyaWVzW2ldID0gc2VyaWVzLnNoaWZ0KCk7CgkJCQl9CgoJCQkJc2VsZi5ncmFwaC51cGRhdGUoKTsKCQkJfQoJCX0gKTsKCQlqUXVlcnkoc2VsZi5sZWdlbmQubGlzdCkuZGlzYWJsZVNlbGVjdGlvbigpOwoJfSk7CgoJLy9oYWNrIHRvIG1ha2UganF1ZXJ5LXVpIHNvcnRhYmxlIGJlaGF2ZQoJdGhpcy5ncmFwaC5vblVwZGF0ZSggZnVuY3Rpb24oKSB7IAoJCXZhciBoID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoc2VsZi5sZWdlbmQuZWxlbWVudCkuaGVpZ2h0OwoJCXNlbGYubGVnZW5kLmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gaDsKCX0gKTsKfTsKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaC5CZWhhdmlvci5TZXJpZXMuVG9nZ2xlJyk7CgpSaWNrc2hhdy5HcmFwaC5CZWhhdmlvci5TZXJpZXMuVG9nZ2xlID0gZnVuY3Rpb24oYXJncykgewoKCXRoaXMuZ3JhcGggPSBhcmdzLmdyYXBoOwoJdGhpcy5sZWdlbmQgPSBhcmdzLmxlZ2VuZDsKCgl2YXIgc2VsZiA9IHRoaXM7CgoJdGhpcy5hZGRBbmNob3IgPSBmdW5jdGlvbihsaW5lKSB7CgoJCXZhciBhbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CgkJYW5jaG9yLmlubmVySFRNTCA9ICcmIzEwMDA0Oyc7CgkJYW5jaG9yLmNsYXNzTGlzdC5hZGQoJ2FjdGlvbicpOwoJCWxpbmUuZWxlbWVudC5pbnNlcnRCZWZvcmUoYW5jaG9yLCBsaW5lLmVsZW1lbnQuZmlyc3RDaGlsZCk7CgoJCWFuY2hvci5vbmNsaWNrID0gZnVuY3Rpb24oZSkgewoJCQlpZiAobGluZS5zZXJpZXMuZGlzYWJsZWQpIHsKCQkJCWxpbmUuc2VyaWVzLmVuYWJsZSgpOwoJCQkJbGluZS5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2Rpc2FibGVkJyk7CgkJCX0gZWxzZSB7IAoJCQkJaWYgKHRoaXMuZ3JhcGguc2VyaWVzLmZpbHRlcihmdW5jdGlvbihzKSB7IHJldHVybiAhcy5kaXNhYmxlZCB9KS5sZW5ndGggPD0gMSkgcmV0dXJuOwoJCQkJbGluZS5zZXJpZXMuZGlzYWJsZSgpOwoJCQkJbGluZS5lbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2Rpc2FibGVkJyk7CgkJCX0KCgkJfS5iaW5kKHRoaXMpOwoJCQogICAgICAgICAgICAgICAgdmFyIGxhYmVsID0gbGluZS5lbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzcGFuJylbMF07CiAgICAgICAgICAgICAgICBsYWJlbC5vbmNsaWNrID0gZnVuY3Rpb24oZSl7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlzYWJsZUFsbE90aGVyTGluZXMgPSBsaW5lLnNlcmllcy5kaXNhYmxlZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCAhIGRpc2FibGVBbGxPdGhlckxpbmVzICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNlbGYubGVnZW5kLmxpbmVzLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGwgPSBzZWxmLmxlZ2VuZC5saW5lc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICggbGluZS5zZXJpZXMgPT09IGwuc2VyaWVzICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBub29wCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBsLnNlcmllcy5kaXNhYmxlZCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm9vcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZUFsbE90aGVyTGluZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNob3cgYWxsIG9yIG5vbmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBkaXNhYmxlQWxsT3RoZXJMaW5lcyApIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlc2UgbXVzdCBoYXBwZW4gZmlyc3Qgb3IgZWxzZSB3ZSB0cnkgKCBhbmQgcHJvYmFibHkgZmFpbCApIHRvIG1ha2UgYSBubyBsaW5lIGdyYXBoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZS5zZXJpZXMuZW5hYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZS5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2Rpc2FibGVkJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubGVnZW5kLmxpbmVzLmZvckVhY2goZnVuY3Rpb24obCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGxpbmUuc2VyaWVzID09PSBsLnNlcmllcyApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm9vcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbC5zZXJpZXMuZGlzYWJsZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsLmVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZGlzYWJsZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubGVnZW5kLmxpbmVzLmZvckVhY2goZnVuY3Rpb24obCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsLnNlcmllcy5lbmFibGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGwuZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdkaXNhYmxlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH07CgoJfTsKCglpZiAodGhpcy5sZWdlbmQpIHsKCgkJdmFyICQgPSBqUXVlcnk7CgkJaWYgKHR5cGVvZiAkICE9ICd1bmRlZmluZWQnICYmICQodGhpcy5sZWdlbmQubGlzdCkuc29ydGFibGUpIHsKCgkJCSQodGhpcy5sZWdlbmQubGlzdCkuc29ydGFibGUoIHsKCQkJCXN0YXJ0OiBmdW5jdGlvbihldmVudCwgdWkpIHsKCQkJCQl1aS5pdGVtLmJpbmQoJ25vLm9uY2xpY2snLAoJCQkJCQlmdW5jdGlvbihldmVudCkgewoJCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJfQoJCQkJCSk7CgkJCQl9LAoJCQkJc3RvcDogZnVuY3Rpb24oZXZlbnQsIHVpKSB7CgkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJCQl1aS5pdGVtLnVuYmluZCgnbm8ub25jbGljaycpOwoJCQkJCX0sIDI1MCk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJdGhpcy5sZWdlbmQubGluZXMuZm9yRWFjaCggZnVuY3Rpb24obCkgewoJCQlzZWxmLmFkZEFuY2hvcihsKTsKCQl9ICk7Cgl9CgoJdGhpcy5fYWRkQmVoYXZpb3IgPSBmdW5jdGlvbigpIHsKCgkJdGhpcy5ncmFwaC5zZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24ocykgewoJCQkKCQkJcy5kaXNhYmxlID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKHNlbGYuZ3JhcGguc2VyaWVzLmxlbmd0aCA8PSAxKSB7CgkJCQkJdGhyb3coJ29ubHkgb25lIHNlcmllcyBsZWZ0Jyk7CgkJCQl9CgkJCQkKCQkJCXMuZGlzYWJsZWQgPSB0cnVlOwoJCQkJc2VsZi5ncmFwaC51cGRhdGUoKTsKCQkJfTsKCgkJCXMuZW5hYmxlID0gZnVuY3Rpb24oKSB7CgkJCQlzLmRpc2FibGVkID0gZmFsc2U7CgkJCQlzZWxmLmdyYXBoLnVwZGF0ZSgpOwoJCQl9OwoJCX0gKTsKCX07Cgl0aGlzLl9hZGRCZWhhdmlvcigpOwoKCXRoaXMudXBkYXRlQmVoYXZpb3VyID0gZnVuY3Rpb24gKCkgeyB0aGlzLl9hZGRCZWhhdmlvcigpIH07Cgp9OwpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkdyYXBoLkhvdmVyRGV0YWlsJyk7CgpSaWNrc2hhdy5HcmFwaC5Ib3ZlckRldGFpbCA9IFJpY2tzaGF3LkNsYXNzLmNyZWF0ZSh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oYXJncykgewoKCQl2YXIgZ3JhcGggPSB0aGlzLmdyYXBoID0gYXJncy5ncmFwaDsKCgkJdGhpcy54Rm9ybWF0dGVyID0gYXJncy54Rm9ybWF0dGVyIHx8IGZ1bmN0aW9uKHgpIHsKCQkJcmV0dXJuIG5ldyBEYXRlKCB4ICogMTAwMCApLnRvVVRDU3RyaW5nKCk7CgkJfTsKCgkJdGhpcy55Rm9ybWF0dGVyID0gYXJncy55Rm9ybWF0dGVyIHx8IGZ1bmN0aW9uKHkpIHsKCQkJcmV0dXJuIHkgPT09IG51bGwgPyB5IDogeS50b0ZpeGVkKDIpOwoJCX07CgoJCXZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJZWxlbWVudC5jbGFzc05hbWUgPSAnZGV0YWlsJzsKCgkJdGhpcy52aXNpYmxlID0gdHJ1ZTsKCQlncmFwaC5lbGVtZW50LmFwcGVuZENoaWxkKGVsZW1lbnQpOwoKCQl0aGlzLmxhc3RFdmVudCA9IG51bGw7CgkJdGhpcy5fYWRkTGlzdGVuZXJzKCk7CgoJCXRoaXMub25TaG93ID0gYXJncy5vblNob3c7CgkJdGhpcy5vbkhpZGUgPSBhcmdzLm9uSGlkZTsKCQl0aGlzLm9uUmVuZGVyID0gYXJncy5vblJlbmRlcjsKCgkJdGhpcy5mb3JtYXR0ZXIgPSBhcmdzLmZvcm1hdHRlciB8fCB0aGlzLmZvcm1hdHRlcjsKCgl9LAoKCWZvcm1hdHRlcjogZnVuY3Rpb24oc2VyaWVzLCB4LCB5LCBmb3JtYXR0ZWRYLCBmb3JtYXR0ZWRZLCBkKSB7CgkJcmV0dXJuIHNlcmllcy5uYW1lICsgJzombmJzcDsnICsgZm9ybWF0dGVkWTsKCX0sCgoJdXBkYXRlOiBmdW5jdGlvbihlKSB7CgoJCWUgPSBlIHx8IHRoaXMubGFzdEV2ZW50OwoJCWlmICghZSkgcmV0dXJuOwoJCXRoaXMubGFzdEV2ZW50ID0gZTsKCgkJaWYgKCFlLnRhcmdldC5ub2RlTmFtZS5tYXRjaCgvXihwYXRofHN2Z3xyZWN0fGNpcmNsZSkkLykpIHJldHVybjsKCgkJdmFyIGdyYXBoID0gdGhpcy5ncmFwaDsKCgkJdmFyIGV2ZW50WCA9IGUub2Zmc2V0WCB8fCBlLmxheWVyWDsKCQl2YXIgZXZlbnRZID0gZS5vZmZzZXRZIHx8IGUubGF5ZXJZOwoKCQl2YXIgaiA9IDA7CgkJdmFyIHBvaW50cyA9IFtdOwoJCXZhciBuZWFyZXN0UG9pbnQ7CgoJCXRoaXMuZ3JhcGguc2VyaWVzLmFjdGl2ZSgpLmZvckVhY2goIGZ1bmN0aW9uKHNlcmllcykgewoKCQkJdmFyIGRhdGEgPSB0aGlzLmdyYXBoLnN0YWNrZWREYXRhW2orK107CgoJCQlpZiAoIWRhdGEubGVuZ3RoKQoJCQkJcmV0dXJuOwoKCQkJdmFyIGRvbWFpblggPSBncmFwaC54LmludmVydChldmVudFgpOwoKCQkJdmFyIGRvbWFpbkluZGV4U2NhbGUgPSBkMy5zY2FsZS5saW5lYXIoKQoJCQkJLmRvbWFpbihbZGF0YVswXS54LCBkYXRhLnNsaWNlKC0xKVswXS54XSkKCQkJCS5yYW5nZShbMCwgZGF0YS5sZW5ndGggLSAxXSk7CgoJCQl2YXIgYXBwcm94aW1hdGVJbmRleCA9IE1hdGgucm91bmQoZG9tYWluSW5kZXhTY2FsZShkb21haW5YKSk7CgkJCWlmIChhcHByb3hpbWF0ZUluZGV4ID09IGRhdGEubGVuZ3RoIC0gMSkgYXBwcm94aW1hdGVJbmRleC0tOwoKCQkJdmFyIGRhdGFJbmRleCA9IE1hdGgubWluKGFwcHJveGltYXRlSW5kZXggfHwgMCwgZGF0YS5sZW5ndGggLSAxKTsKCgkJCWZvciAodmFyIGkgPSBhcHByb3hpbWF0ZUluZGV4OyBpIDwgZGF0YS5sZW5ndGggLSAxOykgewoKCQkJCWlmICghZGF0YVtpXSB8fCAhZGF0YVtpICsgMV0pIGJyZWFrOwoKCQkJCWlmIChkYXRhW2ldLnggPD0gZG9tYWluWCAmJiBkYXRhW2kgKyAxXS54ID4gZG9tYWluWCkgewoJCQkJCWRhdGFJbmRleCA9IE1hdGguYWJzKGRvbWFpblggLSBkYXRhW2ldLngpIDwgTWF0aC5hYnMoZG9tYWluWCAtIGRhdGFbaSArIDFdLngpID8gaSA6IGkgKyAxOwoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWlmIChkYXRhW2kgKyAxXS54IDw9IGRvbWFpblgpIHsgaSsrIH0gZWxzZSB7IGktLSB9CgkJCX0KCgkJCWlmIChkYXRhSW5kZXggPCAwKSBkYXRhSW5kZXggPSAwOwoJCQl2YXIgdmFsdWUgPSBkYXRhW2RhdGFJbmRleF07CgoJCQl2YXIgZGlzdGFuY2UgPSBNYXRoLnNxcnQoCgkJCQlNYXRoLnBvdyhNYXRoLmFicyhncmFwaC54KHZhbHVlLngpIC0gZXZlbnRYKSwgMikgKwoJCQkJTWF0aC5wb3coTWF0aC5hYnMoZ3JhcGgueSh2YWx1ZS55ICsgdmFsdWUueTApIC0gZXZlbnRZKSwgMikKCQkJKTsKCgkJCXZhciB4Rm9ybWF0dGVyID0gc2VyaWVzLnhGb3JtYXR0ZXIgfHwgdGhpcy54Rm9ybWF0dGVyOwoJCQl2YXIgeUZvcm1hdHRlciA9IHNlcmllcy55Rm9ybWF0dGVyIHx8IHRoaXMueUZvcm1hdHRlcjsKCgkJCXZhciBwb2ludCA9IHsKCQkJCWZvcm1hdHRlZFhWYWx1ZTogeEZvcm1hdHRlcih2YWx1ZS54KSwKCQkJCWZvcm1hdHRlZFlWYWx1ZTogeUZvcm1hdHRlcihzZXJpZXMuc2NhbGUgPyBzZXJpZXMuc2NhbGUuaW52ZXJ0KHZhbHVlLnkpIDogdmFsdWUueSksCgkJCQlzZXJpZXM6IHNlcmllcywKCQkJCXZhbHVlOiB2YWx1ZSwKCQkJCWRpc3RhbmNlOiBkaXN0YW5jZSwKCQkJCW9yZGVyOiBqLAoJCQkJbmFtZTogc2VyaWVzLm5hbWUKCQkJfTsKCgkJCWlmICghbmVhcmVzdFBvaW50IHx8IGRpc3RhbmNlIDwgbmVhcmVzdFBvaW50LmRpc3RhbmNlKSB7CgkJCQluZWFyZXN0UG9pbnQgPSBwb2ludDsKCQkJfQoKCQkJcG9pbnRzLnB1c2gocG9pbnQpOwoKCQl9LCB0aGlzICk7CgoJCWlmICghbmVhcmVzdFBvaW50KQoJCQlyZXR1cm47CgoJCW5lYXJlc3RQb2ludC5hY3RpdmUgPSB0cnVlOwoKCQl2YXIgZG9tYWluWCA9IG5lYXJlc3RQb2ludC52YWx1ZS54OwoJCXZhciBmb3JtYXR0ZWRYVmFsdWUgPSBuZWFyZXN0UG9pbnQuZm9ybWF0dGVkWFZhbHVlOwoKCQl0aGlzLmVsZW1lbnQuaW5uZXJIVE1MID0gJyc7CgkJdGhpcy5lbGVtZW50LnN0eWxlLmxlZnQgPSBncmFwaC54KGRvbWFpblgpICsgJ3B4JzsKCgkJdGhpcy52aXNpYmxlICYmIHRoaXMucmVuZGVyKCB7CgkJCXBvaW50czogcG9pbnRzLAoJCQlkZXRhaWw6IHBvaW50cywgLy8gZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CgkJCW1vdXNlWDogZXZlbnRYLAoJCQltb3VzZVk6IGV2ZW50WSwKCQkJZm9ybWF0dGVkWFZhbHVlOiBmb3JtYXR0ZWRYVmFsdWUsCgkJCWRvbWFpblg6IGRvbWFpblgKCQl9ICk7Cgl9LAoKCWhpZGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMudmlzaWJsZSA9IGZhbHNlOwoJCXRoaXMuZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdpbmFjdGl2ZScpOwoKCQlpZiAodHlwZW9mIHRoaXMub25IaWRlID09ICdmdW5jdGlvbicpIHsKCQkJdGhpcy5vbkhpZGUoKTsKCQl9Cgl9LAoKCXNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMudmlzaWJsZSA9IHRydWU7CgkJdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2luYWN0aXZlJyk7CgoJCWlmICh0eXBlb2YgdGhpcy5vblNob3cgPT0gJ2Z1bmN0aW9uJykgewoJCQl0aGlzLm9uU2hvdygpOwoJCX0KCX0sCgoJcmVuZGVyOiBmdW5jdGlvbihhcmdzKSB7CgoJCXZhciBncmFwaCA9IHRoaXMuZ3JhcGg7CgkJdmFyIHBvaW50cyA9IGFyZ3MucG9pbnRzOwoJCXZhciBwb2ludCA9IHBvaW50cy5maWx0ZXIoIGZ1bmN0aW9uKHApIHsgcmV0dXJuIHAuYWN0aXZlIH0gKS5zaGlmdCgpOwoKCQlpZiAocG9pbnQudmFsdWUueSA9PT0gbnVsbCkgcmV0dXJuOwoKCQl2YXIgZm9ybWF0dGVkWFZhbHVlID0gcG9pbnQuZm9ybWF0dGVkWFZhbHVlOwoJCXZhciBmb3JtYXR0ZWRZVmFsdWUgPSBwb2ludC5mb3JtYXR0ZWRZVmFsdWU7CgoJCXRoaXMuZWxlbWVudC5pbm5lckhUTUwgPSAnJzsKCQl0aGlzLmVsZW1lbnQuc3R5bGUubGVmdCA9IGdyYXBoLngocG9pbnQudmFsdWUueCkgKyAncHgnOwoKCQl2YXIgeExhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgoJCXhMYWJlbC5jbGFzc05hbWUgPSAneF9sYWJlbCc7CgkJeExhYmVsLmlubmVySFRNTCA9IGZvcm1hdHRlZFhWYWx1ZTsKCQl0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQoeExhYmVsKTsKCgkJdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCgkJaXRlbS5jbGFzc05hbWUgPSAnaXRlbSc7CgoJCS8vIGludmVydCB0aGUgc2NhbGUgaWYgdGhpcyBzZXJpZXMgZGlzcGxheXMgdXNpbmcgYSBzY2FsZQoJCXZhciBzZXJpZXMgPSBwb2ludC5zZXJpZXM7CgkJdmFyIGFjdHVhbFkgPSBzZXJpZXMuc2NhbGUgPyBzZXJpZXMuc2NhbGUuaW52ZXJ0KHBvaW50LnZhbHVlLnkpIDogcG9pbnQudmFsdWUueTsKCgkJaXRlbS5pbm5lckhUTUwgPSB0aGlzLmZvcm1hdHRlcihzZXJpZXMsIHBvaW50LnZhbHVlLngsIGFjdHVhbFksIGZvcm1hdHRlZFhWYWx1ZSwgZm9ybWF0dGVkWVZhbHVlLCBwb2ludCk7CgkJaXRlbS5zdHlsZS50b3AgPSB0aGlzLmdyYXBoLnkocG9pbnQudmFsdWUueTAgKyBwb2ludC52YWx1ZS55KSArICdweCc7CgoJCXRoaXMuZWxlbWVudC5hcHBlbmRDaGlsZChpdGVtKTsKCgkJdmFyIGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCQlkb3QuY2xhc3NOYW1lID0gJ2RvdCc7CgkJZG90LnN0eWxlLnRvcCA9IGl0ZW0uc3R5bGUudG9wOwoJCWRvdC5zdHlsZS5ib3JkZXJDb2xvciA9IHNlcmllcy5jb2xvcjsKCgkJdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKGRvdCk7CgoJCWlmIChwb2ludC5hY3RpdmUpIHsKCQkJaXRlbS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKCQkJZG90LmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwoJCX0KCgkJLy8gQXNzdW1lIGxlZnQgYWxpZ25tZW50IHVudGlsIHRoZSBlbGVtZW50IGhhcyBiZWVuIGRpc3BsYXllZCBhbmQKCQkvLyBib3VuZGluZyBib3ggY2FsY3VsYXRpb25zIGFyZSBwb3NzaWJsZS4KCQl2YXIgYWxpZ25hYmxlcyA9IFt4TGFiZWwsIGl0ZW1dOwoJCWFsaWduYWJsZXMuZm9yRWFjaChmdW5jdGlvbihlbCkgewoJCQllbC5jbGFzc0xpc3QuYWRkKCdsZWZ0Jyk7CgkJfSk7CgoJCXRoaXMuc2hvdygpOwoKCQkvLyBJZiBsZWZ0LWFsaWdubWVudCByZXN1bHRzIGluIGFueSBlcnJvciwgdHJ5IHJpZ2h0LWFsaWdubWVudC4KCQl2YXIgbGVmdEFsaWduRXJyb3IgPSB0aGlzLl9jYWxjTGF5b3V0RXJyb3IoYWxpZ25hYmxlcyk7CgkJaWYgKGxlZnRBbGlnbkVycm9yID4gMCkgewoJCQlhbGlnbmFibGVzLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKCQkJCWVsLmNsYXNzTGlzdC5yZW1vdmUoJ2xlZnQnKTsKCQkJCWVsLmNsYXNzTGlzdC5hZGQoJ3JpZ2h0Jyk7CgkJCX0pOwoKCQkJLy8gSWYgcmlnaHQtYWxpZ25tZW50IGlzIHdvcnNlIHRoYW4gbGVmdCBhbGlnbm1lbnQsIHN3aXRjaCBiYWNrLgoJCQl2YXIgcmlnaHRBbGlnbkVycm9yID0gdGhpcy5fY2FsY0xheW91dEVycm9yKGFsaWduYWJsZXMpOwoJCQlpZiAocmlnaHRBbGlnbkVycm9yID4gbGVmdEFsaWduRXJyb3IpIHsKCQkJCWFsaWduYWJsZXMuZm9yRWFjaChmdW5jdGlvbihlbCkgewoJCQkJCWVsLmNsYXNzTGlzdC5yZW1vdmUoJ3JpZ2h0Jyk7CgkJCQkJZWwuY2xhc3NMaXN0LmFkZCgnbGVmdCcpOwoJCQkJfSk7CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YgdGhpcy5vblJlbmRlciA9PSAnZnVuY3Rpb24nKSB7CgkJCXRoaXMub25SZW5kZXIoYXJncyk7CgkJfQoJfSwKCglfY2FsY0xheW91dEVycm9yOiBmdW5jdGlvbihhbGlnbmFibGVzKSB7CgkJLy8gTGF5b3V0IGVycm9yIGlzIGNhbGN1bGF0ZWQgYXMgdGhlIG51bWJlciBvZiBsaW5lYXIgcGl4ZWxzIGJ5IHdoaWNoCgkJLy8gYW4gYWxpZ25hYmxlIGV4dGVuZHMgcGFzdCB0aGUgbGVmdCBvciByaWdodCBlZGdlIG9mIHRoZSBwYXJlbnQuCgkJdmFyIHBhcmVudFJlY3QgPSB0aGlzLmVsZW1lbnQucGFyZW50Tm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCgkJdmFyIGVycm9yID0gMDsKCQl2YXIgYWxpZ25SaWdodCA9IGFsaWduYWJsZXMuZm9yRWFjaChmdW5jdGlvbihlbCkgewoJCQl2YXIgcmVjdCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoJCQlpZiAoIXJlY3Qud2lkdGgpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKHJlY3QucmlnaHQgPiBwYXJlbnRSZWN0LnJpZ2h0KSB7CgkJCQllcnJvciArPSByZWN0LnJpZ2h0IC0gcGFyZW50UmVjdC5yaWdodDsKCQkJfQoKCQkJaWYgKHJlY3QubGVmdCA8IHBhcmVudFJlY3QubGVmdCkgewoJCQkJZXJyb3IgKz0gcGFyZW50UmVjdC5sZWZ0IC0gcmVjdC5sZWZ0OwoJCQl9CgkJfSk7CgkJcmV0dXJuIGVycm9yOwoJfSwKCglfYWRkTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKCgkJdGhpcy5ncmFwaC5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoCgkJCSdtb3VzZW1vdmUnLAoJCQlmdW5jdGlvbihlKSB7CgkJCQl0aGlzLnZpc2libGUgPSB0cnVlOwoJCQkJdGhpcy51cGRhdGUoZSk7CgkJCX0uYmluZCh0aGlzKSwKCQkJZmFsc2UKCQkpOwoKCQl0aGlzLmdyYXBoLm9uVXBkYXRlKCBmdW5jdGlvbigpIHsgdGhpcy51cGRhdGUoKSB9LmJpbmQodGhpcykgKTsKCgkJdGhpcy5ncmFwaC5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoCgkJCSdtb3VzZW91dCcsCgkJCWZ1bmN0aW9uKGUpIHsKCQkJCWlmIChlLnJlbGF0ZWRUYXJnZXQgJiYgIShlLnJlbGF0ZWRUYXJnZXQuY29tcGFyZURvY3VtZW50UG9zaXRpb24odGhpcy5ncmFwaC5lbGVtZW50KSAmIE5vZGUuRE9DVU1FTlRfUE9TSVRJT05fQ09OVEFJTlMpKSB7CgkJCQkJdGhpcy5oaWRlKCk7CgkJCQl9CgkJCX0uYmluZCh0aGlzKSwKCQkJZmFsc2UKCQkpOwoJfQp9KTsKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaC5KU09OUCcpOwoKUmlja3NoYXcuR3JhcGguSlNPTlAgPSBSaWNrc2hhdy5DbGFzcy5jcmVhdGUoIFJpY2tzaGF3LkdyYXBoLkFqYXgsIHsKCglyZXF1ZXN0OiBmdW5jdGlvbigpIHsKCgkJalF1ZXJ5LmFqYXgoIHsKCQkJdXJsOiB0aGlzLmRhdGFVUkwsCgkJCWRhdGFUeXBlOiAnanNvbnAnLAoJCQlzdWNjZXNzOiB0aGlzLnN1Y2Nlc3MuYmluZCh0aGlzKSwKCQkJZXJyb3I6IHRoaXMuZXJyb3IuYmluZCh0aGlzKQoJCX0gKTsKCX0KfSApOwpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkdyYXBoLkxlZ2VuZCcpOwoKUmlja3NoYXcuR3JhcGguTGVnZW5kID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCB7CgoJY2xhc3NOYW1lOiAncmlja3NoYXdfbGVnZW5kJywKCglpbml0aWFsaXplOiBmdW5jdGlvbihhcmdzKSB7CgkJdGhpcy5lbGVtZW50ID0gYXJncy5lbGVtZW50OwoJCXRoaXMuZ3JhcGggPSBhcmdzLmdyYXBoOwoJCXRoaXMubmF0dXJhbE9yZGVyID0gYXJncy5uYXR1cmFsT3JkZXI7CgoJCXRoaXMuZWxlbWVudC5jbGFzc0xpc3QuYWRkKHRoaXMuY2xhc3NOYW1lKTsKCgkJdGhpcy5saXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTsKCQl0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5saXN0KTsKCgkJdGhpcy5yZW5kZXIoKTsKCgkJLy8gd2UgY291bGQgYmluZCB0aGlzLnJlbmRlci5iaW5kKHRoaXMpIGhlcmUKCQkvLyBidXQgdHJpZ2dlcmluZyB0aGUgcmUtcmVuZGVyIHdvdWxkIGxvc2UgdGhlIGFkZGVkCgkJLy8gYmVoYXZpb3Igb2YgdGhlIHNlcmllcyB0b2dnbGUKCQl0aGlzLmdyYXBoLm9uVXBkYXRlKCBmdW5jdGlvbigpIHt9ICk7Cgl9LAoKCXJlbmRlcjogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl3aGlsZSAoIHRoaXMubGlzdC5maXJzdENoaWxkICkgewoJCQl0aGlzLmxpc3QucmVtb3ZlQ2hpbGQoIHRoaXMubGlzdC5maXJzdENoaWxkICk7CgkJfQoJCXRoaXMubGluZXMgPSBbXTsKCgkJdmFyIHNlcmllcyA9IHRoaXMuZ3JhcGguc2VyaWVzCgkJCS5tYXAoIGZ1bmN0aW9uKHMpIHsgcmV0dXJuIHMgfSApOwoKCQlpZiAoIXRoaXMubmF0dXJhbE9yZGVyKSB7CgkJCXNlcmllcyA9IHNlcmllcy5yZXZlcnNlKCk7CgkJfQoKCQlzZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24ocykgewoJCQlzZWxmLmFkZExpbmUocyk7CgkJfSApOwoKCgl9LAoKCWFkZExpbmU6IGZ1bmN0aW9uIChzZXJpZXMpIHsKCQl2YXIgbGluZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7CgkJbGluZS5jbGFzc05hbWUgPSAnbGluZSc7CgkJaWYgKHNlcmllcy5kaXNhYmxlZCkgewoJCQlsaW5lLmNsYXNzTmFtZSArPSAnIGRpc2FibGVkJzsKCQl9CgkJaWYgKHNlcmllcy5jbGFzc05hbWUpIHsKCQkJZDMuc2VsZWN0KGxpbmUpLmNsYXNzZWQoc2VyaWVzLmNsYXNzTmFtZSwgdHJ1ZSk7CgkJfQoJCXZhciBzd2F0Y2ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQlzd2F0Y2guY2xhc3NOYW1lID0gJ3N3YXRjaCc7CgkJc3dhdGNoLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHNlcmllcy5jb2xvcjsKCgkJbGluZS5hcHBlbmRDaGlsZChzd2F0Y2gpOwoKCQl2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7CgkJbGFiZWwuY2xhc3NOYW1lID0gJ2xhYmVsJzsKCQlsYWJlbC5pbm5lckhUTUwgPSBzZXJpZXMubmFtZTsKCgkJbGluZS5hcHBlbmRDaGlsZChsYWJlbCk7CgkJdGhpcy5saXN0LmFwcGVuZENoaWxkKGxpbmUpOwoKCQlsaW5lLnNlcmllcyA9IHNlcmllczsKCgkJaWYgKHNlcmllcy5ub0xlZ2VuZCkgewoJCQlsaW5lLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgkJfQoKCQl2YXIgX2xpbmUgPSB7IGVsZW1lbnQ6IGxpbmUsIHNlcmllczogc2VyaWVzIH07CgkJaWYgKHRoaXMuc2hlbHZpbmcpIHsKCQkJdGhpcy5zaGVsdmluZy5hZGRBbmNob3IoX2xpbmUpOwoJCQl0aGlzLnNoZWx2aW5nLnVwZGF0ZUJlaGF2aW91cigpOwoJCX0KCQlpZiAodGhpcy5oaWdobGlnaHRlcikgewoJCQl0aGlzLmhpZ2hsaWdodGVyLmFkZEhpZ2hsaWdodEV2ZW50cyhfbGluZSk7CgkJfQoJCXRoaXMubGluZXMucHVzaChfbGluZSk7CgkJcmV0dXJuIGxpbmU7Cgl9Cn0gKTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguUmFuZ2VTbGlkZXInKTsKClJpY2tzaGF3LkdyYXBoLlJhbmdlU2xpZGVyID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKHsKCglpbml0aWFsaXplOiBmdW5jdGlvbihhcmdzKSB7CgoJCXZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50ID0gYXJncy5lbGVtZW50OwoJCXZhciBncmFwaCA9IHRoaXMuZ3JhcGggPSBhcmdzLmdyYXBoOwoKCQl0aGlzLnNsaWRlQ2FsbGJhY2tzID0gW107CgoJCXRoaXMuYnVpbGQoKTsKCgkJZ3JhcGgub25VcGRhdGUoIGZ1bmN0aW9uKCkgeyB0aGlzLnVwZGF0ZSgpIH0uYmluZCh0aGlzKSApOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50OwoJCXZhciBncmFwaCA9IHRoaXMuZ3JhcGg7CgkJdmFyICQgPSBqUXVlcnk7CgoJCXZhciBkb21haW4gPSBncmFwaC5kYXRhRG9tYWluKCk7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQkkKCBmdW5jdGlvbigpIHsKCQkJJChlbGVtZW50KS5zbGlkZXIoIHsKCQkJCXJhbmdlOiB0cnVlLAoJCQkJbWluOiBkb21haW5bMF0sCgkJCQltYXg6IGRvbWFpblsxXSwKCQkJCXZhbHVlczogWyAKCQkJCQlkb21haW5bMF0sCgkJCQkJZG9tYWluWzFdCgkJCQldLAoJCQkJc2xpZGU6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgoJCQkJCWlmICh1aS52YWx1ZXNbMV0gPD0gdWkudmFsdWVzWzBdKSByZXR1cm47CgoJCQkJCWdyYXBoLndpbmRvdy54TWluID0gdWkudmFsdWVzWzBdOwoJCQkJCWdyYXBoLndpbmRvdy54TWF4ID0gdWkudmFsdWVzWzFdOwoJCQkJCWdyYXBoLnVwZGF0ZSgpOwoKCQkJCQl2YXIgZG9tYWluID0gZ3JhcGguZGF0YURvbWFpbigpOwoKCQkJCQkvLyBpZiB3ZSdyZSBhdCBhbiBleHRyZW1lLCBzdGljayB0aGVyZQoJCQkJCWlmIChkb21haW5bMF0gPT0gdWkudmFsdWVzWzBdKSB7CgkJCQkJCWdyYXBoLndpbmRvdy54TWluID0gdW5kZWZpbmVkOwoJCQkJCX0KCgkJCQkJaWYgKGRvbWFpblsxXSA9PSB1aS52YWx1ZXNbMV0pIHsKCQkJCQkJZ3JhcGgud2luZG93LnhNYXggPSB1bmRlZmluZWQ7CgkJCQkJfQoKCQkJCQlzZWxmLnNsaWRlQ2FsbGJhY2tzLmZvckVhY2goZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCQkJY2FsbGJhY2soZ3JhcGgsIGdyYXBoLndpbmRvdy54TWluLCBncmFwaC53aW5kb3cueE1heCk7CgkJCQkJfSk7CgkJCQl9CgkJCX0gKTsKCQl9ICk7CgoJCSQoZWxlbWVudClbMF0uc3R5bGUud2lkdGggPSBncmFwaC53aWR0aCArICdweCc7CgoJfSwKCgl1cGRhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQl2YXIgZ3JhcGggPSB0aGlzLmdyYXBoOwoJCXZhciAkID0galF1ZXJ5OwoKCQl2YXIgdmFsdWVzID0gJChlbGVtZW50KS5zbGlkZXIoJ29wdGlvbicsICd2YWx1ZXMnKTsKCgkJdmFyIGRvbWFpbiA9IGdyYXBoLmRhdGFEb21haW4oKTsKCgkJJChlbGVtZW50KS5zbGlkZXIoJ29wdGlvbicsICdtaW4nLCBkb21haW5bMF0pOwoJCSQoZWxlbWVudCkuc2xpZGVyKCdvcHRpb24nLCAnbWF4JywgZG9tYWluWzFdKTsKCgkJaWYgKGdyYXBoLndpbmRvdy54TWluID09IG51bGwpIHsKCQkJdmFsdWVzWzBdID0gZG9tYWluWzBdOwoJCX0KCQlpZiAoZ3JhcGgud2luZG93LnhNYXggPT0gbnVsbCkgewoJCQl2YWx1ZXNbMV0gPSBkb21haW5bMV07CgkJfQoKCQkkKGVsZW1lbnQpLnNsaWRlcignb3B0aW9uJywgJ3ZhbHVlcycsIHZhbHVlcyk7Cgl9LAoKCW9uU2xpZGU6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJdGhpcy5zbGlkZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKCX0KfSk7CgpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkdyYXBoLlJhbmdlU2xpZGVyLlByZXZpZXcnKTsKClJpY2tzaGF3LkdyYXBoLlJhbmdlU2xpZGVyLlByZXZpZXcgPSBSaWNrc2hhdy5DbGFzcy5jcmVhdGUoewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGFyZ3MpIHsKCgkJaWYgKCFhcmdzLmVsZW1lbnQpIHRocm93ICJSaWNrc2hhdy5HcmFwaC5SYW5nZVNsaWRlci5QcmV2aWV3IG5lZWRzIGEgcmVmZXJlbmNlIHRvIGFuIGVsZW1lbnQiOwoJCWlmICghYXJncy5ncmFwaCAmJiAhYXJncy5ncmFwaHMpIHRocm93ICJSaWNrc2hhdy5HcmFwaC5SYW5nZVNsaWRlci5QcmV2aWV3IG5lZWRzIGEgcmVmZXJlbmNlIHRvIGFuIGdyYXBoIG9yIGFuIGFycmF5IG9mIGdyYXBocyI7CgoJCXRoaXMuZWxlbWVudCA9IGFyZ3MuZWxlbWVudDsKCQl0aGlzLmVsZW1lbnQuc3R5bGUucG9zaXRpb24gPSAncmVsYXRpdmUnOwoKCQl0aGlzLmdyYXBocyA9IGFyZ3MuZ3JhcGggPyBbIGFyZ3MuZ3JhcGggXSA6IGFyZ3MuZ3JhcGhzOwoKCQl0aGlzLmRlZmF1bHRzID0gewoJCQloZWlnaHQ6IDc1LAoJCQl3aWR0aDogNDAwLAoJCQlncmlwcGVyQ29sb3I6IHVuZGVmaW5lZCwKCQkJZnJhbWVUb3BUaGlja25lc3M6IDMsCgkJCWZyYW1lSGFuZGxlVGhpY2tuZXNzOiAxMCwKCQkJZnJhbWVDb2xvcjogIiNkNGQ0ZDQiLAoJCQlmcmFtZU9wYWNpdHk6IDEsCgkJCW1pbmltdW1GcmFtZVdpZHRoOiAwLAoJCQloZWlnaHRSYXRpbzogMC4yCgkJfTsKCgkJdGhpcy5oZWlnaHRSYXRpbyA9IGFyZ3MuaGVpZ2h0UmF0aW8gfHwgdGhpcy5kZWZhdWx0cy5oZWlnaHRSYXRpbzsKCQl0aGlzLmRlZmF1bHRzLmdyaXBwZXJDb2xvciA9IGQzLnJnYih0aGlzLmRlZmF1bHRzLmZyYW1lQ29sb3IpLmRhcmtlcigpLnRvU3RyaW5nKCk7IAoKCQl0aGlzLmNvbmZpZ3VyZUNhbGxiYWNrcyA9IFtdOwoJCXRoaXMuc2xpZGVDYWxsYmFja3MgPSBbXTsKCgkJdGhpcy5wcmV2aWV3cyA9IFtdOwoKCQlpZiAoIWFyZ3Mud2lkdGgpIHRoaXMud2lkdGhGcm9tR3JhcGggPSB0cnVlOwoJCWlmICghYXJncy5oZWlnaHQpIHRoaXMuaGVpZ2h0RnJvbUdyYXBoID0gdHJ1ZTsKCgkJaWYgKHRoaXMud2lkdGhGcm9tR3JhcGggfHwgdGhpcy5oZWlnaHRGcm9tR3JhcGgpIHsKCQkJdGhpcy5ncmFwaHNbMF0ub25Db25maWd1cmUoZnVuY3Rpb24gKCkgewoJCQkJdGhpcy5jb25maWd1cmUoYXJncyk7IHRoaXMucmVuZGVyKCk7CgkJCX0uYmluZCh0aGlzKSk7CgkJfQoKCQlhcmdzLndpZHRoID0gYXJncy53aWR0aCB8fCB0aGlzLmdyYXBoc1swXS53aWR0aCB8fCB0aGlzLmRlZmF1bHRzLndpZHRoOwoJCWFyZ3MuaGVpZ2h0ID0gYXJncy5oZWlnaHQgfHwgdGhpcy5ncmFwaHNbMF0uaGVpZ2h0ICogdGhpcy5oZWlnaHRSYXRpbyB8fCB0aGlzLmRlZmF1bHRzLmhlaWdodDsKCgkJdGhpcy5jb25maWd1cmUoYXJncyk7CgkJdGhpcy5yZW5kZXIoKTsKCX0sCgoJb25TbGlkZTogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQl0aGlzLnNsaWRlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwoJfSwKCglvbkNvbmZpZ3VyZTogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQl0aGlzLmNvbmZpZ3VyZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTsKCX0sCgoJY29uZmlndXJlOiBmdW5jdGlvbihhcmdzKSB7CgoJCXRoaXMuY29uZmlnID0gdGhpcy5jb25maWcgfHwge307CgoJCXRoaXMuY29uZmlndXJlQ2FsbGJhY2tzLmZvckVhY2goZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJY2FsbGJhY2soYXJncyk7CgkJfSk7CgoJCVJpY2tzaGF3LmtleXModGhpcy5kZWZhdWx0cykuZm9yRWFjaChmdW5jdGlvbihrKSB7CgkJCXRoaXMuY29uZmlnW2tdID0gayBpbiBhcmdzID8gYXJnc1trXQoJCQkJOiBrIGluIHRoaXMuY29uZmlnID8gdGhpcy5jb25maWdba10KCQkJCTogdGhpcy5kZWZhdWx0c1trXTsKCQl9LCB0aGlzKTsKCgkJaWYgKCd3aWR0aCcgaW4gYXJncyB8fCAnaGVpZ2h0JyBpbiBhcmdzKSB7CgoJCQlpZiAodGhpcy53aWR0aEZyb21HcmFwaCkgewoJCQkJdGhpcy5jb25maWcud2lkdGggPSB0aGlzLmdyYXBoc1swXS53aWR0aDsKCQkJfQoKCQkJaWYgKHRoaXMuaGVpZ2h0RnJvbUdyYXBoKSB7CgkJCQl0aGlzLmNvbmZpZy5oZWlnaHQgPSB0aGlzLmdyYXBoc1swXS5oZWlnaHQgKiB0aGlzLmhlaWdodFJhdGlvOwoJCQkJdGhpcy5wcmV2aWV3SGVpZ2h0ID0gdGhpcy5jb25maWcuaGVpZ2h0OwoJCQl9CgoJCQl0aGlzLnByZXZpZXdzLmZvckVhY2goZnVuY3Rpb24ocHJldmlldykgewoKCQkJCXZhciBoZWlnaHQgPSB0aGlzLnByZXZpZXdIZWlnaHQgLyB0aGlzLmdyYXBocy5sZW5ndGggLSB0aGlzLmNvbmZpZy5mcmFtZVRvcFRoaWNrbmVzcyAqIDI7CgkJCQl2YXIgd2lkdGggPSB0aGlzLmNvbmZpZy53aWR0aCAtIHRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzICogMjsKCQkJCXByZXZpZXcuc2V0U2l6ZSh7IHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfSk7CgoJCQkJaWYgKHRoaXMuc3ZnKSB7CgkJCQkJdmFyIHN2Z0hlaWdodCA9IGhlaWdodCArIHRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzICogMjsKCQkJCQl2YXIgc3ZnV2lkdGggPSB3aWR0aCArIHRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzICogMjsKCQkJCQl0aGlzLnN2Zy5zdHlsZSgid2lkdGgiLCBzdmdXaWR0aCArICJweCIpOwoJCQkJCXRoaXMuc3ZnLnN0eWxlKCJoZWlnaHQiLCBzdmdIZWlnaHQgKyAicHgiKTsKCQkJCX0KCQkJfSwgdGhpcyk7CgkJfQoJfSwKCglyZW5kZXI6IGZ1bmN0aW9uKCkgewoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc3ZnID0gZDMuc2VsZWN0KHRoaXMuZWxlbWVudCkKCQkJLnNlbGVjdEFsbCgic3ZnLnJpY2tzaGF3X3JhbmdlX3NsaWRlcl9wcmV2aWV3IikKCQkJLmRhdGEoW251bGxdKTsKCgkJdGhpcy5wcmV2aWV3SGVpZ2h0ID0gdGhpcy5jb25maWcuaGVpZ2h0IC0gKHRoaXMuY29uZmlnLmZyYW1lVG9wVGhpY2tuZXNzICogMik7CgkJdGhpcy5wcmV2aWV3V2lkdGggPSB0aGlzLmNvbmZpZy53aWR0aCAtICh0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcyAqIDIpOwoKCQl0aGlzLmN1cnJlbnRGcmFtZSA9IFswLCB0aGlzLnByZXZpZXdXaWR0aF07CgoJCXZhciBidWlsZEdyYXBoID0gZnVuY3Rpb24ocGFyZW50LCBpbmRleCkgewoKCQkJdmFyIGdyYXBoQXJncyA9IFJpY2tzaGF3LmV4dGVuZCh7fSwgcGFyZW50LmNvbmZpZyk7CgkJCXZhciBoZWlnaHQgPSBzZWxmLnByZXZpZXdIZWlnaHQgLyBzZWxmLmdyYXBocy5sZW5ndGg7CgkJCXZhciByZW5kZXJlciA9IHBhcmVudC5yZW5kZXJlci5uYW1lOwoKCQkJUmlja3NoYXcuZXh0ZW5kKGdyYXBoQXJncywgewoJCQkJZWxlbWVudDogdGhpcy5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSksCgkJCQloZWlnaHQ6IGhlaWdodCwKCQkJCXdpZHRoOiBzZWxmLnByZXZpZXdXaWR0aCwKCQkJCXNlcmllczogcGFyZW50LnNlcmllcywKCQkJCXJlbmRlcmVyOiByZW5kZXJlcgoJCQl9KTsKCgkJCXZhciBncmFwaCA9IG5ldyBSaWNrc2hhdy5HcmFwaChncmFwaEFyZ3MpOwoJCQlzZWxmLnByZXZpZXdzLnB1c2goZ3JhcGgpOwoKCQkJcGFyZW50Lm9uVXBkYXRlKGZ1bmN0aW9uKCkgeyBncmFwaC5yZW5kZXIoKTsgc2VsZi5yZW5kZXIoKSB9KTsKCgkJCXBhcmVudC5vbkNvbmZpZ3VyZShmdW5jdGlvbihhcmdzKSB7IAoJCQkJLy8gZG9uJ3QgcHJvcGFnYXRlIGhlaWdodAoJCQkJZGVsZXRlIGFyZ3MuaGVpZ2h0OwoJCQkJYXJncy53aWR0aCA9IGFyZ3Mud2lkdGggLSBzZWxmLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcyAqIDI7CgkJCQlncmFwaC5jb25maWd1cmUoYXJncyk7CgkJCQlncmFwaC5yZW5kZXIoKTsKCQkJfSk7CgoJCQlncmFwaC5yZW5kZXIoKTsKCQl9OwoKCQl2YXIgZ3JhcGhDb250YWluZXIgPSBkMy5zZWxlY3QodGhpcy5lbGVtZW50KQoJCQkuc2VsZWN0QWxsKCJkaXYucmlja3NoYXdfcmFuZ2Vfc2xpZGVyX3ByZXZpZXdfY29udGFpbmVyIikKCQkJLmRhdGEodGhpcy5ncmFwaHMpOwoKCQl2YXIgdHJhbnNsYXRlQ29tbWFuZCA9ICJ0cmFuc2xhdGUoIiArCgkJCXRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzICsgInB4LCAiICsKCQkJdGhpcy5jb25maWcuZnJhbWVUb3BUaGlja25lc3MgKyAicHgpIjsKCgkJZ3JhcGhDb250YWluZXIuZW50ZXIoKQoJCQkuYXBwZW5kKCJkaXYiKQoJCQkuY2xhc3NlZCgicmlja3NoYXdfcmFuZ2Vfc2xpZGVyX3ByZXZpZXdfY29udGFpbmVyIiwgdHJ1ZSkKCQkJLnN0eWxlKCItd2Via2l0LXRyYW5zZm9ybSIsIHRyYW5zbGF0ZUNvbW1hbmQpCgkJCS5zdHlsZSgiLW1vei10cmFuc2Zvcm0iLCB0cmFuc2xhdGVDb21tYW5kKQoJCQkuc3R5bGUoIi1tcy10cmFuc2Zvcm0iLCB0cmFuc2xhdGVDb21tYW5kKQoJCQkuc3R5bGUoInRyYW5zZm9ybSIsIHRyYW5zbGF0ZUNvbW1hbmQpCgkJCS5lYWNoKGJ1aWxkR3JhcGgpOwoKCQlncmFwaENvbnRhaW5lci5leGl0KCkKCQkJLnJlbW92ZSgpOwoKCQkvLyBVc2UgdGhlIGZpcnN0IGdyYXBoIGFzIHRoZSAibWFzdGVyIiBmb3IgdGhlIGZyYW1lIHN0YXRlCgkJdmFyIG1hc3RlckdyYXBoID0gdGhpcy5ncmFwaHNbMF07CgoJCXZhciBkb21haW5TY2FsZSA9IGQzLnNjYWxlLmxpbmVhcigpCgkJCS5kb21haW4oWzAsIHRoaXMucHJldmlld1dpZHRoXSkKCQkJLnJhbmdlKG1hc3RlckdyYXBoLmRhdGFEb21haW4oKSk7CgoJCXZhciBjdXJyZW50V2luZG93ID0gW21hc3RlckdyYXBoLndpbmRvdy54TWluLCBtYXN0ZXJHcmFwaC53aW5kb3cueE1heF07CgoJCXRoaXMuY3VycmVudEZyYW1lWzBdID0gY3VycmVudFdpbmRvd1swXSA9PT0gdW5kZWZpbmVkID8gCgkJCTAgOiBNYXRoLnJvdW5kKGRvbWFpblNjYWxlLmludmVydChjdXJyZW50V2luZG93WzBdKSk7CgoJCWlmICh0aGlzLmN1cnJlbnRGcmFtZVswXSA8IDApIHRoaXMuY3VycmVudEZyYW1lWzBdID0gMDsKCgkJdGhpcy5jdXJyZW50RnJhbWVbMV0gPSBjdXJyZW50V2luZG93WzFdID09PSB1bmRlZmluZWQgPwoJCQl0aGlzLnByZXZpZXdXaWR0aCA6IGRvbWFpblNjYWxlLmludmVydChjdXJyZW50V2luZG93WzFdKTsKCgkJaWYgKHRoaXMuY3VycmVudEZyYW1lWzFdIC0gdGhpcy5jdXJyZW50RnJhbWVbMF0gPCBzZWxmLmNvbmZpZy5taW5pbXVtRnJhbWVXaWR0aCkgewoJCQl0aGlzLmN1cnJlbnRGcmFtZVsxXSA9ICh0aGlzLmN1cnJlbnRGcmFtZVswXSB8fCAwKSArIHNlbGYuY29uZmlnLm1pbmltdW1GcmFtZVdpZHRoOwoJCX0KCgkJdGhpcy5zdmcuZW50ZXIoKQoJCQkuYXBwZW5kKCJzdmciKQoJCQkuY2xhc3NlZCgicmlja3NoYXdfcmFuZ2Vfc2xpZGVyX3ByZXZpZXciLCB0cnVlKQoJCQkuc3R5bGUoImhlaWdodCIsIHRoaXMuY29uZmlnLmhlaWdodCArICJweCIpCgkJCS5zdHlsZSgid2lkdGgiLCB0aGlzLmNvbmZpZy53aWR0aCArICJweCIpCgkJCS5zdHlsZSgicG9zaXRpb24iLCAiYWJzb2x1dGUiKQoJCQkuc3R5bGUoInRvcCIsIDApOwoKCQl0aGlzLl9yZW5kZXJEaW1taW5nKCk7CgkJdGhpcy5fcmVuZGVyRnJhbWUoKTsKCQl0aGlzLl9yZW5kZXJHcmlwcGVycygpOwoJCXRoaXMuX3JlbmRlckhhbmRsZXMoKTsKCQl0aGlzLl9yZW5kZXJNaWRkbGUoKTsKCgkJdGhpcy5fcmVnaXN0ZXJNb3VzZUV2ZW50cygpOwoJfSwKCglfcmVuZGVyRGltbWluZzogZnVuY3Rpb24oKSB7CgoJCXZhciBlbGVtZW50ID0gdGhpcy5zdmcKCQkJLnNlbGVjdEFsbCgicGF0aC5kaW1taW5nIikKCQkJLmRhdGEoW251bGxdKTsKCgkJZWxlbWVudC5lbnRlcigpCgkJCS5hcHBlbmQoInBhdGgiKQoJCQkuYXR0cigiZmlsbCIsICJ3aGl0ZSIpCgkJCS5hdHRyKCJmaWxsLW9wYWNpdHkiLCAiMC43IikKCQkJLmF0dHIoImZpbGwtcnVsZSIsICJldmVub2RkIikKCQkJLmNsYXNzZWQoImRpbW1pbmciLCB0cnVlKTsKCgkJdmFyIHBhdGggPSAiIjsKCQlwYXRoICs9ICIgTSAiICsgdGhpcy5jb25maWcuZnJhbWVIYW5kbGVUaGlja25lc3MgKyAiICIgKyB0aGlzLmNvbmZpZy5mcmFtZVRvcFRoaWNrbmVzczsKCQlwYXRoICs9ICIgaCAiICsgdGhpcy5wcmV2aWV3V2lkdGg7CgkJcGF0aCArPSAiIHYgIiArIHRoaXMucHJldmlld0hlaWdodDsKCQlwYXRoICs9ICIgaCAiICsgLXRoaXMucHJldmlld1dpZHRoOwoJCXBhdGggKz0gIiB6ICI7CgkJcGF0aCArPSAiIE0gIiArIE1hdGgubWF4KHRoaXMuY3VycmVudEZyYW1lWzBdLCB0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcykgKyAiICIgKyB0aGlzLmNvbmZpZy5mcmFtZVRvcFRoaWNrbmVzczsKCQlwYXRoICs9ICIgSCAiICsgTWF0aC5taW4odGhpcy5jdXJyZW50RnJhbWVbMV0gKyB0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcyAqIDIsIHRoaXMucHJldmlld1dpZHRoICsgdGhpcy5jb25maWcuZnJhbWVIYW5kbGVUaGlja25lc3MpOwoJCXBhdGggKz0gIiB2ICIgKyB0aGlzLnByZXZpZXdIZWlnaHQ7CgkJcGF0aCArPSAiIEggIiArIE1hdGgubWF4KHRoaXMuY3VycmVudEZyYW1lWzBdLCB0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcyk7CgkJcGF0aCArPSAiIHoiOwoKCQllbGVtZW50LmF0dHIoImQiLCBwYXRoKTsKCX0sCgoJX3JlbmRlckZyYW1lOiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsZW1lbnQgPSB0aGlzLnN2ZwoJCQkuc2VsZWN0QWxsKCJwYXRoLmZyYW1lIikKCQkJLmRhdGEoW251bGxdKTsKCgkJZWxlbWVudC5lbnRlcigpCgkJCS5hcHBlbmQoInBhdGgiKQoJCQkuYXR0cigic3Ryb2tlIiwgIndoaXRlIikKCQkJLmF0dHIoInN0cm9rZS13aWR0aCIsICIxcHgiKQoJCQkuYXR0cigic3Ryb2tlLWxpbmVqb2luIiwgInJvdW5kIikKCQkJLmF0dHIoImZpbGwiLCB0aGlzLmNvbmZpZy5mcmFtZUNvbG9yKQoJCQkuYXR0cigiZmlsbC1vcGFjaXR5IiwgdGhpcy5jb25maWcuZnJhbWVPcGFjaXR5KQoJCQkuYXR0cigiZmlsbC1ydWxlIiwgImV2ZW5vZGQiKQoJCQkuY2xhc3NlZCgiZnJhbWUiLCB0cnVlKTsKCgkJdmFyIHBhdGggPSAiIjsKCQlwYXRoICs9ICIgTSAiICsgdGhpcy5jdXJyZW50RnJhbWVbMF0gKyAiIDAiOwoJCXBhdGggKz0gIiBIICIgKyAodGhpcy5jdXJyZW50RnJhbWVbMV0gKyAodGhpcy5jb25maWcuZnJhbWVIYW5kbGVUaGlja25lc3MgKiAyKSk7CgkJcGF0aCArPSAiIFYgIiArIHRoaXMuY29uZmlnLmhlaWdodDsKCQlwYXRoICs9ICIgSCAiICsgKHRoaXMuY3VycmVudEZyYW1lWzBdKTsKCQlwYXRoICs9ICIgeiI7CgkJcGF0aCArPSAiIE0gIiArICh0aGlzLmN1cnJlbnRGcmFtZVswXSArIHRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzKSArICIgIiArIHRoaXMuY29uZmlnLmZyYW1lVG9wVGhpY2tuZXNzOwoJCXBhdGggKz0gIiBIICIgKyAodGhpcy5jdXJyZW50RnJhbWVbMV0gKyB0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcyk7CgkJcGF0aCArPSAiIHYgIiArIHRoaXMucHJldmlld0hlaWdodDsKCQlwYXRoICs9ICIgSCAiICsgKHRoaXMuY3VycmVudEZyYW1lWzBdICsgdGhpcy5jb25maWcuZnJhbWVIYW5kbGVUaGlja25lc3MpOwoJCXBhdGggKz0gIiB6IjsKCgkJZWxlbWVudC5hdHRyKCJkIiwgcGF0aCk7Cgl9LAoKCV9yZW5kZXJHcmlwcGVyczogZnVuY3Rpb24oKSB7CgoJCXZhciBncmlwcGVyID0gdGhpcy5zdmcuc2VsZWN0QWxsKCJwYXRoLmdyaXBwZXIiKQoJCQkuZGF0YShbbnVsbF0pOwoKCQlncmlwcGVyLmVudGVyKCkKCQkJLmFwcGVuZCgicGF0aCIpCgkJCS5hdHRyKCJzdHJva2UiLCB0aGlzLmNvbmZpZy5ncmlwcGVyQ29sb3IpCgkJCS5jbGFzc2VkKCJncmlwcGVyIiwgdHJ1ZSk7CgoJCXZhciBwYXRoID0gIiI7CgoJCVswLjQsIDAuNl0uZm9yRWFjaChmdW5jdGlvbihzcGFjaW5nKSB7CgkJCXBhdGggKz0gIiBNICIgKyBNYXRoLnJvdW5kKCh0aGlzLmN1cnJlbnRGcmFtZVswXSArICh0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcyAqIHNwYWNpbmcpKSkgKyAiICIgKyBNYXRoLnJvdW5kKHRoaXMuY29uZmlnLmhlaWdodCAqIDAuMyk7CgkJCXBhdGggKz0gIiBWICIgKyBNYXRoLnJvdW5kKHRoaXMuY29uZmlnLmhlaWdodCAqIDAuNyk7CgkJCXBhdGggKz0gIiBNICIgKyBNYXRoLnJvdW5kKCh0aGlzLmN1cnJlbnRGcmFtZVsxXSArICh0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcyAqICgxICsgc3BhY2luZykpKSkgKyAiICIgKyBNYXRoLnJvdW5kKHRoaXMuY29uZmlnLmhlaWdodCAqIDAuMyk7CgkJCXBhdGggKz0gIiBWICIgKyBNYXRoLnJvdW5kKHRoaXMuY29uZmlnLmhlaWdodCAqIDAuNyk7CgkJfS5iaW5kKHRoaXMpKTsKCgkJZ3JpcHBlci5hdHRyKCJkIiwgcGF0aCk7Cgl9LAoKCV9yZW5kZXJIYW5kbGVzOiBmdW5jdGlvbigpIHsKCgkJdmFyIGxlZnRIYW5kbGUgPSB0aGlzLnN2Zy5zZWxlY3RBbGwoInJlY3QubGVmdF9oYW5kbGUiKQoJCQkuZGF0YShbbnVsbF0pOwoKCQlsZWZ0SGFuZGxlLmVudGVyKCkKCQkJLmFwcGVuZCgicmVjdCIpCgkJCS5hdHRyKCd3aWR0aCcsIHRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzKQoJCQkuc3R5bGUoImN1cnNvciIsICJldy1yZXNpemUiKQoJCQkuc3R5bGUoImZpbGwtb3BhY2l0eSIsICIwIikKCQkJLmNsYXNzZWQoImxlZnRfaGFuZGxlIiwgdHJ1ZSk7CgoJCWxlZnRIYW5kbGUKCQkJLmF0dHIoJ3gnLCB0aGlzLmN1cnJlbnRGcmFtZVswXSkKCQkJLmF0dHIoJ2hlaWdodCcsIHRoaXMuY29uZmlnLmhlaWdodCk7CgoJCXZhciByaWdodEhhbmRsZSA9IHRoaXMuc3ZnLnNlbGVjdEFsbCgicmVjdC5yaWdodF9oYW5kbGUiKQoJCQkuZGF0YShbbnVsbF0pOwoKCQlyaWdodEhhbmRsZS5lbnRlcigpCgkJCS5hcHBlbmQoInJlY3QiKQoJCQkuYXR0cignd2lkdGgnLCB0aGlzLmNvbmZpZy5mcmFtZUhhbmRsZVRoaWNrbmVzcykKCQkJLnN0eWxlKCJjdXJzb3IiLCAiZXctcmVzaXplIikKCQkJLnN0eWxlKCJmaWxsLW9wYWNpdHkiLCAiMCIpCgkJCS5jbGFzc2VkKCJyaWdodF9oYW5kbGUiLCB0cnVlKTsKCgkJcmlnaHRIYW5kbGUKCQkJLmF0dHIoJ3gnLCB0aGlzLmN1cnJlbnRGcmFtZVsxXSArIHRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzKQoJCQkuYXR0cignaGVpZ2h0JywgdGhpcy5jb25maWcuaGVpZ2h0KTsKCX0sCgoJX3JlbmRlck1pZGRsZTogZnVuY3Rpb24oKSB7CgoJCXZhciBtaWRkbGVIYW5kbGUgPSB0aGlzLnN2Zy5zZWxlY3RBbGwoInJlY3QubWlkZGxlX2hhbmRsZSIpCgkJCS5kYXRhKFtudWxsXSk7CgoJCW1pZGRsZUhhbmRsZS5lbnRlcigpCgkJCS5hcHBlbmQoInJlY3QiKQoJCQkuc3R5bGUoImN1cnNvciIsICJtb3ZlIikKCQkJLnN0eWxlKCJmaWxsLW9wYWNpdHkiLCAiMCIpCgkJCS5jbGFzc2VkKCJtaWRkbGVfaGFuZGxlIiwgdHJ1ZSk7CgoJCW1pZGRsZUhhbmRsZQoJCQkuYXR0cignd2lkdGgnLCBNYXRoLm1heCgwLCB0aGlzLmN1cnJlbnRGcmFtZVsxXSAtIHRoaXMuY3VycmVudEZyYW1lWzBdKSkKCQkJLmF0dHIoJ3gnLCB0aGlzLmN1cnJlbnRGcmFtZVswXSArIHRoaXMuY29uZmlnLmZyYW1lSGFuZGxlVGhpY2tuZXNzKQoJCQkuYXR0cignaGVpZ2h0JywgdGhpcy5jb25maWcuaGVpZ2h0KTsKCX0sCgoJX3JlZ2lzdGVyTW91c2VFdmVudHM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbWVudCA9IGQzLnNlbGVjdCh0aGlzLmVsZW1lbnQpOwoKCQl2YXIgZHJhZyA9IHsKCQkJdGFyZ2V0OiBudWxsLAoJCQlzdGFydDogbnVsbCwKCQkJc3RvcDogbnVsbCwKCQkJbGVmdDogZmFsc2UsCgkJCXJpZ2h0OiBmYWxzZSwKCQkJcmlnaWQ6IGZhbHNlCgkJfTsKCgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlmdW5jdGlvbiBvbk1vdXNlbW92ZShkYXR1bSwgaW5kZXgpIHsKCgkJCWRyYWcuc3RvcCA9IHNlbGYuX2dldENsaWVudFhGcm9tRXZlbnQoZDMuZXZlbnQsIGRyYWcpOwoJCQl2YXIgZGlzdGFuY2VUcmF2ZWxlZCA9IGRyYWcuc3RvcCAtIGRyYWcuc3RhcnQ7CgkJCXZhciBmcmFtZUFmdGVyRHJhZyA9IHNlbGYuZnJhbWVCZWZvcmVEcmFnLnNsaWNlKDApOwoJCQl2YXIgbWluaW11bUZyYW1lV2lkdGggPSBzZWxmLmNvbmZpZy5taW5pbXVtRnJhbWVXaWR0aDsKCgkJCWlmIChkcmFnLnJpZ2lkKSB7CgkJCQltaW5pbXVtRnJhbWVXaWR0aCA9IHNlbGYuZnJhbWVCZWZvcmVEcmFnWzFdIC0gc2VsZi5mcmFtZUJlZm9yZURyYWdbMF07CgkJCX0KCQkJaWYgKGRyYWcubGVmdCkgewoJCQkJZnJhbWVBZnRlckRyYWdbMF0gPSBNYXRoLm1heChmcmFtZUFmdGVyRHJhZ1swXSArIGRpc3RhbmNlVHJhdmVsZWQsIDApOwoJCQl9CgkJCWlmIChkcmFnLnJpZ2h0KSB7CgkJCQlmcmFtZUFmdGVyRHJhZ1sxXSA9IE1hdGgubWluKGZyYW1lQWZ0ZXJEcmFnWzFdICsgZGlzdGFuY2VUcmF2ZWxlZCwgc2VsZi5wcmV2aWV3V2lkdGgpOwoJCQl9CgoJCQl2YXIgY3VycmVudEZyYW1lV2lkdGggPSBmcmFtZUFmdGVyRHJhZ1sxXSAtIGZyYW1lQWZ0ZXJEcmFnWzBdOwoKCQkJaWYgKGN1cnJlbnRGcmFtZVdpZHRoIDw9IG1pbmltdW1GcmFtZVdpZHRoKSB7CgoJCQkJaWYgKGRyYWcubGVmdCkgewoJCQkJCWZyYW1lQWZ0ZXJEcmFnWzBdID0gZnJhbWVBZnRlckRyYWdbMV0gLSBtaW5pbXVtRnJhbWVXaWR0aDsKCQkJCX0KCQkJCWlmIChkcmFnLnJpZ2h0KSB7CgkJCQkJZnJhbWVBZnRlckRyYWdbMV0gPSBmcmFtZUFmdGVyRHJhZ1swXSArIG1pbmltdW1GcmFtZVdpZHRoOwoJCQkJfQoJCQkJaWYgKGZyYW1lQWZ0ZXJEcmFnWzBdIDw9IDApIHsKCQkJCQlmcmFtZUFmdGVyRHJhZ1sxXSAtPSBmcmFtZUFmdGVyRHJhZ1swXTsKCQkJCQlmcmFtZUFmdGVyRHJhZ1swXSA9IDA7CgkJCQl9CgkJCQlpZiAoZnJhbWVBZnRlckRyYWdbMV0gPj0gc2VsZi5wcmV2aWV3V2lkdGgpIHsKCQkJCQlmcmFtZUFmdGVyRHJhZ1swXSAtPSAoZnJhbWVBZnRlckRyYWdbMV0gLSBzZWxmLnByZXZpZXdXaWR0aCk7CgkJCQkJZnJhbWVBZnRlckRyYWdbMV0gPSBzZWxmLnByZXZpZXdXaWR0aDsKCQkJCX0KCQkJfQoKCQkJc2VsZi5ncmFwaHMuZm9yRWFjaChmdW5jdGlvbihncmFwaCkgewoKCQkJCXZhciBkb21haW5TY2FsZSA9IGQzLnNjYWxlLmxpbmVhcigpCgkJCQkJLmludGVycG9sYXRlKGQzLmludGVycG9sYXRlTnVtYmVyKQoJCQkJCS5kb21haW4oWzAsIHNlbGYucHJldmlld1dpZHRoXSkKCQkJCQkucmFuZ2UoZ3JhcGguZGF0YURvbWFpbigpKTsKCgkJCQl2YXIgd2luZG93QWZ0ZXJEcmFnID0gWwoJCQkJCWRvbWFpblNjYWxlKGZyYW1lQWZ0ZXJEcmFnWzBdKSwKCQkJCQlkb21haW5TY2FsZShmcmFtZUFmdGVyRHJhZ1sxXSkKCQkJCV07CgoJCQkJc2VsZi5zbGlkZUNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJCQkJY2FsbGJhY2soZ3JhcGgsIHdpbmRvd0FmdGVyRHJhZ1swXSwgd2luZG93QWZ0ZXJEcmFnWzFdKTsKCQkJCX0pOwoKCQkJCWlmIChmcmFtZUFmdGVyRHJhZ1swXSA9PT0gMCkgewoJCQkJCXdpbmRvd0FmdGVyRHJhZ1swXSA9IHVuZGVmaW5lZDsKCQkJCX0KCQkJCWlmIChmcmFtZUFmdGVyRHJhZ1sxXSA9PT0gc2VsZi5wcmV2aWV3V2lkdGgpIHsKCQkJCQl3aW5kb3dBZnRlckRyYWdbMV0gPSB1bmRlZmluZWQ7CgkJCQl9CgkJCQlncmFwaC53aW5kb3cueE1pbiA9IHdpbmRvd0FmdGVyRHJhZ1swXTsKCQkJCWdyYXBoLndpbmRvdy54TWF4ID0gd2luZG93QWZ0ZXJEcmFnWzFdOwoKCQkJCWdyYXBoLnVwZGF0ZSgpOwoJCQl9KTsKCQl9CgoJCWZ1bmN0aW9uIG9uTW91c2Vkb3duKCkgewoJCQlkcmFnLnRhcmdldCA9IGQzLmV2ZW50LnRhcmdldDsKCQkJZHJhZy5zdGFydCA9IHNlbGYuX2dldENsaWVudFhGcm9tRXZlbnQoZDMuZXZlbnQsIGRyYWcpOwoJCQlzZWxmLmZyYW1lQmVmb3JlRHJhZyA9IHNlbGYuY3VycmVudEZyYW1lLnNsaWNlKCk7CgkJCWQzLmV2ZW50LnByZXZlbnREZWZhdWx0ID8gZDMuZXZlbnQucHJldmVudERlZmF1bHQoKSA6IGQzLmV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkJCWQzLnNlbGVjdChkb2N1bWVudCkub24oIm1vdXNlbW92ZS5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG9uTW91c2Vtb3ZlKTsKCQkJZDMuc2VsZWN0KGRvY3VtZW50KS5vbigibW91c2V1cC5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG9uTW91c2V1cCk7CgkJCWQzLnNlbGVjdChkb2N1bWVudCkub24oInRvdWNobW92ZS5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG9uTW91c2Vtb3ZlKTsKCQkJZDMuc2VsZWN0KGRvY3VtZW50KS5vbigidG91Y2hlbmQucmlja3NoYXdfcmFuZ2Vfc2xpZGVyX3ByZXZpZXciLCBvbk1vdXNldXApOwoJCQlkMy5zZWxlY3QoZG9jdW1lbnQpLm9uKCJ0b3VjaGNhbmNlbC5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG9uTW91c2V1cCk7CgkJfQoKCQlmdW5jdGlvbiBvbk1vdXNlZG93bkxlZnRIYW5kbGUoZGF0dW0sIGluZGV4KSB7CgkJCWRyYWcubGVmdCA9IHRydWU7CgkJCW9uTW91c2Vkb3duKCk7CgkJfQoKCQlmdW5jdGlvbiBvbk1vdXNlZG93blJpZ2h0SGFuZGxlKGRhdHVtLCBpbmRleCkgewoJCQlkcmFnLnJpZ2h0ID0gdHJ1ZTsKCQkJb25Nb3VzZWRvd24oKTsKCQl9CgoJCWZ1bmN0aW9uIG9uTW91c2Vkb3duTWlkZGxlSGFuZGxlKGRhdHVtLCBpbmRleCkgewoJCQlkcmFnLmxlZnQgPSB0cnVlOwoJCQlkcmFnLnJpZ2h0ID0gdHJ1ZTsKCQkJZHJhZy5yaWdpZCA9IHRydWU7CgkJCW9uTW91c2Vkb3duKCk7CgkJfQoKCQlmdW5jdGlvbiBvbk1vdXNldXAoZGF0dW0sIGluZGV4KSB7CgkJCWQzLnNlbGVjdChkb2N1bWVudCkub24oIm1vdXNlbW92ZS5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG51bGwpOwoJCQlkMy5zZWxlY3QoZG9jdW1lbnQpLm9uKCJtb3VzZXVwLnJpY2tzaGF3X3JhbmdlX3NsaWRlcl9wcmV2aWV3IiwgbnVsbCk7CgkJCWQzLnNlbGVjdChkb2N1bWVudCkub24oInRvdWNobW92ZS5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG51bGwpOwoJCQlkMy5zZWxlY3QoZG9jdW1lbnQpLm9uKCJ0b3VjaGVuZC5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG51bGwpOwoJCQlkMy5zZWxlY3QoZG9jdW1lbnQpLm9uKCJ0b3VjaGNhbmNlbC5yaWNrc2hhd19yYW5nZV9zbGlkZXJfcHJldmlldyIsIG51bGwpOwoJCQlkZWxldGUgc2VsZi5mcmFtZUJlZm9yZURyYWc7CgkJCWRyYWcubGVmdCA9IGZhbHNlOwoJCQlkcmFnLnJpZ2h0ID0gZmFsc2U7CgkJCWRyYWcucmlnaWQgPSBmYWxzZTsKCQl9CgoJCWVsZW1lbnQuc2VsZWN0KCJyZWN0LmxlZnRfaGFuZGxlIikub24oIm1vdXNlZG93biIsIG9uTW91c2Vkb3duTGVmdEhhbmRsZSk7CgkJZWxlbWVudC5zZWxlY3QoInJlY3QucmlnaHRfaGFuZGxlIikub24oIm1vdXNlZG93biIsIG9uTW91c2Vkb3duUmlnaHRIYW5kbGUpOwoJCWVsZW1lbnQuc2VsZWN0KCJyZWN0Lm1pZGRsZV9oYW5kbGUiKS5vbigibW91c2Vkb3duIiwgb25Nb3VzZWRvd25NaWRkbGVIYW5kbGUpOwoJCWVsZW1lbnQuc2VsZWN0KCJyZWN0LmxlZnRfaGFuZGxlIikub24oInRvdWNoc3RhcnQiLCBvbk1vdXNlZG93bkxlZnRIYW5kbGUpOwoJCWVsZW1lbnQuc2VsZWN0KCJyZWN0LnJpZ2h0X2hhbmRsZSIpLm9uKCJ0b3VjaHN0YXJ0Iiwgb25Nb3VzZWRvd25SaWdodEhhbmRsZSk7CgkJZWxlbWVudC5zZWxlY3QoInJlY3QubWlkZGxlX2hhbmRsZSIpLm9uKCJ0b3VjaHN0YXJ0Iiwgb25Nb3VzZWRvd25NaWRkbGVIYW5kbGUpOwoJfSwKCglfZ2V0Q2xpZW50WEZyb21FdmVudDogZnVuY3Rpb24oZXZlbnQsIGRyYWcpIHsKCgkJc3dpdGNoIChldmVudC50eXBlKSB7CgkJCWNhc2UgJ3RvdWNoc3RhcnQnOgoJCQljYXNlICd0b3VjaG1vdmUnOgoJCQkJdmFyIHRvdWNoTGlzdCA9IGV2ZW50LmNoYW5nZWRUb3VjaGVzOwoJCQkJdmFyIHRvdWNoID0gbnVsbDsKCQkJCWZvciAodmFyIHRvdWNoSW5kZXggPSAwOyB0b3VjaEluZGV4IDwgdG91Y2hMaXN0Lmxlbmd0aDsgdG91Y2hJbmRleCsrKSB7CgkJCQkJaWYgKHRvdWNoTGlzdFt0b3VjaEluZGV4XS50YXJnZXQgPT09IGRyYWcudGFyZ2V0KSB7CgkJCQkJCXRvdWNoID0gdG91Y2hMaXN0W3RvdWNoSW5kZXhdOwoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdG91Y2ggIT09IG51bGwgPyB0b3VjaC5jbGllbnRYIDogdW5kZWZpbmVkOwoKCQkJZGVmYXVsdDoKCQkJCXJldHVybiBldmVudC5jbGllbnRYOwoJCX0KCX0KfSk7CgpSaWNrc2hhdy5uYW1lc3BhY2UoIlJpY2tzaGF3LkdyYXBoLlJlbmRlcmVyIik7CgpSaWNrc2hhdy5HcmFwaC5SZW5kZXJlciA9IFJpY2tzaGF3LkNsYXNzLmNyZWF0ZSggewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGFyZ3MpIHsKCQl0aGlzLmdyYXBoID0gYXJncy5ncmFwaDsKCQl0aGlzLnRlbnNpb24gPSBhcmdzLnRlbnNpb24gfHwgdGhpcy50ZW5zaW9uOwoJCXRoaXMuY29uZmlndXJlKGFyZ3MpOwoJfSwKCglzZXJpZXNQYXRoRmFjdG9yeTogZnVuY3Rpb24oKSB7CgkJLy9pbXBsZW1lbnQgaW4gc3ViY2xhc3MKCX0sCgoJc2VyaWVzU3Ryb2tlRmFjdG9yeTogZnVuY3Rpb24oKSB7CgkJLy8gaW1wbGVtZW50IGluIHN1YmNsYXNzCgl9LAoKCWRlZmF1bHRzOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gewoJCQl0ZW5zaW9uOiAwLjgsCgkJCXN0cm9rZVdpZHRoOiAyLAoJCQl1bnN0YWNrOiB0cnVlLAoJCQlwYWRkaW5nOiB7IHRvcDogMC4wMSwgcmlnaHQ6IDAsIGJvdHRvbTogMC4wMSwgbGVmdDogMCB9LAoJCQlzdHJva2U6IGZhbHNlLAoJCQlmaWxsOiBmYWxzZQoJCX07Cgl9LAoKCWRvbWFpbjogZnVuY3Rpb24oZGF0YSkgewoJCS8vIFJlcXVpcmVzIHRoYXQgYXQgbGVhc3Qgb25lIHNlcmllcyBjb250YWlucyBzb21lIGRhdGEKCQl2YXIgc3RhY2tlZERhdGEgPSBkYXRhIHx8IHRoaXMuZ3JhcGguc3RhY2tlZERhdGEgfHwgdGhpcy5ncmFwaC5zdGFja0RhdGEoKTsKCgkJdmFyIHhNaW4gPSArSW5maW5pdHk7CgkJdmFyIHhNYXggPSAtSW5maW5pdHk7CgoJCXZhciB5TWluID0gK0luZmluaXR5OwoJCXZhciB5TWF4ID0gLUluZmluaXR5OwoKCQlzdGFja2VkRGF0YS5mb3JFYWNoKCBmdW5jdGlvbihzZXJpZXMpIHsKCgkJCXNlcmllcy5mb3JFYWNoKCBmdW5jdGlvbihkKSB7CgoJCQkJaWYgKGQueSA9PSBudWxsKSByZXR1cm47CgoJCQkJdmFyIHkgPSBkLnkgKyBkLnkwOwoKCQkJCWlmICh5IDwgeU1pbikgeU1pbiA9IHk7CgkJCQlpZiAoeSA+IHlNYXgpIHlNYXggPSB5OwoJCQl9ICk7CgoJCQlpZiAoIXNlcmllcy5sZW5ndGgpIHJldHVybjsKCgkJCWlmIChzZXJpZXNbMF0ueCA8IHhNaW4pIHhNaW4gPSBzZXJpZXNbMF0ueDsKCQkJaWYgKHNlcmllc1tzZXJpZXMubGVuZ3RoIC0gMV0ueCA+IHhNYXgpIHhNYXggPSBzZXJpZXNbc2VyaWVzLmxlbmd0aCAtIDFdLng7CgkJfSApOwoKCQl4TWluIC09ICh4TWF4IC0geE1pbikgKiB0aGlzLnBhZGRpbmcubGVmdDsKCQl4TWF4ICs9ICh4TWF4IC0geE1pbikgKiB0aGlzLnBhZGRpbmcucmlnaHQ7CgoJCXlNaW4gPSB0aGlzLmdyYXBoLm1pbiA9PT0gJ2F1dG8nID8geU1pbiA6IHRoaXMuZ3JhcGgubWluIHx8IDA7CgkJeU1heCA9IHRoaXMuZ3JhcGgubWF4ID09PSB1bmRlZmluZWQgPyB5TWF4IDogdGhpcy5ncmFwaC5tYXg7CgoJCWlmICh0aGlzLmdyYXBoLm1pbiA9PT0gJ2F1dG8nIHx8IHlNaW4gPCAwKSB7CgkJCXlNaW4gLT0gKHlNYXggLSB5TWluKSAqIHRoaXMucGFkZGluZy5ib3R0b207CgkJfQoKCQlpZiAodGhpcy5ncmFwaC5tYXggPT09IHVuZGVmaW5lZCkgewoJCQl5TWF4ICs9ICh5TWF4IC0geU1pbikgKiB0aGlzLnBhZGRpbmcudG9wOwoJCX0KCgkJcmV0dXJuIHsgeDogW3hNaW4sIHhNYXhdLCB5OiBbeU1pbiwgeU1heF0gfTsKCX0sCgoJcmVuZGVyOiBmdW5jdGlvbihhcmdzKSB7CgoJCWFyZ3MgPSBhcmdzIHx8IHt9OwoKCQl2YXIgZ3JhcGggPSB0aGlzLmdyYXBoOwoJCXZhciBzZXJpZXMgPSBhcmdzLnNlcmllcyB8fCBncmFwaC5zZXJpZXM7CgoJCXZhciB2aXMgPSBhcmdzLnZpcyB8fCBncmFwaC52aXM7CgkJdmlzLnNlbGVjdEFsbCgnKicpLnJlbW92ZSgpOwoKCQl2YXIgZGF0YSA9IHNlcmllcwoJCQkuZmlsdGVyKGZ1bmN0aW9uKHMpIHsgcmV0dXJuICFzLmRpc2FibGVkIH0pCgkJCS5tYXAoZnVuY3Rpb24ocykgeyByZXR1cm4gcy5zdGFjayB9KTsKCgkJdmFyIHBhdGhOb2RlcyA9IHZpcy5zZWxlY3RBbGwoInBhdGgucGF0aCIpCgkJCS5kYXRhKGRhdGEpCgkJCS5lbnRlcigpLmFwcGVuZCgic3ZnOnBhdGgiKQoJCQkuY2xhc3NlZCgncGF0aCcsIHRydWUpCgkJCS5hdHRyKCJkIiwgdGhpcy5zZXJpZXNQYXRoRmFjdG9yeSgpKTsKCgkJaWYgKHRoaXMuc3Ryb2tlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHJva2VOb2RlcyA9IHZpcy5zZWxlY3RBbGwoJ3BhdGguc3Ryb2tlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZGF0YShkYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5lbnRlcigpLmFwcGVuZCgic3ZnOnBhdGgiKQoJCQkJLmNsYXNzZWQoJ3N0cm9rZScsIHRydWUpCgkJCQkuYXR0cigiZCIsIHRoaXMuc2VyaWVzU3Ryb2tlRmFjdG9yeSgpKTsKCQl9CgoJCXZhciBpID0gMDsKCQlzZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24oc2VyaWVzKSB7CgkJCWlmIChzZXJpZXMuZGlzYWJsZWQpIHJldHVybjsKCQkJc2VyaWVzLnBhdGggPSBwYXRoTm9kZXNbMF1baV07CgkJCWlmICh0aGlzLnN0cm9rZSkgc2VyaWVzLnN0cm9rZSA9IHN0cm9rZU5vZGVzWzBdW2ldOwoJCQl0aGlzLl9zdHlsZVNlcmllcyhzZXJpZXMpOwoJCQlpKys7CgkJfSwgdGhpcyApOwoKCX0sCgoJX3N0eWxlU2VyaWVzOiBmdW5jdGlvbihzZXJpZXMpIHsKCgkJdmFyIGZpbGwgPSB0aGlzLmZpbGwgPyBzZXJpZXMuY29sb3IgOiAnbm9uZSc7CgkJdmFyIHN0cm9rZSA9IHRoaXMuc3Ryb2tlID8gc2VyaWVzLmNvbG9yIDogJ25vbmUnOwoKCQlzZXJpZXMucGF0aC5zZXRBdHRyaWJ1dGUoJ2ZpbGwnLCBmaWxsKTsKCQlzZXJpZXMucGF0aC5zZXRBdHRyaWJ1dGUoJ3N0cm9rZScsIHN0cm9rZSk7CgkJc2VyaWVzLnBhdGguc2V0QXR0cmlidXRlKCdzdHJva2Utd2lkdGgnLCB0aGlzLnN0cm9rZVdpZHRoKTsKCgkJaWYgKHNlcmllcy5jbGFzc05hbWUpIHsKCQkJZDMuc2VsZWN0KHNlcmllcy5wYXRoKS5jbGFzc2VkKHNlcmllcy5jbGFzc05hbWUsIHRydWUpOwoJCX0KCQlpZiAoc2VyaWVzLmNsYXNzTmFtZSAmJiB0aGlzLnN0cm9rZSkgewoJCQlkMy5zZWxlY3Qoc2VyaWVzLnN0cm9rZSkuY2xhc3NlZChzZXJpZXMuY2xhc3NOYW1lLCB0cnVlKTsKCQl9Cgl9LAoKCWNvbmZpZ3VyZTogZnVuY3Rpb24oYXJncykgewoKCQlhcmdzID0gYXJncyB8fCB7fTsKCgkJUmlja3NoYXcua2V5cyh0aGlzLmRlZmF1bHRzKCkpLmZvckVhY2goIGZ1bmN0aW9uKGtleSkgewoKCQkJaWYgKCFhcmdzLmhhc093blByb3BlcnR5KGtleSkpIHsKCQkJCXRoaXNba2V5XSA9IHRoaXNba2V5XSB8fCB0aGlzLmdyYXBoW2tleV0gfHwgdGhpcy5kZWZhdWx0cygpW2tleV07CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICh0eXBlb2YgdGhpcy5kZWZhdWx0cygpW2tleV0gPT0gJ29iamVjdCcpIHsKCgkJCQlSaWNrc2hhdy5rZXlzKHRoaXMuZGVmYXVsdHMoKVtrZXldKS5mb3JFYWNoKCBmdW5jdGlvbihrKSB7CgoJCQkJCXRoaXNba2V5XVtrXSA9CgkJCQkJCWFyZ3Nba2V5XVtrXSAhPT0gdW5kZWZpbmVkID8gYXJnc1trZXldW2tdIDoKCQkJCQkJdGhpc1trZXldW2tdICE9PSB1bmRlZmluZWQgPyB0aGlzW2tleV1ba10gOgoJCQkJCQl0aGlzLmRlZmF1bHRzKClba2V5XVtrXTsKCQkJCX0sIHRoaXMgKTsKCgkJCX0gZWxzZSB7CgkJCQl0aGlzW2tleV0gPQoJCQkJCWFyZ3Nba2V5XSAhPT0gdW5kZWZpbmVkID8gYXJnc1trZXldIDoKCQkJCQl0aGlzW2tleV0gIT09IHVuZGVmaW5lZCA\/IHRoaXNba2V5XSA6CgkJCQkJdGhpcy5ncmFwaFtrZXldICE9PSB1bmRlZmluZWQgPyB0aGlzLmdyYXBoW2tleV0gOgoJCQkJCXRoaXMuZGVmYXVsdHMoKVtrZXldOwoJCQl9CgoJCX0sIHRoaXMgKTsKCX0sCgoJc2V0U3Ryb2tlV2lkdGg6IGZ1bmN0aW9uKHN0cm9rZVdpZHRoKSB7CgkJaWYgKHN0cm9rZVdpZHRoICE9PSB1bmRlZmluZWQpIHsKCQkJdGhpcy5zdHJva2VXaWR0aCA9IHN0cm9rZVdpZHRoOwoJCX0KCX0sCgoJc2V0VGVuc2lvbjogZnVuY3Rpb24odGVuc2lvbikgewoJCWlmICh0ZW5zaW9uICE9PSB1bmRlZmluZWQpIHsKCQkJdGhpcy50ZW5zaW9uID0gdGVuc2lvbjsKCQl9Cgl9Cn0gKTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguUmVuZGVyZXIuTGluZScpOwoKUmlja3NoYXcuR3JhcGguUmVuZGVyZXIuTGluZSA9IFJpY2tzaGF3LkNsYXNzLmNyZWF0ZSggUmlja3NoYXcuR3JhcGguUmVuZGVyZXIsIHsKCgluYW1lOiAnbGluZScsCgoJZGVmYXVsdHM6IGZ1bmN0aW9uKCRzdXBlcikgewoKCQlyZXR1cm4gUmlja3NoYXcuZXh0ZW5kKCAkc3VwZXIoKSwgewoJCQl1bnN0YWNrOiB0cnVlLAoJCQlmaWxsOiBmYWxzZSwKCQkJc3Ryb2tlOiB0cnVlCgkJfSApOwoJfSwKCglzZXJpZXNQYXRoRmFjdG9yeTogZnVuY3Rpb24oKSB7CgoJCXZhciBncmFwaCA9IHRoaXMuZ3JhcGg7CgoJCXZhciBmYWN0b3J5ID0gZDMuc3ZnLmxpbmUoKQoJCQkueCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueChkLngpIH0gKQoJCQkueSggZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueShkLnkpIH0gKQoJCQkuaW50ZXJwb2xhdGUodGhpcy5ncmFwaC5pbnRlcnBvbGF0aW9uKS50ZW5zaW9uKHRoaXMudGVuc2lvbik7CgoJCWZhY3RvcnkuZGVmaW5lZCAmJiBmYWN0b3J5LmRlZmluZWQoIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQueSAhPT0gbnVsbCB9ICk7CgkJcmV0dXJuIGZhY3Rvcnk7Cgl9Cn0gKTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguUmVuZGVyZXIuU3RhY2snKTsKClJpY2tzaGF3LkdyYXBoLlJlbmRlcmVyLlN0YWNrID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCBSaWNrc2hhdy5HcmFwaC5SZW5kZXJlciwgewoKCW5hbWU6ICdzdGFjaycsCgoJZGVmYXVsdHM6IGZ1bmN0aW9uKCRzdXBlcikgewoKCQlyZXR1cm4gUmlja3NoYXcuZXh0ZW5kKCAkc3VwZXIoKSwgewoJCQlmaWxsOiB0cnVlLAoJCQlzdHJva2U6IGZhbHNlLAoJCQl1bnN0YWNrOiBmYWxzZQoJCX0gKTsKCX0sCgoJc2VyaWVzUGF0aEZhY3Rvcnk6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZ3JhcGggPSB0aGlzLmdyYXBoOwoKCQl2YXIgZmFjdG9yeSA9IGQzLnN2Zy5hcmVhKCkKCQkJLngoIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGdyYXBoLngoZC54KSB9ICkKCQkJLnkwKCBmdW5jdGlvbihkKSB7IHJldHVybiBncmFwaC55KGQueTApIH0gKQoJCQkueTEoIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGdyYXBoLnkoZC55ICsgZC55MCkgfSApCgkJCS5pbnRlcnBvbGF0ZSh0aGlzLmdyYXBoLmludGVycG9sYXRpb24pLnRlbnNpb24odGhpcy50ZW5zaW9uKTsKCgkJZmFjdG9yeS5kZWZpbmVkICYmIGZhY3RvcnkuZGVmaW5lZCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZC55ICE9PSBudWxsIH0gKTsKCQlyZXR1cm4gZmFjdG9yeTsKCX0KfSApOwoKUmlja3NoYXcubmFtZXNwYWNlKCdSaWNrc2hhdy5HcmFwaC5SZW5kZXJlci5CYXInKTsKClJpY2tzaGF3LkdyYXBoLlJlbmRlcmVyLkJhciA9IFJpY2tzaGF3LkNsYXNzLmNyZWF0ZSggUmlja3NoYXcuR3JhcGguUmVuZGVyZXIsIHsKCgluYW1lOiAnYmFyJywKCglkZWZhdWx0czogZnVuY3Rpb24oJHN1cGVyKSB7CgoJCXZhciBkZWZhdWx0cyA9IFJpY2tzaGF3LmV4dGVuZCggJHN1cGVyKCksIHsKCQkJZ2FwU2l6ZTogMC4wNSwKCQkJdW5zdGFjazogZmFsc2UKCQl9ICk7CgoJCWRlbGV0ZSBkZWZhdWx0cy50ZW5zaW9uOwoJCXJldHVybiBkZWZhdWx0czsKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oJHN1cGVyLCBhcmdzKSB7CgkJYXJncyA9IGFyZ3MgfHwge307CgkJdGhpcy5nYXBTaXplID0gYXJncy5nYXBTaXplIHx8IHRoaXMuZ2FwU2l6ZTsKCQkkc3VwZXIoYXJncyk7Cgl9LAoKCWRvbWFpbjogZnVuY3Rpb24oJHN1cGVyKSB7CgoJCXZhciBkb21haW4gPSAkc3VwZXIoKTsKCgkJdmFyIGZyZXF1ZW50SW50ZXJ2YWwgPSB0aGlzLl9mcmVxdWVudEludGVydmFsKHRoaXMuZ3JhcGguc3RhY2tlZERhdGEuc2xpY2UoLTEpLnNoaWZ0KCkpOwoJCWRvbWFpbi54WzFdICs9IE51bWJlcihmcmVxdWVudEludGVydmFsLm1hZ25pdHVkZSk7CgoJCXJldHVybiBkb21haW47Cgl9LAoKCWJhcldpZHRoOiBmdW5jdGlvbihzZXJpZXMpIHsKCgkJdmFyIGZyZXF1ZW50SW50ZXJ2YWwgPSB0aGlzLl9mcmVxdWVudEludGVydmFsKHNlcmllcy5zdGFjayk7CgkJdmFyIGJhcldpZHRoID0gdGhpcy5ncmFwaC54Lm1hZ25pdHVkZShmcmVxdWVudEludGVydmFsLm1hZ25pdHVkZSkgKiAoMSAtIHRoaXMuZ2FwU2l6ZSk7CgoJCXJldHVybiBiYXJXaWR0aDsKCX0sCgoJcmVuZGVyOiBmdW5jdGlvbihhcmdzKSB7CgoJCWFyZ3MgPSBhcmdzIHx8IHt9OwoKCQl2YXIgZ3JhcGggPSB0aGlzLmdyYXBoOwoJCXZhciBzZXJpZXMgPSBhcmdzLnNlcmllcyB8fCBncmFwaC5zZXJpZXM7CgoJCXZhciB2aXMgPSBhcmdzLnZpcyB8fCBncmFwaC52aXM7CgkJdmlzLnNlbGVjdEFsbCgnKicpLnJlbW92ZSgpOwoKCQl2YXIgYmFyV2lkdGggPSB0aGlzLmJhcldpZHRoKHNlcmllcy5hY3RpdmUoKVswXSk7CgkJdmFyIGJhclhPZmZzZXQgPSAwOwoKCQl2YXIgYWN0aXZlU2VyaWVzQ291bnQgPSBzZXJpZXMuZmlsdGVyKCBmdW5jdGlvbihzKSB7IHJldHVybiAhcy5kaXNhYmxlZDsgfSApLmxlbmd0aDsKCQl2YXIgc2VyaWVzQmFyV2lkdGggPSB0aGlzLnVuc3RhY2sgPyBiYXJXaWR0aCAvIGFjdGl2ZVNlcmllc0NvdW50IDogYmFyV2lkdGg7CgoJCXZhciB0cmFuc2Zvcm0gPSBmdW5jdGlvbihkKSB7CgkJCS8vIGFkZCBhIG1hdHJpeCB0cmFuc2Zvcm0gZm9yIG5lZ2F0aXZlIHZhbHVlcwoJCQl2YXIgbWF0cml4ID0gWyAxLCAwLCAwLCAoZC55IDwgMCA\/IC0xIDogMSksIDAsIChkLnkgPCAwID8gZ3JhcGgueS5tYWduaXR1ZGUoTWF0aC5hYnMoZC55KSkgKiAyIDogMCkgXTsKCQkJcmV0dXJuICJtYXRyaXgoIiArIG1hdHJpeC5qb2luKCcsJykgKyAiKSI7CgkJfTsKCgkJc2VyaWVzLmZvckVhY2goIGZ1bmN0aW9uKHNlcmllcykgewoKCQkJaWYgKHNlcmllcy5kaXNhYmxlZCkgcmV0dXJuOwoKCQkJdmFyIGJhcldpZHRoID0gdGhpcy5iYXJXaWR0aChzZXJpZXMpOwoKCQkJdmFyIG5vZGVzID0gdmlzLnNlbGVjdEFsbCgicGF0aCIpCgkJCQkuZGF0YShzZXJpZXMuc3RhY2suZmlsdGVyKCBmdW5jdGlvbihkKSB7IHJldHVybiBkLnkgIT09IG51bGwgfSApKQoJCQkJLmVudGVyKCkuYXBwZW5kKCJzdmc6cmVjdCIpCgkJCQkuYXR0cigieCIsIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGdyYXBoLngoZC54KSArIGJhclhPZmZzZXQgfSkKCQkJCS5hdHRyKCJ5IiwgZnVuY3Rpb24oZCkgeyByZXR1cm4gKGdyYXBoLnkoZC55MCArIE1hdGguYWJzKGQueSkpKSAqIChkLnkgPCAwID8gLTEgOiAxICkgfSkKCQkJCS5hdHRyKCJ3aWR0aCIsIHNlcmllc0JhcldpZHRoKQoJCQkJLmF0dHIoImhlaWdodCIsIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGdyYXBoLnkubWFnbml0dWRlKE1hdGguYWJzKGQueSkpIH0pCgkJCQkuYXR0cigidHJhbnNmb3JtIiwgdHJhbnNmb3JtKTsKCgkJCUFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwobm9kZXNbMF0sIGZ1bmN0aW9uKG4pIHsKCQkJCW4uc2V0QXR0cmlidXRlKCdmaWxsJywgc2VyaWVzLmNvbG9yKTsKCQkJfSApOwoKCQkJaWYgKHRoaXMudW5zdGFjaykgYmFyWE9mZnNldCArPSBzZXJpZXNCYXJXaWR0aDsKCgkJfSwgdGhpcyApOwoJfSwKCglfZnJlcXVlbnRJbnRlcnZhbDogZnVuY3Rpb24oZGF0YSkgewoKCQl2YXIgaW50ZXJ2YWxDb3VudHMgPSB7fTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aCAtIDE7IGkrKykgewoJCQl2YXIgaW50ZXJ2YWwgPSBkYXRhW2kgKyAxXS54IC0gZGF0YVtpXS54OwoJCQlpbnRlcnZhbENvdW50c1tpbnRlcnZhbF0gPSBpbnRlcnZhbENvdW50c1tpbnRlcnZhbF0gfHwgMDsKCQkJaW50ZXJ2YWxDb3VudHNbaW50ZXJ2YWxdKys7CgkJfQoKCQl2YXIgZnJlcXVlbnRJbnRlcnZhbCA9IHsgY291bnQ6IDAsIG1hZ25pdHVkZTogMSB9OwoKCQlSaWNrc2hhdy5rZXlzKGludGVydmFsQ291bnRzKS5mb3JFYWNoKCBmdW5jdGlvbihpKSB7CgkJCWlmIChmcmVxdWVudEludGVydmFsLmNvdW50IDwgaW50ZXJ2YWxDb3VudHNbaV0pIHsKCQkJCWZyZXF1ZW50SW50ZXJ2YWwgPSB7CgkJCQkJY291bnQ6IGludGVydmFsQ291bnRzW2ldLAoJCQkJCW1hZ25pdHVkZTogaQoJCQkJfTsKCQkJfQoJCX0gKTsKCgkJcmV0dXJuIGZyZXF1ZW50SW50ZXJ2YWw7Cgl9Cn0gKTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguUmVuZGVyZXIuQXJlYScpOwoKUmlja3NoYXcuR3JhcGguUmVuZGVyZXIuQXJlYSA9IFJpY2tzaGF3LkNsYXNzLmNyZWF0ZSggUmlja3NoYXcuR3JhcGguUmVuZGVyZXIsIHsKCgluYW1lOiAnYXJlYScsCgoJZGVmYXVsdHM6IGZ1bmN0aW9uKCRzdXBlcikgewoKCQlyZXR1cm4gUmlja3NoYXcuZXh0ZW5kKCAkc3VwZXIoKSwgewoJCQl1bnN0YWNrOiBmYWxzZSwKCQkJZmlsbDogZmFsc2UsCgkJCXN0cm9rZTogZmFsc2UKCQl9ICk7Cgl9LAoKCXNlcmllc1BhdGhGYWN0b3J5OiBmdW5jdGlvbigpIHsKCgkJdmFyIGdyYXBoID0gdGhpcy5ncmFwaDsKCgkJdmFyIGZhY3RvcnkgPSBkMy5zdmcuYXJlYSgpCgkJCS54KCBmdW5jdGlvbihkKSB7IHJldHVybiBncmFwaC54KGQueCkgfSApCgkJCS55MCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueShkLnkwKSB9ICkKCQkJLnkxKCBmdW5jdGlvbihkKSB7IHJldHVybiBncmFwaC55KGQueSArIGQueTApIH0gKQoJCQkuaW50ZXJwb2xhdGUoZ3JhcGguaW50ZXJwb2xhdGlvbikudGVuc2lvbih0aGlzLnRlbnNpb24pOwoKCQlmYWN0b3J5LmRlZmluZWQgJiYgZmFjdG9yeS5kZWZpbmVkKCBmdW5jdGlvbihkKSB7IHJldHVybiBkLnkgIT09IG51bGwgfSApOwoJCXJldHVybiBmYWN0b3J5OwoJfSwKCglzZXJpZXNTdHJva2VGYWN0b3J5OiBmdW5jdGlvbigpIHsKCgkJdmFyIGdyYXBoID0gdGhpcy5ncmFwaDsKCgkJdmFyIGZhY3RvcnkgPSBkMy5zdmcubGluZSgpCgkJCS54KCBmdW5jdGlvbihkKSB7IHJldHVybiBncmFwaC54KGQueCkgfSApCgkJCS55KCBmdW5jdGlvbihkKSB7IHJldHVybiBncmFwaC55KGQueSArIGQueTApIH0gKQoJCQkuaW50ZXJwb2xhdGUoZ3JhcGguaW50ZXJwb2xhdGlvbikudGVuc2lvbih0aGlzLnRlbnNpb24pOwoKCQlmYWN0b3J5LmRlZmluZWQgJiYgZmFjdG9yeS5kZWZpbmVkKCBmdW5jdGlvbihkKSB7IHJldHVybiBkLnkgIT09IG51bGwgfSApOwoJCXJldHVybiBmYWN0b3J5OwoJfSwKCglyZW5kZXI6IGZ1bmN0aW9uKGFyZ3MpIHsKCgkJYXJncyA9IGFyZ3MgfHwge307CgoJCXZhciBncmFwaCA9IHRoaXMuZ3JhcGg7CgkJdmFyIHNlcmllcyA9IGFyZ3Muc2VyaWVzIHx8IGdyYXBoLnNlcmllczsKCgkJdmFyIHZpcyA9IGFyZ3MudmlzIHx8IGdyYXBoLnZpczsKCQl2aXMuc2VsZWN0QWxsKCcqJykucmVtb3ZlKCk7CgoJCS8vIGluc2VydCBvciBzdGFja2VkIGFyZWFzIHNvIHN0cm9rZXMgbGF5IG9uIHRvcCBvZiBhcmVhcwoJCXZhciBtZXRob2QgPSB0aGlzLnVuc3RhY2sgPyAnYXBwZW5kJyA6ICdpbnNlcnQnOwoKCQl2YXIgZGF0YSA9IHNlcmllcwoJCQkuZmlsdGVyKGZ1bmN0aW9uKHMpIHsgcmV0dXJuICFzLmRpc2FibGVkIH0pCgkJCS5tYXAoZnVuY3Rpb24ocykgeyByZXR1cm4gcy5zdGFjayB9KTsKCgkJdmFyIG5vZGVzID0gdmlzLnNlbGVjdEFsbCgicGF0aCIpCgkJCS5kYXRhKGRhdGEpCgkJCS5lbnRlcigpW21ldGhvZF0oInN2ZzpnIiwgJ2cnKTsKCgkJbm9kZXMuYXBwZW5kKCJzdmc6cGF0aCIpCgkJCS5hdHRyKCJkIiwgdGhpcy5zZXJpZXNQYXRoRmFjdG9yeSgpKQoJCQkuYXR0cigiY2xhc3MiLCAnYXJlYScpOwoKCQlpZiAodGhpcy5zdHJva2UpIHsKCQkJbm9kZXMuYXBwZW5kKCJzdmc6cGF0aCIpCgkJCQkuYXR0cigiZCIsIHRoaXMuc2VyaWVzU3Ryb2tlRmFjdG9yeSgpKQoJCQkJLmF0dHIoImNsYXNzIiwgJ2xpbmUnKTsKCQl9CgoJCXZhciBpID0gMDsKCQlzZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24oc2VyaWVzKSB7CgkJCWlmIChzZXJpZXMuZGlzYWJsZWQpIHJldHVybjsKCQkJc2VyaWVzLnBhdGggPSBub2Rlc1swXVtpKytdOwoJCQl0aGlzLl9zdHlsZVNlcmllcyhzZXJpZXMpOwoJCX0sIHRoaXMgKTsKCX0sCgoJX3N0eWxlU2VyaWVzOiBmdW5jdGlvbihzZXJpZXMpIHsKCgkJaWYgKCFzZXJpZXMucGF0aCkgcmV0dXJuOwoKCQlkMy5zZWxlY3Qoc2VyaWVzLnBhdGgpLnNlbGVjdCgnLmFyZWEnKQoJCQkuYXR0cignZmlsbCcsIHNlcmllcy5jb2xvcik7CgoJCWlmICh0aGlzLnN0cm9rZSkgewoJCQlkMy5zZWxlY3Qoc2VyaWVzLnBhdGgpLnNlbGVjdCgnLmxpbmUnKQoJCQkJLmF0dHIoJ2ZpbGwnLCAnbm9uZScpCgkJCQkuYXR0cignc3Ryb2tlJywgc2VyaWVzLnN0cm9rZSB8fCBkMy5pbnRlcnBvbGF0ZVJnYihzZXJpZXMuY29sb3IsICdibGFjaycpKDAuMTI1KSkKCQkJCS5hdHRyKCdzdHJva2Utd2lkdGgnLCB0aGlzLnN0cm9rZVdpZHRoKTsKCQl9CgoJCWlmIChzZXJpZXMuY2xhc3NOYW1lKSB7CgkJCXNlcmllcy5wYXRoLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBzZXJpZXMuY2xhc3NOYW1lKTsKCQl9Cgl9Cn0gKTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguUmVuZGVyZXIuU2NhdHRlclBsb3QnKTsKClJpY2tzaGF3LkdyYXBoLlJlbmRlcmVyLlNjYXR0ZXJQbG90ID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCBSaWNrc2hhdy5HcmFwaC5SZW5kZXJlciwgewoKCW5hbWU6ICdzY2F0dGVycGxvdCcsCgoJZGVmYXVsdHM6IGZ1bmN0aW9uKCRzdXBlcikgewoKCQlyZXR1cm4gUmlja3NoYXcuZXh0ZW5kKCAkc3VwZXIoKSwgewoJCQl1bnN0YWNrOiB0cnVlLAoJCQlmaWxsOiB0cnVlLAoJCQlzdHJva2U6IGZhbHNlLAoJCQlwYWRkaW5nOnsgdG9wOiAwLjAxLCByaWdodDogMC4wMSwgYm90dG9tOiAwLjAxLCBsZWZ0OiAwLjAxIH0sCgkJCWRvdFNpemU6IDQKCQl9ICk7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKCRzdXBlciwgYXJncykgewoJCSRzdXBlcihhcmdzKTsKCX0sCgoJcmVuZGVyOiBmdW5jdGlvbihhcmdzKSB7CgoJCWFyZ3MgPSBhcmdzIHx8IHt9OwoKCQl2YXIgZ3JhcGggPSB0aGlzLmdyYXBoOwoKCQl2YXIgc2VyaWVzID0gYXJncy5zZXJpZXMgfHwgZ3JhcGguc2VyaWVzOwoJCXZhciB2aXMgPSBhcmdzLnZpcyB8fCBncmFwaC52aXM7CgoJCXZhciBkb3RTaXplID0gdGhpcy5kb3RTaXplOwoKCQl2aXMuc2VsZWN0QWxsKCcqJykucmVtb3ZlKCk7CgoJCXNlcmllcy5mb3JFYWNoKCBmdW5jdGlvbihzZXJpZXMpIHsKCgkJCWlmIChzZXJpZXMuZGlzYWJsZWQpIHJldHVybjsKCgkJCXZhciBub2RlcyA9IHZpcy5zZWxlY3RBbGwoInBhdGgiKQoJCQkJLmRhdGEoc2VyaWVzLnN0YWNrLmZpbHRlciggZnVuY3Rpb24oZCkgeyByZXR1cm4gZC55ICE9PSBudWxsIH0gKSkKCQkJCS5lbnRlcigpLmFwcGVuZCgic3ZnOmNpcmNsZSIpCgkJCQkJLmF0dHIoImN4IiwgZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueChkLngpIH0pCgkJCQkJLmF0dHIoImN5IiwgZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueShkLnkpIH0pCgkJCQkJLmF0dHIoInIiLCBmdW5jdGlvbihkKSB7IHJldHVybiAoInIiIGluIGQpID8gZC5yIDogZG90U2l6ZX0pOwoJCQlpZiAoc2VyaWVzLmNsYXNzTmFtZSkgewoJCQkJbm9kZXMuY2xhc3NlZChzZXJpZXMuY2xhc3NOYW1lLCB0cnVlKTsKCQkJfQoJCQkKCQkJQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChub2Rlc1swXSwgZnVuY3Rpb24obikgewoJCQkJbi5zZXRBdHRyaWJ1dGUoJ2ZpbGwnLCBzZXJpZXMuY29sb3IpOwoJCQl9ICk7CgoJCX0sIHRoaXMgKTsKCX0KfSApOwpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkdyYXBoLlJlbmRlcmVyLk11bHRpJyk7CgpSaWNrc2hhdy5HcmFwaC5SZW5kZXJlci5NdWx0aSA9IFJpY2tzaGF3LkNsYXNzLmNyZWF0ZSggUmlja3NoYXcuR3JhcGguUmVuZGVyZXIsIHsKCgluYW1lOiAnbXVsdGknLAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKCRzdXBlciwgYXJncykgewoKCQkkc3VwZXIoYXJncyk7Cgl9LAoKCWRlZmF1bHRzOiBmdW5jdGlvbigkc3VwZXIpIHsKCgkJcmV0dXJuIFJpY2tzaGF3LmV4dGVuZCggJHN1cGVyKCksIHsKCQkJdW5zdGFjazogdHJ1ZSwKCQkJZmlsbDogZmFsc2UsCgkJCXN0cm9rZTogdHJ1ZSAKCQl9ICk7Cgl9LAoKCWNvbmZpZ3VyZTogZnVuY3Rpb24oJHN1cGVyLCBhcmdzKSB7CgoJCWFyZ3MgPSBhcmdzIHx8IHt9OwoJCXRoaXMuY29uZmlnID0gYXJnczsKCQkkc3VwZXIoYXJncyk7Cgl9LAoKCWRvbWFpbjogZnVuY3Rpb24oJHN1cGVyKSB7CgoJCXRoaXMuZ3JhcGguc3RhY2tEYXRhKCk7CgoJCXZhciBkb21haW5zID0gW107CgoJCXZhciBncm91cHMgPSB0aGlzLl9ncm91cHMoKTsKCQl0aGlzLl9zdGFjayhncm91cHMpOwoKCQlncm91cHMuZm9yRWFjaCggZnVuY3Rpb24oZ3JvdXApIHsKCgkJCXZhciBkYXRhID0gZ3JvdXAuc2VyaWVzCgkJCQkuZmlsdGVyKCBmdW5jdGlvbihzKSB7IHJldHVybiAhcy5kaXNhYmxlZCB9ICkKCQkJCS5tYXAoIGZ1bmN0aW9uKHMpIHsgcmV0dXJuIHMuc3RhY2sgfSk7CgoJCQlpZiAoIWRhdGEubGVuZ3RoKSByZXR1cm47CgkJCQoJCQl2YXIgZG9tYWluID0gbnVsbDsKCQkJaWYgKGdyb3VwLnJlbmRlcmVyICYmIGdyb3VwLnJlbmRlcmVyLmRvbWFpbikgewoJCQkJZG9tYWluID0gZ3JvdXAucmVuZGVyZXIuZG9tYWluKGRhdGEpOwoJCQl9CgkJCWVsc2UgewoJCQkJZG9tYWluID0gJHN1cGVyKGRhdGEpOwoJCQl9CgkJCWRvbWFpbnMucHVzaChkb21haW4pOwoJCX0pOwoKCQl2YXIgeE1pbiA9IGQzLm1pbihkb21haW5zLm1hcCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZC54WzBdIH0gKSk7CgkJdmFyIHhNYXggPSBkMy5tYXgoZG9tYWlucy5tYXAoIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQueFsxXSB9ICkpOwoJCXZhciB5TWluID0gZDMubWluKGRvbWFpbnMubWFwKCBmdW5jdGlvbihkKSB7IHJldHVybiBkLnlbMF0gfSApKTsKCQl2YXIgeU1heCA9IGQzLm1heChkb21haW5zLm1hcCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZC55WzFdIH0gKSk7CgoJCXJldHVybiB7IHg6IFt4TWluLCB4TWF4XSwgeTogW3lNaW4sIHlNYXhdIH07Cgl9LAoKCV9ncm91cHM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZ3JhcGggPSB0aGlzLmdyYXBoOwoKCQl2YXIgcmVuZGVyR3JvdXBzID0ge307CgoJCWdyYXBoLnNlcmllcy5mb3JFYWNoKCBmdW5jdGlvbihzZXJpZXMpIHsKCgkJCWlmIChzZXJpZXMuZGlzYWJsZWQpIHJldHVybjsKCgkJCWlmICghcmVuZGVyR3JvdXBzW3Nlcmllcy5yZW5kZXJlcl0pIHsKCgkJCQl2YXIgbnMgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwoJCQkJdmFyIHZpcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhucywgJ2cnKTsKCgkJCQlncmFwaC52aXNbMF1bMF0uYXBwZW5kQ2hpbGQodmlzKTsKCgkJCQl2YXIgcmVuZGVyZXIgPSBncmFwaC5fcmVuZGVyZXJzW3Nlcmllcy5yZW5kZXJlcl07CgoJCQkJdmFyIGNvbmZpZyA9IHt9OwoKCQkJCXZhciBkZWZhdWx0cyA9IFsgdGhpcy5kZWZhdWx0cygpLCByZW5kZXJlci5kZWZhdWx0cygpLCB0aGlzLmNvbmZpZywgdGhpcy5ncmFwaCBdOwoJCQkJZGVmYXVsdHMuZm9yRWFjaChmdW5jdGlvbihkKSB7IFJpY2tzaGF3LmV4dGVuZChjb25maWcsIGQpIH0pOwoKCQkJCXJlbmRlcmVyLmNvbmZpZ3VyZShjb25maWcpOwoKCQkJCXJlbmRlckdyb3Vwc1tzZXJpZXMucmVuZGVyZXJdID0gewoJCQkJCXJlbmRlcmVyOiByZW5kZXJlciwKCQkJCQlzZXJpZXM6IFtdLAoJCQkJCXZpczogZDMuc2VsZWN0KHZpcykKCQkJCX07CgkJCX0KCQkJCQoJCQlyZW5kZXJHcm91cHNbc2VyaWVzLnJlbmRlcmVyXS5zZXJpZXMucHVzaChzZXJpZXMpOwoKCQl9LCB0aGlzKTsKCgkJdmFyIGdyb3VwcyA9IFtdOwoKCQlPYmplY3Qua2V5cyhyZW5kZXJHcm91cHMpLmZvckVhY2goIGZ1bmN0aW9uKGtleSkgewoJCQl2YXIgZ3JvdXAgPSByZW5kZXJHcm91cHNba2V5XTsKCQkJZ3JvdXBzLnB1c2goZ3JvdXApOwoJCX0pOwoKCQlyZXR1cm4gZ3JvdXBzOwoJfSwKCglfc3RhY2s6IGZ1bmN0aW9uKGdyb3VwcykgewoKCQlncm91cHMuZm9yRWFjaCggZnVuY3Rpb24oZ3JvdXApIHsKCgkJCXZhciBzZXJpZXMgPSBncm91cC5zZXJpZXMKCQkJCS5maWx0ZXIoIGZ1bmN0aW9uKHNlcmllcykgeyByZXR1cm4gIXNlcmllcy5kaXNhYmxlZCB9ICk7CgoJCQl2YXIgZGF0YSA9IHNlcmllcwoJCQkJLm1hcCggZnVuY3Rpb24oc2VyaWVzKSB7IHJldHVybiBzZXJpZXMuc3RhY2sgfSApOwoKCQkJaWYgKCFncm91cC5yZW5kZXJlci51bnN0YWNrKSB7CgoJCQkJdmFyIGxheW91dCA9IGQzLmxheW91dC5zdGFjaygpOwoJCQkJdmFyIHN0YWNrZWREYXRhID0gUmlja3NoYXcuY2xvbmUobGF5b3V0KGRhdGEpKTsKCgkJCQlzZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24oc2VyaWVzLCBpbmRleCkgewoJCQkJCXNlcmllcy5fc3RhY2sgPSBSaWNrc2hhdy5jbG9uZShzdGFja2VkRGF0YVtpbmRleF0pOwoJCQkJfSk7CgkJCX0KCgkJfSwgdGhpcyApOwoKCQlyZXR1cm4gZ3JvdXBzOwoKCX0sCgoJcmVuZGVyOiBmdW5jdGlvbigpIHsKCgkJdGhpcy5ncmFwaC5zZXJpZXMuZm9yRWFjaCggZnVuY3Rpb24oc2VyaWVzKSB7CgkJCWlmICghc2VyaWVzLnJlbmRlcmVyKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoIkVhY2ggc2VyaWVzIG5lZWRzIGEgcmVuZGVyZXIgZm9yIGdyYXBoICdtdWx0aScgcmVuZGVyZXIiKTsKCQkJfQoJCX0pOwoKCQl0aGlzLmdyYXBoLnZpcy5zZWxlY3RBbGwoJyonKS5yZW1vdmUoKTsKCgkJdmFyIGdyb3VwcyA9IHRoaXMuX2dyb3VwcygpOwoJCWdyb3VwcyA9IHRoaXMuX3N0YWNrKGdyb3Vwcyk7CgoJCWdyb3Vwcy5mb3JFYWNoKCBmdW5jdGlvbihncm91cCkgewoKCQkJdmFyIHNlcmllcyA9IGdyb3VwLnNlcmllcwoJCQkJLmZpbHRlciggZnVuY3Rpb24oc2VyaWVzKSB7IHJldHVybiAhc2VyaWVzLmRpc2FibGVkIH0gKTsKCgkJCXNlcmllcy5hY3RpdmUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHNlcmllcyB9OwoKCQkJZ3JvdXAucmVuZGVyZXIucmVuZGVyKHsgc2VyaWVzOiBzZXJpZXMsIHZpczogZ3JvdXAudmlzIH0pOwoJCQlzZXJpZXMuZm9yRWFjaChmdW5jdGlvbihzKSB7IHMuc3RhY2sgPSBzLl9zdGFjayB8fCBzLnN0YWNrIHx8IHMuZGF0YTsgfSk7CgkJfSk7Cgl9Cgp9ICk7ClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguUmVuZGVyZXIuTGluZVBsb3QnKTsKClJpY2tzaGF3LkdyYXBoLlJlbmRlcmVyLkxpbmVQbG90ID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCBSaWNrc2hhdy5HcmFwaC5SZW5kZXJlciwgewoKCW5hbWU6ICdsaW5lcGxvdCcsCgoJZGVmYXVsdHM6IGZ1bmN0aW9uKCRzdXBlcikgewoKCQlyZXR1cm4gUmlja3NoYXcuZXh0ZW5kKCAkc3VwZXIoKSwgewoJCQl1bnN0YWNrOiB0cnVlLAoJCQlmaWxsOiBmYWxzZSwKCQkJc3Ryb2tlOiB0cnVlLAoJCQlwYWRkaW5nOnsgdG9wOiAwLjAxLCByaWdodDogMC4wMSwgYm90dG9tOiAwLjAxLCBsZWZ0OiAwLjAxIH0sCgkJCWRvdFNpemU6IDMsCgkJCXN0cm9rZVdpZHRoOiAyCgkJfSApOwoJfSwKCglzZXJpZXNQYXRoRmFjdG9yeTogZnVuY3Rpb24oKSB7CgoJCXZhciBncmFwaCA9IHRoaXMuZ3JhcGg7CgoJCXZhciBmYWN0b3J5ID0gZDMuc3ZnLmxpbmUoKQoJCQkueCggZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueChkLngpIH0gKQoJCQkueSggZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueShkLnkpIH0gKQoJCQkuaW50ZXJwb2xhdGUodGhpcy5ncmFwaC5pbnRlcnBvbGF0aW9uKS50ZW5zaW9uKHRoaXMudGVuc2lvbik7CgoJCWZhY3RvcnkuZGVmaW5lZCAmJiBmYWN0b3J5LmRlZmluZWQoIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQueSAhPT0gbnVsbCB9ICk7CgkJcmV0dXJuIGZhY3Rvcnk7Cgl9LAoKCXJlbmRlcjogZnVuY3Rpb24oYXJncykgewoKCQlhcmdzID0gYXJncyB8fCB7fTsKCgkJdmFyIGdyYXBoID0gdGhpcy5ncmFwaDsKCgkJdmFyIHNlcmllcyA9IGFyZ3Muc2VyaWVzIHx8IGdyYXBoLnNlcmllczsKCQl2YXIgdmlzID0gYXJncy52aXMgfHwgZ3JhcGgudmlzOwoKCQl2YXIgZG90U2l6ZSA9IHRoaXMuZG90U2l6ZTsKCgkJdmlzLnNlbGVjdEFsbCgnKicpLnJlbW92ZSgpOwoKCQl2YXIgZGF0YSA9IHNlcmllcwoJCQkuZmlsdGVyKGZ1bmN0aW9uKHMpIHsgcmV0dXJuICFzLmRpc2FibGVkIH0pCgkJCS5tYXAoZnVuY3Rpb24ocykgeyByZXR1cm4gcy5zdGFjayB9KTsKCgkJdmFyIG5vZGVzID0gdmlzLnNlbGVjdEFsbCgicGF0aCIpCgkJCS5kYXRhKGRhdGEpCgkJCS5lbnRlcigpLmFwcGVuZCgic3ZnOnBhdGgiKQoJCQkuYXR0cigiZCIsIHRoaXMuc2VyaWVzUGF0aEZhY3RvcnkoKSk7CgoJCXZhciBpID0gMDsKCQlzZXJpZXMuZm9yRWFjaChmdW5jdGlvbihzZXJpZXMpIHsKCQkJaWYgKHNlcmllcy5kaXNhYmxlZCkgcmV0dXJuOwoJCQlzZXJpZXMucGF0aCA9IG5vZGVzWzBdW2krK107CgkJCXRoaXMuX3N0eWxlU2VyaWVzKHNlcmllcyk7CgkJfSwgdGhpcyk7CgoJCXNlcmllcy5mb3JFYWNoKGZ1bmN0aW9uKHNlcmllcykgewoKCQkJaWYgKHNlcmllcy5kaXNhYmxlZCkgcmV0dXJuOwoKCQkJdmFyIG5vZGVzID0gdmlzLnNlbGVjdEFsbCgieCIpCgkJCQkuZGF0YShzZXJpZXMuc3RhY2suZmlsdGVyKCBmdW5jdGlvbihkKSB7IHJldHVybiBkLnkgIT09IG51bGwgfSApKQoJCQkJLmVudGVyKCkuYXBwZW5kKCJzdmc6Y2lyY2xlIikKCQkJCS5hdHRyKCJjeCIsIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGdyYXBoLngoZC54KSB9KQoJCQkJLmF0dHIoImN5IiwgZnVuY3Rpb24oZCkgeyByZXR1cm4gZ3JhcGgueShkLnkpIH0pCgkJCQkuYXR0cigiciIsIGZ1bmN0aW9uKGQpIHsgcmV0dXJuICgiciIgaW4gZCkgPyBkLnIgOiBkb3RTaXplfSk7CgoJCQlBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKG5vZGVzWzBdLCBmdW5jdGlvbihuKSB7CgkJCQlpZiAoIW4pIHJldHVybjsKCQkJCW4uc2V0QXR0cmlidXRlKCdkYXRhLWNvbG9yJywgc2VyaWVzLmNvbG9yKTsKCQkJCW4uc2V0QXR0cmlidXRlKCdmaWxsJywgJ3doaXRlJyk7CgkJCQluLnNldEF0dHJpYnV0ZSgnc3Ryb2tlJywgc2VyaWVzLmNvbG9yKTsKCQkJCW4uc2V0QXR0cmlidXRlKCdzdHJva2Utd2lkdGgnLCB0aGlzLnN0cm9rZVdpZHRoKTsKCgkJCX0uYmluZCh0aGlzKSk7CgoJCX0sIHRoaXMpOwoJfQp9ICk7CgpSaWNrc2hhdy5uYW1lc3BhY2UoJ1JpY2tzaGF3LkdyYXBoLlNtb290aGVyJyk7CgpSaWNrc2hhdy5HcmFwaC5TbW9vdGhlciA9IFJpY2tzaGF3LkNsYXNzLmNyZWF0ZSh7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oYXJncykgewoKCQl0aGlzLmdyYXBoID0gYXJncy5ncmFwaDsKCQl0aGlzLmVsZW1lbnQgPSBhcmdzLmVsZW1lbnQ7CgkJdGhpcy5hZ2dyZWdhdGlvblNjYWxlID0gMTsKCgkJdGhpcy5idWlsZCgpOwoKCQl0aGlzLmdyYXBoLnN0YWNrRGF0YS5ob29rcy5kYXRhLnB1c2goIHsKCQkJbmFtZTogJ3Ntb290aGVyJywKCQkJb3JkZXJQb3NpdGlvbjogNTAsCgkJCWY6IHRoaXMudHJhbnNmb3JtZXIuYmluZCh0aGlzKQoJCX0gKTsKCX0sCgoJYnVpbGQ6IGZ1bmN0aW9uKCkgewoKCQl2YXIgc2VsZiA9IHRoaXM7CgkJdmFyICQgPSBqUXVlcnk7CgoJCWlmICh0aGlzLmVsZW1lbnQpIHsKCQkJJCggZnVuY3Rpb24oKSB7CgkJCQkkKHNlbGYuZWxlbWVudCkuc2xpZGVyKCB7CgkJCQkJbWluOiAxLAoJCQkJCW1heDogMTAwLAoJCQkJCXNsaWRlOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJCQlzZWxmLnNldFNjYWxlKHVpLnZhbHVlKTsKCQkJCQkJc2VsZi5ncmFwaC51cGRhdGUoKTsKCQkJCQl9CgkJCQl9ICk7CgkJCX0gKTsKCQl9Cgl9LAoKCXNldFNjYWxlOiBmdW5jdGlvbihzY2FsZSkgewoKCQlpZiAoc2NhbGUgPCAxKSB7CgkJCXRocm93ICJzY2FsZSBvdXQgb2YgcmFuZ2U6ICIgKyBzY2FsZTsKCQl9CgoJCXRoaXMuYWdncmVnYXRpb25TY2FsZSA9IHNjYWxlOwoJCXRoaXMuZ3JhcGgudXBkYXRlKCk7Cgl9LAoKCXRyYW5zZm9ybWVyOiBmdW5jdGlvbihkYXRhKSB7CgoJCWlmICh0aGlzLmFnZ3JlZ2F0aW9uU2NhbGUgPT0gMSkgcmV0dXJuIGRhdGE7CgoJCXZhciBhZ2dyZWdhdGVkRGF0YSA9IFtdOwoKCQlkYXRhLmZvckVhY2goIGZ1bmN0aW9uKHNlcmllc0RhdGEpIHsKCgkJCXZhciBhZ2dyZWdhdGVkU2VyaWVzRGF0YSA9IFtdOwoKCQkJd2hpbGUgKHNlcmllc0RhdGEubGVuZ3RoKSB7CgoJCQkJdmFyIGF2Z1ggPSAwLCBhdmdZID0gMDsKCQkJCXZhciBzbGljZSA9IHNlcmllc0RhdGEuc3BsaWNlKDAsIHRoaXMuYWdncmVnYXRpb25TY2FsZSk7CgoJCQkJc2xpY2UuZm9yRWFjaCggZnVuY3Rpb24oZCkgewoJCQkJCWF2Z1ggKz0gZC54IC8gc2xpY2UubGVuZ3RoOwoJCQkJCWF2Z1kgKz0gZC55IC8gc2xpY2UubGVuZ3RoOwoJCQkJfSApOwoKCQkJCWFnZ3JlZ2F0ZWRTZXJpZXNEYXRhLnB1c2goIHsgeDogYXZnWCwgeTogYXZnWSB9ICk7CgkJCX0KCgkJCWFnZ3JlZ2F0ZWREYXRhLnB1c2goYWdncmVnYXRlZFNlcmllc0RhdGEpOwoKCQl9LmJpbmQodGhpcykgKTsKCgkJcmV0dXJuIGFnZ3JlZ2F0ZWREYXRhOwoJfQp9KTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuR3JhcGguU29ja2V0aW8nKTsKClJpY2tzaGF3LkdyYXBoLlNvY2tldGlvID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKCBSaWNrc2hhdy5HcmFwaC5BamF4LCB7CglyZXF1ZXN0OiBmdW5jdGlvbigpIHsKCQl2YXIgc29ja2V0ID0gaW8uY29ubmVjdCh0aGlzLmRhdGFVUkwpOwoJCXZhciBzZWxmID0gdGhpczsKCQlzb2NrZXQub24oJ3JpY2tzaGF3JywgZnVuY3Rpb24gKGRhdGEpIHsKCQkJc2VsZi5zdWNjZXNzKGRhdGEpOwoJCX0pOwoJfQp9ICk7ClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuU2VyaWVzJyk7CgpSaWNrc2hhdy5TZXJpZXMgPSBSaWNrc2hhdy5DbGFzcy5jcmVhdGUoIEFycmF5LCB7CgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24gKGRhdGEsIHBhbGV0dGUsIG9wdGlvbnMpIHsKCgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgoJCXRoaXMucGFsZXR0ZSA9IG5ldyBSaWNrc2hhdy5Db2xvci5QYWxldHRlKHBhbGV0dGUpOwoKCQl0aGlzLnRpbWVCYXNlID0gdHlwZW9mKG9wdGlvbnMudGltZUJhc2UpID09PSAndW5kZWZpbmVkJyA\/IAoJCQlNYXRoLmZsb29yKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkgOiAKCQkJb3B0aW9ucy50aW1lQmFzZTsKCgkJdmFyIHRpbWVJbnRlcnZhbCA9IHR5cGVvZihvcHRpb25zLnRpbWVJbnRlcnZhbCkgPT0gJ3VuZGVmaW5lZCcgPwoJCQkxMDAwIDoKCQkJb3B0aW9ucy50aW1lSW50ZXJ2YWw7CgoJCXRoaXMuc2V0VGltZUludGVydmFsKHRpbWVJbnRlcnZhbCk7CgoJCWlmIChkYXRhICYmICh0eXBlb2YoZGF0YSkgPT0gIm9iamVjdCIpICYmIEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKCQkJZGF0YS5mb3JFYWNoKCBmdW5jdGlvbihpdGVtKSB7IHRoaXMuYWRkSXRlbShpdGVtKSB9LCB0aGlzICk7CgkJfQoJfSwKCglhZGRJdGVtOiBmdW5jdGlvbihpdGVtKSB7CgoJCWlmICh0eXBlb2YoaXRlbS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhyb3coJ2FkZEl0ZW0oKSBuZWVkcyBhIG5hbWUnKTsKCQl9CgoJCWl0ZW0uY29sb3IgPSAoaXRlbS5jb2xvciB8fCB0aGlzLnBhbGV0dGUuY29sb3IoaXRlbS5uYW1lKSk7CgkJaXRlbS5kYXRhID0gKGl0ZW0uZGF0YSB8fCBbXSk7CgoJCS8vIGJhY2tmaWxsLCBpZiBuZWNlc3NhcnkKCQlpZiAoKGl0ZW0uZGF0YS5sZW5ndGggPT09IDApICYmIHRoaXMubGVuZ3RoICYmICh0aGlzLmdldEluZGV4KCkgPiAwKSkgewoJCQl0aGlzWzBdLmRhdGEuZm9yRWFjaCggZnVuY3Rpb24ocGxvdCkgewoJCQkJaXRlbS5kYXRhLnB1c2goeyB4OiBwbG90LngsIHk6IDAgfSk7CgkJCX0gKTsKCQl9IGVsc2UgaWYgKGl0ZW0uZGF0YS5sZW5ndGggPT09IDApIHsKCQkJaXRlbS5kYXRhLnB1c2goeyB4OiB0aGlzLnRpbWVCYXNlIC0gKHRoaXMudGltZUludGVydmFsIHx8IDApLCB5OiAwIH0pOwoJCX0gCgoJCXRoaXMucHVzaChpdGVtKTsKCgkJaWYgKHRoaXMubGVnZW5kKSB7CgkJCXRoaXMubGVnZW5kLmFkZExpbmUodGhpcy5pdGVtQnlOYW1lKGl0ZW0ubmFtZSkpOwoJCX0KCX0sCgoJYWRkRGF0YTogZnVuY3Rpb24oZGF0YSwgeCkgewoKCQl2YXIgaW5kZXggPSB0aGlzLmdldEluZGV4KCk7CgoJCVJpY2tzaGF3LmtleXMoZGF0YSkuZm9yRWFjaCggZnVuY3Rpb24obmFtZSkgewoJCQlpZiAoISB0aGlzLml0ZW1CeU5hbWUobmFtZSkpIHsKCQkJCXRoaXMuYWRkSXRlbSh7IG5hbWU6IG5hbWUgfSk7CgkJCX0KCQl9LCB0aGlzICk7CgoJCXRoaXMuZm9yRWFjaCggZnVuY3Rpb24oaXRlbSkgewoJCQlpdGVtLmRhdGEucHVzaCh7IAoJCQkJeDogeCB8fCAoaW5kZXggKiB0aGlzLnRpbWVJbnRlcnZhbCB8fCAxKSArIHRoaXMudGltZUJhc2UsIAoJCQkJeTogKGRhdGFbaXRlbS5uYW1lXSB8fCAwKSAKCQkJfSk7CgkJfSwgdGhpcyApOwoJfSwKCglnZXRJbmRleDogZnVuY3Rpb24gKCkgewoJCXJldHVybiAodGhpc1swXSAmJiB0aGlzWzBdLmRhdGEgJiYgdGhpc1swXS5kYXRhLmxlbmd0aCkgPyB0aGlzWzBdLmRhdGEubGVuZ3RoIDogMDsKCX0sCgoJaXRlbUJ5TmFtZTogZnVuY3Rpb24obmFtZSkgewoKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKCQkJaWYgKHRoaXNbaV0ubmFtZSA9PSBuYW1lKQoJCQkJcmV0dXJuIHRoaXNbaV07CgkJfQoJfSwKCglzZXRUaW1lSW50ZXJ2YWw6IGZ1bmN0aW9uKGl2KSB7CgkJdGhpcy50aW1lSW50ZXJ2YWwgPSBpdiAvIDEwMDA7Cgl9LAoKCXNldFRpbWVCYXNlOiBmdW5jdGlvbiAodCkgewoJCXRoaXMudGltZUJhc2UgPSB0OwoJfSwKCglkdW1wOiBmdW5jdGlvbigpIHsKCgkJdmFyIGRhdGEgPSB7CgkJCXRpbWVCYXNlOiB0aGlzLnRpbWVCYXNlLAoJCQl0aW1lSW50ZXJ2YWw6IHRoaXMudGltZUludGVydmFsLAoJCQlpdGVtczogW10KCQl9OwoKCQl0aGlzLmZvckVhY2goIGZ1bmN0aW9uKGl0ZW0pIHsKCgkJCXZhciBuZXdJdGVtID0gewoJCQkJY29sb3I6IGl0ZW0uY29sb3IsCgkJCQluYW1lOiBpdGVtLm5hbWUsCgkJCQlkYXRhOiBbXQoJCQl9OwoKCQkJaXRlbS5kYXRhLmZvckVhY2goIGZ1bmN0aW9uKHBsb3QpIHsKCQkJCW5ld0l0ZW0uZGF0YS5wdXNoKHsgeDogcGxvdC54LCB5OiBwbG90LnkgfSk7CgkJCX0gKTsKCgkJCWRhdGEuaXRlbXMucHVzaChuZXdJdGVtKTsKCQl9ICk7CgoJCXJldHVybiBkYXRhOwoJfSwKCglsb2FkOiBmdW5jdGlvbihkYXRhKSB7CgoJCWlmIChkYXRhLnRpbWVJbnRlcnZhbCkgewoJCQl0aGlzLnRpbWVJbnRlcnZhbCA9IGRhdGEudGltZUludGVydmFsOwoJCX0KCgkJaWYgKGRhdGEudGltZUJhc2UpIHsKCQkJdGhpcy50aW1lQmFzZSA9IGRhdGEudGltZUJhc2U7CgkJfQoKCQlpZiAoZGF0YS5pdGVtcykgewoJCQlkYXRhLml0ZW1zLmZvckVhY2goIGZ1bmN0aW9uKGl0ZW0pIHsKCQkJCXRoaXMucHVzaChpdGVtKTsKCQkJCWlmICh0aGlzLmxlZ2VuZCkgewoJCQkJCXRoaXMubGVnZW5kLmFkZExpbmUodGhpcy5pdGVtQnlOYW1lKGl0ZW0ubmFtZSkpOwoJCQkJfQoKCQkJfSwgdGhpcyApOwoJCX0KCX0KfSApOwoKUmlja3NoYXcuU2VyaWVzLnplcm9GaWxsID0gZnVuY3Rpb24oc2VyaWVzKSB7CglSaWNrc2hhdy5TZXJpZXMuZmlsbChzZXJpZXMsIDApOwp9OwoKUmlja3NoYXcuU2VyaWVzLmZpbGwgPSBmdW5jdGlvbihzZXJpZXMsIGZpbGwpIHsKCgl2YXIgeDsKCXZhciBpID0gMDsKCgl2YXIgZGF0YSA9IHNlcmllcy5tYXAoIGZ1bmN0aW9uKHMpIHsgcmV0dXJuIHMuZGF0YSB9ICk7CgoJd2hpbGUgKCBpIDwgTWF0aC5tYXguYXBwbHkobnVsbCwgZGF0YS5tYXAoIGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQubGVuZ3RoIH0gKSkgKSB7CgoJCXggPSBNYXRoLm1pbi5hcHBseSggbnVsbCwgCgkJCWRhdGEKCQkJCS5maWx0ZXIoZnVuY3Rpb24oZCkgeyByZXR1cm4gZFtpXSB9KQoJCQkJLm1hcChmdW5jdGlvbihkKSB7IHJldHVybiBkW2ldLnggfSkKCQkpOwoKCQlkYXRhLmZvckVhY2goIGZ1bmN0aW9uKGQpIHsKCQkJaWYgKCFkW2ldIHx8IGRbaV0ueCAhPSB4KSB7CgkJCQlkLnNwbGljZShpLCAwLCB7IHg6IHgsIHk6IGZpbGwgfSk7CgkJCX0KCQl9ICk7CgoJCWkrKzsKCX0KfTsKClJpY2tzaGF3Lm5hbWVzcGFjZSgnUmlja3NoYXcuU2VyaWVzLkZpeGVkRHVyYXRpb24nKTsKClJpY2tzaGF3LlNlcmllcy5GaXhlZER1cmF0aW9uID0gUmlja3NoYXcuQ2xhc3MuY3JlYXRlKFJpY2tzaGF3LlNlcmllcywgewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uIChkYXRhLCBwYWxldHRlLCBvcHRpb25zKSB7CgoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCQlpZiAodHlwZW9mKG9wdGlvbnMudGltZUludGVydmFsKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhyb3cgbmV3IEVycm9yKCdGaXhlZER1cmF0aW9uIHNlcmllcyByZXF1aXJlcyB0aW1lSW50ZXJ2YWwnKTsKCQl9CgoJCWlmICh0eXBlb2Yob3B0aW9ucy5tYXhEYXRhUG9pbnRzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhyb3cgbmV3IEVycm9yKCdGaXhlZER1cmF0aW9uIHNlcmllcyByZXF1aXJlcyBtYXhEYXRhUG9pbnRzJyk7CgkJfQoKCQl0aGlzLnBhbGV0dGUgPSBuZXcgUmlja3NoYXcuQ29sb3IuUGFsZXR0ZShwYWxldHRlKTsKCQl0aGlzLnRpbWVCYXNlID0gdHlwZW9mKG9wdGlvbnMudGltZUJhc2UpID09PSAndW5kZWZpbmVkJyA\/IE1hdGguZmxvb3IobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKSA6IG9wdGlvbnMudGltZUJhc2U7CgkJdGhpcy5zZXRUaW1lSW50ZXJ2YWwob3B0aW9ucy50aW1lSW50ZXJ2YWwpOwoKCQlpZiAodGhpc1swXSAmJiB0aGlzWzBdLmRhdGEgJiYgdGhpc1swXS5kYXRhLmxlbmd0aCkgewoJCQl0aGlzLmN1cnJlbnRTaXplID0gdGhpc1swXS5kYXRhLmxlbmd0aDsKCQkJdGhpcy5jdXJyZW50SW5kZXggPSB0aGlzWzBdLmRhdGEubGVuZ3RoOwoJCX0gZWxzZSB7CgkJCXRoaXMuY3VycmVudFNpemUgID0gMDsKCQkJdGhpcy5jdXJyZW50SW5kZXggPSAwOwoJCX0KCgkJdGhpcy5tYXhEYXRhUG9pbnRzID0gb3B0aW9ucy5tYXhEYXRhUG9pbnRzOwoKCgkJaWYgKGRhdGEgJiYgKHR5cGVvZihkYXRhKSA9PSAib2JqZWN0IikgJiYgQXJyYXkuaXNBcnJheShkYXRhKSkgewoJCQlkYXRhLmZvckVhY2goIGZ1bmN0aW9uIChpdGVtKSB7IHRoaXMuYWRkSXRlbShpdGVtKSB9LCB0aGlzICk7CgkJCXRoaXMuY3VycmVudFNpemUgICs9IDE7CgkJCXRoaXMuY3VycmVudEluZGV4ICs9IDE7CgkJfQoKCQkvLyByZXNldCB0aW1lQmFzZSBmb3IgemVyby1maWxsZWQgdmFsdWVzIGlmIG5lZWRlZAoJCXRoaXMudGltZUJhc2UgLT0gKHRoaXMubWF4RGF0YVBvaW50cyAtIHRoaXMuY3VycmVudFNpemUpICogdGhpcy50aW1lSW50ZXJ2YWw7CgoJCS8vIHplcm8tZmlsbCB1cCB0byBtYXhEYXRhUG9pbnRzIHNpemUgaWYgd2UgZG9uJ3QgaGF2ZSB0aGF0IG11Y2ggZGF0YSB5ZXQKCQlpZiAoKHR5cGVvZih0aGlzLm1heERhdGFQb2ludHMpICE9PSAndW5kZWZpbmVkJykgJiYgKHRoaXMuY3VycmVudFNpemUgPCB0aGlzLm1heERhdGFQb2ludHMpKSB7CgkJCWZvciAodmFyIGkgPSB0aGlzLm1heERhdGFQb2ludHMgLSB0aGlzLmN1cnJlbnRTaXplIC0gMTsgaSA+IDE7IGktLSkgewoJCQkJdGhpcy5jdXJyZW50U2l6ZSAgKz0gMTsKCQkJCXRoaXMuY3VycmVudEluZGV4ICs9IDE7CgkJCQl0aGlzLmZvckVhY2goIGZ1bmN0aW9uIChpdGVtKSB7CgkJCQkJaXRlbS5kYXRhLnVuc2hpZnQoeyB4OiAoKGktMSkgKiB0aGlzLnRpbWVJbnRlcnZhbCB8fCAxKSArIHRoaXMudGltZUJhc2UsIHk6IDAsIGk6IGkgfSk7CgkJCQl9LCB0aGlzICk7CgkJCX0KCQl9Cgl9LAoKCWFkZERhdGE6IGZ1bmN0aW9uKCRzdXBlciwgZGF0YSwgeCkgewoKCQkkc3VwZXIoZGF0YSwgeCk7CgoJCXRoaXMuY3VycmVudFNpemUgKz0gMTsKCQl0aGlzLmN1cnJlbnRJbmRleCArPSAxOwoKCQlpZiAodGhpcy5tYXhEYXRhUG9pbnRzICE9PSB1bmRlZmluZWQpIHsKCQkJd2hpbGUgKHRoaXMuY3VycmVudFNpemUgPiB0aGlzLm1heERhdGFQb2ludHMpIHsKCQkJCXRoaXMuZHJvcERhdGEoKTsKCQkJfQoJCX0KCX0sCgoJZHJvcERhdGE6IGZ1bmN0aW9uKCkgewoKCQl0aGlzLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewoJCQlpdGVtLmRhdGEuc3BsaWNlKDAsIDEpOwoJCX0gKTsKCgkJdGhpcy5jdXJyZW50U2l6ZSAtPSAxOwoJfSwKCglnZXRJbmRleDogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLmN1cnJlbnRJbmRleDsKCX0KfSApOwoKCXJldHVybiBSaWNrc2hhdzsKfSkpOwo=",
    "size": "100700"
}