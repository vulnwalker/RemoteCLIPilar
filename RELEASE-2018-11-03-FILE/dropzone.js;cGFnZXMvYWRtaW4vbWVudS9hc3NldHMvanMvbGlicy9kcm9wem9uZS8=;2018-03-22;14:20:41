{
    "namaFile": "pages\/admin\/menu\/assets\/js\/libs\/dropzone\/dropzone.js",
    "lastUpdate": "2018-03-22+14:20:41.56",
    "contentFile": "Ci8qCiAqCiAqIE1vcmUgaW5mbyBhdCBbd3d3LmRyb3B6b25lanMuY29tXShodHRwOi8vd3d3LmRyb3B6b25lanMuY29tKQogKgogKiBDb3B5cmlnaHQgKGMpIDIwMTIsIE1hdGlhcyBNZW5vCiAqCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgogKgogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICoKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKgogKi8KCihmdW5jdGlvbigpIHsKICB2YXIgRHJvcHpvbmUsIEVtaXR0ZXIsIGNhbWVsaXplLCBjb250ZW50TG9hZGVkLCBkZXRlY3RWZXJ0aWNhbFNxdWFzaCwgZHJhd0ltYWdlSU9TRml4LCBub29wLCB3aXRob3V0LAogICAgX19zbGljZSA9IFtdLnNsaWNlLAogICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksCiAgICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTsKCiAgbm9vcCA9IGZ1bmN0aW9uKCkge307CgogIEVtaXR0ZXIgPSAoZnVuY3Rpb24oKSB7CiAgICBmdW5jdGlvbiBFbWl0dGVyKCkge30KCiAgICBFbWl0dGVyLnByb3RvdHlwZS5hZGRFdmVudExpc3RlbmVyID0gRW1pdHRlci5wcm90b3R5cGUub247CgogICAgRW1pdHRlci5wcm90b3R5cGUub24gPSBmdW5jdGlvbihldmVudCwgZm4pIHsKICAgICAgdGhpcy5fY2FsbGJhY2tzID0gdGhpcy5fY2FsbGJhY2tzIHx8IHt9OwogICAgICBpZiAoIXRoaXMuX2NhbGxiYWNrc1tldmVudF0pIHsKICAgICAgICB0aGlzLl9jYWxsYmFja3NbZXZlbnRdID0gW107CiAgICAgIH0KICAgICAgdGhpcy5fY2FsbGJhY2tzW2V2ZW50XS5wdXNoKGZuKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKICAgIEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MsIGNhbGxiYWNrLCBjYWxsYmFja3MsIGV2ZW50LCBfaSwgX2xlbjsKICAgICAgZXZlbnQgPSBhcmd1bWVudHNbMF0sIGFyZ3MgPSAyIDw9IGFyZ3VtZW50cy5sZW5ndGggPyBfX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSA6IFtdOwogICAgICB0aGlzLl9jYWxsYmFja3MgPSB0aGlzLl9jYWxsYmFja3MgfHwge307CiAgICAgIGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrc1tldmVudF07CiAgICAgIGlmIChjYWxsYmFja3MpIHsKICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGNhbGxiYWNrcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFja3NbX2ldOwogICAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICBFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IEVtaXR0ZXIucHJvdG90eXBlLm9mZjsKCiAgICBFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBFbWl0dGVyLnByb3RvdHlwZS5vZmY7CgogICAgRW1pdHRlci5wcm90b3R5cGUucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IEVtaXR0ZXIucHJvdG90eXBlLm9mZjsKCiAgICBFbWl0dGVyLnByb3RvdHlwZS5vZmYgPSBmdW5jdGlvbihldmVudCwgZm4pIHsKICAgICAgdmFyIGNhbGxiYWNrLCBjYWxsYmFja3MsIGksIF9pLCBfbGVuOwogICAgICBpZiAoIXRoaXMuX2NhbGxiYWNrcyB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0ge307CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgY2FsbGJhY2tzID0gdGhpcy5fY2FsbGJhY2tzW2V2ZW50XTsKICAgICAgaWYgKCFjYWxsYmFja3MpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9jYWxsYmFja3NbZXZlbnRdOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGZvciAoaSA9IF9pID0gMCwgX2xlbiA9IGNhbGxiYWNrcy5sZW5ndGg7IF9pIDwgX2xlbjsgaSA9ICsrX2kpIHsKICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICBpZiAoY2FsbGJhY2sgPT09IGZuKSB7CiAgICAgICAgICBjYWxsYmFja3Muc3BsaWNlKGksIDEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCiAgICByZXR1cm4gRW1pdHRlcjsKCiAgfSkoKTsKCiAgRHJvcHpvbmUgPSAoZnVuY3Rpb24oX3N1cGVyKSB7CiAgICB2YXIgZXh0ZW5kLCByZXNvbHZlT3B0aW9uOwoKICAgIF9fZXh0ZW5kcyhEcm9wem9uZSwgX3N1cGVyKTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuRW1pdHRlciA9IEVtaXR0ZXI7CgoKICAgIC8qCiAgICBUaGlzIGlzIGEgbGlzdCBvZiBhbGwgYXZhaWxhYmxlIGV2ZW50cyB5b3UgY2FuIHJlZ2lzdGVyIG9uIGEgZHJvcHpvbmUgb2JqZWN0LgogICAgCiAgICBZb3UgY2FuIHJlZ2lzdGVyIGFuIGV2ZW50IGhhbmRsZXIgbGlrZSB0aGlzOgogICAgCiAgICAgICAgZHJvcHpvbmUub24oImRyYWdFbnRlciIsIGZ1bmN0aW9uKCkgeyB9KTsKICAgICAqLwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5ldmVudHMgPSBbImRyb3AiLCAiZHJhZ3N0YXJ0IiwgImRyYWdlbmQiLCAiZHJhZ2VudGVyIiwgImRyYWdvdmVyIiwgImRyYWdsZWF2ZSIsICJhZGRlZGZpbGUiLCAicmVtb3ZlZGZpbGUiLCAidGh1bWJuYWlsIiwgImVycm9yIiwgImVycm9ybXVsdGlwbGUiLCAicHJvY2Vzc2luZyIsICJwcm9jZXNzaW5nbXVsdGlwbGUiLCAidXBsb2FkcHJvZ3Jlc3MiLCAidG90YWx1cGxvYWRwcm9ncmVzcyIsICJzZW5kaW5nIiwgInNlbmRpbmdtdWx0aXBsZSIsICJzdWNjZXNzIiwgInN1Y2Nlc3NtdWx0aXBsZSIsICJjYW5jZWxlZCIsICJjYW5jZWxlZG11bHRpcGxlIiwgImNvbXBsZXRlIiwgImNvbXBsZXRlbXVsdGlwbGUiLCAicmVzZXQiLCAibWF4ZmlsZXNleGNlZWRlZCIsICJtYXhmaWxlc3JlYWNoZWQiLCAicXVldWVjb21wbGV0ZSJdOwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5kZWZhdWx0T3B0aW9ucyA9IHsKICAgICAgdXJsOiBudWxsLAogICAgICBtZXRob2Q6ICJwb3N0IiwKICAgICAgd2l0aENyZWRlbnRpYWxzOiBmYWxzZSwKICAgICAgcGFyYWxsZWxVcGxvYWRzOiAyLAogICAgICB1cGxvYWRNdWx0aXBsZTogZmFsc2UsCiAgICAgIG1heEZpbGVzaXplOiAyNTYsCiAgICAgIHBhcmFtTmFtZTogImZpbGUiLAogICAgICBjcmVhdGVJbWFnZVRodW1ibmFpbHM6IHRydWUsCiAgICAgIG1heFRodW1ibmFpbEZpbGVzaXplOiAxMCwKICAgICAgdGh1bWJuYWlsV2lkdGg6IDEyMCwKICAgICAgdGh1bWJuYWlsSGVpZ2h0OiAxMjAsCiAgICAgIGZpbGVzaXplQmFzZTogMTAwMCwKICAgICAgbWF4RmlsZXM6IG51bGwsCiAgICAgIGZpbGVzaXplQmFzZTogMTAwMCwKICAgICAgcGFyYW1zOiB7fSwKICAgICAgY2xpY2thYmxlOiB0cnVlLAogICAgICBpZ25vcmVIaWRkZW5GaWxlczogdHJ1ZSwKICAgICAgYWNjZXB0ZWRGaWxlczogbnVsbCwKICAgICAgYWNjZXB0ZWRNaW1lVHlwZXM6IG51bGwsCiAgICAgIGF1dG9Qcm9jZXNzUXVldWU6IHRydWUsCiAgICAgIGF1dG9RdWV1ZTogdHJ1ZSwKICAgICAgYWRkUmVtb3ZlTGlua3M6IGZhbHNlLAogICAgICBwcmV2aWV3c0NvbnRhaW5lcjogbnVsbCwKICAgICAgY2FwdHVyZTogbnVsbCwKICAgICAgZGljdERlZmF1bHRNZXNzYWdlOiAiRHJvcCBmaWxlcyBoZXJlIHRvIHVwbG9hZCIsCiAgICAgIGRpY3RGYWxsYmFja01lc3NhZ2U6ICJZb3VyIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBkcmFnJ24nZHJvcCBmaWxlIHVwbG9hZHMuIiwKICAgICAgZGljdEZhbGxiYWNrVGV4dDogIlBsZWFzZSB1c2UgdGhlIGZhbGxiYWNrIGZvcm0gYmVsb3cgdG8gdXBsb2FkIHlvdXIgZmlsZXMgbGlrZSBpbiB0aGUgb2xkZW4gZGF5cy4iLAogICAgICBkaWN0RmlsZVRvb0JpZzogIkZpbGUgaXMgdG9vIGJpZyAoe3tmaWxlc2l6ZX19TWlCKS4gTWF4IGZpbGVzaXplOiB7e21heEZpbGVzaXplfX1NaUIuIiwKICAgICAgZGljdEludmFsaWRGaWxlVHlwZTogIllvdSBjYW4ndCB1cGxvYWQgZmlsZXMgb2YgdGhpcyB0eXBlLiIsCiAgICAgIGRpY3RSZXNwb25zZUVycm9yOiAiU2VydmVyIHJlc3BvbmRlZCB3aXRoIHt7c3RhdHVzQ29kZX19IGNvZGUuIiwKICAgICAgZGljdENhbmNlbFVwbG9hZDogIkNhbmNlbCB1cGxvYWQiLAogICAgICBkaWN0Q2FuY2VsVXBsb2FkQ29uZmlybWF0aW9uOiAiQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGNhbmNlbCB0aGlzIHVwbG9hZD8iLAogICAgICBkaWN0UmVtb3ZlRmlsZTogIlJlbW92ZSBmaWxlIiwKICAgICAgZGljdFJlbW92ZUZpbGVDb25maXJtYXRpb246IG51bGwsCiAgICAgIGRpY3RNYXhGaWxlc0V4Y2VlZGVkOiAiWW91IGNhbiBub3QgdXBsb2FkIGFueSBtb3JlIGZpbGVzLiIsCiAgICAgIGFjY2VwdDogZnVuY3Rpb24oZmlsZSwgZG9uZSkgewogICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBub29wOwogICAgICB9LAogICAgICBmb3JjZUZhbGxiYWNrOiBmYWxzZSwKICAgICAgZmFsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjaGlsZCwgbWVzc2FnZUVsZW1lbnQsIHNwYW4sIF9pLCBfbGVuLCBfcmVmOwogICAgICAgIHRoaXMuZWxlbWVudC5jbGFzc05hbWUgPSAiIiArIHRoaXMuZWxlbWVudC5jbGFzc05hbWUgKyAiIGR6LWJyb3dzZXItbm90LXN1cHBvcnRlZCI7CiAgICAgICAgX3JlZiA9IHRoaXMuZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZGl2Iik7CiAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICBjaGlsZCA9IF9yZWZbX2ldOwogICAgICAgICAgaWYgKC8oXnwgKWR6LW1lc3NhZ2UoJHwgKS8udGVzdChjaGlsZC5jbGFzc05hbWUpKSB7CiAgICAgICAgICAgIG1lc3NhZ2VFbGVtZW50ID0gY2hpbGQ7CiAgICAgICAgICAgIGNoaWxkLmNsYXNzTmFtZSA9ICJkei1tZXNzYWdlIjsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghbWVzc2FnZUVsZW1lbnQpIHsKICAgICAgICAgIG1lc3NhZ2VFbGVtZW50ID0gRHJvcHpvbmUuY3JlYXRlRWxlbWVudCgiPGRpdiBjbGFzcz1cImR6LW1lc3NhZ2VcIj48c3Bhbj48L3NwYW4+PC9kaXY+Iik7CiAgICAgICAgICB0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQobWVzc2FnZUVsZW1lbnQpOwogICAgICAgIH0KICAgICAgICBzcGFuID0gbWVzc2FnZUVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInNwYW4iKVswXTsKICAgICAgICBpZiAoc3BhbikgewogICAgICAgICAgc3Bhbi50ZXh0Q29udGVudCA9IHRoaXMub3B0aW9ucy5kaWN0RmFsbGJhY2tNZXNzYWdlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKHRoaXMuZ2V0RmFsbGJhY2tGb3JtKCkpOwogICAgICB9LAogICAgICByZXNpemU6IGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgICB2YXIgaW5mbywgc3JjUmF0aW8sIHRyZ1JhdGlvOwogICAgICAgIGluZm8gPSB7CiAgICAgICAgICBzcmNYOiAwLAogICAgICAgICAgc3JjWTogMCwKICAgICAgICAgIHNyY1dpZHRoOiBmaWxlLndpZHRoLAogICAgICAgICAgc3JjSGVpZ2h0OiBmaWxlLmhlaWdodAogICAgICAgIH07CiAgICAgICAgc3JjUmF0aW8gPSBmaWxlLndpZHRoIC8gZmlsZS5oZWlnaHQ7CiAgICAgICAgaW5mby5vcHRXaWR0aCA9IHRoaXMub3B0aW9ucy50aHVtYm5haWxXaWR0aDsKICAgICAgICBpbmZvLm9wdEhlaWdodCA9IHRoaXMub3B0aW9ucy50aHVtYm5haWxIZWlnaHQ7CiAgICAgICAgaWYgKChpbmZvLm9wdFdpZHRoID09IG51bGwpICYmIChpbmZvLm9wdEhlaWdodCA9PSBudWxsKSkgewogICAgICAgICAgaW5mby5vcHRXaWR0aCA9IGluZm8uc3JjV2lkdGg7CiAgICAgICAgICBpbmZvLm9wdEhlaWdodCA9IGluZm8uc3JjSGVpZ2h0OwogICAgICAgIH0gZWxzZSBpZiAoaW5mby5vcHRXaWR0aCA9PSBudWxsKSB7CiAgICAgICAgICBpbmZvLm9wdFdpZHRoID0gc3JjUmF0aW8gKiBpbmZvLm9wdEhlaWdodDsKICAgICAgICB9IGVsc2UgaWYgKGluZm8ub3B0SGVpZ2h0ID09IG51bGwpIHsKICAgICAgICAgIGluZm8ub3B0SGVpZ2h0ID0gKDEgLyBzcmNSYXRpbykgKiBpbmZvLm9wdFdpZHRoOwogICAgICAgIH0KICAgICAgICB0cmdSYXRpbyA9IGluZm8ub3B0V2lkdGggLyBpbmZvLm9wdEhlaWdodDsKICAgICAgICBpZiAoZmlsZS5oZWlnaHQgPCBpbmZvLm9wdEhlaWdodCB8fCBmaWxlLndpZHRoIDwgaW5mby5vcHRXaWR0aCkgewogICAgICAgICAgaW5mby50cmdIZWlnaHQgPSBpbmZvLnNyY0hlaWdodDsKICAgICAgICAgIGluZm8udHJnV2lkdGggPSBpbmZvLnNyY1dpZHRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoc3JjUmF0aW8gPiB0cmdSYXRpbykgewogICAgICAgICAgICBpbmZvLnNyY0hlaWdodCA9IGZpbGUuaGVpZ2h0OwogICAgICAgICAgICBpbmZvLnNyY1dpZHRoID0gaW5mby5zcmNIZWlnaHQgKiB0cmdSYXRpbzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZm8uc3JjV2lkdGggPSBmaWxlLndpZHRoOwogICAgICAgICAgICBpbmZvLnNyY0hlaWdodCA9IGluZm8uc3JjV2lkdGggLyB0cmdSYXRpbzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5mby5zcmNYID0gKGZpbGUud2lkdGggLSBpbmZvLnNyY1dpZHRoKSAvIDI7CiAgICAgICAgaW5mby5zcmNZID0gKGZpbGUuaGVpZ2h0IC0gaW5mby5zcmNIZWlnaHQpIC8gMjsKICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgfSwKCiAgICAgIC8qCiAgICAgIFRob3NlIGZ1bmN0aW9ucyByZWdpc3RlciB0aGVtc2VsdmVzIHRvIHRoZSBldmVudHMgb24gaW5pdCBhbmQgaGFuZGxlIGFsbAogICAgICB0aGUgdXNlciBpbnRlcmZhY2Ugc3BlY2lmaWMgc3R1ZmYuIE92ZXJ3cml0aW5nIHRoZW0gd29uJ3QgYnJlYWsgdGhlIHVwbG9hZAogICAgICBidXQgY2FuIGJyZWFrIHRoZSB3YXkgaXQncyBkaXNwbGF5ZWQuCiAgICAgIFlvdSBjYW4gb3ZlcndyaXRlIHRoZW0gaWYgeW91IGRvbid0IGxpa2UgdGhlIGRlZmF1bHQgYmVoYXZpb3IuIElmIHlvdSBqdXN0CiAgICAgIHdhbnQgdG8gYWRkIGFuIGFkZGl0aW9uYWwgZXZlbnQgaGFuZGxlciwgcmVnaXN0ZXIgaXQgb24gdGhlIGRyb3B6b25lIG9iamVjdAogICAgICBhbmQgZG9uJ3Qgb3ZlcndyaXRlIHRob3NlIG9wdGlvbnMuCiAgICAgICAqLwogICAgICBkcm9wOiBmdW5jdGlvbihlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCJkei1kcmFnLWhvdmVyIik7CiAgICAgIH0sCiAgICAgIGRyYWdzdGFydDogbm9vcCwKICAgICAgZHJhZ2VuZDogZnVuY3Rpb24oZSkgewogICAgICAgIHJldHVybiB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgiZHotZHJhZy1ob3ZlciIpOwogICAgICB9LAogICAgICBkcmFnZW50ZXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoImR6LWRyYWctaG92ZXIiKTsKICAgICAgfSwKICAgICAgZHJhZ292ZXI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoImR6LWRyYWctaG92ZXIiKTsKICAgICAgfSwKICAgICAgZHJhZ2xlYXZlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCJkei1kcmFnLWhvdmVyIik7CiAgICAgIH0sCiAgICAgIHBhc3RlOiBub29wLAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCJkei1zdGFydGVkIik7CiAgICAgIH0sCiAgICAgIGFkZGVkZmlsZTogZnVuY3Rpb24oZmlsZSkgewogICAgICAgIHZhciBub2RlLCByZW1vdmVGaWxlRXZlbnQsIHJlbW92ZUxpbmssIF9pLCBfaiwgX2ssIF9sZW4sIF9sZW4xLCBfbGVuMiwgX3JlZiwgX3JlZjEsIF9yZWYyLCBfcmVzdWx0czsKICAgICAgICBpZiAodGhpcy5lbGVtZW50ID09PSB0aGlzLnByZXZpZXdzQ29udGFpbmVyKSB7CiAgICAgICAgICB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LmFkZCgiZHotc3RhcnRlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5wcmV2aWV3c0NvbnRhaW5lcikgewogICAgICAgICAgZmlsZS5wcmV2aWV3RWxlbWVudCA9IERyb3B6b25lLmNyZWF0ZUVsZW1lbnQodGhpcy5vcHRpb25zLnByZXZpZXdUZW1wbGF0ZS50cmltKCkpOwogICAgICAgICAgZmlsZS5wcmV2aWV3VGVtcGxhdGUgPSBmaWxlLnByZXZpZXdFbGVtZW50OwogICAgICAgICAgdGhpcy5wcmV2aWV3c0NvbnRhaW5lci5hcHBlbmRDaGlsZChmaWxlLnByZXZpZXdFbGVtZW50KTsKICAgICAgICAgIF9yZWYgPSBmaWxlLnByZXZpZXdFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIltkYXRhLWR6LW5hbWVdIik7CiAgICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgICAgbm9kZSA9IF9yZWZbX2ldOwogICAgICAgICAgICBub2RlLnRleHRDb250ZW50ID0gZmlsZS5uYW1lOwogICAgICAgICAgfQogICAgICAgICAgX3JlZjEgPSBmaWxlLnByZXZpZXdFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIltkYXRhLWR6LXNpemVdIik7CiAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBfcmVmMS5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICAgICAgbm9kZSA9IF9yZWYxW19qXTsKICAgICAgICAgICAgbm9kZS5pbm5lckhUTUwgPSB0aGlzLmZpbGVzaXplKGZpbGUuc2l6ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmFkZFJlbW92ZUxpbmtzKSB7CiAgICAgICAgICAgIGZpbGUuX3JlbW92ZUxpbmsgPSBEcm9wem9uZS5jcmVhdGVFbGVtZW50KCI8YSBjbGFzcz1cImR6LXJlbW92ZVwiIGhyZWY9XCJqYXZhc2NyaXB0OnVuZGVmaW5lZDtcIiBkYXRhLWR6LXJlbW92ZT4iICsgdGhpcy5vcHRpb25zLmRpY3RSZW1vdmVGaWxlICsgIjwvYT4iKTsKICAgICAgICAgICAgZmlsZS5wcmV2aWV3RWxlbWVudC5hcHBlbmRDaGlsZChmaWxlLl9yZW1vdmVMaW5rKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbW92ZUZpbGVFdmVudCA9IChmdW5jdGlvbihfdGhpcykgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIGlmIChmaWxlLnN0YXR1cyA9PT0gRHJvcHpvbmUuVVBMT0FESU5HKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRHJvcHpvbmUuY29uZmlybShfdGhpcy5vcHRpb25zLmRpY3RDYW5jZWxVcGxvYWRDb25maXJtYXRpb24sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucmVtb3ZlRmlsZShmaWxlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucy5kaWN0UmVtb3ZlRmlsZUNvbmZpcm1hdGlvbikgewogICAgICAgICAgICAgICAgICByZXR1cm4gRHJvcHpvbmUuY29uZmlybShfdGhpcy5vcHRpb25zLmRpY3RSZW1vdmVGaWxlQ29uZmlybWF0aW9uLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucmVtb3ZlRmlsZShmaWxlKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucmVtb3ZlRmlsZShmaWxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9KSh0aGlzKTsKICAgICAgICAgIF9yZWYyID0gZmlsZS5wcmV2aWV3RWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS1kei1yZW1vdmVdIik7CiAgICAgICAgICBfcmVzdWx0cyA9IFtdOwogICAgICAgICAgZm9yIChfayA9IDAsIF9sZW4yID0gX3JlZjIubGVuZ3RoOyBfayA8IF9sZW4yOyBfaysrKSB7CiAgICAgICAgICAgIHJlbW92ZUxpbmsgPSBfcmVmMltfa107CiAgICAgICAgICAgIF9yZXN1bHRzLnB1c2gocmVtb3ZlTGluay5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHJlbW92ZUZpbGVFdmVudCkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcmVtb3ZlZGZpbGU6IGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgICB2YXIgX3JlZjsKICAgICAgICBpZiAoZmlsZS5wcmV2aWV3RWxlbWVudCkgewogICAgICAgICAgaWYgKChfcmVmID0gZmlsZS5wcmV2aWV3RWxlbWVudCkgIT0gbnVsbCkgewogICAgICAgICAgICBfcmVmLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZmlsZS5wcmV2aWV3RWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVNYXhGaWxlc1JlYWNoZWRDbGFzcygpOwogICAgICB9LAogICAgICB0aHVtYm5haWw6IGZ1bmN0aW9uKGZpbGUsIGRhdGFVcmwpIHsKICAgICAgICB2YXIgdGh1bWJuYWlsRWxlbWVudCwgX2ksIF9sZW4sIF9yZWY7CiAgICAgICAgaWYgKGZpbGUucHJldmlld0VsZW1lbnQpIHsKICAgICAgICAgIGZpbGUucHJldmlld0VsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgiZHotZmlsZS1wcmV2aWV3Iik7CiAgICAgICAgICBfcmVmID0gZmlsZS5wcmV2aWV3RWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS1kei10aHVtYm5haWxdIik7CiAgICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgICAgdGh1bWJuYWlsRWxlbWVudCA9IF9yZWZbX2ldOwogICAgICAgICAgICB0aHVtYm5haWxFbGVtZW50LmFsdCA9IGZpbGUubmFtZTsKICAgICAgICAgICAgdGh1bWJuYWlsRWxlbWVudC5zcmMgPSBkYXRhVXJsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoKChmdW5jdGlvbihfdGhpcykgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZpbGUucHJldmlld0VsZW1lbnQuY2xhc3NMaXN0LmFkZCgiZHotaW1hZ2UtcHJldmlldyIpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSkodGhpcykpLCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGVycm9yOiBmdW5jdGlvbihmaWxlLCBtZXNzYWdlKSB7CiAgICAgICAgdmFyIG5vZGUsIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgICBpZiAoZmlsZS5wcmV2aWV3RWxlbWVudCkgewogICAgICAgICAgZmlsZS5wcmV2aWV3RWxlbWVudC5jbGFzc0xpc3QuYWRkKCJkei1lcnJvciIpOwogICAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAiU3RyaW5nIiAmJiBtZXNzYWdlLmVycm9yKSB7CiAgICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLmVycm9yOwogICAgICAgICAgfQogICAgICAgICAgX3JlZiA9IGZpbGUucHJldmlld0VsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgiW2RhdGEtZHotZXJyb3JtZXNzYWdlXSIpOwogICAgICAgICAgX3Jlc3VsdHMgPSBbXTsKICAgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgICAgICBub2RlID0gX3JlZltfaV07CiAgICAgICAgICAgIF9yZXN1bHRzLnB1c2gobm9kZS50ZXh0Q29udGVudCA9IG1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZXJyb3JtdWx0aXBsZTogbm9vcCwKICAgICAgcHJvY2Vzc2luZzogZnVuY3Rpb24oZmlsZSkgewogICAgICAgIGlmIChmaWxlLnByZXZpZXdFbGVtZW50KSB7CiAgICAgICAgICBmaWxlLnByZXZpZXdFbGVtZW50LmNsYXNzTGlzdC5hZGQoImR6LXByb2Nlc3NpbmciKTsKICAgICAgICAgIGlmIChmaWxlLl9yZW1vdmVMaW5rKSB7CiAgICAgICAgICAgIHJldHVybiBmaWxlLl9yZW1vdmVMaW5rLnRleHRDb250ZW50ID0gdGhpcy5vcHRpb25zLmRpY3RDYW5jZWxVcGxvYWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBwcm9jZXNzaW5nbXVsdGlwbGU6IG5vb3AsCiAgICAgIHVwbG9hZHByb2dyZXNzOiBmdW5jdGlvbihmaWxlLCBwcm9ncmVzcywgYnl0ZXNTZW50KSB7CiAgICAgICAgdmFyIG5vZGUsIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgICBpZiAoZmlsZS5wcmV2aWV3RWxlbWVudCkgewogICAgICAgICAgX3JlZiA9IGZpbGUucHJldmlld0VsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgiW2RhdGEtZHotdXBsb2FkcHJvZ3Jlc3NdIik7CiAgICAgICAgICBfcmVzdWx0cyA9IFtdOwogICAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICAgIG5vZGUgPSBfcmVmW19pXTsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZU5hbWUgPT09ICdQUk9HUkVTUycpIHsKICAgICAgICAgICAgICBfcmVzdWx0cy5wdXNoKG5vZGUudmFsdWUgPSBwcm9ncmVzcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgX3Jlc3VsdHMucHVzaChub2RlLnN0eWxlLndpZHRoID0gIiIgKyBwcm9ncmVzcyArICIlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBfcmVzdWx0czsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHRvdGFsdXBsb2FkcHJvZ3Jlc3M6IG5vb3AsCiAgICAgIHNlbmRpbmc6IG5vb3AsCiAgICAgIHNlbmRpbmdtdWx0aXBsZTogbm9vcCwKICAgICAgc3VjY2VzczogZnVuY3Rpb24oZmlsZSkgewogICAgICAgIGlmIChmaWxlLnByZXZpZXdFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gZmlsZS5wcmV2aWV3RWxlbWVudC5jbGFzc0xpc3QuYWRkKCJkei1zdWNjZXNzIik7CiAgICAgICAgfQogICAgICB9LAogICAgICBzdWNjZXNzbXVsdGlwbGU6IG5vb3AsCiAgICAgIGNhbmNlbGVkOiBmdW5jdGlvbihmaWxlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW1pdCgiZXJyb3IiLCBmaWxlLCAiVXBsb2FkIGNhbmNlbGVkLiIpOwogICAgICB9LAogICAgICBjYW5jZWxlZG11bHRpcGxlOiBub29wLAogICAgICBjb21wbGV0ZTogZnVuY3Rpb24oZmlsZSkgewogICAgICAgIGlmIChmaWxlLl9yZW1vdmVMaW5rKSB7CiAgICAgICAgICBmaWxlLl9yZW1vdmVMaW5rLnRleHRDb250ZW50ID0gdGhpcy5vcHRpb25zLmRpY3RSZW1vdmVGaWxlOwogICAgICAgIH0KICAgICAgICBpZiAoZmlsZS5wcmV2aWV3RWxlbWVudCkgewogICAgICAgICAgcmV0dXJuIGZpbGUucHJldmlld0VsZW1lbnQuY2xhc3NMaXN0LmFkZCgiZHotY29tcGxldGUiKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXBsZXRlbXVsdGlwbGU6IG5vb3AsCiAgICAgIG1heGZpbGVzZXhjZWVkZWQ6IG5vb3AsCiAgICAgIG1heGZpbGVzcmVhY2hlZDogbm9vcCwKICAgICAgcXVldWVjb21wbGV0ZTogbm9vcCwKICAgICAgcHJldmlld1RlbXBsYXRlOiAiPGRpdiBjbGFzcz1cImR6LXByZXZpZXcgZHotZmlsZS1wcmV2aWV3XCI+XG4gIDxkaXYgY2xhc3M9XCJkei1pbWFnZVwiPjxpbWcgZGF0YS1kei10aHVtYm5haWwgLz48L2Rpdj5cbiAgPGRpdiBjbGFzcz1cImR6LWRldGFpbHNcIj5cbiAgICA8ZGl2IGNsYXNzPVwiZHotc2l6ZVwiPjxzcGFuIGRhdGEtZHotc2l6ZT48L3NwYW4+PC9kaXY+XG4gICAgPGRpdiBjbGFzcz1cImR6LWZpbGVuYW1lXCI+PHNwYW4gZGF0YS1kei1uYW1lPjwvc3Bhbj48L2Rpdj5cbiAgPC9kaXY+XG4gIDxkaXYgY2xhc3M9XCJkei1wcm9ncmVzc1wiPjxzcGFuIGNsYXNzPVwiZHotdXBsb2FkXCIgZGF0YS1kei11cGxvYWRwcm9ncmVzcz48L3NwYW4+PC9kaXY+XG4gIDxkaXYgY2xhc3M9XCJkei1lcnJvci1tZXNzYWdlXCI+PHNwYW4gZGF0YS1kei1lcnJvcm1lc3NhZ2U+PC9zcGFuPjwvZGl2PlxuICA8ZGl2IGNsYXNzPVwiZHotc3VjY2Vzcy1tYXJrXCI+XG4gICAgPHN2ZyB3aWR0aD1cIjU0cHhcIiBoZWlnaHQ9XCI1NHB4XCIgdmlld0JveD1cIjAgMCA1NCA1NFwiIHZlcnNpb249XCIxLjFcIiB4bWxucz1cImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCIgeG1sbnM6eGxpbms9XCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rXCIgeG1sbnM6c2tldGNoPVwiaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zXCI+XG4gICAgICA8dGl0bGU+Q2hlY2s8L3RpdGxlPlxuICAgICAgPGRlZnM+PC9kZWZzPlxuICAgICAgPGcgaWQ9XCJQYWdlLTFcIiBzdHJva2U9XCJub25lXCIgc3Ryb2tlLXdpZHRoPVwiMVwiIGZpbGw9XCJub25lXCIgZmlsbC1ydWxlPVwiZXZlbm9kZFwiIHNrZXRjaDp0eXBlPVwiTVNQYWdlXCI+XG4gICAgICAgIDxwYXRoIGQ9XCJNMjMuNSwzMS44NDMxNDU4IEwxNy41ODUyNDE5LDI1LjkyODM4NzcgQzE2LjAyNDgyNTMsMjQuMzY3OTcxMSAxMy40OTEwMjk0LDI0LjM2NjgzNSAxMS45Mjg5MzIyLDI1LjkyODkzMjIgQzEwLjM3MDAxMzYsMjcuNDg3ODUwOCAxMC4zNjY1OTEyLDMwLjAyMzQ0NTUgMTEuOTI4Mzg3NywzMS41ODUyNDE5IEwyMC40MTQ3NTgxLDQwLjA3MTYxMjMgQzIwLjUxMzM5OTksNDAuMTcwMjU0MSAyMC42MTU5MzE1LDQwLjI2MjY2NDkgMjAuNzIxODYxNSw0MC4zNDg4NDM1IEMyMi4yODM1NjY5LDQxLjg3MjU2NTEgMjQuNzk0MjM0LDQxLjg2MjYyMDIgMjYuMzQ2MTU2NCw0MC4zMTA2OTc4IEw0My4zMTA2OTc4LDIzLjM0NjE1NjQgQzQ0Ljg3NzEwMjEsMjEuNzc5NzUyMSA0NC44NzU4MDU3LDE5LjI0ODM4ODcgNDMuMzEzNzA4NSwxNy42ODYyOTE1IEM0MS43NTQ3ODk5LDE2LjEyNzM3MjkgMzkuMjE3NjAzNSwxNi4xMjU1NDIyIDM3LjY1Mzg0MzYsMTcuNjg5MzAyMiBMMjMuNSwzMS44NDMxNDU4IFogTTI3LDUzIEM0MS4zNTk0MDM1LDUzIDUzLDQxLjM1OTQwMzUgNTMsMjcgQzUzLDEyLjY0MDU5NjUgNDEuMzU5NDAzNSwxIDI3LDEgQzEyLjY0MDU5NjUsMSAxLDEyLjY0MDU5NjUgMSwyNyBDMSw0MS4zNTk0MDM1IDEyLjY0MDU5NjUsNTMgMjcsNTMgWlwiIGlkPVwiT3ZhbC0yXCIgc3Ryb2tlLW9wYWNpdHk9XCIwLjE5ODc5NDE1OFwiIHN0cm9rZT1cIiM3NDc0NzRcIiBmaWxsLW9wYWNpdHk9XCIwLjgxNjUxOTQ3NVwiIGZpbGw9XCIjRkZGRkZGXCIgc2tldGNoOnR5cGU9XCJNU1NoYXBlR3JvdXBcIj48L3BhdGg+XG4gICAgICA8L2c+XG4gICAgPC9zdmc+XG4gIDwvZGl2PlxuICA8ZGl2IGNsYXNzPVwiZHotZXJyb3ItbWFya1wiPlxuICAgIDxzdmcgd2lkdGg9XCI1NHB4XCIgaGVpZ2h0PVwiNTRweFwiIHZpZXdCb3g9XCIwIDAgNTQgNTRcIiB2ZXJzaW9uPVwiMS4xXCIgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiIHhtbG5zOnhsaW5rPVwiaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGlua1wiIHhtbG5zOnNrZXRjaD1cImh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaC9uc1wiPlxuICAgICAgPHRpdGxlPkVycm9yPC90aXRsZT5cbiAgICAgIDxkZWZzPjwvZGVmcz5cbiAgICAgIDxnIGlkPVwiUGFnZS0xXCIgc3Ryb2tlPVwibm9uZVwiIHN0cm9rZS13aWR0aD1cIjFcIiBmaWxsPVwibm9uZVwiIGZpbGwtcnVsZT1cImV2ZW5vZGRcIiBza2V0Y2g6dHlwZT1cIk1TUGFnZVwiPlxuICAgICAgICA8ZyBpZD1cIkNoZWNrLSstT3ZhbC0yXCIgc2tldGNoOnR5cGU9XCJNU0xheWVyR3JvdXBcIiBzdHJva2U9XCIjNzQ3NDc0XCIgc3Ryb2tlLW9wYWNpdHk9XCIwLjE5ODc5NDE1OFwiIGZpbGw9XCIjRkZGRkZGXCIgZmlsbC1vcGFjaXR5PVwiMC44MTY1MTk0NzVcIj5cbiAgICAgICAgICA8cGF0aCBkPVwiTTMyLjY1Njg1NDIsMjkgTDM4LjMxMDY5NzgsMjMuMzQ2MTU2NCBDMzkuODc3MTAyMSwyMS43Nzk3NTIxIDM5Ljg3NTgwNTcsMTkuMjQ4Mzg4NyAzOC4zMTM3MDg1LDE3LjY4NjI5MTUgQzM2Ljc1NDc4OTksMTYuMTI3MzcyOSAzNC4yMTc2MDM1LDE2LjEyNTU0MjIgMzIuNjUzODQzNiwxNy42ODkzMDIyIEwyNywyMy4zNDMxNDU4IEwyMS4zNDYxNTY0LDE3LjY4OTMwMjIgQzE5Ljc4MjM5NjUsMTYuMTI1NTQyMiAxNy4yNDUyMTAxLDE2LjEyNzM3MjkgMTUuNjg2MjkxNSwxNy42ODYyOTE1IEMxNC4xMjQxOTQzLDE5LjI0ODM4ODcgMTQuMTIyODk3OSwyMS43Nzk3NTIxIDE1LjY4OTMwMjIsMjMuMzQ2MTU2NCBMMjEuMzQzMTQ1OCwyOSBMMTUuNjg5MzAyMiwzNC42NTM4NDM2IEMxNC4xMjI4OTc5LDM2LjIyMDI0NzkgMTQuMTI0MTk0MywzOC43NTE2MTEzIDE1LjY4NjI5MTUsNDAuMzEzNzA4NSBDMTcuMjQ1MjEwMSw0MS44NzI2MjcxIDE5Ljc4MjM5NjUsNDEuODc0NDU3OCAyMS4zNDYxNTY0LDQwLjMxMDY5NzggTDI3LDM0LjY1Njg1NDIgTDMyLjY1Mzg0MzYsNDAuMzEwNjk3OCBDMzQuMjE3NjAzNSw0MS44NzQ0NTc4IDM2Ljc1NDc4OTksNDEuODcyNjI3MSAzOC4zMTM3MDg1LDQwLjMxMzcwODUgQzM5Ljg3NTgwNTcsMzguNzUxNjExMyAzOS44NzcxMDIxLDM2LjIyMDI0NzkgMzguMzEwNjk3OCwzNC42NTM4NDM2IEwzMi42NTY4NTQyLDI5IFogTTI3LDUzIEM0MS4zNTk0MDM1LDUzIDUzLDQxLjM1OTQwMzUgNTMsMjcgQzUzLDEyLjY0MDU5NjUgNDEuMzU5NDAzNSwxIDI3LDEgQzEyLjY0MDU5NjUsMSAxLDEyLjY0MDU5NjUgMSwyNyBDMSw0MS4zNTk0MDM1IDEyLjY0MDU5NjUsNTMgMjcsNTMgWlwiIGlkPVwiT3ZhbC0yXCIgc2tldGNoOnR5cGU9XCJNU1NoYXBlR3JvdXBcIj48L3BhdGg+XG4gICAgICAgIDwvZz5cbiAgICAgIDwvZz5cbiAgICA8L3N2Zz5cbiAgPC9kaXY+XG48L2Rpdj4iCiAgICB9OwoKICAgIGV4dGVuZCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIga2V5LCBvYmplY3QsIG9iamVjdHMsIHRhcmdldCwgdmFsLCBfaSwgX2xlbjsKICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzWzBdLCBvYmplY3RzID0gMiA8PSBhcmd1bWVudHMubGVuZ3RoID8gX19zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgOiBbXTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBvYmplY3RzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgb2JqZWN0ID0gb2JqZWN0c1tfaV07CiAgICAgICAgZm9yIChrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgICB2YWwgPSBvYmplY3Rba2V5XTsKICAgICAgICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfTsKCiAgICBmdW5jdGlvbiBEcm9wem9uZShlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBlbGVtZW50T3B0aW9ucywgZmFsbGJhY2ssIF9yZWY7CiAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgIHRoaXMudmVyc2lvbiA9IERyb3B6b25lLnZlcnNpb247CiAgICAgIHRoaXMuZGVmYXVsdE9wdGlvbnMucHJldmlld1RlbXBsYXRlID0gdGhpcy5kZWZhdWx0T3B0aW9ucy5wcmV2aWV3VGVtcGxhdGUucmVwbGFjZSgvXG4qL2csICIiKTsKICAgICAgdGhpcy5jbGlja2FibGVFbGVtZW50cyA9IFtdOwogICAgICB0aGlzLmxpc3RlbmVycyA9IFtdOwogICAgICB0aGlzLmZpbGVzID0gW107CiAgICAgIGlmICh0eXBlb2YgdGhpcy5lbGVtZW50ID09PSAic3RyaW5nIikgewogICAgICAgIHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5lbGVtZW50KTsKICAgICAgfQogICAgICBpZiAoISh0aGlzLmVsZW1lbnQgJiYgKHRoaXMuZWxlbWVudC5ub2RlVHlwZSAhPSBudWxsKSkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZHJvcHpvbmUgZWxlbWVudC4iKTsKICAgICAgfQogICAgICBpZiAodGhpcy5lbGVtZW50LmRyb3B6b25lKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEcm9wem9uZSBhbHJlYWR5IGF0dGFjaGVkLiIpOwogICAgICB9CiAgICAgIERyb3B6b25lLmluc3RhbmNlcy5wdXNoKHRoaXMpOwogICAgICB0aGlzLmVsZW1lbnQuZHJvcHpvbmUgPSB0aGlzOwogICAgICBlbGVtZW50T3B0aW9ucyA9IChfcmVmID0gRHJvcHpvbmUub3B0aW9uc0ZvckVsZW1lbnQodGhpcy5lbGVtZW50KSkgIT0gbnVsbCA\/IF9yZWYgOiB7fTsKICAgICAgdGhpcy5vcHRpb25zID0gZXh0ZW5kKHt9LCB0aGlzLmRlZmF1bHRPcHRpb25zLCBlbGVtZW50T3B0aW9ucywgb3B0aW9ucyAhPSBudWxsID8gb3B0aW9ucyA6IHt9KTsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5mb3JjZUZhbGxiYWNrIHx8ICFEcm9wem9uZS5pc0Jyb3dzZXJTdXBwb3J0ZWQoKSkgewogICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZmFsbGJhY2suY2FsbCh0aGlzKTsKICAgICAgfQogICAgICBpZiAodGhpcy5vcHRpb25zLnVybCA9PSBudWxsKSB7CiAgICAgICAgdGhpcy5vcHRpb25zLnVybCA9IHRoaXMuZWxlbWVudC5nZXRBdHRyaWJ1dGUoImFjdGlvbiIpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5vcHRpb25zLnVybCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gVVJMIHByb3ZpZGVkLiIpOwogICAgICB9CiAgICAgIGlmICh0aGlzLm9wdGlvbnMuYWNjZXB0ZWRGaWxlcyAmJiB0aGlzLm9wdGlvbnMuYWNjZXB0ZWRNaW1lVHlwZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIllvdSBjYW4ndCBwcm92aWRlIGJvdGggJ2FjY2VwdGVkRmlsZXMnIGFuZCAnYWNjZXB0ZWRNaW1lVHlwZXMnLiAnYWNjZXB0ZWRNaW1lVHlwZXMnIGlzIGRlcHJlY2F0ZWQuIik7CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5hY2NlcHRlZE1pbWVUeXBlcykgewogICAgICAgIHRoaXMub3B0aW9ucy5hY2NlcHRlZEZpbGVzID0gdGhpcy5vcHRpb25zLmFjY2VwdGVkTWltZVR5cGVzOwogICAgICAgIGRlbGV0ZSB0aGlzLm9wdGlvbnMuYWNjZXB0ZWRNaW1lVHlwZXM7CiAgICAgIH0KICAgICAgdGhpcy5vcHRpb25zLm1ldGhvZCA9IHRoaXMub3B0aW9ucy5tZXRob2QudG9VcHBlckNhc2UoKTsKICAgICAgaWYgKChmYWxsYmFjayA9IHRoaXMuZ2V0RXhpc3RpbmdGYWxsYmFjaygpKSAmJiBmYWxsYmFjay5wYXJlbnROb2RlKSB7CiAgICAgICAgZmFsbGJhY2sucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChmYWxsYmFjayk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5wcmV2aWV3c0NvbnRhaW5lciAhPT0gZmFsc2UpIHsKICAgICAgICBpZiAodGhpcy5vcHRpb25zLnByZXZpZXdzQ29udGFpbmVyKSB7CiAgICAgICAgICB0aGlzLnByZXZpZXdzQ29udGFpbmVyID0gRHJvcHpvbmUuZ2V0RWxlbWVudCh0aGlzLm9wdGlvbnMucHJldmlld3NDb250YWluZXIsICJwcmV2aWV3c0NvbnRhaW5lciIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnByZXZpZXdzQ29udGFpbmVyID0gdGhpcy5lbGVtZW50OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodGhpcy5vcHRpb25zLmNsaWNrYWJsZSkgewogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY2xpY2thYmxlID09PSB0cnVlKSB7CiAgICAgICAgICB0aGlzLmNsaWNrYWJsZUVsZW1lbnRzID0gW3RoaXMuZWxlbWVudF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2xpY2thYmxlRWxlbWVudHMgPSBEcm9wem9uZS5nZXRFbGVtZW50cyh0aGlzLm9wdGlvbnMuY2xpY2thYmxlLCAiY2xpY2thYmxlIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaW5pdCgpOwogICAgfQoKICAgIERyb3B6b25lLnByb3RvdHlwZS5nZXRBY2NlcHRlZEZpbGVzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBmaWxlLCBfaSwgX2xlbiwgX3JlZiwgX3Jlc3VsdHM7CiAgICAgIF9yZWYgPSB0aGlzLmZpbGVzOwogICAgICBfcmVzdWx0cyA9IFtdOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBmaWxlID0gX3JlZltfaV07CiAgICAgICAgaWYgKGZpbGUuYWNjZXB0ZWQpIHsKICAgICAgICAgIF9yZXN1bHRzLnB1c2goZmlsZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBfcmVzdWx0czsKICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLmdldFJlamVjdGVkRmlsZXMgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGZpbGUsIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgX3JlZiA9IHRoaXMuZmlsZXM7CiAgICAgIF9yZXN1bHRzID0gW107CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGZpbGUgPSBfcmVmW19pXTsKICAgICAgICBpZiAoIWZpbGUuYWNjZXB0ZWQpIHsKICAgICAgICAgIF9yZXN1bHRzLnB1c2goZmlsZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBfcmVzdWx0czsKICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLmdldEZpbGVzV2l0aFN0YXR1cyA9IGZ1bmN0aW9uKHN0YXR1cykgewogICAgICB2YXIgZmlsZSwgX2ksIF9sZW4sIF9yZWYsIF9yZXN1bHRzOwogICAgICBfcmVmID0gdGhpcy5maWxlczsKICAgICAgX3Jlc3VsdHMgPSBbXTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgZmlsZSA9IF9yZWZbX2ldOwogICAgICAgIGlmIChmaWxlLnN0YXR1cyA9PT0gc3RhdHVzKSB7CiAgICAgICAgICBfcmVzdWx0cy5wdXNoKGZpbGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5nZXRRdWV1ZWRGaWxlcyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRGaWxlc1dpdGhTdGF0dXMoRHJvcHpvbmUuUVVFVUVEKTsKICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLmdldFVwbG9hZGluZ0ZpbGVzID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldEZpbGVzV2l0aFN0YXR1cyhEcm9wem9uZS5VUExPQURJTkcpOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuZ2V0QWN0aXZlRmlsZXMgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGZpbGUsIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgX3JlZiA9IHRoaXMuZmlsZXM7CiAgICAgIF9yZXN1bHRzID0gW107CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGZpbGUgPSBfcmVmW19pXTsKICAgICAgICBpZiAoZmlsZS5zdGF0dXMgPT09IERyb3B6b25lLlVQTE9BRElORyB8fCBmaWxlLnN0YXR1cyA9PT0gRHJvcHpvbmUuUVVFVUVEKSB7CiAgICAgICAgICBfcmVzdWx0cy5wdXNoKGZpbGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBldmVudE5hbWUsIG5vUHJvcGFnYXRpb24sIHNldHVwSGlkZGVuRmlsZUlucHV0LCBfaSwgX2xlbiwgX3JlZiwgX3JlZjE7CiAgICAgIGlmICh0aGlzLmVsZW1lbnQudGFnTmFtZSA9PT0gImZvcm0iKSB7CiAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgiZW5jdHlwZSIsICJtdWx0aXBhcnQvZm9ybS1kYXRhIik7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoImRyb3B6b25lIikgJiYgIXRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKCIuZHotbWVzc2FnZSIpKSB7CiAgICAgICAgdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKERyb3B6b25lLmNyZWF0ZUVsZW1lbnQoIjxkaXYgY2xhc3M9XCJkei1kZWZhdWx0IGR6LW1lc3NhZ2VcIj48c3Bhbj4iICsgdGhpcy5vcHRpb25zLmRpY3REZWZhdWx0TWVzc2FnZSArICI8L3NwYW4+PC9kaXY+IikpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmNsaWNrYWJsZUVsZW1lbnRzLmxlbmd0aCkgewogICAgICAgIHNldHVwSGlkZGVuRmlsZUlucHV0ID0gKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChfdGhpcy5oaWRkZW5GaWxlSW5wdXQpIHsKICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKF90aGlzLmhpZGRlbkZpbGVJbnB1dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RoaXMuaGlkZGVuRmlsZUlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgX3RoaXMuaGlkZGVuRmlsZUlucHV0LnNldEF0dHJpYnV0ZSgidHlwZSIsICJmaWxlIik7CiAgICAgICAgICAgIGlmICgoX3RoaXMub3B0aW9ucy5tYXhGaWxlcyA9PSBudWxsKSB8fCBfdGhpcy5vcHRpb25zLm1heEZpbGVzID4gMSkgewogICAgICAgICAgICAgIF90aGlzLmhpZGRlbkZpbGVJbnB1dC5zZXRBdHRyaWJ1dGUoIm11bHRpcGxlIiwgIm11bHRpcGxlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgX3RoaXMuaGlkZGVuRmlsZUlucHV0LmNsYXNzTmFtZSA9ICJkei1oaWRkZW4taW5wdXQiOwogICAgICAgICAgICBpZiAoX3RoaXMub3B0aW9ucy5hY2NlcHRlZEZpbGVzICE9IG51bGwpIHsKICAgICAgICAgICAgICBfdGhpcy5oaWRkZW5GaWxlSW5wdXQuc2V0QXR0cmlidXRlKCJhY2NlcHQiLCBfdGhpcy5vcHRpb25zLmFjY2VwdGVkRmlsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25zLmNhcHR1cmUgIT0gbnVsbCkgewogICAgICAgICAgICAgIF90aGlzLmhpZGRlbkZpbGVJbnB1dC5zZXRBdHRyaWJ1dGUoImNhcHR1cmUiLCBfdGhpcy5vcHRpb25zLmNhcHR1cmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF90aGlzLmhpZGRlbkZpbGVJbnB1dC5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgICAgICAgIF90aGlzLmhpZGRlbkZpbGVJbnB1dC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgICAgIF90aGlzLmhpZGRlbkZpbGVJbnB1dC5zdHlsZS50b3AgPSAiMCI7CiAgICAgICAgICAgIF90aGlzLmhpZGRlbkZpbGVJbnB1dC5zdHlsZS5sZWZ0ID0gIjAiOwogICAgICAgICAgICBfdGhpcy5oaWRkZW5GaWxlSW5wdXQuc3R5bGUuaGVpZ2h0ID0gIjAiOwogICAgICAgICAgICBfdGhpcy5oaWRkZW5GaWxlSW5wdXQuc3R5bGUud2lkdGggPSAiMCI7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoX3RoaXMuaGlkZGVuRmlsZUlucHV0KTsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLmhpZGRlbkZpbGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgZmlsZSwgZmlsZXMsIF9pLCBfbGVuOwogICAgICAgICAgICAgIGZpbGVzID0gX3RoaXMuaGlkZGVuRmlsZUlucHV0LmZpbGVzOwogICAgICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZmlsZXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgICAgICAgICAgZmlsZSA9IGZpbGVzW19pXTsKICAgICAgICAgICAgICAgICAgX3RoaXMuYWRkRmlsZShmaWxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHNldHVwSGlkZGVuRmlsZUlucHV0KCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9KSh0aGlzKTsKICAgICAgICBzZXR1cEhpZGRlbkZpbGVJbnB1dCgpOwogICAgICB9CiAgICAgIHRoaXMuVVJMID0gKF9yZWYgPSB3aW5kb3cuVVJMKSAhPSBudWxsID8gX3JlZiA6IHdpbmRvdy53ZWJraXRVUkw7CiAgICAgIF9yZWYxID0gdGhpcy5ldmVudHM7CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZjEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBldmVudE5hbWUgPSBfcmVmMVtfaV07CiAgICAgICAgdGhpcy5vbihldmVudE5hbWUsIHRoaXMub3B0aW9uc1tldmVudE5hbWVdKTsKICAgICAgfQogICAgICB0aGlzLm9uKCJ1cGxvYWRwcm9ncmVzcyIsIChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGVUb3RhbFVwbG9hZFByb2dyZXNzKCk7CiAgICAgICAgfTsKICAgICAgfSkodGhpcykpOwogICAgICB0aGlzLm9uKCJyZW1vdmVkZmlsZSIsIChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGVUb3RhbFVwbG9hZFByb2dyZXNzKCk7CiAgICAgICAgfTsKICAgICAgfSkodGhpcykpOwogICAgICB0aGlzLm9uKCJjYW5jZWxlZCIsIChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlKSB7CiAgICAgICAgICByZXR1cm4gX3RoaXMuZW1pdCgiY29tcGxldGUiLCBmaWxlKTsKICAgICAgICB9OwogICAgICB9KSh0aGlzKSk7CiAgICAgIHRoaXMub24oImNvbXBsZXRlIiwgKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgICAgIGlmIChfdGhpcy5nZXRVcGxvYWRpbmdGaWxlcygpLmxlbmd0aCA9PT0gMCAmJiBfdGhpcy5nZXRRdWV1ZWRGaWxlcygpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gc2V0VGltZW91dCgoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmVtaXQoInF1ZXVlY29tcGxldGUiKTsKICAgICAgICAgICAgfSksIDApOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0pKHRoaXMpKTsKICAgICAgbm9Qcm9wYWdhdGlvbiA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICByZXR1cm4gZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgdGhpcy5saXN0ZW5lcnMgPSBbCiAgICAgICAgewogICAgICAgICAgZWxlbWVudDogdGhpcy5lbGVtZW50LAogICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICJkcmFnc3RhcnQiOiAoZnVuY3Rpb24oX3RoaXMpIHsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmVtaXQoImRyYWdzdGFydCIsIGUpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pKHRoaXMpLAogICAgICAgICAgICAiZHJhZ2VudGVyIjogKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIG5vUHJvcGFnYXRpb24oZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZW1pdCgiZHJhZ2VudGVyIiwgZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSkodGhpcyksCiAgICAgICAgICAgICJkcmFnb3ZlciI6IChmdW5jdGlvbihfdGhpcykgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgZWZjdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGVmY3QgPSBlLmRhdGFUcmFuc2Zlci5lZmZlY3RBbGxvd2VkOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoX2Vycm9yKSB7fQogICAgICAgICAgICAgICAgZS5kYXRhVHJhbnNmZXIuZHJvcEVmZmVjdCA9ICdtb3ZlJyA9PT0gZWZjdCB8fCAnbGlua01vdmUnID09PSBlZmN0ID8gJ21vdmUnIDogJ2NvcHknOwogICAgICAgICAgICAgICAgbm9Qcm9wYWdhdGlvbihlKTsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5lbWl0KCJkcmFnb3ZlciIsIGUpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pKHRoaXMpLAogICAgICAgICAgICAiZHJhZ2xlYXZlIjogKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5lbWl0KCJkcmFnbGVhdmUiLCBlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KSh0aGlzKSwKICAgICAgICAgICAgImRyb3AiOiAoZnVuY3Rpb24oX3RoaXMpIHsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgbm9Qcm9wYWdhdGlvbihlKTsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5kcm9wKGUpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pKHRoaXMpLAogICAgICAgICAgICAiZHJhZ2VuZCI6IChmdW5jdGlvbihfdGhpcykgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZW1pdCgiZHJhZ2VuZCIsIGUpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pKHRoaXMpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICBdOwogICAgICB0aGlzLmNsaWNrYWJsZUVsZW1lbnRzLmZvckVhY2goKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNsaWNrYWJsZUVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBfdGhpcy5saXN0ZW5lcnMucHVzaCh7CiAgICAgICAgICAgIGVsZW1lbnQ6IGNsaWNrYWJsZUVsZW1lbnQsCiAgICAgICAgICAgIGV2ZW50czogewogICAgICAgICAgICAgICJjbGljayI6IGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAgICAgICAgaWYgKChjbGlja2FibGVFbGVtZW50ICE9PSBfdGhpcy5lbGVtZW50KSB8fCAoZXZ0LnRhcmdldCA9PT0gX3RoaXMuZWxlbWVudCB8fCBEcm9wem9uZS5lbGVtZW50SW5zaWRlKGV2dC50YXJnZXQsIF90aGlzLmVsZW1lbnQucXVlcnlTZWxlY3RvcigiLmR6LW1lc3NhZ2UiKSkpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5oaWRkZW5GaWxlSW5wdXQuY2xpY2soKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgIH0pKHRoaXMpKTsKICAgICAgdGhpcy5lbmFibGUoKTsKICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5pbml0LmNhbGwodGhpcyk7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBfcmVmOwogICAgICB0aGlzLmRpc2FibGUoKTsKICAgICAgdGhpcy5yZW1vdmVBbGxGaWxlcyh0cnVlKTsKICAgICAgaWYgKChfcmVmID0gdGhpcy5oaWRkZW5GaWxlSW5wdXQpICE9IG51bGwgPyBfcmVmLnBhcmVudE5vZGUgOiB2b2lkIDApIHsKICAgICAgICB0aGlzLmhpZGRlbkZpbGVJbnB1dC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuaGlkZGVuRmlsZUlucHV0KTsKICAgICAgICB0aGlzLmhpZGRlbkZpbGVJbnB1dCA9IG51bGw7CiAgICAgIH0KICAgICAgZGVsZXRlIHRoaXMuZWxlbWVudC5kcm9wem9uZTsKICAgICAgcmV0dXJuIERyb3B6b25lLmluc3RhbmNlcy5zcGxpY2UoRHJvcHpvbmUuaW5zdGFuY2VzLmluZGV4T2YodGhpcyksIDEpOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUudXBkYXRlVG90YWxVcGxvYWRQcm9ncmVzcyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYWN0aXZlRmlsZXMsIGZpbGUsIHRvdGFsQnl0ZXMsIHRvdGFsQnl0ZXNTZW50LCB0b3RhbFVwbG9hZFByb2dyZXNzLCBfaSwgX2xlbiwgX3JlZjsKICAgICAgdG90YWxCeXRlc1NlbnQgPSAwOwogICAgICB0b3RhbEJ5dGVzID0gMDsKICAgICAgYWN0aXZlRmlsZXMgPSB0aGlzLmdldEFjdGl2ZUZpbGVzKCk7CiAgICAgIGlmIChhY3RpdmVGaWxlcy5sZW5ndGgpIHsKICAgICAgICBfcmVmID0gdGhpcy5nZXRBY3RpdmVGaWxlcygpOwogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgICAgZmlsZSA9IF9yZWZbX2ldOwogICAgICAgICAgdG90YWxCeXRlc1NlbnQgKz0gZmlsZS51cGxvYWQuYnl0ZXNTZW50OwogICAgICAgICAgdG90YWxCeXRlcyArPSBmaWxlLnVwbG9hZC50b3RhbDsKICAgICAgICB9CiAgICAgICAgdG90YWxVcGxvYWRQcm9ncmVzcyA9IDEwMCAqIHRvdGFsQnl0ZXNTZW50IC8gdG90YWxCeXRlczsKICAgICAgfSBlbHNlIHsKICAgICAgICB0b3RhbFVwbG9hZFByb2dyZXNzID0gMTAwOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVtaXQoInRvdGFsdXBsb2FkcHJvZ3Jlc3MiLCB0b3RhbFVwbG9hZFByb2dyZXNzLCB0b3RhbEJ5dGVzLCB0b3RhbEJ5dGVzU2VudCk7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5fZ2V0UGFyYW1OYW1lID0gZnVuY3Rpb24obikgewogICAgICBpZiAodHlwZW9mIHRoaXMub3B0aW9ucy5wYXJhbU5hbWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLnBhcmFtTmFtZShuKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gIiIgKyB0aGlzLm9wdGlvbnMucGFyYW1OYW1lICsgKHRoaXMub3B0aW9ucy51cGxvYWRNdWx0aXBsZSA\/ICJbIiArIG4gKyAiXSIgOiAiIik7CiAgICAgIH0KICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLmdldEZhbGxiYWNrRm9ybSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZXhpc3RpbmdGYWxsYmFjaywgZmllbGRzLCBmaWVsZHNTdHJpbmcsIGZvcm07CiAgICAgIGlmIChleGlzdGluZ0ZhbGxiYWNrID0gdGhpcy5nZXRFeGlzdGluZ0ZhbGxiYWNrKCkpIHsKICAgICAgICByZXR1cm4gZXhpc3RpbmdGYWxsYmFjazsKICAgICAgfQogICAgICBmaWVsZHNTdHJpbmcgPSAiPGRpdiBjbGFzcz1cImR6LWZhbGxiYWNrXCI+IjsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5kaWN0RmFsbGJhY2tUZXh0KSB7CiAgICAgICAgZmllbGRzU3RyaW5nICs9ICI8cD4iICsgdGhpcy5vcHRpb25zLmRpY3RGYWxsYmFja1RleHQgKyAiPC9wPiI7CiAgICAgIH0KICAgICAgZmllbGRzU3RyaW5nICs9ICI8aW5wdXQgdHlwZT1cImZpbGVcIiBuYW1lPVwiIiArICh0aGlzLl9nZXRQYXJhbU5hbWUoMCkpICsgIlwiICIgKyAodGhpcy5vcHRpb25zLnVwbG9hZE11bHRpcGxlID8gJ211bHRpcGxlPSJtdWx0aXBsZSInIDogdm9pZCAwKSArICIgLz48aW5wdXQgdHlwZT1cInN1Ym1pdFwiIHZhbHVlPVwiVXBsb2FkIVwiPjwvZGl2PiI7CiAgICAgIGZpZWxkcyA9IERyb3B6b25lLmNyZWF0ZUVsZW1lbnQoZmllbGRzU3RyaW5nKTsKICAgICAgaWYgKHRoaXMuZWxlbWVudC50YWdOYW1lICE9PSAiRk9STSIpIHsKICAgICAgICBmb3JtID0gRHJvcHpvbmUuY3JlYXRlRWxlbWVudCgiPGZvcm0gYWN0aW9uPVwiIiArIHRoaXMub3B0aW9ucy51cmwgKyAiXCIgZW5jdHlwZT1cIm11bHRpcGFydC9mb3JtLWRhdGFcIiBtZXRob2Q9XCIiICsgdGhpcy5vcHRpb25zLm1ldGhvZCArICJcIj48L2Zvcm0+Iik7CiAgICAgICAgZm9ybS5hcHBlbmRDaGlsZChmaWVsZHMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoImVuY3R5cGUiLCAibXVsdGlwYXJ0L2Zvcm0tZGF0YSIpOwogICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoIm1ldGhvZCIsIHRoaXMub3B0aW9ucy5tZXRob2QpOwogICAgICB9CiAgICAgIHJldHVybiBmb3JtICE9IG51bGwgPyBmb3JtIDogZmllbGRzOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuZ2V0RXhpc3RpbmdGYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZmFsbGJhY2ssIGdldEZhbGxiYWNrLCB0YWdOYW1lLCBfaSwgX2xlbiwgX3JlZjsKICAgICAgZ2V0RmFsbGJhY2sgPSBmdW5jdGlvbihlbGVtZW50cykgewogICAgICAgIHZhciBlbCwgX2ksIF9sZW47CiAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBlbGVtZW50cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgICAgZWwgPSBlbGVtZW50c1tfaV07CiAgICAgICAgICBpZiAoLyhefCApZmFsbGJhY2soJHwgKS8udGVzdChlbC5jbGFzc05hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIF9yZWYgPSBbImRpdiIsICJmb3JtIl07CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIHRhZ05hbWUgPSBfcmVmW19pXTsKICAgICAgICBpZiAoZmFsbGJhY2sgPSBnZXRGYWxsYmFjayh0aGlzLmVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSkpKSB7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2s7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5zZXR1cEV2ZW50TGlzdGVuZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbGVtZW50TGlzdGVuZXJzLCBldmVudCwgbGlzdGVuZXIsIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgX3JlZiA9IHRoaXMubGlzdGVuZXJzOwogICAgICBfcmVzdWx0cyA9IFtdOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBlbGVtZW50TGlzdGVuZXJzID0gX3JlZltfaV07CiAgICAgICAgX3Jlc3VsdHMucHVzaCgoZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgX3JlZjEsIF9yZXN1bHRzMTsKICAgICAgICAgIF9yZWYxID0gZWxlbWVudExpc3RlbmVycy5ldmVudHM7CiAgICAgICAgICBfcmVzdWx0czEgPSBbXTsKICAgICAgICAgIGZvciAoZXZlbnQgaW4gX3JlZjEpIHsKICAgICAgICAgICAgbGlzdGVuZXIgPSBfcmVmMVtldmVudF07CiAgICAgICAgICAgIF9yZXN1bHRzMS5wdXNoKGVsZW1lbnRMaXN0ZW5lcnMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lciwgZmFsc2UpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBfcmVzdWx0czE7CiAgICAgICAgfSkoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUucmVtb3ZlRXZlbnRMaXN0ZW5lcnMgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lcnMsIGV2ZW50LCBsaXN0ZW5lciwgX2ksIF9sZW4sIF9yZWYsIF9yZXN1bHRzOwogICAgICBfcmVmID0gdGhpcy5saXN0ZW5lcnM7CiAgICAgIF9yZXN1bHRzID0gW107CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGVsZW1lbnRMaXN0ZW5lcnMgPSBfcmVmW19pXTsKICAgICAgICBfcmVzdWx0cy5wdXNoKChmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBfcmVmMSwgX3Jlc3VsdHMxOwogICAgICAgICAgX3JlZjEgPSBlbGVtZW50TGlzdGVuZXJzLmV2ZW50czsKICAgICAgICAgIF9yZXN1bHRzMSA9IFtdOwogICAgICAgICAgZm9yIChldmVudCBpbiBfcmVmMSkgewogICAgICAgICAgICBsaXN0ZW5lciA9IF9yZWYxW2V2ZW50XTsKICAgICAgICAgICAgX3Jlc3VsdHMxLnB1c2goZWxlbWVudExpc3RlbmVycy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyLCBmYWxzZSkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9yZXN1bHRzMTsKICAgICAgICB9KSgpKTsKICAgICAgfQogICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5kaXNhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBmaWxlLCBfaSwgX2xlbiwgX3JlZiwgX3Jlc3VsdHM7CiAgICAgIHRoaXMuY2xpY2thYmxlRWxlbWVudHMuZm9yRWFjaChmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgiZHotY2xpY2thYmxlIik7CiAgICAgIH0pOwogICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXJzKCk7CiAgICAgIF9yZWYgPSB0aGlzLmZpbGVzOwogICAgICBfcmVzdWx0cyA9IFtdOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBmaWxlID0gX3JlZltfaV07CiAgICAgICAgX3Jlc3VsdHMucHVzaCh0aGlzLmNhbmNlbFVwbG9hZChmaWxlKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuZW5hYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY2xpY2thYmxlRWxlbWVudHMuZm9yRWFjaChmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgiZHotY2xpY2thYmxlIik7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpcy5zZXR1cEV2ZW50TGlzdGVuZXJzKCk7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5maWxlc2l6ZSA9IGZ1bmN0aW9uKHNpemUpIHsKICAgICAgdmFyIGN1dG9mZiwgaSwgc2VsZWN0ZWRTaXplLCBzZWxlY3RlZFVuaXQsIHVuaXQsIHVuaXRzLCBfaSwgX2xlbjsKICAgICAgdW5pdHMgPSBbJ1RCJywgJ0dCJywgJ01CJywgJ0tCJywgJ2InXTsKICAgICAgc2VsZWN0ZWRTaXplID0gc2VsZWN0ZWRVbml0ID0gbnVsbDsKICAgICAgZm9yIChpID0gX2kgPSAwLCBfbGVuID0gdW5pdHMubGVuZ3RoOyBfaSA8IF9sZW47IGkgPSArK19pKSB7CiAgICAgICAgdW5pdCA9IHVuaXRzW2ldOwogICAgICAgIGN1dG9mZiA9IE1hdGgucG93KHRoaXMub3B0aW9ucy5maWxlc2l6ZUJhc2UsIDQgLSBpKSAvIDEwOwogICAgICAgIGlmIChzaXplID49IGN1dG9mZikgewogICAgICAgICAgc2VsZWN0ZWRTaXplID0gc2l6ZSAvIE1hdGgucG93KHRoaXMub3B0aW9ucy5maWxlc2l6ZUJhc2UsIDQgLSBpKTsKICAgICAgICAgIHNlbGVjdGVkVW5pdCA9IHVuaXQ7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgc2VsZWN0ZWRTaXplID0gTWF0aC5yb3VuZCgxMCAqIHNlbGVjdGVkU2l6ZSkgLyAxMDsKICAgICAgcmV0dXJuICI8c3Ryb25nPiIgKyBzZWxlY3RlZFNpemUgKyAiPC9zdHJvbmc+ICIgKyBzZWxlY3RlZFVuaXQ7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5fdXBkYXRlTWF4RmlsZXNSZWFjaGVkQ2xhc3MgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCh0aGlzLm9wdGlvbnMubWF4RmlsZXMgIT0gbnVsbCkgJiYgdGhpcy5nZXRBY2NlcHRlZEZpbGVzKCkubGVuZ3RoID49IHRoaXMub3B0aW9ucy5tYXhGaWxlcykgewogICAgICAgIGlmICh0aGlzLmdldEFjY2VwdGVkRmlsZXMoKS5sZW5ndGggPT09IHRoaXMub3B0aW9ucy5tYXhGaWxlcykgewogICAgICAgICAgdGhpcy5lbWl0KCdtYXhmaWxlc3JlYWNoZWQnLCB0aGlzLmZpbGVzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QuYWRkKCJkei1tYXgtZmlsZXMtcmVhY2hlZCIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgiZHotbWF4LWZpbGVzLXJlYWNoZWQiKTsKICAgICAgfQogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuZHJvcCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGZpbGVzLCBpdGVtczsKICAgICAgaWYgKCFlLmRhdGFUcmFuc2ZlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLmVtaXQoImRyb3AiLCBlKTsKICAgICAgZmlsZXMgPSBlLmRhdGFUcmFuc2Zlci5maWxlczsKICAgICAgaWYgKGZpbGVzLmxlbmd0aCkgewogICAgICAgIGl0ZW1zID0gZS5kYXRhVHJhbnNmZXIuaXRlbXM7CiAgICAgICAgaWYgKGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCAmJiAoaXRlbXNbMF0ud2Via2l0R2V0QXNFbnRyeSAhPSBudWxsKSkgewogICAgICAgICAgdGhpcy5fYWRkRmlsZXNGcm9tSXRlbXMoaXRlbXMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmhhbmRsZUZpbGVzKGZpbGVzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLnBhc3RlID0gZnVuY3Rpb24oZSkgewogICAgICB2YXIgaXRlbXMsIF9yZWY7CiAgICAgIGlmICgoZSAhPSBudWxsID8gKF9yZWYgPSBlLmNsaXBib2FyZERhdGEpICE9IG51bGwgPyBfcmVmLml0ZW1zIDogdm9pZCAwIDogdm9pZCAwKSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuZW1pdCgicGFzdGUiLCBlKTsKICAgICAgaXRlbXMgPSBlLmNsaXBib2FyZERhdGEuaXRlbXM7CiAgICAgIGlmIChpdGVtcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYWRkRmlsZXNGcm9tSXRlbXMoaXRlbXMpOwogICAgICB9CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5oYW5kbGVGaWxlcyA9IGZ1bmN0aW9uKGZpbGVzKSB7CiAgICAgIHZhciBmaWxlLCBfaSwgX2xlbiwgX3Jlc3VsdHM7CiAgICAgIF9yZXN1bHRzID0gW107CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZmlsZXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBmaWxlID0gZmlsZXNbX2ldOwogICAgICAgIF9yZXN1bHRzLnB1c2godGhpcy5hZGRGaWxlKGZpbGUpKTsKICAgICAgfQogICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5fYWRkRmlsZXNGcm9tSXRlbXMgPSBmdW5jdGlvbihpdGVtcykgewogICAgICB2YXIgZW50cnksIGl0ZW0sIF9pLCBfbGVuLCBfcmVzdWx0czsKICAgICAgX3Jlc3VsdHMgPSBbXTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBpdGVtcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGl0ZW0gPSBpdGVtc1tfaV07CiAgICAgICAgaWYgKChpdGVtLndlYmtpdEdldEFzRW50cnkgIT0gbnVsbCkgJiYgKGVudHJ5ID0gaXRlbS53ZWJraXRHZXRBc0VudHJ5KCkpKSB7CiAgICAgICAgICBpZiAoZW50cnkuaXNGaWxlKSB7CiAgICAgICAgICAgIF9yZXN1bHRzLnB1c2godGhpcy5hZGRGaWxlKGl0ZW0uZ2V0QXNGaWxlKCkpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZW50cnkuaXNEaXJlY3RvcnkpIHsKICAgICAgICAgICAgX3Jlc3VsdHMucHVzaCh0aGlzLl9hZGRGaWxlc0Zyb21EaXJlY3RvcnkoZW50cnksIGVudHJ5Lm5hbWUpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9yZXN1bHRzLnB1c2godm9pZCAwKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGl0ZW0uZ2V0QXNGaWxlICE9IG51bGwpIHsKICAgICAgICAgIGlmICgoaXRlbS5raW5kID09IG51bGwpIHx8IGl0ZW0ua2luZCA9PT0gImZpbGUiKSB7CiAgICAgICAgICAgIF9yZXN1bHRzLnB1c2godGhpcy5hZGRGaWxlKGl0ZW0uZ2V0QXNGaWxlKCkpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIF9yZXN1bHRzLnB1c2godm9pZCAwKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3Jlc3VsdHMucHVzaCh2b2lkIDApOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5fYWRkRmlsZXNGcm9tRGlyZWN0b3J5ID0gZnVuY3Rpb24oZGlyZWN0b3J5LCBwYXRoKSB7CiAgICAgIHZhciBkaXJSZWFkZXIsIGVudHJpZXNSZWFkZXI7CiAgICAgIGRpclJlYWRlciA9IGRpcmVjdG9yeS5jcmVhdGVSZWFkZXIoKTsKICAgICAgZW50cmllc1JlYWRlciA9IChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbihlbnRyaWVzKSB7CiAgICAgICAgICB2YXIgZW50cnksIF9pLCBfbGVuOwogICAgICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBlbnRyaWVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICAgIGVudHJ5ID0gZW50cmllc1tfaV07CiAgICAgICAgICAgIGlmIChlbnRyeS5pc0ZpbGUpIHsKICAgICAgICAgICAgICBlbnRyeS5maWxlKGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25zLmlnbm9yZUhpZGRlbkZpbGVzICYmIGZpbGUubmFtZS5zdWJzdHJpbmcoMCwgMSkgPT09ICcuJykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmaWxlLmZ1bGxQYXRoID0gIiIgKyBwYXRoICsgIi8iICsgZmlsZS5uYW1lOwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmFkZEZpbGUoZmlsZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50cnkuaXNEaXJlY3RvcnkpIHsKICAgICAgICAgICAgICBfdGhpcy5fYWRkRmlsZXNGcm9tRGlyZWN0b3J5KGVudHJ5LCAiIiArIHBhdGggKyAiLyIgKyBlbnRyeS5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0pKHRoaXMpOwogICAgICByZXR1cm4gZGlyUmVhZGVyLnJlYWRFbnRyaWVzKGVudHJpZXNSZWFkZXIsIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlICE9PSBudWxsID8gdHlwZW9mIGNvbnNvbGUubG9nID09PSAiZnVuY3Rpb24iID8gY29uc29sZS5sb2coZXJyb3IpIDogdm9pZCAwIDogdm9pZCAwOwogICAgICB9KTsKICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLmFjY2VwdCA9IGZ1bmN0aW9uKGZpbGUsIGRvbmUpIHsKICAgICAgaWYgKGZpbGUuc2l6ZSA+IHRoaXMub3B0aW9ucy5tYXhGaWxlc2l6ZSAqIDEwMjQgKiAxMDI0KSB7CiAgICAgICAgcmV0dXJuIGRvbmUodGhpcy5vcHRpb25zLmRpY3RGaWxlVG9vQmlnLnJlcGxhY2UoInt7ZmlsZXNpemV9fSIsIE1hdGgucm91bmQoZmlsZS5zaXplIC8gMTAyNCAvIDEwLjI0KSAvIDEwMCkucmVwbGFjZSgie3ttYXhGaWxlc2l6ZX19IiwgdGhpcy5vcHRpb25zLm1heEZpbGVzaXplKSk7CiAgICAgIH0gZWxzZSBpZiAoIURyb3B6b25lLmlzVmFsaWRGaWxlKGZpbGUsIHRoaXMub3B0aW9ucy5hY2NlcHRlZEZpbGVzKSkgewogICAgICAgIHJldHVybiBkb25lKHRoaXMub3B0aW9ucy5kaWN0SW52YWxpZEZpbGVUeXBlKTsKICAgICAgfSBlbHNlIGlmICgodGhpcy5vcHRpb25zLm1heEZpbGVzICE9IG51bGwpICYmIHRoaXMuZ2V0QWNjZXB0ZWRGaWxlcygpLmxlbmd0aCA+PSB0aGlzLm9wdGlvbnMubWF4RmlsZXMpIHsKICAgICAgICBkb25lKHRoaXMub3B0aW9ucy5kaWN0TWF4RmlsZXNFeGNlZWRlZC5yZXBsYWNlKCJ7e21heEZpbGVzfX0iLCB0aGlzLm9wdGlvbnMubWF4RmlsZXMpKTsKICAgICAgICByZXR1cm4gdGhpcy5lbWl0KCJtYXhmaWxlc2V4Y2VlZGVkIiwgZmlsZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5hY2NlcHQuY2FsbCh0aGlzLCBmaWxlLCBkb25lKTsKICAgICAgfQogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuYWRkRmlsZSA9IGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgZmlsZS51cGxvYWQgPSB7CiAgICAgICAgcHJvZ3Jlc3M6IDAsCiAgICAgICAgdG90YWw6IGZpbGUuc2l6ZSwKICAgICAgICBieXRlc1NlbnQ6IDAKICAgICAgfTsKICAgICAgdGhpcy5maWxlcy5wdXNoKGZpbGUpOwogICAgICBmaWxlLnN0YXR1cyA9IERyb3B6b25lLkFEREVEOwogICAgICB0aGlzLmVtaXQoImFkZGVkZmlsZSIsIGZpbGUpOwogICAgICB0aGlzLl9lbnF1ZXVlVGh1bWJuYWlsKGZpbGUpOwogICAgICByZXR1cm4gdGhpcy5hY2NlcHQoZmlsZSwgKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgZmlsZS5hY2NlcHRlZCA9IGZhbHNlOwogICAgICAgICAgICBfdGhpcy5fZXJyb3JQcm9jZXNzaW5nKFtmaWxlXSwgZXJyb3IpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmlsZS5hY2NlcHRlZCA9IHRydWU7CiAgICAgICAgICAgIGlmIChfdGhpcy5vcHRpb25zLmF1dG9RdWV1ZSkgewogICAgICAgICAgICAgIF90aGlzLmVucXVldWVGaWxlKGZpbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gX3RoaXMuX3VwZGF0ZU1heEZpbGVzUmVhY2hlZENsYXNzKCk7CiAgICAgICAgfTsKICAgICAgfSkodGhpcykpOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuZW5xdWV1ZUZpbGVzID0gZnVuY3Rpb24oZmlsZXMpIHsKICAgICAgdmFyIGZpbGUsIF9pLCBfbGVuOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGZpbGVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgZmlsZSA9IGZpbGVzW19pXTsKICAgICAgICB0aGlzLmVucXVldWVGaWxlKGZpbGUpOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuZW5xdWV1ZUZpbGUgPSBmdW5jdGlvbihmaWxlKSB7CiAgICAgIGlmIChmaWxlLnN0YXR1cyA9PT0gRHJvcHpvbmUuQURERUQgJiYgZmlsZS5hY2NlcHRlZCA9PT0gdHJ1ZSkgewogICAgICAgIGZpbGUuc3RhdHVzID0gRHJvcHpvbmUuUVVFVUVEOwogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYXV0b1Byb2Nlc3NRdWV1ZSkgewogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoKChmdW5jdGlvbihfdGhpcykgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnByb2Nlc3NRdWV1ZSgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSkodGhpcykpLCAwKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGZpbGUgY2FuJ3QgYmUgcXVldWVkIGJlY2F1c2UgaXQgaGFzIGFscmVhZHkgYmVlbiBwcm9jZXNzZWQgb3Igd2FzIHJlamVjdGVkLiIpOwogICAgICB9CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5fdGh1bWJuYWlsUXVldWUgPSBbXTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuX3Byb2Nlc3NpbmdUaHVtYm5haWwgPSBmYWxzZTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuX2VucXVldWVUaHVtYm5haWwgPSBmdW5jdGlvbihmaWxlKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMuY3JlYXRlSW1hZ2VUaHVtYm5haWxzICYmIGZpbGUudHlwZS5tYXRjaCgvaW1hZ2UuKi8pICYmIGZpbGUuc2l6ZSA8PSB0aGlzLm9wdGlvbnMubWF4VGh1bWJuYWlsRmlsZXNpemUgKiAxMDI0ICogMTAyNCkgewogICAgICAgIHRoaXMuX3RodW1ibmFpbFF1ZXVlLnB1c2goZmlsZSk7CiAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoKChmdW5jdGlvbihfdGhpcykgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMuX3Byb2Nlc3NUaHVtYm5haWxRdWV1ZSgpOwogICAgICAgICAgfTsKICAgICAgICB9KSh0aGlzKSksIDApOwogICAgICB9CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5fcHJvY2Vzc1RodW1ibmFpbFF1ZXVlID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLl9wcm9jZXNzaW5nVGh1bWJuYWlsIHx8IHRoaXMuX3RodW1ibmFpbFF1ZXVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9wcm9jZXNzaW5nVGh1bWJuYWlsID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlVGh1bWJuYWlsKHRoaXMuX3RodW1ibmFpbFF1ZXVlLnNoaWZ0KCksIChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIF90aGlzLl9wcm9jZXNzaW5nVGh1bWJuYWlsID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4gX3RoaXMuX3Byb2Nlc3NUaHVtYm5haWxRdWV1ZSgpOwogICAgICAgIH07CiAgICAgIH0pKHRoaXMpKTsKICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLnJlbW92ZUZpbGUgPSBmdW5jdGlvbihmaWxlKSB7CiAgICAgIGlmIChmaWxlLnN0YXR1cyA9PT0gRHJvcHpvbmUuVVBMT0FESU5HKSB7CiAgICAgICAgdGhpcy5jYW5jZWxVcGxvYWQoZmlsZSk7CiAgICAgIH0KICAgICAgdGhpcy5maWxlcyA9IHdpdGhvdXQodGhpcy5maWxlcywgZmlsZSk7CiAgICAgIHRoaXMuZW1pdCgicmVtb3ZlZGZpbGUiLCBmaWxlKTsKICAgICAgaWYgKHRoaXMuZmlsZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW1pdCgicmVzZXQiKTsKICAgICAgfQogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUucmVtb3ZlQWxsRmlsZXMgPSBmdW5jdGlvbihjYW5jZWxJZk5lY2Vzc2FyeSkgewogICAgICB2YXIgZmlsZSwgX2ksIF9sZW4sIF9yZWY7CiAgICAgIGlmIChjYW5jZWxJZk5lY2Vzc2FyeSA9PSBudWxsKSB7CiAgICAgICAgY2FuY2VsSWZOZWNlc3NhcnkgPSBmYWxzZTsKICAgICAgfQogICAgICBfcmVmID0gdGhpcy5maWxlcy5zbGljZSgpOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBmaWxlID0gX3JlZltfaV07CiAgICAgICAgaWYgKGZpbGUuc3RhdHVzICE9PSBEcm9wem9uZS5VUExPQURJTkcgfHwgY2FuY2VsSWZOZWNlc3NhcnkpIHsKICAgICAgICAgIHRoaXMucmVtb3ZlRmlsZShmaWxlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5jcmVhdGVUaHVtYm5haWwgPSBmdW5jdGlvbihmaWxlLCBjYWxsYmFjaykgewogICAgICB2YXIgZmlsZVJlYWRlcjsKICAgICAgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyOwogICAgICBmaWxlUmVhZGVyLm9ubG9hZCA9IChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBpbWc7CiAgICAgICAgICBpZiAoZmlsZS50eXBlID09PSAiaW1hZ2Uvc3ZnK3htbCIpIHsKICAgICAgICAgICAgX3RoaXMuZW1pdCgidGh1bWJuYWlsIiwgZmlsZSwgZmlsZVJlYWRlci5yZXN1bHQpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjYW52YXMsIGN0eCwgcmVzaXplSW5mbywgdGh1bWJuYWlsLCBfcmVmLCBfcmVmMSwgX3JlZjIsIF9yZWYzOwogICAgICAgICAgICBmaWxlLndpZHRoID0gaW1nLndpZHRoOwogICAgICAgICAgICBmaWxlLmhlaWdodCA9IGltZy5oZWlnaHQ7CiAgICAgICAgICAgIHJlc2l6ZUluZm8gPSBfdGhpcy5vcHRpb25zLnJlc2l6ZS5jYWxsKF90aGlzLCBmaWxlKTsKICAgICAgICAgICAgaWYgKHJlc2l6ZUluZm8udHJnV2lkdGggPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlc2l6ZUluZm8udHJnV2lkdGggPSByZXNpemVJbmZvLm9wdFdpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXNpemVJbmZvLnRyZ0hlaWdodCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmVzaXplSW5mby50cmdIZWlnaHQgPSByZXNpemVJbmZvLm9wdEhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgICAgICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IHJlc2l6ZUluZm8udHJnV2lkdGg7CiAgICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSByZXNpemVJbmZvLnRyZ0hlaWdodDsKICAgICAgICAgICAgZHJhd0ltYWdlSU9TRml4KGN0eCwgaW1nLCAoX3JlZiA9IHJlc2l6ZUluZm8uc3JjWCkgIT0gbnVsbCA\/IF9yZWYgOiAwLCAoX3JlZjEgPSByZXNpemVJbmZvLnNyY1kpICE9IG51bGwgPyBfcmVmMSA6IDAsIHJlc2l6ZUluZm8uc3JjV2lkdGgsIHJlc2l6ZUluZm8uc3JjSGVpZ2h0LCAoX3JlZjIgPSByZXNpemVJbmZvLnRyZ1gpICE9IG51bGwgPyBfcmVmMiA6IDAsIChfcmVmMyA9IHJlc2l6ZUluZm8udHJnWSkgIT0gbnVsbCA\/IF9yZWYzIDogMCwgcmVzaXplSW5mby50cmdXaWR0aCwgcmVzaXplSW5mby50cmdIZWlnaHQpOwogICAgICAgICAgICB0aHVtYm5haWwgPSBjYW52YXMudG9EYXRhVVJMKCJpbWFnZS9wbmciKTsKICAgICAgICAgICAgX3RoaXMuZW1pdCgidGh1bWJuYWlsIiwgZmlsZSwgdGh1bWJuYWlsKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGltZy5vbmVycm9yID0gY2FsbGJhY2s7CiAgICAgICAgICByZXR1cm4gaW1nLnNyYyA9IGZpbGVSZWFkZXIucmVzdWx0OwogICAgICAgIH07CiAgICAgIH0pKHRoaXMpOwogICAgICByZXR1cm4gZmlsZVJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUucHJvY2Vzc1F1ZXVlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpLCBwYXJhbGxlbFVwbG9hZHMsIHByb2Nlc3NpbmdMZW5ndGgsIHF1ZXVlZEZpbGVzOwogICAgICBwYXJhbGxlbFVwbG9hZHMgPSB0aGlzLm9wdGlvbnMucGFyYWxsZWxVcGxvYWRzOwogICAgICBwcm9jZXNzaW5nTGVuZ3RoID0gdGhpcy5nZXRVcGxvYWRpbmdGaWxlcygpLmxlbmd0aDsKICAgICAgaSA9IHByb2Nlc3NpbmdMZW5ndGg7CiAgICAgIGlmIChwcm9jZXNzaW5nTGVuZ3RoID49IHBhcmFsbGVsVXBsb2FkcykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBxdWV1ZWRGaWxlcyA9IHRoaXMuZ2V0UXVldWVkRmlsZXMoKTsKICAgICAgaWYgKCEocXVldWVkRmlsZXMubGVuZ3RoID4gMCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy51cGxvYWRNdWx0aXBsZSkgewogICAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NGaWxlcyhxdWV1ZWRGaWxlcy5zbGljZSgwLCBwYXJhbGxlbFVwbG9hZHMgLSBwcm9jZXNzaW5nTGVuZ3RoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2hpbGUgKGkgPCBwYXJhbGxlbFVwbG9hZHMpIHsKICAgICAgICAgIGlmICghcXVldWVkRmlsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMucHJvY2Vzc0ZpbGUocXVldWVkRmlsZXMuc2hpZnQoKSk7CiAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5wcm9jZXNzRmlsZSA9IGZ1bmN0aW9uKGZpbGUpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc0ZpbGVzKFtmaWxlXSk7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS5wcm9jZXNzRmlsZXMgPSBmdW5jdGlvbihmaWxlcykgewogICAgICB2YXIgZmlsZSwgX2ksIF9sZW47CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZmlsZXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBmaWxlID0gZmlsZXNbX2ldOwogICAgICAgIGZpbGUucHJvY2Vzc2luZyA9IHRydWU7CiAgICAgICAgZmlsZS5zdGF0dXMgPSBEcm9wem9uZS5VUExPQURJTkc7CiAgICAgICAgdGhpcy5lbWl0KCJwcm9jZXNzaW5nIiwgZmlsZSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy51cGxvYWRNdWx0aXBsZSkgewogICAgICAgIHRoaXMuZW1pdCgicHJvY2Vzc2luZ211bHRpcGxlIiwgZmlsZXMpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnVwbG9hZEZpbGVzKGZpbGVzKTsKICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLl9nZXRGaWxlc1dpdGhYaHIgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgdmFyIGZpbGUsIGZpbGVzOwogICAgICByZXR1cm4gZmlsZXMgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgICBfcmVmID0gdGhpcy5maWxlczsKICAgICAgICBfcmVzdWx0cyA9IFtdOwogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgICAgZmlsZSA9IF9yZWZbX2ldOwogICAgICAgICAgaWYgKGZpbGUueGhyID09PSB4aHIpIHsKICAgICAgICAgICAgX3Jlc3VsdHMucHVzaChmaWxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgICB9KS5jYWxsKHRoaXMpOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuY2FuY2VsVXBsb2FkID0gZnVuY3Rpb24oZmlsZSkgewogICAgICB2YXIgZ3JvdXBlZEZpbGUsIGdyb3VwZWRGaWxlcywgX2ksIF9qLCBfbGVuLCBfbGVuMSwgX3JlZjsKICAgICAgaWYgKGZpbGUuc3RhdHVzID09PSBEcm9wem9uZS5VUExPQURJTkcpIHsKICAgICAgICBncm91cGVkRmlsZXMgPSB0aGlzLl9nZXRGaWxlc1dpdGhYaHIoZmlsZS54aHIpOwogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZ3JvdXBlZEZpbGVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICBncm91cGVkRmlsZSA9IGdyb3VwZWRGaWxlc1tfaV07CiAgICAgICAgICBncm91cGVkRmlsZS5zdGF0dXMgPSBEcm9wem9uZS5DQU5DRUxFRDsKICAgICAgICB9CiAgICAgICAgZmlsZS54aHIuYWJvcnQoKTsKICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBncm91cGVkRmlsZXMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CiAgICAgICAgICBncm91cGVkRmlsZSA9IGdyb3VwZWRGaWxlc1tfal07CiAgICAgICAgICB0aGlzLmVtaXQoImNhbmNlbGVkIiwgZ3JvdXBlZEZpbGUpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5vcHRpb25zLnVwbG9hZE11bHRpcGxlKSB7CiAgICAgICAgICB0aGlzLmVtaXQoImNhbmNlbGVkbXVsdGlwbGUiLCBncm91cGVkRmlsZXMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgoX3JlZiA9IGZpbGUuc3RhdHVzKSA9PT0gRHJvcHpvbmUuQURERUQgfHwgX3JlZiA9PT0gRHJvcHpvbmUuUVVFVUVEKSB7CiAgICAgICAgZmlsZS5zdGF0dXMgPSBEcm9wem9uZS5DQU5DRUxFRDsKICAgICAgICB0aGlzLmVtaXQoImNhbmNlbGVkIiwgZmlsZSk7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy51cGxvYWRNdWx0aXBsZSkgewogICAgICAgICAgdGhpcy5lbWl0KCJjYW5jZWxlZG11bHRpcGxlIiwgW2ZpbGVdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5hdXRvUHJvY2Vzc1F1ZXVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc1F1ZXVlKCk7CiAgICAgIH0KICAgIH07CgogICAgcmVzb2x2ZU9wdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncywgb3B0aW9uOwogICAgICBvcHRpb24gPSBhcmd1bWVudHNbMF0sIGFyZ3MgPSAyIDw9IGFyZ3VtZW50cy5sZW5ndGggPyBfX3NsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSA6IFtdOwogICAgICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBvcHRpb24uYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9wdGlvbjsKICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLnVwbG9hZEZpbGUgPSBmdW5jdGlvbihmaWxlKSB7CiAgICAgIHJldHVybiB0aGlzLnVwbG9hZEZpbGVzKFtmaWxlXSk7CiAgICB9OwoKICAgIERyb3B6b25lLnByb3RvdHlwZS51cGxvYWRGaWxlcyA9IGZ1bmN0aW9uKGZpbGVzKSB7CiAgICAgIHZhciBmaWxlLCBmb3JtRGF0YSwgaGFuZGxlRXJyb3IsIGhlYWRlck5hbWUsIGhlYWRlclZhbHVlLCBoZWFkZXJzLCBpLCBpbnB1dCwgaW5wdXROYW1lLCBpbnB1dFR5cGUsIGtleSwgbWV0aG9kLCBvcHRpb24sIHByb2dyZXNzT2JqLCByZXNwb25zZSwgdXBkYXRlUHJvZ3Jlc3MsIHVybCwgdmFsdWUsIHhociwgX2ksIF9qLCBfaywgX2wsIF9sZW4sIF9sZW4xLCBfbGVuMiwgX2xlbjMsIF9tLCBfcmVmLCBfcmVmMSwgX3JlZjIsIF9yZWYzLCBfcmVmNCwgX3JlZjU7CiAgICAgIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGZpbGVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgZmlsZSA9IGZpbGVzW19pXTsKICAgICAgICBmaWxlLnhociA9IHhocjsKICAgICAgfQogICAgICBtZXRob2QgPSByZXNvbHZlT3B0aW9uKHRoaXMub3B0aW9ucy5tZXRob2QsIGZpbGVzKTsKICAgICAgdXJsID0gcmVzb2x2ZU9wdGlvbih0aGlzLm9wdGlvbnMudXJsLCBmaWxlcyk7CiAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9ICEhdGhpcy5vcHRpb25zLndpdGhDcmVkZW50aWFsczsKICAgICAgcmVzcG9uc2UgPSBudWxsOwogICAgICBoYW5kbGVFcnJvciA9IChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBfaiwgX2xlbjEsIF9yZXN1bHRzOwogICAgICAgICAgX3Jlc3VsdHMgPSBbXTsKICAgICAgICAgIGZvciAoX2ogPSAwLCBfbGVuMSA9IGZpbGVzLmxlbmd0aDsgX2ogPCBfbGVuMTsgX2orKykgewogICAgICAgICAgICBmaWxlID0gZmlsZXNbX2pdOwogICAgICAgICAgICBfcmVzdWx0cy5wdXNoKF90aGlzLl9lcnJvclByb2Nlc3NpbmcoZmlsZXMsIHJlc3BvbnNlIHx8IF90aGlzLm9wdGlvbnMuZGljdFJlc3BvbnNlRXJyb3IucmVwbGFjZSgie3tzdGF0dXNDb2RlfX0iLCB4aHIuc3RhdHVzKSwgeGhyKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICAgICAgfTsKICAgICAgfSkodGhpcyk7CiAgICAgIHVwZGF0ZVByb2dyZXNzID0gKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHZhciBhbGxGaWxlc0ZpbmlzaGVkLCBwcm9ncmVzcywgX2osIF9rLCBfbCwgX2xlbjEsIF9sZW4yLCBfbGVuMywgX3Jlc3VsdHM7CiAgICAgICAgICBpZiAoZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHByb2dyZXNzID0gMTAwICogZS5sb2FkZWQgLyBlLnRvdGFsOwogICAgICAgICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBmaWxlcy5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICAgICAgICBmaWxlID0gZmlsZXNbX2pdOwogICAgICAgICAgICAgIGZpbGUudXBsb2FkID0gewogICAgICAgICAgICAgICAgcHJvZ3Jlc3M6IHByb2dyZXNzLAogICAgICAgICAgICAgICAgdG90YWw6IGUudG90YWwsCiAgICAgICAgICAgICAgICBieXRlc1NlbnQ6IGUubG9hZGVkCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYWxsRmlsZXNGaW5pc2hlZCA9IHRydWU7CiAgICAgICAgICAgIHByb2dyZXNzID0gMTAwOwogICAgICAgICAgICBmb3IgKF9rID0gMCwgX2xlbjIgPSBmaWxlcy5sZW5ndGg7IF9rIDwgX2xlbjI7IF9rKyspIHsKICAgICAgICAgICAgICBmaWxlID0gZmlsZXNbX2tdOwogICAgICAgICAgICAgIGlmICghKGZpbGUudXBsb2FkLnByb2dyZXNzID09PSAxMDAgJiYgZmlsZS51cGxvYWQuYnl0ZXNTZW50ID09PSBmaWxlLnVwbG9hZC50b3RhbCkpIHsKICAgICAgICAgICAgICAgIGFsbEZpbGVzRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZmlsZS51cGxvYWQucHJvZ3Jlc3MgPSBwcm9ncmVzczsKICAgICAgICAgICAgICBmaWxlLnVwbG9hZC5ieXRlc1NlbnQgPSBmaWxlLnVwbG9hZC50b3RhbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWxsRmlsZXNGaW5pc2hlZCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgX3Jlc3VsdHMgPSBbXTsKICAgICAgICAgIGZvciAoX2wgPSAwLCBfbGVuMyA9IGZpbGVzLmxlbmd0aDsgX2wgPCBfbGVuMzsgX2wrKykgewogICAgICAgICAgICBmaWxlID0gZmlsZXNbX2xdOwogICAgICAgICAgICBfcmVzdWx0cy5wdXNoKF90aGlzLmVtaXQoInVwbG9hZHByb2dyZXNzIiwgZmlsZSwgcHJvZ3Jlc3MsIGZpbGUudXBsb2FkLmJ5dGVzU2VudCkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgICAgIH07CiAgICAgIH0pKHRoaXMpOwogICAgICB4aHIub25sb2FkID0gKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHZhciBfcmVmOwogICAgICAgICAgaWYgKGZpbGVzWzBdLnN0YXR1cyA9PT0gRHJvcHpvbmUuQ0FOQ0VMRUQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlICE9PSA0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3BvbnNlID0geGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICAgIGlmICh4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoImNvbnRlbnQtdHlwZSIpICYmIH54aHIuZ2V0UmVzcG9uc2VIZWFkZXIoImNvbnRlbnQtdHlwZSIpLmluZGV4T2YoImFwcGxpY2F0aW9uL2pzb24iKSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXNwb25zZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKF9lcnJvcikgewogICAgICAgICAgICAgIGUgPSBfZXJyb3I7CiAgICAgICAgICAgICAgcmVzcG9uc2UgPSAiSW52YWxpZCBKU09OIHJlc3BvbnNlIGZyb20gc2VydmVyLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZVByb2dyZXNzKCk7CiAgICAgICAgICBpZiAoISgoMjAwIDw9IChfcmVmID0geGhyLnN0YXR1cykgJiYgX3JlZiA8IDMwMCkpKSB7CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVFcnJvcigpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLl9maW5pc2hlZChmaWxlcywgcmVzcG9uc2UsIGUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0pKHRoaXMpOwogICAgICB4aHIub25lcnJvciA9IChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChmaWxlc1swXS5zdGF0dXMgPT09IERyb3B6b25lLkNBTkNFTEVEKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBoYW5kbGVFcnJvcigpOwogICAgICAgIH07CiAgICAgIH0pKHRoaXMpOwogICAgICBwcm9ncmVzc09iaiA9IChfcmVmID0geGhyLnVwbG9hZCkgIT0gbnVsbCA\/IF9yZWYgOiB4aHI7CiAgICAgIHByb2dyZXNzT2JqLm9ucHJvZ3Jlc3MgPSB1cGRhdGVQcm9ncmVzczsKICAgICAgaGVhZGVycyA9IHsKICAgICAgICAiQWNjZXB0IjogImFwcGxpY2F0aW9uL2pzb24iLAogICAgICAgICJDYWNoZS1Db250cm9sIjogIm5vLWNhY2hlIiwKICAgICAgICAiWC1SZXF1ZXN0ZWQtV2l0aCI6ICJYTUxIdHRwUmVxdWVzdCIKICAgICAgfTsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5oZWFkZXJzKSB7CiAgICAgICAgZXh0ZW5kKGhlYWRlcnMsIHRoaXMub3B0aW9ucy5oZWFkZXJzKTsKICAgICAgfQogICAgICBmb3IgKGhlYWRlck5hbWUgaW4gaGVhZGVycykgewogICAgICAgIGhlYWRlclZhbHVlID0gaGVhZGVyc1toZWFkZXJOYW1lXTsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihoZWFkZXJOYW1lLCBoZWFkZXJWYWx1ZSk7CiAgICAgIH0KICAgICAgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5wYXJhbXMpIHsKICAgICAgICBfcmVmMSA9IHRoaXMub3B0aW9ucy5wYXJhbXM7CiAgICAgICAgZm9yIChrZXkgaW4gX3JlZjEpIHsKICAgICAgICAgIHZhbHVlID0gX3JlZjFba2V5XTsKICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gZmlsZXMubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CiAgICAgICAgZmlsZSA9IGZpbGVzW19qXTsKICAgICAgICB0aGlzLmVtaXQoInNlbmRpbmciLCBmaWxlLCB4aHIsIGZvcm1EYXRhKTsKICAgICAgfQogICAgICBpZiAodGhpcy5vcHRpb25zLnVwbG9hZE11bHRpcGxlKSB7CiAgICAgICAgdGhpcy5lbWl0KCJzZW5kaW5nbXVsdGlwbGUiLCBmaWxlcywgeGhyLCBmb3JtRGF0YSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZWxlbWVudC50YWdOYW1lID09PSAiRk9STSIpIHsKICAgICAgICBfcmVmMiA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCwgYnV0dG9uIik7CiAgICAgICAgZm9yIChfayA9IDAsIF9sZW4yID0gX3JlZjIubGVuZ3RoOyBfayA8IF9sZW4yOyBfaysrKSB7CiAgICAgICAgICBpbnB1dCA9IF9yZWYyW19rXTsKICAgICAgICAgIGlucHV0TmFtZSA9IGlucHV0LmdldEF0dHJpYnV0ZSgibmFtZSIpOwogICAgICAgICAgaW5wdXRUeXBlID0gaW5wdXQuZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgICAgICBpZiAoaW5wdXQudGFnTmFtZSA9PT0gIlNFTEVDVCIgJiYgaW5wdXQuaGFzQXR0cmlidXRlKCJtdWx0aXBsZSIpKSB7CiAgICAgICAgICAgIF9yZWYzID0gaW5wdXQub3B0aW9uczsKICAgICAgICAgICAgZm9yIChfbCA9IDAsIF9sZW4zID0gX3JlZjMubGVuZ3RoOyBfbCA8IF9sZW4zOyBfbCsrKSB7CiAgICAgICAgICAgICAgb3B0aW9uID0gX3JlZjNbX2xdOwogICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZChpbnB1dE5hbWUsIG9wdGlvbi52YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKCFpbnB1dFR5cGUgfHwgKChfcmVmNCA9IGlucHV0VHlwZS50b0xvd2VyQ2FzZSgpKSAhPT0gImNoZWNrYm94IiAmJiBfcmVmNCAhPT0gInJhZGlvIikgfHwgaW5wdXQuY2hlY2tlZCkgewogICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoaW5wdXROYW1lLCBpbnB1dC52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoaSA9IF9tID0gMCwgX3JlZjUgPSBmaWxlcy5sZW5ndGggLSAxOyAwIDw9IF9yZWY1ID8gX20gPD0gX3JlZjUgOiBfbSA+PSBfcmVmNTsgaSA9IDAgPD0gX3JlZjUgPyArK19tIDogLS1fbSkgewogICAgICAgIGZvcm1EYXRhLmFwcGVuZCh0aGlzLl9nZXRQYXJhbU5hbWUoaSksIGZpbGVzW2ldLCBmaWxlc1tpXS5uYW1lKTsKICAgICAgfQogICAgICByZXR1cm4geGhyLnNlbmQoZm9ybURhdGEpOwogICAgfTsKCiAgICBEcm9wem9uZS5wcm90b3R5cGUuX2ZpbmlzaGVkID0gZnVuY3Rpb24oZmlsZXMsIHJlc3BvbnNlVGV4dCwgZSkgewogICAgICB2YXIgZmlsZSwgX2ksIF9sZW47CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZmlsZXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBmaWxlID0gZmlsZXNbX2ldOwogICAgICAgIGZpbGUuc3RhdHVzID0gRHJvcHpvbmUuU1VDQ0VTUzsKICAgICAgICB0aGlzLmVtaXQoInN1Y2Nlc3MiLCBmaWxlLCByZXNwb25zZVRleHQsIGUpOwogICAgICAgIHRoaXMuZW1pdCgiY29tcGxldGUiLCBmaWxlKTsKICAgICAgfQogICAgICBpZiAodGhpcy5vcHRpb25zLnVwbG9hZE11bHRpcGxlKSB7CiAgICAgICAgdGhpcy5lbWl0KCJzdWNjZXNzbXVsdGlwbGUiLCBmaWxlcywgcmVzcG9uc2VUZXh0LCBlKTsKICAgICAgICB0aGlzLmVtaXQoImNvbXBsZXRlbXVsdGlwbGUiLCBmaWxlcyk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5hdXRvUHJvY2Vzc1F1ZXVlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc1F1ZXVlKCk7CiAgICAgIH0KICAgIH07CgogICAgRHJvcHpvbmUucHJvdG90eXBlLl9lcnJvclByb2Nlc3NpbmcgPSBmdW5jdGlvbihmaWxlcywgbWVzc2FnZSwgeGhyKSB7CiAgICAgIHZhciBmaWxlLCBfaSwgX2xlbjsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBmaWxlcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGZpbGUgPSBmaWxlc1tfaV07CiAgICAgICAgZmlsZS5zdGF0dXMgPSBEcm9wem9uZS5FUlJPUjsKICAgICAgICB0aGlzLmVtaXQoImVycm9yIiwgZmlsZSwgbWVzc2FnZSwgeGhyKTsKICAgICAgICB0aGlzLmVtaXQoImNvbXBsZXRlIiwgZmlsZSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy51cGxvYWRNdWx0aXBsZSkgewogICAgICAgIHRoaXMuZW1pdCgiZXJyb3JtdWx0aXBsZSIsIGZpbGVzLCBtZXNzYWdlLCB4aHIpOwogICAgICAgIHRoaXMuZW1pdCgiY29tcGxldGVtdWx0aXBsZSIsIGZpbGVzKTsKICAgICAgfQogICAgICBpZiAodGhpcy5vcHRpb25zLmF1dG9Qcm9jZXNzUXVldWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5wcm9jZXNzUXVldWUoKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gRHJvcHpvbmU7CgogIH0pKEVtaXR0ZXIpOwoKICBEcm9wem9uZS52ZXJzaW9uID0gIjQuMC4wIjsKCiAgRHJvcHpvbmUub3B0aW9ucyA9IHt9OwoKICBEcm9wem9uZS5vcHRpb25zRm9yRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSgiaWQiKSkgewogICAgICByZXR1cm4gRHJvcHpvbmUub3B0aW9uc1tjYW1lbGl6ZShlbGVtZW50LmdldEF0dHJpYnV0ZSgiaWQiKSldOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICB9OwoKICBEcm9wem9uZS5pbnN0YW5jZXMgPSBbXTsKCiAgRHJvcHpvbmUuZm9yRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gInN0cmluZyIpIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZWxlbWVudCk7CiAgICB9CiAgICBpZiAoKGVsZW1lbnQgIT0gbnVsbCA\/IGVsZW1lbnQuZHJvcHpvbmUgOiB2b2lkIDApID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBEcm9wem9uZSBmb3VuZCBmb3IgZ2l2ZW4gZWxlbWVudC4gVGhpcyBpcyBwcm9iYWJseSBiZWNhdXNlIHlvdSdyZSB0cnlpbmcgdG8gYWNjZXNzIGl0IGJlZm9yZSBEcm9wem9uZSBoYWQgdGhlIHRpbWUgdG8gaW5pdGlhbGl6ZS4gVXNlIHRoZSBgaW5pdGAgb3B0aW9uIHRvIHNldHVwIGFueSBhZGRpdGlvbmFsIG9ic2VydmVycyBvbiB5b3VyIERyb3B6b25lLiIpOwogICAgfQogICAgcmV0dXJuIGVsZW1lbnQuZHJvcHpvbmU7CiAgfTsKCiAgRHJvcHpvbmUuYXV0b0Rpc2NvdmVyID0gdHJ1ZTsKCiAgRHJvcHpvbmUuZGlzY292ZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjaGVja0VsZW1lbnRzLCBkcm9wem9uZSwgZHJvcHpvbmVzLCBfaSwgX2xlbiwgX3Jlc3VsdHM7CiAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCkgewogICAgICBkcm9wem9uZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIuZHJvcHpvbmUiKTsKICAgIH0gZWxzZSB7CiAgICAgIGRyb3B6b25lcyA9IFtdOwogICAgICBjaGVja0VsZW1lbnRzID0gZnVuY3Rpb24oZWxlbWVudHMpIHsKICAgICAgICB2YXIgZWwsIF9pLCBfbGVuLCBfcmVzdWx0czsKICAgICAgICBfcmVzdWx0cyA9IFtdOwogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZWxlbWVudHMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgIGVsID0gZWxlbWVudHNbX2ldOwogICAgICAgICAgaWYgKC8oXnwgKWRyb3B6b25lKCR8ICkvLnRlc3QoZWwuY2xhc3NOYW1lKSkgewogICAgICAgICAgICBfcmVzdWx0cy5wdXNoKGRyb3B6b25lcy5wdXNoKGVsKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfcmVzdWx0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBfcmVzdWx0czsKICAgICAgfTsKICAgICAgY2hlY2tFbGVtZW50cyhkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZGl2IikpOwogICAgICBjaGVja0VsZW1lbnRzKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJmb3JtIikpOwogICAgfQogICAgX3Jlc3VsdHMgPSBbXTsKICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZHJvcHpvbmVzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIGRyb3B6b25lID0gZHJvcHpvbmVzW19pXTsKICAgICAgaWYgKERyb3B6b25lLm9wdGlvbnNGb3JFbGVtZW50KGRyb3B6b25lKSAhPT0gZmFsc2UpIHsKICAgICAgICBfcmVzdWx0cy5wdXNoKG5ldyBEcm9wem9uZShkcm9wem9uZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIF9yZXN1bHRzLnB1c2godm9pZCAwKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIF9yZXN1bHRzOwogIH07CgogIERyb3B6b25lLmJsYWNrbGlzdGVkQnJvd3NlcnMgPSBbL29wZXJhLipNYWNpbnRvc2guKnZlcnNpb25cLzEyL2ldOwoKICBEcm9wem9uZS5pc0Jyb3dzZXJTdXBwb3J0ZWQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBjYXBhYmxlQnJvd3NlciwgcmVnZXgsIF9pLCBfbGVuLCBfcmVmOwogICAgY2FwYWJsZUJyb3dzZXIgPSB0cnVlOwogICAgaWYgKHdpbmRvdy5GaWxlICYmIHdpbmRvdy5GaWxlUmVhZGVyICYmIHdpbmRvdy5GaWxlTGlzdCAmJiB3aW5kb3cuQmxvYiAmJiB3aW5kb3cuRm9ybURhdGEgJiYgZG9jdW1lbnQucXVlcnlTZWxlY3RvcikgewogICAgICBpZiAoISgiY2xhc3NMaXN0IiBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIikpKSB7CiAgICAgICAgY2FwYWJsZUJyb3dzZXIgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBfcmVmID0gRHJvcHpvbmUuYmxhY2tsaXN0ZWRCcm93c2VyczsKICAgICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICAgIHJlZ2V4ID0gX3JlZltfaV07CiAgICAgICAgICBpZiAocmVnZXgudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSkgewogICAgICAgICAgICBjYXBhYmxlQnJvd3NlciA9IGZhbHNlOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNhcGFibGVCcm93c2VyID0gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gY2FwYWJsZUJyb3dzZXI7CiAgfTsKCiAgd2l0aG91dCA9IGZ1bmN0aW9uKGxpc3QsIHJlamVjdGVkSXRlbSkgewogICAgdmFyIGl0ZW0sIF9pLCBfbGVuLCBfcmVzdWx0czsKICAgIF9yZXN1bHRzID0gW107CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGxpc3QubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgaXRlbSA9IGxpc3RbX2ldOwogICAgICBpZiAoaXRlbSAhPT0gcmVqZWN0ZWRJdGVtKSB7CiAgICAgICAgX3Jlc3VsdHMucHVzaChpdGVtKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIF9yZXN1bHRzOwogIH07CgogIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1tcLV9dKFx3KS9nLCBmdW5jdGlvbihtYXRjaCkgewogICAgICByZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CiAgICB9KTsKICB9OwoKICBEcm9wem9uZS5jcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICB2YXIgZGl2OwogICAgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXYuaW5uZXJIVE1MID0gc3RyaW5nOwogICAgcmV0dXJuIGRpdi5jaGlsZE5vZGVzWzBdOwogIH07CgogIERyb3B6b25lLmVsZW1lbnRJbnNpZGUgPSBmdW5jdGlvbihlbGVtZW50LCBjb250YWluZXIpIHsKICAgIGlmIChlbGVtZW50ID09PSBjb250YWluZXIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB3aGlsZSAoZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSkgewogICAgICBpZiAoZWxlbWVudCA9PT0gY29udGFpbmVyKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9OwoKICBEcm9wem9uZS5nZXRFbGVtZW50ID0gZnVuY3Rpb24oZWwsIG5hbWUpIHsKICAgIHZhciBlbGVtZW50OwogICAgaWYgKHR5cGVvZiBlbCA9PT0gInN0cmluZyIpIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZWwpOwogICAgfSBlbHNlIGlmIChlbC5ub2RlVHlwZSAhPSBudWxsKSB7CiAgICAgIGVsZW1lbnQgPSBlbDsKICAgIH0KICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGAiICsgbmFtZSArICJgIG9wdGlvbiBwcm92aWRlZC4gUGxlYXNlIHByb3ZpZGUgYSBDU1Mgc2VsZWN0b3Igb3IgYSBwbGFpbiBIVE1MIGVsZW1lbnQuIik7CiAgICB9CiAgICByZXR1cm4gZWxlbWVudDsKICB9OwoKICBEcm9wem9uZS5nZXRFbGVtZW50cyA9IGZ1bmN0aW9uKGVscywgbmFtZSkgewogICAgdmFyIGUsIGVsLCBlbGVtZW50cywgX2ksIF9qLCBfbGVuLCBfbGVuMSwgX3JlZjsKICAgIGlmIChlbHMgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICBlbGVtZW50cyA9IFtdOwogICAgICB0cnkgewogICAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZWxzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgICBlbCA9IGVsc1tfaV07CiAgICAgICAgICBlbGVtZW50cy5wdXNoKHRoaXMuZ2V0RWxlbWVudChlbCwgbmFtZSkpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX2Vycm9yKSB7CiAgICAgICAgZSA9IF9lcnJvcjsKICAgICAgICBlbGVtZW50cyA9IG51bGw7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIGVscyA9PT0gInN0cmluZyIpIHsKICAgICAgZWxlbWVudHMgPSBbXTsKICAgICAgX3JlZiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZWxzKTsKICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gX3JlZi5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICBlbCA9IF9yZWZbX2pdOwogICAgICAgIGVsZW1lbnRzLnB1c2goZWwpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGVscy5ub2RlVHlwZSAhPSBudWxsKSB7CiAgICAgIGVsZW1lbnRzID0gW2Vsc107CiAgICB9CiAgICBpZiAoISgoZWxlbWVudHMgIT0gbnVsbCkgJiYgZWxlbWVudHMubGVuZ3RoKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYCIgKyBuYW1lICsgImAgb3B0aW9uIHByb3ZpZGVkLiBQbGVhc2UgcHJvdmlkZSBhIENTUyBzZWxlY3RvciwgYSBwbGFpbiBIVE1MIGVsZW1lbnQgb3IgYSBsaXN0IG9mIHRob3NlLiIpOwogICAgfQogICAgcmV0dXJuIGVsZW1lbnRzOwogIH07CgogIERyb3B6b25lLmNvbmZpcm0gPSBmdW5jdGlvbihxdWVzdGlvbiwgYWNjZXB0ZWQsIHJlamVjdGVkKSB7CiAgICBpZiAod2luZG93LmNvbmZpcm0ocXVlc3Rpb24pKSB7CiAgICAgIHJldHVybiBhY2NlcHRlZCgpOwogICAgfSBlbHNlIGlmIChyZWplY3RlZCAhPSBudWxsKSB7CiAgICAgIHJldHVybiByZWplY3RlZCgpOwogICAgfQogIH07CgogIERyb3B6b25lLmlzVmFsaWRGaWxlID0gZnVuY3Rpb24oZmlsZSwgYWNjZXB0ZWRGaWxlcykgewogICAgdmFyIGJhc2VNaW1lVHlwZSwgbWltZVR5cGUsIHZhbGlkVHlwZSwgX2ksIF9sZW47CiAgICBpZiAoIWFjY2VwdGVkRmlsZXMpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBhY2NlcHRlZEZpbGVzID0gYWNjZXB0ZWRGaWxlcy5zcGxpdCgiLCIpOwogICAgbWltZVR5cGUgPSBmaWxlLnR5cGU7CiAgICBiYXNlTWltZVR5cGUgPSBtaW1lVHlwZS5yZXBsYWNlKC9cLy4qJC8sICIiKTsKICAgIGZvciAoX2kgPSAwLCBfbGVuID0gYWNjZXB0ZWRGaWxlcy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICB2YWxpZFR5cGUgPSBhY2NlcHRlZEZpbGVzW19pXTsKICAgICAgdmFsaWRUeXBlID0gdmFsaWRUeXBlLnRyaW0oKTsKICAgICAgaWYgKHZhbGlkVHlwZS5jaGFyQXQoMCkgPT09ICIuIikgewogICAgICAgIGlmIChmaWxlLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKHZhbGlkVHlwZS50b0xvd2VyQ2FzZSgpLCBmaWxlLm5hbWUubGVuZ3RoIC0gdmFsaWRUeXBlLmxlbmd0aCkgIT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoL1wvXCokLy50ZXN0KHZhbGlkVHlwZSkpIHsKICAgICAgICBpZiAoYmFzZU1pbWVUeXBlID09PSB2YWxpZFR5cGUucmVwbGFjZSgvXC8uKiQvLCAiIikpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobWltZVR5cGUgPT09IHZhbGlkVHlwZSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfTsKCiAgaWYgKHR5cGVvZiBqUXVlcnkgIT09ICJ1bmRlZmluZWQiICYmIGpRdWVyeSAhPT0gbnVsbCkgewogICAgalF1ZXJ5LmZuLmRyb3B6b25lID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgRHJvcHpvbmUodGhpcywgb3B0aW9ucyk7CiAgICAgIH0pOwogICAgfTsKICB9CgogIGlmICh0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiAmJiBtb2R1bGUgIT09IG51bGwpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gRHJvcHpvbmU7CiAgfSBlbHNlIHsKICAgIHdpbmRvdy5Ecm9wem9uZSA9IERyb3B6b25lOwogIH0KCiAgRHJvcHpvbmUuQURERUQgPSAiYWRkZWQiOwoKICBEcm9wem9uZS5RVUVVRUQgPSAicXVldWVkIjsKCiAgRHJvcHpvbmUuQUNDRVBURUQgPSBEcm9wem9uZS5RVUVVRUQ7CgogIERyb3B6b25lLlVQTE9BRElORyA9ICJ1cGxvYWRpbmciOwoKICBEcm9wem9uZS5QUk9DRVNTSU5HID0gRHJvcHpvbmUuVVBMT0FESU5HOwoKICBEcm9wem9uZS5DQU5DRUxFRCA9ICJjYW5jZWxlZCI7CgogIERyb3B6b25lLkVSUk9SID0gImVycm9yIjsKCiAgRHJvcHpvbmUuU1VDQ0VTUyA9ICJzdWNjZXNzIjsKCgogIC8qCiAgCiAgQnVnZml4IGZvciBpT1MgNiBhbmQgNwogIFNvdXJjZTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xMTkyOTA5OS9odG1sNS1jYW52YXMtZHJhd2ltYWdlLXJhdGlvLWJ1Zy1pb3MKICBiYXNlZCBvbiB0aGUgd29yayBvZiBodHRwczovL2dpdGh1Yi5jb20vc3RvbWl0YS9pb3MtaW1hZ2VmaWxlLW1lZ2FwaXhlbAogICAqLwoKICBkZXRlY3RWZXJ0aWNhbFNxdWFzaCA9IGZ1bmN0aW9uKGltZykgewogICAgdmFyIGFscGhhLCBjYW52YXMsIGN0eCwgZGF0YSwgZXksIGloLCBpdywgcHksIHJhdGlvLCBzeTsKICAgIGl3ID0gaW1nLm5hdHVyYWxXaWR0aDsKICAgIGloID0gaW1nLm5hdHVyYWxIZWlnaHQ7CiAgICBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgIGNhbnZhcy53aWR0aCA9IDE7CiAgICBjYW52YXMuaGVpZ2h0ID0gaWg7CiAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwKTsKICAgIGRhdGEgPSBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIDEsIGloKS5kYXRhOwogICAgc3kgPSAwOwogICAgZXkgPSBpaDsKICAgIHB5ID0gaWg7CiAgICB3aGlsZSAocHkgPiBzeSkgewogICAgICBhbHBoYSA9IGRhdGFbKHB5IC0gMSkgKiA0ICsgM107CiAgICAgIGlmIChhbHBoYSA9PT0gMCkgewogICAgICAgIGV5ID0gcHk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3kgPSBweTsKICAgICAgfQogICAgICBweSA9IChleSArIHN5KSA+PiAxOwogICAgfQogICAgcmF0aW8gPSBweSAvIGloOwogICAgaWYgKHJhdGlvID09PSAwKSB7CiAgICAgIHJldHVybiAxOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHJhdGlvOwogICAgfQogIH07CgogIGRyYXdJbWFnZUlPU0ZpeCA9IGZ1bmN0aW9uKGN0eCwgaW1nLCBzeCwgc3ksIHN3LCBzaCwgZHgsIGR5LCBkdywgZGgpIHsKICAgIHZhciB2ZXJ0U3F1YXNoUmF0aW87CiAgICB2ZXJ0U3F1YXNoUmF0aW8gPSBkZXRlY3RWZXJ0aWNhbFNxdWFzaChpbWcpOwogICAgcmV0dXJuIGN0eC5kcmF3SW1hZ2UoaW1nLCBzeCwgc3ksIHN3LCBzaCwgZHgsIGR5LCBkdywgZGggLyB2ZXJ0U3F1YXNoUmF0aW8pOwogIH07CgoKICAvKgogICAqIGNvbnRlbnRsb2FkZWQuanMKICAgKgogICAqIEF1dGhvcjogRGllZ28gUGVyaW5pIChkaWVnby5wZXJpbmkgYXQgZ21haWwuY29tKQogICAqIFN1bW1hcnk6IGNyb3NzLWJyb3dzZXIgd3JhcHBlciBmb3IgRE9NQ29udGVudExvYWRlZAogICAqIFVwZGF0ZWQ6IDIwMTAxMDIwCiAgICogTGljZW5zZTogTUlUCiAgICogVmVyc2lvbjogMS4yCiAgICoKICAgKiBVUkw6CiAgICogaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0NvbnRlbnRMb2FkZWQvCiAgICogaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0NvbnRlbnRMb2FkZWQvTUlULUxJQ0VOU0UKICAgKi8KCiAgY29udGVudExvYWRlZCA9IGZ1bmN0aW9uKHdpbiwgZm4pIHsKICAgIHZhciBhZGQsIGRvYywgZG9uZSwgaW5pdCwgcG9sbCwgcHJlLCByZW0sIHJvb3QsIHRvcDsKICAgIGRvbmUgPSBmYWxzZTsKICAgIHRvcCA9IHRydWU7CiAgICBkb2MgPSB3aW4uZG9jdW1lbnQ7CiAgICByb290ID0gZG9jLmRvY3VtZW50RWxlbWVudDsKICAgIGFkZCA9IChkb2MuYWRkRXZlbnRMaXN0ZW5lciA\/ICJhZGRFdmVudExpc3RlbmVyIiA6ICJhdHRhY2hFdmVudCIpOwogICAgcmVtID0gKGRvYy5hZGRFdmVudExpc3RlbmVyID8gInJlbW92ZUV2ZW50TGlzdGVuZXIiIDogImRldGFjaEV2ZW50Iik7CiAgICBwcmUgPSAoZG9jLmFkZEV2ZW50TGlzdGVuZXIgPyAiIiA6ICJvbiIpOwogICAgaW5pdCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKGUudHlwZSA9PT0gInJlYWR5c3RhdGVjaGFuZ2UiICYmIGRvYy5yZWFkeVN0YXRlICE9PSAiY29tcGxldGUiKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIChlLnR5cGUgPT09ICJsb2FkIiA\/IHdpbiA6IGRvYylbcmVtXShwcmUgKyBlLnR5cGUsIGluaXQsIGZhbHNlKTsKICAgICAgaWYgKCFkb25lICYmIChkb25lID0gdHJ1ZSkpIHsKICAgICAgICByZXR1cm4gZm4uY2FsbCh3aW4sIGUudHlwZSB8fCBlKTsKICAgICAgfQogICAgfTsKICAgIHBvbGwgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGU7CiAgICAgIHRyeSB7CiAgICAgICAgcm9vdC5kb1Njcm9sbCgibGVmdCIpOwogICAgICB9IGNhdGNoIChfZXJyb3IpIHsKICAgICAgICBlID0gX2Vycm9yOwogICAgICAgIHNldFRpbWVvdXQocG9sbCwgNTApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICByZXR1cm4gaW5pdCgicG9sbCIpOwogICAgfTsKICAgIGlmIChkb2MucmVhZHlTdGF0ZSAhPT0gImNvbXBsZXRlIikgewogICAgICBpZiAoZG9jLmNyZWF0ZUV2ZW50T2JqZWN0ICYmIHJvb3QuZG9TY3JvbGwpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdG9wID0gIXdpbi5mcmFtZUVsZW1lbnQ7CiAgICAgICAgfSBjYXRjaCAoX2Vycm9yKSB7fQogICAgICAgIGlmICh0b3ApIHsKICAgICAgICAgIHBvbGwoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZG9jW2FkZF0ocHJlICsgIkRPTUNvbnRlbnRMb2FkZWQiLCBpbml0LCBmYWxzZSk7CiAgICAgIGRvY1thZGRdKHByZSArICJyZWFkeXN0YXRlY2hhbmdlIiwgaW5pdCwgZmFsc2UpOwogICAgICByZXR1cm4gd2luW2FkZF0ocHJlICsgImxvYWQiLCBpbml0LCBmYWxzZSk7CiAgICB9CiAgfTsKCiAgRHJvcHpvbmUuX2F1dG9EaXNjb3ZlckZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoRHJvcHpvbmUuYXV0b0Rpc2NvdmVyKSB7CiAgICAgIHJldHVybiBEcm9wem9uZS5kaXNjb3ZlcigpOwogICAgfQogIH07CgogIGNvbnRlbnRMb2FkZWQod2luZG93LCBEcm9wem9uZS5fYXV0b0Rpc2NvdmVyRnVuY3Rpb24pOwoKfSkuY2FsbCh0aGlzKTsK",
    "size": "62820"
}