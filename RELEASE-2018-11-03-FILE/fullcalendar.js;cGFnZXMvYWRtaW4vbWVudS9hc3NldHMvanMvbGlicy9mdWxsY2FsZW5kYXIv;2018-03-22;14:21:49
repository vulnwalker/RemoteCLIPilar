{
    "namaFile": "pages\/admin\/menu\/assets\/js\/libs\/fullcalendar\/fullcalendar.js",
    "lastUpdate": "2018-03-22+14:21:49.28",
    "contentFile": "LyohCiAqIEZ1bGxDYWxlbmRhciB2Mi4yLjYKICogRG9jcyAmIExpY2Vuc2U6IGh0dHA6Ly9hcnNoYXcuY29tL2Z1bGxjYWxlbmRhci8KICogKGMpIDIwMTMgQWRhbSBTaGF3CiAqLwoKKGZ1bmN0aW9uKGZhY3RvcnkpIHsKCWlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKCQlkZWZpbmUoWyAnanF1ZXJ5JywgJ21vbWVudCcgXSwgZmFjdG9yeSk7Cgl9CgllbHNlIHsKCQlmYWN0b3J5KGpRdWVyeSwgbW9tZW50KTsKCX0KfSkoZnVuY3Rpb24oJCwgbW9tZW50KSB7Cgo7OwoKdmFyIGRlZmF1bHRzID0gewoKCXRpdGxlUmFuZ2VTZXBhcmF0b3I6ICcgXHUyMDE0ICcsIC8vIGVtcGhhc2l6ZWQgZGFzaAoJbW9udGhZZWFyRm9ybWF0OiAnTU1NTSBZWVlZJywgLy8gcmVxdWlyZWQgZm9yIGVuLiBvdGhlciBsYW5ndWFnZXMgcmVseSBvbiBkYXRlcGlja2VyIGNvbXB1dGFibGUgb3B0aW9uCgoJZGVmYXVsdFRpbWVkRXZlbnREdXJhdGlvbjogJzAyOjAwOjAwJywKCWRlZmF1bHRBbGxEYXlFdmVudER1cmF0aW9uOiB7IGRheXM6IDEgfSwKCWZvcmNlRXZlbnREdXJhdGlvbjogZmFsc2UsCgluZXh0RGF5VGhyZXNob2xkOiAnMDk6MDA6MDAnLCAvLyA5YW0KCgkvLyBkaXNwbGF5CglkZWZhdWx0VmlldzogJ21vbnRoJywKCWFzcGVjdFJhdGlvOiAxLjM1LAoJaGVhZGVyOiB7CgkJbGVmdDogJ3RpdGxlJywKCQljZW50ZXI6ICcnLAoJCXJpZ2h0OiAndG9kYXkgcHJldixuZXh0JwoJfSwKCXdlZWtlbmRzOiB0cnVlLAoJd2Vla051bWJlcnM6IGZhbHNlLAoKCXdlZWtOdW1iZXJUaXRsZTogJ1cnLAoJd2Vla051bWJlckNhbGN1bGF0aW9uOiAnbG9jYWwnLAoJCgkvL2VkaXRhYmxlOiBmYWxzZSwKCQoJLy8gZXZlbnQgYWpheAoJbGF6eUZldGNoaW5nOiB0cnVlLAoJc3RhcnRQYXJhbTogJ3N0YXJ0JywKCWVuZFBhcmFtOiAnZW5kJywKCXRpbWV6b25lUGFyYW06ICd0aW1lem9uZScsCgoJdGltZXpvbmU6IGZhbHNlLAoKCS8vYWxsRGF5RGVmYXVsdDogdW5kZWZpbmVkLAoKCS8vIGxvY2FsZQoJaXNSVEw6IGZhbHNlLAoJZGVmYXVsdEJ1dHRvblRleHQ6IHsKCQlwcmV2OiAicHJldiIsCgkJbmV4dDogIm5leHQiLAoJCXByZXZZZWFyOiAicHJldiB5ZWFyIiwKCQluZXh0WWVhcjogIm5leHQgeWVhciIsCgkJdG9kYXk6ICd0b2RheScsCgkJbW9udGg6ICdtb250aCcsCgkJd2VlazogJ3dlZWsnLAoJCWRheTogJ2RheScKCX0sCgoJYnV0dG9uSWNvbnM6IHsKCQlwcmV2OiAnbGVmdC1zaW5nbGUtYXJyb3cnLAoJCW5leHQ6ICdyaWdodC1zaW5nbGUtYXJyb3cnLAoJCXByZXZZZWFyOiAnbGVmdC1kb3VibGUtYXJyb3cnLAoJCW5leHRZZWFyOiAncmlnaHQtZG91YmxlLWFycm93JwoJfSwKCQoJLy8ganF1ZXJ5LXVpIHRoZW1pbmcKCXRoZW1lOiBmYWxzZSwKCXRoZW1lQnV0dG9uSWNvbnM6IHsKCQlwcmV2OiAnY2lyY2xlLXRyaWFuZ2xlLXcnLAoJCW5leHQ6ICdjaXJjbGUtdHJpYW5nbGUtZScsCgkJcHJldlllYXI6ICdzZWVrLXByZXYnLAoJCW5leHRZZWFyOiAnc2Vlay1uZXh0JwoJfSwKCglkcmFnT3BhY2l0eTogLjc1LAoJZHJhZ1JldmVydER1cmF0aW9uOiA1MDAsCglkcmFnU2Nyb2xsOiB0cnVlLAoJCgkvL3NlbGVjdGFibGU6IGZhbHNlLAoJdW5zZWxlY3RBdXRvOiB0cnVlLAoJCglkcm9wQWNjZXB0OiAnKicsCgoJZXZlbnRMaW1pdDogZmFsc2UsCglldmVudExpbWl0VGV4dDogJ21vcmUnLAoJZXZlbnRMaW1pdENsaWNrOiAncG9wb3ZlcicsCglkYXlQb3BvdmVyRm9ybWF0OiAnTEwnLAoJCgloYW5kbGVXaW5kb3dSZXNpemU6IHRydWUsCgl3aW5kb3dSZXNpemVEZWxheTogMjAwIC8vIG1pbGxpc2Vjb25kcyBiZWZvcmUgYW4gdXBkYXRlU2l6ZSBoYXBwZW5zCgkKfTsKCgp2YXIgZW5nbGlzaERlZmF1bHRzID0gewoJZGF5UG9wb3ZlckZvcm1hdDogJ2RkZGQsIE1NTU0gRCcKfTsKCgovLyByaWdodC10by1sZWZ0IGRlZmF1bHRzCnZhciBydGxEZWZhdWx0cyA9IHsKCWhlYWRlcjogewoJCWxlZnQ6ICduZXh0LHByZXYgdG9kYXknLAoJCWNlbnRlcjogJycsCgkJcmlnaHQ6ICd0aXRsZScKCX0sCglidXR0b25JY29uczogewoJCXByZXY6ICdyaWdodC1zaW5nbGUtYXJyb3cnLAoJCW5leHQ6ICdsZWZ0LXNpbmdsZS1hcnJvdycsCgkJcHJldlllYXI6ICdyaWdodC1kb3VibGUtYXJyb3cnLAoJCW5leHRZZWFyOiAnbGVmdC1kb3VibGUtYXJyb3cnCgl9LAoJdGhlbWVCdXR0b25JY29uczogewoJCXByZXY6ICdjaXJjbGUtdHJpYW5nbGUtZScsCgkJbmV4dDogJ2NpcmNsZS10cmlhbmdsZS13JywKCQluZXh0WWVhcjogJ3NlZWstcHJldicsCgkJcHJldlllYXI6ICdzZWVrLW5leHQnCgl9Cn07Cgo7OwoKdmFyIGZjID0gJC5mdWxsQ2FsZW5kYXIgPSB7IHZlcnNpb246ICIyLjIuNiIgfTsKdmFyIGZjVmlld3MgPSBmYy52aWV3cyA9IHt9OwoKCiQuZm4uZnVsbENhbGVuZGFyID0gZnVuY3Rpb24ob3B0aW9ucykgewoJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOyAvLyBmb3IgYSBwb3NzaWJsZSBtZXRob2QgY2FsbAoJdmFyIHJlcyA9IHRoaXM7IC8vIHdoYXQgdGhpcyBmdW5jdGlvbiB3aWxsIHJldHVybiAodGhpcyBqUXVlcnkgb2JqZWN0IGJ5IGRlZmF1bHQpCgoJdGhpcy5lYWNoKGZ1bmN0aW9uKGksIF9lbGVtZW50KSB7IC8vIGxvb3AgZWFjaCBET00gZWxlbWVudCBpbnZvbHZlZAoJCXZhciBlbGVtZW50ID0gJChfZWxlbWVudCk7CgkJdmFyIGNhbGVuZGFyID0gZWxlbWVudC5kYXRhKCdmdWxsQ2FsZW5kYXInKTsgLy8gZ2V0IHRoZSBleGlzdGluZyBjYWxlbmRhciBvYmplY3QgKGlmIGFueSkKCQl2YXIgc2luZ2xlUmVzOyAvLyB0aGUgcmV0dXJuZWQgdmFsdWUgb2YgdGhpcyBzaW5nbGUgbWV0aG9kIGNhbGwKCgkJLy8gYSBtZXRob2QgY2FsbAoJCWlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKCQkJaWYgKGNhbGVuZGFyICYmICQuaXNGdW5jdGlvbihjYWxlbmRhcltvcHRpb25zXSkpIHsKCQkJCXNpbmdsZVJlcyA9IGNhbGVuZGFyW29wdGlvbnNdLmFwcGx5KGNhbGVuZGFyLCBhcmdzKTsKCQkJCWlmICghaSkgewoJCQkJCXJlcyA9IHNpbmdsZVJlczsgLy8gcmVjb3JkIHRoZSBmaXJzdCBtZXRob2QgY2FsbCByZXN1bHQKCQkJCX0KCQkJCWlmIChvcHRpb25zID09PSAnZGVzdHJveScpIHsgLy8gZm9yIHRoZSBkZXN0cm95IG1ldGhvZCwgbXVzdCByZW1vdmUgQ2FsZW5kYXIgb2JqZWN0IGRhdGEKCQkJCQllbGVtZW50LnJlbW92ZURhdGEoJ2Z1bGxDYWxlbmRhcicpOwoJCQkJfQoJCQl9CgkJfQoJCS8vIGEgbmV3IGNhbGVuZGFyIGluaXRpYWxpemF0aW9uCgkJZWxzZSBpZiAoIWNhbGVuZGFyKSB7IC8vIGRvbid0IGluaXRpYWxpemUgdHdpY2UKCQkJY2FsZW5kYXIgPSBuZXcgQ2FsZW5kYXIoZWxlbWVudCwgb3B0aW9ucyk7CgkJCWVsZW1lbnQuZGF0YSgnZnVsbENhbGVuZGFyJywgY2FsZW5kYXIpOwoJCQljYWxlbmRhci5yZW5kZXIoKTsKCQl9Cgl9KTsKCQoJcmV0dXJuIHJlczsKfTsKCgovLyBmdW5jdGlvbiBmb3IgYWRkaW5nL292ZXJyaWRpbmcgZGVmYXVsdHMKZnVuY3Rpb24gc2V0RGVmYXVsdHMoZCkgewoJbWVyZ2VPcHRpb25zKGRlZmF1bHRzLCBkKTsKfQoKCi8vIFJlY3Vyc2l2ZWx5IGNvbWJpbmVzIG9wdGlvbiBoYXNoLW9iamVjdHMuCi8vIEJldHRlciB0aGFuIGAkLmV4dGVuZCh0cnVlLCAuLi4pYCBiZWNhdXNlIGFycmF5cyBhcmUgbm90IHRyYXZlcnNlZC9jb3BpZWQuCi8vCi8vIGNhbGxlZCBsaWtlOgovLyAgICAgbWVyZ2VPcHRpb25zKHRhcmdldCwgb2JqMSwgb2JqMiwgLi4uKQovLwpmdW5jdGlvbiBtZXJnZU9wdGlvbnModGFyZ2V0KSB7CgoJZnVuY3Rpb24gbWVyZ2VJbnRvVGFyZ2V0KG5hbWUsIHZhbHVlKSB7CgkJaWYgKCQuaXNQbGFpbk9iamVjdCh2YWx1ZSkgJiYgJC5pc1BsYWluT2JqZWN0KHRhcmdldFtuYW1lXSkgJiYgIWlzRm9yY2VkQXRvbWljT3B0aW9uKG5hbWUpKSB7CgkJCS8vIG1lcmdlIGludG8gYSBuZXcgb2JqZWN0IHRvIGF2b2lkIGRlc3RydWN0aW9uCgkJCXRhcmdldFtuYW1lXSA9IG1lcmdlT3B0aW9ucyh7fSwgdGFyZ2V0W25hbWVdLCB2YWx1ZSk7IC8vIGNvbWJpbmUuIGB2YWx1ZWAgb2JqZWN0IHRha2VzIHByZWNlZGVuY2UKCQl9CgkJZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgeyAvLyBvbmx5IHVzZSB2YWx1ZXMgdGhhdCBhcmUgc2V0IGFuZCBub3QgdW5kZWZpbmVkCgkJCXRhcmdldFtuYW1lXSA9IHZhbHVlOwoJCX0KCX0KCglmb3IgKHZhciBpPTE7IGk8YXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CgkJJC5lYWNoKGFyZ3VtZW50c1tpXSwgbWVyZ2VJbnRvVGFyZ2V0KTsKCX0KCglyZXR1cm4gdGFyZ2V0Owp9CgoKLy8gb3ZlcmNvbWUgc3Vja3kgdmlldy1vcHRpb24taGFzaCBhbmQgb3B0aW9uLW1lcmdpbmcgYmVoYXZpb3IgbWVzc2luZyB3aXRoIG9wdGlvbnMgaXQgc2hvdWxkbid0CmZ1bmN0aW9uIGlzRm9yY2VkQXRvbWljT3B0aW9uKG5hbWUpIHsKCS8vIEFueSBvcHRpb24gdGhhdCBlbmRzIGluICJUaW1lIiBvciAiRHVyYXRpb24iIGlzIHByb2JhYmx5IGEgRHVyYXRpb24sCgkvLyBhbmQgdGhlc2Ugd2lsbCBjb21tb25seSBiZSBzcGVjaWZpZWQgYXMgcGxhaW4gb2JqZWN0cywgd2hpY2ggd2UgZG9uJ3Qgd2FudCB0byBtZXNzIHVwLgoJcmV0dXJuIC8oVGltZXxEdXJhdGlvbikkLy50ZXN0KG5hbWUpOwp9Ci8vIEZJWDogZmluZCBhIGRpZmZlcmVudCBzb2x1dGlvbiBmb3Igdmlldy1vcHRpb24taGFzaGVzIGFuZCBoYXZlIGEgd2hpdGVsaXN0Ci8vIGZvciBvcHRpb25zIHRoYXQgY2FuIGJlIHJlY3Vyc2l2ZWx5IG1lcmdlZC4KCjs7Cgp2YXIgbGFuZ09wdGlvbkhhc2ggPSBmYy5sYW5ncyA9IHt9OyAvLyBpbml0aWFsaXplIGFuZCBleHBvc2UKCgovLyBUT0RPOiBkb2N1bWVudCB0aGUgc3RydWN0dXJlIGFuZCBvcmRlcmluZyBvZiBhIEZ1bGxDYWxlbmRhciBsYW5nIGZpbGUKLy8gVE9ETzogcmVuYW1lIGV2ZXJ5dGhpbmcgImxhbmciIHRvICJsb2NhbGUiLCBsaWtlIHdoYXQgdGhlIG1vbWVudCBwcm9qZWN0IGRpZAoKCi8vIEluaXRpYWxpemUgalF1ZXJ5IFVJIGRhdGVwaWNrZXIgdHJhbnNsYXRpb25zIHdoaWxlIHVzaW5nIHNvbWUgb2YgdGhlIHRyYW5zbGF0aW9ucwovLyBXaWxsIHNldCB0aGlzIGFzIHRoZSBkZWZhdWx0IGxhbmd1YWdlIGZvciBkYXRlcGlja2VyLgpmYy5kYXRlcGlja2VyTGFuZyA9IGZ1bmN0aW9uKGxhbmdDb2RlLCBkcExhbmdDb2RlLCBkcE9wdGlvbnMpIHsKCgkvLyBnZXQgdGhlIEZ1bGxDYWxlbmRhciBpbnRlcm5hbCBvcHRpb24gaGFzaCBmb3IgdGhpcyBsYW5ndWFnZS4gY3JlYXRlIGlmIG5lY2Vzc2FyeQoJdmFyIGZjT3B0aW9ucyA9IGxhbmdPcHRpb25IYXNoW2xhbmdDb2RlXSB8fCAobGFuZ09wdGlvbkhhc2hbbGFuZ0NvZGVdID0ge30pOwoKCS8vIHRyYW5zZmVyIHNvbWUgc2ltcGxlIG9wdGlvbnMgZnJvbSBkYXRlcGlja2VyIHRvIGZjCglmY09wdGlvbnMuaXNSVEwgPSBkcE9wdGlvbnMuaXNSVEw7CglmY09wdGlvbnMud2Vla051bWJlclRpdGxlID0gZHBPcHRpb25zLndlZWtIZWFkZXI7CgoJLy8gY29tcHV0ZSBzb21lIG1vcmUgY29tcGxleCBvcHRpb25zIGZyb20gZGF0ZXBpY2tlcgoJJC5lYWNoKGRwQ29tcHV0YWJsZU9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIGZ1bmMpIHsKCQlmY09wdGlvbnNbbmFtZV0gPSBmdW5jKGRwT3B0aW9ucyk7Cgl9KTsKCgkvLyBpcyBqUXVlcnkgVUkgRGF0ZXBpY2tlciBpcyBvbiB0aGUgcGFnZT8KCWlmICgkLmRhdGVwaWNrZXIpIHsKCgkJLy8gUmVnaXN0ZXIgdGhlIGxhbmd1YWdlIGRhdGEuCgkJLy8gRnVsbENhbGVuZGFyIGFuZCBNb21lbnRKUyB1c2UgbGFuZ3VhZ2UgY29kZXMgbGlrZSAicHQtYnIiIGJ1dCBEYXRlcGlja2VyCgkJLy8gZG9lcyBpdCBsaWtlICJwdC1CUiIgb3IgaWYgaXQgZG9lc24ndCBoYXZlIHRoZSBsYW5ndWFnZSwgbWF5YmUganVzdCAicHQiLgoJCS8vIE1ha2UgYW4gYWxpYXMgc28gdGhlIGxhbmd1YWdlIGNhbiBiZSByZWZlcmVuY2VkIGVpdGhlciB3YXkuCgkJJC5kYXRlcGlja2VyLnJlZ2lvbmFsW2RwTGFuZ0NvZGVdID0KCQkJJC5kYXRlcGlja2VyLnJlZ2lvbmFsW2xhbmdDb2RlXSA9IC8vIGFsaWFzCgkJCQlkcE9wdGlvbnM7CgoJCS8vIEFsaWFzICdlbicgdG8gdGhlIGRlZmF1bHQgbGFuZ3VhZ2UgZGF0YS4gRG8gdGhpcyBldmVyeSB0aW1lLgoJCSQuZGF0ZXBpY2tlci5yZWdpb25hbC5lbiA9ICQuZGF0ZXBpY2tlci5yZWdpb25hbFsnJ107CgoJCS8vIFNldCBhcyBEYXRlcGlja2VyJ3MgZ2xvYmFsIGRlZmF1bHRzLgoJCSQuZGF0ZXBpY2tlci5zZXREZWZhdWx0cyhkcE9wdGlvbnMpOwoJfQp9OwoKCi8vIFNldHMgRnVsbENhbGVuZGFyLXNwZWNpZmljIHRyYW5zbGF0aW9ucy4gV2lsbCBzZXQgdGhlIGxhbmd1YWdlIGFzIHRoZSBnbG9iYWwgZGVmYXVsdC4KZmMubGFuZyA9IGZ1bmN0aW9uKGxhbmdDb2RlLCBuZXdGY09wdGlvbnMpIHsKCXZhciBmY09wdGlvbnM7Cgl2YXIgbW9tT3B0aW9uczsKCgkvLyBnZXQgdGhlIEZ1bGxDYWxlbmRhciBpbnRlcm5hbCBvcHRpb24gaGFzaCBmb3IgdGhpcyBsYW5ndWFnZS4gY3JlYXRlIGlmIG5lY2Vzc2FyeQoJZmNPcHRpb25zID0gbGFuZ09wdGlvbkhhc2hbbGFuZ0NvZGVdIHx8IChsYW5nT3B0aW9uSGFzaFtsYW5nQ29kZV0gPSB7fSk7CgoJLy8gcHJvdmlkZWQgbmV3IG9wdGlvbnMgZm9yIHRoaXMgbGFuZ3VhZ2U\/IG1lcmdlIHRoZW0gaW4KCWlmIChuZXdGY09wdGlvbnMpIHsKCQltZXJnZU9wdGlvbnMoZmNPcHRpb25zLCBuZXdGY09wdGlvbnMpOwoJfQoKCS8vIGNvbXB1dGUgbGFuZ3VhZ2Ugb3B0aW9ucyB0aGF0IHdlcmVuJ3QgZGVmaW5lZC4KCS8vIGFsd2F5cyBkbyB0aGlzLiBuZXdGY09wdGlvbnMgY2FuIGJlIHVuZGVmaW5lZCB3aGVuIGluaXRpYWxpemluZyBmcm9tIGkxOG4gZmlsZSwKCS8vIHNvIG5vIHdheSB0byB0ZWxsIGlmIHRoaXMgaXMgYW4gaW5pdGlhbGl6YXRpb24gb3IgYSBkZWZhdWx0LXNldHRpbmcuCgltb21PcHRpb25zID0gZ2V0TW9tZW50TG9jYWxlRGF0YShsYW5nQ29kZSk7IC8vIHdpbGwgZmFsbCBiYWNrIHRvIGVuCgkkLmVhY2gobW9tQ29tcHV0YWJsZU9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIGZ1bmMpIHsKCQlpZiAoZmNPcHRpb25zW25hbWVdID09PSB1bmRlZmluZWQpIHsKCQkJZmNPcHRpb25zW25hbWVdID0gZnVuYyhtb21PcHRpb25zLCBmY09wdGlvbnMpOwoJCX0KCX0pOwoKCS8vIHNldCBpdCBhcyB0aGUgZGVmYXVsdCBsYW5ndWFnZSBmb3IgRnVsbENhbGVuZGFyCglkZWZhdWx0cy5sYW5nID0gbGFuZ0NvZGU7Cn07CgoKLy8gTk9URTogY2FuJ3QgZ3VhcmFudGVlIGFueSBvZiB0aGVzZSBjb21wdXRhdGlvbnMgd2lsbCBydW4gYmVjYXVzZSBub3QgZXZlcnkgbGFuZ3VhZ2UgaGFzIGRhdGVwaWNrZXIKLy8gY29uZmlncywgc28gbWFrZSBzdXJlIHRoZXJlIGFyZSBFbmdsaXNoIGZhbGxiYWNrcyBmb3IgdGhlc2UgaW4gdGhlIGRlZmF1bHRzIGZpbGUuCnZhciBkcENvbXB1dGFibGVPcHRpb25zID0gewoKCWRlZmF1bHRCdXR0b25UZXh0OiBmdW5jdGlvbihkcE9wdGlvbnMpIHsKCQlyZXR1cm4gewoJCQkvLyB0aGUgdHJhbnNsYXRpb25zIHNvbWV0aW1lcyB3cm9uZ2x5IGNvbnRhaW4gSFRNTCBlbnRpdGllcwoJCQlwcmV2OiBzdHJpcEh0bWxFbnRpdGllcyhkcE9wdGlvbnMucHJldlRleHQpLAoJCQluZXh0OiBzdHJpcEh0bWxFbnRpdGllcyhkcE9wdGlvbnMubmV4dFRleHQpLAoJCQl0b2RheTogc3RyaXBIdG1sRW50aXRpZXMoZHBPcHRpb25zLmN1cnJlbnRUZXh0KQoJCX07Cgl9LAoKCS8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgIk1NTU0gWVlZWSIgLT4gIlNlcHRlbWJlciAyMDE0IgoJbW9udGhZZWFyRm9ybWF0OiBmdW5jdGlvbihkcE9wdGlvbnMpIHsKCQlyZXR1cm4gZHBPcHRpb25zLnNob3dNb250aEFmdGVyWWVhciA\/CgkJCSdZWVlZWycgKyBkcE9wdGlvbnMueWVhclN1ZmZpeCArICddIE1NTU0nIDoKCQkJJ01NTU0gWVlZWVsnICsgZHBPcHRpb25zLnllYXJTdWZmaXggKyAnXSc7Cgl9Cgp9OwoKdmFyIG1vbUNvbXB1dGFibGVPcHRpb25zID0gewoKCS8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgImRkZCBNTS9ERCIgLT4gIkZyaSAxMi8xMCIKCWRheU9mTW9udGhGb3JtYXQ6IGZ1bmN0aW9uKG1vbU9wdGlvbnMsIGZjT3B0aW9ucykgewoJCXZhciBmb3JtYXQgPSBtb21PcHRpb25zLmxvbmdEYXRlRm9ybWF0KCdsJyk7IC8vIGZvciB0aGUgZm9ybWF0IGxpa2UgIk0vRC9ZWVlZIgoKCQkvLyBzdHJpcCB0aGUgeWVhciBvZmYgdGhlIGVkZ2UsIGFzIHdlbGwgYXMgb3RoZXIgbWlzYyBub24td2hpdGVzcGFjZSBjaGFycwoJCWZvcm1hdCA9IGZvcm1hdC5yZXBsYWNlKC9eWStbXlx3XHNdKnxbXlx3XHNdKlkrJC9nLCAnJyk7CgoJCWlmIChmY09wdGlvbnMuaXNSVEwpIHsKCQkJZm9ybWF0ICs9ICcgZGRkJzsgLy8gZm9yIFJUTCwgYWRkIGRheS1vZi13ZWVrIHRvIGVuZAoJCX0KCQllbHNlIHsKCQkJZm9ybWF0ID0gJ2RkZCAnICsgZm9ybWF0OyAvLyBmb3IgTFRSLCBhZGQgZGF5LW9mLXdlZWsgdG8gYmVnaW5uaW5nCgkJfQoJCXJldHVybiBmb3JtYXQ7Cgl9LAoKCS8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgIkgoOm1tKWEiIC0+ICI2cG0iIG9yICI2OjMwcG0iCglzbWFsbFRpbWVGb3JtYXQ6IGZ1bmN0aW9uKG1vbU9wdGlvbnMpIHsKCQlyZXR1cm4gbW9tT3B0aW9ucy5sb25nRGF0ZUZvcm1hdCgnTFQnKQoJCQkucmVwbGFjZSgnOm1tJywgJyg6bW0pJykKCQkJLnJlcGxhY2UoLyhcV21tKSQvLCAnKCQxKScpIC8vIGxpa2UgYWJvdmUsIGJ1dCBmb3IgZm9yZWlnbiBsYW5ncwoJCQkucmVwbGFjZSgvXHMqYSQvaSwgJ2EnKTsgLy8gY29udmVydCBBTS9QTS9hbS9wbSB0byBsb3dlcmNhc2UuIHJlbW92ZSBhbnkgc3BhY2VzIGJlZm9yZWhhbmQKCX0sCgoJLy8gUHJvZHVjZXMgZm9ybWF0IHN0cmluZ3MgbGlrZSAiSCg6bW0pdCIgLT4gIjZwIiBvciAiNjozMHAiCglleHRyYVNtYWxsVGltZUZvcm1hdDogZnVuY3Rpb24obW9tT3B0aW9ucykgewoJCXJldHVybiBtb21PcHRpb25zLmxvbmdEYXRlRm9ybWF0KCdMVCcpCgkJCS5yZXBsYWNlKCc6bW0nLCAnKDptbSknKQoJCQkucmVwbGFjZSgvKFxXbW0pJC8sICcoJDEpJykgLy8gbGlrZSBhYm92ZSwgYnV0IGZvciBmb3JlaWduIGxhbmdzCgkJCS5yZXBsYWNlKC9ccyphJC9pLCAndCcpOyAvLyBjb252ZXJ0IHRvIEFNL1BNL2FtL3BtIHRvIGxvd2VyY2FzZSBvbmUtbGV0dGVyLiByZW1vdmUgYW55IHNwYWNlcyBiZWZvcmVoYW5kCgl9LAoKCS8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgIkg6bW0iIC0+ICI2OjMwIiAod2l0aCBubyBBTS9QTSkKCW5vTWVyaWRpZW1UaW1lRm9ybWF0OiBmdW5jdGlvbihtb21PcHRpb25zKSB7CgkJcmV0dXJuIG1vbU9wdGlvbnMubG9uZ0RhdGVGb3JtYXQoJ0xUJykKCQkJLnJlcGxhY2UoL1xzKmEkL2ksICcnKTsgLy8gcmVtb3ZlIHRyYWlsaW5nIEFNL1BNCgl9Cgp9OwoKCi8vIFJldHVybnMgbW9tZW50J3MgaW50ZXJuYWwgbG9jYWxlIGRhdGEuIElmIGRvZXNuJ3QgZXhpc3QsIHJldHVybnMgRW5nbGlzaC4KLy8gV29ya3Mgd2l0aCBtb21lbnQtcHJlLTIuOApmdW5jdGlvbiBnZXRNb21lbnRMb2NhbGVEYXRhKGxhbmdDb2RlKSB7Cgl2YXIgZnVuYyA9IG1vbWVudC5sb2NhbGVEYXRhIHx8IG1vbWVudC5sYW5nRGF0YTsKCXJldHVybiBmdW5jLmNhbGwobW9tZW50LCBsYW5nQ29kZSkgfHwKCQlmdW5jLmNhbGwobW9tZW50LCAnZW4nKTsgLy8gdGhlIG5ld2VyIGxvY2FsRGF0YSBjb3VsZCByZXR1cm4gbnVsbCwgc28gZmFsbCBiYWNrIHRvIGVuCn0KCgovLyBJbml0aWFsaXplIEVuZ2xpc2ggYnkgZm9yY2luZyBjb21wdXRhdGlvbiBvZiBtb21lbnQtZGVyaXZlZCBvcHRpb25zLgovLyBBbHNvLCBzZXRzIGl0IGFzIHRoZSBkZWZhdWx0LgpmYy5sYW5nKCdlbicsIGVuZ2xpc2hEZWZhdWx0cyk7Cgo7OwoKLy8gZXhwb3J0cwpmYy5pbnRlcnNlY3Rpb25Ub1NlZyA9IGludGVyc2VjdGlvblRvU2VnOwpmYy5hcHBseUFsbCA9IGFwcGx5QWxsOwpmYy5kZWJvdW5jZSA9IGRlYm91bmNlOwoKCi8qIEZ1bGxDYWxlbmRhci1zcGVjaWZpYyBET00gVXRpbGl0aWVzCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCi8vIEdpdmVuIHRoZSBzY3JvbGxiYXIgd2lkdGhzIG9mIHNvbWUgb3RoZXIgY29udGFpbmVyLCBjcmVhdGUgYm9yZGVycy9tYXJnaW5zIG9uIHJvd0VscyBpbiBvcmRlciB0byBtYXRjaCB0aGUgbGVmdAovLyBhbmQgcmlnaHQgc3BhY2UgdGhhdCB3YXMgb2Zmc2V0IGJ5IHRoZSBzY3JvbGxiYXJzLiBBIDEtcGl4ZWwgYm9yZGVyIGZpcnN0LCB0aGVuIG1hcmdpbiBiZXlvbmQgdGhhdC4KZnVuY3Rpb24gY29tcGVuc2F0ZVNjcm9sbChyb3dFbHMsIHNjcm9sbGJhcldpZHRocykgewoJaWYgKHNjcm9sbGJhcldpZHRocy5sZWZ0KSB7CgkJcm93RWxzLmNzcyh7CgkJCSdib3JkZXItbGVmdC13aWR0aCc6IDEsCgkJCSdtYXJnaW4tbGVmdCc6IHNjcm9sbGJhcldpZHRocy5sZWZ0IC0gMQoJCX0pOwoJfQoJaWYgKHNjcm9sbGJhcldpZHRocy5yaWdodCkgewoJCXJvd0Vscy5jc3MoewoJCQknYm9yZGVyLXJpZ2h0LXdpZHRoJzogMSwKCQkJJ21hcmdpbi1yaWdodCc6IHNjcm9sbGJhcldpZHRocy5yaWdodCAtIDEKCQl9KTsKCX0KfQoKCi8vIFVuZG9lcyBjb21wZW5zYXRlU2Nyb2xsIGFuZCByZXN0b3JlcyBhbGwgYm9yZGVycy9tYXJnaW5zCmZ1bmN0aW9uIHVuY29tcGVuc2F0ZVNjcm9sbChyb3dFbHMpIHsKCXJvd0Vscy5jc3MoewoJCSdtYXJnaW4tbGVmdCc6ICcnLAoJCSdtYXJnaW4tcmlnaHQnOiAnJywKCQknYm9yZGVyLWxlZnQtd2lkdGgnOiAnJywKCQknYm9yZGVyLXJpZ2h0LXdpZHRoJzogJycKCX0pOwp9CgoKLy8gTWFrZSB0aGUgbW91c2UgY3Vyc29yIGV4cHJlc3MgdGhhdCBhbiBldmVudCBpcyBub3QgYWxsb3dlZCBpbiB0aGUgY3VycmVudCBhcmVhCmZ1bmN0aW9uIGRpc2FibGVDdXJzb3IoKSB7CgkkKCdib2R5JykuYWRkQ2xhc3MoJ2ZjLW5vdC1hbGxvd2VkJyk7Cn0KCgovLyBSZXR1cm5zIHRoZSBtb3VzZSBjdXJzb3IgdG8gaXRzIG9yaWdpbmFsIGxvb2sKZnVuY3Rpb24gZW5hYmxlQ3Vyc29yKCkgewoJJCgnYm9keScpLnJlbW92ZUNsYXNzKCdmYy1ub3QtYWxsb3dlZCcpOwp9CgoKLy8gR2l2ZW4gYSB0b3RhbCBhdmFpbGFibGUgaGVpZ2h0IHRvIGZpbGwsIGhhdmUgYGVsc2AgKGVzc2VudGlhbGx5IGNoaWxkIHJvd3MpIGV4cGFuZCB0byBhY2NvbW9kYXRlLgovLyBCeSBkZWZhdWx0LCBhbGwgZWxlbWVudHMgdGhhdCBhcmUgc2hvcnRlciB0aGFuIHRoZSByZWNvbW1lbmRlZCBoZWlnaHQgYXJlIGV4cGFuZGVkIHVuaWZvcm1seSwgbm90IGNvbnNpZGVyaW5nCi8vIGFueSBvdGhlciBlbHMgdGhhdCBhcmUgYWxyZWFkeSB0b28gdGFsbC4gaWYgYHNob3VsZFJlZGlzdHJpYnV0ZWAgaXMgb24sIGl0IGNvbnNpZGVycyB0aGVzZSB0YWxsIHJvd3MgYW5kIAovLyByZWR1Y2VzIHRoZSBhdmFpbGFibGUgaGVpZ2h0LgpmdW5jdGlvbiBkaXN0cmlidXRlSGVpZ2h0KGVscywgYXZhaWxhYmxlSGVpZ2h0LCBzaG91bGRSZWRpc3RyaWJ1dGUpIHsKCgkvLyAqRkxPT1JJTkcgTk9URSo6IHdlIGZsb29yIGluIGNlcnRhaW4gcGxhY2VzIGJlY2F1c2Ugem9vbSBjYW4gZ2l2ZSBpbmFjY3VyYXRlIGZsb2F0aW5nLXBvaW50IGRpbWVuc2lvbnMsCgkvLyBhbmQgaXQgaXMgYmV0dGVyIHRvIGJlIHNob3J0ZXIgdGhhbiB0YWxsZXIsIHRvIGF2b2lkIGNyZWF0aW5nIHVubmVjZXNzYXJ5IHNjcm9sbGJhcnMuCgoJdmFyIG1pbk9mZnNldDEgPSBNYXRoLmZsb29yKGF2YWlsYWJsZUhlaWdodCAvIGVscy5sZW5ndGgpOyAvLyBmb3Igbm9uLWxhc3QgZWxlbWVudAoJdmFyIG1pbk9mZnNldDIgPSBNYXRoLmZsb29yKGF2YWlsYWJsZUhlaWdodCAtIG1pbk9mZnNldDEgKiAoZWxzLmxlbmd0aCAtIDEpKTsgLy8gZm9yIGxhc3QgZWxlbWVudCAqRkxPT1JJTkcgTk9URSoKCXZhciBmbGV4RWxzID0gW107IC8vIGVsZW1lbnRzIHRoYXQgYXJlIGFsbG93ZWQgdG8gZXhwYW5kLiBhcnJheSBvZiBET00gbm9kZXMKCXZhciBmbGV4T2Zmc2V0cyA9IFtdOyAvLyBhbW91bnQgb2YgdmVydGljYWwgc3BhY2UgaXQgdGFrZXMgdXAKCXZhciBmbGV4SGVpZ2h0cyA9IFtdOyAvLyBhY3R1YWwgY3NzIGhlaWdodAoJdmFyIHVzZWRIZWlnaHQgPSAwOwoKCXVuZGlzdHJpYnV0ZUhlaWdodChlbHMpOyAvLyBnaXZlIGFsbCBlbGVtZW50cyB0aGVpciBuYXR1cmFsIGhlaWdodAoKCS8vIGZpbmQgZWxlbWVudHMgdGhhdCBhcmUgYmVsb3cgdGhlIHJlY29tbWVuZGVkIGhlaWdodCAoZXhwYW5kYWJsZSkuCgkvLyBpbXBvcnRhbnQgdG8gcXVlcnkgZm9yIGhlaWdodHMgaW4gYSBzaW5nbGUgZmlyc3QgcGFzcyAodG8gYXZvaWQgcmVmbG93IG9zY2lsbGF0aW9uKS4KCWVscy5lYWNoKGZ1bmN0aW9uKGksIGVsKSB7CgkJdmFyIG1pbk9mZnNldCA9IGkgPT09IGVscy5sZW5ndGggLSAxID8gbWluT2Zmc2V0MiA6IG1pbk9mZnNldDE7CgkJdmFyIG5hdHVyYWxPZmZzZXQgPSAkKGVsKS5vdXRlckhlaWdodCh0cnVlKTsKCgkJaWYgKG5hdHVyYWxPZmZzZXQgPCBtaW5PZmZzZXQpIHsKCQkJZmxleEVscy5wdXNoKGVsKTsKCQkJZmxleE9mZnNldHMucHVzaChuYXR1cmFsT2Zmc2V0KTsKCQkJZmxleEhlaWdodHMucHVzaCgkKGVsKS5oZWlnaHQoKSk7CgkJfQoJCWVsc2UgewoJCQkvLyB0aGlzIGVsZW1lbnQgc3RyZXRjaGVzIHBhc3QgcmVjb21tZW5kZWQgaGVpZ2h0IChub24tZXhwYW5kYWJsZSkuIG1hcmsgdGhlIHNwYWNlIGFzIG9jY3VwaWVkLgoJCQl1c2VkSGVpZ2h0ICs9IG5hdHVyYWxPZmZzZXQ7CgkJfQoJfSk7CgoJLy8gcmVhZGp1c3QgdGhlIHJlY29tbWVuZGVkIGhlaWdodCB0byBvbmx5IGNvbnNpZGVyIHRoZSBoZWlnaHQgYXZhaWxhYmxlIHRvIG5vbi1tYXhlZC1vdXQgcm93cy4KCWlmIChzaG91bGRSZWRpc3RyaWJ1dGUpIHsKCQlhdmFpbGFibGVIZWlnaHQgLT0gdXNlZEhlaWdodDsKCQltaW5PZmZzZXQxID0gTWF0aC5mbG9vcihhdmFpbGFibGVIZWlnaHQgLyBmbGV4RWxzLmxlbmd0aCk7CgkJbWluT2Zmc2V0MiA9IE1hdGguZmxvb3IoYXZhaWxhYmxlSGVpZ2h0IC0gbWluT2Zmc2V0MSAqIChmbGV4RWxzLmxlbmd0aCAtIDEpKTsgLy8gKkZMT09SSU5HIE5PVEUqCgl9CgoJLy8gYXNzaWduIGhlaWdodHMgdG8gYWxsIGV4cGFuZGFibGUgZWxlbWVudHMKCSQoZmxleEVscykuZWFjaChmdW5jdGlvbihpLCBlbCkgewoJCXZhciBtaW5PZmZzZXQgPSBpID09PSBmbGV4RWxzLmxlbmd0aCAtIDEgPyBtaW5PZmZzZXQyIDogbWluT2Zmc2V0MTsKCQl2YXIgbmF0dXJhbE9mZnNldCA9IGZsZXhPZmZzZXRzW2ldOwoJCXZhciBuYXR1cmFsSGVpZ2h0ID0gZmxleEhlaWdodHNbaV07CgkJdmFyIG5ld0hlaWdodCA9IG1pbk9mZnNldCAtIChuYXR1cmFsT2Zmc2V0IC0gbmF0dXJhbEhlaWdodCk7IC8vIHN1YnRyYWN0IHRoZSBtYXJnaW4vcGFkZGluZwoKCQlpZiAobmF0dXJhbE9mZnNldCA8IG1pbk9mZnNldCkgeyAvLyB3ZSBjaGVjayB0aGlzIGFnYWluIGJlY2F1c2UgcmVkaXN0cmlidXRpb24gbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoaW5ncwoJCQkkKGVsKS5oZWlnaHQobmV3SGVpZ2h0KTsKCQl9Cgl9KTsKfQoKCi8vIFVuZG9lcyBkaXN0cnVidXRlSGVpZ2h0LCByZXN0b3JpbmcgYWxsIGVscyB0byB0aGVpciBuYXR1cmFsIGhlaWdodApmdW5jdGlvbiB1bmRpc3RyaWJ1dGVIZWlnaHQoZWxzKSB7CgllbHMuaGVpZ2h0KCcnKTsKfQoKCi8vIEdpdmVuIGBlbHNgLCBhIGpRdWVyeSBzZXQgb2YgPHRkPiBjZWxscywgZmluZCB0aGUgY2VsbCB3aXRoIHRoZSBsYXJnZXN0IG5hdHVyYWwgd2lkdGggYW5kIHNldCB0aGUgd2lkdGhzIG9mIGFsbCB0aGUKLy8gY2VsbHMgdG8gYmUgdGhhdCB3aWR0aC4KLy8gUFJFUkVRVUlTSVRFOiBpZiB5b3Ugd2FudCBhIGNlbGwgdG8gdGFrZSB1cCB3aWR0aCwgaXQgbmVlZHMgdG8gaGF2ZSBhIHNpbmdsZSBpbm5lciBlbGVtZW50IHcvIGRpc3BsYXk6aW5saW5lCmZ1bmN0aW9uIG1hdGNoQ2VsbFdpZHRocyhlbHMpIHsKCXZhciBtYXhJbm5lcldpZHRoID0gMDsKCgllbHMuZmluZCgnPiAqJykuZWFjaChmdW5jdGlvbihpLCBpbm5lckVsKSB7CgkJdmFyIGlubmVyV2lkdGggPSAkKGlubmVyRWwpLm91dGVyV2lkdGgoKTsKCQlpZiAoaW5uZXJXaWR0aCA+IG1heElubmVyV2lkdGgpIHsKCQkJbWF4SW5uZXJXaWR0aCA9IGlubmVyV2lkdGg7CgkJfQoJfSk7CgoJbWF4SW5uZXJXaWR0aCsrOyAvLyBzb21ldGltZXMgbm90IGFjY3VyYXRlIG9mIHdpZHRoIHRoZSB0ZXh0IG5lZWRzIHRvIHN0YXkgb24gb25lIGxpbmUuIGluc3VyYW5jZQoKCWVscy53aWR0aChtYXhJbm5lcldpZHRoKTsKCglyZXR1cm4gbWF4SW5uZXJXaWR0aDsKfQoKCi8vIFR1cm5zIGEgY29udGFpbmVyIGVsZW1lbnQgaW50byBhIHNjcm9sbGVyIGlmIGl0cyBjb250ZW50cyBpcyB0YWxsZXIgdGhhbiB0aGUgYWxsb3R0ZWQgaGVpZ2h0LgovLyBSZXR1cm5zIHRydWUgaWYgdGhlIGVsZW1lbnQgaXMgbm93IGEgc2Nyb2xsZXIsIGZhbHNlIG90aGVyd2lzZS4KLy8gTk9URTogdGhpcyBtZXRob2QgaXMgYmVzdCBiZWNhdXNlIGl0IHRha2VzIHdlaXJkIHpvb21pbmcgZGltZW5zaW9ucyBpbnRvIGFjY291bnQKZnVuY3Rpb24gc2V0UG90ZW50aWFsU2Nyb2xsZXIoY29udGFpbmVyRWwsIGhlaWdodCkgewoJY29udGFpbmVyRWwuaGVpZ2h0KGhlaWdodCkuYWRkQ2xhc3MoJ2ZjLXNjcm9sbGVyJyk7CgoJLy8gYXJlIHNjcm9sbGJhcnMgbmVlZGVkPwoJaWYgKGNvbnRhaW5lckVsWzBdLnNjcm9sbEhlaWdodCAtIDEgPiBjb250YWluZXJFbFswXS5jbGllbnRIZWlnaHQpIHsgLy8gISEhIC0xIGJlY2F1c2UgSUUgaXMgb2Z0ZW4gb2ZmLWJ5LW9uZSA6KAoJCXJldHVybiB0cnVlOwoJfQoKCXVuc2V0U2Nyb2xsZXIoY29udGFpbmVyRWwpOyAvLyB1bmRvCglyZXR1cm4gZmFsc2U7Cn0KCgovLyBUYWtlcyBhbiBlbGVtZW50IHRoYXQgbWlnaHQgaGF2ZSBiZWVuIGEgc2Nyb2xsZXIsIGFuZCB0dXJucyBpdCBiYWNrIGludG8gYSBub3JtYWwgZWxlbWVudC4KZnVuY3Rpb24gdW5zZXRTY3JvbGxlcihjb250YWluZXJFbCkgewoJY29udGFpbmVyRWwuaGVpZ2h0KCcnKS5yZW1vdmVDbGFzcygnZmMtc2Nyb2xsZXInKTsKfQoKCi8qIEdlbmVyYWwgRE9NIFV0aWxpdGllcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgovLyBib3Jyb3dlZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LXVpL2Jsb2IvMS4xMS4wL3VpL2NvcmUuanMjTDUxCmZ1bmN0aW9uIGdldFNjcm9sbFBhcmVudChlbCkgewoJdmFyIHBvc2l0aW9uID0gZWwuY3NzKCdwb3NpdGlvbicpLAoJCXNjcm9sbFBhcmVudCA9IGVsLnBhcmVudHMoKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXZhciBwYXJlbnQgPSAkKHRoaXMpOwoJCQlyZXR1cm4gKC8oYXV0b3xzY3JvbGwpLykudGVzdCgKCQkJCXBhcmVudC5jc3MoJ292ZXJmbG93JykgKyBwYXJlbnQuY3NzKCdvdmVyZmxvdy15JykgKyBwYXJlbnQuY3NzKCdvdmVyZmxvdy14JykKCQkJKTsKCQl9KS5lcSgwKTsKCglyZXR1cm4gcG9zaXRpb24gPT09ICdmaXhlZCcgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKGVsWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpIDogc2Nyb2xsUGFyZW50Owp9CgoKLy8gR2l2ZW4gYSBjb250YWluZXIgZWxlbWVudCwgcmV0dXJuIGFuIG9iamVjdCB3aXRoIHRoZSBwaXhlbCB2YWx1ZXMgb2YgdGhlIGxlZnQvcmlnaHQgc2Nyb2xsYmFycy4KLy8gTGVmdCBzY3JvbGxiYXJzIG1pZ2h0IG9jY3VyIG9uIFJUTCBicm93c2VycyAoSUUgbWF5YmU\/KSBidXQgSSBoYXZlIG5vdCB0ZXN0ZWQuCi8vIFBSRVJFUVVJU0lURTogY29udGFpbmVyIGVsZW1lbnQgbXVzdCBoYXZlIGEgc2luZ2xlIGNoaWxkIHdpdGggZGlzcGxheTpibG9jawpmdW5jdGlvbiBnZXRTY3JvbGxiYXJXaWR0aHMoY29udGFpbmVyKSB7Cgl2YXIgY29udGFpbmVyTGVmdCA9IGNvbnRhaW5lci5vZmZzZXQoKS5sZWZ0OwoJdmFyIGNvbnRhaW5lclJpZ2h0ID0gY29udGFpbmVyTGVmdCArIGNvbnRhaW5lci53aWR0aCgpOwoJdmFyIGlubmVyID0gY29udGFpbmVyLmNoaWxkcmVuKCk7Cgl2YXIgaW5uZXJMZWZ0ID0gaW5uZXIub2Zmc2V0KCkubGVmdDsKCXZhciBpbm5lclJpZ2h0ID0gaW5uZXJMZWZ0ICsgaW5uZXIub3V0ZXJXaWR0aCgpOwoKCXJldHVybiB7CgkJbGVmdDogaW5uZXJMZWZ0IC0gY29udGFpbmVyTGVmdCwKCQlyaWdodDogY29udGFpbmVyUmlnaHQgLSBpbm5lclJpZ2h0Cgl9Owp9CgoKLy8gUmV0dXJucyBhIGJvb2xlYW4gd2hldGhlciB0aGlzIHdhcyBhIGxlZnQgbW91c2UgY2xpY2sgYW5kIG5vIGN0cmwga2V5ICh3aGljaCBtZWFucyByaWdodCBjbGljayBvbiBNYWMpCmZ1bmN0aW9uIGlzUHJpbWFyeU1vdXNlQnV0dG9uKGV2KSB7CglyZXR1cm4gZXYud2hpY2ggPT0gMSAmJiAhZXYuY3RybEtleTsKfQoKCi8qIEZ1bGxDYWxlbmRhci1zcGVjaWZpYyBNaXNjIFV0aWxpdGllcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgovLyBDcmVhdGVzIGEgYmFzaWMgc2VnbWVudCB3aXRoIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHR3byByYW5nZXMuIFJldHVybnMgdW5kZWZpbmVkIGlmIG5vIGludGVyc2VjdGlvbi4KLy8gRXhwZWN0cyBhbGwgZGF0ZXMgdG8gYmUgbm9ybWFsaXplZCB0byB0aGUgc2FtZSB0aW1lem9uZSBiZWZvcmVoYW5kLgovLyBUT0RPOiBtb3ZlIHRvIGRhdGUgc2VjdGlvbj8KZnVuY3Rpb24gaW50ZXJzZWN0aW9uVG9TZWcoc3ViamVjdFJhbmdlLCBjb25zdHJhaW50UmFuZ2UpIHsKCXZhciBzdWJqZWN0U3RhcnQgPSBzdWJqZWN0UmFuZ2Uuc3RhcnQ7Cgl2YXIgc3ViamVjdEVuZCA9IHN1YmplY3RSYW5nZS5lbmQ7Cgl2YXIgY29uc3RyYWludFN0YXJ0ID0gY29uc3RyYWludFJhbmdlLnN0YXJ0OwoJdmFyIGNvbnN0cmFpbnRFbmQgPSBjb25zdHJhaW50UmFuZ2UuZW5kOwoJdmFyIHNlZ1N0YXJ0LCBzZWdFbmQ7Cgl2YXIgaXNTdGFydCwgaXNFbmQ7CgoJaWYgKHN1YmplY3RFbmQgPiBjb25zdHJhaW50U3RhcnQgJiYgc3ViamVjdFN0YXJ0IDwgY29uc3RyYWludEVuZCkgeyAvLyBpbiBib3VuZHMgYXQgYWxsPwoKCQlpZiAoc3ViamVjdFN0YXJ0ID49IGNvbnN0cmFpbnRTdGFydCkgewoJCQlzZWdTdGFydCA9IHN1YmplY3RTdGFydC5jbG9uZSgpOwoJCQlpc1N0YXJ0ID0gdHJ1ZTsKCQl9CgkJZWxzZSB7CgkJCXNlZ1N0YXJ0ID0gY29uc3RyYWludFN0YXJ0LmNsb25lKCk7CgkJCWlzU3RhcnQgPSAgZmFsc2U7CgkJfQoKCQlpZiAoc3ViamVjdEVuZCA8PSBjb25zdHJhaW50RW5kKSB7CgkJCXNlZ0VuZCA9IHN1YmplY3RFbmQuY2xvbmUoKTsKCQkJaXNFbmQgPSB0cnVlOwoJCX0KCQllbHNlIHsKCQkJc2VnRW5kID0gY29uc3RyYWludEVuZC5jbG9uZSgpOwoJCQlpc0VuZCA9IGZhbHNlOwoJCX0KCgkJcmV0dXJuIHsKCQkJc3RhcnQ6IHNlZ1N0YXJ0LAoJCQllbmQ6IHNlZ0VuZCwKCQkJaXNTdGFydDogaXNTdGFydCwKCQkJaXNFbmQ6IGlzRW5kCgkJfTsKCX0KfQoKCmZ1bmN0aW9uIHNtYXJ0UHJvcGVydHkob2JqLCBuYW1lKSB7IC8vIGdldCBhIGNhbWVsLWNhc2VkL25hbWVzcGFjZWQgcHJvcGVydHkgb2YgYW4gb2JqZWN0CglvYmogPSBvYmogfHwge307CglpZiAob2JqW25hbWVdICE9PSB1bmRlZmluZWQpIHsKCQlyZXR1cm4gb2JqW25hbWVdOwoJfQoJdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgvKD89W0EtWl0pLyksCgkJaSA9IHBhcnRzLmxlbmd0aCAtIDEsIHJlczsKCWZvciAoOyBpPj0wOyBpLS0pIHsKCQlyZXMgPSBvYmpbcGFydHNbaV0udG9Mb3dlckNhc2UoKV07CgkJaWYgKHJlcyAhPT0gdW5kZWZpbmVkKSB7CgkJCXJldHVybiByZXM7CgkJfQoJfQoJcmV0dXJuIG9ialsnZGVmYXVsdCddOwp9CgoKLyogRGF0ZSBVdGlsaXRpZXMKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgp2YXIgZGF5SURzID0gWyAnc3VuJywgJ21vbicsICd0dWUnLCAnd2VkJywgJ3RodScsICdmcmknLCAnc2F0JyBdOwp2YXIgaW50ZXJ2YWxVbml0cyA9IFsgJ3llYXInLCAnbW9udGgnLCAnd2VlaycsICdkYXknLCAnaG91cicsICdtaW51dGUnLCAnc2Vjb25kJywgJ21pbGxpc2Vjb25kJyBdOwoKCi8vIERpZmZzIHRoZSB0d28gbW9tZW50cyBpbnRvIGEgRHVyYXRpb24gd2hlcmUgZnVsbC1kYXlzIGFyZSByZWNvcmRlZCBmaXJzdCwgdGhlbiB0aGUgcmVtYWluaW5nIHRpbWUuCi8vIE1vbWVudHMgd2lsbCBoYXZlIHRoZWlyIHRpbWV6b25lcyBub3JtYWxpemVkLgpmdW5jdGlvbiBkaWZmRGF5VGltZShhLCBiKSB7CglyZXR1cm4gbW9tZW50LmR1cmF0aW9uKHsKCQlkYXlzOiBhLmNsb25lKCkuc3RyaXBUaW1lKCkuZGlmZihiLmNsb25lKCkuc3RyaXBUaW1lKCksICdkYXlzJyksCgkJbXM6IGEudGltZSgpIC0gYi50aW1lKCkgLy8gdGltZS1vZi1kYXkgZnJvbSBkYXkgc3RhcnQuIGRpc3JlZ2FyZHMgdGltZXpvbmUKCX0pOwp9CgoKLy8gRGlmZnMgdGhlIHR3byBtb21lbnRzIHZpYSB0aGVpciBzdGFydC1vZi1kYXkgKHJlZ2FyZGxlc3Mgb2YgdGltZXpvbmUpLiBQcm9kdWNlcyB3aG9sZS1kYXkgZHVyYXRpb25zLgpmdW5jdGlvbiBkaWZmRGF5KGEsIGIpIHsKCXJldHVybiBtb21lbnQuZHVyYXRpb24oewoJCWRheXM6IGEuY2xvbmUoKS5zdHJpcFRpbWUoKS5kaWZmKGIuY2xvbmUoKS5zdHJpcFRpbWUoKSwgJ2RheXMnKQoJfSk7Cn0KCgovLyBDb21wdXRlcyB0aGUgbGFyZ2VzIHdob2xlLXVuaXQgcGVyaW9kIG9mIHRpbWUsIGFzIGEgZHVyYXRpb24gb2JqZWN0LgovLyBGb3IgZXhhbXBsZSwgNDggaG91cnMgd2lsbCBiZSB7ZGF5czoyfSB3aGVyZWFzIDQ5IGhvdXJzIHdpbGwgYmUge2hvdXJzOjQ5fS4KLy8gQWNjZXB0cyBzdGFydC9lbmQsIGEgcmFuZ2Ugb2JqZWN0LCBvciBhbiBvcmlnaW5hbCBkdXJhdGlvbiBvYmplY3QuCi8qIChuZXZlciB1c2VkKQpmdW5jdGlvbiBjb21wdXRlSW50ZXJ2YWxEdXJhdGlvbihzdGFydCwgZW5kKSB7Cgl2YXIgZHVyYXRpb25JbnB1dCA9IHt9OwoJdmFyIGksIHVuaXQ7Cgl2YXIgdmFsOwoKCWZvciAoaSA9IDA7IGkgPCBpbnRlcnZhbFVuaXRzLmxlbmd0aDsgaSsrKSB7CgkJdW5pdCA9IGludGVydmFsVW5pdHNbaV07CgkJdmFsID0gY29tcHV0ZUludGVydmFsQXModW5pdCwgc3RhcnQsIGVuZCk7CgkJaWYgKHZhbCkgewoJCQlicmVhazsKCQl9Cgl9CgoJZHVyYXRpb25JbnB1dFt1bml0XSA9IHZhbDsKCXJldHVybiBtb21lbnQuZHVyYXRpb24oZHVyYXRpb25JbnB1dCk7Cn0KKi8KCgovLyBDb21wdXRlcyB0aGUgdW5pdCBuYW1lIG9mIHRoZSBsYXJnZXN0IHdob2xlLXVuaXQgcGVyaW9kIG9mIHRpbWUuCi8vIEZvciBleGFtcGxlLCA0OCBob3VycyB3aWxsIGJlICJkYXlzIiB3aGVyZXdhcyA0OSBob3VycyB3aWxsIGJlICJob3VycyIuCi8vIEFjY2VwdHMgc3RhcnQvZW5kLCBhIHJhbmdlIG9iamVjdCwgb3IgYW4gb3JpZ2luYWwgZHVyYXRpb24gb2JqZWN0LgpmdW5jdGlvbiBjb21wdXRlSW50ZXJ2YWxVbml0KHN0YXJ0LCBlbmQpIHsKCXZhciBpLCB1bml0OwoKCWZvciAoaSA9IDA7IGkgPCBpbnRlcnZhbFVuaXRzLmxlbmd0aDsgaSsrKSB7CgkJdW5pdCA9IGludGVydmFsVW5pdHNbaV07CgkJaWYgKGNvbXB1dGVJbnRlcnZhbEFzKHVuaXQsIHN0YXJ0LCBlbmQpKSB7CgkJCWJyZWFrOwoJCX0KCX0KCglyZXR1cm4gdW5pdDsgLy8gd2lsbCBiZSAibWlsbGlzZWNvbmRzIiBpZiBub3RoaW5nIGVsc2UgbWF0Y2hlcwp9CgoKLy8gQ29tcHV0ZXMgdGhlIG51bWJlciBvZiB1bml0cyB0aGUgaW50ZXJ2YWwgaXMgY2xlYW5seSBjb21wcmlzZWQgb2YuCi8vIElmIHRoZSBnaXZlbiB1bml0IGRvZXMgbm90IGNsZWFubHkgZGl2aWRlIHRoZSBpbnRlcnZhbCBhIHdob2xlIG51bWJlciBvZiB0aW1lcywgYGZhbHNlYCBpcyByZXR1cm5lZC4KLy8gQWNjZXB0cyBzdGFydC9lbmQsIGEgcmFuZ2Ugb2JqZWN0LCBvciBhbiBvcmlnaW5hbCBkdXJhdGlvbiBvYmplY3QuCmZ1bmN0aW9uIGNvbXB1dGVJbnRlcnZhbEFzKHVuaXQsIHN0YXJ0LCBlbmQpIHsKCXZhciB2YWw7CgoJaWYgKGVuZCAhPSBudWxsKSB7IC8vIGdpdmVuIHN0YXJ0LCBlbmQKCQl2YWwgPSBlbmQuZGlmZihzdGFydCwgdW5pdCwgdHJ1ZSk7Cgl9CgllbHNlIGlmIChtb21lbnQuaXNEdXJhdGlvbihzdGFydCkpIHsgLy8gZ2l2ZW4gZHVyYXRpb24KCQl2YWwgPSBzdGFydC5hcyh1bml0KTsKCX0KCWVsc2UgeyAvLyBnaXZlbiB7IHN0YXJ0LCBlbmQgfSByYW5nZSBvYmplY3QKCQl2YWwgPSBzdGFydC5lbmQuZGlmZihzdGFydC5zdGFydCwgdW5pdCwgdHJ1ZSk7Cgl9CgoJaWYgKHZhbCA+PSAxICYmIGlzSW50KHZhbCkpIHsKCQlyZXR1cm4gdmFsOwoJfQoKCXJldHVybiBmYWxzZTsKfQoKCmZ1bmN0aW9uIGlzTmF0aXZlRGF0ZShpbnB1dCkgewoJcmV0dXJuICBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBEYXRlXScgfHwgaW5wdXQgaW5zdGFuY2VvZiBEYXRlOwp9CgoKLy8gUmV0dXJucyBhIGJvb2xlYW4gYWJvdXQgd2hldGhlciB0aGUgZ2l2ZW4gaW5wdXQgaXMgYSB0aW1lIHN0cmluZywgbGlrZSAiMDY6NDA6MDAiIG9yICIwNjowMCIKZnVuY3Rpb24gaXNUaW1lU3RyaW5nKHN0cikgewoJcmV0dXJuIC9eXGQrXDpcZCsoPzpcOlxkK1wuPyg\/OlxkezN9KT8pPyQvLnRlc3Qoc3RyKTsKfQoKCi8qIEdlbmVyYWwgVXRpbGl0aWVzCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKdmFyIGhhc093blByb3BNZXRob2QgPSB7fS5oYXNPd25Qcm9wZXJ0eTsKCgovLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgaGFzIHRoZSBnaXZlbiBwcm90b3R5cGUuIEp1c3QgbGlrZSBPYmplY3QuY3JlYXRlCmZ1bmN0aW9uIGNyZWF0ZU9iamVjdChwcm90bykgewoJdmFyIGYgPSBmdW5jdGlvbigpIHt9OwoJZi5wcm90b3R5cGUgPSBwcm90bzsKCXJldHVybiBuZXcgZigpOwp9CgoKZnVuY3Rpb24gY29weU93blByb3BzKHNyYywgZGVzdCkgewoJZm9yICh2YXIgbmFtZSBpbiBzcmMpIHsKCQlpZiAoaGFzT3duUHJvcChzcmMsIG5hbWUpKSB7CgkJCWRlc3RbbmFtZV0gPSBzcmNbbmFtZV07CgkJfQoJfQp9CgoKZnVuY3Rpb24gaGFzT3duUHJvcChvYmosIG5hbWUpIHsKCXJldHVybiBoYXNPd25Qcm9wTWV0aG9kLmNhbGwob2JqLCBuYW1lKTsKfQoKCi8vIElzIHRoZSBnaXZlbiB2YWx1ZSBhIG5vbi1vYmplY3Qgbm9uLWZ1bmN0aW9uIHZhbHVlPwpmdW5jdGlvbiBpc0F0b21pYyh2YWwpIHsKCXJldHVybiAvdW5kZWZpbmVkfG51bGx8Ym9vbGVhbnxudW1iZXJ8c3RyaW5nLy50ZXN0KCQudHlwZSh2YWwpKTsKfQoKCmZ1bmN0aW9uIGFwcGx5QWxsKGZ1bmN0aW9ucywgdGhpc09iaiwgYXJncykgewoJaWYgKCQuaXNGdW5jdGlvbihmdW5jdGlvbnMpKSB7CgkJZnVuY3Rpb25zID0gWyBmdW5jdGlvbnMgXTsKCX0KCWlmIChmdW5jdGlvbnMpIHsKCQl2YXIgaTsKCQl2YXIgcmV0OwoJCWZvciAoaT0wOyBpPGZ1bmN0aW9ucy5sZW5ndGg7IGkrKykgewoJCQlyZXQgPSBmdW5jdGlvbnNbaV0uYXBwbHkodGhpc09iaiwgYXJncykgfHwgcmV0OwoJCX0KCQlyZXR1cm4gcmV0OwoJfQp9CgoKZnVuY3Rpb24gZmlyc3REZWZpbmVkKCkgewoJZm9yICh2YXIgaT0wOyBpPGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCWlmIChhcmd1bWVudHNbaV0gIT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gYXJndW1lbnRzW2ldOwoJCX0KCX0KfQoKCmZ1bmN0aW9uIGh0bWxFc2NhcGUocykgewoJcmV0dXJuIChzICsgJycpLnJlcGxhY2UoLyYvZywgJyZhbXA7JykKCQkucmVwbGFjZSgvPC9nLCAnJmx0OycpCgkJLnJlcGxhY2UoLz4vZywgJyZndDsnKQoJCS5yZXBsYWNlKC8nL2csICcmIzAzOTsnKQoJCS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKQoJCS5yZXBsYWNlKC9cbi9nLCAnPGJyIC8+Jyk7Cn0KCgpmdW5jdGlvbiBzdHJpcEh0bWxFbnRpdGllcyh0ZXh0KSB7CglyZXR1cm4gdGV4dC5yZXBsYWNlKC8mLio\/Oy9nLCAnJyk7Cn0KCgpmdW5jdGlvbiBjYXBpdGFsaXNlRmlyc3RMZXR0ZXIoc3RyKSB7CglyZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwp9CgoKZnVuY3Rpb24gY29tcGFyZU51bWJlcnMoYSwgYikgeyAvLyBmb3IgLnNvcnQoKQoJcmV0dXJuIGEgLSBiOwp9CgoKZnVuY3Rpb24gaXNJbnQobikgewoJcmV0dXJuIG4gJSAxID09PSAwOwp9CgoKLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdAovLyBiZSB0cmlnZ2VyZWQuIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBhZnRlciBpdCBzdG9wcyBiZWluZyBjYWxsZWQgZm9yCi8vIE4gbWlsbGlzZWNvbmRzLgovLyBodHRwczovL2dpdGh1Yi5jb20vamFzaGtlbmFzL3VuZGVyc2NvcmUvYmxvYi8xLjYuMC91bmRlcnNjb3JlLmpzI0w3MTQKZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgd2FpdCkgewoJdmFyIHRpbWVvdXRJZDsKCXZhciBhcmdzOwoJdmFyIGNvbnRleHQ7Cgl2YXIgdGltZXN0YW1wOyAvLyBvZiBtb3N0IHJlY2VudCBjYWxsCgl2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKCQl2YXIgbGFzdCA9ICtuZXcgRGF0ZSgpIC0gdGltZXN0YW1wOwoJCWlmIChsYXN0IDwgd2FpdCAmJiBsYXN0ID4gMCkgewoJCQl0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0IC0gbGFzdCk7CgkJfQoJCWVsc2UgewoJCQl0aW1lb3V0SWQgPSBudWxsOwoJCQlmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwoJCQlpZiAoIXRpbWVvdXRJZCkgewoJCQkJY29udGV4dCA9IGFyZ3MgPSBudWxsOwoJCQl9CgkJfQoJfTsKCglyZXR1cm4gZnVuY3Rpb24oKSB7CgkJY29udGV4dCA9IHRoaXM7CgkJYXJncyA9IGFyZ3VtZW50czsKCQl0aW1lc3RhbXAgPSArbmV3IERhdGUoKTsKCQlpZiAoIXRpbWVvdXRJZCkgewoJCQl0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKCQl9Cgl9Owp9Cgo7OwoKdmFyIGFtYmlnRGF0ZU9mTW9udGhSZWdleCA9IC9eXHMqXGR7NH0tXGRcZCQvOwp2YXIgYW1iaWdUaW1lT3Jab25lUmVnZXggPQoJL15ccypcZHs0fS0oPzooXGRcZC1cZFxkKXwoV1xkXGQkKXwoV1xkXGQtXGQpfChcZFxkXGQpKSgoVHwgKShcZFxkKDpcZFxkKDpcZFxkKFwuXGQrKT8pPyk\/KT8pPyQvOwp2YXIgbmV3TW9tZW50UHJvdG8gPSBtb21lbnQuZm47IC8vIHdoZXJlIHdlIHdpbGwgYXR0YWNoIG91ciBuZXcgbWV0aG9kcwp2YXIgb2xkTW9tZW50UHJvdG8gPSAkLmV4dGVuZCh7fSwgbmV3TW9tZW50UHJvdG8pOyAvLyBjb3B5IG9mIG9yaWdpbmFsIG1vbWVudCBtZXRob2RzCnZhciBhbGxvd1ZhbHVlT3B0aW1pemF0aW9uOwp2YXIgc2V0VVRDVmFsdWVzOyAvLyBmdW5jdGlvbiBkZWZpbmVkIGJlbG93CnZhciBzZXRMb2NhbFZhbHVlczsgLy8gZnVuY3Rpb24gZGVmaW5lZCBiZWxvdwoKCi8vIENyZWF0aW5nCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIENyZWF0ZXMgYSBuZXcgbW9tZW50LCBzaW1pbGFyIHRvIHRoZSB2YW5pbGxhIG1vbWVudCguLi4pIGNvbnN0cnVjdG9yLCBidXQgd2l0aAovLyBleHRyYSBmZWF0dXJlcyAoYW1iaWd1b3VzIHRpbWUsIGVuaGFuY2VkIGZvcm1hdHRpbmcpLiBXaGVuIGdpdmVuIGFuIGV4aXN0aW5nIG1vbWVudCwKLy8gaXQgd2lsbCBmdW5jdGlvbiBhcyBhIGNsb25lIChhbmQgcmV0YWluIHRoZSB6b25lIG9mIHRoZSBtb21lbnQpLiBBbnl0aGluZyBlbHNlIHdpbGwKLy8gcmVzdWx0IGluIGEgbW9tZW50IGluIHRoZSBsb2NhbCB6b25lLgpmYy5tb21lbnQgPSBmdW5jdGlvbigpIHsKCXJldHVybiBtYWtlTW9tZW50KGFyZ3VtZW50cyk7Cn07CgovLyBTYW1lcyBhcyBmYy5tb21lbnQsIGJ1dCBmb3JjZXMgdGhlIHJlc3VsdGluZyBtb21lbnQgdG8gYmUgaW4gdGhlIFVUQyB0aW1lem9uZS4KZmMubW9tZW50LnV0YyA9IGZ1bmN0aW9uKCkgewoJdmFyIG1vbSA9IG1ha2VNb21lbnQoYXJndW1lbnRzLCB0cnVlKTsKCgkvLyBGb3JjZSBpdCBpbnRvIFVUQyBiZWNhdXNlIG1ha2VNb21lbnQgZG9lc24ndCBndWFyYW50ZWUgaXQKCS8vIChpZiBnaXZlbiBhIHByZS1leGlzdGluZyBtb21lbnQgZm9yIGV4YW1wbGUpCglpZiAobW9tLmhhc1RpbWUoKSkgeyAvLyBkb24ndCBnaXZlIGFtYmlndW91c2x5LXRpbWVkIG1vbWVudHMgYSBVVEMgem9uZQoJCW1vbS51dGMoKTsKCX0KCglyZXR1cm4gbW9tOwp9OwoKLy8gU2FtZSBhcyBmYy5tb21lbnQsIGJ1dCB3aGVuIGdpdmVuIGFuIElTTzg2MDEgc3RyaW5nLCB0aGUgdGltZXpvbmUgb2Zmc2V0IGlzIHByZXNlcnZlZC4KLy8gSVNPODYwMSBzdHJpbmdzIHdpdGggbm8gdGltZXpvbmUgb2Zmc2V0IHdpbGwgYmVjb21lIGFtYmlndW91c2x5IHpvbmVkLgpmYy5tb21lbnQucGFyc2Vab25lID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gbWFrZU1vbWVudChhcmd1bWVudHMsIHRydWUsIHRydWUpOwp9OwoKLy8gQnVpbGRzIGFuIGVuaGFuY2VkIG1vbWVudCBmcm9tIGFyZ3MuIFdoZW4gZ2l2ZW4gYW4gZXhpc3RpbmcgbW9tZW50LCBpdCBjbG9uZXMuIFdoZW4gZ2l2ZW4gYQovLyBuYXRpdmUgRGF0ZSwgb3IgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzICh0aGUgY3VycmVudCB0aW1lKSwgdGhlIHJlc3VsdGluZyBtb21lbnQgd2lsbCBiZSBsb2NhbC4KLy8gQW55dGhpbmcgZWxzZSBuZWVkcyB0byBiZSAicGFyc2VkIiAoYSBzdHJpbmcgb3IgYW4gYXJyYXkpLCBhbmQgd2lsbCBiZSBhZmZlY3RlZCBieToKLy8gICAgcGFyc2VBc1VUQyAtIGlmIHRoZXJlIGlzIG5vIHpvbmUgaW5mb3JtYXRpb24sIHNob3VsZCB3ZSBwYXJzZSB0aGUgaW5wdXQgaW4gVVRDPwovLyAgICBwYXJzZVpvbmUgLSBpZiB0aGVyZSBpcyB6b25lIGluZm9ybWF0aW9uLCBzaG91bGQgd2UgZm9yY2UgdGhlIHpvbmUgb2YgdGhlIG1vbWVudD8KZnVuY3Rpb24gbWFrZU1vbWVudChhcmdzLCBwYXJzZUFzVVRDLCBwYXJzZVpvbmUpIHsKCXZhciBpbnB1dCA9IGFyZ3NbMF07Cgl2YXIgaXNTaW5nbGVTdHJpbmcgPSBhcmdzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZyc7Cgl2YXIgaXNBbWJpZ1RpbWU7Cgl2YXIgaXNBbWJpZ1pvbmU7Cgl2YXIgYW1iaWdNYXRjaDsKCXZhciBtb207CgoJaWYgKG1vbWVudC5pc01vbWVudChpbnB1dCkpIHsKCQltb20gPSBtb21lbnQuYXBwbHkobnVsbCwgYXJncyk7IC8vIGNsb25lIGl0CgkJdHJhbnNmZXJBbWJpZ3MoaW5wdXQsIG1vbSk7IC8vIHRoZSBhbWJpZyBmbGFncyB3ZXJlbid0IHRyYW5zZmVyZWQgd2l0aCB0aGUgY2xvbmUKCX0KCWVsc2UgaWYgKGlzTmF0aXZlRGF0ZShpbnB1dCkgfHwgaW5wdXQgPT09IHVuZGVmaW5lZCkgewoJCW1vbSA9IG1vbWVudC5hcHBseShudWxsLCBhcmdzKTsgLy8gd2lsbCBiZSBsb2NhbAoJfQoJZWxzZSB7IC8vICJwYXJzaW5nIiBpcyByZXF1aXJlZAoJCWlzQW1iaWdUaW1lID0gZmFsc2U7CgkJaXNBbWJpZ1pvbmUgPSBmYWxzZTsKCgkJaWYgKGlzU2luZ2xlU3RyaW5nKSB7CgkJCWlmIChhbWJpZ0RhdGVPZk1vbnRoUmVnZXgudGVzdChpbnB1dCkpIHsKCQkJCS8vIGFjY2VwdCBzdHJpbmdzIGxpa2UgJzIwMTQtMDUnLCBidXQgY29udmVydCB0byB0aGUgZmlyc3Qgb2YgdGhlIG1vbnRoCgkJCQlpbnB1dCArPSAnLTAxJzsKCQkJCWFyZ3MgPSBbIGlucHV0IF07IC8vIGZvciB3aGVuIHdlIHBhc3MgaXQgb24gdG8gbW9tZW50J3MgY29uc3RydWN0b3IKCQkJCWlzQW1iaWdUaW1lID0gdHJ1ZTsKCQkJCWlzQW1iaWdab25lID0gdHJ1ZTsKCQkJfQoJCQllbHNlIGlmICgoYW1iaWdNYXRjaCA9IGFtYmlnVGltZU9yWm9uZVJlZ2V4LmV4ZWMoaW5wdXQpKSkgewoJCQkJaXNBbWJpZ1RpbWUgPSAhYW1iaWdNYXRjaFs1XTsgLy8gbm8gdGltZSBwYXJ0PwoJCQkJaXNBbWJpZ1pvbmUgPSB0cnVlOwoJCQl9CgkJfQoJCWVsc2UgaWYgKCQuaXNBcnJheShpbnB1dCkpIHsKCQkJLy8gYXJyYXlzIGhhdmUgbm8gdGltZXpvbmUgaW5mb3JtYXRpb24sIHNvIGFzc3VtZSBhbWJpZ3VvdXMgem9uZQoJCQlpc0FtYmlnWm9uZSA9IHRydWU7CgkJfQoJCS8vIG90aGVyd2lzZSwgcHJvYmFibHkgYSBzdHJpbmcgd2l0aCBhIGZvcm1hdAoKCQlpZiAocGFyc2VBc1VUQyB8fCBpc0FtYmlnVGltZSkgewoJCQltb20gPSBtb21lbnQudXRjLmFwcGx5KG1vbWVudCwgYXJncyk7CgkJfQoJCWVsc2UgewoJCQltb20gPSBtb21lbnQuYXBwbHkobnVsbCwgYXJncyk7CgkJfQoKCQlpZiAoaXNBbWJpZ1RpbWUpIHsKCQkJbW9tLl9hbWJpZ1RpbWUgPSB0cnVlOwoJCQltb20uX2FtYmlnWm9uZSA9IHRydWU7IC8vIGFtYmlndW91cyB0aW1lIGFsd2F5cyBtZWFucyBhbWJpZ3VvdXMgem9uZQoJCX0KCQllbHNlIGlmIChwYXJzZVpvbmUpIHsgLy8gbGV0J3MgcmVjb3JkIHRoZSBpbnB1dHRlZCB6b25lIHNvbWVob3cKCQkJaWYgKGlzQW1iaWdab25lKSB7CgkJCQltb20uX2FtYmlnWm9uZSA9IHRydWU7CgkJCX0KCQkJZWxzZSBpZiAoaXNTaW5nbGVTdHJpbmcpIHsKCQkJCW1vbS56b25lKGlucHV0KTsgLy8gaWYgbm90IGEgdmFsaWQgem9uZSwgd2lsbCBhc3NpZ24gVVRDCgkJCX0KCQl9Cgl9CgoJbW9tLl9mdWxsQ2FsZW5kYXIgPSB0cnVlOyAvLyBmbGFnIGZvciBleHRlbmRlZCBmdW5jdGlvbmFsaXR5CgoJcmV0dXJuIG1vbTsKfQoKCi8vIEEgY2xvbmUgbWV0aG9kIHRoYXQgd29ya3Mgd2l0aCB0aGUgZmxhZ3MgcmVsYXRlZCB0byBvdXIgZW5oYW5jZWQgZnVuY3Rpb25hbGl0eS4KLy8gSW4gdGhlIGZ1dHVyZSwgdXNlIG1vbWVudC5tb21lbnRQcm9wZXJ0aWVzCm5ld01vbWVudFByb3RvLmNsb25lID0gZnVuY3Rpb24oKSB7Cgl2YXIgbW9tID0gb2xkTW9tZW50UHJvdG8uY2xvbmUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCgkvLyB0aGVzZSBmbGFncyB3ZXJlbid0IHRyYW5zZmVyZWQgd2l0aCB0aGUgY2xvbmUKCXRyYW5zZmVyQW1iaWdzKHRoaXMsIG1vbSk7CglpZiAodGhpcy5fZnVsbENhbGVuZGFyKSB7CgkJbW9tLl9mdWxsQ2FsZW5kYXIgPSB0cnVlOwoJfQoKCXJldHVybiBtb207Cn07CgoKLy8gVGltZS1vZi1kYXkKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKLy8gR0VUVEVSCi8vIFJldHVybnMgYSBEdXJhdGlvbiB3aXRoIHRoZSBob3Vycy9taW51dGVzL3NlY29uZHMvbXMgdmFsdWVzIG9mIHRoZSBtb21lbnQuCi8vIElmIHRoZSBtb21lbnQgaGFzIGFuIGFtYmlndW91cyB0aW1lLCBhIGR1cmF0aW9uIG9mIDAwOjAwIHdpbGwgYmUgcmV0dXJuZWQuCi8vCi8vIFNFVFRFUgovLyBZb3UgY2FuIHN1cHBseSBhIER1cmF0aW9uLCBhIE1vbWVudCwgb3IgYSBEdXJhdGlvbi1saWtlIGFyZ3VtZW50LgovLyBXaGVuIHNldHRpbmcgdGhlIHRpbWUsIGFuZCB0aGUgbW9tZW50IGhhcyBhbiBhbWJpZ3VvdXMgdGltZSwgaXQgdGhlbiBiZWNvbWVzIHVuYW1iaWd1b3VzLgpuZXdNb21lbnRQcm90by50aW1lID0gZnVuY3Rpb24odGltZSkgewoKCS8vIEZhbGxiYWNrIHRvIHRoZSBvcmlnaW5hbCBtZXRob2QgKGlmIHRoZXJlIGlzIG9uZSkgaWYgdGhpcyBtb21lbnQgd2Fzbid0IGNyZWF0ZWQgdmlhIEZ1bGxDYWxlbmRhci4KCS8vIGB0aW1lYCBpcyBhIGdlbmVyaWMgZW5vdWdoIG1ldGhvZCBuYW1lIHdoZXJlIHRoaXMgcHJlY2F1dGlvbiBpcyBuZWNlc3NhcnkgdG8gYXZvaWQgY29sbGlzaW9ucyB3LyBvdGhlciBwbHVnaW5zLgoJaWYgKCF0aGlzLl9mdWxsQ2FsZW5kYXIpIHsKCQlyZXR1cm4gb2xkTW9tZW50UHJvdG8udGltZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfQoKCWlmICh0aW1lID09IG51bGwpIHsgLy8gZ2V0dGVyCgkJcmV0dXJuIG1vbWVudC5kdXJhdGlvbih7CgkJCWhvdXJzOiB0aGlzLmhvdXJzKCksCgkJCW1pbnV0ZXM6IHRoaXMubWludXRlcygpLAoJCQlzZWNvbmRzOiB0aGlzLnNlY29uZHMoKSwKCQkJbWlsbGlzZWNvbmRzOiB0aGlzLm1pbGxpc2Vjb25kcygpCgkJfSk7Cgl9CgllbHNlIHsgLy8gc2V0dGVyCgoJCXRoaXMuX2FtYmlnVGltZSA9IGZhbHNlOyAvLyBtYXJrIHRoYXQgdGhlIG1vbWVudCBub3cgaGFzIGEgdGltZQoKCQlpZiAoIW1vbWVudC5pc0R1cmF0aW9uKHRpbWUpICYmICFtb21lbnQuaXNNb21lbnQodGltZSkpIHsKCQkJdGltZSA9IG1vbWVudC5kdXJhdGlvbih0aW1lKTsKCQl9CgoJCS8vIFRoZSBkYXkgdmFsdWUgc2hvdWxkIGNhdXNlIG92ZXJmbG93IChzbyAyNCBob3VycyBiZWNvbWVzIDAwOjAwOjAwIG9mIG5leHQgZGF5KS4KCQkvLyBPbmx5IGZvciBEdXJhdGlvbiB0aW1lcywgbm90IE1vbWVudCB0aW1lcy4KCQl2YXIgZGF5SG91cnMgPSAwOwoJCWlmIChtb21lbnQuaXNEdXJhdGlvbih0aW1lKSkgewoJCQlkYXlIb3VycyA9IE1hdGguZmxvb3IodGltZS5hc0RheXMoKSkgKiAyNDsKCQl9CgoJCS8vIFdlIG5lZWQgdG8gc2V0IHRoZSBpbmRpdmlkdWFsIGZpZWxkcy4KCQkvLyBDYW4ndCB1c2Ugc3RhcnRPZignZGF5JykgdGhlbiBhZGQgZHVyYXRpb24uIEluIGNhc2Ugb2YgRFNUIGF0IHN0YXJ0IG9mIGRheS4KCQlyZXR1cm4gdGhpcy5ob3VycyhkYXlIb3VycyArIHRpbWUuaG91cnMoKSkKCQkJLm1pbnV0ZXModGltZS5taW51dGVzKCkpCgkJCS5zZWNvbmRzKHRpbWUuc2Vjb25kcygpKQoJCQkubWlsbGlzZWNvbmRzKHRpbWUubWlsbGlzZWNvbmRzKCkpOwoJfQp9OwoKLy8gQ29udmVydHMgdGhlIG1vbWVudCB0byBVVEMsIHN0cmlwcGluZyBvdXQgaXRzIHRpbWUtb2YtZGF5IGFuZCB0aW1lem9uZSBvZmZzZXQsCi8vIGJ1dCBwcmVzZXJ2aW5nIGl0cyBZTUQuIEEgbW9tZW50IHdpdGggYSBzdHJpcHBlZCB0aW1lIHdpbGwgZGlzcGxheSBubyB0aW1lCi8vIG5vciB0aW1lem9uZSBvZmZzZXQgd2hlbiAuZm9ybWF0KCkgaXMgY2FsbGVkLgpuZXdNb21lbnRQcm90by5zdHJpcFRpbWUgPSBmdW5jdGlvbigpIHsKCXZhciBhOwoKCWlmICghdGhpcy5fYW1iaWdUaW1lKSB7CgoJCS8vIGdldCB0aGUgdmFsdWVzIGJlZm9yZSBhbnkgY29udmVyc2lvbiBoYXBwZW5zCgkJYSA9IHRoaXMudG9BcnJheSgpOyAvLyBhcnJheSBvZiB5L20vZC9oL20vcy9tcwoKCQl0aGlzLnV0YygpOyAvLyBzZXQgdGhlIGludGVybmFsIFVUQyBmbGFnICh3aWxsIGNsZWFyIHRoZSBhbWJpZyBmbGFncykKCQlzZXRVVENWYWx1ZXModGhpcywgYS5zbGljZSgwLCAzKSk7IC8vIHNldCB0aGUgeWVhci9tb250aC9kYXRlLiB0aW1lIHdpbGwgYmUgemVybwoKCQkvLyBNYXJrIHRoZSB0aW1lIGFzIGFtYmlndW91cy4gVGhpcyBuZWVkcyB0byBoYXBwZW4gYWZ0ZXIgdGhlIC51dGMoKSBjYWxsLCB3aGljaCBjYWxscyAudXRjT2Zmc2V0KCksCgkJLy8gd2hpY2ggY2xlYXJzIGFsbCBhbWJpZyBmbGFncy4gU2FtZSB3aXRoIHNldFVUQ1ZhbHVlcyB3aXRoIG1vbWVudC10aW1lem9uZS4KCQl0aGlzLl9hbWJpZ1RpbWUgPSB0cnVlOwoJCXRoaXMuX2FtYmlnWm9uZSA9IHRydWU7IC8vIGlmIGFtYmlndW91cyB0aW1lLCBhbHNvIGFtYmlndW91cyB0aW1lem9uZSBvZmZzZXQKCX0KCglyZXR1cm4gdGhpczsgLy8gZm9yIGNoYWluaW5nCn07CgovLyBSZXR1cm5zIGlmIHRoZSBtb21lbnQgaGFzIGEgbm9uLWFtYmlndW91cyB0aW1lIChib29sZWFuKQpuZXdNb21lbnRQcm90by5oYXNUaW1lID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gIXRoaXMuX2FtYmlnVGltZTsKfTsKCgovLyBUaW1lem9uZQovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgovLyBDb252ZXJ0cyB0aGUgbW9tZW50IHRvIFVUQywgc3RyaXBwaW5nIG91dCBpdHMgdGltZXpvbmUgb2Zmc2V0LCBidXQgcHJlc2VydmluZyBpdHMKLy8gWU1EIGFuZCB0aW1lLW9mLWRheS4gQSBtb21lbnQgd2l0aCBhIHN0cmlwcGVkIHRpbWV6b25lIG9mZnNldCB3aWxsIGRpc3BsYXkgbm8KLy8gdGltZXpvbmUgb2Zmc2V0IHdoZW4gLmZvcm1hdCgpIGlzIGNhbGxlZC4KbmV3TW9tZW50UHJvdG8uc3RyaXBab25lID0gZnVuY3Rpb24oKSB7Cgl2YXIgYSwgd2FzQW1iaWdUaW1lOwoKCWlmICghdGhpcy5fYW1iaWdab25lKSB7CgoJCS8vIGdldCB0aGUgdmFsdWVzIGJlZm9yZSBhbnkgY29udmVyc2lvbiBoYXBwZW5zCgkJYSA9IHRoaXMudG9BcnJheSgpOyAvLyBhcnJheSBvZiB5L20vZC9oL20vcy9tcwoJCXdhc0FtYmlnVGltZSA9IHRoaXMuX2FtYmlnVGltZTsKCgkJdGhpcy51dGMoKTsgLy8gc2V0IHRoZSBpbnRlcm5hbCBVVEMgZmxhZyAod2lsbCBjbGVhciB0aGUgYW1iaWcgZmxhZ3MpCgkJc2V0VVRDVmFsdWVzKHRoaXMsIGEpOyAvLyB3aWxsIHNldCB0aGUgeWVhci9tb250aC9kYXRlL2hvdXJzL21pbnV0ZXMvc2Vjb25kcy9tcwoKCQlpZiAod2FzQW1iaWdUaW1lKSB7CgkJCS8vIHRoZSBhYm92ZSBjYWxsIHRvIC51dGMoKS8udXRjT2Zmc2V0KCkgdW5mb3J0dW5hdGVseSBjbGVhcnMgdGhlIGFtYmlnIGZsYWdzLCBzbyByZWFzc2lnbgoJCQl0aGlzLl9hbWJpZ1RpbWUgPSB0cnVlOwoJCX0KCgkJLy8gTWFyayB0aGUgem9uZSBhcyBhbWJpZ3VvdXMuIFRoaXMgbmVlZHMgdG8gaGFwcGVuIGFmdGVyIHRoZSAudXRjKCkgY2FsbCwgd2hpY2ggY2FsbHMgLnV0Y09mZnNldCgpLAoJCS8vIHdoaWNoIGNsZWFycyBhbGwgYW1iaWcgZmxhZ3MuIFNhbWUgd2l0aCBzZXRVVENWYWx1ZXMgd2l0aCBtb21lbnQtdGltZXpvbmUuCgkJdGhpcy5fYW1iaWdab25lID0gdHJ1ZTsKCX0KCglyZXR1cm4gdGhpczsgLy8gZm9yIGNoYWluaW5nCn07CgovLyBSZXR1cm5zIG9mIHRoZSBtb21lbnQgaGFzIGEgbm9uLWFtYmlndW91cyB0aW1lem9uZSBvZmZzZXQgKGJvb2xlYW4pCm5ld01vbWVudFByb3RvLmhhc1pvbmUgPSBmdW5jdGlvbigpIHsKCXJldHVybiAhdGhpcy5fYW1iaWdab25lOwp9OwoKJC5lYWNoKFsgJ3V0Y09mZnNldCcsICd6b25lJyBdLCBmdW5jdGlvbihpLCBuYW1lKSB7IC8vIC56b25lKCkgaXMgbW9tZW50LXByZS0yLjksIGhhcyBiZWVuIGRlcHJlY2F0ZWQKCWlmIChvbGRNb21lbnRQcm90b1tuYW1lXSkgewoKCQkvLyB0aGlzIG1ldGhvZCBpbXBsaWNpdGx5IG1hcmtzIGEgem9uZSAod2lsbCBnZXQgY2FsbGVkIHVwb24gLnV0YygpIGFuZCAubG9jYWwoKSkKCQluZXdNb21lbnRQcm90b1tuYW1lXSA9IGZ1bmN0aW9uKHR6bykgewoKCQkJaWYgKHR6byAhPSBudWxsKSB7IC8vIHNldHRlcgoJCQkJLy8gdGhlc2UgYXNzaWdubWVudHMgbmVlZHMgdG8gaGFwcGVuIGJlZm9yZSB0aGUgb3JpZ2luYWwgem9uZSBtZXRob2QgaXMgY2FsbGVkLgoJCQkJLy8gSSBmb3JnZXQgd2h5LCBzb21ldGhpbmcgdG8gZG8gd2l0aCBhIGJyb3dzZXIgY3Jhc2guCgkJCQl0aGlzLl9hbWJpZ1RpbWUgPSBmYWxzZTsKCQkJCXRoaXMuX2FtYmlnWm9uZSA9IGZhbHNlOwoJCQl9CgoJCQlyZXR1cm4gb2xkTW9tZW50UHJvdG9bbmFtZV0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl9OwoJfQp9KTsKCi8vIHRoaXMgbWV0aG9kIGltcGxpY2l0bHkgbWFya3MgYSB6b25lCm5ld01vbWVudFByb3RvLmxvY2FsID0gZnVuY3Rpb24oKSB7Cgl2YXIgYSA9IHRoaXMudG9BcnJheSgpOyAvLyB5ZWFyLG1vbnRoLGRhdGUsaG91cnMsbWludXRlcyxzZWNvbmRzLG1zIGFzIGFuIGFycmF5Cgl2YXIgd2FzQW1iaWdab25lID0gdGhpcy5fYW1iaWdab25lOwoKCW9sZE1vbWVudFByb3RvLmxvY2FsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIHdpbGwgY2xlYXIgYW1iaWcgZmxhZ3MKCglpZiAod2FzQW1iaWdab25lKSB7CgkJLy8gSWYgdGhlIG1vbWVudCB3YXMgYW1iaWd1b3VzbHkgem9uZWQsIHRoZSBkYXRlIGZpZWxkcyB3ZXJlIHN0b3JlZCBhcyBVVEMuCgkJLy8gV2Ugd2FudCB0byBwcmVzZXJ2ZSB0aGVzZSwgYnV0IGluIGxvY2FsIHRpbWUuCgkJc2V0TG9jYWxWYWx1ZXModGhpcywgYSk7Cgl9CgoJcmV0dXJuIHRoaXM7IC8vIGZvciBjaGFpbmluZwp9OwoKCi8vIEZvcm1hdHRpbmcKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKbmV3TW9tZW50UHJvdG8uZm9ybWF0ID0gZnVuY3Rpb24oKSB7CglpZiAodGhpcy5fZnVsbENhbGVuZGFyICYmIGFyZ3VtZW50c1swXSkgeyAvLyBhbiBlbmhhbmNlZCBtb21lbnQ\/IGFuZCBhIGZvcm1hdCBzdHJpbmcgcHJvdmlkZWQ\/CgkJcmV0dXJuIGZvcm1hdERhdGUodGhpcywgYXJndW1lbnRzWzBdKTsgLy8gb3VyIGV4dGVuZGVkIGZvcm1hdHRpbmcKCX0KCWlmICh0aGlzLl9hbWJpZ1RpbWUpIHsKCQlyZXR1cm4gb2xkTW9tZW50Rm9ybWF0KHRoaXMsICdZWVlZLU1NLUREJyk7Cgl9CglpZiAodGhpcy5fYW1iaWdab25lKSB7CgkJcmV0dXJuIG9sZE1vbWVudEZvcm1hdCh0aGlzLCAnWVlZWS1NTS1ERFtUXUhIOm1tOnNzJyk7Cgl9CglyZXR1cm4gb2xkTW9tZW50UHJvdG8uZm9ybWF0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07CgpuZXdNb21lbnRQcm90by50b0lTT1N0cmluZyA9IGZ1bmN0aW9uKCkgewoJaWYgKHRoaXMuX2FtYmlnVGltZSkgewoJCXJldHVybiBvbGRNb21lbnRGb3JtYXQodGhpcywgJ1lZWVktTU0tREQnKTsKCX0KCWlmICh0aGlzLl9hbWJpZ1pvbmUpIHsKCQlyZXR1cm4gb2xkTW9tZW50Rm9ybWF0KHRoaXMsICdZWVlZLU1NLUREW1RdSEg6bW06c3MnKTsKCX0KCXJldHVybiBvbGRNb21lbnRQcm90by50b0lTT1N0cmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKCi8vIFF1ZXJ5aW5nCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIElzIHRoZSBtb21lbnQgd2l0aGluIHRoZSBzcGVjaWZpZWQgcmFuZ2U\/IGBlbmRgIGlzIGV4Y2x1c2l2ZS4KLy8gRllJLCB0aGlzIG1ldGhvZCBpcyBub3QgYSBzdGFuZGFyZCBNb21lbnQgbWV0aG9kLCBzbyBhbHdheXMgZG8gb3VyIGVuaGFuY2VkIGxvZ2ljLgpuZXdNb21lbnRQcm90by5pc1dpdGhpbiA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKCXZhciBhID0gY29tbW9ubHlBbWJpZ3VhdGUoWyB0aGlzLCBzdGFydCwgZW5kIF0pOwoJcmV0dXJuIGFbMF0gPj0gYVsxXSAmJiBhWzBdIDwgYVsyXTsKfTsKCi8vIFdoZW4gaXNTYW1lIGlzIGNhbGxlZCB3aXRoIHVuaXRzLCB0aW1lem9uZSBhbWJpZ3VpdHkgaXMgbm9ybWFsaXplZCBiZWZvcmUgdGhlIGNvbXBhcmlzb24gaGFwcGVucy4KLy8gSWYgbm8gdW5pdHMgc3BlY2lmaWVkLCB0aGUgdHdvIG1vbWVudHMgbXVzdCBiZSBpZGVudGljYWxseSB0aGUgc2FtZSwgd2l0aCBtYXRjaGluZyBhbWJpZyBmbGFncy4KbmV3TW9tZW50UHJvdG8uaXNTYW1lID0gZnVuY3Rpb24oaW5wdXQsIHVuaXRzKSB7Cgl2YXIgYTsKCgkvLyBvbmx5IGRvIGN1c3RvbSBsb2dpYyBpZiB0aGlzIGlzIGFuIGVuaGFuY2VkIG1vbWVudAoJaWYgKCF0aGlzLl9mdWxsQ2FsZW5kYXIpIHsKCQlyZXR1cm4gb2xkTW9tZW50UHJvdG8uaXNTYW1lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9CgoJaWYgKHVuaXRzKSB7CgkJYSA9IGNvbW1vbmx5QW1iaWd1YXRlKFsgdGhpcywgaW5wdXQgXSwgdHJ1ZSk7IC8vIG5vcm1hbGl6ZSB0aW1lem9uZXMgYnV0IGRvbid0IGVyYXNlIHRpbWVzCgkJcmV0dXJuIG9sZE1vbWVudFByb3RvLmlzU2FtZS5jYWxsKGFbMF0sIGFbMV0sIHVuaXRzKTsKCX0KCWVsc2UgewoJCWlucHV0ID0gZmMubW9tZW50LnBhcnNlWm9uZShpbnB1dCk7IC8vIG5vcm1hbGl6ZSBpbnB1dAoJCXJldHVybiBvbGRNb21lbnRQcm90by5pc1NhbWUuY2FsbCh0aGlzLCBpbnB1dCkgJiYKCQkJQm9vbGVhbih0aGlzLl9hbWJpZ1RpbWUpID09PSBCb29sZWFuKGlucHV0Ll9hbWJpZ1RpbWUpICYmCgkJCUJvb2xlYW4odGhpcy5fYW1iaWdab25lKSA9PT0gQm9vbGVhbihpbnB1dC5fYW1iaWdab25lKTsKCX0KfTsKCi8vIE1ha2UgdGhlc2UgcXVlcnkgbWV0aG9kcyB3b3JrIHdpdGggYW1iaWd1b3VzIG1vbWVudHMKJC5lYWNoKFsKCSdpc0JlZm9yZScsCgknaXNBZnRlcicKXSwgZnVuY3Rpb24oaSwgbWV0aG9kTmFtZSkgewoJbmV3TW9tZW50UHJvdG9bbWV0aG9kTmFtZV0gPSBmdW5jdGlvbihpbnB1dCwgdW5pdHMpIHsKCQl2YXIgYTsKCgkJLy8gb25seSBkbyBjdXN0b20gbG9naWMgaWYgdGhpcyBpcyBhbiBlbmhhbmNlZCBtb21lbnQKCQlpZiAoIXRoaXMuX2Z1bGxDYWxlbmRhcikgewoJCQlyZXR1cm4gb2xkTW9tZW50UHJvdG9bbWV0aG9kTmFtZV0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl9CgoJCWEgPSBjb21tb25seUFtYmlndWF0ZShbIHRoaXMsIGlucHV0IF0pOwoJCXJldHVybiBvbGRNb21lbnRQcm90b1ttZXRob2ROYW1lXS5jYWxsKGFbMF0sIGFbMV0sIHVuaXRzKTsKCX07Cn0pOwoKCi8vIE1pc2MgSW50ZXJuYWxzCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIGdpdmVuIGFuIGFycmF5IG9mIG1vbWVudC1saWtlIGlucHV0cywgcmV0dXJuIGEgcGFyYWxsZWwgYXJyYXkgdy8gbW9tZW50cyBzaW1pbGFybHkgYW1iaWd1YXRlZC4KLy8gZm9yIGV4YW1wbGUsIG9mIG9uZSBtb21lbnQgaGFzIGFtYmlnIHRpbWUsIGJ1dCBub3Qgb3RoZXJzLCBhbGwgbW9tZW50cyB3aWxsIGhhdmUgdGhlaXIgdGltZSBzdHJpcHBlZC4KLy8gc2V0IGBwcmVzZXJ2ZVRpbWVgIHRvIGB0cnVlYCB0byBrZWVwIHRpbWVzLCBidXQgb25seSBub3JtYWxpemUgem9uZSBhbWJpZ3VpdHkuCi8vIHJldHVybnMgdGhlIG9yaWdpbmFsIG1vbWVudHMgaWYgbm8gbW9kaWZpY2F0aW9ucyBhcmUgbmVjZXNzYXJ5LgpmdW5jdGlvbiBjb21tb25seUFtYmlndWF0ZShpbnB1dHMsIHByZXNlcnZlVGltZSkgewoJdmFyIGFueUFtYmlnVGltZSA9IGZhbHNlOwoJdmFyIGFueUFtYmlnWm9uZSA9IGZhbHNlOwoJdmFyIGxlbiA9IGlucHV0cy5sZW5ndGg7Cgl2YXIgbW9tcyA9IFtdOwoJdmFyIGksIG1vbTsKCgkvLyBwYXJzZSBpbnB1dHMgaW50byByZWFsIG1vbWVudHMgYW5kIHF1ZXJ5IHRoZWlyIGFtYmlnIGZsYWdzCglmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKCQltb20gPSBpbnB1dHNbaV07CgkJaWYgKCFtb21lbnQuaXNNb21lbnQobW9tKSkgewoJCQltb20gPSBmYy5tb21lbnQucGFyc2Vab25lKG1vbSk7CgkJfQoJCWFueUFtYmlnVGltZSA9IGFueUFtYmlnVGltZSB8fCBtb20uX2FtYmlnVGltZTsKCQlhbnlBbWJpZ1pvbmUgPSBhbnlBbWJpZ1pvbmUgfHwgbW9tLl9hbWJpZ1pvbmU7CgkJbW9tcy5wdXNoKG1vbSk7Cgl9CgoJLy8gc3RyaXAgZWFjaCBtb21lbnQgZG93biB0byBsb3dlc3QgY29tbW9uIGFtYmlndWl0eQoJLy8gdXNlIGNsb25lcyB0byBhdm9pZCBtb2RpZnlpbmcgdGhlIG9yaWdpbmFsIG1vbWVudHMKCWZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCW1vbSA9IG1vbXNbaV07CgkJaWYgKCFwcmVzZXJ2ZVRpbWUgJiYgYW55QW1iaWdUaW1lICYmICFtb20uX2FtYmlnVGltZSkgewoJCQltb21zW2ldID0gbW9tLmNsb25lKCkuc3RyaXBUaW1lKCk7CgkJfQoJCWVsc2UgaWYgKGFueUFtYmlnWm9uZSAmJiAhbW9tLl9hbWJpZ1pvbmUpIHsKCQkJbW9tc1tpXSA9IG1vbS5jbG9uZSgpLnN0cmlwWm9uZSgpOwoJCX0KCX0KCglyZXR1cm4gbW9tczsKfQoKLy8gVHJhbnNmZXJzIGFsbCB0aGUgZmxhZ3MgcmVsYXRlZCB0byBhbWJpZ3VvdXMgdGltZS96b25lIGZyb20gdGhlIGBzcmNgIG1vbWVudCB0byB0aGUgYGRlc3RgIG1vbWVudApmdW5jdGlvbiB0cmFuc2ZlckFtYmlncyhzcmMsIGRlc3QpIHsKCWlmIChzcmMuX2FtYmlnVGltZSkgewoJCWRlc3QuX2FtYmlnVGltZSA9IHRydWU7Cgl9CgllbHNlIGlmIChkZXN0Ll9hbWJpZ1RpbWUpIHsKCQlkZXN0Ll9hbWJpZ1RpbWUgPSBmYWxzZTsKCX0KCglpZiAoc3JjLl9hbWJpZ1pvbmUpIHsKCQlkZXN0Ll9hbWJpZ1pvbmUgPSB0cnVlOwoJfQoJZWxzZSBpZiAoZGVzdC5fYW1iaWdab25lKSB7CgkJZGVzdC5fYW1iaWdab25lID0gZmFsc2U7Cgl9Cn0KCgovLyBTZXRzIHRoZSB5ZWFyL21vbnRoL2RhdGUvZXRjIHZhbHVlcyBvZiB0aGUgbW9tZW50IGZyb20gdGhlIGdpdmVuIGFycmF5LgovLyBJbmVmZmljaWVudCBiZWNhdXNlIGl0IGNhbGxzIGVhY2ggaW5kaXZpZHVhbCBzZXR0ZXIuCmZ1bmN0aW9uIHNldE1vbWVudFZhbHVlcyhtb20sIGEpIHsKCW1vbS55ZWFyKGFbMF0gfHwgMCkKCQkubW9udGgoYVsxXSB8fCAwKQoJCS5kYXRlKGFbMl0gfHwgMCkKCQkuaG91cnMoYVszXSB8fCAwKQoJCS5taW51dGVzKGFbNF0gfHwgMCkKCQkuc2Vjb25kcyhhWzVdIHx8IDApCgkJLm1pbGxpc2Vjb25kcyhhWzZdIHx8IDApOwp9CgovLyBDYW4gd2Ugc2V0IHRoZSBtb21lbnQncyBpbnRlcm5hbCBkYXRlIGRpcmVjdGx5PwphbGxvd1ZhbHVlT3B0aW1pemF0aW9uID0gJ19kJyBpbiBtb21lbnQoKSAmJiAndXBkYXRlT2Zmc2V0JyBpbiBtb21lbnQ7CgovLyBVdGlsaXR5IGZ1bmN0aW9uLiBBY2NlcHRzIGEgbW9tZW50IGFuZCBhbiBhcnJheSBvZiB0aGUgVVRDIHllYXIvbW9udGgvZGF0ZS9ldGMgdmFsdWVzIHRvIHNldC4KLy8gQXNzdW1lcyB0aGUgZ2l2ZW4gbW9tZW50IGlzIGFscmVhZHkgaW4gVVRDIG1vZGUuCnNldFVUQ1ZhbHVlcyA9IGFsbG93VmFsdWVPcHRpbWl6YXRpb24gPyBmdW5jdGlvbihtb20sIGEpIHsKCS8vIHNpbWxhdGUgd2hhdCBtb21lbnQncyBhY2Nlc3NvcnMgZG8KCW1vbS5fZC5zZXRUaW1lKERhdGUuVVRDLmFwcGx5KERhdGUsIGEpKTsKCW1vbWVudC51cGRhdGVPZmZzZXQobW9tLCBmYWxzZSk7IC8vIGtlZXBUaW1lPWZhbHNlCn0gOiBzZXRNb21lbnRWYWx1ZXM7CgovLyBVdGlsaXR5IGZ1bmN0aW9uLiBBY2NlcHRzIGEgbW9tZW50IGFuZCBhbiBhcnJheSBvZiB0aGUgbG9jYWwgeWVhci9tb250aC9kYXRlL2V0YyB2YWx1ZXMgdG8gc2V0LgovLyBBc3N1bWVzIHRoZSBnaXZlbiBtb21lbnQgaXMgYWxyZWFkeSBpbiBsb2NhbCBtb2RlLgpzZXRMb2NhbFZhbHVlcyA9IGFsbG93VmFsdWVPcHRpbWl6YXRpb24gPyBmdW5jdGlvbihtb20sIGEpIHsKCS8vIHNpbWxhdGUgd2hhdCBtb21lbnQncyBhY2Nlc3NvcnMgZG8KCW1vbS5fZC5zZXRUaW1lKCtuZXcgRGF0ZSggLy8gRllJLCB0aGVyZSBpcyBub3cgd2F5IHRvIGFwcGx5IGFuIGFycmF5IG9mIGFyZ3MgdG8gYSBjb25zdHJ1Y3RvcgoJCWFbMF0gfHwgMCwKCQlhWzFdIHx8IDAsCgkJYVsyXSB8fCAwLAoJCWFbM10gfHwgMCwKCQlhWzRdIHx8IDAsCgkJYVs1XSB8fCAwLAoJCWFbNl0gfHwgMAoJKSk7Cgltb21lbnQudXBkYXRlT2Zmc2V0KG1vbSwgZmFsc2UpOyAvLyBrZWVwVGltZT1mYWxzZQp9IDogc2V0TW9tZW50VmFsdWVzOwoKOzsKCi8vIFNpbmdsZSBEYXRlIEZvcm1hdHRpbmcKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKCi8vIGNhbGwgdGhpcyBpZiB5b3Ugd2FudCBNb21lbnQncyBvcmlnaW5hbCBmb3JtYXQgbWV0aG9kIHRvIGJlIHVzZWQKZnVuY3Rpb24gb2xkTW9tZW50Rm9ybWF0KG1vbSwgZm9ybWF0U3RyKSB7CglyZXR1cm4gb2xkTW9tZW50UHJvdG8uZm9ybWF0LmNhbGwobW9tLCBmb3JtYXRTdHIpOyAvLyBvbGRNb21lbnRQcm90byBkZWZpbmVkIGluIG1vbWVudC1leHQuanMKfQoKCi8vIEZvcm1hdHMgYGRhdGVgIHdpdGggYSBNb21lbnQgZm9ybWF0dGluZyBzdHJpbmcsIGJ1dCBhbGxvdyBvdXIgbm9uLXplcm8gYXJlYXMgYW5kCi8vIGFkZGl0aW9uYWwgdG9rZW4uCmZ1bmN0aW9uIGZvcm1hdERhdGUoZGF0ZSwgZm9ybWF0U3RyKSB7CglyZXR1cm4gZm9ybWF0RGF0ZVdpdGhDaHVua3MoZGF0ZSwgZ2V0Rm9ybWF0U3RyaW5nQ2h1bmtzKGZvcm1hdFN0cikpOwp9CgoKZnVuY3Rpb24gZm9ybWF0RGF0ZVdpdGhDaHVua3MoZGF0ZSwgY2h1bmtzKSB7Cgl2YXIgcyA9ICcnOwoJdmFyIGk7CgoJZm9yIChpPTA7IGk8Y2h1bmtzLmxlbmd0aDsgaSsrKSB7CgkJcyArPSBmb3JtYXREYXRlV2l0aENodW5rKGRhdGUsIGNodW5rc1tpXSk7Cgl9CgoJcmV0dXJuIHM7Cn0KCgovLyBhZGRpdGlvbiBmb3JtYXR0aW5nIHRva2VucyB3ZSB3YW50IHJlY29nbml6ZWQKdmFyIHRva2VuT3ZlcnJpZGVzID0gewoJdDogZnVuY3Rpb24oZGF0ZSkgeyAvLyAiYSIgb3IgInAiCgkJcmV0dXJuIG9sZE1vbWVudEZvcm1hdChkYXRlLCAnYScpLmNoYXJBdCgwKTsKCX0sCglUOiBmdW5jdGlvbihkYXRlKSB7IC8vICJBIiBvciAiUCIKCQlyZXR1cm4gb2xkTW9tZW50Rm9ybWF0KGRhdGUsICdBJykuY2hhckF0KDApOwoJfQp9OwoKCmZ1bmN0aW9uIGZvcm1hdERhdGVXaXRoQ2h1bmsoZGF0ZSwgY2h1bmspIHsKCXZhciB0b2tlbjsKCXZhciBtYXliZVN0cjsKCglpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJykgeyAvLyBhIGxpdGVyYWwgc3RyaW5nCgkJcmV0dXJuIGNodW5rOwoJfQoJZWxzZSBpZiAoKHRva2VuID0gY2h1bmsudG9rZW4pKSB7IC8vIGEgdG9rZW4sIGxpa2UgIllZWVkiCgkJaWYgKHRva2VuT3ZlcnJpZGVzW3Rva2VuXSkgewoJCQlyZXR1cm4gdG9rZW5PdmVycmlkZXNbdG9rZW5dKGRhdGUpOyAvLyB1c2Ugb3VyIGN1c3RvbSB0b2tlbgoJCX0KCQlyZXR1cm4gb2xkTW9tZW50Rm9ybWF0KGRhdGUsIHRva2VuKTsKCX0KCWVsc2UgaWYgKGNodW5rLm1heWJlKSB7IC8vIGEgZ3JvdXBpbmcgb2Ygb3RoZXIgY2h1bmtzIHRoYXQgbXVzdCBiZSBub24temVybwoJCW1heWJlU3RyID0gZm9ybWF0RGF0ZVdpdGhDaHVua3MoZGF0ZSwgY2h1bmsubWF5YmUpOwoJCWlmIChtYXliZVN0ci5tYXRjaCgvWzEtOV0vKSkgewoJCQlyZXR1cm4gbWF5YmVTdHI7CgkJfQoJfQoKCXJldHVybiAnJzsKfQoKCi8vIERhdGUgUmFuZ2UgRm9ybWF0dGluZwovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIFRPRE86IG1ha2UgaXQgd29yayB3aXRoIHRpbWV6b25lIG9mZnNldAoKLy8gVXNpbmcgYSBmb3JtYXR0aW5nIHN0cmluZyBtZWFudCBmb3IgYSBzaW5nbGUgZGF0ZSwgZ2VuZXJhdGUgYSByYW5nZSBzdHJpbmcsIGxpa2UKLy8gIlNlcCAyIC0gOSAyMDEzIiwgdGhhdCBpbnRlbGxpZ2VudGx5IGluc2VydHMgYSBzZXBhcmF0b3Igd2hlcmUgdGhlIGRhdGVzIGRpZmZlci4KLy8gSWYgdGhlIGRhdGVzIGFyZSB0aGUgc2FtZSBhcyBmYXIgYXMgdGhlIGZvcm1hdCBzdHJpbmcgaXMgY29uY2VybmVkLCBqdXN0IHJldHVybiBhIHNpbmdsZQovLyByZW5kZXJpbmcgb2Ygb25lIGRhdGUsIHdpdGhvdXQgYW55IHNlcGFyYXRvci4KZnVuY3Rpb24gZm9ybWF0UmFuZ2UoZGF0ZTEsIGRhdGUyLCBmb3JtYXRTdHIsIHNlcGFyYXRvciwgaXNSVEwpIHsKCXZhciBsb2NhbGVEYXRhOwoKCWRhdGUxID0gZmMubW9tZW50LnBhcnNlWm9uZShkYXRlMSk7CglkYXRlMiA9IGZjLm1vbWVudC5wYXJzZVpvbmUoZGF0ZTIpOwoKCWxvY2FsZURhdGEgPSAoZGF0ZTEubG9jYWxlRGF0YSB8fCBkYXRlMS5sYW5nKS5jYWxsKGRhdGUxKTsgLy8gd29ya3Mgd2l0aCBtb21lbnQtcHJlLTIuOAoKCS8vIEV4cGFuZCBsb2NhbGl6ZWQgZm9ybWF0IHN0cmluZ3MsIGxpa2UgIkxMIiAtPiAiTU1NTSBEIFlZWVkiCglmb3JtYXRTdHIgPSBsb2NhbGVEYXRhLmxvbmdEYXRlRm9ybWF0KGZvcm1hdFN0cikgfHwgZm9ybWF0U3RyOwoJLy8gQlRXLCB0aGlzIGlzIG5vdCBpbXBvcnRhbnQgZm9yIGBmb3JtYXREYXRlYCBiZWNhdXNlIGl0IGlzIGltcG9zc2libGUgdG8gcHV0IGN1c3RvbSB0b2tlbnMKCS8vIG9yIG5vbi16ZXJvIGFyZWFzIGluIE1vbWVudCdzIGxvY2FsaXplZCBmb3JtYXQgc3RyaW5ncy4KCglzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJyAtICc7CgoJcmV0dXJuIGZvcm1hdFJhbmdlV2l0aENodW5rcygKCQlkYXRlMSwKCQlkYXRlMiwKCQlnZXRGb3JtYXRTdHJpbmdDaHVua3MoZm9ybWF0U3RyKSwKCQlzZXBhcmF0b3IsCgkJaXNSVEwKCSk7Cn0KZmMuZm9ybWF0UmFuZ2UgPSBmb3JtYXRSYW5nZTsgLy8gZXhwb3NlCgoKZnVuY3Rpb24gZm9ybWF0UmFuZ2VXaXRoQ2h1bmtzKGRhdGUxLCBkYXRlMiwgY2h1bmtzLCBzZXBhcmF0b3IsIGlzUlRMKSB7Cgl2YXIgY2h1bmtTdHI7IC8vIHRoZSByZW5kZXJpbmcgb2YgdGhlIGNodW5rCgl2YXIgbGVmdEk7Cgl2YXIgbGVmdFN0ciA9ICcnOwoJdmFyIHJpZ2h0STsKCXZhciByaWdodFN0ciA9ICcnOwoJdmFyIG1pZGRsZUk7Cgl2YXIgbWlkZGxlU3RyMSA9ICcnOwoJdmFyIG1pZGRsZVN0cjIgPSAnJzsKCXZhciBtaWRkbGVTdHIgPSAnJzsKCgkvLyBTdGFydCBhdCB0aGUgbGVmdG1vc3Qgc2lkZSBvZiB0aGUgZm9ybWF0dGluZyBzdHJpbmcgYW5kIGNvbnRpbnVlIHVudGlsIHlvdSBoaXQgYSB0b2tlbgoJLy8gdGhhdCBpcyBub3QgdGhlIHNhbWUgYmV0d2VlbiBkYXRlcy4KCWZvciAobGVmdEk9MDsgbGVmdEk8Y2h1bmtzLmxlbmd0aDsgbGVmdEkrKykgewoJCWNodW5rU3RyID0gZm9ybWF0U2ltaWxhckNodW5rKGRhdGUxLCBkYXRlMiwgY2h1bmtzW2xlZnRJXSk7CgkJaWYgKGNodW5rU3RyID09PSBmYWxzZSkgewoJCQlicmVhazsKCQl9CgkJbGVmdFN0ciArPSBjaHVua1N0cjsKCX0KCgkvLyBTaW1pbGFybHksIHN0YXJ0IGF0IHRoZSByaWdodG1vc3Qgc2lkZSBvZiB0aGUgZm9ybWF0dGluZyBzdHJpbmcgYW5kIG1vdmUgbGVmdAoJZm9yIChyaWdodEk9Y2h1bmtzLmxlbmd0aC0xOyByaWdodEk+bGVmdEk7IHJpZ2h0SS0tKSB7CgkJY2h1bmtTdHIgPSBmb3JtYXRTaW1pbGFyQ2h1bmsoZGF0ZTEsIGRhdGUyLCBjaHVua3NbcmlnaHRJXSk7CgkJaWYgKGNodW5rU3RyID09PSBmYWxzZSkgewoJCQlicmVhazsKCQl9CgkJcmlnaHRTdHIgPSBjaHVua1N0ciArIHJpZ2h0U3RyOwoJfQoKCS8vIFRoZSBhcmVhIGluIHRoZSBtaWRkbGUgaXMgZGlmZmVyZW50IGZvciBib3RoIG9mIHRoZSBkYXRlcy4KCS8vIENvbGxlY3QgdGhlbSBkaXN0aW5jdGx5IHNvIHdlIGNhbiBqYW0gdGhlbSB0b2dldGhlciBsYXRlci4KCWZvciAobWlkZGxlST1sZWZ0STsgbWlkZGxlSTw9cmlnaHRJOyBtaWRkbGVJKyspIHsKCQltaWRkbGVTdHIxICs9IGZvcm1hdERhdGVXaXRoQ2h1bmsoZGF0ZTEsIGNodW5rc1ttaWRkbGVJXSk7CgkJbWlkZGxlU3RyMiArPSBmb3JtYXREYXRlV2l0aENodW5rKGRhdGUyLCBjaHVua3NbbWlkZGxlSV0pOwoJfQoKCWlmIChtaWRkbGVTdHIxIHx8IG1pZGRsZVN0cjIpIHsKCQlpZiAoaXNSVEwpIHsKCQkJbWlkZGxlU3RyID0gbWlkZGxlU3RyMiArIHNlcGFyYXRvciArIG1pZGRsZVN0cjE7CgkJfQoJCWVsc2UgewoJCQltaWRkbGVTdHIgPSBtaWRkbGVTdHIxICsgc2VwYXJhdG9yICsgbWlkZGxlU3RyMjsKCQl9Cgl9CgoJcmV0dXJuIGxlZnRTdHIgKyBtaWRkbGVTdHIgKyByaWdodFN0cjsKfQoKCnZhciBzaW1pbGFyVW5pdE1hcCA9IHsKCVk6ICd5ZWFyJywKCU06ICdtb250aCcsCglEOiAnZGF5JywgLy8gZGF5IG9mIG1vbnRoCglkOiAnZGF5JywgLy8gZGF5IG9mIHdlZWsKCS8vIHByZXZlbnRzIGEgc2VwYXJhdG9yIGJldHdlZW4gYW55dGhpbmcgdGltZS1yZWxhdGVkLi4uCglBOiAnc2Vjb25kJywgLy8gQU0vUE0KCWE6ICdzZWNvbmQnLCAvLyBhbS9wbQoJVDogJ3NlY29uZCcsIC8vIEEvUAoJdDogJ3NlY29uZCcsIC8vIGEvcAoJSDogJ3NlY29uZCcsIC8vIGhvdXIgKDI0KQoJaDogJ3NlY29uZCcsIC8vIGhvdXIgKDEyKQoJbTogJ3NlY29uZCcsIC8vIG1pbnV0ZQoJczogJ3NlY29uZCcgLy8gc2Vjb25kCn07Ci8vIFRPRE86IHdlZWsgbWF5YmU\/CgoKLy8gR2l2ZW4gYSBmb3JtYXR0aW5nIGNodW5rLCBhbmQgZ2l2ZW4gdGhhdCBib3RoIGRhdGVzIGFyZSBzaW1pbGFyIGluIHRoZSByZWdhcmQgdGhlCi8vIGZvcm1hdHRpbmcgY2h1bmsgaXMgY29uY2VybmVkLCBmb3JtYXQgZGF0ZTEgYWdhaW5zdCBgY2h1bmtgLiBPdGhlcndpc2UsIHJldHVybiBgZmFsc2VgLgpmdW5jdGlvbiBmb3JtYXRTaW1pbGFyQ2h1bmsoZGF0ZTEsIGRhdGUyLCBjaHVuaykgewoJdmFyIHRva2VuOwoJdmFyIHVuaXQ7CgoJaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsgLy8gYSBsaXRlcmFsIHN0cmluZwoJCXJldHVybiBjaHVuazsKCX0KCWVsc2UgaWYgKCh0b2tlbiA9IGNodW5rLnRva2VuKSkgewoJCXVuaXQgPSBzaW1pbGFyVW5pdE1hcFt0b2tlbi5jaGFyQXQoMCldOwoJCS8vIGFyZSB0aGUgZGF0ZXMgdGhlIHNhbWUgZm9yIHRoaXMgdW5pdCBvZiBtZWFzdXJlbWVudD8KCQlpZiAodW5pdCAmJiBkYXRlMS5pc1NhbWUoZGF0ZTIsIHVuaXQpKSB7CgkJCXJldHVybiBvbGRNb21lbnRGb3JtYXQoZGF0ZTEsIHRva2VuKTsgLy8gd291bGQgYmUgdGhlIHNhbWUgaWYgd2UgdXNlZCBgZGF0ZTJgCgkJCS8vIEJUVywgZG9uJ3Qgc3VwcG9ydCBjdXN0b20gdG9rZW5zCgkJfQoJfQoKCXJldHVybiBmYWxzZTsgLy8gdGhlIGNodW5rIGlzIE5PVCB0aGUgc2FtZSBmb3IgdGhlIHR3byBkYXRlcwoJLy8gQlRXLCBkb24ndCBzdXBwb3J0IHNwbGl0dGluZyBvbiBub24temVybyBhcmVhcwp9CgoKLy8gQ2h1bmtpbmcgVXRpbHMKLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKCnZhciBmb3JtYXRTdHJpbmdDaHVua0NhY2hlID0ge307CgoKZnVuY3Rpb24gZ2V0Rm9ybWF0U3RyaW5nQ2h1bmtzKGZvcm1hdFN0cikgewoJaWYgKGZvcm1hdFN0ciBpbiBmb3JtYXRTdHJpbmdDaHVua0NhY2hlKSB7CgkJcmV0dXJuIGZvcm1hdFN0cmluZ0NodW5rQ2FjaGVbZm9ybWF0U3RyXTsKCX0KCXJldHVybiAoZm9ybWF0U3RyaW5nQ2h1bmtDYWNoZVtmb3JtYXRTdHJdID0gY2h1bmtGb3JtYXRTdHJpbmcoZm9ybWF0U3RyKSk7Cn0KCgovLyBCcmVhayB0aGUgZm9ybWF0dGluZyBzdHJpbmcgaW50byBhbiBhcnJheSBvZiBjaHVua3MKZnVuY3Rpb24gY2h1bmtGb3JtYXRTdHJpbmcoZm9ybWF0U3RyKSB7Cgl2YXIgY2h1bmtzID0gW107Cgl2YXIgY2h1bmtlciA9IC9cWyhbXlxdXSopXF18XCgoW15cKV0qKVwpfChMVHwoXHcpXDQqbz8pfChbXlx3XFtcKF0rKS9nOyAvLyBUT0RPOiBtb3JlIGRlc2NyaW1pbmF0aW9uCgl2YXIgbWF0Y2g7CgoJd2hpbGUgKChtYXRjaCA9IGNodW5rZXIuZXhlYyhmb3JtYXRTdHIpKSkgewoJCWlmIChtYXRjaFsxXSkgeyAvLyBhIGxpdGVyYWwgc3RyaW5nIGluc2lkZSBbIC4uLiBdCgkJCWNodW5rcy5wdXNoKG1hdGNoWzFdKTsKCQl9CgkJZWxzZSBpZiAobWF0Y2hbMl0pIHsgLy8gbm9uLXplcm8gZm9ybWF0dGluZyBpbnNpZGUgKCAuLi4gKQoJCQljaHVua3MucHVzaCh7IG1heWJlOiBjaHVua0Zvcm1hdFN0cmluZyhtYXRjaFsyXSkgfSk7CgkJfQoJCWVsc2UgaWYgKG1hdGNoWzNdKSB7IC8vIGEgZm9ybWF0dGluZyB0b2tlbgoJCQljaHVua3MucHVzaCh7IHRva2VuOiBtYXRjaFszXSB9KTsKCQl9CgkJZWxzZSBpZiAobWF0Y2hbNV0pIHsgLy8gYW4gdW5lbmNsb3NlZCBsaXRlcmFsIHN0cmluZwoJCQljaHVua3MucHVzaChtYXRjaFs1XSk7CgkJfQoJfQoKCXJldHVybiBjaHVua3M7Cn0KCjs7CgpmYy5DbGFzcyA9IENsYXNzOyAvLyBleHBvcnQKCi8vIGNsYXNzIHRoYXQgYWxsIG90aGVyIGNsYXNzZXMgd2lsbCBpbmhlcml0IGZyb20KZnVuY3Rpb24gQ2xhc3MoKSB7IH0KCi8vIGNhbGxlZCB1cG9uIGEgY2xhc3MgdG8gY3JlYXRlIGEgc3ViY2xhc3MKQ2xhc3MuZXh0ZW5kID0gZnVuY3Rpb24obWVtYmVycykgewoJdmFyIHN1cGVyQ2xhc3MgPSB0aGlzOwoJdmFyIHN1YkNsYXNzOwoKCW1lbWJlcnMgPSBtZW1iZXJzIHx8IHt9OwoKCS8vIGVuc3VyZSBhIGNvbnN0cnVjdG9yIGZvciB0aGUgc3ViY2xhc3MsIGZvcndhcmRpbmcgYWxsIGFyZ3VtZW50cyB0byB0aGUgc3VwZXItY29uc3RydWN0b3IgaWYgaXQgZG9lc24ndCBleGlzdAoJaWYgKGhhc093blByb3AobWVtYmVycywgJ2NvbnN0cnVjdG9yJykpIHsKCQlzdWJDbGFzcyA9IG1lbWJlcnMuY29uc3RydWN0b3I7Cgl9CglpZiAodHlwZW9mIHN1YkNsYXNzICE9PSAnZnVuY3Rpb24nKSB7CgkJc3ViQ2xhc3MgPSBtZW1iZXJzLmNvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CgkJCXN1cGVyQ2xhc3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl9OwoJfQoKCS8vIGJ1aWxkIHRoZSBiYXNlIHByb3RvdHlwZSBmb3IgdGhlIHN1YmNsYXNzLCB3aGljaCBpcyBhbiBuZXcgb2JqZWN0IGNoYWluZWQgdG8gdGhlIHN1cGVyY2xhc3MncyBwcm90b3R5cGUKCXN1YkNsYXNzLnByb3RvdHlwZSA9IGNyZWF0ZU9iamVjdChzdXBlckNsYXNzLnByb3RvdHlwZSk7CgoJLy8gY29weSBlYWNoIG1lbWJlciB2YXJpYWJsZS9tZXRob2Qgb250byB0aGUgdGhlIHN1YmNsYXNzJ3MgcHJvdG90eXBlCgljb3B5T3duUHJvcHMobWVtYmVycywgc3ViQ2xhc3MucHJvdG90eXBlKTsKCgkvLyBjb3B5IG92ZXIgYWxsIGNsYXNzIHZhcmlhYmxlcy9tZXRob2RzIHRvIHRoZSBzdWJjbGFzcywgc3VjaCBhcyBgZXh0ZW5kYCBhbmQgYG1peGluYAoJY29weU93blByb3BzKHN1cGVyQ2xhc3MsIHN1YkNsYXNzKTsKCglyZXR1cm4gc3ViQ2xhc3M7Cn07CgovLyBhZGRzIG5ldyBtZW1iZXIgdmFyaWFibGVzL21ldGhvZHMgdG8gdGhlIGNsYXNzJ3MgcHJvdG90eXBlLgovLyBjYW4gYmUgY2FsbGVkIHdpdGggYW5vdGhlciBjbGFzcywgb3IgYSBwbGFpbiBvYmplY3QgaGFzaCBjb250YWluaW5nIG5ldyBtZW1iZXJzLgpDbGFzcy5taXhpbiA9IGZ1bmN0aW9uKG1lbWJlcnMpIHsKCWNvcHlPd25Qcm9wcyhtZW1iZXJzLnByb3RvdHlwZSB8fCBtZW1iZXJzLCB0aGlzLnByb3RvdHlwZSk7Cn07Cjs7CgovKiBBIHJlY3Rhbmd1bGFyIHBhbmVsIHRoYXQgaXMgYWJzb2x1dGVseSBwb3NpdGlvbmVkIG92ZXIgb3RoZXIgY29udGVudAotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KT3B0aW9uczoKCS0gY2xhc3NOYW1lIChzdHJpbmcpCgktIGNvbnRlbnQgKEhUTUwgc3RyaW5nIG9yIGpRdWVyeSBlbGVtZW50IHNldCkKCS0gcGFyZW50RWwKCS0gdG9wCgktIGxlZnQKCS0gcmlnaHQgKHRoZSB4IGNvb3JkIG9mIHdoZXJlIHRoZSByaWdodCBlZGdlIHNob3VsZCBiZS4gbm90IGEgIkNTUyIgcmlnaHQpCgktIGF1dG9IaWRlIChib29sZWFuKQoJLSBzaG93IChjYWxsYmFjaykKCS0gaGlkZSAoY2FsbGJhY2spCiovCgp2YXIgUG9wb3ZlciA9IENsYXNzLmV4dGVuZCh7CgoJaXNIaWRkZW46IHRydWUsCglvcHRpb25zOiBudWxsLAoJZWw6IG51bGwsIC8vIHRoZSBjb250YWluZXIgZWxlbWVudCBmb3IgdGhlIHBvcG92ZXIuIGdlbmVyYXRlZCBieSB0aGlzIG9iamVjdAoJZG9jdW1lbnRNb3VzZWRvd25Qcm94eTogbnVsbCwgLy8gZG9jdW1lbnQgbW91c2Vkb3duIGhhbmRsZXIgYm91bmQgdG8gYHRoaXNgCgltYXJnaW46IDEwLCAvLyB0aGUgc3BhY2UgcmVxdWlyZWQgYmV0d2VlbiB0aGUgcG9wb3ZlciBhbmQgdGhlIGVkZ2VzIG9mIHRoZSBzY3JvbGwgY29udGFpbmVyCgoKCWNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCX0sCgoKCS8vIFNob3dzIHRoZSBwb3BvdmVyIG9uIHRoZSBzcGVjaWZpZWQgcG9zaXRpb24uIFJlbmRlcnMgaXQgaWYgbm90IGFscmVhZHkKCXNob3c6IGZ1bmN0aW9uKCkgewoJCWlmICh0aGlzLmlzSGlkZGVuKSB7CgkJCWlmICghdGhpcy5lbCkgewoJCQkJdGhpcy5yZW5kZXIoKTsKCQkJfQoJCQl0aGlzLmVsLnNob3coKTsKCQkJdGhpcy5wb3NpdGlvbigpOwoJCQl0aGlzLmlzSGlkZGVuID0gZmFsc2U7CgkJCXRoaXMudHJpZ2dlcignc2hvdycpOwoJCX0KCX0sCgoKCS8vIEhpZGVzIHRoZSBwb3BvdmVyLCB0aHJvdWdoIENTUywgYnV0IGRvZXMgbm90IHJlbW92ZSBpdCBmcm9tIHRoZSBET00KCWhpZGU6IGZ1bmN0aW9uKCkgewoJCWlmICghdGhpcy5pc0hpZGRlbikgewoJCQl0aGlzLmVsLmhpZGUoKTsKCQkJdGhpcy5pc0hpZGRlbiA9IHRydWU7CgkJCXRoaXMudHJpZ2dlcignaGlkZScpOwoJCX0KCX0sCgoKCS8vIENyZWF0ZXMgYHRoaXMuZWxgIGFuZCByZW5kZXJzIGNvbnRlbnQgaW5zaWRlIG9mIGl0CglyZW5kZXI6IGZ1bmN0aW9uKCkgewoJCXZhciBfdGhpcyA9IHRoaXM7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCXRoaXMuZWwgPSAkKCc8ZGl2IGNsYXNzPSJmYy1wb3BvdmVyIi8+JykKCQkJLmFkZENsYXNzKG9wdGlvbnMuY2xhc3NOYW1lIHx8ICcnKQoJCQkuY3NzKHsKCQkJCS8vIHBvc2l0aW9uIGluaXRpYWxseSB0byB0aGUgdG9wIGxlZnQgdG8gYXZvaWQgY3JlYXRpbmcgc2Nyb2xsYmFycwoJCQkJdG9wOiAwLAoJCQkJbGVmdDogMAoJCQl9KQoJCQkuYXBwZW5kKG9wdGlvbnMuY29udGVudCkKCQkJLmFwcGVuZFRvKG9wdGlvbnMucGFyZW50RWwpOwoKCQkvLyB3aGVuIGEgY2xpY2sgaGFwcGVucyBvbiBhbnl0aGluZyBpbnNpZGUgd2l0aCBhICdmYy1jbG9zZScgY2xhc3NOYW1lLCBoaWRlIHRoZSBwb3BvdmVyCgkJdGhpcy5lbC5vbignY2xpY2snLCAnLmZjLWNsb3NlJywgZnVuY3Rpb24oKSB7CgkJCV90aGlzLmhpZGUoKTsKCQl9KTsKCgkJaWYgKG9wdGlvbnMuYXV0b0hpZGUpIHsKCQkJJChkb2N1bWVudCkub24oJ21vdXNlZG93bicsIHRoaXMuZG9jdW1lbnRNb3VzZWRvd25Qcm94eSA9ICQucHJveHkodGhpcywgJ2RvY3VtZW50TW91c2Vkb3duJykpOwoJCX0KCX0sCgoKCS8vIFRyaWdnZXJlZCB3aGVuIHRoZSB1c2VyIGNsaWNrcyAqYW55d2hlcmUqIGluIHRoZSBkb2N1bWVudCwgZm9yIHRoZSBhdXRvSGlkZSBmZWF0dXJlCglkb2N1bWVudE1vdXNlZG93bjogZnVuY3Rpb24oZXYpIHsKCQkvLyBvbmx5IGhpZGUgdGhlIHBvcG92ZXIgaWYgdGhlIGNsaWNrIGhhcHBlbmVkIG91dHNpZGUgdGhlIHBvcG92ZXIKCQlpZiAodGhpcy5lbCAmJiAhJChldi50YXJnZXQpLmNsb3Nlc3QodGhpcy5lbCkubGVuZ3RoKSB7CgkJCXRoaXMuaGlkZSgpOwoJCX0KCX0sCgoKCS8vIEhpZGVzIGFuZCB1bnJlZ2lzdGVycyBhbnkgaGFuZGxlcnMKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGlkZSgpOwoKCQlpZiAodGhpcy5lbCkgewoJCQl0aGlzLmVsLnJlbW92ZSgpOwoJCQl0aGlzLmVsID0gbnVsbDsKCQl9CgoJCSQoZG9jdW1lbnQpLm9mZignbW91c2Vkb3duJywgdGhpcy5kb2N1bWVudE1vdXNlZG93blByb3h5KTsKCX0sCgoKCS8vIFBvc2l0aW9ucyB0aGUgcG9wb3ZlciBvcHRpbWFsbHksIHVzaW5nIHRoZSB0b3AvbGVmdC9yaWdodCBvcHRpb25zCglwb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgkJdmFyIG9yaWdpbiA9IHRoaXMuZWwub2Zmc2V0UGFyZW50KCkub2Zmc2V0KCk7CgkJdmFyIHdpZHRoID0gdGhpcy5lbC5vdXRlcldpZHRoKCk7CgkJdmFyIGhlaWdodCA9IHRoaXMuZWwub3V0ZXJIZWlnaHQoKTsKCQl2YXIgd2luZG93RWwgPSAkKHdpbmRvdyk7CgkJdmFyIHZpZXdwb3J0RWwgPSBnZXRTY3JvbGxQYXJlbnQodGhpcy5lbCk7CgkJdmFyIHZpZXdwb3J0VG9wOwoJCXZhciB2aWV3cG9ydExlZnQ7CgkJdmFyIHZpZXdwb3J0T2Zmc2V0OwoJCXZhciB0b3A7IC8vIHRoZSAicG9zaXRpb24iIChub3QgIm9mZnNldCIpIHZhbHVlcyBmb3IgdGhlIHBvcG92ZXIKCQl2YXIgbGVmdDsgLy8KCgkJLy8gY29tcHV0ZSB0b3AgYW5kIGxlZnQKCQl0b3AgPSBvcHRpb25zLnRvcCB8fCAwOwoJCWlmIChvcHRpb25zLmxlZnQgIT09IHVuZGVmaW5lZCkgewoJCQlsZWZ0ID0gb3B0aW9ucy5sZWZ0OwoJCX0KCQllbHNlIGlmIChvcHRpb25zLnJpZ2h0ICE9PSB1bmRlZmluZWQpIHsKCQkJbGVmdCA9IG9wdGlvbnMucmlnaHQgLSB3aWR0aDsgLy8gZGVyaXZlIHRoZSBsZWZ0IHZhbHVlIGZyb20gdGhlIHJpZ2h0IHZhbHVlCgkJfQoJCWVsc2UgewoJCQlsZWZ0ID0gMDsKCQl9CgoJCWlmICh2aWV3cG9ydEVsLmlzKHdpbmRvdykgfHwgdmlld3BvcnRFbC5pcyhkb2N1bWVudCkpIHsgLy8gbm9ybWFsaXplIGdldFNjcm9sbFBhcmVudCdzIHJlc3VsdAoJCQl2aWV3cG9ydEVsID0gd2luZG93RWw7CgkJCXZpZXdwb3J0VG9wID0gMDsgLy8gdGhlIHdpbmRvdyBpcyBhbHdheXMgYXQgdGhlIHRvcCBsZWZ0CgkJCXZpZXdwb3J0TGVmdCA9IDA7IC8vIChhbmQgLm9mZnNldCgpIHdvbid0IHdvcmsgaWYgY2FsbGVkIGhlcmUpCgkJfQoJCWVsc2UgewoJCQl2aWV3cG9ydE9mZnNldCA9IHZpZXdwb3J0RWwub2Zmc2V0KCk7CgkJCXZpZXdwb3J0VG9wID0gdmlld3BvcnRPZmZzZXQudG9wOwoJCQl2aWV3cG9ydExlZnQgPSB2aWV3cG9ydE9mZnNldC5sZWZ0OwoJCX0KCgkJLy8gaWYgdGhlIHdpbmRvdyBpcyBzY3JvbGxlZCwgaXQgY2F1c2VzIHRoZSB2aXNpYmxlIGFyZWEgdG8gYmUgZnVydGhlciBkb3duCgkJdmlld3BvcnRUb3AgKz0gd2luZG93RWwuc2Nyb2xsVG9wKCk7CgkJdmlld3BvcnRMZWZ0ICs9IHdpbmRvd0VsLnNjcm9sbExlZnQoKTsKCgkJLy8gY29uc3RyYWluIHRvIHRoZSB2aWV3IHBvcnQuIGlmIGNvbnN0cmFpbmVkIGJ5IHR3byBlZGdlcywgZ2l2ZSBwcmVjZWRlbmNlIHRvIHRvcC9sZWZ0CgkJaWYgKG9wdGlvbnMudmlld3BvcnRDb25zdHJhaW4gIT09IGZhbHNlKSB7CgkJCXRvcCA9IE1hdGgubWluKHRvcCwgdmlld3BvcnRUb3AgKyB2aWV3cG9ydEVsLm91dGVySGVpZ2h0KCkgLSBoZWlnaHQgLSB0aGlzLm1hcmdpbik7CgkJCXRvcCA9IE1hdGgubWF4KHRvcCwgdmlld3BvcnRUb3AgKyB0aGlzLm1hcmdpbik7CgkJCWxlZnQgPSBNYXRoLm1pbihsZWZ0LCB2aWV3cG9ydExlZnQgKyB2aWV3cG9ydEVsLm91dGVyV2lkdGgoKSAtIHdpZHRoIC0gdGhpcy5tYXJnaW4pOwoJCQlsZWZ0ID0gTWF0aC5tYXgobGVmdCwgdmlld3BvcnRMZWZ0ICsgdGhpcy5tYXJnaW4pOwoJCX0KCgkJdGhpcy5lbC5jc3MoewoJCQl0b3A6IHRvcCAtIG9yaWdpbi50b3AsCgkJCWxlZnQ6IGxlZnQgLSBvcmlnaW4ubGVmdAoJCX0pOwoJfSwKCgoJLy8gVHJpZ2dlcnMgYSBjYWxsYmFjay4gQ2FsbHMgYSBmdW5jdGlvbiBpbiB0aGUgb3B0aW9uIGhhc2ggb2YgdGhlIHNhbWUgbmFtZS4KCS8vIEFyZ3VtZW50cyBiZXlvbmQgdGhlIGZpcnN0IGBuYW1lYCBhcmUgZm9yd2FyZGVkIG9uLgoJLy8gVE9ETzogYmV0dGVyIGNvZGUgcmV1c2UgZm9yIHRoaXMuIFJlcGVhdCBjb2RlCgl0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CgkJaWYgKHRoaXMub3B0aW9uc1tuYW1lXSkgewoJCQl0aGlzLm9wdGlvbnNbbmFtZV0uYXBwbHkodGhpcywgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkJfQoJfQoKfSk7Cgo7OwoKLyogQSAiY29vcmRpbmF0ZSBtYXAiIGNvbnZlcnRzIHBpeGVsIGNvb3JkaW5hdGVzIGludG8gYW4gYXNzb2NpYXRlZCBjZWxsLCB3aGljaCBoYXMgYW4gYXNzb2NpYXRlZCBkYXRlCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpDb21tb24gaW50ZXJmYWNlOgoKCUNvb3JkTWFwLnByb3RvdHlwZSA9IHsKCQlidWlsZDogZnVuY3Rpb24oKSB7fSwKCQlnZXRDZWxsOiBmdW5jdGlvbih4LCB5KSB7fQoJfTsKCiovCgovKiBDb29yZGluYXRlIG1hcCBmb3IgYSBncmlkIGNvbXBvbmVudAotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCnZhciBHcmlkQ29vcmRNYXAgPSBDbGFzcy5leHRlbmQoewoKCWdyaWQ6IG51bGwsIC8vIHJlZmVyZW5jZSB0byB0aGUgR3JpZAoJcm93Q29vcmRzOiBudWxsLCAvLyBhcnJheSBvZiB7dG9wLGJvdHRvbX0gb2JqZWN0cwoJY29sQ29vcmRzOiBudWxsLCAvLyBhcnJheSBvZiB7bGVmdCxyaWdodH0gb2JqZWN0cwoKCWNvbnRhaW5lckVsOiBudWxsLCAvLyBjb250YWluZXIgZWxlbWVudCB0aGF0IGFsbCBjb29yZGluYXRlcyBhcmUgY29uc3RyYWluZWQgdG8uIG9wdGlvbmFsbHkgYXNzaWduZWQKCW1pblg6IG51bGwsCgltYXhYOiBudWxsLCAvLyBleGNsdXNpdmUKCW1pblk6IG51bGwsCgltYXhZOiBudWxsLCAvLyBleGNsdXNpdmUKCgoJY29uc3RydWN0b3I6IGZ1bmN0aW9uKGdyaWQpIHsKCQl0aGlzLmdyaWQgPSBncmlkOwoJfSwKCgoJLy8gUXVlcmllcyB0aGUgZ3JpZCBmb3IgdGhlIGNvb3JkaW5hdGVzIG9mIGFsbCB0aGUgY2VsbHMKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl0aGlzLnJvd0Nvb3JkcyA9IHRoaXMuZ3JpZC5jb21wdXRlUm93Q29vcmRzKCk7CgkJdGhpcy5jb2xDb29yZHMgPSB0aGlzLmdyaWQuY29tcHV0ZUNvbENvb3JkcygpOwoJCXRoaXMuY29tcHV0ZUJvdW5kcygpOwoJfSwKCgoJLy8gQ2xlYXJzIHRoZSBjb29yZGluYXRlcyBkYXRhIHRvIGZyZWUgdXAgbWVtb3J5CgljbGVhcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5yb3dDb29yZHMgPSBudWxsOwoJCXRoaXMuY29sQ29vcmRzID0gbnVsbDsKCX0sCgoKCS8vIEdpdmVuIGEgY29vcmRpbmF0ZSBvZiB0aGUgZG9jdW1lbnQsIGdldHMgdGhlIGFzc29jaWF0ZWQgY2VsbC4gSWYgbm8gY2VsbCBpcyB1bmRlcm5lYXRoLCByZXR1cm5zIG51bGwKCWdldENlbGw6IGZ1bmN0aW9uKHgsIHkpIHsKCQl2YXIgcm93Q29vcmRzID0gdGhpcy5yb3dDb29yZHM7CgkJdmFyIGNvbENvb3JkcyA9IHRoaXMuY29sQ29vcmRzOwoJCXZhciBoaXRSb3cgPSBudWxsOwoJCXZhciBoaXRDb2wgPSBudWxsOwoJCXZhciBpLCBjb29yZHM7CgkJdmFyIGNlbGw7CgoJCWlmICh0aGlzLmluQm91bmRzKHgsIHkpKSB7CgoJCQlmb3IgKGkgPSAwOyBpIDwgcm93Q29vcmRzLmxlbmd0aDsgaSsrKSB7CgkJCQljb29yZHMgPSByb3dDb29yZHNbaV07CgkJCQlpZiAoeSA+PSBjb29yZHMudG9wICYmIHkgPCBjb29yZHMuYm90dG9tKSB7CgkJCQkJaGl0Um93ID0gaTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoKCQkJZm9yIChpID0gMDsgaSA8IGNvbENvb3Jkcy5sZW5ndGg7IGkrKykgewoJCQkJY29vcmRzID0gY29sQ29vcmRzW2ldOwoJCQkJaWYgKHggPj0gY29vcmRzLmxlZnQgJiYgeCA8IGNvb3Jkcy5yaWdodCkgewoJCQkJCWhpdENvbCA9IGk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCWlmIChoaXRSb3cgIT09IG51bGwgJiYgaGl0Q29sICE9PSBudWxsKSB7CgkJCQljZWxsID0gdGhpcy5ncmlkLmdldENlbGwoaGl0Um93LCBoaXRDb2wpOwoJCQkJY2VsbC5ncmlkID0gdGhpcy5ncmlkOyAvLyBmb3IgRHJhZ0xpc3RlbmVyJ3MgaXNDZWxsc0VxdWFsLiBkcmFnZ2luZyBiZXR3ZWVuIGdyaWRzCgkJCQlyZXR1cm4gY2VsbDsKCQkJfQoJCX0KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCgkvLyBJZiB0aGVyZSBpcyBhIGNvbnRhaW5lckVsLCBjb21wdXRlIHRoZSBib3VuZHMgaW50byBtaW4vbWF4IHZhbHVlcwoJY29tcHV0ZUJvdW5kczogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRhaW5lck9mZnNldDsKCgkJaWYgKHRoaXMuY29udGFpbmVyRWwpIHsKCQkJY29udGFpbmVyT2Zmc2V0ID0gdGhpcy5jb250YWluZXJFbC5vZmZzZXQoKTsKCQkJdGhpcy5taW5YID0gY29udGFpbmVyT2Zmc2V0LmxlZnQ7CgkJCXRoaXMubWF4WCA9IGNvbnRhaW5lck9mZnNldC5sZWZ0ICsgdGhpcy5jb250YWluZXJFbC5vdXRlcldpZHRoKCk7CgkJCXRoaXMubWluWSA9IGNvbnRhaW5lck9mZnNldC50b3A7CgkJCXRoaXMubWF4WSA9IGNvbnRhaW5lck9mZnNldC50b3AgKyB0aGlzLmNvbnRhaW5lckVsLm91dGVySGVpZ2h0KCk7CgkJfQoJfSwKCgoJLy8gRGV0ZXJtaW5lcyBpZiB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMgYXJlIGluIGJvdW5kcy4gSWYgbm8gYGNvbnRhaW5lckVsYCwgYWx3YXlzIHRydWUKCWluQm91bmRzOiBmdW5jdGlvbih4LCB5KSB7CgkJaWYgKHRoaXMuY29udGFpbmVyRWwpIHsKCQkJcmV0dXJuIHggPj0gdGhpcy5taW5YICYmIHggPCB0aGlzLm1heFggJiYgeSA+PSB0aGlzLm1pblkgJiYgeSA8IHRoaXMubWF4WTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9Cgp9KTsKCgovKiBDb29yZGluYXRlIG1hcCB0aGF0IGlzIGEgY29tYmluYXRpb24gb2YgbXVsdGlwbGUgb3RoZXIgY29vcmRpbmF0ZSBtYXBzCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKdmFyIENvbWJvQ29vcmRNYXAgPSBDbGFzcy5leHRlbmQoewoKCWNvb3JkTWFwczogbnVsbCwgLy8gYW4gYXJyYXkgb2YgQ29vcmRNYXBzCgoKCWNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb29yZE1hcHMpIHsKCQl0aGlzLmNvb3JkTWFwcyA9IGNvb3JkTWFwczsKCX0sCgoKCS8vIEJ1aWxkcyBhbGwgY29vcmRNYXBzCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIGNvb3JkTWFwcyA9IHRoaXMuY29vcmRNYXBzOwoJCXZhciBpOwoKCQlmb3IgKGkgPSAwOyBpIDwgY29vcmRNYXBzLmxlbmd0aDsgaSsrKSB7CgkJCWNvb3JkTWFwc1tpXS5idWlsZCgpOwoJCX0KCX0sCgoKCS8vIFF1ZXJpZXMgYWxsIGNvb3JkTWFwcyBmb3IgdGhlIGNlbGwgdW5kZXJuZWF0aCB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMsIHJldHVybmluZyB0aGUgZmlyc3QgcmVzdWx0CglnZXRDZWxsOiBmdW5jdGlvbih4LCB5KSB7CgkJdmFyIGNvb3JkTWFwcyA9IHRoaXMuY29vcmRNYXBzOwoJCXZhciBjZWxsID0gbnVsbDsKCQl2YXIgaTsKCgkJZm9yIChpID0gMDsgaSA8IGNvb3JkTWFwcy5sZW5ndGggJiYgIWNlbGw7IGkrKykgewoJCQljZWxsID0gY29vcmRNYXBzW2ldLmdldENlbGwoeCwgeSk7CgkJfQoKCQlyZXR1cm4gY2VsbDsKCX0sCgoKCS8vIENsZWFycyBhbGwgY29vcmRNYXBzCgljbGVhcjogZnVuY3Rpb24oKSB7CgkJdmFyIGNvb3JkTWFwcyA9IHRoaXMuY29vcmRNYXBzOwoJCXZhciBpOwoKCQlmb3IgKGkgPSAwOyBpIDwgY29vcmRNYXBzLmxlbmd0aDsgaSsrKSB7CgkJCWNvb3JkTWFwc1tpXS5jbGVhcigpOwoJCX0KCX0KCn0pOwoKOzsKCi8qIFRyYWNrcyBtb3VzZSBtb3ZlbWVudHMgb3ZlciBhIENvb3JkTWFwIGFuZCByYWlzZXMgZXZlbnRzIGFib3V0IHdoaWNoIGNlbGwgdGhlIG1vdXNlIGlzIG92ZXIuCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwovLyBUT0RPOiB2ZXJ5IHVzZWZ1bCB0byBoYXZlIGEgaGFuZGxlciB0aGF0IGdldHMgY2FsbGVkIHVwb24gY2VsbE91dCBPUiB3aGVuIGRyYWdnaW5nIHN0b3BzIChmb3IgY2xlYW51cCkKCnZhciBEcmFnTGlzdGVuZXIgPSBDbGFzcy5leHRlbmQoewoKCWNvb3JkTWFwOiBudWxsLAoJb3B0aW9uczogbnVsbCwKCglpc0xpc3RlbmluZzogZmFsc2UsCglpc0RyYWdnaW5nOiBmYWxzZSwKCgkvLyB0aGUgY2VsbCB0aGUgbW91c2Ugd2FzIG92ZXIgd2hlbiBsaXN0ZW5pbmcgc3RhcnRlZAoJb3JpZ0NlbGw6IG51bGwsCgoJLy8gdGhlIGNlbGwgdGhlIG1vdXNlIGlzIG92ZXIKCWNlbGw6IG51bGwsCgoJLy8gY29vcmRpbmF0ZXMgb2YgdGhlIGluaXRpYWwgbW91c2Vkb3duCgltb3VzZVgwOiBudWxsLAoJbW91c2VZMDogbnVsbCwKCgkvLyBoYW5kbGVyIGF0dGFjaGVkIHRvIHRoZSBkb2N1bWVudCwgYm91bmQgdG8gdGhlIERyYWdMaXN0ZW5lcidzIGB0aGlzYAoJbW91c2Vtb3ZlUHJveHk6IG51bGwsCgltb3VzZXVwUHJveHk6IG51bGwsCgoJc2Nyb2xsRWw6IG51bGwsCglzY3JvbGxCb3VuZHM6IG51bGwsIC8vIHsgdG9wLCBib3R0b20sIGxlZnQsIHJpZ2h0IH0KCXNjcm9sbFRvcFZlbDogbnVsbCwgLy8gcGl4ZWxzIHBlciBzZWNvbmQKCXNjcm9sbExlZnRWZWw6IG51bGwsIC8vIHBpeGVscyBwZXIgc2Vjb25kCglzY3JvbGxJbnRlcnZhbElkOiBudWxsLCAvLyBJRCBvZiBzZXRUaW1lb3V0IGZvciBzY3JvbGxpbmcgYW5pbWF0aW9uIGxvb3AKCXNjcm9sbEhhbmRsZXJQcm94eTogbnVsbCwgLy8gdGhpcy1zY29wZWQgZnVuY3Rpb24gZm9yIGhhbmRsaW5nIHdoZW4gc2Nyb2xsRWwgaXMgc2Nyb2xsZWQKCglzY3JvbGxTZW5zaXRpdml0eTogMzAsIC8vIHBpeGVscyBmcm9tIGVkZ2UgZm9yIHNjcm9sbGluZyB0byBzdGFydAoJc2Nyb2xsU3BlZWQ6IDIwMCwgLy8gcGl4ZWxzIHBlciBzZWNvbmQsIGF0IG1heGltdW0gc3BlZWQKCXNjcm9sbEludGVydmFsTXM6IDUwLCAvLyBtaWxsaXNlY29uZCB3YWl0IGJldHdlZW4gc2Nyb2xsIGluY3JlbWVudAoKCgljb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29vcmRNYXAsIG9wdGlvbnMpIHsKCQl0aGlzLmNvb3JkTWFwID0gY29vcmRNYXA7CgkJdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCX0sCgoKCS8vIENhbGwgdGhpcyB3aGVuIHRoZSB1c2VyIGRvZXMgYSBtb3VzZWRvd24uIFdpbGwgcHJvYmFibHkgbGVhZCB0byBzdGFydExpc3RlbmluZwoJbW91c2Vkb3duOiBmdW5jdGlvbihldikgewoJCWlmIChpc1ByaW1hcnlNb3VzZUJ1dHRvbihldikpIHsKCgkJCWV2LnByZXZlbnREZWZhdWx0KCk7IC8vIHByZXZlbnRzIG5hdGl2ZSBzZWxlY3Rpb24gaW4gbW9zdCBicm93c2VycwoKCQkJdGhpcy5zdGFydExpc3RlbmluZyhldik7CgoJCQkvLyBzdGFydCB0aGUgZHJhZyBpbW1lZGlhdGVseSBpZiB0aGVyZSBpcyBubyBtaW5pbXVtIGRpc3RhbmNlIGZvciBhIGRyYWcgc3RhcnQKCQkJaWYgKCF0aGlzLm9wdGlvbnMuZGlzdGFuY2UpIHsKCQkJCXRoaXMuc3RhcnREcmFnKGV2KTsKCQkJfQoJCX0KCX0sCgoKCS8vIENhbGwgdGhpcyB0byBzdGFydCB0cmFja2luZyBtb3VzZSBtb3ZlbWVudHMKCXN0YXJ0TGlzdGVuaW5nOiBmdW5jdGlvbihldikgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJdmFyIGNlbGw7CgoJCWlmICghdGhpcy5pc0xpc3RlbmluZykgewoKCQkJLy8gZ3JhYiBzY3JvbGwgY29udGFpbmVyIGFuZCBhdHRhY2ggaGFuZGxlcgoJCQlpZiAoZXYgJiYgdGhpcy5vcHRpb25zLnNjcm9sbCkgewoJCQkJc2Nyb2xsUGFyZW50ID0gZ2V0U2Nyb2xsUGFyZW50KCQoZXYudGFyZ2V0KSk7CgkJCQlpZiAoIXNjcm9sbFBhcmVudC5pcyh3aW5kb3cpICYmICFzY3JvbGxQYXJlbnQuaXMoZG9jdW1lbnQpKSB7CgkJCQkJdGhpcy5zY3JvbGxFbCA9IHNjcm9sbFBhcmVudDsKCgkJCQkJLy8gc2NvcGUgdG8gYHRoaXNgLCBhbmQgdXNlIGBkZWJvdW5jZWAgdG8gbWFrZSBzdXJlIHJhcGlkIGNhbGxzIGRvbid0IGhhcHBlbgoJCQkJCXRoaXMuc2Nyb2xsSGFuZGxlclByb3h5ID0gZGVib3VuY2UoJC5wcm94eSh0aGlzLCAnc2Nyb2xsSGFuZGxlcicpLCAxMDApOwoJCQkJCXRoaXMuc2Nyb2xsRWwub24oJ3Njcm9sbCcsIHRoaXMuc2Nyb2xsSGFuZGxlclByb3h5KTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5jb21wdXRlQ29vcmRzKCk7IC8vIHJlbGllcyBvbiBgc2Nyb2xsRWxgCgoJCQkvLyBnZXQgaW5mbyBvbiB0aGUgaW5pdGlhbCBjZWxsIGFuZCBpdHMgY29vcmRpbmF0ZXMKCQkJaWYgKGV2KSB7CgkJCQljZWxsID0gdGhpcy5nZXRDZWxsKGV2KTsKCQkJCXRoaXMub3JpZ0NlbGwgPSBjZWxsOwoKCQkJCXRoaXMubW91c2VYMCA9IGV2LnBhZ2VYOwoJCQkJdGhpcy5tb3VzZVkwID0gZXYucGFnZVk7CgkJCX0KCgkJCSQoZG9jdW1lbnQpCgkJCQkub24oJ21vdXNlbW92ZScsIHRoaXMubW91c2Vtb3ZlUHJveHkgPSAkLnByb3h5KHRoaXMsICdtb3VzZW1vdmUnKSkKCQkJCS5vbignbW91c2V1cCcsIHRoaXMubW91c2V1cFByb3h5ID0gJC5wcm94eSh0aGlzLCAnbW91c2V1cCcpKQoJCQkJLm9uKCdzZWxlY3RzdGFydCcsIHRoaXMucHJldmVudERlZmF1bHQpOyAvLyBwcmV2ZW50cyBuYXRpdmUgc2VsZWN0aW9uIGluIElFPD04CgoJCQl0aGlzLmlzTGlzdGVuaW5nID0gdHJ1ZTsKCQkJdGhpcy50cmlnZ2VyKCdsaXN0ZW5TdGFydCcsIGV2KTsKCQl9Cgl9LAoKCgkvLyBSZWNvbXB1dGVzIHRoZSBkcmFnLWNyaXRpY2FsIHBvc2l0aW9ucyBvZiBlbGVtZW50cwoJY29tcHV0ZUNvb3JkczogZnVuY3Rpb24oKSB7CgkJdGhpcy5jb29yZE1hcC5idWlsZCgpOwoJCXRoaXMuY29tcHV0ZVNjcm9sbEJvdW5kcygpOwoJfSwKCgoJLy8gQ2FsbGVkIHdoZW4gdGhlIHVzZXIgbW92ZXMgdGhlIG1vdXNlCgltb3VzZW1vdmU6IGZ1bmN0aW9uKGV2KSB7CgkJdmFyIG1pbkRpc3RhbmNlOwoJCXZhciBkaXN0YW5jZVNxOyAvLyBjdXJyZW50IGRpc3RhbmNlIGZyb20gbW91c2VYMC9tb3VzZVkwLCBzcXVhcmVkCgoJCWlmICghdGhpcy5pc0RyYWdnaW5nKSB7IC8vIGlmIG5vdCBhbHJlYWR5IGRyYWdnaW5nLi4uCgkJCS8vIHRoZW4gc3RhcnQgdGhlIGRyYWcgaWYgdGhlIG1pbmltdW0gZGlzdGFuY2UgY3JpdGVyaWEgaXMgbWV0CgkJCW1pbkRpc3RhbmNlID0gdGhpcy5vcHRpb25zLmRpc3RhbmNlIHx8IDE7CgkJCWRpc3RhbmNlU3EgPSBNYXRoLnBvdyhldi5wYWdlWCAtIHRoaXMubW91c2VYMCwgMikgKyBNYXRoLnBvdyhldi5wYWdlWSAtIHRoaXMubW91c2VZMCwgMik7CgkJCWlmIChkaXN0YW5jZVNxID49IG1pbkRpc3RhbmNlICogbWluRGlzdGFuY2UpIHsgLy8gdXNlIHB5dGhhZ29yZWFuIHRoZW9yZW0KCQkJCXRoaXMuc3RhcnREcmFnKGV2KTsKCQkJfQoJCX0KCgkJaWYgKHRoaXMuaXNEcmFnZ2luZykgewoJCQl0aGlzLmRyYWcoZXYpOyAvLyByZXBvcnQgYSBkcmFnLCBldmVuIGlmIHRoaXMgbW91c2Vtb3ZlIGluaXRpYXRlZCB0aGUgZHJhZwoJCX0KCX0sCgoKCS8vIENhbGwgdGhpcyB0byBpbml0aWF0ZSBhIGxlZ2l0aW1hdGUgZHJhZy4KCS8vIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGludGVybmFsbHkgZnJvbSB0aGlzIGNsYXNzLCBidXQgY2FuIGFsc28gYmUgY2FsbGVkIGV4cGxpY2l0bHkgZnJvbSBvdXRzaWRlCglzdGFydERyYWc6IGZ1bmN0aW9uKGV2KSB7CgkJdmFyIGNlbGw7CgoJCWlmICghdGhpcy5pc0xpc3RlbmluZykgeyAvLyBzdGFydERyYWcgbXVzdCBoYXZlIG1hbnVhbGx5IGluaXRpYXRlZAoJCQl0aGlzLnN0YXJ0TGlzdGVuaW5nKCk7CgkJfQoKCQlpZiAoIXRoaXMuaXNEcmFnZ2luZykgewoJCQl0aGlzLmlzRHJhZ2dpbmcgPSB0cnVlOwoJCQl0aGlzLnRyaWdnZXIoJ2RyYWdTdGFydCcsIGV2KTsKCgkJCS8vIHJlcG9ydCB0aGUgaW5pdGlhbCBjZWxsIHRoZSBtb3VzZSBpcyBvdmVyCgkJCS8vIGVzcGVjaWFsbHkgaW1wb3J0YW50IGlmIG5vIG1pbi1kaXN0YW5jZSBhbmQgZHJhZyBzdGFydHMgaW1tZWRpYXRlbHkKCQkJY2VsbCA9IHRoaXMuZ2V0Q2VsbChldik7IC8vIHRoaXMgbWlnaHQgYmUgZGlmZmVyZW50IGZyb20gdGhpcy5vcmlnQ2VsbCBpZiB0aGUgbWluLWRpc3RhbmNlIGlzIGxhcmdlCgkJCWlmIChjZWxsKSB7CgkJCQl0aGlzLmNlbGxPdmVyKGNlbGwpOwoJCQl9CgkJfQoJfSwKCgoJLy8gQ2FsbGVkIHdoaWxlIHRoZSBtb3VzZSBpcyBiZWluZyBtb3ZlZCBhbmQgd2hlbiB3ZSBrbm93IGEgbGVnaXRpbWF0ZSBkcmFnIGlzIHRha2luZyBwbGFjZQoJZHJhZzogZnVuY3Rpb24oZXYpIHsKCQl2YXIgY2VsbDsKCgkJaWYgKHRoaXMuaXNEcmFnZ2luZykgewoJCQljZWxsID0gdGhpcy5nZXRDZWxsKGV2KTsKCgkJCWlmICghaXNDZWxsc0VxdWFsKGNlbGwsIHRoaXMuY2VsbCkpIHsgLy8gYSBkaWZmZXJlbnQgY2VsbCB0aGFuIGJlZm9yZT8KCQkJCWlmICh0aGlzLmNlbGwpIHsKCQkJCQl0aGlzLmNlbGxPdXQoKTsKCQkJCX0KCQkJCWlmIChjZWxsKSB7CgkJCQkJdGhpcy5jZWxsT3ZlcihjZWxsKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5kcmFnU2Nyb2xsKGV2KTsgLy8gd2lsbCBwb3NzaWJseSBjYXVzZSBzY3JvbGxpbmcKCQl9Cgl9LAoKCgkvLyBDYWxsZWQgd2hlbiBhIHRoZSBtb3VzZSBoYXMganVzdCBtb3ZlZCBvdmVyIGEgbmV3IGNlbGwKCWNlbGxPdmVyOiBmdW5jdGlvbihjZWxsKSB7CgkJdGhpcy5jZWxsID0gY2VsbDsKCQl0aGlzLnRyaWdnZXIoJ2NlbGxPdmVyJywgY2VsbCwgaXNDZWxsc0VxdWFsKGNlbGwsIHRoaXMub3JpZ0NlbGwpKTsKCX0sCgoKCS8vIENhbGxlZCB3aGVuIHRoZSBtb3VzZSBoYXMganVzdCBtb3ZlZCBvdXQgb2YgYSBjZWxsCgljZWxsT3V0OiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5jZWxsKSB7CgkJCXRoaXMudHJpZ2dlcignY2VsbE91dCcsIHRoaXMuY2VsbCk7CgkJCXRoaXMuY2VsbCA9IG51bGw7CgkJfQoJfSwKCgoJLy8gQ2FsbGVkIHdoZW4gdGhlIHVzZXIgZG9lcyBhIG1vdXNldXAKCW1vdXNldXA6IGZ1bmN0aW9uKGV2KSB7CgkJdGhpcy5zdG9wRHJhZyhldik7CgkJdGhpcy5zdG9wTGlzdGVuaW5nKGV2KTsKCX0sCgoKCS8vIENhbGxlZCB3aGVuIHRoZSBkcmFnIGlzIG92ZXIuIFdpbGwgbm90IGNhdXNlIGxpc3RlbmluZyB0byBzdG9wIGhvd2V2ZXIuCgkvLyBBIGNvbmNsdWRpbmcgJ2NlbGxPdXQnIGV2ZW50IHdpbGwgTk9UIGJlIHRyaWdnZXJlZC4KCXN0b3BEcmFnOiBmdW5jdGlvbihldikgewoJCWlmICh0aGlzLmlzRHJhZ2dpbmcpIHsKCQkJdGhpcy5zdG9wU2Nyb2xsaW5nKCk7CgkJCXRoaXMudHJpZ2dlcignZHJhZ1N0b3AnLCBldik7CgkJCXRoaXMuaXNEcmFnZ2luZyA9IGZhbHNlOwoJCX0KCX0sCgoKCS8vIENhbGwgdGhpcyB0byBzdG9wIGxpc3RlbmluZyB0byB0aGUgdXNlcidzIG1vdXNlIGV2ZW50cwoJc3RvcExpc3RlbmluZzogZnVuY3Rpb24oZXYpIHsKCQlpZiAodGhpcy5pc0xpc3RlbmluZykgewoKCQkJLy8gcmVtb3ZlIHRoZSBzY3JvbGwgaGFuZGxlciBpZiB0aGVyZSBpcyBhIHNjcm9sbEVsCgkJCWlmICh0aGlzLnNjcm9sbEVsKSB7CgkJCQl0aGlzLnNjcm9sbEVsLm9mZignc2Nyb2xsJywgdGhpcy5zY3JvbGxIYW5kbGVyUHJveHkpOwoJCQkJdGhpcy5zY3JvbGxIYW5kbGVyUHJveHkgPSBudWxsOwoJCQl9CgoJCQkkKGRvY3VtZW50KQoJCQkJLm9mZignbW91c2Vtb3ZlJywgdGhpcy5tb3VzZW1vdmVQcm94eSkKCQkJCS5vZmYoJ21vdXNldXAnLCB0aGlzLm1vdXNldXBQcm94eSkKCQkJCS5vZmYoJ3NlbGVjdHN0YXJ0JywgdGhpcy5wcmV2ZW50RGVmYXVsdCk7CgoJCQl0aGlzLm1vdXNlbW92ZVByb3h5ID0gbnVsbDsKCQkJdGhpcy5tb3VzZXVwUHJveHkgPSBudWxsOwoKCQkJdGhpcy5pc0xpc3RlbmluZyA9IGZhbHNlOwoJCQl0aGlzLnRyaWdnZXIoJ2xpc3RlblN0b3AnLCBldik7CgoJCQl0aGlzLm9yaWdDZWxsID0gdGhpcy5jZWxsID0gbnVsbDsKCQkJdGhpcy5jb29yZE1hcC5jbGVhcigpOwoJCX0KCX0sCgoKCS8vIEdldHMgdGhlIGNlbGwgdW5kZXJuZWF0aCB0aGUgY29vcmRpbmF0ZXMgZm9yIHRoZSBnaXZlbiBtb3VzZSBldmVudAoJZ2V0Q2VsbDogZnVuY3Rpb24oZXYpIHsKCQlyZXR1cm4gdGhpcy5jb29yZE1hcC5nZXRDZWxsKGV2LnBhZ2VYLCBldi5wYWdlWSk7Cgl9LAoKCgkvLyBUcmlnZ2VycyBhIGNhbGxiYWNrLiBDYWxscyBhIGZ1bmN0aW9uIGluIHRoZSBvcHRpb24gaGFzaCBvZiB0aGUgc2FtZSBuYW1lLgoJLy8gQXJndW1lbnRzIGJleW9uZCB0aGUgZmlyc3QgYG5hbWVgIGFyZSBmb3J3YXJkZWQgb24uCgl0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CgkJaWYgKHRoaXMub3B0aW9uc1tuYW1lXSkgewoJCQl0aGlzLm9wdGlvbnNbbmFtZV0uYXBwbHkodGhpcywgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkJfQoJfSwKCgoJLy8gU3RvcHMgYSBnaXZlbiBtb3VzZSBldmVudCBmcm9tIGRvaW5nIGl0J3MgbmF0aXZlIGJyb3dzZXIgYWN0aW9uLiBJbiBvdXIgY2FzZSwgdGV4dCBzZWxlY3Rpb24uCglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oZXYpIHsKCQlldi5wcmV2ZW50RGVmYXVsdCgpOwoJfSwKCgoJLyogU2Nyb2xsaW5nCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBDb21wdXRlcyBhbmQgc3RvcmVzIHRoZSBib3VuZGluZyByZWN0YW5nbGUgb2Ygc2Nyb2xsRWwKCWNvbXB1dGVTY3JvbGxCb3VuZHM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuc2Nyb2xsRWw7CgkJdmFyIG9mZnNldDsKCgkJaWYgKGVsKSB7CgkJCW9mZnNldCA9IGVsLm9mZnNldCgpOwoJCQl0aGlzLnNjcm9sbEJvdW5kcyA9IHsKCQkJCXRvcDogb2Zmc2V0LnRvcCwKCQkJCWxlZnQ6IG9mZnNldC5sZWZ0LAoJCQkJYm90dG9tOiBvZmZzZXQudG9wICsgZWwub3V0ZXJIZWlnaHQoKSwKCQkJCXJpZ2h0OiBvZmZzZXQubGVmdCArIGVsLm91dGVyV2lkdGgoKQoJCQl9OwoJCX0KCX0sCgoKCS8vIENhbGxlZCB3aGVuIHRoZSBkcmFnZ2luZyBpcyBpbiBwcm9ncmVzcyBhbmQgc2Nyb2xsaW5nIHNob3VsZCBiZSB1cGRhdGVkCglkcmFnU2Nyb2xsOiBmdW5jdGlvbihldikgewoJCXZhciBzZW5zaXRpdml0eSA9IHRoaXMuc2Nyb2xsU2Vuc2l0aXZpdHk7CgkJdmFyIGJvdW5kcyA9IHRoaXMuc2Nyb2xsQm91bmRzOwoJCXZhciB0b3BDbG9zZW5lc3MsIGJvdHRvbUNsb3NlbmVzczsKCQl2YXIgbGVmdENsb3NlbmVzcywgcmlnaHRDbG9zZW5lc3M7CgkJdmFyIHRvcFZlbCA9IDA7CgkJdmFyIGxlZnRWZWwgPSAwOwoKCQlpZiAoYm91bmRzKSB7IC8vIG9ubHkgc2Nyb2xsIGlmIHNjcm9sbEVsIGV4aXN0cwoKCQkJLy8gY29tcHV0ZSBjbG9zZW5lc3MgdG8gZWRnZXMuIHZhbGlkIHJhbmdlIGlzIGZyb20gMC4wIC0gMS4wCgkJCXRvcENsb3NlbmVzcyA9IChzZW5zaXRpdml0eSAtIChldi5wYWdlWSAtIGJvdW5kcy50b3ApKSAvIHNlbnNpdGl2aXR5OwoJCQlib3R0b21DbG9zZW5lc3MgPSAoc2Vuc2l0aXZpdHkgLSAoYm91bmRzLmJvdHRvbSAtIGV2LnBhZ2VZKSkgLyBzZW5zaXRpdml0eTsKCQkJbGVmdENsb3NlbmVzcyA9IChzZW5zaXRpdml0eSAtIChldi5wYWdlWCAtIGJvdW5kcy5sZWZ0KSkgLyBzZW5zaXRpdml0eTsKCQkJcmlnaHRDbG9zZW5lc3MgPSAoc2Vuc2l0aXZpdHkgLSAoYm91bmRzLnJpZ2h0IC0gZXYucGFnZVgpKSAvIHNlbnNpdGl2aXR5OwoKCQkJLy8gdHJhbnNsYXRlIHZlcnRpY2FsIGNsb3NlbmVzcyBpbnRvIHZlbG9jaXR5LgoJCQkvLyBtb3VzZSBtdXN0IGJlIGNvbXBsZXRlbHkgaW4gYm91bmRzIGZvciB2ZWxvY2l0eSB0byBoYXBwZW4uCgkJCWlmICh0b3BDbG9zZW5lc3MgPj0gMCAmJiB0b3BDbG9zZW5lc3MgPD0gMSkgewoJCQkJdG9wVmVsID0gdG9wQ2xvc2VuZXNzICogdGhpcy5zY3JvbGxTcGVlZCAqIC0xOyAvLyBuZWdhdGl2ZS4gZm9yIHNjcm9sbGluZyB1cAoJCQl9CgkJCWVsc2UgaWYgKGJvdHRvbUNsb3NlbmVzcyA+PSAwICYmIGJvdHRvbUNsb3NlbmVzcyA8PSAxKSB7CgkJCQl0b3BWZWwgPSBib3R0b21DbG9zZW5lc3MgKiB0aGlzLnNjcm9sbFNwZWVkOwoJCQl9CgoJCQkvLyB0cmFuc2xhdGUgaG9yaXpvbnRhbCBjbG9zZW5lc3MgaW50byB2ZWxvY2l0eQoJCQlpZiAobGVmdENsb3NlbmVzcyA+PSAwICYmIGxlZnRDbG9zZW5lc3MgPD0gMSkgewoJCQkJbGVmdFZlbCA9IGxlZnRDbG9zZW5lc3MgKiB0aGlzLnNjcm9sbFNwZWVkICogLTE7IC8vIG5lZ2F0aXZlLiBmb3Igc2Nyb2xsaW5nIGxlZnQKCQkJfQoJCQllbHNlIGlmIChyaWdodENsb3NlbmVzcyA+PSAwICYmIHJpZ2h0Q2xvc2VuZXNzIDw9IDEpIHsKCQkJCWxlZnRWZWwgPSByaWdodENsb3NlbmVzcyAqIHRoaXMuc2Nyb2xsU3BlZWQ7CgkJCX0KCQl9CgoJCXRoaXMuc2V0U2Nyb2xsVmVsKHRvcFZlbCwgbGVmdFZlbCk7Cgl9LAoKCgkvLyBTZXRzIHRoZSBzcGVlZC1vZi1zY3JvbGxpbmcgZm9yIHRoZSBzY3JvbGxFbAoJc2V0U2Nyb2xsVmVsOiBmdW5jdGlvbih0b3BWZWwsIGxlZnRWZWwpIHsKCgkJdGhpcy5zY3JvbGxUb3BWZWwgPSB0b3BWZWw7CgkJdGhpcy5zY3JvbGxMZWZ0VmVsID0gbGVmdFZlbDsKCgkJdGhpcy5jb25zdHJhaW5TY3JvbGxWZWwoKTsgLy8gbWFzc2FnZXMgaW50byByZWFsaXN0aWMgdmFsdWVzCgoJCS8vIGlmIHRoZXJlIGlzIG5vbi16ZXJvIHZlbG9jaXR5LCBhbmQgYW4gYW5pbWF0aW9uIGxvb3AgaGFzbid0IGFscmVhZHkgc3RhcnRlZCwgdGhlbiBTVEFSVAoJCWlmICgodGhpcy5zY3JvbGxUb3BWZWwgfHwgdGhpcy5zY3JvbGxMZWZ0VmVsKSAmJiAhdGhpcy5zY3JvbGxJbnRlcnZhbElkKSB7CgkJCXRoaXMuc2Nyb2xsSW50ZXJ2YWxJZCA9IHNldEludGVydmFsKAoJCQkJJC5wcm94eSh0aGlzLCAnc2Nyb2xsSW50ZXJ2YWxGdW5jJyksIC8vIHNjb3BlIHRvIGB0aGlzYAoJCQkJdGhpcy5zY3JvbGxJbnRlcnZhbE1zCgkJCSk7CgkJfQoJfSwKCgoJLy8gRm9yY2VzIHNjcm9sbFRvcFZlbCBhbmQgc2Nyb2xsTGVmdFZlbCB0byBiZSB6ZXJvIGlmIHNjcm9sbGluZyBoYXMgYWxyZWFkeSBnb25lIGFsbCB0aGUgd2F5Cgljb25zdHJhaW5TY3JvbGxWZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuc2Nyb2xsRWw7CgoJCWlmICh0aGlzLnNjcm9sbFRvcFZlbCA8IDApIHsgLy8gc2Nyb2xsaW5nIHVwPwoJCQlpZiAoZWwuc2Nyb2xsVG9wKCkgPD0gMCkgeyAvLyBhbHJlYWR5IHNjcm9sbGVkIGFsbCB0aGUgd2F5IHVwPwoJCQkJdGhpcy5zY3JvbGxUb3BWZWwgPSAwOwoJCQl9CgkJfQoJCWVsc2UgaWYgKHRoaXMuc2Nyb2xsVG9wVmVsID4gMCkgeyAvLyBzY3JvbGxpbmcgZG93bj8KCQkJaWYgKGVsLnNjcm9sbFRvcCgpICsgZWxbMF0uY2xpZW50SGVpZ2h0ID49IGVsWzBdLnNjcm9sbEhlaWdodCkgeyAvLyBhbHJlYWR5IHNjcm9sbGVkIGFsbCB0aGUgd2F5IGRvd24\/CgkJCQl0aGlzLnNjcm9sbFRvcFZlbCA9IDA7CgkJCX0KCQl9CgoJCWlmICh0aGlzLnNjcm9sbExlZnRWZWwgPCAwKSB7IC8vIHNjcm9sbGluZyBsZWZ0PwoJCQlpZiAoZWwuc2Nyb2xsTGVmdCgpIDw9IDApIHsgLy8gYWxyZWFkeSBzY3JvbGxlZCBhbGwgdGhlIGxlZnQ\/CgkJCQl0aGlzLnNjcm9sbExlZnRWZWwgPSAwOwoJCQl9CgkJfQoJCWVsc2UgaWYgKHRoaXMuc2Nyb2xsTGVmdFZlbCA+IDApIHsgLy8gc2Nyb2xsaW5nIHJpZ2h0PwoJCQlpZiAoZWwuc2Nyb2xsTGVmdCgpICsgZWxbMF0uY2xpZW50V2lkdGggPj0gZWxbMF0uc2Nyb2xsV2lkdGgpIHsgLy8gYWxyZWFkeSBzY3JvbGxlZCBhbGwgdGhlIHdheSByaWdodD8KCQkJCXRoaXMuc2Nyb2xsTGVmdFZlbCA9IDA7CgkJCX0KCQl9Cgl9LAoKCgkvLyBUaGlzIGZ1bmN0aW9uIGdldHMgY2FsbGVkIGR1cmluZyBldmVyeSBpdGVyYXRpb24gb2YgdGhlIHNjcm9sbGluZyBhbmltYXRpb24gbG9vcAoJc2Nyb2xsSW50ZXJ2YWxGdW5jOiBmdW5jdGlvbigpIHsKCQl2YXIgZWwgPSB0aGlzLnNjcm9sbEVsOwoJCXZhciBmcmFjID0gdGhpcy5zY3JvbGxJbnRlcnZhbE1zIC8gMTAwMDsgLy8gY29uc2lkZXJpbmcgYW5pbWF0aW9uIGZyZXF1ZW5jeSwgd2hhdCB0aGUgdmVsIHNob3VsZCBiZSBtdWx0J2QgYnkKCgkJLy8gY2hhbmdlIHRoZSB2YWx1ZSBvZiBzY3JvbGxFbCdzIHNjcm9sbAoJCWlmICh0aGlzLnNjcm9sbFRvcFZlbCkgewoJCQllbC5zY3JvbGxUb3AoZWwuc2Nyb2xsVG9wKCkgKyB0aGlzLnNjcm9sbFRvcFZlbCAqIGZyYWMpOwoJCX0KCQlpZiAodGhpcy5zY3JvbGxMZWZ0VmVsKSB7CgkJCWVsLnNjcm9sbExlZnQoZWwuc2Nyb2xsTGVmdCgpICsgdGhpcy5zY3JvbGxMZWZ0VmVsICogZnJhYyk7CgkJfQoKCQl0aGlzLmNvbnN0cmFpblNjcm9sbFZlbCgpOyAvLyBzaW5jZSB0aGUgc2Nyb2xsIHZhbHVlcyBjaGFuZ2VkLCByZWNvbXB1dGUgdGhlIHZlbG9jaXRpZXMKCgkJLy8gaWYgc2Nyb2xsZWQgYWxsIHRoZSB3YXksIHdoaWNoIGNhdXNlcyB0aGUgdmVscyB0byBiZSB6ZXJvLCBzdG9wIHRoZSBhbmltYXRpb24gbG9vcAoJCWlmICghdGhpcy5zY3JvbGxUb3BWZWwgJiYgIXRoaXMuc2Nyb2xsTGVmdFZlbCkgewoJCQl0aGlzLnN0b3BTY3JvbGxpbmcoKTsKCQl9Cgl9LAoKCgkvLyBLaWxscyBhbnkgZXhpc3Rpbmcgc2Nyb2xsaW5nIGFuaW1hdGlvbiBsb29wCglzdG9wU2Nyb2xsaW5nOiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5zY3JvbGxJbnRlcnZhbElkKSB7CgkJCWNsZWFySW50ZXJ2YWwodGhpcy5zY3JvbGxJbnRlcnZhbElkKTsKCQkJdGhpcy5zY3JvbGxJbnRlcnZhbElkID0gbnVsbDsKCgkJCS8vIHdoZW4gYWxsIGRvbmUgd2l0aCBzY3JvbGxpbmcsIHJlY29tcHV0ZSBwb3NpdGlvbnMgc2luY2UgdGhleSBwcm9iYWJseSBjaGFuZ2VkCgkJCXRoaXMuY29tcHV0ZUNvb3JkcygpOwoJCX0KCX0sCgoKCS8vIEdldCBjYWxsZWQgd2hlbiB0aGUgc2Nyb2xsRWwgaXMgc2Nyb2xsZWQgKE5PVEU6IHRoaXMgaXMgZGVsYXllZCB2aWEgZGVib3VuY2UpCglzY3JvbGxIYW5kbGVyOiBmdW5jdGlvbigpIHsKCQkvLyByZWNvbXB1dGUgYWxsIGNvb3JkaW5hdGVzLCBidXQgKm9ubHkqIGlmIHRoaXMgaXMgKm5vdCogcGFydCBvZiBvdXIgc2Nyb2xsaW5nIGFuaW1hdGlvbgoJCWlmICghdGhpcy5zY3JvbGxJbnRlcnZhbElkKSB7CgkJCXRoaXMuY29tcHV0ZUNvb3JkcygpOwoJCX0KCX0KCn0pOwoKCi8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBjZWxscyBhcmUgaWRlbnRpY2FsbHkgZXF1YWwuIGBmYWxzZWAgb3RoZXJ3aXNlLgovLyBUaGV5IG11c3QgaGF2ZSB0aGUgc2FtZSByb3csIGNvbCwgYW5kIGJlIGZyb20gdGhlIHNhbWUgZ3JpZC4KLy8gVHdvIG51bGwgdmFsdWVzIHdpbGwgYmUgY29uc2lkZXJlZCBlcXVhbCwgYXMgdHdvICJvdXQgb2YgdGhlIGdyaWQiIHN0YXRlcyBhcmUgdGhlIHNhbWUuCmZ1bmN0aW9uIGlzQ2VsbHNFcXVhbChjZWxsMSwgY2VsbDIpIHsKCglpZiAoIWNlbGwxICYmICFjZWxsMikgewoJCXJldHVybiB0cnVlOwoJfQoKCWlmIChjZWxsMSAmJiBjZWxsMikgewoJCXJldHVybiBjZWxsMS5ncmlkID09PSBjZWxsMi5ncmlkICYmCgkJCWNlbGwxLnJvdyA9PT0gY2VsbDIucm93ICYmCgkJCWNlbGwxLmNvbCA9PT0gY2VsbDIuY29sOwoJfQoKCXJldHVybiBmYWxzZTsKfQoKOzsKCi8qIENyZWF0ZXMgYSBjbG9uZSBvZiBhbiBlbGVtZW50IGFuZCBsZXRzIGl0IHRyYWNrIHRoZSBtb3VzZSBhcyBpdCBtb3ZlcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCnZhciBNb3VzZUZvbGxvd2VyID0gQ2xhc3MuZXh0ZW5kKHsKCglvcHRpb25zOiBudWxsLAoKCXNvdXJjZUVsOiBudWxsLCAvLyB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgY2xvbmVkIGFuZCBtYWRlIHRvIGxvb2sgbGlrZSBpdCBpcyBkcmFnZ2luZwoJZWw6IG51bGwsIC8vIHRoZSBjbG9uZSBvZiBgc291cmNlRWxgIHRoYXQgd2lsbCB0cmFjayB0aGUgbW91c2UKCXBhcmVudEVsOiBudWxsLCAvLyB0aGUgZWxlbWVudCB0aGF0IGBlbGAgKHRoZSBjbG9uZSkgd2lsbCBiZSBhdHRhY2hlZCB0bwoKCS8vIHRoZSBpbml0aWFsIHBvc2l0aW9uIG9mIGVsLCByZWxhdGl2ZSB0byB0aGUgb2Zmc2V0IHBhcmVudC4gbWFkZSB0byBtYXRjaCB0aGUgaW5pdGlhbCBvZmZzZXQgb2Ygc291cmNlRWwKCXRvcDA6IG51bGwsCglsZWZ0MDogbnVsbCwKCgkvLyB0aGUgaW5pdGlhbCBwb3NpdGlvbiBvZiB0aGUgbW91c2UKCW1vdXNlWTA6IG51bGwsCgltb3VzZVgwOiBudWxsLAoKCS8vIHRoZSBudW1iZXIgb2YgcGl4ZWxzIHRoZSBtb3VzZSBoYXMgbW92ZWQgZnJvbSBpdHMgaW5pdGlhbCBwb3NpdGlvbgoJdG9wRGVsdGE6IG51bGwsCglsZWZ0RGVsdGE6IG51bGwsCgoJbW91c2Vtb3ZlUHJveHk6IG51bGwsIC8vIGRvY3VtZW50IG1vdXNlbW92ZSBoYW5kbGVyLCBib3VuZCB0byB0aGUgTW91c2VGb2xsb3dlcidzIGB0aGlzYAoKCWlzRm9sbG93aW5nOiBmYWxzZSwKCWlzSGlkZGVuOiBmYWxzZSwKCWlzQW5pbWF0aW5nOiBmYWxzZSwgLy8gZG9pbmcgdGhlIHJldmVydCBhbmltYXRpb24\/CgoJY29uc3RydWN0b3I6IGZ1bmN0aW9uKHNvdXJjZUVsLCBvcHRpb25zKSB7CgkJdGhpcy5vcHRpb25zID0gb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJdGhpcy5zb3VyY2VFbCA9IHNvdXJjZUVsOwoJCXRoaXMucGFyZW50RWwgPSBvcHRpb25zLnBhcmVudEVsID8gJChvcHRpb25zLnBhcmVudEVsKSA6IHNvdXJjZUVsLnBhcmVudCgpOyAvLyBkZWZhdWx0IHRvIHNvdXJjZUVsJ3MgcGFyZW50Cgl9LAoKCgkvLyBDYXVzZXMgdGhlIGVsZW1lbnQgdG8gc3RhcnQgZm9sbG93aW5nIHRoZSBtb3VzZQoJc3RhcnQ6IGZ1bmN0aW9uKGV2KSB7CgkJaWYgKCF0aGlzLmlzRm9sbG93aW5nKSB7CgkJCXRoaXMuaXNGb2xsb3dpbmcgPSB0cnVlOwoKCQkJdGhpcy5tb3VzZVkwID0gZXYucGFnZVk7CgkJCXRoaXMubW91c2VYMCA9IGV2LnBhZ2VYOwoJCQl0aGlzLnRvcERlbHRhID0gMDsKCQkJdGhpcy5sZWZ0RGVsdGEgPSAwOwoKCQkJaWYgKCF0aGlzLmlzSGlkZGVuKSB7CgkJCQl0aGlzLnVwZGF0ZVBvc2l0aW9uKCk7CgkJCX0KCgkJCSQoZG9jdW1lbnQpLm9uKCdtb3VzZW1vdmUnLCB0aGlzLm1vdXNlbW92ZVByb3h5ID0gJC5wcm94eSh0aGlzLCAnbW91c2Vtb3ZlJykpOwoJCX0KCX0sCgoKCS8vIENhdXNlcyB0aGUgZWxlbWVudCB0byBzdG9wIGZvbGxvd2luZyB0aGUgbW91c2UuIElmIHNob3VsZFJldmVydCBpcyB0cnVlLCB3aWxsIGFuaW1hdGUgYmFjayB0byBvcmlnaW5hbCBwb3NpdGlvbi4KCS8vIGBjYWxsYmFja2AgZ2V0cyBpbnZva2VkIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZS4gSWYgbm8gYW5pbWF0aW9uLCBpdCBpcyBpbnZva2VkIGltbWVkaWF0ZWx5LgoJc3RvcDogZnVuY3Rpb24oc2hvdWxkUmV2ZXJ0LCBjYWxsYmFjaykgewoJCXZhciBfdGhpcyA9IHRoaXM7CgkJdmFyIHJldmVydER1cmF0aW9uID0gdGhpcy5vcHRpb25zLnJldmVydER1cmF0aW9uOwoKCQlmdW5jdGlvbiBjb21wbGV0ZSgpIHsKCQkJdGhpcy5pc0FuaW1hdGluZyA9IGZhbHNlOwoJCQlfdGhpcy5kZXN0cm95RWwoKTsKCgkJCXRoaXMudG9wMCA9IHRoaXMubGVmdDAgPSBudWxsOyAvLyByZXNldCBzdGF0ZSBmb3IgZnV0dXJlIHVwZGF0ZVBvc2l0aW9uIGNhbGxzCgoJCQlpZiAoY2FsbGJhY2spIHsKCQkJCWNhbGxiYWNrKCk7CgkJCX0KCQl9CgoJCWlmICh0aGlzLmlzRm9sbG93aW5nICYmICF0aGlzLmlzQW5pbWF0aW5nKSB7IC8vIGRpc2FsbG93IG1vcmUgdGhhbiBvbmUgc3RvcCBhbmltYXRpb24gYXQgYSB0aW1lCgkJCXRoaXMuaXNGb2xsb3dpbmcgPSBmYWxzZTsKCgkJCSQoZG9jdW1lbnQpLm9mZignbW91c2Vtb3ZlJywgdGhpcy5tb3VzZW1vdmVQcm94eSk7CgoJCQlpZiAoc2hvdWxkUmV2ZXJ0ICYmIHJldmVydER1cmF0aW9uICYmICF0aGlzLmlzSGlkZGVuKSB7IC8vIGRvIGEgcmV2ZXJ0IGFuaW1hdGlvbj8KCQkJCXRoaXMuaXNBbmltYXRpbmcgPSB0cnVlOwoJCQkJdGhpcy5lbC5hbmltYXRlKHsKCQkJCQl0b3A6IHRoaXMudG9wMCwKCQkJCQlsZWZ0OiB0aGlzLmxlZnQwCgkJCQl9LCB7CgkJCQkJZHVyYXRpb246IHJldmVydER1cmF0aW9uLAoJCQkJCWNvbXBsZXRlOiBjb21wbGV0ZQoJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoJfSwKCgoJLy8gR2V0cyB0aGUgdHJhY2tpbmcgZWxlbWVudC4gQ3JlYXRlIGl0IGlmIG5lY2Vzc2FyeQoJZ2V0RWw6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWw7CgoJCWlmICghZWwpIHsKCQkJdGhpcy5zb3VyY2VFbC53aWR0aCgpOyAvLyBoYWNrIHRvIGZvcmNlIElFOCB0byBjb21wdXRlIGNvcnJlY3QgYm91bmRpbmcgYm94CgkJCWVsID0gdGhpcy5lbCA9IHRoaXMuc291cmNlRWwuY2xvbmUoKQoJCQkJLmNzcyh7CgkJCQkJcG9zaXRpb246ICdhYnNvbHV0ZScsCgkJCQkJdmlzaWJpbGl0eTogJycsIC8vIGluIGNhc2Ugb3JpZ2luYWwgZWxlbWVudCB3YXMgaGlkZGVuIChjb21tb25seSB0aHJvdWdoIGhpZGVFdmVudHMoKSkKCQkJCQlkaXNwbGF5OiB0aGlzLmlzSGlkZGVuID8gJ25vbmUnIDogJycsIC8vIGZvciB3aGVuIGluaXRpYWxseSBoaWRkZW4KCQkJCQltYXJnaW46IDAsCgkJCQkJcmlnaHQ6ICdhdXRvJywgLy8gZXJhc2UgYW5kIHNldCB3aWR0aCBpbnN0ZWFkCgkJCQkJYm90dG9tOiAnYXV0bycsIC8vIGVyYXNlIGFuZCBzZXQgaGVpZ2h0IGluc3RlYWQKCQkJCQl3aWR0aDogdGhpcy5zb3VyY2VFbC53aWR0aCgpLCAvLyBleHBsaWNpdCBoZWlnaHQgaW4gY2FzZSB0aGVyZSB3YXMgYSAncmlnaHQnIHZhbHVlCgkJCQkJaGVpZ2h0OiB0aGlzLnNvdXJjZUVsLmhlaWdodCgpLCAvLyBleHBsaWNpdCB3aWR0aCBpbiBjYXNlIHRoZXJlIHdhcyBhICdib3R0b20nIHZhbHVlCgkJCQkJb3BhY2l0eTogdGhpcy5vcHRpb25zLm9wYWNpdHkgfHwgJycsCgkJCQkJekluZGV4OiB0aGlzLm9wdGlvbnMuekluZGV4CgkJCQl9KQoJCQkJLmFwcGVuZFRvKHRoaXMucGFyZW50RWwpOwoJCX0KCgkJcmV0dXJuIGVsOwoJfSwKCgoJLy8gUmVtb3ZlcyB0aGUgdHJhY2tpbmcgZWxlbWVudCBpZiBpdCBoYXMgYWxyZWFkeSBiZWVuIGNyZWF0ZWQKCWRlc3Ryb3lFbDogZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMuZWwpIHsKCQkJdGhpcy5lbC5yZW1vdmUoKTsKCQkJdGhpcy5lbCA9IG51bGw7CgkJfQoJfSwKCgoJLy8gVXBkYXRlIHRoZSBDU1MgcG9zaXRpb24gb2YgdGhlIHRyYWNraW5nIGVsZW1lbnQKCXVwZGF0ZVBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgc291cmNlT2Zmc2V0OwoJCXZhciBvcmlnaW47CgoJCXRoaXMuZ2V0RWwoKTsgLy8gZW5zdXJlIHRoaXMuZWwKCgkJLy8gbWFrZSBzdXJlIG9yaWdpbiBpbmZvIHdhcyBjb21wdXRlZAoJCWlmICh0aGlzLnRvcDAgPT09IG51bGwpIHsKCQkJdGhpcy5zb3VyY2VFbC53aWR0aCgpOyAvLyBoYWNrIHRvIGZvcmNlIElFOCB0byBjb21wdXRlIGNvcnJlY3QgYm91bmRpbmcgYm94CgkJCXNvdXJjZU9mZnNldCA9IHRoaXMuc291cmNlRWwub2Zmc2V0KCk7CgkJCW9yaWdpbiA9IHRoaXMuZWwub2Zmc2V0UGFyZW50KCkub2Zmc2V0KCk7CgkJCXRoaXMudG9wMCA9IHNvdXJjZU9mZnNldC50b3AgLSBvcmlnaW4udG9wOwoJCQl0aGlzLmxlZnQwID0gc291cmNlT2Zmc2V0LmxlZnQgLSBvcmlnaW4ubGVmdDsKCQl9CgoJCXRoaXMuZWwuY3NzKHsKCQkJdG9wOiB0aGlzLnRvcDAgKyB0aGlzLnRvcERlbHRhLAoJCQlsZWZ0OiB0aGlzLmxlZnQwICsgdGhpcy5sZWZ0RGVsdGEKCQl9KTsKCX0sCgoKCS8vIEdldHMgY2FsbGVkIHdoZW4gdGhlIHVzZXIgbW92ZXMgdGhlIG1vdXNlCgltb3VzZW1vdmU6IGZ1bmN0aW9uKGV2KSB7CgkJdGhpcy50b3BEZWx0YSA9IGV2LnBhZ2VZIC0gdGhpcy5tb3VzZVkwOwoJCXRoaXMubGVmdERlbHRhID0gZXYucGFnZVggLSB0aGlzLm1vdXNlWDA7CgoJCWlmICghdGhpcy5pc0hpZGRlbikgewoJCQl0aGlzLnVwZGF0ZVBvc2l0aW9uKCk7CgkJfQoJfSwKCgoJLy8gVGVtcG9yYXJpbHkgbWFrZXMgdGhlIHRyYWNraW5nIGVsZW1lbnQgaW52aXNpYmxlLiBDYW4gYmUgY2FsbGVkIGJlZm9yZSBmb2xsb3dpbmcgc3RhcnRzCgloaWRlOiBmdW5jdGlvbigpIHsKCQlpZiAoIXRoaXMuaXNIaWRkZW4pIHsKCQkJdGhpcy5pc0hpZGRlbiA9IHRydWU7CgkJCWlmICh0aGlzLmVsKSB7CgkJCQl0aGlzLmVsLmhpZGUoKTsKCQkJfQoJCX0KCX0sCgoKCS8vIFNob3cgdGhlIHRyYWNraW5nIGVsZW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gdGVtcG9yYXJpbHkgaGlkZGVuCglzaG93OiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5pc0hpZGRlbikgewoJCQl0aGlzLmlzSGlkZGVuID0gZmFsc2U7CgkJCXRoaXMudXBkYXRlUG9zaXRpb24oKTsKCQkJdGhpcy5nZXRFbCgpLnNob3coKTsKCQl9Cgl9Cgp9KTsKCjs7CgovKiBBIHV0aWxpdHkgY2xhc3MgZm9yIHJlbmRlcmluZyA8dHI+IHJvd3MuCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwovLyBJdCBsZXZlcmFnZXMgbWV0aG9kcyBvZiB0aGUgc3ViY2xhc3MgYW5kIHRoZSBWaWV3IHRvIGRldGVybWluZSBjdXN0b20gcmVuZGVyaW5nIGJlaGF2aW9yIGZvciBlYWNoIHJvdyAidHlwZSIKLy8gKHN1Y2ggYXMgaGlnaGxpZ2h0IHJvd3MsIGRheSByb3dzLCBoZWxwZXIgcm93cywgZXRjKS4KCnZhciBSb3dSZW5kZXJlciA9IENsYXNzLmV4dGVuZCh7CgoJdmlldzogbnVsbCwgLy8gYSBWaWV3IG9iamVjdAoJaXNSVEw6IG51bGwsIC8vIHNob3J0Y3V0IHRvIHRoZSB2aWV3J3MgaXNSVEwgb3B0aW9uCgljZWxsSHRtbDogJzx0ZC8+JywgLy8gcGxhaW4gZGVmYXVsdCBIVE1MIHVzZWQgZm9yIGEgY2VsbCB3aGVuIG5vIG90aGVyIGlzIGF2YWlsYWJsZQoKCgljb25zdHJ1Y3RvcjogZnVuY3Rpb24odmlldykgewoJCXRoaXMudmlldyA9IHZpZXc7CgkJdGhpcy5pc1JUTCA9IHZpZXcub3B0KCdpc1JUTCcpOwoJfSwKCgoJLy8gUmVuZGVycyB0aGUgSFRNTCBmb3IgYSByb3csIGxldmVyYWdpbmcgY3VzdG9tIGNlbGwtSFRNTC1yZW5kZXJlcnMgYmFzZWQgb24gdGhlIGByb3dUeXBlYC4KCS8vIEFsc28gYXBwbGllcyB0aGUgImludHJvIiBhbmQgIm91dHJvIiBjZWxscywgd2hpY2ggYXJlIHNwZWNpZmllZCBieSB0aGUgc3ViY2xhc3MgYW5kIHZpZXdzLgoJLy8gYHJvd2AgaXMgYW4gb3B0aW9uYWwgcm93IG51bWJlci4KCXJvd0h0bWw6IGZ1bmN0aW9uKHJvd1R5cGUsIHJvdykgewoJCXZhciByZW5kZXJDZWxsID0gdGhpcy5nZXRIdG1sUmVuZGVyZXIoJ2NlbGwnLCByb3dUeXBlKTsKCQl2YXIgcm93Q2VsbEh0bWwgPSAnJzsKCQl2YXIgY29sOwoJCXZhciBjZWxsOwoKCQlyb3cgPSByb3cgfHwgMDsKCgkJZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzLmNvbENudDsgY29sKyspIHsKCQkJY2VsbCA9IHRoaXMuZ2V0Q2VsbChyb3csIGNvbCk7CgkJCXJvd0NlbGxIdG1sICs9IHJlbmRlckNlbGwoY2VsbCk7CgkJfQoKCQlyb3dDZWxsSHRtbCA9IHRoaXMuYm9va2VuZENlbGxzKHJvd0NlbGxIdG1sLCByb3dUeXBlLCByb3cpOyAvLyBhcHBseSBpbnRybyBhbmQgb3V0cm8KCgkJcmV0dXJuICc8dHI+JyArIHJvd0NlbGxIdG1sICsgJzwvdHI+JzsKCX0sCgoKCS8vIEFwcGxpZXMgdGhlICJpbnRybyIgYW5kICJvdXRybyIgSFRNTCB0byB0aGUgZ2l2ZW4gY2VsbHMuCgkvLyBJbnRybyBtZWFucyB0aGUgbGVmdG1vc3QgY2VsbCB3aGVuIHRoZSBjYWxlbmRhciBpcyBMVFIgYW5kIHRoZSByaWdodG1vc3QgY2VsbCB3aGVuIFJUTC4gVmljZS12ZXJzYSBmb3Igb3V0cm8uCgkvLyBgY2VsbHNgIGNhbiBiZSBhbiBIVE1MIHN0cmluZyBvZiA8dGQ+J3Mgb3IgYSBqUXVlcnkgPHRyPiBlbGVtZW50CgkvLyBgcm93YCBpcyBhbiBvcHRpb25hbCByb3cgbnVtYmVyLgoJYm9va2VuZENlbGxzOiBmdW5jdGlvbihjZWxscywgcm93VHlwZSwgcm93KSB7CgkJdmFyIGludHJvID0gdGhpcy5nZXRIdG1sUmVuZGVyZXIoJ2ludHJvJywgcm93VHlwZSkocm93IHx8IDApOwoJCXZhciBvdXRybyA9IHRoaXMuZ2V0SHRtbFJlbmRlcmVyKCdvdXRybycsIHJvd1R5cGUpKHJvdyB8fCAwKTsKCQl2YXIgcHJlcGVuZEh0bWwgPSB0aGlzLmlzUlRMID8gb3V0cm8gOiBpbnRybzsKCQl2YXIgYXBwZW5kSHRtbCA9IHRoaXMuaXNSVEwgPyBpbnRybyA6IG91dHJvOwoKCQlpZiAodHlwZW9mIGNlbGxzID09PSAnc3RyaW5nJykgewoJCQlyZXR1cm4gcHJlcGVuZEh0bWwgKyBjZWxscyArIGFwcGVuZEh0bWw7CgkJfQoJCWVsc2UgeyAvLyBhIGpRdWVyeSA8dHI+IGVsZW1lbnQKCQkJcmV0dXJuIGNlbGxzLnByZXBlbmQocHJlcGVuZEh0bWwpLmFwcGVuZChhcHBlbmRIdG1sKTsKCQl9Cgl9LAoKCgkvLyBSZXR1cm5zIGFuIEhUTUwtcmVuZGVyaW5nIGZ1bmN0aW9uIGdpdmVuIGEgc3BlY2lmaWMgYHJlbmRlcmVyTmFtZWAgKGxpa2UgY2VsbCwgaW50cm8sIG9yIG91dHJvKSBhbmQgYSBzcGVjaWZpYwoJLy8gYHJvd1R5cGVgIChsaWtlIGRheSwgZXZlbnRTa2VsZXRvbiwgaGVscGVyU2tlbGV0b24pLCB3aGljaCBpcyBvcHRpb25hbC4KCS8vIElmIGEgcmVuZGVyZXIgZm9yIHRoZSBzcGVjaWZpYyByb3dUeXBlIGRvZXNuJ3QgZXhpc3QsIGl0IHdpbGwgZmFsbCBiYWNrIHRvIGEgZ2VuZXJpYyByZW5kZXJlci4KCS8vIFdlIHdpbGwgcXVlcnkgdGhlIFZpZXcgb2JqZWN0IGZpcnN0IGZvciBhbnkgY3VzdG9tIHJlbmRlcmluZyBmdW5jdGlvbnMsIHRoZW4gdGhlIG1ldGhvZHMgb2YgdGhlIHN1YmNsYXNzLgoJZ2V0SHRtbFJlbmRlcmVyOiBmdW5jdGlvbihyZW5kZXJlck5hbWUsIHJvd1R5cGUpIHsKCQl2YXIgdmlldyA9IHRoaXMudmlldzsKCQl2YXIgZ2VuZXJhbE5hbWU7IC8vIGxpa2UgImNlbGxIdG1sIgoJCXZhciBzcGVjaWZpY05hbWU7IC8vIGxpa2UgImRheUNlbGxIdG1sIi4gYmFzZWQgb24gcm93VHlwZQoJCXZhciBwcm92aWRlcjsgLy8gZWl0aGVyIHRoZSBWaWV3IG9yIHRoZSBSb3dSZW5kZXJlciBzdWJjbGFzcywgd2hpY2hldmVyIHByb3ZpZGVkIHRoZSBtZXRob2QKCQl2YXIgcmVuZGVyZXI7CgoJCWdlbmVyYWxOYW1lID0gcmVuZGVyZXJOYW1lICsgJ0h0bWwnOwoJCWlmIChyb3dUeXBlKSB7CgkJCXNwZWNpZmljTmFtZSA9IHJvd1R5cGUgKyBjYXBpdGFsaXNlRmlyc3RMZXR0ZXIocmVuZGVyZXJOYW1lKSArICdIdG1sJzsKCQl9CgoJCWlmIChzcGVjaWZpY05hbWUgJiYgKHJlbmRlcmVyID0gdmlld1tzcGVjaWZpY05hbWVdKSkgewoJCQlwcm92aWRlciA9IHZpZXc7CgkJfQoJCWVsc2UgaWYgKHNwZWNpZmljTmFtZSAmJiAocmVuZGVyZXIgPSB0aGlzW3NwZWNpZmljTmFtZV0pKSB7CgkJCXByb3ZpZGVyID0gdGhpczsKCQl9CgkJZWxzZSBpZiAoKHJlbmRlcmVyID0gdmlld1tnZW5lcmFsTmFtZV0pKSB7CgkJCXByb3ZpZGVyID0gdmlldzsKCQl9CgkJZWxzZSBpZiAoKHJlbmRlcmVyID0gdGhpc1tnZW5lcmFsTmFtZV0pKSB7CgkJCXByb3ZpZGVyID0gdGhpczsKCQl9CgoJCWlmICh0eXBlb2YgcmVuZGVyZXIgPT09ICdmdW5jdGlvbicpIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHJlbmRlcmVyLmFwcGx5KHByb3ZpZGVyLCBhcmd1bWVudHMpIHx8ICcnOyAvLyB1c2UgY29ycmVjdCBgdGhpc2AgYW5kIGFsd2F5cyByZXR1cm4gYSBzdHJpbmcKCQkJfTsKCQl9CgoJCS8vIHRoZSByZW5kZXJlZCBjYW4gYmUgYSBwbGFpbiBzdHJpbmcgYXMgd2VsbC4gaWYgbm90IHNwZWNpZmllZCwgYWx3YXlzIGFuIGVtcHR5IHN0cmluZy4KCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCXJldHVybiByZW5kZXJlciB8fCAnJzsKCQl9OwoJfQoKfSk7Cgo7OwoKLyogQW4gYWJzdHJhY3QgY2xhc3MgY29tcHJpc2VkIG9mIGEgImdyaWQiIG9mIGNlbGxzIHRoYXQgZWFjaCByZXByZXNlbnQgYSBzcGVjaWZpYyBkYXRldGltZQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCnZhciBHcmlkID0gZmMuR3JpZCA9IFJvd1JlbmRlcmVyLmV4dGVuZCh7CgoJc3RhcnQ6IG51bGwsIC8vIHRoZSBkYXRlIG9mIHRoZSBmaXJzdCBjZWxsCgllbmQ6IG51bGwsIC8vIHRoZSBkYXRlIGFmdGVyIHRoZSBsYXN0IGNlbGwKCglyb3dDbnQ6IDAsIC8vIG51bWJlciBvZiByb3dzCgljb2xDbnQ6IDAsIC8vIG51bWJlciBvZiBjb2xzCglyb3dEYXRhOiBudWxsLCAvLyBhcnJheSBvZiBvYmplY3RzLCBob2xkaW5nIG1pc2MgZGF0YSBmb3IgZWFjaCByb3cKCWNvbERhdGE6IG51bGwsIC8vIGFycmF5IG9mIG9iamVjdHMsIGhvbGRpbmcgbWlzYyBkYXRhIGZvciBlYWNoIGNvbHVtbgoKCWVsOiBudWxsLCAvLyB0aGUgY29udGFpbmluZyBlbGVtZW50Cgljb29yZE1hcDogbnVsbCwgLy8gYSBHcmlkQ29vcmRNYXAgdGhhdCBjb252ZXJ0cyBwaXhlbCB2YWx1ZXMgdG8gZGF0ZXRpbWVzCgllbHNCeUZpbGw6IG51bGwsIC8vIGEgaGFzaCBvZiBqUXVlcnkgZWxlbWVudCBzZXRzIHVzZWQgZm9yIHJlbmRlcmluZyBlYWNoIGZpbGwuIEtleWVkIGJ5IGZpbGwgbmFtZS4KCglkb2N1bWVudERyYWdTdGFydFByb3h5OiBudWxsLCAvLyBiaW5kcyB0aGUgR3JpZCdzIHNjb3BlIHRvIGRvY3VtZW50RHJhZ1N0YXJ0IChpbiBEYXlHcmlkLmV2ZW50cykKCgkvLyBkZXJpdmVkIGZyb20gb3B0aW9ucwoJY29sSGVhZEZvcm1hdDogbnVsbCwgLy8gVE9ETzogbW92ZSB0byBhbm90aGVyIGNsYXNzLiBub3QgYXBwbGljYWJsZSB0byBhbGwgR3JpZHMKCWV2ZW50VGltZUZvcm1hdDogbnVsbCwKCWRpc3BsYXlFdmVudEVuZDogbnVsbCwKCgoJY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewoJCVJvd1JlbmRlcmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIGNhbGwgdGhlIHN1cGVyLWNvbnN0cnVjdG9yCgoJCXRoaXMuY29vcmRNYXAgPSBuZXcgR3JpZENvb3JkTWFwKHRoaXMpOwoJCXRoaXMuZWxzQnlGaWxsID0ge307CgkJdGhpcy5kb2N1bWVudERyYWdTdGFydFByb3h5ID0gJC5wcm94eSh0aGlzLCAnZG9jdW1lbnREcmFnU3RhcnQnKTsKCX0sCgoKCS8vIFJlbmRlcnMgdGhlIGdyaWQgaW50byB0aGUgYGVsYCBlbGVtZW50LgoJLy8gU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgYW5kIGNhbGwgdGhpcyBzdXBlci1tZXRob2Qgd2hlbiBkb25lLgoJcmVuZGVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLmJpbmRIYW5kbGVycygpOwoJfSwKCgoJLy8gQ2FsbGVkIHdoZW4gdGhlIGdyaWQncyByZXNvdXJjZXMgbmVlZCB0byBiZSBjbGVhbmVkIHVwCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLnVuYmluZEhhbmRsZXJzKCk7Cgl9LAoKCgkvKiBPcHRpb25zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBHZW5lcmF0ZXMgdGhlIGZvcm1hdCBzdHJpbmcgdXNlZCBmb3IgdGhlIHRleHQgaW4gY29sdW1uIGhlYWRlcnMsIGlmIG5vdCBleHBsaWNpdGx5IGRlZmluZWQgYnkgJ2NvbHVtbkZvcm1hdCcKCS8vIFRPRE86IG1vdmUgdG8gYW5vdGhlciBjbGFzcy4gbm90IGFwcGxpY2FibGUgdG8gYWxsIEdyaWRzCgljb21wdXRlQ29sSGVhZEZvcm1hdDogZnVuY3Rpb24oKSB7CgkJLy8gc3ViY2xhc3NlcyBtdXN0IGltcGxlbWVudCBpZiB0aGV5IHdhbnQgdG8gdXNlIGhlYWRIdG1sKCkKCX0sCgoKCS8vIEdlbmVyYXRlcyB0aGUgZm9ybWF0IHN0cmluZyB1c2VkIGZvciBldmVudCB0aW1lIHRleHQsIGlmIG5vdCBleHBsaWNpdGx5IGRlZmluZWQgYnkgJ3RpbWVGb3JtYXQnCgljb21wdXRlRXZlbnRUaW1lRm9ybWF0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy52aWV3Lm9wdCgnc21hbGxUaW1lRm9ybWF0Jyk7Cgl9LAoKCgkvLyBEZXRlcm1pbmVzIHdoZXRoZXIgZXZlbnRzIHNob3VsZCBoYXZlIHRoZWlyIGVuZCB0aW1lcyBkaXNwbGF5ZWQsIGlmIG5vdCBleHBsaWNpdGx5IGRlZmluZWQgYnkgJ2Rpc3BsYXlFdmVudEVuZCcKCWNvbXB1dGVEaXNwbGF5RXZlbnRFbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0sCgoKCS8qIERhdGVzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBUZWxscyB0aGUgZ3JpZCBhYm91dCB3aGF0IHBlcmlvZCBvZiB0aW1lIHRvIGRpc3BsYXkuIEdyaWQgd2lsbCBzdWJzZXF1ZW50bHkgY29tcHV0ZSBkYXRlcyBmb3IgY2VsbCBzeXN0ZW0uCglzZXRSYW5nZTogZnVuY3Rpb24ocmFuZ2UpIHsKCQl2YXIgdmlldyA9IHRoaXMudmlldzsKCgkJdGhpcy5zdGFydCA9IHJhbmdlLnN0YXJ0LmNsb25lKCk7CgkJdGhpcy5lbmQgPSByYW5nZS5lbmQuY2xvbmUoKTsKCgkJdGhpcy5yb3dEYXRhID0gW107CgkJdGhpcy5jb2xEYXRhID0gW107CgkJdGhpcy51cGRhdGVDZWxscygpOwoKCQkvLyBQb3B1bGF0ZSBvcHRpb24tZGVyaXZlZCBzZXR0aW5ncy4gTG9vayBmb3Igb3ZlcnJpZGUgZmlyc3QsIHRoZW4gY29tcHV0ZSBpZiBuZWNlc3NhcnkuCgkJdGhpcy5jb2xIZWFkRm9ybWF0ID0gdmlldy5vcHQoJ2NvbHVtbkZvcm1hdCcpIHx8IHRoaXMuY29tcHV0ZUNvbEhlYWRGb3JtYXQoKTsKCQl0aGlzLmV2ZW50VGltZUZvcm1hdCA9IHZpZXcub3B0KCd0aW1lRm9ybWF0JykgfHwgdGhpcy5jb21wdXRlRXZlbnRUaW1lRm9ybWF0KCk7CgkJdGhpcy5kaXNwbGF5RXZlbnRFbmQgPSB2aWV3Lm9wdCgnZGlzcGxheUV2ZW50RW5kJyk7CgkJaWYgKHRoaXMuZGlzcGxheUV2ZW50RW5kID09IG51bGwpIHsKCQkJdGhpcy5kaXNwbGF5RXZlbnRFbmQgPSB0aGlzLmNvbXB1dGVEaXNwbGF5RXZlbnRFbmQoKTsKCQl9Cgl9LAoKCgkvLyBSZXNwb25zaWJsZSBmb3Igc2V0dGluZyByb3dDbnQvY29sQ250IGFuZCBhbnkgb3RoZXIgcm93L2NvbCBkYXRhCgl1cGRhdGVDZWxsczogZnVuY3Rpb24oKSB7CgkJLy8gc3ViY2xhc3NlcyBtdXN0IGltcGxlbWVudAoJfSwKCgoJLy8gQ29udmVydHMgYSByYW5nZSB3aXRoIGFuIGluY2x1c2l2ZSBgc3RhcnRgIGFuZCBhbiBleGNsdXNpdmUgYGVuZGAgaW50byBhbiBhcnJheSBvZiBzZWdtZW50IG9iamVjdHMKCXJhbmdlVG9TZWdzOiBmdW5jdGlvbihyYW5nZSkgewoJCS8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQKCX0sCgoKCS8qIENlbGxzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoJLy8gTk9URTogY29sdW1ucyBhcmUgb3JkZXJlZCBsZWZ0LXRvLXJpZ2h0CgoKCS8vIEdldHMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgcm93L2NvbCBudW1iZXIsIG1pc2MgZGF0YSwgYW5kIHJhbmdlIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjZWxsLgoJLy8gQWNjZXB0cyByb3cvY29sIHZhbHVlcywgYW4gb2JqZWN0IHdpdGggcm93L2NvbCBwcm9wZXJ0aWVzLCBvciBhIHNpbmdsZS1udW1iZXIgb2Zmc2V0IGZyb20gdGhlIGZpcnN0IGNlbGwuCglnZXRDZWxsOiBmdW5jdGlvbihyb3csIGNvbCkgewoJCXZhciBjZWxsOwoKCQlpZiAoY29sID09IG51bGwpIHsKCQkJaWYgKHR5cGVvZiByb3cgPT09ICdudW1iZXInKSB7IC8vIGEgc2luZ2xlLW51bWJlciBvZmZzZXQKCQkJCWNvbCA9IHJvdyAlIHRoaXMuY29sQ250OwoJCQkJcm93ID0gTWF0aC5mbG9vcihyb3cgLyB0aGlzLmNvbENudCk7CgkJCX0KCQkJZWxzZSB7IC8vIGFuIG9iamVjdCB3aXRoIHJvdy9jb2wgcHJvcGVydGllcwoJCQkJY29sID0gcm93LmNvbDsKCQkJCXJvdyA9IHJvdy5yb3c7CgkJCX0KCQl9CgoJCWNlbGwgPSB7IHJvdzogcm93LCBjb2w6IGNvbCB9OwoKCQkkLmV4dGVuZChjZWxsLCB0aGlzLmdldFJvd0RhdGEocm93KSwgdGhpcy5nZXRDb2xEYXRhKGNvbCkpOwoJCSQuZXh0ZW5kKGNlbGwsIHRoaXMuY29tcHV0ZUNlbGxSYW5nZShjZWxsKSk7CgoJCXJldHVybiBjZWxsOwoJfSwKCgoJLy8gR2l2ZW4gYSBjZWxsIG9iamVjdCB3aXRoIGluZGV4IGFuZCBtaXNjIGRhdGEsIGdlbmVyYXRlcyBhIHJhbmdlIG9iamVjdAoJY29tcHV0ZUNlbGxSYW5nZTogZnVuY3Rpb24oY2VsbCkgewoJCS8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQKCX0sCgoKCS8vIFJldHJpZXZlcyBtaXNjIGRhdGEgYWJvdXQgdGhlIGdpdmVuIHJvdwoJZ2V0Um93RGF0YTogZnVuY3Rpb24ocm93KSB7CgkJcmV0dXJuIHRoaXMucm93RGF0YVtyb3ddIHx8IHt9OwoJfSwKCgoJLy8gUmV0cmlldmVzIG1pc2MgZGF0YSBiYW91dCB0aGUgZ2l2ZW4gY29sdW1uCglnZXRDb2xEYXRhOiBmdW5jdGlvbihjb2wpIHsKCQlyZXR1cm4gdGhpcy5jb2xEYXRhW2NvbF0gfHwge307Cgl9LAoKCgkvLyBSZXRyaWV2ZXMgdGhlIGVsZW1lbnQgcmVwcmVzZW50aW5nIHRoZSBnaXZlbiByb3cKCWdldFJvd0VsOiBmdW5jdGlvbihyb3cpIHsKCQkvLyBzdWJjbGFzc2VzIHNob3VsZCBpbXBsZW1lbnQgaWYgbGV2ZXJhZ2luZyB0aGUgZGVmYXVsdCBnZXRDZWxsRGF5RWwoKSBvciBjb21wdXRlUm93Q29vcmRzKCkKCX0sCgoKCS8vIFJldHJpZXZlcyB0aGUgZWxlbWVudCByZXByZXNlbnRpbmcgdGhlIGdpdmVuIGNvbHVtbgoJZ2V0Q29sRWw6IGZ1bmN0aW9uKGNvbCkgewoJCS8vIHN1YmNsYXNzZXMgc2hvdWxkIGltcGxlbWVudCBpZiBsZXZlcmFnaW5nIHRoZSBkZWZhdWx0IGdldENlbGxEYXlFbCgpIG9yIGNvbXB1dGVDb2xDb29yZHMoKQoJfSwKCgoJLy8gR2l2ZW4gYSBjZWxsIG9iamVjdCwgcmV0dXJucyB0aGUgZWxlbWVudCB0aGF0IHJlcHJlc2VudHMgdGhlIGNlbGwncyB3aG9sZS1kYXkKCWdldENlbGxEYXlFbDogZnVuY3Rpb24oY2VsbCkgewoJCXJldHVybiB0aGlzLmdldENvbEVsKGNlbGwuY29sKSB8fCB0aGlzLmdldFJvd0VsKGNlbGwucm93KTsKCX0sCgoKCS8qIENlbGwgQ29vcmRpbmF0ZXMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIENvbXB1dGVzIHRoZSB0b3AvYm90dG9tIGNvb3JkaW5hdGVzIG9mIGFsbCByb3dzLgoJLy8gQnkgZGVmYXVsdCwgcXVlcmllcyB0aGUgZGltZW5zaW9ucyBvZiB0aGUgZWxlbWVudCBwcm92aWRlZCBieSBnZXRSb3dFbCgpLgoJY29tcHV0ZVJvd0Nvb3JkczogZnVuY3Rpb24oKSB7CgkJdmFyIGl0ZW1zID0gW107CgkJdmFyIGksIGVsOwoJCXZhciBpdGVtOwoKCQlmb3IgKGkgPSAwOyBpIDwgdGhpcy5yb3dDbnQ7IGkrKykgewoJCQllbCA9IHRoaXMuZ2V0Um93RWwoaSk7CgkJCWl0ZW0gPSB7CgkJCQl0b3A6IGVsLm9mZnNldCgpLnRvcAoJCQl9OwoJCQlpZiAoaSA+IDApIHsKCQkJCWl0ZW1zW2kgLSAxXS5ib3R0b20gPSBpdGVtLnRvcDsKCQkJfQoJCQlpdGVtcy5wdXNoKGl0ZW0pOwoJCX0KCQlpdGVtLmJvdHRvbSA9IGl0ZW0udG9wICsgZWwub3V0ZXJIZWlnaHQoKTsKCgkJcmV0dXJuIGl0ZW1zOwoJfSwKCgoJLy8gQ29tcHV0ZXMgdGhlIGxlZnQvcmlnaHQgY29vcmRpbmF0ZXMgb2YgYWxsIHJvd3MuCgkvLyBCeSBkZWZhdWx0LCBxdWVyaWVzIHRoZSBkaW1lbnNpb25zIG9mIHRoZSBlbGVtZW50IHByb3ZpZGVkIGJ5IGdldENvbEVsKCkuCgljb21wdXRlQ29sQ29vcmRzOiBmdW5jdGlvbigpIHsKCQl2YXIgaXRlbXMgPSBbXTsKCQl2YXIgaSwgZWw7CgkJdmFyIGl0ZW07CgoJCWZvciAoaSA9IDA7IGkgPCB0aGlzLmNvbENudDsgaSsrKSB7CgkJCWVsID0gdGhpcy5nZXRDb2xFbChpKTsKCQkJaXRlbSA9IHsKCQkJCWxlZnQ6IGVsLm9mZnNldCgpLmxlZnQKCQkJfTsKCQkJaWYgKGkgPiAwKSB7CgkJCQlpdGVtc1tpIC0gMV0ucmlnaHQgPSBpdGVtLmxlZnQ7CgkJCX0KCQkJaXRlbXMucHVzaChpdGVtKTsKCQl9CgkJaXRlbS5yaWdodCA9IGl0ZW0ubGVmdCArIGVsLm91dGVyV2lkdGgoKTsKCgkJcmV0dXJuIGl0ZW1zOwoJfSwKCgoJLyogSGFuZGxlcnMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIEF0dGFjaGVzIGhhbmRsZXJzIHRvIERPTQoJYmluZEhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgX3RoaXMgPSB0aGlzOwoKCQkvLyBhdHRhY2ggYSBoYW5kbGVyIHRvIHRoZSBncmlkJ3Mgcm9vdCBlbGVtZW50LgoJCS8vIHdlIGRvbid0IG5lZWQgdG8gY2xlYW4gdXAgaW4gdW5iaW5kSGFuZGxlcnMgb3IgZGVzdHJveSwgYmVjYXVzZSB3aGVuIGpRdWVyeSByZW1vdmVzIHRoZSBlbGVtZW50IGZyb20gdGhlCgkJLy8gRE9NIGl0IGF1dG9tYXRpY2FsbHkgdW5yZWdpc3RlcnMgdGhlIGhhbmRsZXJzLgoJCXRoaXMuZWwub24oJ21vdXNlZG93bicsIGZ1bmN0aW9uKGV2KSB7CgkJCWlmICgKCQkJCSEkKGV2LnRhcmdldCkuaXMoJy5mYy1ldmVudC1jb250YWluZXIgKiwgLmZjLW1vcmUnKSAmJiAvLyBub3QgYW4gYW4gZXZlbnQgZWxlbWVudCwgb3IgIm1vcmUuLiIgbGluawoJCQkJISQoZXYudGFyZ2V0KS5jbG9zZXN0KCcuZmMtcG9wb3ZlcicpLmxlbmd0aCAvLyBub3Qgb24gYSBwb3BvdmVyIChsaWtlIHRoZSAibW9yZS4uIiBldmVudHMgb25lKQoJCQkpIHsKCQkJCV90aGlzLmRheU1vdXNlZG93bihldik7CgkJCX0KCQl9KTsKCgkJLy8gYXR0YWNoIGV2ZW50LWVsZW1lbnQtcmVsYXRlZCBoYW5kbGVycy4gaW4gR3JpZC5ldmVudHMKCQkvLyBzYW1lIGdhcmJhZ2UgY29sbGVjdGlvbiBub3RlIGFzIGFib3ZlLgoJCXRoaXMuYmluZFNlZ0hhbmRsZXJzKCk7CgoJCSQoZG9jdW1lbnQpLm9uKCdkcmFnc3RhcnQnLCB0aGlzLmRvY3VtZW50RHJhZ1N0YXJ0UHJveHkpOyAvLyBqcXVpIGRyYWcKCX0sCgoKCS8vIFVuYXR0YWNoZXMgaGFuZGxlcnMgZnJvbSB0aGUgRE9NCgl1bmJpbmRIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJJChkb2N1bWVudCkub2ZmKCdkcmFnc3RhcnQnLCB0aGlzLmRvY3VtZW50RHJhZ1N0YXJ0UHJveHkpOyAvLyBqcXVpIGRyYWcKCX0sCgoKCS8vIFByb2Nlc3MgYSBtb3VzZWRvd24gb24gYW4gZWxlbWVudCB0aGF0IHJlcHJlc2VudHMgYSBkYXkuIEZvciBkYXkgY2xpY2tpbmcgYW5kIHNlbGVjdGluZy4KCWRheU1vdXNlZG93bjogZnVuY3Rpb24oZXYpIHsKCQl2YXIgX3RoaXMgPSB0aGlzOwoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBpc1NlbGVjdGFibGUgPSB2aWV3Lm9wdCgnc2VsZWN0YWJsZScpOwoJCXZhciBkYXlDbGlja0NlbGw7IC8vIG51bGwgaWYgaW52YWxpZCBkYXlDbGljawoJCXZhciBzZWxlY3Rpb25SYW5nZTsgLy8gbnVsbCBpZiBpbnZhbGlkIHNlbGVjdGlvbgoKCQkvLyB0aGlzIGxpc3RlbmVyIHRyYWNrcyBhIG1vdXNlZG93biBvbiBhIGRheSBlbGVtZW50LCBhbmQgYSBzdWJzZXF1ZW50IGRyYWcuCgkJLy8gaWYgdGhlIGRyYWcgZW5kcyBvbiB0aGUgc2FtZSBkYXksIGl0IGlzIGEgJ2RheUNsaWNrJy4KCQkvLyBpZiAnc2VsZWN0YWJsZScgaXMgZW5hYmxlZCwgdGhpcyBsaXN0ZW5lciBhbHNvIGRldGVjdHMgc2VsZWN0aW9ucy4KCQl2YXIgZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcih0aGlzLmNvb3JkTWFwLCB7CgkJCS8vZGlzdGFuY2U6IDUsIC8vIG5lZWRzIG1vcmUgd29yayBpZiB3ZSB3YW50IGRheUNsaWNrIHRvIGZpcmUgY29ycmVjdGx5CgkJCXNjcm9sbDogdmlldy5vcHQoJ2RyYWdTY3JvbGwnKSwKCQkJZHJhZ1N0YXJ0OiBmdW5jdGlvbigpIHsKCQkJCXZpZXcudW5zZWxlY3QoKTsgLy8gc2luY2Ugd2UgY291bGQgYmUgcmVuZGVyaW5nIGEgbmV3IHNlbGVjdGlvbiwgd2Ugd2FudCB0byBjbGVhciBhbnkgb2xkIG9uZQoJCQl9LAoJCQljZWxsT3ZlcjogZnVuY3Rpb24oY2VsbCwgaXNPcmlnKSB7CgkJCQl2YXIgb3JpZ0NlbGwgPSBkcmFnTGlzdGVuZXIub3JpZ0NlbGw7CgkJCQlpZiAob3JpZ0NlbGwpIHsgLy8gY2xpY2sgbmVlZHMgdG8gaGF2ZSBzdGFydGVkIG9uIGEgY2VsbAoJCQkJCWRheUNsaWNrQ2VsbCA9IGlzT3JpZyA\/IGNlbGwgOiBudWxsOyAvLyBzaW5nbGUtY2VsbCBzZWxlY3Rpb24gaXMgYSBkYXkgY2xpY2sKCQkJCQlpZiAoaXNTZWxlY3RhYmxlKSB7CgkJCQkJCXNlbGVjdGlvblJhbmdlID0gX3RoaXMuY29tcHV0ZVNlbGVjdGlvbihvcmlnQ2VsbCwgY2VsbCk7CgkJCQkJCWlmIChzZWxlY3Rpb25SYW5nZSkgewoJCQkJCQkJX3RoaXMucmVuZGVyU2VsZWN0aW9uKHNlbGVjdGlvblJhbmdlKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCWRpc2FibGVDdXJzb3IoKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSwKCQkJY2VsbE91dDogZnVuY3Rpb24oY2VsbCkgewoJCQkJZGF5Q2xpY2tDZWxsID0gbnVsbDsKCQkJCXNlbGVjdGlvblJhbmdlID0gbnVsbDsKCQkJCV90aGlzLmRlc3Ryb3lTZWxlY3Rpb24oKTsKCQkJCWVuYWJsZUN1cnNvcigpOwoJCQl9LAoJCQlsaXN0ZW5TdG9wOiBmdW5jdGlvbihldikgewoJCQkJaWYgKGRheUNsaWNrQ2VsbCkgewoJCQkJCXZpZXcudHJpZ2dlcignZGF5Q2xpY2snLCBfdGhpcy5nZXRDZWxsRGF5RWwoZGF5Q2xpY2tDZWxsKSwgZGF5Q2xpY2tDZWxsLnN0YXJ0LCBldik7CgkJCQl9CgkJCQlpZiAoc2VsZWN0aW9uUmFuZ2UpIHsKCQkJCQkvLyB0aGUgc2VsZWN0aW9uIHdpbGwgYWxyZWFkeSBoYXZlIGJlZW4gcmVuZGVyZWQuIGp1c3QgcmVwb3J0IGl0CgkJCQkJdmlldy5yZXBvcnRTZWxlY3Rpb24oc2VsZWN0aW9uUmFuZ2UsIGV2KTsKCQkJCX0KCQkJCWVuYWJsZUN1cnNvcigpOwoJCQl9CgkJfSk7CgoJCWRyYWdMaXN0ZW5lci5tb3VzZWRvd24oZXYpOyAvLyBzdGFydCBsaXN0ZW5pbmcsIHdoaWNoIHdpbGwgZXZlbnR1YWxseSBpbml0aWF0ZSBhIGRyYWdTdGFydAoJfSwKCgoJLyogRXZlbnQgSGVscGVyCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoJLy8gVE9ETzogc2hvdWxkIHByb2JhYmx5IG1vdmUgdGhpcyB0byBHcmlkLmV2ZW50cywgbGlrZSB3ZSBkaWQgZXZlbnQgZHJhZ2dpbmcgLyByZXNpemluZwoKCgkvLyBSZW5kZXJzIGEgbW9jayBldmVudCBvdmVyIHRoZSBnaXZlbiByYW5nZS4KCS8vIFRoZSByYW5nZSdzIGVuZCBjYW4gYmUgbnVsbCwgaW4gd2hpY2ggY2FzZSB0aGUgbW9jayBldmVudCB0aGF0IGlzIHJlbmRlcmVkIHdpbGwgaGF2ZSBhIG51bGwgZW5kIHRpbWUuCgkvLyBgc291cmNlU2VnYCBpcyB0aGUgaW50ZXJuYWwgc2VnbWVudCBvYmplY3QgaW52b2x2ZWQgaW4gdGhlIGRyYWcuIElmIG51bGwsIHNvbWV0aGluZyBleHRlcm5hbCBpcyBkcmFnZ2luZy4KCXJlbmRlclJhbmdlSGVscGVyOiBmdW5jdGlvbihyYW5nZSwgc291cmNlU2VnKSB7CgkJdmFyIGZha2VFdmVudDsKCgkJZmFrZUV2ZW50ID0gc291cmNlU2VnID8gY3JlYXRlT2JqZWN0KHNvdXJjZVNlZy5ldmVudCkgOiB7fTsgLy8gbWFzayB0aGUgb3JpZ2luYWwgZXZlbnQgb2JqZWN0IGlmIHBvc3NpYmxlCgkJZmFrZUV2ZW50LnN0YXJ0ID0gcmFuZ2Uuc3RhcnQuY2xvbmUoKTsKCQlmYWtlRXZlbnQuZW5kID0gcmFuZ2UuZW5kID8gcmFuZ2UuZW5kLmNsb25lKCkgOiBudWxsOwoJCWZha2VFdmVudC5hbGxEYXkgPSBudWxsOyAvLyBmb3JjZSBpdCB0byBiZSBmcmVzaGx5IGNvbXB1dGVkIGJ5IG5vcm1hbGl6ZUV2ZW50RGF0ZVByb3BzCgkJdGhpcy52aWV3LmNhbGVuZGFyLm5vcm1hbGl6ZUV2ZW50RGF0ZVByb3BzKGZha2VFdmVudCk7CgoJCS8vIHRoaXMgZXh0cmEgY2xhc3NOYW1lIHdpbGwgYmUgdXNlZnVsIGZvciBkaWZmZXJlbnRpYXRpbmcgcmVhbCBldmVudHMgZnJvbSBtb2NrIGV2ZW50cyBpbiBDU1MKCQlmYWtlRXZlbnQuY2xhc3NOYW1lID0gKGZha2VFdmVudC5jbGFzc05hbWUgfHwgW10pLmNvbmNhdCgnZmMtaGVscGVyJyk7CgoJCS8vIGlmIHNvbWV0aGluZyBleHRlcm5hbCBpcyBiZWluZyBkcmFnZ2VkIGluLCBkb24ndCByZW5kZXIgYSByZXNpemVyCgkJaWYgKCFzb3VyY2VTZWcpIHsKCQkJZmFrZUV2ZW50LmVkaXRhYmxlID0gZmFsc2U7CgkJfQoKCQl0aGlzLnJlbmRlckhlbHBlcihmYWtlRXZlbnQsIHNvdXJjZVNlZyk7IC8vIGRvIHRoZSBhY3R1YWwgcmVuZGVyaW5nCgl9LAoKCgkvLyBSZW5kZXJzIGEgbW9jayBldmVudAoJcmVuZGVySGVscGVyOiBmdW5jdGlvbihldmVudCwgc291cmNlU2VnKSB7CgkJLy8gc3ViY2xhc3NlcyBtdXN0IGltcGxlbWVudAoJfSwKCgoJLy8gVW5yZW5kZXJzIGEgbW9jayBldmVudAoJZGVzdHJveUhlbHBlcjogZnVuY3Rpb24oKSB7CgkJLy8gc3ViY2xhc3NlcyBtdXN0IGltcGxlbWVudAoJfSwKCgoJLyogU2VsZWN0aW9uCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYSBzZWxlY3Rpb24uIFdpbGwgaGlnaGxpZ2h0IGJ5IGRlZmF1bHQgYnV0IGNhbiBiZSBvdmVycmlkZGVuIGJ5IHN1YmNsYXNzZXMuCglyZW5kZXJTZWxlY3Rpb246IGZ1bmN0aW9uKHJhbmdlKSB7CgkJdGhpcy5yZW5kZXJIaWdobGlnaHQocmFuZ2UpOwoJfSwKCgoJLy8gVW5yZW5kZXJzIGFueSB2aXN1YWwgaW5kaWNhdGlvbnMgb2YgYSBzZWxlY3Rpb24uIFdpbGwgdW5yZW5kZXIgYSBoaWdobGlnaHQgYnkgZGVmYXVsdC4KCWRlc3Ryb3lTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXRoaXMuZGVzdHJveUhpZ2hsaWdodCgpOwoJfSwKCgoJLy8gR2l2ZW4gdGhlIGZpcnN0IGFuZCBsYXN0IGNlbGxzIG9mIGEgc2VsZWN0aW9uLCByZXR1cm5zIGEgcmFuZ2Ugb2JqZWN0LgoJLy8gV2lsbCByZXR1cm4gc29tZXRoaW5nIGZhbHN5IGlmIHRoZSBzZWxlY3Rpb24gaXMgaW52YWxpZCAod2hlbiBvdXRzaWRlIG9mIHNlbGVjdGlvbkNvbnN0cmFpbnQgZm9yIGV4YW1wbGUpLgoJLy8gU3ViY2xhc3NlcyBjYW4gb3ZlcnJpZGUgYW5kIHByb3ZpZGUgYWRkaXRpb25hbCBkYXRhIGluIHRoZSByYW5nZSBvYmplY3QuIFdpbGwgYmUgcGFzc2VkIHRvIHJlbmRlclNlbGVjdGlvbigpLgoJY29tcHV0ZVNlbGVjdGlvbjogZnVuY3Rpb24oZmlyc3RDZWxsLCBsYXN0Q2VsbCkgewoJCXZhciBkYXRlcyA9IFsKCQkJZmlyc3RDZWxsLnN0YXJ0LAoJCQlmaXJzdENlbGwuZW5kLAoJCQlsYXN0Q2VsbC5zdGFydCwKCQkJbGFzdENlbGwuZW5kCgkJXTsKCQl2YXIgcmFuZ2U7CgoJCWRhdGVzLnNvcnQoY29tcGFyZU51bWJlcnMpOyAvLyBzb3J0cyBjaHJvbm9sb2dpY2FsbHkuIHdvcmtzIHdpdGggTW9tZW50cwoKCQlyYW5nZSA9IHsKCQkJc3RhcnQ6IGRhdGVzWzBdLmNsb25lKCksCgkJCWVuZDogZGF0ZXNbM10uY2xvbmUoKQoJCX07CgoJCWlmICghdGhpcy52aWV3LmNhbGVuZGFyLmlzU2VsZWN0aW9uUmFuZ2VBbGxvd2VkKHJhbmdlKSkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCXJldHVybiByYW5nZTsKCX0sCgoKCS8qIEhpZ2hsaWdodAoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVuZGVycyBhbiBlbXBoYXNpcyBvbiB0aGUgZ2l2ZW4gZGF0ZSByYW5nZS4gYHN0YXJ0YCBpcyBpbmNsdXNpdmUuIGBlbmRgIGlzIGV4Y2x1c2l2ZS4KCXJlbmRlckhpZ2hsaWdodDogZnVuY3Rpb24ocmFuZ2UpIHsKCQl0aGlzLnJlbmRlckZpbGwoJ2hpZ2hsaWdodCcsIHRoaXMucmFuZ2VUb1NlZ3MocmFuZ2UpKTsKCX0sCgoKCS8vIFVucmVuZGVycyB0aGUgZW1waGFzaXMgb24gYSBkYXRlIHJhbmdlCglkZXN0cm95SGlnaGxpZ2h0OiBmdW5jdGlvbigpIHsKCQl0aGlzLmRlc3Ryb3lGaWxsKCdoaWdobGlnaHQnKTsKCX0sCgoKCS8vIEdlbmVyYXRlcyBhbiBhcnJheSBvZiBjbGFzc05hbWVzIGZvciByZW5kZXJpbmcgdGhlIGhpZ2hsaWdodC4gVXNlZCBieSB0aGUgZmlsbCBzeXN0ZW0uCgloaWdobGlnaHRTZWdDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gWyAnZmMtaGlnaGxpZ2h0JyBdOwoJfSwKCgoJLyogRmlsbCBTeXN0ZW0gKGhpZ2hsaWdodCwgYmFja2dyb3VuZCBldmVudHMsIGJ1c2luZXNzIGhvdXJzKQoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVuZGVycyBhIHNldCBvZiByZWN0YW5nbGVzIG92ZXIgdGhlIGdpdmVuIHNlZ21lbnRzIG9mIHRpbWUuCgkvLyBSZXR1cm5zIGEgc3Vic2V0IG9mIHNlZ3MsIHRoZSBzZWdzIHRoYXQgd2VyZSBhY3R1YWxseSByZW5kZXJlZC4KCS8vIFJlc3BvbnNpYmxlIGZvciBwb3B1bGF0aW5nIHRoaXMuZWxzQnlGaWxsLiBUT0RPOiBiZXR0ZXIgQVBJIGZvciBleHByZXNzaW5nIHRoaXMgcmVxdWlyZW1lbnQKCXJlbmRlckZpbGw6IGZ1bmN0aW9uKHR5cGUsIHNlZ3MpIHsKCQkvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYSBzcGVjaWZpYyB0eXBlIG9mIGZpbGwgdGhhdCBpcyBjdXJyZW50bHkgcmVuZGVyZWQgb24gdGhlIGdyaWQKCWRlc3Ryb3lGaWxsOiBmdW5jdGlvbih0eXBlKSB7CgkJdmFyIGVsID0gdGhpcy5lbHNCeUZpbGxbdHlwZV07CgoJCWlmIChlbCkgewoJCQllbC5yZW1vdmUoKTsKCQkJZGVsZXRlIHRoaXMuZWxzQnlGaWxsW3R5cGVdOwoJCX0KCX0sCgoKCS8vIFJlbmRlcnMgYW5kIGFzc2lnbnMgYW4gYGVsYCBwcm9wZXJ0eSBmb3IgZWFjaCBmaWxsIHNlZ21lbnQuIEdlbmVyaWMgZW5vdWdoIHRvIHdvcmsgd2l0aCBkaWZmZXJlbnQgdHlwZXMuCgkvLyBPbmx5IHJldHVybnMgc2VnbWVudHMgdGhhdCBzdWNjZXNzZnVsbHkgcmVuZGVyZWQuCgkvLyBUbyBiZSBoYXJuZXNzZWQgYnkgcmVuZGVyRmlsbCAoaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3NlcykuCgkvLyBBbmFsYWdvdXMgdG8gcmVuZGVyRmdTZWdFbHMuCglyZW5kZXJGaWxsU2VnRWxzOiBmdW5jdGlvbih0eXBlLCBzZWdzKSB7CgkJdmFyIF90aGlzID0gdGhpczsKCQl2YXIgc2VnRWxNZXRob2QgPSB0aGlzW3R5cGUgKyAnU2VnRWwnXTsKCQl2YXIgaHRtbCA9ICcnOwoJCXZhciByZW5kZXJlZFNlZ3MgPSBbXTsKCQl2YXIgaTsKCgkJaWYgKHNlZ3MubGVuZ3RoKSB7CgoJCQkvLyBidWlsZCBhIGxhcmdlIGNvbmNhdGVuYXRpb24gb2Ygc2VnbWVudCBIVE1MCgkJCWZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7CgkJCQlodG1sICs9IHRoaXMuZmlsbFNlZ0h0bWwodHlwZSwgc2Vnc1tpXSk7CgkJCX0KCgkJCS8vIEdyYWIgaW5kaXZpZHVhbCBlbGVtZW50cyBmcm9tIHRoZSBjb21iaW5lZCBIVE1MIHN0cmluZy4gVXNlIGVhY2ggYXMgdGhlIGRlZmF1bHQgcmVuZGVyaW5nLgoJCQkvLyBUaGVuLCBjb21wdXRlIHRoZSAnZWwnIGZvciBlYWNoIHNlZ21lbnQuCgkJCSQoaHRtbCkuZWFjaChmdW5jdGlvbihpLCBub2RlKSB7CgkJCQl2YXIgc2VnID0gc2Vnc1tpXTsKCQkJCXZhciBlbCA9ICQobm9kZSk7CgoJCQkJLy8gYWxsb3cgY3VzdG9tIGZpbHRlciBtZXRob2RzIHBlci10eXBlCgkJCQlpZiAoc2VnRWxNZXRob2QpIHsKCQkJCQllbCA9IHNlZ0VsTWV0aG9kLmNhbGwoX3RoaXMsIHNlZywgZWwpOwoJCQkJfQoKCQkJCWlmIChlbCkgeyAvLyBjdXN0b20gZmlsdGVycyBkaWQgbm90IGNhbmNlbCB0aGUgcmVuZGVyCgkJCQkJZWwgPSAkKGVsKTsgLy8gYWxsb3cgY3VzdG9tIGZpbHRlciB0byByZXR1cm4gcmF3IERPTSBub2RlCgoJCQkJCS8vIGNvcnJlY3QgZWxlbWVudCB0eXBlPyAod291bGQgYmUgYmFkIGlmIGEgbm9uLVREIHdlcmUgaW5zZXJ0ZWQgaW50byBhIHRhYmxlIGZvciBleGFtcGxlKQoJCQkJCWlmIChlbC5pcyhfdGhpcy5maWxsU2VnVGFnKSkgewoJCQkJCQlzZWcuZWwgPSBlbDsKCQkJCQkJcmVuZGVyZWRTZWdzLnB1c2goc2VnKTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJlbmRlcmVkU2VnczsKCX0sCgoKCWZpbGxTZWdUYWc6ICdkaXYnLCAvLyBzdWJjbGFzc2VzIGNhbiBvdmVycmlkZQoKCgkvLyBCdWlsZHMgdGhlIEhUTUwgbmVlZGVkIGZvciBvbmUgZmlsbCBzZWdtZW50LiBHZW5lcmljIGVub3VnaHQgbyB3b3JrIHdpdGggZGlmZmVyZW50IHR5cGVzLgoJZmlsbFNlZ0h0bWw6IGZ1bmN0aW9uKHR5cGUsIHNlZykgewoJCXZhciBjbGFzc2VzTWV0aG9kID0gdGhpc1t0eXBlICsgJ1NlZ0NsYXNzZXMnXTsgLy8gY3VzdG9tIGhvb2tzIHBlci10eXBlCgkJdmFyIHN0eWxlc01ldGhvZCA9IHRoaXNbdHlwZSArICdTZWdTdHlsZXMnXTsgLy8KCQl2YXIgY2xhc3NlcyA9IGNsYXNzZXNNZXRob2QgPyBjbGFzc2VzTWV0aG9kLmNhbGwodGhpcywgc2VnKSA6IFtdOwoJCXZhciBzdHlsZXMgPSBzdHlsZXNNZXRob2QgPyBzdHlsZXNNZXRob2QuY2FsbCh0aGlzLCBzZWcpIDogJyc7IC8vIGEgc2VtaS1jb2xvbiBzZXBhcmF0ZWQgQ1NTIHByb3BlcnR5IHN0cmluZwoKCQlyZXR1cm4gJzwnICsgdGhpcy5maWxsU2VnVGFnICsKCQkJKGNsYXNzZXMubGVuZ3RoID8gJyBjbGFzcz0iJyArIGNsYXNzZXMuam9pbignICcpICsgJyInIDogJycpICsKCQkJKHN0eWxlcyA\/ICcgc3R5bGU9IicgKyBzdHlsZXMgKyAnIicgOiAnJykgKwoJCQknIC8+JzsKCX0sCgoKCS8qIEdlbmVyaWMgcmVuZGVyaW5nIHV0aWxpdGllcyBmb3Igc3ViY2xhc3NlcwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVuZGVycyBhIGRheS1vZi13ZWVrIGhlYWRlciByb3cuCgkvLyBUT0RPOiBtb3ZlIHRvIGFub3RoZXIgY2xhc3MuIG5vdCBhcHBsaWNhYmxlIHRvIGFsbCBHcmlkcwoJaGVhZEh0bWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAnJyArCgkJCSc8ZGl2IGNsYXNzPSJmYy1yb3cgJyArIHRoaXMudmlldy53aWRnZXRIZWFkZXJDbGFzcyArICciPicgKwoJCQkJJzx0YWJsZT4nICsKCQkJCQknPHRoZWFkPicgKwoJCQkJCQl0aGlzLnJvd0h0bWwoJ2hlYWQnKSArIC8vIGxldmVyYWdlcyBSb3dSZW5kZXJlcgoJCQkJCSc8L3RoZWFkPicgKwoJCQkJJzwvdGFibGU+JyArCgkJCSc8L2Rpdj4nOwoJfSwKCgoJLy8gVXNlZCBieSB0aGUgYGhlYWRIdG1sYCBtZXRob2QsIHZpYSBSb3dSZW5kZXJlciwgZm9yIHJlbmRlcmluZyB0aGUgSFRNTCBvZiBhIGRheS1vZi13ZWVrIGhlYWRlciBjZWxsCgkvLyBUT0RPOiBtb3ZlIHRvIGFub3RoZXIgY2xhc3MuIG5vdCBhcHBsaWNhYmxlIHRvIGFsbCBHcmlkcwoJaGVhZENlbGxIdG1sOiBmdW5jdGlvbihjZWxsKSB7CgkJdmFyIHZpZXcgPSB0aGlzLnZpZXc7CgkJdmFyIGRhdGUgPSBjZWxsLnN0YXJ0OwoKCQlyZXR1cm4gJycgKwoJCQknPHRoIGNsYXNzPSJmYy1kYXktaGVhZGVyICcgKyB2aWV3LndpZGdldEhlYWRlckNsYXNzICsgJyBmYy0nICsgZGF5SURzW2RhdGUuZGF5KCldICsgJyI+JyArCgkJCQlodG1sRXNjYXBlKGRhdGUuZm9ybWF0KHRoaXMuY29sSGVhZEZvcm1hdCkpICsKCQkJJzwvdGg+JzsKCX0sCgoKCS8vIFJlbmRlcnMgdGhlIEhUTUwgZm9yIGEgc2luZ2xlLWRheSBiYWNrZ3JvdW5kIGNlbGwKCWJnQ2VsbEh0bWw6IGZ1bmN0aW9uKGNlbGwpIHsKCQl2YXIgdmlldyA9IHRoaXMudmlldzsKCQl2YXIgZGF0ZSA9IGNlbGwuc3RhcnQ7CgkJdmFyIGNsYXNzZXMgPSB0aGlzLmdldERheUNsYXNzZXMoZGF0ZSk7CgoJCWNsYXNzZXMudW5zaGlmdCgnZmMtZGF5Jywgdmlldy53aWRnZXRDb250ZW50Q2xhc3MpOwoKCQlyZXR1cm4gJzx0ZCBjbGFzcz0iJyArIGNsYXNzZXMuam9pbignICcpICsgJyInICsKCQkJJyBkYXRhLWRhdGU9IicgKyBkYXRlLmZvcm1hdCgnWVlZWS1NTS1ERCcpICsgJyInICsgLy8gaWYgZGF0ZSBoYXMgYSB0aW1lLCB3b24ndCBmb3JtYXQgaXQKCQkJJz48L3RkPic7Cgl9LAoKCgkvLyBDb21wdXRlcyBIVE1MIGNsYXNzTmFtZXMgZm9yIGEgc2luZ2xlLWRheSBjZWxsCglnZXREYXlDbGFzc2VzOiBmdW5jdGlvbihkYXRlKSB7CgkJdmFyIHZpZXcgPSB0aGlzLnZpZXc7CgkJdmFyIHRvZGF5ID0gdmlldy5jYWxlbmRhci5nZXROb3coKS5zdHJpcFRpbWUoKTsKCQl2YXIgY2xhc3NlcyA9IFsgJ2ZjLScgKyBkYXlJRHNbZGF0ZS5kYXkoKV0gXTsKCgkJaWYgKAoJCQl2aWV3Lm5hbWUgPT09ICdtb250aCcgJiYKCQkJZGF0ZS5tb250aCgpICE9IHZpZXcuaW50ZXJ2YWxTdGFydC5tb250aCgpCgkJKSB7CgkJCWNsYXNzZXMucHVzaCgnZmMtb3RoZXItbW9udGgnKTsKCQl9CgoJCWlmIChkYXRlLmlzU2FtZSh0b2RheSwgJ2RheScpKSB7CgkJCWNsYXNzZXMucHVzaCgKCQkJCSdmYy10b2RheScsCgkJCQl2aWV3LmhpZ2hsaWdodFN0YXRlQ2xhc3MKCQkJKTsKCQl9CgkJZWxzZSBpZiAoZGF0ZSA8IHRvZGF5KSB7CgkJCWNsYXNzZXMucHVzaCgnZmMtcGFzdCcpOwoJCX0KCQllbHNlIHsKCQkJY2xhc3Nlcy5wdXNoKCdmYy1mdXR1cmUnKTsKCQl9CgoJCXJldHVybiBjbGFzc2VzOwoJfQoKfSk7Cgo7OwoKLyogRXZlbnQtcmVuZGVyaW5nIGFuZCBldmVudC1pbnRlcmFjdGlvbiBtZXRob2RzIGZvciB0aGUgYWJzdHJhY3QgR3JpZCBjbGFzcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCkdyaWQubWl4aW4oewoKCW1vdXNlZE92ZXJTZWc6IG51bGwsIC8vIHRoZSBzZWdtZW50IG9iamVjdCB0aGUgdXNlcidzIG1vdXNlIGlzIG92ZXIuIG51bGwgaWYgb3ZlciBub3RoaW5nCglpc0RyYWdnaW5nU2VnOiBmYWxzZSwgLy8gaXMgYSBzZWdtZW50IGJlaW5nIGRyYWdnZWQ\/IGJvb2xlYW4KCWlzUmVzaXppbmdTZWc6IGZhbHNlLCAvLyBpcyBhIHNlZ21lbnQgYmVpbmcgcmVzaXplZD8gYm9vbGVhbgoJc2VnczogbnVsbCwgLy8gdGhlIGV2ZW50IHNlZ21lbnRzIGN1cnJlbnRseSByZW5kZXJlZCBpbiB0aGUgZ3JpZAoKCgkvLyBSZW5kZXJzIHRoZSBnaXZlbiBldmVudHMgb250byB0aGUgZ3JpZAoJcmVuZGVyRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKCQl2YXIgc2VncyA9IHRoaXMuZXZlbnRzVG9TZWdzKGV2ZW50cyk7CgkJdmFyIGJnU2VncyA9IFtdOwoJCXZhciBmZ1NlZ3MgPSBbXTsKCQl2YXIgaSwgc2VnOwoKCQlmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgewoJCQlzZWcgPSBzZWdzW2ldOwoKCQkJaWYgKGlzQmdFdmVudChzZWcuZXZlbnQpKSB7CgkJCQliZ1NlZ3MucHVzaChzZWcpOwoJCQl9CgkJCWVsc2UgewoJCQkJZmdTZWdzLnB1c2goc2VnKTsKCQkJfQoJCX0KCgkJLy8gUmVuZGVyIGVhY2ggZGlmZmVyZW50IHR5cGUgb2Ygc2VnbWVudC4KCQkvLyBFYWNoIGZ1bmN0aW9uIG1heSByZXR1cm4gYSBzdWJzZXQgb2YgdGhlIHNlZ3MsIHNlZ3MgdGhhdCB3ZXJlIGFjdHVhbGx5IHJlbmRlcmVkLgoJCWJnU2VncyA9IHRoaXMucmVuZGVyQmdTZWdzKGJnU2VncykgfHwgYmdTZWdzOwoJCWZnU2VncyA9IHRoaXMucmVuZGVyRmdTZWdzKGZnU2VncykgfHwgZmdTZWdzOwoKCQl0aGlzLnNlZ3MgPSBiZ1NlZ3MuY29uY2F0KGZnU2Vncyk7Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYWxsIGV2ZW50cyBjdXJyZW50bHkgcmVuZGVyZWQgb24gdGhlIGdyaWQKCWRlc3Ryb3lFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMudHJpZ2dlclNlZ01vdXNlb3V0KCk7IC8vIHRyaWdnZXIgYW4gZXZlbnRNb3VzZW91dCBpZiB1c2VyJ3MgbW91c2UgaXMgb3ZlciBhbiBldmVudAoKCQl0aGlzLmRlc3Ryb3lGZ1NlZ3MoKTsKCQl0aGlzLmRlc3Ryb3lCZ1NlZ3MoKTsKCgkJdGhpcy5zZWdzID0gbnVsbDsKCX0sCgoKCS8vIFJldHJpZXZlcyBhbGwgcmVuZGVyZWQgc2VnbWVudCBvYmplY3RzIGN1cnJlbnRseSByZW5kZXJlZCBvbiB0aGUgZ3JpZAoJZ2V0RXZlbnRTZWdzOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWdzIHx8IFtdOwoJfSwKCgoJLyogRm9yZWdyb3VuZCBTZWdtZW50IFJlbmRlcmluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVuZGVycyBmb3JlZ3JvdW5kIGV2ZW50IHNlZ21lbnRzIG9udG8gdGhlIGdyaWQuIE1heSByZXR1cm4gYSBzdWJzZXQgb2Ygc2VncyB0aGF0IHdlcmUgcmVuZGVyZWQuCglyZW5kZXJGZ1NlZ3M6IGZ1bmN0aW9uKHNlZ3MpIHsKCQkvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYWxsIGN1cnJlbnRseSByZW5kZXJlZCBmb3JlZ3JvdW5kIHNlZ21lbnRzCglkZXN0cm95RmdTZWdzOiBmdW5jdGlvbigpIHsKCQkvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50Cgl9LAoKCgkvLyBSZW5kZXJzIGFuZCBhc3NpZ25zIGFuIGBlbGAgcHJvcGVydHkgZm9yIGVhY2ggZm9yZWdyb3VuZCBldmVudCBzZWdtZW50LgoJLy8gT25seSByZXR1cm5zIHNlZ21lbnRzIHRoYXQgc3VjY2Vzc2Z1bGx5IHJlbmRlcmVkLgoJLy8gQSB1dGlsaXR5IHRoYXQgc3ViY2xhc3NlcyBtYXkgdXNlLgoJcmVuZGVyRmdTZWdFbHM6IGZ1bmN0aW9uKHNlZ3MsIGRpc2FibGVSZXNpemluZykgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBodG1sID0gJyc7CgkJdmFyIHJlbmRlcmVkU2VncyA9IFtdOwoJCXZhciBpOwoKCQlpZiAoc2Vncy5sZW5ndGgpIHsgLy8gZG9uJ3QgYnVpbGQgYW4gZW1wdHkgaHRtbCBzdHJpbmcKCgkJCS8vIGJ1aWxkIGEgbGFyZ2UgY29uY2F0ZW5hdGlvbiBvZiBldmVudCBzZWdtZW50IEhUTUwKCQkJZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsKCQkJCWh0bWwgKz0gdGhpcy5mZ1NlZ0h0bWwoc2Vnc1tpXSwgZGlzYWJsZVJlc2l6aW5nKTsKCQkJfQoKCQkJLy8gR3JhYiBpbmRpdmlkdWFsIGVsZW1lbnRzIGZyb20gdGhlIGNvbWJpbmVkIEhUTUwgc3RyaW5nLiBVc2UgZWFjaCBhcyB0aGUgZGVmYXVsdCByZW5kZXJpbmcuCgkJCS8vIFRoZW4sIGNvbXB1dGUgdGhlICdlbCcgZm9yIGVhY2ggc2VnbWVudC4gQW4gZWwgbWlnaHQgYmUgbnVsbCBpZiB0aGUgZXZlbnRSZW5kZXIgY2FsbGJhY2sgcmV0dXJuZWQgZmFsc2UuCgkJCSQoaHRtbCkuZWFjaChmdW5jdGlvbihpLCBub2RlKSB7CgkJCQl2YXIgc2VnID0gc2Vnc1tpXTsKCQkJCXZhciBlbCA9IHZpZXcucmVzb2x2ZUV2ZW50RWwoc2VnLmV2ZW50LCAkKG5vZGUpKTsKCgkJCQlpZiAoZWwpIHsKCQkJCQllbC5kYXRhKCdmYy1zZWcnLCBzZWcpOyAvLyB1c2VkIGJ5IGhhbmRsZXJzCgkJCQkJc2VnLmVsID0gZWw7CgkJCQkJcmVuZGVyZWRTZWdzLnB1c2goc2VnKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmVuZGVyZWRTZWdzOwoJfSwKCgoJLy8gR2VuZXJhdGVzIHRoZSBIVE1MIGZvciB0aGUgZGVmYXVsdCByZW5kZXJpbmcgb2YgYSBmb3JlZ3JvdW5kIGV2ZW50IHNlZ21lbnQuIFVzZWQgYnkgcmVuZGVyRmdTZWdFbHMoKQoJZmdTZWdIdG1sOiBmdW5jdGlvbihzZWcsIGRpc2FibGVSZXNpemluZykgewoJCS8vIHN1YmNsYXNzZXMgc2hvdWxkIGltcGxlbWVudAoJfSwKCgoJLyogQmFja2dyb3VuZCBTZWdtZW50IFJlbmRlcmluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVuZGVycyB0aGUgZ2l2ZW4gYmFja2dyb3VuZCBldmVudCBzZWdtZW50cyBvbnRvIHRoZSBncmlkLgoJLy8gUmV0dXJucyBhIHN1YnNldCBvZiB0aGUgc2VncyB0aGF0IHdlcmUgYWN0dWFsbHkgcmVuZGVyZWQuCglyZW5kZXJCZ1NlZ3M6IGZ1bmN0aW9uKHNlZ3MpIHsKCQlyZXR1cm4gdGhpcy5yZW5kZXJGaWxsKCdiZ0V2ZW50Jywgc2Vncyk7Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYWxsIHRoZSBjdXJyZW50bHkgcmVuZGVyZWQgYmFja2dyb3VuZCBldmVudCBzZWdtZW50cwoJZGVzdHJveUJnU2VnczogZnVuY3Rpb24oKSB7CgkJdGhpcy5kZXN0cm95RmlsbCgnYmdFdmVudCcpOwoJfSwKCgoJLy8gUmVuZGVycyBhIGJhY2tncm91bmQgZXZlbnQgZWxlbWVudCwgZ2l2ZW4gdGhlIGRlZmF1bHQgcmVuZGVyaW5nLiBDYWxsZWQgYnkgdGhlIGZpbGwgc3lzdGVtLgoJYmdFdmVudFNlZ0VsOiBmdW5jdGlvbihzZWcsIGVsKSB7CgkJcmV0dXJuIHRoaXMudmlldy5yZXNvbHZlRXZlbnRFbChzZWcuZXZlbnQsIGVsKTsgLy8gd2lsbCBmaWx0ZXIgdGhyb3VnaCBldmVudFJlbmRlcgoJfSwKCgoJLy8gR2VuZXJhdGVzIGFuIGFycmF5IG9mIGNsYXNzTmFtZXMgdG8gYmUgdXNlZCBmb3IgdGhlIGRlZmF1bHQgcmVuZGVyaW5nIG9mIGEgYmFja2dyb3VuZCBldmVudC4KCS8vIENhbGxlZCBieSB0aGUgZmlsbCBzeXN0ZW0uCgliZ0V2ZW50U2VnQ2xhc3NlczogZnVuY3Rpb24oc2VnKSB7CgkJdmFyIGV2ZW50ID0gc2VnLmV2ZW50OwoJCXZhciBzb3VyY2UgPSBldmVudC5zb3VyY2UgfHwge307CgoJCXJldHVybiBbICdmYy1iZ2V2ZW50JyBdLmNvbmNhdCgKCQkJZXZlbnQuY2xhc3NOYW1lLAoJCQlzb3VyY2UuY2xhc3NOYW1lIHx8IFtdCgkJKTsKCX0sCgoKCS8vIEdlbmVyYXRlcyBhIHNlbWljb2xvbi1zZXBhcmF0ZWQgQ1NTIHN0cmluZyB0byBiZSB1c2VkIGZvciB0aGUgZGVmYXVsdCByZW5kZXJpbmcgb2YgYSBiYWNrZ3JvdW5kIGV2ZW50LgoJLy8gQ2FsbGVkIGJ5IHRoZSBmaWxsIHN5c3RlbS4KCS8vIFRPRE86IGNvbnNvbGlkYXRlIHdpdGggZ2V0RXZlbnRTa2luQ3NzPwoJYmdFdmVudFNlZ1N0eWxlczogZnVuY3Rpb24oc2VnKSB7CgkJdmFyIHZpZXcgPSB0aGlzLnZpZXc7CgkJdmFyIGV2ZW50ID0gc2VnLmV2ZW50OwoJCXZhciBzb3VyY2UgPSBldmVudC5zb3VyY2UgfHwge307CgkJdmFyIGV2ZW50Q29sb3IgPSBldmVudC5jb2xvcjsKCQl2YXIgc291cmNlQ29sb3IgPSBzb3VyY2UuY29sb3I7CgkJdmFyIG9wdGlvbkNvbG9yID0gdmlldy5vcHQoJ2V2ZW50Q29sb3InKTsKCQl2YXIgYmFja2dyb3VuZENvbG9yID0KCQkJZXZlbnQuYmFja2dyb3VuZENvbG9yIHx8CgkJCWV2ZW50Q29sb3IgfHwKCQkJc291cmNlLmJhY2tncm91bmRDb2xvciB8fAoJCQlzb3VyY2VDb2xvciB8fAoJCQl2aWV3Lm9wdCgnZXZlbnRCYWNrZ3JvdW5kQ29sb3InKSB8fAoJCQlvcHRpb25Db2xvcjsKCgkJaWYgKGJhY2tncm91bmRDb2xvcikgewoJCQlyZXR1cm4gJ2JhY2tncm91bmQtY29sb3I6JyArIGJhY2tncm91bmRDb2xvcjsKCQl9CgoJCXJldHVybiAnJzsKCX0sCgoKCS8vIEdlbmVyYXRlcyBhbiBhcnJheSBvZiBjbGFzc05hbWVzIHRvIGJlIHVzZWQgZm9yIHRoZSByZW5kZXJpbmcgYnVzaW5lc3MgaG91cnMgb3ZlcmxheS4gQ2FsbGVkIGJ5IHRoZSBmaWxsIHN5c3RlbS4KCWJ1c2luZXNzSG91cnNTZWdDbGFzc2VzOiBmdW5jdGlvbihzZWcpIHsKCQlyZXR1cm4gWyAnZmMtbm9uYnVzaW5lc3MnLCAnZmMtYmdldmVudCcgXTsKCX0sCgoKCS8qIEhhbmRsZXJzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBBdHRhY2hlcyBldmVudC1lbGVtZW50LXJlbGF0ZWQgaGFuZGxlcnMgdG8gdGhlIGNvbnRhaW5lciBlbGVtZW50IGFuZCBsZXZlcmFnZSBidWJibGluZwoJYmluZFNlZ0hhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgX3RoaXMgPSB0aGlzOwoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoKCQkkLmVhY2goCgkJCXsKCQkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKHNlZywgZXYpIHsKCQkJCQlfdGhpcy50cmlnZ2VyU2VnTW91c2VvdmVyKHNlZywgZXYpOwoJCQkJfSwKCQkJCW1vdXNlbGVhdmU6IGZ1bmN0aW9uKHNlZywgZXYpIHsKCQkJCQlfdGhpcy50cmlnZ2VyU2VnTW91c2VvdXQoc2VnLCBldik7CgkJCQl9LAoJCQkJY2xpY2s6IGZ1bmN0aW9uKHNlZywgZXYpIHsKCQkJCQlyZXR1cm4gdmlldy50cmlnZ2VyKCdldmVudENsaWNrJywgdGhpcywgc2VnLmV2ZW50LCBldik7IC8vIGNhbiByZXR1cm4gYGZhbHNlYCB0byBjYW5jZWwKCQkJCX0sCgkJCQltb3VzZWRvd246IGZ1bmN0aW9uKHNlZywgZXYpIHsKCQkJCQlpZiAoJChldi50YXJnZXQpLmlzKCcuZmMtcmVzaXplcicpICYmIHZpZXcuaXNFdmVudFJlc2l6YWJsZShzZWcuZXZlbnQpKSB7CgkJCQkJCV90aGlzLnNlZ1Jlc2l6ZU1vdXNlZG93bihzZWcsIGV2KTsKCQkJCQl9CgkJCQkJZWxzZSBpZiAodmlldy5pc0V2ZW50RHJhZ2dhYmxlKHNlZy5ldmVudCkpIHsKCQkJCQkJX3RoaXMuc2VnRHJhZ01vdXNlZG93bihzZWcsIGV2KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgkJCWZ1bmN0aW9uKG5hbWUsIGZ1bmMpIHsKCQkJCS8vIGF0dGFjaCB0aGUgaGFuZGxlciB0byB0aGUgY29udGFpbmVyIGVsZW1lbnQgYW5kIG9ubHkgbGlzdGVuIGZvciByZWFsIGV2ZW50IGVsZW1lbnRzIHZpYSBidWJibGluZwoJCQkJX3RoaXMuZWwub24obmFtZSwgJy5mYy1ldmVudC1jb250YWluZXIgPiAqJywgZnVuY3Rpb24oZXYpIHsKCQkJCQl2YXIgc2VnID0gJCh0aGlzKS5kYXRhKCdmYy1zZWcnKTsgLy8gZ3JhYiBzZWdtZW50IGRhdGEuIHB1dCB0aGVyZSBieSBWaWV3OjpyZW5kZXJFdmVudHMKCgkJCQkJLy8gb25seSBjYWxsIHRoZSBoYW5kbGVycyBpZiB0aGVyZSBpcyBub3QgYSBkcmFnL3Jlc2l6ZSBpbiBwcm9ncmVzcwoJCQkJCWlmIChzZWcgJiYgIV90aGlzLmlzRHJhZ2dpbmdTZWcgJiYgIV90aGlzLmlzUmVzaXppbmdTZWcpIHsKCQkJCQkJcmV0dXJuIGZ1bmMuY2FsbCh0aGlzLCBzZWcsIGV2KTsgLy8gYHRoaXNgIHdpbGwgYmUgdGhlIGV2ZW50IGVsZW1lbnQKCQkJCQl9CgkJCQl9KTsKCQkJfQoJCSk7Cgl9LAoKCgkvLyBVcGRhdGVzIGludGVybmFsIHN0YXRlIGFuZCB0cmlnZ2VycyBoYW5kbGVycyBmb3Igd2hlbiBhbiBldmVudCBlbGVtZW50IGlzIG1vdXNlZCBvdmVyCgl0cmlnZ2VyU2VnTW91c2VvdmVyOiBmdW5jdGlvbihzZWcsIGV2KSB7CgkJaWYgKCF0aGlzLm1vdXNlZE92ZXJTZWcpIHsKCQkJdGhpcy5tb3VzZWRPdmVyU2VnID0gc2VnOwoJCQl0aGlzLnZpZXcudHJpZ2dlcignZXZlbnRNb3VzZW92ZXInLCBzZWcuZWxbMF0sIHNlZy5ldmVudCwgZXYpOwoJCX0KCX0sCgoKCS8vIFVwZGF0ZXMgaW50ZXJuYWwgc3RhdGUgYW5kIHRyaWdnZXJzIGhhbmRsZXJzIGZvciB3aGVuIGFuIGV2ZW50IGVsZW1lbnQgaXMgbW91c2VkIG91dC4KCS8vIENhbiBiZSBnaXZlbiBubyBhcmd1bWVudHMsIGluIHdoaWNoIGNhc2UgaXQgd2lsbCBtb3VzZW91dCB0aGUgc2VnbWVudCB0aGF0IHdhcyBwcmV2aW91c2x5IG1vdXNlZCBvdmVyLgoJdHJpZ2dlclNlZ01vdXNlb3V0OiBmdW5jdGlvbihzZWcsIGV2KSB7CgkJZXYgPSBldiB8fCB7fTsgLy8gaWYgZ2l2ZW4gbm8gYXJncywgbWFrZSBhIG1vY2sgbW91c2UgZXZlbnQKCgkJaWYgKHRoaXMubW91c2VkT3ZlclNlZykgewoJCQlzZWcgPSBzZWcgfHwgdGhpcy5tb3VzZWRPdmVyU2VnOyAvLyBpZiBnaXZlbiBubyBhcmdzLCB1c2UgdGhlIGN1cnJlbnRseSBtb3VzZWQtb3ZlciBzZWdtZW50CgkJCXRoaXMubW91c2VkT3ZlclNlZyA9IG51bGw7CgkJCXRoaXMudmlldy50cmlnZ2VyKCdldmVudE1vdXNlb3V0Jywgc2VnLmVsWzBdLCBzZWcuZXZlbnQsIGV2KTsKCQl9Cgl9LAoKCgkvKiBFdmVudCBEcmFnZ2luZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gQ2FsbGVkIHdoZW4gdGhlIHVzZXIgZG9lcyBhIG1vdXNlZG93biBvbiBhbiBldmVudCwgd2hpY2ggbWlnaHQgbGVhZCB0byBkcmFnZ2luZy4KCS8vIEdlbmVyaWMgZW5vdWdoIHRvIHdvcmsgd2l0aCBhbnkgdHlwZSBvZiBHcmlkLgoJc2VnRHJhZ01vdXNlZG93bjogZnVuY3Rpb24oc2VnLCBldikgewoJCXZhciBfdGhpcyA9IHRoaXM7CgkJdmFyIHZpZXcgPSB0aGlzLnZpZXc7CgkJdmFyIGVsID0gc2VnLmVsOwoJCXZhciBldmVudCA9IHNlZy5ldmVudDsKCQl2YXIgZHJvcExvY2F0aW9uOwoKCQkvLyBBIGNsb25lIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50IHRoYXQgd2lsbCBtb3ZlIHdpdGggdGhlIG1vdXNlCgkJdmFyIG1vdXNlRm9sbG93ZXIgPSBuZXcgTW91c2VGb2xsb3dlcihzZWcuZWwsIHsKCQkJcGFyZW50RWw6IHZpZXcuZWwsCgkJCW9wYWNpdHk6IHZpZXcub3B0KCdkcmFnT3BhY2l0eScpLAoJCQlyZXZlcnREdXJhdGlvbjogdmlldy5vcHQoJ2RyYWdSZXZlcnREdXJhdGlvbicpLAoJCQl6SW5kZXg6IDIgLy8gb25lIGFib3ZlIHRoZSAuZmMtdmlldwoJCX0pOwoKCQkvLyBUcmFja3MgbW91c2UgbW92ZW1lbnQgb3ZlciB0aGUgKnZpZXcncyogY29vcmRpbmF0ZSBtYXAuIEFsbG93cyBkcmFnZ2luZyBhbmQgZHJvcHBpbmcgYmV0d2VlbiBzdWJjb21wb25lbnRzCgkJLy8gb2YgdGhlIHZpZXcuCgkJdmFyIGRyYWdMaXN0ZW5lciA9IG5ldyBEcmFnTGlzdGVuZXIodmlldy5jb29yZE1hcCwgewoJCQlkaXN0YW5jZTogNSwKCQkJc2Nyb2xsOiB2aWV3Lm9wdCgnZHJhZ1Njcm9sbCcpLAoJCQlsaXN0ZW5TdGFydDogZnVuY3Rpb24oZXYpIHsKCQkJCW1vdXNlRm9sbG93ZXIuaGlkZSgpOyAvLyBkb24ndCBzaG93IHVudGlsIHdlIGtub3cgdGhpcyBpcyBhIHJlYWwgZHJhZwoJCQkJbW91c2VGb2xsb3dlci5zdGFydChldik7CgkJCX0sCgkJCWRyYWdTdGFydDogZnVuY3Rpb24oZXYpIHsKCQkJCV90aGlzLnRyaWdnZXJTZWdNb3VzZW91dChzZWcsIGV2KTsgLy8gZW5zdXJlIGEgbW91c2VvdXQgb24gdGhlIG1hbmlwdWxhdGVkIGV2ZW50IGhhcyBiZWVuIHJlcG9ydGVkCgkJCQlfdGhpcy5pc0RyYWdnaW5nU2VnID0gdHJ1ZTsKCQkJCXZpZXcuaGlkZUV2ZW50KGV2ZW50KTsgLy8gaGlkZSBhbGwgZXZlbnQgc2VnbWVudHMuIG91ciBtb3VzZUZvbGxvd2VyIHdpbGwgdGFrZSBvdmVyCgkJCQl2aWV3LnRyaWdnZXIoJ2V2ZW50RHJhZ1N0YXJ0JywgZWxbMF0sIGV2ZW50LCBldiwge30pOyAvLyBsYXN0IGFyZ3VtZW50IGlzIGpxdWkgZHVtbXkKCQkJfSwKCQkJY2VsbE92ZXI6IGZ1bmN0aW9uKGNlbGwsIGlzT3JpZykgewoJCQkJdmFyIG9yaWdDZWxsID0gc2VnLmNlbGwgfHwgZHJhZ0xpc3RlbmVyLm9yaWdDZWxsOyAvLyBzdGFydGluZyBjZWxsIGNvdWxkIGJlIGZvcmNlZCAoRGF5R3JpZC5saW1pdCkKCgkJCQlkcm9wTG9jYXRpb24gPSBfdGhpcy5jb21wdXRlRXZlbnREcm9wKG9yaWdDZWxsLCBjZWxsLCBldmVudCk7CgkJCQlpZiAoZHJvcExvY2F0aW9uKSB7CgkJCQkJaWYgKHZpZXcucmVuZGVyRHJhZyhkcm9wTG9jYXRpb24sIHNlZykpIHsgLy8gaGF2ZSB0aGUgc3ViY2xhc3MgcmVuZGVyIGEgdmlzdWFsIGluZGljYXRpb24KCQkJCQkJbW91c2VGb2xsb3dlci5oaWRlKCk7IC8vIGlmIHRoZSBzdWJjbGFzcyBpcyBhbHJlYWR5IHVzaW5nIGEgbW9jayBldmVudCAiaGVscGVyIiwgaGlkZSBvdXIgb3duCgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQltb3VzZUZvbGxvd2VyLnNob3coKTsKCQkJCQl9CgkJCQkJaWYgKGlzT3JpZykgewoJCQkJCQlkcm9wTG9jYXRpb24gPSBudWxsOyAvLyBuZWVkcyB0byBoYXZlIG1vdmVkIGNlbGxzIHRvIGJlIGEgdmFsaWQgZHJvcAoJCQkJCX0KCQkJCX0KCQkJCWVsc2UgewoJCQkJCS8vIGhhdmUgdGhlIGhlbHBlciBmb2xsb3cgdGhlIG1vdXNlIChubyBzbmFwcGluZykgd2l0aCBhIHdhcm5pbmctc3R5bGUgY3Vyc29yCgkJCQkJbW91c2VGb2xsb3dlci5zaG93KCk7CgkJCQkJZGlzYWJsZUN1cnNvcigpOwoJCQkJfQoJCQl9LAoJCQljZWxsT3V0OiBmdW5jdGlvbigpIHsgLy8gY2FsbGVkIGJlZm9yZSBtb3VzZSBtb3ZlcyB0byBhIGRpZmZlcmVudCBjZWxsIE9SIG1vdmVkIG91dCBvZiBhbGwgY2VsbHMKCQkJCWRyb3BMb2NhdGlvbiA9IG51bGw7CgkJCQl2aWV3LmRlc3Ryb3lEcmFnKCk7IC8vIHVucmVuZGVyIHdoYXRldmVyIHdhcyBkb25lIGluIHJlbmRlckRyYWcKCQkJCW1vdXNlRm9sbG93ZXIuc2hvdygpOyAvLyBzaG93IGluIGNhc2Ugd2UgYXJlIG1vdmluZyBvdXQgb2YgYWxsIGNlbGxzCgkJCQllbmFibGVDdXJzb3IoKTsKCQkJfSwKCQkJZHJhZ1N0b3A6IGZ1bmN0aW9uKGV2KSB7CgkJCQkvLyBkbyByZXZlcnQgYW5pbWF0aW9uIGlmIGhhc24ndCBjaGFuZ2VkLiBjYWxscyBhIGNhbGxiYWNrIHdoZW4gZmluaXNoZWQgKHdoZXRoZXIgYW5pbWF0aW9uIG9yIG5vdCkKCQkJCW1vdXNlRm9sbG93ZXIuc3RvcCghZHJvcExvY2F0aW9uLCBmdW5jdGlvbigpIHsKCQkJCQlfdGhpcy5pc0RyYWdnaW5nU2VnID0gZmFsc2U7CgkJCQkJdmlldy5kZXN0cm95RHJhZygpOwoJCQkJCXZpZXcuc2hvd0V2ZW50KGV2ZW50KTsKCQkJCQl2aWV3LnRyaWdnZXIoJ2V2ZW50RHJhZ1N0b3AnLCBlbFswXSwgZXZlbnQsIGV2LCB7fSk7IC8vIGxhc3QgYXJndW1lbnQgaXMganF1aSBkdW1teQoKCQkJCQlpZiAoZHJvcExvY2F0aW9uKSB7CgkJCQkJCXZpZXcucmVwb3J0RXZlbnREcm9wKGV2ZW50LCBkcm9wTG9jYXRpb24sIGVsLCBldik7CgkJCQkJfQoJCQkJfSk7CgkJCQllbmFibGVDdXJzb3IoKTsKCQkJfSwKCQkJbGlzdGVuU3RvcDogZnVuY3Rpb24oKSB7CgkJCQltb3VzZUZvbGxvd2VyLnN0b3AoKTsgLy8gcHV0IGluIGxpc3RlblN0b3AgaW4gY2FzZSB0aGVyZSB3YXMgYSBtb3VzZWRvd24gYnV0IHRoZSBkcmFnIG5ldmVyIHN0YXJ0ZWQKCQkJfQoJCX0pOwoKCQlkcmFnTGlzdGVuZXIubW91c2Vkb3duKGV2KTsgLy8gc3RhcnQgbGlzdGVuaW5nLCB3aGljaCB3aWxsIGV2ZW50dWFsbHkgbGVhZCB0byBhIGRyYWdTdGFydAoJfSwKCgoJLy8gR2l2ZW4gdGhlIGNlbGwgYW4gZXZlbnQgZHJhZyBiZWdhbiwgYW5kIHRoZSBjZWxsIGV2ZW50IHdhcyBkcm9wcGVkLCBjYWxjdWxhdGVzIHRoZSBuZXcgc3RhcnQvZW5kL2FsbERheQoJLy8gdmFsdWVzIGZvciB0aGUgZXZlbnQuIFN1YmNsYXNzZXMgbWF5IG92ZXJyaWRlIGFuZCBzZXQgYWRkaXRpb25hbCBwcm9wZXJ0aWVzIHRvIGJlIHVzZWQgYnkgcmVuZGVyRHJhZy4KCS8vIEEgZmFsc3kgcmV0dXJuZWQgdmFsdWUgaW5kaWNhdGVzIGFuIGludmFsaWQgZHJvcC4KCWNvbXB1dGVFdmVudERyb3A6IGZ1bmN0aW9uKHN0YXJ0Q2VsbCwgZW5kQ2VsbCwgZXZlbnQpIHsKCQl2YXIgZHJhZ1N0YXJ0ID0gc3RhcnRDZWxsLnN0YXJ0OwoJCXZhciBkcmFnRW5kID0gZW5kQ2VsbC5zdGFydDsKCQl2YXIgZGVsdGE7CgkJdmFyIG5ld1N0YXJ0OwoJCXZhciBuZXdFbmQ7CgkJdmFyIG5ld0FsbERheTsKCQl2YXIgZHJvcExvY2F0aW9uOwoKCQlpZiAoZHJhZ1N0YXJ0Lmhhc1RpbWUoKSA9PT0gZHJhZ0VuZC5oYXNUaW1lKCkpIHsKCQkJZGVsdGEgPSBkaWZmRGF5VGltZShkcmFnRW5kLCBkcmFnU3RhcnQpOwoJCQluZXdTdGFydCA9IGV2ZW50LnN0YXJ0LmNsb25lKCkuYWRkKGRlbHRhKTsKCQkJaWYgKGV2ZW50LmVuZCA9PT0gbnVsbCkgeyAvLyBkbyB3ZSBuZWVkIHRvIGNvbXB1dGUgYW4gZW5kPwoJCQkJbmV3RW5kID0gbnVsbDsKCQkJfQoJCQllbHNlIHsKCQkJCW5ld0VuZCA9IGV2ZW50LmVuZC5jbG9uZSgpLmFkZChkZWx0YSk7CgkJCX0KCQkJbmV3QWxsRGF5ID0gZXZlbnQuYWxsRGF5OyAvLyBrZWVwIGl0IHRoZSBzYW1lCgkJfQoJCWVsc2UgewoJCQkvLyBpZiBzd2l0Y2hpbmcgZnJvbSBkYXkgPC0+IHRpbWVkLCBzdGFydCBzaG91bGQgYmUgcmVzZXQgdG8gdGhlIGRyb3BwZWQgZGF0ZSwgYW5kIHRoZSBlbmQgY2xlYXJlZAoJCQluZXdTdGFydCA9IGRyYWdFbmQuY2xvbmUoKTsKCQkJbmV3RW5kID0gbnVsbDsgLy8gZW5kIHNob3VsZCBiZSBjbGVhcmVkCgkJCW5ld0FsbERheSA9ICFkcmFnRW5kLmhhc1RpbWUoKTsKCQl9CgoJCWRyb3BMb2NhdGlvbiA9IHsKCQkJc3RhcnQ6IG5ld1N0YXJ0LAoJCQllbmQ6IG5ld0VuZCwKCQkJYWxsRGF5OiBuZXdBbGxEYXkKCQl9OwoKCQlpZiAoIXRoaXMudmlldy5jYWxlbmRhci5pc0V2ZW50UmFuZ2VBbGxvd2VkKGRyb3BMb2NhdGlvbiwgZXZlbnQpKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJcmV0dXJuIGRyb3BMb2NhdGlvbjsKCX0sCgoKCS8qIEV4dGVybmFsIEVsZW1lbnQgRHJhZ2dpbmcKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIENhbGxlZCB3aGVuIGEgalF1ZXJ5IFVJIGRyYWcgaXMgaW5pdGlhdGVkIGFueXdoZXJlIGluIHRoZSBET00KCWRvY3VtZW50RHJhZ1N0YXJ0OiBmdW5jdGlvbihldiwgdWkpIHsKCQl2YXIgdmlldyA9IHRoaXMudmlldzsKCQl2YXIgZWw7CgkJdmFyIGFjY2VwdDsKCgkJaWYgKHZpZXcub3B0KCdkcm9wcGFibGUnKSkgeyAvLyBvbmx5IGxpc3RlbiBpZiB0aGlzIHNldHRpbmcgaXMgb24KCQkJZWwgPSAkKGV2LnRhcmdldCk7CgoJCQkvLyBUZXN0IHRoYXQgdGhlIGRyYWdnZWQgZWxlbWVudCBwYXNzZXMgdGhlIGRyb3BBY2NlcHQgc2VsZWN0b3Igb3IgZmlsdGVyIGZ1bmN0aW9uLgoJCQkvLyBGWUksIHRoZSBkZWZhdWx0IGlzICIqIiAobWF0Y2hlcyBhbGwpCgkJCWFjY2VwdCA9IHZpZXcub3B0KCdkcm9wQWNjZXB0Jyk7CgkJCWlmICgkLmlzRnVuY3Rpb24oYWNjZXB0KSA\/IGFjY2VwdC5jYWxsKGVsWzBdLCBlbCkgOiBlbC5pcyhhY2NlcHQpKSB7CgoJCQkJdGhpcy5zdGFydEV4dGVybmFsRHJhZyhlbCwgZXYsIHVpKTsKCQkJfQoJCX0KCX0sCgoKCS8vIENhbGxlZCB3aGVuIGEgalF1ZXJ5IFVJIGRyYWcgc3RhcnRzIGFuZCBpdCBuZWVkcyB0byBiZSBtb25pdG9yZWQgZm9yIGNlbGwgZHJvcHBpbmcKCXN0YXJ0RXh0ZXJuYWxEcmFnOiBmdW5jdGlvbihlbCwgZXYsIHVpKSB7CgkJdmFyIF90aGlzID0gdGhpczsKCQl2YXIgbWV0YSA9IGdldERyYWdnZWRFbE1ldGEoZWwpOyAvLyBleHRyYSBkYXRhIGFib3V0IGV2ZW50IGRyb3AsIGluY2x1ZGluZyBwb3NzaWJsZSBldmVudCB0byBjcmVhdGUKCQl2YXIgZHJhZ0xpc3RlbmVyOwoJCXZhciBkcm9wTG9jYXRpb247IC8vIGEgbnVsbCB2YWx1ZSBzaWduYWxzIGFuIHVuc3VjY2Vzc2Z1bCBkcmFnCgoJCS8vIGxpc3RlbmVyIHRoYXQgdHJhY2tzIG1vdXNlIG1vdmVtZW50IG92ZXIgZGF0ZS1hc3NvY2lhdGVkIHBpeGVsIHJlZ2lvbnMKCQlkcmFnTGlzdGVuZXIgPSBuZXcgRHJhZ0xpc3RlbmVyKHRoaXMuY29vcmRNYXAsIHsKCQkJY2VsbE92ZXI6IGZ1bmN0aW9uKGNlbGwpIHsKCQkJCWRyb3BMb2NhdGlvbiA9IF90aGlzLmNvbXB1dGVFeHRlcm5hbERyb3AoY2VsbCwgbWV0YSk7CgkJCQlpZiAoZHJvcExvY2F0aW9uKSB7CgkJCQkJX3RoaXMucmVuZGVyRHJhZyhkcm9wTG9jYXRpb24pOyAvLyBjYWxsZWQgd2l0aG91dCBhIHNlZyBwYXJhbWV0ZXIKCQkJCX0KCQkJCWVsc2UgeyAvLyBpbnZhbGlkIGRyb3AgY2VsbAoJCQkJCWRpc2FibGVDdXJzb3IoKTsKCQkJCX0KCQkJfSwKCQkJY2VsbE91dDogZnVuY3Rpb24oKSB7CgkJCQlkcm9wTG9jYXRpb24gPSBudWxsOyAvLyBzaWduYWwgdW5zdWNjZXNzZnVsCgkJCQlfdGhpcy5kZXN0cm95RHJhZygpOwoJCQkJZW5hYmxlQ3Vyc29yKCk7CgkJCX0KCQl9KTsKCgkJLy8gZ2V0cyBjYWxsZWQsIG9ubHkgb25jZSwgd2hlbiBqcXVpIGRyYWcgaXMgZmluaXNoZWQKCQkkKGRvY3VtZW50KS5vbmUoJ2RyYWdzdG9wJywgZnVuY3Rpb24oZXYsIHVpKSB7CgkJCV90aGlzLmRlc3Ryb3lEcmFnKCk7CgkJCWVuYWJsZUN1cnNvcigpOwoKCQkJaWYgKGRyb3BMb2NhdGlvbikgeyAvLyBlbGVtZW50IHdhcyBkcm9wcGVkIG9uIGEgdmFsaWQgZGF0ZS90aW1lIGNlbGwKCQkJCV90aGlzLnZpZXcucmVwb3J0RXh0ZXJuYWxEcm9wKG1ldGEsIGRyb3BMb2NhdGlvbiwgZWwsIGV2LCB1aSk7CgkJCX0KCQl9KTsKCgkJZHJhZ0xpc3RlbmVyLnN0YXJ0RHJhZyhldik7IC8vIHN0YXJ0IGxpc3RlbmluZyBpbW1lZGlhdGVseQoJfSwKCgoJLy8gR2l2ZW4gYSBjZWxsIHRvIGJlIGRyb3BwZWQgdXBvbiwgYW5kIG1pc2MgZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIGpxdWkgZHJhZyAoZ3VhcmFudGVlZCB0byBiZSBhIHBsYWluIG9iamVjdCksCgkvLyByZXR1cm5zIHN0YXJ0L2VuZCBkYXRlcyBmb3IgdGhlIGV2ZW50IHRoYXQgd291bGQgcmVzdWx0IGZyb20gdGhlIGh5cG90aGV0aWNhbCBkcm9wLiBlbmQgbWlnaHQgYmUgbnVsbC4KCS8vIFJldHVybmluZyBhIG51bGwgdmFsdWUgc2lnbmFscyBhbiBpbnZhbGlkIGRyb3AgY2VsbC4KCWNvbXB1dGVFeHRlcm5hbERyb3A6IGZ1bmN0aW9uKGNlbGwsIG1ldGEpIHsKCQl2YXIgZHJvcExvY2F0aW9uID0gewoJCQlzdGFydDogY2VsbC5zdGFydC5jbG9uZSgpLAoJCQllbmQ6IG51bGwKCQl9OwoKCQkvLyBpZiBkcm9wcGVkIG9uIGFuIGFsbC1kYXkgY2VsbCwgYW5kIGVsZW1lbnQncyBtZXRhZGF0YSBzcGVjaWZpZWQgYSB0aW1lLCBzZXQgaXQKCQlpZiAobWV0YS5zdGFydFRpbWUgJiYgIWRyb3BMb2NhdGlvbi5zdGFydC5oYXNUaW1lKCkpIHsKCQkJZHJvcExvY2F0aW9uLnN0YXJ0LnRpbWUobWV0YS5zdGFydFRpbWUpOwoJCX0KCgkJaWYgKG1ldGEuZHVyYXRpb24pIHsKCQkJZHJvcExvY2F0aW9uLmVuZCA9IGRyb3BMb2NhdGlvbi5zdGFydC5jbG9uZSgpLmFkZChtZXRhLmR1cmF0aW9uKTsKCQl9CgoJCWlmICghdGhpcy52aWV3LmNhbGVuZGFyLmlzRXh0ZXJuYWxEcm9wUmFuZ2VBbGxvd2VkKGRyb3BMb2NhdGlvbiwgbWV0YS5ldmVudFByb3BzKSkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCXJldHVybiBkcm9wTG9jYXRpb247Cgl9LAoKCgoJLyogRHJhZyBSZW5kZXJpbmcgKGZvciBib3RoIGV2ZW50cyBhbmQgYW4gZXh0ZXJuYWwgZWxlbWVudHMpCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYW4gZXZlbnQgb3IgZXh0ZXJuYWwgZWxlbWVudCBiZWluZyBkcmFnZ2VkLgoJLy8gYGRyb3BMb2NhdGlvbmAgY29udGFpbnMgaHlwb3RoZXRpY2FsIHN0YXJ0L2VuZC9hbGxEYXkgdmFsdWVzIHRoZSBldmVudCB3b3VsZCBoYXZlIGlmIGRyb3BwZWQuIGVuZCBjYW4gYmUgbnVsbC4KCS8vIGBzZWdgIGlzIHRoZSBpbnRlcm5hbCBzZWdtZW50IG9iamVjdCB0aGF0IGlzIGJlaW5nIGRyYWdnZWQuIElmIGRyYWdnaW5nIGFuIGV4dGVybmFsIGVsZW1lbnQsIGBzZWdgIGlzIG51bGwuCgkvLyBBIHRydXRoeSByZXR1cm5lZCB2YWx1ZSBpbmRpY2F0ZXMgdGhpcyBtZXRob2QgaGFzIHJlbmRlcmVkIGEgaGVscGVyIGVsZW1lbnQuCglyZW5kZXJEcmFnOiBmdW5jdGlvbihkcm9wTG9jYXRpb24sIHNlZykgewoJCS8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQKCX0sCgoKCS8vIFVucmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGFuIGV2ZW50IG9yIGV4dGVybmFsIGVsZW1lbnQgYmVpbmcgZHJhZ2dlZAoJZGVzdHJveURyYWc6IGZ1bmN0aW9uKCkgewoJCS8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQKCX0sCgoKCS8qIFJlc2l6aW5nCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBDYWxsZWQgd2hlbiB0aGUgdXNlciBkb2VzIGEgbW91c2Vkb3duIG9uIGFuIGV2ZW50J3MgcmVzaXplciwgd2hpY2ggbWlnaHQgbGVhZCB0byByZXNpemluZy4KCS8vIEdlbmVyaWMgZW5vdWdoIHRvIHdvcmsgd2l0aCBhbnkgdHlwZSBvZiBHcmlkLgoJc2VnUmVzaXplTW91c2Vkb3duOiBmdW5jdGlvbihzZWcsIGV2KSB7CgkJdmFyIF90aGlzID0gdGhpczsKCQl2YXIgdmlldyA9IHRoaXMudmlldzsKCQl2YXIgY2FsZW5kYXIgPSB2aWV3LmNhbGVuZGFyOwoJCXZhciBlbCA9IHNlZy5lbDsKCQl2YXIgZXZlbnQgPSBzZWcuZXZlbnQ7CgkJdmFyIHN0YXJ0ID0gZXZlbnQuc3RhcnQ7CgkJdmFyIG9sZEVuZCA9IGNhbGVuZGFyLmdldEV2ZW50RW5kKGV2ZW50KTsKCQl2YXIgbmV3RW5kOyAvLyBmYWxzeSBpZiBpbnZhbGlkIHJlc2l6ZQoJCXZhciBkcmFnTGlzdGVuZXI7CgoJCWZ1bmN0aW9uIGRlc3Ryb3koKSB7IC8vIHJlc2V0cyB0aGUgcmVuZGVyaW5nIHRvIHNob3cgdGhlIG9yaWdpbmFsIGV2ZW50CgkJCV90aGlzLmRlc3Ryb3lFdmVudFJlc2l6ZSgpOwoJCQl2aWV3LnNob3dFdmVudChldmVudCk7CgkJCWVuYWJsZUN1cnNvcigpOwoJCX0KCgkJLy8gVHJhY2tzIG1vdXNlIG1vdmVtZW50IG92ZXIgdGhlICpncmlkJ3MqIGNvb3JkaW5hdGUgbWFwCgkJZHJhZ0xpc3RlbmVyID0gbmV3IERyYWdMaXN0ZW5lcih0aGlzLmNvb3JkTWFwLCB7CgkJCWRpc3RhbmNlOiA1LAoJCQlzY3JvbGw6IHZpZXcub3B0KCdkcmFnU2Nyb2xsJyksCgkJCWRyYWdTdGFydDogZnVuY3Rpb24oZXYpIHsKCQkJCV90aGlzLnRyaWdnZXJTZWdNb3VzZW91dChzZWcsIGV2KTsgLy8gZW5zdXJlIGEgbW91c2VvdXQgb24gdGhlIG1hbmlwdWxhdGVkIGV2ZW50IGhhcyBiZWVuIHJlcG9ydGVkCgkJCQlfdGhpcy5pc1Jlc2l6aW5nU2VnID0gdHJ1ZTsKCQkJCXZpZXcudHJpZ2dlcignZXZlbnRSZXNpemVTdGFydCcsIGVsWzBdLCBldmVudCwgZXYsIHt9KTsgLy8gbGFzdCBhcmd1bWVudCBpcyBqcXVpIGR1bW15CgkJCX0sCgkJCWNlbGxPdmVyOiBmdW5jdGlvbihjZWxsKSB7CgkJCQluZXdFbmQgPSBjZWxsLmVuZDsKCgkJCQlpZiAoIW5ld0VuZC5pc0FmdGVyKHN0YXJ0KSkgeyAvLyB3YXMgZW5kIG1vdmVkIGJlZm9yZSBzdGFydD8KCQkJCQluZXdFbmQgPSBzdGFydC5jbG9uZSgpLmFkZCggLy8gbWFrZSB0aGUgZXZlbnQgc3BhbiBhIHNpbmdsZSBzbG90CgkJCQkJCWRpZmZEYXlUaW1lKGNlbGwuZW5kLCBjZWxsLnN0YXJ0KSAvLyBhc3N1bWVzIGFsbCBzbG90IGR1cmF0aW9ucyBhcmUgdGhlIHNhbWUKCQkJCQkpOwoJCQkJfQoKCQkJCWlmIChuZXdFbmQuaXNTYW1lKG9sZEVuZCkpIHsKCQkJCQluZXdFbmQgPSBudWxsOwoJCQkJfQoJCQkJZWxzZSBpZiAoIWNhbGVuZGFyLmlzRXZlbnRSYW5nZUFsbG93ZWQoeyBzdGFydDogc3RhcnQsIGVuZDogbmV3RW5kIH0sIGV2ZW50KSkgewoJCQkJCW5ld0VuZCA9IG51bGw7CgkJCQkJZGlzYWJsZUN1cnNvcigpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJX3RoaXMucmVuZGVyRXZlbnRSZXNpemUoeyBzdGFydDogc3RhcnQsIGVuZDogbmV3RW5kIH0sIHNlZyk7CgkJCQkJdmlldy5oaWRlRXZlbnQoZXZlbnQpOwoJCQkJfQoJCQl9LAoJCQljZWxsT3V0OiBmdW5jdGlvbigpIHsgLy8gY2FsbGVkIGJlZm9yZSBtb3VzZSBtb3ZlcyB0byBhIGRpZmZlcmVudCBjZWxsIE9SIG1vdmVkIG91dCBvZiBhbGwgY2VsbHMKCQkJCW5ld0VuZCA9IG51bGw7CgkJCQlkZXN0cm95KCk7CgkJCX0sCgkJCWRyYWdTdG9wOiBmdW5jdGlvbihldikgewoJCQkJX3RoaXMuaXNSZXNpemluZ1NlZyA9IGZhbHNlOwoJCQkJZGVzdHJveSgpOwoJCQkJdmlldy50cmlnZ2VyKCdldmVudFJlc2l6ZVN0b3AnLCBlbFswXSwgZXZlbnQsIGV2LCB7fSk7IC8vIGxhc3QgYXJndW1lbnQgaXMganF1aSBkdW1teQoKCQkJCWlmIChuZXdFbmQpIHsgLy8gdmFsaWQgZGF0ZSB0byByZXNpemUgdG8\/CgkJCQkJdmlldy5yZXBvcnRFdmVudFJlc2l6ZShldmVudCwgbmV3RW5kLCBlbCwgZXYpOwoJCQkJfQoJCQl9CgkJfSk7CgoJCWRyYWdMaXN0ZW5lci5tb3VzZWRvd24oZXYpOyAvLyBzdGFydCBsaXN0ZW5pbmcsIHdoaWNoIHdpbGwgZXZlbnR1YWxseSBsZWFkIHRvIGEgZHJhZ1N0YXJ0Cgl9LAoKCgkvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYW4gZXZlbnQgYmVpbmcgcmVzaXplZC4KCS8vIGByYW5nZWAgaGFzIHRoZSB1cGRhdGVkIGRhdGVzIG9mIHRoZSBldmVudC4gYHNlZ2AgaXMgdGhlIG9yaWdpbmFsIHNlZ21lbnQgb2JqZWN0IGludm9sdmVkIGluIHRoZSBkcmFnLgoJcmVuZGVyRXZlbnRSZXNpemU6IGZ1bmN0aW9uKHJhbmdlLCBzZWcpIHsKCQkvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBiZWluZyByZXNpemVkLgoJZGVzdHJveUV2ZW50UmVzaXplOiBmdW5jdGlvbigpIHsKCQkvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50Cgl9LAoKCgkvKiBSZW5kZXJpbmcgVXRpbHMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIENvbXB1dGUgdGhlIHRleHQgdGhhdCBzaG91bGQgYmUgZGlzcGxheWVkIG9uIGFuIGV2ZW50J3MgZWxlbWVudC4KCS8vIGByYW5nZWAgY2FuIGJlIHRoZSBFdmVudCBvYmplY3QgaXRzZWxmLCBvciBzb21ldGhpbmcgcmFuZ2UtbGlrZSwgd2l0aCBhdCBsZWFzdCBhIGBzdGFydGAuCgkvLyBUaGUgYHRpbWVGb3JtYXRgIG9wdGlvbnMgYW5kIHRoZSBncmlkJ3MgZGVmYXVsdCBmb3JtYXQgaXMgdXNlZCwgYnV0IGBmb3JtYXRTdHJgIGNhbiBvdmVycmlkZS4KCWdldEV2ZW50VGltZVRleHQ6IGZ1bmN0aW9uKHJhbmdlLCBmb3JtYXRTdHIpIHsKCgkJZm9ybWF0U3RyID0gZm9ybWF0U3RyIHx8IHRoaXMuZXZlbnRUaW1lRm9ybWF0OwoKCQlpZiAocmFuZ2UuZW5kICYmIHRoaXMuZGlzcGxheUV2ZW50RW5kKSB7CgkJCXJldHVybiB0aGlzLnZpZXcuZm9ybWF0UmFuZ2UocmFuZ2UsIGZvcm1hdFN0cik7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gcmFuZ2Uuc3RhcnQuZm9ybWF0KGZvcm1hdFN0cik7CgkJfQoJfSwKCgoJLy8gR2VuZXJpYyB1dGlsaXR5IGZvciBnZW5lcmF0aW5nIHRoZSBIVE1MIGNsYXNzTmFtZXMgZm9yIGFuIGV2ZW50IHNlZ21lbnQncyBlbGVtZW50CglnZXRTZWdDbGFzc2VzOiBmdW5jdGlvbihzZWcsIGlzRHJhZ2dhYmxlLCBpc1Jlc2l6YWJsZSkgewoJCXZhciBldmVudCA9IHNlZy5ldmVudDsKCQl2YXIgY2xhc3NlcyA9IFsKCQkJJ2ZjLWV2ZW50JywKCQkJc2VnLmlzU3RhcnQgPyAnZmMtc3RhcnQnIDogJ2ZjLW5vdC1zdGFydCcsCgkJCXNlZy5pc0VuZCA\/ICdmYy1lbmQnIDogJ2ZjLW5vdC1lbmQnCgkJXS5jb25jYXQoCgkJCWV2ZW50LmNsYXNzTmFtZSwKCQkJZXZlbnQuc291cmNlID8gZXZlbnQuc291cmNlLmNsYXNzTmFtZSA6IFtdCgkJKTsKCgkJaWYgKGlzRHJhZ2dhYmxlKSB7CgkJCWNsYXNzZXMucHVzaCgnZmMtZHJhZ2dhYmxlJyk7CgkJfQoJCWlmIChpc1Jlc2l6YWJsZSkgewoJCQljbGFzc2VzLnB1c2goJ2ZjLXJlc2l6YWJsZScpOwoJCX0KCgkJcmV0dXJuIGNsYXNzZXM7Cgl9LAoKCgkvLyBVdGlsaXR5IGZvciBnZW5lcmF0aW5nIGEgQ1NTIHN0cmluZyB3aXRoIGFsbCB0aGUgZXZlbnQgc2tpbi1yZWxhdGVkIHByb3BlcnRpZXMKCWdldEV2ZW50U2tpbkNzczogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgdmlldyA9IHRoaXMudmlldzsKCQl2YXIgc291cmNlID0gZXZlbnQuc291cmNlIHx8IHt9OwoJCXZhciBldmVudENvbG9yID0gZXZlbnQuY29sb3I7CgkJdmFyIHNvdXJjZUNvbG9yID0gc291cmNlLmNvbG9yOwoJCXZhciBvcHRpb25Db2xvciA9IHZpZXcub3B0KCdldmVudENvbG9yJyk7CgkJdmFyIGJhY2tncm91bmRDb2xvciA9CgkJCWV2ZW50LmJhY2tncm91bmRDb2xvciB8fAoJCQlldmVudENvbG9yIHx8CgkJCXNvdXJjZS5iYWNrZ3JvdW5kQ29sb3IgfHwKCQkJc291cmNlQ29sb3IgfHwKCQkJdmlldy5vcHQoJ2V2ZW50QmFja2dyb3VuZENvbG9yJykgfHwKCQkJb3B0aW9uQ29sb3I7CgkJdmFyIGJvcmRlckNvbG9yID0KCQkJZXZlbnQuYm9yZGVyQ29sb3IgfHwKCQkJZXZlbnRDb2xvciB8fAoJCQlzb3VyY2UuYm9yZGVyQ29sb3IgfHwKCQkJc291cmNlQ29sb3IgfHwKCQkJdmlldy5vcHQoJ2V2ZW50Qm9yZGVyQ29sb3InKSB8fAoJCQlvcHRpb25Db2xvcjsKCQl2YXIgdGV4dENvbG9yID0KCQkJZXZlbnQudGV4dENvbG9yIHx8CgkJCXNvdXJjZS50ZXh0Q29sb3IgfHwKCQkJdmlldy5vcHQoJ2V2ZW50VGV4dENvbG9yJyk7CgkJdmFyIHN0YXRlbWVudHMgPSBbXTsKCQlpZiAoYmFja2dyb3VuZENvbG9yKSB7CgkJCXN0YXRlbWVudHMucHVzaCgnYmFja2dyb3VuZC1jb2xvcjonICsgYmFja2dyb3VuZENvbG9yKTsKCQl9CgkJaWYgKGJvcmRlckNvbG9yKSB7CgkJCXN0YXRlbWVudHMucHVzaCgnYm9yZGVyLWNvbG9yOicgKyBib3JkZXJDb2xvcik7CgkJfQoJCWlmICh0ZXh0Q29sb3IpIHsKCQkJc3RhdGVtZW50cy5wdXNoKCdjb2xvcjonICsgdGV4dENvbG9yKTsKCQl9CgkJcmV0dXJuIHN0YXRlbWVudHMuam9pbignOycpOwoJfSwKCgoJLyogQ29udmVydGluZyBldmVudHMgLT4gcmFuZ2VzIC0+IHNlZ3MKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIENvbnZlcnRzIGFuIGFycmF5IG9mIGV2ZW50IG9iamVjdHMgaW50byBhbiBhcnJheSBvZiBldmVudCBzZWdtZW50IG9iamVjdHMuCgkvLyBBIGN1c3RvbSBgcmFuZ2VUb1NlZ3NGdW5jYCBtYXkgYmUgZ2l2ZW4gZm9yIGFyYml0cmFyaWx5IHNsaWNpbmcgdXAgZXZlbnRzLgoJZXZlbnRzVG9TZWdzOiBmdW5jdGlvbihldmVudHMsIHJhbmdlVG9TZWdzRnVuYykgewoJCXZhciBldmVudFJhbmdlcyA9IHRoaXMuZXZlbnRzVG9SYW5nZXMoZXZlbnRzKTsKCQl2YXIgc2VncyA9IFtdOwoJCXZhciBpOwoKCQlmb3IgKGkgPSAwOyBpIDwgZXZlbnRSYW5nZXMubGVuZ3RoOyBpKyspIHsKCQkJc2Vncy5wdXNoLmFwcGx5KAoJCQkJc2VncywKCQkJCXRoaXMuZXZlbnRSYW5nZVRvU2VncyhldmVudFJhbmdlc1tpXSwgcmFuZ2VUb1NlZ3NGdW5jKQoJCQkpOwoJCX0KCgkJcmV0dXJuIHNlZ3M7Cgl9LAoKCgkvLyBDb252ZXJ0cyBhbiBhcnJheSBvZiBldmVudHMgaW50byBhbiBhcnJheSBvZiAicmFuZ2UiIG9iamVjdHMuCgkvLyBBICJyYW5nZSIgb2JqZWN0IGlzIGEgcGxhaW4gb2JqZWN0IHdpdGggc3RhcnQvZW5kIHByb3BlcnRpZXMgZGVub3RpbmcgdGhlIHRpbWUgaXQgY292ZXJzLiBBbHNvIGFuIGV2ZW50IHByb3BlcnR5LgoJLy8gRm9yICJub3JtYWwiIGV2ZW50cywgdGhpcyB3aWxsIGJlIGlkZW50aWNhbCB0byB0aGUgZXZlbnQncyBzdGFydC9lbmQsIGJ1dCBmb3IgImludmVyc2UtYmFja2dyb3VuZCIgZXZlbnRzLAoJLy8gd2lsbCBjcmVhdGUgYW4gYXJyYXkgb2YgcmFuZ2VzIHRoYXQgc3BhbiB0aGUgdGltZSAqbm90KiBjb3ZlcmVkIGJ5IHRoZSBnaXZlbiBldmVudC4KCWV2ZW50c1RvUmFuZ2VzOiBmdW5jdGlvbihldmVudHMpIHsKCQl2YXIgX3RoaXMgPSB0aGlzOwoJCXZhciBldmVudHNCeUlkID0gZ3JvdXBFdmVudHNCeUlkKGV2ZW50cyk7CgkJdmFyIHJhbmdlcyA9IFtdOwoKCQkvLyBncm91cCBieSBJRCBzbyB0aGF0IHJlbGF0ZWQgaW52ZXJzZS1iYWNrZ3JvdW5kIGV2ZW50cyBjYW4gYmUgcmVuZGVyZWQgdG9nZXRoZXIKCQkkLmVhY2goZXZlbnRzQnlJZCwgZnVuY3Rpb24oaWQsIGV2ZW50R3JvdXApIHsKCQkJaWYgKGV2ZW50R3JvdXAubGVuZ3RoKSB7CgkJCQlyYW5nZXMucHVzaC5hcHBseSgKCQkJCQlyYW5nZXMsCgkJCQkJaXNJbnZlcnNlQmdFdmVudChldmVudEdyb3VwWzBdKSA\/CgkJCQkJCV90aGlzLmV2ZW50c1RvSW52ZXJzZVJhbmdlcyhldmVudEdyb3VwKSA6CgkJCQkJCV90aGlzLmV2ZW50c1RvTm9ybWFsUmFuZ2VzKGV2ZW50R3JvdXApCgkJCQkpOwoJCQl9CgkJfSk7CgoJCXJldHVybiByYW5nZXM7Cgl9LAoKCgkvLyBDb252ZXJ0cyBhbiBhcnJheSBvZiAibm9ybWFsIiBldmVudHMgKG5vdCBpbnZlcnRlZCByZW5kZXJpbmcpIGludG8gYSBwYXJhbGxlbCBhcnJheSBvZiByYW5nZXMKCWV2ZW50c1RvTm9ybWFsUmFuZ2VzOiBmdW5jdGlvbihldmVudHMpIHsKCQl2YXIgY2FsZW5kYXIgPSB0aGlzLnZpZXcuY2FsZW5kYXI7CgkJdmFyIHJhbmdlcyA9IFtdOwoJCXZhciBpLCBldmVudDsKCQl2YXIgZXZlbnRTdGFydCwgZXZlbnRFbmQ7CgoJCWZvciAoaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHsKCQkJZXZlbnQgPSBldmVudHNbaV07CgoJCQkvLyBtYWtlIGNvcGllcyBhbmQgbm9ybWFsaXplIGJ5IHN0cmlwcGluZyB0aW1lem9uZQoJCQlldmVudFN0YXJ0ID0gZXZlbnQuc3RhcnQuY2xvbmUoKS5zdHJpcFpvbmUoKTsKCQkJZXZlbnRFbmQgPSBjYWxlbmRhci5nZXRFdmVudEVuZChldmVudCkuc3RyaXBab25lKCk7CgoJCQlyYW5nZXMucHVzaCh7CgkJCQlldmVudDogZXZlbnQsCgkJCQlzdGFydDogZXZlbnRTdGFydCwKCQkJCWVuZDogZXZlbnRFbmQsCgkJCQlldmVudFN0YXJ0TVM6ICtldmVudFN0YXJ0LAoJCQkJZXZlbnREdXJhdGlvbk1TOiBldmVudEVuZCAtIGV2ZW50U3RhcnQKCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmFuZ2VzOwoJfSwKCgoJLy8gQ29udmVydHMgYW4gYXJyYXkgb2YgZXZlbnRzLCB3aXRoIGludmVyc2UtYmFja2dyb3VuZCByZW5kZXJpbmcsIGludG8gYW4gYXJyYXkgb2YgcmFuZ2Ugb2JqZWN0cy4KCS8vIFRoZSByYW5nZSBvYmplY3RzIHdpbGwgY292ZXIgYWxsIHRoZSB0aW1lIE5PVCBjb3ZlcmVkIGJ5IHRoZSBldmVudHMuCglldmVudHNUb0ludmVyc2VSYW5nZXM6IGZ1bmN0aW9uKGV2ZW50cykgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciB2aWV3U3RhcnQgPSB2aWV3LnN0YXJ0LmNsb25lKCkuc3RyaXBab25lKCk7IC8vIG5vcm1hbGl6ZSB0aW1lem9uZQoJCXZhciB2aWV3RW5kID0gdmlldy5lbmQuY2xvbmUoKS5zdHJpcFpvbmUoKTsgLy8gbm9ybWFsaXplIHRpbWV6b25lCgkJdmFyIG5vcm1hbFJhbmdlcyA9IHRoaXMuZXZlbnRzVG9Ob3JtYWxSYW5nZXMoZXZlbnRzKTsgLy8gd2lsbCBnaXZlIHVzIG5vcm1hbGl6ZWQgZGF0ZXMgd2UgY2FuIHVzZSB3L28gY29waWVzCgkJdmFyIGludmVyc2VSYW5nZXMgPSBbXTsKCQl2YXIgZXZlbnQwID0gZXZlbnRzWzBdOyAvLyBhc3NpZ24gdGhpcyB0byBlYWNoIHJhbmdlJ3MgYC5ldmVudGAKCQl2YXIgc3RhcnQgPSB2aWV3U3RhcnQ7IC8vIHRoZSBlbmQgb2YgdGhlIHByZXZpb3VzIHJhbmdlLiB0aGUgc3RhcnQgb2YgdGhlIG5ldyByYW5nZQoJCXZhciBpLCBub3JtYWxSYW5nZTsKCgkJLy8gcmFuZ2VzIG5lZWQgdG8gYmUgaW4gb3JkZXIuIHJlcXVpcmVkIGZvciBvdXIgZGF0ZS13YWxraW5nIGFsZ29yaXRobQoJCW5vcm1hbFJhbmdlcy5zb3J0KGNvbXBhcmVOb3JtYWxSYW5nZXMpOwoKCQlmb3IgKGkgPSAwOyBpIDwgbm9ybWFsUmFuZ2VzLmxlbmd0aDsgaSsrKSB7CgkJCW5vcm1hbFJhbmdlID0gbm9ybWFsUmFuZ2VzW2ldOwoKCQkJLy8gYWRkIHRoZSBzcGFuIG9mIHRpbWUgYmVmb3JlIHRoZSBldmVudCAoaWYgdGhlcmUgaXMgYW55KQoJCQlpZiAobm9ybWFsUmFuZ2Uuc3RhcnQgPiBzdGFydCkgeyAvLyBjb21wYXJlIG1pbGxpc2Vjb25kIHRpbWUgKHNraXAgYW55IGFtYmlnIGxvZ2ljKQoJCQkJaW52ZXJzZVJhbmdlcy5wdXNoKHsKCQkJCQlldmVudDogZXZlbnQwLAoJCQkJCXN0YXJ0OiBzdGFydCwKCQkJCQllbmQ6IG5vcm1hbFJhbmdlLnN0YXJ0CgkJCQl9KTsKCQkJfQoKCQkJc3RhcnQgPSBub3JtYWxSYW5nZS5lbmQ7CgkJfQoKCQkvLyBhZGQgdGhlIHNwYW4gb2YgdGltZSBhZnRlciB0aGUgbGFzdCBldmVudCAoaWYgdGhlcmUgaXMgYW55KQoJCWlmIChzdGFydCA8IHZpZXdFbmQpIHsgLy8gY29tcGFyZSBtaWxsaXNlY29uZCB0aW1lIChza2lwIGFueSBhbWJpZyBsb2dpYykKCQkJaW52ZXJzZVJhbmdlcy5wdXNoKHsKCQkJCWV2ZW50OiBldmVudDAsCgkJCQlzdGFydDogc3RhcnQsCgkJCQllbmQ6IHZpZXdFbmQKCQkJfSk7CgkJfQoKCQlyZXR1cm4gaW52ZXJzZVJhbmdlczsKCX0sCgoKCS8vIFNsaWNlcyB0aGUgZ2l2ZW4gZXZlbnQgcmFuZ2UgaW50byBvbmUgb3IgbW9yZSBzZWdtZW50IG9iamVjdHMuCgkvLyBBIGByYW5nZVRvU2Vnc0Z1bmNgIGN1c3RvbSBzbGljaW5nIGZ1bmN0aW9uIGNhbiBiZSBnaXZlbi4KCWV2ZW50UmFuZ2VUb1NlZ3M6IGZ1bmN0aW9uKGV2ZW50UmFuZ2UsIHJhbmdlVG9TZWdzRnVuYykgewoJCXZhciBzZWdzOwoJCXZhciBpLCBzZWc7CgoJCWlmIChyYW5nZVRvU2Vnc0Z1bmMpIHsKCQkJc2VncyA9IHJhbmdlVG9TZWdzRnVuYyhldmVudFJhbmdlKTsKCQl9CgkJZWxzZSB7CgkJCXNlZ3MgPSB0aGlzLnJhbmdlVG9TZWdzKGV2ZW50UmFuZ2UpOyAvLyBkZWZpbmVkIGJ5IHRoZSBzdWJjbGFzcwoJCX0KCgkJZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsKCQkJc2VnID0gc2Vnc1tpXTsKCQkJc2VnLmV2ZW50ID0gZXZlbnRSYW5nZS5ldmVudDsKCQkJc2VnLmV2ZW50U3RhcnRNUyA9IGV2ZW50UmFuZ2UuZXZlbnRTdGFydE1TOwoJCQlzZWcuZXZlbnREdXJhdGlvbk1TID0gZXZlbnRSYW5nZS5ldmVudER1cmF0aW9uTVM7CgkJfQoKCQlyZXR1cm4gc2VnczsKCX0KCn0pOwoKCi8qIFV0aWxpdGllcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgpmdW5jdGlvbiBpc0JnRXZlbnQoZXZlbnQpIHsgLy8gcmV0dXJucyB0cnVlIGlmIGJhY2tncm91bmQgT1IgaW52ZXJzZS1iYWNrZ3JvdW5kCgl2YXIgcmVuZGVyaW5nID0gZ2V0RXZlbnRSZW5kZXJpbmcoZXZlbnQpOwoJcmV0dXJuIHJlbmRlcmluZyA9PT0gJ2JhY2tncm91bmQnIHx8IHJlbmRlcmluZyA9PT0gJ2ludmVyc2UtYmFja2dyb3VuZCc7Cn0KCgpmdW5jdGlvbiBpc0ludmVyc2VCZ0V2ZW50KGV2ZW50KSB7CglyZXR1cm4gZ2V0RXZlbnRSZW5kZXJpbmcoZXZlbnQpID09PSAnaW52ZXJzZS1iYWNrZ3JvdW5kJzsKfQoKCmZ1bmN0aW9uIGdldEV2ZW50UmVuZGVyaW5nKGV2ZW50KSB7CglyZXR1cm4gZmlyc3REZWZpbmVkKChldmVudC5zb3VyY2UgfHwge30pLnJlbmRlcmluZywgZXZlbnQucmVuZGVyaW5nKTsKfQoKCmZ1bmN0aW9uIGdyb3VwRXZlbnRzQnlJZChldmVudHMpIHsKCXZhciBldmVudHNCeUlkID0ge307Cgl2YXIgaSwgZXZlbnQ7CgoJZm9yIChpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykgewoJCWV2ZW50ID0gZXZlbnRzW2ldOwoJCShldmVudHNCeUlkW2V2ZW50Ll9pZF0gfHwgKGV2ZW50c0J5SWRbZXZlbnQuX2lkXSA9IFtdKSkucHVzaChldmVudCk7Cgl9CgoJcmV0dXJuIGV2ZW50c0J5SWQ7Cn0KCgovLyBBIGNtcCBmdW5jdGlvbiBmb3IgZGV0ZXJtaW5pbmcgd2hpY2ggbm9uLWludmVydGVkICJyYW5nZXMiIChzZWUgYWJvdmUpIGhhcHBlbiBlYXJsaWVyCmZ1bmN0aW9uIGNvbXBhcmVOb3JtYWxSYW5nZXMocmFuZ2UxLCByYW5nZTIpIHsKCXJldHVybiByYW5nZTEuZXZlbnRTdGFydE1TIC0gcmFuZ2UyLmV2ZW50U3RhcnRNUzsgLy8gZWFybGllciByYW5nZXMgZ28gZmlyc3QKfQoKCi8vIEEgY21wIGZ1bmN0aW9uIGZvciBkZXRlcm1pbmluZyB3aGljaCBzZWdtZW50cyBzaG91bGQgdGFrZSB2aXN1YWwgcHJpb3JpdHkKLy8gRE9FUyBOT1QgV09SSyBPTiBJTlZFUlRFRCBCQUNLR1JPVU5EIEVWRU5UUyBiZWNhdXNlIHRoZXkgaGF2ZSBubyBldmVudFN0YXJ0TVMvZXZlbnREdXJhdGlvbk1TCmZ1bmN0aW9uIGNvbXBhcmVTZWdzKHNlZzEsIHNlZzIpIHsKCXJldHVybiBzZWcxLmV2ZW50U3RhcnRNUyAtIHNlZzIuZXZlbnRTdGFydE1TIHx8IC8vIGVhcmxpZXIgZXZlbnRzIGdvIGZpcnN0CgkJc2VnMi5ldmVudER1cmF0aW9uTVMgLSBzZWcxLmV2ZW50RHVyYXRpb25NUyB8fCAvLyB0aWU\/IGxvbmdlciBldmVudHMgZ28gZmlyc3QKCQlzZWcyLmV2ZW50LmFsbERheSAtIHNlZzEuZXZlbnQuYWxsRGF5IHx8IC8vIHRpZT8gcHV0IGFsbC1kYXkgZXZlbnRzIGZpcnN0IChib29sZWFucyBjYXN0IHRvIDAvMSkKCQkoc2VnMS5ldmVudC50aXRsZSB8fCAnJykubG9jYWxlQ29tcGFyZShzZWcyLmV2ZW50LnRpdGxlKTsgLy8gdGllPyBhbHBoYWJldGljYWxseSBieSB0aXRsZQp9CgpmYy5jb21wYXJlU2VncyA9IGNvbXBhcmVTZWdzOyAvLyBleHBvcnQKCgovKiBFeHRlcm5hbC1EcmFnZ2luZy1FbGVtZW50IERhdGEKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgovLyBSZXF1aXJlIGFsbCBIVE1MNSBkYXRhLSogYXR0cmlidXRlcyB1c2VkIGJ5IEZ1bGxDYWxlbmRhciB0byBoYXZlIHRoaXMgcHJlZml4LgovLyBBIHZhbHVlIG9mICcnIHdpbGwgcXVlcnkgYXR0cmlidXRlcyBsaWtlIGRhdGEtZXZlbnQuIEEgdmFsdWUgb2YgJ2ZjJyB3aWxsIHF1ZXJ5IGF0dHJpYnV0ZXMgbGlrZSBkYXRhLWZjLWV2ZW50LgpmYy5kYXRhQXR0clByZWZpeCA9ICcnOwoKLy8gR2l2ZW4gYSBqUXVlcnkgZWxlbWVudCB0aGF0IG1pZ2h0IHJlcHJlc2VudCBhIGRyYWdnZWQgRnVsbENhbGVuZGFyIGV2ZW50LCByZXR1cm5zIGFuIGludGVybWVkaWF0ZSBkYXRhIHN0cnVjdHVyZQovLyB0byBiZSB1c2VkIGZvciBFdmVudCBPYmplY3QgY3JlYXRpb24uCi8vIEEgZGVmaW5lZCBgLmV2ZW50UHJvcHNgLCBldmVuIHdoZW4gZW1wdHksIGluZGljYXRlcyB0aGF0IGFuIGV2ZW50IHNob3VsZCBiZSBjcmVhdGVkLgpmdW5jdGlvbiBnZXREcmFnZ2VkRWxNZXRhKGVsKSB7Cgl2YXIgcHJlZml4ID0gZmMuZGF0YUF0dHJQcmVmaXg7Cgl2YXIgZXZlbnRQcm9wczsgLy8gcHJvcGVydGllcyBmb3IgY3JlYXRpbmcgdGhlIGV2ZW50LCBub3QgcmVsYXRlZCB0byBkYXRlL3RpbWUKCXZhciBzdGFydFRpbWU7IC8vIGEgRHVyYXRpb24KCXZhciBkdXJhdGlvbjsKCXZhciBzdGljazsKCglpZiAocHJlZml4KSB7IHByZWZpeCArPSAnLSc7IH0KCWV2ZW50UHJvcHMgPSBlbC5kYXRhKHByZWZpeCArICdldmVudCcpIHx8IG51bGw7CgoJaWYgKGV2ZW50UHJvcHMpIHsKCQlpZiAodHlwZW9mIGV2ZW50UHJvcHMgPT09ICdvYmplY3QnKSB7CgkJCWV2ZW50UHJvcHMgPSAkLmV4dGVuZCh7fSwgZXZlbnRQcm9wcyk7IC8vIG1ha2UgYSBjb3B5CgkJfQoJCWVsc2UgeyAvLyBzb21ldGhpbmcgbGlrZSAxIG9yIHRydWUuIHN0aWxsIHNpZ25hbCBldmVudCBjcmVhdGlvbgoJCQlldmVudFByb3BzID0ge307CgkJfQoKCQkvLyBwbHVjayBzcGVjaWFsLWNhc2VkIGRhdGUvdGltZSBwcm9wZXJ0aWVzCgkJc3RhcnRUaW1lID0gZXZlbnRQcm9wcy5zdGFydDsKCQlpZiAoc3RhcnRUaW1lID09IG51bGwpIHsgc3RhcnRUaW1lID0gZXZlbnRQcm9wcy50aW1lOyB9IC8vIGFjY2VwdCAndGltZScgYXMgd2VsbAoJCWR1cmF0aW9uID0gZXZlbnRQcm9wcy5kdXJhdGlvbjsKCQlzdGljayA9IGV2ZW50UHJvcHMuc3RpY2s7CgkJZGVsZXRlIGV2ZW50UHJvcHMuc3RhcnQ7CgkJZGVsZXRlIGV2ZW50UHJvcHMudGltZTsKCQlkZWxldGUgZXZlbnRQcm9wcy5kdXJhdGlvbjsKCQlkZWxldGUgZXZlbnRQcm9wcy5zdGljazsKCX0KCgkvLyBmYWxsYmFjayB0byBzdGFuZGFsb25lIGF0dHJpYnV0ZSB2YWx1ZXMgZm9yIGVhY2ggb2YgdGhlIGRhdGUvdGltZSBwcm9wZXJ0aWVzCglpZiAoc3RhcnRUaW1lID09IG51bGwpIHsgc3RhcnRUaW1lID0gZWwuZGF0YShwcmVmaXggKyAnc3RhcnQnKTsgfQoJaWYgKHN0YXJ0VGltZSA9PSBudWxsKSB7IHN0YXJ0VGltZSA9IGVsLmRhdGEocHJlZml4ICsgJ3RpbWUnKTsgfSAvLyBhY2NlcHQgJ3RpbWUnIGFzIHdlbGwKCWlmIChkdXJhdGlvbiA9PSBudWxsKSB7IGR1cmF0aW9uID0gZWwuZGF0YShwcmVmaXggKyAnZHVyYXRpb24nKTsgfQoJaWYgKHN0aWNrID09IG51bGwpIHsgc3RpY2sgPSBlbC5kYXRhKHByZWZpeCArICdzdGljaycpOyB9CgoJLy8gbWFzc2FnZSBpbnRvIGNvcnJlY3QgZGF0YSB0eXBlcwoJc3RhcnRUaW1lID0gc3RhcnRUaW1lICE9IG51bGwgPyBtb21lbnQuZHVyYXRpb24oc3RhcnRUaW1lKSA6IG51bGw7CglkdXJhdGlvbiA9IGR1cmF0aW9uICE9IG51bGwgPyBtb21lbnQuZHVyYXRpb24oZHVyYXRpb24pIDogbnVsbDsKCXN0aWNrID0gQm9vbGVhbihzdGljayk7CgoJcmV0dXJuIHsgZXZlbnRQcm9wczogZXZlbnRQcm9wcywgc3RhcnRUaW1lOiBzdGFydFRpbWUsIGR1cmF0aW9uOiBkdXJhdGlvbiwgc3RpY2s6IHN0aWNrIH07Cn0KCgo7OwoKLyogQSBjb21wb25lbnQgdGhhdCByZW5kZXJzIGEgZ3JpZCBvZiB3aG9sZS1kYXlzIHRoYXQgcnVucyBob3Jpem9udGFsbHkuIFRoZXJlIGNhbiBiZSBtdWx0aXBsZSByb3dzLCBvbmUgcGVyIHdlZWsuCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKdmFyIERheUdyaWQgPSBHcmlkLmV4dGVuZCh7CgoJbnVtYmVyc1Zpc2libGU6IGZhbHNlLCAvLyBzaG91bGQgcmVuZGVyIGEgcm93IGZvciBkYXkvd2VlayBudW1iZXJzPyBzZXQgYnkgb3V0c2lkZSB2aWV3LiBUT0RPOiBtYWtlIGludGVybmFsCglib3R0b21Db29yZFBhZGRpbmc6IDAsIC8vIGhhY2sgZm9yIGV4dGVuZGluZyB0aGUgaGl0IGFyZWEgZm9yIHRoZSBsYXN0IHJvdyBvZiB0aGUgY29vcmRpbmF0ZSBncmlkCglicmVha09uV2Vla3M6IG51bGwsIC8vIHNob3VsZCBjcmVhdGUgYSBuZXcgcm93IGZvciBlYWNoIHdlZWs\/IHNldCBieSBvdXRzaWRlIHZpZXcKCgljZWxsRGF0ZXM6IG51bGwsIC8vIGZsYXQgY2hyb25vbG9naWNhbCBhcnJheSBvZiBlYWNoIGNlbGwncyBkYXRlcwoJZGF5VG9DZWxsT2Zmc2V0czogbnVsbCwgLy8gbWFwcyBkYXlzIG9mZnNldHMgZnJvbSBncmlkJ3Mgc3RhcnQgZGF0ZSwgdG8gY2VsbCBvZmZzZXRzCgoJcm93RWxzOiBudWxsLCAvLyBzZXQgb2YgZmFrZSByb3cgZWxlbWVudHMKCWRheUVsczogbnVsbCwgLy8gc2V0IG9mIHdob2xlLWRheSBlbGVtZW50cyBjb21wcmlzaW5nIHRoZSByb3cncyBiYWNrZ3JvdW5kCgloZWxwZXJFbHM6IG51bGwsIC8vIHNldCBvZiBjZWxsIHNrZWxldG9uIGVsZW1lbnRzIGZvciByZW5kZXJpbmcgdGhlIG1vY2sgZXZlbnQgImhlbHBlciIKCgoJLy8gUmVuZGVycyB0aGUgcm93cyBhbmQgY29sdW1ucyBpbnRvIHRoZSBjb21wb25lbnQncyBgdGhpcy5lbGAsIHdoaWNoIHNob3VsZCBhbHJlYWR5IGJlIGFzc2lnbmVkLgoJLy8gaXNSaWdpZCBkZXRlcm1pbnMgd2hldGhlciB0aGUgaW5kaXZpZHVhbCByb3dzIHNob3VsZCBpZ25vcmUgdGhlIGNvbnRlbnRzIGFuZCBiZSBhIGNvbnN0YW50IGhlaWdodC4KCS8vIFJlbGllcyBvbiB0aGUgdmlldydzIGNvbENudCBhbmQgcm93Q250LiBJbiB0aGUgZnV0dXJlLCB0aGlzIGNvbXBvbmVudCBzaG91bGQgcHJvYmFibHkgYmUgc2VsZi1zdWZmaWNpZW50LgoJcmVuZGVyOiBmdW5jdGlvbihpc1JpZ2lkKSB7CgkJdmFyIHZpZXcgPSB0aGlzLnZpZXc7CgkJdmFyIHJvd0NudCA9IHRoaXMucm93Q250OwoJCXZhciBjb2xDbnQgPSB0aGlzLmNvbENudDsKCQl2YXIgY2VsbENudCA9IHJvd0NudCAqIGNvbENudDsKCQl2YXIgaHRtbCA9ICcnOwoJCXZhciByb3c7CgkJdmFyIGksIGNlbGw7CgoJCWZvciAocm93ID0gMDsgcm93IDwgcm93Q250OyByb3crKykgewoJCQlodG1sICs9IHRoaXMuZGF5Um93SHRtbChyb3csIGlzUmlnaWQpOwoJCX0KCQl0aGlzLmVsLmh0bWwoaHRtbCk7CgoJCXRoaXMucm93RWxzID0gdGhpcy5lbC5maW5kKCcuZmMtcm93Jyk7CgkJdGhpcy5kYXlFbHMgPSB0aGlzLmVsLmZpbmQoJy5mYy1kYXknKTsKCgkJLy8gdHJpZ2dlciBkYXlSZW5kZXIgd2l0aCBlYWNoIGNlbGwncyBlbGVtZW50CgkJZm9yIChpID0gMDsgaSA8IGNlbGxDbnQ7IGkrKykgewoJCQljZWxsID0gdGhpcy5nZXRDZWxsKGkpOwoJCQl2aWV3LnRyaWdnZXIoJ2RheVJlbmRlcicsIG51bGwsIGNlbGwuc3RhcnQsIHRoaXMuZGF5RWxzLmVxKGkpKTsKCQl9CgoJCUdyaWQucHJvdG90eXBlLnJlbmRlci5jYWxsKHRoaXMpOyAvLyBjYWxsIHRoZSBzdXBlci1tZXRob2QKCX0sCgoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZGVzdHJveVNlZ1BvcG92ZXIoKTsKCQlHcmlkLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7IC8vIGNhbGwgdGhlIHN1cGVyLW1ldGhvZAoJfSwKCgoJLy8gR2VuZXJhdGVzIHRoZSBIVE1MIGZvciBhIHNpbmdsZSByb3cuIGByb3dgIGlzIHRoZSByb3cgbnVtYmVyLgoJZGF5Um93SHRtbDogZnVuY3Rpb24ocm93LCBpc1JpZ2lkKSB7CgkJdmFyIHZpZXcgPSB0aGlzLnZpZXc7CgkJdmFyIGNsYXNzZXMgPSBbICdmYy1yb3cnLCAnZmMtd2VlaycsIHZpZXcud2lkZ2V0Q29udGVudENsYXNzIF07CgoJCWlmIChpc1JpZ2lkKSB7CgkJCWNsYXNzZXMucHVzaCgnZmMtcmlnaWQnKTsKCQl9CgoJCXJldHVybiAnJyArCgkJCSc8ZGl2IGNsYXNzPSInICsgY2xhc3Nlcy5qb2luKCcgJykgKyAnIj4nICsKCQkJCSc8ZGl2IGNsYXNzPSJmYy1iZyI+JyArCgkJCQkJJzx0YWJsZT4nICsKCQkJCQkJdGhpcy5yb3dIdG1sKCdkYXknLCByb3cpICsgLy8gbGV2ZXJhZ2VzIFJvd1JlbmRlcmVyLiBjYWxscyBkYXlDZWxsSHRtbCgpCgkJCQkJJzwvdGFibGU+JyArCgkJCQknPC9kaXY+JyArCgkJCQknPGRpdiBjbGFzcz0iZmMtY29udGVudC1za2VsZXRvbiI+JyArCgkJCQkJJzx0YWJsZT4nICsKCQkJCQkJKHRoaXMubnVtYmVyc1Zpc2libGUgPwoJCQkJCQkJJzx0aGVhZD4nICsKCQkJCQkJCQl0aGlzLnJvd0h0bWwoJ251bWJlcicsIHJvdykgKyAvLyBsZXZlcmFnZXMgUm93UmVuZGVyZXIuIFZpZXcgd2lsbCBkZWZpbmUgcmVuZGVyIG1ldGhvZAoJCQkJCQkJJzwvdGhlYWQ+JyA6CgkJCQkJCQknJwoJCQkJCQkJKSArCgkJCQkJJzwvdGFibGU+JyArCgkJCQknPC9kaXY+JyArCgkJCSc8L2Rpdj4nOwoJfSwKCgoJLy8gUmVuZGVycyB0aGUgSFRNTCBmb3IgYSB3aG9sZS1kYXkgY2VsbC4gV2lsbCBldmVudHVhbGx5IGVuZCB1cCBpbiB0aGUgZGF5LXJvdydzIGJhY2tncm91bmQuCgkvLyBXZSBnbyB0aHJvdWdoIGEgJ2RheScgcm93IHR5cGUgaW5zdGVhZCBvZiBqdXN0IGRvaW5nIGEgJ2JnJyByb3cgdHlwZSBzbyB0aGF0IHRoZSBWaWV3IGNhbiBkbyBjdXN0b20gcmVuZGVyaW5nCgkvLyBzcGVjaWZpY2FsbHkgZm9yIHdob2xlLWRheSByb3dzLCB3aGVyZWFzIGEgJ2JnJyBtaWdodCBhbHNvIGJlIHVzZWQgZm9yIG90aGVyIHB1cnBvc2VzIChUaW1lR3JpZCBiZyBmb3IgZXhhbXBsZSkuCglkYXlDZWxsSHRtbDogZnVuY3Rpb24oY2VsbCkgewoJCXJldHVybiB0aGlzLmJnQ2VsbEh0bWwoY2VsbCk7Cgl9LAoKCgkvKiBPcHRpb25zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBDb21wdXRlcyBhIGRlZmF1bHQgY29sdW1uIGhlYWRlciBmb3JtYXR0aW5nIHN0cmluZyBpZiBgY29sRm9ybWF0YCBpcyBub3QgZXhwbGljaXRseSBkZWZpbmVkCgljb21wdXRlQ29sSGVhZEZvcm1hdDogZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMucm93Q250ID4gMSkgeyAvLyBtb3JlIHRoYW4gb25lIHdlZWsgcm93LiBkYXkgbnVtYmVycyB3aWxsIGJlIGluIGVhY2ggY2VsbAoJCQlyZXR1cm4gJ2RkZCc7IC8vICJTYXQiCgkJfQoJCWVsc2UgaWYgKHRoaXMuY29sQ250ID4gMSkgeyAvLyBtdWx0aXBsZSBkYXlzLCBzbyBmdWxsIHNpbmdsZSBkYXRlIHN0cmluZyBXT04nVCBiZSBpbiB0aXRsZSB0ZXh0CgkJCXJldHVybiB0aGlzLnZpZXcub3B0KCdkYXlPZk1vbnRoRm9ybWF0Jyk7IC8vICJTYXQgMTIvMTAiCgkJfQoJCWVsc2UgeyAvLyBzaW5nbGUgZGF5LCBzbyBmdWxsIHNpbmdsZSBkYXRlIHN0cmluZyB3aWxsIHByb2JhYmx5IGJlIGluIHRpdGxlIHRleHQKCQkJcmV0dXJuICdkZGRkJzsgLy8gIlNhdHVyZGF5IgoJCX0KCX0sCgoKCS8vIENvbXB1dGVzIGEgZGVmYXVsdCBldmVudCB0aW1lIGZvcm1hdHRpbmcgc3RyaW5nIGlmIGB0aW1lRm9ybWF0YCBpcyBub3QgZXhwbGljaXRseSBkZWZpbmVkCgljb21wdXRlRXZlbnRUaW1lRm9ybWF0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy52aWV3Lm9wdCgnZXh0cmFTbWFsbFRpbWVGb3JtYXQnKTsgLy8gbGlrZSAiNnAiIG9yICI2OjMwcCIKCX0sCgoKCS8vIENvbXB1dGVzIGEgZGVmYXVsdCBgZGlzcGxheUV2ZW50RW5kYCB2YWx1ZSBpZiBvbmUgaXMgbm90IGV4cGxpY2x0eSBkZWZpbmVkCgljb21wdXRlRGlzcGxheUV2ZW50RW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5jb2xDbnQgPT0gMTsgLy8gd2UnbGwgbGlrZWx5IGhhdmUgc3BhY2UgaWYgdGhlcmUncyBvbmx5IG9uZSBkYXkKCX0sCgoKCS8qIENlbGwgU3lzdGVtCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBJbml0aWFsaXplcyByb3cvY29sIGluZm9ybWF0aW9uCgl1cGRhdGVDZWxsczogZnVuY3Rpb24oKSB7CgkJdmFyIGNlbGxEYXRlczsKCQl2YXIgZmlyc3REYXk7CgkJdmFyIHJvd0NudDsKCQl2YXIgY29sQ250OwoKCQl0aGlzLnVwZGF0ZUNlbGxEYXRlcygpOyAvLyBwb3B1bGF0ZXMgY2VsbERhdGVzIGFuZCBkYXlUb0NlbGxPZmZzZXRzCgkJY2VsbERhdGVzID0gdGhpcy5jZWxsRGF0ZXM7CgoJCWlmICh0aGlzLmJyZWFrT25XZWVrcykgewoJCQkvLyBjb3VudCBjb2x1bW5zIHVudGlsIHRoZSBkYXktb2Ytd2VlayByZXBlYXRzCgkJCWZpcnN0RGF5ID0gY2VsbERhdGVzWzBdLmRheSgpOwoJCQlmb3IgKGNvbENudCA9IDE7IGNvbENudCA8IGNlbGxEYXRlcy5sZW5ndGg7IGNvbENudCsrKSB7CgkJCQlpZiAoY2VsbERhdGVzW2NvbENudF0uZGF5KCkgPT0gZmlyc3REYXkpIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQlyb3dDbnQgPSBNYXRoLmNlaWwoY2VsbERhdGVzLmxlbmd0aCAvIGNvbENudCk7CgkJfQoJCWVsc2UgewoJCQlyb3dDbnQgPSAxOwoJCQljb2xDbnQgPSBjZWxsRGF0ZXMubGVuZ3RoOwoJCX0KCgkJdGhpcy5yb3dDbnQgPSByb3dDbnQ7CgkJdGhpcy5jb2xDbnQgPSBjb2xDbnQ7Cgl9LAoKCgkvLyBQb3B1bGF0ZXMgY2VsbERhdGVzIGFuZCBkYXlUb0NlbGxPZmZzZXRzCgl1cGRhdGVDZWxsRGF0ZXM6IGZ1bmN0aW9uKCkgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBkYXRlID0gdGhpcy5zdGFydC5jbG9uZSgpOwoJCXZhciBkYXRlcyA9IFtdOwoJCXZhciBvZmZzZXQgPSAtMTsKCQl2YXIgb2Zmc2V0cyA9IFtdOwoKCQl3aGlsZSAoZGF0ZS5pc0JlZm9yZSh0aGlzLmVuZCkpIHsgLy8gbG9vcCBlYWNoIGRheSBmcm9tIHN0YXJ0IHRvIGVuZAoJCQlpZiAodmlldy5pc0hpZGRlbkRheShkYXRlKSkgewoJCQkJb2Zmc2V0cy5wdXNoKG9mZnNldCArIDAuNSk7IC8vIG1hcmsgdGhhdCBpdCdzIGJldHdlZW4gb2Zmc2V0cwoJCQl9CgkJCWVsc2UgewoJCQkJb2Zmc2V0Kys7CgkJCQlvZmZzZXRzLnB1c2gob2Zmc2V0KTsKCQkJCWRhdGVzLnB1c2goZGF0ZS5jbG9uZSgpKTsKCQkJfQoJCQlkYXRlLmFkZCgxLCAnZGF5cycpOwoJCX0KCgkJdGhpcy5jZWxsRGF0ZXMgPSBkYXRlczsKCQl0aGlzLmRheVRvQ2VsbE9mZnNldHMgPSBvZmZzZXRzOwoJfSwKCgoJLy8gR2l2ZW4gYSBjZWxsIG9iamVjdCwgZ2VuZXJhdGVzIGEgcmFuZ2Ugb2JqZWN0Cgljb21wdXRlQ2VsbFJhbmdlOiBmdW5jdGlvbihjZWxsKSB7CgkJdmFyIGNvbENudCA9IHRoaXMuY29sQ250OwoJCXZhciBpbmRleCA9IGNlbGwucm93ICogY29sQ250ICsgKHRoaXMuaXNSVEwgPyBjb2xDbnQgLSBjZWxsLmNvbCAtIDEgOiBjZWxsLmNvbCk7CgkJdmFyIHN0YXJ0ID0gdGhpcy5jZWxsRGF0ZXNbaW5kZXhdLmNsb25lKCk7CgkJdmFyIGVuZCA9IHN0YXJ0LmNsb25lKCkuYWRkKDEsICdkYXknKTsKCgkJcmV0dXJuIHsgc3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZCB9OwoJfSwKCgoJLy8gUmV0cmlldmVzIHRoZSBlbGVtZW50IHJlcHJlc2VudGluZyB0aGUgZ2l2ZW4gcm93CglnZXRSb3dFbDogZnVuY3Rpb24ocm93KSB7CgkJcmV0dXJuIHRoaXMucm93RWxzLmVxKHJvdyk7Cgl9LAoKCgkvLyBSZXRyaWV2ZXMgdGhlIGVsZW1lbnQgcmVwcmVzZW50aW5nIHRoZSBnaXZlbiBjb2x1bW4KCWdldENvbEVsOiBmdW5jdGlvbihjb2wpIHsKCQlyZXR1cm4gdGhpcy5kYXlFbHMuZXEoY29sKTsKCX0sCgoKCS8vIEdldHMgdGhlIHdob2xlLWRheSBlbGVtZW50IGFzc29jaWF0ZWQgd2l0aCB0aGUgY2VsbAoJZ2V0Q2VsbERheUVsOiBmdW5jdGlvbihjZWxsKSB7CgkJcmV0dXJuIHRoaXMuZGF5RWxzLmVxKGNlbGwucm93ICogdGhpcy5jb2xDbnQgKyBjZWxsLmNvbCk7Cgl9LAoKCgkvLyBPdmVycmlkZXMgR3JpZCdzIG1ldGhvZCBmb3Igd2hlbiByb3cgY29vcmRpbmF0ZXMgYXJlIGNvbXB1dGVkCgljb21wdXRlUm93Q29vcmRzOiBmdW5jdGlvbigpIHsKCQl2YXIgcm93Q29vcmRzID0gR3JpZC5wcm90b3R5cGUuY29tcHV0ZVJvd0Nvb3Jkcy5jYWxsKHRoaXMpOyAvLyBjYWxsIHRoZSBzdXBlci1tZXRob2QKCgkJLy8gaGFjayBmb3IgZXh0ZW5kaW5nIGxhc3Qgcm93ICh1c2VkIGJ5IEFnZW5kYVZpZXcpCgkJcm93Q29vcmRzW3Jvd0Nvb3Jkcy5sZW5ndGggLSAxXS5ib3R0b20gKz0gdGhpcy5ib3R0b21Db29yZFBhZGRpbmc7CgoJCXJldHVybiByb3dDb29yZHM7Cgl9LAoKCgkvKiBEYXRlcwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gU2xpY2VzIHVwIGEgZGF0ZSByYW5nZSBieSByb3cgaW50byBhbiBhcnJheSBvZiBzZWdtZW50cwoJcmFuZ2VUb1NlZ3M6IGZ1bmN0aW9uKHJhbmdlKSB7CgkJdmFyIGlzUlRMID0gdGhpcy5pc1JUTDsKCQl2YXIgcm93Q250ID0gdGhpcy5yb3dDbnQ7CgkJdmFyIGNvbENudCA9IHRoaXMuY29sQ250OwoJCXZhciBzZWdzID0gW107CgkJdmFyIGZpcnN0LCBsYXN0OyAvLyBpbmNsdXNpdmUgY2VsbC1vZmZzZXQgcmFuZ2UgZm9yIGdpdmVuIHJhbmdlCgkJdmFyIHJvdzsKCQl2YXIgcm93Rmlyc3QsIHJvd0xhc3Q7IC8vIGluY2x1c2l2ZSBjZWxsLW9mZnNldCByYW5nZSBmb3IgY3VycmVudCByb3cKCQl2YXIgaXNTdGFydCwgaXNFbmQ7CgkJdmFyIHNlZ0ZpcnN0LCBzZWdMYXN0OyAvLyBpbmNsdXNpdmUgY2VsbC1vZmZzZXQgcmFuZ2UgZm9yIHNlZ21lbnQKCQl2YXIgc2VnOwoKCQlyYW5nZSA9IHRoaXMudmlldy5jb21wdXRlRGF5UmFuZ2UocmFuZ2UpOyAvLyBtYWtlIHdob2xlLWRheSByYW5nZSwgY29uc2lkZXJpbmcgbmV4dERheVRocmVzaG9sZAoJCWZpcnN0ID0gdGhpcy5kYXRlVG9DZWxsT2Zmc2V0KHJhbmdlLnN0YXJ0KTsKCQlsYXN0ID0gdGhpcy5kYXRlVG9DZWxsT2Zmc2V0KHJhbmdlLmVuZC5zdWJ0cmFjdCgxLCAnZGF5cycpKTsgLy8gb2Zmc2V0IG9mIGluY2x1c2l2ZSBlbmQgZGF0ZQoKCQlmb3IgKHJvdyA9IDA7IHJvdyA8IHJvd0NudDsgcm93KyspIHsKCQkJcm93Rmlyc3QgPSByb3cgKiBjb2xDbnQ7CgkJCXJvd0xhc3QgPSByb3dGaXJzdCArIGNvbENudCAtIDE7CgoJCQkvLyBpbnRlcnNlY3Qgc2VnbWVudCdzIG9mZnNldCByYW5nZSB3aXRoIHRoZSByb3cncwoJCQlzZWdGaXJzdCA9IE1hdGgubWF4KHJvd0ZpcnN0LCBmaXJzdCk7CgkJCXNlZ0xhc3QgPSBNYXRoLm1pbihyb3dMYXN0LCBsYXN0KTsKCgkJCS8vIGRlYWwgd2l0aCBpbi1iZXR3ZWVuIGluZGljZXMKCQkJc2VnRmlyc3QgPSBNYXRoLmNlaWwoc2VnRmlyc3QpOyAvLyBpbi1iZXR3ZWVuIHN0YXJ0cyByb3VuZCB0byBuZXh0IGNlbGwKCQkJc2VnTGFzdCA9IE1hdGguZmxvb3Ioc2VnTGFzdCk7IC8vIGluLWJldHdlZW4gZW5kcyByb3VuZCB0byBwcmV2IGNlbGwKCgkJCWlmIChzZWdGaXJzdCA8PSBzZWdMYXN0KSB7IC8vIHdhcyB0aGVyZSBhbnkgaW50ZXJzZWN0aW9uIHdpdGggdGhlIGN1cnJlbnQgcm93PwoKCQkJCS8vIG11c3QgYmUgbWF0Y2hpbmcgaW50ZWdlcnMgdG8gYmUgdGhlIHNlZ21lbnQncyBzdGFydC9lbmQKCQkJCWlzU3RhcnQgPSBzZWdGaXJzdCA9PT0gZmlyc3Q7CgkJCQlpc0VuZCA9IHNlZ0xhc3QgPT09IGxhc3Q7CgoJCQkJLy8gdHJhbnNsYXRlIG9mZnNldHMgdG8gYmUgcmVsYXRpdmUgdG8gc3RhcnQtb2Ytcm93CgkJCQlzZWdGaXJzdCAtPSByb3dGaXJzdDsKCQkJCXNlZ0xhc3QgLT0gcm93Rmlyc3Q7CgoJCQkJc2VnID0geyByb3c6IHJvdywgaXNTdGFydDogaXNTdGFydCwgaXNFbmQ6IGlzRW5kIH07CgkJCQlpZiAoaXNSVEwpIHsKCQkJCQlzZWcubGVmdENvbCA9IGNvbENudCAtIHNlZ0xhc3QgLSAxOwoJCQkJCXNlZy5yaWdodENvbCA9IGNvbENudCAtIHNlZ0ZpcnN0IC0gMTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCXNlZy5sZWZ0Q29sID0gc2VnRmlyc3Q7CgkJCQkJc2VnLnJpZ2h0Q29sID0gc2VnTGFzdDsKCQkJCX0KCQkJCXNlZ3MucHVzaChzZWcpOwoJCQl9CgkJfQoKCQlyZXR1cm4gc2VnczsKCX0sCgoKCS8vIEdpdmVuIGEgZGF0ZSwgcmV0dXJucyBpdHMgY2hyb25vbG9jaWFsIGNlbGwtb2Zmc2V0IGZyb20gdGhlIGZpcnN0IGNlbGwgb2YgdGhlIGdyaWQuCgkvLyBJZiB0aGUgZGF0ZSBsaWVzIGJldHdlZW4gY2VsbHMgKGJlY2F1c2Ugb2YgaGlkZGVuRGF5cyksIHJldHVybnMgYSBmbG9hdGluZy1wb2ludCB2YWx1ZSBiZXR3ZWVuIG9mZnNldHMuCgkvLyBJZiBiZWZvcmUgdGhlIGZpcnN0IG9mZnNldCwgcmV0dXJucyBhIG5lZ2F0aXZlIG51bWJlci4KCS8vIElmIGFmdGVyIHRoZSBsYXN0IG9mZnNldCwgcmV0dXJucyBhbiBvZmZzZXQgcGFzdCB0aGUgbGFzdCBjZWxsIG9mZnNldC4KCS8vIE9ubHkgd29ya3MgZm9yICpzdGFydCogZGF0ZXMgb2YgY2VsbHMuIFdpbGwgbm90IHdvcmsgZm9yIGV4Y2x1c2l2ZSBlbmQgZGF0ZXMgZm9yIGNlbGxzLgoJZGF0ZVRvQ2VsbE9mZnNldDogZnVuY3Rpb24oZGF0ZSkgewoJCXZhciBvZmZzZXRzID0gdGhpcy5kYXlUb0NlbGxPZmZzZXRzOwoJCXZhciBkYXkgPSBkYXRlLmRpZmYodGhpcy5zdGFydCwgJ2RheXMnKTsKCgkJaWYgKGRheSA8IDApIHsKCQkJcmV0dXJuIG9mZnNldHNbMF0gLSAxOwoJCX0KCQllbHNlIGlmIChkYXkgPj0gb2Zmc2V0cy5sZW5ndGgpIHsKCQkJcmV0dXJuIG9mZnNldHNbb2Zmc2V0cy5sZW5ndGggLSAxXSArIDE7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gb2Zmc2V0c1tkYXldOwoJCX0KCX0sCgoKCS8qIEV2ZW50IERyYWcgVmlzdWFsaXphdGlvbgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCS8vIFRPRE86IG1vdmUgdG8gRGF5R3JpZC5ldmVudCwgc2ltaWxhciB0byB3aGF0IHdlIGRpZCB3aXRoIEdyaWQncyBkcmFnIG1ldGhvZHMKCgoJLy8gUmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGFuIGV2ZW50IG9yIGV4dGVybmFsIGVsZW1lbnQgYmVpbmcgZHJhZ2dlZC4KCS8vIFRoZSBkcm9wTG9jYXRpb24ncyBlbmQgY2FuIGJlIG51bGwuIHNlZyBjYW4gYmUgbnVsbC4gU2VlIEdyaWQ6OnJlbmRlckRyYWcgZm9yIG1vcmUgaW5mby4KCXJlbmRlckRyYWc6IGZ1bmN0aW9uKGRyb3BMb2NhdGlvbiwgc2VnKSB7CgkJdmFyIG9wYWNpdHk7CgoJCS8vIGFsd2F5cyByZW5kZXIgYSBoaWdobGlnaHQgdW5kZXJuZWF0aAoJCXRoaXMucmVuZGVySGlnaGxpZ2h0KAoJCQl0aGlzLnZpZXcuY2FsZW5kYXIuZW5zdXJlVmlzaWJsZUV2ZW50UmFuZ2UoZHJvcExvY2F0aW9uKSAvLyBuZWVkcyB0byBiZSBhIHByb3BlciByYW5nZQoJCSk7CgoJCS8vIGlmIGEgc2VnbWVudCBmcm9tIHRoZSBzYW1lIGNhbGVuZGFyIGJ1dCBhbm90aGVyIGNvbXBvbmVudCBpcyBiZWluZyBkcmFnZ2VkLCByZW5kZXIgYSBoZWxwZXIgZXZlbnQKCQlpZiAoc2VnICYmICFzZWcuZWwuY2xvc2VzdCh0aGlzLmVsKS5sZW5ndGgpIHsKCgkJCXRoaXMucmVuZGVyUmFuZ2VIZWxwZXIoZHJvcExvY2F0aW9uLCBzZWcpOwoKCQkJb3BhY2l0eSA9IHRoaXMudmlldy5vcHQoJ2RyYWdPcGFjaXR5Jyk7CgkJCWlmIChvcGFjaXR5ICE9PSB1bmRlZmluZWQpIHsKCQkJCXRoaXMuaGVscGVyRWxzLmNzcygnb3BhY2l0eScsIG9wYWNpdHkpOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsgLy8gYSBoZWxwZXIgaGFzIGJlZW4gcmVuZGVyZWQKCQl9Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYW55IHZpc3VhbCBpbmRpY2F0aW9uIG9mIGEgaG92ZXJpbmcgZXZlbnQKCWRlc3Ryb3lEcmFnOiBmdW5jdGlvbigpIHsKCQl0aGlzLmRlc3Ryb3lIaWdobGlnaHQoKTsKCQl0aGlzLmRlc3Ryb3lIZWxwZXIoKTsKCX0sCgoKCS8qIEV2ZW50IFJlc2l6ZSBWaXN1YWxpemF0aW9uCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYW4gZXZlbnQgYmVpbmcgcmVzaXplZAoJcmVuZGVyRXZlbnRSZXNpemU6IGZ1bmN0aW9uKHJhbmdlLCBzZWcpIHsKCQl0aGlzLnJlbmRlckhpZ2hsaWdodChyYW5nZSk7CgkJdGhpcy5yZW5kZXJSYW5nZUhlbHBlcihyYW5nZSwgc2VnKTsKCX0sCgoKCS8vIFVucmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGFuIGV2ZW50IGJlaW5nIHJlc2l6ZWQKCWRlc3Ryb3lFdmVudFJlc2l6ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5kZXN0cm95SGlnaGxpZ2h0KCk7CgkJdGhpcy5kZXN0cm95SGVscGVyKCk7Cgl9LAoKCgkvKiBFdmVudCBIZWxwZXIKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIFJlbmRlcnMgYSBtb2NrICJoZWxwZXIiIGV2ZW50LiBgc291cmNlU2VnYCBpcyB0aGUgYXNzb2NpYXRlZCBpbnRlcm5hbCBzZWdtZW50IG9iamVjdC4gSXQgY2FuIGJlIG51bGwuCglyZW5kZXJIZWxwZXI6IGZ1bmN0aW9uKGV2ZW50LCBzb3VyY2VTZWcpIHsKCQl2YXIgaGVscGVyTm9kZXMgPSBbXTsKCQl2YXIgc2VncyA9IHRoaXMuZXZlbnRzVG9TZWdzKFsgZXZlbnQgXSk7CgkJdmFyIHJvd1N0cnVjdHM7CgoJCXNlZ3MgPSB0aGlzLnJlbmRlckZnU2VnRWxzKHNlZ3MpOyAvLyBhc3NpZ25zIGVhY2ggc2VnJ3MgZWwgYW5kIHJldHVybnMgYSBzdWJzZXQgb2Ygc2VncyB0aGF0IHdlcmUgcmVuZGVyZWQKCQlyb3dTdHJ1Y3RzID0gdGhpcy5yZW5kZXJTZWdSb3dzKHNlZ3MpOwoKCQkvLyBpbmplY3QgZWFjaCBuZXcgZXZlbnQgc2tlbGV0b24gaW50byBlYWNoIGFzc29jaWF0ZWQgcm93CgkJdGhpcy5yb3dFbHMuZWFjaChmdW5jdGlvbihyb3csIHJvd05vZGUpIHsKCQkJdmFyIHJvd0VsID0gJChyb3dOb2RlKTsgLy8gdGhlIC5mYy1yb3cKCQkJdmFyIHNrZWxldG9uRWwgPSAkKCc8ZGl2IGNsYXNzPSJmYy1oZWxwZXItc2tlbGV0b24iPjx0YWJsZS8+PC9kaXY+Jyk7IC8vIHdpbGwgYmUgYWJzb2x1dGVseSBwb3NpdGlvbmVkCgkJCXZhciBza2VsZXRvblRvcDsKCgkJCS8vIElmIHRoZXJlIGlzIGFuIG9yaWdpbmFsIHNlZ21lbnQsIG1hdGNoIHRoZSB0b3AgcG9zaXRpb24uIE90aGVyd2lzZSwgcHV0IGl0IGF0IHRoZSByb3cncyB0b3AgbGV2ZWwKCQkJaWYgKHNvdXJjZVNlZyAmJiBzb3VyY2VTZWcucm93ID09PSByb3cpIHsKCQkJCXNrZWxldG9uVG9wID0gc291cmNlU2VnLmVsLnBvc2l0aW9uKCkudG9wOwoJCQl9CgkJCWVsc2UgewoJCQkJc2tlbGV0b25Ub3AgPSByb3dFbC5maW5kKCcuZmMtY29udGVudC1za2VsZXRvbiB0Ym9keScpLnBvc2l0aW9uKCkudG9wOwoJCQl9CgoJCQlza2VsZXRvbkVsLmNzcygndG9wJywgc2tlbGV0b25Ub3ApCgkJCQkuZmluZCgndGFibGUnKQoJCQkJCS5hcHBlbmQocm93U3RydWN0c1tyb3ddLnRib2R5RWwpOwoKCQkJcm93RWwuYXBwZW5kKHNrZWxldG9uRWwpOwoJCQloZWxwZXJOb2Rlcy5wdXNoKHNrZWxldG9uRWxbMF0pOwoJCX0pOwoKCQl0aGlzLmhlbHBlckVscyA9ICQoaGVscGVyTm9kZXMpOyAvLyBhcnJheSAtPiBqUXVlcnkgc2V0Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYW55IHZpc3VhbCBpbmRpY2F0aW9uIG9mIGEgbW9jayBoZWxwZXIgZXZlbnQKCWRlc3Ryb3lIZWxwZXI6IGZ1bmN0aW9uKCkgewoJCWlmICh0aGlzLmhlbHBlckVscykgewoJCQl0aGlzLmhlbHBlckVscy5yZW1vdmUoKTsKCQkJdGhpcy5oZWxwZXJFbHMgPSBudWxsOwoJCX0KCX0sCgoKCS8qIEZpbGwgU3lzdGVtIChoaWdobGlnaHQsIGJhY2tncm91bmQgZXZlbnRzLCBidXNpbmVzcyBob3VycykKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCWZpbGxTZWdUYWc6ICd0ZCcsIC8vIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHRhZyBuYW1lCgoKCS8vIFJlbmRlcnMgYSBzZXQgb2YgcmVjdGFuZ2xlcyBvdmVyIHRoZSBnaXZlbiBzZWdtZW50cyBvZiBkYXlzLgoJLy8gT25seSByZXR1cm5zIHNlZ21lbnRzIHRoYXQgc3VjY2Vzc2Z1bGx5IHJlbmRlcmVkLgoJcmVuZGVyRmlsbDogZnVuY3Rpb24odHlwZSwgc2VncykgewoJCXZhciBub2RlcyA9IFtdOwoJCXZhciBpLCBzZWc7CgkJdmFyIHNrZWxldG9uRWw7CgoJCXNlZ3MgPSB0aGlzLnJlbmRlckZpbGxTZWdFbHModHlwZSwgc2Vncyk7IC8vIGFzc2lnbmVzIGAuZWxgIHRvIGVhY2ggc2VnLiByZXR1cm5zIHN1Y2Nlc3NmdWxseSByZW5kZXJlZCBzZWdzCgoJCWZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7CgkJCXNlZyA9IHNlZ3NbaV07CgkJCXNrZWxldG9uRWwgPSB0aGlzLnJlbmRlckZpbGxSb3codHlwZSwgc2VnKTsKCQkJdGhpcy5yb3dFbHMuZXEoc2VnLnJvdykuYXBwZW5kKHNrZWxldG9uRWwpOwoJCQlub2Rlcy5wdXNoKHNrZWxldG9uRWxbMF0pOwoJCX0KCgkJdGhpcy5lbHNCeUZpbGxbdHlwZV0gPSAkKG5vZGVzKTsKCgkJcmV0dXJuIHNlZ3M7Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgdGhlIEhUTUwgbmVlZGVkIGZvciBvbmUgcm93IG9mIGEgZmlsbC4gUmVxdWlyZXMgdGhlIHNlZydzIGVsIHRvIGJlIHJlbmRlcmVkLgoJcmVuZGVyRmlsbFJvdzogZnVuY3Rpb24odHlwZSwgc2VnKSB7CgkJdmFyIGNvbENudCA9IHRoaXMuY29sQ250OwoJCXZhciBzdGFydENvbCA9IHNlZy5sZWZ0Q29sOwoJCXZhciBlbmRDb2wgPSBzZWcucmlnaHRDb2wgKyAxOwoJCXZhciBza2VsZXRvbkVsOwoJCXZhciB0ckVsOwoKCQlza2VsZXRvbkVsID0gJCgKCQkJJzxkaXYgY2xhc3M9ImZjLScgKyB0eXBlLnRvTG93ZXJDYXNlKCkgKyAnLXNrZWxldG9uIj4nICsKCQkJCSc8dGFibGU+PHRyLz48L3RhYmxlPicgKwoJCQknPC9kaXY+JwoJCSk7CgkJdHJFbCA9IHNrZWxldG9uRWwuZmluZCgndHInKTsKCgkJaWYgKHN0YXJ0Q29sID4gMCkgewoJCQl0ckVsLmFwcGVuZCgnPHRkIGNvbHNwYW49IicgKyBzdGFydENvbCArICciLz4nKTsKCQl9CgoJCXRyRWwuYXBwZW5kKAoJCQlzZWcuZWwuYXR0cignY29sc3BhbicsIGVuZENvbCAtIHN0YXJ0Q29sKQoJCSk7CgoJCWlmIChlbmRDb2wgPCBjb2xDbnQpIHsKCQkJdHJFbC5hcHBlbmQoJzx0ZCBjb2xzcGFuPSInICsgKGNvbENudCAtIGVuZENvbCkgKyAnIi8+Jyk7CgkJfQoKCQl0aGlzLmJvb2tlbmRDZWxscyh0ckVsLCB0eXBlKTsKCgkJcmV0dXJuIHNrZWxldG9uRWw7Cgl9Cgp9KTsKCjs7CgovKiBFdmVudC1yZW5kZXJpbmcgbWV0aG9kcyBmb3IgdGhlIERheUdyaWQgY2xhc3MKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgpEYXlHcmlkLm1peGluKHsKCglyb3dTdHJ1Y3RzOiBudWxsLCAvLyBhbiBhcnJheSBvZiBvYmplY3RzLCBlYWNoIGhvbGRpbmcgaW5mb3JtYXRpb24gYWJvdXQgYSByb3cncyBmb3JlZ3JvdW5kIGV2ZW50LXJlbmRlcmluZwoKCgkvLyBVbnJlbmRlcnMgYWxsIGV2ZW50cyBjdXJyZW50bHkgcmVuZGVyZWQgb24gdGhlIGdyaWQKCWRlc3Ryb3lFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZGVzdHJveVNlZ1BvcG92ZXIoKTsgLy8gcmVtb3ZlcyB0aGUgIm1vcmUuLiIgZXZlbnRzIHBvcG92ZXIKCQlHcmlkLnByb3RvdHlwZS5kZXN0cm95RXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIGNhbGxzIHRoZSBzdXBlci1tZXRob2QKCX0sCgoKCS8vIFJldHJpZXZlcyBhbGwgcmVuZGVyZWQgc2VnbWVudCBvYmplY3RzIGN1cnJlbnRseSByZW5kZXJlZCBvbiB0aGUgZ3JpZAoJZ2V0RXZlbnRTZWdzOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gR3JpZC5wcm90b3R5cGUuZ2V0RXZlbnRTZWdzLmNhbGwodGhpcykgLy8gZ2V0IHRoZSBzZWdtZW50cyBmcm9tIHRoZSBzdXBlci1tZXRob2QKCQkJLmNvbmNhdCh0aGlzLnBvcG92ZXJTZWdzIHx8IFtdKTsgLy8gYXBwZW5kIHRoZSBzZWdtZW50cyBmcm9tIHRoZSAibW9yZS4uLiIgcG9wb3ZlcgoJfSwKCgoJLy8gUmVuZGVycyB0aGUgZ2l2ZW4gYmFja2dyb3VuZCBldmVudCBzZWdtZW50cyBvbnRvIHRoZSBncmlkCglyZW5kZXJCZ1NlZ3M6IGZ1bmN0aW9uKHNlZ3MpIHsKCgkJLy8gZG9uJ3QgcmVuZGVyIHRpbWVkIGJhY2tncm91bmQgZXZlbnRzCgkJdmFyIGFsbERheVNlZ3MgPSAkLmdyZXAoc2VncywgZnVuY3Rpb24oc2VnKSB7CgkJCXJldHVybiBzZWcuZXZlbnQuYWxsRGF5OwoJCX0pOwoKCQlyZXR1cm4gR3JpZC5wcm90b3R5cGUucmVuZGVyQmdTZWdzLmNhbGwodGhpcywgYWxsRGF5U2Vncyk7IC8vIGNhbGwgdGhlIHN1cGVyLW1ldGhvZAoJfSwKCgoJLy8gUmVuZGVycyB0aGUgZ2l2ZW4gZm9yZWdyb3VuZCBldmVudCBzZWdtZW50cyBvbnRvIHRoZSBncmlkCglyZW5kZXJGZ1NlZ3M6IGZ1bmN0aW9uKHNlZ3MpIHsKCQl2YXIgcm93U3RydWN0czsKCgkJLy8gcmVuZGVyIGFuIGAuZWxgIG9uIGVhY2ggc2VnCgkJLy8gcmV0dXJucyBhIHN1YnNldCBvZiB0aGUgc2Vncy4gc2VncyB0aGF0IHdlcmUgYWN0dWFsbHkgcmVuZGVyZWQKCQlzZWdzID0gdGhpcy5yZW5kZXJGZ1NlZ0VscyhzZWdzKTsKCgkJcm93U3RydWN0cyA9IHRoaXMucm93U3RydWN0cyA9IHRoaXMucmVuZGVyU2VnUm93cyhzZWdzKTsKCgkJLy8gYXBwZW5kIHRvIGVhY2ggcm93J3MgY29udGVudCBza2VsZXRvbgoJCXRoaXMucm93RWxzLmVhY2goZnVuY3Rpb24oaSwgcm93Tm9kZSkgewoJCQkkKHJvd05vZGUpLmZpbmQoJy5mYy1jb250ZW50LXNrZWxldG9uID4gdGFibGUnKS5hcHBlbmQoCgkJCQlyb3dTdHJ1Y3RzW2ldLnRib2R5RWwKCQkJKTsKCQl9KTsKCgkJcmV0dXJuIHNlZ3M7IC8vIHJldHVybiBvbmx5IHRoZSBzZWdzIHRoYXQgd2VyZSBhY3R1YWxseSByZW5kZXJlZAoJfSwKCgoJLy8gVW5yZW5kZXJzIGFsbCBjdXJyZW50bHkgcmVuZGVyZWQgZm9yZWdyb3VuZCBldmVudCBzZWdtZW50cwoJZGVzdHJveUZnU2VnczogZnVuY3Rpb24oKSB7CgkJdmFyIHJvd1N0cnVjdHMgPSB0aGlzLnJvd1N0cnVjdHMgfHwgW107CgkJdmFyIHJvd1N0cnVjdDsKCgkJd2hpbGUgKChyb3dTdHJ1Y3QgPSByb3dTdHJ1Y3RzLnBvcCgpKSkgewoJCQlyb3dTdHJ1Y3QudGJvZHlFbC5yZW1vdmUoKTsKCQl9CgoJCXRoaXMucm93U3RydWN0cyA9IG51bGw7Cgl9LAoKCgkvLyBVc2VzIHRoZSBnaXZlbiBldmVudHMgYXJyYXkgdG8gZ2VuZXJhdGUgPHRib2R5PiBlbGVtZW50cyB0aGF0IHNob3VsZCBiZSBhcHBlbmRlZCB0byBlYWNoIHJvdydzIGNvbnRlbnQgc2tlbGV0b24uCgkvLyBSZXR1cm5zIGFuIGFycmF5IG9mIHJvd1N0cnVjdCBvYmplY3RzIChzZWUgdGhlIGJvdHRvbSBvZiBgcmVuZGVyU2VnUm93YCkuCgkvLyBQUkVDT05ESVRJT046IGVhY2ggc2VnbWVudCBzaG91ZCBhbHJlYWR5IGhhdmUgYSByZW5kZXJlZCBhbmQgYXNzaWduZWQgYC5lbGAKCXJlbmRlclNlZ1Jvd3M6IGZ1bmN0aW9uKHNlZ3MpIHsKCQl2YXIgcm93U3RydWN0cyA9IFtdOwoJCXZhciBzZWdSb3dzOwoJCXZhciByb3c7CgoJCXNlZ1Jvd3MgPSB0aGlzLmdyb3VwU2VnUm93cyhzZWdzKTsgLy8gZ3JvdXAgaW50byBuZXN0ZWQgYXJyYXlzCgoJCS8vIGl0ZXJhdGUgZWFjaCByb3cgb2Ygc2VnbWVudCBncm91cGluZ3MKCQlmb3IgKHJvdyA9IDA7IHJvdyA8IHNlZ1Jvd3MubGVuZ3RoOyByb3crKykgewoJCQlyb3dTdHJ1Y3RzLnB1c2goCgkJCQl0aGlzLnJlbmRlclNlZ1Jvdyhyb3csIHNlZ1Jvd3Nbcm93XSkKCQkJKTsKCQl9CgoJCXJldHVybiByb3dTdHJ1Y3RzOwoJfSwKCgoJLy8gQnVpbGRzIHRoZSBIVE1MIHRvIGJlIHVzZWQgZm9yIHRoZSBkZWZhdWx0IGVsZW1lbnQgZm9yIGFuIGluZGl2aWR1YWwgc2VnbWVudAoJZmdTZWdIdG1sOiBmdW5jdGlvbihzZWcsIGRpc2FibGVSZXNpemluZykgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBldmVudCA9IHNlZy5ldmVudDsKCQl2YXIgaXNEcmFnZ2FibGUgPSB2aWV3LmlzRXZlbnREcmFnZ2FibGUoZXZlbnQpOwoJCXZhciBpc1Jlc2l6YWJsZSA9ICFkaXNhYmxlUmVzaXppbmcgJiYgZXZlbnQuYWxsRGF5ICYmIHNlZy5pc0VuZCAmJiB2aWV3LmlzRXZlbnRSZXNpemFibGUoZXZlbnQpOwoJCXZhciBjbGFzc2VzID0gdGhpcy5nZXRTZWdDbGFzc2VzKHNlZywgaXNEcmFnZ2FibGUsIGlzUmVzaXphYmxlKTsKCQl2YXIgc2tpbkNzcyA9IHRoaXMuZ2V0RXZlbnRTa2luQ3NzKGV2ZW50KTsKCQl2YXIgdGltZUh0bWwgPSAnJzsKCQl2YXIgdGl0bGVIdG1sOwoKCQljbGFzc2VzLnVuc2hpZnQoJ2ZjLWRheS1ncmlkLWV2ZW50Jyk7CgoJCS8vIE9ubHkgZGlzcGxheSBhIHRpbWVkIGV2ZW50cyB0aW1lIGlmIGl0IGlzIHRoZSBzdGFydGluZyBzZWdtZW50CgkJaWYgKCFldmVudC5hbGxEYXkgJiYgc2VnLmlzU3RhcnQpIHsKCQkJdGltZUh0bWwgPSAnPHNwYW4gY2xhc3M9ImZjLXRpbWUiPicgKyBodG1sRXNjYXBlKHRoaXMuZ2V0RXZlbnRUaW1lVGV4dChldmVudCkpICsgJzwvc3Bhbj4nOwoJCX0KCgkJdGl0bGVIdG1sID0KCQkJJzxzcGFuIGNsYXNzPSJmYy10aXRsZSI+JyArCgkJCQkoaHRtbEVzY2FwZShldmVudC50aXRsZSB8fCAnJykgfHwgJyZuYnNwOycpICsgLy8gd2UgYWx3YXlzIHdhbnQgb25lIGxpbmUgb2YgaGVpZ2h0CgkJCSc8L3NwYW4+JzsKCQkKCQlyZXR1cm4gJzxhIGNsYXNzPSInICsgY2xhc3Nlcy5qb2luKCcgJykgKyAnIicgKwoJCQkJKGV2ZW50LnVybCA\/CgkJCQkJJyBocmVmPSInICsgaHRtbEVzY2FwZShldmVudC51cmwpICsgJyInIDoKCQkJCQknJwoJCQkJCSkgKwoJCQkJKHNraW5Dc3MgPwoJCQkJCScgc3R5bGU9IicgKyBza2luQ3NzICsgJyInIDoKCQkJCQknJwoJCQkJCSkgKwoJCQknPicgKwoJCQkJJzxkaXYgY2xhc3M9ImZjLWNvbnRlbnQiPicgKwoJCQkJCSh0aGlzLmlzUlRMID8KCQkJCQkJdGl0bGVIdG1sICsgJyAnICsgdGltZUh0bWwgOiAvLyBwdXQgYSBuYXR1cmFsIHNwYWNlIGluIGJldHdlZW4KCQkJCQkJdGltZUh0bWwgKyAnICcgKyB0aXRsZUh0bWwgICAvLwoJCQkJCQkpICsKCQkJCSc8L2Rpdj4nICsKCQkJCShpc1Jlc2l6YWJsZSA\/CgkJCQkJJzxkaXYgY2xhc3M9ImZjLXJlc2l6ZXIiLz4nIDoKCQkJCQknJwoJCQkJCSkgKwoJCQknPC9hPic7Cgl9LAoKCgkvLyBHaXZlbiBhIHJvdyAjIGFuZCBhbiBhcnJheSBvZiBzZWdtZW50cyBhbGwgaW4gdGhlIHNhbWUgcm93LCByZW5kZXIgYSA8dGJvZHk+IGVsZW1lbnQsIGEgc2tlbGV0b24gdGhhdCBjb250YWlucwoJLy8gdGhlIHNlZ21lbnRzLiBSZXR1cm5zIG9iamVjdCB3aXRoIGEgYnVuY2ggb2YgaW50ZXJuYWwgZGF0YSBhYm91dCBob3cgdGhlIHJlbmRlciB3YXMgY2FsY3VsYXRlZC4KCXJlbmRlclNlZ1JvdzogZnVuY3Rpb24ocm93LCByb3dTZWdzKSB7CgkJdmFyIGNvbENudCA9IHRoaXMuY29sQ250OwoJCXZhciBzZWdMZXZlbHMgPSB0aGlzLmJ1aWxkU2VnTGV2ZWxzKHJvd1NlZ3MpOyAvLyBncm91cCBpbnRvIHN1Yi1hcnJheXMgb2YgbGV2ZWxzCgkJdmFyIGxldmVsQ250ID0gTWF0aC5tYXgoMSwgc2VnTGV2ZWxzLmxlbmd0aCk7IC8vIGVuc3VyZSBhdCBsZWFzdCBvbmUgbGV2ZWwKCQl2YXIgdGJvZHkgPSAkKCc8dGJvZHkvPicpOwoJCXZhciBzZWdNYXRyaXggPSBbXTsgLy8gbG9va3VwIGZvciB3aGljaCBzZWdtZW50cyBhcmUgcmVuZGVyZWQgaW50byB3aGljaCBsZXZlbCtjb2wgY2VsbHMKCQl2YXIgY2VsbE1hdHJpeCA9IFtdOyAvLyBsb29rdXAgZm9yIGFsbCA8dGQ+IGVsZW1lbnRzIG9mIHRoZSBsZXZlbCtjb2wgbWF0cml4CgkJdmFyIGxvbmVDZWxsTWF0cml4ID0gW107IC8vIGxvb2t1cCBmb3IgPHRkPiBlbGVtZW50cyB0aGF0IG9ubHkgdGFrZSB1cCBhIHNpbmdsZSBjb2x1bW4KCQl2YXIgaSwgbGV2ZWxTZWdzOwoJCXZhciBjb2w7CgkJdmFyIHRyOwoJCXZhciBqLCBzZWc7CgkJdmFyIHRkOwoKCQkvLyBwb3B1bGF0ZXMgZW1wdHkgY2VsbHMgZnJvbSB0aGUgY3VycmVudCBjb2x1bW4gKGBjb2xgKSB0byBgZW5kQ29sYAoJCWZ1bmN0aW9uIGVtcHR5Q2VsbHNVbnRpbChlbmRDb2wpIHsKCQkJd2hpbGUgKGNvbCA8IGVuZENvbCkgewoJCQkJLy8gdHJ5IHRvIGdyYWIgYSBjZWxsIGZyb20gdGhlIGxldmVsIGFib3ZlIGFuZCBleHRlbmQgaXRzIHJvd3NwYW4uIG90aGVyd2lzZSwgY3JlYXRlIGEgZnJlc2ggY2VsbAoJCQkJdGQgPSAobG9uZUNlbGxNYXRyaXhbaSAtIDFdIHx8IFtdKVtjb2xdOwoJCQkJaWYgKHRkKSB7CgkJCQkJdGQuYXR0cigKCQkJCQkJJ3Jvd3NwYW4nLAoJCQkJCQlwYXJzZUludCh0ZC5hdHRyKCdyb3dzcGFuJykgfHwgMSwgMTApICsgMQoJCQkJCSk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQl0ZCA9ICQoJzx0ZC8+Jyk7CgkJCQkJdHIuYXBwZW5kKHRkKTsKCQkJCX0KCQkJCWNlbGxNYXRyaXhbaV1bY29sXSA9IHRkOwoJCQkJbG9uZUNlbGxNYXRyaXhbaV1bY29sXSA9IHRkOwoJCQkJY29sKys7CgkJCX0KCQl9CgoJCWZvciAoaSA9IDA7IGkgPCBsZXZlbENudDsgaSsrKSB7IC8vIGl0ZXJhdGUgdGhyb3VnaCBhbGwgbGV2ZWxzCgkJCWxldmVsU2VncyA9IHNlZ0xldmVsc1tpXTsKCQkJY29sID0gMDsKCQkJdHIgPSAkKCc8dHIvPicpOwoKCQkJc2VnTWF0cml4LnB1c2goW10pOwoJCQljZWxsTWF0cml4LnB1c2goW10pOwoJCQlsb25lQ2VsbE1hdHJpeC5wdXNoKFtdKTsKCgkJCS8vIGxldmVsQ250IG1pZ2h0IGJlIDEgZXZlbiB0aG91Z2ggdGhlcmUgYXJlIG5vIGFjdHVhbCBsZXZlbHMuIHByb3RlY3QgYWdhaW5zdCB0aGlzLgoJCQkvLyB0aGlzIHNpbmdsZSBlbXB0eSByb3cgaXMgdXNlZnVsIGZvciBzdHlsaW5nLgoJCQlpZiAobGV2ZWxTZWdzKSB7CgkJCQlmb3IgKGogPSAwOyBqIDwgbGV2ZWxTZWdzLmxlbmd0aDsgaisrKSB7IC8vIGl0ZXJhdGUgdGhyb3VnaCBzZWdtZW50cyBpbiBsZXZlbAoJCQkJCXNlZyA9IGxldmVsU2Vnc1tqXTsKCgkJCQkJZW1wdHlDZWxsc1VudGlsKHNlZy5sZWZ0Q29sKTsKCgkJCQkJLy8gY3JlYXRlIGEgY29udGFpbmVyIHRoYXQgb2NjdXBpZXMgb3IgbW9yZSBjb2x1bW5zLiBhcHBlbmQgdGhlIGV2ZW50IGVsZW1lbnQuCgkJCQkJdGQgPSAkKCc8dGQgY2xhc3M9ImZjLWV2ZW50LWNvbnRhaW5lciIvPicpLmFwcGVuZChzZWcuZWwpOwoJCQkJCWlmIChzZWcubGVmdENvbCAhPSBzZWcucmlnaHRDb2wpIHsKCQkJCQkJdGQuYXR0cignY29sc3BhbicsIHNlZy5yaWdodENvbCAtIHNlZy5sZWZ0Q29sICsgMSk7CgkJCQkJfQoJCQkJCWVsc2UgeyAvLyBhIHNpbmdsZS1jb2x1bW4gc2VnbWVudAoJCQkJCQlsb25lQ2VsbE1hdHJpeFtpXVtjb2xdID0gdGQ7CgkJCQkJfQoKCQkJCQl3aGlsZSAoY29sIDw9IHNlZy5yaWdodENvbCkgewoJCQkJCQljZWxsTWF0cml4W2ldW2NvbF0gPSB0ZDsKCQkJCQkJc2VnTWF0cml4W2ldW2NvbF0gPSBzZWc7CgkJCQkJCWNvbCsrOwoJCQkJCX0KCgkJCQkJdHIuYXBwZW5kKHRkKTsKCQkJCX0KCQkJfQoKCQkJZW1wdHlDZWxsc1VudGlsKGNvbENudCk7IC8vIGZpbmlzaCBvZmYgdGhlIHJvdwoJCQl0aGlzLmJvb2tlbmRDZWxscyh0ciwgJ2V2ZW50U2tlbGV0b24nKTsKCQkJdGJvZHkuYXBwZW5kKHRyKTsKCQl9CgoJCXJldHVybiB7IC8vIGEgInJvd1N0cnVjdCIKCQkJcm93OiByb3csIC8vIHRoZSByb3cgbnVtYmVyCgkJCXRib2R5RWw6IHRib2R5LAoJCQljZWxsTWF0cml4OiBjZWxsTWF0cml4LAoJCQlzZWdNYXRyaXg6IHNlZ01hdHJpeCwKCQkJc2VnTGV2ZWxzOiBzZWdMZXZlbHMsCgkJCXNlZ3M6IHJvd1NlZ3MKCQl9OwoJfSwKCgoJLy8gU3RhY2tzIGEgZmxhdCBhcnJheSBvZiBzZWdtZW50cywgd2hpY2ggYXJlIGFsbCBhc3N1bWVkIHRvIGJlIGluIHRoZSBzYW1lIHJvdywgaW50byBzdWJhcnJheXMgb2YgdmVydGljYWwgbGV2ZWxzLgoJYnVpbGRTZWdMZXZlbHM6IGZ1bmN0aW9uKHNlZ3MpIHsKCQl2YXIgbGV2ZWxzID0gW107CgkJdmFyIGksIHNlZzsKCQl2YXIgajsKCgkJLy8gR2l2ZSBwcmVmZXJlbmNlIHRvIGVsZW1lbnRzIHdpdGggY2VydGFpbiBjcml0ZXJpYSwgc28gdGhleSBoYXZlCgkJLy8gYSBjaGFuY2UgdG8gYmUgY2xvc2VyIHRvIHRoZSB0b3AuCgkJc2Vncy5zb3J0KGNvbXBhcmVTZWdzKTsKCQkKCQlmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgewoJCQlzZWcgPSBzZWdzW2ldOwoKCQkJLy8gbG9vcCB0aHJvdWdoIGxldmVscywgc3RhcnRpbmcgd2l0aCB0aGUgdG9wbW9zdCwgdW50aWwgdGhlIHNlZ21lbnQgZG9lc24ndCBjb2xsaWRlIHdpdGggb3RoZXIgc2VnbWVudHMKCQkJZm9yIChqID0gMDsgaiA8IGxldmVscy5sZW5ndGg7IGorKykgewoJCQkJaWYgKCFpc0RheVNlZ0NvbGxpc2lvbihzZWcsIGxldmVsc1tqXSkpIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCQkvLyBgamAgbm93IGhvbGRzIHRoZSBkZXNpcmVkIHN1YnJvdyBpbmRleAoJCQlzZWcubGV2ZWwgPSBqOwoKCQkJLy8gY3JlYXRlIG5ldyBsZXZlbCBhcnJheSBpZiBuZWVkZWQgYW5kIGFwcGVuZCBzZWdtZW50CgkJCShsZXZlbHNbal0gfHwgKGxldmVsc1tqXSA9IFtdKSkucHVzaChzZWcpOwoJCX0KCgkJLy8gb3JkZXIgc2VnbWVudHMgbGVmdC10by1yaWdodC4gdmVyeSBpbXBvcnRhbnQgaWYgY2FsZW5kYXIgaXMgUlRMCgkJZm9yIChqID0gMDsgaiA8IGxldmVscy5sZW5ndGg7IGorKykgewoJCQlsZXZlbHNbal0uc29ydChjb21wYXJlRGF5U2VnQ29scyk7CgkJfQoKCQlyZXR1cm4gbGV2ZWxzOwoJfSwKCgoJLy8gR2l2ZW4gYSBmbGF0IGFycmF5IG9mIHNlZ21lbnRzLCByZXR1cm4gYW4gYXJyYXkgb2Ygc3ViLWFycmF5cywgZ3JvdXBlZCBieSBlYWNoIHNlZ21lbnQncyByb3cKCWdyb3VwU2VnUm93czogZnVuY3Rpb24oc2VncykgewoJCXZhciBzZWdSb3dzID0gW107CgkJdmFyIGk7CgoJCWZvciAoaSA9IDA7IGkgPCB0aGlzLnJvd0NudDsgaSsrKSB7CgkJCXNlZ1Jvd3MucHVzaChbXSk7CgkJfQoKCQlmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgewoJCQlzZWdSb3dzW3NlZ3NbaV0ucm93XS5wdXNoKHNlZ3NbaV0pOwoJCX0KCgkJcmV0dXJuIHNlZ1Jvd3M7Cgl9Cgp9KTsKCgovLyBDb21wdXRlcyB3aGV0aGVyIHR3byBzZWdtZW50cycgY29sdW1ucyBjb2xsaWRlLiBUaGV5IGFyZSBhc3N1bWVkIHRvIGJlIGluIHRoZSBzYW1lIHJvdy4KZnVuY3Rpb24gaXNEYXlTZWdDb2xsaXNpb24oc2VnLCBvdGhlclNlZ3MpIHsKCXZhciBpLCBvdGhlclNlZzsKCglmb3IgKGkgPSAwOyBpIDwgb3RoZXJTZWdzLmxlbmd0aDsgaSsrKSB7CgkJb3RoZXJTZWcgPSBvdGhlclNlZ3NbaV07CgoJCWlmICgKCQkJb3RoZXJTZWcubGVmdENvbCA8PSBzZWcucmlnaHRDb2wgJiYKCQkJb3RoZXJTZWcucmlnaHRDb2wgPj0gc2VnLmxlZnRDb2wKCQkpIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCXJldHVybiBmYWxzZTsKfQoKCi8vIEEgY21wIGZ1bmN0aW9uIGZvciBkZXRlcm1pbmluZyB0aGUgbGVmdG1vc3QgZXZlbnQKZnVuY3Rpb24gY29tcGFyZURheVNlZ0NvbHMoYSwgYikgewoJcmV0dXJuIGEubGVmdENvbCAtIGIubGVmdENvbDsKfQoKOzsKCi8qIE1ldGhvZHMgcmVsYXRlIHRvIGxpbWl0aW5nIHRoZSBudW1iZXIgZXZlbnRzIGZvciBhIGdpdmVuIGRheSBvbiBhIERheUdyaWQKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCi8vIE5PVEU6IGFsbCB0aGUgc2VncyBiZWluZyBwYXNzZWQgYXJvdW5kIGluIGhlcmUgYXJlIGZvcmVncm91bmQgc2VncwoKRGF5R3JpZC5taXhpbih7CgoJc2VnUG9wb3ZlcjogbnVsbCwgLy8gdGhlIFBvcG92ZXIgdGhhdCBob2xkcyBldmVudHMgdGhhdCBjYW4ndCBmaXQgaW4gYSBjZWxsLiBudWxsIHdoZW4gbm90IHZpc2libGUKCXBvcG92ZXJTZWdzOiBudWxsLCAvLyBhbiBhcnJheSBvZiBzZWdtZW50IG9iamVjdHMgdGhhdCB0aGUgc2VnUG9wb3ZlciBob2xkcy4gbnVsbCB3aGVuIG5vdCB2aXNpYmxlCgoKCWRlc3Ryb3lTZWdQb3BvdmVyOiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5zZWdQb3BvdmVyKSB7CgkJCXRoaXMuc2VnUG9wb3Zlci5oaWRlKCk7IC8vIHdpbGwgdHJpZ2dlciBkZXN0cnVjdGlvbiBvZiBgc2VnUG9wb3ZlcmAgYW5kIGBwb3BvdmVyU2Vnc2AKCQl9Cgl9LAoKCgkvLyBMaW1pdHMgdGhlIG51bWJlciBvZiAibGV2ZWxzIiAodmVydGljYWxseSBzdGFja2luZyBsYXllcnMgb2YgZXZlbnRzKSBmb3IgZWFjaCByb3cgb2YgdGhlIGdyaWQuCgkvLyBgbGV2ZWxMaW1pdGAgY2FuIGJlIGZhbHNlIChkb24ndCBsaW1pdCksIGEgbnVtYmVyLCBvciB0cnVlIChzaG91bGQgYmUgY29tcHV0ZWQpLgoJbGltaXRSb3dzOiBmdW5jdGlvbihsZXZlbExpbWl0KSB7CgkJdmFyIHJvd1N0cnVjdHMgPSB0aGlzLnJvd1N0cnVjdHMgfHwgW107CgkJdmFyIHJvdzsgLy8gcm93ICMKCQl2YXIgcm93TGV2ZWxMaW1pdDsKCgkJZm9yIChyb3cgPSAwOyByb3cgPCByb3dTdHJ1Y3RzLmxlbmd0aDsgcm93KyspIHsKCQkJdGhpcy51bmxpbWl0Um93KHJvdyk7CgoJCQlpZiAoIWxldmVsTGltaXQpIHsKCQkJCXJvd0xldmVsTGltaXQgPSBmYWxzZTsKCQkJfQoJCQllbHNlIGlmICh0eXBlb2YgbGV2ZWxMaW1pdCA9PT0gJ251bWJlcicpIHsKCQkJCXJvd0xldmVsTGltaXQgPSBsZXZlbExpbWl0OwoJCQl9CgkJCWVsc2UgewoJCQkJcm93TGV2ZWxMaW1pdCA9IHRoaXMuY29tcHV0ZVJvd0xldmVsTGltaXQocm93KTsKCQkJfQoKCQkJaWYgKHJvd0xldmVsTGltaXQgIT09IGZhbHNlKSB7CgkJCQl0aGlzLmxpbWl0Um93KHJvdywgcm93TGV2ZWxMaW1pdCk7CgkJCX0KCQl9Cgl9LAoKCgkvLyBDb21wdXRlcyB0aGUgbnVtYmVyIG9mIGxldmVscyBhIHJvdyB3aWxsIGFjY29tb2RhdGUgd2l0aG91dCBnb2luZyBvdXRzaWRlIGl0cyBib3VuZHMuCgkvLyBBc3N1bWVzIHRoZSByb3cgaXMgInJpZ2lkIiAobWFpbnRhaW5zIGEgY29uc3RhbnQgaGVpZ2h0IHJlZ2FyZGxlc3Mgb2Ygd2hhdCBpcyBpbnNpZGUpLgoJLy8gYHJvd2AgaXMgdGhlIHJvdyBudW1iZXIuCgljb21wdXRlUm93TGV2ZWxMaW1pdDogZnVuY3Rpb24ocm93KSB7CgkJdmFyIHJvd0VsID0gdGhpcy5yb3dFbHMuZXEocm93KTsgLy8gdGhlIGNvbnRhaW5pbmcgImZha2UiIHJvdyBkaXYKCQl2YXIgcm93SGVpZ2h0ID0gcm93RWwuaGVpZ2h0KCk7IC8vIFRPRE86IGNhY2hlIHNvbWVob3c\/CgkJdmFyIHRyRWxzID0gdGhpcy5yb3dTdHJ1Y3RzW3Jvd10udGJvZHlFbC5jaGlsZHJlbigpOwoJCXZhciBpLCB0ckVsOwoKCQkvLyBSZXZlYWwgb25lIGxldmVsIDx0cj4gYXQgYSB0aW1lIGFuZCBzdG9wIHdoZW4gd2UgZmluZCBvbmUgb3V0IG9mIGJvdW5kcwoJCWZvciAoaSA9IDA7IGkgPCB0ckVscy5sZW5ndGg7IGkrKykgewoJCQl0ckVsID0gdHJFbHMuZXEoaSkucmVtb3ZlQ2xhc3MoJ2ZjLWxpbWl0ZWQnKTsgLy8gZ2V0IGFuZCByZXZlYWwKCQkJaWYgKHRyRWwucG9zaXRpb24oKS50b3AgKyB0ckVsLm91dGVySGVpZ2h0KCkgPiByb3dIZWlnaHQpIHsKCQkJCXJldHVybiBpOwoJCQl9CgkJfQoKCQlyZXR1cm4gZmFsc2U7IC8vIHNob3VsZCBub3QgbGltaXQgYXQgYWxsCgl9LAoKCgkvLyBMaW1pdHMgdGhlIGdpdmVuIGdyaWQgcm93IHRvIHRoZSBtYXhpbXVtIG51bWJlciBvZiBsZXZlbHMgYW5kIGluamVjdHMgIm1vcmUiIGxpbmtzIGlmIG5lY2Vzc2FyeS4KCS8vIGByb3dgIGlzIHRoZSByb3cgbnVtYmVyLgoJLy8gYGxldmVsTGltaXRgIGlzIGEgbnVtYmVyIGZvciB0aGUgbWF4aW11bSAoaW5jbHVzaXZlKSBudW1iZXIgb2YgbGV2ZWxzIGFsbG93ZWQuCglsaW1pdFJvdzogZnVuY3Rpb24ocm93LCBsZXZlbExpbWl0KSB7CgkJdmFyIF90aGlzID0gdGhpczsKCQl2YXIgcm93U3RydWN0ID0gdGhpcy5yb3dTdHJ1Y3RzW3Jvd107CgkJdmFyIG1vcmVOb2RlcyA9IFtdOyAvLyBhcnJheSBvZiAibW9yZSIgPGE+IGxpbmtzIGFuZCA8dGQ+IERPTSBub2RlcwoJCXZhciBjb2wgPSAwOyAvLyBjb2wgIywgbGVmdC10by1yaWdodCAobm90IGNocm9ub2xvZ2ljYWxseSkKCQl2YXIgY2VsbDsKCQl2YXIgbGV2ZWxTZWdzOyAvLyBhcnJheSBvZiBzZWdtZW50IG9iamVjdHMgaW4gdGhlIGxhc3QgYWxsb3dhYmxlIGxldmVsLCBvcmRlcmVkIGxlZnQtdG8tcmlnaHQKCQl2YXIgY2VsbE1hdHJpeDsgLy8gYSBtYXRyaXggKGJ5IGxldmVsLCB0aGVuIGNvbHVtbikgb2YgYWxsIDx0ZD4galF1ZXJ5IGVsZW1lbnRzIGluIHRoZSByb3cKCQl2YXIgbGltaXRlZE5vZGVzOyAvLyBhcnJheSBvZiB0ZW1wb3JhcmlseSBoaWRkZW4gbGV2ZWwgPHRyPiBhbmQgc2VnbWVudCA8dGQ+IERPTSBub2RlcwoJCXZhciBpLCBzZWc7CgkJdmFyIHNlZ3NCZWxvdzsgLy8gYXJyYXkgb2Ygc2VnbWVudCBvYmplY3RzIGJlbG93IGBzZWdgIGluIHRoZSBjdXJyZW50IGBjb2xgCgkJdmFyIHRvdGFsU2Vnc0JlbG93OyAvLyB0b3RhbCBudW1iZXIgb2Ygc2VnbWVudHMgYmVsb3cgYHNlZ2AgaW4gYW55IG9mIHRoZSBjb2x1bW5zIGBzZWdgIG9jY3VwaWVzCgkJdmFyIGNvbFNlZ3NCZWxvdzsgLy8gYXJyYXkgb2Ygc2VnbWVudCBhcnJheXMsIGJlbG93IHNlZywgb25lIGZvciBlYWNoIGNvbHVtbiAob2Zmc2V0IGZyb20gc2VncydzIGZpcnN0IGNvbHVtbikKCQl2YXIgdGQsIHJvd3NwYW47CgkJdmFyIHNlZ01vcmVOb2RlczsgLy8gYXJyYXkgb2YgIm1vcmUiIDx0ZD4gY2VsbHMgdGhhdCB3aWxsIHN0YW5kLWluIGZvciB0aGUgY3VycmVudCBzZWcncyBjZWxsCgkJdmFyIGo7CgkJdmFyIG1vcmVUZCwgbW9yZVdyYXAsIG1vcmVMaW5rOwoKCQkvLyBJdGVyYXRlcyB0aHJvdWdoIGVtcHR5IGxldmVsIGNlbGxzIGFuZCBwbGFjZXMgIm1vcmUiIGxpbmtzIGluc2lkZSBpZiBuZWVkIGJlCgkJZnVuY3Rpb24gZW1wdHlDZWxsc1VudGlsKGVuZENvbCkgeyAvLyBnb2VzIGZyb20gY3VycmVudCBgY29sYCB0byBgZW5kQ29sYAoJCQl3aGlsZSAoY29sIDwgZW5kQ29sKSB7CgkJCQljZWxsID0gX3RoaXMuZ2V0Q2VsbChyb3csIGNvbCk7CgkJCQlzZWdzQmVsb3cgPSBfdGhpcy5nZXRDZWxsU2VncyhjZWxsLCBsZXZlbExpbWl0KTsKCQkJCWlmIChzZWdzQmVsb3cubGVuZ3RoKSB7CgkJCQkJdGQgPSBjZWxsTWF0cml4W2xldmVsTGltaXQgLSAxXVtjb2xdOwoJCQkJCW1vcmVMaW5rID0gX3RoaXMucmVuZGVyTW9yZUxpbmsoY2VsbCwgc2Vnc0JlbG93KTsKCQkJCQltb3JlV3JhcCA9ICQoJzxkaXYvPicpLmFwcGVuZChtb3JlTGluayk7CgkJCQkJdGQuYXBwZW5kKG1vcmVXcmFwKTsKCQkJCQltb3JlTm9kZXMucHVzaChtb3JlV3JhcFswXSk7CgkJCQl9CgkJCQljb2wrKzsKCQkJfQoJCX0KCgkJaWYgKGxldmVsTGltaXQgJiYgbGV2ZWxMaW1pdCA8IHJvd1N0cnVjdC5zZWdMZXZlbHMubGVuZ3RoKSB7IC8vIGlzIGl0IGFjdHVhbGx5IG92ZXIgdGhlIGxpbWl0PwoJCQlsZXZlbFNlZ3MgPSByb3dTdHJ1Y3Quc2VnTGV2ZWxzW2xldmVsTGltaXQgLSAxXTsKCQkJY2VsbE1hdHJpeCA9IHJvd1N0cnVjdC5jZWxsTWF0cml4OwoKCQkJbGltaXRlZE5vZGVzID0gcm93U3RydWN0LnRib2R5RWwuY2hpbGRyZW4oKS5zbGljZShsZXZlbExpbWl0KSAvLyBnZXQgbGV2ZWwgPHRyPiBlbGVtZW50cyBwYXN0IHRoZSBsaW1pdAoJCQkJLmFkZENsYXNzKCdmYy1saW1pdGVkJykuZ2V0KCk7IC8vIGhpZGUgZWxlbWVudHMgYW5kIGdldCBhIHNpbXBsZSBET00tbm9kZXMgYXJyYXkKCgkJCS8vIGl0ZXJhdGUgdGhvdWdoIHNlZ21lbnRzIGluIHRoZSBsYXN0IGFsbG93YWJsZSBsZXZlbAoJCQlmb3IgKGkgPSAwOyBpIDwgbGV2ZWxTZWdzLmxlbmd0aDsgaSsrKSB7CgkJCQlzZWcgPSBsZXZlbFNlZ3NbaV07CgkJCQllbXB0eUNlbGxzVW50aWwoc2VnLmxlZnRDb2wpOyAvLyBwcm9jZXNzIGVtcHR5IGNlbGxzIGJlZm9yZSB0aGUgc2VnbWVudAoKCQkJCS8vIGRldGVybWluZSAqYWxsKiBzZWdtZW50cyBiZWxvdyBgc2VnYCB0aGF0IG9jY3VweSB0aGUgc2FtZSBjb2x1bW5zCgkJCQljb2xTZWdzQmVsb3cgPSBbXTsKCQkJCXRvdGFsU2Vnc0JlbG93ID0gMDsKCQkJCXdoaWxlIChjb2wgPD0gc2VnLnJpZ2h0Q29sKSB7CgkJCQkJY2VsbCA9IHRoaXMuZ2V0Q2VsbChyb3csIGNvbCk7CgkJCQkJc2Vnc0JlbG93ID0gdGhpcy5nZXRDZWxsU2VncyhjZWxsLCBsZXZlbExpbWl0KTsKCQkJCQljb2xTZWdzQmVsb3cucHVzaChzZWdzQmVsb3cpOwoJCQkJCXRvdGFsU2Vnc0JlbG93ICs9IHNlZ3NCZWxvdy5sZW5ndGg7CgkJCQkJY29sKys7CgkJCQl9CgoJCQkJaWYgKHRvdGFsU2Vnc0JlbG93KSB7IC8vIGRvIHdlIG5lZWQgdG8gcmVwbGFjZSB0aGlzIHNlZ21lbnQgd2l0aCBvbmUgb3IgbWFueSAibW9yZSIgbGlua3M\/CgkJCQkJdGQgPSBjZWxsTWF0cml4W2xldmVsTGltaXQgLSAxXVtzZWcubGVmdENvbF07IC8vIHRoZSBzZWdtZW50J3MgcGFyZW50IGNlbGwKCQkJCQlyb3dzcGFuID0gdGQuYXR0cigncm93c3BhbicpIHx8IDE7CgkJCQkJc2VnTW9yZU5vZGVzID0gW107CgoJCQkJCS8vIG1ha2UgYSByZXBsYWNlbWVudCA8dGQ+IGZvciBlYWNoIGNvbHVtbiB0aGUgc2VnbWVudCBvY2N1cGllcy4gd2lsbCBiZSBvbmUgZm9yIGVhY2ggY29sc3BhbgoJCQkJCWZvciAoaiA9IDA7IGogPCBjb2xTZWdzQmVsb3cubGVuZ3RoOyBqKyspIHsKCQkJCQkJbW9yZVRkID0gJCgnPHRkIGNsYXNzPSJmYy1tb3JlLWNlbGwiLz4nKS5hdHRyKCdyb3dzcGFuJywgcm93c3Bhbik7CgkJCQkJCXNlZ3NCZWxvdyA9IGNvbFNlZ3NCZWxvd1tqXTsKCQkJCQkJY2VsbCA9IHRoaXMuZ2V0Q2VsbChyb3csIHNlZy5sZWZ0Q29sICsgaik7CgkJCQkJCW1vcmVMaW5rID0gdGhpcy5yZW5kZXJNb3JlTGluayhjZWxsLCBbIHNlZyBdLmNvbmNhdChzZWdzQmVsb3cpKTsgLy8gY291bnQgc2VnIGFzIGhpZGRlbiB0b28KCQkJCQkJbW9yZVdyYXAgPSAkKCc8ZGl2Lz4nKS5hcHBlbmQobW9yZUxpbmspOwoJCQkJCQltb3JlVGQuYXBwZW5kKG1vcmVXcmFwKTsKCQkJCQkJc2VnTW9yZU5vZGVzLnB1c2gobW9yZVRkWzBdKTsKCQkJCQkJbW9yZU5vZGVzLnB1c2gobW9yZVRkWzBdKTsKCQkJCQl9CgoJCQkJCXRkLmFkZENsYXNzKCdmYy1saW1pdGVkJykuYWZ0ZXIoJChzZWdNb3JlTm9kZXMpKTsgLy8gaGlkZSBvcmlnaW5hbCA8dGQ+IGFuZCBpbmplY3QgcmVwbGFjZW1lbnRzCgkJCQkJbGltaXRlZE5vZGVzLnB1c2godGRbMF0pOwoJCQkJfQoJCQl9CgoJCQllbXB0eUNlbGxzVW50aWwodGhpcy5jb2xDbnQpOyAvLyBmaW5pc2ggb2ZmIHRoZSBsZXZlbAoJCQlyb3dTdHJ1Y3QubW9yZUVscyA9ICQobW9yZU5vZGVzKTsgLy8gZm9yIGVhc3kgdW5kb2luZyBsYXRlcgoJCQlyb3dTdHJ1Y3QubGltaXRlZEVscyA9ICQobGltaXRlZE5vZGVzKTsgLy8gZm9yIGVhc3kgdW5kb2luZyBsYXRlcgoJCX0KCX0sCgoKCS8vIFJldmVhbHMgYWxsIGxldmVscyBhbmQgcmVtb3ZlcyBhbGwgIm1vcmUiLXJlbGF0ZWQgZWxlbWVudHMgZm9yIGEgZ3JpZCdzIHJvdy4KCS8vIGByb3dgIGlzIGEgcm93IG51bWJlci4KCXVubGltaXRSb3c6IGZ1bmN0aW9uKHJvdykgewoJCXZhciByb3dTdHJ1Y3QgPSB0aGlzLnJvd1N0cnVjdHNbcm93XTsKCgkJaWYgKHJvd1N0cnVjdC5tb3JlRWxzKSB7CgkJCXJvd1N0cnVjdC5tb3JlRWxzLnJlbW92ZSgpOwoJCQlyb3dTdHJ1Y3QubW9yZUVscyA9IG51bGw7CgkJfQoKCQlpZiAocm93U3RydWN0LmxpbWl0ZWRFbHMpIHsKCQkJcm93U3RydWN0LmxpbWl0ZWRFbHMucmVtb3ZlQ2xhc3MoJ2ZjLWxpbWl0ZWQnKTsKCQkJcm93U3RydWN0LmxpbWl0ZWRFbHMgPSBudWxsOwoJCX0KCX0sCgoKCS8vIFJlbmRlcnMgYW4gPGE+IGVsZW1lbnQgdGhhdCByZXByZXNlbnRzIGhpZGRlbiBldmVudCBlbGVtZW50IGZvciBhIGNlbGwuCgkvLyBSZXNwb25zaWJsZSBmb3IgYXR0YWNoaW5nIGNsaWNrIGhhbmRsZXIgYXMgd2VsbC4KCXJlbmRlck1vcmVMaW5rOiBmdW5jdGlvbihjZWxsLCBoaWRkZW5TZWdzKSB7CgkJdmFyIF90aGlzID0gdGhpczsKCQl2YXIgdmlldyA9IHRoaXMudmlldzsKCgkJcmV0dXJuICQoJzxhIGNsYXNzPSJmYy1tb3JlIi8+JykKCQkJLnRleHQoCgkJCQl0aGlzLmdldE1vcmVMaW5rVGV4dChoaWRkZW5TZWdzLmxlbmd0aCkKCQkJKQoJCQkub24oJ2NsaWNrJywgZnVuY3Rpb24oZXYpIHsKCQkJCXZhciBjbGlja09wdGlvbiA9IHZpZXcub3B0KCdldmVudExpbWl0Q2xpY2snKTsKCQkJCXZhciBkYXRlID0gY2VsbC5zdGFydDsKCQkJCXZhciBtb3JlRWwgPSAkKHRoaXMpOwoJCQkJdmFyIGRheUVsID0gX3RoaXMuZ2V0Q2VsbERheUVsKGNlbGwpOwoJCQkJdmFyIGFsbFNlZ3MgPSBfdGhpcy5nZXRDZWxsU2VncyhjZWxsKTsKCgkJCQkvLyByZXNjb3BlIHRoZSBzZWdtZW50cyB0byBiZSB3aXRoaW4gdGhlIGNlbGwncyBkYXRlCgkJCQl2YXIgcmVzbGljZWRBbGxTZWdzID0gX3RoaXMucmVzbGljZURheVNlZ3MoYWxsU2VncywgZGF0ZSk7CgkJCQl2YXIgcmVzbGljZWRIaWRkZW5TZWdzID0gX3RoaXMucmVzbGljZURheVNlZ3MoaGlkZGVuU2VncywgZGF0ZSk7CgoJCQkJaWYgKHR5cGVvZiBjbGlja09wdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCS8vIHRoZSByZXR1cm5lZCB2YWx1ZSBjYW4gYmUgYW4gYXRvbWljIG9wdGlvbgoJCQkJCWNsaWNrT3B0aW9uID0gdmlldy50cmlnZ2VyKCdldmVudExpbWl0Q2xpY2snLCBudWxsLCB7CgkJCQkJCWRhdGU6IGRhdGUsCgkJCQkJCWRheUVsOiBkYXlFbCwKCQkJCQkJbW9yZUVsOiBtb3JlRWwsCgkJCQkJCXNlZ3M6IHJlc2xpY2VkQWxsU2VncywKCQkJCQkJaGlkZGVuU2VnczogcmVzbGljZWRIaWRkZW5TZWdzCgkJCQkJfSwgZXYpOwoJCQkJfQoKCQkJCWlmIChjbGlja09wdGlvbiA9PT0gJ3BvcG92ZXInKSB7CgkJCQkJX3RoaXMuc2hvd1NlZ1BvcG92ZXIoY2VsbCwgbW9yZUVsLCByZXNsaWNlZEFsbFNlZ3MpOwoJCQkJfQoJCQkJZWxzZSBpZiAodHlwZW9mIGNsaWNrT3B0aW9uID09PSAnc3RyaW5nJykgeyAvLyBhIHZpZXcgbmFtZQoJCQkJCXZpZXcuY2FsZW5kYXIuem9vbVRvKGRhdGUsIGNsaWNrT3B0aW9uKTsKCQkJCX0KCQkJfSk7Cgl9LAoKCgkvLyBSZXZlYWxzIHRoZSBwb3BvdmVyIHRoYXQgZGlzcGxheXMgYWxsIGV2ZW50cyB3aXRoaW4gYSBjZWxsCglzaG93U2VnUG9wb3ZlcjogZnVuY3Rpb24oY2VsbCwgbW9yZUxpbmssIHNlZ3MpIHsKCQl2YXIgX3RoaXMgPSB0aGlzOwoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBtb3JlV3JhcCA9IG1vcmVMaW5rLnBhcmVudCgpOyAvLyB0aGUgPGRpdj4gd3JhcHBlciBhcm91bmQgdGhlIDxhPgoJCXZhciB0b3BFbDsgLy8gdGhlIGVsZW1lbnQgd2Ugd2FudCB0byBtYXRjaCB0aGUgdG9wIGNvb3JkaW5hdGUgb2YKCQl2YXIgb3B0aW9uczsKCgkJaWYgKHRoaXMucm93Q250ID09IDEpIHsKCQkJdG9wRWwgPSB2aWV3LmVsOyAvLyB3aWxsIGNhdXNlIHRoZSBwb3BvdmVyIHRvIGNvdmVyIGFueSBzb3J0IG9mIGhlYWRlcgoJCX0KCQllbHNlIHsKCQkJdG9wRWwgPSB0aGlzLnJvd0Vscy5lcShjZWxsLnJvdyk7IC8vIHdpbGwgYWxpZ24gd2l0aCB0b3Agb2Ygcm93CgkJfQoKCQlvcHRpb25zID0gewoJCQljbGFzc05hbWU6ICdmYy1tb3JlLXBvcG92ZXInLAoJCQljb250ZW50OiB0aGlzLnJlbmRlclNlZ1BvcG92ZXJDb250ZW50KGNlbGwsIHNlZ3MpLAoJCQlwYXJlbnRFbDogdGhpcy5lbCwKCQkJdG9wOiB0b3BFbC5vZmZzZXQoKS50b3AsCgkJCWF1dG9IaWRlOiB0cnVlLCAvLyB3aGVuIHRoZSB1c2VyIGNsaWNrcyBlbHNld2hlcmUsIGhpZGUgdGhlIHBvcG92ZXIKCQkJdmlld3BvcnRDb25zdHJhaW46IHZpZXcub3B0KCdwb3BvdmVyVmlld3BvcnRDb25zdHJhaW4nKSwKCQkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCQkvLyBkZXN0cm95IGV2ZXJ5dGhpbmcgd2hlbiB0aGUgcG9wb3ZlciBpcyBoaWRkZW4KCQkJCV90aGlzLnNlZ1BvcG92ZXIuZGVzdHJveSgpOwoJCQkJX3RoaXMuc2VnUG9wb3ZlciA9IG51bGw7CgkJCQlfdGhpcy5wb3BvdmVyU2VncyA9IG51bGw7CgkJCX0KCQl9OwoKCQkvLyBEZXRlcm1pbmUgaG9yaXpvbnRhbCBjb29yZGluYXRlLgoJCS8vIFdlIHVzZSB0aGUgbW9yZVdyYXAgaW5zdGVhZCBvZiB0aGUgPHRkPiB0byBhdm9pZCBib3JkZXIgY29uZnVzaW9uLgoJCWlmICh0aGlzLmlzUlRMKSB7CgkJCW9wdGlvbnMucmlnaHQgPSBtb3JlV3JhcC5vZmZzZXQoKS5sZWZ0ICsgbW9yZVdyYXAub3V0ZXJXaWR0aCgpICsgMTsgLy8gKzEgdG8gYmUgb3ZlciBjZWxsIGJvcmRlcgoJCX0KCQllbHNlIHsKCQkJb3B0aW9ucy5sZWZ0ID0gbW9yZVdyYXAub2Zmc2V0KCkubGVmdCAtIDE7IC8vIC0xIHRvIGJlIG92ZXIgY2VsbCBib3JkZXIKCQl9CgoJCXRoaXMuc2VnUG9wb3ZlciA9IG5ldyBQb3BvdmVyKG9wdGlvbnMpOwoJCXRoaXMuc2VnUG9wb3Zlci5zaG93KCk7Cgl9LAoKCgkvLyBCdWlsZHMgdGhlIGlubmVyIERPTSBjb250ZW50cyBvZiB0aGUgc2VnbWVudCBwb3BvdmVyCglyZW5kZXJTZWdQb3BvdmVyQ29udGVudDogZnVuY3Rpb24oY2VsbCwgc2VncykgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBpc1RoZW1lID0gdmlldy5vcHQoJ3RoZW1lJyk7CgkJdmFyIHRpdGxlID0gY2VsbC5zdGFydC5mb3JtYXQodmlldy5vcHQoJ2RheVBvcG92ZXJGb3JtYXQnKSk7CgkJdmFyIGNvbnRlbnQgPSAkKAoJCQknPGRpdiBjbGFzcz0iZmMtaGVhZGVyICcgKyB2aWV3LndpZGdldEhlYWRlckNsYXNzICsgJyI+JyArCgkJCQknPHNwYW4gY2xhc3M9ImZjLWNsb3NlICcgKwoJCQkJCShpc1RoZW1lID8gJ3VpLWljb24gdWktaWNvbi1jbG9zZXRoaWNrJyA6ICdmYy1pY29uIGZjLWljb24teCcpICsKCQkJCSciPjwvc3Bhbj4nICsKCQkJCSc8c3BhbiBjbGFzcz0iZmMtdGl0bGUiPicgKwoJCQkJCWh0bWxFc2NhcGUodGl0bGUpICsKCQkJCSc8L3NwYW4+JyArCgkJCQknPGRpdiBjbGFzcz0iZmMtY2xlYXIiLz4nICsKCQkJJzwvZGl2PicgKwoJCQknPGRpdiBjbGFzcz0iZmMtYm9keSAnICsgdmlldy53aWRnZXRDb250ZW50Q2xhc3MgKyAnIj4nICsKCQkJCSc8ZGl2IGNsYXNzPSJmYy1ldmVudC1jb250YWluZXIiPjwvZGl2PicgKwoJCQknPC9kaXY+JwoJCSk7CgkJdmFyIHNlZ0NvbnRhaW5lciA9IGNvbnRlbnQuZmluZCgnLmZjLWV2ZW50LWNvbnRhaW5lcicpOwoJCXZhciBpOwoKCQkvLyByZW5kZXIgZWFjaCBzZWcncyBgZWxgIGFuZCBvbmx5IHJldHVybiB0aGUgdmlzaWJsZSBzZWdzCgkJc2VncyA9IHRoaXMucmVuZGVyRmdTZWdFbHMoc2VncywgdHJ1ZSk7IC8vIGRpc2FibGVSZXNpemluZz10cnVlCgkJdGhpcy5wb3BvdmVyU2VncyA9IHNlZ3M7CgoJCWZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7CgoJCQkvLyBiZWNhdXNlIHNlZ21lbnRzIGluIHRoZSBwb3BvdmVyIGFyZSBub3QgcGFydCBvZiBhIGdyaWQgY29vcmRpbmF0ZSBzeXN0ZW0sIHByb3ZpZGUgYSBoaW50IHRvIGFueQoJCQkvLyBncmlkcyB0aGF0IHdhbnQgdG8gZG8gZHJhZy1uLWRyb3AgYWJvdXQgd2hpY2ggY2VsbCBpdCBjYW1lIGZyb20KCQkJc2Vnc1tpXS5jZWxsID0gY2VsbDsKCgkJCXNlZ0NvbnRhaW5lci5hcHBlbmQoc2Vnc1tpXS5lbCk7CgkJfQoKCQlyZXR1cm4gY29udGVudDsKCX0sCgoKCS8vIEdpdmVuIHRoZSBldmVudHMgd2l0aGluIGFuIGFycmF5IG9mIHNlZ21lbnQgb2JqZWN0cywgcmVzbGljZSB0aGVtIHRvIGJlIGluIGEgc2luZ2xlIGRheQoJcmVzbGljZURheVNlZ3M6IGZ1bmN0aW9uKHNlZ3MsIGRheURhdGUpIHsKCgkJLy8gYnVpbGQgYW4gYXJyYXkgb2YgdGhlIG9yaWdpbmFsIGV2ZW50cwoJCXZhciBldmVudHMgPSAkLm1hcChzZWdzLCBmdW5jdGlvbihzZWcpIHsKCQkJcmV0dXJuIHNlZy5ldmVudDsKCQl9KTsKCgkJdmFyIGRheVN0YXJ0ID0gZGF5RGF0ZS5jbG9uZSgpLnN0cmlwVGltZSgpOwoJCXZhciBkYXlFbmQgPSBkYXlTdGFydC5jbG9uZSgpLmFkZCgxLCAnZGF5cycpOwoJCXZhciBkYXlSYW5nZSA9IHsgc3RhcnQ6IGRheVN0YXJ0LCBlbmQ6IGRheUVuZCB9OwoKCQkvLyBzbGljZSB0aGUgZXZlbnRzIHdpdGggYSBjdXN0b20gc2xpY2luZyBmdW5jdGlvbgoJCXJldHVybiB0aGlzLmV2ZW50c1RvU2VncygKCQkJZXZlbnRzLAoJCQlmdW5jdGlvbihyYW5nZSkgewoJCQkJdmFyIHNlZyA9IGludGVyc2VjdGlvblRvU2VnKHJhbmdlLCBkYXlSYW5nZSk7IC8vIHVuZGVmaW5kIGlmIG5vIGludGVyc2VjdGlvbgoJCQkJcmV0dXJuIHNlZyA\/IFsgc2VnIF0gOiBbXTsgLy8gbXVzdCByZXR1cm4gYW4gYXJyYXkgb2Ygc2VnbWVudHMKCQkJfQoJCSk7Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgdGhlIHRleHQgdGhhdCBzaG91bGQgYmUgaW5zaWRlIGEgIm1vcmUiIGxpbmssIGdpdmVuIHRoZSBudW1iZXIgb2YgZXZlbnRzIGl0IHJlcHJlc2VudHMKCWdldE1vcmVMaW5rVGV4dDogZnVuY3Rpb24obnVtKSB7CgkJdmFyIG9wdCA9IHRoaXMudmlldy5vcHQoJ2V2ZW50TGltaXRUZXh0Jyk7CgoJCWlmICh0eXBlb2Ygb3B0ID09PSAnZnVuY3Rpb24nKSB7CgkJCXJldHVybiBvcHQobnVtKTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiAnKycgKyBudW0gKyAnICcgKyBvcHQ7CgkJfQoJfSwKCgoJLy8gUmV0dXJucyBzZWdtZW50cyB3aXRoaW4gYSBnaXZlbiBjZWxsLgoJLy8gSWYgYHN0YXJ0TGV2ZWxgIGlzIHNwZWNpZmllZCwgcmV0dXJucyBvbmx5IGV2ZW50cyBpbmNsdWRpbmcgYW5kIGJlbG93IHRoYXQgbGV2ZWwuIE90aGVyd2lzZSByZXR1cm5zIGFsbCBzZWdzLgoJZ2V0Q2VsbFNlZ3M6IGZ1bmN0aW9uKGNlbGwsIHN0YXJ0TGV2ZWwpIHsKCQl2YXIgc2VnTWF0cml4ID0gdGhpcy5yb3dTdHJ1Y3RzW2NlbGwucm93XS5zZWdNYXRyaXg7CgkJdmFyIGxldmVsID0gc3RhcnRMZXZlbCB8fCAwOwoJCXZhciBzZWdzID0gW107CgkJdmFyIHNlZzsKCgkJd2hpbGUgKGxldmVsIDwgc2VnTWF0cml4Lmxlbmd0aCkgewoJCQlzZWcgPSBzZWdNYXRyaXhbbGV2ZWxdW2NlbGwuY29sXTsKCQkJaWYgKHNlZykgewoJCQkJc2Vncy5wdXNoKHNlZyk7CgkJCX0KCQkJbGV2ZWwrKzsKCQl9CgoJCXJldHVybiBzZWdzOwoJfQoKfSk7Cgo7OwoKLyogQSBjb21wb25lbnQgdGhhdCByZW5kZXJzIG9uZSBvciBtb3JlIGNvbHVtbnMgb2YgdmVydGljYWwgdGltZSBzbG90cwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCnZhciBUaW1lR3JpZCA9IEdyaWQuZXh0ZW5kKHsKCglzbG90RHVyYXRpb246IG51bGwsIC8vIGR1cmF0aW9uIG9mIGEgInNsb3QiLCBhIGRpc3RpbmN0IHRpbWUgc2VnbWVudCBvbiBnaXZlbiBkYXksIHZpc3VhbGl6ZWQgYnkgbGluZXMKCXNuYXBEdXJhdGlvbjogbnVsbCwgLy8gZ3JhbnVsYXJpdHkgb2YgdGltZSBmb3IgZHJhZ2dpbmcgYW5kIHNlbGVjdGluZwoKCW1pblRpbWU6IG51bGwsIC8vIER1cmF0aW9uIG9iamVjdCB0aGF0IGRlbm90ZXMgdGhlIGZpcnN0IHZpc2libGUgdGltZSBvZiBhbnkgZ2l2ZW4gZGF5CgltYXhUaW1lOiBudWxsLCAvLyBEdXJhdGlvbiBvYmplY3QgdGhhdCBkZW5vdGVzIHRoZSBleGNsdXNpdmUgdmlzaWJsZSBlbmQgdGltZSBvZiBhbnkgZ2l2ZW4gZGF5CgoJYXhpc0Zvcm1hdDogbnVsbCwgLy8gZm9ybWF0dGluZyBzdHJpbmcgZm9yIHRpbWVzIHJ1bm5pbmcgYWxvbmcgdmVydGljYWwgYXhpcwoKCWRheUVsczogbnVsbCwgLy8gY2VsbHMgZWxlbWVudHMgaW4gdGhlIGRheS1yb3cgYmFja2dyb3VuZAoJc2xhdEVsczogbnVsbCwgLy8gZWxlbWVudHMgcnVubmluZyBob3Jpem9udGFsbHkgYWNyb3NzIGFsbCBjb2x1bW5zCgoJc2xhdFRvcHM6IG51bGwsIC8vIGFuIGFycmF5IG9mIHRvcCBwb3NpdGlvbnMsIHJlbGF0aXZlIHRvIHRoZSBjb250YWluZXIuIGxhc3QgaXRlbSBob2xkcyBib3R0b20gb2YgbGFzdCBzbG90CgoJaGVscGVyRWw6IG51bGwsIC8vIGNlbGwgc2tlbGV0b24gZWxlbWVudCBmb3IgcmVuZGVyaW5nIHRoZSBtb2NrIGV2ZW50ICJoZWxwZXIiCgoJYnVzaW5lc3NIb3VyU2VnczogbnVsbCwKCgoJY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewoJCUdyaWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgLy8gY2FsbCB0aGUgc3VwZXItY29uc3RydWN0b3IKCQl0aGlzLnByb2Nlc3NPcHRpb25zKCk7Cgl9LAoKCgkvLyBSZW5kZXJzIHRoZSB0aW1lIGdyaWQgaW50byBgdGhpcy5lbGAsIHdoaWNoIHNob3VsZCBhbHJlYWR5IGJlIGFzc2lnbmVkLgoJLy8gUmVsaWVzIG9uIHRoZSB2aWV3J3MgY29sQ250LiBJbiB0aGUgZnV0dXJlLCB0aGlzIGNvbXBvbmVudCBzaG91bGQgcHJvYmFibHkgYmUgc2VsZi1zdWZmaWNpZW50LgoJcmVuZGVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsLmh0bWwodGhpcy5yZW5kZXJIdG1sKCkpOwoJCXRoaXMuZGF5RWxzID0gdGhpcy5lbC5maW5kKCcuZmMtZGF5Jyk7CgkJdGhpcy5zbGF0RWxzID0gdGhpcy5lbC5maW5kKCcuZmMtc2xhdHMgdHInKTsKCgkJdGhpcy5jb21wdXRlU2xhdFRvcHMoKTsKCQl0aGlzLnJlbmRlckJ1c2luZXNzSG91cnMoKTsKCQlHcmlkLnByb3RvdHlwZS5yZW5kZXIuY2FsbCh0aGlzKTsgLy8gY2FsbCB0aGUgc3VwZXItbWV0aG9kCgl9LAoKCglyZW5kZXJCdXNpbmVzc0hvdXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgZXZlbnRzID0gdGhpcy52aWV3LmNhbGVuZGFyLmdldEJ1c2luZXNzSG91cnNFdmVudHMoKTsKCQl0aGlzLmJ1c2luZXNzSG91clNlZ3MgPSB0aGlzLnJlbmRlckZpbGwoJ2J1c2luZXNzSG91cnMnLCB0aGlzLmV2ZW50c1RvU2VncyhldmVudHMpLCAnYmdldmVudCcpOwoJfSwKCgoJLy8gUmVuZGVycyB0aGUgYmFzaWMgSFRNTCBza2VsZXRvbiBmb3IgdGhlIGdyaWQKCXJlbmRlckh0bWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAnJyArCgkJCSc8ZGl2IGNsYXNzPSJmYy1iZyI+JyArCgkJCQknPHRhYmxlPicgKwoJCQkJCXRoaXMucm93SHRtbCgnc2xvdEJnJykgKyAvLyBsZXZlcmFnZXMgUm93UmVuZGVyZXIsIHdoaWNoIHdpbGwgY2FsbCBzbG90QmdDZWxsSHRtbAoJCQkJJzwvdGFibGU+JyArCgkJCSc8L2Rpdj4nICsKCQkJJzxkaXYgY2xhc3M9ImZjLXNsYXRzIj4nICsKCQkJCSc8dGFibGU+JyArCgkJCQkJdGhpcy5zbGF0Um93SHRtbCgpICsKCQkJCSc8L3RhYmxlPicgKwoJCQknPC9kaXY+JzsKCX0sCgoKCS8vIFJlbmRlcnMgdGhlIEhUTUwgZm9yIGEgdmVydGljYWwgYmFja2dyb3VuZCBjZWxsIGJlaGluZCB0aGUgc2xvdHMuCgkvLyBUaGlzIG1ldGhvZCBpcyBkaXN0aW5jdCBmcm9tICdiZycgYmVjYXVzZSB3ZSB3YW50ZWQgYSBuZXcgYHJvd1R5cGVgIHNvIHRoZSBWaWV3IGNvdWxkIGN1c3RvbWl6ZSB0aGUgcmVuZGVyaW5nLgoJc2xvdEJnQ2VsbEh0bWw6IGZ1bmN0aW9uKGNlbGwpIHsKCQlyZXR1cm4gdGhpcy5iZ0NlbGxIdG1sKGNlbGwpOwoJfSwKCgoJLy8gR2VuZXJhdGVzIHRoZSBIVE1MIGZvciB0aGUgaG9yaXpvbnRhbCAic2xhdHMiIHRoYXQgcnVuIHdpZHRoLXdpc2UuIEhhcyBhIHRpbWUgYXhpcyBvbiBhIHNpZGUuIERlcGVuZHMgb24gUlRMLgoJc2xhdFJvd0h0bWw6IGZ1bmN0aW9uKCkgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBpc1JUTCA9IHRoaXMuaXNSVEw7CgkJdmFyIGh0bWwgPSAnJzsKCQl2YXIgc2xvdE5vcm1hbCA9IHRoaXMuc2xvdER1cmF0aW9uLmFzTWludXRlcygpICUgMTUgPT09IDA7CgkJdmFyIHNsb3RUaW1lID0gbW9tZW50LmR1cmF0aW9uKCt0aGlzLm1pblRpbWUpOyAvLyB3aXNoIHRoZXJlIHdhcyAuY2xvbmUoKSBmb3IgZHVyYXRpb25zCgkJdmFyIHNsb3REYXRlOyAvLyB3aWxsIGJlIG9uIHRoZSB2aWV3J3MgZmlyc3QgZGF5LCBidXQgd2Ugb25seSBjYXJlIGFib3V0IGl0cyB0aW1lCgkJdmFyIG1pbnV0ZXM7CgkJdmFyIGF4aXNIdG1sOwoKCQkvLyBDYWxjdWxhdGUgdGhlIHRpbWUgZm9yIGVhY2ggc2xvdAoJCXdoaWxlIChzbG90VGltZSA8IHRoaXMubWF4VGltZSkgewoJCQlzbG90RGF0ZSA9IHRoaXMuc3RhcnQuY2xvbmUoKS50aW1lKHNsb3RUaW1lKTsgLy8gd2lsbCBiZSBpbiBVVEMgYnV0IHRoYXQncyBnb29kLiB0byBhdm9pZCBEU1QgaXNzdWVzCgkJCW1pbnV0ZXMgPSBzbG90RGF0ZS5taW51dGVzKCk7CgoJCQlheGlzSHRtbCA9CgkJCQknPHRkIGNsYXNzPSJmYy1heGlzIGZjLXRpbWUgJyArIHZpZXcud2lkZ2V0Q29udGVudENsYXNzICsgJyIgJyArIHZpZXcuYXhpc1N0eWxlQXR0cigpICsgJz4nICsKCQkJCQkoKCFzbG90Tm9ybWFsIHx8ICFtaW51dGVzKSA\/IC8vIGlmIGlycmVndWxhciBzbG90IGR1cmF0aW9uLCBvciBvbiB0aGUgaG91ciwgdGhlbiBkaXNwbGF5IHRoZSB0aW1lCgkJCQkJCSc8c3Bhbj4nICsgLy8gZm9yIG1hdGNoQ2VsbFdpZHRocwoJCQkJCQkJaHRtbEVzY2FwZShzbG90RGF0ZS5mb3JtYXQodGhpcy5heGlzRm9ybWF0KSkgKwoJCQkJCQknPC9zcGFuPicgOgoJCQkJCQknJwoJCQkJCQkpICsKCQkJCSc8L3RkPic7CgoJCQlodG1sICs9CgkJCQknPHRyICcgKyAoIW1pbnV0ZXMgPyAnJyA6ICdjbGFzcz0iZmMtbWlub3IiJykgKyAnPicgKwoJCQkJCSghaXNSVEwgPyBheGlzSHRtbCA6ICcnKSArCgkJCQkJJzx0ZCBjbGFzcz0iJyArIHZpZXcud2lkZ2V0Q29udGVudENsYXNzICsgJyIvPicgKwoJCQkJCShpc1JUTCA\/IGF4aXNIdG1sIDogJycpICsKCQkJCSI8L3RyPiI7CgoJCQlzbG90VGltZS5hZGQodGhpcy5zbG90RHVyYXRpb24pOwoJCX0KCgkJcmV0dXJuIGh0bWw7Cgl9LAoKCgkvKiBPcHRpb25zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBQYXJzZXMgdmFyaW91cyBvcHRpb25zIGludG8gcHJvcGVydGllcyBvZiB0aGlzIG9iamVjdAoJcHJvY2Vzc09wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBzbG90RHVyYXRpb24gPSB2aWV3Lm9wdCgnc2xvdER1cmF0aW9uJyk7CgkJdmFyIHNuYXBEdXJhdGlvbiA9IHZpZXcub3B0KCdzbmFwRHVyYXRpb24nKTsKCgkJc2xvdER1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKHNsb3REdXJhdGlvbik7CgkJc25hcER1cmF0aW9uID0gc25hcER1cmF0aW9uID8gbW9tZW50LmR1cmF0aW9uKHNuYXBEdXJhdGlvbikgOiBzbG90RHVyYXRpb247CgoJCXRoaXMuc2xvdER1cmF0aW9uID0gc2xvdER1cmF0aW9uOwoJCXRoaXMuc25hcER1cmF0aW9uID0gc25hcER1cmF0aW9uOwoKCQl0aGlzLm1pblRpbWUgPSBtb21lbnQuZHVyYXRpb24odmlldy5vcHQoJ21pblRpbWUnKSk7CgkJdGhpcy5tYXhUaW1lID0gbW9tZW50LmR1cmF0aW9uKHZpZXcub3B0KCdtYXhUaW1lJykpOwoKCQl0aGlzLmF4aXNGb3JtYXQgPSB2aWV3Lm9wdCgnYXhpc0Zvcm1hdCcpIHx8IHZpZXcub3B0KCdzbWFsbFRpbWVGb3JtYXQnKTsKCX0sCgoKCS8vIENvbXB1dGVzIGEgZGVmYXVsdCBjb2x1bW4gaGVhZGVyIGZvcm1hdHRpbmcgc3RyaW5nIGlmIGBjb2xGb3JtYXRgIGlzIG5vdCBleHBsaWNpdGx5IGRlZmluZWQKCWNvbXB1dGVDb2xIZWFkRm9ybWF0OiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5jb2xDbnQgPiAxKSB7IC8vIG11bHRpcGxlIGRheXMsIHNvIGZ1bGwgc2luZ2xlIGRhdGUgc3RyaW5nIFdPTidUIGJlIGluIHRpdGxlIHRleHQKCQkJcmV0dXJuIHRoaXMudmlldy5vcHQoJ2RheU9mTW9udGhGb3JtYXQnKTsgLy8gIlNhdCAxMi8xMCIKCQl9CgkJZWxzZSB7IC8vIHNpbmdsZSBkYXksIHNvIGZ1bGwgc2luZ2xlIGRhdGUgc3RyaW5nIHdpbGwgcHJvYmFibHkgYmUgaW4gdGl0bGUgdGV4dAoJCQlyZXR1cm4gJ2RkZGQnOyAvLyAiU2F0dXJkYXkiCgkJfQoJfSwKCgoJLy8gQ29tcHV0ZXMgYSBkZWZhdWx0IGV2ZW50IHRpbWUgZm9ybWF0dGluZyBzdHJpbmcgaWYgYHRpbWVGb3JtYXRgIGlzIG5vdCBleHBsaWNpdGx5IGRlZmluZWQKCWNvbXB1dGVFdmVudFRpbWVGb3JtYXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnZpZXcub3B0KCdub01lcmlkaWVtVGltZUZvcm1hdCcpOyAvLyBsaWtlICI2OjMwIiAobm8gQU0vUE0pCgl9LAoKCgkvLyBDb21wdXRlcyBhIGRlZmF1bHQgYGRpc3BsYXlFdmVudEVuZGAgdmFsdWUgaWYgb25lIGlzIG5vdCBleHBsaWNsdHkgZGVmaW5lZAoJY29tcHV0ZURpc3BsYXlFdmVudEVuZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCgkvKiBDZWxsIFN5c3RlbQoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gSW5pdGlhbGl6ZXMgcm93L2NvbCBpbmZvcm1hdGlvbgoJdXBkYXRlQ2VsbHM6IGZ1bmN0aW9uKCkgewoJCXZhciB2aWV3ID0gdGhpcy52aWV3OwoJCXZhciBjb2xEYXRhID0gW107CgkJdmFyIGRhdGU7CgoJCWRhdGUgPSB0aGlzLnN0YXJ0LmNsb25lKCk7CgkJd2hpbGUgKGRhdGUuaXNCZWZvcmUodGhpcy5lbmQpKSB7CgkJCWNvbERhdGEucHVzaCh7CgkJCQlkYXk6IGRhdGUuY2xvbmUoKQoJCQl9KTsKCQkJZGF0ZS5hZGQoMSwgJ2RheScpOwoJCQlkYXRlID0gdmlldy5za2lwSGlkZGVuRGF5cyhkYXRlKTsKCQl9CgoJCWlmICh0aGlzLmlzUlRMKSB7CgkJCWNvbERhdGEucmV2ZXJzZSgpOwoJCX0KCgkJdGhpcy5jb2xEYXRhID0gY29sRGF0YTsKCQl0aGlzLmNvbENudCA9IGNvbERhdGEubGVuZ3RoOwoJCXRoaXMucm93Q250ID0gTWF0aC5jZWlsKCh0aGlzLm1heFRpbWUgLSB0aGlzLm1pblRpbWUpIC8gdGhpcy5zbmFwRHVyYXRpb24pOyAvLyAjIG9mIHZlcnRpY2FsIHNuYXBzCgl9LAoKCgkvLyBHaXZlbiBhIGNlbGwgb2JqZWN0LCBnZW5lcmF0ZXMgYSByYW5nZSBvYmplY3QKCWNvbXB1dGVDZWxsUmFuZ2U6IGZ1bmN0aW9uKGNlbGwpIHsKCQl2YXIgdGltZSA9IHRoaXMuY29tcHV0ZVNuYXBUaW1lKGNlbGwucm93KTsKCQl2YXIgc3RhcnQgPSB0aGlzLnZpZXcuY2FsZW5kYXIucmV6b25lRGF0ZShjZWxsLmRheSkudGltZSh0aW1lKTsKCQl2YXIgZW5kID0gc3RhcnQuY2xvbmUoKS5hZGQodGhpcy5zbmFwRHVyYXRpb24pOwoKCQlyZXR1cm4geyBzdGFydDogc3RhcnQsIGVuZDogZW5kIH07Cgl9LAoKCgkvLyBSZXRyaWV2ZXMgdGhlIGVsZW1lbnQgcmVwcmVzZW50aW5nIHRoZSBnaXZlbiBjb2x1bW4KCWdldENvbEVsOiBmdW5jdGlvbihjb2wpIHsKCQlyZXR1cm4gdGhpcy5kYXlFbHMuZXEoY29sKTsKCX0sCgoKCS8qIERhdGVzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBHaXZlbiBhIHJvdyBudW1iZXIgb2YgdGhlIGdyaWQsIHJlcHJlc2VudGluZyBhICJzbmFwIiwgcmV0dXJucyBhIHRpbWUgKER1cmF0aW9uKSBmcm9tIGl0cyBzdGFydC1vZi1kYXkKCWNvbXB1dGVTbmFwVGltZTogZnVuY3Rpb24ocm93KSB7CgkJcmV0dXJuIG1vbWVudC5kdXJhdGlvbih0aGlzLm1pblRpbWUgKyB0aGlzLnNuYXBEdXJhdGlvbiAqIHJvdyk7Cgl9LAoKCgkvLyBTbGljZXMgdXAgYSBkYXRlIHJhbmdlIGJ5IGNvbHVtbiBpbnRvIGFuIGFycmF5IG9mIHNlZ21lbnRzCglyYW5nZVRvU2VnczogZnVuY3Rpb24ocmFuZ2UpIHsKCQl2YXIgY29sQ250ID0gdGhpcy5jb2xDbnQ7CgkJdmFyIHNlZ3MgPSBbXTsKCQl2YXIgc2VnOwoJCXZhciBjb2w7CgkJdmFyIGNvbERhdGU7CgkJdmFyIGNvbFJhbmdlOwoKCQkvLyBub3JtYWxpemUgOigKCQlyYW5nZSA9IHsKCQkJc3RhcnQ6IHJhbmdlLnN0YXJ0LmNsb25lKCkuc3RyaXBab25lKCksCgkJCWVuZDogcmFuZ2UuZW5kLmNsb25lKCkuc3RyaXBab25lKCkKCQl9OwoKCQlmb3IgKGNvbCA9IDA7IGNvbCA8IGNvbENudDsgY29sKyspIHsKCQkJY29sRGF0ZSA9IHRoaXMuY29sRGF0YVtjb2xdLmRheTsgLy8gd2lsbCBiZSBhbWJpZyB0aW1lL3RpbWV6b25lCgkJCWNvbFJhbmdlID0gewoJCQkJc3RhcnQ6IGNvbERhdGUuY2xvbmUoKS50aW1lKHRoaXMubWluVGltZSksCgkJCQllbmQ6IGNvbERhdGUuY2xvbmUoKS50aW1lKHRoaXMubWF4VGltZSkKCQkJfTsKCQkJc2VnID0gaW50ZXJzZWN0aW9uVG9TZWcocmFuZ2UsIGNvbFJhbmdlKTsgLy8gYm90aCB3aWxsIGJlIGFtYmlnIHRpbWV6b25lCgkJCWlmIChzZWcpIHsKCQkJCXNlZy5jb2wgPSBjb2w7CgkJCQlzZWdzLnB1c2goc2VnKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHNlZ3M7Cgl9LAoKCgkvKiBDb29yZGluYXRlcwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gQ2FsbGVkIHdoZW4gdGhlcmUgaXMgYSB3aW5kb3cgcmVzaXplL3pvb20gYW5kIHdlIG5lZWQgdG8gcmVjYWxjdWxhdGUgY29vcmRpbmF0ZXMgZm9yIHRoZSBncmlkCglyZXNpemU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuY29tcHV0ZVNsYXRUb3BzKCk7CgkJdGhpcy51cGRhdGVTZWdWZXJ0aWNhbHMoKTsKCX0sCgoKCS8vIENvbXB1dGVzIHRoZSB0b3AvYm90dG9tIGNvb3JkaW5hdGVzIG9mIGVhY2ggInNuYXAiIHJvd3MKCWNvbXB1dGVSb3dDb29yZHM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcmlnaW5Ub3AgPSB0aGlzLmVsLm9mZnNldCgpLnRvcDsKCQl2YXIgaXRlbXMgPSBbXTsKCQl2YXIgaTsKCQl2YXIgaXRlbTsKCgkJZm9yIChpID0gMDsgaSA8IHRoaXMucm93Q250OyBpKyspIHsKCQkJaXRlbSA9IHsKCQkJCXRvcDogb3JpZ2luVG9wICsgdGhpcy5jb21wdXRlVGltZVRvcCh0aGlzLmNvbXB1dGVTbmFwVGltZShpKSkKCQkJfTsKCQkJaWYgKGkgPiAwKSB7CgkJCQlpdGVtc1tpIC0gMV0uYm90dG9tID0gaXRlbS50b3A7CgkJCX0KCQkJaXRlbXMucHVzaChpdGVtKTsKCQl9CgkJaXRlbS5ib3R0b20gPSBpdGVtLnRvcCArIHRoaXMuY29tcHV0ZVRpbWVUb3AodGhpcy5jb21wdXRlU25hcFRpbWUoaSkpOwoKCQlyZXR1cm4gaXRlbXM7Cgl9LAoKCgkvLyBDb21wdXRlcyB0aGUgdG9wIGNvb3JkaW5hdGUsIHJlbGF0aXZlIHRvIHRoZSBib3VuZHMgb2YgdGhlIGdyaWQsIG9mIHRoZSBnaXZlbiBkYXRlLgoJLy8gQSBgc3RhcnRPZkRheURhdGVgIG11c3QgYmUgZ2l2ZW4gZm9yIGF2b2lkaW5nIGFtYmlndWl0eSBvdmVyIGhvdyB0byB0cmVhdCBtaWRuaWdodC4KCWNvbXB1dGVEYXRlVG9wOiBmdW5jdGlvbihkYXRlLCBzdGFydE9mRGF5RGF0ZSkgewoJCXJldHVybiB0aGlzLmNvbXB1dGVUaW1lVG9wKAoJCQltb21lbnQuZHVyYXRpb24oCgkJCQlkYXRlLmNsb25lKCkuc3RyaXBab25lKCkgLSBzdGFydE9mRGF5RGF0ZS5jbG9uZSgpLnN0cmlwVGltZSgpCgkJCSkKCQkpOwoJfSwKCgoJLy8gQ29tcHV0ZXMgdGhlIHRvcCBjb29yZGluYXRlLCByZWxhdGl2ZSB0byB0aGUgYm91bmRzIG9mIHRoZSBncmlkLCBvZiB0aGUgZ2l2ZW4gdGltZSAoYSBEdXJhdGlvbikuCgljb21wdXRlVGltZVRvcDogZnVuY3Rpb24odGltZSkgewoJCXZhciBzbGF0Q292ZXJhZ2UgPSAodGltZSAtIHRoaXMubWluVGltZSkgLyB0aGlzLnNsb3REdXJhdGlvbjsgLy8gZmxvYXRpbmctcG9pbnQgdmFsdWUgb2YgIyBvZiBzbG90cyBjb3ZlcmVkCgkJdmFyIHNsYXRJbmRleDsKCQl2YXIgc2xhdFJlbWFpbmRlcjsKCQl2YXIgc2xhdFRvcDsKCQl2YXIgc2xhdEJvdHRvbTsKCgkJLy8gY29uc3RyYWluLiBiZWNhdXNlIG1pblRpbWUvbWF4VGltZSBtaWdodCBiZSBjdXN0b21pemVkCgkJc2xhdENvdmVyYWdlID0gTWF0aC5tYXgoMCwgc2xhdENvdmVyYWdlKTsKCQlzbGF0Q292ZXJhZ2UgPSBNYXRoLm1pbih0aGlzLnNsYXRFbHMubGVuZ3RoLCBzbGF0Q292ZXJhZ2UpOwoKCQlzbGF0SW5kZXggPSBNYXRoLmZsb29yKHNsYXRDb3ZlcmFnZSk7IC8vIGFuIGludGVnZXIgaW5kZXggb2YgdGhlIGZ1cnRoZXN0IHdob2xlIHNsb3QKCQlzbGF0UmVtYWluZGVyID0gc2xhdENvdmVyYWdlIC0gc2xhdEluZGV4OwoJCXNsYXRUb3AgPSB0aGlzLnNsYXRUb3BzW3NsYXRJbmRleF07IC8vIHRoZSB0b3AgcG9zaXRpb24gb2YgdGhlIGZ1cnRoZXN0IHdob2xlIHNsb3QKCgkJaWYgKHNsYXRSZW1haW5kZXIpIHsgLy8gdGltZSBzcGFucyBwYXJ0LXdheSBpbnRvIHRoZSBzbG90CgkJCXNsYXRCb3R0b20gPSB0aGlzLnNsYXRUb3BzW3NsYXRJbmRleCArIDFdOwoJCQlyZXR1cm4gc2xhdFRvcCArIChzbGF0Qm90dG9tIC0gc2xhdFRvcCkgKiBzbGF0UmVtYWluZGVyOyAvLyBwYXJ0LXdheSBiZXR3ZWVuIHNsb3RzCgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gc2xhdFRvcDsKCQl9Cgl9LAoKCgkvLyBRdWVyaWVzIGVhY2ggYHNsYXRFbGAgZm9yIGl0cyBwb3NpdGlvbiByZWxhdGl2ZSB0byB0aGUgZ3JpZCdzIGNvbnRhaW5lciBhbmQgc3RvcmVzIGl0IGluIGBzbGF0VG9wc2AuCgkvLyBJbmNsdWRlcyB0aGUgdGhlIGJvdHRvbSBvZiB0aGUgbGFzdCBzbGF0IGFzIHRoZSBsYXN0IGl0ZW0gaW4gdGhlIGFycmF5LgoJY29tcHV0ZVNsYXRUb3BzOiBmdW5jdGlvbigpIHsKCQl2YXIgdG9wcyA9IFtdOwoJCXZhciB0b3A7CgoJCXRoaXMuc2xhdEVscy5lYWNoKGZ1bmN0aW9uKGksIG5vZGUpIHsKCQkJdG9wID0gJChub2RlKS5wb3NpdGlvbigpLnRvcDsKCQkJdG9wcy5wdXNoKHRvcCk7CgkJfSk7CgoJCXRvcHMucHVzaCh0b3AgKyB0aGlzLnNsYXRFbHMubGFzdCgpLm91dGVySGVpZ2h0KCkpOyAvLyBib3R0b20gb2YgdGhlIGxhc3Qgc2xhdAoKCQl0aGlzLnNsYXRUb3BzID0gdG9wczsKCX0sCgoKCS8qIEV2ZW50IERyYWcgVmlzdWFsaXphdGlvbgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGFuIGV2ZW50IGJlaW5nIGRyYWdnZWQgb3ZlciB0aGUgc3BlY2lmaWVkIGRhdGUocykuCgkvLyBkcm9wTG9jYXRpb24ncyBlbmQgbWlnaHQgYmUgbnVsbCwgYXMgd2VsbCBhcyBgc2VnYC4gU2VlIEdyaWQ6OnJlbmRlckRyYWcgZm9yIG1vcmUgaW5mby4KCS8vIEEgcmV0dXJuZWQgdmFsdWUgb2YgYHRydWVgIHNpZ25hbHMgdGhhdCBhIG1vY2sgImhlbHBlciIgZXZlbnQgaGFzIGJlZW4gcmVuZGVyZWQuCglyZW5kZXJEcmFnOiBmdW5jdGlvbihkcm9wTG9jYXRpb24sIHNlZykgewoJCXZhciBvcGFjaXR5OwoKCQlpZiAoc2VnKSB7IC8vIGlmIHRoZXJlIGlzIGV2ZW50IGluZm9ybWF0aW9uIGZvciB0aGlzIGRyYWcsIHJlbmRlciBhIGhlbHBlciBldmVudAoJCQl0aGlzLnJlbmRlclJhbmdlSGVscGVyKGRyb3BMb2NhdGlvbiwgc2VnKTsKCgkJCW9wYWNpdHkgPSB0aGlzLnZpZXcub3B0KCdkcmFnT3BhY2l0eScpOwoJCQlpZiAob3BhY2l0eSAhPT0gdW5kZWZpbmVkKSB7CgkJCQl0aGlzLmhlbHBlckVsLmNzcygnb3BhY2l0eScsIG9wYWNpdHkpOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsgLy8gc2lnbmFsIHRoYXQgYSBoZWxwZXIgaGFzIGJlZW4gcmVuZGVyZWQKCQl9CgkJZWxzZSB7CgkJCS8vIG90aGVyd2lzZSwganVzdCByZW5kZXIgYSBoaWdobGlnaHQKCQkJdGhpcy5yZW5kZXJIaWdobGlnaHQoCgkJCQl0aGlzLnZpZXcuY2FsZW5kYXIuZW5zdXJlVmlzaWJsZUV2ZW50UmFuZ2UoZHJvcExvY2F0aW9uKSAvLyBuZWVkcyB0byBiZSBhIHByb3BlciByYW5nZQoJCQkpOwoJCX0KCX0sCgoKCS8vIFVucmVuZGVycyBhbnkgdmlzdWFsIGluZGljYXRpb24gb2YgYW4gZXZlbnQgYmVpbmcgZHJhZ2dlZAoJZGVzdHJveURyYWc6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZGVzdHJveUhlbHBlcigpOwoJCXRoaXMuZGVzdHJveUhpZ2hsaWdodCgpOwoJfSwKCgoJLyogRXZlbnQgUmVzaXplIFZpc3VhbGl6YXRpb24KCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIFJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBiZWluZyByZXNpemVkCglyZW5kZXJFdmVudFJlc2l6ZTogZnVuY3Rpb24ocmFuZ2UsIHNlZykgewoJCXRoaXMucmVuZGVyUmFuZ2VIZWxwZXIocmFuZ2UsIHNlZyk7Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYW55IHZpc3VhbCBpbmRpY2F0aW9uIG9mIGFuIGV2ZW50IGJlaW5nIHJlc2l6ZWQKCWRlc3Ryb3lFdmVudFJlc2l6ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5kZXN0cm95SGVscGVyKCk7Cgl9LAoKCgkvKiBFdmVudCBIZWxwZXIKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIFJlbmRlcnMgYSBtb2NrICJoZWxwZXIiIGV2ZW50LiBgc291cmNlU2VnYCBpcyB0aGUgb3JpZ2luYWwgc2VnbWVudCBvYmplY3QgYW5kIG1pZ2h0IGJlIG51bGwgKGFuIGV4dGVybmFsIGRyYWcpCglyZW5kZXJIZWxwZXI6IGZ1bmN0aW9uKGV2ZW50LCBzb3VyY2VTZWcpIHsKCQl2YXIgc2VncyA9IHRoaXMuZXZlbnRzVG9TZWdzKFsgZXZlbnQgXSk7CgkJdmFyIHRhYmxlRWw7CgkJdmFyIGksIHNlZzsKCQl2YXIgc291cmNlRWw7CgoJCXNlZ3MgPSB0aGlzLnJlbmRlckZnU2VnRWxzKHNlZ3MpOyAvLyBhc3NpZ25zIGVhY2ggc2VnJ3MgZWwgYW5kIHJldHVybnMgYSBzdWJzZXQgb2Ygc2VncyB0aGF0IHdlcmUgcmVuZGVyZWQKCQl0YWJsZUVsID0gdGhpcy5yZW5kZXJTZWdUYWJsZShzZWdzKTsKCgkJLy8gVHJ5IHRvIG1ha2UgdGhlIHNlZ21lbnQgdGhhdCBpcyBpbiB0aGUgc2FtZSByb3cgYXMgc291cmNlU2VnIGxvb2sgdGhlIHNhbWUKCQlmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgewoJCQlzZWcgPSBzZWdzW2ldOwoJCQlpZiAoc291cmNlU2VnICYmIHNvdXJjZVNlZy5jb2wgPT09IHNlZy5jb2wpIHsKCQkJCXNvdXJjZUVsID0gc291cmNlU2VnLmVsOwoJCQkJc2VnLmVsLmNzcyh7CgkJCQkJbGVmdDogc291cmNlRWwuY3NzKCdsZWZ0JyksCgkJCQkJcmlnaHQ6IHNvdXJjZUVsLmNzcygncmlnaHQnKSwKCQkJCQknbWFyZ2luLWxlZnQnOiBzb3VyY2VFbC5jc3MoJ21hcmdpbi1sZWZ0JyksCgkJCQkJJ21hcmdpbi1yaWdodCc6IHNvdXJjZUVsLmNzcygnbWFyZ2luLXJpZ2h0JykKCQkJCX0pOwoJCQl9CgkJfQoKCQl0aGlzLmhlbHBlckVsID0gJCgnPGRpdiBjbGFzcz0iZmMtaGVscGVyLXNrZWxldG9uIi8+JykKCQkJLmFwcGVuZCh0YWJsZUVsKQoJCQkJLmFwcGVuZFRvKHRoaXMuZWwpOwoJfSwKCgoJLy8gVW5yZW5kZXJzIGFueSBtb2NrIGhlbHBlciBldmVudAoJZGVzdHJveUhlbHBlcjogZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMuaGVscGVyRWwpIHsKCQkJdGhpcy5oZWxwZXJFbC5yZW1vdmUoKTsKCQkJdGhpcy5oZWxwZXJFbCA9IG51bGw7CgkJfQoJfSwKCgoJLyogU2VsZWN0aW9uCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYSBzZWxlY3Rpb24uIE92ZXJyaWRlcyB0aGUgZGVmYXVsdCwgd2hpY2ggd2FzIHRvIHNpbXBseSByZW5kZXIgYSBoaWdobGlnaHQuCglyZW5kZXJTZWxlY3Rpb246IGZ1bmN0aW9uKHJhbmdlKSB7CgkJaWYgKHRoaXMudmlldy5vcHQoJ3NlbGVjdEhlbHBlcicpKSB7IC8vIHRoaXMgc2V0dGluZyBzaWduYWxzIHRoYXQgYSBtb2NrIGhlbHBlciBldmVudCBzaG91bGQgYmUgcmVuZGVyZWQKCQkJdGhpcy5yZW5kZXJSYW5nZUhlbHBlcihyYW5nZSk7CgkJfQoJCWVsc2UgewoJCQl0aGlzLnJlbmRlckhpZ2hsaWdodChyYW5nZSk7CgkJfQoJfSwKCgoJLy8gVW5yZW5kZXJzIGFueSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhIHNlbGVjdGlvbgoJZGVzdHJveVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5kZXN0cm95SGVscGVyKCk7CgkJdGhpcy5kZXN0cm95SGlnaGxpZ2h0KCk7Cgl9LAoKCgkvKiBGaWxsIFN5c3RlbSAoaGlnaGxpZ2h0LCBiYWNrZ3JvdW5kIGV2ZW50cywgYnVzaW5lc3MgaG91cnMpCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBSZW5kZXJzIGEgc2V0IG9mIHJlY3RhbmdsZXMgb3ZlciB0aGUgZ2l2ZW4gdGltZSBzZWdtZW50cy4KCS8vIE9ubHkgcmV0dXJucyBzZWdtZW50cyB0aGF0IHN1Y2Nlc3NmdWxseSByZW5kZXJlZC4KCXJlbmRlckZpbGw6IGZ1bmN0aW9uKHR5cGUsIHNlZ3MsIGNsYXNzTmFtZSkgewoJCXZhciBzZWdDb2xzOwoJCXZhciBza2VsZXRvbkVsOwoJCXZhciB0ckVsOwoJCXZhciBjb2wsIGNvbFNlZ3M7CgkJdmFyIHRkRWw7CgkJdmFyIGNvbnRhaW5lckVsOwoJCXZhciBkYXlEYXRlOwoJCXZhciBpLCBzZWc7CgoJCWlmIChzZWdzLmxlbmd0aCkgewoKCQkJc2VncyA9IHRoaXMucmVuZGVyRmlsbFNlZ0Vscyh0eXBlLCBzZWdzKTsgLy8gYXNzaWduZXMgYC5lbGAgdG8gZWFjaCBzZWcuIHJldHVybnMgc3VjY2Vzc2Z1bGx5IHJlbmRlcmVkIHNlZ3MKCQkJc2VnQ29scyA9IHRoaXMuZ3JvdXBTZWdDb2xzKHNlZ3MpOyAvLyBncm91cCBpbnRvIHN1Yi1hcnJheXMsIGFuZCBhc3NpZ25zICdjb2wnIHRvIGVhY2ggc2VnCgoJCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgdHlwZS50b0xvd2VyQ2FzZSgpOwoJCQlza2VsZXRvbkVsID0gJCgKCQkJCSc8ZGl2IGNsYXNzPSJmYy0nICsgY2xhc3NOYW1lICsgJy1za2VsZXRvbiI+JyArCgkJCQkJJzx0YWJsZT48dHIvPjwvdGFibGU+JyArCgkJCQknPC9kaXY+JwoJCQkpOwoJCQl0ckVsID0gc2tlbGV0b25FbC5maW5kKCd0cicpOwoKCQkJZm9yIChjb2wgPSAwOyBjb2wgPCBzZWdDb2xzLmxlbmd0aDsgY29sKyspIHsKCQkJCWNvbFNlZ3MgPSBzZWdDb2xzW2NvbF07CgkJCQl0ZEVsID0gJCgnPHRkLz4nKS5hcHBlbmRUbyh0ckVsKTsKCgkJCQlpZiAoY29sU2Vncy5sZW5ndGgpIHsKCQkJCQljb250YWluZXJFbCA9ICQoJzxkaXYgY2xhc3M9ImZjLScgKyBjbGFzc05hbWUgKyAnLWNvbnRhaW5lciIvPicpLmFwcGVuZFRvKHRkRWwpOwoJCQkJCWRheURhdGUgPSB0aGlzLmNvbERhdGFbY29sXS5kYXk7CgoJCQkJCWZvciAoaSA9IDA7IGkgPCBjb2xTZWdzLmxlbmd0aDsgaSsrKSB7CgkJCQkJCXNlZyA9IGNvbFNlZ3NbaV07CgkJCQkJCWNvbnRhaW5lckVsLmFwcGVuZCgKCQkJCQkJCXNlZy5lbC5jc3MoewoJCQkJCQkJCXRvcDogdGhpcy5jb21wdXRlRGF0ZVRvcChzZWcuc3RhcnQsIGRheURhdGUpLAoJCQkJCQkJCWJvdHRvbTogLXRoaXMuY29tcHV0ZURhdGVUb3Aoc2VnLmVuZCwgZGF5RGF0ZSkgLy8gdGhlIHkgcG9zaXRpb24gb2YgdGhlIGJvdHRvbSBlZGdlCgkJCQkJCQl9KQoJCQkJCQkpOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJdGhpcy5ib29rZW5kQ2VsbHModHJFbCwgdHlwZSk7CgoJCQl0aGlzLmVsLmFwcGVuZChza2VsZXRvbkVsKTsKCQkJdGhpcy5lbHNCeUZpbGxbdHlwZV0gPSBza2VsZXRvbkVsOwoJCX0KCgkJcmV0dXJuIHNlZ3M7Cgl9Cgp9KTsKCjs7CgovKiBFdmVudC1yZW5kZXJpbmcgbWV0aG9kcyBmb3IgdGhlIFRpbWVHcmlkIGNsYXNzCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKVGltZUdyaWQubWl4aW4oewoKCWV2ZW50U2tlbGV0b25FbDogbnVsbCwgLy8gaGFzIGNlbGxzIHdpdGggZXZlbnQtY29udGFpbmVycywgd2hpY2ggY29udGFpbiBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQgZXZlbnQgZWxlbWVudHMKCgoJLy8gUmVuZGVycyB0aGUgZ2l2ZW4gZm9yZWdyb3VuZCBldmVudCBzZWdtZW50cyBvbnRvIHRoZSBncmlkCglyZW5kZXJGZ1NlZ3M6IGZ1bmN0aW9uKHNlZ3MpIHsKCQlzZWdzID0gdGhpcy5yZW5kZXJGZ1NlZ0VscyhzZWdzKTsgLy8gcmV0dXJucyBhIHN1YnNldCBvZiB0aGUgc2Vncy4gc2VncyB0aGF0IHdlcmUgYWN0dWFsbHkgcmVuZGVyZWQKCgkJdGhpcy5lbC5hcHBlbmQoCgkJCXRoaXMuZXZlbnRTa2VsZXRvbkVsID0gJCgnPGRpdiBjbGFzcz0iZmMtY29udGVudC1za2VsZXRvbiIvPicpCgkJCQkuYXBwZW5kKHRoaXMucmVuZGVyU2VnVGFibGUoc2VncykpCgkJKTsKCgkJcmV0dXJuIHNlZ3M7IC8vIHJldHVybiBvbmx5IHRoZSBzZWdzIHRoYXQgd2VyZSBhY3R1YWxseSByZW5kZXJlZAoJfSwKCgoJLy8gVW5yZW5kZXJzIGFsbCBjdXJyZW50bHkgcmVuZGVyZWQgZm9yZWdyb3VuZCBldmVudCBzZWdtZW50cwoJZGVzdHJveUZnU2VnczogZnVuY3Rpb24oc2VncykgewoJCWlmICh0aGlzLmV2ZW50U2tlbGV0b25FbCkgewoJCQl0aGlzLmV2ZW50U2tlbGV0b25FbC5yZW1vdmUoKTsKCQkJdGhpcy5ldmVudFNrZWxldG9uRWwgPSBudWxsOwoJCX0KCX0sCgoKCS8vIFJlbmRlcnMgYW5kIHJldHVybnMgdGhlIDx0YWJsZT4gcG9ydGlvbiBvZiB0aGUgZXZlbnQtc2tlbGV0b24uCgkvLyBSZXR1cm5zIGFuIG9iamVjdCB3aXRoIHByb3BlcnRpZXMgJ3Rib2R5RWwnIGFuZCAnc2VncycuCglyZW5kZXJTZWdUYWJsZTogZnVuY3Rpb24oc2VncykgewoJCXZhciB0YWJsZUVsID0gJCgnPHRhYmxlPjx0ci8+PC90YWJsZT4nKTsKCQl2YXIgdHJFbCA9IHRhYmxlRWwuZmluZCgndHInKTsKCQl2YXIgc2VnQ29sczsKCQl2YXIgaSwgc2VnOwoJCXZhciBjb2wsIGNvbFNlZ3M7CgkJdmFyIGNvbnRhaW5lckVsOwoKCQlzZWdDb2xzID0gdGhpcy5ncm91cFNlZ0NvbHMoc2Vncyk7IC8vIGdyb3VwIGludG8gc3ViLWFycmF5cywgYW5kIGFzc2lnbnMgJ2NvbCcgdG8gZWFjaCBzZWcKCgkJdGhpcy5jb21wdXRlU2VnVmVydGljYWxzKHNlZ3MpOyAvLyBjb21wdXRlIGFuZCBhc3NpZ24gdG9wL2JvdHRvbQoKCQlmb3IgKGNvbCA9IDA7IGNvbCA8IHNlZ0NvbHMubGVuZ3RoOyBjb2wrKykgeyAvLyBpdGVyYXRlIGVhY2ggY29sdW1uIGdyb3VwaW5nCgkJCWNvbFNlZ3MgPSBzZWdDb2xzW2NvbF07CgkJCXBsYWNlU2xvdFNlZ3MoY29sU2Vncyk7IC8vIGNvbXB1dGUgaG9yaXpvbnRhbCBjb29yZGluYXRlcywgei1pbmRleCdzLCBhbmQgcmVvcmRlciB0aGUgYXJyYXkKCgkJCWNvbnRhaW5lckVsID0gJCgnPGRpdiBjbGFzcz0iZmMtZXZlbnQtY29udGFpbmVyIi8+Jyk7CgoJCQkvLyBhc3NpZ24gcG9zaXRpb25pbmcgQ1NTIGFuZCBpbnNlcnQgaW50byBjb250YWluZXIKCQkJZm9yIChpID0gMDsgaSA8IGNvbFNlZ3MubGVuZ3RoOyBpKyspIHsKCQkJCXNlZyA9IGNvbFNlZ3NbaV07CgkJCQlzZWcuZWwuY3NzKHRoaXMuZ2VuZXJhdGVTZWdQb3NpdGlvbkNzcyhzZWcpKTsKCgkJCQkvLyBpZiB0aGUgaGVpZ2h0IGlzIHNob3J0LCBhZGQgYSBjbGFzc05hbWUgZm9yIGFsdGVybmF0ZSBzdHlsaW5nCgkJCQlpZiAoc2VnLmJvdHRvbSAtIHNlZy50b3AgPCAzMCkgewoJCQkJCXNlZy5lbC5hZGRDbGFzcygnZmMtc2hvcnQnKTsKCQkJCX0KCgkJCQljb250YWluZXJFbC5hcHBlbmQoc2VnLmVsKTsKCQkJfQoKCQkJdHJFbC5hcHBlbmQoJCgnPHRkLz4nKS5hcHBlbmQoY29udGFpbmVyRWwpKTsKCQl9CgoJCXRoaXMuYm9va2VuZENlbGxzKHRyRWwsICdldmVudFNrZWxldG9uJyk7CgoJCXJldHVybiB0YWJsZUVsOwoJfSwKCgoJLy8gUmVmcmVzaGVzIHRoZSBDU1MgdG9wL2JvdHRvbSBjb29yZGluYXRlcyBmb3IgZWFjaCBzZWdtZW50IGVsZW1lbnQuIFByb2JhYmx5IGFmdGVyIGEgd2luZG93IHJlc2l6ZS96b29tLgoJLy8gUmVwb3NpdGlvbnMgYnVzaW5lc3MgaG91cnMgc2VncyB0b28sIHNvIG5vdCBqdXN0IGZvciBldmVudHMuIE1heWJlIHNob3VsZG4ndCBiZSBoZXJlLgoJdXBkYXRlU2VnVmVydGljYWxzOiBmdW5jdGlvbigpIHsKCQl2YXIgYWxsU2VncyA9ICh0aGlzLnNlZ3MgfHwgW10pLmNvbmNhdCh0aGlzLmJ1c2luZXNzSG91clNlZ3MgfHwgW10pOwoJCXZhciBpOwoKCQl0aGlzLmNvbXB1dGVTZWdWZXJ0aWNhbHMoYWxsU2Vncyk7CgoJCWZvciAoaSA9IDA7IGkgPCBhbGxTZWdzLmxlbmd0aDsgaSsrKSB7CgkJCWFsbFNlZ3NbaV0uZWwuY3NzKAoJCQkJdGhpcy5nZW5lcmF0ZVNlZ1ZlcnRpY2FsQ3NzKGFsbFNlZ3NbaV0pCgkJCSk7CgkJfQoJfSwKCgoJLy8gRm9yIGVhY2ggc2VnbWVudCBpbiBhbiBhcnJheSwgY29tcHV0ZXMgYW5kIGFzc2lnbnMgaXRzIHRvcCBhbmQgYm90dG9tIHByb3BlcnRpZXMKCWNvbXB1dGVTZWdWZXJ0aWNhbHM6IGZ1bmN0aW9uKHNlZ3MpIHsKCQl2YXIgaSwgc2VnOwoKCQlmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgewoJCQlzZWcgPSBzZWdzW2ldOwoJCQlzZWcudG9wID0gdGhpcy5jb21wdXRlRGF0ZVRvcChzZWcuc3RhcnQsIHNlZy5zdGFydCk7CgkJCXNlZy5ib3R0b20gPSB0aGlzLmNvbXB1dGVEYXRlVG9wKHNlZy5lbmQsIHNlZy5zdGFydCk7CgkJfQoJfSwKCgoJLy8gUmVuZGVycyB0aGUgSFRNTCBmb3IgYSBzaW5nbGUgZXZlbnQgc2VnbWVudCdzIGRlZmF1bHQgcmVuZGVyaW5nCglmZ1NlZ0h0bWw6IGZ1bmN0aW9uKHNlZywgZGlzYWJsZVJlc2l6aW5nKSB7CgkJdmFyIHZpZXcgPSB0aGlzLnZpZXc7CgkJdmFyIGV2ZW50ID0gc2VnLmV2ZW50OwoJCXZhciBpc0RyYWdnYWJsZSA9IHZpZXcuaXNFdmVudERyYWdnYWJsZShldmVudCk7CgkJdmFyIGlzUmVzaXphYmxlID0gIWRpc2FibGVSZXNpemluZyAmJiBzZWcuaXNFbmQgJiYgdmlldy5pc0V2ZW50UmVzaXphYmxlKGV2ZW50KTsKCQl2YXIgY2xhc3NlcyA9IHRoaXMuZ2V0U2VnQ2xhc3NlcyhzZWcsIGlzRHJhZ2dhYmxlLCBpc1Jlc2l6YWJsZSk7CgkJdmFyIHNraW5Dc3MgPSB0aGlzLmdldEV2ZW50U2tpbkNzcyhldmVudCk7CgkJdmFyIHRpbWVUZXh0OwoJCXZhciBmdWxsVGltZVRleHQ7IC8vIG1vcmUgdmVyYm9zZSB0aW1lIHRleHQuIGZvciB0aGUgcHJpbnQgc3R5bGVzaGVldAoJCXZhciBzdGFydFRpbWVUZXh0OyAvLyBqdXN0IHRoZSBzdGFydCB0aW1lIHRleHQKCgkJY2xhc3Nlcy51bnNoaWZ0KCdmYy10aW1lLWdyaWQtZXZlbnQnKTsKCgkJaWYgKHZpZXcuaXNNdWx0aURheUV2ZW50KGV2ZW50KSkgeyAvLyBpZiB0aGUgZXZlbnQgYXBwZWFycyB0byBzcGFuIG1vcmUgdGhhbiBvbmUgZGF5Li4uCgkJCS8vIERvbid0IGRpc3BsYXkgdGltZSB0ZXh0IG9uIHNlZ21lbnRzIHRoYXQgcnVuIGVudGlyZWx5IHRocm91Z2ggYSBkYXkuCgkJCS8vIFRoYXQgd291bGQgYXBwZWFyIGFzIG1pZG5pZ2h0LW1pZG5pZ2h0IGFuZCB3b3VsZCBsb29rIGR1bWIuCgkJCS8vIE90aGVyd2lzZSwgZGlzcGxheSB0aGUgdGltZSB0ZXh0IGZvciB0aGUgKnNlZ21lbnQncyogdGltZXMgKGxpa2UgNnBtLW1pZG5pZ2h0IG9yIG1pZG5pZ2h0LTEwYW0pCgkJCWlmIChzZWcuaXNTdGFydCB8fCBzZWcuaXNFbmQpIHsKCQkJCXRpbWVUZXh0ID0gdGhpcy5nZXRFdmVudFRpbWVUZXh0KHNlZyk7CgkJCQlmdWxsVGltZVRleHQgPSB0aGlzLmdldEV2ZW50VGltZVRleHQoc2VnLCAnTFQnKTsKCQkJCXN0YXJ0VGltZVRleHQgPSB0aGlzLmdldEV2ZW50VGltZVRleHQoeyBzdGFydDogc2VnLnN0YXJ0IH0pOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gRGlzcGxheSB0aGUgbm9ybWFsIHRpbWUgdGV4dCBmb3IgdGhlICpldmVudCdzKiB0aW1lcwoJCQl0aW1lVGV4dCA9IHRoaXMuZ2V0RXZlbnRUaW1lVGV4dChldmVudCk7CgkJCWZ1bGxUaW1lVGV4dCA9IHRoaXMuZ2V0RXZlbnRUaW1lVGV4dChldmVudCwgJ0xUJyk7CgkJCXN0YXJ0VGltZVRleHQgPSB0aGlzLmdldEV2ZW50VGltZVRleHQoeyBzdGFydDogZXZlbnQuc3RhcnQgfSk7CgkJfQoKCQlyZXR1cm4gJzxhIGNsYXNzPSInICsgY2xhc3Nlcy5qb2luKCcgJykgKyAnIicgKwoJCQkoZXZlbnQudXJsID8KCQkJCScgaHJlZj0iJyArIGh0bWxFc2NhcGUoZXZlbnQudXJsKSArICciJyA6CgkJCQknJwoJCQkJKSArCgkJCShza2luQ3NzID8KCQkJCScgc3R5bGU9IicgKyBza2luQ3NzICsgJyInIDoKCQkJCScnCgkJCQkpICsKCQkJJz4nICsKCQkJCSc8ZGl2IGNsYXNzPSJmYy1jb250ZW50Ij4nICsKCQkJCQkodGltZVRleHQgPwoJCQkJCQknPGRpdiBjbGFzcz0iZmMtdGltZSInICsKCQkJCQkJJyBkYXRhLXN0YXJ0PSInICsgaHRtbEVzY2FwZShzdGFydFRpbWVUZXh0KSArICciJyArCgkJCQkJCScgZGF0YS1mdWxsPSInICsgaHRtbEVzY2FwZShmdWxsVGltZVRleHQpICsgJyInICsKCQkJCQkJJz4nICsKCQkJCQkJCSc8c3Bhbj4nICsgaHRtbEVzY2FwZSh0aW1lVGV4dCkgKyAnPC9zcGFuPicgKwoJCQkJCQknPC9kaXY+JyA6CgkJCQkJCScnCgkJCQkJCSkgKwoJCQkJCShldmVudC50aXRsZSA\/CgkJCQkJCSc8ZGl2IGNsYXNzPSJmYy10aXRsZSI+JyArCgkJCQkJCQlodG1sRXNjYXBlKGV2ZW50LnRpdGxlKSArCgkJCQkJCSc8L2Rpdj4nIDoKCQkJCQkJJycKCQkJCQkJKSArCgkJCQknPC9kaXY+JyArCgkJCQknPGRpdiBjbGFzcz0iZmMtYmciLz4nICsKCQkJCShpc1Jlc2l6YWJsZSA\/CgkJCQkJJzxkaXYgY2xhc3M9ImZjLXJlc2l6ZXIiLz4nIDoKCQkJCQknJwoJCQkJCSkgKwoJCQknPC9hPic7Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgYW4gb2JqZWN0IHdpdGggQ1NTIHByb3BlcnRpZXMvdmFsdWVzIHRoYXQgc2hvdWxkIGJlIGFwcGxpZWQgdG8gYW4gZXZlbnQgc2VnbWVudCBlbGVtZW50LgoJLy8gQ29udGFpbnMgaW1wb3J0YW50IHBvc2l0aW9uaW5nLXJlbGF0ZWQgcHJvcGVydGllcyB0aGF0IHNob3VsZCBiZSBhcHBsaWVkIHRvIGFueSBldmVudCBlbGVtZW50LCBjdXN0b21pemVkIG9yIG5vdC4KCWdlbmVyYXRlU2VnUG9zaXRpb25Dc3M6IGZ1bmN0aW9uKHNlZykgewoJCXZhciBzaG91bGRPdmVybGFwID0gdGhpcy52aWV3Lm9wdCgnc2xvdEV2ZW50T3ZlcmxhcCcpOwoJCXZhciBiYWNrd2FyZENvb3JkID0gc2VnLmJhY2t3YXJkQ29vcmQ7IC8vIHRoZSBsZWZ0IHNpZGUgaWYgTFRSLiB0aGUgcmlnaHQgc2lkZSBpZiBSVEwuIGZsb2F0aW5nLXBvaW50CgkJdmFyIGZvcndhcmRDb29yZCA9IHNlZy5mb3J3YXJkQ29vcmQ7IC8vIHRoZSByaWdodCBzaWRlIGlmIExUUi4gdGhlIGxlZnQgc2lkZSBpZiBSVEwuIGZsb2F0aW5nLXBvaW50CgkJdmFyIHByb3BzID0gdGhpcy5nZW5lcmF0ZVNlZ1ZlcnRpY2FsQ3NzKHNlZyk7IC8vIGdldCB0b3AvYm90dG9tIGZpcnN0CgkJdmFyIGxlZnQ7IC8vIGFtb3VudCBvZiBzcGFjZSBmcm9tIGxlZnQgZWRnZSwgYSBmcmFjdGlvbiBvZiB0aGUgdG90YWwgd2lkdGgKCQl2YXIgcmlnaHQ7IC8vIGFtb3VudCBvZiBzcGFjZSBmcm9tIHJpZ2h0IGVkZ2UsIGEgZnJhY3Rpb24gb2YgdGhlIHRvdGFsIHdpZHRoCgoJCWlmIChzaG91bGRPdmVybGFwKSB7CgkJCS8vIGRvdWJsZSB0aGUgd2lkdGgsIGJ1dCBkb24ndCBnbyBiZXlvbmQgdGhlIG1heGltdW0gZm9yd2FyZCBjb29yZGluYXRlICgxLjApCgkJCWZvcndhcmRDb29yZCA9IE1hdGgubWluKDEsIGJhY2t3YXJkQ29vcmQgKyAoZm9yd2FyZENvb3JkIC0gYmFja3dhcmRDb29yZCkgKiAyKTsKCQl9CgoJCWlmICh0aGlzLmlzUlRMKSB7CgkJCWxlZnQgPSAxIC0gZm9yd2FyZENvb3JkOwoJCQlyaWdodCA9IGJhY2t3YXJkQ29vcmQ7CgkJfQoJCWVsc2UgewoJCQlsZWZ0ID0gYmFja3dhcmRDb29yZDsKCQkJcmlnaHQgPSAxIC0gZm9yd2FyZENvb3JkOwoJCX0KCgkJcHJvcHMuekluZGV4ID0gc2VnLmxldmVsICsgMTsgLy8gY29udmVydCBmcm9tIDAtYmFzZSB0byAxLWJhc2VkCgkJcHJvcHMubGVmdCA9IGxlZnQgKiAxMDAgKyAnJSc7CgkJcHJvcHMucmlnaHQgPSByaWdodCAqIDEwMCArICclJzsKCgkJaWYgKHNob3VsZE92ZXJsYXAgJiYgc2VnLmZvcndhcmRQcmVzc3VyZSkgewoJCQkvLyBhZGQgcGFkZGluZyB0byB0aGUgZWRnZSBzbyB0aGF0IGZvcndhcmQgc3RhY2tlZCBldmVudHMgZG9uJ3QgY292ZXIgdGhlIHJlc2l6ZXIncyBpY29uCgkJCXByb3BzW3RoaXMuaXNSVEwgPyAnbWFyZ2luTGVmdCcgOiAnbWFyZ2luUmlnaHQnXSA9IDEwICogMjsgLy8gMTAgaXMgYSBndWVzc3RpbWF0ZSBvZiB0aGUgaWNvbidzIHdpZHRoCgkJfQoKCQlyZXR1cm4gcHJvcHM7Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgYW4gb2JqZWN0IHdpdGggQ1NTIHByb3BlcnRpZXMgZm9yIHRoZSB0b3AvYm90dG9tIGNvb3JkaW5hdGVzIG9mIGEgc2VnbWVudCBlbGVtZW50CglnZW5lcmF0ZVNlZ1ZlcnRpY2FsQ3NzOiBmdW5jdGlvbihzZWcpIHsKCQlyZXR1cm4gewoJCQl0b3A6IHNlZy50b3AsCgkJCWJvdHRvbTogLXNlZy5ib3R0b20gLy8gZmxpcHBlZCBiZWNhdXNlIG5lZWRzIHRvIGJlIHNwYWNlIGJleW9uZCBib3R0b20gZWRnZSBvZiBldmVudCBjb250YWluZXIKCQl9OwoJfSwKCgoJLy8gR2l2ZW4gYSBmbGF0IGFycmF5IG9mIHNlZ21lbnRzLCByZXR1cm4gYW4gYXJyYXkgb2Ygc3ViLWFycmF5cywgZ3JvdXBlZCBieSBlYWNoIHNlZ21lbnQncyBjb2wKCWdyb3VwU2VnQ29sczogZnVuY3Rpb24oc2VncykgewoJCXZhciBzZWdDb2xzID0gW107CgkJdmFyIGk7CgoJCWZvciAoaSA9IDA7IGkgPCB0aGlzLmNvbENudDsgaSsrKSB7CgkJCXNlZ0NvbHMucHVzaChbXSk7CgkJfQoKCQlmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgewoJCQlzZWdDb2xzW3NlZ3NbaV0uY29sXS5wdXNoKHNlZ3NbaV0pOwoJCX0KCgkJcmV0dXJuIHNlZ0NvbHM7Cgl9Cgp9KTsKCgovLyBHaXZlbiBhbiBhcnJheSBvZiBzZWdtZW50cyB0aGF0IGFyZSBhbGwgaW4gdGhlIHNhbWUgY29sdW1uLCBzZXRzIHRoZSBiYWNrd2FyZENvb3JkIGFuZCBmb3J3YXJkQ29vcmQgb24gZWFjaC4KLy8gQWxzbyByZW9yZGVycyB0aGUgZ2l2ZW4gYXJyYXkgYnkgZGF0ZSEKZnVuY3Rpb24gcGxhY2VTbG90U2VncyhzZWdzKSB7Cgl2YXIgbGV2ZWxzOwoJdmFyIGxldmVsMDsKCXZhciBpOwoKCXNlZ3Muc29ydChjb21wYXJlU2Vncyk7IC8vIG9yZGVyIGJ5IGRhdGUKCWxldmVscyA9IGJ1aWxkU2xvdFNlZ0xldmVscyhzZWdzKTsKCWNvbXB1dGVGb3J3YXJkU2xvdFNlZ3MobGV2ZWxzKTsKCglpZiAoKGxldmVsMCA9IGxldmVsc1swXSkpIHsKCgkJZm9yIChpID0gMDsgaSA8IGxldmVsMC5sZW5ndGg7IGkrKykgewoJCQljb21wdXRlU2xvdFNlZ1ByZXNzdXJlcyhsZXZlbDBbaV0pOwoJCX0KCgkJZm9yIChpID0gMDsgaSA8IGxldmVsMC5sZW5ndGg7IGkrKykgewoJCQljb21wdXRlU2xvdFNlZ0Nvb3JkcyhsZXZlbDBbaV0sIDAsIDApOwoJCX0KCX0KfQoKCi8vIEJ1aWxkcyBhbiBhcnJheSBvZiBzZWdtZW50cyAibGV2ZWxzIi4gVGhlIGZpcnN0IGxldmVsIHdpbGwgYmUgdGhlIGxlZnRtb3N0IHRpZXIgb2Ygc2VnbWVudHMgaWYgdGhlIGNhbGVuZGFyIGlzCi8vIGxlZnQtdG8tcmlnaHQsIG9yIHRoZSByaWdodG1vc3QgaWYgdGhlIGNhbGVuZGFyIGlzIHJpZ2h0LXRvLWxlZnQuIEFzc3VtZXMgdGhlIHNlZ21lbnRzIGFyZSBhbHJlYWR5IG9yZGVyZWQgYnkgZGF0ZS4KZnVuY3Rpb24gYnVpbGRTbG90U2VnTGV2ZWxzKHNlZ3MpIHsKCXZhciBsZXZlbHMgPSBbXTsKCXZhciBpLCBzZWc7Cgl2YXIgajsKCglmb3IgKGk9MDsgaTxzZWdzLmxlbmd0aDsgaSsrKSB7CgkJc2VnID0gc2Vnc1tpXTsKCgkJLy8gZ28gdGhyb3VnaCBhbGwgdGhlIGxldmVscyBhbmQgc3RvcCBvbiB0aGUgZmlyc3QgbGV2ZWwgd2hlcmUgdGhlcmUgYXJlIG5vIGNvbGxpc2lvbnMKCQlmb3IgKGo9MDsgajxsZXZlbHMubGVuZ3RoOyBqKyspIHsKCQkJaWYgKCFjb21wdXRlU2xvdFNlZ0NvbGxpc2lvbnMoc2VnLCBsZXZlbHNbal0pLmxlbmd0aCkgewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCXNlZy5sZXZlbCA9IGo7CgoJCShsZXZlbHNbal0gfHwgKGxldmVsc1tqXSA9IFtdKSkucHVzaChzZWcpOwoJfQoKCXJldHVybiBsZXZlbHM7Cn0KCgovLyBGb3IgZXZlcnkgc2VnbWVudCwgZmlndXJlIG91dCB0aGUgb3RoZXIgc2VnbWVudHMgdGhhdCBhcmUgaW4gc3Vic2VxdWVudAovLyBsZXZlbHMgdGhhdCBhbHNvIG9jY3VweSB0aGUgc2FtZSB2ZXJ0aWNhbCBzcGFjZS4gQWNjdW11bGF0ZSBpbiBzZWcuZm9yd2FyZFNlZ3MKZnVuY3Rpb24gY29tcHV0ZUZvcndhcmRTbG90U2VncyhsZXZlbHMpIHsKCXZhciBpLCBsZXZlbDsKCXZhciBqLCBzZWc7Cgl2YXIgazsKCglmb3IgKGk9MDsgaTxsZXZlbHMubGVuZ3RoOyBpKyspIHsKCQlsZXZlbCA9IGxldmVsc1tpXTsKCgkJZm9yIChqPTA7IGo8bGV2ZWwubGVuZ3RoOyBqKyspIHsKCQkJc2VnID0gbGV2ZWxbal07CgoJCQlzZWcuZm9yd2FyZFNlZ3MgPSBbXTsKCQkJZm9yIChrPWkrMTsgazxsZXZlbHMubGVuZ3RoOyBrKyspIHsKCQkJCWNvbXB1dGVTbG90U2VnQ29sbGlzaW9ucyhzZWcsIGxldmVsc1trXSwgc2VnLmZvcndhcmRTZWdzKTsKCQkJfQoJCX0KCX0KfQoKCi8vIEZpZ3VyZSBvdXQgd2hpY2ggcGF0aCBmb3J3YXJkICh2aWEgc2VnLmZvcndhcmRTZWdzKSByZXN1bHRzIGluIHRoZSBsb25nZXN0IHBhdGggdW50aWwKLy8gdGhlIGZ1cnRoZXN0IGVkZ2UgaXMgcmVhY2hlZC4gVGhlIG51bWJlciBvZiBzZWdtZW50cyBpbiB0aGlzIHBhdGggd2lsbCBiZSBzZWcuZm9yd2FyZFByZXNzdXJlCmZ1bmN0aW9uIGNvbXB1dGVTbG90U2VnUHJlc3N1cmVzKHNlZykgewoJdmFyIGZvcndhcmRTZWdzID0gc2VnLmZvcndhcmRTZWdzOwoJdmFyIGZvcndhcmRQcmVzc3VyZSA9IDA7Cgl2YXIgaSwgZm9yd2FyZFNlZzsKCglpZiAoc2VnLmZvcndhcmRQcmVzc3VyZSA9PT0gdW5kZWZpbmVkKSB7IC8vIG5vdCBhbHJlYWR5IGNvbXB1dGVkCgoJCWZvciAoaT0wOyBpPGZvcndhcmRTZWdzLmxlbmd0aDsgaSsrKSB7CgkJCWZvcndhcmRTZWcgPSBmb3J3YXJkU2Vnc1tpXTsKCgkJCS8vIGZpZ3VyZSBvdXQgdGhlIGNoaWxkJ3MgbWF4aW11bSBmb3J3YXJkIHBhdGgKCQkJY29tcHV0ZVNsb3RTZWdQcmVzc3VyZXMoZm9yd2FyZFNlZyk7CgoJCQkvLyBlaXRoZXIgdXNlIHRoZSBleGlzdGluZyBtYXhpbXVtLCBvciB1c2UgdGhlIGNoaWxkJ3MgZm9yd2FyZCBwcmVzc3VyZQoJCQkvLyBwbHVzIG9uZSAoZm9yIHRoZSBmb3J3YXJkU2VnIGl0c2VsZikKCQkJZm9yd2FyZFByZXNzdXJlID0gTWF0aC5tYXgoCgkJCQlmb3J3YXJkUHJlc3N1cmUsCgkJCQkxICsgZm9yd2FyZFNlZy5mb3J3YXJkUHJlc3N1cmUKCQkJKTsKCQl9CgoJCXNlZy5mb3J3YXJkUHJlc3N1cmUgPSBmb3J3YXJkUHJlc3N1cmU7Cgl9Cn0KCgovLyBDYWxjdWxhdGUgc2VnLmZvcndhcmRDb29yZCBhbmQgc2VnLmJhY2t3YXJkQ29vcmQgZm9yIHRoZSBzZWdtZW50LCB3aGVyZSBib3RoIHZhbHVlcyByYW5nZQovLyBmcm9tIDAgdG8gMS4gSWYgdGhlIGNhbGVuZGFyIGlzIGxlZnQtdG8tcmlnaHQsIHRoZSBzZWcuYmFja3dhcmRDb29yZCBtYXBzIHRvICJsZWZ0IiBhbmQKLy8gc2VnLmZvcndhcmRDb29yZCBtYXBzIHRvICJyaWdodCIgKHZpYSBwZXJjZW50YWdlKS4gVmljZS12ZXJzYSBpZiB0aGUgY2FsZW5kYXIgaXMgcmlnaHQtdG8tbGVmdC4KLy8KLy8gVGhlIHNlZ21lbnQgbWlnaHQgYmUgcGFydCBvZiBhICJzZXJpZXMiLCB3aGljaCBtZWFucyBjb25zZWN1dGl2ZSBzZWdtZW50cyB3aXRoIHRoZSBzYW1lIHByZXNzdXJlCi8vIHdobydzIHdpZHRoIGlzIHVua25vd24gdW50aWwgYW4gZWRnZSBoYXMgYmVlbiBoaXQuIGBzZXJpZXNCYWNrd2FyZFByZXNzdXJlYCBpcyB0aGUgbnVtYmVyIG9mCi8vIHNlZ21lbnRzIGJlaGluZCB0aGlzIG9uZSBpbiB0aGUgY3VycmVudCBzZXJpZXMsIGFuZCBgc2VyaWVzQmFja3dhcmRDb29yZGAgaXMgdGhlIHN0YXJ0aW5nCi8vIGNvb3JkaW5hdGUgb2YgdGhlIGZpcnN0IHNlZ21lbnQgaW4gdGhlIHNlcmllcy4KZnVuY3Rpb24gY29tcHV0ZVNsb3RTZWdDb29yZHMoc2VnLCBzZXJpZXNCYWNrd2FyZFByZXNzdXJlLCBzZXJpZXNCYWNrd2FyZENvb3JkKSB7Cgl2YXIgZm9yd2FyZFNlZ3MgPSBzZWcuZm9yd2FyZFNlZ3M7Cgl2YXIgaTsKCglpZiAoc2VnLmZvcndhcmRDb29yZCA9PT0gdW5kZWZpbmVkKSB7IC8vIG5vdCBhbHJlYWR5IGNvbXB1dGVkCgoJCWlmICghZm9yd2FyZFNlZ3MubGVuZ3RoKSB7CgoJCQkvLyBpZiB0aGVyZSBhcmUgbm8gZm9yd2FyZCBzZWdtZW50cywgdGhpcyBzZWdtZW50IHNob3VsZCBidXR0IHVwIGFnYWluc3QgdGhlIGVkZ2UKCQkJc2VnLmZvcndhcmRDb29yZCA9IDE7CgkJfQoJCWVsc2UgewoKCQkJLy8gc29ydCBoaWdoZXN0IHByZXNzdXJlIGZpcnN0CgkJCWZvcndhcmRTZWdzLnNvcnQoY29tcGFyZUZvcndhcmRTbG90U2Vncyk7CgoJCQkvLyB0aGlzIHNlZ21lbnQncyBmb3J3YXJkQ29vcmQgd2lsbCBiZSBjYWxjdWxhdGVkIGZyb20gdGhlIGJhY2t3YXJkQ29vcmQgb2YgdGhlCgkJCS8vIGhpZ2hlc3QtcHJlc3N1cmUgZm9yd2FyZCBzZWdtZW50LgoJCQljb21wdXRlU2xvdFNlZ0Nvb3Jkcyhmb3J3YXJkU2Vnc1swXSwgc2VyaWVzQmFja3dhcmRQcmVzc3VyZSArIDEsIHNlcmllc0JhY2t3YXJkQ29vcmQpOwoJCQlzZWcuZm9yd2FyZENvb3JkID0gZm9yd2FyZFNlZ3NbMF0uYmFja3dhcmRDb29yZDsKCQl9CgoJCS8vIGNhbGN1bGF0ZSB0aGUgYmFja3dhcmRDb29yZCBmcm9tIHRoZSBmb3J3YXJkQ29vcmQuIGNvbnNpZGVyIHRoZSBzZXJpZXMKCQlzZWcuYmFja3dhcmRDb29yZCA9IHNlZy5mb3J3YXJkQ29vcmQgLQoJCQkoc2VnLmZvcndhcmRDb29yZCAtIHNlcmllc0JhY2t3YXJkQ29vcmQpIC8gLy8gYXZhaWxhYmxlIHdpZHRoIGZvciBzZXJpZXMKCQkJKHNlcmllc0JhY2t3YXJkUHJlc3N1cmUgKyAxKTsgLy8gIyBvZiBzZWdtZW50cyBpbiB0aGUgc2VyaWVzCgoJCS8vIHVzZSB0aGlzIHNlZ21lbnQncyBjb29yZGluYXRlcyB0byBjb21wdXRlZCB0aGUgY29vcmRpbmF0ZXMgb2YgdGhlIGxlc3MtcHJlc3N1cml6ZWQKCQkvLyBmb3J3YXJkIHNlZ21lbnRzCgkJZm9yIChpPTA7IGk8Zm9yd2FyZFNlZ3MubGVuZ3RoOyBpKyspIHsKCQkJY29tcHV0ZVNsb3RTZWdDb29yZHMoZm9yd2FyZFNlZ3NbaV0sIDAsIHNlZy5mb3J3YXJkQ29vcmQpOwoJCX0KCX0KfQoKCi8vIEZpbmQgYWxsIHRoZSBzZWdtZW50cyBpbiBgb3RoZXJTZWdzYCB0aGF0IHZlcnRpY2FsbHkgY29sbGlkZSB3aXRoIGBzZWdgLgovLyBBcHBlbmQgaW50byBhbiBvcHRpb25hbGx5LXN1cHBsaWVkIGByZXN1bHRzYCBhcnJheSBhbmQgcmV0dXJuLgpmdW5jdGlvbiBjb21wdXRlU2xvdFNlZ0NvbGxpc2lvbnMoc2VnLCBvdGhlclNlZ3MsIHJlc3VsdHMpIHsKCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwoKCWZvciAodmFyIGk9MDsgaTxvdGhlclNlZ3MubGVuZ3RoOyBpKyspIHsKCQlpZiAoaXNTbG90U2VnQ29sbGlzaW9uKHNlZywgb3RoZXJTZWdzW2ldKSkgewoJCQlyZXN1bHRzLnB1c2gob3RoZXJTZWdzW2ldKTsKCQl9Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn0KCgovLyBEbyB0aGVzZSBzZWdtZW50cyBvY2N1cHkgdGhlIHNhbWUgdmVydGljYWwgc3BhY2U\/CmZ1bmN0aW9uIGlzU2xvdFNlZ0NvbGxpc2lvbihzZWcxLCBzZWcyKSB7CglyZXR1cm4gc2VnMS5ib3R0b20gPiBzZWcyLnRvcCAmJiBzZWcxLnRvcCA8IHNlZzIuYm90dG9tOwp9CgoKLy8gQSBjbXAgZnVuY3Rpb24gZm9yIGRldGVybWluaW5nIHdoaWNoIGZvcndhcmQgc2VnbWVudCB0byByZWx5IG9uIG1vcmUgd2hlbiBjb21wdXRpbmcgY29vcmRpbmF0ZXMuCmZ1bmN0aW9uIGNvbXBhcmVGb3J3YXJkU2xvdFNlZ3Moc2VnMSwgc2VnMikgewoJLy8gcHV0IGhpZ2hlci1wcmVzc3VyZSBmaXJzdAoJcmV0dXJuIHNlZzIuZm9yd2FyZFByZXNzdXJlIC0gc2VnMS5mb3J3YXJkUHJlc3N1cmUgfHwKCQkvLyBwdXQgc2VnbWVudHMgdGhhdCBhcmUgY2xvc2VyIHRvIGluaXRpYWwgZWRnZSBmaXJzdCAoYW5kIGZhdm9yIG9uZXMgd2l0aCBubyBjb29yZHMgeWV0KQoJCShzZWcxLmJhY2t3YXJkQ29vcmQgfHwgMCkgLSAoc2VnMi5iYWNrd2FyZENvb3JkIHx8IDApIHx8CgkJLy8gZG8gbm9ybWFsIHNvcnRpbmcuLi4KCQljb21wYXJlU2VncyhzZWcxLCBzZWcyKTsKfQoKOzsKCi8qIEFuIGFic3RyYWN0IGNsYXNzIGZyb20gd2hpY2ggb3RoZXIgdmlld3MgaW5oZXJpdCBmcm9tCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKdmFyIFZpZXcgPSBmYy5WaWV3ID0gQ2xhc3MuZXh0ZW5kKHsKCgl0eXBlOiBudWxsLCAvLyBzdWJjbGFzcycgdmlldyBuYW1lIChzdHJpbmcpCgluYW1lOiBudWxsLCAvLyBkZXByZWNhdGVkLiB1c2UgYHR5cGVgIGluc3RlYWQKCXRpdGxlOiBudWxsLCAvLyB0aGUgdGV4dCB0aGF0IHdpbGwgYmUgZGlzcGxheWVkIGluIHRoZSBoZWFkZXIncyB0aXRsZQoKCWNhbGVuZGFyOiBudWxsLCAvLyBvd25lciBDYWxlbmRhciBvYmplY3QKCW9wdGlvbnM6IG51bGwsIC8vIHZpZXctc3BlY2lmaWMgb3B0aW9ucwoJY29vcmRNYXA6IG51bGwsIC8vIGEgQ29vcmRNYXAgb2JqZWN0IGZvciBjb252ZXJ0aW5nIHBpeGVsIHJlZ2lvbnMgdG8gZGF0ZXMKCWVsOiBudWxsLCAvLyB0aGUgdmlldydzIGNvbnRhaW5pbmcgZWxlbWVudC4gc2V0IGJ5IENhbGVuZGFyCgoJLy8gcmFuZ2UgdGhlIHZpZXcgaXMgYWN0dWFsbHkgZGlzcGxheWluZyAobW9tZW50cykKCXN0YXJ0OiBudWxsLAoJZW5kOiBudWxsLCAvLyBleGNsdXNpdmUKCgkvLyByYW5nZSB0aGUgdmlldyBpcyBmb3JtYWxseSByZXNwb25zaWJsZSBmb3IgKG1vbWVudHMpCgkvLyBtYXkgYmUgZGlmZmVyZW50IGZyb20gc3RhcnQvZW5kLiBmb3IgZXhhbXBsZSwgYSBtb250aCB2aWV3IG1pZ2h0IGhhdmUgMXN0LTMxc3QsIGV4Y2x1ZGluZyBwYWRkZWQgZGF0ZXMKCWludGVydmFsU3RhcnQ6IG51bGwsCglpbnRlcnZhbEVuZDogbnVsbCwgLy8gZXhjbHVzaXZlCgoJaW50ZXJ2YWxEdXJhdGlvbjogbnVsbCwgLy8gdGhlIHdob2xlLXVuaXQgZHVyYXRpb24gdGhhdCBpcyBiZWluZyBkaXNwbGF5ZWQKCWludGVydmFsVW5pdDogbnVsbCwgLy8gbmFtZSBvZiBsYXJnZXN0IHVuaXQgYmVpbmcgZGlzcGxheWVkLCBsaWtlICJtb250aCIgb3IgIndlZWsiCgoJaXNTZWxlY3RlZDogZmFsc2UsIC8vIGJvb2xlYW4gd2hldGhlciBhIHJhbmdlIG9mIHRpbWUgaXMgdXNlci1zZWxlY3RlZCBvciBub3QKCgkvLyBzdWJjbGFzc2VzIGNhbiBvcHRpb25hbGx5IHVzZSBhIHNjcm9sbCBjb250YWluZXIKCXNjcm9sbGVyRWw6IG51bGwsIC8vIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBtb3N0IGxpa2VseSBzY3JvbGwgd2hlbiBjb250ZW50IGlzIHRvbyB0YWxsCglzY3JvbGxUb3A6IG51bGwsIC8vIGNhY2hlZCB2ZXJ0aWNhbCBzY3JvbGwgdmFsdWUKCgkvLyBjbGFzc05hbWVzIHN0eWxlZCBieSBqcXVpIHRoZW1lcwoJd2lkZ2V0SGVhZGVyQ2xhc3M6IG51bGwsCgl3aWRnZXRDb250ZW50Q2xhc3M6IG51bGwsCgloaWdobGlnaHRTdGF0ZUNsYXNzOiBudWxsLAoKCS8vIGZvciBkYXRlIHV0aWxzLCBjb21wdXRlZCBmcm9tIG9wdGlvbnMKCW5leHREYXlUaHJlc2hvbGQ6IG51bGwsCglpc0hpZGRlbkRheUhhc2g6IG51bGwsCgoJLy8gZG9jdW1lbnQgaGFuZGxlcnMsIGJvdW5kIHRvIGB0aGlzYCBvYmplY3QKCWRvY3VtZW50TW91c2Vkb3duUHJveHk6IG51bGwsIC8vIFRPRE86IGRvZXNuJ3Qgd29yayB3aXRoIHRvdWNoCgoKCWNvbnN0cnVjdG9yOiBmdW5jdGlvbihjYWxlbmRhciwgdmlld09wdGlvbnMsIHZpZXdUeXBlKSB7CgkJdGhpcy5jYWxlbmRhciA9IGNhbGVuZGFyOwoJCXRoaXMub3B0aW9ucyA9IHZpZXdPcHRpb25zOwoJCXRoaXMudHlwZSA9IHRoaXMubmFtZSA9IHZpZXdUeXBlOyAvLyAubmFtZSBpcyBkZXByZWNhdGVkCgoJCXRoaXMubmV4dERheVRocmVzaG9sZCA9IG1vbWVudC5kdXJhdGlvbih0aGlzLm9wdCgnbmV4dERheVRocmVzaG9sZCcpKTsKCQl0aGlzLmluaXRUaGVtaW5nKCk7CgkJdGhpcy5pbml0SGlkZGVuRGF5cygpOwoKCQl0aGlzLmRvY3VtZW50TW91c2Vkb3duUHJveHkgPSAkLnByb3h5KHRoaXMsICdkb2N1bWVudE1vdXNlZG93bicpOwoKCQl0aGlzLmluaXRpYWxpemUoKTsKCX0sCgoKCS8vIEEgZ29vZCBwbGFjZSBmb3Igc3ViY2xhc3NlcyB0byBpbml0aWFsaXplIG1lbWJlciB2YXJpYWJsZXMKCWluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoJCS8vIHN1YmNsYXNzZXMgY2FuIGltcGxlbWVudAoJfSwKCgoJLy8gUmV0cmlldmVzIGFuIG9wdGlvbiB3aXRoIHRoZSBnaXZlbiBuYW1lCglvcHQ6IGZ1bmN0aW9uKG5hbWUpIHsKCQl2YXIgdmFsOwoKCQl2YWwgPSB0aGlzLm9wdGlvbnNbbmFtZV07IC8vIGxvb2sgYXQgdmlldy1zcGVjaWZpYyBvcHRpb25zIGZpcnN0CgkJaWYgKHZhbCAhPT0gdW5kZWZpbmVkKSB7CgkJCXJldHVybiB2YWw7CgkJfQoKCQl2YWwgPSB0aGlzLmNhbGVuZGFyLm9wdGlvbnNbbmFtZV07CgkJaWYgKCQuaXNQbGFpbk9iamVjdCh2YWwpICYmICFpc0ZvcmNlZEF0b21pY09wdGlvbihuYW1lKSkgeyAvLyB2aWV3LW9wdGlvbi1oYXNoZXMgYXJlIGRlcHJlY2F0ZWQKCQkJcmV0dXJuIHNtYXJ0UHJvcGVydHkodmFsLCB0aGlzLnR5cGUpOwoJCX0KCgkJcmV0dXJuIHZhbDsKCX0sCgoKCS8vIFRyaWdnZXJzIGhhbmRsZXJzIHRoYXQgYXJlIHZpZXctcmVsYXRlZC4gTW9kaWZpZXMgYXJncyBiZWZvcmUgcGFzc2luZyB0byBjYWxlbmRhci4KCXRyaWdnZXI6IGZ1bmN0aW9uKG5hbWUsIHRoaXNPYmopIHsgLy8gYXJndW1lbnRzIGJleW9uZCB0aGlzT2JqIGFyZSBwYXNzZWQgYWxvbmcKCQl2YXIgY2FsZW5kYXIgPSB0aGlzLmNhbGVuZGFyOwoKCQlyZXR1cm4gY2FsZW5kYXIudHJpZ2dlci5hcHBseSgKCQkJY2FsZW5kYXIsCgkJCVtuYW1lLCB0aGlzT2JqIHx8IHRoaXNdLmNvbmNhdCgKCQkJCUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMiksIC8vIGFyZ3VtZW50cyBiZXlvbmQgdGhpc09iagoJCQkJWyB0aGlzIF0gLy8gYWx3YXlzIG1ha2UgdGhlIGxhc3QgYXJndW1lbnQgYSByZWZlcmVuY2UgdG8gdGhlIHZpZXcuIFRPRE86IGRlcHJlY2F0ZQoJCQkpCgkJKTsKCX0sCgoKCS8qIERhdGVzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBVcGRhdGVzIGFsbCBpbnRlcm5hbCBkYXRlcyB0byBjZW50ZXIgYXJvdW5kIHRoZSBnaXZlbiBjdXJyZW50IGRhdGUKCXNldERhdGU6IGZ1bmN0aW9uKGRhdGUpIHsKCQl0aGlzLnNldFJhbmdlKHRoaXMuY29tcHV0ZVJhbmdlKGRhdGUpKTsKCX0sCgoKCS8vIFVwZGF0ZXMgYWxsIGludGVybmFsIGRhdGVzIGZvciBkaXNwbGF5aW5nIHRoZSBnaXZlbiByYW5nZS4KCS8vIEV4cGVjdHMgYWxsIHZhbHVlcyB0byBiZSBub3JtYWxpemVkIChsaWtlIHdoYXQgY29tcHV0ZVJhbmdlIGRvZXMpLgoJc2V0UmFuZ2U6IGZ1bmN0aW9uKHJhbmdlKSB7CgkJJC5leHRlbmQodGhpcywgcmFuZ2UpOwoJfSwKCgoJLy8gR2l2ZW4gYSBzaW5nbGUgY3VycmVudCBkYXRlLCBwcm9kdWNlIGluZm9ybWF0aW9uIGFib3V0IHdoYXQgcmFuZ2UgdG8gZGlzcGxheS4KCS8vIFN1YmNsYXNzZXMgY2FuIG92ZXJyaWRlLiBNdXN0IHJldHVybiBhbGwgcHJvcGVydGllcy4KCWNvbXB1dGVSYW5nZTogZnVuY3Rpb24oZGF0ZSkgewoJCXZhciBpbnRlcnZhbER1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKHRoaXMub3B0KCdkdXJhdGlvbicpIHx8IHRoaXMuY29uc3RydWN0b3IuZHVyYXRpb24gfHwgeyBkYXlzOiAxIH0pOwoJCXZhciBpbnRlcnZhbFVuaXQgPSBjb21wdXRlSW50ZXJ2YWxVbml0KGludGVydmFsRHVyYXRpb24pOwoJCXZhciBpbnRlcnZhbFN0YXJ0ID0gZGF0ZS5jbG9uZSgpLnN0YXJ0T2YoaW50ZXJ2YWxVbml0KTsKCQl2YXIgaW50ZXJ2YWxFbmQgPSBpbnRlcnZhbFN0YXJ0LmNsb25lKCkuYWRkKGludGVydmFsRHVyYXRpb24pOwoJCXZhciBzdGFydCwgZW5kOwoKCQkvLyBub3JtYWxpemUgdGhlIHJhbmdlJ3MgdGltZS1hbWJpZ3VpdHkKCQlpZiAoY29tcHV0ZUludGVydmFsQXMoJ2RheXMnLCBpbnRlcnZhbER1cmF0aW9uKSkgeyAvLyB3aG9sZS1kYXlzPwoJCQlpbnRlcnZhbFN0YXJ0LnN0cmlwVGltZSgpOwoJCQlpbnRlcnZhbEVuZC5zdHJpcFRpbWUoKTsKCQl9CgkJZWxzZSB7IC8vIG5lZWRzIHRvIGhhdmUgYSB0aW1lPwoJCQlpZiAoIWludGVydmFsU3RhcnQuaGFzVGltZSgpKSB7CgkJCQlpbnRlcnZhbFN0YXJ0ID0gdGhpcy5jYWxlbmRhci5yZXpvbmVEYXRlKGludGVydmFsU3RhcnQpOyAvLyBjb252ZXJ0IHRvIGN1cnJlbnQgdGltZXpvbmUsIHdpdGggMDA6MDAKCQkJfQoJCQlpZiAoIWludGVydmFsRW5kLmhhc1RpbWUoKSkgewoJCQkJaW50ZXJ2YWxFbmQgPSB0aGlzLmNhbGVuZGFyLnJlem9uZURhdGUoaW50ZXJ2YWxFbmQpOyAvLyBjb252ZXJ0IHRvIGN1cnJlbnQgdGltZXpvbmUsIHdpdGggMDA6MDAKCQkJfQoJCX0KCgkJc3RhcnQgPSBpbnRlcnZhbFN0YXJ0LmNsb25lKCk7CgkJc3RhcnQgPSB0aGlzLnNraXBIaWRkZW5EYXlzKHN0YXJ0KTsKCQllbmQgPSBpbnRlcnZhbEVuZC5jbG9uZSgpOwoJCWVuZCA9IHRoaXMuc2tpcEhpZGRlbkRheXMoZW5kLCAtMSwgdHJ1ZSk7IC8vIGV4Y2x1c2l2ZWx5IG1vdmUgYmFja3dhcmRzCgoJCXJldHVybiB7CgkJCWludGVydmFsRHVyYXRpb246IGludGVydmFsRHVyYXRpb24sCgkJCWludGVydmFsVW5pdDogaW50ZXJ2YWxVbml0LAoJCQlpbnRlcnZhbFN0YXJ0OiBpbnRlcnZhbFN0YXJ0LAoJCQlpbnRlcnZhbEVuZDogaW50ZXJ2YWxFbmQsCgkJCXN0YXJ0OiBzdGFydCwKCQkJZW5kOiBlbmQKCQl9OwoJfSwKCgoJLy8gQ29tcHV0ZXMgdGhlIG5ldyBkYXRlIHdoZW4gdGhlIHVzZXIgaGl0cyB0aGUgcHJldiBidXR0b24sIGdpdmVuIHRoZSBjdXJyZW50IGRhdGUKCWNvbXB1dGVQcmV2RGF0ZTogZnVuY3Rpb24oZGF0ZSkgewoJCXJldHVybiB0aGlzLm1hc3NhZ2VDdXJyZW50RGF0ZSgKCQkJZGF0ZS5jbG9uZSgpLnN0YXJ0T2YodGhpcy5pbnRlcnZhbFVuaXQpLnN1YnRyYWN0KHRoaXMuaW50ZXJ2YWxEdXJhdGlvbiksIC0xCgkJKTsKCX0sCgoKCS8vIENvbXB1dGVzIHRoZSBuZXcgZGF0ZSB3aGVuIHRoZSB1c2VyIGhpdHMgdGhlIG5leHQgYnV0dG9uLCBnaXZlbiB0aGUgY3VycmVudCBkYXRlCgljb21wdXRlTmV4dERhdGU6IGZ1bmN0aW9uKGRhdGUpIHsKCQlyZXR1cm4gdGhpcy5tYXNzYWdlQ3VycmVudERhdGUoCgkJCWRhdGUuY2xvbmUoKS5zdGFydE9mKHRoaXMuaW50ZXJ2YWxVbml0KS5hZGQodGhpcy5pbnRlcnZhbER1cmF0aW9uKQoJCSk7Cgl9LAoKCgkvLyBHaXZlbiBhbiBhcmJpdHJhcmlseSBjYWxjdWxhdGVkIGN1cnJlbnQgZGF0ZSBvZiB0aGUgY2FsZW5kYXIsIHJldHVybnMgYSBkYXRlIHRoYXQgaXMgZW5zdXJlZCB0byBiZSBjb21wbGV0ZWx5CgkvLyB2aXNpYmxlLiBgZGlyZWN0aW9uYCBpcyBvcHRpb25hbCBhbmQgaW5kaWNhdGVzIHdoaWNoIGRpcmVjdGlvbiB0aGUgY3VycmVudCBkYXRlIHdhcyBiZWluZwoJLy8gaW5jcmVtZW50ZWQgb3IgZGVjcmVtZW50ZWQgKDEgb3IgLTEpLgoJbWFzc2FnZUN1cnJlbnREYXRlOiBmdW5jdGlvbihkYXRlLCBkaXJlY3Rpb24pIHsKCQlpZiAodGhpcy5pbnRlcnZhbER1cmF0aW9uIDw9IG1vbWVudC5kdXJhdGlvbih7IGRheXM6IDEgfSkpIHsgLy8gaWYgdGhlIHZpZXcgZGlzcGxheXMgYSBzaW5nbGUgZGF5IG9yIHNtYWxsZXIKCQkJaWYgKHRoaXMuaXNIaWRkZW5EYXkoZGF0ZSkpIHsKCQkJCWRhdGUgPSB0aGlzLnNraXBIaWRkZW5EYXlzKGRhdGUsIGRpcmVjdGlvbik7CgkJCQlkYXRlLnN0YXJ0T2YoJ2RheScpOwoJCQl9CgkJfQoKCQlyZXR1cm4gZGF0ZTsKCX0sCgoKCS8qIFRpdGxlIGFuZCBEYXRlIEZvcm1hdHRpbmcKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIFNldHMgdGhlIHZpZXcncyB0aXRsZSBwcm9wZXJ0eSB0byB0aGUgbW9zdCB1cGRhdGVkIGNvbXB1dGVkIHZhbHVlCgl1cGRhdGVUaXRsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy50aXRsZSA9IHRoaXMuY29tcHV0ZVRpdGxlKCk7Cgl9LAoKCgkvLyBDb21wdXRlcyB3aGF0IHRoZSB0aXRsZSBhdCB0aGUgdG9wIG9mIHRoZSBjYWxlbmRhciBzaG91bGQgYmUgZm9yIHRoaXMgdmlldwoJY29tcHV0ZVRpdGxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5mb3JtYXRSYW5nZSgKCQkJeyBzdGFydDogdGhpcy5pbnRlcnZhbFN0YXJ0LCBlbmQ6IHRoaXMuaW50ZXJ2YWxFbmQgfSwKCQkJdGhpcy5vcHQoJ3RpdGxlRm9ybWF0JykgfHwgdGhpcy5jb21wdXRlVGl0bGVGb3JtYXQoKSwKCQkJdGhpcy5vcHQoJ3RpdGxlUmFuZ2VTZXBhcmF0b3InKQoJCSk7Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgdGhlIGZvcm1hdCBzdHJpbmcgdGhhdCBzaG91bGQgYmUgdXNlZCB0byBnZW5lcmF0ZSB0aGUgdGl0bGUgZm9yIHRoZSBjdXJyZW50IGRhdGUgcmFuZ2UuCgkvLyBBdHRlbXB0cyB0byBjb21wdXRlIHRoZSBtb3N0IGFwcHJvcHJpYXRlIGZvcm1hdCBpZiBub3QgZXhwbGljaXRseSBzcGVjaWZpZWQgd2l0aCBgdGl0bGVGb3JtYXRgLgoJY29tcHV0ZVRpdGxlRm9ybWF0OiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5pbnRlcnZhbFVuaXQgPT0gJ3llYXInKSB7CgkJCXJldHVybiAnWVlZWSc7CgkJfQoJCWVsc2UgaWYgKHRoaXMuaW50ZXJ2YWxVbml0ID09ICdtb250aCcpIHsKCQkJcmV0dXJuIHRoaXMub3B0KCdtb250aFllYXJGb3JtYXQnKTsgLy8gbGlrZSAiU2VwdGVtYmVyIDIwMTQiCgkJfQoJCWVsc2UgaWYgKHRoaXMuaW50ZXJ2YWxEdXJhdGlvbi5hcygnZGF5cycpID4gMSkgewoJCQlyZXR1cm4gJ2xsJzsgLy8gbXVsdGktZGF5IHJhbmdlLiBzaG9ydGVyLCBsaWtlICJTZXAgOSAtIDEwIDIwMTQiCgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gJ0xMJzsgLy8gb25lIGRheS4gbG9uZ2VyLCBsaWtlICJTZXB0ZW1iZXIgOSAyMDE0IgoJCX0KCX0sCgoKCS8vIFV0aWxpdHkgZm9yIGZvcm1hdHRpbmcgYSByYW5nZS4gQWNjZXB0cyBhIHJhbmdlIG9iamVjdCwgZm9ybWF0dGluZyBzdHJpbmcsIGFuZCBvcHRpb25hbCBzZXBhcmF0b3IuCgkvLyBEaXNwbGF5cyBhbGwtZGF5IHJhbmdlcyBuYXR1cmFsbHksIHdpdGggYW4gaW5jbHVzaXZlIGVuZC4gVGFrZXMgdGhlIGN1cnJlbnQgaXNSVEwgaW50byBhY2NvdW50LgoJZm9ybWF0UmFuZ2U6IGZ1bmN0aW9uKHJhbmdlLCBmb3JtYXRTdHIsIHNlcGFyYXRvcikgewoJCXZhciBlbmQgPSByYW5nZS5lbmQ7CgoJCWlmICghZW5kLmhhc1RpbWUoKSkgeyAvLyBhbGwtZGF5PwoJCQllbmQgPSBlbmQuY2xvbmUoKS5zdWJ0cmFjdCgxKTsgLy8gY29udmVydCB0byBpbmNsdXNpdmUuIGxhc3QgbXMgb2YgcHJldmlvdXMgZGF5CgkJfQoKCQlyZXR1cm4gZm9ybWF0UmFuZ2UocmFuZ2Uuc3RhcnQsIGVuZCwgZm9ybWF0U3RyLCBzZXBhcmF0b3IsIHRoaXMub3B0KCdpc1JUTCcpKTsKCX0sCgoKCS8qIFJlbmRlcmluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gV3JhcHMgdGhlIGJhc2ljIHJlbmRlcigpIG1ldGhvZCB3aXRoIG1vcmUgVmlldy1zcGVjaWZpYyBsb2dpYy4gQ2FsbGVkIGJ5IHRoZSBvd25lciBDYWxlbmRhci4KCXJlbmRlclZpZXc6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVuZGVyKCk7CgkJdGhpcy51cGRhdGVTaXplKCk7CgkJdGhpcy5pbml0aWFsaXplU2Nyb2xsKCk7CgkJdGhpcy50cmlnZ2VyKCd2aWV3UmVuZGVyJywgdGhpcywgdGhpcywgdGhpcy5lbCk7CgoJCS8vIGF0dGFjaCBoYW5kbGVycyB0byBkb2N1bWVudC4gZG8gaXQgaGVyZSB0byBhbGxvdyBmb3IgZGVzdHJveS9yZXJlbmRlcgoJCSQoZG9jdW1lbnQpLm9uKCdtb3VzZWRvd24nLCB0aGlzLmRvY3VtZW50TW91c2Vkb3duUHJveHkpOwoJfSwKCgoJLy8gUmVuZGVycyB0aGUgdmlldyBpbnNpZGUgYW4gYWxyZWFkeS1kZWZpbmVkIGB0aGlzLmVsYAoJcmVuZGVyOiBmdW5jdGlvbigpIHsKCQkvLyBzdWJjbGFzc2VzIHNob3VsZCBpbXBsZW1lbnQKCX0sCgoKCS8vIFdyYXBzIHRoZSBiYXNpYyBkZXN0cm95KCkgbWV0aG9kIHdpdGggbW9yZSBWaWV3LXNwZWNpZmljIGxvZ2ljLiBDYWxsZWQgYnkgdGhlIG93bmVyIENhbGVuZGFyLgoJZGVzdHJveVZpZXc6IGZ1bmN0aW9uKCkgewoJCXRoaXMudW5zZWxlY3QoKTsKCQl0aGlzLmRlc3Ryb3lWaWV3RXZlbnRzKCk7CgkJdGhpcy5kZXN0cm95KCk7CgkJdGhpcy50cmlnZ2VyKCd2aWV3RGVzdHJveScsIHRoaXMsIHRoaXMsIHRoaXMuZWwpOwoKCQkkKGRvY3VtZW50KS5vZmYoJ21vdXNlZG93bicsIHRoaXMuZG9jdW1lbnRNb3VzZWRvd25Qcm94eSk7Cgl9LAoKCgkvLyBDbGVhcnMgdGhlIHZpZXcncyByZW5kZXJpbmcKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWwuZW1wdHkoKTsgLy8gcmVtb3ZlcyBpbm5lciBjb250ZW50cyBidXQgbGVhdmVzIHRoZSBlbGVtZW50IGludGFjdAoJfSwKCgoJLy8gSW5pdGlhbGl6ZXMgaW50ZXJuYWwgdmFyaWFibGVzIHJlbGF0ZWQgdG8gdGhlbWluZwoJaW5pdFRoZW1pbmc6IGZ1bmN0aW9uKCkgewoJCXZhciB0bSA9IHRoaXMub3B0KCd0aGVtZScpID8gJ3VpJyA6ICdmYyc7CgoJCXRoaXMud2lkZ2V0SGVhZGVyQ2xhc3MgPSB0bSArICctd2lkZ2V0LWhlYWRlcic7CgkJdGhpcy53aWRnZXRDb250ZW50Q2xhc3MgPSB0bSArICctd2lkZ2V0LWNvbnRlbnQnOwoJCXRoaXMuaGlnaGxpZ2h0U3RhdGVDbGFzcyA9IHRtICsgJy1zdGF0ZS1oaWdobGlnaHQnOwoJfSwKCgoJLyogRGltZW5zaW9ucwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVmcmVzaGVzIGFueXRoaW5nIGRlcGVuZGFudCB1cG9uIHNpemluZyBvZiB0aGUgY29udGFpbmVyIGVsZW1lbnQgb2YgdGhlIGdyaWQKCXVwZGF0ZVNpemU6IGZ1bmN0aW9uKGlzUmVzaXplKSB7CgkJaWYgKGlzUmVzaXplKSB7CgkJCXRoaXMucmVjb3JkU2Nyb2xsKCk7CgkJfQoJCXRoaXMudXBkYXRlSGVpZ2h0KCk7CgkJdGhpcy51cGRhdGVXaWR0aCgpOwoJfSwKCgoJLy8gUmVmcmVzaGVzIHRoZSBob3Jpem9udGFsIGRpbWVuc2lvbnMgb2YgdGhlIGNhbGVuZGFyCgl1cGRhdGVXaWR0aDogZnVuY3Rpb24oKSB7CgkJLy8gc3ViY2xhc3NlcyBzaG91bGQgaW1wbGVtZW50Cgl9LAoKCgkvLyBSZWZyZXNoZXMgdGhlIHZlcnRpY2FsIGRpbWVuc2lvbnMgb2YgdGhlIGNhbGVuZGFyCgl1cGRhdGVIZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBjYWxlbmRhciA9IHRoaXMuY2FsZW5kYXI7IC8vIHdlIHBvbGwgdGhlIGNhbGVuZGFyIGZvciBoZWlnaHQgaW5mb3JtYXRpb24KCgkJdGhpcy5zZXRIZWlnaHQoCgkJCWNhbGVuZGFyLmdldFN1Z2dlc3RlZFZpZXdIZWlnaHQoKSwKCQkJY2FsZW5kYXIuaXNIZWlnaHRBdXRvKCkKCQkpOwoJfSwKCgoJLy8gVXBkYXRlcyB0aGUgdmVydGljYWwgZGltZW5zaW9ucyBvZiB0aGUgY2FsZW5kYXIgdG8gdGhlIHNwZWNpZmllZCBoZWlnaHQuCgkvLyBpZiBgaXNBdXRvYCBpcyBzZXQgdG8gdHJ1ZSwgaGVpZ2h0IGJlY29tZXMgbWVyZWx5IGEgc3VnZ2VzdGlvbiBhbmQgdGhlIHZpZXcgc2hvdWxkIHVzZSBpdHMgIm5hdHVyYWwiIGhlaWdodC4KCXNldEhlaWdodDogZnVuY3Rpb24oaGVpZ2h0LCBpc0F1dG8pIHsKCQkvLyBzdWJjbGFzc2VzIHNob3VsZCBpbXBsZW1lbnQKCX0sCgoKCS8qIFNjcm9sbGVyCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBHaXZlbiB0aGUgdG90YWwgaGVpZ2h0IG9mIHRoZSB2aWV3LCByZXR1cm4gdGhlIG51bWJlciBvZiBwaXhlbHMgdGhhdCBzaG91bGQgYmUgdXNlZCBmb3IgdGhlIHNjcm9sbGVyLgoJLy8gQnkgZGVmYXVsdCwgdXNlcyB0aGlzLnNjcm9sbGVyRWwsIGJ1dCBjYW4gcGFzcyB0aGlzIGluIGFzIHdlbGwuCgkvLyBVdGlsaXR5IGZvciBzdWJjbGFzc2VzLgoJY29tcHV0ZVNjcm9sbGVySGVpZ2h0OiBmdW5jdGlvbih0b3RhbEhlaWdodCwgc2Nyb2xsZXJFbCkgewoJCXZhciBib3RoOwoJCXZhciBvdGhlckhlaWdodDsgLy8gY3VtdWxhdGl2ZSBoZWlnaHQgb2YgZXZlcnl0aGluZyB0aGF0IGlzIG5vdCB0aGUgc2Nyb2xsZXJFbCBpbiB0aGUgdmlldyAoaGVhZGVyK2JvcmRlcnMpCgoJCXNjcm9sbGVyRWwgPSBzY3JvbGxlckVsIHx8IHRoaXMuc2Nyb2xsZXJFbDsKCQlib3RoID0gdGhpcy5lbC5hZGQoc2Nyb2xsZXJFbCk7CgoJCS8vIGZ1Y2tpbiBJRTgvOS8xMC8xMSBzb21ldGltZXMgcmV0dXJucyAwIGZvciBkaW1lbnNpb25zLiB0aGlzIHdlaXJkIGhhY2sgd2FzIHRoZSBvbmx5IHRoaW5nIHRoYXQgd29ya2VkCgkJYm90aC5jc3MoewoJCQlwb3NpdGlvbjogJ3JlbGF0aXZlJywgLy8gY2F1c2UgYSByZWZsb3csIHdoaWNoIHdpbGwgZm9yY2UgZnJlc2ggZGltZW5zaW9uIHJlY2FsY3VsYXRpb24KCQkJbGVmdDogLTEgLy8gZW5zdXJlIHJlZmxvdyBpbiBjYXNlIHRoZSBlbCB3YXMgYWxyZWFkeSByZWxhdGl2ZS4gbmVnYXRpdmUgaXMgbGVzcyBsaWtlbHkgdG8gY2F1c2UgbmV3IHNjcm9sbAoJCX0pOwoJCW90aGVySGVpZ2h0ID0gdGhpcy5lbC5vdXRlckhlaWdodCgpIC0gc2Nyb2xsZXJFbC5oZWlnaHQoKTsgLy8gZ3JhYiB0aGUgZGltZW5zaW9ucwoJCWJvdGguY3NzKHsgcG9zaXRpb246ICcnLCBsZWZ0OiAnJyB9KTsgLy8gdW5kbyBoYWNrCgoJCXJldHVybiB0b3RhbEhlaWdodCAtIG90aGVySGVpZ2h0OwoJfSwKCgoJLy8gU2V0cyB0aGUgc2Nyb2xsIHZhbHVlIG9mIHRoZSBzY3JvbGxlciB0byB0aGUgaW5pdGlhbCBwcmUtY29uZmlndXJlZCBzdGF0ZSBwcmlvciB0byBhbGxvd2luZyB0aGUgdXNlciB0byBjaGFuZ2UgaXQKCWluaXRpYWxpemVTY3JvbGw6IGZ1bmN0aW9uKCkgewoJfSwKCgoJLy8gQ2FsbGVkIGZvciByZW1lbWJlcmluZyB0aGUgY3VycmVudCBzY3JvbGwgdmFsdWUgb2YgdGhlIHNjcm9sbGVyLgoJLy8gU2hvdWxkIGJlIGNhbGxlZCBiZWZvcmUgdGhlcmUgaXMgYSBkZXN0cnVjdGl2ZSBvcGVyYXRpb24gKGxpa2UgcmVtb3ZpbmcgRE9NIGVsZW1lbnRzKSB0aGF0IG1pZ2h0IGluYWR2ZXJ0ZW50bHkKCS8vIGNoYW5nZSB0aGUgc2Nyb2xsIG9mIHRoZSBjb250YWluZXIuCglyZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCWlmICh0aGlzLnNjcm9sbGVyRWwpIHsKCQkJdGhpcy5zY3JvbGxUb3AgPSB0aGlzLnNjcm9sbGVyRWwuc2Nyb2xsVG9wKCk7CgkJfQoJfSwKCgoJLy8gU2V0IHRoZSBzY3JvbGwgdmFsdWUgb2YgdGhlIHNjcm9sbGVyIHRvIHRoZSBwcmV2aW91c2x5IHJlY29yZGVkIHZhbHVlLgoJLy8gU2hvdWxkIGJlIGNhbGxlZCBhZnRlciB3ZSBrbm93IHRoZSB2aWV3J3MgZGltZW5zaW9ucyBoYXZlIGJlZW4gcmVzdG9yZWQgZm9sbG93aW5nIHNvbWUgdHlwZSBvZiBkZXN0cnVjdGl2ZQoJLy8gb3BlcmF0aW9uIChsaWtlIHRlbXBvcmFyaWx5IHJlbW92aW5nIERPTSBlbGVtZW50cykuCglyZXN0b3JlU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5zY3JvbGxUb3AgIT09IG51bGwpIHsKCQkJdGhpcy5zY3JvbGxlckVsLnNjcm9sbFRvcCh0aGlzLnNjcm9sbFRvcCk7CgkJfQoJfSwKCgoJLyogRXZlbnQgRWxlbWVudHMgLyBTZWdtZW50cwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gV3JhcHMgdGhlIGJhc2ljIHJlbmRlckV2ZW50cygpIG1ldGhvZCB3aXRoIG1vcmUgVmlldy1zcGVjaWZpYyBsb2dpYwoJcmVuZGVyVmlld0V2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CgkJdGhpcy5yZW5kZXJFdmVudHMoZXZlbnRzKTsKCgkJdGhpcy5ldmVudFNlZ0VhY2goZnVuY3Rpb24oc2VnKSB7CgkJCXRoaXMudHJpZ2dlcignZXZlbnRBZnRlclJlbmRlcicsIHNlZy5ldmVudCwgc2VnLmV2ZW50LCBzZWcuZWwpOwoJCX0pOwoJCXRoaXMudHJpZ2dlcignZXZlbnRBZnRlckFsbFJlbmRlcicpOwoJfSwKCgoJLy8gUmVuZGVycyB0aGUgZXZlbnRzIG9udG8gdGhlIHZpZXcuCglyZW5kZXJFdmVudHM6IGZ1bmN0aW9uKCkgewoJCS8vIHN1YmNsYXNzZXMgc2hvdWxkIGltcGxlbWVudAoJfSwKCgoJLy8gV3JhcHMgdGhlIGJhc2ljIGRlc3Ryb3lFdmVudHMoKSBtZXRob2Qgd2l0aCBtb3JlIFZpZXctc3BlY2lmaWMgbG9naWMKCWRlc3Ryb3lWaWV3RXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmV2ZW50U2VnRWFjaChmdW5jdGlvbihzZWcpIHsKCQkJdGhpcy50cmlnZ2VyKCdldmVudERlc3Ryb3knLCBzZWcuZXZlbnQsIHNlZy5ldmVudCwgc2VnLmVsKTsKCQl9KTsKCgkJdGhpcy5kZXN0cm95RXZlbnRzKCk7Cgl9LAoKCgkvLyBSZW1vdmVzIGV2ZW50IGVsZW1lbnRzIGZyb20gdGhlIHZpZXcuCglkZXN0cm95RXZlbnRzOiBmdW5jdGlvbigpIHsKCQkvLyBzdWJjbGFzc2VzIHNob3VsZCBpbXBsZW1lbnQKCX0sCgoKCS8vIEdpdmVuIGFuIGV2ZW50IGFuZCB0aGUgZGVmYXVsdCBlbGVtZW50IHVzZWQgZm9yIHJlbmRlcmluZywgcmV0dXJucyB0aGUgZWxlbWVudCB0aGF0IHNob3VsZCBhY3R1YWxseSBiZSB1c2VkLgoJLy8gQmFzaWNhbGx5IHJ1bnMgZXZlbnRzIGFuZCBlbGVtZW50cyB0aHJvdWdoIHRoZSBldmVudFJlbmRlciBob29rLgoJcmVzb2x2ZUV2ZW50RWw6IGZ1bmN0aW9uKGV2ZW50LCBlbCkgewoJCXZhciBjdXN0b20gPSB0aGlzLnRyaWdnZXIoJ2V2ZW50UmVuZGVyJywgZXZlbnQsIGV2ZW50LCBlbCk7CgoJCWlmIChjdXN0b20gPT09IGZhbHNlKSB7IC8vIG1lYW5zIGRvbid0IHJlbmRlciBhdCBhbGwKCQkJZWwgPSBudWxsOwoJCX0KCQllbHNlIGlmIChjdXN0b20gJiYgY3VzdG9tICE9PSB0cnVlKSB7CgkJCWVsID0gJChjdXN0b20pOwoJCX0KCgkJcmV0dXJuIGVsOwoJfSwKCgoJLy8gSGlkZXMgYWxsIHJlbmRlcmVkIGV2ZW50IHNlZ21lbnRzIGxpbmtlZCB0byB0aGUgZ2l2ZW4gZXZlbnQKCXNob3dFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKCQl0aGlzLmV2ZW50U2VnRWFjaChmdW5jdGlvbihzZWcpIHsKCQkJc2VnLmVsLmNzcygndmlzaWJpbGl0eScsICcnKTsKCQl9LCBldmVudCk7Cgl9LAoKCgkvLyBTaG93cyBhbGwgcmVuZGVyZWQgZXZlbnQgc2VnbWVudHMgbGlua2VkIHRvIHRoZSBnaXZlbiBldmVudAoJaGlkZUV2ZW50OiBmdW5jdGlvbihldmVudCkgewoJCXRoaXMuZXZlbnRTZWdFYWNoKGZ1bmN0aW9uKHNlZykgewoJCQlzZWcuZWwuY3NzKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpOwoJCX0sIGV2ZW50KTsKCX0sCgoKCS8vIEl0ZXJhdGVzIHRocm91Z2ggZXZlbnQgc2VnbWVudHMuIEdvZXMgdGhyb3VnaCBhbGwgYnkgZGVmYXVsdC4KCS8vIElmIHRoZSBvcHRpb25hbCBgZXZlbnRgIGFyZ3VtZW50IGlzIHNwZWNpZmllZCwgb25seSBpdGVyYXRlcyB0aHJvdWdoIHNlZ21lbnRzIGxpbmtlZCB0byB0aGF0IGV2ZW50LgoJLy8gVGhlIGB0aGlzYCB2YWx1ZSBvZiB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSB0aGUgdmlldy4KCWV2ZW50U2VnRWFjaDogZnVuY3Rpb24oZnVuYywgZXZlbnQpIHsKCQl2YXIgc2VncyA9IHRoaXMuZ2V0RXZlbnRTZWdzKCk7CgkJdmFyIGk7CgoJCWZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICghZXZlbnQgfHwgc2Vnc1tpXS5ldmVudC5faWQgPT09IGV2ZW50Ll9pZCkgewoJCQkJZnVuYy5jYWxsKHRoaXMsIHNlZ3NbaV0pOwoJCQl9CgkJfQoJfSwKCgoJLy8gUmV0cmlldmVzIGFsbCB0aGUgcmVuZGVyZWQgc2VnbWVudCBvYmplY3RzIGZvciB0aGUgdmlldwoJZ2V0RXZlbnRTZWdzOiBmdW5jdGlvbigpIHsKCQkvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50CgkJcmV0dXJuIFtdOwoJfSwKCgoJLyogRXZlbnQgRHJhZy1uLURyb3AKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIENvbXB1dGVzIGlmIHRoZSBnaXZlbiBldmVudCBpcyBhbGxvd2VkIHRvIGJlIGRyYWdnZWQgYnkgdGhlIHVzZXIKCWlzRXZlbnREcmFnZ2FibGU6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJdmFyIHNvdXJjZSA9IGV2ZW50LnNvdXJjZSB8fCB7fTsKCgkJcmV0dXJuIGZpcnN0RGVmaW5lZCgKCQkJZXZlbnQuc3RhcnRFZGl0YWJsZSwKCQkJc291cmNlLnN0YXJ0RWRpdGFibGUsCgkJCXRoaXMub3B0KCdldmVudFN0YXJ0RWRpdGFibGUnKSwKCQkJZXZlbnQuZWRpdGFibGUsCgkJCXNvdXJjZS5lZGl0YWJsZSwKCQkJdGhpcy5vcHQoJ2VkaXRhYmxlJykKCQkpOwoJfSwKCgoJLy8gTXVzdCBiZSBjYWxsZWQgd2hlbiBhbiBldmVudCBpbiB0aGUgdmlldyBpcyBkcm9wcGVkIG9udG8gbmV3IGxvY2F0aW9uLgoJLy8gYGRyb3BMb2NhdGlvbmAgaXMgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIG5ldyBzdGFydC9lbmQvYWxsRGF5IHZhbHVlcyBmb3IgdGhlIGV2ZW50LgoJcmVwb3J0RXZlbnREcm9wOiBmdW5jdGlvbihldmVudCwgZHJvcExvY2F0aW9uLCBlbCwgZXYpIHsKCQl2YXIgY2FsZW5kYXIgPSB0aGlzLmNhbGVuZGFyOwoJCXZhciBtdXRhdGVSZXN1bHQgPSBjYWxlbmRhci5tdXRhdGVFdmVudChldmVudCwgZHJvcExvY2F0aW9uKTsKCQl2YXIgdW5kb0Z1bmMgPSBmdW5jdGlvbigpIHsKCQkJbXV0YXRlUmVzdWx0LnVuZG8oKTsKCQkJY2FsZW5kYXIucmVwb3J0RXZlbnRDaGFuZ2UoKTsKCQl9OwoKCQl0aGlzLnRyaWdnZXJFdmVudERyb3AoZXZlbnQsIG11dGF0ZVJlc3VsdC5kYXRlRGVsdGEsIHVuZG9GdW5jLCBlbCwgZXYpOwoJCWNhbGVuZGFyLnJlcG9ydEV2ZW50Q2hhbmdlKCk7IC8vIHdpbGwgcmVyZW5kZXIgZXZlbnRzCgl9LAoKCgkvLyBUcmlnZ2VycyBldmVudC1kcm9wIGhhbmRsZXJzIHRoYXQgaGF2ZSBzdWJzY3JpYmVkIHZpYSB0aGUgQVBJCgl0cmlnZ2VyRXZlbnREcm9wOiBmdW5jdGlvbihldmVudCwgZGF0ZURlbHRhLCB1bmRvRnVuYywgZWwsIGV2KSB7CgkJdGhpcy50cmlnZ2VyKCdldmVudERyb3AnLCBlbFswXSwgZXZlbnQsIGRhdGVEZWx0YSwgdW5kb0Z1bmMsIGV2LCB7fSk7IC8vIHt9ID0ganF1aSBkdW1teQoJfSwKCgoJLyogRXh0ZXJuYWwgRWxlbWVudCBEcmFnLW4tRHJvcAoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gTXVzdCBiZSBjYWxsZWQgd2hlbiBhbiBleHRlcm5hbCBlbGVtZW50LCB2aWEgalF1ZXJ5IFVJLCBoYXMgYmVlbiBkcm9wcGVkIG9udG8gdGhlIGNhbGVuZGFyLgoJLy8gYG1ldGFgIGlzIHRoZSBwYXJzZWQgZGF0YSB0aGF0IGhhcyBiZWVuIGVtYmVkZGVkIGludG8gdGhlIGRyYWdnaW5nIGV2ZW50LgoJLy8gYGRyb3BMb2NhdGlvbmAgaXMgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgdGhlIG5ldyBzdGFydC9lbmQvYWxsRGF5IHZhbHVlcyBmb3IgdGhlIGV2ZW50LgoJcmVwb3J0RXh0ZXJuYWxEcm9wOiBmdW5jdGlvbihtZXRhLCBkcm9wTG9jYXRpb24sIGVsLCBldiwgdWkpIHsKCQl2YXIgZXZlbnRQcm9wcyA9IG1ldGEuZXZlbnRQcm9wczsKCQl2YXIgZXZlbnRJbnB1dDsKCQl2YXIgZXZlbnQ7CgoJCS8vIFRyeSB0byBidWlsZCBhbiBldmVudCBvYmplY3QgYW5kIHJlbmRlciBpdC4gVE9ETzogZGVjb3VwbGUgdGhlIHR3bwoJCWlmIChldmVudFByb3BzKSB7CgkJCWV2ZW50SW5wdXQgPSAkLmV4dGVuZCh7fSwgZXZlbnRQcm9wcywgZHJvcExvY2F0aW9uKTsKCQkJZXZlbnQgPSB0aGlzLmNhbGVuZGFyLnJlbmRlckV2ZW50KGV2ZW50SW5wdXQsIG1ldGEuc3RpY2spWzBdOyAvLyByZW5kZXJFdmVudCByZXR1cm5zIGFuIGFycmF5CgkJfQoKCQl0aGlzLnRyaWdnZXJFeHRlcm5hbERyb3AoZXZlbnQsIGRyb3BMb2NhdGlvbiwgZWwsIGV2LCB1aSk7Cgl9LAoKCgkvLyBUcmlnZ2VycyBleHRlcm5hbC1kcm9wIGhhbmRsZXJzIHRoYXQgaGF2ZSBzdWJzY3JpYmVkIHZpYSB0aGUgQVBJCgl0cmlnZ2VyRXh0ZXJuYWxEcm9wOiBmdW5jdGlvbihldmVudCwgZHJvcExvY2F0aW9uLCBlbCwgZXYsIHVpKSB7CgoJCS8vIHRyaWdnZXIgJ2Ryb3AnIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciBlbGVtZW50IHJlcHJlc2VudHMgYW4gZXZlbnQKCQl0aGlzLnRyaWdnZXIoJ2Ryb3AnLCBlbFswXSwgZHJvcExvY2F0aW9uLnN0YXJ0LCBldiwgdWkpOwoKCQlpZiAoZXZlbnQpIHsKCQkJdGhpcy50cmlnZ2VyKCdldmVudFJlY2VpdmUnLCBudWxsLCBldmVudCk7IC8vIHNpZ25hbCBhbiBleHRlcm5hbCBldmVudCBsYW5kZWQKCQl9Cgl9LAoKCgkvKiBEcmFnLW4tRHJvcCBSZW5kZXJpbmcgKGZvciBib3RoIGV2ZW50cyBhbmQgZXh0ZXJuYWwgZWxlbWVudHMpCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYSBldmVudCBvciBleHRlcm5hbC1lbGVtZW50IGRyYWcgb3ZlciB0aGUgZ2l2ZW4gZHJvcCB6b25lLgoJLy8gSWYgYW4gZXh0ZXJuYWwtZWxlbWVudCwgc2VnIHdpbGwgYmUgYG51bGxgCglyZW5kZXJEcmFnOiBmdW5jdGlvbihkcm9wTG9jYXRpb24sIHNlZykgewoJCS8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQKCX0sCgoKCS8vIFVucmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGFuIGV2ZW50IG9yIGV4dGVybmFsLWVsZW1lbnQgYmVpbmcgZHJhZ2dlZC4KCWRlc3Ryb3lEcmFnOiBmdW5jdGlvbigpIHsKCQkvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50Cgl9LAoKCgkvKiBFdmVudCBSZXNpemluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gQ29tcHV0ZXMgaWYgdGhlIGdpdmVuIGV2ZW50IGlzIGFsbG93ZWQgdG8gYmUgcmVzaXplIGJ5IHRoZSB1c2VyCglpc0V2ZW50UmVzaXphYmxlOiBmdW5jdGlvbihldmVudCkgewoJCXZhciBzb3VyY2UgPSBldmVudC5zb3VyY2UgfHwge307CgoJCXJldHVybiBmaXJzdERlZmluZWQoCgkJCWV2ZW50LmR1cmF0aW9uRWRpdGFibGUsCgkJCXNvdXJjZS5kdXJhdGlvbkVkaXRhYmxlLAoJCQl0aGlzLm9wdCgnZXZlbnREdXJhdGlvbkVkaXRhYmxlJyksCgkJCWV2ZW50LmVkaXRhYmxlLAoJCQlzb3VyY2UuZWRpdGFibGUsCgkJCXRoaXMub3B0KCdlZGl0YWJsZScpCgkJKTsKCX0sCgoKCS8vIE11c3QgYmUgY2FsbGVkIHdoZW4gYW4gZXZlbnQgaW4gdGhlIHZpZXcgaGFzIGJlZW4gcmVzaXplZCB0byBhIG5ldyBsZW5ndGgKCXJlcG9ydEV2ZW50UmVzaXplOiBmdW5jdGlvbihldmVudCwgbmV3RW5kLCBlbCwgZXYpIHsKCQl2YXIgY2FsZW5kYXIgPSB0aGlzLmNhbGVuZGFyOwoJCXZhciBtdXRhdGVSZXN1bHQgPSBjYWxlbmRhci5tdXRhdGVFdmVudChldmVudCwgeyBlbmQ6IG5ld0VuZCB9KTsKCQl2YXIgdW5kb0Z1bmMgPSBmdW5jdGlvbigpIHsKCQkJbXV0YXRlUmVzdWx0LnVuZG8oKTsKCQkJY2FsZW5kYXIucmVwb3J0RXZlbnRDaGFuZ2UoKTsKCQl9OwoKCQl0aGlzLnRyaWdnZXJFdmVudFJlc2l6ZShldmVudCwgbXV0YXRlUmVzdWx0LmR1cmF0aW9uRGVsdGEsIHVuZG9GdW5jLCBlbCwgZXYpOwoJCWNhbGVuZGFyLnJlcG9ydEV2ZW50Q2hhbmdlKCk7IC8vIHdpbGwgcmVyZW5kZXIgZXZlbnRzCgl9LAoKCgkvLyBUcmlnZ2VycyBldmVudC1yZXNpemUgaGFuZGxlcnMgdGhhdCBoYXZlIHN1YnNjcmliZWQgdmlhIHRoZSBBUEkKCXRyaWdnZXJFdmVudFJlc2l6ZTogZnVuY3Rpb24oZXZlbnQsIGR1cmF0aW9uRGVsdGEsIHVuZG9GdW5jLCBlbCwgZXYpIHsKCQl0aGlzLnRyaWdnZXIoJ2V2ZW50UmVzaXplJywgZWxbMF0sIGV2ZW50LCBkdXJhdGlvbkRlbHRhLCB1bmRvRnVuYywgZXYsIHt9KTsgLy8ge30gPSBqcXVpIGR1bW15Cgl9LAoKCgkvKiBTZWxlY3Rpb24KCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIFNlbGVjdHMgYSBkYXRlIHJhbmdlIG9uIHRoZSB2aWV3LiBgc3RhcnRgIGFuZCBgZW5kYCBhcmUgYm90aCBNb21lbnRzLgoJLy8gYGV2YCBpcyB0aGUgbmF0aXZlIG1vdXNlIGV2ZW50IHRoYXQgYmVnaW4gdGhlIGludGVyYWN0aW9uLgoJc2VsZWN0OiBmdW5jdGlvbihyYW5nZSwgZXYpIHsKCQl0aGlzLnVuc2VsZWN0KGV2KTsKCQl0aGlzLnJlbmRlclNlbGVjdGlvbihyYW5nZSk7CgkJdGhpcy5yZXBvcnRTZWxlY3Rpb24ocmFuZ2UsIGV2KTsKCX0sCgoKCS8vIFJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiB0aGUgc2VsZWN0aW9uCglyZW5kZXJTZWxlY3Rpb246IGZ1bmN0aW9uKHJhbmdlKSB7CgkJLy8gc3ViY2xhc3NlcyBzaG91bGQgaW1wbGVtZW50Cgl9LAoKCgkvLyBDYWxsZWQgd2hlbiBhIG5ldyBzZWxlY3Rpb24gaXMgbWFkZS4gVXBkYXRlcyBpbnRlcm5hbCBzdGF0ZSBhbmQgdHJpZ2dlcnMgaGFuZGxlcnMuCglyZXBvcnRTZWxlY3Rpb246IGZ1bmN0aW9uKHJhbmdlLCBldikgewoJCXRoaXMuaXNTZWxlY3RlZCA9IHRydWU7CgkJdGhpcy50cmlnZ2VyKCdzZWxlY3QnLCBudWxsLCByYW5nZS5zdGFydCwgcmFuZ2UuZW5kLCBldik7Cgl9LAoKCgkvLyBVbmRvZXMgYSBzZWxlY3Rpb24uIHVwZGF0ZXMgaW4gdGhlIGludGVybmFsIHN0YXRlIGFuZCB0cmlnZ2VycyBoYW5kbGVycy4KCS8vIGBldmAgaXMgdGhlIG5hdGl2ZSBtb3VzZSBldmVudCB0aGF0IGJlZ2FuIHRoZSBpbnRlcmFjdGlvbi4KCXVuc2VsZWN0OiBmdW5jdGlvbihldikgewoJCWlmICh0aGlzLmlzU2VsZWN0ZWQpIHsKCQkJdGhpcy5pc1NlbGVjdGVkID0gZmFsc2U7CgkJCXRoaXMuZGVzdHJveVNlbGVjdGlvbigpOwoJCQl0aGlzLnRyaWdnZXIoJ3Vuc2VsZWN0JywgbnVsbCwgZXYpOwoJCX0KCX0sCgoKCS8vIFVucmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIHNlbGVjdGlvbgoJZGVzdHJveVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJLy8gc3ViY2xhc3NlcyBzaG91bGQgaW1wbGVtZW50Cgl9LAoKCgkvLyBIYW5kbGVyIGZvciB1bnNlbGVjdGluZyB3aGVuIHRoZSB1c2VyIGNsaWNrcyBzb21ldGhpbmcgYW5kIHRoZSAndW5zZWxlY3RBdXRvJyBzZXR0aW5nIGlzIG9uCglkb2N1bWVudE1vdXNlZG93bjogZnVuY3Rpb24oZXYpIHsKCQl2YXIgaWdub3JlOwoKCQkvLyBpcyB0aGVyZSBhIHNlbGVjdGlvbiwgYW5kIGhhcyB0aGUgdXNlciBtYWRlIGEgcHJvcGVyIGxlZnQgY2xpY2s\/CgkJaWYgKHRoaXMuaXNTZWxlY3RlZCAmJiB0aGlzLm9wdCgndW5zZWxlY3RBdXRvJykgJiYgaXNQcmltYXJ5TW91c2VCdXR0b24oZXYpKSB7CgoJCQkvLyBvbmx5IHVuc2VsZWN0IGlmIHRoZSBjbGlja2VkIGVsZW1lbnQgaXMgbm90IGlkZW50aWNhbCB0byBvciBpbnNpZGUgb2YgYW4gJ3Vuc2VsZWN0Q2FuY2VsJyBlbGVtZW50CgkJCWlnbm9yZSA9IHRoaXMub3B0KCd1bnNlbGVjdENhbmNlbCcpOwoJCQlpZiAoIWlnbm9yZSB8fCAhJChldi50YXJnZXQpLmNsb3Nlc3QoaWdub3JlKS5sZW5ndGgpIHsKCQkJCXRoaXMudW5zZWxlY3QoZXYpOwoJCQl9CgkJfQoJfSwKCgoJLyogRGF0ZSBVdGlscwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gSW5pdGlhbGl6ZXMgaW50ZXJuYWwgdmFyaWFibGVzIHJlbGF0ZWQgdG8gY2FsY3VsYXRpbmcgaGlkZGVuIGRheXMtb2Ytd2VlawoJaW5pdEhpZGRlbkRheXM6IGZ1bmN0aW9uKCkgewoJCXZhciBoaWRkZW5EYXlzID0gdGhpcy5vcHQoJ2hpZGRlbkRheXMnKSB8fCBbXTsgLy8gYXJyYXkgb2YgZGF5LW9mLXdlZWsgaW5kaWNlcyB0aGF0IGFyZSBoaWRkZW4KCQl2YXIgaXNIaWRkZW5EYXlIYXNoID0gW107IC8vIGlzIHRoZSBkYXktb2Ytd2VlayBoaWRkZW4\/IChoYXNoIHdpdGggZGF5LW9mLXdlZWstaW5kZXggLT4gYm9vbCkKCQl2YXIgZGF5Q250ID0gMDsKCQl2YXIgaTsKCgkJaWYgKHRoaXMub3B0KCd3ZWVrZW5kcycpID09PSBmYWxzZSkgewoJCQloaWRkZW5EYXlzLnB1c2goMCwgNik7IC8vIDA9c3VuZGF5LCA2PXNhdHVyZGF5CgkJfQoKCQlmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7CgkJCWlmICgKCQkJCSEoaXNIaWRkZW5EYXlIYXNoW2ldID0gJC5pbkFycmF5KGksIGhpZGRlbkRheXMpICE9PSAtMSkKCQkJKSB7CgkJCQlkYXlDbnQrKzsKCQkJfQoJCX0KCgkJaWYgKCFkYXlDbnQpIHsKCQkJdGhyb3cgJ2ludmFsaWQgaGlkZGVuRGF5cyc7IC8vIGFsbCBkYXlzIHdlcmUgaGlkZGVuPyBiYWQuCgkJfQoKCQl0aGlzLmlzSGlkZGVuRGF5SGFzaCA9IGlzSGlkZGVuRGF5SGFzaDsKCX0sCgoKCS8vIElzIHRoZSBjdXJyZW50IGRheSBoaWRkZW4\/CgkvLyBgZGF5YCBpcyBhIGRheS1vZi13ZWVrIGluZGV4ICgwLTYpLCBvciBhIE1vbWVudAoJaXNIaWRkZW5EYXk6IGZ1bmN0aW9uKGRheSkgewoJCWlmIChtb21lbnQuaXNNb21lbnQoZGF5KSkgewoJCQlkYXkgPSBkYXkuZGF5KCk7CgkJfQoJCXJldHVybiB0aGlzLmlzSGlkZGVuRGF5SGFzaFtkYXldOwoJfSwKCgoJLy8gSW5jcmVtZW50aW5nIHRoZSBjdXJyZW50IGRheSB1bnRpbCBpdCBpcyBubyBsb25nZXIgYSBoaWRkZW4gZGF5LCByZXR1cm5pbmcgYSBjb3B5LgoJLy8gSWYgdGhlIGluaXRpYWwgdmFsdWUgb2YgYGRhdGVgIGlzIG5vdCBhIGhpZGRlbiBkYXksIGRvbid0IGRvIGFueXRoaW5nLgoJLy8gUGFzcyBgaXNFeGNsdXNpdmVgIGFzIGB0cnVlYCBpZiB5b3UgYXJlIGRlYWxpbmcgd2l0aCBhbiBlbmQgZGF0ZS4KCS8vIGBpbmNgIGRlZmF1bHRzIHRvIGAxYCAoaW5jcmVtZW50IG9uZSBkYXkgZm9yd2FyZCBlYWNoIHRpbWUpCglza2lwSGlkZGVuRGF5czogZnVuY3Rpb24oZGF0ZSwgaW5jLCBpc0V4Y2x1c2l2ZSkgewoJCXZhciBvdXQgPSBkYXRlLmNsb25lKCk7CgkJaW5jID0gaW5jIHx8IDE7CgkJd2hpbGUgKAoJCQl0aGlzLmlzSGlkZGVuRGF5SGFzaFsob3V0LmRheSgpICsgKGlzRXhjbHVzaXZlID8gaW5jIDogMCkgKyA3KSAlIDddCgkJKSB7CgkJCW91dC5hZGQoaW5jLCAnZGF5cycpOwoJCX0KCQlyZXR1cm4gb3V0OwoJfSwKCgoJLy8gUmV0dXJucyB0aGUgZGF0ZSByYW5nZSBvZiB0aGUgZnVsbCBkYXlzIHRoZSBnaXZlbiByYW5nZSB2aXN1YWxseSBhcHBlYXJzIHRvIG9jY3VweS4KCS8vIFJldHVybnMgYSBuZXcgcmFuZ2Ugb2JqZWN0LgoJY29tcHV0ZURheVJhbmdlOiBmdW5jdGlvbihyYW5nZSkgewoJCXZhciBzdGFydERheSA9IHJhbmdlLnN0YXJ0LmNsb25lKCkuc3RyaXBUaW1lKCk7IC8vIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGRheSB0aGUgcmFuZ2Ugc3RhcnRzCgkJdmFyIGVuZCA9IHJhbmdlLmVuZDsKCQl2YXIgZW5kRGF5ID0gbnVsbDsKCQl2YXIgZW5kVGltZU1TOwoKCQlpZiAoZW5kKSB7CgkJCWVuZERheSA9IGVuZC5jbG9uZSgpLnN0cmlwVGltZSgpOyAvLyB0aGUgYmVnaW5uaW5nIG9mIHRoZSBkYXkgdGhlIHJhbmdlIGV4Y2x1c2l2ZWx5IGVuZHMKCQkJZW5kVGltZU1TID0gK2VuZC50aW1lKCk7IC8vICMgb2YgbWlsbGlzZWNvbmRzIGludG8gYGVuZERheWAKCgkJCS8vIElmIHRoZSBlbmQgdGltZSBpcyBhY3R1YWxseSBpbmNsdXNpdmVseSBwYXJ0IG9mIHRoZSBuZXh0IGRheSBhbmQgaXMgZXF1YWwgdG8gb3IKCQkJLy8gYmV5b25kIHRoZSBuZXh0IGRheSB0aHJlc2hvbGQsIGFkanVzdCB0aGUgZW5kIHRvIGJlIHRoZSBleGNsdXNpdmUgZW5kIG9mIGBlbmREYXlgLgoJCQkvLyBPdGhlcndpc2UsIGxlYXZpbmcgaXQgYXMgaW5jbHVzaXZlIHdpbGwgY2F1c2UgaXQgdG8gZXhjbHVkZSBgZW5kRGF5YC4KCQkJaWYgKGVuZFRpbWVNUyAmJiBlbmRUaW1lTVMgPj0gdGhpcy5uZXh0RGF5VGhyZXNob2xkKSB7CgkJCQllbmREYXkuYWRkKDEsICdkYXlzJyk7CgkJCX0KCQl9CgoJCS8vIElmIG5vIGVuZCB3YXMgc3BlY2lmaWVkLCBvciBpZiBpdCBpcyB3aXRoaW4gYHN0YXJ0RGF5YCBidXQgbm90IHBhc3QgbmV4dERheVRocmVzaG9sZCwKCQkvLyBhc3NpZ24gdGhlIGRlZmF1bHQgZHVyYXRpb24gb2Ygb25lIGRheS4KCQlpZiAoIWVuZCB8fCBlbmREYXkgPD0gc3RhcnREYXkpIHsKCQkJZW5kRGF5ID0gc3RhcnREYXkuY2xvbmUoKS5hZGQoMSwgJ2RheXMnKTsKCQl9CgoJCXJldHVybiB7IHN0YXJ0OiBzdGFydERheSwgZW5kOiBlbmREYXkgfTsKCX0sCgoKCS8vIERvZXMgdGhlIGdpdmVuIGV2ZW50IHZpc3VhbGx5IGFwcGVhciB0byBvY2N1cHkgbW9yZSB0aGFuIG9uZSBkYXk\/Cglpc011bHRpRGF5RXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJdmFyIHJhbmdlID0gdGhpcy5jb21wdXRlRGF5UmFuZ2UoZXZlbnQpOyAvLyBldmVudCBpcyByYW5nZS1pc2gKCgkJcmV0dXJuIHJhbmdlLmVuZC5kaWZmKHJhbmdlLnN0YXJ0LCAnZGF5cycpID4gMTsKCX0KCn0pOwoKOzsKCiAKZnVuY3Rpb24gQ2FsZW5kYXIoZWxlbWVudCwgaW5zdGFuY2VPcHRpb25zKSB7Cgl2YXIgdCA9IHRoaXM7CgoKCgkvLyBCdWlsZCBvcHRpb25zIG9iamVjdAoJLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCS8vIFByZWNlZGVuY2UgKGxvd2VzdCB0byBoaWdoZXN0KTogZGVmYXVsdHMsIHJ0bERlZmF1bHRzLCBsYW5nT3B0aW9ucywgaW5zdGFuY2VPcHRpb25zCgoJaW5zdGFuY2VPcHRpb25zID0gaW5zdGFuY2VPcHRpb25zIHx8IHt9OwoKCXZhciBvcHRpb25zID0gbWVyZ2VPcHRpb25zKHt9LCBkZWZhdWx0cywgaW5zdGFuY2VPcHRpb25zKTsKCXZhciBsYW5nT3B0aW9uczsKCgkvLyBkZXRlcm1pbmUgbGFuZ3VhZ2Ugb3B0aW9ucwoJaWYgKG9wdGlvbnMubGFuZyBpbiBsYW5nT3B0aW9uSGFzaCkgewoJCWxhbmdPcHRpb25zID0gbGFuZ09wdGlvbkhhc2hbb3B0aW9ucy5sYW5nXTsKCX0KCWVsc2UgewoJCWxhbmdPcHRpb25zID0gbGFuZ09wdGlvbkhhc2hbZGVmYXVsdHMubGFuZ107Cgl9CgoJaWYgKGxhbmdPcHRpb25zKSB7IC8vIGlmIGxhbmd1YWdlIG9wdGlvbnMgZXhpc3QsIHJlYnVpbGQuLi4KCQlvcHRpb25zID0gbWVyZ2VPcHRpb25zKHt9LCBkZWZhdWx0cywgbGFuZ09wdGlvbnMsIGluc3RhbmNlT3B0aW9ucyk7Cgl9CgoJaWYgKG9wdGlvbnMuaXNSVEwpIHsgLy8gaXMgaXNSVEwsIHJlYnVpbGQuLi4KCQlvcHRpb25zID0gbWVyZ2VPcHRpb25zKHt9LCBkZWZhdWx0cywgcnRsRGVmYXVsdHMsIGxhbmdPcHRpb25zIHx8IHt9LCBpbnN0YW5jZU9wdGlvbnMpOwoJfQoKCgkKCS8vIEV4cG9ydHMKCS8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoJdC5vcHRpb25zID0gb3B0aW9uczsKCXQucmVuZGVyID0gcmVuZGVyOwoJdC5kZXN0cm95ID0gZGVzdHJveTsKCXQucmVmZXRjaEV2ZW50cyA9IHJlZmV0Y2hFdmVudHM7Cgl0LnJlcG9ydEV2ZW50cyA9IHJlcG9ydEV2ZW50czsKCXQucmVwb3J0RXZlbnRDaGFuZ2UgPSByZXBvcnRFdmVudENoYW5nZTsKCXQucmVyZW5kZXJFdmVudHMgPSByZW5kZXJFdmVudHM7IC8vIGByZW5kZXJFdmVudHNgIHNlcnZlcyBhcyBhIHJlcmVuZGVyLiBhbiBBUEkgbWV0aG9kCgl0LmNoYW5nZVZpZXcgPSByZW5kZXJWaWV3OyAvLyBgcmVuZGVyVmlld2Agd2lsbCBzd2l0Y2ggdG8gYW5vdGhlciB2aWV3Cgl0LnNlbGVjdCA9IHNlbGVjdDsKCXQudW5zZWxlY3QgPSB1bnNlbGVjdDsKCXQucHJldiA9IHByZXY7Cgl0Lm5leHQgPSBuZXh0OwoJdC5wcmV2WWVhciA9IHByZXZZZWFyOwoJdC5uZXh0WWVhciA9IG5leHRZZWFyOwoJdC50b2RheSA9IHRvZGF5OwoJdC5nb3RvRGF0ZSA9IGdvdG9EYXRlOwoJdC5pbmNyZW1lbnREYXRlID0gaW5jcmVtZW50RGF0ZTsKCXQuem9vbVRvID0gem9vbVRvOwoJdC5nZXREYXRlID0gZ2V0RGF0ZTsKCXQuZ2V0Q2FsZW5kYXIgPSBnZXRDYWxlbmRhcjsKCXQuZ2V0VmlldyA9IGdldFZpZXc7Cgl0Lm9wdGlvbiA9IG9wdGlvbjsKCXQudHJpZ2dlciA9IHRyaWdnZXI7Cgl0LmlzVmFsaWRWaWV3VHlwZSA9IGlzVmFsaWRWaWV3VHlwZTsKCXQuZ2V0Vmlld0J1dHRvblRleHQgPSBnZXRWaWV3QnV0dG9uVGV4dDsKCgoKCS8vIExhbmd1YWdlLWRhdGEgSW50ZXJuYWxzCgkvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJLy8gQXBwbHkgb3ZlcnJpZGVzIHRvIHRoZSBjdXJyZW50IGxhbmd1YWdlJ3MgZGF0YQoKCgl2YXIgbG9jYWxlRGF0YSA9IGNyZWF0ZU9iamVjdCggLy8gbWFrZSBhIGNoZWFwIGNvcHkKCQlnZXRNb21lbnRMb2NhbGVEYXRhKG9wdGlvbnMubGFuZykgLy8gd2lsbCBmYWxsIGJhY2sgdG8gZW4KCSk7CgoJaWYgKG9wdGlvbnMubW9udGhOYW1lcykgewoJCWxvY2FsZURhdGEuX21vbnRocyA9IG9wdGlvbnMubW9udGhOYW1lczsKCX0KCWlmIChvcHRpb25zLm1vbnRoTmFtZXNTaG9ydCkgewoJCWxvY2FsZURhdGEuX21vbnRoc1Nob3J0ID0gb3B0aW9ucy5tb250aE5hbWVzU2hvcnQ7Cgl9CglpZiAob3B0aW9ucy5kYXlOYW1lcykgewoJCWxvY2FsZURhdGEuX3dlZWtkYXlzID0gb3B0aW9ucy5kYXlOYW1lczsKCX0KCWlmIChvcHRpb25zLmRheU5hbWVzU2hvcnQpIHsKCQlsb2NhbGVEYXRhLl93ZWVrZGF5c1Nob3J0ID0gb3B0aW9ucy5kYXlOYW1lc1Nob3J0OwoJfQoJaWYgKG9wdGlvbnMuZmlyc3REYXkgIT0gbnVsbCkgewoJCXZhciBfd2VlayA9IGNyZWF0ZU9iamVjdChsb2NhbGVEYXRhLl93ZWVrKTsgLy8gX3dlZWs6IHsgZG93OiAjIH0KCQlfd2Vlay5kb3cgPSBvcHRpb25zLmZpcnN0RGF5OwoJCWxvY2FsZURhdGEuX3dlZWsgPSBfd2VlazsKCX0KCgoKCS8vIENhbGVuZGFyLXNwZWNpZmljIERhdGUgVXRpbGl0aWVzCgkvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKCgl0LmRlZmF1bHRBbGxEYXlFdmVudER1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKG9wdGlvbnMuZGVmYXVsdEFsbERheUV2ZW50RHVyYXRpb24pOwoJdC5kZWZhdWx0VGltZWRFdmVudER1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKG9wdGlvbnMuZGVmYXVsdFRpbWVkRXZlbnREdXJhdGlvbik7CgoKCS8vIEJ1aWxkcyBhIG1vbWVudCB1c2luZyB0aGUgc2V0dGluZ3Mgb2YgdGhlIGN1cnJlbnQgY2FsZW5kYXI6IHRpbWV6b25lIGFuZCBsYW5ndWFnZS4KCS8vIEFjY2VwdHMgYW55dGhpbmcgdGhlIHZhbmlsbGEgbW9tZW50KCkgY29uc3RydWN0b3IgYWNjZXB0cy4KCXQubW9tZW50ID0gZnVuY3Rpb24oKSB7CgkJdmFyIG1vbTsKCgkJaWYgKG9wdGlvbnMudGltZXpvbmUgPT09ICdsb2NhbCcpIHsKCQkJbW9tID0gZmMubW9tZW50LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CgoJCQkvLyBGb3JjZSB0aGUgbW9tZW50IHRvIGJlIGxvY2FsLCBiZWNhdXNlIGZjLm1vbWVudCBkb2Vzbid0IGd1YXJhbnRlZSBpdC4KCQkJaWYgKG1vbS5oYXNUaW1lKCkpIHsgLy8gZG9uJ3QgZ2l2ZSBhbWJpZ3VvdXNseS10aW1lZCBtb21lbnRzIGEgbG9jYWwgem9uZQoJCQkJbW9tLmxvY2FsKCk7CgkJCX0KCQl9CgkJZWxzZSBpZiAob3B0aW9ucy50aW1lem9uZSA9PT0gJ1VUQycpIHsKCQkJbW9tID0gZmMubW9tZW50LnV0Yy5hcHBseShudWxsLCBhcmd1bWVudHMpOyAvLyBwcm9jZXNzIGFzIFVUQwoJCX0KCQllbHNlIHsKCQkJbW9tID0gZmMubW9tZW50LnBhcnNlWm9uZS5hcHBseShudWxsLCBhcmd1bWVudHMpOyAvLyBsZXQgdGhlIGlucHV0IGRlY2lkZSB0aGUgem9uZQoJCX0KCgkJaWYgKCdfbG9jYWxlJyBpbiBtb20pIHsgLy8gbW9tZW50IDIuOCBhbmQgYWJvdmUKCQkJbW9tLl9sb2NhbGUgPSBsb2NhbGVEYXRhOwoJCX0KCQllbHNlIHsgLy8gcHJlLW1vbWVudC0yLjgKCQkJbW9tLl9sYW5nID0gbG9jYWxlRGF0YTsKCQl9CgoJCXJldHVybiBtb207Cgl9OwoKCgkvLyBSZXR1cm5zIGEgYm9vbGVhbiBhYm91dCB3aGV0aGVyIG9yIG5vdCB0aGUgY2FsZW5kYXIga25vd3MgaG93IHRvIGNhbGN1bGF0ZQoJLy8gdGhlIHRpbWV6b25lIG9mZnNldCBvZiBhcmJpdHJhcnkgZGF0ZXMgaW4gdGhlIGN1cnJlbnQgdGltZXpvbmUuCgl0LmdldElzQW1iaWdUaW1lem9uZSA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiBvcHRpb25zLnRpbWV6b25lICE9PSAnbG9jYWwnICYmIG9wdGlvbnMudGltZXpvbmUgIT09ICdVVEMnOwoJfTsKCgoJLy8gUmV0dXJucyBhIGNvcHkgb2YgdGhlIGdpdmVuIGRhdGUgaW4gdGhlIGN1cnJlbnQgdGltZXpvbmUgb2YgaXQgaXMgYW1iaWd1b3VzbHkgem9uZWQuCgkvLyBUaGlzIHdpbGwgYWxzbyBnaXZlIHRoZSBkYXRlIGFuIHVuYW1iaWd1b3VzIHRpbWUuCgl0LnJlem9uZURhdGUgPSBmdW5jdGlvbihkYXRlKSB7CgkJcmV0dXJuIHQubW9tZW50KGRhdGUudG9BcnJheSgpKTsKCX07CgoKCS8vIFJldHVybnMgYSBtb21lbnQgZm9yIHRoZSBjdXJyZW50IGRhdGUsIGFzIGRlZmluZWQgYnkgdGhlIGNsaWVudCdzIGNvbXB1dGVyLAoJLy8gb3Igb3ZlcnJpZGRlbiBieSB0aGUgYG5vd2Agb3B0aW9uLgoJdC5nZXROb3cgPSBmdW5jdGlvbigpIHsKCQl2YXIgbm93ID0gb3B0aW9ucy5ub3c7CgkJaWYgKHR5cGVvZiBub3cgPT09ICdmdW5jdGlvbicpIHsKCQkJbm93ID0gbm93KCk7CgkJfQoJCXJldHVybiB0Lm1vbWVudChub3cpOwoJfTsKCgoJLy8gQ2FsY3VsYXRlcyB0aGUgd2VlayBudW1iZXIgZm9yIGEgbW9tZW50IGFjY29yZGluZyB0byB0aGUgY2FsZW5kYXIncwoJLy8gYHdlZWtOdW1iZXJDYWxjdWxhdGlvbmAgc2V0dGluZy4KCXQuY2FsY3VsYXRlV2Vla051bWJlciA9IGZ1bmN0aW9uKG1vbSkgewoJCXZhciBjYWxjID0gb3B0aW9ucy53ZWVrTnVtYmVyQ2FsY3VsYXRpb247CgoJCWlmICh0eXBlb2YgY2FsYyA9PT0gJ2Z1bmN0aW9uJykgewoJCQlyZXR1cm4gY2FsYyhtb20pOwoJCX0KCQllbHNlIGlmIChjYWxjID09PSAnbG9jYWwnKSB7CgkJCXJldHVybiBtb20ud2VlaygpOwoJCX0KCQllbHNlIGlmIChjYWxjLnRvVXBwZXJDYXNlKCkgPT09ICdJU08nKSB7CgkJCXJldHVybiBtb20uaXNvV2VlaygpOwoJCX0KCX07CgoKCS8vIEdldCBhbiBldmVudCdzIG5vcm1hbGl6ZWQgZW5kIGRhdGUuIElmIG5vdCBwcmVzZW50LCBjYWxjdWxhdGUgaXQgZnJvbSB0aGUgZGVmYXVsdHMuCgl0LmdldEV2ZW50RW5kID0gZnVuY3Rpb24oZXZlbnQpIHsKCQlpZiAoZXZlbnQuZW5kKSB7CgkJCXJldHVybiBldmVudC5lbmQuY2xvbmUoKTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiB0LmdldERlZmF1bHRFdmVudEVuZChldmVudC5hbGxEYXksIGV2ZW50LnN0YXJ0KTsKCQl9Cgl9OwoKCgkvLyBHaXZlbiBhbiBldmVudCdzIGFsbERheSBzdGF0dXMgYW5kIHN0YXJ0IGRhdGUsIHJldHVybiBzd2hhdCBpdHMgZmFsbGJhY2sgZW5kIGRhdGUgc2hvdWxkIGJlLgoJdC5nZXREZWZhdWx0RXZlbnRFbmQgPSBmdW5jdGlvbihhbGxEYXksIHN0YXJ0KSB7IC8vIFRPRE86IHJlbmFtZSB0byBjb21wdXRlRGVmYXVsdEV2ZW50RW5kCgkJdmFyIGVuZCA9IHN0YXJ0LmNsb25lKCk7CgoJCWlmIChhbGxEYXkpIHsKCQkJZW5kLnN0cmlwVGltZSgpLmFkZCh0LmRlZmF1bHRBbGxEYXlFdmVudER1cmF0aW9uKTsKCQl9CgkJZWxzZSB7CgkJCWVuZC5hZGQodC5kZWZhdWx0VGltZWRFdmVudER1cmF0aW9uKTsKCQl9CgoJCWlmICh0LmdldElzQW1iaWdUaW1lem9uZSgpKSB7CgkJCWVuZC5zdHJpcFpvbmUoKTsgLy8gd2UgZG9uJ3Qga25vdyB3aGF0IHRoZSB0em8gc2hvdWxkIGJlCgkJfQoKCQlyZXR1cm4gZW5kOwoJfTsKCgoJLy8gUHJvZHVjZXMgYSBodW1hbi1yZWFkYWJsZSBzdHJpbmcgZm9yIHRoZSBnaXZlbiBkdXJhdGlvbi4KCS8vIFNpZGUtZWZmZWN0OiBjaGFuZ2VzIHRoZSBsb2NhbGUgb2YgdGhlIGdpdmVuIGR1cmF0aW9uLgoJZnVuY3Rpb24gaHVtYW5pemVEdXJhdGlvbihkdXJhdGlvbikgewoJCXJldHVybiAoZHVyYXRpb24ubG9jYWxlIHx8IGR1cmF0aW9uLmxhbmcpLmNhbGwoZHVyYXRpb24sIG9wdGlvbnMubGFuZykgLy8gd29ya3MgbW9tZW50LXByZS0yLjgKCQkJLmh1bWFuaXplKCk7Cgl9CgoKCQoJLy8gSW1wb3J0cwoJLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCgoJRXZlbnRNYW5hZ2VyLmNhbGwodCwgb3B0aW9ucyk7Cgl2YXIgaXNGZXRjaE5lZWRlZCA9IHQuaXNGZXRjaE5lZWRlZDsKCXZhciBmZXRjaEV2ZW50cyA9IHQuZmV0Y2hFdmVudHM7CgoKCgkvLyBMb2NhbHMKCS8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoKCXZhciBfZWxlbWVudCA9IGVsZW1lbnRbMF07Cgl2YXIgaGVhZGVyOwoJdmFyIGhlYWRlckVsZW1lbnQ7Cgl2YXIgY29udGVudDsKCXZhciB0bTsgLy8gZm9yIG1ha2luZyB0aGVtZSBjbGFzc2VzCgl2YXIgdmlld1NwZWNDYWNoZSA9IHt9OwoJdmFyIGN1cnJlbnRWaWV3OwoJdmFyIHN1Z2dlc3RlZFZpZXdIZWlnaHQ7Cgl2YXIgd2luZG93UmVzaXplUHJveHk7IC8vIHdyYXBzIHRoZSB3aW5kb3dSZXNpemUgZnVuY3Rpb24KCXZhciBpZ25vcmVXaW5kb3dSZXNpemUgPSAwOwoJdmFyIGRhdGU7Cgl2YXIgZXZlbnRzID0gW107CgkKCQoJCgkvLyBNYWluIFJlbmRlcmluZwoJLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCgoJaWYgKG9wdGlvbnMuZGVmYXVsdERhdGUgIT0gbnVsbCkgewoJCWRhdGUgPSB0Lm1vbWVudChvcHRpb25zLmRlZmF1bHREYXRlKTsKCX0KCWVsc2UgewoJCWRhdGUgPSB0LmdldE5vdygpOwoJfQoJCgkKCWZ1bmN0aW9uIHJlbmRlcihpbmMpIHsKCQlpZiAoIWNvbnRlbnQpIHsKCQkJaW5pdGlhbFJlbmRlcigpOwoJCX0KCQllbHNlIGlmIChlbGVtZW50VmlzaWJsZSgpKSB7CgkJCS8vIG1haW5seSBmb3IgdGhlIHB1YmxpYyBBUEkKCQkJY2FsY1NpemUoKTsKCQkJcmVuZGVyVmlldyhpbmMpOwoJCX0KCX0KCQoJCglmdW5jdGlvbiBpbml0aWFsUmVuZGVyKCkgewoJCXRtID0gb3B0aW9ucy50aGVtZSA\/ICd1aScgOiAnZmMnOwoJCWVsZW1lbnQuYWRkQ2xhc3MoJ2ZjJyk7CgoJCWlmIChvcHRpb25zLmlzUlRMKSB7CgkJCWVsZW1lbnQuYWRkQ2xhc3MoJ2ZjLXJ0bCcpOwoJCX0KCQllbHNlIHsKCQkJZWxlbWVudC5hZGRDbGFzcygnZmMtbHRyJyk7CgkJfQoKCQlpZiAob3B0aW9ucy50aGVtZSkgewoJCQllbGVtZW50LmFkZENsYXNzKCd1aS13aWRnZXQnKTsKCQl9CgkJZWxzZSB7CgkJCWVsZW1lbnQuYWRkQ2xhc3MoJ2ZjLXVudGhlbWVkJyk7CgkJfQoKCQljb250ZW50ID0gJCgiPGRpdiBjbGFzcz0nZmMtdmlldy1jb250YWluZXInLz4iKS5wcmVwZW5kVG8oZWxlbWVudCk7CgoJCWhlYWRlciA9IG5ldyBIZWFkZXIodCwgb3B0aW9ucyk7CgkJaGVhZGVyRWxlbWVudCA9IGhlYWRlci5yZW5kZXIoKTsKCQlpZiAoaGVhZGVyRWxlbWVudCkgewoJCQllbGVtZW50LnByZXBlbmQoaGVhZGVyRWxlbWVudCk7CgkJfQoKCQlyZW5kZXJWaWV3KG9wdGlvbnMuZGVmYXVsdFZpZXcpOwoKCQlpZiAob3B0aW9ucy5oYW5kbGVXaW5kb3dSZXNpemUpIHsKCQkJd2luZG93UmVzaXplUHJveHkgPSBkZWJvdW5jZSh3aW5kb3dSZXNpemUsIG9wdGlvbnMud2luZG93UmVzaXplRGVsYXkpOyAvLyBwcmV2ZW50cyByYXBpZCBjYWxscwoJCQkkKHdpbmRvdykucmVzaXplKHdpbmRvd1Jlc2l6ZVByb3h5KTsKCQl9Cgl9CgkKCQoJZnVuY3Rpb24gZGVzdHJveSgpIHsKCgkJaWYgKGN1cnJlbnRWaWV3KSB7CgkJCWN1cnJlbnRWaWV3LmRlc3Ryb3lWaWV3KCk7CgkJfQoKCQloZWFkZXIuZGVzdHJveSgpOwoJCWNvbnRlbnQucmVtb3ZlKCk7CgkJZWxlbWVudC5yZW1vdmVDbGFzcygnZmMgZmMtbHRyIGZjLXJ0bCBmYy11bnRoZW1lZCB1aS13aWRnZXQnKTsKCgkJJCh3aW5kb3cpLnVuYmluZCgncmVzaXplJywgd2luZG93UmVzaXplUHJveHkpOwoJfQoJCgkKCWZ1bmN0aW9uIGVsZW1lbnRWaXNpYmxlKCkgewoJCXJldHVybiBlbGVtZW50LmlzKCc6dmlzaWJsZScpOwoJfQoJCgkKCgkvLyBWaWV3IFJlbmRlcmluZwoJLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCgoJLy8gUmVuZGVycyBhIHZpZXcgYmVjYXVzZSBvZiBhIGRhdGUgY2hhbmdlLCB2aWV3LXR5cGUgY2hhbmdlLCBvciBmb3IgdGhlIGZpcnN0IHRpbWUKCWZ1bmN0aW9uIHJlbmRlclZpZXcodmlld1R5cGUpIHsKCQlpZ25vcmVXaW5kb3dSZXNpemUrKzsKCgkJLy8gaWYgdmlld1R5cGUgaXMgY2hhbmdpbmcsIGRlc3Ryb3kgdGhlIG9sZCB2aWV3CgkJaWYgKGN1cnJlbnRWaWV3ICYmIHZpZXdUeXBlICYmIGN1cnJlbnRWaWV3LnR5cGUgIT09IHZpZXdUeXBlKSB7CgkJCWhlYWRlci5kZWFjdGl2YXRlQnV0dG9uKGN1cnJlbnRWaWV3LnR5cGUpOwoJCQlmcmVlemVDb250ZW50SGVpZ2h0KCk7IC8vIHByZXZlbnQgYSBzY3JvbGwganVtcCB3aGVuIHZpZXcgZWxlbWVudCBpcyByZW1vdmVkCgkJCWlmIChjdXJyZW50Vmlldy5zdGFydCkgeyAvLyByZW5kZXJlZCBiZWZvcmU\/CgkJCQljdXJyZW50Vmlldy5kZXN0cm95VmlldygpOwoJCQl9CgkJCWN1cnJlbnRWaWV3LmVsLnJlbW92ZSgpOwoJCQljdXJyZW50VmlldyA9IG51bGw7CgkJfQoKCQkvLyBpZiB2aWV3VHlwZSBjaGFuZ2VkLCBvciB0aGUgdmlldyB3YXMgbmV2ZXIgY3JlYXRlZCwgY3JlYXRlIGEgZnJlc2ggdmlldwoJCWlmICghY3VycmVudFZpZXcgJiYgdmlld1R5cGUpIHsKCQkJY3VycmVudFZpZXcgPSBpbnN0YW50aWF0ZVZpZXcodmlld1R5cGUpOwoJCQljdXJyZW50Vmlldy5lbCA9ICAkKCI8ZGl2IGNsYXNzPSdmYy12aWV3IGZjLSIgKyB2aWV3VHlwZSArICItdmlldycgLz4iKS5hcHBlbmRUbyhjb250ZW50KTsKCQkJaGVhZGVyLmFjdGl2YXRlQnV0dG9uKHZpZXdUeXBlKTsKCQl9CgoJCWlmIChjdXJyZW50VmlldykgewoKCQkJLy8gaW4gY2FzZSB0aGUgdmlldyBzaG91bGQgcmVuZGVyIGEgcGVyaW9kIG9mIHRpbWUgdGhhdCBpcyBjb21wbGV0ZWx5IGhpZGRlbgoJCQlkYXRlID0gY3VycmVudFZpZXcubWFzc2FnZUN1cnJlbnREYXRlKGRhdGUpOwoKCQkJLy8gcmVuZGVyIG9yIHJlcmVuZGVyIHRoZSB2aWV3CgkJCWlmICgKCQkJCSFjdXJyZW50Vmlldy5zdGFydCB8fCAvLyBuZXZlciByZW5kZXJlZCBiZWZvcmUKCQkJCSFkYXRlLmlzV2l0aGluKGN1cnJlbnRWaWV3LmludGVydmFsU3RhcnQsIGN1cnJlbnRWaWV3LmludGVydmFsRW5kKSAvLyBpbXBsaWNpdCBkYXRlIHdpbmRvdyBjaGFuZ2UKCQkJKSB7CgkJCQlpZiAoZWxlbWVudFZpc2libGUoKSkgewoKCQkJCQlmcmVlemVDb250ZW50SGVpZ2h0KCk7CgkJCQkJaWYgKGN1cnJlbnRWaWV3LnN0YXJ0KSB7IC8vIHJlbmRlcmVkIGJlZm9yZT8KCQkJCQkJY3VycmVudFZpZXcuZGVzdHJveVZpZXcoKTsKCQkJCQl9CgkJCQkJY3VycmVudFZpZXcuc2V0RGF0ZShkYXRlKTsKCQkJCQljdXJyZW50Vmlldy5yZW5kZXJWaWV3KCk7CgkJCQkJdW5mcmVlemVDb250ZW50SGVpZ2h0KCk7CgoJCQkJCS8vIG5lZWQgdG8gZG8gdGhpcyBhZnRlciBWaWV3OjpyZW5kZXIsIHNvIGRhdGVzIGFyZSBjYWxjdWxhdGVkCgkJCQkJdXBkYXRlVGl0bGUoKTsKCQkJCQl1cGRhdGVUb2RheUJ1dHRvbigpOwoKCQkJCQlnZXRBbmRSZW5kZXJFdmVudHMoKTsKCQkJCX0KCQkJfQoJCX0KCgkJdW5mcmVlemVDb250ZW50SGVpZ2h0KCk7IC8vIHVuZG8gYW55IGxvbmUgZnJlZXplQ29udGVudEhlaWdodCBjYWxscwoJCWlnbm9yZVdpbmRvd1Jlc2l6ZS0tOwoJfQoKCgoJLy8gVmlldyBJbnN0YW50aWF0aW9uCgkvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKCgkvLyBHaXZlbiBhIHZpZXcgbmFtZSBmb3IgYSBjdXN0b20gdmlldyBvciBhIHN0YW5kYXJkIHZpZXcsIGNyZWF0ZXMgYSByZWFkeS10by1nbyBWaWV3IG9iamVjdAoJZnVuY3Rpb24gaW5zdGFudGlhdGVWaWV3KHZpZXdUeXBlKSB7CgkJdmFyIHNwZWMgPSBnZXRWaWV3U3BlYyh2aWV3VHlwZSk7CgoJCXJldHVybiBuZXcgc3BlY1snY2xhc3MnXSh0LCBzcGVjLm9wdGlvbnMsIHZpZXdUeXBlKTsKCX0KCgoJLy8gR2V0cyBpbmZvcm1hdGlvbiBhYm91dCBob3cgdG8gY3JlYXRlIGEgdmlldwoJZnVuY3Rpb24gZ2V0Vmlld1NwZWMocmVxdWVzdGVkVmlld1R5cGUpIHsKCQl2YXIgYWxsRGVmYXVsdEJ1dHRvblRleHQgPSBvcHRpb25zLmRlZmF1bHRCdXR0b25UZXh0IHx8IHt9OwoJCXZhciBhbGxCdXR0b25UZXh0ID0gb3B0aW9ucy5idXR0b25UZXh0IHx8IHt9OwoJCXZhciBoYXNoID0gb3B0aW9ucy52aWV3cyB8fCB7fTsgLy8gdGhlIGB2aWV3c2Agb3B0aW9uIG9iamVjdAoJCXZhciB2aWV3VHlwZSA9IHJlcXVlc3RlZFZpZXdUeXBlOwoJCXZhciB2aWV3T3B0aW9uc0NoYWluID0gW107CgkJdmFyIHZpZXdPcHRpb25zOwoJCXZhciB2aWV3Q2xhc3M7CgkJdmFyIGR1cmF0aW9uLCB1bml0LCB1bml0SXNTaW5nbGUgPSBmYWxzZTsKCQl2YXIgYnV0dG9uVGV4dDsKCgkJaWYgKHZpZXdTcGVjQ2FjaGVbcmVxdWVzdGVkVmlld1R5cGVdKSB7CgkJCXJldHVybiB2aWV3U3BlY0NhY2hlW3JlcXVlc3RlZFZpZXdUeXBlXTsKCQl9CgoJCWZ1bmN0aW9uIHByb2Nlc3NTcGVjSW5wdXQoaW5wdXQpIHsKCQkJaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJdmlld0NsYXNzID0gaW5wdXQ7CgkJCX0KCQkJZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAnb2JqZWN0JykgewoJCQkJJC5leHRlbmQodmlld09wdGlvbnMsIGlucHV0KTsKCQkJfQoJCX0KCgkJLy8gaXRlcmF0ZSB1cCBhIHZpZXcncyBzcGVjIGFuY2VzdG9yIGNoYWluIHV0aWwgd2UgZmluZCBhIGNsYXNzIHRvIGluc3RhbnRpYXRlCgkJd2hpbGUgKHZpZXdUeXBlICYmICF2aWV3Q2xhc3MpIHsKCQkJdmlld09wdGlvbnMgPSB7fTsgLy8gb25seSBmb3IgdGhpcyBzcGVjaWZpYyB2aWV3IGluIHRoZSBhbmNlc3RyeQoJCQlwcm9jZXNzU3BlY0lucHV0KGZjVmlld3Nbdmlld1R5cGVdKTsgLy8gJC5mdWxsQ2FsZW5kYXIudmlld3MsIGxvd2VyIHByZWNlZGVuY2UKCQkJcHJvY2Vzc1NwZWNJbnB1dChoYXNoW3ZpZXdUeXBlXSk7IC8vIG9wdGlvbnMgYXQgaW5pdGlhbGl6YXRpb24sIGhpZ2hlciBwcmVjZWRlbmNlCgkJCXZpZXdPcHRpb25zQ2hhaW4udW5zaGlmdCh2aWV3T3B0aW9ucyk7IC8vIHJlY29yZCBvbGRlciBhbmNlc3RvcnMgZmlyc3QKCQkJdmlld1R5cGUgPSB2aWV3T3B0aW9ucy50eXBlOwoJCX0KCgkJdmlld09wdGlvbnNDaGFpbi51bnNoaWZ0KHt9KTsgLy8galF1ZXJ5J3MgZXh0ZW5kIG5lZWRzIGF0IGxlYXN0IG9uZSBhcmcKCQl2aWV3T3B0aW9ucyA9ICQuZXh0ZW5kLmFwcGx5KCQsIHZpZXdPcHRpb25zQ2hhaW4pOyAvLyBjb21iaW5lIGFsbCwgbmV3ZXIgYW5jZXN0b3JzIG92ZXJ3cml0dGluZyBvbGQKCgkJaWYgKHZpZXdDbGFzcykgewoKCQkJZHVyYXRpb24gPSB2aWV3T3B0aW9ucy5kdXJhdGlvbiB8fCB2aWV3Q2xhc3MuZHVyYXRpb247CgkJCWlmIChkdXJhdGlvbikgewoJCQkJZHVyYXRpb24gPSBtb21lbnQuZHVyYXRpb24oZHVyYXRpb24pOwoJCQkJdW5pdCA9IGNvbXB1dGVJbnRlcnZhbFVuaXQoZHVyYXRpb24pOwoJCQkJdW5pdElzU2luZ2xlID0gY29tcHV0ZUludGVydmFsQXModW5pdCwgZHVyYXRpb24pID09PSAxOwoJCQl9CgoJCQkvLyBvcHRpb25zIHRoYXQgYXJlIHNwZWNpZmllZCBwZXIgdGhlIHZpZXcncyBkdXJhdGlvbiwgbGlrZSAid2VlayIgb3IgImRheSIKCQkJaWYgKHVuaXRJc1NpbmdsZSAmJiBoYXNoW3VuaXRdKSB7CgkJCQl2aWV3T3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCBoYXNoW3VuaXRdLCB2aWV3T3B0aW9ucyk7IC8vIGxvd2VzdCBwcmlvcml0eQoJCQl9CgoJCQkvLyBjb21wdXRlIHRoZSBmaW5hbCB0ZXh0IGZvciB0aGUgYnV0dG9uIHJlcHJlc2VudGluZyB0aGlzIHZpZXcKCQkJYnV0dG9uVGV4dCA9CgkJCQlhbGxCdXR0b25UZXh0W3JlcXVlc3RlZFZpZXdUeXBlXSB8fCAvLyBpbml0IG9wdGlvbnMsIGxpa2UgImFnZW5kYVdlZWsiCgkJCQkodW5pdElzU2luZ2xlID8gYWxsQnV0dG9uVGV4dFt1bml0XSA6IG51bGwpIHx8IC8vIGluaXQgb3B0aW9ucywgbGlrZSAid2VlayIKCQkJCWFsbERlZmF1bHRCdXR0b25UZXh0W3JlcXVlc3RlZFZpZXdUeXBlXSB8fCAvLyBsYW5nIGRhdGEsIGxpa2UgImFnZW5kYVdlZWsiCgkJCQkodW5pdElzU2luZ2xlID8gYWxsRGVmYXVsdEJ1dHRvblRleHRbdW5pdF0gOiBudWxsKSB8fCAvLyBsYW5nIGRhdGEsIGxpa2UgIndlZWsiCgkJCQl2aWV3T3B0aW9ucy5idXR0b25UZXh0IHx8CgkJCQl2aWV3Q2xhc3MuYnV0dG9uVGV4dCB8fAoJCQkJKGR1cmF0aW9uID8gaHVtYW5pemVEdXJhdGlvbihkdXJhdGlvbikgOiBudWxsKSB8fAoJCQkJcmVxdWVzdGVkVmlld1R5cGU7CgoJCQlyZXR1cm4gKHZpZXdTcGVjQ2FjaGVbcmVxdWVzdGVkVmlld1R5cGVdID0gewoJCQkJJ2NsYXNzJzogdmlld0NsYXNzLAoJCQkJb3B0aW9uczogdmlld09wdGlvbnMsCgkJCQlidXR0b25UZXh0OiBidXR0b25UZXh0CgkJCX0pOwoJCX0KCX0KCgoJLy8gUmV0dXJucyBhIGJvb2xlYW4gYWJvdXQgd2hldGhlciB0aGUgdmlldyBpcyBva2F5IHRvIGluc3RhbnRpYXRlIGF0IHNvbWUgcG9pbnQKCWZ1bmN0aW9uIGlzVmFsaWRWaWV3VHlwZSh2aWV3VHlwZSkgewoJCXJldHVybiBCb29sZWFuKGdldFZpZXdTcGVjKHZpZXdUeXBlKSk7Cgl9CgoKCS8vIEdldHMgdGhlIHRleHQgdGhhdCBzaG91bGQgYmUgZGlzcGxheWVkIG9uIGEgdmlldydzIGJ1dHRvbiBpbiB0aGUgaGVhZGVyCglmdW5jdGlvbiBnZXRWaWV3QnV0dG9uVGV4dCh2aWV3VHlwZSkgewoJCXZhciBzcGVjID0gZ2V0Vmlld1NwZWModmlld1R5cGUpOwoKCQlpZiAoc3BlYykgewoJCQlyZXR1cm4gc3BlYy5idXR0b25UZXh0OwoJCX0KCX0KCQoJCgoJLy8gUmVzaXppbmcKCS8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoKCXQuZ2V0U3VnZ2VzdGVkVmlld0hlaWdodCA9IGZ1bmN0aW9uKCkgewoJCWlmIChzdWdnZXN0ZWRWaWV3SGVpZ2h0ID09PSB1bmRlZmluZWQpIHsKCQkJY2FsY1NpemUoKTsKCQl9CgkJcmV0dXJuIHN1Z2dlc3RlZFZpZXdIZWlnaHQ7Cgl9OwoKCgl0LmlzSGVpZ2h0QXV0byA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiBvcHRpb25zLmNvbnRlbnRIZWlnaHQgPT09ICdhdXRvJyB8fCBvcHRpb25zLmhlaWdodCA9PT0gJ2F1dG8nOwoJfTsKCQoJCglmdW5jdGlvbiB1cGRhdGVTaXplKHNob3VsZFJlY2FsYykgewoJCWlmIChlbGVtZW50VmlzaWJsZSgpKSB7CgoJCQlpZiAoc2hvdWxkUmVjYWxjKSB7CgkJCQlfY2FsY1NpemUoKTsKCQkJfQoKCQkJaWdub3JlV2luZG93UmVzaXplKys7CgkJCWN1cnJlbnRWaWV3LnVwZGF0ZVNpemUodHJ1ZSk7IC8vIGlzUmVzaXplPXRydWUuIHdpbGwgcG9sbCBnZXRTdWdnZXN0ZWRWaWV3SGVpZ2h0KCkgYW5kIGlzSGVpZ2h0QXV0bygpCgkJCWlnbm9yZVdpbmRvd1Jlc2l6ZS0tOwoKCQkJcmV0dXJuIHRydWU7IC8vIHNpZ25hbCBzdWNjZXNzCgkJfQoJfQoKCglmdW5jdGlvbiBjYWxjU2l6ZSgpIHsKCQlpZiAoZWxlbWVudFZpc2libGUoKSkgewoJCQlfY2FsY1NpemUoKTsKCQl9Cgl9CgkKCQoJZnVuY3Rpb24gX2NhbGNTaXplKCkgeyAvLyBhc3N1bWVzIGVsZW1lbnRWaXNpYmxlCgkJaWYgKHR5cGVvZiBvcHRpb25zLmNvbnRlbnRIZWlnaHQgPT09ICdudW1iZXInKSB7IC8vIGV4aXN0cyBhbmQgbm90ICdhdXRvJwoJCQlzdWdnZXN0ZWRWaWV3SGVpZ2h0ID0gb3B0aW9ucy5jb250ZW50SGVpZ2h0OwoJCX0KCQllbHNlIGlmICh0eXBlb2Ygb3B0aW9ucy5oZWlnaHQgPT09ICdudW1iZXInKSB7IC8vIGV4aXN0cyBhbmQgbm90ICdhdXRvJwoJCQlzdWdnZXN0ZWRWaWV3SGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgLSAoaGVhZGVyRWxlbWVudCA\/IGhlYWRlckVsZW1lbnQub3V0ZXJIZWlnaHQodHJ1ZSkgOiAwKTsKCQl9CgkJZWxzZSB7CgkJCXN1Z2dlc3RlZFZpZXdIZWlnaHQgPSBNYXRoLnJvdW5kKGNvbnRlbnQud2lkdGgoKSAvIE1hdGgubWF4KG9wdGlvbnMuYXNwZWN0UmF0aW8sIC41KSk7CgkJfQoJfQoJCgkKCWZ1bmN0aW9uIHdpbmRvd1Jlc2l6ZShldikgewoJCWlmICgKCQkJIWlnbm9yZVdpbmRvd1Jlc2l6ZSAmJgoJCQlldi50YXJnZXQgPT09IHdpbmRvdyAmJiAvLyBzbyB3ZSBkb24ndCBwcm9jZXNzIGpxdWkgInJlc2l6ZSIgZXZlbnRzIHRoYXQgaGF2ZSBidWJibGVkIHVwCgkJCWN1cnJlbnRWaWV3LnN0YXJ0IC8vIHZpZXcgaGFzIGFscmVhZHkgYmVlbiByZW5kZXJlZAoJCSkgewoJCQlpZiAodXBkYXRlU2l6ZSh0cnVlKSkgewoJCQkJY3VycmVudFZpZXcudHJpZ2dlcignd2luZG93UmVzaXplJywgX2VsZW1lbnQpOwoJCQl9CgkJfQoJfQoJCgkKCQoJLyogRXZlbnQgRmV0Y2hpbmcvUmVuZGVyaW5nCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgkvLyBUT0RPOiBnb2luZyBmb3J3YXJkLCBtb3N0IG9mIHRoaXMgc3R1ZmYgc2hvdWxkIGJlIGRpcmVjdGx5IGhhbmRsZWQgYnkgdGhlIHZpZXcKCgoJZnVuY3Rpb24gcmVmZXRjaEV2ZW50cygpIHsgLy8gY2FuIGJlIGNhbGxlZCBhcyBhbiBBUEkgbWV0aG9kCgkJZGVzdHJveUV2ZW50cygpOyAvLyBzbyB0aGF0IGV2ZW50cyBhcmUgY2xlYXJlZCBiZWZvcmUgdXNlciBzdGFydHMgd2FpdGluZyBmb3IgQUpBWAoJCWZldGNoQW5kUmVuZGVyRXZlbnRzKCk7Cgl9CgoKCWZ1bmN0aW9uIHJlbmRlckV2ZW50cygpIHsgLy8gZGVzdHJveXMgb2xkIGV2ZW50cyBpZiBwcmV2aW91c2x5IHJlbmRlcmVkCgkJaWYgKGVsZW1lbnRWaXNpYmxlKCkpIHsKCQkJZnJlZXplQ29udGVudEhlaWdodCgpOwoJCQljdXJyZW50Vmlldy5kZXN0cm95Vmlld0V2ZW50cygpOyAvLyBubyBwZXJmb3JtYW5jZSBjb3N0IGlmIG5ldmVyIHJlbmRlcmVkCgkJCWN1cnJlbnRWaWV3LnJlbmRlclZpZXdFdmVudHMoZXZlbnRzKTsKCQkJdW5mcmVlemVDb250ZW50SGVpZ2h0KCk7CgkJfQoJfQoKCglmdW5jdGlvbiBkZXN0cm95RXZlbnRzKCkgewoJCWZyZWV6ZUNvbnRlbnRIZWlnaHQoKTsKCQljdXJyZW50Vmlldy5kZXN0cm95Vmlld0V2ZW50cygpOwoJCXVuZnJlZXplQ29udGVudEhlaWdodCgpOwoJfQoJCgoJZnVuY3Rpb24gZ2V0QW5kUmVuZGVyRXZlbnRzKCkgewoJCWlmICghb3B0aW9ucy5sYXp5RmV0Y2hpbmcgfHwgaXNGZXRjaE5lZWRlZChjdXJyZW50Vmlldy5zdGFydCwgY3VycmVudFZpZXcuZW5kKSkgewoJCQlmZXRjaEFuZFJlbmRlckV2ZW50cygpOwoJCX0KCQllbHNlIHsKCQkJcmVuZGVyRXZlbnRzKCk7CgkJfQoJfQoKCglmdW5jdGlvbiBmZXRjaEFuZFJlbmRlckV2ZW50cygpIHsKCQlmZXRjaEV2ZW50cyhjdXJyZW50Vmlldy5zdGFydCwgY3VycmVudFZpZXcuZW5kKTsKCQkJLy8gLi4uIHdpbGwgY2FsbCByZXBvcnRFdmVudHMKCQkJLy8gLi4uIHdoaWNoIHdpbGwgY2FsbCByZW5kZXJFdmVudHMKCX0KCgkKCS8vIGNhbGxlZCB3aGVuIGV2ZW50IGRhdGEgYXJyaXZlcwoJZnVuY3Rpb24gcmVwb3J0RXZlbnRzKF9ldmVudHMpIHsKCQlldmVudHMgPSBfZXZlbnRzOwoJCXJlbmRlckV2ZW50cygpOwoJfQoKCgkvLyBjYWxsZWQgd2hlbiBhIHNpbmdsZSBldmVudCdzIGRhdGEgaGFzIGJlZW4gY2hhbmdlZAoJZnVuY3Rpb24gcmVwb3J0RXZlbnRDaGFuZ2UoKSB7CgkJcmVuZGVyRXZlbnRzKCk7Cgl9CgoKCgkvKiBIZWFkZXIgVXBkYXRpbmcKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJZnVuY3Rpb24gdXBkYXRlVGl0bGUoKSB7CgkJY3VycmVudFZpZXcudXBkYXRlVGl0bGUoKTsKCQloZWFkZXIudXBkYXRlVGl0bGUoY3VycmVudFZpZXcudGl0bGUpOwoJfQoKCglmdW5jdGlvbiB1cGRhdGVUb2RheUJ1dHRvbigpIHsKCQl2YXIgbm93ID0gdC5nZXROb3coKTsKCQlpZiAobm93LmlzV2l0aGluKGN1cnJlbnRWaWV3LmludGVydmFsU3RhcnQsIGN1cnJlbnRWaWV3LmludGVydmFsRW5kKSkgewoJCQloZWFkZXIuZGlzYWJsZUJ1dHRvbigndG9kYXknKTsKCQl9CgkJZWxzZSB7CgkJCWhlYWRlci5lbmFibGVCdXR0b24oJ3RvZGF5Jyk7CgkJfQoJfQoJCgoKCS8qIFNlbGVjdGlvbgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoJCgoJZnVuY3Rpb24gc2VsZWN0KHN0YXJ0LCBlbmQpIHsKCgkJc3RhcnQgPSB0Lm1vbWVudChzdGFydCk7CgkJaWYgKGVuZCkgewoJCQllbmQgPSB0Lm1vbWVudChlbmQpOwoJCX0KCQllbHNlIGlmIChzdGFydC5oYXNUaW1lKCkpIHsKCQkJZW5kID0gc3RhcnQuY2xvbmUoKS5hZGQodC5kZWZhdWx0VGltZWRFdmVudER1cmF0aW9uKTsKCQl9CgkJZWxzZSB7CgkJCWVuZCA9IHN0YXJ0LmNsb25lKCkuYWRkKHQuZGVmYXVsdEFsbERheUV2ZW50RHVyYXRpb24pOwoJCX0KCgkJY3VycmVudFZpZXcuc2VsZWN0KHsgc3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZCB9KTsgLy8gYWNjZXB0cyBhIHJhbmdlCgl9CgkKCglmdW5jdGlvbiB1bnNlbGVjdCgpIHsgLy8gc2FmZSB0byBiZSBjYWxsZWQgYmVmb3JlIHJlbmRlclZpZXcKCQlpZiAoY3VycmVudFZpZXcpIHsKCQkJY3VycmVudFZpZXcudW5zZWxlY3QoKTsKCQl9Cgl9CgkKCQoJCgkvKiBEYXRlCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgkKCQoJZnVuY3Rpb24gcHJldigpIHsKCQlkYXRlID0gY3VycmVudFZpZXcuY29tcHV0ZVByZXZEYXRlKGRhdGUpOwoJCXJlbmRlclZpZXcoKTsKCX0KCQoJCglmdW5jdGlvbiBuZXh0KCkgewoJCWRhdGUgPSBjdXJyZW50Vmlldy5jb21wdXRlTmV4dERhdGUoZGF0ZSk7CgkJcmVuZGVyVmlldygpOwoJfQoJCgkKCWZ1bmN0aW9uIHByZXZZZWFyKCkgewoJCWRhdGUuYWRkKC0xLCAneWVhcnMnKTsKCQlyZW5kZXJWaWV3KCk7Cgl9CgkKCQoJZnVuY3Rpb24gbmV4dFllYXIoKSB7CgkJZGF0ZS5hZGQoMSwgJ3llYXJzJyk7CgkJcmVuZGVyVmlldygpOwoJfQoJCgkKCWZ1bmN0aW9uIHRvZGF5KCkgewoJCWRhdGUgPSB0LmdldE5vdygpOwoJCXJlbmRlclZpZXcoKTsKCX0KCQoJCglmdW5jdGlvbiBnb3RvRGF0ZShkYXRlSW5wdXQpIHsKCQlkYXRlID0gdC5tb21lbnQoZGF0ZUlucHV0KTsKCQlyZW5kZXJWaWV3KCk7Cgl9CgkKCQoJZnVuY3Rpb24gaW5jcmVtZW50RGF0ZShkZWx0YSkgewoJCWRhdGUuYWRkKG1vbWVudC5kdXJhdGlvbihkZWx0YSkpOwoJCXJlbmRlclZpZXcoKTsKCX0KCgoJLy8gRm9yY2VzIG5hdmlnYXRpb24gdG8gYSB2aWV3IGZvciB0aGUgZ2l2ZW4gZGF0ZS4KCS8vIGB2aWV3VHlwZWAgY2FuIGJlIGEgc3BlY2lmaWMgdmlldyBuYW1lIG9yIGEgZ2VuZXJpYyBvbmUgbGlrZSAid2VlayIgb3IgImRheSIuCglmdW5jdGlvbiB6b29tVG8obmV3RGF0ZSwgdmlld1R5cGUpIHsKCQl2YXIgdmlld1N0cjsKCQl2YXIgbWF0Y2g7CgoJCWlmICghdmlld1R5cGUgfHwgIWlzVmFsaWRWaWV3VHlwZSh2aWV3VHlwZSkpIHsgLy8gYSBnZW5lcmFsIHZpZXcgbmFtZSwgb3IgImF1dG8iCgkJCXZpZXdUeXBlID0gdmlld1R5cGUgfHwgJ2RheSc7CgkJCXZpZXdTdHIgPSBoZWFkZXIuZ2V0Vmlld3NXaXRoQnV0dG9ucygpLmpvaW4oJyAnKTsgLy8gc3BhY2Utc2VwYXJhdGVkIHN0cmluZyBvZiBhbGwgdGhlIHZpZXdzIGluIHRoZSBoZWFkZXIKCgkJCS8vIHRyeSB0byBtYXRjaCBhIGdlbmVyYWwgdmlldyBuYW1lLCBsaWtlICJ3ZWVrIiwgYWdhaW5zdCBhIHNwZWNpZmljIG9uZSwgbGlrZSAiYWdlbmRhV2VlayIKCQkJbWF0Y2ggPSB2aWV3U3RyLm1hdGNoKG5ldyBSZWdFeHAoJ1xcdysnICsgY2FwaXRhbGlzZUZpcnN0TGV0dGVyKHZpZXdUeXBlKSkpOwoKCQkJLy8gZmFsbCBiYWNrIHRvIHRoZSBkYXkgdmlldyBiZWluZyB1c2VkIGluIHRoZSBoZWFkZXIKCQkJaWYgKCFtYXRjaCkgewoJCQkJbWF0Y2ggPSB2aWV3U3RyLm1hdGNoKC9cdytEYXkvKTsKCQkJfQoKCQkJdmlld1R5cGUgPSBtYXRjaCA\/IG1hdGNoWzBdIDogJ2FnZW5kYURheSc7IC8vIGZhbGwgYmFjayB0byBhZ2VuZGFEYXkKCQl9CgoJCWRhdGUgPSBuZXdEYXRlOwoJCXJlbmRlclZpZXcodmlld1R5cGUpOwoJfQoJCgkKCWZ1bmN0aW9uIGdldERhdGUoKSB7CgkJcmV0dXJuIGRhdGUuY2xvbmUoKTsKCX0KCgoKCS8qIEhlaWdodCAiRnJlZXppbmciCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCWZ1bmN0aW9uIGZyZWV6ZUNvbnRlbnRIZWlnaHQoKSB7CgkJY29udGVudC5jc3MoewoJCQl3aWR0aDogJzEwMCUnLAoJCQloZWlnaHQ6IGNvbnRlbnQuaGVpZ2h0KCksCgkJCW92ZXJmbG93OiAnaGlkZGVuJwoJCX0pOwoJfQoKCglmdW5jdGlvbiB1bmZyZWV6ZUNvbnRlbnRIZWlnaHQoKSB7CgkJY29udGVudC5jc3MoewoJCQl3aWR0aDogJycsCgkJCWhlaWdodDogJycsCgkJCW92ZXJmbG93OiAnJwoJCX0pOwoJfQoJCgkKCQoJLyogTWlzYwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoJCgoJZnVuY3Rpb24gZ2V0Q2FsZW5kYXIoKSB7CgkJcmV0dXJuIHQ7Cgl9CgoJCglmdW5jdGlvbiBnZXRWaWV3KCkgewoJCXJldHVybiBjdXJyZW50VmlldzsKCX0KCQoJCglmdW5jdGlvbiBvcHRpb24obmFtZSwgdmFsdWUpIHsKCQlpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gb3B0aW9uc1tuYW1lXTsKCQl9CgkJaWYgKG5hbWUgPT0gJ2hlaWdodCcgfHwgbmFtZSA9PSAnY29udGVudEhlaWdodCcgfHwgbmFtZSA9PSAnYXNwZWN0UmF0aW8nKSB7CgkJCW9wdGlvbnNbbmFtZV0gPSB2YWx1ZTsKCQkJdXBkYXRlU2l6ZSh0cnVlKTsgLy8gdHJ1ZSA9IGFsbG93IHJlY2FsY3VsYXRpb24gb2YgaGVpZ2h0CgkJfQoJfQoJCgkKCWZ1bmN0aW9uIHRyaWdnZXIobmFtZSwgdGhpc09iaikgewoJCWlmIChvcHRpb25zW25hbWVdKSB7CgkJCXJldHVybiBvcHRpb25zW25hbWVdLmFwcGx5KAoJCQkJdGhpc09iaiB8fCBfZWxlbWVudCwKCQkJCUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMikKCQkJKTsKCQl9Cgl9Cgp9Cgo7OwoKLyogVG9wIHRvb2xiYXIgYXJlYSB3aXRoIGJ1dHRvbnMgYW5kIHRpdGxlCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwovLyBUT0RPOiByZW5hbWUgYWxsIGhlYWRlci1yZWxhdGVkIHRoaW5ncyB0byAidG9vbGJhciIKCmZ1bmN0aW9uIEhlYWRlcihjYWxlbmRhciwgb3B0aW9ucykgewoJdmFyIHQgPSB0aGlzOwoJCgkvLyBleHBvcnRzCgl0LnJlbmRlciA9IHJlbmRlcjsKCXQuZGVzdHJveSA9IGRlc3Ryb3k7Cgl0LnVwZGF0ZVRpdGxlID0gdXBkYXRlVGl0bGU7Cgl0LmFjdGl2YXRlQnV0dG9uID0gYWN0aXZhdGVCdXR0b247Cgl0LmRlYWN0aXZhdGVCdXR0b24gPSBkZWFjdGl2YXRlQnV0dG9uOwoJdC5kaXNhYmxlQnV0dG9uID0gZGlzYWJsZUJ1dHRvbjsKCXQuZW5hYmxlQnV0dG9uID0gZW5hYmxlQnV0dG9uOwoJdC5nZXRWaWV3c1dpdGhCdXR0b25zID0gZ2V0Vmlld3NXaXRoQnV0dG9uczsKCQoJLy8gbG9jYWxzCgl2YXIgZWwgPSAkKCk7Cgl2YXIgdmlld3NXaXRoQnV0dG9ucyA9IFtdOwoJdmFyIHRtOwoKCglmdW5jdGlvbiByZW5kZXIoKSB7CgkJdmFyIHNlY3Rpb25zID0gb3B0aW9ucy5oZWFkZXI7CgoJCXRtID0gb3B0aW9ucy50aGVtZSA\/ICd1aScgOiAnZmMnOwoKCQlpZiAoc2VjdGlvbnMpIHsKCQkJZWwgPSAkKCI8ZGl2IGNsYXNzPSdmYy10b29sYmFyJy8+IikKCQkJCS5hcHBlbmQocmVuZGVyU2VjdGlvbignbGVmdCcpKQoJCQkJLmFwcGVuZChyZW5kZXJTZWN0aW9uKCdyaWdodCcpKQoJCQkJLmFwcGVuZChyZW5kZXJTZWN0aW9uKCdjZW50ZXInKSkKCQkJCS5hcHBlbmQoJzxkaXYgY2xhc3M9ImZjLWNsZWFyIi8+Jyk7CgoJCQlyZXR1cm4gZWw7CgkJfQoJfQoJCgkKCWZ1bmN0aW9uIGRlc3Ryb3koKSB7CgkJZWwucmVtb3ZlKCk7Cgl9CgkKCQoJZnVuY3Rpb24gcmVuZGVyU2VjdGlvbihwb3NpdGlvbikgewoJCXZhciBzZWN0aW9uRWwgPSAkKCc8ZGl2IGNsYXNzPSJmYy0nICsgcG9zaXRpb24gKyAnIi8+Jyk7CgkJdmFyIGJ1dHRvblN0ciA9IG9wdGlvbnMuaGVhZGVyW3Bvc2l0aW9uXTsKCgkJaWYgKGJ1dHRvblN0cikgewoJCQkkLmVhY2goYnV0dG9uU3RyLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGkpIHsKCQkJCXZhciBncm91cENoaWxkcmVuID0gJCgpOwoJCQkJdmFyIGlzT25seUJ1dHRvbnMgPSB0cnVlOwoJCQkJdmFyIGdyb3VwRWw7CgoJCQkJJC5lYWNoKHRoaXMuc3BsaXQoJywnKSwgZnVuY3Rpb24oaiwgYnV0dG9uTmFtZSkgewoJCQkJCXZhciBidXR0b25DbGljazsKCQkJCQl2YXIgdGhlbWVJY29uOwoJCQkJCXZhciBub3JtYWxJY29uOwoJCQkJCXZhciBkZWZhdWx0VGV4dDsKCQkJCQl2YXIgdmlld1RleHQ7IC8vIGhpZ2hlc3QgcHJpb3JpdHkKCQkJCQl2YXIgY3VzdG9tVGV4dDsKCQkJCQl2YXIgaW5uZXJIdG1sOwoJCQkJCXZhciBjbGFzc2VzOwoJCQkJCXZhciBidXR0b247CgoJCQkJCWlmIChidXR0b25OYW1lID09ICd0aXRsZScpIHsKCQkJCQkJZ3JvdXBDaGlsZHJlbiA9IGdyb3VwQ2hpbGRyZW4uYWRkKCQoJzxoMj4mbmJzcDs8L2gyPicpKTsgLy8gd2UgYWx3YXlzIHdhbnQgaXQgdG8gdGFrZSB1cCBoZWlnaHQKCQkJCQkJaXNPbmx5QnV0dG9ucyA9IGZhbHNlOwoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJaWYgKGNhbGVuZGFyW2J1dHRvbk5hbWVdKSB7IC8vIGEgY2FsZW5kYXIgbWV0aG9kCgkJCQkJCQlidXR0b25DbGljayA9IGZ1bmN0aW9uKCkgewoJCQkJCQkJCWNhbGVuZGFyW2J1dHRvbk5hbWVdKCk7CgkJCQkJCQl9OwoJCQkJCQl9CgkJCQkJCWVsc2UgaWYgKGNhbGVuZGFyLmlzVmFsaWRWaWV3VHlwZShidXR0b25OYW1lKSkgeyAvLyBhIHZpZXcgdHlwZQoJCQkJCQkJYnV0dG9uQ2xpY2sgPSBmdW5jdGlvbigpIHsKCQkJCQkJCQljYWxlbmRhci5jaGFuZ2VWaWV3KGJ1dHRvbk5hbWUpOwoJCQkJCQkJfTsKCQkJCQkJCXZpZXdzV2l0aEJ1dHRvbnMucHVzaChidXR0b25OYW1lKTsKCQkJCQkJCXZpZXdUZXh0ID0gY2FsZW5kYXIuZ2V0Vmlld0J1dHRvblRleHQoYnV0dG9uTmFtZSk7CgkJCQkJCX0KCQkJCQkJaWYgKGJ1dHRvbkNsaWNrKSB7CgoJCQkJCQkJLy8gc21hcnRQcm9wZXJ0eSBhbGxvd3MgZGlmZmVyZW50IHRleHQgcGVyIHZpZXcgYnV0dG9uIChleDogIkFnZW5kYSBXZWVrIiB2cyAiQmFzaWMgV2VlayIpCgkJCQkJCQl0aGVtZUljb24gPSBzbWFydFByb3BlcnR5KG9wdGlvbnMudGhlbWVCdXR0b25JY29ucywgYnV0dG9uTmFtZSk7CgkJCQkJCQlub3JtYWxJY29uID0gc21hcnRQcm9wZXJ0eShvcHRpb25zLmJ1dHRvbkljb25zLCBidXR0b25OYW1lKTsKCQkJCQkJCWRlZmF1bHRUZXh0ID0gc21hcnRQcm9wZXJ0eShvcHRpb25zLmRlZmF1bHRCdXR0b25UZXh0LCBidXR0b25OYW1lKTsgLy8gZnJvbSBsYW5ndWFnZXMKCQkJCQkJCWN1c3RvbVRleHQgPSBzbWFydFByb3BlcnR5KG9wdGlvbnMuYnV0dG9uVGV4dCwgYnV0dG9uTmFtZSk7CgoJCQkJCQkJaWYgKHZpZXdUZXh0IHx8IGN1c3RvbVRleHQpIHsKCQkJCQkJCQlpbm5lckh0bWwgPSBodG1sRXNjYXBlKHZpZXdUZXh0IHx8IGN1c3RvbVRleHQpOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSBpZiAodGhlbWVJY29uICYmIG9wdGlvbnMudGhlbWUpIHsKCQkJCQkJCQlpbm5lckh0bWwgPSAiPHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi0iICsgdGhlbWVJY29uICsgIic+PC9zcGFuPiI7CgkJCQkJCQl9CgkJCQkJCQllbHNlIGlmIChub3JtYWxJY29uICYmICFvcHRpb25zLnRoZW1lKSB7CgkJCQkJCQkJaW5uZXJIdG1sID0gIjxzcGFuIGNsYXNzPSdmYy1pY29uIGZjLWljb24tIiArIG5vcm1hbEljb24gKyAiJz48L3NwYW4+IjsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCWlubmVySHRtbCA9IGh0bWxFc2NhcGUoZGVmYXVsdFRleHQgfHwgYnV0dG9uTmFtZSk7CgkJCQkJCQl9CgoJCQkJCQkJY2xhc3NlcyA9IFsKCQkJCQkJCQknZmMtJyArIGJ1dHRvbk5hbWUgKyAnLWJ1dHRvbicsCgkJCQkJCQkJdG0gKyAnLWJ1dHRvbicsCgkJCQkJCQkJdG0gKyAnLXN0YXRlLWRlZmF1bHQnCgkJCQkJCQldOwoKCQkJCQkJCWJ1dHRvbiA9ICQoIC8vIHR5cGU9ImJ1dHRvbiIgc28gdGhhdCBpdCBkb2Vzbid0IHN1Ym1pdCBhIGZvcm0KCQkJCQkJCQknPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSInICsgY2xhc3Nlcy5qb2luKCcgJykgKyAnIj4nICsKCQkJCQkJCQkJaW5uZXJIdG1sICsKCQkJCQkJCQknPC9idXR0b24+JwoJCQkJCQkJCSkKCQkJCQkJCQkuY2xpY2soZnVuY3Rpb24oKSB7CgkJCQkJCQkJCS8vIGRvbid0IHByb2Nlc3MgY2xpY2tzIGZvciBkaXNhYmxlZCBidXR0b25zCgkJCQkJCQkJCWlmICghYnV0dG9uLmhhc0NsYXNzKHRtICsgJy1zdGF0ZS1kaXNhYmxlZCcpKSB7CgoJCQkJCQkJCQkJYnV0dG9uQ2xpY2soKTsKCgkJCQkJCQkJCQkvLyBhZnRlciB0aGUgY2xpY2sgYWN0aW9uLCBpZiB0aGUgYnV0dG9uIGJlY29tZXMgdGhlICJhY3RpdmUiIHRhYiwgb3IgZGlzYWJsZWQsCgkJCQkJCQkJCQkvLyBpdCBzaG91bGQgbmV2ZXIgaGF2ZSBhIGhvdmVyIGNsYXNzLCBzbyByZW1vdmUgaXQgbm93LgoJCQkJCQkJCQkJaWYgKAoJCQkJCQkJCQkJCWJ1dHRvbi5oYXNDbGFzcyh0bSArICctc3RhdGUtYWN0aXZlJykgfHwKCQkJCQkJCQkJCQlidXR0b24uaGFzQ2xhc3ModG0gKyAnLXN0YXRlLWRpc2FibGVkJykKCQkJCQkJCQkJCSkgewoJCQkJCQkJCQkJCWJ1dHRvbi5yZW1vdmVDbGFzcyh0bSArICctc3RhdGUtaG92ZXInKTsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJfQoJCQkJCQkJCX0pCgkJCQkJCQkJLm1vdXNlZG93bihmdW5jdGlvbigpIHsKCQkJCQkJCQkJLy8gdGhlICpkb3duKiBlZmZlY3QgKG1vdXNlIHByZXNzZWQgaW4pLgoJCQkJCQkJCQkvLyBvbmx5IG9uIGJ1dHRvbnMgdGhhdCBhcmUgbm90IHRoZSAiYWN0aXZlIiB0YWIsIG9yIGRpc2FibGVkCgkJCQkJCQkJCWJ1dHRvbgoJCQkJCQkJCQkJLm5vdCgnLicgKyB0bSArICctc3RhdGUtYWN0aXZlJykKCQkJCQkJCQkJCS5ub3QoJy4nICsgdG0gKyAnLXN0YXRlLWRpc2FibGVkJykKCQkJCQkJCQkJCS5hZGRDbGFzcyh0bSArICctc3RhdGUtZG93bicpOwoJCQkJCQkJCX0pCgkJCQkJCQkJLm1vdXNldXAoZnVuY3Rpb24oKSB7CgkJCQkJCQkJCS8vIHVuZG8gdGhlICpkb3duKiBlZmZlY3QKCQkJCQkJCQkJYnV0dG9uLnJlbW92ZUNsYXNzKHRtICsgJy1zdGF0ZS1kb3duJyk7CgkJCQkJCQkJfSkKCQkJCQkJCQkuaG92ZXIoCgkJCQkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJCQkJLy8gdGhlICpob3ZlciogZWZmZWN0LgoJCQkJCQkJCQkJLy8gb25seSBvbiBidXR0b25zIHRoYXQgYXJlIG5vdCB0aGUgImFjdGl2ZSIgdGFiLCBvciBkaXNhYmxlZAoJCQkJCQkJCQkJYnV0dG9uCgkJCQkJCQkJCQkJLm5vdCgnLicgKyB0bSArICctc3RhdGUtYWN0aXZlJykKCQkJCQkJCQkJCQkubm90KCcuJyArIHRtICsgJy1zdGF0ZS1kaXNhYmxlZCcpCgkJCQkJCQkJCQkJLmFkZENsYXNzKHRtICsgJy1zdGF0ZS1ob3ZlcicpOwoJCQkJCQkJCQl9LAoJCQkJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCQkJCS8vIHVuZG8gdGhlICpob3ZlciogZWZmZWN0CgkJCQkJCQkJCQlidXR0b24KCQkJCQkJCQkJCQkucmVtb3ZlQ2xhc3ModG0gKyAnLXN0YXRlLWhvdmVyJykKCQkJCQkJCQkJCQkucmVtb3ZlQ2xhc3ModG0gKyAnLXN0YXRlLWRvd24nKTsgLy8gaWYgbW91c2VsZWF2ZSBoYXBwZW5zIGJlZm9yZSBtb3VzZXVwCgkJCQkJCQkJCX0KCQkJCQkJCQkpOwoKCQkJCQkJCWdyb3VwQ2hpbGRyZW4gPSBncm91cENoaWxkcmVuLmFkZChidXR0b24pOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgoJCQkJaWYgKGlzT25seUJ1dHRvbnMpIHsKCQkJCQlncm91cENoaWxkcmVuCgkJCQkJCS5maXJzdCgpLmFkZENsYXNzKHRtICsgJy1jb3JuZXItbGVmdCcpLmVuZCgpCgkJCQkJCS5sYXN0KCkuYWRkQ2xhc3ModG0gKyAnLWNvcm5lci1yaWdodCcpLmVuZCgpOwoJCQkJfQoKCQkJCWlmIChncm91cENoaWxkcmVuLmxlbmd0aCA+IDEpIHsKCQkJCQlncm91cEVsID0gJCgnPGRpdi8+Jyk7CgkJCQkJaWYgKGlzT25seUJ1dHRvbnMpIHsKCQkJCQkJZ3JvdXBFbC5hZGRDbGFzcygnZmMtYnV0dG9uLWdyb3VwJyk7CgkJCQkJfQoJCQkJCWdyb3VwRWwuYXBwZW5kKGdyb3VwQ2hpbGRyZW4pOwoJCQkJCXNlY3Rpb25FbC5hcHBlbmQoZ3JvdXBFbCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlzZWN0aW9uRWwuYXBwZW5kKGdyb3VwQ2hpbGRyZW4pOyAvLyAxIG9yIDAgY2hpbGRyZW4KCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gc2VjdGlvbkVsOwoJfQoJCgkKCWZ1bmN0aW9uIHVwZGF0ZVRpdGxlKHRleHQpIHsKCQllbC5maW5kKCdoMicpLnRleHQodGV4dCk7Cgl9CgkKCQoJZnVuY3Rpb24gYWN0aXZhdGVCdXR0b24oYnV0dG9uTmFtZSkgewoJCWVsLmZpbmQoJy5mYy0nICsgYnV0dG9uTmFtZSArICctYnV0dG9uJykKCQkJLmFkZENsYXNzKHRtICsgJy1zdGF0ZS1hY3RpdmUnKTsKCX0KCQoJCglmdW5jdGlvbiBkZWFjdGl2YXRlQnV0dG9uKGJ1dHRvbk5hbWUpIHsKCQllbC5maW5kKCcuZmMtJyArIGJ1dHRvbk5hbWUgKyAnLWJ1dHRvbicpCgkJCS5yZW1vdmVDbGFzcyh0bSArICctc3RhdGUtYWN0aXZlJyk7Cgl9CgkKCQoJZnVuY3Rpb24gZGlzYWJsZUJ1dHRvbihidXR0b25OYW1lKSB7CgkJZWwuZmluZCgnLmZjLScgKyBidXR0b25OYW1lICsgJy1idXR0b24nKQoJCQkuYXR0cignZGlzYWJsZWQnLCAnZGlzYWJsZWQnKQoJCQkuYWRkQ2xhc3ModG0gKyAnLXN0YXRlLWRpc2FibGVkJyk7Cgl9CgkKCQoJZnVuY3Rpb24gZW5hYmxlQnV0dG9uKGJ1dHRvbk5hbWUpIHsKCQllbC5maW5kKCcuZmMtJyArIGJ1dHRvbk5hbWUgKyAnLWJ1dHRvbicpCgkJCS5yZW1vdmVBdHRyKCdkaXNhYmxlZCcpCgkJCS5yZW1vdmVDbGFzcyh0bSArICctc3RhdGUtZGlzYWJsZWQnKTsKCX0KCgoJZnVuY3Rpb24gZ2V0Vmlld3NXaXRoQnV0dG9ucygpIHsKCQlyZXR1cm4gdmlld3NXaXRoQnV0dG9uczsKCX0KCn0KCjs7CgpmYy5zb3VyY2VOb3JtYWxpemVycyA9IFtdOwpmYy5zb3VyY2VGZXRjaGVycyA9IFtdOwoKdmFyIGFqYXhEZWZhdWx0cyA9IHsKCWRhdGFUeXBlOiAnanNvbicsCgljYWNoZTogZmFsc2UKfTsKCnZhciBldmVudEdVSUQgPSAxOwoKCmZ1bmN0aW9uIEV2ZW50TWFuYWdlcihvcHRpb25zKSB7IC8vIGFzc3VtZWQgdG8gYmUgYSBjYWxlbmRhcgoJdmFyIHQgPSB0aGlzOwoJCgkKCS8vIGV4cG9ydHMKCXQuaXNGZXRjaE5lZWRlZCA9IGlzRmV0Y2hOZWVkZWQ7Cgl0LmZldGNoRXZlbnRzID0gZmV0Y2hFdmVudHM7Cgl0LmFkZEV2ZW50U291cmNlID0gYWRkRXZlbnRTb3VyY2U7Cgl0LnJlbW92ZUV2ZW50U291cmNlID0gcmVtb3ZlRXZlbnRTb3VyY2U7Cgl0LnVwZGF0ZUV2ZW50ID0gdXBkYXRlRXZlbnQ7Cgl0LnJlbmRlckV2ZW50ID0gcmVuZGVyRXZlbnQ7Cgl0LnJlbW92ZUV2ZW50cyA9IHJlbW92ZUV2ZW50czsKCXQuY2xpZW50RXZlbnRzID0gY2xpZW50RXZlbnRzOwoJdC5tdXRhdGVFdmVudCA9IG11dGF0ZUV2ZW50OwoJdC5ub3JtYWxpemVFdmVudERhdGVQcm9wcyA9IG5vcm1hbGl6ZUV2ZW50RGF0ZVByb3BzOwoJdC5lbnN1cmVWaXNpYmxlRXZlbnRSYW5nZSA9IGVuc3VyZVZpc2libGVFdmVudFJhbmdlOwoJCgkKCS8vIGltcG9ydHMKCXZhciB0cmlnZ2VyID0gdC50cmlnZ2VyOwoJdmFyIGdldFZpZXcgPSB0LmdldFZpZXc7Cgl2YXIgcmVwb3J0RXZlbnRzID0gdC5yZXBvcnRFdmVudHM7CgkKCQoJLy8gbG9jYWxzCgl2YXIgc3RpY2t5U291cmNlID0geyBldmVudHM6IFtdIH07Cgl2YXIgc291cmNlcyA9IFsgc3RpY2t5U291cmNlIF07Cgl2YXIgcmFuZ2VTdGFydCwgcmFuZ2VFbmQ7Cgl2YXIgY3VycmVudEZldGNoSUQgPSAwOwoJdmFyIHBlbmRpbmdTb3VyY2VDbnQgPSAwOwoJdmFyIGxvYWRpbmdMZXZlbCA9IDA7Cgl2YXIgY2FjaGUgPSBbXTsgLy8gaG9sZHMgZXZlbnRzIHRoYXQgaGF2ZSBhbHJlYWR5IGJlZW4gZXhwYW5kZWQKCgoJJC5lYWNoKAoJCShvcHRpb25zLmV2ZW50cyA\/IFsgb3B0aW9ucy5ldmVudHMgXSA6IFtdKS5jb25jYXQob3B0aW9ucy5ldmVudFNvdXJjZXMgfHwgW10pLAoJCWZ1bmN0aW9uKGksIHNvdXJjZUlucHV0KSB7CgkJCXZhciBzb3VyY2UgPSBidWlsZEV2ZW50U291cmNlKHNvdXJjZUlucHV0KTsKCQkJaWYgKHNvdXJjZSkgewoJCQkJc291cmNlcy5wdXNoKHNvdXJjZSk7CgkJCX0KCQl9CgkpOwoJCgkKCQoJLyogRmV0Y2hpbmcKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCQoJCglmdW5jdGlvbiBpc0ZldGNoTmVlZGVkKHN0YXJ0LCBlbmQpIHsKCQlyZXR1cm4gIXJhbmdlU3RhcnQgfHwgLy8gbm90aGluZyBoYXMgYmVlbiBmZXRjaGVkIHlldD8KCQkJLy8gb3IsIGEgcGFydCBvZiB0aGUgbmV3IHJhbmdlIGlzIG91dHNpZGUgb2YgdGhlIG9sZCByYW5nZT8gKGFmdGVyIG5vcm1hbGl6aW5nKQoJCQlzdGFydC5jbG9uZSgpLnN0cmlwWm9uZSgpIDwgcmFuZ2VTdGFydC5jbG9uZSgpLnN0cmlwWm9uZSgpIHx8CgkJCWVuZC5jbG9uZSgpLnN0cmlwWm9uZSgpID4gcmFuZ2VFbmQuY2xvbmUoKS5zdHJpcFpvbmUoKTsKCX0KCQoJCglmdW5jdGlvbiBmZXRjaEV2ZW50cyhzdGFydCwgZW5kKSB7CgkJcmFuZ2VTdGFydCA9IHN0YXJ0OwoJCXJhbmdlRW5kID0gZW5kOwoJCWNhY2hlID0gW107CgkJdmFyIGZldGNoSUQgPSArK2N1cnJlbnRGZXRjaElEOwoJCXZhciBsZW4gPSBzb3VyY2VzLmxlbmd0aDsKCQlwZW5kaW5nU291cmNlQ250ID0gbGVuOwoJCWZvciAodmFyIGk9MDsgaTxsZW47IGkrKykgewoJCQlmZXRjaEV2ZW50U291cmNlKHNvdXJjZXNbaV0sIGZldGNoSUQpOwoJCX0KCX0KCQoJCglmdW5jdGlvbiBmZXRjaEV2ZW50U291cmNlKHNvdXJjZSwgZmV0Y2hJRCkgewoJCV9mZXRjaEV2ZW50U291cmNlKHNvdXJjZSwgZnVuY3Rpb24oZXZlbnRJbnB1dHMpIHsKCQkJdmFyIGlzQXJyYXlTb3VyY2UgPSAkLmlzQXJyYXkoc291cmNlLmV2ZW50cyk7CgkJCXZhciBpLCBldmVudElucHV0OwoJCQl2YXIgYWJzdHJhY3RFdmVudDsKCgkJCWlmIChmZXRjaElEID09IGN1cnJlbnRGZXRjaElEKSB7CgoJCQkJaWYgKGV2ZW50SW5wdXRzKSB7CgkJCQkJZm9yIChpID0gMDsgaSA8IGV2ZW50SW5wdXRzLmxlbmd0aDsgaSsrKSB7CgkJCQkJCWV2ZW50SW5wdXQgPSBldmVudElucHV0c1tpXTsKCgkJCQkJCWlmIChpc0FycmF5U291cmNlKSB7IC8vIGFycmF5IHNvdXJjZXMgaGF2ZSBhbHJlYWR5IGJlZW4gY29udmVydCB0byBFdmVudCBPYmplY3RzCgkJCQkJCQlhYnN0cmFjdEV2ZW50ID0gZXZlbnRJbnB1dDsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCWFic3RyYWN0RXZlbnQgPSBidWlsZEV2ZW50RnJvbUlucHV0KGV2ZW50SW5wdXQsIHNvdXJjZSk7CgkJCQkJCX0KCgkJCQkJCWlmIChhYnN0cmFjdEV2ZW50KSB7IC8vIG5vdCBmYWxzZSAoYW4gaW52YWxpZCBldmVudCkKCQkJCQkJCWNhY2hlLnB1c2guYXBwbHkoCgkJCQkJCQkJY2FjaGUsCgkJCQkJCQkJZXhwYW5kRXZlbnQoYWJzdHJhY3RFdmVudCkgLy8gYWRkIGluZGl2aWR1YWwgZXhwYW5kZWQgZXZlbnRzIHRvIHRoZSBjYWNoZQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQlwZW5kaW5nU291cmNlQ250LS07CgkJCQlpZiAoIXBlbmRpbmdTb3VyY2VDbnQpIHsKCQkJCQlyZXBvcnRFdmVudHMoY2FjaGUpOwoJCQkJfQoJCQl9CgkJfSk7Cgl9CgkKCQoJZnVuY3Rpb24gX2ZldGNoRXZlbnRTb3VyY2Uoc291cmNlLCBjYWxsYmFjaykgewoJCXZhciBpOwoJCXZhciBmZXRjaGVycyA9IGZjLnNvdXJjZUZldGNoZXJzOwoJCXZhciByZXM7CgoJCWZvciAoaT0wOyBpPGZldGNoZXJzLmxlbmd0aDsgaSsrKSB7CgkJCXJlcyA9IGZldGNoZXJzW2ldLmNhbGwoCgkJCQl0LCAvLyB0aGlzLCB0aGUgQ2FsZW5kYXIgb2JqZWN0CgkJCQlzb3VyY2UsCgkJCQlyYW5nZVN0YXJ0LmNsb25lKCksCgkJCQlyYW5nZUVuZC5jbG9uZSgpLAoJCQkJb3B0aW9ucy50aW1lem9uZSwKCQkJCWNhbGxiYWNrCgkJCSk7CgoJCQlpZiAocmVzID09PSB0cnVlKSB7CgkJCQkvLyB0aGUgZmV0Y2hlciBpcyBpbiBjaGFyZ2UuIG1hZGUgaXRzIG93biBhc3luYyByZXF1ZXN0CgkJCQlyZXR1cm47CgkJCX0KCQkJZWxzZSBpZiAodHlwZW9mIHJlcyA9PSAnb2JqZWN0JykgewoJCQkJLy8gdGhlIGZldGNoZXIgcmV0dXJuZWQgYSBuZXcgc291cmNlLiBwcm9jZXNzIGl0CgkJCQlfZmV0Y2hFdmVudFNvdXJjZShyZXMsIGNhbGxiYWNrKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJdmFyIGV2ZW50cyA9IHNvdXJjZS5ldmVudHM7CgkJaWYgKGV2ZW50cykgewoJCQlpZiAoJC5pc0Z1bmN0aW9uKGV2ZW50cykpIHsKCQkJCXB1c2hMb2FkaW5nKCk7CgkJCQlldmVudHMuY2FsbCgKCQkJCQl0LCAvLyB0aGlzLCB0aGUgQ2FsZW5kYXIgb2JqZWN0CgkJCQkJcmFuZ2VTdGFydC5jbG9uZSgpLAoJCQkJCXJhbmdlRW5kLmNsb25lKCksCgkJCQkJb3B0aW9ucy50aW1lem9uZSwKCQkJCQlmdW5jdGlvbihldmVudHMpIHsKCQkJCQkJY2FsbGJhY2soZXZlbnRzKTsKCQkJCQkJcG9wTG9hZGluZygpOwoJCQkJCX0KCQkJCSk7CgkJCX0KCQkJZWxzZSBpZiAoJC5pc0FycmF5KGV2ZW50cykpIHsKCQkJCWNhbGxiYWNrKGV2ZW50cyk7CgkJCX0KCQkJZWxzZSB7CgkJCQljYWxsYmFjaygpOwoJCQl9CgkJfWVsc2V7CgkJCXZhciB1cmwgPSBzb3VyY2UudXJsOwoJCQlpZiAodXJsKSB7CgkJCQl2YXIgc3VjY2VzcyA9IHNvdXJjZS5zdWNjZXNzOwoJCQkJdmFyIGVycm9yID0gc291cmNlLmVycm9yOwoJCQkJdmFyIGNvbXBsZXRlID0gc291cmNlLmNvbXBsZXRlOwoKCQkJCS8vIHJldHJpZXZlIGFueSBvdXRib3VuZCBHRVQvUE9TVCAkLmFqYXggZGF0YSBmcm9tIHRoZSBvcHRpb25zCgkJCQl2YXIgY3VzdG9tRGF0YTsKCQkJCWlmICgkLmlzRnVuY3Rpb24oc291cmNlLmRhdGEpKSB7CgkJCQkJLy8gc3VwcGxpZWQgYXMgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSBrZXkvdmFsdWUgb2JqZWN0CgkJCQkJY3VzdG9tRGF0YSA9IHNvdXJjZS5kYXRhKCk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQkvLyBzdXBwbGllZCBhcyBhIHN0cmFpZ2h0IGtleS92YWx1ZSBvYmplY3QKCQkJCQljdXN0b21EYXRhID0gc291cmNlLmRhdGE7CgkJCQl9CgoJCQkJLy8gdXNlIGEgY29weSBvZiB0aGUgY3VzdG9tIGRhdGEgc28gd2UgY2FuIG1vZGlmeSB0aGUgcGFyYW1ldGVycwoJCQkJLy8gYW5kIG5vdCBhZmZlY3QgdGhlIHBhc3NlZC1pbiBvYmplY3QuCgkJCQl2YXIgZGF0YSA9ICQuZXh0ZW5kKHt9LCBjdXN0b21EYXRhIHx8IHt9KTsKCgkJCQl2YXIgc3RhcnRQYXJhbSA9IGZpcnN0RGVmaW5lZChzb3VyY2Uuc3RhcnRQYXJhbSwgb3B0aW9ucy5zdGFydFBhcmFtKTsKCQkJCXZhciBlbmRQYXJhbSA9IGZpcnN0RGVmaW5lZChzb3VyY2UuZW5kUGFyYW0sIG9wdGlvbnMuZW5kUGFyYW0pOwoJCQkJdmFyIHRpbWV6b25lUGFyYW0gPSBmaXJzdERlZmluZWQoc291cmNlLnRpbWV6b25lUGFyYW0sIG9wdGlvbnMudGltZXpvbmVQYXJhbSk7CgoJCQkJaWYgKHN0YXJ0UGFyYW0pIHsKCQkJCQlkYXRhW3N0YXJ0UGFyYW1dID0gcmFuZ2VTdGFydC5mb3JtYXQoKTsKCQkJCX0KCQkJCWlmIChlbmRQYXJhbSkgewoJCQkJCWRhdGFbZW5kUGFyYW1dID0gcmFuZ2VFbmQuZm9ybWF0KCk7CgkJCQl9CgkJCQlpZiAob3B0aW9ucy50aW1lem9uZSAmJiBvcHRpb25zLnRpbWV6b25lICE9ICdsb2NhbCcpIHsKCQkJCQlkYXRhW3RpbWV6b25lUGFyYW1dID0gb3B0aW9ucy50aW1lem9uZTsKCQkJCX0KCgkJCQlwdXNoTG9hZGluZygpOwoJCQkJJC5hamF4KCQuZXh0ZW5kKHt9LCBhamF4RGVmYXVsdHMsIHNvdXJjZSwgewoJCQkJCWRhdGE6IGRhdGEsCgkJCQkJc3VjY2VzczogZnVuY3Rpb24oZXZlbnRzKSB7CgkJCQkJCWV2ZW50cyA9IGV2ZW50cyB8fCBbXTsKCQkJCQkJdmFyIHJlcyA9IGFwcGx5QWxsKHN1Y2Nlc3MsIHRoaXMsIGFyZ3VtZW50cyk7CgkJCQkJCWlmICgkLmlzQXJyYXkocmVzKSkgewoJCQkJCQkJZXZlbnRzID0gcmVzOwoJCQkJCQl9CgkJCQkJCWNhbGxiYWNrKGV2ZW50cyk7CgkJCQkJfSwKCQkJCQllcnJvcjogZnVuY3Rpb24oKSB7CgkJCQkJCWFwcGx5QWxsKGVycm9yLCB0aGlzLCBhcmd1bWVudHMpOwoJCQkJCQljYWxsYmFjaygpOwoJCQkJCX0sCgkJCQkJY29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQkJCQlhcHBseUFsbChjb21wbGV0ZSwgdGhpcywgYXJndW1lbnRzKTsKCQkJCQkJcG9wTG9hZGluZygpOwoJCQkJCX0KCQkJCX0pKTsKCQkJfWVsc2V7CgkJCQljYWxsYmFjaygpOwoJCQl9CgkJfQoJfQoJCgkKCQoJLyogU291cmNlcwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoJCgoJZnVuY3Rpb24gYWRkRXZlbnRTb3VyY2Uoc291cmNlSW5wdXQpIHsKCQl2YXIgc291cmNlID0gYnVpbGRFdmVudFNvdXJjZShzb3VyY2VJbnB1dCk7CgkJaWYgKHNvdXJjZSkgewoJCQlzb3VyY2VzLnB1c2goc291cmNlKTsKCQkJcGVuZGluZ1NvdXJjZUNudCsrOwoJCQlmZXRjaEV2ZW50U291cmNlKHNvdXJjZSwgY3VycmVudEZldGNoSUQpOyAvLyB3aWxsIGV2ZW50dWFsbHkgY2FsbCByZXBvcnRFdmVudHMKCQl9Cgl9CgoKCWZ1bmN0aW9uIGJ1aWxkRXZlbnRTb3VyY2Uoc291cmNlSW5wdXQpIHsgLy8gd2lsbCByZXR1cm4gdW5kZWZpbmVkIGlmIGludmFsaWQgc291cmNlCgkJdmFyIG5vcm1hbGl6ZXJzID0gZmMuc291cmNlTm9ybWFsaXplcnM7CgkJdmFyIHNvdXJjZTsKCQl2YXIgaTsKCgkJaWYgKCQuaXNGdW5jdGlvbihzb3VyY2VJbnB1dCkgfHwgJC5pc0FycmF5KHNvdXJjZUlucHV0KSkgewoJCQlzb3VyY2UgPSB7IGV2ZW50czogc291cmNlSW5wdXQgfTsKCQl9CgkJZWxzZSBpZiAodHlwZW9mIHNvdXJjZUlucHV0ID09PSAnc3RyaW5nJykgewoJCQlzb3VyY2UgPSB7IHVybDogc291cmNlSW5wdXQgfTsKCQl9CgkJZWxzZSBpZiAodHlwZW9mIHNvdXJjZUlucHV0ID09PSAnb2JqZWN0JykgewoJCQlzb3VyY2UgPSAkLmV4dGVuZCh7fSwgc291cmNlSW5wdXQpOyAvLyBzaGFsbG93IGNvcHkKCQl9CgoJCWlmIChzb3VyY2UpIHsKCgkJCS8vIFRPRE86IHJlcGVhdCBjb2RlLCBzYW1lIGNvZGUgZm9yIGV2ZW50IGNsYXNzTmFtZXMKCQkJaWYgKHNvdXJjZS5jbGFzc05hbWUpIHsKCQkJCWlmICh0eXBlb2Ygc291cmNlLmNsYXNzTmFtZSA9PT0gJ3N0cmluZycpIHsKCQkJCQlzb3VyY2UuY2xhc3NOYW1lID0gc291cmNlLmNsYXNzTmFtZS5zcGxpdCgvXHMrLyk7CgkJCQl9CgkJCQkvLyBvdGhlcndpc2UsIGFzc3VtZWQgdG8gYmUgYW4gYXJyYXkKCQkJfQoJCQllbHNlIHsKCQkJCXNvdXJjZS5jbGFzc05hbWUgPSBbXTsKCQkJfQoKCQkJLy8gZm9yIGFycmF5IHNvdXJjZXMsIHdlIGNvbnZlcnQgdG8gc3RhbmRhcmQgRXZlbnQgT2JqZWN0cyB1cCBmcm9udAoJCQlpZiAoJC5pc0FycmF5KHNvdXJjZS5ldmVudHMpKSB7CgkJCQlzb3VyY2Uub3JpZ0FycmF5ID0gc291cmNlLmV2ZW50czsgLy8gZm9yIHJlbW92ZUV2ZW50U291cmNlCgkJCQlzb3VyY2UuZXZlbnRzID0gJC5tYXAoc291cmNlLmV2ZW50cywgZnVuY3Rpb24oZXZlbnRJbnB1dCkgewoJCQkJCXJldHVybiBidWlsZEV2ZW50RnJvbUlucHV0KGV2ZW50SW5wdXQsIHNvdXJjZSk7CgkJCQl9KTsKCQkJfQoKCQkJZm9yIChpPTA7IGk8bm9ybWFsaXplcnMubGVuZ3RoOyBpKyspIHsKCQkJCW5vcm1hbGl6ZXJzW2ldLmNhbGwodCwgc291cmNlKTsKCQkJfQoKCQkJcmV0dXJuIHNvdXJjZTsKCQl9Cgl9CgoKCWZ1bmN0aW9uIHJlbW92ZUV2ZW50U291cmNlKHNvdXJjZSkgewoJCXNvdXJjZXMgPSAkLmdyZXAoc291cmNlcywgZnVuY3Rpb24oc3JjKSB7CgkJCXJldHVybiAhaXNTb3VyY2VzRXF1YWwoc3JjLCBzb3VyY2UpOwoJCX0pOwoJCS8vIHJlbW92ZSBhbGwgY2xpZW50IGV2ZW50cyBmcm9tIHRoYXQgc291cmNlCgkJY2FjaGUgPSAkLmdyZXAoY2FjaGUsIGZ1bmN0aW9uKGUpIHsKCQkJcmV0dXJuICFpc1NvdXJjZXNFcXVhbChlLnNvdXJjZSwgc291cmNlKTsKCQl9KTsKCQlyZXBvcnRFdmVudHMoY2FjaGUpOwoJfQoKCglmdW5jdGlvbiBpc1NvdXJjZXNFcXVhbChzb3VyY2UxLCBzb3VyY2UyKSB7CgkJcmV0dXJuIHNvdXJjZTEgJiYgc291cmNlMiAmJiBnZXRTb3VyY2VQcmltaXRpdmUoc291cmNlMSkgPT0gZ2V0U291cmNlUHJpbWl0aXZlKHNvdXJjZTIpOwoJfQoKCglmdW5jdGlvbiBnZXRTb3VyY2VQcmltaXRpdmUoc291cmNlKSB7CgkJcmV0dXJuICgKCQkJKHR5cGVvZiBzb3VyY2UgPT09ICdvYmplY3QnKSA\/IC8vIGEgbm9ybWFsaXplZCBldmVudCBzb3VyY2U\/CgkJCQkoc291cmNlLm9yaWdBcnJheSB8fCBzb3VyY2UuZ29vZ2xlQ2FsZW5kYXJJZCB8fCBzb3VyY2UudXJsIHx8IHNvdXJjZS5ldmVudHMpIDogLy8gZ2V0IHRoZSBwcmltaXRpdmUKCQkJCW51bGwKCQkpIHx8CgkJc291cmNlOyAvLyB0aGUgZ2l2ZW4gYXJndW1lbnQgKmlzKiB0aGUgcHJpbWl0aXZlCgl9CgkKCQoJCgkvKiBNYW5pcHVsYXRpb24KCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gT25seSBldmVyIGNhbGxlZCBmcm9tIHRoZSBleHRlcm5hbGx5LWZhY2luZyBBUEkKCWZ1bmN0aW9uIHVwZGF0ZUV2ZW50KGV2ZW50KSB7CgoJCS8vIG1hc3NhZ2Ugc3RhcnQvZW5kIHZhbHVlcywgZXZlbiBpZiBkYXRlIHN0cmluZyB2YWx1ZXMKCQlldmVudC5zdGFydCA9IHQubW9tZW50KGV2ZW50LnN0YXJ0KTsKCQlpZiAoZXZlbnQuZW5kKSB7CgkJCWV2ZW50LmVuZCA9IHQubW9tZW50KGV2ZW50LmVuZCk7CgkJfQoJCWVsc2UgewoJCQlldmVudC5lbmQgPSBudWxsOwoJCX0KCgkJbXV0YXRlRXZlbnQoZXZlbnQsIGdldE1pc2NFdmVudFByb3BzKGV2ZW50KSk7IC8vIHdpbGwgaGFuZGxlIHN0YXJ0L2VuZC9hbGxEYXkgbm9ybWFsaXphdGlvbgoJCXJlcG9ydEV2ZW50cyhjYWNoZSk7IC8vIHJlcG9ydHMgZXZlbnQgbW9kaWZpY2F0aW9ucyAoc28gd2UgY2FuIHJlZHJhdykKCX0KCgoJLy8gUmV0dXJucyBhIGhhc2ggb2YgbWlzYyBldmVudCBwcm9wZXJ0aWVzIHRoYXQgc2hvdWxkIGJlIGNvcGllZCBvdmVyIHRvIHJlbGF0ZWQgZXZlbnRzLgoJZnVuY3Rpb24gZ2V0TWlzY0V2ZW50UHJvcHMoZXZlbnQpIHsKCQl2YXIgcHJvcHMgPSB7fTsKCgkJJC5lYWNoKGV2ZW50LCBmdW5jdGlvbihuYW1lLCB2YWwpIHsKCQkJaWYgKGlzTWlzY0V2ZW50UHJvcE5hbWUobmFtZSkpIHsKCQkJCWlmICh2YWwgIT09IHVuZGVmaW5lZCAmJiBpc0F0b21pYyh2YWwpKSB7IC8vIGEgZGVmaW5lZCBub24tb2JqZWN0CgkJCQkJcHJvcHNbbmFtZV0gPSB2YWw7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHByb3BzOwoJfQoKCS8vIG5vbi1kYXRlLXJlbGF0ZWQsIG5vbi1pZC1yZWxhdGVkLCBub24tc2VjcmV0CglmdW5jdGlvbiBpc01pc2NFdmVudFByb3BOYW1lKG5hbWUpIHsKCQlyZXR1cm4gIS9eX3xeKGlkfGFsbERheXxzdGFydHxlbmQpJC8udGVzdChuYW1lKTsKCX0KCgkKCS8vIHJldHVybnMgdGhlIGV4cGFuZGVkIGV2ZW50cyB0aGF0IHdlcmUgY3JlYXRlZAoJZnVuY3Rpb24gcmVuZGVyRXZlbnQoZXZlbnRJbnB1dCwgc3RpY2spIHsKCQl2YXIgYWJzdHJhY3RFdmVudCA9IGJ1aWxkRXZlbnRGcm9tSW5wdXQoZXZlbnRJbnB1dCk7CgkJdmFyIGV2ZW50czsKCQl2YXIgaSwgZXZlbnQ7CgoJCWlmIChhYnN0cmFjdEV2ZW50KSB7IC8vIG5vdCBmYWxzZSAoYSB2YWxpZCBpbnB1dCkKCQkJZXZlbnRzID0gZXhwYW5kRXZlbnQoYWJzdHJhY3RFdmVudCk7CgoJCQlmb3IgKGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7CgkJCQlldmVudCA9IGV2ZW50c1tpXTsKCgkJCQlpZiAoIWV2ZW50LnNvdXJjZSkgewoJCQkJCWlmIChzdGljaykgewoJCQkJCQlzdGlja3lTb3VyY2UuZXZlbnRzLnB1c2goZXZlbnQpOwoJCQkJCQlldmVudC5zb3VyY2UgPSBzdGlja3lTb3VyY2U7CgkJCQkJfQoJCQkJCWNhY2hlLnB1c2goZXZlbnQpOwoJCQkJfQoJCQl9CgoJCQlyZXBvcnRFdmVudHMoY2FjaGUpOwoKCQkJcmV0dXJuIGV2ZW50czsKCQl9CgoJCXJldHVybiBbXTsKCX0KCQoJCglmdW5jdGlvbiByZW1vdmVFdmVudHMoZmlsdGVyKSB7CgkJdmFyIGV2ZW50SUQ7CgkJdmFyIGk7CgoJCWlmIChmaWx0ZXIgPT0gbnVsbCkgeyAvLyBudWxsIG9yIHVuZGVmaW5lZC4gcmVtb3ZlIGFsbCBldmVudHMKCQkJZmlsdGVyID0gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9OyAvLyB3aWxsIGFsd2F5cyBtYXRjaAoJCX0KCQllbHNlIGlmICghJC5pc0Z1bmN0aW9uKGZpbHRlcikpIHsgLy8gYW4gZXZlbnQgSUQKCQkJZXZlbnRJRCA9IGZpbHRlciArICcnOwoJCQlmaWx0ZXIgPSBmdW5jdGlvbihldmVudCkgewoJCQkJcmV0dXJuIGV2ZW50Ll9pZCA9PSBldmVudElEOwoJCQl9OwoJCX0KCgkJLy8gUHVyZ2UgZXZlbnQocykgZnJvbSBvdXIgbG9jYWwgY2FjaGUKCQljYWNoZSA9ICQuZ3JlcChjYWNoZSwgZmlsdGVyLCB0cnVlKTsgLy8gaW52ZXJzZT10cnVlCgoJCS8vIFJlbW92ZSBldmVudHMgZnJvbSBhcnJheSBzb3VyY2VzLgoJCS8vIFRoaXMgd29ya3MgYmVjYXVzZSB0aGV5IGhhdmUgYmVlbiBjb252ZXJ0ZWQgdG8gb2ZmaWNpYWwgRXZlbnQgT2JqZWN0cyB1cCBmcm9udC4KCQkvLyAoYW5kIGFzIGEgcmVzdWx0LCBldmVudC5faWQgaGFzIGJlZW4gY2FsY3VsYXRlZCkuCgkJZm9yIChpPTA7IGk8c291cmNlcy5sZW5ndGg7IGkrKykgewoJCQlpZiAoJC5pc0FycmF5KHNvdXJjZXNbaV0uZXZlbnRzKSkgewoJCQkJc291cmNlc1tpXS5ldmVudHMgPSAkLmdyZXAoc291cmNlc1tpXS5ldmVudHMsIGZpbHRlciwgdHJ1ZSk7CgkJCX0KCQl9CgoJCXJlcG9ydEV2ZW50cyhjYWNoZSk7Cgl9CgkKCQoJZnVuY3Rpb24gY2xpZW50RXZlbnRzKGZpbHRlcikgewoJCWlmICgkLmlzRnVuY3Rpb24oZmlsdGVyKSkgewoJCQlyZXR1cm4gJC5ncmVwKGNhY2hlLCBmaWx0ZXIpOwoJCX0KCQllbHNlIGlmIChmaWx0ZXIgIT0gbnVsbCkgeyAvLyBub3QgbnVsbCwgbm90IHVuZGVmaW5lZC4gYW4gZXZlbnQgSUQKCQkJZmlsdGVyICs9ICcnOwoJCQlyZXR1cm4gJC5ncmVwKGNhY2hlLCBmdW5jdGlvbihlKSB7CgkJCQlyZXR1cm4gZS5faWQgPT0gZmlsdGVyOwoJCQl9KTsKCQl9CgkJcmV0dXJuIGNhY2hlOyAvLyBlbHNlLCByZXR1cm4gYWxsCgl9CgkKCQoJCgkvKiBMb2FkaW5nIFN0YXRlCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgkKCQoJZnVuY3Rpb24gcHVzaExvYWRpbmcoKSB7CgkJaWYgKCEobG9hZGluZ0xldmVsKyspKSB7CgkJCXRyaWdnZXIoJ2xvYWRpbmcnLCBudWxsLCB0cnVlLCBnZXRWaWV3KCkpOwoJCX0KCX0KCQoJCglmdW5jdGlvbiBwb3BMb2FkaW5nKCkgewoJCWlmICghKC0tbG9hZGluZ0xldmVsKSkgewoJCQl0cmlnZ2VyKCdsb2FkaW5nJywgbnVsbCwgZmFsc2UsIGdldFZpZXcoKSk7CgkJfQoJfQoJCgkKCQoJLyogRXZlbnQgTm9ybWFsaXphdGlvbgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBHaXZlbiBhIHJhdyBvYmplY3Qgd2l0aCBrZXkvdmFsdWUgcHJvcGVydGllcywgcmV0dXJucyBhbiAiYWJzdHJhY3QiIEV2ZW50IG9iamVjdC4KCS8vIEFuICJhYnN0cmFjdCIgZXZlbnQgaXMgYW4gZXZlbnQgdGhhdCwgaWYgcmVjdXJyaW5nLCB3aWxsIG5vdCBoYXZlIGJlZW4gZXhwYW5kZWQgeWV0LgoJLy8gV2lsbCByZXR1cm4gYGZhbHNlYCB3aGVuIGlucHV0IGlzIGludmFsaWQuCgkvLyBgc291cmNlYCBpcyBvcHRpb25hbAoJZnVuY3Rpb24gYnVpbGRFdmVudEZyb21JbnB1dChpbnB1dCwgc291cmNlKSB7CgkJdmFyIG91dCA9IHt9OwoJCXZhciBzdGFydCwgZW5kOwoJCXZhciBhbGxEYXk7CgoJCWlmIChvcHRpb25zLmV2ZW50RGF0YVRyYW5zZm9ybSkgewoJCQlpbnB1dCA9IG9wdGlvbnMuZXZlbnREYXRhVHJhbnNmb3JtKGlucHV0KTsKCQl9CgkJaWYgKHNvdXJjZSAmJiBzb3VyY2UuZXZlbnREYXRhVHJhbnNmb3JtKSB7CgkJCWlucHV0ID0gc291cmNlLmV2ZW50RGF0YVRyYW5zZm9ybShpbnB1dCk7CgkJfQoKCQkvLyBDb3B5IGFsbCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIHJlc3VsdGluZyBvYmplY3QuCgkJLy8gVGhlIHNwZWNpYWwtY2FzZSBwcm9wZXJ0aWVzIHdpbGwgYmUgY29waWVkIG92ZXIgYWZ0ZXJ3YXJkcy4KCQkkLmV4dGVuZChvdXQsIGlucHV0KTsKCgkJaWYgKHNvdXJjZSkgewoJCQlvdXQuc291cmNlID0gc291cmNlOwoJCX0KCgkJb3V0Ll9pZCA9IGlucHV0Ll9pZCB8fCAoaW5wdXQuaWQgPT09IHVuZGVmaW5lZCA\/ICdfZmMnICsgZXZlbnRHVUlEKysgOiBpbnB1dC5pZCArICcnKTsKCgkJaWYgKGlucHV0LmNsYXNzTmFtZSkgewoJCQlpZiAodHlwZW9mIGlucHV0LmNsYXNzTmFtZSA9PSAnc3RyaW5nJykgewoJCQkJb3V0LmNsYXNzTmFtZSA9IGlucHV0LmNsYXNzTmFtZS5zcGxpdCgvXHMrLyk7CgkJCX0KCQkJZWxzZSB7IC8vIGFzc3VtZWQgdG8gYmUgYW4gYXJyYXkKCQkJCW91dC5jbGFzc05hbWUgPSBpbnB1dC5jbGFzc05hbWU7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCW91dC5jbGFzc05hbWUgPSBbXTsKCQl9CgoJCXN0YXJ0ID0gaW5wdXQuc3RhcnQgfHwgaW5wdXQuZGF0ZTsgLy8gImRhdGUiIGlzIGFuIGFsaWFzIGZvciAic3RhcnQiCgkJZW5kID0gaW5wdXQuZW5kOwoKCQkvLyBwYXJzZSBhcyBhIHRpbWUgKER1cmF0aW9uKSBpZiBhcHBsaWNhYmxlCgkJaWYgKGlzVGltZVN0cmluZyhzdGFydCkpIHsKCQkJc3RhcnQgPSBtb21lbnQuZHVyYXRpb24oc3RhcnQpOwoJCX0KCQlpZiAoaXNUaW1lU3RyaW5nKGVuZCkpIHsKCQkJZW5kID0gbW9tZW50LmR1cmF0aW9uKGVuZCk7CgkJfQoKCQlpZiAoaW5wdXQuZG93IHx8IG1vbWVudC5pc0R1cmF0aW9uKHN0YXJ0KSB8fCBtb21lbnQuaXNEdXJhdGlvbihlbmQpKSB7CgoJCQkvLyB0aGUgZXZlbnQgaXMgImFic3RyYWN0IiAocmVjdXJyaW5nKSBzbyBkb24ndCBjYWxjdWxhdGUgZXhhY3Qgc3RhcnQvZW5kIGRhdGVzIGp1c3QgeWV0CgkJCW91dC5zdGFydCA9IHN0YXJ0ID8gbW9tZW50LmR1cmF0aW9uKHN0YXJ0KSA6IG51bGw7IC8vIHdpbGwgYmUgYSBEdXJhdGlvbiBvciBudWxsCgkJCW91dC5lbmQgPSBlbmQgPyBtb21lbnQuZHVyYXRpb24oZW5kKSA6IG51bGw7IC8vIHdpbGwgYmUgYSBEdXJhdGlvbiBvciBudWxsCgkJCW91dC5fcmVjdXJyaW5nID0gdHJ1ZTsgLy8gb3VyIGludGVybmFsIG1hcmtlcgoJCX0KCQllbHNlIHsKCgkJCWlmIChzdGFydCkgewoJCQkJc3RhcnQgPSB0Lm1vbWVudChzdGFydCk7CgkJCQlpZiAoIXN0YXJ0LmlzVmFsaWQoKSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoKCQkJaWYgKGVuZCkgewoJCQkJZW5kID0gdC5tb21lbnQoZW5kKTsKCQkJCWlmICghZW5kLmlzVmFsaWQoKSkgewoJCQkJCWVuZCA9IG51bGw7IC8vIGxldCBkZWZhdWx0cyB0YWtlIG92ZXIKCQkJCX0KCQkJfQoKCQkJYWxsRGF5ID0gaW5wdXQuYWxsRGF5OwoJCQlpZiAoYWxsRGF5ID09PSB1bmRlZmluZWQpIHsgLy8gc3RpbGwgdW5kZWZpbmVkPyBmYWxsYmFjayB0byBkZWZhdWx0CgkJCQlhbGxEYXkgPSBmaXJzdERlZmluZWQoCgkJCQkJc291cmNlID8gc291cmNlLmFsbERheURlZmF1bHQgOiB1bmRlZmluZWQsCgkJCQkJb3B0aW9ucy5hbGxEYXlEZWZhdWx0CgkJCQkpOwoJCQkJLy8gc3RpbGwgdW5kZWZpbmVkPyBub3JtYWxpemVFdmVudERhdGVQcm9wcyB3aWxsIGNhbGN1bGF0ZSBpdAoJCQl9CgoJCQlhc3NpZ25EYXRlc1RvRXZlbnQoc3RhcnQsIGVuZCwgYWxsRGF5LCBvdXQpOwoJCX0KCgkJcmV0dXJuIG91dDsKCX0KCgoJLy8gTm9ybWFsaXplcyBhbmQgYXNzaWducyB0aGUgZ2l2ZW4gZGF0ZXMgdG8gdGhlIGdpdmVuIHBhcnRpYWxseS1mb3JtZWQgZXZlbnQgb2JqZWN0LgoJLy8gTk9URTogbXV0YXRlcyB0aGUgZ2l2ZW4gc3RhcnQvZW5kIG1vbWVudHMuIGRvZXMgbm90IG1ha2UgYSBjb3B5LgoJZnVuY3Rpb24gYXNzaWduRGF0ZXNUb0V2ZW50KHN0YXJ0LCBlbmQsIGFsbERheSwgZXZlbnQpIHsKCQlldmVudC5zdGFydCA9IHN0YXJ0OwoJCWV2ZW50LmVuZCA9IGVuZDsKCQlldmVudC5hbGxEYXkgPSBhbGxEYXk7CgkJbm9ybWFsaXplRXZlbnREYXRlUHJvcHMoZXZlbnQpOwoJCWJhY2t1cEV2ZW50RGF0ZXMoZXZlbnQpOwoJfQoKCgkvLyBFbnN1cmVzIHRoZSBhbGxEYXkgcHJvcGVydHkgZXhpc3RzLgoJLy8gRW5zdXJlcyB0aGUgc3RhcnQvZW5kIGRhdGVzIGFyZSBjb25zaXN0ZW50IHdpdGggYWxsRGF5IGFuZCBmb3JjZUV2ZW50RHVyYXRpb24uCgkvLyBBY2NlcHRzIGFuIEV2ZW50IG9iamVjdCwgb3IgYSBwbGFpbiBvYmplY3Qgd2l0aCBldmVudC1pc2ggcHJvcGVydGllcy4KCS8vIE5PVEU6IFdpbGwgbW9kaWZ5IHRoZSBnaXZlbiBvYmplY3QuCglmdW5jdGlvbiBub3JtYWxpemVFdmVudERhdGVQcm9wcyhwcm9wcykgewoKCQlpZiAocHJvcHMuYWxsRGF5ID09IG51bGwpIHsKCQkJcHJvcHMuYWxsRGF5ID0gIShwcm9wcy5zdGFydC5oYXNUaW1lKCkgfHwgKHByb3BzLmVuZCAmJiBwcm9wcy5lbmQuaGFzVGltZSgpKSk7CgkJfQoKCQlpZiAocHJvcHMuYWxsRGF5KSB7CgkJCXByb3BzLnN0YXJ0LnN0cmlwVGltZSgpOwoJCQlpZiAocHJvcHMuZW5kKSB7CgkJCQlwcm9wcy5lbmQuc3RyaXBUaW1lKCk7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCWlmICghcHJvcHMuc3RhcnQuaGFzVGltZSgpKSB7CgkJCQlwcm9wcy5zdGFydCA9IHQucmV6b25lRGF0ZShwcm9wcy5zdGFydCk7IC8vIHdpbGwgYWxzbyBnaXZlIGl0IGEgMDA6MDAgdGltZQoJCQl9CgkJCWlmIChwcm9wcy5lbmQgJiYgIXByb3BzLmVuZC5oYXNUaW1lKCkpIHsKCQkJCXByb3BzLmVuZCA9IHQucmV6b25lRGF0ZShwcm9wcy5lbmQpOyAvLyB3aWxsIGFsc28gZ2l2ZSBpdCBhIDAwOjAwIHRpbWUKCQkJfQoJCX0KCgkJaWYgKHByb3BzLmVuZCAmJiAhcHJvcHMuZW5kLmlzQWZ0ZXIocHJvcHMuc3RhcnQpKSB7CgkJCXByb3BzLmVuZCA9IG51bGw7CgkJfQoKCQlpZiAoIXByb3BzLmVuZCkgewoJCQlpZiAob3B0aW9ucy5mb3JjZUV2ZW50RHVyYXRpb24pIHsKCQkJCXByb3BzLmVuZCA9IHQuZ2V0RGVmYXVsdEV2ZW50RW5kKHByb3BzLmFsbERheSwgcHJvcHMuc3RhcnQpOwoJCQl9CgkJCWVsc2UgewoJCQkJcHJvcHMuZW5kID0gbnVsbDsKCQkJfQoJCX0KCX0KCgoJLy8gSWYgYHJhbmdlYCBpcyBhIHByb3BlciByYW5nZSB3aXRoIGEgc3RhcnQgYW5kIGVuZCwgcmV0dXJucyB0aGUgb3JpZ2luYWwgb2JqZWN0LgoJLy8gSWYgbWlzc2luZyBhbiBlbmQsIGNvbXB1dGVzIGEgbmV3IHJhbmdlIHdpdGggYW4gZW5kLCBjb21wdXRpbmcgaXQgYXMgaWYgaXQgd2VyZSBhbiBldmVudC4KCS8vIFRPRE86IG1ha2UgdGhpcyBhIHBhcnQgb2YgdGhlIGV2ZW50IC0+IGV2ZW50UmFuZ2Ugc3lzdGVtCglmdW5jdGlvbiBlbnN1cmVWaXNpYmxlRXZlbnRSYW5nZShyYW5nZSkgewoJCXZhciBhbGxEYXk7CgoJCWlmICghcmFuZ2UuZW5kKSB7CgoJCQlhbGxEYXkgPSByYW5nZS5hbGxEYXk7IC8vIHJhbmdlIG1pZ2h0IGJlIG1vcmUgZXZlbnQtaXNoIHRoYW4gd2UgdGhpbmsKCQkJaWYgKGFsbERheSA9PSBudWxsKSB7CgkJCQlhbGxEYXkgPSAhcmFuZ2Uuc3RhcnQuaGFzVGltZSgpOwoJCQl9CgoJCQlyYW5nZSA9IHsKCQkJCXN0YXJ0OiByYW5nZS5zdGFydCwKCQkJCWVuZDogdC5nZXREZWZhdWx0RXZlbnRFbmQoYWxsRGF5LCByYW5nZS5zdGFydCkKCQkJfTsKCQl9CgkJcmV0dXJuIHJhbmdlOwoJfQoKCgkvLyBJZiB0aGUgZ2l2ZW4gZXZlbnQgaXMgYSByZWN1cnJpbmcgZXZlbnQsIGJyZWFrIGl0IGRvd24gaW50byBhbiBhcnJheSBvZiBpbmRpdmlkdWFsIGluc3RhbmNlcy4KCS8vIElmIG5vdCBhIHJlY3VycmluZyBldmVudCwgcmV0dXJuIGFuIGFycmF5IHdpdGggdGhlIHNpbmdsZSBvcmlnaW5hbCBldmVudC4KCS8vIElmIGdpdmVuIGEgZmFsc3kgaW5wdXQgKHByb2JhYmx5IGJlY2F1c2Ugb2YgYSBmYWlsZWQgYnVpbGRFdmVudEZyb21JbnB1dCBjYWxsKSwgcmV0dXJucyBhbiBlbXB0eSBhcnJheS4KCS8vIEhBQ0s6IGNhbiBvdmVycmlkZSB0aGUgcmVjdXJyaW5nIHdpbmRvdyBieSBwcm92aWRpbmcgY3VzdG9tIHJhbmdlU3RhcnQvcmFuZ2VFbmQgKGZvciBidXNpbmVzc0hvdXJzKS4KCWZ1bmN0aW9uIGV4cGFuZEV2ZW50KGFic3RyYWN0RXZlbnQsIF9yYW5nZVN0YXJ0LCBfcmFuZ2VFbmQpIHsKCQl2YXIgZXZlbnRzID0gW107CgkJdmFyIGRvd0hhc2g7CgkJdmFyIGRvdzsKCQl2YXIgaTsKCQl2YXIgZGF0ZTsKCQl2YXIgc3RhcnRUaW1lLCBlbmRUaW1lOwoJCXZhciBzdGFydCwgZW5kOwoJCXZhciBldmVudDsKCgkJX3JhbmdlU3RhcnQgPSBfcmFuZ2VTdGFydCB8fCByYW5nZVN0YXJ0OwoJCV9yYW5nZUVuZCA9IF9yYW5nZUVuZCB8fCByYW5nZUVuZDsKCgkJaWYgKGFic3RyYWN0RXZlbnQpIHsKCQkJaWYgKGFic3RyYWN0RXZlbnQuX3JlY3VycmluZykgewoKCQkJCS8vIG1ha2UgYSBib29sZWFuIGhhc2ggYXMgdG8gd2hldGhlciB0aGUgZXZlbnQgb2NjdXJzIG9uIGVhY2ggZGF5LW9mLXdlZWsKCQkJCWlmICgoZG93ID0gYWJzdHJhY3RFdmVudC5kb3cpKSB7CgkJCQkJZG93SGFzaCA9IHt9OwoJCQkJCWZvciAoaSA9IDA7IGkgPCBkb3cubGVuZ3RoOyBpKyspIHsKCQkJCQkJZG93SGFzaFtkb3dbaV1dID0gdHJ1ZTsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gaXRlcmF0ZSB0aHJvdWdoIGV2ZXJ5IGRheSBpbiB0aGUgY3VycmVudCByYW5nZQoJCQkJZGF0ZSA9IF9yYW5nZVN0YXJ0LmNsb25lKCkuc3RyaXBUaW1lKCk7IC8vIGhvbGRzIHRoZSBkYXRlIG9mIHRoZSBjdXJyZW50IGRheQoJCQkJd2hpbGUgKGRhdGUuaXNCZWZvcmUoX3JhbmdlRW5kKSkgewoKCQkJCQlpZiAoIWRvd0hhc2ggfHwgZG93SGFzaFtkYXRlLmRheSgpXSkgeyAvLyBpZiBldmVyeWRheSwgb3IgdGhpcyBwYXJ0aWN1bGFyIGRheS1vZi13ZWVrCgoJCQkJCQlzdGFydFRpbWUgPSBhYnN0cmFjdEV2ZW50LnN0YXJ0OyAvLyB0aGUgc3RvcmVkIHN0YXJ0IGFuZCBlbmQgcHJvcGVydGllcyBhcmUgdGltZXMgKER1cmF0aW9ucykKCQkJCQkJZW5kVGltZSA9IGFic3RyYWN0RXZlbnQuZW5kOyAvLyAiCgkJCQkJCXN0YXJ0ID0gZGF0ZS5jbG9uZSgpOwoJCQkJCQllbmQgPSBudWxsOwoKCQkJCQkJaWYgKHN0YXJ0VGltZSkgewoJCQkJCQkJc3RhcnQgPSBzdGFydC50aW1lKHN0YXJ0VGltZSk7CgkJCQkJCX0KCQkJCQkJaWYgKGVuZFRpbWUpIHsKCQkJCQkJCWVuZCA9IGRhdGUuY2xvbmUoKS50aW1lKGVuZFRpbWUpOwoJCQkJCQl9CgoJCQkJCQlldmVudCA9ICQuZXh0ZW5kKHt9LCBhYnN0cmFjdEV2ZW50KTsgLy8gbWFrZSBhIGNvcHkgb2YgdGhlIG9yaWdpbmFsCgkJCQkJCWFzc2lnbkRhdGVzVG9FdmVudCgKCQkJCQkJCXN0YXJ0LCBlbmQsCgkJCQkJCQkhc3RhcnRUaW1lICYmICFlbmRUaW1lLCAvLyBhbGxEYXk\/CgkJCQkJCQlldmVudAoJCQkJCQkpOwoJCQkJCQlldmVudHMucHVzaChldmVudCk7CgkJCQkJfQoKCQkJCQlkYXRlLmFkZCgxLCAnZGF5cycpOwoJCQkJfQoJCQl9CgkJCWVsc2UgewoJCQkJZXZlbnRzLnB1c2goYWJzdHJhY3RFdmVudCk7IC8vIHJldHVybiB0aGUgb3JpZ2luYWwgZXZlbnQuIHdpbGwgYmUgYSBvbmUtaXRlbSBhcnJheQoJCQl9CgkJfQoKCQlyZXR1cm4gZXZlbnRzOwoJfQoKCgoJLyogRXZlbnQgTW9kaWZpY2F0aW9uIE1hdGgKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gTW9kaWZpZXMgYW4gZXZlbnQgYW5kIGFsbCByZWxhdGVkIGV2ZW50cyBieSBhcHBseWluZyB0aGUgZ2l2ZW4gcHJvcGVydGllcy4KCS8vIFNwZWNpYWwgZGF0ZS1kaWZmaW5nIGxvZ2ljIGlzIHVzZWQgZm9yIG1hbmlwdWxhdGlvbiBvZiBkYXRlcy4KCS8vIElmIGBwcm9wc2AgZG9lcyBub3QgY29udGFpbiBzdGFydC9lbmQgZGF0ZXMsIHRoZSB1cGRhdGVkIHZhbHVlcyBhcmUgYXNzdW1lZCB0byBiZSB0aGUgZXZlbnQncyBjdXJyZW50IHN0YXJ0L2VuZC4KCS8vIEFsbCBkYXRlIGNvbXBhcmlzb25zIGFyZSBkb25lIGFnYWluc3QgdGhlIGV2ZW50J3MgcHJpc3RpbmUgX3N0YXJ0IGFuZCBfZW5kIGRhdGVzLgoJLy8gUmV0dXJucyBhbiBvYmplY3Qgd2l0aCBkZWx0YSBpbmZvcm1hdGlvbiBhbmQgYSBmdW5jdGlvbiB0byB1bmRvIGFsbCBvcGVyYXRpb25zLgoJLy8KCWZ1bmN0aW9uIG11dGF0ZUV2ZW50KGV2ZW50LCBwcm9wcykgewoJCXZhciBtaXNjUHJvcHMgPSB7fTsKCQl2YXIgY2xlYXJFbmQ7CgkJdmFyIGRhdGVEZWx0YTsKCQl2YXIgZHVyYXRpb25EZWx0YTsKCQl2YXIgdW5kb0Z1bmM7CgoJCXByb3BzID0gcHJvcHMgfHwge307CgoJCS8vIGVuc3VyZSBuZXcgZGF0ZS1yZWxhdGVkIHZhbHVlcyB0byBjb21wYXJlIGFnYWluc3QKCQlpZiAoIXByb3BzLnN0YXJ0KSB7CgkJCXByb3BzLnN0YXJ0ID0gZXZlbnQuc3RhcnQuY2xvbmUoKTsKCQl9CgkJaWYgKHByb3BzLmVuZCA9PT0gdW5kZWZpbmVkKSB7CgkJCXByb3BzLmVuZCA9IGV2ZW50LmVuZCA\/IGV2ZW50LmVuZC5jbG9uZSgpIDogbnVsbDsKCQl9CgkJaWYgKHByb3BzLmFsbERheSA9PSBudWxsKSB7IC8vIGlzIG51bGwgb3IgdW5kZWZpbmVkPwoJCQlwcm9wcy5hbGxEYXkgPSBldmVudC5hbGxEYXk7CgkJfQoKCQlub3JtYWxpemVFdmVudERhdGVQcm9wcyhwcm9wcyk7IC8vIG1hc3NhZ2VzIHN0YXJ0L2VuZC9hbGxEYXkKCgkJLy8gY2xlYXIgdGhlIGVuZCBkYXRlIGlmIGV4cGxpY2l0bHkgY2hhbmdlZCB0byBudWxsCgkJY2xlYXJFbmQgPSBldmVudC5fZW5kICE9PSBudWxsICYmIHByb3BzLmVuZCA9PT0gbnVsbDsKCgkJLy8gY29tcHV0ZSB0aGUgZGVsdGEgZm9yIG1vdmluZyB0aGUgc3RhcnQgYW5kIGVuZCBkYXRlcyB0b2dldGhlcgoJCWlmIChwcm9wcy5hbGxEYXkpIHsKCQkJZGF0ZURlbHRhID0gZGlmZkRheShwcm9wcy5zdGFydCwgZXZlbnQuX3N0YXJ0KTsgLy8gd2hvbGUtZGF5IGRpZmYgZnJvbSBzdGFydC1vZi1kYXkKCQl9CgkJZWxzZSB7CgkJCWRhdGVEZWx0YSA9IGRpZmZEYXlUaW1lKHByb3BzLnN0YXJ0LCBldmVudC5fc3RhcnQpOwoJCX0KCgkJLy8gY29tcHV0ZSB0aGUgZGVsdGEgZm9yIG1vdmluZyB0aGUgZW5kIGRhdGUgKGFmdGVyIGFwcGx5aW5nIGRhdGVEZWx0YSkKCQlpZiAoIWNsZWFyRW5kICYmIHByb3BzLmVuZCkgewoJCQlkdXJhdGlvbkRlbHRhID0gZGlmZkRheVRpbWUoCgkJCQkvLyBuZXcgZHVyYXRpb24KCQkJCXByb3BzLmVuZCwKCQkJCXByb3BzLnN0YXJ0CgkJCSkuc3VidHJhY3QoZGlmZkRheVRpbWUoCgkJCQkvLyBzdWJ0cmFjdCBvbGQgZHVyYXRpb24KCQkJCWV2ZW50Ll9lbmQgfHwgdC5nZXREZWZhdWx0RXZlbnRFbmQoZXZlbnQuX2FsbERheSwgZXZlbnQuX3N0YXJ0KSwKCQkJCWV2ZW50Ll9zdGFydAoJCQkpKTsKCQl9CgoJCS8vIGdhdGhlciBhbGwgbm9uLWRhdGUtcmVsYXRlZCBwcm9wZXJ0aWVzCgkJJC5lYWNoKHByb3BzLCBmdW5jdGlvbihuYW1lLCB2YWwpIHsKCQkJaWYgKGlzTWlzY0V2ZW50UHJvcE5hbWUobmFtZSkpIHsKCQkJCWlmICh2YWwgIT09IHVuZGVmaW5lZCkgewoJCQkJCW1pc2NQcm9wc1tuYW1lXSA9IHZhbDsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvLyBhcHBseSB0aGUgb3BlcmF0aW9ucyB0byB0aGUgZXZlbnQgYW5kIGFsbCByZWxhdGVkIGV2ZW50cwoJCXVuZG9GdW5jID0gbXV0YXRlRXZlbnRzKAoJCQljbGllbnRFdmVudHMoZXZlbnQuX2lkKSwgLy8gZ2V0IGV2ZW50cyB3aXRoIHRoaXMgSUQKCQkJY2xlYXJFbmQsCgkJCXByb3BzLmFsbERheSwKCQkJZGF0ZURlbHRhLAoJCQlkdXJhdGlvbkRlbHRhLAoJCQltaXNjUHJvcHMKCQkpOwoKCQlyZXR1cm4gewoJCQlkYXRlRGVsdGE6IGRhdGVEZWx0YSwKCQkJZHVyYXRpb25EZWx0YTogZHVyYXRpb25EZWx0YSwKCQkJdW5kbzogdW5kb0Z1bmMKCQl9OwoJfQoKCgkvLyBNb2RpZmllcyBhbiBhcnJheSBvZiBldmVudHMgaW4gdGhlIGZvbGxvd2luZyB3YXlzIChvcGVyYXRpb25zIGFyZSBpbiBvcmRlcik6CgkvLyAtIGNsZWFyIHRoZSBldmVudCdzIGBlbmRgCgkvLyAtIGNvbnZlcnQgdGhlIGV2ZW50IHRvIGFsbERheQoJLy8gLSBhZGQgYGRhdGVEZWx0YWAgdG8gdGhlIHN0YXJ0IGFuZCBlbmQKCS8vIC0gYWRkIGBkdXJhdGlvbkRlbHRhYCB0byB0aGUgZXZlbnQncyBkdXJhdGlvbgoJLy8gLSBhc3NpZ24gYG1pc2NQcm9wc2AgdG8gdGhlIGV2ZW50CgkvLwoJLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGNhbGxlZCB0byB1bmRvIGFsbCB0aGUgb3BlcmF0aW9ucy4KCS8vCgkvLyBUT0RPOiBkb24ndCB1c2Ugc28gbWFueSBjbG9zdXJlcy4gcG9zc2libGUgbWVtb3J5IGlzc3VlcyB3aGVuIGxvdHMgb2YgZXZlbnRzIHdpdGggc2FtZSBJRC4KCS8vCglmdW5jdGlvbiBtdXRhdGVFdmVudHMoZXZlbnRzLCBjbGVhckVuZCwgYWxsRGF5LCBkYXRlRGVsdGEsIGR1cmF0aW9uRGVsdGEsIG1pc2NQcm9wcykgewoJCXZhciBpc0FtYmlnVGltZXpvbmUgPSB0LmdldElzQW1iaWdUaW1lem9uZSgpOwoJCXZhciB1bmRvRnVuY3Rpb25zID0gW107CgoJCS8vIG5vcm1hbGl6ZSB6ZXJvLWxlbmd0aCBkZWx0YXMgdG8gYmUgbnVsbAoJCWlmIChkYXRlRGVsdGEgJiYgIWRhdGVEZWx0YS52YWx1ZU9mKCkpIHsgZGF0ZURlbHRhID0gbnVsbDsgfQoJCWlmIChkdXJhdGlvbkRlbHRhICYmICFkdXJhdGlvbkRlbHRhLnZhbHVlT2YoKSkgeyBkdXJhdGlvbkRlbHRhID0gbnVsbDsgfQoKCQkkLmVhY2goZXZlbnRzLCBmdW5jdGlvbihpLCBldmVudCkgewoJCQl2YXIgb2xkUHJvcHM7CgkJCXZhciBuZXdQcm9wczsKCgkJCS8vIGJ1aWxkIGFuIG9iamVjdCBob2xkaW5nIGFsbCB0aGUgb2xkIHZhbHVlcywgYm90aCBkYXRlLXJlbGF0ZWQgYW5kIG1pc2MuCgkJCS8vIGZvciB0aGUgdW5kbyBmdW5jdGlvbi4KCQkJb2xkUHJvcHMgPSB7CgkJCQlzdGFydDogZXZlbnQuc3RhcnQuY2xvbmUoKSwKCQkJCWVuZDogZXZlbnQuZW5kID8gZXZlbnQuZW5kLmNsb25lKCkgOiBudWxsLAoJCQkJYWxsRGF5OiBldmVudC5hbGxEYXkKCQkJfTsKCQkJJC5lYWNoKG1pc2NQcm9wcywgZnVuY3Rpb24obmFtZSkgewoJCQkJb2xkUHJvcHNbbmFtZV0gPSBldmVudFtuYW1lXTsKCQkJfSk7CgoJCQkvLyBuZXcgZGF0ZS1yZWxhdGVkIHByb3BlcnRpZXMuIHdvcmsgb2ZmIHRoZSBvcmlnaW5hbCBkYXRlIHNuYXBzaG90LgoJCQkvLyBvayB0byB1c2UgcmVmZXJlbmNlcyBiZWNhdXNlIHRoZXkgd2lsbCBiZSB0aHJvd24gYXdheSB3aGVuIGJhY2t1cEV2ZW50RGF0ZXMgaXMgY2FsbGVkLgoJCQluZXdQcm9wcyA9IHsKCQkJCXN0YXJ0OiBldmVudC5fc3RhcnQsCgkJCQllbmQ6IGV2ZW50Ll9lbmQsCgkJCQlhbGxEYXk6IGV2ZW50Ll9hbGxEYXkKCQkJfTsKCgkJCWlmIChjbGVhckVuZCkgewoJCQkJbmV3UHJvcHMuZW5kID0gbnVsbDsKCQkJfQoKCQkJbmV3UHJvcHMuYWxsRGF5ID0gYWxsRGF5OwoKCQkJbm9ybWFsaXplRXZlbnREYXRlUHJvcHMobmV3UHJvcHMpOyAvLyBtYXNzYWdlcyBzdGFydC9lbmQvYWxsRGF5CgoJCQlpZiAoZGF0ZURlbHRhKSB7CgkJCQluZXdQcm9wcy5zdGFydC5hZGQoZGF0ZURlbHRhKTsKCQkJCWlmIChuZXdQcm9wcy5lbmQpIHsKCQkJCQluZXdQcm9wcy5lbmQuYWRkKGRhdGVEZWx0YSk7CgkJCQl9CgkJCX0KCgkJCWlmIChkdXJhdGlvbkRlbHRhKSB7CgkJCQlpZiAoIW5ld1Byb3BzLmVuZCkgewoJCQkJCW5ld1Byb3BzLmVuZCA9IHQuZ2V0RGVmYXVsdEV2ZW50RW5kKG5ld1Byb3BzLmFsbERheSwgbmV3UHJvcHMuc3RhcnQpOwoJCQkJfQoJCQkJbmV3UHJvcHMuZW5kLmFkZChkdXJhdGlvbkRlbHRhKTsKCQkJfQoKCQkJLy8gaWYgdGhlIGRhdGVzIGhhdmUgY2hhbmdlZCwgYW5kIHdlIGtub3cgaXQgaXMgaW1wb3NzaWJsZSB0byByZWNvbXB1dGUgdGhlCgkJCS8vIHRpbWV6b25lIG9mZnNldHMsIHN0cmlwIHRoZSB6b25lLgoJCQlpZiAoCgkJCQlpc0FtYmlnVGltZXpvbmUgJiYKCQkJCSFuZXdQcm9wcy5hbGxEYXkgJiYKCQkJCShkYXRlRGVsdGEgfHwgZHVyYXRpb25EZWx0YSkKCQkJKSB7CgkJCQluZXdQcm9wcy5zdGFydC5zdHJpcFpvbmUoKTsKCQkJCWlmIChuZXdQcm9wcy5lbmQpIHsKCQkJCQluZXdQcm9wcy5lbmQuc3RyaXBab25lKCk7CgkJCQl9CgkJCX0KCgkJCSQuZXh0ZW5kKGV2ZW50LCBtaXNjUHJvcHMsIG5ld1Byb3BzKTsgLy8gY29weSBvdmVyIG1pc2MgcHJvcHMsIHRoZW4gZGF0ZS1yZWxhdGVkIHByb3BzCgkJCWJhY2t1cEV2ZW50RGF0ZXMoZXZlbnQpOyAvLyByZWdlbmVyYXRlIGludGVybmFsIF9zdGFydC9fZW5kL19hbGxEYXkKCgkJCXVuZG9GdW5jdGlvbnMucHVzaChmdW5jdGlvbigpIHsKCQkJCSQuZXh0ZW5kKGV2ZW50LCBvbGRQcm9wcyk7CgkJCQliYWNrdXBFdmVudERhdGVzKGV2ZW50KTsgLy8gcmVnZW5lcmF0ZSBpbnRlcm5hbCBfc3RhcnQvX2VuZC9fYWxsRGF5CgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdW5kb0Z1bmN0aW9ucy5sZW5ndGg7IGkrKykgewoJCQkJdW5kb0Z1bmN0aW9uc1tpXSgpOwoJCQl9CgkJfTsKCX0KCgoJLyogQnVzaW5lc3MgSG91cnMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgl0LmdldEJ1c2luZXNzSG91cnNFdmVudHMgPSBnZXRCdXNpbmVzc0hvdXJzRXZlbnRzOwoKCgkvLyBSZXR1cm5zIGFuIGFycmF5IG9mIGV2ZW50cyBhcyB0byB3aGVuIHRoZSBidXNpbmVzcyBob3VycyBvY2N1ciBpbiB0aGUgZ2l2ZW4gdmlldy4KCS8vIEFidXNlIG9mIG91ciBldmVudCBzeXN0ZW0gOigKCWZ1bmN0aW9uIGdldEJ1c2luZXNzSG91cnNFdmVudHMoKSB7CgkJdmFyIG9wdGlvblZhbCA9IG9wdGlvbnMuYnVzaW5lc3NIb3VyczsKCQl2YXIgZGVmYXVsdFZhbCA9IHsKCQkJY2xhc3NOYW1lOiAnZmMtbm9uYnVzaW5lc3MnLAoJCQlzdGFydDogJzA5OjAwJywKCQkJZW5kOiAnMTc6MDAnLAoJCQlkb3c6IFsgMSwgMiwgMywgNCwgNSBdLCAvLyBtb25kYXkgLSBmcmlkYXkKCQkJcmVuZGVyaW5nOiAnaW52ZXJzZS1iYWNrZ3JvdW5kJwoJCX07CgkJdmFyIHZpZXcgPSB0LmdldFZpZXcoKTsKCQl2YXIgZXZlbnRJbnB1dDsKCgkJaWYgKG9wdGlvblZhbCkgewoJCQlpZiAodHlwZW9mIG9wdGlvblZhbCA9PT0gJ29iamVjdCcpIHsKCQkJCS8vIG9wdGlvbiB2YWx1ZSBpcyBhbiBvYmplY3QgdGhhdCBjYW4gb3ZlcnJpZGUgdGhlIGRlZmF1bHQgYnVzaW5lc3MgaG91cnMKCQkJCWV2ZW50SW5wdXQgPSAkLmV4dGVuZCh7fSwgZGVmYXVsdFZhbCwgb3B0aW9uVmFsKTsKCQkJfQoJCQllbHNlIHsKCQkJCS8vIG9wdGlvbiB2YWx1ZSBpcyBgdHJ1ZWAuIHVzZSBkZWZhdWx0IGJ1c2luZXNzIGhvdXJzCgkJCQlldmVudElucHV0ID0gZGVmYXVsdFZhbDsKCQkJfQoJCX0KCgkJaWYgKGV2ZW50SW5wdXQpIHsKCQkJcmV0dXJuIGV4cGFuZEV2ZW50KAoJCQkJYnVpbGRFdmVudEZyb21JbnB1dChldmVudElucHV0KSwKCQkJCXZpZXcuc3RhcnQsCgkJCQl2aWV3LmVuZAoJCQkpOwoJCX0KCgkJcmV0dXJuIFtdOwoJfQoKCgkvKiBPdmVybGFwcGluZyAvIENvbnN0cmFpbmluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCXQuaXNFdmVudFJhbmdlQWxsb3dlZCA9IGlzRXZlbnRSYW5nZUFsbG93ZWQ7Cgl0LmlzU2VsZWN0aW9uUmFuZ2VBbGxvd2VkID0gaXNTZWxlY3Rpb25SYW5nZUFsbG93ZWQ7Cgl0LmlzRXh0ZXJuYWxEcm9wUmFuZ2VBbGxvd2VkID0gaXNFeHRlcm5hbERyb3BSYW5nZUFsbG93ZWQ7CgoKCWZ1bmN0aW9uIGlzRXZlbnRSYW5nZUFsbG93ZWQocmFuZ2UsIGV2ZW50KSB7CgkJdmFyIHNvdXJjZSA9IGV2ZW50LnNvdXJjZSB8fCB7fTsKCQl2YXIgY29uc3RyYWludCA9IGZpcnN0RGVmaW5lZCgKCQkJZXZlbnQuY29uc3RyYWludCwKCQkJc291cmNlLmNvbnN0cmFpbnQsCgkJCW9wdGlvbnMuZXZlbnRDb25zdHJhaW50CgkJKTsKCQl2YXIgb3ZlcmxhcCA9IGZpcnN0RGVmaW5lZCgKCQkJZXZlbnQub3ZlcmxhcCwKCQkJc291cmNlLm92ZXJsYXAsCgkJCW9wdGlvbnMuZXZlbnRPdmVybGFwCgkJKTsKCgkJcmFuZ2UgPSBlbnN1cmVWaXNpYmxlRXZlbnRSYW5nZShyYW5nZSk7IC8vIGVuc3VyZSBhIHByb3BlciByYW5nZSB3aXRoIGFuIGVuZCBmb3IgaXNSYW5nZUFsbG93ZWQKCgkJcmV0dXJuIGlzUmFuZ2VBbGxvd2VkKHJhbmdlLCBjb25zdHJhaW50LCBvdmVybGFwLCBldmVudCk7Cgl9CgoKCWZ1bmN0aW9uIGlzU2VsZWN0aW9uUmFuZ2VBbGxvd2VkKHJhbmdlKSB7CgkJcmV0dXJuIGlzUmFuZ2VBbGxvd2VkKHJhbmdlLCBvcHRpb25zLnNlbGVjdENvbnN0cmFpbnQsIG9wdGlvbnMuc2VsZWN0T3ZlcmxhcCk7Cgl9CgoKCS8vIHdoZW4gYGV2ZW50UHJvcHNgIGlzIGRlZmluZWQsIGNvbnNpZGVyIHRoaXMgYW4gZXZlbnQuCgkvLyBgZXZlbnRQcm9wc2AgY2FuIGNvbnRhaW4gbWlzYyBub24tZGF0ZS1yZWxhdGVkIGluZm8gYWJvdXQgdGhlIGV2ZW50LgoJZnVuY3Rpb24gaXNFeHRlcm5hbERyb3BSYW5nZUFsbG93ZWQocmFuZ2UsIGV2ZW50UHJvcHMpIHsKCQl2YXIgZXZlbnRJbnB1dDsKCQl2YXIgZXZlbnQ7CgoJCS8vIG5vdGU6IHZlcnkgc2ltaWxhciBsb2dpYyBpcyBpbiBWaWV3J3MgcmVwb3J0RXh0ZXJuYWxEcm9wCgkJaWYgKGV2ZW50UHJvcHMpIHsKCQkJZXZlbnRJbnB1dCA9ICQuZXh0ZW5kKHt9LCBldmVudFByb3BzLCByYW5nZSk7CgkJCWV2ZW50ID0gZXhwYW5kRXZlbnQoYnVpbGRFdmVudEZyb21JbnB1dChldmVudElucHV0KSlbMF07CgkJfQoKCQlpZiAoZXZlbnQpIHsKCQkJcmV0dXJuIGlzRXZlbnRSYW5nZUFsbG93ZWQocmFuZ2UsIGV2ZW50KTsKCQl9CgkJZWxzZSB7IC8vIHRyZWF0IGl0IGFzIGEgc2VsZWN0aW9uCgoJCQlyYW5nZSA9IGVuc3VyZVZpc2libGVFdmVudFJhbmdlKHJhbmdlKTsgLy8gZW5zdXJlIGEgcHJvcGVyIHJhbmdlIHdpdGggYW4gZW5kIGZvciBpc1NlbGVjdGlvblJhbmdlQWxsb3dlZAoKCQkJcmV0dXJuIGlzU2VsZWN0aW9uUmFuZ2VBbGxvd2VkKHJhbmdlKTsKCQl9Cgl9CgoKCS8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgZ2l2ZW4gcmFuZ2UgKGNhdXNlZCBieSBhbiBldmVudCBkcm9wL3Jlc2l6ZSBvciBhIHNlbGVjdGlvbikgaXMgYWxsb3dlZCB0byBleGlzdAoJLy8gYWNjb3JkaW5nIHRvIHRoZSBjb25zdHJhaW50L292ZXJsYXAgc2V0dGluZ3MuCgkvLyBgZXZlbnRgIGlzIG5vdCByZXF1aXJlZCBpZiBjaGVja2luZyBhIHNlbGVjdGlvbi4KCWZ1bmN0aW9uIGlzUmFuZ2VBbGxvd2VkKHJhbmdlLCBjb25zdHJhaW50LCBvdmVybGFwLCBldmVudCkgewoJCXZhciBjb25zdHJhaW50RXZlbnRzOwoJCXZhciBhbnlDb250YWlubWVudDsKCQl2YXIgaSwgb3RoZXJFdmVudDsKCQl2YXIgb3RoZXJPdmVybGFwOwoKCQkvLyBub3JtYWxpemUuIGZ5aSwgd2UncmUgbm9ybWFsaXppbmcgaW4gdG9vIG1hbnkgcGxhY2VzIDooCgkJcmFuZ2UgPSB7CgkJCXN0YXJ0OiByYW5nZS5zdGFydC5jbG9uZSgpLnN0cmlwWm9uZSgpLAoJCQllbmQ6IHJhbmdlLmVuZC5jbG9uZSgpLnN0cmlwWm9uZSgpCgkJfTsKCgkJLy8gdGhlIHJhbmdlIG11c3QgYmUgZnVsbHkgY29udGFpbmVkIGJ5IGF0IGxlYXN0IG9uZSBvZiBwcm9kdWNlZCBjb25zdHJhaW50IGV2ZW50cwoJCWlmIChjb25zdHJhaW50ICE9IG51bGwpIHsKCgkJCS8vIG5vdCB0cmVhdGVkIGFzIGFuIGV2ZW50ISBpbnRlcm1lZGlhdGUgZGF0YSBzdHJ1Y3R1cmUKCQkJLy8gVE9ETzogdXNlIHJhbmdlcyBpbiB0aGUgZnV0dXJlCgkJCWNvbnN0cmFpbnRFdmVudHMgPSBjb25zdHJhaW50VG9FdmVudHMoY29uc3RyYWludCk7CgoJCQlhbnlDb250YWlubWVudCA9IGZhbHNlOwoJCQlmb3IgKGkgPSAwOyBpIDwgY29uc3RyYWludEV2ZW50cy5sZW5ndGg7IGkrKykgewoJCQkJaWYgKGV2ZW50Q29udGFpbnNSYW5nZShjb25zdHJhaW50RXZlbnRzW2ldLCByYW5nZSkpIHsKCQkJCQlhbnlDb250YWlubWVudCA9IHRydWU7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCWlmICghYW55Q29udGFpbm1lbnQpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0KCgkJZm9yIChpID0gMDsgaSA8IGNhY2hlLmxlbmd0aDsgaSsrKSB7IC8vIGxvb3AgYWxsIGV2ZW50cyBhbmQgZGV0ZWN0IG92ZXJsYXAKCQkJb3RoZXJFdmVudCA9IGNhY2hlW2ldOwoKCQkJLy8gZG9uJ3QgY29tcGFyZSB0aGUgZXZlbnQgdG8gaXRzZWxmIG9yIG90aGVyIHJlbGF0ZWQgW3JlcGVhdGluZ10gZXZlbnRzCgkJCWlmIChldmVudCAmJiBldmVudC5faWQgPT09IG90aGVyRXZlbnQuX2lkKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gdGhlcmUgbmVlZHMgdG8gYmUgYW4gYWN0dWFsIGludGVyc2VjdGlvbiBiZWZvcmUgZGlzYWxsb3dpbmcgYW55dGhpbmcKCQkJaWYgKGV2ZW50SW50ZXJzZWN0c1JhbmdlKG90aGVyRXZlbnQsIHJhbmdlKSkgewoKCQkJCS8vIGV2YWx1YXRlIG92ZXJsYXAgZm9yIHRoZSBnaXZlbiByYW5nZSBhbmQgc2hvcnQtY2lyY3VpdCBpZiBuZWNlc3NhcnkKCQkJCWlmIChvdmVybGFwID09PSBmYWxzZSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJCWVsc2UgaWYgKHR5cGVvZiBvdmVybGFwID09PSAnZnVuY3Rpb24nICYmICFvdmVybGFwKG90aGVyRXZlbnQsIGV2ZW50KSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQkvLyBpZiB3ZSBhcmUgY29tcHV0aW5nIGlmIHRoZSBnaXZlbiByYW5nZSBpcyBhbGxvd2FibGUgZm9yIGFuIGV2ZW50LCBjb25zaWRlciB0aGUgb3RoZXIgZXZlbnQncwoJCQkJLy8gRXZlbnRPYmplY3Qtc3BlY2lmaWMgb3IgU291cmNlLXNwZWNpZmljIGBvdmVybGFwYCBwcm9wZXJ0eQoJCQkJaWYgKGV2ZW50KSB7CgkJCQkJb3RoZXJPdmVybGFwID0gZmlyc3REZWZpbmVkKAoJCQkJCQlvdGhlckV2ZW50Lm92ZXJsYXAsCgkJCQkJCShvdGhlckV2ZW50LnNvdXJjZSB8fCB7fSkub3ZlcmxhcAoJCQkJCQkvLyB3ZSBhbHJlYWR5IGNvbnNpZGVyZWQgdGhlIGdsb2JhbCBgZXZlbnRPdmVybGFwYAoJCQkJCSk7CgkJCQkJaWYgKG90aGVyT3ZlcmxhcCA9PT0gZmFsc2UpIHsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCQlpZiAodHlwZW9mIG90aGVyT3ZlcmxhcCA9PT0gJ2Z1bmN0aW9uJyAmJiAhb3RoZXJPdmVybGFwKGV2ZW50LCBvdGhlckV2ZW50KSkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCX0KCgoJLy8gR2l2ZW4gYW4gZXZlbnQgaW5wdXQgZnJvbSB0aGUgQVBJLCBwcm9kdWNlcyBhbiBhcnJheSBvZiBldmVudCBvYmplY3RzLiBQb3NzaWJsZSBldmVudCBpbnB1dHM6CgkvLyAnYnVzaW5lc3NIb3VycycKCS8vIEFuIGV2ZW50IElEIChudW1iZXIgb3Igc3RyaW5nKQoJLy8gQW4gb2JqZWN0IHdpdGggc3BlY2lmaWMgc3RhcnQvZW5kIGRhdGVzIG9yIGEgcmVjdXJyaW5nIGV2ZW50IChsaWtlIHdoYXQgYnVzaW5lc3NIb3VycyBhY2NlcHRzKQoJZnVuY3Rpb24gY29uc3RyYWludFRvRXZlbnRzKGNvbnN0cmFpbnRJbnB1dCkgewoKCQlpZiAoY29uc3RyYWludElucHV0ID09PSAnYnVzaW5lc3NIb3VycycpIHsKCQkJcmV0dXJuIGdldEJ1c2luZXNzSG91cnNFdmVudHMoKTsKCQl9CgoJCWlmICh0eXBlb2YgY29uc3RyYWludElucHV0ID09PSAnb2JqZWN0JykgewoJCQlyZXR1cm4gZXhwYW5kRXZlbnQoYnVpbGRFdmVudEZyb21JbnB1dChjb25zdHJhaW50SW5wdXQpKTsKCQl9CgoJCXJldHVybiBjbGllbnRFdmVudHMoY29uc3RyYWludElucHV0KTsgLy8gcHJvYmFibHkgYW4gSUQKCX0KCgoJLy8gRG9lcyB0aGUgZXZlbnQncyBkYXRlIHJhbmdlIGZ1bGx5IGNvbnRhaW4gdGhlIGdpdmVuIHJhbmdlPwoJLy8gc3RhcnQvZW5kIGFscmVhZHkgYXNzdW1lZCB0byBoYXZlIHN0cmlwcGVkIHpvbmVzIDooCglmdW5jdGlvbiBldmVudENvbnRhaW5zUmFuZ2UoZXZlbnQsIHJhbmdlKSB7CgkJdmFyIGV2ZW50U3RhcnQgPSBldmVudC5zdGFydC5jbG9uZSgpLnN0cmlwWm9uZSgpOwoJCXZhciBldmVudEVuZCA9IHQuZ2V0RXZlbnRFbmQoZXZlbnQpLnN0cmlwWm9uZSgpOwoKCQlyZXR1cm4gcmFuZ2Uuc3RhcnQgPj0gZXZlbnRTdGFydCAmJiByYW5nZS5lbmQgPD0gZXZlbnRFbmQ7Cgl9CgoKCS8vIERvZXMgdGhlIGV2ZW50J3MgZGF0ZSByYW5nZSBpbnRlcnNlY3Qgd2l0aCB0aGUgZ2l2ZW4gcmFuZ2U\/CgkvLyBzdGFydC9lbmQgYWxyZWFkeSBhc3N1bWVkIHRvIGhhdmUgc3RyaXBwZWQgem9uZXMgOigKCWZ1bmN0aW9uIGV2ZW50SW50ZXJzZWN0c1JhbmdlKGV2ZW50LCByYW5nZSkgewoJCXZhciBldmVudFN0YXJ0ID0gZXZlbnQuc3RhcnQuY2xvbmUoKS5zdHJpcFpvbmUoKTsKCQl2YXIgZXZlbnRFbmQgPSB0LmdldEV2ZW50RW5kKGV2ZW50KS5zdHJpcFpvbmUoKTsKCgkJcmV0dXJuIHJhbmdlLnN0YXJ0IDwgZXZlbnRFbmQgJiYgcmFuZ2UuZW5kID4gZXZlbnRTdGFydDsKCX0KCn0KCgovLyB1cGRhdGVzIHRoZSAiYmFja3VwIiBwcm9wZXJ0aWVzLCB3aGljaCBhcmUgcHJlc2VydmVkIGluIG9yZGVyIHRvIGNvbXB1dGUgZGlmZnMgbGF0ZXIgb24uCmZ1bmN0aW9uIGJhY2t1cEV2ZW50RGF0ZXMoZXZlbnQpIHsKCWV2ZW50Ll9hbGxEYXkgPSBldmVudC5hbGxEYXk7CglldmVudC5fc3RhcnQgPSBldmVudC5zdGFydC5jbG9uZSgpOwoJZXZlbnQuX2VuZCA9IGV2ZW50LmVuZCA\/IGV2ZW50LmVuZC5jbG9uZSgpIDogbnVsbDsKfQoKOzsKCi8qIEFuIGFic3RyYWN0IGNsYXNzIGZvciB0aGUgImJhc2ljIiB2aWV3cywgYXMgd2VsbCBhcyBtb250aCB2aWV3LiBSZW5kZXJzIG9uZSBvciBtb3JlIHJvd3Mgb2YgZGF5IGNlbGxzLgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KLy8gSXQgaXMgYSBtYW5hZ2VyIGZvciBhIERheUdyaWQgc3ViY29tcG9uZW50LCB3aGljaCBkb2VzIG1vc3Qgb2YgdGhlIGhlYXZ5IGxpZnRpbmcuCi8vIEl0IGlzIHJlc3BvbnNpYmxlIGZvciBtYW5hZ2luZyB3aWR0aC9oZWlnaHQuCgp2YXIgQmFzaWNWaWV3ID0gZmNWaWV3cy5iYXNpYyA9IFZpZXcuZXh0ZW5kKHsKCglkYXlHcmlkOiBudWxsLCAvLyB0aGUgbWFpbiBzdWJjb21wb25lbnQgdGhhdCBkb2VzIG1vc3Qgb2YgdGhlIGhlYXZ5IGxpZnRpbmcKCglkYXlOdW1iZXJzVmlzaWJsZTogZmFsc2UsIC8vIGRpc3BsYXkgZGF5IG51bWJlcnMgb24gZWFjaCBkYXkgY2VsbD8KCXdlZWtOdW1iZXJzVmlzaWJsZTogZmFsc2UsIC8vIGRpc3BsYXkgd2VlayBudW1iZXJzIGFsb25nIHRoZSBzaWRlPwoKCXdlZWtOdW1iZXJXaWR0aDogbnVsbCwgLy8gd2lkdGggb2YgYWxsIHRoZSB3ZWVrLW51bWJlciBjZWxscyBydW5uaW5nIGRvd24gdGhlIHNpZGUKCgloZWFkUm93RWw6IG51bGwsIC8vIHRoZSBmYWtlIHJvdyBlbGVtZW50IG9mIHRoZSBkYXktb2Ytd2VlayBoZWFkZXIKCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5kYXlHcmlkID0gbmV3IERheUdyaWQodGhpcyk7CgkJdGhpcy5jb29yZE1hcCA9IHRoaXMuZGF5R3JpZC5jb29yZE1hcDsgLy8gdGhlIHZpZXcncyBkYXRlLXRvLWNlbGwgbWFwcGluZyBpcyBpZGVudGljYWwgdG8gdGhlIHN1YmNvbXBvbmVudCdzCgl9LAoKCgkvLyBTZXRzIHRoZSBkaXNwbGF5IHJhbmdlIGFuZCBjb21wdXRlcyBhbGwgbmVjZXNzYXJ5IGRhdGVzCglzZXRSYW5nZTogZnVuY3Rpb24ocmFuZ2UpIHsKCQlWaWV3LnByb3RvdHlwZS5zZXRSYW5nZS5jYWxsKHRoaXMsIHJhbmdlKTsgLy8gY2FsbCB0aGUgc3VwZXItbWV0aG9kCgoJCXRoaXMuZGF5R3JpZC5icmVha09uV2Vla3MgPSAveWVhcnxtb250aHx3ZWVrLy50ZXN0KHRoaXMuaW50ZXJ2YWxVbml0KTsgLy8gZG8gYmVmb3JlIHNldFJhbmdlCgkJdGhpcy5kYXlHcmlkLnNldFJhbmdlKHJhbmdlKTsKCX0sCgoKCS8vIENvbXB1dGUgdGhlIHZhbHVlIHRvIGZlZWQgaW50byBzZXRSYW5nZS4gT3ZlcnJpZGVzIHN1cGVyY2xhc3MuCgljb21wdXRlUmFuZ2U6IGZ1bmN0aW9uKGRhdGUpIHsKCQl2YXIgcmFuZ2UgPSBWaWV3LnByb3RvdHlwZS5jb21wdXRlUmFuZ2UuY2FsbCh0aGlzLCBkYXRlKTsgLy8gZ2V0IHZhbHVlIGZyb20gdGhlIHN1cGVyLW1ldGhvZAoKCQkvLyB5ZWFyIGFuZCBtb250aCB2aWV3cyBzaG91bGQgYmUgYWxpZ25lZCB3aXRoIHdlZWtzLiB0aGlzIGlzIGFscmVhZHkgZG9uZSBmb3Igd2VlawoJCWlmICgveWVhcnxtb250aC8udGVzdChyYW5nZS5pbnRlcnZhbFVuaXQpKSB7CgkJCXJhbmdlLnN0YXJ0LnN0YXJ0T2YoJ3dlZWsnKTsKCQkJcmFuZ2Uuc3RhcnQgPSB0aGlzLnNraXBIaWRkZW5EYXlzKHJhbmdlLnN0YXJ0KTsKCgkJCS8vIG1ha2UgZW5kLW9mLXdlZWsgaWYgbm90IGFscmVhZHkKCQkJaWYgKHJhbmdlLmVuZC53ZWVrZGF5KCkpIHsKCQkJCXJhbmdlLmVuZC5hZGQoMSwgJ3dlZWsnKS5zdGFydE9mKCd3ZWVrJyk7CgkJCQlyYW5nZS5lbmQgPSB0aGlzLnNraXBIaWRkZW5EYXlzKHJhbmdlLmVuZCwgLTEsIHRydWUpOyAvLyBleGNsdXNpdmVseSBtb3ZlIGJhY2t3YXJkcwoJCQl9CgkJfQoKCQlyZXR1cm4gcmFuZ2U7Cgl9LAoKCgkvLyBSZW5kZXJzIHRoZSB2aWV3IGludG8gYHRoaXMuZWxgLCB3aGljaCBzaG91bGQgYWxyZWFkeSBiZSBhc3NpZ25lZAoJcmVuZGVyOiBmdW5jdGlvbigpIHsKCgkJdGhpcy5kYXlOdW1iZXJzVmlzaWJsZSA9IHRoaXMuZGF5R3JpZC5yb3dDbnQgPiAxOyAvLyBUT0RPOiBtYWtlIGdyaWQgcmVzcG9uc2libGUKCQl0aGlzLndlZWtOdW1iZXJzVmlzaWJsZSA9IHRoaXMub3B0KCd3ZWVrTnVtYmVycycpOwoJCXRoaXMuZGF5R3JpZC5udW1iZXJzVmlzaWJsZSA9IHRoaXMuZGF5TnVtYmVyc1Zpc2libGUgfHwgdGhpcy53ZWVrTnVtYmVyc1Zpc2libGU7CgoJCXRoaXMuZWwuYWRkQ2xhc3MoJ2ZjLWJhc2ljLXZpZXcnKS5odG1sKHRoaXMucmVuZGVySHRtbCgpKTsKCgkJdGhpcy5oZWFkUm93RWwgPSB0aGlzLmVsLmZpbmQoJ3RoZWFkIC5mYy1yb3cnKTsKCgkJdGhpcy5zY3JvbGxlckVsID0gdGhpcy5lbC5maW5kKCcuZmMtZGF5LWdyaWQtY29udGFpbmVyJyk7CgkJdGhpcy5kYXlHcmlkLmNvb3JkTWFwLmNvbnRhaW5lckVsID0gdGhpcy5zY3JvbGxlckVsOyAvLyBjb25zdHJhaW4gY2xpY2tzL2V0YyB0byB0aGUgZGltZW5zaW9ucyBvZiB0aGUgc2Nyb2xsZXIKCgkJdGhpcy5kYXlHcmlkLmVsID0gdGhpcy5lbC5maW5kKCcuZmMtZGF5LWdyaWQnKTsKCQl0aGlzLmRheUdyaWQucmVuZGVyKHRoaXMuaGFzUmlnaWRSb3dzKCkpOwoJfSwKCgoJLy8gTWFrZSBzdWJjb21wb25lbnRzIHJlYWR5IGZvciBjbGVhbnVwCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLmRheUdyaWQuZGVzdHJveSgpOwoJCVZpZXcucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsgLy8gY2FsbCB0aGUgc3VwZXItbWV0aG9kCgl9LAoKCgkvLyBCdWlsZHMgdGhlIEhUTUwgc2tlbGV0b24gZm9yIHRoZSB2aWV3LgoJLy8gVGhlIGRheS1ncmlkIGNvbXBvbmVudCB3aWxsIHJlbmRlciBpbnNpZGUgb2YgYSBjb250YWluZXIgZGVmaW5lZCBieSB0aGlzIEhUTUwuCglyZW5kZXJIdG1sOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJycgKwoJCQknPHRhYmxlPicgKwoJCQkJJzx0aGVhZD4nICsKCQkJCQknPHRyPicgKwoJCQkJCQknPHRkIGNsYXNzPSInICsgdGhpcy53aWRnZXRIZWFkZXJDbGFzcyArICciPicgKwoJCQkJCQkJdGhpcy5kYXlHcmlkLmhlYWRIdG1sKCkgKyAvLyByZW5kZXIgdGhlIGRheS1vZi13ZWVrIGhlYWRlcnMKCQkJCQkJJzwvdGQ+JyArCgkJCQkJJzwvdHI+JyArCgkJCQknPC90aGVhZD4nICsKCQkJCSc8dGJvZHk+JyArCgkJCQkJJzx0cj4nICsKCQkJCQkJJzx0ZCBjbGFzcz0iJyArIHRoaXMud2lkZ2V0Q29udGVudENsYXNzICsgJyI+JyArCgkJCQkJCQknPGRpdiBjbGFzcz0iZmMtZGF5LWdyaWQtY29udGFpbmVyIj4nICsKCQkJCQkJCQknPGRpdiBjbGFzcz0iZmMtZGF5LWdyaWQiLz4nICsKCQkJCQkJCSc8L2Rpdj4nICsKCQkJCQkJJzwvdGQ+JyArCgkJCQkJJzwvdHI+JyArCgkJCQknPC90Ym9keT4nICsKCQkJJzwvdGFibGU+JzsKCX0sCgoKCS8vIEdlbmVyYXRlcyB0aGUgSFRNTCB0aGF0IHdpbGwgZ28gYmVmb3JlIHRoZSBkYXktb2Ygd2VlayBoZWFkZXIgY2VsbHMuCgkvLyBRdWVyaWVkIGJ5IHRoZSBEYXlHcmlkIHN1YmNvbXBvbmVudCB3aGVuIGdlbmVyYXRpbmcgcm93cy4gT3JkZXJpbmcgZGVwZW5kcyBvbiBpc1JUTC4KCWhlYWRJbnRyb0h0bWw6IGZ1bmN0aW9uKCkgewoJCWlmICh0aGlzLndlZWtOdW1iZXJzVmlzaWJsZSkgewoJCQlyZXR1cm4gJycgKwoJCQkJJzx0aCBjbGFzcz0iZmMtd2Vlay1udW1iZXIgJyArIHRoaXMud2lkZ2V0SGVhZGVyQ2xhc3MgKyAnIiAnICsgdGhpcy53ZWVrTnVtYmVyU3R5bGVBdHRyKCkgKyAnPicgKwoJCQkJCSc8c3Bhbj4nICsgLy8gbmVlZGVkIGZvciBtYXRjaENlbGxXaWR0aHMKCQkJCQkJaHRtbEVzY2FwZSh0aGlzLm9wdCgnd2Vla051bWJlclRpdGxlJykpICsKCQkJCQknPC9zcGFuPicgKwoJCQkJJzwvdGg+JzsKCQl9Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgdGhlIEhUTUwgdGhhdCB3aWxsIGdvIGJlZm9yZSBjb250ZW50LXNrZWxldG9uIGNlbGxzIHRoYXQgZGlzcGxheSB0aGUgZGF5L3dlZWsgbnVtYmVycy4KCS8vIFF1ZXJpZWQgYnkgdGhlIERheUdyaWQgc3ViY29tcG9uZW50LiBPcmRlcmluZyBkZXBlbmRzIG9uIGlzUlRMLgoJbnVtYmVySW50cm9IdG1sOiBmdW5jdGlvbihyb3cpIHsKCQlpZiAodGhpcy53ZWVrTnVtYmVyc1Zpc2libGUpIHsKCQkJcmV0dXJuICcnICsKCQkJCSc8dGQgY2xhc3M9ImZjLXdlZWstbnVtYmVyIiAnICsgdGhpcy53ZWVrTnVtYmVyU3R5bGVBdHRyKCkgKyAnPicgKwoJCQkJCSc8c3Bhbj4nICsgLy8gbmVlZGVkIGZvciBtYXRjaENlbGxXaWR0aHMKCQkJCQkJdGhpcy5jYWxlbmRhci5jYWxjdWxhdGVXZWVrTnVtYmVyKHRoaXMuZGF5R3JpZC5nZXRDZWxsKHJvdywgMCkuc3RhcnQpICsKCQkJCQknPC9zcGFuPicgKwoJCQkJJzwvdGQ+JzsKCQl9Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgdGhlIEhUTUwgdGhhdCBnb2VzIGJlZm9yZSB0aGUgZGF5IGJnIGNlbGxzIGZvciBlYWNoIGRheS1yb3cuCgkvLyBRdWVyaWVkIGJ5IHRoZSBEYXlHcmlkIHN1YmNvbXBvbmVudC4gT3JkZXJpbmcgZGVwZW5kcyBvbiBpc1JUTC4KCWRheUludHJvSHRtbDogZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMud2Vla051bWJlcnNWaXNpYmxlKSB7CgkJCXJldHVybiAnPHRkIGNsYXNzPSJmYy13ZWVrLW51bWJlciAnICsgdGhpcy53aWRnZXRDb250ZW50Q2xhc3MgKyAnIiAnICsKCQkJCXRoaXMud2Vla051bWJlclN0eWxlQXR0cigpICsgJz48L3RkPic7CgkJfQoJfSwKCgoJLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgZ29lcyBiZWZvcmUgZXZlcnkgb3RoZXIgdHlwZSBvZiByb3cgZ2VuZXJhdGVkIGJ5IERheUdyaWQuIE9yZGVyaW5nIGRlcGVuZHMgb24gaXNSVEwuCgkvLyBBZmZlY3RzIGhlbHBlci1za2VsZXRvbiBhbmQgaGlnaGxpZ2h0LXNrZWxldG9uIHJvd3MuCglpbnRyb0h0bWw6IGZ1bmN0aW9uKCkgewoJCWlmICh0aGlzLndlZWtOdW1iZXJzVmlzaWJsZSkgewoJCQlyZXR1cm4gJzx0ZCBjbGFzcz0iZmMtd2Vlay1udW1iZXIiICcgKyB0aGlzLndlZWtOdW1iZXJTdHlsZUF0dHIoKSArICc+PC90ZD4nOwoJCX0KCX0sCgoKCS8vIEdlbmVyYXRlcyB0aGUgSFRNTCBmb3IgdGhlIDx0ZD5zIG9mIHRoZSAibnVtYmVyIiByb3cgaW4gdGhlIERheUdyaWQncyBjb250ZW50IHNrZWxldG9uLgoJLy8gVGhlIG51bWJlciByb3cgd2lsbCBvbmx5IGV4aXN0IGlmIGVpdGhlciBkYXkgbnVtYmVycyBvciB3ZWVrIG51bWJlcnMgYXJlIHR1cm5lZCBvbi4KCW51bWJlckNlbGxIdG1sOiBmdW5jdGlvbihjZWxsKSB7CgkJdmFyIGRhdGUgPSBjZWxsLnN0YXJ0OwoJCXZhciBjbGFzc2VzOwoKCQlpZiAoIXRoaXMuZGF5TnVtYmVyc1Zpc2libGUpIHsgLy8gaWYgdGhlcmUgYXJlIHdlZWsgbnVtYmVycyBidXQgbm90IGRheSBudW1iZXJzCgkJCXJldHVybiAnPHRkLz4nOyAvLyAgd2lsbCBjcmVhdGUgYW4gZW1wdHkgc3BhY2UgYWJvdmUgZXZlbnRzIDooCgkJfQoKCQljbGFzc2VzID0gdGhpcy5kYXlHcmlkLmdldERheUNsYXNzZXMoZGF0ZSk7CgkJY2xhc3Nlcy51bnNoaWZ0KCdmYy1kYXktbnVtYmVyJyk7CgoJCXJldHVybiAnJyArCgkJCSc8dGQgY2xhc3M9IicgKyBjbGFzc2VzLmpvaW4oJyAnKSArICciIGRhdGEtZGF0ZT0iJyArIGRhdGUuZm9ybWF0KCkgKyAnIj4nICsKCQkJCWRhdGUuZGF0ZSgpICsKCQkJJzwvdGQ+JzsKCX0sCgoKCS8vIEdlbmVyYXRlcyBhbiBIVE1MIGF0dHJpYnV0ZSBzdHJpbmcgZm9yIHNldHRpbmcgdGhlIHdpZHRoIG9mIHRoZSB3ZWVrIG51bWJlciBjb2x1bW4sIGlmIGl0IGlzIGtub3duCgl3ZWVrTnVtYmVyU3R5bGVBdHRyOiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy53ZWVrTnVtYmVyV2lkdGggIT09IG51bGwpIHsKCQkJcmV0dXJuICdzdHlsZT0id2lkdGg6JyArIHRoaXMud2Vla051bWJlcldpZHRoICsgJ3B4Iic7CgkJfQoJCXJldHVybiAnJzsKCX0sCgoKCS8vIERldGVybWluZXMgd2hldGhlciBlYWNoIHJvdyBzaG91bGQgaGF2ZSBhIGNvbnN0YW50IGhlaWdodAoJaGFzUmlnaWRSb3dzOiBmdW5jdGlvbigpIHsKCQl2YXIgZXZlbnRMaW1pdCA9IHRoaXMub3B0KCdldmVudExpbWl0Jyk7CgkJcmV0dXJuIGV2ZW50TGltaXQgJiYgdHlwZW9mIGV2ZW50TGltaXQgIT09ICdudW1iZXInOwoJfSwKCgoJLyogRGltZW5zaW9ucwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVmcmVzaGVzIHRoZSBob3Jpem9udGFsIGRpbWVuc2lvbnMgb2YgdGhlIHZpZXcKCXVwZGF0ZVdpZHRoOiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy53ZWVrTnVtYmVyc1Zpc2libGUpIHsKCQkJLy8gTWFrZSBzdXJlIGFsbCB3ZWVrIG51bWJlciBjZWxscyBydW5uaW5nIGRvd24gdGhlIHNpZGUgaGF2ZSB0aGUgc2FtZSB3aWR0aC4KCQkJLy8gUmVjb3JkIHRoZSB3aWR0aCBmb3IgY2VsbHMgY3JlYXRlZCBsYXRlci4KCQkJdGhpcy53ZWVrTnVtYmVyV2lkdGggPSBtYXRjaENlbGxXaWR0aHMoCgkJCQl0aGlzLmVsLmZpbmQoJy5mYy13ZWVrLW51bWJlcicpCgkJCSk7CgkJfQoJfSwKCgoJLy8gQWRqdXN0cyB0aGUgdmVydGljYWwgZGltZW5zaW9ucyBvZiB0aGUgdmlldyB0byB0aGUgc3BlY2lmaWVkIHZhbHVlcwoJc2V0SGVpZ2h0OiBmdW5jdGlvbih0b3RhbEhlaWdodCwgaXNBdXRvKSB7CgkJdmFyIGV2ZW50TGltaXQgPSB0aGlzLm9wdCgnZXZlbnRMaW1pdCcpOwoJCXZhciBzY3JvbGxlckhlaWdodDsKCgkJLy8gcmVzZXQgYWxsIGhlaWdodHMgdG8gYmUgbmF0dXJhbAoJCXVuc2V0U2Nyb2xsZXIodGhpcy5zY3JvbGxlckVsKTsKCQl1bmNvbXBlbnNhdGVTY3JvbGwodGhpcy5oZWFkUm93RWwpOwoKCQl0aGlzLmRheUdyaWQuZGVzdHJveVNlZ1BvcG92ZXIoKTsgLy8ga2lsbCB0aGUgIm1vcmUiIHBvcG92ZXIgaWYgZGlzcGxheWVkCgoJCS8vIGlzIHRoZSBldmVudCBsaW1pdCBhIGNvbnN0YW50IGxldmVsIG51bWJlcj8KCQlpZiAoZXZlbnRMaW1pdCAmJiB0eXBlb2YgZXZlbnRMaW1pdCA9PT0gJ251bWJlcicpIHsKCQkJdGhpcy5kYXlHcmlkLmxpbWl0Um93cyhldmVudExpbWl0KTsgLy8gbGltaXQgdGhlIGxldmVscyBmaXJzdCBzbyB0aGUgaGVpZ2h0IGNhbiByZWRpc3RyaWJ1dGUgYWZ0ZXIKCQl9CgoJCXNjcm9sbGVySGVpZ2h0ID0gdGhpcy5jb21wdXRlU2Nyb2xsZXJIZWlnaHQodG90YWxIZWlnaHQpOwoJCXRoaXMuc2V0R3JpZEhlaWdodChzY3JvbGxlckhlaWdodCwgaXNBdXRvKTsKCgkJLy8gaXMgdGhlIGV2ZW50IGxpbWl0IGR5bmFtaWNhbGx5IGNhbGN1bGF0ZWQ\/CgkJaWYgKGV2ZW50TGltaXQgJiYgdHlwZW9mIGV2ZW50TGltaXQgIT09ICdudW1iZXInKSB7CgkJCXRoaXMuZGF5R3JpZC5saW1pdFJvd3MoZXZlbnRMaW1pdCk7IC8vIGxpbWl0IHRoZSBsZXZlbHMgYWZ0ZXIgdGhlIGdyaWQncyByb3cgaGVpZ2h0cyBoYXZlIGJlZW4gc2V0CgkJfQoKCQlpZiAoIWlzQXV0byAmJiBzZXRQb3RlbnRpYWxTY3JvbGxlcih0aGlzLnNjcm9sbGVyRWwsIHNjcm9sbGVySGVpZ2h0KSkgeyAvLyB1c2luZyBzY3JvbGxiYXJzPwoKCQkJY29tcGVuc2F0ZVNjcm9sbCh0aGlzLmhlYWRSb3dFbCwgZ2V0U2Nyb2xsYmFyV2lkdGhzKHRoaXMuc2Nyb2xsZXJFbCkpOwoKCQkJLy8gZG9pbmcgdGhlIHNjcm9sbGJhciBjb21wZW5zYXRpb24gbWlnaHQgaGF2ZSBjcmVhdGVkIHRleHQgb3ZlcmZsb3cgd2hpY2ggY3JlYXRlZCBtb3JlIGhlaWdodC4gcmVkbwoJCQlzY3JvbGxlckhlaWdodCA9IHRoaXMuY29tcHV0ZVNjcm9sbGVySGVpZ2h0KHRvdGFsSGVpZ2h0KTsKCQkJdGhpcy5zY3JvbGxlckVsLmhlaWdodChzY3JvbGxlckhlaWdodCk7CgoJCQl0aGlzLnJlc3RvcmVTY3JvbGwoKTsKCQl9Cgl9LAoKCgkvLyBTZXRzIHRoZSBoZWlnaHQgb2YganVzdCB0aGUgRGF5R3JpZCBjb21wb25lbnQgaW4gdGhpcyB2aWV3CglzZXRHcmlkSGVpZ2h0OiBmdW5jdGlvbihoZWlnaHQsIGlzQXV0bykgewoJCWlmIChpc0F1dG8pIHsKCQkJdW5kaXN0cmlidXRlSGVpZ2h0KHRoaXMuZGF5R3JpZC5yb3dFbHMpOyAvLyBsZXQgdGhlIHJvd3MgYmUgdGhlaXIgbmF0dXJhbCBoZWlnaHQgd2l0aCBubyBleHBhbmRpbmcKCQl9CgkJZWxzZSB7CgkJCWRpc3RyaWJ1dGVIZWlnaHQodGhpcy5kYXlHcmlkLnJvd0VscywgaGVpZ2h0LCB0cnVlKTsgLy8gdHJ1ZSA9IGNvbXBlbnNhdGUgZm9yIGhlaWdodC1ob2dnaW5nIHJvd3MKCQl9Cgl9LAoKCgkvKiBFdmVudHMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIFJlbmRlcnMgdGhlIGdpdmVuIGV2ZW50cyBvbnRvIHRoZSB2aWV3IGFuZCBwb3B1bGF0ZXMgdGhlIHNlZ21lbnRzIGFycmF5CglyZW5kZXJFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewoJCXRoaXMuZGF5R3JpZC5yZW5kZXJFdmVudHMoZXZlbnRzKTsKCgkJdGhpcy51cGRhdGVIZWlnaHQoKTsgLy8gbXVzdCBjb21wZW5zYXRlIGZvciBldmVudHMgdGhhdCBvdmVyZmxvdyB0aGUgcm93Cgl9LAoKCgkvLyBSZXRyaWV2ZXMgYWxsIHNlZ21lbnQgb2JqZWN0cyB0aGF0IGFyZSByZW5kZXJlZCBpbiB0aGUgdmlldwoJZ2V0RXZlbnRTZWdzOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kYXlHcmlkLmdldEV2ZW50U2VncygpOwoJfSwKCgoJLy8gVW5yZW5kZXJzIGFsbCBldmVudCBlbGVtZW50cyBhbmQgY2xlYXJzIGludGVybmFsIHNlZ21lbnQgZGF0YQoJZGVzdHJveUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWNvcmRTY3JvbGwoKTsgLy8gcmVtb3ZpbmcgZXZlbnRzIHdpbGwgcmVkdWNlIGhlaWdodCBhbmQgbWVzcyB3aXRoIHRoZSBzY3JvbGwsIHNvIHJlY29yZCBiZWZvcmVoYW5kCgkJdGhpcy5kYXlHcmlkLmRlc3Ryb3lFdmVudHMoKTsKCgkJLy8gd2UgRE9OJ1QgbmVlZCB0byBjYWxsIHVwZGF0ZUhlaWdodCgpIGJlY2F1c2U6CgkJLy8gQSkgYSByZW5kZXJFdmVudHMoKSBjYWxsIGFsd2F5cyBoYXBwZW5zIGFmdGVyIHRoaXMsIHdoaWNoIHdpbGwgZXZlbnR1YWxseSBjYWxsIHVwZGF0ZUhlaWdodCgpCgkJLy8gQikgaW4gSUU4LCB0aGlzIGNhdXNlcyBhIGZsYXNoIHdoZW5ldmVyIGV2ZW50cyBhcmUgcmVyZW5kZXJlZAoJfSwKCgoJLyogRHJhZ2dpbmcgKGZvciBib3RoIGV2ZW50cyBhbmQgZXh0ZXJuYWwgZWxlbWVudHMpCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBBIHJldHVybmVkIHZhbHVlIG9mIGB0cnVlYCBzaWduYWxzIHRoYXQgYSBtb2NrICJoZWxwZXIiIGV2ZW50IGhhcyBiZWVuIHJlbmRlcmVkLgoJcmVuZGVyRHJhZzogZnVuY3Rpb24oZHJvcExvY2F0aW9uLCBzZWcpIHsKCQlyZXR1cm4gdGhpcy5kYXlHcmlkLnJlbmRlckRyYWcoZHJvcExvY2F0aW9uLCBzZWcpOwoJfSwKCgoJZGVzdHJveURyYWc6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZGF5R3JpZC5kZXN0cm95RHJhZygpOwoJfSwKCgoJLyogU2VsZWN0aW9uCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYSBzZWxlY3Rpb24KCXJlbmRlclNlbGVjdGlvbjogZnVuY3Rpb24ocmFuZ2UpIHsKCQl0aGlzLmRheUdyaWQucmVuZGVyU2VsZWN0aW9uKHJhbmdlKTsKCX0sCgoKCS8vIFVucmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9ucyBvZiBhIHNlbGVjdGlvbgoJZGVzdHJveVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5kYXlHcmlkLmRlc3Ryb3lTZWxlY3Rpb24oKTsKCX0KCn0pOwoKOzsKCi8qIEEgbW9udGggdmlldyB3aXRoIGRheSBjZWxscyBydW5uaW5nIGluIHJvd3MgKG9uZS1wZXItd2VlaykgYW5kIGNvbHVtbnMKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgpzZXREZWZhdWx0cyh7CglmaXhlZFdlZWtDb3VudDogdHJ1ZQp9KTsKCnZhciBNb250aFZpZXcgPSBmY1ZpZXdzLm1vbnRoID0gQmFzaWNWaWV3LmV4dGVuZCh7CgoJLy8gUHJvZHVjZXMgaW5mb3JtYXRpb24gYWJvdXQgd2hhdCByYW5nZSB0byBkaXNwbGF5Cgljb21wdXRlUmFuZ2U6IGZ1bmN0aW9uKGRhdGUpIHsKCQl2YXIgcmFuZ2UgPSBCYXNpY1ZpZXcucHJvdG90eXBlLmNvbXB1dGVSYW5nZS5jYWxsKHRoaXMsIGRhdGUpOyAvLyBnZXQgdmFsdWUgZnJvbSBzdXBlci1tZXRob2QKCQl2YXIgcm93Q250OwoKCQkvLyBlbnN1cmUgNiB3ZWVrcwoJCWlmICh0aGlzLmlzRml4ZWRXZWVrcygpKSB7CgkJCXJvd0NudCA9IE1hdGguY2VpbChyYW5nZS5lbmQuZGlmZihyYW5nZS5zdGFydCwgJ3dlZWtzJywgdHJ1ZSkpOyAvLyBjb3VsZCBiZSBwYXJ0aWFsIHdlZWtzIGR1ZSB0byBoaWRkZW5EYXlzCgkJCXJhbmdlLmVuZC5hZGQoNiAtIHJvd0NudCwgJ3dlZWtzJyk7CgkJfQoKCQlyZXR1cm4gcmFuZ2U7Cgl9LAoKCgkvLyBPdmVycmlkZXMgdGhlIGRlZmF1bHQgQmFzaWNWaWV3IGJlaGF2aW9yIHRvIGhhdmUgc3BlY2lhbCBtdWx0aS13ZWVrIGF1dG8taGVpZ2h0IGxvZ2ljCglzZXRHcmlkSGVpZ2h0OiBmdW5jdGlvbihoZWlnaHQsIGlzQXV0bykgewoKCQlpc0F1dG8gPSBpc0F1dG8gfHwgdGhpcy5vcHQoJ3dlZWtNb2RlJykgPT09ICd2YXJpYWJsZSc7IC8vIExFR0FDWTogd2Vla01vZGUgaXMgZGVwcmVjYXRlZAoKCQkvLyBpZiBhdXRvLCBtYWtlIHRoZSBoZWlnaHQgb2YgZWFjaCByb3cgdGhlIGhlaWdodCB0aGF0IGl0IHdvdWxkIGJlIGlmIHRoZXJlIHdlcmUgNiB3ZWVrcwoJCWlmIChpc0F1dG8pIHsKCQkJaGVpZ2h0ICo9IHRoaXMucm93Q250IC8gNjsKCQl9CgoJCWRpc3RyaWJ1dGVIZWlnaHQodGhpcy5kYXlHcmlkLnJvd0VscywgaGVpZ2h0LCAhaXNBdXRvKTsgLy8gaWYgYXV0bywgZG9uJ3QgY29tcGVuc2F0ZSBmb3IgaGVpZ2h0LWhvZ2dpbmcgcm93cwoJfSwKCgoJaXNGaXhlZFdlZWtzOiBmdW5jdGlvbigpIHsKCQl2YXIgd2Vla01vZGUgPSB0aGlzLm9wdCgnd2Vla01vZGUnKTsgLy8gTEVHQUNZOiB3ZWVrTW9kZSBpcyBkZXByZWNhdGVkCgkJaWYgKHdlZWtNb2RlKSB7CgkJCXJldHVybiB3ZWVrTW9kZSA9PT0gJ2ZpeGVkJzsgLy8gaWYgYW55IG90aGVyIHR5cGUgb2Ygd2Vla01vZGUsIGFzc3VtZSBOT1QgZml4ZWQKCQl9CgoJCXJldHVybiB0aGlzLm9wdCgnZml4ZWRXZWVrQ291bnQnKTsKCX0KCn0pOwoKTW9udGhWaWV3LmR1cmF0aW9uID0geyBtb250aHM6IDEgfTsKCjs7CgovKiBBIHdlZWsgdmlldyB3aXRoIHNpbXBsZSBkYXkgY2VsbHMgcnVubmluZyBob3Jpem9udGFsbHkKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgpmY1ZpZXdzLmJhc2ljV2VlayA9IHsKCXR5cGU6ICdiYXNpYycsCglkdXJhdGlvbjogeyB3ZWVrczogMSB9Cn07Cjs7CgovKiBBIHZpZXcgd2l0aCBhIHNpbmdsZSBzaW1wbGUgZGF5IGNlbGwKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgpmY1ZpZXdzLmJhc2ljRGF5ID0gewoJdHlwZTogJ2Jhc2ljJywKCWR1cmF0aW9uOiB7IGRheXM6IDEgfQp9Owo7OwoKLyogQW4gYWJzdHJhY3QgY2xhc3MgZm9yIGFsbCBhZ2VuZGEtcmVsYXRlZCB2aWV3cy4gRGlzcGxheXMgb25lIG1vcmUgY29sdW1ucyB3aXRoIHRpbWUgc2xvdHMgcnVubmluZyB2ZXJ0aWNhbGx5LgotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KLy8gSXMgYSBtYW5hZ2VyIGZvciB0aGUgVGltZUdyaWQgc3ViY29tcG9uZW50IGFuZCBwb3NzaWJseSB0aGUgRGF5R3JpZCBzdWJjb21wb25lbnQgKGlmIGFsbERheVNsb3QgaXMgb24pLgovLyBSZXNwb25zaWJsZSBmb3IgbWFuYWdpbmcgd2lkdGgvaGVpZ2h0LgoKc2V0RGVmYXVsdHMoewoJYWxsRGF5U2xvdDogdHJ1ZSwKCWFsbERheVRleHQ6ICdhbGwtZGF5JywKCXNjcm9sbFRpbWU6ICcwNjowMDowMCcsCglzbG90RHVyYXRpb246ICcwMDozMDowMCcsCgltaW5UaW1lOiAnMDA6MDA6MDAnLAoJbWF4VGltZTogJzI0OjAwOjAwJywKCXNsb3RFdmVudE92ZXJsYXA6IHRydWUKfSk7Cgp2YXIgQUdFTkRBX0FMTF9EQVlfRVZFTlRfTElNSVQgPSA1OwoKZmNWaWV3cy5hZ2VuZGEgPSBWaWV3LmV4dGVuZCh7IC8vIEFnZW5kYVZpZXcKCgl0aW1lR3JpZDogbnVsbCwgLy8gdGhlIG1haW4gdGltZS1ncmlkIHN1YmNvbXBvbmVudCBvZiB0aGlzIHZpZXcKCWRheUdyaWQ6IG51bGwsIC8vIHRoZSAiYWxsLWRheSIgc3ViY29tcG9uZW50LiBpZiBhbGwtZGF5IGlzIHR1cm5lZCBvZmYsIHRoaXMgd2lsbCBiZSBudWxsCgoJYXhpc1dpZHRoOiBudWxsLCAvLyB0aGUgd2lkdGggb2YgdGhlIHRpbWUgYXhpcyBydW5uaW5nIGRvd24gdGhlIHNpZGUKCglub1Njcm9sbFJvd0VsczogbnVsbCwgLy8gc2V0IG9mIGZha2Ugcm93IGVsZW1lbnRzIHRoYXQgbXVzdCBjb21wZW5zYXRlIHdoZW4gc2Nyb2xsZXJFbCBoYXMgc2Nyb2xsYmFycwoKCS8vIHdoZW4gdGhlIHRpbWUtZ3JpZCBpc24ndCB0YWxsIGVub3VnaCB0byBvY2N1cHkgdGhlIGdpdmVuIGhlaWdodCwgd2UgcmVuZGVyIGFuIDxocj4gdW5kZXJuZWF0aAoJYm90dG9tUnVsZUVsOiBudWxsLAoJYm90dG9tUnVsZUhlaWdodDogbnVsbCwKCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy50aW1lR3JpZCA9IG5ldyBUaW1lR3JpZCh0aGlzKTsKCgkJaWYgKHRoaXMub3B0KCdhbGxEYXlTbG90JykpIHsgLy8gc2hvdWxkIHdlIGRpc3BsYXkgdGhlICJhbGwtZGF5IiBhcmVhPwoJCQl0aGlzLmRheUdyaWQgPSBuZXcgRGF5R3JpZCh0aGlzKTsgLy8gdGhlIGFsbC1kYXkgc3ViY29tcG9uZW50IG9mIHRoaXMgdmlldwoKCQkJLy8gdGhlIGNvb3JkaW5hdGUgZ3JpZCB3aWxsIGJlIGEgY29tYmluYXRpb24gb2YgYm90aCBzdWJjb21wb25lbnRzJyBncmlkcwoJCQl0aGlzLmNvb3JkTWFwID0gbmV3IENvbWJvQ29vcmRNYXAoWwoJCQkJdGhpcy5kYXlHcmlkLmNvb3JkTWFwLAoJCQkJdGhpcy50aW1lR3JpZC5jb29yZE1hcAoJCQldKTsKCQl9CgkJZWxzZSB7CgkJCXRoaXMuY29vcmRNYXAgPSB0aGlzLnRpbWVHcmlkLmNvb3JkTWFwOwoJCX0KCX0sCgoKCS8qIFJlbmRlcmluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gU2V0cyB0aGUgZGlzcGxheSByYW5nZSBhbmQgY29tcHV0ZXMgYWxsIG5lY2Vzc2FyeSBkYXRlcwoJc2V0UmFuZ2U6IGZ1bmN0aW9uKHJhbmdlKSB7CgkJVmlldy5wcm90b3R5cGUuc2V0UmFuZ2UuY2FsbCh0aGlzLCByYW5nZSk7IC8vIGNhbGwgdGhlIHN1cGVyLW1ldGhvZAoKCQl0aGlzLnRpbWVHcmlkLnNldFJhbmdlKHJhbmdlKTsKCQlpZiAodGhpcy5kYXlHcmlkKSB7CgkJCXRoaXMuZGF5R3JpZC5zZXRSYW5nZShyYW5nZSk7CgkJfQoJfSwKCgoJLy8gUmVuZGVycyB0aGUgdmlldyBpbnRvIGB0aGlzLmVsYCwgd2hpY2ggaGFzIGFscmVhZHkgYmVlbiBhc3NpZ25lZAoJcmVuZGVyOiBmdW5jdGlvbigpIHsKCgkJdGhpcy5lbC5hZGRDbGFzcygnZmMtYWdlbmRhLXZpZXcnKS5odG1sKHRoaXMucmVuZGVySHRtbCgpKTsKCgkJLy8gdGhlIGVsZW1lbnQgdGhhdCB3cmFwcyB0aGUgdGltZS1ncmlkIHRoYXQgd2lsbCBwcm9iYWJseSBzY3JvbGwKCQl0aGlzLnNjcm9sbGVyRWwgPSB0aGlzLmVsLmZpbmQoJy5mYy10aW1lLWdyaWQtY29udGFpbmVyJyk7CgkJdGhpcy50aW1lR3JpZC5jb29yZE1hcC5jb250YWluZXJFbCA9IHRoaXMuc2Nyb2xsZXJFbDsgLy8gZG9uJ3QgYWNjZXB0IGNsaWNrcy9ldGMgb3V0c2lkZSBvZiB0aGlzCgoJCXRoaXMudGltZUdyaWQuZWwgPSB0aGlzLmVsLmZpbmQoJy5mYy10aW1lLWdyaWQnKTsKCQl0aGlzLnRpbWVHcmlkLnJlbmRlcigpOwoKCQkvLyB0aGUgPGhyPiB0aGF0IHNvbWV0aW1lcyBkaXNwbGF5cyB1bmRlciB0aGUgdGltZS1ncmlkCgkJdGhpcy5ib3R0b21SdWxlRWwgPSAkKCc8aHIgY2xhc3M9IicgKyB0aGlzLndpZGdldEhlYWRlckNsYXNzICsgJyIvPicpCgkJCS5hcHBlbmRUbyh0aGlzLnRpbWVHcmlkLmVsKTsgLy8gaW5qZWN0IGl0IGludG8gdGhlIHRpbWUtZ3JpZAoKCQlpZiAodGhpcy5kYXlHcmlkKSB7CgkJCXRoaXMuZGF5R3JpZC5lbCA9IHRoaXMuZWwuZmluZCgnLmZjLWRheS1ncmlkJyk7CgkJCXRoaXMuZGF5R3JpZC5yZW5kZXIoKTsKCgkJCS8vIGhhdmUgdGhlIGRheS1ncmlkIGV4dGVuZCBpdCdzIGNvb3JkaW5hdGUgYXJlYSBvdmVyIHRoZSA8aHI+IGRpdmlkaW5nIHRoZSB0d28gZ3JpZHMKCQkJdGhpcy5kYXlHcmlkLmJvdHRvbUNvb3JkUGFkZGluZyA9IHRoaXMuZGF5R3JpZC5lbC5uZXh0KCdocicpLm91dGVySGVpZ2h0KCk7CgkJfQoKCQl0aGlzLm5vU2Nyb2xsUm93RWxzID0gdGhpcy5lbC5maW5kKCcuZmMtcm93Om5vdCguZmMtc2Nyb2xsZXIgKiknKTsgLy8gZmFrZSByb3dzIG5vdCB3aXRoaW4gdGhlIHNjcm9sbGVyCgl9LAoKCgkvLyBNYWtlIHN1YmNvbXBvbmVudHMgcmVhZHkgZm9yIGNsZWFudXAKCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMudGltZUdyaWQuZGVzdHJveSgpOwoJCWlmICh0aGlzLmRheUdyaWQpIHsKCQkJdGhpcy5kYXlHcmlkLmRlc3Ryb3koKTsKCQl9CgkJVmlldy5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOyAvLyBjYWxsIHRoZSBzdXBlci1tZXRob2QKCX0sCgoKCS8vIEJ1aWxkcyB0aGUgSFRNTCBza2VsZXRvbiBmb3IgdGhlIHZpZXcuCgkvLyBUaGUgZGF5LWdyaWQgYW5kIHRpbWUtZ3JpZCBjb21wb25lbnRzIHdpbGwgcmVuZGVyIGluc2lkZSBjb250YWluZXJzIGRlZmluZWQgYnkgdGhpcyBIVE1MLgoJcmVuZGVySHRtbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICcnICsKCQkJJzx0YWJsZT4nICsKCQkJCSc8dGhlYWQ+JyArCgkJCQkJJzx0cj4nICsKCQkJCQkJJzx0ZCBjbGFzcz0iJyArIHRoaXMud2lkZ2V0SGVhZGVyQ2xhc3MgKyAnIj4nICsKCQkJCQkJCXRoaXMudGltZUdyaWQuaGVhZEh0bWwoKSArIC8vIHJlbmRlciB0aGUgZGF5LW9mLXdlZWsgaGVhZGVycwoJCQkJCQknPC90ZD4nICsKCQkJCQknPC90cj4nICsKCQkJCSc8L3RoZWFkPicgKwoJCQkJJzx0Ym9keT4nICsKCQkJCQknPHRyPicgKwoJCQkJCQknPHRkIGNsYXNzPSInICsgdGhpcy53aWRnZXRDb250ZW50Q2xhc3MgKyAnIj4nICsKCQkJCQkJCSh0aGlzLmRheUdyaWQgPwoJCQkJCQkJCSc8ZGl2IGNsYXNzPSJmYy1kYXktZ3JpZCIvPicgKwoJCQkJCQkJCSc8aHIgY2xhc3M9IicgKyB0aGlzLndpZGdldEhlYWRlckNsYXNzICsgJyIvPicgOgoJCQkJCQkJCScnCgkJCQkJCQkJKSArCgkJCQkJCQknPGRpdiBjbGFzcz0iZmMtdGltZS1ncmlkLWNvbnRhaW5lciI+JyArCgkJCQkJCQkJJzxkaXYgY2xhc3M9ImZjLXRpbWUtZ3JpZCIvPicgKwoJCQkJCQkJJzwvZGl2PicgKwoJCQkJCQknPC90ZD4nICsKCQkJCQknPC90cj4nICsKCQkJCSc8L3Rib2R5PicgKwoJCQknPC90YWJsZT4nOwoJfSwKCgoJLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgd2lsbCBnbyBiZWZvcmUgdGhlIGRheS1vZiB3ZWVrIGhlYWRlciBjZWxscy4KCS8vIFF1ZXJpZWQgYnkgdGhlIFRpbWVHcmlkIHN1YmNvbXBvbmVudCB3aGVuIGdlbmVyYXRpbmcgcm93cy4gT3JkZXJpbmcgZGVwZW5kcyBvbiBpc1JUTC4KCWhlYWRJbnRyb0h0bWw6IGZ1bmN0aW9uKCkgewoJCXZhciBkYXRlOwoJCXZhciB3ZWVrTnVtYmVyOwoJCXZhciB3ZWVrVGl0bGU7CgkJdmFyIHdlZWtUZXh0OwoKCQlpZiAodGhpcy5vcHQoJ3dlZWtOdW1iZXJzJykpIHsKCQkJZGF0ZSA9IHRoaXMudGltZUdyaWQuZ2V0Q2VsbCgwKS5zdGFydDsKCQkJd2Vla051bWJlciA9IHRoaXMuY2FsZW5kYXIuY2FsY3VsYXRlV2Vla051bWJlcihkYXRlKTsKCQkJd2Vla1RpdGxlID0gdGhpcy5vcHQoJ3dlZWtOdW1iZXJUaXRsZScpOwoKCQkJaWYgKHRoaXMub3B0KCdpc1JUTCcpKSB7CgkJCQl3ZWVrVGV4dCA9IHdlZWtOdW1iZXIgKyB3ZWVrVGl0bGU7CgkJCX0KCQkJZWxzZSB7CgkJCQl3ZWVrVGV4dCA9IHdlZWtUaXRsZSArIHdlZWtOdW1iZXI7CgkJCX0KCgkJCXJldHVybiAnJyArCgkJCQknPHRoIGNsYXNzPSJmYy1heGlzIGZjLXdlZWstbnVtYmVyICcgKyB0aGlzLndpZGdldEhlYWRlckNsYXNzICsgJyIgJyArIHRoaXMuYXhpc1N0eWxlQXR0cigpICsgJz4nICsKCQkJCQknPHNwYW4+JyArIC8vIG5lZWRlZCBmb3IgbWF0Y2hDZWxsV2lkdGhzCgkJCQkJCWh0bWxFc2NhcGUod2Vla1RleHQpICsKCQkJCQknPC9zcGFuPicgKwoJCQkJJzwvdGg+JzsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiAnPHRoIGNsYXNzPSJmYy1heGlzICcgKyB0aGlzLndpZGdldEhlYWRlckNsYXNzICsgJyIgJyArIHRoaXMuYXhpc1N0eWxlQXR0cigpICsgJz48L3RoPic7CgkJfQoJfSwKCgoJLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgZ29lcyBiZWZvcmUgdGhlIGFsbC1kYXkgY2VsbHMuCgkvLyBRdWVyaWVkIGJ5IHRoZSBEYXlHcmlkIHN1YmNvbXBvbmVudCB3aGVuIGdlbmVyYXRpbmcgcm93cy4gT3JkZXJpbmcgZGVwZW5kcyBvbiBpc1JUTC4KCWRheUludHJvSHRtbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICcnICsKCQkJJzx0ZCBjbGFzcz0iZmMtYXhpcyAnICsgdGhpcy53aWRnZXRDb250ZW50Q2xhc3MgKyAnIiAnICsgdGhpcy5heGlzU3R5bGVBdHRyKCkgKyAnPicgKwoJCQkJJzxzcGFuPicgKyAvLyBuZWVkZWQgZm9yIG1hdGNoQ2VsbFdpZHRocwoJCQkJCSh0aGlzLm9wdCgnYWxsRGF5SHRtbCcpIHx8IGh0bWxFc2NhcGUodGhpcy5vcHQoJ2FsbERheVRleHQnKSkpICsKCQkJCSc8L3NwYW4+JyArCgkJCSc8L3RkPic7Cgl9LAoKCgkvLyBHZW5lcmF0ZXMgdGhlIEhUTUwgdGhhdCBnb2VzIGJlZm9yZSB0aGUgYmcgb2YgdGhlIFRpbWVHcmlkIHNsb3QgYXJlYS4gTG9uZyB2ZXJ0aWNhbCBjb2x1bW4uCglzbG90QmdJbnRyb0h0bWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAnPHRkIGNsYXNzPSJmYy1heGlzICcgKyB0aGlzLndpZGdldENvbnRlbnRDbGFzcyArICciICcgKyB0aGlzLmF4aXNTdHlsZUF0dHIoKSArICc+PC90ZD4nOwoJfSwKCgoJLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgZ29lcyBiZWZvcmUgYWxsIG90aGVyIHR5cGVzIG9mIGNlbGxzLgoJLy8gQWZmZWN0cyBjb250ZW50LXNrZWxldG9uLCBoZWxwZXItc2tlbGV0b24sIGhpZ2hsaWdodC1za2VsZXRvbiBmb3IgYm90aCB0aGUgdGltZS1ncmlkIGFuZCBkYXktZ3JpZC4KCS8vIFF1ZXJpZWQgYnkgdGhlIFRpbWVHcmlkIGFuZCBEYXlHcmlkIHN1YmNvbXBvbmVudHMgd2hlbiBnZW5lcmF0aW5nIHJvd3MuIE9yZGVyaW5nIGRlcGVuZHMgb24gaXNSVEwuCglpbnRyb0h0bWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAnPHRkIGNsYXNzPSJmYy1heGlzIiAnICsgdGhpcy5heGlzU3R5bGVBdHRyKCkgKyAnPjwvdGQ+JzsKCX0sCgoKCS8vIEdlbmVyYXRlcyBhbiBIVE1MIGF0dHJpYnV0ZSBzdHJpbmcgZm9yIHNldHRpbmcgdGhlIHdpZHRoIG9mIHRoZSBheGlzLCBpZiBpdCBpcyBrbm93bgoJYXhpc1N0eWxlQXR0cjogZnVuY3Rpb24oKSB7CgkJaWYgKHRoaXMuYXhpc1dpZHRoICE9PSBudWxsKSB7CgkJCSByZXR1cm4gJ3N0eWxlPSJ3aWR0aDonICsgdGhpcy5heGlzV2lkdGggKyAncHgiJzsKCQl9CgkJcmV0dXJuICcnOwoJfSwKCgoJLyogRGltZW5zaW9ucwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJdXBkYXRlU2l6ZTogZnVuY3Rpb24oaXNSZXNpemUpIHsKCQlpZiAoaXNSZXNpemUpIHsKCQkJdGhpcy50aW1lR3JpZC5yZXNpemUoKTsKCQl9CgkJVmlldy5wcm90b3R5cGUudXBkYXRlU2l6ZS5jYWxsKHRoaXMsIGlzUmVzaXplKTsKCX0sCgoKCS8vIFJlZnJlc2hlcyB0aGUgaG9yaXpvbnRhbCBkaW1lbnNpb25zIG9mIHRoZSB2aWV3Cgl1cGRhdGVXaWR0aDogZnVuY3Rpb24oKSB7CgkJLy8gbWFrZSBhbGwgYXhpcyBjZWxscyBsaW5lIHVwLCBhbmQgcmVjb3JkIHRoZSB3aWR0aCBzbyBuZXdseSBjcmVhdGVkIGF4aXMgY2VsbHMgd2lsbCBoYXZlIGl0CgkJdGhpcy5heGlzV2lkdGggPSBtYXRjaENlbGxXaWR0aHModGhpcy5lbC5maW5kKCcuZmMtYXhpcycpKTsKCX0sCgoKCS8vIEFkanVzdHMgdGhlIHZlcnRpY2FsIGRpbWVuc2lvbnMgb2YgdGhlIHZpZXcgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZXMKCXNldEhlaWdodDogZnVuY3Rpb24odG90YWxIZWlnaHQsIGlzQXV0bykgewoJCXZhciBldmVudExpbWl0OwoJCXZhciBzY3JvbGxlckhlaWdodDsKCgkJaWYgKHRoaXMuYm90dG9tUnVsZUhlaWdodCA9PT0gbnVsbCkgewoJCQkvLyBjYWxjdWxhdGUgdGhlIGhlaWdodCBvZiB0aGUgcnVsZSB0aGUgdmVyeSBmaXJzdCB0aW1lCgkJCXRoaXMuYm90dG9tUnVsZUhlaWdodCA9IHRoaXMuYm90dG9tUnVsZUVsLm91dGVySGVpZ2h0KCk7CgkJfQoJCXRoaXMuYm90dG9tUnVsZUVsLmhpZGUoKTsgLy8gLnNob3coKSB3aWxsIGJlIGNhbGxlZCBsYXRlciBpZiB0aGlzIDxocj4gaXMgbmVjZXNzYXJ5CgoJCS8vIHJlc2V0IGFsbCBkaW1lbnNpb25zIGJhY2sgdG8gdGhlIG9yaWdpbmFsIHN0YXRlCgkJdGhpcy5zY3JvbGxlckVsLmNzcygnb3ZlcmZsb3cnLCAnJyk7CgkJdW5zZXRTY3JvbGxlcih0aGlzLnNjcm9sbGVyRWwpOwoJCXVuY29tcGVuc2F0ZVNjcm9sbCh0aGlzLm5vU2Nyb2xsUm93RWxzKTsKCgkJLy8gbGltaXQgbnVtYmVyIG9mIGV2ZW50cyBpbiB0aGUgYWxsLWRheSBhcmVhCgkJaWYgKHRoaXMuZGF5R3JpZCkgewoJCQl0aGlzLmRheUdyaWQuZGVzdHJveVNlZ1BvcG92ZXIoKTsgLy8ga2lsbCB0aGUgIm1vcmUiIHBvcG92ZXIgaWYgZGlzcGxheWVkCgoJCQlldmVudExpbWl0ID0gdGhpcy5vcHQoJ2V2ZW50TGltaXQnKTsKCQkJaWYgKGV2ZW50TGltaXQgJiYgdHlwZW9mIGV2ZW50TGltaXQgIT09ICdudW1iZXInKSB7CgkJCQlldmVudExpbWl0ID0gQUdFTkRBX0FMTF9EQVlfRVZFTlRfTElNSVQ7IC8vIG1ha2Ugc3VyZSAiYXV0byIgZ29lcyB0byBhIHJlYWwgbnVtYmVyCgkJCX0KCQkJaWYgKGV2ZW50TGltaXQpIHsKCQkJCXRoaXMuZGF5R3JpZC5saW1pdFJvd3MoZXZlbnRMaW1pdCk7CgkJCX0KCQl9CgoJCWlmICghaXNBdXRvKSB7IC8vIHNob3VsZCB3ZSBmb3JjZSBkaW1lbnNpb25zIG9mIHRoZSBzY3JvbGwgY29udGFpbmVyLCBvciBsZXQgdGhlIGNvbnRlbnRzIGJlIG5hdHVyYWwgaGVpZ2h0PwoKCQkJc2Nyb2xsZXJIZWlnaHQgPSB0aGlzLmNvbXB1dGVTY3JvbGxlckhlaWdodCh0b3RhbEhlaWdodCk7CgkJCWlmIChzZXRQb3RlbnRpYWxTY3JvbGxlcih0aGlzLnNjcm9sbGVyRWwsIHNjcm9sbGVySGVpZ2h0KSkgeyAvLyB1c2luZyBzY3JvbGxiYXJzPwoKCQkJCS8vIG1ha2UgdGhlIGFsbC1kYXkgYW5kIGhlYWRlciByb3dzIGxpbmVzIHVwCgkJCQljb21wZW5zYXRlU2Nyb2xsKHRoaXMubm9TY3JvbGxSb3dFbHMsIGdldFNjcm9sbGJhcldpZHRocyh0aGlzLnNjcm9sbGVyRWwpKTsKCgkJCQkvLyB0aGUgc2Nyb2xsYmFyIGNvbXBlbnNhdGlvbiBtaWdodCBoYXZlIGNoYW5nZWQgdGV4dCBmbG93LCB3aGljaCBtaWdodCBhZmZlY3QgaGVpZ2h0LCBzbyByZWNhbGN1bGF0ZQoJCQkJLy8gYW5kIHJlYXBwbHkgdGhlIGRlc2lyZWQgaGVpZ2h0IHRvIHRoZSBzY3JvbGxlci4KCQkJCXNjcm9sbGVySGVpZ2h0ID0gdGhpcy5jb21wdXRlU2Nyb2xsZXJIZWlnaHQodG90YWxIZWlnaHQpOwoJCQkJdGhpcy5zY3JvbGxlckVsLmhlaWdodChzY3JvbGxlckhlaWdodCk7CgoJCQkJdGhpcy5yZXN0b3JlU2Nyb2xsKCk7CgkJCX0KCQkJZWxzZSB7IC8vIG5vIHNjcm9sbGJhcnMKCQkJCS8vIHN0aWxsLCBmb3JjZSBhIGhlaWdodCBhbmQgZGlzcGxheSB0aGUgYm90dG9tIHJ1bGUgKG1hcmtzIHRoZSBlbmQgb2YgZGF5KQoJCQkJdGhpcy5zY3JvbGxlckVsLmhlaWdodChzY3JvbGxlckhlaWdodCkuY3NzKCdvdmVyZmxvdycsICdoaWRkZW4nKTsgLy8gaW4gY2FzZSA8aHI+IGdvZXMgb3V0c2lkZQoJCQkJdGhpcy5ib3R0b21SdWxlRWwuc2hvdygpOwoJCQl9CgkJfQoJfSwKCgoJLy8gU2V0cyB0aGUgc2Nyb2xsIHZhbHVlIG9mIHRoZSBzY3JvbGxlciB0byB0aGUgaW5pdGlhbCBwcmUtY29uZmlndXJlZCBzdGF0ZSBwcmlvciB0byBhbGxvd2luZyB0aGUgdXNlciB0byBjaGFuZ2UgaXQKCWluaXRpYWxpemVTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBfdGhpcyA9IHRoaXM7CgkJdmFyIHNjcm9sbFRpbWUgPSBtb21lbnQuZHVyYXRpb24odGhpcy5vcHQoJ3Njcm9sbFRpbWUnKSk7CgkJdmFyIHRvcCA9IHRoaXMudGltZUdyaWQuY29tcHV0ZVRpbWVUb3Aoc2Nyb2xsVGltZSk7CgoJCS8vIHpvb20gY2FuIGdpdmUgd2VpcmQgZmxvYXRpbmctcG9pbnQgdmFsdWVzLiByYXRoZXIgc2Nyb2xsIGEgbGl0dGxlIGJpdCBmdXJ0aGVyCgkJdG9wID0gTWF0aC5jZWlsKHRvcCk7CgoJCWlmICh0b3ApIHsKCQkJdG9wKys7IC8vIHRvIG92ZXJjb21lIHRvcCBib3JkZXIgdGhhdCBzbG90cyBiZXlvbmQgdGhlIGZpcnN0IGhhdmUuIGxvb2tzIGJldHRlcgoJCX0KCgkJZnVuY3Rpb24gc2Nyb2xsKCkgewoJCQlfdGhpcy5zY3JvbGxlckVsLnNjcm9sbFRvcCh0b3ApOwoJCX0KCgkJc2Nyb2xsKCk7CgkJc2V0VGltZW91dChzY3JvbGwsIDApOyAvLyBvdmVycmlkZXMgYW55IHByZXZpb3VzIHNjcm9sbCBzdGF0ZSBtYWRlIGJ5IHRoZSBicm93c2VyCgl9LAoKCgkvKiBFdmVudHMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoKCS8vIFJlbmRlcnMgZXZlbnRzIG9udG8gdGhlIHZpZXcgYW5kIHBvcHVsYXRlcyB0aGUgVmlldydzIHNlZ21lbnQgYXJyYXkKCXJlbmRlckV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CgkJdmFyIGRheUV2ZW50cyA9IFtdOwoJCXZhciB0aW1lZEV2ZW50cyA9IFtdOwoJCXZhciBkYXlTZWdzID0gW107CgkJdmFyIHRpbWVkU2VnczsKCQl2YXIgaTsKCgkJLy8gc2VwYXJhdGUgdGhlIGV2ZW50cyBpbnRvIGFsbC1kYXkgYW5kIHRpbWVkCgkJZm9yIChpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykgewoJCQlpZiAoZXZlbnRzW2ldLmFsbERheSkgewoJCQkJZGF5RXZlbnRzLnB1c2goZXZlbnRzW2ldKTsKCQkJfQoJCQllbHNlIHsKCQkJCXRpbWVkRXZlbnRzLnB1c2goZXZlbnRzW2ldKTsKCQkJfQoJCX0KCgkJLy8gcmVuZGVyIHRoZSBldmVudHMgaW4gdGhlIHN1YmNvbXBvbmVudHMKCQl0aW1lZFNlZ3MgPSB0aGlzLnRpbWVHcmlkLnJlbmRlckV2ZW50cyh0aW1lZEV2ZW50cyk7CgkJaWYgKHRoaXMuZGF5R3JpZCkgewoJCQlkYXlTZWdzID0gdGhpcy5kYXlHcmlkLnJlbmRlckV2ZW50cyhkYXlFdmVudHMpOwoJCX0KCgkJLy8gdGhlIGFsbC1kYXkgYXJlYSBpcyBmbGV4aWJsZSBhbmQgbWlnaHQgaGF2ZSBhIGxvdCBvZiBldmVudHMsIHNvIHNoaWZ0IHRoZSBoZWlnaHQKCQl0aGlzLnVwZGF0ZUhlaWdodCgpOwoJfSwKCgoJLy8gUmV0cmlldmVzIGFsbCBzZWdtZW50IG9iamVjdHMgdGhhdCBhcmUgcmVuZGVyZWQgaW4gdGhlIHZpZXcKCWdldEV2ZW50U2VnczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudGltZUdyaWQuZ2V0RXZlbnRTZWdzKCkuY29uY2F0KAoJCQl0aGlzLmRheUdyaWQgPyB0aGlzLmRheUdyaWQuZ2V0RXZlbnRTZWdzKCkgOiBbXQoJCSk7Cgl9LAoKCgkvLyBVbnJlbmRlcnMgYWxsIGV2ZW50IGVsZW1lbnRzIGFuZCBjbGVhcnMgaW50ZXJuYWwgc2VnbWVudCBkYXRhCglkZXN0cm95RXZlbnRzOiBmdW5jdGlvbigpIHsKCgkJLy8gaWYgZGVzdHJveUV2ZW50cyBpcyBiZWluZyBjYWxsZWQgYXMgcGFydCBvZiBhbiBldmVudCByZXJlbmRlciwgcmVuZGVyRXZlbnRzIHdpbGwgYmUgY2FsbGVkIHNob3J0bHkKCQkvLyBhZnRlciwgc28gcmVtZW1iZXIgd2hhdCB0aGUgc2Nyb2xsIHZhbHVlIHdhcyBzbyB3ZSBjYW4gcmVzdG9yZSBpdC4KCQl0aGlzLnJlY29yZFNjcm9sbCgpOwoKCQkvLyBkZXN0cm95IHRoZSBldmVudHMgaW4gdGhlIHN1YmNvbXBvbmVudHMKCQl0aGlzLnRpbWVHcmlkLmRlc3Ryb3lFdmVudHMoKTsKCQlpZiAodGhpcy5kYXlHcmlkKSB7CgkJCXRoaXMuZGF5R3JpZC5kZXN0cm95RXZlbnRzKCk7CgkJfQoKCQkvLyB3ZSBET04nVCBuZWVkIHRvIGNhbGwgdXBkYXRlSGVpZ2h0KCkgYmVjYXVzZToKCQkvLyBBKSBhIHJlbmRlckV2ZW50cygpIGNhbGwgYWx3YXlzIGhhcHBlbnMgYWZ0ZXIgdGhpcywgd2hpY2ggd2lsbCBldmVudHVhbGx5IGNhbGwgdXBkYXRlSGVpZ2h0KCkKCQkvLyBCKSBpbiBJRTgsIHRoaXMgY2F1c2VzIGEgZmxhc2ggd2hlbmV2ZXIgZXZlbnRzIGFyZSByZXJlbmRlcmVkCgl9LAoKCgkvKiBEcmFnZ2luZyAoZm9yIGV2ZW50cyBhbmQgZXh0ZXJuYWwgZWxlbWVudHMpCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCgkvLyBBIHJldHVybmVkIHZhbHVlIG9mIGB0cnVlYCBzaWduYWxzIHRoYXQgYSBtb2NrICJoZWxwZXIiIGV2ZW50IGhhcyBiZWVuIHJlbmRlcmVkLgoJcmVuZGVyRHJhZzogZnVuY3Rpb24oZHJvcExvY2F0aW9uLCBzZWcpIHsKCQlpZiAoZHJvcExvY2F0aW9uLnN0YXJ0Lmhhc1RpbWUoKSkgewoJCQlyZXR1cm4gdGhpcy50aW1lR3JpZC5yZW5kZXJEcmFnKGRyb3BMb2NhdGlvbiwgc2VnKTsKCQl9CgkJZWxzZSBpZiAodGhpcy5kYXlHcmlkKSB7CgkJCXJldHVybiB0aGlzLmRheUdyaWQucmVuZGVyRHJhZyhkcm9wTG9jYXRpb24sIHNlZyk7CgkJfQoJfSwKCgoJZGVzdHJveURyYWc6IGZ1bmN0aW9uKCkgewoJCXRoaXMudGltZUdyaWQuZGVzdHJveURyYWcoKTsKCQlpZiAodGhpcy5kYXlHcmlkKSB7CgkJCXRoaXMuZGF5R3JpZC5kZXN0cm95RHJhZygpOwoJCX0KCX0sCgoKCS8qIFNlbGVjdGlvbgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgoJLy8gUmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGEgc2VsZWN0aW9uCglyZW5kZXJTZWxlY3Rpb246IGZ1bmN0aW9uKHJhbmdlKSB7CgkJaWYgKHJhbmdlLnN0YXJ0Lmhhc1RpbWUoKSB8fCByYW5nZS5lbmQuaGFzVGltZSgpKSB7CgkJCXRoaXMudGltZUdyaWQucmVuZGVyU2VsZWN0aW9uKHJhbmdlKTsKCQl9CgkJZWxzZSBpZiAodGhpcy5kYXlHcmlkKSB7CgkJCXRoaXMuZGF5R3JpZC5yZW5kZXJTZWxlY3Rpb24ocmFuZ2UpOwoJCX0KCX0sCgoKCS8vIFVucmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9ucyBvZiBhIHNlbGVjdGlvbgoJZGVzdHJveVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy50aW1lR3JpZC5kZXN0cm95U2VsZWN0aW9uKCk7CgkJaWYgKHRoaXMuZGF5R3JpZCkgewoJCQl0aGlzLmRheUdyaWQuZGVzdHJveVNlbGVjdGlvbigpOwoJCX0KCX0KCn0pOwoKOzsKCi8qIEEgd2VlayB2aWV3IHdpdGggYW4gYWxsLWRheSBjZWxsIGFyZWEgYXQgdGhlIHRvcCwgYW5kIGEgdGltZSBncmlkIGJlbG93Ci0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKZmNWaWV3cy5hZ2VuZGFXZWVrID0gewoJdHlwZTogJ2FnZW5kYScsCglkdXJhdGlvbjogeyB3ZWVrczogMSB9Cn07Cjs7CgovKiBBIGRheSB2aWV3IHdpdGggYW4gYWxsLWRheSBjZWxsIGFyZWEgYXQgdGhlIHRvcCwgYW5kIGEgdGltZSBncmlkIGJlbG93Ci0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKZmNWaWV3cy5hZ2VuZGFEYXkgPSB7Cgl0eXBlOiAnYWdlbmRhJywKCWR1cmF0aW9uOiB7IGRheXM6IDEgfQp9Owo7OwoKfSk7",
    "size": "280260"
}