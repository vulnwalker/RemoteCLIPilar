{
    "namaFile": "js\/jquery-ui.custom.js",
    "lastUpdate": "2015-09-15+16:14:32.62",
    "contentFile": "LyohIGpRdWVyeSBVSSAtIHYxLjEwLjMgLSAyMDEzLTEwLTIwCiogaHR0cDovL2pxdWVyeXVpLmNvbQoqIEluY2x1ZGVzOiBqcXVlcnkudWkuY29yZS5qcywganF1ZXJ5LnVpLndpZGdldC5qcywganF1ZXJ5LnVpLm1vdXNlLmpzLCBqcXVlcnkudWkucG9zaXRpb24uanMsIGpxdWVyeS51aS5kcmFnZ2FibGUuanMsIGpxdWVyeS51aS5kcm9wcGFibGUuanMsIGpxdWVyeS51aS5yZXNpemFibGUuanMsIGpxdWVyeS51aS5zZWxlY3RhYmxlLmpzLCBqcXVlcnkudWkuc29ydGFibGUuanMsIGpxdWVyeS51aS5hY2NvcmRpb24uanMsIGpxdWVyeS51aS5hdXRvY29tcGxldGUuanMsIGpxdWVyeS51aS5idXR0b24uanMsIGpxdWVyeS51aS5kYXRlcGlja2VyLmpzLCBqcXVlcnkudWkuZGlhbG9nLmpzLCBqcXVlcnkudWkubWVudS5qcywganF1ZXJ5LnVpLnByb2dyZXNzYmFyLmpzLCBqcXVlcnkudWkuc2xpZGVyLmpzLCBqcXVlcnkudWkuc3Bpbm5lci5qcywganF1ZXJ5LnVpLnRhYnMuanMsIGpxdWVyeS51aS50b29sdGlwLmpzLCBqcXVlcnkudWkuZWZmZWN0LmpzLCBqcXVlcnkudWkuZWZmZWN0LWJsaW5kLmpzLCBqcXVlcnkudWkuZWZmZWN0LWJvdW5jZS5qcywganF1ZXJ5LnVpLmVmZmVjdC1jbGlwLmpzLCBqcXVlcnkudWkuZWZmZWN0LWRyb3AuanMsIGpxdWVyeS51aS5lZmZlY3QtZXhwbG9kZS5qcywganF1ZXJ5LnVpLmVmZmVjdC1mYWRlLmpzLCBqcXVlcnkudWkuZWZmZWN0LWZvbGQuanMsIGpxdWVyeS51aS5lZmZlY3QtaGlnaGxpZ2h0LmpzLCBqcXVlcnkudWkuZWZmZWN0LXB1bHNhdGUuanMsIGpxdWVyeS51aS5lZmZlY3Qtc2NhbGUuanMsIGpxdWVyeS51aS5lZmZlY3Qtc2hha2UuanMsIGpxdWVyeS51aS5lZmZlY3Qtc2xpZGUuanMsIGpxdWVyeS51aS5lZmZlY3QtdHJhbnNmZXIuanMKKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzOyBMaWNlbnNlZCBNSVQgKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJcnVuaXF1ZUlkID0gL151aS1pZC1cZCskLzsKCi8vICQudWkgbWlnaHQgZXhpc3QgZnJvbSBjb21wb25lbnRzIHdpdGggbm8gZGVwZW5kZW5jaWVzLCBlLmcuLCAkLnVpLnBvc2l0aW9uCiQudWkgPSAkLnVpIHx8IHt9OwoKJC5leHRlbmQoICQudWksIHsKCXZlcnNpb246ICIxLjEwLjMiLAoKCWtleUNvZGU6IHsKCQlCQUNLU1BBQ0U6IDgsCgkJQ09NTUE6IDE4OCwKCQlERUxFVEU6IDQ2LAoJCURPV046IDQwLAoJCUVORDogMzUsCgkJRU5URVI6IDEzLAoJCUVTQ0FQRTogMjcsCgkJSE9NRTogMzYsCgkJTEVGVDogMzcsCgkJTlVNUEFEX0FERDogMTA3LAoJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJTlVNUEFEX0RJVklERTogMTExLAoJCU5VTVBBRF9FTlRFUjogMTA4LAoJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCU5VTVBBRF9TVUJUUkFDVDogMTA5LAoJCVBBR0VfRE9XTjogMzQsCgkJUEFHRV9VUDogMzMsCgkJUEVSSU9EOiAxOTAsCgkJUklHSFQ6IDM5LAoJCVNQQUNFOiAzMiwKCQlUQUI6IDksCgkJVVA6IDM4Cgl9Cn0pOwoKLy8gcGx1Z2lucwokLmZuLmV4dGVuZCh7Cglmb2N1czogKGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggZGVsYXksIGZuICkgewoJCQlyZXR1cm4gdHlwZW9mIGRlbGF5ID09PSAibnVtYmVyIiA\/CgkJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGVsZW0gPSB0aGlzOwoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCSQoIGVsZW0gKS5mb2N1cygpOwoJCQkJCQlpZiAoIGZuICkgewoJCQkJCQkJZm4uY2FsbCggZWxlbSApOwoJCQkJCQl9CgkJCQkJfSwgZGVsYXkgKTsKCQkJCX0pIDoKCQkJCW9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX07Cgl9KSggJC5mbi5mb2N1cyApLAoKCXNjcm9sbFBhcmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNjcm9sbFBhcmVudDsKCQlpZiAoKCQudWkuaWUgJiYgKC8oc3RhdGljfHJlbGF0aXZlKS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB8fCAoL2Fic29sdXRlLykudGVzdCh0aGlzLmNzcygicG9zaXRpb24iKSkpIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKHJlbGF0aXZlfGFic29sdXRlfGZpeGVkKS8pLnRlc3QoJC5jc3ModGhpcywicG9zaXRpb24iKSkgJiYgKC8oYXV0b3xzY3JvbGwpLykudGVzdCgkLmNzcyh0aGlzLCJvdmVyZmxvdyIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXkiKSskLmNzcyh0aGlzLCJvdmVyZmxvdy14IikpOwoJCQl9KS5lcSgwKTsKCQl9IGVsc2UgewoJCQlzY3JvbGxQYXJlbnQgPSB0aGlzLnBhcmVudHMoKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKC8oYXV0b3xzY3JvbGwpLykudGVzdCgkLmNzcyh0aGlzLCJvdmVyZmxvdyIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXkiKSskLmNzcyh0aGlzLCJvdmVyZmxvdy14IikpOwoJCQl9KS5lcSgwKTsKCQl9CgoJCXJldHVybiAoL2ZpeGVkLykudGVzdCh0aGlzLmNzcygicG9zaXRpb24iKSkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKGRvY3VtZW50KSA6IHNjcm9sbFBhcmVudDsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA\/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0KfSk7CgokLmV4dGVuZCggJC51aSwgewoJLy8gJC51aS5wbHVnaW4gaXMgZGVwcmVjYXRlZC4gVXNlICQud2lkZ2V0KCkgZXh0ZW5zaW9ucyBpbnN0ZWFkLgoJcGx1Z2luOiB7CgkJYWRkOiBmdW5jdGlvbiggbW9kdWxlLCBvcHRpb24sIHNldCApIHsKCQkJdmFyIGksCgkJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQkJZm9yICggaSBpbiBzZXQgKSB7CgkJCQlwcm90by5wbHVnaW5zWyBpIF0gPSBwcm90by5wbHVnaW5zWyBpIF0gfHwgW107CgkJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQkJfQoJCX0sCgkJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzICkgewoJCQl2YXIgaSwKCQkJCXNldCA9IGluc3RhbmNlLnBsdWdpbnNbIG5hbWUgXTsKCQkJaWYgKCAhc2V0IHx8ICFpbnN0YW5jZS5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZSB8fCBpbnN0YW5jZS5lbGVtZW50WyAwIF0ucGFyZW50Tm9kZS5ub2RlVHlwZSA9PT0gMTEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWZvciAoIGkgPSAwOyBpIDwgc2V0Lmxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQkJc2V0WyBpIF1bIDEgXS5hcHBseSggaW5zdGFuY2UuZWxlbWVudCwgYXJncyApOwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBvbmx5IHVzZWQgYnkgcmVzaXphYmxlCgloYXNTY3JvbGw6IGZ1bmN0aW9uKCBlbCwgYSApIHsKCgkJLy9JZiBvdmVyZmxvdyBpcyBoaWRkZW4sIHRoZSBlbGVtZW50IG1pZ2h0IGhhdmUgZXh0cmEgY29udGVudCwgYnV0IHRoZSB1c2VyIHdhbnRzIHRvIGhpZGUgaXQKCQlpZiAoICQoIGVsICkuY3NzKCAib3ZlcmZsb3ciICkgPT09ICJoaWRkZW4iKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXZhciBzY3JvbGwgPSAoIGEgJiYgYSA9PT0gImxlZnQiICkgPyAic2Nyb2xsTGVmdCIgOiAic2Nyb2xsVG9wIiwKCQkJaGFzID0gZmFsc2U7CgoJCWlmICggZWxbIHNjcm9sbCBdID4gMCApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQkvLyBUT0RPOiBkZXRlcm1pbmUgd2hpY2ggY2FzZXMgYWN0dWFsbHkgY2F1c2UgdGhpcyB0byBoYXBwZW4KCQkvLyBpZiB0aGUgZWxlbWVudCBkb2Vzbid0IGhhdmUgdGhlIHNjcm9sbCBzZXQsIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvCgkJLy8gc2V0IHRoZSBzY3JvbGwKCQllbFsgc2Nyb2xsIF0gPSAxOwoJCWhhcyA9ICggZWxbIHNjcm9sbCBdID4gMCApOwoJCWVsWyBzY3JvbGwgXSA9IDA7CgkJcmV0dXJuIGhhczsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCglfY2xlYW5EYXRhID0gJC5jbGVhbkRhdGE7CiQuY2xlYW5EYXRhID0gZnVuY3Rpb24oIGVsZW1zICkgewoJZm9yICggdmFyIGkgPSAwLCBlbGVtOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJdHJ5IHsKCQkJJCggZWxlbSApLnRyaWdnZXJIYW5kbGVyKCAicmVtb3ZlIiApOwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzgyMzUKCQl9IGNhdGNoKCBlICkge30KCX0KCV9jbGVhbkRhdGEoIGVsZW1zICk7Cn07CgokLndpZGdldCA9IGZ1bmN0aW9uKCBuYW1lLCBiYXNlLCBwcm90b3R5cGUgKSB7Cgl2YXIgZnVsbE5hbWUsIGV4aXN0aW5nQ29uc3RydWN0b3IsIGNvbnN0cnVjdG9yLCBiYXNlUHJvdG90eXBlLAoJCS8vIHByb3hpZWRQcm90b3R5cGUgYWxsb3dzIHRoZSBwcm92aWRlZCBwcm90b3R5cGUgdG8gcmVtYWluIHVubW9kaWZpZWQKCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIGFzIGEgbWl4aW4gZm9yIG11bHRpcGxlIHdpZGdldHMgKCM4ODc2KQoJCXByb3hpZWRQcm90b3R5cGUgPSB7fSwKCQluYW1lc3BhY2UgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMCBdOwoKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUudG9Mb3dlckNhc2UoKSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBmdWxsTmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07Cgljb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCS8vIGV4dGVuZCB3aXRoIHRoZSBleGlzdGluZyBjb25zdHJ1Y3RvciB0byBjYXJyeSBvdmVyIGFueSBzdGF0aWMgcHJvcGVydGllcwoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7CgkJdmVyc2lvbjogcHJvdG90eXBlLnZlcnNpb24sCgkJLy8gY29weSB0aGUgb2JqZWN0IHVzZWQgdG8gY3JlYXRlIHRoZSBwcm90b3R5cGUgaW4gY2FzZSB3ZSBuZWVkIHRvCgkJLy8gcmVkZWZpbmUgdGhlIHdpZGdldCBsYXRlcgoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwKCQkvLyB0cmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0pOwoKCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJC5lYWNoKCBwcm90b3R5cGUsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQlpZiAoICEkLmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9IHZhbHVlOwoJCQlyZXR1cm47CgkJfQoJCXByb3hpZWRQcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJdmFyIF9zdXBlciA9IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCX0sCgkJCQlfc3VwZXJBcHBseSA9IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCQl9OwoJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQl2YXIgX19zdXBlciA9IHRoaXMuX3N1cGVyLAoJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJcmV0dXJuVmFsdWU7CgoJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuVmFsdWUgPSB2YWx1ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCQkJdGhpcy5fc3VwZXIgPSBfX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQlyZXR1cm4gcmV0dXJuVmFsdWU7CgkJCX07CgkJfSkoKTsKCX0pOwoJY29uc3RydWN0b3IucHJvdG90eXBlID0gJC53aWRnZXQuZXh0ZW5kKCBiYXNlUHJvdG90eXBlLCB7CgkJLy8gVE9ETzogcmVtb3ZlIHN1cHBvcnQgZm9yIHdpZGdldEV2ZW50UHJlZml4CgkJLy8gYWx3YXlzIHVzZSB0aGUgbmFtZSArIGEgY29sb24gYXMgdGhlIHByZWZpeCwgZS5nLiwgZHJhZ2dhYmxlOnN0YXJ0CgkJLy8gZG9uJ3QgcHJlZml4IGZvciB3aWRnZXRzIHRoYXQgYXJlbid0IERPTS1iYXNlZAoJCXdpZGdldEV2ZW50UHJlZml4OiBleGlzdGluZ0NvbnN0cnVjdG9yID8gYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCA6IG5hbWUKCX0sIHByb3hpZWRQcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA\/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA\/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCB1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfb246IGZ1bmN0aW9uKCBzdXBwcmVzc0Rpc2FibGVkQ2hlY2ssIGVsZW1lbnQsIGhhbmRsZXJzICkgewoJCXZhciBkZWxlZ2F0ZUVsZW1lbnQsCgkJCWluc3RhbmNlID0gdGhpczsKCgkJLy8gbm8gc3VwcHJlc3NEaXNhYmxlZENoZWNrIGZsYWcsIHNodWZmbGUgYXJndW1lbnRzCgkJaWYgKCB0eXBlb2Ygc3VwcHJlc3NEaXNhYmxlZENoZWNrICE9PSAiYm9vbGVhbiIgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHN1cHByZXNzRGlzYWJsZWRDaGVjazsKCQkJc3VwcHJlc3NEaXNhYmxlZENoZWNrID0gZmFsc2U7CgkJfQoKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQkJZGVsZWdhdGVFbGVtZW50ID0gdGhpcy53aWRnZXQoKTsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJCS8vIGFsbG93IHdpZGdldHMgdG8gY3VzdG9taXplIHRoZSBkaXNhYmxlZCBoYW5kbGluZwoJCQkJLy8gLSBkaXNhYmxlZCBhcyBhbiBhcnJheSBpbnN0ZWFkIG9mIGJvb2xlYW4KCQkJCS8vIC0gZGlzYWJsZWQgY2xhc3MgYXMgbWV0aG9kIGZvciBkaXNhYmxpbmcgaW5kaXZpZHVhbCBwYXJ0cwoJCQkJaWYgKCAhc3VwcHJlc3NEaXNhYmxlZENoZWNrICYmCgkJCQkJCSggaW5zdGFuY2Uub3B0aW9ucy5kaXNhYmxlZCA9PT0gdHJ1ZSB8fAoJCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIGNvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihcdyspXHMqKC4qKSQvICksCgkJCQlldmVudE5hbWUgPSBtYXRjaFsxXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlLAoJCQkJc2VsZWN0b3IgPSBtYXRjaFsyXTsKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA\/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICQuZWZmZWN0cy5lZmZlY3RbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgbWV0aG9kIF0oIG9wdGlvbnMgKTsKCQl9IGVsc2UgaWYgKCBlZmZlY3ROYW1lICE9PSBtZXRob2QgJiYgZWxlbWVudFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBlZmZlY3ROYW1lIF0oIG9wdGlvbnMuZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nLCBjYWxsYmFjayApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnQucXVldWUoZnVuY3Rpb24oIG5leHQgKSB7CgkJCQkkKCB0aGlzIClbIG1ldGhvZCBdKCk7CgkJCQlpZiAoIGNhbGxiYWNrICkgewoJCQkJCWNhbGxiYWNrLmNhbGwoIGVsZW1lbnRbIDAgXSApOwoJCQkJfQoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9Cgl9Owp9KTsKCn0pKCBqUXVlcnkgKTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgbW91c2VIYW5kbGVkID0gZmFsc2U7CiQoIGRvY3VtZW50ICkubW91c2V1cCggZnVuY3Rpb24oKSB7Cgltb3VzZUhhbmRsZWQgPSBmYWxzZTsKfSk7CgokLndpZGdldCgidWkubW91c2UiLCB7Cgl2ZXJzaW9uOiAiMS4xMC4zIiwKCW9wdGlvbnM6IHsKCQljYW5jZWw6ICJpbnB1dCx0ZXh0YXJlYSxidXR0b24sc2VsZWN0LG9wdGlvbiIsCgkJZGlzdGFuY2U6IDEsCgkJZGVsYXk6IDAKCX0sCglfbW91c2VJbml0OiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMuZWxlbWVudAoJCQkuYmluZCgibW91c2Vkb3duLiIrdGhpcy53aWRnZXROYW1lLCBmdW5jdGlvbihldmVudCkgewoJCQkJcmV0dXJuIHRoYXQuX21vdXNlRG93bihldmVudCk7CgkJCX0pCgkJCS5iaW5kKCJjbGljay4iK3RoaXMud2lkZ2V0TmFtZSwgZnVuY3Rpb24oZXZlbnQpIHsKCQkJCWlmICh0cnVlID09PSAkLmRhdGEoZXZlbnQudGFyZ2V0LCB0aGF0LndpZGdldE5hbWUgKyAiLnByZXZlbnRDbGlja0V2ZW50IikpIHsKCQkJCQkkLnJlbW92ZURhdGEoZXZlbnQudGFyZ2V0LCB0aGF0LndpZGdldE5hbWUgKyAiLnByZXZlbnRDbGlja0V2ZW50Iik7CgkJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5zdGFydGVkID0gZmFsc2U7Cgl9LAoKCS8vIFRPRE86IG1ha2Ugc3VyZSBkZXN0cm95aW5nIG9uZSBpbnN0YW5jZSBvZiBtb3VzZSBkb2Vzbid0IG1lc3Mgd2l0aAoJLy8gb3RoZXIgaW5zdGFuY2VzIG9mIG1vdXNlCglfbW91c2VEZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQudW5iaW5kKCIuIit0aGlzLndpZGdldE5hbWUpOwoJCWlmICggdGhpcy5fbW91c2VNb3ZlRGVsZWdhdGUgKSB7CgkJCSQoZG9jdW1lbnQpCgkJCQkudW5iaW5kKCJtb3VzZW1vdmUuIit0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlTW92ZURlbGVnYXRlKQoJCQkJLnVuYmluZCgibW91c2V1cC4iK3RoaXMud2lkZ2V0TmFtZSwgdGhpcy5fbW91c2VVcERlbGVnYXRlKTsKCQl9Cgl9LAoKCV9tb3VzZURvd246IGZ1bmN0aW9uKGV2ZW50KSB7CgkJLy8gZG9uJ3QgbGV0IG1vcmUgdGhhbiBvbmUgd2lkZ2V0IGhhbmRsZSBtb3VzZVN0YXJ0CgkJaWYoIG1vdXNlSGFuZGxlZCApIHsgcmV0dXJuOyB9CgoJCS8vIHdlIG1heSBoYXZlIG1pc3NlZCBtb3VzZXVwIChvdXQgb2Ygd2luZG93KQoJCSh0aGlzLl9tb3VzZVN0YXJ0ZWQgJiYgdGhpcy5fbW91c2VVcChldmVudCkpOwoKCQl0aGlzLl9tb3VzZURvd25FdmVudCA9IGV2ZW50OwoKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCWJ0bklzTGVmdCA9IChldmVudC53aGljaCA9PT0gMSksCgkJCS8vIGV2ZW50LnRhcmdldC5ub2RlTmFtZSB3b3JrcyBhcm91bmQgYSBidWcgaW4gSUUgOCB3aXRoCgkJCS8vIGRpc2FibGVkIGlucHV0cyAoIzc2MjApCgkJCWVsSXNDYW5jZWwgPSAodHlwZW9mIHRoaXMub3B0aW9ucy5jYW5jZWwgPT09ICJzdHJpbmciICYmIGV2ZW50LnRhcmdldC5ub2RlTmFtZSA\/ICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KHRoaXMub3B0aW9ucy5jYW5jZWwpLmxlbmd0aCA6IGZhbHNlKTsKCQlpZiAoIWJ0bklzTGVmdCB8fCBlbElzQ2FuY2VsIHx8ICF0aGlzLl9tb3VzZUNhcHR1cmUoZXZlbnQpKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCgkJdGhpcy5tb3VzZURlbGF5TWV0ID0gIXRoaXMub3B0aW9ucy5kZWxheTsKCQlpZiAoIXRoaXMubW91c2VEZWxheU1ldCkgewoJCQl0aGlzLl9tb3VzZURlbGF5VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJdGhhdC5tb3VzZURlbGF5TWV0ID0gdHJ1ZTsKCQkJfSwgdGhpcy5vcHRpb25zLmRlbGF5KTsKCQl9CgoJCWlmICh0aGlzLl9tb3VzZURpc3RhbmNlTWV0KGV2ZW50KSAmJiB0aGlzLl9tb3VzZURlbGF5TWV0KGV2ZW50KSkgewoJCQl0aGlzLl9tb3VzZVN0YXJ0ZWQgPSAodGhpcy5fbW91c2VTdGFydChldmVudCkgIT09IGZhbHNlKTsKCQkJaWYgKCF0aGlzLl9tb3VzZVN0YXJ0ZWQpIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gQ2xpY2sgZXZlbnQgbWF5IG5ldmVyIGhhdmUgZmlyZWQgKEdlY2tvICYgT3BlcmEpCgkJaWYgKHRydWUgPT09ICQuZGF0YShldmVudC50YXJnZXQsIHRoaXMud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiKSkgewoJCQkkLnJlbW92ZURhdGEoZXZlbnQudGFyZ2V0LCB0aGlzLndpZGdldE5hbWUgKyAiLnByZXZlbnRDbGlja0V2ZW50Iik7CgkJfQoKCQkvLyB0aGVzZSBkZWxlZ2F0ZXMgYXJlIHJlcXVpcmVkIHRvIGtlZXAgY29udGV4dAoJCXRoaXMuX21vdXNlTW92ZURlbGVnYXRlID0gZnVuY3Rpb24oZXZlbnQpIHsKCQkJcmV0dXJuIHRoYXQuX21vdXNlTW92ZShldmVudCk7CgkJfTsKCQl0aGlzLl9tb3VzZVVwRGVsZWdhdGUgPSBmdW5jdGlvbihldmVudCkgewoJCQlyZXR1cm4gdGhhdC5fbW91c2VVcChldmVudCk7CgkJfTsKCQkkKGRvY3VtZW50KQoJCQkuYmluZCgibW91c2Vtb3ZlLiIrdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSkKCQkJLmJpbmQoIm1vdXNldXAuIit0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlVXBEZWxlZ2F0ZSk7CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCW1vdXNlSGFuZGxlZCA9IHRydWU7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZU1vdmU6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJLy8gSUUgbW91c2V1cCBjaGVjayAtIG1vdXNldXAgaGFwcGVuZWQgd2hlbiBtb3VzZSB3YXMgb3V0IG9mIHdpbmRvdwoJCWlmICgkLnVpLmllICYmICggIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPCA5ICkgJiYgIWV2ZW50LmJ1dHRvbikgewoJCQlyZXR1cm4gdGhpcy5fbW91c2VVcChldmVudCk7CgkJfQoKCQlpZiAodGhpcy5fbW91c2VTdGFydGVkKSB7CgkJCXRoaXMuX21vdXNlRHJhZyhldmVudCk7CgkJCXJldHVybiBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCgkJaWYgKHRoaXMuX21vdXNlRGlzdGFuY2VNZXQoZXZlbnQpICYmIHRoaXMuX21vdXNlRGVsYXlNZXQoZXZlbnQpKSB7CgkJCXRoaXMuX21vdXNlU3RhcnRlZCA9CgkJCQkodGhpcy5fbW91c2VTdGFydCh0aGlzLl9tb3VzZURvd25FdmVudCwgZXZlbnQpICE9PSBmYWxzZSk7CgkJCSh0aGlzLl9tb3VzZVN0YXJ0ZWQgPyB0aGlzLl9tb3VzZURyYWcoZXZlbnQpIDogdGhpcy5fbW91c2VVcChldmVudCkpOwoJCX0KCgkJcmV0dXJuICF0aGlzLl9tb3VzZVN0YXJ0ZWQ7Cgl9LAoKCV9tb3VzZVVwOiBmdW5jdGlvbihldmVudCkgewoJCSQoZG9jdW1lbnQpCgkJCS51bmJpbmQoIm1vdXNlbW92ZS4iK3RoaXMud2lkZ2V0TmFtZSwgdGhpcy5fbW91c2VNb3ZlRGVsZWdhdGUpCgkJCS51bmJpbmQoIm1vdXNldXAuIit0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlVXBEZWxlZ2F0ZSk7CgoJCWlmICh0aGlzLl9tb3VzZVN0YXJ0ZWQpIHsKCQkJdGhpcy5fbW91c2VTdGFydGVkID0gZmFsc2U7CgoJCQlpZiAoZXZlbnQudGFyZ2V0ID09PSB0aGlzLl9tb3VzZURvd25FdmVudC50YXJnZXQpIHsKCQkJCSQuZGF0YShldmVudC50YXJnZXQsIHRoaXMud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiLCB0cnVlKTsKCQkJfQoKCQkJdGhpcy5fbW91c2VTdG9wKGV2ZW50KTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX21vdXNlRGlzdGFuY2VNZXQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJcmV0dXJuIChNYXRoLm1heCgKCQkJCU1hdGguYWJzKHRoaXMuX21vdXNlRG93bkV2ZW50LnBhZ2VYIC0gZXZlbnQucGFnZVgpLAoJCQkJTWF0aC5hYnModGhpcy5fbW91c2VEb3duRXZlbnQucGFnZVkgLSBldmVudC5wYWdlWSkKCQkJKSA+PSB0aGlzLm9wdGlvbnMuZGlzdGFuY2UKCQkpOwoJfSwKCglfbW91c2VEZWxheU1ldDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQlyZXR1cm4gdGhpcy5tb3VzZURlbGF5TWV0OwoJfSwKCgkvLyBUaGVzZSBhcmUgcGxhY2Vob2xkZXIgbWV0aG9kcywgdG8gYmUgb3ZlcnJpZGVuIGJ5IGV4dGVuZGluZyBwbHVnaW4KCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbigvKiBldmVudCAqLykge30sCglfbW91c2VEcmFnOiBmdW5jdGlvbigvKiBldmVudCAqLykge30sCglfbW91c2VTdG9wOiBmdW5jdGlvbigvKiBldmVudCAqLykge30sCglfbW91c2VDYXB0dXJlOiBmdW5jdGlvbigvKiBldmVudCAqLykgeyByZXR1cm4gdHJ1ZTsgfQp9KTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC51aSA9ICQudWkgfHwge307Cgp2YXIgY2FjaGVkU2Nyb2xsYmFyV2lkdGgsCgltYXggPSBNYXRoLm1heCwKCWFicyA9IE1hdGguYWJzLAoJcm91bmQgPSBNYXRoLnJvdW5kLAoJcmhvcml6b250YWwgPSAvbGVmdHxjZW50ZXJ8cmlnaHQvLAoJcnZlcnRpY2FsID0gL3RvcHxjZW50ZXJ8Ym90dG9tLywKCXJvZmZzZXQgPSAvW1wrXC1dXGQrKFwuW1xkXSspPyU\/LywKCXJwb3NpdGlvbiA9IC9eXHcrLywKCXJwZXJjZW50ID0gLyUkLywKCV9wb3NpdGlvbiA9ICQuZm4ucG9zaXRpb247CgpmdW5jdGlvbiBnZXRPZmZzZXRzKCBvZmZzZXRzLCB3aWR0aCwgaGVpZ2h0ICkgewoJcmV0dXJuIFsKCQlwYXJzZUZsb2F0KCBvZmZzZXRzWyAwIF0gKSAqICggcnBlcmNlbnQudGVzdCggb2Zmc2V0c1sgMCBdICkgPyB3aWR0aCAvIDEwMCA6IDEgKSwKCQlwYXJzZUZsb2F0KCBvZmZzZXRzWyAxIF0gKSAqICggcnBlcmNlbnQudGVzdCggb2Zmc2V0c1sgMSBdICkgPyBoZWlnaHQgLyAxMDAgOiAxICkKCV07Cn0KCmZ1bmN0aW9uIHBhcnNlQ3NzKCBlbGVtZW50LCBwcm9wZXJ0eSApIHsKCXJldHVybiBwYXJzZUludCggJC5jc3MoIGVsZW1lbnQsIHByb3BlcnR5ICksIDEwICkgfHwgMDsKfQoKZnVuY3Rpb24gZ2V0RGltZW5zaW9ucyggZWxlbSApIHsKCXZhciByYXcgPSBlbGVtWzBdOwoJaWYgKCByYXcubm9kZVR5cGUgPT09IDkgKSB7CgkJcmV0dXJuIHsKCQkJd2lkdGg6IGVsZW0ud2lkdGgoKSwKCQkJaGVpZ2h0OiBlbGVtLmhlaWdodCgpLAoJCQlvZmZzZXQ6IHsgdG9wOiAwLCBsZWZ0OiAwIH0KCQl9OwoJfQoJaWYgKCAkLmlzV2luZG93KCByYXcgKSApIHsKCQlyZXR1cm4gewoJCQl3aWR0aDogZWxlbS53aWR0aCgpLAoJCQloZWlnaHQ6IGVsZW0uaGVpZ2h0KCksCgkJCW9mZnNldDogeyB0b3A6IGVsZW0uc2Nyb2xsVG9wKCksIGxlZnQ6IGVsZW0uc2Nyb2xsTGVmdCgpIH0KCQl9OwoJfQoJaWYgKCByYXcucHJldmVudERlZmF1bHQgKSB7CgkJcmV0dXJuIHsKCQkJd2lkdGg6IDAsCgkJCWhlaWdodDogMCwKCQkJb2Zmc2V0OiB7IHRvcDogcmF3LnBhZ2VZLCBsZWZ0OiByYXcucGFnZVggfQoJCX07Cgl9CglyZXR1cm4gewoJCXdpZHRoOiBlbGVtLm91dGVyV2lkdGgoKSwKCQloZWlnaHQ6IGVsZW0ub3V0ZXJIZWlnaHQoKSwKCQlvZmZzZXQ6IGVsZW0ub2Zmc2V0KCkKCX07Cn0KCiQucG9zaXRpb24gPSB7CglzY3JvbGxiYXJXaWR0aDogZnVuY3Rpb24oKSB7CgkJaWYgKCBjYWNoZWRTY3JvbGxiYXJXaWR0aCAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gY2FjaGVkU2Nyb2xsYmFyV2lkdGg7CgkJfQoJCXZhciB3MSwgdzIsCgkJCWRpdiA9ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OmJsb2NrO3dpZHRoOjUwcHg7aGVpZ2h0OjUwcHg7b3ZlcmZsb3c6aGlkZGVuOyc+PGRpdiBzdHlsZT0naGVpZ2h0OjEwMHB4O3dpZHRoOmF1dG87Jz48L2Rpdj48L2Rpdj4iICksCgkJCWlubmVyRGl2ID0gZGl2LmNoaWxkcmVuKClbMF07CgoJCSQoICJib2R5IiApLmFwcGVuZCggZGl2ICk7CgkJdzEgPSBpbm5lckRpdi5vZmZzZXRXaWR0aDsKCQlkaXYuY3NzKCAib3ZlcmZsb3ciLCAic2Nyb2xsIiApOwoKCQl3MiA9IGlubmVyRGl2Lm9mZnNldFdpZHRoOwoKCQlpZiAoIHcxID09PSB3MiApIHsKCQkJdzIgPSBkaXZbMF0uY2xpZW50V2lkdGg7CgkJfQoKCQlkaXYucmVtb3ZlKCk7CgoJCXJldHVybiAoY2FjaGVkU2Nyb2xsYmFyV2lkdGggPSB3MSAtIHcyKTsKCX0sCglnZXRTY3JvbGxJbmZvOiBmdW5jdGlvbiggd2l0aGluICkgewoJCXZhciBvdmVyZmxvd1ggPSB3aXRoaW4uaXNXaW5kb3cgPyAiIiA6IHdpdGhpbi5lbGVtZW50LmNzcyggIm92ZXJmbG93LXgiICksCgkJCW92ZXJmbG93WSA9IHdpdGhpbi5pc1dpbmRvdyA\/ICIiIDogd2l0aGluLmVsZW1lbnQuY3NzKCAib3ZlcmZsb3cteSIgKSwKCQkJaGFzT3ZlcmZsb3dYID0gb3ZlcmZsb3dYID09PSAic2Nyb2xsIiB8fAoJCQkJKCBvdmVyZmxvd1ggPT09ICJhdXRvIiAmJiB3aXRoaW4ud2lkdGggPCB3aXRoaW4uZWxlbWVudFswXS5zY3JvbGxXaWR0aCApLAoJCQloYXNPdmVyZmxvd1kgPSBvdmVyZmxvd1kgPT09ICJzY3JvbGwiIHx8CgkJCQkoIG92ZXJmbG93WSA9PT0gImF1dG8iICYmIHdpdGhpbi5oZWlnaHQgPCB3aXRoaW4uZWxlbWVudFswXS5zY3JvbGxIZWlnaHQgKTsKCQlyZXR1cm4gewoJCQl3aWR0aDogaGFzT3ZlcmZsb3dZID8gJC5wb3NpdGlvbi5zY3JvbGxiYXJXaWR0aCgpIDogMCwKCQkJaGVpZ2h0OiBoYXNPdmVyZmxvd1ggPyAkLnBvc2l0aW9uLnNjcm9sbGJhcldpZHRoKCkgOiAwCgkJfTsKCX0sCglnZXRXaXRoaW5JbmZvOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgd2l0aGluRWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgd2luZG93ICksCgkJCWlzV2luZG93ID0gJC5pc1dpbmRvdyggd2l0aGluRWxlbWVudFswXSApOwoJCXJldHVybiB7CgkJCWVsZW1lbnQ6IHdpdGhpbkVsZW1lbnQsCgkJCWlzV2luZG93OiBpc1dpbmRvdywKCQkJb2Zmc2V0OiB3aXRoaW5FbGVtZW50Lm9mZnNldCgpIHx8IHsgbGVmdDogMCwgdG9wOiAwIH0sCgkJCXNjcm9sbExlZnQ6IHdpdGhpbkVsZW1lbnQuc2Nyb2xsTGVmdCgpLAoJCQlzY3JvbGxUb3A6IHdpdGhpbkVsZW1lbnQuc2Nyb2xsVG9wKCksCgkJCXdpZHRoOiBpc1dpbmRvdyA\/IHdpdGhpbkVsZW1lbnQud2lkdGgoKSA6IHdpdGhpbkVsZW1lbnQub3V0ZXJXaWR0aCgpLAoJCQloZWlnaHQ6IGlzV2luZG93ID8gd2l0aGluRWxlbWVudC5oZWlnaHQoKSA6IHdpdGhpbkVsZW1lbnQub3V0ZXJIZWlnaHQoKQoJCX07Cgl9Cn07CgokLmZuLnBvc2l0aW9uID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglpZiAoICFvcHRpb25zIHx8ICFvcHRpb25zLm9mICkgewoJCXJldHVybiBfcG9zaXRpb24uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfQoKCS8vIG1ha2UgYSBjb3B5LCB3ZSBkb24ndCB3YW50IHRvIG1vZGlmeSBhcmd1bWVudHMKCW9wdGlvbnMgPSAkLmV4dGVuZCgge30sIG9wdGlvbnMgKTsKCgl2YXIgYXRPZmZzZXQsIHRhcmdldFdpZHRoLCB0YXJnZXRIZWlnaHQsIHRhcmdldE9mZnNldCwgYmFzZVBvc2l0aW9uLCBkaW1lbnNpb25zLAoJCXRhcmdldCA9ICQoIG9wdGlvbnMub2YgKSwKCQl3aXRoaW4gPSAkLnBvc2l0aW9uLmdldFdpdGhpbkluZm8oIG9wdGlvbnMud2l0aGluICksCgkJc2Nyb2xsSW5mbyA9ICQucG9zaXRpb24uZ2V0U2Nyb2xsSW5mbyggd2l0aGluICksCgkJY29sbGlzaW9uID0gKCBvcHRpb25zLmNvbGxpc2lvbiB8fCAiZmxpcCIgKS5zcGxpdCggIiAiICksCgkJb2Zmc2V0cyA9IHt9OwoKCWRpbWVuc2lvbnMgPSBnZXREaW1lbnNpb25zKCB0YXJnZXQgKTsKCWlmICggdGFyZ2V0WzBdLnByZXZlbnREZWZhdWx0ICkgewoJCS8vIGZvcmNlIGxlZnQgdG9wIHRvIGFsbG93IGZsaXBwaW5nCgkJb3B0aW9ucy5hdCA9ICJsZWZ0IHRvcCI7Cgl9Cgl0YXJnZXRXaWR0aCA9IGRpbWVuc2lvbnMud2lkdGg7Cgl0YXJnZXRIZWlnaHQgPSBkaW1lbnNpb25zLmhlaWdodDsKCXRhcmdldE9mZnNldCA9IGRpbWVuc2lvbnMub2Zmc2V0OwoJLy8gY2xvbmUgdG8gcmV1c2Ugb3JpZ2luYWwgdGFyZ2V0T2Zmc2V0IGxhdGVyCgliYXNlUG9zaXRpb24gPSAkLmV4dGVuZCgge30sIHRhcmdldE9mZnNldCApOwoKCS8vIGZvcmNlIG15IGFuZCBhdCB0byBoYXZlIHZhbGlkIGhvcml6b250YWwgYW5kIHZlcnRpY2FsIHBvc2l0aW9ucwoJLy8gaWYgYSB2YWx1ZSBpcyBtaXNzaW5nIG9yIGludmFsaWQsIGl0IHdpbGwgYmUgY29udmVydGVkIHRvIGNlbnRlcgoJJC5lYWNoKCBbICJteSIsICJhdCIgXSwgZnVuY3Rpb24oKSB7CgkJdmFyIHBvcyA9ICggb3B0aW9uc1sgdGhpcyBdIHx8ICIiICkuc3BsaXQoICIgIiApLAoJCQlob3Jpem9udGFsT2Zmc2V0LAoJCQl2ZXJ0aWNhbE9mZnNldDsKCgkJaWYgKCBwb3MubGVuZ3RoID09PSAxKSB7CgkJCXBvcyA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPwoJCQkJcG9zLmNvbmNhdCggWyAiY2VudGVyIiBdICkgOgoJCQkJcnZlcnRpY2FsLnRlc3QoIHBvc1sgMCBdICkgPwoJCQkJCVsgImNlbnRlciIgXS5jb25jYXQoIHBvcyApIDoKCQkJCQlbICJjZW50ZXIiLCAiY2VudGVyIiBdOwoJCX0KCQlwb3NbIDAgXSA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPyBwb3NbIDAgXSA6ICJjZW50ZXIiOwoJCXBvc1sgMSBdID0gcnZlcnRpY2FsLnRlc3QoIHBvc1sgMSBdICkgPyBwb3NbIDEgXSA6ICJjZW50ZXIiOwoKCQkvLyBjYWxjdWxhdGUgb2Zmc2V0cwoJCWhvcml6b250YWxPZmZzZXQgPSByb2Zmc2V0LmV4ZWMoIHBvc1sgMCBdICk7CgkJdmVydGljYWxPZmZzZXQgPSByb2Zmc2V0LmV4ZWMoIHBvc1sgMSBdICk7CgkJb2Zmc2V0c1sgdGhpcyBdID0gWwoJCQlob3Jpem9udGFsT2Zmc2V0ID8gaG9yaXpvbnRhbE9mZnNldFsgMCBdIDogMCwKCQkJdmVydGljYWxPZmZzZXQgPyB2ZXJ0aWNhbE9mZnNldFsgMCBdIDogMAoJCV07CgoJCS8vIHJlZHVjZSB0byBqdXN0IHRoZSBwb3NpdGlvbnMgd2l0aG91dCB0aGUgb2Zmc2V0cwoJCW9wdGlvbnNbIHRoaXMgXSA9IFsKCQkJcnBvc2l0aW9uLmV4ZWMoIHBvc1sgMCBdIClbIDAgXSwKCQkJcnBvc2l0aW9uLmV4ZWMoIHBvc1sgMSBdIClbIDAgXQoJCV07Cgl9KTsKCgkvLyBub3JtYWxpemUgY29sbGlzaW9uIG9wdGlvbgoJaWYgKCBjb2xsaXNpb24ubGVuZ3RoID09PSAxICkgewoJCWNvbGxpc2lvblsgMSBdID0gY29sbGlzaW9uWyAwIF07Cgl9CgoJaWYgKCBvcHRpb25zLmF0WyAwIF0gPT09ICJyaWdodCIgKSB7CgkJYmFzZVBvc2l0aW9uLmxlZnQgKz0gdGFyZ2V0V2lkdGg7Cgl9IGVsc2UgaWYgKCBvcHRpb25zLmF0WyAwIF0gPT09ICJjZW50ZXIiICkgewoJCWJhc2VQb3NpdGlvbi5sZWZ0ICs9IHRhcmdldFdpZHRoIC8gMjsKCX0KCglpZiAoIG9wdGlvbnMuYXRbIDEgXSA9PT0gImJvdHRvbSIgKSB7CgkJYmFzZVBvc2l0aW9uLnRvcCArPSB0YXJnZXRIZWlnaHQ7Cgl9IGVsc2UgaWYgKCBvcHRpb25zLmF0WyAxIF0gPT09ICJjZW50ZXIiICkgewoJCWJhc2VQb3NpdGlvbi50b3AgKz0gdGFyZ2V0SGVpZ2h0IC8gMjsKCX0KCglhdE9mZnNldCA9IGdldE9mZnNldHMoIG9mZnNldHMuYXQsIHRhcmdldFdpZHRoLCB0YXJnZXRIZWlnaHQgKTsKCWJhc2VQb3NpdGlvbi5sZWZ0ICs9IGF0T2Zmc2V0WyAwIF07CgliYXNlUG9zaXRpb24udG9wICs9IGF0T2Zmc2V0WyAxIF07CgoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgY29sbGlzaW9uUG9zaXRpb24sIHVzaW5nLAoJCQllbGVtID0gJCggdGhpcyApLAoJCQllbGVtV2lkdGggPSBlbGVtLm91dGVyV2lkdGgoKSwKCQkJZWxlbUhlaWdodCA9IGVsZW0ub3V0ZXJIZWlnaHQoKSwKCQkJbWFyZ2luTGVmdCA9IHBhcnNlQ3NzKCB0aGlzLCAibWFyZ2luTGVmdCIgKSwKCQkJbWFyZ2luVG9wID0gcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5Ub3AiICksCgkJCWNvbGxpc2lvbldpZHRoID0gZWxlbVdpZHRoICsgbWFyZ2luTGVmdCArIHBhcnNlQ3NzKCB0aGlzLCAibWFyZ2luUmlnaHQiICkgKyBzY3JvbGxJbmZvLndpZHRoLAoJCQljb2xsaXNpb25IZWlnaHQgPSBlbGVtSGVpZ2h0ICsgbWFyZ2luVG9wICsgcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5Cb3R0b20iICkgKyBzY3JvbGxJbmZvLmhlaWdodCwKCQkJcG9zaXRpb24gPSAkLmV4dGVuZCgge30sIGJhc2VQb3NpdGlvbiApLAoJCQlteU9mZnNldCA9IGdldE9mZnNldHMoIG9mZnNldHMubXksIGVsZW0ub3V0ZXJXaWR0aCgpLCBlbGVtLm91dGVySGVpZ2h0KCkgKTsKCgkJaWYgKCBvcHRpb25zLm15WyAwIF0gPT09ICJyaWdodCIgKSB7CgkJCXBvc2l0aW9uLmxlZnQgLT0gZWxlbVdpZHRoOwoJCX0gZWxzZSBpZiAoIG9wdGlvbnMubXlbIDAgXSA9PT0gImNlbnRlciIgKSB7CgkJCXBvc2l0aW9uLmxlZnQgLT0gZWxlbVdpZHRoIC8gMjsKCQl9CgoJCWlmICggb3B0aW9ucy5teVsgMSBdID09PSAiYm90dG9tIiApIHsKCQkJcG9zaXRpb24udG9wIC09IGVsZW1IZWlnaHQ7CgkJfSBlbHNlIGlmICggb3B0aW9ucy5teVsgMSBdID09PSAiY2VudGVyIiApIHsKCQkJcG9zaXRpb24udG9wIC09IGVsZW1IZWlnaHQgLyAyOwoJCX0KCgkJcG9zaXRpb24ubGVmdCArPSBteU9mZnNldFsgMCBdOwoJCXBvc2l0aW9uLnRvcCArPSBteU9mZnNldFsgMSBdOwoKCQkvLyBpZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgZnJhY3Rpb25zLCB0aGVuIHJvdW5kIGZvciBjb25zaXN0ZW50IHJlc3VsdHMKCQlpZiAoICEkLnN1cHBvcnQub2Zmc2V0RnJhY3Rpb25zICkgewoJCQlwb3NpdGlvbi5sZWZ0ID0gcm91bmQoIHBvc2l0aW9uLmxlZnQgKTsKCQkJcG9zaXRpb24udG9wID0gcm91bmQoIHBvc2l0aW9uLnRvcCApOwoJCX0KCgkJY29sbGlzaW9uUG9zaXRpb24gPSB7CgkJCW1hcmdpbkxlZnQ6IG1hcmdpbkxlZnQsCgkJCW1hcmdpblRvcDogbWFyZ2luVG9wCgkJfTsKCgkJJC5lYWNoKCBbICJsZWZ0IiwgInRvcCIgXSwgZnVuY3Rpb24oIGksIGRpciApIHsKCQkJaWYgKCAkLnVpLnBvc2l0aW9uWyBjb2xsaXNpb25bIGkgXSBdICkgewoJCQkJJC51aS5wb3NpdGlvblsgY29sbGlzaW9uWyBpIF0gXVsgZGlyIF0oIHBvc2l0aW9uLCB7CgkJCQkJdGFyZ2V0V2lkdGg6IHRhcmdldFdpZHRoLAoJCQkJCXRhcmdldEhlaWdodDogdGFyZ2V0SGVpZ2h0LAoJCQkJCWVsZW1XaWR0aDogZWxlbVdpZHRoLAoJCQkJCWVsZW1IZWlnaHQ6IGVsZW1IZWlnaHQsCgkJCQkJY29sbGlzaW9uUG9zaXRpb246IGNvbGxpc2lvblBvc2l0aW9uLAoJCQkJCWNvbGxpc2lvbldpZHRoOiBjb2xsaXNpb25XaWR0aCwKCQkJCQljb2xsaXNpb25IZWlnaHQ6IGNvbGxpc2lvbkhlaWdodCwKCQkJCQlvZmZzZXQ6IFsgYXRPZmZzZXRbIDAgXSArIG15T2Zmc2V0WyAwIF0sIGF0T2Zmc2V0IFsgMSBdICsgbXlPZmZzZXRbIDEgXSBdLAoJCQkJCW15OiBvcHRpb25zLm15LAoJCQkJCWF0OiBvcHRpb25zLmF0LAoJCQkJCXdpdGhpbjogd2l0aGluLAoJCQkJCWVsZW0gOiBlbGVtCgkJCQl9KTsKCQkJfQoJCX0pOwoKCQlpZiAoIG9wdGlvbnMudXNpbmcgKSB7CgkJCS8vIGFkZHMgZmVlZGJhY2sgYXMgc2Vjb25kIGFyZ3VtZW50IHRvIHVzaW5nIGNhbGxiYWNrLCBpZiBwcmVzZW50CgkJCXVzaW5nID0gZnVuY3Rpb24oIHByb3BzICkgewoJCQkJdmFyIGxlZnQgPSB0YXJnZXRPZmZzZXQubGVmdCAtIHBvc2l0aW9uLmxlZnQsCgkJCQkJcmlnaHQgPSBsZWZ0ICsgdGFyZ2V0V2lkdGggLSBlbGVtV2lkdGgsCgkJCQkJdG9wID0gdGFyZ2V0T2Zmc2V0LnRvcCAtIHBvc2l0aW9uLnRvcCwKCQkJCQlib3R0b20gPSB0b3AgKyB0YXJnZXRIZWlnaHQgLSBlbGVtSGVpZ2h0LAoJCQkJCWZlZWRiYWNrID0gewoJCQkJCQl0YXJnZXQ6IHsKCQkJCQkJCWVsZW1lbnQ6IHRhcmdldCwKCQkJCQkJCWxlZnQ6IHRhcmdldE9mZnNldC5sZWZ0LAoJCQkJCQkJdG9wOiB0YXJnZXRPZmZzZXQudG9wLAoJCQkJCQkJd2lkdGg6IHRhcmdldFdpZHRoLAoJCQkJCQkJaGVpZ2h0OiB0YXJnZXRIZWlnaHQKCQkJCQkJfSwKCQkJCQkJZWxlbWVudDogewoJCQkJCQkJZWxlbWVudDogZWxlbSwKCQkJCQkJCWxlZnQ6IHBvc2l0aW9uLmxlZnQsCgkJCQkJCQl0b3A6IHBvc2l0aW9uLnRvcCwKCQkJCQkJCXdpZHRoOiBlbGVtV2lkdGgsCgkJCQkJCQloZWlnaHQ6IGVsZW1IZWlnaHQKCQkJCQkJfSwKCQkJCQkJaG9yaXpvbnRhbDogcmlnaHQgPCAwID8gImxlZnQiIDogbGVmdCA+IDAgPyAicmlnaHQiIDogImNlbnRlciIsCgkJCQkJCXZlcnRpY2FsOiBib3R0b20gPCAwID8gInRvcCIgOiB0b3AgPiAwID8gImJvdHRvbSIgOiAibWlkZGxlIgoJCQkJCX07CgkJCQlpZiAoIHRhcmdldFdpZHRoIDwgZWxlbVdpZHRoICYmIGFicyggbGVmdCArIHJpZ2h0ICkgPCB0YXJnZXRXaWR0aCApIHsKCQkJCQlmZWVkYmFjay5ob3Jpem9udGFsID0gImNlbnRlciI7CgkJCQl9CgkJCQlpZiAoIHRhcmdldEhlaWdodCA8IGVsZW1IZWlnaHQgJiYgYWJzKCB0b3AgKyBib3R0b20gKSA8IHRhcmdldEhlaWdodCApIHsKCQkJCQlmZWVkYmFjay52ZXJ0aWNhbCA9ICJtaWRkbGUiOwoJCQkJfQoJCQkJaWYgKCBtYXgoIGFicyggbGVmdCApLCBhYnMoIHJpZ2h0ICkgKSA+IG1heCggYWJzKCB0b3AgKSwgYWJzKCBib3R0b20gKSApICkgewoJCQkJCWZlZWRiYWNrLmltcG9ydGFudCA9ICJob3Jpem9udGFsIjsKCQkJCX0gZWxzZSB7CgkJCQkJZmVlZGJhY2suaW1wb3J0YW50ID0gInZlcnRpY2FsIjsKCQkJCX0KCQkJCW9wdGlvbnMudXNpbmcuY2FsbCggdGhpcywgcHJvcHMsIGZlZWRiYWNrICk7CgkJCX07CgkJfQoKCQllbGVtLm9mZnNldCggJC5leHRlbmQoIHBvc2l0aW9uLCB7IHVzaW5nOiB1c2luZyB9ICkgKTsKCX0pOwp9OwoKJC51aS5wb3NpdGlvbiA9IHsKCWZpdDogewoJCWxlZnQ6IGZ1bmN0aW9uKCBwb3NpdGlvbiwgZGF0YSApIHsKCQkJdmFyIHdpdGhpbiA9IGRhdGEud2l0aGluLAoJCQkJd2l0aGluT2Zmc2V0ID0gd2l0aGluLmlzV2luZG93ID8gd2l0aGluLnNjcm9sbExlZnQgOiB3aXRoaW4ub2Zmc2V0LmxlZnQsCgkJCQlvdXRlcldpZHRoID0gd2l0aGluLndpZHRoLAoJCQkJY29sbGlzaW9uUG9zTGVmdCA9IHBvc2l0aW9uLmxlZnQgLSBkYXRhLmNvbGxpc2lvblBvc2l0aW9uLm1hcmdpbkxlZnQsCgkJCQlvdmVyTGVmdCA9IHdpdGhpbk9mZnNldCAtIGNvbGxpc2lvblBvc0xlZnQsCgkJCQlvdmVyUmlnaHQgPSBjb2xsaXNpb25Qb3NMZWZ0ICsgZGF0YS5jb2xsaXNpb25XaWR0aCAtIG91dGVyV2lkdGggLSB3aXRoaW5PZmZzZXQsCgkJCQluZXdPdmVyUmlnaHQ7CgoJCQkvLyBlbGVtZW50IGlzIHdpZGVyIHRoYW4gd2l0aGluCgkJCWlmICggZGF0YS5jb2xsaXNpb25XaWR0aCA+IG91dGVyV2lkdGggKSB7CgkJCQkvLyBlbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIHRoZSBsZWZ0IHNpZGUgb2Ygd2l0aGluCgkJCQlpZiAoIG92ZXJMZWZ0ID4gMCAmJiBvdmVyUmlnaHQgPD0gMCApIHsKCQkJCQluZXdPdmVyUmlnaHQgPSBwb3NpdGlvbi5sZWZ0ICsgb3ZlckxlZnQgKyBkYXRhLmNvbGxpc2lvbldpZHRoIC0gb3V0ZXJXaWR0aCAtIHdpdGhpbk9mZnNldDsKCQkJCQlwb3NpdGlvbi5sZWZ0ICs9IG92ZXJMZWZ0IC0gbmV3T3ZlclJpZ2h0OwoJCQkJLy8gZWxlbWVudCBpcyBpbml0aWFsbHkgb3ZlciByaWdodCBzaWRlIG9mIHdpdGhpbgoJCQkJfSBlbHNlIGlmICggb3ZlclJpZ2h0ID4gMCAmJiBvdmVyTGVmdCA8PSAwICkgewoJCQkJCXBvc2l0aW9uLmxlZnQgPSB3aXRoaW5PZmZzZXQ7CgkJCQkvLyBlbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIGJvdGggbGVmdCBhbmQgcmlnaHQgc2lkZXMgb2Ygd2l0aGluCgkJCQl9IGVsc2UgewoJCQkJCWlmICggb3ZlckxlZnQgPiBvdmVyUmlnaHQgKSB7CgkJCQkJCXBvc2l0aW9uLmxlZnQgPSB3aXRoaW5PZmZzZXQgKyBvdXRlcldpZHRoIC0gZGF0YS5jb2xsaXNpb25XaWR0aDsKCQkJCQl9IGVsc2UgewoJCQkJCQlwb3NpdGlvbi5sZWZ0ID0gd2l0aGluT2Zmc2V0OwoJCQkJCX0KCQkJCX0KCQkJLy8gdG9vIGZhciBsZWZ0IC0+IGFsaWduIHdpdGggbGVmdCBlZGdlCgkJCX0gZWxzZSBpZiAoIG92ZXJMZWZ0ID4gMCApIHsKCQkJCXBvc2l0aW9uLmxlZnQgKz0gb3ZlckxlZnQ7CgkJCS8vIHRvbyBmYXIgcmlnaHQgLT4gYWxpZ24gd2l0aCByaWdodCBlZGdlCgkJCX0gZWxzZSBpZiAoIG92ZXJSaWdodCA+IDAgKSB7CgkJCQlwb3NpdGlvbi5sZWZ0IC09IG92ZXJSaWdodDsKCQkJLy8gYWRqdXN0IGJhc2VkIG9uIHBvc2l0aW9uIGFuZCBtYXJnaW4KCQkJfSBlbHNlIHsKCQkJCXBvc2l0aW9uLmxlZnQgPSBtYXgoIHBvc2l0aW9uLmxlZnQgLSBjb2xsaXNpb25Qb3NMZWZ0LCBwb3NpdGlvbi5sZWZ0ICk7CgkJCX0KCQl9LAoJCXRvcDogZnVuY3Rpb24oIHBvc2l0aW9uLCBkYXRhICkgewoJCQl2YXIgd2l0aGluID0gZGF0YS53aXRoaW4sCgkJCQl3aXRoaW5PZmZzZXQgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsVG9wIDogd2l0aGluLm9mZnNldC50b3AsCgkJCQlvdXRlckhlaWdodCA9IGRhdGEud2l0aGluLmhlaWdodCwKCQkJCWNvbGxpc2lvblBvc1RvcCA9IHBvc2l0aW9uLnRvcCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luVG9wLAoJCQkJb3ZlclRvcCA9IHdpdGhpbk9mZnNldCAtIGNvbGxpc2lvblBvc1RvcCwKCQkJCW92ZXJCb3R0b20gPSBjb2xsaXNpb25Qb3NUb3AgKyBkYXRhLmNvbGxpc2lvbkhlaWdodCAtIG91dGVySGVpZ2h0IC0gd2l0aGluT2Zmc2V0LAoJCQkJbmV3T3ZlckJvdHRvbTsKCgkJCS8vIGVsZW1lbnQgaXMgdGFsbGVyIHRoYW4gd2l0aGluCgkJCWlmICggZGF0YS5jb2xsaXNpb25IZWlnaHQgPiBvdXRlckhlaWdodCApIHsKCQkJCS8vIGVsZW1lbnQgaXMgaW5pdGlhbGx5IG92ZXIgdGhlIHRvcCBvZiB3aXRoaW4KCQkJCWlmICggb3ZlclRvcCA+IDAgJiYgb3ZlckJvdHRvbSA8PSAwICkgewoJCQkJCW5ld092ZXJCb3R0b20gPSBwb3NpdGlvbi50b3AgKyBvdmVyVG9wICsgZGF0YS5jb2xsaXNpb25IZWlnaHQgLSBvdXRlckhlaWdodCAtIHdpdGhpbk9mZnNldDsKCQkJCQlwb3NpdGlvbi50b3AgKz0gb3ZlclRvcCAtIG5ld092ZXJCb3R0b207CgkJCQkvLyBlbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIGJvdHRvbSBvZiB3aXRoaW4KCQkJCX0gZWxzZSBpZiAoIG92ZXJCb3R0b20gPiAwICYmIG92ZXJUb3AgPD0gMCApIHsKCQkJCQlwb3NpdGlvbi50b3AgPSB3aXRoaW5PZmZzZXQ7CgkJCQkvLyBlbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIGJvdGggdG9wIGFuZCBib3R0b20gb2Ygd2l0aGluCgkJCQl9IGVsc2UgewoJCQkJCWlmICggb3ZlclRvcCA+IG92ZXJCb3R0b20gKSB7CgkJCQkJCXBvc2l0aW9uLnRvcCA9IHdpdGhpbk9mZnNldCArIG91dGVySGVpZ2h0IC0gZGF0YS5jb2xsaXNpb25IZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcG9zaXRpb24udG9wID0gd2l0aGluT2Zmc2V0OwoJCQkJCX0KCQkJCX0KCQkJLy8gdG9vIGZhciB1cCAtPiBhbGlnbiB3aXRoIHRvcAoJCQl9IGVsc2UgaWYgKCBvdmVyVG9wID4gMCApIHsKCQkJCXBvc2l0aW9uLnRvcCArPSBvdmVyVG9wOwoJCQkvLyB0b28gZmFyIGRvd24gLT4gYWxpZ24gd2l0aCBib3R0b20gZWRnZQoJCQl9IGVsc2UgaWYgKCBvdmVyQm90dG9tID4gMCApIHsKCQkJCXBvc2l0aW9uLnRvcCAtPSBvdmVyQm90dG9tOwoJCQkvLyBhZGp1c3QgYmFzZWQgb24gcG9zaXRpb24gYW5kIG1hcmdpbgoJCQl9IGVsc2UgewoJCQkJcG9zaXRpb24udG9wID0gbWF4KCBwb3NpdGlvbi50b3AgLSBjb2xsaXNpb25Qb3NUb3AsIHBvc2l0aW9uLnRvcCApOwoJCQl9CgkJfQoJfSwKCWZsaXA6IHsKCQlsZWZ0OiBmdW5jdGlvbiggcG9zaXRpb24sIGRhdGEgKSB7CgkJCXZhciB3aXRoaW4gPSBkYXRhLndpdGhpbiwKCQkJCXdpdGhpbk9mZnNldCA9IHdpdGhpbi5vZmZzZXQubGVmdCArIHdpdGhpbi5zY3JvbGxMZWZ0LAoJCQkJb3V0ZXJXaWR0aCA9IHdpdGhpbi53aWR0aCwKCQkJCW9mZnNldExlZnQgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsTGVmdCA6IHdpdGhpbi5vZmZzZXQubGVmdCwKCQkJCWNvbGxpc2lvblBvc0xlZnQgPSBwb3NpdGlvbi5sZWZ0IC0gZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5MZWZ0LAoJCQkJb3ZlckxlZnQgPSBjb2xsaXNpb25Qb3NMZWZ0IC0gb2Zmc2V0TGVmdCwKCQkJCW92ZXJSaWdodCA9IGNvbGxpc2lvblBvc0xlZnQgKyBkYXRhLmNvbGxpc2lvbldpZHRoIC0gb3V0ZXJXaWR0aCAtIG9mZnNldExlZnQsCgkJCQlteU9mZnNldCA9IGRhdGEubXlbIDAgXSA9PT0gImxlZnQiID8KCQkJCQktZGF0YS5lbGVtV2lkdGggOgoJCQkJCWRhdGEubXlbIDAgXSA9PT0gInJpZ2h0IiA\/CgkJCQkJCWRhdGEuZWxlbVdpZHRoIDoKCQkJCQkJMCwKCQkJCWF0T2Zmc2V0ID0gZGF0YS5hdFsgMCBdID09PSAibGVmdCIgPwoJCQkJCWRhdGEudGFyZ2V0V2lkdGggOgoJCQkJCWRhdGEuYXRbIDAgXSA9PT0gInJpZ2h0IiA\/CgkJCQkJCS1kYXRhLnRhcmdldFdpZHRoIDoKCQkJCQkJMCwKCQkJCW9mZnNldCA9IC0yICogZGF0YS5vZmZzZXRbIDAgXSwKCQkJCW5ld092ZXJSaWdodCwKCQkJCW5ld092ZXJMZWZ0OwoKCQkJaWYgKCBvdmVyTGVmdCA8IDAgKSB7CgkJCQluZXdPdmVyUmlnaHQgPSBwb3NpdGlvbi5sZWZ0ICsgbXlPZmZzZXQgKyBhdE9mZnNldCArIG9mZnNldCArIGRhdGEuY29sbGlzaW9uV2lkdGggLSBvdXRlcldpZHRoIC0gd2l0aGluT2Zmc2V0OwoJCQkJaWYgKCBuZXdPdmVyUmlnaHQgPCAwIHx8IG5ld092ZXJSaWdodCA8IGFicyggb3ZlckxlZnQgKSApIHsKCQkJCQlwb3NpdGlvbi5sZWZ0ICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7CgkJCQl9CgkJCX0KCQkJZWxzZSBpZiAoIG92ZXJSaWdodCA+IDAgKSB7CgkJCQluZXdPdmVyTGVmdCA9IHBvc2l0aW9uLmxlZnQgLSBkYXRhLmNvbGxpc2lvblBvc2l0aW9uLm1hcmdpbkxlZnQgKyBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0IC0gb2Zmc2V0TGVmdDsKCQkJCWlmICggbmV3T3ZlckxlZnQgPiAwIHx8IGFicyggbmV3T3ZlckxlZnQgKSA8IG92ZXJSaWdodCApIHsKCQkJCQlwb3NpdGlvbi5sZWZ0ICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7CgkJCQl9CgkJCX0KCQl9LAoJCXRvcDogZnVuY3Rpb24oIHBvc2l0aW9uLCBkYXRhICkgewoJCQl2YXIgd2l0aGluID0gZGF0YS53aXRoaW4sCgkJCQl3aXRoaW5PZmZzZXQgPSB3aXRoaW4ub2Zmc2V0LnRvcCArIHdpdGhpbi5zY3JvbGxUb3AsCgkJCQlvdXRlckhlaWdodCA9IHdpdGhpbi5oZWlnaHQsCgkJCQlvZmZzZXRUb3AgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsVG9wIDogd2l0aGluLm9mZnNldC50b3AsCgkJCQljb2xsaXNpb25Qb3NUb3AgPSBwb3NpdGlvbi50b3AgLSBkYXRhLmNvbGxpc2lvblBvc2l0aW9uLm1hcmdpblRvcCwKCQkJCW92ZXJUb3AgPSBjb2xsaXNpb25Qb3NUb3AgLSBvZmZzZXRUb3AsCgkJCQlvdmVyQm90dG9tID0gY29sbGlzaW9uUG9zVG9wICsgZGF0YS5jb2xsaXNpb25IZWlnaHQgLSBvdXRlckhlaWdodCAtIG9mZnNldFRvcCwKCQkJCXRvcCA9IGRhdGEubXlbIDEgXSA9PT0gInRvcCIsCgkJCQlteU9mZnNldCA9IHRvcCA\/CgkJCQkJLWRhdGEuZWxlbUhlaWdodCA6CgkJCQkJZGF0YS5teVsgMSBdID09PSAiYm90dG9tIiA\/CgkJCQkJCWRhdGEuZWxlbUhlaWdodCA6CgkJCQkJCTAsCgkJCQlhdE9mZnNldCA9IGRhdGEuYXRbIDEgXSA9PT0gInRvcCIgPwoJCQkJCWRhdGEudGFyZ2V0SGVpZ2h0IDoKCQkJCQlkYXRhLmF0WyAxIF0gPT09ICJib3R0b20iID8KCQkJCQkJLWRhdGEudGFyZ2V0SGVpZ2h0IDoKCQkJCQkJMCwKCQkJCW9mZnNldCA9IC0yICogZGF0YS5vZmZzZXRbIDEgXSwKCQkJCW5ld092ZXJUb3AsCgkJCQluZXdPdmVyQm90dG9tOwoJCQlpZiAoIG92ZXJUb3AgPCAwICkgewoJCQkJbmV3T3ZlckJvdHRvbSA9IHBvc2l0aW9uLnRvcCArIG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQgKyBkYXRhLmNvbGxpc2lvbkhlaWdodCAtIG91dGVySGVpZ2h0IC0gd2l0aGluT2Zmc2V0OwoJCQkJaWYgKCAoIHBvc2l0aW9uLnRvcCArIG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQpID4gb3ZlclRvcCAmJiAoIG5ld092ZXJCb3R0b20gPCAwIHx8IG5ld092ZXJCb3R0b20gPCBhYnMoIG92ZXJUb3AgKSApICkgewoJCQkJCXBvc2l0aW9uLnRvcCArPSBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0OwoJCQkJfQoJCQl9CgkJCWVsc2UgaWYgKCBvdmVyQm90dG9tID4gMCApIHsKCQkJCW5ld092ZXJUb3AgPSBwb3NpdGlvbi50b3AgLSAgZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5Ub3AgKyBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0IC0gb2Zmc2V0VG9wOwoJCQkJaWYgKCAoIHBvc2l0aW9uLnRvcCArIG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQpID4gb3ZlckJvdHRvbSAmJiAoIG5ld092ZXJUb3AgPiAwIHx8IGFicyggbmV3T3ZlclRvcCApIDwgb3ZlckJvdHRvbSApICkgewoJCQkJCXBvc2l0aW9uLnRvcCArPSBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0OwoJCQkJfQoJCQl9CgkJfQoJfSwKCWZsaXBmaXQ6IHsKCQlsZWZ0OiBmdW5jdGlvbigpIHsKCQkJJC51aS5wb3NpdGlvbi5mbGlwLmxlZnQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkkLnVpLnBvc2l0aW9uLmZpdC5sZWZ0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9LAoJCXRvcDogZnVuY3Rpb24oKSB7CgkJCSQudWkucG9zaXRpb24uZmxpcC50b3AuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkkLnVpLnBvc2l0aW9uLmZpdC50b3AuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX0KCX0KfTsKCi8vIGZyYWN0aW9uIHN1cHBvcnQgdGVzdAooZnVuY3Rpb24gKCkgewoJdmFyIHRlc3RFbGVtZW50LCB0ZXN0RWxlbWVudFBhcmVudCwgdGVzdEVsZW1lbnRTdHlsZSwgb2Zmc2V0TGVmdCwgaSwKCQlib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJib2R5IiApWyAwIF0sCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCgkvL0NyZWF0ZSBhICJmYWtlIGJvZHkiIGZvciB0ZXN0aW5nIGJhc2VkIG9uIG1ldGhvZCB1c2VkIGluIGpRdWVyeS5zdXBwb3J0Cgl0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIGJvZHkgPyAiZGl2IiA6ICJib2R5IiApOwoJdGVzdEVsZW1lbnRTdHlsZSA9IHsKCQl2aXNpYmlsaXR5OiAiaGlkZGVuIiwKCQl3aWR0aDogMCwKCQloZWlnaHQ6IDAsCgkJYm9yZGVyOiAwLAoJCW1hcmdpbjogMCwKCQliYWNrZ3JvdW5kOiAibm9uZSIKCX07CglpZiAoIGJvZHkgKSB7CgkJJC5leHRlbmQoIHRlc3RFbGVtZW50U3R5bGUsIHsKCQkJcG9zaXRpb246ICJhYnNvbHV0ZSIsCgkJCWxlZnQ6ICItMTAwMHB4IiwKCQkJdG9wOiAiLTEwMDBweCIKCQl9KTsKCX0KCWZvciAoIGkgaW4gdGVzdEVsZW1lbnRTdHlsZSApIHsKCQl0ZXN0RWxlbWVudC5zdHlsZVsgaSBdID0gdGVzdEVsZW1lbnRTdHlsZVsgaSBdOwoJfQoJdGVzdEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGRpdiApOwoJdGVzdEVsZW1lbnRQYXJlbnQgPSBib2R5IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCXRlc3RFbGVtZW50UGFyZW50Lmluc2VydEJlZm9yZSggdGVzdEVsZW1lbnQsIHRlc3RFbGVtZW50UGFyZW50LmZpcnN0Q2hpbGQgKTsKCglkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjogYWJzb2x1dGU7IGxlZnQ6IDEwLjc0MzIyMjJweDsiOwoKCW9mZnNldExlZnQgPSAkKCBkaXYgKS5vZmZzZXQoKS5sZWZ0OwoJJC5zdXBwb3J0Lm9mZnNldEZyYWN0aW9ucyA9IG9mZnNldExlZnQgPiAxMCAmJiBvZmZzZXRMZWZ0IDwgMTE7CgoJdGVzdEVsZW1lbnQuaW5uZXJIVE1MID0gIiI7Cgl0ZXN0RWxlbWVudFBhcmVudC5yZW1vdmVDaGlsZCggdGVzdEVsZW1lbnQgKTsKfSkoKTsKCn0oIGpRdWVyeSApICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoInVpLmRyYWdnYWJsZSIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJkcmFnIiwKCW9wdGlvbnM6IHsKCQlhZGRDbGFzc2VzOiB0cnVlLAoJCWFwcGVuZFRvOiAicGFyZW50IiwKCQlheGlzOiBmYWxzZSwKCQljb25uZWN0VG9Tb3J0YWJsZTogZmFsc2UsCgkJY29udGFpbm1lbnQ6IGZhbHNlLAoJCWN1cnNvcjogImF1dG8iLAoJCWN1cnNvckF0OiBmYWxzZSwKCQlncmlkOiBmYWxzZSwKCQloYW5kbGU6IGZhbHNlLAoJCWhlbHBlcjogIm9yaWdpbmFsIiwKCQlpZnJhbWVGaXg6IGZhbHNlLAoJCW9wYWNpdHk6IGZhbHNlLAoJCXJlZnJlc2hQb3NpdGlvbnM6IGZhbHNlLAoJCXJldmVydDogZmFsc2UsCgkJcmV2ZXJ0RHVyYXRpb246IDUwMCwKCQlzY29wZTogImRlZmF1bHQiLAoJCXNjcm9sbDogdHJ1ZSwKCQlzY3JvbGxTZW5zaXRpdml0eTogMjAsCgkJc2Nyb2xsU3BlZWQ6IDIwLAoJCXNuYXA6IGZhbHNlLAoJCXNuYXBNb2RlOiAiYm90aCIsCgkJc25hcFRvbGVyYW5jZTogMjAsCgkJc3RhY2s6IGZhbHNlLAoJCXpJbmRleDogZmFsc2UsCgoJCS8vIGNhbGxiYWNrcwoJCWRyYWc6IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbAoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAodGhpcy5vcHRpb25zLmhlbHBlciA9PT0gIm9yaWdpbmFsIiAmJiAhKC9eKD86cnxhfGYpLykudGVzdCh0aGlzLmVsZW1lbnQuY3NzKCJwb3NpdGlvbiIpKSkgewoJCQl0aGlzLmVsZW1lbnRbMF0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwoJCX0KCQlpZiAodGhpcy5vcHRpb25zLmFkZENsYXNzZXMpewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoInVpLWRyYWdnYWJsZSIpOwoJCX0KCQlpZiAodGhpcy5vcHRpb25zLmRpc2FibGVkKXsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCJ1aS1kcmFnZ2FibGUtZGlzYWJsZWQiKTsKCQl9CgoJCXRoaXMuX21vdXNlSW5pdCgpOwoKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWRyYWdnYWJsZSB1aS1kcmFnZ2FibGUtZHJhZ2dpbmcgdWktZHJhZ2dhYmxlLWRpc2FibGVkIiApOwoJCXRoaXMuX21vdXNlRGVzdHJveSgpOwoJfSwKCglfbW91c2VDYXB0dXJlOiBmdW5jdGlvbihldmVudCkgewoKCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gYW1vbmcgb3RoZXJzLCBwcmV2ZW50IGEgZHJhZyBvbiBhIHJlc2l6YWJsZS1oYW5kbGUKCQlpZiAodGhpcy5oZWxwZXIgfHwgby5kaXNhYmxlZCB8fCAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgiLnVpLXJlc2l6YWJsZS1oYW5kbGUiKS5sZW5ndGggPiAwKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vUXVpdCBpZiB3ZSdyZSBub3Qgb24gYSB2YWxpZCBoYW5kbGUKCQl0aGlzLmhhbmRsZSA9IHRoaXMuX2dldEhhbmRsZShldmVudCk7CgkJaWYgKCF0aGlzLmhhbmRsZSkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkkKG8uaWZyYW1lRml4ID09PSB0cnVlID8gImlmcmFtZSIgOiBvLmlmcmFtZUZpeCkuZWFjaChmdW5jdGlvbigpIHsKCQkJJCgiPGRpdiBjbGFzcz0ndWktZHJhZ2dhYmxlLWlmcmFtZUZpeCcgc3R5bGU9J2JhY2tncm91bmQ6ICNmZmY7Jz48L2Rpdj4iKQoJCQkuY3NzKHsKCQkJCXdpZHRoOiB0aGlzLm9mZnNldFdpZHRoKyJweCIsIGhlaWdodDogdGhpcy5vZmZzZXRIZWlnaHQrInB4IiwKCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLCBvcGFjaXR5OiAiMC4wMDEiLCB6SW5kZXg6IDEwMDAKCQkJfSkKCQkJLmNzcygkKHRoaXMpLm9mZnNldCgpKQoJCQkuYXBwZW5kVG8oImJvZHkiKTsKCQl9KTsKCgkJcmV0dXJuIHRydWU7CgoJfSwKCglfbW91c2VTdGFydDogZnVuY3Rpb24oZXZlbnQpIHsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vQ3JlYXRlIGFuZCBhcHBlbmQgdGhlIHZpc2libGUgaGVscGVyCgkJdGhpcy5oZWxwZXIgPSB0aGlzLl9jcmVhdGVIZWxwZXIoZXZlbnQpOwoKCQl0aGlzLmhlbHBlci5hZGRDbGFzcygidWktZHJhZ2dhYmxlLWRyYWdnaW5nIik7CgoJCS8vQ2FjaGUgdGhlIGhlbHBlciBzaXplCgkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOwoKCQkvL0lmIGRkbWFuYWdlciBpcyB1c2VkIGZvciBkcm9wcGFibGVzLCBzZXQgdGhlIGdsb2JhbCBkcmFnZ2FibGUKCQlpZigkLnVpLmRkbWFuYWdlcikgewoJCQkkLnVpLmRkbWFuYWdlci5jdXJyZW50ID0gdGhpczsKCQl9CgoJCS8qCgkJICogLSBQb3NpdGlvbiBnZW5lcmF0aW9uIC0KCQkgKiBUaGlzIGJsb2NrIGdlbmVyYXRlcyBldmVyeXRoaW5nIHBvc2l0aW9uIHJlbGF0ZWQgLSBpdCdzIHRoZSBjb3JlIG9mIGRyYWdnYWJsZXMuCgkJICovCgoJCS8vQ2FjaGUgdGhlIG1hcmdpbnMgb2YgdGhlIG9yaWdpbmFsIGVsZW1lbnQKCQl0aGlzLl9jYWNoZU1hcmdpbnMoKTsKCgkJLy9TdG9yZSB0aGUgaGVscGVyJ3MgY3NzIHBvc2l0aW9uCgkJdGhpcy5jc3NQb3NpdGlvbiA9IHRoaXMuaGVscGVyLmNzcyggInBvc2l0aW9uIiApOwoJCXRoaXMuc2Nyb2xsUGFyZW50ID0gdGhpcy5oZWxwZXIuc2Nyb2xsUGFyZW50KCk7CgkJdGhpcy5vZmZzZXRQYXJlbnQgPSB0aGlzLmhlbHBlci5vZmZzZXRQYXJlbnQoKTsKCQl0aGlzLm9mZnNldFBhcmVudENzc1Bvc2l0aW9uID0gdGhpcy5vZmZzZXRQYXJlbnQuY3NzKCAicG9zaXRpb24iICk7CgoJCS8vVGhlIGVsZW1lbnQncyBhYnNvbHV0ZSBwb3NpdGlvbiBvbiB0aGUgcGFnZSBtaW51cyBtYXJnaW5zCgkJdGhpcy5vZmZzZXQgPSB0aGlzLnBvc2l0aW9uQWJzID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOwoJCXRoaXMub2Zmc2V0ID0gewoJCQl0b3A6IHRoaXMub2Zmc2V0LnRvcCAtIHRoaXMubWFyZ2lucy50b3AsCgkJCWxlZnQ6IHRoaXMub2Zmc2V0LmxlZnQgLSB0aGlzLm1hcmdpbnMubGVmdAoJCX07CgoJCS8vUmVzZXQgc2Nyb2xsIGNhY2hlCgkJdGhpcy5vZmZzZXQuc2Nyb2xsID0gZmFsc2U7CgoJCSQuZXh0ZW5kKHRoaXMub2Zmc2V0LCB7CgkJCWNsaWNrOiB7IC8vV2hlcmUgdGhlIGNsaWNrIGhhcHBlbmVkLCByZWxhdGl2ZSB0byB0aGUgZWxlbWVudAoJCQkJbGVmdDogZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5sZWZ0LAoJCQkJdG9wOiBldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LnRvcAoJCQl9LAoJCQlwYXJlbnQ6IHRoaXMuX2dldFBhcmVudE9mZnNldCgpLAoJCQlyZWxhdGl2ZTogdGhpcy5fZ2V0UmVsYXRpdmVPZmZzZXQoKSAvL1RoaXMgaXMgYSByZWxhdGl2ZSB0byBhYnNvbHV0ZSBwb3NpdGlvbiBtaW51cyB0aGUgYWN0dWFsIHBvc2l0aW9uIGNhbGN1bGF0aW9uIC0gb25seSB1c2VkIGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIGhlbHBlcgoJCX0pOwoKCQkvL0dlbmVyYXRlIHRoZSBvcmlnaW5hbCBwb3NpdGlvbgoJCXRoaXMub3JpZ2luYWxQb3NpdGlvbiA9IHRoaXMucG9zaXRpb24gPSB0aGlzLl9nZW5lcmF0ZVBvc2l0aW9uKGV2ZW50KTsKCQl0aGlzLm9yaWdpbmFsUGFnZVggPSBldmVudC5wYWdlWDsKCQl0aGlzLm9yaWdpbmFsUGFnZVkgPSBldmVudC5wYWdlWTsKCgkJLy9BZGp1c3QgdGhlIG1vdXNlIG9mZnNldCByZWxhdGl2ZSB0byB0aGUgaGVscGVyIGlmICJjdXJzb3JBdCIgaXMgc3VwcGxpZWQKCQkoby5jdXJzb3JBdCAmJiB0aGlzLl9hZGp1c3RPZmZzZXRGcm9tSGVscGVyKG8uY3Vyc29yQXQpKTsKCgkJLy9TZXQgYSBjb250YWlubWVudCBpZiBnaXZlbiBpbiB0aGUgb3B0aW9ucwoJCXRoaXMuX3NldENvbnRhaW5tZW50KCk7CgoJCS8vVHJpZ2dlciBldmVudCArIGNhbGxiYWNrcwoJCWlmKHRoaXMuX3RyaWdnZXIoInN0YXJ0IiwgZXZlbnQpID09PSBmYWxzZSkgewoJCQl0aGlzLl9jbGVhcigpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvL1JlY2FjaGUgdGhlIGhlbHBlciBzaXplCgkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOwoKCQkvL1ByZXBhcmUgdGhlIGRyb3BwYWJsZSBvZmZzZXRzCgkJaWYgKCQudWkuZGRtYW5hZ2VyICYmICFvLmRyb3BCZWhhdmlvdXIpIHsKCQkJJC51aS5kZG1hbmFnZXIucHJlcGFyZU9mZnNldHModGhpcywgZXZlbnQpOwoJCX0KCgoJCXRoaXMuX21vdXNlRHJhZyhldmVudCwgdHJ1ZSk7IC8vRXhlY3V0ZSB0aGUgZHJhZyBvbmNlIC0gdGhpcyBjYXVzZXMgdGhlIGhlbHBlciBub3QgdG8gYmUgdmlzaWJsZSBiZWZvcmUgZ2V0dGluZyBpdHMgY29ycmVjdCBwb3NpdGlvbgoKCQkvL0lmIHRoZSBkZG1hbmFnZXIgaXMgdXNlZCBmb3IgZHJvcHBhYmxlcywgaW5mb3JtIHRoZSBtYW5hZ2VyIHRoYXQgZHJhZ2dpbmcgaGFzIHN0YXJ0ZWQgKHNlZSAjNTAwMykKCQlpZiAoICQudWkuZGRtYW5hZ2VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5kcmFnU3RhcnQodGhpcywgZXZlbnQpOwoJCX0KCgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZURyYWc6IGZ1bmN0aW9uKGV2ZW50LCBub1Byb3BhZ2F0aW9uKSB7CgkJLy8gcmVzZXQgYW55IG5lY2Vzc2FyeSBjYWNoZWQgcHJvcGVydGllcyAoc2VlICM1MDA5KQoJCWlmICggdGhpcy5vZmZzZXRQYXJlbnRDc3NQb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJdGhpcy5vZmZzZXQucGFyZW50ID0gdGhpcy5fZ2V0UGFyZW50T2Zmc2V0KCk7CgkJfQoKCQkvL0NvbXB1dGUgdGhlIGhlbHBlcnMgcG9zaXRpb24KCQl0aGlzLnBvc2l0aW9uID0gdGhpcy5fZ2VuZXJhdGVQb3NpdGlvbihldmVudCk7CgkJdGhpcy5wb3NpdGlvbkFicyA9IHRoaXMuX2NvbnZlcnRQb3NpdGlvblRvKCJhYnNvbHV0ZSIpOwoKCQkvL0NhbGwgcGx1Z2lucyBhbmQgY2FsbGJhY2tzIGFuZCB1c2UgdGhlIHJlc3VsdGluZyBwb3NpdGlvbiBpZiBzb21ldGhpbmcgaXMgcmV0dXJuZWQKCQlpZiAoIW5vUHJvcGFnYXRpb24pIHsKCQkJdmFyIHVpID0gdGhpcy5fdWlIYXNoKCk7CgkJCWlmKHRoaXMuX3RyaWdnZXIoImRyYWciLCBldmVudCwgdWkpID09PSBmYWxzZSkgewoJCQkJdGhpcy5fbW91c2VVcCh7fSk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJdGhpcy5wb3NpdGlvbiA9IHVpLnBvc2l0aW9uOwoJCX0KCgkJaWYoIXRoaXMub3B0aW9ucy5heGlzIHx8IHRoaXMub3B0aW9ucy5heGlzICE9PSAieSIpIHsKCQkJdGhpcy5oZWxwZXJbMF0uc3R5bGUubGVmdCA9IHRoaXMucG9zaXRpb24ubGVmdCsicHgiOwoJCX0KCQlpZighdGhpcy5vcHRpb25zLmF4aXMgfHwgdGhpcy5vcHRpb25zLmF4aXMgIT09ICJ4IikgewoJCQl0aGlzLmhlbHBlclswXS5zdHlsZS50b3AgPSB0aGlzLnBvc2l0aW9uLnRvcCsicHgiOwoJCX0KCQlpZigkLnVpLmRkbWFuYWdlcikgewoJCQkkLnVpLmRkbWFuYWdlci5kcmFnKHRoaXMsIGV2ZW50KTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX21vdXNlU3RvcDogZnVuY3Rpb24oZXZlbnQpIHsKCgkJLy9JZiB3ZSBhcmUgdXNpbmcgZHJvcHBhYmxlcywgaW5mb3JtIHRoZSBtYW5hZ2VyIGFib3V0IHRoZSBkcm9wCgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlkcm9wcGVkID0gZmFsc2U7CgkJaWYgKCQudWkuZGRtYW5hZ2VyICYmICF0aGlzLm9wdGlvbnMuZHJvcEJlaGF2aW91cikgewoJCQlkcm9wcGVkID0gJC51aS5kZG1hbmFnZXIuZHJvcCh0aGlzLCBldmVudCk7CgkJfQoKCQkvL2lmIGEgZHJvcCBjb21lcyBmcm9tIG91dHNpZGUgKGEgc29ydGFibGUpCgkJaWYodGhpcy5kcm9wcGVkKSB7CgkJCWRyb3BwZWQgPSB0aGlzLmRyb3BwZWQ7CgkJCXRoaXMuZHJvcHBlZCA9IGZhbHNlOwoJCX0KCgkJLy9pZiB0aGUgb3JpZ2luYWwgZWxlbWVudCBpcyBubyBsb25nZXIgaW4gdGhlIERPTSBkb24ndCBib3RoZXIgdG8gY29udGludWUgKHNlZSAjODI2OSkKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWxwZXIgPT09ICJvcmlnaW5hbCIgJiYgISQuY29udGFpbnMoIHRoaXMuZWxlbWVudFsgMCBdLm93bmVyRG9jdW1lbnQsIHRoaXMuZWxlbWVudFsgMCBdICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmKCh0aGlzLm9wdGlvbnMucmV2ZXJ0ID09PSAiaW52YWxpZCIgJiYgIWRyb3BwZWQpIHx8ICh0aGlzLm9wdGlvbnMucmV2ZXJ0ID09PSAidmFsaWQiICYmIGRyb3BwZWQpIHx8IHRoaXMub3B0aW9ucy5yZXZlcnQgPT09IHRydWUgfHwgKCQuaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMucmV2ZXJ0KSAmJiB0aGlzLm9wdGlvbnMucmV2ZXJ0LmNhbGwodGhpcy5lbGVtZW50LCBkcm9wcGVkKSkpIHsKCQkJJCh0aGlzLmhlbHBlcikuYW5pbWF0ZSh0aGlzLm9yaWdpbmFsUG9zaXRpb24sIHBhcnNlSW50KHRoaXMub3B0aW9ucy5yZXZlcnREdXJhdGlvbiwgMTApLCBmdW5jdGlvbigpIHsKCQkJCWlmKHRoYXQuX3RyaWdnZXIoInN0b3AiLCBldmVudCkgIT09IGZhbHNlKSB7CgkJCQkJdGhhdC5fY2xlYXIoKTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJaWYodGhpcy5fdHJpZ2dlcigic3RvcCIsIGV2ZW50KSAhPT0gZmFsc2UpIHsKCQkJCXRoaXMuX2NsZWFyKCk7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX21vdXNlVXA6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJLy9SZW1vdmUgZnJhbWUgaGVscGVycwoJCSQoImRpdi51aS1kcmFnZ2FibGUtaWZyYW1lRml4IikuZWFjaChmdW5jdGlvbigpIHsKCQkJdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpOwoJCX0pOwoKCQkvL0lmIHRoZSBkZG1hbmFnZXIgaXMgdXNlZCBmb3IgZHJvcHBhYmxlcywgaW5mb3JtIHRoZSBtYW5hZ2VyIHRoYXQgZHJhZ2dpbmcgaGFzIHN0b3BwZWQgKHNlZSAjNTAwMykKCQlpZiggJC51aS5kZG1hbmFnZXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLmRyYWdTdG9wKHRoaXMsIGV2ZW50KTsKCQl9CgoJCXJldHVybiAkLnVpLm1vdXNlLnByb3RvdHlwZS5fbW91c2VVcC5jYWxsKHRoaXMsIGV2ZW50KTsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpIHsKCgkJaWYodGhpcy5oZWxwZXIuaXMoIi51aS1kcmFnZ2FibGUtZHJhZ2dpbmciKSkgewoJCQl0aGlzLl9tb3VzZVVwKHt9KTsKCQl9IGVsc2UgewoJCQl0aGlzLl9jbGVhcigpOwoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCglfZ2V0SGFuZGxlOiBmdW5jdGlvbihldmVudCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMuaGFuZGxlID8KCQkJISEkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLmhhbmRsZSApICkubGVuZ3RoIDoKCQkJdHJ1ZTsKCX0sCgoJX2NyZWF0ZUhlbHBlcjogZnVuY3Rpb24oZXZlbnQpIHsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCWhlbHBlciA9ICQuaXNGdW5jdGlvbihvLmhlbHBlcikgPyAkKG8uaGVscGVyLmFwcGx5KHRoaXMuZWxlbWVudFswXSwgW2V2ZW50XSkpIDogKG8uaGVscGVyID09PSAiY2xvbmUiID8gdGhpcy5lbGVtZW50LmNsb25lKCkucmVtb3ZlQXR0cigiaWQiKSA6IHRoaXMuZWxlbWVudCk7CgoJCWlmKCFoZWxwZXIucGFyZW50cygiYm9keSIpLmxlbmd0aCkgewoJCQloZWxwZXIuYXBwZW5kVG8oKG8uYXBwZW5kVG8gPT09ICJwYXJlbnQiID8gdGhpcy5lbGVtZW50WzBdLnBhcmVudE5vZGUgOiBvLmFwcGVuZFRvKSk7CgkJfQoKCQlpZihoZWxwZXJbMF0gIT09IHRoaXMuZWxlbWVudFswXSAmJiAhKC8oZml4ZWR8YWJzb2x1dGUpLykudGVzdChoZWxwZXIuY3NzKCJwb3NpdGlvbiIpKSkgewoJCQloZWxwZXIuY3NzKCJwb3NpdGlvbiIsICJhYnNvbHV0ZSIpOwoJCX0KCgkJcmV0dXJuIGhlbHBlcjsKCgl9LAoKCV9hZGp1c3RPZmZzZXRGcm9tSGVscGVyOiBmdW5jdGlvbihvYmopIHsKCQlpZiAodHlwZW9mIG9iaiA9PT0gInN0cmluZyIpIHsKCQkJb2JqID0gb2JqLnNwbGl0KCIgIik7CgkJfQoJCWlmICgkLmlzQXJyYXkob2JqKSkgewoJCQlvYmogPSB7bGVmdDogK29ialswXSwgdG9wOiArb2JqWzFdIHx8IDB9OwoJCX0KCQlpZiAoImxlZnQiIGluIG9iaikgewoJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0ID0gb2JqLmxlZnQgKyB0aGlzLm1hcmdpbnMubGVmdDsKCQl9CgkJaWYgKCJyaWdodCIgaW4gb2JqKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPSB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gb2JqLnJpZ2h0ICsgdGhpcy5tYXJnaW5zLmxlZnQ7CgkJfQoJCWlmICgidG9wIiBpbiBvYmopIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wID0gb2JqLnRvcCArIHRoaXMubWFyZ2lucy50b3A7CgkJfQoJCWlmICgiYm90dG9tIiBpbiBvYmopIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wID0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLSBvYmouYm90dG9tICsgdGhpcy5tYXJnaW5zLnRvcDsKCQl9Cgl9LAoKCV9nZXRQYXJlbnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoKCQkvL0dldCB0aGUgb2Zmc2V0UGFyZW50IGFuZCBjYWNoZSBpdHMgcG9zaXRpb24KCQl2YXIgcG8gPSB0aGlzLm9mZnNldFBhcmVudC5vZmZzZXQoKTsKCgkJLy8gVGhpcyBpcyBhIHNwZWNpYWwgY2FzZSB3aGVyZSB3ZSBuZWVkIHRvIG1vZGlmeSBhIG9mZnNldCBjYWxjdWxhdGVkIG9uIHN0YXJ0LCBzaW5jZSB0aGUgZm9sbG93aW5nIGhhcHBlbmVkOgoJCS8vIDEuIFRoZSBwb3NpdGlvbiBvZiB0aGUgaGVscGVyIGlzIGFic29sdXRlLCBzbyBpdCdzIHBvc2l0aW9uIGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gdGhlIG5leHQgcG9zaXRpb25lZCBwYXJlbnQKCQkvLyAyLiBUaGUgYWN0dWFsIG9mZnNldCBwYXJlbnQgaXMgYSBjaGlsZCBvZiB0aGUgc2Nyb2xsIHBhcmVudCwgYW5kIHRoZSBzY3JvbGwgcGFyZW50IGlzbid0IHRoZSBkb2N1bWVudCwgd2hpY2ggbWVhbnMgdGhhdAoJCS8vICAgIHRoZSBzY3JvbGwgaXMgaW5jbHVkZWQgaW4gdGhlIGluaXRpYWwgY2FsY3VsYXRpb24gb2YgdGhlIG9mZnNldCBvZiB0aGUgcGFyZW50LCBhbmQgbmV2ZXIgcmVjYWxjdWxhdGVkIHVwb24gZHJhZwoJCWlmKHRoaXMuY3NzUG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgJiYgdGhpcy5zY3JvbGxQYXJlbnRbMF0gIT09IGRvY3VtZW50ICYmICQuY29udGFpbnModGhpcy5zY3JvbGxQYXJlbnRbMF0sIHRoaXMub2Zmc2V0UGFyZW50WzBdKSkgewoJCQlwby5sZWZ0ICs9IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKTsKCQkJcG8udG9wICs9IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpOwoJCX0KCgkJLy9UaGlzIG5lZWRzIHRvIGJlIGFjdHVhbGx5IGRvbmUgZm9yIGFsbCBicm93c2Vycywgc2luY2UgcGFnZVgvcGFnZVkgaW5jbHVkZXMgdGhpcyBpbmZvcm1hdGlvbgoJCS8vVWdseSBJRSBmaXgKCQlpZigodGhpcy5vZmZzZXRQYXJlbnRbMF0gPT09IGRvY3VtZW50LmJvZHkpIHx8CgkJCSh0aGlzLm9mZnNldFBhcmVudFswXS50YWdOYW1lICYmIHRoaXMub2Zmc2V0UGFyZW50WzBdLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gImh0bWwiICYmICQudWkuaWUpKSB7CgkJCXBvID0geyB0b3A6IDAsIGxlZnQ6IDAgfTsKCQl9CgoJCXJldHVybiB7CgkJCXRvcDogcG8udG9wICsgKHBhcnNlSW50KHRoaXMub2Zmc2V0UGFyZW50LmNzcygiYm9yZGVyVG9wV2lkdGgiKSwxMCkgfHwgMCksCgkJCWxlZnQ6IHBvLmxlZnQgKyAocGFyc2VJbnQodGhpcy5vZmZzZXRQYXJlbnQuY3NzKCJib3JkZXJMZWZ0V2lkdGgiKSwxMCkgfHwgMCkKCQl9OwoKCX0sCgoJX2dldFJlbGF0aXZlT2Zmc2V0OiBmdW5jdGlvbigpIHsKCgkJaWYodGhpcy5jc3NQb3NpdGlvbiA9PT0gInJlbGF0aXZlIikgewoJCQl2YXIgcCA9IHRoaXMuZWxlbWVudC5wb3NpdGlvbigpOwoJCQlyZXR1cm4gewoJCQkJdG9wOiBwLnRvcCAtIChwYXJzZUludCh0aGlzLmhlbHBlci5jc3MoInRvcCIpLDEwKSB8fCAwKSArIHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpLAoJCQkJbGVmdDogcC5sZWZ0IC0gKHBhcnNlSW50KHRoaXMuaGVscGVyLmNzcygibGVmdCIpLDEwKSB8fCAwKSArIHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldHVybiB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgl9LAoKCV9jYWNoZU1hcmdpbnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMubWFyZ2lucyA9IHsKCQkJbGVmdDogKHBhcnNlSW50KHRoaXMuZWxlbWVudC5jc3MoIm1hcmdpbkxlZnQiKSwxMCkgfHwgMCksCgkJCXRvcDogKHBhcnNlSW50KHRoaXMuZWxlbWVudC5jc3MoIm1hcmdpblRvcCIpLDEwKSB8fCAwKSwKCQkJcmlnaHQ6IChwYXJzZUludCh0aGlzLmVsZW1lbnQuY3NzKCJtYXJnaW5SaWdodCIpLDEwKSB8fCAwKSwKCQkJYm90dG9tOiAocGFyc2VJbnQodGhpcy5lbGVtZW50LmNzcygibWFyZ2luQm90dG9tIiksMTApIHx8IDApCgkJfTsKCX0sCgoJX2NhY2hlSGVscGVyUHJvcG9ydGlvbnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMgPSB7CgkJCXdpZHRoOiB0aGlzLmhlbHBlci5vdXRlcldpZHRoKCksCgkJCWhlaWdodDogdGhpcy5oZWxwZXIub3V0ZXJIZWlnaHQoKQoJCX07Cgl9LAoKCV9zZXRDb250YWlubWVudDogZnVuY3Rpb24oKSB7CgoJCXZhciBvdmVyLCBjLCBjZSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCAhby5jb250YWlubWVudCApIHsKCQkJdGhpcy5jb250YWlubWVudCA9IG51bGw7CgkJCXJldHVybjsKCQl9CgoJCWlmICggby5jb250YWlubWVudCA9PT0gIndpbmRvdyIgKSB7CgkJCXRoaXMuY29udGFpbm1lbnQgPSBbCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxMZWZ0KCkgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQsCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSAtIHRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAtIHRoaXMub2Zmc2V0LnBhcmVudC50b3AsCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxMZWZ0KCkgKyAkKCB3aW5kb3cgKS53aWR0aCgpIC0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgKyAoICQoIHdpbmRvdyApLmhlaWdodCgpIHx8IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5zY3JvbGxIZWlnaHQgKSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcAoJCQldOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIG8uY29udGFpbm1lbnQgPT09ICJkb2N1bWVudCIpIHsKCQkJdGhpcy5jb250YWlubWVudCA9IFsKCQkJCTAsCgkJCQkwLAoJCQkJJCggZG9jdW1lbnQgKS53aWR0aCgpIC0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJKCAkKCBkb2N1bWVudCApLmhlaWdodCgpIHx8IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5zY3JvbGxIZWlnaHQgKSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcAoJCQldOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIG8uY29udGFpbm1lbnQuY29uc3RydWN0b3IgPT09IEFycmF5ICkgewoJCQl0aGlzLmNvbnRhaW5tZW50ID0gby5jb250YWlubWVudDsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBvLmNvbnRhaW5tZW50ID09PSAicGFyZW50IiApIHsKCQkJby5jb250YWlubWVudCA9IHRoaXMuaGVscGVyWyAwIF0ucGFyZW50Tm9kZTsKCQl9CgoJCWMgPSAkKCBvLmNvbnRhaW5tZW50ICk7CgkJY2UgPSBjWyAwIF07CgoJCWlmKCAhY2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCW92ZXIgPSBjLmNzcyggIm92ZXJmbG93IiApICE9PSAiaGlkZGVuIjsKCgkJdGhpcy5jb250YWlubWVudCA9IFsKCQkJKCBwYXJzZUludCggYy5jc3MoICJib3JkZXJMZWZ0V2lkdGgiICksIDEwICkgfHwgMCApICsgKCBwYXJzZUludCggYy5jc3MoICJwYWRkaW5nTGVmdCIgKSwgMTAgKSB8fCAwICksCgkJCSggcGFyc2VJbnQoIGMuY3NzKCAiYm9yZGVyVG9wV2lkdGgiICksIDEwICkgfHwgMCApICsgKCBwYXJzZUludCggYy5jc3MoICJwYWRkaW5nVG9wIiApLCAxMCApIHx8IDAgKSAsCgkJCSggb3ZlciA\/IE1hdGgubWF4KCBjZS5zY3JvbGxXaWR0aCwgY2Uub2Zmc2V0V2lkdGggKSA6IGNlLm9mZnNldFdpZHRoICkgLSAoIHBhcnNlSW50KCBjLmNzcyggImJvcmRlclJpZ2h0V2lkdGgiICksIDEwICkgfHwgMCApIC0gKCBwYXJzZUludCggYy5jc3MoICJwYWRkaW5nUmlnaHQiICksIDEwICkgfHwgMCApIC0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIHRoaXMubWFyZ2lucy5sZWZ0IC0gdGhpcy5tYXJnaW5zLnJpZ2h0LAoJCQkoIG92ZXIgPyBNYXRoLm1heCggY2Uuc2Nyb2xsSGVpZ2h0LCBjZS5vZmZzZXRIZWlnaHQgKSA6IGNlLm9mZnNldEhlaWdodCApIC0gKCBwYXJzZUludCggYy5jc3MoICJib3JkZXJCb3R0b21XaWR0aCIgKSwgMTAgKSB8fCAwICkgLSAoIHBhcnNlSW50KCBjLmNzcyggInBhZGRpbmdCb3R0b20iICksIDEwICkgfHwgMCApIC0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLSB0aGlzLm1hcmdpbnMudG9wICAtIHRoaXMubWFyZ2lucy5ib3R0b20KCQldOwoJCXRoaXMucmVsYXRpdmVfY29udGFpbmVyID0gYzsKCX0sCgoJX2NvbnZlcnRQb3NpdGlvblRvOiBmdW5jdGlvbihkLCBwb3MpIHsKCgkJaWYoIXBvcykgewoJCQlwb3MgPSB0aGlzLnBvc2l0aW9uOwoJCX0KCgkJdmFyIG1vZCA9IGQgPT09ICJhYnNvbHV0ZSIgPyAxIDogLTEsCgkJCXNjcm9sbCA9IHRoaXMuY3NzUG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgJiYgISggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gZG9jdW1lbnQgJiYgJC5jb250YWlucyggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSwgdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgPyB0aGlzLm9mZnNldFBhcmVudCA6IHRoaXMuc2Nyb2xsUGFyZW50OwoKCQkvL0NhY2hlIHRoZSBzY3JvbGwKCQlpZiAoIXRoaXMub2Zmc2V0LnNjcm9sbCkgewoJCQl0aGlzLm9mZnNldC5zY3JvbGwgPSB7dG9wIDogc2Nyb2xsLnNjcm9sbFRvcCgpLCBsZWZ0IDogc2Nyb2xsLnNjcm9sbExlZnQoKX07CgkJfQoKCQlyZXR1cm4gewoJCQl0b3A6ICgKCQkJCXBvcy50b3AJKwkJCQkJCQkJCQkJCQkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAqIG1vZCArCQkJCQkJCQkJCS8vIE9ubHkgZm9yIHJlbGF0aXZlIHBvc2l0aW9uZWQgbm9kZXM6IFJlbGF0aXZlIG9mZnNldCBmcm9tIGVsZW1lbnQgdG8gb2Zmc2V0IHBhcmVudAoJCQkJdGhpcy5vZmZzZXQucGFyZW50LnRvcCAqIG1vZCAtCQkJCQkJCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/IC10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSA6IHRoaXMub2Zmc2V0LnNjcm9sbC50b3AgKSAqIG1vZCApCgkJCSksCgkJCWxlZnQ6ICgKCQkJCXBvcy5sZWZ0ICsJCQkJCQkJCQkJCQkJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0ICogbW9kICsJCQkJCQkJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5wYXJlbnQubGVmdCAqIG1vZAktCQkJCQkJCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/IC10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkgOiB0aGlzLm9mZnNldC5zY3JvbGwubGVmdCApICogbW9kICkKCQkJKQoJCX07CgoJfSwKCglfZ2VuZXJhdGVQb3NpdGlvbjogZnVuY3Rpb24oZXZlbnQpIHsKCgkJdmFyIGNvbnRhaW5tZW50LCBjbywgdG9wLCBsZWZ0LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlzY3JvbGwgPSB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmICEoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IGRvY3VtZW50ICYmICQuY29udGFpbnMoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0sIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gKSApID8gdGhpcy5vZmZzZXRQYXJlbnQgOiB0aGlzLnNjcm9sbFBhcmVudCwKCQkJcGFnZVggPSBldmVudC5wYWdlWCwKCQkJcGFnZVkgPSBldmVudC5wYWdlWTsKCgkJLy9DYWNoZSB0aGUgc2Nyb2xsCgkJaWYgKCF0aGlzLm9mZnNldC5zY3JvbGwpIHsKCQkJdGhpcy5vZmZzZXQuc2Nyb2xsID0ge3RvcCA6IHNjcm9sbC5zY3JvbGxUb3AoKSwgbGVmdCA6IHNjcm9sbC5zY3JvbGxMZWZ0KCl9OwoJCX0KCgkJLyoKCQkgKiAtIFBvc2l0aW9uIGNvbnN0cmFpbmluZyAtCgkJICogQ29uc3RyYWluIHRoZSBwb3NpdGlvbiB0byBhIG1peCBvZiBncmlkLCBjb250YWlubWVudC4KCQkgKi8KCgkJLy8gSWYgd2UgYXJlIG5vdCBkcmFnZ2luZyB5ZXQsIHdlIHdvbid0IGNoZWNrIGZvciBvcHRpb25zCgkJaWYgKCB0aGlzLm9yaWdpbmFsUG9zaXRpb24gKSB7CgkJCWlmICggdGhpcy5jb250YWlubWVudCApIHsKCQkJCWlmICggdGhpcy5yZWxhdGl2ZV9jb250YWluZXIgKXsKCQkJCQljbyA9IHRoaXMucmVsYXRpdmVfY29udGFpbmVyLm9mZnNldCgpOwoJCQkJCWNvbnRhaW5tZW50ID0gWwoJCQkJCQl0aGlzLmNvbnRhaW5tZW50WyAwIF0gKyBjby5sZWZ0LAoJCQkJCQl0aGlzLmNvbnRhaW5tZW50WyAxIF0gKyBjby50b3AsCgkJCQkJCXRoaXMuY29udGFpbm1lbnRbIDIgXSArIGNvLmxlZnQsCgkJCQkJCXRoaXMuY29udGFpbm1lbnRbIDMgXSArIGNvLnRvcAoJCQkJCV07CgkJCQl9CgkJCQllbHNlIHsKCQkJCQljb250YWlubWVudCA9IHRoaXMuY29udGFpbm1lbnQ7CgkJCQl9CgoJCQkJaWYoZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0IDwgY29udGFpbm1lbnRbMF0pIHsKCQkJCQlwYWdlWCA9IGNvbnRhaW5tZW50WzBdICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdDsKCQkJCX0KCQkJCWlmKGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wIDwgY29udGFpbm1lbnRbMV0pIHsKCQkJCQlwYWdlWSA9IGNvbnRhaW5tZW50WzFdICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wOwoJCQkJfQoJCQkJaWYoZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID4gY29udGFpbm1lbnRbMl0pIHsKCQkJCQlwYWdlWCA9IGNvbnRhaW5tZW50WzJdICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdDsKCQkJCX0KCQkJCWlmKGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID4gY29udGFpbm1lbnRbM10pIHsKCQkJCQlwYWdlWSA9IGNvbnRhaW5tZW50WzNdICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wOwoJCQkJfQoJCQl9CgoJCQlpZihvLmdyaWQpIHsKCQkJCS8vQ2hlY2sgZm9yIGdyaWQgZWxlbWVudHMgc2V0IHRvIDAgdG8gcHJldmVudCBkaXZpZGUgYnkgMCBlcnJvciBjYXVzaW5nIGludmFsaWQgYXJndW1lbnQgZXJyb3JzIGluIElFIChzZWUgdGlja2V0ICM2OTUwKQoJCQkJdG9wID0gby5ncmlkWzFdID8gdGhpcy5vcmlnaW5hbFBhZ2VZICsgTWF0aC5yb3VuZCgocGFnZVkgLSB0aGlzLm9yaWdpbmFsUGFnZVkpIC8gby5ncmlkWzFdKSAqIG8uZ3JpZFsxXSA6IHRoaXMub3JpZ2luYWxQYWdlWTsKCQkJCXBhZ2VZID0gY29udGFpbm1lbnQgPyAoKHRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA+PSBjb250YWlubWVudFsxXSB8fCB0b3AgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPiBjb250YWlubWVudFszXSkgPyB0b3AgOiAoKHRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA+PSBjb250YWlubWVudFsxXSkgPyB0b3AgLSBvLmdyaWRbMV0gOiB0b3AgKyBvLmdyaWRbMV0pKSA6IHRvcDsKCgkJCQlsZWZ0ID0gby5ncmlkWzBdID8gdGhpcy5vcmlnaW5hbFBhZ2VYICsgTWF0aC5yb3VuZCgocGFnZVggLSB0aGlzLm9yaWdpbmFsUGFnZVgpIC8gby5ncmlkWzBdKSAqIG8uZ3JpZFswXSA6IHRoaXMub3JpZ2luYWxQYWdlWDsKCQkJCXBhZ2VYID0gY29udGFpbm1lbnQgPyAoKGxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID49IGNvbnRhaW5tZW50WzBdIHx8IGxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID4gY29udGFpbm1lbnRbMl0pID8gbGVmdCA6ICgobGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPj0gY29udGFpbm1lbnRbMF0pID8gbGVmdCAtIG8uZ3JpZFswXSA6IGxlZnQgKyBvLmdyaWRbMF0pKSA6IGxlZnQ7CgkJCX0KCgkJfQoKCQlyZXR1cm4gewoJCQl0b3A6ICgKCQkJCXBhZ2VZIC0JCQkJCQkJCQkJCQkJCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbgoJCQkJdGhpcy5vZmZzZXQuY2xpY2sudG9wCS0JCQkJCQkJCQkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUudG9wIC0JCQkJCQkJCQkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC50b3AgKwkJCQkJCQkJCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQkoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPyAtdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCkgOiB0aGlzLm9mZnNldC5zY3JvbGwudG9wICkKCQkJKSwKCQkJbGVmdDogKAoJCQkJcGFnZVggLQkJCQkJCQkJCQkJCQkJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0IC0JCQkJCQkJCQkJCQkvLyBDbGljayBvZmZzZXQgKHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50KQoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdCAtCQkJCQkJCQkJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5wYXJlbnQubGVmdCArCQkJCQkJCQkJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCSggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/IC10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkgOiB0aGlzLm9mZnNldC5zY3JvbGwubGVmdCApCgkJCSkKCQl9OwoKCX0sCgoJX2NsZWFyOiBmdW5jdGlvbigpIHsKCQl0aGlzLmhlbHBlci5yZW1vdmVDbGFzcygidWktZHJhZ2dhYmxlLWRyYWdnaW5nIik7CgkJaWYodGhpcy5oZWxwZXJbMF0gIT09IHRoaXMuZWxlbWVudFswXSAmJiAhdGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsKSB7CgkJCXRoaXMuaGVscGVyLnJlbW92ZSgpOwoJCX0KCQl0aGlzLmhlbHBlciA9IG51bGw7CgkJdGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsID0gZmFsc2U7Cgl9LAoKCS8vIEZyb20gbm93IG9uIGJ1bGsgc3R1ZmYgLSBtYWlubHkgaGVscGVycwoKCV90cmlnZ2VyOiBmdW5jdGlvbih0eXBlLCBldmVudCwgdWkpIHsKCQl1aSA9IHVpIHx8IHRoaXMuX3VpSGFzaCgpOwoJCSQudWkucGx1Z2luLmNhbGwodGhpcywgdHlwZSwgW2V2ZW50LCB1aV0pOwoJCS8vVGhlIGFic29sdXRlIHBvc2l0aW9uIGhhcyB0byBiZSByZWNhbGN1bGF0ZWQgYWZ0ZXIgcGx1Z2lucwoJCWlmKHR5cGUgPT09ICJkcmFnIikgewoJCQl0aGlzLnBvc2l0aW9uQWJzID0gdGhpcy5fY29udmVydFBvc2l0aW9uVG8oImFic29sdXRlIik7CgkJfQoJCXJldHVybiAkLldpZGdldC5wcm90b3R5cGUuX3RyaWdnZXIuY2FsbCh0aGlzLCB0eXBlLCBldmVudCwgdWkpOwoJfSwKCglwbHVnaW5zOiB7fSwKCglfdWlIYXNoOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gewoJCQloZWxwZXI6IHRoaXMuaGVscGVyLAoJCQlwb3NpdGlvbjogdGhpcy5wb3NpdGlvbiwKCQkJb3JpZ2luYWxQb3NpdGlvbjogdGhpcy5vcmlnaW5hbFBvc2l0aW9uLAoJCQlvZmZzZXQ6IHRoaXMucG9zaXRpb25BYnMKCQl9OwoJfQoKfSk7CgokLnVpLnBsdWdpbi5hZGQoImRyYWdnYWJsZSIsICJjb25uZWN0VG9Tb3J0YWJsZSIsIHsKCXN0YXJ0OiBmdW5jdGlvbihldmVudCwgdWkpIHsKCgkJdmFyIGluc3QgPSAkKHRoaXMpLmRhdGEoInVpLWRyYWdnYWJsZSIpLCBvID0gaW5zdC5vcHRpb25zLAoJCQl1aVNvcnRhYmxlID0gJC5leHRlbmQoe30sIHVpLCB7IGl0ZW06IGluc3QuZWxlbWVudCB9KTsKCQlpbnN0LnNvcnRhYmxlcyA9IFtdOwoJCSQoby5jb25uZWN0VG9Tb3J0YWJsZSkuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIHNvcnRhYmxlID0gJC5kYXRhKHRoaXMsICJ1aS1zb3J0YWJsZSIpOwoJCQlpZiAoc29ydGFibGUgJiYgIXNvcnRhYmxlLm9wdGlvbnMuZGlzYWJsZWQpIHsKCQkJCWluc3Quc29ydGFibGVzLnB1c2goewoJCQkJCWluc3RhbmNlOiBzb3J0YWJsZSwKCQkJCQlzaG91bGRSZXZlcnQ6IHNvcnRhYmxlLm9wdGlvbnMucmV2ZXJ0CgkJCQl9KTsKCQkJCXNvcnRhYmxlLnJlZnJlc2hQb3NpdGlvbnMoKTsJLy8gQ2FsbCB0aGUgc29ydGFibGUncyByZWZyZXNoUG9zaXRpb25zIGF0IGRyYWcgc3RhcnQgdG8gcmVmcmVzaCB0aGUgY29udGFpbmVyQ2FjaGUgc2luY2UgdGhlIHNvcnRhYmxlIGNvbnRhaW5lciBjYWNoZSBpcyB1c2VkIGluIGRyYWcgYW5kIG5lZWRzIHRvIGJlIHVwIHRvIGRhdGUgKHRoaXMgd2lsbCBlbnN1cmUgaXQncyBpbml0aWFsaXNlZCBhcyB3ZWxsIGFzIGJlaW5nIGtlcHQgaW4gc3RlcCB3aXRoIGFueSBjaGFuZ2VzIHRoYXQgbWlnaHQgaGF2ZSBoYXBwZW5lZCBvbiB0aGUgcGFnZSkuCgkJCQlzb3J0YWJsZS5fdHJpZ2dlcigiYWN0aXZhdGUiLCBldmVudCwgdWlTb3J0YWJsZSk7CgkJCX0KCQl9KTsKCgl9LAoJc3RvcDogZnVuY3Rpb24oZXZlbnQsIHVpKSB7CgoJCS8vSWYgd2UgYXJlIHN0aWxsIG92ZXIgdGhlIHNvcnRhYmxlLCB3ZSBmYWtlIHRoZSBzdG9wIGV2ZW50IG9mIHRoZSBzb3J0YWJsZSwgYnV0IGFsc28gcmVtb3ZlIGhlbHBlcgoJCXZhciBpbnN0ID0gJCh0aGlzKS5kYXRhKCJ1aS1kcmFnZ2FibGUiKSwKCQkJdWlTb3J0YWJsZSA9ICQuZXh0ZW5kKHt9LCB1aSwgeyBpdGVtOiBpbnN0LmVsZW1lbnQgfSk7CgoJCSQuZWFjaChpbnN0LnNvcnRhYmxlcywgZnVuY3Rpb24oKSB7CgkJCWlmKHRoaXMuaW5zdGFuY2UuaXNPdmVyKSB7CgoJCQkJdGhpcy5pbnN0YW5jZS5pc092ZXIgPSAwOwoKCQkJCWluc3QuY2FuY2VsSGVscGVyUmVtb3ZhbCA9IHRydWU7IC8vRG9uJ3QgcmVtb3ZlIHRoZSBoZWxwZXIgaW4gdGhlIGRyYWdnYWJsZSBpbnN0YW5jZQoJCQkJdGhpcy5pbnN0YW5jZS5jYW5jZWxIZWxwZXJSZW1vdmFsID0gZmFsc2U7IC8vUmVtb3ZlIGl0IGluIHRoZSBzb3J0YWJsZSBpbnN0YW5jZSAoc28gc29ydGFibGUgcGx1Z2lucyBsaWtlIHJldmVydCBzdGlsbCB3b3JrKQoKCQkJCS8vVGhlIHNvcnRhYmxlIHJldmVydCBpcyBzdXBwb3J0ZWQsIGFuZCB3ZSBoYXZlIHRvIHNldCBhIHRlbXBvcmFyeSBkcm9wcGVkIHZhcmlhYmxlIG9uIHRoZSBkcmFnZ2FibGUgdG8gc3VwcG9ydCByZXZlcnQ6ICJ2YWxpZC9pbnZhbGlkIgoJCQkJaWYodGhpcy5zaG91bGRSZXZlcnQpIHsKCQkJCQl0aGlzLmluc3RhbmNlLm9wdGlvbnMucmV2ZXJ0ID0gdGhpcy5zaG91bGRSZXZlcnQ7CgkJCQl9CgoJCQkJLy9UcmlnZ2VyIHRoZSBzdG9wIG9mIHRoZSBzb3J0YWJsZQoJCQkJdGhpcy5pbnN0YW5jZS5fbW91c2VTdG9wKGV2ZW50KTsKCgkJCQl0aGlzLmluc3RhbmNlLm9wdGlvbnMuaGVscGVyID0gdGhpcy5pbnN0YW5jZS5vcHRpb25zLl9oZWxwZXI7CgoJCQkJLy9JZiB0aGUgaGVscGVyIGhhcyBiZWVuIHRoZSBvcmlnaW5hbCBpdGVtLCByZXN0b3JlIHByb3BlcnRpZXMgaW4gdGhlIHNvcnRhYmxlCgkJCQlpZihpbnN0Lm9wdGlvbnMuaGVscGVyID09PSAib3JpZ2luYWwiKSB7CgkJCQkJdGhpcy5pbnN0YW5jZS5jdXJyZW50SXRlbS5jc3MoeyB0b3A6ICJhdXRvIiwgbGVmdDogImF1dG8iIH0pOwoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5zdGFuY2UuY2FuY2VsSGVscGVyUmVtb3ZhbCA9IGZhbHNlOyAvL1JlbW92ZSB0aGUgaGVscGVyIGluIHRoZSBzb3J0YWJsZSBpbnN0YW5jZQoJCQkJdGhpcy5pbnN0YW5jZS5fdHJpZ2dlcigiZGVhY3RpdmF0ZSIsIGV2ZW50LCB1aVNvcnRhYmxlKTsKCQkJfQoKCQl9KTsKCgl9LAoJZHJhZzogZnVuY3Rpb24oZXZlbnQsIHVpKSB7CgoJCXZhciBpbnN0ID0gJCh0aGlzKS5kYXRhKCJ1aS1kcmFnZ2FibGUiKSwgdGhhdCA9IHRoaXM7CgoJCSQuZWFjaChpbnN0LnNvcnRhYmxlcywgZnVuY3Rpb24oKSB7CgoJCQl2YXIgaW5uZXJtb3N0SW50ZXJzZWN0aW5nID0gZmFsc2UsCgkJCQl0aGlzU29ydGFibGUgPSB0aGlzOwoKCQkJLy9Db3B5IG92ZXIgc29tZSB2YXJpYWJsZXMgdG8gYWxsb3cgY2FsbGluZyB0aGUgc29ydGFibGUncyBuYXRpdmUgX2ludGVyc2VjdHNXaXRoCgkJCXRoaXMuaW5zdGFuY2UucG9zaXRpb25BYnMgPSBpbnN0LnBvc2l0aW9uQWJzOwoJCQl0aGlzLmluc3RhbmNlLmhlbHBlclByb3BvcnRpb25zID0gaW5zdC5oZWxwZXJQcm9wb3J0aW9uczsKCQkJdGhpcy5pbnN0YW5jZS5vZmZzZXQuY2xpY2sgPSBpbnN0Lm9mZnNldC5jbGljazsKCgkJCWlmKHRoaXMuaW5zdGFuY2UuX2ludGVyc2VjdHNXaXRoKHRoaXMuaW5zdGFuY2UuY29udGFpbmVyQ2FjaGUpKSB7CgkJCQlpbm5lcm1vc3RJbnRlcnNlY3RpbmcgPSB0cnVlOwoJCQkJJC5lYWNoKGluc3Quc29ydGFibGVzLCBmdW5jdGlvbiAoKSB7CgkJCQkJdGhpcy5pbnN0YW5jZS5wb3NpdGlvbkFicyA9IGluc3QucG9zaXRpb25BYnM7CgkJCQkJdGhpcy5pbnN0YW5jZS5oZWxwZXJQcm9wb3J0aW9ucyA9IGluc3QuaGVscGVyUHJvcG9ydGlvbnM7CgkJCQkJdGhpcy5pbnN0YW5jZS5vZmZzZXQuY2xpY2sgPSBpbnN0Lm9mZnNldC5jbGljazsKCQkJCQlpZiAodGhpcyAhPT0gdGhpc1NvcnRhYmxlICYmCgkJCQkJCXRoaXMuaW5zdGFuY2UuX2ludGVyc2VjdHNXaXRoKHRoaXMuaW5zdGFuY2UuY29udGFpbmVyQ2FjaGUpICYmCgkJCQkJCSQuY29udGFpbnModGhpc1NvcnRhYmxlLmluc3RhbmNlLmVsZW1lbnRbMF0sIHRoaXMuaW5zdGFuY2UuZWxlbWVudFswXSkKCQkJCQkpIHsKCQkJCQkJaW5uZXJtb3N0SW50ZXJzZWN0aW5nID0gZmFsc2U7CgkJCQkJfQoJCQkJCXJldHVybiBpbm5lcm1vc3RJbnRlcnNlY3Rpbmc7CgkJCQl9KTsKCQkJfQoKCgkJCWlmKGlubmVybW9zdEludGVyc2VjdGluZykgewoJCQkJLy9JZiBpdCBpbnRlcnNlY3RzLCB3ZSB1c2UgYSBsaXR0bGUgaXNPdmVyIHZhcmlhYmxlIGFuZCBzZXQgaXQgb25jZSwgc28gb3VyIG1vdmUtaW4gc3R1ZmYgZ2V0cyBmaXJlZCBvbmx5IG9uY2UKCQkJCWlmKCF0aGlzLmluc3RhbmNlLmlzT3ZlcikgewoKCQkJCQl0aGlzLmluc3RhbmNlLmlzT3ZlciA9IDE7CgkJCQkJLy9Ob3cgd2UgZmFrZSB0aGUgc3RhcnQgb2YgZHJhZ2dpbmcgZm9yIHRoZSBzb3J0YWJsZSBpbnN0YW5jZSwKCQkJCQkvL2J5IGNsb25pbmcgdGhlIGxpc3QgZ3JvdXAgaXRlbSwgYXBwZW5kaW5nIGl0IHRvIHRoZSBzb3J0YWJsZSBhbmQgdXNpbmcgaXQgYXMgaW5zdC5jdXJyZW50SXRlbQoJCQkJCS8vV2UgY2FuIHRoZW4gZmlyZSB0aGUgc3RhcnQgZXZlbnQgb2YgdGhlIHNvcnRhYmxlIHdpdGggb3VyIHBhc3NlZCBicm93c2VyIGV2ZW50LCBhbmQgb3VyIG93biBoZWxwZXIgKHNvIGl0IGRvZXNuJ3QgY3JlYXRlIGEgbmV3IG9uZSkKCQkJCQl0aGlzLmluc3RhbmNlLmN1cnJlbnRJdGVtID0gJCh0aGF0KS5jbG9uZSgpLnJlbW92ZUF0dHIoImlkIikuYXBwZW5kVG8odGhpcy5pbnN0YW5jZS5lbGVtZW50KS5kYXRhKCJ1aS1zb3J0YWJsZS1pdGVtIiwgdHJ1ZSk7CgkJCQkJdGhpcy5pbnN0YW5jZS5vcHRpb25zLl9oZWxwZXIgPSB0aGlzLmluc3RhbmNlLm9wdGlvbnMuaGVscGVyOyAvL1N0b3JlIGhlbHBlciBvcHRpb24gdG8gbGF0ZXIgcmVzdG9yZSBpdAoJCQkJCXRoaXMuaW5zdGFuY2Uub3B0aW9ucy5oZWxwZXIgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHVpLmhlbHBlclswXTsgfTsKCgkJCQkJZXZlbnQudGFyZ2V0ID0gdGhpcy5pbnN0YW5jZS5jdXJyZW50SXRlbVswXTsKCQkJCQl0aGlzLmluc3RhbmNlLl9tb3VzZUNhcHR1cmUoZXZlbnQsIHRydWUpOwoJCQkJCXRoaXMuaW5zdGFuY2UuX21vdXNlU3RhcnQoZXZlbnQsIHRydWUsIHRydWUpOwoKCQkJCQkvL0JlY2F1c2UgdGhlIGJyb3dzZXIgZXZlbnQgaXMgd2F5IG9mZiB0aGUgbmV3IGFwcGVuZGVkIHBvcnRsZXQsIHdlIG1vZGlmeSBhIGNvdXBsZSBvZiB2YXJpYWJsZXMgdG8gcmVmbGVjdCB0aGUgY2hhbmdlcwoJCQkJCXRoaXMuaW5zdGFuY2Uub2Zmc2V0LmNsaWNrLnRvcCA9IGluc3Qub2Zmc2V0LmNsaWNrLnRvcDsKCQkJCQl0aGlzLmluc3RhbmNlLm9mZnNldC5jbGljay5sZWZ0ID0gaW5zdC5vZmZzZXQuY2xpY2subGVmdDsKCQkJCQl0aGlzLmluc3RhbmNlLm9mZnNldC5wYXJlbnQubGVmdCAtPSBpbnN0Lm9mZnNldC5wYXJlbnQubGVmdCAtIHRoaXMuaW5zdGFuY2Uub2Zmc2V0LnBhcmVudC5sZWZ0OwoJCQkJCXRoaXMuaW5zdGFuY2Uub2Zmc2V0LnBhcmVudC50b3AgLT0gaW5zdC5vZmZzZXQucGFyZW50LnRvcCAtIHRoaXMuaW5zdGFuY2Uub2Zmc2V0LnBhcmVudC50b3A7CgoJCQkJCWluc3QuX3RyaWdnZXIoInRvU29ydGFibGUiLCBldmVudCk7CgkJCQkJaW5zdC5kcm9wcGVkID0gdGhpcy5pbnN0YW5jZS5lbGVtZW50OyAvL2RyYWdnYWJsZSByZXZlcnQgbmVlZHMgdGhhdAoJCQkJCS8vaGFjayBzbyByZWNlaXZlL3VwZGF0ZSBjYWxsYmFja3Mgd29yayAobW9zdGx5KQoJCQkJCWluc3QuY3VycmVudEl0ZW0gPSBpbnN0LmVsZW1lbnQ7CgkJCQkJdGhpcy5pbnN0YW5jZS5mcm9tT3V0c2lkZSA9IGluc3Q7CgoJCQkJfQoKCQkJCS8vUHJvdmlkZWQgd2UgZGlkIGFsbCB0aGUgcHJldmlvdXMgc3RlcHMsIHdlIGNhbiBmaXJlIHRoZSBkcmFnIGV2ZW50IG9mIHRoZSBzb3J0YWJsZSBvbiBldmVyeSBkcmFnZ2FibGUgZHJhZywgd2hlbiBpdCBpbnRlcnNlY3RzIHdpdGggdGhlIHNvcnRhYmxlCgkJCQlpZih0aGlzLmluc3RhbmNlLmN1cnJlbnRJdGVtKSB7CgkJCQkJdGhpcy5pbnN0YW5jZS5fbW91c2VEcmFnKGV2ZW50KTsKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJLy9JZiBpdCBkb2Vzbid0IGludGVyc2VjdCB3aXRoIHRoZSBzb3J0YWJsZSwgYW5kIGl0IGludGVyc2VjdGVkIGJlZm9yZSwKCQkJCS8vd2UgZmFrZSB0aGUgZHJhZyBzdG9wIG9mIHRoZSBzb3J0YWJsZSwgYnV0IG1ha2Ugc3VyZSBpdCBkb2Vzbid0IHJlbW92ZSB0aGUgaGVscGVyIGJ5IHVzaW5nIGNhbmNlbEhlbHBlclJlbW92YWwKCQkJCWlmKHRoaXMuaW5zdGFuY2UuaXNPdmVyKSB7CgoJCQkJCXRoaXMuaW5zdGFuY2UuaXNPdmVyID0gMDsKCQkJCQl0aGlzLmluc3RhbmNlLmNhbmNlbEhlbHBlclJlbW92YWwgPSB0cnVlOwoKCQkJCQkvL1ByZXZlbnQgcmV2ZXJ0aW5nIG9uIHRoaXMgZm9yY2VkIHN0b3AKCQkJCQl0aGlzLmluc3RhbmNlLm9wdGlvbnMucmV2ZXJ0ID0gZmFsc2U7CgoJCQkJCS8vIFRoZSBvdXQgZXZlbnQgbmVlZHMgdG8gYmUgdHJpZ2dlcmVkIGluZGVwZW5kZW50bHkKCQkJCQl0aGlzLmluc3RhbmNlLl90cmlnZ2VyKCJvdXQiLCBldmVudCwgdGhpcy5pbnN0YW5jZS5fdWlIYXNoKHRoaXMuaW5zdGFuY2UpKTsKCgkJCQkJdGhpcy5pbnN0YW5jZS5fbW91c2VTdG9wKGV2ZW50LCB0cnVlKTsKCQkJCQl0aGlzLmluc3RhbmNlLm9wdGlvbnMuaGVscGVyID0gdGhpcy5pbnN0YW5jZS5vcHRpb25zLl9oZWxwZXI7CgoJCQkJCS8vTm93IHdlIHJlbW92ZSBvdXIgY3VycmVudEl0ZW0sIHRoZSBsaXN0IGdyb3VwIGNsb25lIGFnYWluLCBhbmQgdGhlIHBsYWNlaG9sZGVyLCBhbmQgYW5pbWF0ZSB0aGUgaGVscGVyIGJhY2sgdG8gaXQncyBvcmlnaW5hbCBzaXplCgkJCQkJdGhpcy5pbnN0YW5jZS5jdXJyZW50SXRlbS5yZW1vdmUoKTsKCQkJCQlpZih0aGlzLmluc3RhbmNlLnBsYWNlaG9sZGVyKSB7CgkJCQkJCXRoaXMuaW5zdGFuY2UucGxhY2Vob2xkZXIucmVtb3ZlKCk7CgkJCQkJfQoKCQkJCQlpbnN0Ll90cmlnZ2VyKCJmcm9tU29ydGFibGUiLCBldmVudCk7CgkJCQkJaW5zdC5kcm9wcGVkID0gZmFsc2U7IC8vZHJhZ2dhYmxlIHJldmVydCBuZWVkcyB0aGF0CgkJCQl9CgoJCQl9CgoJCX0pOwoKCX0KfSk7CgokLnVpLnBsdWdpbi5hZGQoImRyYWdnYWJsZSIsICJjdXJzb3IiLCB7CglzdGFydDogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSAkKCJib2R5IiksIG8gPSAkKHRoaXMpLmRhdGEoInVpLWRyYWdnYWJsZSIpLm9wdGlvbnM7CgkJaWYgKHQuY3NzKCJjdXJzb3IiKSkgewoJCQlvLl9jdXJzb3IgPSB0LmNzcygiY3Vyc29yIik7CgkJfQoJCXQuY3NzKCJjdXJzb3IiLCBvLmN1cnNvcik7Cgl9LAoJc3RvcDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSAkKHRoaXMpLmRhdGEoInVpLWRyYWdnYWJsZSIpLm9wdGlvbnM7CgkJaWYgKG8uX2N1cnNvcikgewoJCQkkKCJib2R5IikuY3NzKCJjdXJzb3IiLCBvLl9jdXJzb3IpOwoJCX0KCX0KfSk7CgokLnVpLnBsdWdpbi5hZGQoImRyYWdnYWJsZSIsICJvcGFjaXR5IiwgewoJc3RhcnQ6IGZ1bmN0aW9uKGV2ZW50LCB1aSkgewoJCXZhciB0ID0gJCh1aS5oZWxwZXIpLCBvID0gJCh0aGlzKS5kYXRhKCJ1aS1kcmFnZ2FibGUiKS5vcHRpb25zOwoJCWlmKHQuY3NzKCJvcGFjaXR5IikpIHsKCQkJby5fb3BhY2l0eSA9IHQuY3NzKCJvcGFjaXR5Iik7CgkJfQoJCXQuY3NzKCJvcGFjaXR5Iiwgby5vcGFjaXR5KTsKCX0sCglzdG9wOiBmdW5jdGlvbihldmVudCwgdWkpIHsKCQl2YXIgbyA9ICQodGhpcykuZGF0YSgidWktZHJhZ2dhYmxlIikub3B0aW9uczsKCQlpZihvLl9vcGFjaXR5KSB7CgkJCSQodWkuaGVscGVyKS5jc3MoIm9wYWNpdHkiLCBvLl9vcGFjaXR5KTsKCQl9Cgl9Cn0pOwoKJC51aS5wbHVnaW4uYWRkKCJkcmFnZ2FibGUiLCAic2Nyb2xsIiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBpID0gJCh0aGlzKS5kYXRhKCJ1aS1kcmFnZ2FibGUiKTsKCQlpZihpLnNjcm9sbFBhcmVudFswXSAhPT0gZG9jdW1lbnQgJiYgaS5zY3JvbGxQYXJlbnRbMF0udGFnTmFtZSAhPT0gIkhUTUwiKSB7CgkJCWkub3ZlcmZsb3dPZmZzZXQgPSBpLnNjcm9sbFBhcmVudC5vZmZzZXQoKTsKCQl9Cgl9LAoJZHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl2YXIgaSA9ICQodGhpcykuZGF0YSgidWktZHJhZ2dhYmxlIiksIG8gPSBpLm9wdGlvbnMsIHNjcm9sbGVkID0gZmFsc2U7CgoJCWlmKGkuc2Nyb2xsUGFyZW50WzBdICE9PSBkb2N1bWVudCAmJiBpLnNjcm9sbFBhcmVudFswXS50YWdOYW1lICE9PSAiSFRNTCIpIHsKCgkJCWlmKCFvLmF4aXMgfHwgby5heGlzICE9PSAieCIpIHsKCQkJCWlmKChpLm92ZXJmbG93T2Zmc2V0LnRvcCArIGkuc2Nyb2xsUGFyZW50WzBdLm9mZnNldEhlaWdodCkgLSBldmVudC5wYWdlWSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlpLnNjcm9sbFBhcmVudFswXS5zY3JvbGxUb3AgPSBzY3JvbGxlZCA9IGkuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcCArIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9IGVsc2UgaWYoZXZlbnQucGFnZVkgLSBpLm92ZXJmbG93T2Zmc2V0LnRvcCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlpLnNjcm9sbFBhcmVudFswXS5zY3JvbGxUb3AgPSBzY3JvbGxlZCA9IGkuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcCAtIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9CgkJCX0KCgkJCWlmKCFvLmF4aXMgfHwgby5heGlzICE9PSAieSIpIHsKCQkJCWlmKChpLm92ZXJmbG93T2Zmc2V0LmxlZnQgKyBpLnNjcm9sbFBhcmVudFswXS5vZmZzZXRXaWR0aCkgLSBldmVudC5wYWdlWCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlpLnNjcm9sbFBhcmVudFswXS5zY3JvbGxMZWZ0ID0gc2Nyb2xsZWQgPSBpLnNjcm9sbFBhcmVudFswXS5zY3JvbGxMZWZ0ICsgby5zY3JvbGxTcGVlZDsKCQkJCX0gZWxzZSBpZihldmVudC5wYWdlWCAtIGkub3ZlcmZsb3dPZmZzZXQubGVmdCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlpLnNjcm9sbFBhcmVudFswXS5zY3JvbGxMZWZ0ID0gc2Nyb2xsZWQgPSBpLnNjcm9sbFBhcmVudFswXS5zY3JvbGxMZWZ0IC0gby5zY3JvbGxTcGVlZDsKCQkJCX0KCQkJfQoKCQl9IGVsc2UgewoKCQkJaWYoIW8uYXhpcyB8fCBvLmF4aXMgIT09ICJ4IikgewoJCQkJaWYoZXZlbnQucGFnZVkgLSAkKGRvY3VtZW50KS5zY3JvbGxUb3AoKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlzY3JvbGxlZCA9ICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgkKGRvY3VtZW50KS5zY3JvbGxUb3AoKSAtIG8uc2Nyb2xsU3BlZWQpOwoJCQkJfSBlbHNlIGlmKCQod2luZG93KS5oZWlnaHQoKSAtIChldmVudC5wYWdlWSAtICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlzY3JvbGxlZCA9ICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgkKGRvY3VtZW50KS5zY3JvbGxUb3AoKSArIG8uc2Nyb2xsU3BlZWQpOwoJCQkJfQoJCQl9CgoJCQlpZighby5heGlzIHx8IG8uYXhpcyAhPT0gInkiKSB7CgkJCQlpZihldmVudC5wYWdlWCAtICQoZG9jdW1lbnQpLnNjcm9sbExlZnQoKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlzY3JvbGxlZCA9ICQoZG9jdW1lbnQpLnNjcm9sbExlZnQoJChkb2N1bWVudCkuc2Nyb2xsTGVmdCgpIC0gby5zY3JvbGxTcGVlZCk7CgkJCQl9IGVsc2UgaWYoJCh3aW5kb3cpLndpZHRoKCkgLSAoZXZlbnQucGFnZVggLSAkKGRvY3VtZW50KS5zY3JvbGxMZWZ0KCkpIDwgby5zY3JvbGxTZW5zaXRpdml0eSkgewoJCQkJCXNjcm9sbGVkID0gJChkb2N1bWVudCkuc2Nyb2xsTGVmdCgkKGRvY3VtZW50KS5zY3JvbGxMZWZ0KCkgKyBvLnNjcm9sbFNwZWVkKTsKCQkJCX0KCQkJfQoKCQl9CgoJCWlmKHNjcm9sbGVkICE9PSBmYWxzZSAmJiAkLnVpLmRkbWFuYWdlciAmJiAhby5kcm9wQmVoYXZpb3VyKSB7CgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKGksIGV2ZW50KTsKCQl9CgoJfQp9KTsKCiQudWkucGx1Z2luLmFkZCgiZHJhZ2dhYmxlIiwgInNuYXAiLCB7CglzdGFydDogZnVuY3Rpb24oKSB7CgoJCXZhciBpID0gJCh0aGlzKS5kYXRhKCJ1aS1kcmFnZ2FibGUiKSwKCQkJbyA9IGkub3B0aW9uczsKCgkJaS5zbmFwRWxlbWVudHMgPSBbXTsKCgkJJChvLnNuYXAuY29uc3RydWN0b3IgIT09IFN0cmluZyA\/ICggby5zbmFwLml0ZW1zIHx8ICI6ZGF0YSh1aS1kcmFnZ2FibGUpIiApIDogby5zbmFwKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHQgPSAkKHRoaXMpLAoJCQkJJG8gPSAkdC5vZmZzZXQoKTsKCQkJaWYodGhpcyAhPT0gaS5lbGVtZW50WzBdKSB7CgkJCQlpLnNuYXBFbGVtZW50cy5wdXNoKHsKCQkJCQlpdGVtOiB0aGlzLAoJCQkJCXdpZHRoOiAkdC5vdXRlcldpZHRoKCksIGhlaWdodDogJHQub3V0ZXJIZWlnaHQoKSwKCQkJCQl0b3A6ICRvLnRvcCwgbGVmdDogJG8ubGVmdAoJCQkJfSk7CgkJCX0KCQl9KTsKCgl9LAoJZHJhZzogZnVuY3Rpb24oZXZlbnQsIHVpKSB7CgoJCXZhciB0cywgYnMsIGxzLCBycywgbCwgciwgdCwgYiwgaSwgZmlyc3QsCgkJCWluc3QgPSAkKHRoaXMpLmRhdGEoInVpLWRyYWdnYWJsZSIpLAoJCQlvID0gaW5zdC5vcHRpb25zLAoJCQlkID0gby5zbmFwVG9sZXJhbmNlLAoJCQl4MSA9IHVpLm9mZnNldC5sZWZ0LCB4MiA9IHgxICsgaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCwKCQkJeTEgPSB1aS5vZmZzZXQudG9wLCB5MiA9IHkxICsgaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQ7CgoJCWZvciAoaSA9IGluc3Quc25hcEVsZW1lbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKCgkJCWwgPSBpbnN0LnNuYXBFbGVtZW50c1tpXS5sZWZ0OwoJCQlyID0gbCArIGluc3Quc25hcEVsZW1lbnRzW2ldLndpZHRoOwoJCQl0ID0gaW5zdC5zbmFwRWxlbWVudHNbaV0udG9wOwoJCQliID0gdCArIGluc3Quc25hcEVsZW1lbnRzW2ldLmhlaWdodDsKCgkJCWlmICggeDIgPCBsIC0gZCB8fCB4MSA+IHIgKyBkIHx8IHkyIDwgdCAtIGQgfHwgeTEgPiBiICsgZCB8fCAhJC5jb250YWlucyggaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5pdGVtLm93bmVyRG9jdW1lbnQsIGluc3Quc25hcEVsZW1lbnRzWyBpIF0uaXRlbSApICkgewoJCQkJaWYoaW5zdC5zbmFwRWxlbWVudHNbaV0uc25hcHBpbmcpIHsKCQkJCQkoaW5zdC5vcHRpb25zLnNuYXAucmVsZWFzZSAmJiBpbnN0Lm9wdGlvbnMuc25hcC5yZWxlYXNlLmNhbGwoaW5zdC5lbGVtZW50LCBldmVudCwgJC5leHRlbmQoaW5zdC5fdWlIYXNoKCksIHsgc25hcEl0ZW06IGluc3Quc25hcEVsZW1lbnRzW2ldLml0ZW0gfSkpKTsKCQkJCX0KCQkJCWluc3Quc25hcEVsZW1lbnRzW2ldLnNuYXBwaW5nID0gZmFsc2U7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJaWYoby5zbmFwTW9kZSAhPT0gImlubmVyIikgewoJCQkJdHMgPSBNYXRoLmFicyh0IC0geTIpIDw9IGQ7CgkJCQlicyA9IE1hdGguYWJzKGIgLSB5MSkgPD0gZDsKCQkJCWxzID0gTWF0aC5hYnMobCAtIHgyKSA8PSBkOwoJCQkJcnMgPSBNYXRoLmFicyhyIC0geDEpIDw9IGQ7CgkJCQlpZih0cykgewoJCQkJCXVpLnBvc2l0aW9uLnRvcCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCJyZWxhdGl2ZSIsIHsgdG9wOiB0IC0gaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQsIGxlZnQ6IDAgfSkudG9wIC0gaW5zdC5tYXJnaW5zLnRvcDsKCQkJCX0KCQkJCWlmKGJzKSB7CgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oInJlbGF0aXZlIiwgeyB0b3A6IGIsIGxlZnQ6IDAgfSkudG9wIC0gaW5zdC5tYXJnaW5zLnRvcDsKCQkJCX0KCQkJCWlmKGxzKSB7CgkJCQkJdWkucG9zaXRpb24ubGVmdCA9IGluc3QuX2NvbnZlcnRQb3NpdGlvblRvKCJyZWxhdGl2ZSIsIHsgdG9wOiAwLCBsZWZ0OiBsIC0gaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCB9KS5sZWZ0IC0gaW5zdC5tYXJnaW5zLmxlZnQ7CgkJCQl9CgkJCQlpZihycykgewoJCQkJCXVpLnBvc2l0aW9uLmxlZnQgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbygicmVsYXRpdmUiLCB7IHRvcDogMCwgbGVmdDogciB9KS5sZWZ0IC0gaW5zdC5tYXJnaW5zLmxlZnQ7CgkJCQl9CgkJCX0KCgkJCWZpcnN0ID0gKHRzIHx8IGJzIHx8IGxzIHx8IHJzKTsKCgkJCWlmKG8uc25hcE1vZGUgIT09ICJvdXRlciIpIHsKCQkJCXRzID0gTWF0aC5hYnModCAtIHkxKSA8PSBkOwoJCQkJYnMgPSBNYXRoLmFicyhiIC0geTIpIDw9IGQ7CgkJCQlscyA9IE1hdGguYWJzKGwgLSB4MSkgPD0gZDsKCQkJCXJzID0gTWF0aC5hYnMociAtIHgyKSA8PSBkOwoJCQkJaWYodHMpIHsKCQkJCQl1aS5wb3NpdGlvbi50b3AgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbygicmVsYXRpdmUiLCB7IHRvcDogdCwgbGVmdDogMCB9KS50b3AgLSBpbnN0Lm1hcmdpbnMudG9wOwoJCQkJfQoJCQkJaWYoYnMpIHsKCQkJCQl1aS5wb3NpdGlvbi50b3AgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbygicmVsYXRpdmUiLCB7IHRvcDogYiAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LCBsZWZ0OiAwIH0pLnRvcCAtIGluc3QubWFyZ2lucy50b3A7CgkJCQl9CgkJCQlpZihscykgewoJCQkJCXVpLnBvc2l0aW9uLmxlZnQgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbygicmVsYXRpdmUiLCB7IHRvcDogMCwgbGVmdDogbCB9KS5sZWZ0IC0gaW5zdC5tYXJnaW5zLmxlZnQ7CgkJCQl9CgkJCQlpZihycykgewoJCQkJCXVpLnBvc2l0aW9uLmxlZnQgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbygicmVsYXRpdmUiLCB7IHRvcDogMCwgbGVmdDogciAtIGluc3QuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggfSkubGVmdCAtIGluc3QubWFyZ2lucy5sZWZ0OwoJCQkJfQoJCQl9CgoJCQlpZighaW5zdC5zbmFwRWxlbWVudHNbaV0uc25hcHBpbmcgJiYgKHRzIHx8IGJzIHx8IGxzIHx8IHJzIHx8IGZpcnN0KSkgewoJCQkJKGluc3Qub3B0aW9ucy5zbmFwLnNuYXAgJiYgaW5zdC5vcHRpb25zLnNuYXAuc25hcC5jYWxsKGluc3QuZWxlbWVudCwgZXZlbnQsICQuZXh0ZW5kKGluc3QuX3VpSGFzaCgpLCB7IHNuYXBJdGVtOiBpbnN0LnNuYXBFbGVtZW50c1tpXS5pdGVtIH0pKSk7CgkJCX0KCQkJaW5zdC5zbmFwRWxlbWVudHNbaV0uc25hcHBpbmcgPSAodHMgfHwgYnMgfHwgbHMgfHwgcnMgfHwgZmlyc3QpOwoKCQl9CgoJfQp9KTsKCiQudWkucGx1Z2luLmFkZCgiZHJhZ2dhYmxlIiwgInN0YWNrIiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBtaW4sCgkJCW8gPSB0aGlzLmRhdGEoInVpLWRyYWdnYWJsZSIpLm9wdGlvbnMsCgkJCWdyb3VwID0gJC5tYWtlQXJyYXkoJChvLnN0YWNrKSkuc29ydChmdW5jdGlvbihhLGIpIHsKCQkJCXJldHVybiAocGFyc2VJbnQoJChhKS5jc3MoInpJbmRleCIpLDEwKSB8fCAwKSAtIChwYXJzZUludCgkKGIpLmNzcygiekluZGV4IiksMTApIHx8IDApOwoJCQl9KTsKCgkJaWYgKCFncm91cC5sZW5ndGgpIHsgcmV0dXJuOyB9CgoJCW1pbiA9IHBhcnNlSW50KCQoZ3JvdXBbMF0pLmNzcygiekluZGV4IiksIDEwKSB8fCAwOwoJCSQoZ3JvdXApLmVhY2goZnVuY3Rpb24oaSkgewoJCQkkKHRoaXMpLmNzcygiekluZGV4IiwgbWluICsgaSk7CgkJfSk7CgkJdGhpcy5jc3MoInpJbmRleCIsIChtaW4gKyBncm91cC5sZW5ndGgpKTsKCX0KfSk7CgokLnVpLnBsdWdpbi5hZGQoImRyYWdnYWJsZSIsICJ6SW5kZXgiLCB7CglzdGFydDogZnVuY3Rpb24oZXZlbnQsIHVpKSB7CgkJdmFyIHQgPSAkKHVpLmhlbHBlciksIG8gPSAkKHRoaXMpLmRhdGEoInVpLWRyYWdnYWJsZSIpLm9wdGlvbnM7CgkJaWYodC5jc3MoInpJbmRleCIpKSB7CgkJCW8uX3pJbmRleCA9IHQuY3NzKCJ6SW5kZXgiKTsKCQl9CgkJdC5jc3MoInpJbmRleCIsIG8uekluZGV4KTsKCX0sCglzdG9wOiBmdW5jdGlvbihldmVudCwgdWkpIHsKCQl2YXIgbyA9ICQodGhpcykuZGF0YSgidWktZHJhZ2dhYmxlIikub3B0aW9uczsKCQlpZihvLl96SW5kZXgpIHsKCQkJJCh1aS5oZWxwZXIpLmNzcygiekluZGV4Iiwgby5fekluZGV4KTsKCQl9Cgl9Cn0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBpc092ZXJBeGlzKCB4LCByZWZlcmVuY2UsIHNpemUgKSB7CglyZXR1cm4gKCB4ID4gcmVmZXJlbmNlICkgJiYgKCB4IDwgKCByZWZlcmVuY2UgKyBzaXplICkgKTsKfQoKJC53aWRnZXQoInVpLmRyb3BwYWJsZSIsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJkcm9wIiwKCW9wdGlvbnM6IHsKCQlhY2NlcHQ6ICIqIiwKCQlhY3RpdmVDbGFzczogZmFsc2UsCgkJYWRkQ2xhc3NlczogdHJ1ZSwKCQlncmVlZHk6IGZhbHNlLAoJCWhvdmVyQ2xhc3M6IGZhbHNlLAoJCXNjb3BlOiAiZGVmYXVsdCIsCgkJdG9sZXJhbmNlOiAiaW50ZXJzZWN0IiwKCgkJLy8gY2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJZGVhY3RpdmF0ZTogbnVsbCwKCQlkcm9wOiBudWxsLAoJCW91dDogbnVsbCwKCQlvdmVyOiBudWxsCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQlhY2NlcHQgPSBvLmFjY2VwdDsKCgkJdGhpcy5pc292ZXIgPSBmYWxzZTsKCQl0aGlzLmlzb3V0ID0gdHJ1ZTsKCgkJdGhpcy5hY2NlcHQgPSAkLmlzRnVuY3Rpb24oYWNjZXB0KSA\/IGFjY2VwdCA6IGZ1bmN0aW9uKGQpIHsKCQkJcmV0dXJuIGQuaXMoYWNjZXB0KTsKCQl9OwoKCQkvL1N0b3JlIHRoZSBkcm9wcGFibGUncyBwcm9wb3J0aW9ucwoJCXRoaXMucHJvcG9ydGlvbnMgPSB7IHdpZHRoOiB0aGlzLmVsZW1lbnRbMF0ub2Zmc2V0V2lkdGgsIGhlaWdodDogdGhpcy5lbGVtZW50WzBdLm9mZnNldEhlaWdodCB9OwoKCQkvLyBBZGQgdGhlIHJlZmVyZW5jZSBhbmQgcG9zaXRpb25zIHRvIHRoZSBtYW5hZ2VyCgkJJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1tvLnNjb3BlXSA9ICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbby5zY29wZV0gfHwgW107CgkJJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1tvLnNjb3BlXS5wdXNoKHRoaXMpOwoKCQkoby5hZGRDbGFzc2VzICYmIHRoaXMuZWxlbWVudC5hZGRDbGFzcygidWktZHJvcHBhYmxlIikpOwoKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBpID0gMCwKCQkJZHJvcCA9ICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbdGhpcy5vcHRpb25zLnNjb3BlXTsKCgkJZm9yICggOyBpIDwgZHJvcC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBkcm9wW2ldID09PSB0aGlzICkgewoJCQkJZHJvcC5zcGxpY2UoaSwgMSk7CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcygidWktZHJvcHBhYmxlIHVpLWRyb3BwYWJsZS1kaXNhYmxlZCIpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgoJCWlmKGtleSA9PT0gImFjY2VwdCIpIHsKCQkJdGhpcy5hY2NlcHQgPSAkLmlzRnVuY3Rpb24odmFsdWUpID8gdmFsdWUgOiBmdW5jdGlvbihkKSB7CgkJCQlyZXR1cm4gZC5pcyh2YWx1ZSk7CgkJCX07CgkJfQoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fc2V0T3B0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsKCQlpZih0aGlzLm9wdGlvbnMuYWN0aXZlQ2xhc3MpIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKHRoaXMub3B0aW9ucy5hY3RpdmVDbGFzcyk7CgkJfQoJCWlmKGRyYWdnYWJsZSl7CgkJCXRoaXMuX3RyaWdnZXIoImFjdGl2YXRlIiwgZXZlbnQsIHRoaXMudWkoZHJhZ2dhYmxlKSk7CgkJfQoJfSwKCglfZGVhY3RpdmF0ZTogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsKCQlpZih0aGlzLm9wdGlvbnMuYWN0aXZlQ2xhc3MpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKHRoaXMub3B0aW9ucy5hY3RpdmVDbGFzcyk7CgkJfQoJCWlmKGRyYWdnYWJsZSl7CgkJCXRoaXMuX3RyaWdnZXIoImRlYWN0aXZhdGUiLCBldmVudCwgdGhpcy51aShkcmFnZ2FibGUpKTsKCQl9Cgl9LAoKCV9vdmVyOiBmdW5jdGlvbihldmVudCkgewoKCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsKCgkJLy8gQmFpbCBpZiBkcmFnZ2FibGUgYW5kIGRyb3BwYWJsZSBhcmUgc2FtZSBlbGVtZW50CgkJaWYgKCFkcmFnZ2FibGUgfHwgKGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudClbMF0gPT09IHRoaXMuZWxlbWVudFswXSkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAodGhpcy5hY2NlcHQuY2FsbCh0aGlzLmVsZW1lbnRbMF0sKGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudCkpKSB7CgkJCWlmKHRoaXMub3B0aW9ucy5ob3ZlckNsYXNzKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3ModGhpcy5vcHRpb25zLmhvdmVyQ2xhc3MpOwoJCQl9CgkJCXRoaXMuX3RyaWdnZXIoIm92ZXIiLCBldmVudCwgdGhpcy51aShkcmFnZ2FibGUpKTsKCQl9CgoJfSwKCglfb3V0OiBmdW5jdGlvbihldmVudCkgewoKCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsKCgkJLy8gQmFpbCBpZiBkcmFnZ2FibGUgYW5kIGRyb3BwYWJsZSBhcmUgc2FtZSBlbGVtZW50CgkJaWYgKCFkcmFnZ2FibGUgfHwgKGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudClbMF0gPT09IHRoaXMuZWxlbWVudFswXSkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAodGhpcy5hY2NlcHQuY2FsbCh0aGlzLmVsZW1lbnRbMF0sKGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudCkpKSB7CgkJCWlmKHRoaXMub3B0aW9ucy5ob3ZlckNsYXNzKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3ModGhpcy5vcHRpb25zLmhvdmVyQ2xhc3MpOwoJCQl9CgkJCXRoaXMuX3RyaWdnZXIoIm91dCIsIGV2ZW50LCB0aGlzLnVpKGRyYWdnYWJsZSkpOwoJCX0KCgl9LAoKCV9kcm9wOiBmdW5jdGlvbihldmVudCxjdXN0b20pIHsKCgkJdmFyIGRyYWdnYWJsZSA9IGN1c3RvbSB8fCAkLnVpLmRkbWFuYWdlci5jdXJyZW50LAoJCQljaGlsZHJlbkludGVyc2VjdGlvbiA9IGZhbHNlOwoKCQkvLyBCYWlsIGlmIGRyYWdnYWJsZSBhbmQgZHJvcHBhYmxlIGFyZSBzYW1lIGVsZW1lbnQKCQlpZiAoIWRyYWdnYWJsZSB8fCAoZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8IGRyYWdnYWJsZS5lbGVtZW50KVswXSA9PT0gdGhpcy5lbGVtZW50WzBdKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXRoaXMuZWxlbWVudC5maW5kKCI6ZGF0YSh1aS1kcm9wcGFibGUpIikubm90KCIudWktZHJhZ2dhYmxlLWRyYWdnaW5nIikuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGluc3QgPSAkLmRhdGEodGhpcywgInVpLWRyb3BwYWJsZSIpOwoJCQlpZigKCQkJCWluc3Qub3B0aW9ucy5ncmVlZHkgJiYKCQkJCSFpbnN0Lm9wdGlvbnMuZGlzYWJsZWQgJiYKCQkJCWluc3Qub3B0aW9ucy5zY29wZSA9PT0gZHJhZ2dhYmxlLm9wdGlvbnMuc2NvcGUgJiYKCQkJCWluc3QuYWNjZXB0LmNhbGwoaW5zdC5lbGVtZW50WzBdLCAoZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8IGRyYWdnYWJsZS5lbGVtZW50KSkgJiYKCQkJCSQudWkuaW50ZXJzZWN0KGRyYWdnYWJsZSwgJC5leHRlbmQoaW5zdCwgeyBvZmZzZXQ6IGluc3QuZWxlbWVudC5vZmZzZXQoKSB9KSwgaW5zdC5vcHRpb25zLnRvbGVyYW5jZSkKCQkJKSB7IGNoaWxkcmVuSW50ZXJzZWN0aW9uID0gdHJ1ZTsgcmV0dXJuIGZhbHNlOyB9CgkJfSk7CgkJaWYoY2hpbGRyZW5JbnRlcnNlY3Rpb24pIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYodGhpcy5hY2NlcHQuY2FsbCh0aGlzLmVsZW1lbnRbMF0sKGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudCkpKSB7CgkJCWlmKHRoaXMub3B0aW9ucy5hY3RpdmVDbGFzcykgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKHRoaXMub3B0aW9ucy5hY3RpdmVDbGFzcyk7CgkJCX0KCQkJaWYodGhpcy5vcHRpb25zLmhvdmVyQ2xhc3MpIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyh0aGlzLm9wdGlvbnMuaG92ZXJDbGFzcyk7CgkJCX0KCQkJdGhpcy5fdHJpZ2dlcigiZHJvcCIsIGV2ZW50LCB0aGlzLnVpKGRyYWdnYWJsZSkpOwoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIGZhbHNlOwoKCX0sCgoJdWk6IGZ1bmN0aW9uKGMpIHsKCQlyZXR1cm4gewoJCQlkcmFnZ2FibGU6IChjLmN1cnJlbnRJdGVtIHx8IGMuZWxlbWVudCksCgkJCWhlbHBlcjogYy5oZWxwZXIsCgkJCXBvc2l0aW9uOiBjLnBvc2l0aW9uLAoJCQlvZmZzZXQ6IGMucG9zaXRpb25BYnMKCQl9OwoJfQoKfSk7CgokLnVpLmludGVyc2VjdCA9IGZ1bmN0aW9uKGRyYWdnYWJsZSwgZHJvcHBhYmxlLCB0b2xlcmFuY2VNb2RlKSB7CgoJaWYgKCFkcm9wcGFibGUub2Zmc2V0KSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCXZhciBkcmFnZ2FibGVMZWZ0LCBkcmFnZ2FibGVUb3AsCgkJeDEgPSAoZHJhZ2dhYmxlLnBvc2l0aW9uQWJzIHx8IGRyYWdnYWJsZS5wb3NpdGlvbi5hYnNvbHV0ZSkubGVmdCwgeDIgPSB4MSArIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCwKCQl5MSA9IChkcmFnZ2FibGUucG9zaXRpb25BYnMgfHwgZHJhZ2dhYmxlLnBvc2l0aW9uLmFic29sdXRlKS50b3AsIHkyID0geTEgKyBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LAoJCWwgPSBkcm9wcGFibGUub2Zmc2V0LmxlZnQsIHIgPSBsICsgZHJvcHBhYmxlLnByb3BvcnRpb25zLndpZHRoLAoJCXQgPSBkcm9wcGFibGUub2Zmc2V0LnRvcCwgYiA9IHQgKyBkcm9wcGFibGUucHJvcG9ydGlvbnMuaGVpZ2h0OwoKCXN3aXRjaCAodG9sZXJhbmNlTW9kZSkgewoJCWNhc2UgImZpdCI6CgkJCXJldHVybiAobCA8PSB4MSAmJiB4MiA8PSByICYmIHQgPD0geTEgJiYgeTIgPD0gYik7CgkJY2FzZSAiaW50ZXJzZWN0IjoKCQkJcmV0dXJuIChsIDwgeDEgKyAoZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC8gMikgJiYgLy8gUmlnaHQgSGFsZgoJCQkJeDIgLSAoZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC8gMikgPCByICYmIC8vIExlZnQgSGFsZgoJCQkJdCA8IHkxICsgKGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLyAyKSAmJiAvLyBCb3R0b20gSGFsZgoJCQkJeTIgLSAoZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAvIDIpIDwgYiApOyAvLyBUb3AgSGFsZgoJCWNhc2UgInBvaW50ZXIiOgoJCQlkcmFnZ2FibGVMZWZ0ID0gKChkcmFnZ2FibGUucG9zaXRpb25BYnMgfHwgZHJhZ2dhYmxlLnBvc2l0aW9uLmFic29sdXRlKS5sZWZ0ICsgKGRyYWdnYWJsZS5jbGlja09mZnNldCB8fCBkcmFnZ2FibGUub2Zmc2V0LmNsaWNrKS5sZWZ0KTsKCQkJZHJhZ2dhYmxlVG9wID0gKChkcmFnZ2FibGUucG9zaXRpb25BYnMgfHwgZHJhZ2dhYmxlLnBvc2l0aW9uLmFic29sdXRlKS50b3AgKyAoZHJhZ2dhYmxlLmNsaWNrT2Zmc2V0IHx8IGRyYWdnYWJsZS5vZmZzZXQuY2xpY2spLnRvcCk7CgkJCXJldHVybiBpc092ZXJBeGlzKCBkcmFnZ2FibGVUb3AsIHQsIGRyb3BwYWJsZS5wcm9wb3J0aW9ucy5oZWlnaHQgKSAmJiBpc092ZXJBeGlzKCBkcmFnZ2FibGVMZWZ0LCBsLCBkcm9wcGFibGUucHJvcG9ydGlvbnMud2lkdGggKTsKCQljYXNlICJ0b3VjaCI6CgkJCXJldHVybiAoCgkJCQkoeTEgPj0gdCAmJiB5MSA8PSBiKSB8fAkvLyBUb3AgZWRnZSB0b3VjaGluZwoJCQkJKHkyID49IHQgJiYgeTIgPD0gYikgfHwJLy8gQm90dG9tIGVkZ2UgdG91Y2hpbmcKCQkJCSh5MSA8IHQgJiYgeTIgPiBiKQkJLy8gU3Vycm91bmRlZCB2ZXJ0aWNhbGx5CgkJCSkgJiYgKAoJCQkJKHgxID49IGwgJiYgeDEgPD0gcikgfHwJLy8gTGVmdCBlZGdlIHRvdWNoaW5nCgkJCQkoeDIgPj0gbCAmJiB4MiA8PSByKSB8fAkvLyBSaWdodCBlZGdlIHRvdWNoaW5nCgkJCQkoeDEgPCBsICYmIHgyID4gcikJCS8vIFN1cnJvdW5kZWQgaG9yaXpvbnRhbGx5CgkJCSk7CgkJZGVmYXVsdDoKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCn07CgovKgoJVGhpcyBtYW5hZ2VyIHRyYWNrcyBvZmZzZXRzIG9mIGRyYWdnYWJsZXMgYW5kIGRyb3BwYWJsZXMKKi8KJC51aS5kZG1hbmFnZXIgPSB7CgljdXJyZW50OiBudWxsLAoJZHJvcHBhYmxlczogeyAiZGVmYXVsdCI6IFtdIH0sCglwcmVwYXJlT2Zmc2V0czogZnVuY3Rpb24odCwgZXZlbnQpIHsKCgkJdmFyIGksIGosCgkJCW0gPSAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzW3Qub3B0aW9ucy5zY29wZV0gfHwgW10sCgkJCXR5cGUgPSBldmVudCA\/IGV2ZW50LnR5cGUgOiBudWxsLCAvLyB3b3JrYXJvdW5kIGZvciAjMjMxNwoJCQlsaXN0ID0gKHQuY3VycmVudEl0ZW0gfHwgdC5lbGVtZW50KS5maW5kKCI6ZGF0YSh1aS1kcm9wcGFibGUpIikuYWRkQmFjaygpOwoKCQlkcm9wcGFibGVzTG9vcDogZm9yIChpID0gMDsgaSA8IG0ubGVuZ3RoOyBpKyspIHsKCgkJCS8vTm8gZGlzYWJsZWQgYW5kIG5vbi1hY2NlcHRlZAoJCQlpZihtW2ldLm9wdGlvbnMuZGlzYWJsZWQgfHwgKHQgJiYgIW1baV0uYWNjZXB0LmNhbGwobVtpXS5lbGVtZW50WzBdLCh0LmN1cnJlbnRJdGVtIHx8IHQuZWxlbWVudCkpKSkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCS8vIEZpbHRlciBvdXQgZWxlbWVudHMgaW4gdGhlIGN1cnJlbnQgZHJhZ2dlZCBpdGVtCgkJCWZvciAoaj0wOyBqIDwgbGlzdC5sZW5ndGg7IGorKykgewoJCQkJaWYobGlzdFtqXSA9PT0gbVtpXS5lbGVtZW50WzBdKSB7CgkJCQkJbVtpXS5wcm9wb3J0aW9ucy5oZWlnaHQgPSAwOwoJCQkJCWNvbnRpbnVlIGRyb3BwYWJsZXNMb29wOwoJCQkJfQoJCQl9CgoJCQltW2ldLnZpc2libGUgPSBtW2ldLmVsZW1lbnQuY3NzKCJkaXNwbGF5IikgIT09ICJub25lIjsKCQkJaWYoIW1baV0udmlzaWJsZSkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCS8vQWN0aXZhdGUgdGhlIGRyb3BwYWJsZSBpZiB1c2VkIGRpcmVjdGx5IGZyb20gZHJhZ2dhYmxlcwoJCQlpZih0eXBlID09PSAibW91c2Vkb3duIikgewoJCQkJbVtpXS5fYWN0aXZhdGUuY2FsbChtW2ldLCBldmVudCk7CgkJCX0KCgkJCW1baV0ub2Zmc2V0ID0gbVtpXS5lbGVtZW50Lm9mZnNldCgpOwoJCQltW2ldLnByb3BvcnRpb25zID0geyB3aWR0aDogbVtpXS5lbGVtZW50WzBdLm9mZnNldFdpZHRoLCBoZWlnaHQ6IG1baV0uZWxlbWVudFswXS5vZmZzZXRIZWlnaHQgfTsKCgkJfQoKCX0sCglkcm9wOiBmdW5jdGlvbihkcmFnZ2FibGUsIGV2ZW50KSB7CgoJCXZhciBkcm9wcGVkID0gZmFsc2U7CgkJLy8gQ3JlYXRlIGEgY29weSBvZiB0aGUgZHJvcHBhYmxlcyBpbiBjYXNlIHRoZSBsaXN0IGNoYW5nZXMgZHVyaW5nIHRoZSBkcm9wICgjOTExNikKCQkkLmVhY2goKCQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbZHJhZ2dhYmxlLm9wdGlvbnMuc2NvcGVdIHx8IFtdKS5zbGljZSgpLCBmdW5jdGlvbigpIHsKCgkJCWlmKCF0aGlzLm9wdGlvbnMpIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIXRoaXMub3B0aW9ucy5kaXNhYmxlZCAmJiB0aGlzLnZpc2libGUgJiYgJC51aS5pbnRlcnNlY3QoZHJhZ2dhYmxlLCB0aGlzLCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlKSkgewoJCQkJZHJvcHBlZCA9IHRoaXMuX2Ryb3AuY2FsbCh0aGlzLCBldmVudCkgfHwgZHJvcHBlZDsKCQkJfQoKCQkJaWYgKCF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgJiYgdGhpcy52aXNpYmxlICYmIHRoaXMuYWNjZXB0LmNhbGwodGhpcy5lbGVtZW50WzBdLChkcmFnZ2FibGUuY3VycmVudEl0ZW0gfHwgZHJhZ2dhYmxlLmVsZW1lbnQpKSkgewoJCQkJdGhpcy5pc291dCA9IHRydWU7CgkJCQl0aGlzLmlzb3ZlciA9IGZhbHNlOwoJCQkJdGhpcy5fZGVhY3RpdmF0ZS5jYWxsKHRoaXMsIGV2ZW50KTsKCQkJfQoKCQl9KTsKCQlyZXR1cm4gZHJvcHBlZDsKCgl9LAoJZHJhZ1N0YXJ0OiBmdW5jdGlvbiggZHJhZ2dhYmxlLCBldmVudCApIHsKCQkvL0xpc3RlbiBmb3Igc2Nyb2xsaW5nIHNvIHRoYXQgaWYgdGhlIGRyYWdnaW5nIGNhdXNlcyBzY3JvbGxpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSBkcm9wcGFibGVzIGNhbiBiZSByZWNhbGN1bGF0ZWQgKHNlZSAjNTAwMykKCQlkcmFnZ2FibGUuZWxlbWVudC5wYXJlbnRzVW50aWwoICJib2R5IiApLmJpbmQoICJzY3JvbGwuZHJvcHBhYmxlIiwgZnVuY3Rpb24oKSB7CgkJCWlmKCAhZHJhZ2dhYmxlLm9wdGlvbnMucmVmcmVzaFBvc2l0aW9ucyApIHsKCQkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBkcmFnZ2FibGUsIGV2ZW50ICk7CgkJCX0KCQl9KTsKCX0sCglkcmFnOiBmdW5jdGlvbihkcmFnZ2FibGUsIGV2ZW50KSB7CgoJCS8vSWYgeW91IGhhdmUgYSBoaWdobHkgZHluYW1pYyBwYWdlLCB5b3UgbWlnaHQgdHJ5IHRoaXMgb3B0aW9uLiBJdCByZW5kZXJzIHBvc2l0aW9ucyBldmVyeSB0aW1lIHlvdSBtb3ZlIHRoZSBtb3VzZS4KCQlpZihkcmFnZ2FibGUub3B0aW9ucy5yZWZyZXNoUG9zaXRpb25zKSB7CgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKGRyYWdnYWJsZSwgZXZlbnQpOwoJCX0KCgkJLy9SdW4gdGhyb3VnaCBhbGwgZHJvcHBhYmxlcyBhbmQgY2hlY2sgdGhlaXIgcG9zaXRpb25zIGJhc2VkIG9uIHNwZWNpZmljIHRvbGVyYW5jZSBvcHRpb25zCgkJJC5lYWNoKCQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbZHJhZ2dhYmxlLm9wdGlvbnMuc2NvcGVdIHx8IFtdLCBmdW5jdGlvbigpIHsKCgkJCWlmKHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmdyZWVkeUNoaWxkIHx8ICF0aGlzLnZpc2libGUpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHBhcmVudEluc3RhbmNlLCBzY29wZSwgcGFyZW50LAoJCQkJaW50ZXJzZWN0cyA9ICQudWkuaW50ZXJzZWN0KGRyYWdnYWJsZSwgdGhpcywgdGhpcy5vcHRpb25zLnRvbGVyYW5jZSksCgkJCQljID0gIWludGVyc2VjdHMgJiYgdGhpcy5pc292ZXIgPyAiaXNvdXQiIDogKGludGVyc2VjdHMgJiYgIXRoaXMuaXNvdmVyID8gImlzb3ZlciIgOiBudWxsKTsKCQkJaWYoIWMpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKHRoaXMub3B0aW9ucy5ncmVlZHkpIHsKCQkJCS8vIGZpbmQgZHJvcHBhYmxlIHBhcmVudHMgd2l0aCBzYW1lIHNjb3BlCgkJCQlzY29wZSA9IHRoaXMub3B0aW9ucy5zY29wZTsKCQkJCXBhcmVudCA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCI6ZGF0YSh1aS1kcm9wcGFibGUpIikuZmlsdGVyKGZ1bmN0aW9uICgpIHsKCQkJCQlyZXR1cm4gJC5kYXRhKHRoaXMsICJ1aS1kcm9wcGFibGUiKS5vcHRpb25zLnNjb3BlID09PSBzY29wZTsKCQkJCX0pOwoKCQkJCWlmIChwYXJlbnQubGVuZ3RoKSB7CgkJCQkJcGFyZW50SW5zdGFuY2UgPSAkLmRhdGEocGFyZW50WzBdLCAidWktZHJvcHBhYmxlIik7CgkJCQkJcGFyZW50SW5zdGFuY2UuZ3JlZWR5Q2hpbGQgPSAoYyA9PT0gImlzb3ZlciIpOwoJCQkJfQoJCQl9CgoJCQkvLyB3ZSBqdXN0IG1vdmVkIGludG8gYSBncmVlZHkgY2hpbGQKCQkJaWYgKHBhcmVudEluc3RhbmNlICYmIGMgPT09ICJpc292ZXIiKSB7CgkJCQlwYXJlbnRJbnN0YW5jZS5pc292ZXIgPSBmYWxzZTsKCQkJCXBhcmVudEluc3RhbmNlLmlzb3V0ID0gdHJ1ZTsKCQkJCXBhcmVudEluc3RhbmNlLl9vdXQuY2FsbChwYXJlbnRJbnN0YW5jZSwgZXZlbnQpOwoJCQl9CgoJCQl0aGlzW2NdID0gdHJ1ZTsKCQkJdGhpc1tjID09PSAiaXNvdXQiID8gImlzb3ZlciIgOiAiaXNvdXQiXSA9IGZhbHNlOwoJCQl0aGlzW2MgPT09ICJpc292ZXIiID8gIl9vdmVyIiA6ICJfb3V0Il0uY2FsbCh0aGlzLCBldmVudCk7CgoJCQkvLyB3ZSBqdXN0IG1vdmVkIG91dCBvZiBhIGdyZWVkeSBjaGlsZAoJCQlpZiAocGFyZW50SW5zdGFuY2UgJiYgYyA9PT0gImlzb3V0IikgewoJCQkJcGFyZW50SW5zdGFuY2UuaXNvdXQgPSBmYWxzZTsKCQkJCXBhcmVudEluc3RhbmNlLmlzb3ZlciA9IHRydWU7CgkJCQlwYXJlbnRJbnN0YW5jZS5fb3Zlci5jYWxsKHBhcmVudEluc3RhbmNlLCBldmVudCk7CgkJCX0KCQl9KTsKCgl9LAoJZHJhZ1N0b3A6IGZ1bmN0aW9uKCBkcmFnZ2FibGUsIGV2ZW50ICkgewoJCWRyYWdnYWJsZS5lbGVtZW50LnBhcmVudHNVbnRpbCggImJvZHkiICkudW5iaW5kKCAic2Nyb2xsLmRyb3BwYWJsZSIgKTsKCQkvL0NhbGwgcHJlcGFyZU9mZnNldHMgb25lIGZpbmFsIHRpbWUgc2luY2UgSUUgZG9lcyBub3QgZmlyZSByZXR1cm4gc2Nyb2xsIGV2ZW50cyB3aGVuIG92ZXJmbG93IHdhcyBjYXVzZWQgYnkgZHJhZyAoc2VlICM1MDAzKQoJCWlmKCAhZHJhZ2dhYmxlLm9wdGlvbnMucmVmcmVzaFBvc2l0aW9ucyApIHsKCQkJJC51aS5kZG1hbmFnZXIucHJlcGFyZU9mZnNldHMoIGRyYWdnYWJsZSwgZXZlbnQgKTsKCQl9Cgl9Cn07Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCmZ1bmN0aW9uIG51bSh2KSB7CglyZXR1cm4gcGFyc2VJbnQodiwgMTApIHx8IDA7Cn0KCmZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKSB7CglyZXR1cm4gIWlzTmFOKHBhcnNlSW50KHZhbHVlLCAxMCkpOwp9CgokLndpZGdldCgidWkucmVzaXphYmxlIiwgJC51aS5tb3VzZSwgewoJdmVyc2lvbjogIjEuMTAuMyIsCgl3aWRnZXRFdmVudFByZWZpeDogInJlc2l6ZSIsCglvcHRpb25zOiB7CgkJYWxzb1Jlc2l6ZTogZmFsc2UsCgkJYW5pbWF0ZTogZmFsc2UsCgkJYW5pbWF0ZUR1cmF0aW9uOiAic2xvdyIsCgkJYW5pbWF0ZUVhc2luZzogInN3aW5nIiwKCQlhc3BlY3RSYXRpbzogZmFsc2UsCgkJYXV0b0hpZGU6IGZhbHNlLAoJCWNvbnRhaW5tZW50OiBmYWxzZSwKCQlnaG9zdDogZmFsc2UsCgkJZ3JpZDogZmFsc2UsCgkJaGFuZGxlczogImUscyxzZSIsCgkJaGVscGVyOiBmYWxzZSwKCQltYXhIZWlnaHQ6IG51bGwsCgkJbWF4V2lkdGg6IG51bGwsCgkJbWluSGVpZ2h0OiAxMCwKCQltaW5XaWR0aDogMTAsCgkJLy8gU2VlICM3OTYwCgkJekluZGV4OiA5MCwKCgkJLy8gY2FsbGJhY2tzCgkJcmVzaXplOiBudWxsLAoJCXN0YXJ0OiBudWxsLAoJCXN0b3A6IG51bGwKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIG4sIGksIGhhbmRsZSwgYXhpcywgaG5hbWUsCgkJCXRoYXQgPSB0aGlzLAoJCQlvID0gdGhpcy5vcHRpb25zOwoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcygidWktcmVzaXphYmxlIik7CgoJCSQuZXh0ZW5kKHRoaXMsIHsKCQkJX2FzcGVjdFJhdGlvOiAhIShvLmFzcGVjdFJhdGlvKSwKCQkJYXNwZWN0UmF0aW86IG8uYXNwZWN0UmF0aW8sCgkJCW9yaWdpbmFsRWxlbWVudDogdGhpcy5lbGVtZW50LAoJCQlfcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50czogW10sCgkJCV9oZWxwZXI6IG8uaGVscGVyIHx8IG8uZ2hvc3QgfHwgby5hbmltYXRlID8gby5oZWxwZXIgfHwgInVpLXJlc2l6YWJsZS1oZWxwZXIiIDogbnVsbAoJCX0pOwoKCQkvL1dyYXAgdGhlIGVsZW1lbnQgaWYgaXQgY2Fubm90IGhvbGQgY2hpbGQgbm9kZXMKCQlpZih0aGlzLmVsZW1lbnRbMF0ubm9kZU5hbWUubWF0Y2goL2NhbnZhc3x0ZXh0YXJlYXxpbnB1dHxzZWxlY3R8YnV0dG9ufGltZy9pKSkgewoKCQkJLy9DcmVhdGUgYSB3cmFwcGVyIGVsZW1lbnQgYW5kIHNldCB0aGUgd3JhcHBlciB0byB0aGUgbmV3IGN1cnJlbnQgaW50ZXJuYWwgZWxlbWVudAoJCQl0aGlzLmVsZW1lbnQud3JhcCgKCQkJCSQoIjxkaXYgY2xhc3M9J3VpLXdyYXBwZXInIHN0eWxlPSdvdmVyZmxvdzogaGlkZGVuOyc+PC9kaXY+IikuY3NzKHsKCQkJCQlwb3NpdGlvbjogdGhpcy5lbGVtZW50LmNzcygicG9zaXRpb24iKSwKCQkJCQl3aWR0aDogdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKSwKCQkJCQloZWlnaHQ6IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpLAoJCQkJCXRvcDogdGhpcy5lbGVtZW50LmNzcygidG9wIiksCgkJCQkJbGVmdDogdGhpcy5lbGVtZW50LmNzcygibGVmdCIpCgkJCQl9KQoJCQkpOwoKCQkJLy9PdmVyd3JpdGUgdGhlIG9yaWdpbmFsIHRoaXMuZWxlbWVudAoJCQl0aGlzLmVsZW1lbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCkuZGF0YSgKCQkJCSJ1aS1yZXNpemFibGUiLCB0aGlzLmVsZW1lbnQuZGF0YSgidWktcmVzaXphYmxlIikKCQkJKTsKCgkJCXRoaXMuZWxlbWVudElzV3JhcHBlciA9IHRydWU7CgoJCQkvL01vdmUgbWFyZ2lucyB0byB0aGUgd3JhcHBlcgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsgbWFyZ2luTGVmdDogdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCJtYXJnaW5MZWZ0IiksIG1hcmdpblRvcDogdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCJtYXJnaW5Ub3AiKSwgbWFyZ2luUmlnaHQ6IHRoaXMub3JpZ2luYWxFbGVtZW50LmNzcygibWFyZ2luUmlnaHQiKSwgbWFyZ2luQm90dG9tOiB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoIm1hcmdpbkJvdHRvbSIpIH0pOwoJCQl0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoeyBtYXJnaW5MZWZ0OiAwLCBtYXJnaW5Ub3A6IDAsIG1hcmdpblJpZ2h0OiAwLCBtYXJnaW5Cb3R0b206IDB9KTsKCgkJCS8vUHJldmVudCBTYWZhcmkgdGV4dGFyZWEgcmVzaXplCgkJCXRoaXMub3JpZ2luYWxSZXNpemVTdHlsZSA9IHRoaXMub3JpZ2luYWxFbGVtZW50LmNzcygicmVzaXplIik7CgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcygicmVzaXplIiwgIm5vbmUiKTsKCgkJCS8vUHVzaCB0aGUgYWN0dWFsIGVsZW1lbnQgdG8gb3VyIHByb3BvcnRpb25hbGx5UmVzaXplIGludGVybmFsIGFycmF5CgkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMucHVzaCh0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoeyBwb3NpdGlvbjogInN0YXRpYyIsIHpvb206IDEsIGRpc3BsYXk6ICJibG9jayIgfSkpOwoKCQkJLy8gYXZvaWQgSUUganVtcCAoaGFyZCBzZXQgdGhlIG1hcmdpbikKCQkJdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKHsgbWFyZ2luOiB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoIm1hcmdpbiIpIH0pOwoKCQkJLy8gZml4IGhhbmRsZXJzIG9mZnNldAoJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOwoKCQl9CgoJCXRoaXMuaGFuZGxlcyA9IG8uaGFuZGxlcyB8fCAoISQoIi51aS1yZXNpemFibGUtaGFuZGxlIiwgdGhpcy5lbGVtZW50KS5sZW5ndGggPyAiZSxzLHNlIiA6IHsgbjogIi51aS1yZXNpemFibGUtbiIsIGU6ICIudWktcmVzaXphYmxlLWUiLCBzOiAiLnVpLXJlc2l6YWJsZS1zIiwgdzogIi51aS1yZXNpemFibGUtdyIsIHNlOiAiLnVpLXJlc2l6YWJsZS1zZSIsIHN3OiAiLnVpLXJlc2l6YWJsZS1zdyIsIG5lOiAiLnVpLXJlc2l6YWJsZS1uZSIsIG53OiAiLnVpLXJlc2l6YWJsZS1udyIgfSk7CgkJaWYodGhpcy5oYW5kbGVzLmNvbnN0cnVjdG9yID09PSBTdHJpbmcpIHsKCgkJCWlmICggdGhpcy5oYW5kbGVzID09PSAiYWxsIikgewoJCQkJdGhpcy5oYW5kbGVzID0gIm4sZSxzLHcsc2Usc3csbmUsbnciOwoJCQl9CgoJCQluID0gdGhpcy5oYW5kbGVzLnNwbGl0KCIsIik7CgkJCXRoaXMuaGFuZGxlcyA9IHt9OwoKCQkJZm9yKGkgPSAwOyBpIDwgbi5sZW5ndGg7IGkrKykgewoKCQkJCWhhbmRsZSA9ICQudHJpbShuW2ldKTsKCQkJCWhuYW1lID0gInVpLXJlc2l6YWJsZS0iK2hhbmRsZTsKCQkJCWF4aXMgPSAkKCI8ZGl2IGNsYXNzPSd1aS1yZXNpemFibGUtaGFuZGxlICIgKyBobmFtZSArICInPjwvZGl2PiIpOwoKCQkJCS8vIEFwcGx5IHpJbmRleCB0byBhbGwgaGFuZGxlcyAtIHNlZSAjNzk2MAoJCQkJYXhpcy5jc3MoeyB6SW5kZXg6IG8uekluZGV4IH0pOwoKCQkJCS8vVE9ETyA6IFdoYXQncyBnb2luZyBvbiBoZXJlPwoJCQkJaWYgKCJzZSIgPT09IGhhbmRsZSkgewoJCQkJCWF4aXMuYWRkQ2xhc3MoInVpLWljb24gdWktaWNvbi1ncmlwc21hbGwtZGlhZ29uYWwtc2UiKTsKCQkJCX0KCgkJCQkvL0luc2VydCBpbnRvIGludGVybmFsIGhhbmRsZXMgb2JqZWN0IGFuZCBhcHBlbmQgdG8gZWxlbWVudAoJCQkJdGhpcy5oYW5kbGVzW2hhbmRsZV0gPSAiLnVpLXJlc2l6YWJsZS0iK2hhbmRsZTsKCQkJCXRoaXMuZWxlbWVudC5hcHBlbmQoYXhpcyk7CgkJCX0KCgkJfQoKCQl0aGlzLl9yZW5kZXJBeGlzID0gZnVuY3Rpb24odGFyZ2V0KSB7CgoJCQl2YXIgaSwgYXhpcywgcGFkUG9zLCBwYWRXcmFwcGVyOwoKCQkJdGFyZ2V0ID0gdGFyZ2V0IHx8IHRoaXMuZWxlbWVudDsKCgkJCWZvcihpIGluIHRoaXMuaGFuZGxlcykgewoKCQkJCWlmKHRoaXMuaGFuZGxlc1tpXS5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7CgkJCQkJdGhpcy5oYW5kbGVzW2ldID0gJCh0aGlzLmhhbmRsZXNbaV0sIHRoaXMuZWxlbWVudCkuc2hvdygpOwoJCQkJfQoKCQkJCS8vQXBwbHkgcGFkIHRvIHdyYXBwZXIgZWxlbWVudCwgbmVlZGVkIHRvIGZpeCBheGlzIHBvc2l0aW9uICh0ZXh0YXJlYSwgaW5wdXRzLCBzY3JvbGxzKQoJCQkJaWYgKHRoaXMuZWxlbWVudElzV3JhcHBlciAmJiB0aGlzLm9yaWdpbmFsRWxlbWVudFswXS5ub2RlTmFtZS5tYXRjaCgvdGV4dGFyZWF8aW5wdXR8c2VsZWN0fGJ1dHRvbi9pKSkgewoKCQkJCQlheGlzID0gJCh0aGlzLmhhbmRsZXNbaV0sIHRoaXMuZWxlbWVudCk7CgoJCQkJCS8vQ2hlY2tpbmcgdGhlIGNvcnJlY3QgcGFkIGFuZCBib3JkZXIKCQkJCQlwYWRXcmFwcGVyID0gL3N3fG5lfG53fHNlfG58cy8udGVzdChpKSA\/IGF4aXMub3V0ZXJIZWlnaHQoKSA6IGF4aXMub3V0ZXJXaWR0aCgpOwoKCQkJCQkvL1RoZSBwYWRkaW5nIHR5cGUgaSBoYXZlIHRvIGFwcGx5Li4uCgkJCQkJcGFkUG9zID0gWyAicGFkZGluZyIsCgkJCQkJCS9uZXxud3xuLy50ZXN0KGkpID8gIlRvcCIgOgoJCQkJCQkvc2V8c3d8cy8udGVzdChpKSA\/ICJCb3R0b20iIDoKCQkJCQkJL15lJC8udGVzdChpKSA\/ICJSaWdodCIgOiAiTGVmdCIgXS5qb2luKCIiKTsKCgkJCQkJdGFyZ2V0LmNzcyhwYWRQb3MsIHBhZFdyYXBwZXIpOwoKCQkJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOwoKCQkJCX0KCgkJCQkvL1RPRE86IFdoYXQncyB0aGF0IGdvb2QgZm9yPyBUaGVyZSdzIG5vdCBhbnl0aGluZyB0byBiZSBleGVjdXRlZCBsZWZ0CgkJCQlpZighJCh0aGlzLmhhbmRsZXNbaV0pLmxlbmd0aCkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQl9CgkJfTsKCgkJLy9UT0RPOiBtYWtlIHJlbmRlckF4aXMgYSBwcm90b3R5cGUgZnVuY3Rpb24KCQl0aGlzLl9yZW5kZXJBeGlzKHRoaXMuZWxlbWVudCk7CgoJCXRoaXMuX2hhbmRsZXMgPSAkKCIudWktcmVzaXphYmxlLWhhbmRsZSIsIHRoaXMuZWxlbWVudCkKCQkJLmRpc2FibGVTZWxlY3Rpb24oKTsKCgkJLy9NYXRjaGluZyBheGlzIG5hbWUKCQl0aGlzLl9oYW5kbGVzLm1vdXNlb3ZlcihmdW5jdGlvbigpIHsKCQkJaWYgKCF0aGF0LnJlc2l6aW5nKSB7CgkJCQlpZiAodGhpcy5jbGFzc05hbWUpIHsKCQkJCQlheGlzID0gdGhpcy5jbGFzc05hbWUubWF0Y2goL3VpLXJlc2l6YWJsZS0oc2V8c3d8bmV8bnd8bnxlfHN8dykvaSk7CgkJCQl9CgkJCQkvL0F4aXMsIGRlZmF1bHQgPSBzZQoJCQkJdGhhdC5heGlzID0gYXhpcyAmJiBheGlzWzFdID8gYXhpc1sxXSA6ICJzZSI7CgkJCX0KCQl9KTsKCgkJLy9JZiB3ZSB3YW50IHRvIGF1dG8gaGlkZSB0aGUgZWxlbWVudHMKCQlpZiAoby5hdXRvSGlkZSkgewoJCQl0aGlzLl9oYW5kbGVzLmhpZGUoKTsKCQkJJCh0aGlzLmVsZW1lbnQpCgkJCQkuYWRkQ2xhc3MoInVpLXJlc2l6YWJsZS1hdXRvaGlkZSIpCgkJCQkubW91c2VlbnRlcihmdW5jdGlvbigpIHsKCQkJCQlpZiAoby5kaXNhYmxlZCkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCSQodGhpcykucmVtb3ZlQ2xhc3MoInVpLXJlc2l6YWJsZS1hdXRvaGlkZSIpOwoJCQkJCXRoYXQuX2hhbmRsZXMuc2hvdygpOwoJCQkJfSkKCQkJCS5tb3VzZWxlYXZlKGZ1bmN0aW9uKCl7CgkJCQkJaWYgKG8uZGlzYWJsZWQpIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQlpZiAoIXRoYXQucmVzaXppbmcpIHsKCQkJCQkJJCh0aGlzKS5hZGRDbGFzcygidWktcmVzaXphYmxlLWF1dG9oaWRlIik7CgkJCQkJCXRoYXQuX2hhbmRsZXMuaGlkZSgpOwoJCQkJCX0KCQkJCX0pOwoJCX0KCgkJLy9Jbml0aWFsaXplIHRoZSBtb3VzZSBpbnRlcmFjdGlvbgoJCXRoaXMuX21vdXNlSW5pdCgpOwoKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoKCQl0aGlzLl9tb3VzZURlc3Ryb3koKTsKCgkJdmFyIHdyYXBwZXIsCgkJCV9kZXN0cm95ID0gZnVuY3Rpb24oZXhwKSB7CgkJCQkkKGV4cCkucmVtb3ZlQ2xhc3MoInVpLXJlc2l6YWJsZSB1aS1yZXNpemFibGUtZGlzYWJsZWQgdWktcmVzaXphYmxlLXJlc2l6aW5nIikKCQkJCQkucmVtb3ZlRGF0YSgicmVzaXphYmxlIikucmVtb3ZlRGF0YSgidWktcmVzaXphYmxlIikudW5iaW5kKCIucmVzaXphYmxlIikuZmluZCgiLnVpLXJlc2l6YWJsZS1oYW5kbGUiKS5yZW1vdmUoKTsKCQkJfTsKCgkJLy9UT0RPOiBVbndyYXAgYXQgc2FtZSBET00gcG9zaXRpb24KCQlpZiAodGhpcy5lbGVtZW50SXNXcmFwcGVyKSB7CgkJCV9kZXN0cm95KHRoaXMuZWxlbWVudCk7CgkJCXdyYXBwZXIgPSB0aGlzLmVsZW1lbnQ7CgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyh7CgkJCQlwb3NpdGlvbjogd3JhcHBlci5jc3MoInBvc2l0aW9uIiksCgkJCQl3aWR0aDogd3JhcHBlci5vdXRlcldpZHRoKCksCgkJCQloZWlnaHQ6IHdyYXBwZXIub3V0ZXJIZWlnaHQoKSwKCQkJCXRvcDogd3JhcHBlci5jc3MoInRvcCIpLAoJCQkJbGVmdDogd3JhcHBlci5jc3MoImxlZnQiKQoJCQl9KS5pbnNlcnRBZnRlciggd3JhcHBlciApOwoJCQl3cmFwcGVyLnJlbW92ZSgpOwoJCX0KCgkJdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCJyZXNpemUiLCB0aGlzLm9yaWdpbmFsUmVzaXplU3R5bGUpOwoJCV9kZXN0cm95KHRoaXMub3JpZ2luYWxFbGVtZW50KTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJdmFyIGksIGhhbmRsZSwKCQkJY2FwdHVyZSA9IGZhbHNlOwoKCQlmb3IgKGkgaW4gdGhpcy5oYW5kbGVzKSB7CgkJCWhhbmRsZSA9ICQodGhpcy5oYW5kbGVzW2ldKVswXTsKCQkJaWYgKGhhbmRsZSA9PT0gZXZlbnQudGFyZ2V0IHx8ICQuY29udGFpbnMoaGFuZGxlLCBldmVudC50YXJnZXQpKSB7CgkJCQljYXB0dXJlID0gdHJ1ZTsKCQkJfQoJCX0KCgkJcmV0dXJuICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgJiYgY2FwdHVyZTsKCX0sCgoJX21vdXNlU3RhcnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgoJCXZhciBjdXJsZWZ0LCBjdXJ0b3AsIGN1cnNvciwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5pUG9zID0gdGhpcy5lbGVtZW50LnBvc2l0aW9uKCksCgkJCWVsID0gdGhpcy5lbGVtZW50OwoKCQl0aGlzLnJlc2l6aW5nID0gdHJ1ZTsKCgkJLy8gYnVnZml4IGZvciBodHRwOi8vZGV2LmpxdWVyeS5jb20vdGlja2V0LzE3NDkKCQlpZiAoICgvYWJzb2x1dGUvKS50ZXN0KCBlbC5jc3MoInBvc2l0aW9uIikgKSApIHsKCQkJZWwuY3NzKHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHRvcDogZWwuY3NzKCJ0b3AiKSwgbGVmdDogZWwuY3NzKCJsZWZ0IikgfSk7CgkJfSBlbHNlIGlmIChlbC5pcygiLnVpLWRyYWdnYWJsZSIpKSB7CgkJCWVsLmNzcyh7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB0b3A6IGluaVBvcy50b3AsIGxlZnQ6IGluaVBvcy5sZWZ0IH0pOwoJCX0KCgkJdGhpcy5fcmVuZGVyUHJveHkoKTsKCgkJY3VybGVmdCA9IG51bSh0aGlzLmhlbHBlci5jc3MoImxlZnQiKSk7CgkJY3VydG9wID0gbnVtKHRoaXMuaGVscGVyLmNzcygidG9wIikpOwoKCQlpZiAoby5jb250YWlubWVudCkgewoJCQljdXJsZWZ0ICs9ICQoby5jb250YWlubWVudCkuc2Nyb2xsTGVmdCgpIHx8IDA7CgkJCWN1cnRvcCArPSAkKG8uY29udGFpbm1lbnQpLnNjcm9sbFRvcCgpIHx8IDA7CgkJfQoKCQkvL1N0b3JlIG5lZWRlZCB2YXJpYWJsZXMKCQl0aGlzLm9mZnNldCA9IHRoaXMuaGVscGVyLm9mZnNldCgpOwoJCXRoaXMucG9zaXRpb24gPSB7IGxlZnQ6IGN1cmxlZnQsIHRvcDogY3VydG9wIH07CgkJdGhpcy5zaXplID0gdGhpcy5faGVscGVyID8geyB3aWR0aDogZWwub3V0ZXJXaWR0aCgpLCBoZWlnaHQ6IGVsLm91dGVySGVpZ2h0KCkgfSA6IHsgd2lkdGg6IGVsLndpZHRoKCksIGhlaWdodDogZWwuaGVpZ2h0KCkgfTsKCQl0aGlzLm9yaWdpbmFsU2l6ZSA9IHRoaXMuX2hlbHBlciA\/IHsgd2lkdGg6IGVsLm91dGVyV2lkdGgoKSwgaGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpIH0gOiB7IHdpZHRoOiBlbC53aWR0aCgpLCBoZWlnaHQ6IGVsLmhlaWdodCgpIH07CgkJdGhpcy5vcmlnaW5hbFBvc2l0aW9uID0geyBsZWZ0OiBjdXJsZWZ0LCB0b3A6IGN1cnRvcCB9OwoJCXRoaXMuc2l6ZURpZmYgPSB7IHdpZHRoOiBlbC5vdXRlcldpZHRoKCkgLSBlbC53aWR0aCgpLCBoZWlnaHQ6IGVsLm91dGVySGVpZ2h0KCkgLSBlbC5oZWlnaHQoKSB9OwoJCXRoaXMub3JpZ2luYWxNb3VzZVBvc2l0aW9uID0geyBsZWZ0OiBldmVudC5wYWdlWCwgdG9wOiBldmVudC5wYWdlWSB9OwoKCQkvL0FzcGVjdCBSYXRpbwoJCXRoaXMuYXNwZWN0UmF0aW8gPSAodHlwZW9mIG8uYXNwZWN0UmF0aW8gPT09ICJudW1iZXIiKSA\/IG8uYXNwZWN0UmF0aW8gOiAoKHRoaXMub3JpZ2luYWxTaXplLndpZHRoIC8gdGhpcy5vcmlnaW5hbFNpemUuaGVpZ2h0KSB8fCAxKTsKCgkJY3Vyc29yID0gJCgiLnVpLXJlc2l6YWJsZS0iICsgdGhpcy5heGlzKS5jc3MoImN1cnNvciIpOwoJCSQoImJvZHkiKS5jc3MoImN1cnNvciIsIGN1cnNvciA9PT0gImF1dG8iID8gdGhpcy5heGlzICsgIi1yZXNpemUiIDogY3Vyc29yKTsKCgkJZWwuYWRkQ2xhc3MoInVpLXJlc2l6YWJsZS1yZXNpemluZyIpOwoJCXRoaXMuX3Byb3BhZ2F0ZSgic3RhcnQiLCBldmVudCk7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZURyYWc6IGZ1bmN0aW9uKGV2ZW50KSB7CgoJCS8vSW5jcmVhc2UgcGVyZm9ybWFuY2UsIGF2b2lkIHJlZ2V4CgkJdmFyIGRhdGEsCgkJCWVsID0gdGhpcy5oZWxwZXIsIHByb3BzID0ge30sCgkJCXNtcCA9IHRoaXMub3JpZ2luYWxNb3VzZVBvc2l0aW9uLAoJCQlhID0gdGhpcy5heGlzLAoJCQlwcmV2VG9wID0gdGhpcy5wb3NpdGlvbi50b3AsCgkJCXByZXZMZWZ0ID0gdGhpcy5wb3NpdGlvbi5sZWZ0LAoJCQlwcmV2V2lkdGggPSB0aGlzLnNpemUud2lkdGgsCgkJCXByZXZIZWlnaHQgPSB0aGlzLnNpemUuaGVpZ2h0LAoJCQlkeCA9IChldmVudC5wYWdlWC1zbXAubGVmdCl8fDAsCgkJCWR5ID0gKGV2ZW50LnBhZ2VZLXNtcC50b3ApfHwwLAoJCQl0cmlnZ2VyID0gdGhpcy5fY2hhbmdlW2FdOwoKCQlpZiAoIXRyaWdnZXIpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gQ2FsY3VsYXRlIHRoZSBhdHRycyB0aGF0IHdpbGwgYmUgY2hhbmdlCgkJZGF0YSA9IHRyaWdnZXIuYXBwbHkodGhpcywgW2V2ZW50LCBkeCwgZHldKTsKCgkJLy8gUHV0IHRoaXMgaW4gdGhlIG1vdXNlRHJhZyBoYW5kbGVyIHNpbmNlIHRoZSB1c2VyIGNhbiBzdGFydCBwcmVzc2luZyBzaGlmdCB3aGlsZSByZXNpemluZwoJCXRoaXMuX3VwZGF0ZVZpcnR1YWxCb3VuZGFyaWVzKGV2ZW50LnNoaWZ0S2V5KTsKCQlpZiAodGhpcy5fYXNwZWN0UmF0aW8gfHwgZXZlbnQuc2hpZnRLZXkpIHsKCQkJZGF0YSA9IHRoaXMuX3VwZGF0ZVJhdGlvKGRhdGEsIGV2ZW50KTsKCQl9CgoJCWRhdGEgPSB0aGlzLl9yZXNwZWN0U2l6ZShkYXRhLCBldmVudCk7CgoJCXRoaXMuX3VwZGF0ZUNhY2hlKGRhdGEpOwoKCQkvLyBwbHVnaW5zIGNhbGxiYWNrcyBuZWVkIHRvIGJlIGNhbGxlZCBmaXJzdAoJCXRoaXMuX3Byb3BhZ2F0ZSgicmVzaXplIiwgZXZlbnQpOwoKCQlpZiAodGhpcy5wb3NpdGlvbi50b3AgIT09IHByZXZUb3ApIHsKCQkJcHJvcHMudG9wID0gdGhpcy5wb3NpdGlvbi50b3AgKyAicHgiOwoJCX0KCQlpZiAodGhpcy5wb3NpdGlvbi5sZWZ0ICE9PSBwcmV2TGVmdCkgewoJCQlwcm9wcy5sZWZ0ID0gdGhpcy5wb3NpdGlvbi5sZWZ0ICsgInB4IjsKCQl9CgkJaWYgKHRoaXMuc2l6ZS53aWR0aCAhPT0gcHJldldpZHRoKSB7CgkJCXByb3BzLndpZHRoID0gdGhpcy5zaXplLndpZHRoICsgInB4IjsKCQl9CgkJaWYgKHRoaXMuc2l6ZS5oZWlnaHQgIT09IHByZXZIZWlnaHQpIHsKCQkJcHJvcHMuaGVpZ2h0ID0gdGhpcy5zaXplLmhlaWdodCArICJweCI7CgkJfQoJCWVsLmNzcyhwcm9wcyk7CgoJCWlmICghdGhpcy5faGVscGVyICYmIHRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMubGVuZ3RoKSB7CgkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplKCk7CgkJfQoKCQkvLyBDYWxsIHRoZSB1c2VyIGNhbGxiYWNrIGlmIHRoZSBlbGVtZW50IHdhcyByZXNpemVkCgkJaWYgKCAhICQuaXNFbXB0eU9iamVjdChwcm9wcykgKSB7CgkJCXRoaXMuX3RyaWdnZXIoInJlc2l6ZSIsIGV2ZW50LCB0aGlzLnVpKCkpOwoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfbW91c2VTdG9wOiBmdW5jdGlvbihldmVudCkgewoKCQl0aGlzLnJlc2l6aW5nID0gZmFsc2U7CgkJdmFyIHByLCBpc3RhLCBzb2Zmc2V0aCwgc29mZnNldHcsIHMsIGxlZnQsIHRvcCwKCQkJbyA9IHRoaXMub3B0aW9ucywgdGhhdCA9IHRoaXM7CgoJCWlmKHRoaXMuX2hlbHBlcikgewoKCQkJcHIgPSB0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZUVsZW1lbnRzOwoJCQlpc3RhID0gcHIubGVuZ3RoICYmICgvdGV4dGFyZWEvaSkudGVzdChwclswXS5ub2RlTmFtZSk7CgkJCXNvZmZzZXRoID0gaXN0YSAmJiAkLnVpLmhhc1Njcm9sbChwclswXSwgImxlZnQiKSAvKiBUT0RPIC0ganVtcCBoZWlnaHQgKi8gPyAwIDogdGhhdC5zaXplRGlmZi5oZWlnaHQ7CgkJCXNvZmZzZXR3ID0gaXN0YSA\/IDAgOiB0aGF0LnNpemVEaWZmLndpZHRoOwoKCQkJcyA9IHsgd2lkdGg6ICh0aGF0LmhlbHBlci53aWR0aCgpICAtIHNvZmZzZXR3KSwgaGVpZ2h0OiAodGhhdC5oZWxwZXIuaGVpZ2h0KCkgLSBzb2Zmc2V0aCkgfTsKCQkJbGVmdCA9IChwYXJzZUludCh0aGF0LmVsZW1lbnQuY3NzKCJsZWZ0IiksIDEwKSArICh0aGF0LnBvc2l0aW9uLmxlZnQgLSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24ubGVmdCkpIHx8IG51bGw7CgkJCXRvcCA9IChwYXJzZUludCh0aGF0LmVsZW1lbnQuY3NzKCJ0b3AiKSwgMTApICsgKHRoYXQucG9zaXRpb24udG9wIC0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLnRvcCkpIHx8IG51bGw7CgoJCQlpZiAoIW8uYW5pbWF0ZSkgewoJCQkJdGhpcy5lbGVtZW50LmNzcygkLmV4dGVuZChzLCB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH0pKTsKCQkJfQoKCQkJdGhhdC5oZWxwZXIuaGVpZ2h0KHRoYXQuc2l6ZS5oZWlnaHQpOwoJCQl0aGF0LmhlbHBlci53aWR0aCh0aGF0LnNpemUud2lkdGgpOwoKCQkJaWYgKHRoaXMuX2hlbHBlciAmJiAhby5hbmltYXRlKSB7CgkJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOwoJCQl9CgkJfQoKCQkkKCJib2R5IikuY3NzKCJjdXJzb3IiLCAiYXV0byIpOwoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoInVpLXJlc2l6YWJsZS1yZXNpemluZyIpOwoKCQl0aGlzLl9wcm9wYWdhdGUoInN0b3AiLCBldmVudCk7CgoJCWlmICh0aGlzLl9oZWxwZXIpIHsKCQkJdGhpcy5oZWxwZXIucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfSwKCglfdXBkYXRlVmlydHVhbEJvdW5kYXJpZXM6IGZ1bmN0aW9uKGZvcmNlQXNwZWN0UmF0aW8pIHsKCQl2YXIgcE1pbldpZHRoLCBwTWF4V2lkdGgsIHBNaW5IZWlnaHQsIHBNYXhIZWlnaHQsIGIsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCWIgPSB7CgkJCW1pbldpZHRoOiBpc051bWJlcihvLm1pbldpZHRoKSA\/IG8ubWluV2lkdGggOiAwLAoJCQltYXhXaWR0aDogaXNOdW1iZXIoby5tYXhXaWR0aCkgPyBvLm1heFdpZHRoIDogSW5maW5pdHksCgkJCW1pbkhlaWdodDogaXNOdW1iZXIoby5taW5IZWlnaHQpID8gby5taW5IZWlnaHQgOiAwLAoJCQltYXhIZWlnaHQ6IGlzTnVtYmVyKG8ubWF4SGVpZ2h0KSA\/IG8ubWF4SGVpZ2h0IDogSW5maW5pdHkKCQl9OwoKCQlpZih0aGlzLl9hc3BlY3RSYXRpbyB8fCBmb3JjZUFzcGVjdFJhdGlvKSB7CgkJCS8vIFdlIHdhbnQgdG8gY3JlYXRlIGFuIGVuY2xvc2luZyBib3ggd2hvc2UgYXNwZWN0IHJhdGlvbiBpcyB0aGUgcmVxdWVzdGVkIG9uZQoJCQkvLyBGaXJzdCwgY29tcHV0ZSB0aGUgInByb2plY3RlZCIgc2l6ZSBmb3IgZWFjaCBkaW1lbnNpb24gYmFzZWQgb24gdGhlIGFzcGVjdCByYXRpbyBhbmQgb3RoZXIgZGltZW5zaW9uCgkJCXBNaW5XaWR0aCA9IGIubWluSGVpZ2h0ICogdGhpcy5hc3BlY3RSYXRpbzsKCQkJcE1pbkhlaWdodCA9IGIubWluV2lkdGggLyB0aGlzLmFzcGVjdFJhdGlvOwoJCQlwTWF4V2lkdGggPSBiLm1heEhlaWdodCAqIHRoaXMuYXNwZWN0UmF0aW87CgkJCXBNYXhIZWlnaHQgPSBiLm1heFdpZHRoIC8gdGhpcy5hc3BlY3RSYXRpbzsKCgkJCWlmKHBNaW5XaWR0aCA+IGIubWluV2lkdGgpIHsKCQkJCWIubWluV2lkdGggPSBwTWluV2lkdGg7CgkJCX0KCQkJaWYocE1pbkhlaWdodCA+IGIubWluSGVpZ2h0KSB7CgkJCQliLm1pbkhlaWdodCA9IHBNaW5IZWlnaHQ7CgkJCX0KCQkJaWYocE1heFdpZHRoIDwgYi5tYXhXaWR0aCkgewoJCQkJYi5tYXhXaWR0aCA9IHBNYXhXaWR0aDsKCQkJfQoJCQlpZihwTWF4SGVpZ2h0IDwgYi5tYXhIZWlnaHQpIHsKCQkJCWIubWF4SGVpZ2h0ID0gcE1heEhlaWdodDsKCQkJfQoJCX0KCQl0aGlzLl92Qm91bmRhcmllcyA9IGI7Cgl9LAoKCV91cGRhdGVDYWNoZTogZnVuY3Rpb24oZGF0YSkgewoJCXRoaXMub2Zmc2V0ID0gdGhpcy5oZWxwZXIub2Zmc2V0KCk7CgkJaWYgKGlzTnVtYmVyKGRhdGEubGVmdCkpIHsKCQkJdGhpcy5wb3NpdGlvbi5sZWZ0ID0gZGF0YS5sZWZ0OwoJCX0KCQlpZiAoaXNOdW1iZXIoZGF0YS50b3ApKSB7CgkJCXRoaXMucG9zaXRpb24udG9wID0gZGF0YS50b3A7CgkJfQoJCWlmIChpc051bWJlcihkYXRhLmhlaWdodCkpIHsKCQkJdGhpcy5zaXplLmhlaWdodCA9IGRhdGEuaGVpZ2h0OwoJCX0KCQlpZiAoaXNOdW1iZXIoZGF0YS53aWR0aCkpIHsKCQkJdGhpcy5zaXplLndpZHRoID0gZGF0YS53aWR0aDsKCQl9Cgl9LAoKCV91cGRhdGVSYXRpbzogZnVuY3Rpb24oIGRhdGEgKSB7CgoJCXZhciBjcG9zID0gdGhpcy5wb3NpdGlvbiwKCQkJY3NpemUgPSB0aGlzLnNpemUsCgkJCWEgPSB0aGlzLmF4aXM7CgoJCWlmIChpc051bWJlcihkYXRhLmhlaWdodCkpIHsKCQkJZGF0YS53aWR0aCA9IChkYXRhLmhlaWdodCAqIHRoaXMuYXNwZWN0UmF0aW8pOwoJCX0gZWxzZSBpZiAoaXNOdW1iZXIoZGF0YS53aWR0aCkpIHsKCQkJZGF0YS5oZWlnaHQgPSAoZGF0YS53aWR0aCAvIHRoaXMuYXNwZWN0UmF0aW8pOwoJCX0KCgkJaWYgKGEgPT09ICJzdyIpIHsKCQkJZGF0YS5sZWZ0ID0gY3Bvcy5sZWZ0ICsgKGNzaXplLndpZHRoIC0gZGF0YS53aWR0aCk7CgkJCWRhdGEudG9wID0gbnVsbDsKCQl9CgkJaWYgKGEgPT09ICJudyIpIHsKCQkJZGF0YS50b3AgPSBjcG9zLnRvcCArIChjc2l6ZS5oZWlnaHQgLSBkYXRhLmhlaWdodCk7CgkJCWRhdGEubGVmdCA9IGNwb3MubGVmdCArIChjc2l6ZS53aWR0aCAtIGRhdGEud2lkdGgpOwoJCX0KCgkJcmV0dXJuIGRhdGE7Cgl9LAoKCV9yZXNwZWN0U2l6ZTogZnVuY3Rpb24oIGRhdGEgKSB7CgoJCXZhciBvID0gdGhpcy5fdkJvdW5kYXJpZXMsCgkJCWEgPSB0aGlzLmF4aXMsCgkJCWlzbWF4dyA9IGlzTnVtYmVyKGRhdGEud2lkdGgpICYmIG8ubWF4V2lkdGggJiYgKG8ubWF4V2lkdGggPCBkYXRhLndpZHRoKSwgaXNtYXhoID0gaXNOdW1iZXIoZGF0YS5oZWlnaHQpICYmIG8ubWF4SGVpZ2h0ICYmIChvLm1heEhlaWdodCA8IGRhdGEuaGVpZ2h0KSwKCQkJaXNtaW53ID0gaXNOdW1iZXIoZGF0YS53aWR0aCkgJiYgby5taW5XaWR0aCAmJiAoby5taW5XaWR0aCA+IGRhdGEud2lkdGgpLCBpc21pbmggPSBpc051bWJlcihkYXRhLmhlaWdodCkgJiYgby5taW5IZWlnaHQgJiYgKG8ubWluSGVpZ2h0ID4gZGF0YS5oZWlnaHQpLAoJCQlkdyA9IHRoaXMub3JpZ2luYWxQb3NpdGlvbi5sZWZ0ICsgdGhpcy5vcmlnaW5hbFNpemUud2lkdGgsCgkJCWRoID0gdGhpcy5wb3NpdGlvbi50b3AgKyB0aGlzLnNpemUuaGVpZ2h0LAoJCQljdyA9IC9zd3xud3x3Ly50ZXN0KGEpLCBjaCA9IC9ud3xuZXxuLy50ZXN0KGEpOwoJCWlmIChpc21pbncpIHsKCQkJZGF0YS53aWR0aCA9IG8ubWluV2lkdGg7CgkJfQoJCWlmIChpc21pbmgpIHsKCQkJZGF0YS5oZWlnaHQgPSBvLm1pbkhlaWdodDsKCQl9CgkJaWYgKGlzbWF4dykgewoJCQlkYXRhLndpZHRoID0gby5tYXhXaWR0aDsKCQl9CgkJaWYgKGlzbWF4aCkgewoJCQlkYXRhLmhlaWdodCA9IG8ubWF4SGVpZ2h0OwoJCX0KCgkJaWYgKGlzbWludyAmJiBjdykgewoJCQlkYXRhLmxlZnQgPSBkdyAtIG8ubWluV2lkdGg7CgkJfQoJCWlmIChpc21heHcgJiYgY3cpIHsKCQkJZGF0YS5sZWZ0ID0gZHcgLSBvLm1heFdpZHRoOwoJCX0KCQlpZiAoaXNtaW5oICYmIGNoKSB7CgkJCWRhdGEudG9wID0gZGggLSBvLm1pbkhlaWdodDsKCQl9CgkJaWYgKGlzbWF4aCAmJiBjaCkgewoJCQlkYXRhLnRvcCA9IGRoIC0gby5tYXhIZWlnaHQ7CgkJfQoKCQkvLyBmaXhpbmcganVtcCBlcnJvciBvbiB0b3AvbGVmdCAtIGJ1ZyAjMjMzMAoJCWlmICghZGF0YS53aWR0aCAmJiAhZGF0YS5oZWlnaHQgJiYgIWRhdGEubGVmdCAmJiBkYXRhLnRvcCkgewoJCQlkYXRhLnRvcCA9IG51bGw7CgkJfSBlbHNlIGlmICghZGF0YS53aWR0aCAmJiAhZGF0YS5oZWlnaHQgJiYgIWRhdGEudG9wICYmIGRhdGEubGVmdCkgewoJCQlkYXRhLmxlZnQgPSBudWxsOwoJCX0KCgkJcmV0dXJuIGRhdGE7Cgl9LAoKCV9wcm9wb3J0aW9uYWxseVJlc2l6ZTogZnVuY3Rpb24oKSB7CgoJCWlmICghdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50cy5sZW5ndGgpIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGksIGosIGJvcmRlcnMsIHBhZGRpbmdzLCBwcmVsLAoJCQllbGVtZW50ID0gdGhpcy5oZWxwZXIgfHwgdGhpcy5lbGVtZW50OwoKCQlmb3IgKCBpPTA7IGkgPCB0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZUVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CgoJCQlwcmVsID0gdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50c1tpXTsKCgkJCWlmICghdGhpcy5ib3JkZXJEaWYpIHsKCQkJCXRoaXMuYm9yZGVyRGlmID0gW107CgkJCQlib3JkZXJzID0gW3ByZWwuY3NzKCJib3JkZXJUb3BXaWR0aCIpLCBwcmVsLmNzcygiYm9yZGVyUmlnaHRXaWR0aCIpLCBwcmVsLmNzcygiYm9yZGVyQm90dG9tV2lkdGgiKSwgcHJlbC5jc3MoImJvcmRlckxlZnRXaWR0aCIpXTsKCQkJCXBhZGRpbmdzID0gW3ByZWwuY3NzKCJwYWRkaW5nVG9wIiksIHByZWwuY3NzKCJwYWRkaW5nUmlnaHQiKSwgcHJlbC5jc3MoInBhZGRpbmdCb3R0b20iKSwgcHJlbC5jc3MoInBhZGRpbmdMZWZ0IildOwoKCQkJCWZvciAoIGogPSAwOyBqIDwgYm9yZGVycy5sZW5ndGg7IGorKyApIHsKCQkJCQl0aGlzLmJvcmRlckRpZlsgaiBdID0gKCBwYXJzZUludCggYm9yZGVyc1sgaiBdLCAxMCApIHx8IDAgKSArICggcGFyc2VJbnQoIHBhZGRpbmdzWyBqIF0sIDEwICkgfHwgMCApOwoJCQkJfQoJCQl9CgoJCQlwcmVsLmNzcyh7CgkJCQloZWlnaHQ6IChlbGVtZW50LmhlaWdodCgpIC0gdGhpcy5ib3JkZXJEaWZbMF0gLSB0aGlzLmJvcmRlckRpZlsyXSkgfHwgMCwKCQkJCXdpZHRoOiAoZWxlbWVudC53aWR0aCgpIC0gdGhpcy5ib3JkZXJEaWZbMV0gLSB0aGlzLmJvcmRlckRpZlszXSkgfHwgMAoJCQl9KTsKCgkJfQoKCX0sCgoJX3JlbmRlclByb3h5OiBmdW5jdGlvbigpIHsKCgkJdmFyIGVsID0gdGhpcy5lbGVtZW50LCBvID0gdGhpcy5vcHRpb25zOwoJCXRoaXMuZWxlbWVudE9mZnNldCA9IGVsLm9mZnNldCgpOwoKCQlpZih0aGlzLl9oZWxwZXIpIHsKCgkJCXRoaXMuaGVscGVyID0gdGhpcy5oZWxwZXIgfHwgJCgiPGRpdiBzdHlsZT0nb3ZlcmZsb3c6aGlkZGVuOyc+PC9kaXY+Iik7CgoJCQl0aGlzLmhlbHBlci5hZGRDbGFzcyh0aGlzLl9oZWxwZXIpLmNzcyh7CgkJCQl3aWR0aDogdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKSAtIDEsCgkJCQloZWlnaHQ6IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gMSwKCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLAoJCQkJbGVmdDogdGhpcy5lbGVtZW50T2Zmc2V0LmxlZnQgKyJweCIsCgkJCQl0b3A6IHRoaXMuZWxlbWVudE9mZnNldC50b3AgKyJweCIsCgkJCQl6SW5kZXg6ICsrby56SW5kZXggLy9UT0RPOiBEb24ndCBtb2RpZnkgb3B0aW9uCgkJCX0pOwoKCQkJdGhpcy5oZWxwZXIKCQkJCS5hcHBlbmRUbygiYm9keSIpCgkJCQkuZGlzYWJsZVNlbGVjdGlvbigpOwoKCQl9IGVsc2UgewoJCQl0aGlzLmhlbHBlciA9IHRoaXMuZWxlbWVudDsKCQl9CgoJfSwKCglfY2hhbmdlOiB7CgkJZTogZnVuY3Rpb24oZXZlbnQsIGR4KSB7CgkJCXJldHVybiB7IHdpZHRoOiB0aGlzLm9yaWdpbmFsU2l6ZS53aWR0aCArIGR4IH07CgkJfSwKCQl3OiBmdW5jdGlvbihldmVudCwgZHgpIHsKCQkJdmFyIGNzID0gdGhpcy5vcmlnaW5hbFNpemUsIHNwID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uOwoJCQlyZXR1cm4geyBsZWZ0OiBzcC5sZWZ0ICsgZHgsIHdpZHRoOiBjcy53aWR0aCAtIGR4IH07CgkJfSwKCQluOiBmdW5jdGlvbihldmVudCwgZHgsIGR5KSB7CgkJCXZhciBjcyA9IHRoaXMub3JpZ2luYWxTaXplLCBzcCA9IHRoaXMub3JpZ2luYWxQb3NpdGlvbjsKCQkJcmV0dXJuIHsgdG9wOiBzcC50b3AgKyBkeSwgaGVpZ2h0OiBjcy5oZWlnaHQgLSBkeSB9OwoJCX0sCgkJczogZnVuY3Rpb24oZXZlbnQsIGR4LCBkeSkgewoJCQlyZXR1cm4geyBoZWlnaHQ6IHRoaXMub3JpZ2luYWxTaXplLmhlaWdodCArIGR5IH07CgkJfSwKCQlzZTogZnVuY3Rpb24oZXZlbnQsIGR4LCBkeSkgewoJCQlyZXR1cm4gJC5leHRlbmQodGhpcy5fY2hhbmdlLnMuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgdGhpcy5fY2hhbmdlLmUuYXBwbHkodGhpcywgW2V2ZW50LCBkeCwgZHldKSk7CgkJfSwKCQlzdzogZnVuY3Rpb24oZXZlbnQsIGR4LCBkeSkgewoJCQlyZXR1cm4gJC5leHRlbmQodGhpcy5fY2hhbmdlLnMuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgdGhpcy5fY2hhbmdlLncuYXBwbHkodGhpcywgW2V2ZW50LCBkeCwgZHldKSk7CgkJfSwKCQluZTogZnVuY3Rpb24oZXZlbnQsIGR4LCBkeSkgewoJCQlyZXR1cm4gJC5leHRlbmQodGhpcy5fY2hhbmdlLm4uYXBwbHkodGhpcywgYXJndW1lbnRzKSwgdGhpcy5fY2hhbmdlLmUuYXBwbHkodGhpcywgW2V2ZW50LCBkeCwgZHldKSk7CgkJfSwKCQludzogZnVuY3Rpb24oZXZlbnQsIGR4LCBkeSkgewoJCQlyZXR1cm4gJC5leHRlbmQodGhpcy5fY2hhbmdlLm4uYXBwbHkodGhpcywgYXJndW1lbnRzKSwgdGhpcy5fY2hhbmdlLncuYXBwbHkodGhpcywgW2V2ZW50LCBkeCwgZHldKSk7CgkJfQoJfSwKCglfcHJvcGFnYXRlOiBmdW5jdGlvbihuLCBldmVudCkgewoJCSQudWkucGx1Z2luLmNhbGwodGhpcywgbiwgW2V2ZW50LCB0aGlzLnVpKCldKTsKCQkobiAhPT0gInJlc2l6ZSIgJiYgdGhpcy5fdHJpZ2dlcihuLCBldmVudCwgdGhpcy51aSgpKSk7Cgl9LAoKCXBsdWdpbnM6IHt9LAoKCXVpOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gewoJCQlvcmlnaW5hbEVsZW1lbnQ6IHRoaXMub3JpZ2luYWxFbGVtZW50LAoJCQllbGVtZW50OiB0aGlzLmVsZW1lbnQsCgkJCWhlbHBlcjogdGhpcy5oZWxwZXIsCgkJCXBvc2l0aW9uOiB0aGlzLnBvc2l0aW9uLAoJCQlzaXplOiB0aGlzLnNpemUsCgkJCW9yaWdpbmFsU2l6ZTogdGhpcy5vcmlnaW5hbFNpemUsCgkJCW9yaWdpbmFsUG9zaXRpb246IHRoaXMub3JpZ2luYWxQb3NpdGlvbgoJCX07Cgl9Cgp9KTsKCi8qCiAqIFJlc2l6YWJsZSBFeHRlbnNpb25zCiAqLwoKJC51aS5wbHVnaW4uYWRkKCJyZXNpemFibGUiLCAiYW5pbWF0ZSIsIHsKCglzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRoYXQgPSAkKHRoaXMpLmRhdGEoInVpLXJlc2l6YWJsZSIpLAoJCQlvID0gdGhhdC5vcHRpb25zLAoJCQlwciA9IHRoYXQuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMsCgkJCWlzdGEgPSBwci5sZW5ndGggJiYgKC90ZXh0YXJlYS9pKS50ZXN0KHByWzBdLm5vZGVOYW1lKSwKCQkJc29mZnNldGggPSBpc3RhICYmICQudWkuaGFzU2Nyb2xsKHByWzBdLCAibGVmdCIpIC8qIFRPRE8gLSBqdW1wIGhlaWdodCAqLyA\/IDAgOiB0aGF0LnNpemVEaWZmLmhlaWdodCwKCQkJc29mZnNldHcgPSBpc3RhID8gMCA6IHRoYXQuc2l6ZURpZmYud2lkdGgsCgkJCXN0eWxlID0geyB3aWR0aDogKHRoYXQuc2l6ZS53aWR0aCAtIHNvZmZzZXR3KSwgaGVpZ2h0OiAodGhhdC5zaXplLmhlaWdodCAtIHNvZmZzZXRoKSB9LAoJCQlsZWZ0ID0gKHBhcnNlSW50KHRoYXQuZWxlbWVudC5jc3MoImxlZnQiKSwgMTApICsgKHRoYXQucG9zaXRpb24ubGVmdCAtIHRoYXQub3JpZ2luYWxQb3NpdGlvbi5sZWZ0KSkgfHwgbnVsbCwKCQkJdG9wID0gKHBhcnNlSW50KHRoYXQuZWxlbWVudC5jc3MoInRvcCIpLCAxMCkgKyAodGhhdC5wb3NpdGlvbi50b3AgLSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24udG9wKSkgfHwgbnVsbDsKCgkJdGhhdC5lbGVtZW50LmFuaW1hdGUoCgkJCSQuZXh0ZW5kKHN0eWxlLCB0b3AgJiYgbGVmdCA\/IHsgdG9wOiB0b3AsIGxlZnQ6IGxlZnQgfSA6IHt9KSwgewoJCQkJZHVyYXRpb246IG8uYW5pbWF0ZUR1cmF0aW9uLAoJCQkJZWFzaW5nOiBvLmFuaW1hdGVFYXNpbmcsCgkJCQlzdGVwOiBmdW5jdGlvbigpIHsKCgkJCQkJdmFyIGRhdGEgPSB7CgkJCQkJCXdpZHRoOiBwYXJzZUludCh0aGF0LmVsZW1lbnQuY3NzKCJ3aWR0aCIpLCAxMCksCgkJCQkJCWhlaWdodDogcGFyc2VJbnQodGhhdC5lbGVtZW50LmNzcygiaGVpZ2h0IiksIDEwKSwKCQkJCQkJdG9wOiBwYXJzZUludCh0aGF0LmVsZW1lbnQuY3NzKCJ0b3AiKSwgMTApLAoJCQkJCQlsZWZ0OiBwYXJzZUludCh0aGF0LmVsZW1lbnQuY3NzKCJsZWZ0IiksIDEwKQoJCQkJCX07CgoJCQkJCWlmIChwciAmJiBwci5sZW5ndGgpIHsKCQkJCQkJJChwclswXSkuY3NzKHsgd2lkdGg6IGRhdGEud2lkdGgsIGhlaWdodDogZGF0YS5oZWlnaHQgfSk7CgkJCQkJfQoKCQkJCQkvLyBwcm9wYWdhdGluZyByZXNpemUsIGFuZCB1cGRhdGluZyB2YWx1ZXMgZm9yIGVhY2ggYW5pbWF0aW9uIHN0ZXAKCQkJCQl0aGF0Ll91cGRhdGVDYWNoZShkYXRhKTsKCQkJCQl0aGF0Ll9wcm9wYWdhdGUoInJlc2l6ZSIsIGV2ZW50KTsKCgkJCQl9CgkJCX0KCQkpOwoJfQoKfSk7CgokLnVpLnBsdWdpbi5hZGQoInJlc2l6YWJsZSIsICJjb250YWlubWVudCIsIHsKCglzdGFydDogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQsIHAsIGNvLCBjaCwgY3csIHdpZHRoLCBoZWlnaHQsCgkJCXRoYXQgPSAkKHRoaXMpLmRhdGEoInVpLXJlc2l6YWJsZSIpLAoJCQlvID0gdGhhdC5vcHRpb25zLAoJCQllbCA9IHRoYXQuZWxlbWVudCwKCQkJb2MgPSBvLmNvbnRhaW5tZW50LAoJCQljZSA9IChvYyBpbnN0YW5jZW9mICQpID8gb2MuZ2V0KDApIDogKC9wYXJlbnQvLnRlc3Qob2MpKSA\/IGVsLnBhcmVudCgpLmdldCgwKSA6IG9jOwoKCQlpZiAoIWNlKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoYXQuY29udGFpbmVyRWxlbWVudCA9ICQoY2UpOwoKCQlpZiAoL2RvY3VtZW50Ly50ZXN0KG9jKSB8fCBvYyA9PT0gZG9jdW1lbnQpIHsKCQkJdGhhdC5jb250YWluZXJPZmZzZXQgPSB7IGxlZnQ6IDAsIHRvcDogMCB9OwoJCQl0aGF0LmNvbnRhaW5lclBvc2l0aW9uID0geyBsZWZ0OiAwLCB0b3A6IDAgfTsKCgkJCXRoYXQucGFyZW50RGF0YSA9IHsKCQkJCWVsZW1lbnQ6ICQoZG9jdW1lbnQpLCBsZWZ0OiAwLCB0b3A6IDAsCgkJCQl3aWR0aDogJChkb2N1bWVudCkud2lkdGgoKSwgaGVpZ2h0OiAkKGRvY3VtZW50KS5oZWlnaHQoKSB8fCBkb2N1bWVudC5ib2R5LnBhcmVudE5vZGUuc2Nyb2xsSGVpZ2h0CgkJCX07CgkJfQoKCQkvLyBpJ20gYSBub2RlLCBzbyBjb21wdXRlIHRvcCwgbGVmdCwgcmlnaHQsIGJvdHRvbQoJCWVsc2UgewoJCQllbGVtZW50ID0gJChjZSk7CgkJCXAgPSBbXTsKCQkJJChbICJUb3AiLCAiUmlnaHQiLCAiTGVmdCIsICJCb3R0b20iIF0pLmVhY2goZnVuY3Rpb24oaSwgbmFtZSkgeyBwW2ldID0gbnVtKGVsZW1lbnQuY3NzKCJwYWRkaW5nIiArIG5hbWUpKTsgfSk7CgoJCQl0aGF0LmNvbnRhaW5lck9mZnNldCA9IGVsZW1lbnQub2Zmc2V0KCk7CgkJCXRoYXQuY29udGFpbmVyUG9zaXRpb24gPSBlbGVtZW50LnBvc2l0aW9uKCk7CgkJCXRoYXQuY29udGFpbmVyU2l6ZSA9IHsgaGVpZ2h0OiAoZWxlbWVudC5pbm5lckhlaWdodCgpIC0gcFszXSksIHdpZHRoOiAoZWxlbWVudC5pbm5lcldpZHRoKCkgLSBwWzFdKSB9OwoKCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldDsKCQkJY2ggPSB0aGF0LmNvbnRhaW5lclNpemUuaGVpZ2h0OwoJCQljdyA9IHRoYXQuY29udGFpbmVyU2l6ZS53aWR0aDsKCQkJd2lkdGggPSAoJC51aS5oYXNTY3JvbGwoY2UsICJsZWZ0IikgPyBjZS5zY3JvbGxXaWR0aCA6IGN3ICk7CgkJCWhlaWdodCA9ICgkLnVpLmhhc1Njcm9sbChjZSkgPyBjZS5zY3JvbGxIZWlnaHQgOiBjaCk7CgoJCQl0aGF0LnBhcmVudERhdGEgPSB7CgkJCQllbGVtZW50OiBjZSwgbGVmdDogY28ubGVmdCwgdG9wOiBjby50b3AsIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQKCQkJfTsKCQl9Cgl9LAoKCXJlc2l6ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB3b3NldCwgaG9zZXQsIGlzUGFyZW50LCBpc09mZnNldFJlbGF0aXZlLAoJCQl0aGF0ID0gJCh0aGlzKS5kYXRhKCJ1aS1yZXNpemFibGUiKSwKCQkJbyA9IHRoYXQub3B0aW9ucywKCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldCwgY3AgPSB0aGF0LnBvc2l0aW9uLAoJCQlwUmF0aW8gPSB0aGF0Ll9hc3BlY3RSYXRpbyB8fCBldmVudC5zaGlmdEtleSwKCQkJY29wID0geyB0b3A6MCwgbGVmdDowIH0sIGNlID0gdGhhdC5jb250YWluZXJFbGVtZW50OwoKCQlpZiAoY2VbMF0gIT09IGRvY3VtZW50ICYmICgvc3RhdGljLykudGVzdChjZS5jc3MoInBvc2l0aW9uIikpKSB7CgkJCWNvcCA9IGNvOwoJCX0KCgkJaWYgKGNwLmxlZnQgPCAodGhhdC5faGVscGVyID8gY28ubGVmdCA6IDApKSB7CgkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQuc2l6ZS53aWR0aCArICh0aGF0Ll9oZWxwZXIgPyAodGhhdC5wb3NpdGlvbi5sZWZ0IC0gY28ubGVmdCkgOiAodGhhdC5wb3NpdGlvbi5sZWZ0IC0gY29wLmxlZnQpKTsKCQkJaWYgKHBSYXRpbykgewoJCQkJdGhhdC5zaXplLmhlaWdodCA9IHRoYXQuc2l6ZS53aWR0aCAvIHRoYXQuYXNwZWN0UmF0aW87CgkJCX0KCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gby5oZWxwZXIgPyBjby5sZWZ0IDogMDsKCQl9CgoJCWlmIChjcC50b3AgPCAodGhhdC5faGVscGVyID8gY28udG9wIDogMCkpIHsKCQkJdGhhdC5zaXplLmhlaWdodCA9IHRoYXQuc2l6ZS5oZWlnaHQgKyAodGhhdC5faGVscGVyID8gKHRoYXQucG9zaXRpb24udG9wIC0gY28udG9wKSA6IHRoYXQucG9zaXRpb24udG9wKTsKCQkJaWYgKHBSYXRpbykgewoJCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5zaXplLmhlaWdodCAqIHRoYXQuYXNwZWN0UmF0aW87CgkJCX0KCQkJdGhhdC5wb3NpdGlvbi50b3AgPSB0aGF0Ll9oZWxwZXIgPyBjby50b3AgOiAwOwoJCX0KCgkJdGhhdC5vZmZzZXQubGVmdCA9IHRoYXQucGFyZW50RGF0YS5sZWZ0K3RoYXQucG9zaXRpb24ubGVmdDsKCQl0aGF0Lm9mZnNldC50b3AgPSB0aGF0LnBhcmVudERhdGEudG9wK3RoYXQucG9zaXRpb24udG9wOwoKCQl3b3NldCA9IE1hdGguYWJzKCAodGhhdC5faGVscGVyID8gdGhhdC5vZmZzZXQubGVmdCAtIGNvcC5sZWZ0IDogKHRoYXQub2Zmc2V0LmxlZnQgLSBjb3AubGVmdCkpICsgdGhhdC5zaXplRGlmZi53aWR0aCApOwoJCWhvc2V0ID0gTWF0aC5hYnMoICh0aGF0Ll9oZWxwZXIgPyB0aGF0Lm9mZnNldC50b3AgLSBjb3AudG9wIDogKHRoYXQub2Zmc2V0LnRvcCAtIGNvLnRvcCkpICsgdGhhdC5zaXplRGlmZi5oZWlnaHQgKTsKCgkJaXNQYXJlbnQgPSB0aGF0LmNvbnRhaW5lckVsZW1lbnQuZ2V0KDApID09PSB0aGF0LmVsZW1lbnQucGFyZW50KCkuZ2V0KDApOwoJCWlzT2Zmc2V0UmVsYXRpdmUgPSAvcmVsYXRpdmV8YWJzb2x1dGUvLnRlc3QodGhhdC5jb250YWluZXJFbGVtZW50LmNzcygicG9zaXRpb24iKSk7CgoJCWlmKGlzUGFyZW50ICYmIGlzT2Zmc2V0UmVsYXRpdmUpIHsKCQkJd29zZXQgLT0gdGhhdC5wYXJlbnREYXRhLmxlZnQ7CgkJfQoKCQlpZiAod29zZXQgKyB0aGF0LnNpemUud2lkdGggPj0gdGhhdC5wYXJlbnREYXRhLndpZHRoKSB7CgkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQucGFyZW50RGF0YS53aWR0aCAtIHdvc2V0OwoJCQlpZiAocFJhdGlvKSB7CgkJCQl0aGF0LnNpemUuaGVpZ2h0ID0gdGhhdC5zaXplLndpZHRoIC8gdGhhdC5hc3BlY3RSYXRpbzsKCQkJfQoJCX0KCgkJaWYgKGhvc2V0ICsgdGhhdC5zaXplLmhlaWdodCA+PSB0aGF0LnBhcmVudERhdGEuaGVpZ2h0KSB7CgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnBhcmVudERhdGEuaGVpZ2h0IC0gaG9zZXQ7CgkJCWlmIChwUmF0aW8pIHsKCQkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQuc2l6ZS5oZWlnaHQgKiB0aGF0LmFzcGVjdFJhdGlvOwoJCQl9CgkJfQoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCXZhciB0aGF0ID0gJCh0aGlzKS5kYXRhKCJ1aS1yZXNpemFibGUiKSwKCQkJbyA9IHRoYXQub3B0aW9ucywKCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldCwKCQkJY29wID0gdGhhdC5jb250YWluZXJQb3NpdGlvbiwKCQkJY2UgPSB0aGF0LmNvbnRhaW5lckVsZW1lbnQsCgkJCWhlbHBlciA9ICQodGhhdC5oZWxwZXIpLAoJCQlobyA9IGhlbHBlci5vZmZzZXQoKSwKCQkJdyA9IGhlbHBlci5vdXRlcldpZHRoKCkgLSB0aGF0LnNpemVEaWZmLndpZHRoLAoJCQloID0gaGVscGVyLm91dGVySGVpZ2h0KCkgLSB0aGF0LnNpemVEaWZmLmhlaWdodDsKCgkJaWYgKHRoYXQuX2hlbHBlciAmJiAhby5hbmltYXRlICYmICgvcmVsYXRpdmUvKS50ZXN0KGNlLmNzcygicG9zaXRpb24iKSkpIHsKCQkJJCh0aGlzKS5jc3MoeyBsZWZ0OiBoby5sZWZ0IC0gY29wLmxlZnQgLSBjby5sZWZ0LCB3aWR0aDogdywgaGVpZ2h0OiBoIH0pOwoJCX0KCgkJaWYgKHRoYXQuX2hlbHBlciAmJiAhby5hbmltYXRlICYmICgvc3RhdGljLykudGVzdChjZS5jc3MoInBvc2l0aW9uIikpKSB7CgkJCSQodGhpcykuY3NzKHsgbGVmdDogaG8ubGVmdCAtIGNvcC5sZWZ0IC0gY28ubGVmdCwgd2lkdGg6IHcsIGhlaWdodDogaCB9KTsKCQl9CgoJfQp9KTsKCiQudWkucGx1Z2luLmFkZCgicmVzaXphYmxlIiwgImFsc29SZXNpemUiLCB7CgoJc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCQl2YXIgdGhhdCA9ICQodGhpcykuZGF0YSgidWktcmVzaXphYmxlIiksCgkJCW8gPSB0aGF0Lm9wdGlvbnMsCgkJCV9zdG9yZSA9IGZ1bmN0aW9uIChleHApIHsKCQkJCSQoZXhwKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbCA9ICQodGhpcyk7CgkJCQkJZWwuZGF0YSgidWktcmVzaXphYmxlLWFsc29yZXNpemUiLCB7CgkJCQkJCXdpZHRoOiBwYXJzZUludChlbC53aWR0aCgpLCAxMCksIGhlaWdodDogcGFyc2VJbnQoZWwuaGVpZ2h0KCksIDEwKSwKCQkJCQkJbGVmdDogcGFyc2VJbnQoZWwuY3NzKCJsZWZ0IiksIDEwKSwgdG9wOiBwYXJzZUludChlbC5jc3MoInRvcCIpLCAxMCkKCQkJCQl9KTsKCQkJCX0pOwoJCQl9OwoKCQlpZiAodHlwZW9mKG8uYWxzb1Jlc2l6ZSkgPT09ICJvYmplY3QiICYmICFvLmFsc29SZXNpemUucGFyZW50Tm9kZSkgewoJCQlpZiAoby5hbHNvUmVzaXplLmxlbmd0aCkgeyBvLmFsc29SZXNpemUgPSBvLmFsc29SZXNpemVbMF07IF9zdG9yZShvLmFsc29SZXNpemUpOyB9CgkJCWVsc2UgeyAkLmVhY2goby5hbHNvUmVzaXplLCBmdW5jdGlvbiAoZXhwKSB7IF9zdG9yZShleHApOyB9KTsgfQoJCX1lbHNlewoJCQlfc3RvcmUoby5hbHNvUmVzaXplKTsKCQl9Cgl9LAoKCXJlc2l6ZTogZnVuY3Rpb24gKGV2ZW50LCB1aSkgewoJCXZhciB0aGF0ID0gJCh0aGlzKS5kYXRhKCJ1aS1yZXNpemFibGUiKSwKCQkJbyA9IHRoYXQub3B0aW9ucywKCQkJb3MgPSB0aGF0Lm9yaWdpbmFsU2l6ZSwKCQkJb3AgPSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24sCgkJCWRlbHRhID0gewoJCQkJaGVpZ2h0OiAodGhhdC5zaXplLmhlaWdodCAtIG9zLmhlaWdodCkgfHwgMCwgd2lkdGg6ICh0aGF0LnNpemUud2lkdGggLSBvcy53aWR0aCkgfHwgMCwKCQkJCXRvcDogKHRoYXQucG9zaXRpb24udG9wIC0gb3AudG9wKSB8fCAwLCBsZWZ0OiAodGhhdC5wb3NpdGlvbi5sZWZ0IC0gb3AubGVmdCkgfHwgMAoJCQl9LAoKCQkJX2Fsc29SZXNpemUgPSBmdW5jdGlvbiAoZXhwLCBjKSB7CgkJCQkkKGV4cCkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgZWwgPSAkKHRoaXMpLCBzdGFydCA9ICQodGhpcykuZGF0YSgidWktcmVzaXphYmxlLWFsc29yZXNpemUiKSwgc3R5bGUgPSB7fSwKCQkJCQkJY3NzID0gYyAmJiBjLmxlbmd0aCA\/IGMgOiBlbC5wYXJlbnRzKHVpLm9yaWdpbmFsRWxlbWVudFswXSkubGVuZ3RoID8gWyJ3aWR0aCIsICJoZWlnaHQiXSA6IFsid2lkdGgiLCAiaGVpZ2h0IiwgInRvcCIsICJsZWZ0Il07CgoJCQkJCSQuZWFjaChjc3MsIGZ1bmN0aW9uIChpLCBwcm9wKSB7CgkJCQkJCXZhciBzdW0gPSAoc3RhcnRbcHJvcF18fDApICsgKGRlbHRhW3Byb3BdfHwwKTsKCQkJCQkJaWYgKHN1bSAmJiBzdW0gPj0gMCkgewoJCQkJCQkJc3R5bGVbcHJvcF0gPSBzdW0gfHwgbnVsbDsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCQllbC5jc3Moc3R5bGUpOwoJCQkJfSk7CgkJCX07CgoJCWlmICh0eXBlb2Yoby5hbHNvUmVzaXplKSA9PT0gIm9iamVjdCIgJiYgIW8uYWxzb1Jlc2l6ZS5ub2RlVHlwZSkgewoJCQkkLmVhY2goby5hbHNvUmVzaXplLCBmdW5jdGlvbiAoZXhwLCBjKSB7IF9hbHNvUmVzaXplKGV4cCwgYyk7IH0pOwoJCX1lbHNlewoJCQlfYWxzb1Jlc2l6ZShvLmFsc29SZXNpemUpOwoJCX0KCX0sCgoJc3RvcDogZnVuY3Rpb24gKCkgewoJCSQodGhpcykucmVtb3ZlRGF0YSgicmVzaXphYmxlLWFsc29yZXNpemUiKTsKCX0KfSk7CgokLnVpLnBsdWdpbi5hZGQoInJlc2l6YWJsZSIsICJnaG9zdCIsIHsKCglzdGFydDogZnVuY3Rpb24oKSB7CgoJCXZhciB0aGF0ID0gJCh0aGlzKS5kYXRhKCJ1aS1yZXNpemFibGUiKSwgbyA9IHRoYXQub3B0aW9ucywgY3MgPSB0aGF0LnNpemU7CgoJCXRoYXQuZ2hvc3QgPSB0aGF0Lm9yaWdpbmFsRWxlbWVudC5jbG9uZSgpOwoJCXRoYXQuZ2hvc3QKCQkJLmNzcyh7IG9wYWNpdHk6IDAuMjUsIGRpc3BsYXk6ICJibG9jayIsIHBvc2l0aW9uOiAicmVsYXRpdmUiLCBoZWlnaHQ6IGNzLmhlaWdodCwgd2lkdGg6IGNzLndpZHRoLCBtYXJnaW46IDAsIGxlZnQ6IDAsIHRvcDogMCB9KQoJCQkuYWRkQ2xhc3MoInVpLXJlc2l6YWJsZS1naG9zdCIpCgkJCS5hZGRDbGFzcyh0eXBlb2Ygby5naG9zdCA9PT0gInN0cmluZyIgPyBvLmdob3N0IDogIiIpOwoKCQl0aGF0Lmdob3N0LmFwcGVuZFRvKHRoYXQuaGVscGVyKTsKCgl9LAoKCXJlc2l6ZTogZnVuY3Rpb24oKXsKCQl2YXIgdGhhdCA9ICQodGhpcykuZGF0YSgidWktcmVzaXphYmxlIik7CgkJaWYgKHRoYXQuZ2hvc3QpIHsKCQkJdGhhdC5naG9zdC5jc3MoeyBwb3NpdGlvbjogInJlbGF0aXZlIiwgaGVpZ2h0OiB0aGF0LnNpemUuaGVpZ2h0LCB3aWR0aDogdGhhdC5zaXplLndpZHRoIH0pOwoJCX0KCX0sCgoJc3RvcDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSAkKHRoaXMpLmRhdGEoInVpLXJlc2l6YWJsZSIpOwoJCWlmICh0aGF0Lmdob3N0ICYmIHRoYXQuaGVscGVyKSB7CgkJCXRoYXQuaGVscGVyLmdldCgwKS5yZW1vdmVDaGlsZCh0aGF0Lmdob3N0LmdldCgwKSk7CgkJfQoJfQoKfSk7CgokLnVpLnBsdWdpbi5hZGQoInJlc2l6YWJsZSIsICJncmlkIiwgewoKCXJlc2l6ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSAkKHRoaXMpLmRhdGEoInVpLXJlc2l6YWJsZSIpLAoJCQlvID0gdGhhdC5vcHRpb25zLAoJCQljcyA9IHRoYXQuc2l6ZSwKCQkJb3MgPSB0aGF0Lm9yaWdpbmFsU2l6ZSwKCQkJb3AgPSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24sCgkJCWEgPSB0aGF0LmF4aXMsCgkJCWdyaWQgPSB0eXBlb2Ygby5ncmlkID09PSAibnVtYmVyIiA\/IFtvLmdyaWQsIG8uZ3JpZF0gOiBvLmdyaWQsCgkJCWdyaWRYID0gKGdyaWRbMF18fDEpLAoJCQlncmlkWSA9IChncmlkWzFdfHwxKSwKCQkJb3ggPSBNYXRoLnJvdW5kKChjcy53aWR0aCAtIG9zLndpZHRoKSAvIGdyaWRYKSAqIGdyaWRYLAoJCQlveSA9IE1hdGgucm91bmQoKGNzLmhlaWdodCAtIG9zLmhlaWdodCkgLyBncmlkWSkgKiBncmlkWSwKCQkJbmV3V2lkdGggPSBvcy53aWR0aCArIG94LAoJCQluZXdIZWlnaHQgPSBvcy5oZWlnaHQgKyBveSwKCQkJaXNNYXhXaWR0aCA9IG8ubWF4V2lkdGggJiYgKG8ubWF4V2lkdGggPCBuZXdXaWR0aCksCgkJCWlzTWF4SGVpZ2h0ID0gby5tYXhIZWlnaHQgJiYgKG8ubWF4SGVpZ2h0IDwgbmV3SGVpZ2h0KSwKCQkJaXNNaW5XaWR0aCA9IG8ubWluV2lkdGggJiYgKG8ubWluV2lkdGggPiBuZXdXaWR0aCksCgkJCWlzTWluSGVpZ2h0ID0gby5taW5IZWlnaHQgJiYgKG8ubWluSGVpZ2h0ID4gbmV3SGVpZ2h0KTsKCgkJby5ncmlkID0gZ3JpZDsKCgkJaWYgKGlzTWluV2lkdGgpIHsKCQkJbmV3V2lkdGggPSBuZXdXaWR0aCArIGdyaWRYOwoJCX0KCQlpZiAoaXNNaW5IZWlnaHQpIHsKCQkJbmV3SGVpZ2h0ID0gbmV3SGVpZ2h0ICsgZ3JpZFk7CgkJfQoJCWlmIChpc01heFdpZHRoKSB7CgkJCW5ld1dpZHRoID0gbmV3V2lkdGggLSBncmlkWDsKCQl9CgkJaWYgKGlzTWF4SGVpZ2h0KSB7CgkJCW5ld0hlaWdodCA9IG5ld0hlaWdodCAtIGdyaWRZOwoJCX0KCgkJaWYgKC9eKHNlfHN8ZSkkLy50ZXN0KGEpKSB7CgkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOwoJCQl0aGF0LnNpemUuaGVpZ2h0ID0gbmV3SGVpZ2h0OwoJCX0gZWxzZSBpZiAoL14obmUpJC8udGVzdChhKSkgewoJCQl0aGF0LnNpemUud2lkdGggPSBuZXdXaWR0aDsKCQkJdGhhdC5zaXplLmhlaWdodCA9IG5ld0hlaWdodDsKCQkJdGhhdC5wb3NpdGlvbi50b3AgPSBvcC50b3AgLSBveTsKCQl9IGVsc2UgaWYgKC9eKHN3KSQvLnRlc3QoYSkpIHsKCQkJdGhhdC5zaXplLndpZHRoID0gbmV3V2lkdGg7CgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7CgkJCXRoYXQucG9zaXRpb24ubGVmdCA9IG9wLmxlZnQgLSBveDsKCQl9IGVsc2UgewoJCQl0aGF0LnNpemUud2lkdGggPSBuZXdXaWR0aDsKCQkJdGhhdC5zaXplLmhlaWdodCA9IG5ld0hlaWdodDsKCQkJdGhhdC5wb3NpdGlvbi50b3AgPSBvcC50b3AgLSBveTsKCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gb3AubGVmdCAtIG94OwoJCX0KCX0KCn0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCgidWkuc2VsZWN0YWJsZSIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJb3B0aW9uczogewoJCWFwcGVuZFRvOiAiYm9keSIsCgkJYXV0b1JlZnJlc2g6IHRydWUsCgkJZGlzdGFuY2U6IDAsCgkJZmlsdGVyOiAiKiIsCgkJdG9sZXJhbmNlOiAidG91Y2giLAoKCQkvLyBjYWxsYmFja3MKCQlzZWxlY3RlZDogbnVsbCwKCQlzZWxlY3Rpbmc6IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbCwKCQl1bnNlbGVjdGVkOiBudWxsLAoJCXVuc2VsZWN0aW5nOiBudWxsCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVlcywKCQkJdGhhdCA9IHRoaXM7CgoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcygidWktc2VsZWN0YWJsZSIpOwoKCQl0aGlzLmRyYWdnZWQgPSBmYWxzZTsKCgkJLy8gY2FjaGUgc2VsZWN0ZWUgY2hpbGRyZW4gYmFzZWQgb24gZmlsdGVyCgkJdGhpcy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7CgkJCXNlbGVjdGVlcyA9ICQodGhhdC5vcHRpb25zLmZpbHRlciwgdGhhdC5lbGVtZW50WzBdKTsKCQkJc2VsZWN0ZWVzLmFkZENsYXNzKCJ1aS1zZWxlY3RlZSIpOwoJCQlzZWxlY3RlZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQodGhpcyksCgkJCQkJcG9zID0gJHRoaXMub2Zmc2V0KCk7CgkJCQkkLmRhdGEodGhpcywgInNlbGVjdGFibGUtaXRlbSIsIHsKCQkJCQllbGVtZW50OiB0aGlzLAoJCQkJCSRlbGVtZW50OiAkdGhpcywKCQkJCQlsZWZ0OiBwb3MubGVmdCwKCQkJCQl0b3A6IHBvcy50b3AsCgkJCQkJcmlnaHQ6IHBvcy5sZWZ0ICsgJHRoaXMub3V0ZXJXaWR0aCgpLAoJCQkJCWJvdHRvbTogcG9zLnRvcCArICR0aGlzLm91dGVySGVpZ2h0KCksCgkJCQkJc3RhcnRzZWxlY3RlZDogZmFsc2UsCgkJCQkJc2VsZWN0ZWQ6ICR0aGlzLmhhc0NsYXNzKCJ1aS1zZWxlY3RlZCIpLAoJCQkJCXNlbGVjdGluZzogJHRoaXMuaGFzQ2xhc3MoInVpLXNlbGVjdGluZyIpLAoJCQkJCXVuc2VsZWN0aW5nOiAkdGhpcy5oYXNDbGFzcygidWktdW5zZWxlY3RpbmciKQoJCQkJfSk7CgkJCX0pOwoJCX07CgkJdGhpcy5yZWZyZXNoKCk7CgoJCXRoaXMuc2VsZWN0ZWVzID0gc2VsZWN0ZWVzLmFkZENsYXNzKCJ1aS1zZWxlY3RlZSIpOwoKCQl0aGlzLl9tb3VzZUluaXQoKTsKCgkJdGhpcy5oZWxwZXIgPSAkKCI8ZGl2IGNsYXNzPSd1aS1zZWxlY3RhYmxlLWhlbHBlcic+PC9kaXY+Iik7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLnNlbGVjdGVlcwoJCQkucmVtb3ZlQ2xhc3MoInVpLXNlbGVjdGVlIikKCQkJLnJlbW92ZURhdGEoInNlbGVjdGFibGUtaXRlbSIpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoInVpLXNlbGVjdGFibGUgdWktc2VsZWN0YWJsZS1kaXNhYmxlZCIpOwoJCXRoaXMuX21vdXNlRGVzdHJveSgpOwoJfSwKCglfbW91c2VTdGFydDogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCXRoaXMub3BvcyA9IFtldmVudC5wYWdlWCwgZXZlbnQucGFnZVldOwoKCQlpZiAodGhpcy5vcHRpb25zLmRpc2FibGVkKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuc2VsZWN0ZWVzID0gJChvcHRpb25zLmZpbHRlciwgdGhpcy5lbGVtZW50WzBdKTsKCgkJdGhpcy5fdHJpZ2dlcigic3RhcnQiLCBldmVudCk7CgoJCSQob3B0aW9ucy5hcHBlbmRUbykuYXBwZW5kKHRoaXMuaGVscGVyKTsKCQkvLyBwb3NpdGlvbiBoZWxwZXIgKGxhc3NvKQoJCXRoaXMuaGVscGVyLmNzcyh7CgkJCSJsZWZ0IjogZXZlbnQucGFnZVgsCgkJCSJ0b3AiOiBldmVudC5wYWdlWSwKCQkJIndpZHRoIjogMCwKCQkJImhlaWdodCI6IDAKCQl9KTsKCgkJaWYgKG9wdGlvbnMuYXV0b1JlZnJlc2gpIHsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfQoKCQl0aGlzLnNlbGVjdGVlcy5maWx0ZXIoIi51aS1zZWxlY3RlZCIpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxlY3RlZSA9ICQuZGF0YSh0aGlzLCAic2VsZWN0YWJsZS1pdGVtIik7CgkJCXNlbGVjdGVlLnN0YXJ0c2VsZWN0ZWQgPSB0cnVlOwoJCQlpZiAoIWV2ZW50Lm1ldGFLZXkgJiYgIWV2ZW50LmN0cmxLZXkpIHsKCQkJCXNlbGVjdGVlLiRlbGVtZW50LnJlbW92ZUNsYXNzKCJ1aS1zZWxlY3RlZCIpOwoJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSBmYWxzZTsKCQkJCXNlbGVjdGVlLiRlbGVtZW50LmFkZENsYXNzKCJ1aS11bnNlbGVjdGluZyIpOwoJCQkJc2VsZWN0ZWUudW5zZWxlY3RpbmcgPSB0cnVlOwoJCQkJLy8gc2VsZWN0YWJsZSBVTlNFTEVDVElORyBjYWxsYmFjawoJCQkJdGhhdC5fdHJpZ2dlcigidW5zZWxlY3RpbmciLCBldmVudCwgewoJCQkJCXVuc2VsZWN0aW5nOiBzZWxlY3RlZS5lbGVtZW50CgkJCQl9KTsKCQkJfQoJCX0pOwoKCQkkKGV2ZW50LnRhcmdldCkucGFyZW50cygpLmFkZEJhY2soKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgZG9TZWxlY3QsCgkJCQlzZWxlY3RlZSA9ICQuZGF0YSh0aGlzLCAic2VsZWN0YWJsZS1pdGVtIik7CgkJCWlmIChzZWxlY3RlZSkgewoJCQkJZG9TZWxlY3QgPSAoIWV2ZW50Lm1ldGFLZXkgJiYgIWV2ZW50LmN0cmxLZXkpIHx8ICFzZWxlY3RlZS4kZWxlbWVudC5oYXNDbGFzcygidWktc2VsZWN0ZWQiKTsKCQkJCXNlbGVjdGVlLiRlbGVtZW50CgkJCQkJLnJlbW92ZUNsYXNzKGRvU2VsZWN0ID8gInVpLXVuc2VsZWN0aW5nIiA6ICJ1aS1zZWxlY3RlZCIpCgkJCQkJLmFkZENsYXNzKGRvU2VsZWN0ID8gInVpLXNlbGVjdGluZyIgOiAidWktdW5zZWxlY3RpbmciKTsKCQkJCXNlbGVjdGVlLnVuc2VsZWN0aW5nID0gIWRvU2VsZWN0OwoJCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gZG9TZWxlY3Q7CgkJCQlzZWxlY3RlZS5zZWxlY3RlZCA9IGRvU2VsZWN0OwoJCQkJLy8gc2VsZWN0YWJsZSAoVU4pU0VMRUNUSU5HIGNhbGxiYWNrCgkJCQlpZiAoZG9TZWxlY3QpIHsKCQkJCQl0aGF0Ll90cmlnZ2VyKCJzZWxlY3RpbmciLCBldmVudCwgewoJCQkJCQlzZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQKCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhhdC5fdHJpZ2dlcigidW5zZWxlY3RpbmciLCBldmVudCwgewoJCQkJCQl1bnNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudAoJCQkJCX0pOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJfSwKCglfbW91c2VEcmFnOiBmdW5jdGlvbihldmVudCkgewoKCQl0aGlzLmRyYWdnZWQgPSB0cnVlOwoKCQlpZiAodGhpcy5vcHRpb25zLmRpc2FibGVkKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0bXAsCgkJCXRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl4MSA9IHRoaXMub3Bvc1swXSwKCQkJeTEgPSB0aGlzLm9wb3NbMV0sCgkJCXgyID0gZXZlbnQucGFnZVgsCgkJCXkyID0gZXZlbnQucGFnZVk7CgoJCWlmICh4MSA+IHgyKSB7IHRtcCA9IHgyOyB4MiA9IHgxOyB4MSA9IHRtcDsgfQoJCWlmICh5MSA+IHkyKSB7IHRtcCA9IHkyOyB5MiA9IHkxOyB5MSA9IHRtcDsgfQoJCXRoaXMuaGVscGVyLmNzcyh7bGVmdDogeDEsIHRvcDogeTEsIHdpZHRoOiB4Mi14MSwgaGVpZ2h0OiB5Mi15MX0pOwoKCQl0aGlzLnNlbGVjdGVlcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZWN0ZWUgPSAkLmRhdGEodGhpcywgInNlbGVjdGFibGUtaXRlbSIpLAoJCQkJaGl0ID0gZmFsc2U7CgoJCQkvL3ByZXZlbnQgaGVscGVyIGZyb20gYmVpbmcgc2VsZWN0ZWQgaWYgYXBwZW5kVG86IHNlbGVjdGFibGUKCQkJaWYgKCFzZWxlY3RlZSB8fCBzZWxlY3RlZS5lbGVtZW50ID09PSB0aGF0LmVsZW1lbnRbMF0pIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKG9wdGlvbnMudG9sZXJhbmNlID09PSAidG91Y2giKSB7CgkJCQloaXQgPSAoICEoc2VsZWN0ZWUubGVmdCA+IHgyIHx8IHNlbGVjdGVlLnJpZ2h0IDwgeDEgfHwgc2VsZWN0ZWUudG9wID4geTIgfHwgc2VsZWN0ZWUuYm90dG9tIDwgeTEpICk7CgkJCX0gZWxzZSBpZiAob3B0aW9ucy50b2xlcmFuY2UgPT09ICJmaXQiKSB7CgkJCQloaXQgPSAoc2VsZWN0ZWUubGVmdCA+IHgxICYmIHNlbGVjdGVlLnJpZ2h0IDwgeDIgJiYgc2VsZWN0ZWUudG9wID4geTEgJiYgc2VsZWN0ZWUuYm90dG9tIDwgeTIpOwoJCQl9CgoJCQlpZiAoaGl0KSB7CgkJCQkvLyBTRUxFQ1QKCQkJCWlmIChzZWxlY3RlZS5zZWxlY3RlZCkgewoJCQkJCXNlbGVjdGVlLiRlbGVtZW50LnJlbW92ZUNsYXNzKCJ1aS1zZWxlY3RlZCIpOwoJCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gZmFsc2U7CgkJCQl9CgkJCQlpZiAoc2VsZWN0ZWUudW5zZWxlY3RpbmcpIHsKCQkJCQlzZWxlY3RlZS4kZWxlbWVudC5yZW1vdmVDbGFzcygidWktdW5zZWxlY3RpbmciKTsKCQkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IGZhbHNlOwoJCQkJfQoJCQkJaWYgKCFzZWxlY3RlZS5zZWxlY3RpbmcpIHsKCQkJCQlzZWxlY3RlZS4kZWxlbWVudC5hZGRDbGFzcygidWktc2VsZWN0aW5nIik7CgkJCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gdHJ1ZTsKCQkJCQkvLyBzZWxlY3RhYmxlIFNFTEVDVElORyBjYWxsYmFjawoJCQkJCXRoYXQuX3RyaWdnZXIoInNlbGVjdGluZyIsIGV2ZW50LCB7CgkJCQkJCXNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudAoJCQkJCX0pOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJLy8gVU5TRUxFQ1QKCQkJCWlmIChzZWxlY3RlZS5zZWxlY3RpbmcpIHsKCQkJCQlpZiAoKGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQuY3RybEtleSkgJiYgc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCkgewoJCQkJCQlzZWxlY3RlZS4kZWxlbWVudC5yZW1vdmVDbGFzcygidWktc2VsZWN0aW5nIik7CgkJCQkJCXNlbGVjdGVlLnNlbGVjdGluZyA9IGZhbHNlOwoJCQkJCQlzZWxlY3RlZS4kZWxlbWVudC5hZGRDbGFzcygidWktc2VsZWN0ZWQiKTsKCQkJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSB0cnVlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNlbGVjdGVlLiRlbGVtZW50LnJlbW92ZUNsYXNzKCJ1aS1zZWxlY3RpbmciKTsKCQkJCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gZmFsc2U7CgkJCQkJCWlmIChzZWxlY3RlZS5zdGFydHNlbGVjdGVkKSB7CgkJCQkJCQlzZWxlY3RlZS4kZWxlbWVudC5hZGRDbGFzcygidWktdW5zZWxlY3RpbmciKTsKCQkJCQkJCXNlbGVjdGVlLnVuc2VsZWN0aW5nID0gdHJ1ZTsKCQkJCQkJfQoJCQkJCQkvLyBzZWxlY3RhYmxlIFVOU0VMRUNUSU5HIGNhbGxiYWNrCgkJCQkJCXRoYXQuX3RyaWdnZXIoInVuc2VsZWN0aW5nIiwgZXZlbnQsIHsKCQkJCQkJCXVuc2VsZWN0aW5nOiBzZWxlY3RlZS5lbGVtZW50CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChzZWxlY3RlZS5zZWxlY3RlZCkgewoJCQkJCWlmICghZXZlbnQubWV0YUtleSAmJiAhZXZlbnQuY3RybEtleSAmJiAhc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCkgewoJCQkJCQlzZWxlY3RlZS4kZWxlbWVudC5yZW1vdmVDbGFzcygidWktc2VsZWN0ZWQiKTsKCQkJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSBmYWxzZTsKCgkJCQkJCXNlbGVjdGVlLiRlbGVtZW50LmFkZENsYXNzKCJ1aS11bnNlbGVjdGluZyIpOwoJCQkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IHRydWU7CgkJCQkJCS8vIHNlbGVjdGFibGUgVU5TRUxFQ1RJTkcgY2FsbGJhY2sKCQkJCQkJdGhhdC5fdHJpZ2dlcigidW5zZWxlY3RpbmciLCBldmVudCwgewoJCQkJCQkJdW5zZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX21vdXNlU3RvcDogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMuZHJhZ2dlZCA9IGZhbHNlOwoKCQkkKCIudWktdW5zZWxlY3RpbmciLCB0aGlzLmVsZW1lbnRbMF0pLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxlY3RlZSA9ICQuZGF0YSh0aGlzLCAic2VsZWN0YWJsZS1pdGVtIik7CgkJCXNlbGVjdGVlLiRlbGVtZW50LnJlbW92ZUNsYXNzKCJ1aS11bnNlbGVjdGluZyIpOwoJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IGZhbHNlOwoJCQlzZWxlY3RlZS5zdGFydHNlbGVjdGVkID0gZmFsc2U7CgkJCXRoYXQuX3RyaWdnZXIoInVuc2VsZWN0ZWQiLCBldmVudCwgewoJCQkJdW5zZWxlY3RlZDogc2VsZWN0ZWUuZWxlbWVudAoJCQl9KTsKCQl9KTsKCQkkKCIudWktc2VsZWN0aW5nIiwgdGhpcy5lbGVtZW50WzBdKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZWN0ZWUgPSAkLmRhdGEodGhpcywgInNlbGVjdGFibGUtaXRlbSIpOwoJCQlzZWxlY3RlZS4kZWxlbWVudC5yZW1vdmVDbGFzcygidWktc2VsZWN0aW5nIikuYWRkQ2xhc3MoInVpLXNlbGVjdGVkIik7CgkJCXNlbGVjdGVlLnNlbGVjdGluZyA9IGZhbHNlOwoJCQlzZWxlY3RlZS5zZWxlY3RlZCA9IHRydWU7CgkJCXNlbGVjdGVlLnN0YXJ0c2VsZWN0ZWQgPSB0cnVlOwoJCQl0aGF0Ll90cmlnZ2VyKCJzZWxlY3RlZCIsIGV2ZW50LCB7CgkJCQlzZWxlY3RlZDogc2VsZWN0ZWUuZWxlbWVudAoJCQl9KTsKCQl9KTsKCQl0aGlzLl90cmlnZ2VyKCJzdG9wIiwgZXZlbnQpOwoKCQl0aGlzLmhlbHBlci5yZW1vdmUoKTsKCgkJcmV0dXJuIGZhbHNlOwoJfQoKfSk7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8qanNoaW50IGxvb3BmdW5jOiB0cnVlICovCgpmdW5jdGlvbiBpc092ZXJBeGlzKCB4LCByZWZlcmVuY2UsIHNpemUgKSB7CglyZXR1cm4gKCB4ID4gcmVmZXJlbmNlICkgJiYgKCB4IDwgKCByZWZlcmVuY2UgKyBzaXplICkgKTsKfQoKZnVuY3Rpb24gaXNGbG9hdGluZyhpdGVtKSB7CglyZXR1cm4gKC9sZWZ0fHJpZ2h0LykudGVzdChpdGVtLmNzcygiZmxvYXQiKSkgfHwgKC9pbmxpbmV8dGFibGUtY2VsbC8pLnRlc3QoaXRlbS5jc3MoImRpc3BsYXkiKSk7Cn0KCiQud2lkZ2V0KCJ1aS5zb3J0YWJsZSIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzb3J0IiwKCXJlYWR5OiBmYWxzZSwKCW9wdGlvbnM6IHsKCQlhcHBlbmRUbzogInBhcmVudCIsCgkJYXhpczogZmFsc2UsCgkJY29ubmVjdFdpdGg6IGZhbHNlLAoJCWNvbnRhaW5tZW50OiBmYWxzZSwKCQljdXJzb3I6ICJhdXRvIiwKCQljdXJzb3JBdDogZmFsc2UsCgkJZHJvcE9uRW1wdHk6IHRydWUsCgkJZm9yY2VQbGFjZWhvbGRlclNpemU6IGZhbHNlLAoJCWZvcmNlSGVscGVyU2l6ZTogZmFsc2UsCgkJZ3JpZDogZmFsc2UsCgkJaGFuZGxlOiBmYWxzZSwKCQloZWxwZXI6ICJvcmlnaW5hbCIsCgkJaXRlbXM6ICI+ICoiLAoJCW9wYWNpdHk6IGZhbHNlLAoJCXBsYWNlaG9sZGVyOiBmYWxzZSwKCQlyZXZlcnQ6IGZhbHNlLAoJCXNjcm9sbDogdHJ1ZSwKCQlzY3JvbGxTZW5zaXRpdml0eTogMjAsCgkJc2Nyb2xsU3BlZWQ6IDIwLAoJCXNjb3BlOiAiZGVmYXVsdCIsCgkJdG9sZXJhbmNlOiAiaW50ZXJzZWN0IiwKCQl6SW5kZXg6IDEwMDAsCgoJCS8vIGNhbGxiYWNrcwoJCWFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZVN0b3A6IG51bGwsCgkJY2hhbmdlOiBudWxsLAoJCWRlYWN0aXZhdGU6IG51bGwsCgkJb3V0OiBudWxsLAoJCW92ZXI6IG51bGwsCgkJcmVjZWl2ZTogbnVsbCwKCQlyZW1vdmU6IG51bGwsCgkJc29ydDogbnVsbCwKCQlzdGFydDogbnVsbCwKCQlzdG9wOiBudWxsLAoJCXVwZGF0ZTogbnVsbAoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCQl0aGlzLmNvbnRhaW5lckNhY2hlID0ge307CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCJ1aS1zb3J0YWJsZSIpOwoKCQkvL0dldCB0aGUgaXRlbXMKCQl0aGlzLnJlZnJlc2goKTsKCgkJLy9MZXQncyBkZXRlcm1pbmUgaWYgdGhlIGl0ZW1zIGFyZSBiZWluZyBkaXNwbGF5ZWQgaG9yaXpvbnRhbGx5CgkJdGhpcy5mbG9hdGluZyA9IHRoaXMuaXRlbXMubGVuZ3RoID8gby5heGlzID09PSAieCIgfHwgaXNGbG9hdGluZyh0aGlzLml0ZW1zWzBdLml0ZW0pIDogZmFsc2U7CgoJCS8vTGV0J3MgZGV0ZXJtaW5lIHRoZSBwYXJlbnQncyBvZmZzZXQKCQl0aGlzLm9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJLy9Jbml0aWFsaXplIG1vdXNlIGV2ZW50cyBmb3IgaW50ZXJhY3Rpb24KCQl0aGlzLl9tb3VzZUluaXQoKTsKCgkJLy9XZSdyZSByZWFkeSB0byBnbwoJCXRoaXMucmVhZHkgPSB0cnVlOwoKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoInVpLXNvcnRhYmxlIHVpLXNvcnRhYmxlLWRpc2FibGVkIik7CgkJdGhpcy5fbW91c2VEZXN0cm95KCk7CgoJCWZvciAoIHZhciBpID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJdGhpcy5pdGVtc1tpXS5pdGVtLnJlbW92ZURhdGEodGhpcy53aWRnZXROYW1lICsgIi1pdGVtIik7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1zb3J0YWJsZS1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQl9IGVsc2UgewoJCQkvLyBEb24ndCBjYWxsIHdpZGdldCBiYXNlIF9zZXRPcHRpb24gZm9yIGRpc2FibGUgYXMgaXQgYWRkcyB1aS1zdGF0ZS1kaXNhYmxlZCBjbGFzcwoJCQkkLldpZGdldC5wcm90b3R5cGUuX3NldE9wdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCX0KCX0sCgoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oZXZlbnQsIG92ZXJyaWRlSGFuZGxlKSB7CgkJdmFyIGN1cnJlbnRJdGVtID0gbnVsbCwKCQkJdmFsaWRIYW5kbGUgPSBmYWxzZSwKCQkJdGhhdCA9IHRoaXM7CgoJCWlmICh0aGlzLnJldmVydGluZykgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZih0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5vcHRpb25zLnR5cGUgPT09ICJzdGF0aWMiKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vV2UgaGF2ZSB0byByZWZyZXNoIHRoZSBpdGVtcyBkYXRhIG9uY2UgZmlyc3QKCQl0aGlzLl9yZWZyZXNoSXRlbXMoZXZlbnQpOwoKCQkvL0ZpbmQgb3V0IGlmIHRoZSBjbGlja2VkIG5vZGUgKG9yIG9uZSBvZiBpdHMgcGFyZW50cykgaXMgYSBhY3R1YWwgaXRlbSBpbiB0aGlzLml0ZW1zCgkJJChldmVudC50YXJnZXQpLnBhcmVudHMoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZigkLmRhdGEodGhpcywgdGhhdC53aWRnZXROYW1lICsgIi1pdGVtIikgPT09IHRoYXQpIHsKCQkJCWN1cnJlbnRJdGVtID0gJCh0aGlzKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoJCWlmKCQuZGF0YShldmVudC50YXJnZXQsIHRoYXQud2lkZ2V0TmFtZSArICItaXRlbSIpID09PSB0aGF0KSB7CgkJCWN1cnJlbnRJdGVtID0gJChldmVudC50YXJnZXQpOwoJCX0KCgkJaWYoIWN1cnJlbnRJdGVtKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYodGhpcy5vcHRpb25zLmhhbmRsZSAmJiAhb3ZlcnJpZGVIYW5kbGUpIHsKCQkJJCh0aGlzLm9wdGlvbnMuaGFuZGxlLCBjdXJyZW50SXRlbSkuZmluZCgiKiIpLmFkZEJhY2soKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJaWYodGhpcyA9PT0gZXZlbnQudGFyZ2V0KSB7CgkJCQkJdmFsaWRIYW5kbGUgPSB0cnVlOwoJCQkJfQoJCQl9KTsKCQkJaWYoIXZhbGlkSGFuZGxlKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgoJCXRoaXMuY3VycmVudEl0ZW0gPSBjdXJyZW50SXRlbTsKCQl0aGlzLl9yZW1vdmVDdXJyZW50c0Zyb21JdGVtcygpOwoJCXJldHVybiB0cnVlOwoKCX0sCgoJX21vdXNlU3RhcnQ6IGZ1bmN0aW9uKGV2ZW50LCBvdmVycmlkZUhhbmRsZSwgbm9BY3RpdmF0aW9uKSB7CgoJCXZhciBpLCBib2R5LAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLmN1cnJlbnRDb250YWluZXIgPSB0aGlzOwoKCQkvL1dlIG9ubHkgbmVlZCB0byBjYWxsIHJlZnJlc2hQb3NpdGlvbnMsIGJlY2F1c2UgdGhlIHJlZnJlc2hJdGVtcyBjYWxsIGhhcyBiZWVuIG1vdmVkIHRvIG1vdXNlQ2FwdHVyZQoJCXRoaXMucmVmcmVzaFBvc2l0aW9ucygpOwoKCQkvL0NyZWF0ZSBhbmQgYXBwZW5kIHRoZSB2aXNpYmxlIGhlbHBlcgoJCXRoaXMuaGVscGVyID0gdGhpcy5fY3JlYXRlSGVscGVyKGV2ZW50KTsKCgkJLy9DYWNoZSB0aGUgaGVscGVyIHNpemUKCQl0aGlzLl9jYWNoZUhlbHBlclByb3BvcnRpb25zKCk7CgoJCS8qCgkJICogLSBQb3NpdGlvbiBnZW5lcmF0aW9uIC0KCQkgKiBUaGlzIGJsb2NrIGdlbmVyYXRlcyBldmVyeXRoaW5nIHBvc2l0aW9uIHJlbGF0ZWQgLSBpdCdzIHRoZSBjb3JlIG9mIGRyYWdnYWJsZXMuCgkJICovCgoJCS8vQ2FjaGUgdGhlIG1hcmdpbnMgb2YgdGhlIG9yaWdpbmFsIGVsZW1lbnQKCQl0aGlzLl9jYWNoZU1hcmdpbnMoKTsKCgkJLy9HZXQgdGhlIG5leHQgc2Nyb2xsaW5nIHBhcmVudAoJCXRoaXMuc2Nyb2xsUGFyZW50ID0gdGhpcy5oZWxwZXIuc2Nyb2xsUGFyZW50KCk7CgoJCS8vVGhlIGVsZW1lbnQncyBhYnNvbHV0ZSBwb3NpdGlvbiBvbiB0aGUgcGFnZSBtaW51cyBtYXJnaW5zCgkJdGhpcy5vZmZzZXQgPSB0aGlzLmN1cnJlbnRJdGVtLm9mZnNldCgpOwoJCXRoaXMub2Zmc2V0ID0gewoJCQl0b3A6IHRoaXMub2Zmc2V0LnRvcCAtIHRoaXMubWFyZ2lucy50b3AsCgkJCWxlZnQ6IHRoaXMub2Zmc2V0LmxlZnQgLSB0aGlzLm1hcmdpbnMubGVmdAoJCX07CgoJCSQuZXh0ZW5kKHRoaXMub2Zmc2V0LCB7CgkJCWNsaWNrOiB7IC8vV2hlcmUgdGhlIGNsaWNrIGhhcHBlbmVkLCByZWxhdGl2ZSB0byB0aGUgZWxlbWVudAoJCQkJbGVmdDogZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5sZWZ0LAoJCQkJdG9wOiBldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LnRvcAoJCQl9LAoJCQlwYXJlbnQ6IHRoaXMuX2dldFBhcmVudE9mZnNldCgpLAoJCQlyZWxhdGl2ZTogdGhpcy5fZ2V0UmVsYXRpdmVPZmZzZXQoKSAvL1RoaXMgaXMgYSByZWxhdGl2ZSB0byBhYnNvbHV0ZSBwb3NpdGlvbiBtaW51cyB0aGUgYWN0dWFsIHBvc2l0aW9uIGNhbGN1bGF0aW9uIC0gb25seSB1c2VkIGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIGhlbHBlcgoJCX0pOwoKCQkvLyBPbmx5IGFmdGVyIHdlIGdvdCB0aGUgb2Zmc2V0LCB3ZSBjYW4gY2hhbmdlIHRoZSBoZWxwZXIncyBwb3NpdGlvbiB0byBhYnNvbHV0ZQoJCS8vIFRPRE86IFN0aWxsIG5lZWQgdG8gZmlndXJlIG91dCBhIHdheSB0byBtYWtlIHJlbGF0aXZlIHNvcnRpbmcgcG9zc2libGUKCQl0aGlzLmhlbHBlci5jc3MoInBvc2l0aW9uIiwgImFic29sdXRlIik7CgkJdGhpcy5jc3NQb3NpdGlvbiA9IHRoaXMuaGVscGVyLmNzcygicG9zaXRpb24iKTsKCgkJLy9HZW5lcmF0ZSB0aGUgb3JpZ2luYWwgcG9zaXRpb24KCQl0aGlzLm9yaWdpbmFsUG9zaXRpb24gPSB0aGlzLl9nZW5lcmF0ZVBvc2l0aW9uKGV2ZW50KTsKCQl0aGlzLm9yaWdpbmFsUGFnZVggPSBldmVudC5wYWdlWDsKCQl0aGlzLm9yaWdpbmFsUGFnZVkgPSBldmVudC5wYWdlWTsKCgkJLy9BZGp1c3QgdGhlIG1vdXNlIG9mZnNldCByZWxhdGl2ZSB0byB0aGUgaGVscGVyIGlmICJjdXJzb3JBdCIgaXMgc3VwcGxpZWQKCQkoby5jdXJzb3JBdCAmJiB0aGlzLl9hZGp1c3RPZmZzZXRGcm9tSGVscGVyKG8uY3Vyc29yQXQpKTsKCgkJLy9DYWNoZSB0aGUgZm9ybWVyIERPTSBwb3NpdGlvbgoJCXRoaXMuZG9tUG9zaXRpb24gPSB7IHByZXY6IHRoaXMuY3VycmVudEl0ZW0ucHJldigpWzBdLCBwYXJlbnQ6IHRoaXMuY3VycmVudEl0ZW0ucGFyZW50KClbMF0gfTsKCgkJLy9JZiB0aGUgaGVscGVyIGlzIG5vdCB0aGUgb3JpZ2luYWwsIGhpZGUgdGhlIG9yaWdpbmFsIHNvIGl0J3Mgbm90IHBsYXlpbmcgYW55IHJvbGUgZHVyaW5nIHRoZSBkcmFnLCB3b24ndCBjYXVzZSBhbnl0aGluZyBiYWQgdGhpcyB3YXkKCQlpZih0aGlzLmhlbHBlclswXSAhPT0gdGhpcy5jdXJyZW50SXRlbVswXSkgewoJCQl0aGlzLmN1cnJlbnRJdGVtLmhpZGUoKTsKCQl9CgoJCS8vQ3JlYXRlIHRoZSBwbGFjZWhvbGRlcgoJCXRoaXMuX2NyZWF0ZVBsYWNlaG9sZGVyKCk7CgoJCS8vU2V0IGEgY29udGFpbm1lbnQgaWYgZ2l2ZW4gaW4gdGhlIG9wdGlvbnMKCQlpZihvLmNvbnRhaW5tZW50KSB7CgkJCXRoaXMuX3NldENvbnRhaW5tZW50KCk7CgkJfQoKCQlpZiggby5jdXJzb3IgJiYgby5jdXJzb3IgIT09ICJhdXRvIiApIHsgLy8gY3Vyc29yIG9wdGlvbgoJCQlib2R5ID0gdGhpcy5kb2N1bWVudC5maW5kKCAiYm9keSIgKTsKCgkJCS8vIHN1cHBvcnQ6IElFCgkJCXRoaXMuc3RvcmVkQ3Vyc29yID0gYm9keS5jc3MoICJjdXJzb3IiICk7CgkJCWJvZHkuY3NzKCAiY3Vyc29yIiwgby5jdXJzb3IgKTsKCgkJCXRoaXMuc3RvcmVkU3R5bGVzaGVldCA9ICQoICI8c3R5bGU+KnsgY3Vyc29yOiAiK28uY3Vyc29yKyIgIWltcG9ydGFudDsgfTwvc3R5bGU+IiApLmFwcGVuZFRvKCBib2R5ICk7CgkJfQoKCQlpZihvLm9wYWNpdHkpIHsgLy8gb3BhY2l0eSBvcHRpb24KCQkJaWYgKHRoaXMuaGVscGVyLmNzcygib3BhY2l0eSIpKSB7CgkJCQl0aGlzLl9zdG9yZWRPcGFjaXR5ID0gdGhpcy5oZWxwZXIuY3NzKCJvcGFjaXR5Iik7CgkJCX0KCQkJdGhpcy5oZWxwZXIuY3NzKCJvcGFjaXR5Iiwgby5vcGFjaXR5KTsKCQl9CgoJCWlmKG8uekluZGV4KSB7IC8vIHpJbmRleCBvcHRpb24KCQkJaWYgKHRoaXMuaGVscGVyLmNzcygiekluZGV4IikpIHsKCQkJCXRoaXMuX3N0b3JlZFpJbmRleCA9IHRoaXMuaGVscGVyLmNzcygiekluZGV4Iik7CgkJCX0KCQkJdGhpcy5oZWxwZXIuY3NzKCJ6SW5kZXgiLCBvLnpJbmRleCk7CgkJfQoKCQkvL1ByZXBhcmUgc2Nyb2xsaW5nCgkJaWYodGhpcy5zY3JvbGxQYXJlbnRbMF0gIT09IGRvY3VtZW50ICYmIHRoaXMuc2Nyb2xsUGFyZW50WzBdLnRhZ05hbWUgIT09ICJIVE1MIikgewoJCQl0aGlzLm92ZXJmbG93T2Zmc2V0ID0gdGhpcy5zY3JvbGxQYXJlbnQub2Zmc2V0KCk7CgkJfQoKCQkvL0NhbGwgY2FsbGJhY2tzCgkJdGhpcy5fdHJpZ2dlcigic3RhcnQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkpOwoKCQkvL1JlY2FjaGUgdGhlIGhlbHBlciBzaXplCgkJaWYoIXRoaXMuX3ByZXNlcnZlSGVscGVyUHJvcG9ydGlvbnMpIHsKCQkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOwoJCX0KCgoJCS8vUG9zdCAiYWN0aXZhdGUiIGV2ZW50cyB0byBwb3NzaWJsZSBjb250YWluZXJzCgkJaWYoICFub0FjdGl2YXRpb24gKSB7CgkJCWZvciAoIGkgPSB0aGlzLmNvbnRhaW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCX0KCQl9CgoJCS8vUHJlcGFyZSBwb3NzaWJsZSBkcm9wcGFibGVzCgkJaWYoJC51aS5kZG1hbmFnZXIpIHsKCQkJJC51aS5kZG1hbmFnZXIuY3VycmVudCA9IHRoaXM7CgkJfQoKCQlpZiAoJC51aS5kZG1hbmFnZXIgJiYgIW8uZHJvcEJlaGF2aW91cikgewoJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyh0aGlzLCBldmVudCk7CgkJfQoKCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCgkJdGhpcy5oZWxwZXIuYWRkQ2xhc3MoInVpLXNvcnRhYmxlLWhlbHBlciIpOwoJCXRoaXMuX21vdXNlRHJhZyhldmVudCk7IC8vRXhlY3V0ZSB0aGUgZHJhZyBvbmNlIC0gdGhpcyBjYXVzZXMgdGhlIGhlbHBlciBub3QgdG8gYmUgdmlzaWJsZSBiZWZvcmUgZ2V0dGluZyBpdHMgY29ycmVjdCBwb3NpdGlvbgoJCXJldHVybiB0cnVlOwoKCX0sCgoJX21vdXNlRHJhZzogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgaSwgaXRlbSwgaXRlbUVsZW1lbnQsIGludGVyc2VjdGlvbiwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJc2Nyb2xsZWQgPSBmYWxzZTsKCgkJLy9Db21wdXRlIHRoZSBoZWxwZXJzIHBvc2l0aW9uCgkJdGhpcy5wb3NpdGlvbiA9IHRoaXMuX2dlbmVyYXRlUG9zaXRpb24oZXZlbnQpOwoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbygiYWJzb2x1dGUiKTsKCgkJaWYgKCF0aGlzLmxhc3RQb3NpdGlvbkFicykgewoJCQl0aGlzLmxhc3RQb3NpdGlvbkFicyA9IHRoaXMucG9zaXRpb25BYnM7CgkJfQoKCQkvL0RvIHNjcm9sbGluZwoJCWlmKHRoaXMub3B0aW9ucy5zY3JvbGwpIHsKCQkJaWYodGhpcy5zY3JvbGxQYXJlbnRbMF0gIT09IGRvY3VtZW50ICYmIHRoaXMuc2Nyb2xsUGFyZW50WzBdLnRhZ05hbWUgIT09ICJIVE1MIikgewoKCQkJCWlmKCh0aGlzLm92ZXJmbG93T2Zmc2V0LnRvcCArIHRoaXMuc2Nyb2xsUGFyZW50WzBdLm9mZnNldEhlaWdodCkgLSBldmVudC5wYWdlWSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQl0aGlzLnNjcm9sbFBhcmVudFswXS5zY3JvbGxUb3AgPSBzY3JvbGxlZCA9IHRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcCArIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9IGVsc2UgaWYoZXZlbnQucGFnZVkgLSB0aGlzLm92ZXJmbG93T2Zmc2V0LnRvcCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQl0aGlzLnNjcm9sbFBhcmVudFswXS5zY3JvbGxUb3AgPSBzY3JvbGxlZCA9IHRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcCAtIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9CgoJCQkJaWYoKHRoaXMub3ZlcmZsb3dPZmZzZXQubGVmdCArIHRoaXMuc2Nyb2xsUGFyZW50WzBdLm9mZnNldFdpZHRoKSAtIGV2ZW50LnBhZ2VYIDwgby5zY3JvbGxTZW5zaXRpdml0eSkgewoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbExlZnQgPSBzY3JvbGxlZCA9IHRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbExlZnQgKyBvLnNjcm9sbFNwZWVkOwoJCQkJfSBlbHNlIGlmKGV2ZW50LnBhZ2VYIC0gdGhpcy5vdmVyZmxvd09mZnNldC5sZWZ0IDwgby5zY3JvbGxTZW5zaXRpdml0eSkgewoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbExlZnQgPSBzY3JvbGxlZCA9IHRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbExlZnQgLSBvLnNjcm9sbFNwZWVkOwoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQlpZihldmVudC5wYWdlWSAtICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpIDwgby5zY3JvbGxTZW5zaXRpdml0eSkgewoJCQkJCXNjcm9sbGVkID0gJChkb2N1bWVudCkuc2Nyb2xsVG9wKCQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpIC0gby5zY3JvbGxTcGVlZCk7CgkJCQl9IGVsc2UgaWYoJCh3aW5kb3cpLmhlaWdodCgpIC0gKGV2ZW50LnBhZ2VZIC0gJChkb2N1bWVudCkuc2Nyb2xsVG9wKCkpIDwgby5zY3JvbGxTZW5zaXRpdml0eSkgewoJCQkJCXNjcm9sbGVkID0gJChkb2N1bWVudCkuc2Nyb2xsVG9wKCQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpICsgby5zY3JvbGxTcGVlZCk7CgkJCQl9CgoJCQkJaWYoZXZlbnQucGFnZVggLSAkKGRvY3VtZW50KS5zY3JvbGxMZWZ0KCkgPCBvLnNjcm9sbFNlbnNpdGl2aXR5KSB7CgkJCQkJc2Nyb2xsZWQgPSAkKGRvY3VtZW50KS5zY3JvbGxMZWZ0KCQoZG9jdW1lbnQpLnNjcm9sbExlZnQoKSAtIG8uc2Nyb2xsU3BlZWQpOwoJCQkJfSBlbHNlIGlmKCQod2luZG93KS53aWR0aCgpIC0gKGV2ZW50LnBhZ2VYIC0gJChkb2N1bWVudCkuc2Nyb2xsTGVmdCgpKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkpIHsKCQkJCQlzY3JvbGxlZCA9ICQoZG9jdW1lbnQpLnNjcm9sbExlZnQoJChkb2N1bWVudCkuc2Nyb2xsTGVmdCgpICsgby5zY3JvbGxTcGVlZCk7CgkJCQl9CgoJCQl9CgoJCQlpZihzY3JvbGxlZCAhPT0gZmFsc2UgJiYgJC51aS5kZG1hbmFnZXIgJiYgIW8uZHJvcEJlaGF2aW91cikgewoJCQkJJC51aS5kZG1hbmFnZXIucHJlcGFyZU9mZnNldHModGhpcywgZXZlbnQpOwoJCQl9CgkJfQoKCQkvL1JlZ2VuZXJhdGUgdGhlIGFic29sdXRlIHBvc2l0aW9uIHVzZWQgZm9yIHBvc2l0aW9uIGNoZWNrcwoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLl9jb252ZXJ0UG9zaXRpb25UbygiYWJzb2x1dGUiKTsKCgkJLy9TZXQgdGhlIGhlbHBlciBwb3NpdGlvbgoJCWlmKCF0aGlzLm9wdGlvbnMuYXhpcyB8fCB0aGlzLm9wdGlvbnMuYXhpcyAhPT0gInkiKSB7CgkJCXRoaXMuaGVscGVyWzBdLnN0eWxlLmxlZnQgPSB0aGlzLnBvc2l0aW9uLmxlZnQrInB4IjsKCQl9CgkJaWYoIXRoaXMub3B0aW9ucy5heGlzIHx8IHRoaXMub3B0aW9ucy5heGlzICE9PSAieCIpIHsKCQkJdGhpcy5oZWxwZXJbMF0uc3R5bGUudG9wID0gdGhpcy5wb3NpdGlvbi50b3ArInB4IjsKCQl9CgoJCS8vUmVhcnJhbmdlCgkJZm9yIChpID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoKCQkJLy9DYWNoZSB2YXJpYWJsZXMgYW5kIGludGVyc2VjdGlvbiwgY29udGludWUgaWYgbm8gaW50ZXJzZWN0aW9uCgkJCWl0ZW0gPSB0aGlzLml0ZW1zW2ldOwoJCQlpdGVtRWxlbWVudCA9IGl0ZW0uaXRlbVswXTsKCQkJaW50ZXJzZWN0aW9uID0gdGhpcy5faW50ZXJzZWN0c1dpdGhQb2ludGVyKGl0ZW0pOwoJCQlpZiAoIWludGVyc2VjdGlvbikgewoJCQkJY29udGludWU7CgkJCX0KCgkJCS8vIE9ubHkgcHV0IHRoZSBwbGFjZWhvbGRlciBpbnNpZGUgdGhlIGN1cnJlbnQgQ29udGFpbmVyLCBza2lwIGFsbAoJCQkvLyBpdGVtcyBmb3JtIG90aGVyIGNvbnRhaW5lcnMuIFRoaXMgd29ya3MgYmVjYXVzZSB3aGVuIG1vdmluZwoJCQkvLyBhbiBpdGVtIGZyb20gb25lIGNvbnRhaW5lciB0byBhbm90aGVyIHRoZQoJCQkvLyBjdXJyZW50Q29udGFpbmVyIGlzIHN3aXRjaGVkIGJlZm9yZSB0aGUgcGxhY2Vob2xkZXIgaXMgbW92ZWQuCgkJCS8vCgkJCS8vIFdpdGhvdXQgdGhpcyBtb3ZpbmcgaXRlbXMgaW4gInN1Yi1zb3J0YWJsZXMiIGNhbiBjYXVzZSB0aGUgcGxhY2Vob2xkZXIgdG8gaml0dGVyCgkJCS8vIGJlZXR3ZWVuIHRoZSBvdXRlciBhbmQgaW5uZXIgY29udGFpbmVyLgoJCQlpZiAoaXRlbS5pbnN0YW5jZSAhPT0gdGhpcy5jdXJyZW50Q29udGFpbmVyKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gY2Fubm90IGludGVyc2VjdCB3aXRoIGl0c2VsZgoJCQkvLyBubyB1c2VsZXNzIGFjdGlvbnMgdGhhdCBoYXZlIGJlZW4gZG9uZSBiZWZvcmUKCQkJLy8gbm8gYWN0aW9uIGlmIHRoZSBpdGVtIG1vdmVkIGlzIHRoZSBwYXJlbnQgb2YgdGhlIGl0ZW0gY2hlY2tlZAoJCQlpZiAoaXRlbUVsZW1lbnQgIT09IHRoaXMuY3VycmVudEl0ZW1bMF0gJiYKCQkJCXRoaXMucGxhY2Vob2xkZXJbaW50ZXJzZWN0aW9uID09PSAxID8gIm5leHQiIDogInByZXYiXSgpWzBdICE9PSBpdGVtRWxlbWVudCAmJgoJCQkJISQuY29udGFpbnModGhpcy5wbGFjZWhvbGRlclswXSwgaXRlbUVsZW1lbnQpICYmCgkJCQkodGhpcy5vcHRpb25zLnR5cGUgPT09ICJzZW1pLWR5bmFtaWMiID8gISQuY29udGFpbnModGhpcy5lbGVtZW50WzBdLCBpdGVtRWxlbWVudCkgOiB0cnVlKQoJCQkpIHsKCgkJCQl0aGlzLmRpcmVjdGlvbiA9IGludGVyc2VjdGlvbiA9PT0gMSA\/ICJkb3duIiA6ICJ1cCI7CgoJCQkJaWYgKHRoaXMub3B0aW9ucy50b2xlcmFuY2UgPT09ICJwb2ludGVyIiB8fCB0aGlzLl9pbnRlcnNlY3RzV2l0aFNpZGVzKGl0ZW0pKSB7CgkJCQkJdGhpcy5fcmVhcnJhbmdlKGV2ZW50LCBpdGVtKTsKCQkJCX0gZWxzZSB7CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJdGhpcy5fdHJpZ2dlcigiY2hhbmdlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQkvL1Bvc3QgZXZlbnRzIHRvIGNvbnRhaW5lcnMKCQl0aGlzLl9jb250YWN0Q29udGFpbmVycyhldmVudCk7CgoJCS8vSW50ZXJjb25uZWN0IHdpdGggZHJvcHBhYmxlcwoJCWlmKCQudWkuZGRtYW5hZ2VyKSB7CgkJCSQudWkuZGRtYW5hZ2VyLmRyYWcodGhpcywgZXZlbnQpOwoJCX0KCgkJLy9DYWxsIGNhbGxiYWNrcwoJCXRoaXMuX3RyaWdnZXIoInNvcnQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkpOwoKCQl0aGlzLmxhc3RQb3NpdGlvbkFicyA9IHRoaXMucG9zaXRpb25BYnM7CgkJcmV0dXJuIGZhbHNlOwoKCX0sCgoJX21vdXNlU3RvcDogZnVuY3Rpb24oZXZlbnQsIG5vUHJvcGFnYXRpb24pIHsKCgkJaWYoIWV2ZW50KSB7CgkJCXJldHVybjsKCQl9CgoJCS8vSWYgd2UgYXJlIHVzaW5nIGRyb3BwYWJsZXMsIGluZm9ybSB0aGUgbWFuYWdlciBhYm91dCB0aGUgZHJvcAoJCWlmICgkLnVpLmRkbWFuYWdlciAmJiAhdGhpcy5vcHRpb25zLmRyb3BCZWhhdmlvdXIpIHsKCQkJJC51aS5kZG1hbmFnZXIuZHJvcCh0aGlzLCBldmVudCk7CgkJfQoKCQlpZih0aGlzLm9wdGlvbnMucmV2ZXJ0KSB7CgkJCXZhciB0aGF0ID0gdGhpcywKCQkJCWN1ciA9IHRoaXMucGxhY2Vob2xkZXIub2Zmc2V0KCksCgkJCQlheGlzID0gdGhpcy5vcHRpb25zLmF4aXMsCgkJCQlhbmltYXRpb24gPSB7fTsKCgkJCWlmICggIWF4aXMgfHwgYXhpcyA9PT0gIngiICkgewoJCQkJYW5pbWF0aW9uLmxlZnQgPSBjdXIubGVmdCAtIHRoaXMub2Zmc2V0LnBhcmVudC5sZWZ0IC0gdGhpcy5tYXJnaW5zLmxlZnQgKyAodGhpcy5vZmZzZXRQYXJlbnRbMF0gPT09IGRvY3VtZW50LmJvZHkgPyAwIDogdGhpcy5vZmZzZXRQYXJlbnRbMF0uc2Nyb2xsTGVmdCk7CgkJCX0KCQkJaWYgKCAhYXhpcyB8fCBheGlzID09PSAieSIgKSB7CgkJCQlhbmltYXRpb24udG9wID0gY3VyLnRvcCAtIHRoaXMub2Zmc2V0LnBhcmVudC50b3AgLSB0aGlzLm1hcmdpbnMudG9wICsgKHRoaXMub2Zmc2V0UGFyZW50WzBdID09PSBkb2N1bWVudC5ib2R5ID8gMCA6IHRoaXMub2Zmc2V0UGFyZW50WzBdLnNjcm9sbFRvcCk7CgkJCX0KCQkJdGhpcy5yZXZlcnRpbmcgPSB0cnVlOwoJCQkkKHRoaXMuaGVscGVyKS5hbmltYXRlKCBhbmltYXRpb24sIHBhcnNlSW50KHRoaXMub3B0aW9ucy5yZXZlcnQsIDEwKSB8fCA1MDAsIGZ1bmN0aW9uKCkgewoJCQkJdGhhdC5fY2xlYXIoZXZlbnQpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLl9jbGVhcihldmVudCwgbm9Qcm9wYWdhdGlvbik7CgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCkgewoKCQlpZih0aGlzLmRyYWdnaW5nKSB7CgoJCQl0aGlzLl9tb3VzZVVwKHsgdGFyZ2V0OiBudWxsIH0pOwoKCQkJaWYodGhpcy5vcHRpb25zLmhlbHBlciA9PT0gIm9yaWdpbmFsIikgewoJCQkJdGhpcy5jdXJyZW50SXRlbS5jc3ModGhpcy5fc3RvcmVkQ1NTKS5yZW1vdmVDbGFzcygidWktc29ydGFibGUtaGVscGVyIik7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmN1cnJlbnRJdGVtLnNob3coKTsKCQkJfQoKCQkJLy9Qb3N0IGRlYWN0aXZhdGluZyBldmVudHMgdG8gY29udGFpbmVycwoJCQlmb3IgKHZhciBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKCQkJCXRoaXMuY29udGFpbmVyc1tpXS5fdHJpZ2dlcigiZGVhY3RpdmF0ZSIsIG51bGwsIHRoaXMuX3VpSGFzaCh0aGlzKSk7CgkJCQlpZih0aGlzLmNvbnRhaW5lcnNbaV0uY29udGFpbmVyQ2FjaGUub3ZlcikgewoJCQkJCXRoaXMuY29udGFpbmVyc1tpXS5fdHJpZ2dlcigib3V0IiwgbnVsbCwgdGhpcy5fdWlIYXNoKHRoaXMpKTsKCQkJCQl0aGlzLmNvbnRhaW5lcnNbaV0uY29udGFpbmVyQ2FjaGUub3ZlciA9IDA7CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5wbGFjZWhvbGRlcikgewoJCQkvLyQodGhpcy5wbGFjZWhvbGRlclswXSkucmVtb3ZlKCk7IHdvdWxkIGhhdmUgYmVlbiB0aGUgalF1ZXJ5IHdheSAtIHVuZm9ydHVuYXRlbHksIGl0IHVuYmluZHMgQUxMIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCBub2RlIQoJCQlpZih0aGlzLnBsYWNlaG9sZGVyWzBdLnBhcmVudE5vZGUpIHsKCQkJCXRoaXMucGxhY2Vob2xkZXJbMF0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLnBsYWNlaG9sZGVyWzBdKTsKCQkJfQoJCQlpZih0aGlzLm9wdGlvbnMuaGVscGVyICE9PSAib3JpZ2luYWwiICYmIHRoaXMuaGVscGVyICYmIHRoaXMuaGVscGVyWzBdLnBhcmVudE5vZGUpIHsKCQkJCXRoaXMuaGVscGVyLnJlbW92ZSgpOwoJCQl9CgoJCQkkLmV4dGVuZCh0aGlzLCB7CgkJCQloZWxwZXI6IG51bGwsCgkJCQlkcmFnZ2luZzogZmFsc2UsCgkJCQlyZXZlcnRpbmc6IGZhbHNlLAoJCQkJX25vRmluYWxTb3J0OiBudWxsCgkJCX0pOwoKCQkJaWYodGhpcy5kb21Qb3NpdGlvbi5wcmV2KSB7CgkJCQkkKHRoaXMuZG9tUG9zaXRpb24ucHJldikuYWZ0ZXIodGhpcy5jdXJyZW50SXRlbSk7CgkJCX0gZWxzZSB7CgkJCQkkKHRoaXMuZG9tUG9zaXRpb24ucGFyZW50KS5wcmVwZW5kKHRoaXMuY3VycmVudEl0ZW0pOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCXNlcmlhbGl6ZTogZnVuY3Rpb24obykgewoKCQl2YXIgaXRlbXMgPSB0aGlzLl9nZXRJdGVtc0FzalF1ZXJ5KG8gJiYgby5jb25uZWN0ZWQpLAoJCQlzdHIgPSBbXTsKCQlvID0gbyB8fCB7fTsKCgkJJChpdGVtcykuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIHJlcyA9ICgkKG8uaXRlbSB8fCB0aGlzKS5hdHRyKG8uYXR0cmlidXRlIHx8ICJpZCIpIHx8ICIiKS5tYXRjaChvLmV4cHJlc3Npb24gfHwgKC8oLispW1wtPV9dKC4rKS8pKTsKCQkJaWYgKHJlcykgewoJCQkJc3RyLnB1c2goKG8ua2V5IHx8IHJlc1sxXSsiW10iKSsiPSIrKG8ua2V5ICYmIG8uZXhwcmVzc2lvbiA\/IHJlc1sxXSA6IHJlc1syXSkpOwoJCQl9CgkJfSk7CgoJCWlmKCFzdHIubGVuZ3RoICYmIG8ua2V5KSB7CgkJCXN0ci5wdXNoKG8ua2V5ICsgIj0iKTsKCQl9CgoJCXJldHVybiBzdHIuam9pbigiJiIpOwoKCX0sCgoJdG9BcnJheTogZnVuY3Rpb24obykgewoKCQl2YXIgaXRlbXMgPSB0aGlzLl9nZXRJdGVtc0FzalF1ZXJ5KG8gJiYgby5jb25uZWN0ZWQpLAoJCQlyZXQgPSBbXTsKCgkJbyA9IG8gfHwge307CgoJCWl0ZW1zLmVhY2goZnVuY3Rpb24oKSB7IHJldC5wdXNoKCQoby5pdGVtIHx8IHRoaXMpLmF0dHIoby5hdHRyaWJ1dGUgfHwgImlkIikgfHwgIiIpOyB9KTsKCQlyZXR1cm4gcmV0OwoKCX0sCgoJLyogQmUgY2FyZWZ1bCB3aXRoIHRoZSBmb2xsb3dpbmcgY29yZSBmdW5jdGlvbnMgKi8KCV9pbnRlcnNlY3RzV2l0aDogZnVuY3Rpb24oaXRlbSkgewoKCQl2YXIgeDEgPSB0aGlzLnBvc2l0aW9uQWJzLmxlZnQsCgkJCXgyID0geDEgKyB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoLAoJCQl5MSA9IHRoaXMucG9zaXRpb25BYnMudG9wLAoJCQl5MiA9IHkxICsgdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQsCgkJCWwgPSBpdGVtLmxlZnQsCgkJCXIgPSBsICsgaXRlbS53aWR0aCwKCQkJdCA9IGl0ZW0udG9wLAoJCQliID0gdCArIGl0ZW0uaGVpZ2h0LAoJCQlkeUNsaWNrID0gdGhpcy5vZmZzZXQuY2xpY2sudG9wLAoJCQlkeENsaWNrID0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCwKCQkJaXNPdmVyRWxlbWVudEhlaWdodCA9ICggdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ4IiApIHx8ICggKCB5MSArIGR5Q2xpY2sgKSA+IHQgJiYgKCB5MSArIGR5Q2xpY2sgKSA8IGIgKSwKCQkJaXNPdmVyRWxlbWVudFdpZHRoID0gKCB0aGlzLm9wdGlvbnMuYXhpcyA9PT0gInkiICkgfHwgKCAoIHgxICsgZHhDbGljayApID4gbCAmJiAoIHgxICsgZHhDbGljayApIDwgciApLAoJCQlpc092ZXJFbGVtZW50ID0gaXNPdmVyRWxlbWVudEhlaWdodCAmJiBpc092ZXJFbGVtZW50V2lkdGg7CgoJCWlmICggdGhpcy5vcHRpb25zLnRvbGVyYW5jZSA9PT0gInBvaW50ZXIiIHx8CgkJCXRoaXMub3B0aW9ucy5mb3JjZVBvaW50ZXJGb3JDb250YWluZXJzIHx8CgkJCSh0aGlzLm9wdGlvbnMudG9sZXJhbmNlICE9PSAicG9pbnRlciIgJiYgdGhpcy5oZWxwZXJQcm9wb3J0aW9uc1t0aGlzLmZsb2F0aW5nID8gIndpZHRoIiA6ICJoZWlnaHQiXSA+IGl0ZW1bdGhpcy5mbG9hdGluZyA\/ICJ3aWR0aCIgOiAiaGVpZ2h0Il0pCgkJKSB7CgkJCXJldHVybiBpc092ZXJFbGVtZW50OwoJCX0gZWxzZSB7CgoJCQlyZXR1cm4gKGwgPCB4MSArICh0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC8gMikgJiYgLy8gUmlnaHQgSGFsZgoJCQkJeDIgLSAodGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAvIDIpIDwgciAmJiAvLyBMZWZ0IEhhbGYKCQkJCXQgPCB5MSArICh0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAvIDIpICYmIC8vIEJvdHRvbSBIYWxmCgkJCQl5MiAtICh0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAvIDIpIDwgYiApOyAvLyBUb3AgSGFsZgoKCQl9Cgl9LAoKCV9pbnRlcnNlY3RzV2l0aFBvaW50ZXI6IGZ1bmN0aW9uKGl0ZW0pIHsKCgkJdmFyIGlzT3ZlckVsZW1lbnRIZWlnaHQgPSAodGhpcy5vcHRpb25zLmF4aXMgPT09ICJ4IikgfHwgaXNPdmVyQXhpcyh0aGlzLnBvc2l0aW9uQWJzLnRvcCArIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCwgaXRlbS50b3AsIGl0ZW0uaGVpZ2h0KSwKCQkJaXNPdmVyRWxlbWVudFdpZHRoID0gKHRoaXMub3B0aW9ucy5heGlzID09PSAieSIpIHx8IGlzT3ZlckF4aXModGhpcy5wb3NpdGlvbkFicy5sZWZ0ICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdCwgaXRlbS5sZWZ0LCBpdGVtLndpZHRoKSwKCQkJaXNPdmVyRWxlbWVudCA9IGlzT3ZlckVsZW1lbnRIZWlnaHQgJiYgaXNPdmVyRWxlbWVudFdpZHRoLAoJCQl2ZXJ0aWNhbERpcmVjdGlvbiA9IHRoaXMuX2dldERyYWdWZXJ0aWNhbERpcmVjdGlvbigpLAoJCQlob3Jpem9udGFsRGlyZWN0aW9uID0gdGhpcy5fZ2V0RHJhZ0hvcml6b250YWxEaXJlY3Rpb24oKTsKCgkJaWYgKCFpc092ZXJFbGVtZW50KSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXJldHVybiB0aGlzLmZsb2F0aW5nID8KCQkJKCAoKGhvcml6b250YWxEaXJlY3Rpb24gJiYgaG9yaXpvbnRhbERpcmVjdGlvbiA9PT0gInJpZ2h0IikgfHwgdmVydGljYWxEaXJlY3Rpb24gPT09ICJkb3duIikgPyAyIDogMSApCgkJCTogKCB2ZXJ0aWNhbERpcmVjdGlvbiAmJiAodmVydGljYWxEaXJlY3Rpb24gPT09ICJkb3duIiA\/IDIgOiAxKSApOwoKCX0sCgoJX2ludGVyc2VjdHNXaXRoU2lkZXM6IGZ1bmN0aW9uKGl0ZW0pIHsKCgkJdmFyIGlzT3ZlckJvdHRvbUhhbGYgPSBpc092ZXJBeGlzKHRoaXMucG9zaXRpb25BYnMudG9wICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wLCBpdGVtLnRvcCArIChpdGVtLmhlaWdodC8yKSwgaXRlbS5oZWlnaHQpLAoJCQlpc092ZXJSaWdodEhhbGYgPSBpc092ZXJBeGlzKHRoaXMucG9zaXRpb25BYnMubGVmdCArIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQsIGl0ZW0ubGVmdCArIChpdGVtLndpZHRoLzIpLCBpdGVtLndpZHRoKSwKCQkJdmVydGljYWxEaXJlY3Rpb24gPSB0aGlzLl9nZXREcmFnVmVydGljYWxEaXJlY3Rpb24oKSwKCQkJaG9yaXpvbnRhbERpcmVjdGlvbiA9IHRoaXMuX2dldERyYWdIb3Jpem9udGFsRGlyZWN0aW9uKCk7CgoJCWlmICh0aGlzLmZsb2F0aW5nICYmIGhvcml6b250YWxEaXJlY3Rpb24pIHsKCQkJcmV0dXJuICgoaG9yaXpvbnRhbERpcmVjdGlvbiA9PT0gInJpZ2h0IiAmJiBpc092ZXJSaWdodEhhbGYpIHx8IChob3Jpem9udGFsRGlyZWN0aW9uID09PSAibGVmdCIgJiYgIWlzT3ZlclJpZ2h0SGFsZikpOwoJCX0gZWxzZSB7CgkJCXJldHVybiB2ZXJ0aWNhbERpcmVjdGlvbiAmJiAoKHZlcnRpY2FsRGlyZWN0aW9uID09PSAiZG93biIgJiYgaXNPdmVyQm90dG9tSGFsZikgfHwgKHZlcnRpY2FsRGlyZWN0aW9uID09PSAidXAiICYmICFpc092ZXJCb3R0b21IYWxmKSk7CgkJfQoKCX0sCgoJX2dldERyYWdWZXJ0aWNhbERpcmVjdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGRlbHRhID0gdGhpcy5wb3NpdGlvbkFicy50b3AgLSB0aGlzLmxhc3RQb3NpdGlvbkFicy50b3A7CgkJcmV0dXJuIGRlbHRhICE9PSAwICYmIChkZWx0YSA+IDAgPyAiZG93biIgOiAidXAiKTsKCX0sCgoJX2dldERyYWdIb3Jpem9udGFsRGlyZWN0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgZGVsdGEgPSB0aGlzLnBvc2l0aW9uQWJzLmxlZnQgLSB0aGlzLmxhc3RQb3NpdGlvbkFicy5sZWZ0OwoJCXJldHVybiBkZWx0YSAhPT0gMCAmJiAoZGVsdGEgPiAwID8gInJpZ2h0IiA6ICJsZWZ0Iik7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKGV2ZW50KSB7CgkJdGhpcy5fcmVmcmVzaEl0ZW1zKGV2ZW50KTsKCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2Nvbm5lY3RXaXRoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQlyZXR1cm4gb3B0aW9ucy5jb25uZWN0V2l0aC5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nID8gW29wdGlvbnMuY29ubmVjdFdpdGhdIDogb3B0aW9ucy5jb25uZWN0V2l0aDsKCX0sCgoJX2dldEl0ZW1zQXNqUXVlcnk6IGZ1bmN0aW9uKGNvbm5lY3RlZCkgewoKCQl2YXIgaSwgaiwgY3VyLCBpbnN0LAoJCQlpdGVtcyA9IFtdLAoJCQlxdWVyaWVzID0gW10sCgkJCWNvbm5lY3RXaXRoID0gdGhpcy5fY29ubmVjdFdpdGgoKTsKCgkJaWYoY29ubmVjdFdpdGggJiYgY29ubmVjdGVkKSB7CgkJCWZvciAoaSA9IGNvbm5lY3RXaXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKCQkJCWN1ciA9ICQoY29ubmVjdFdpdGhbaV0pOwoJCQkJZm9yICggaiA9IGN1ci5sZW5ndGggLSAxOyBqID49IDA7IGotLSl7CgkJCQkJaW5zdCA9ICQuZGF0YShjdXJbal0sIHRoaXMud2lkZ2V0RnVsbE5hbWUpOwoJCQkJCWlmKGluc3QgJiYgaW5zdCAhPT0gdGhpcyAmJiAhaW5zdC5vcHRpb25zLmRpc2FibGVkKSB7CgkJCQkJCXF1ZXJpZXMucHVzaChbJC5pc0Z1bmN0aW9uKGluc3Qub3B0aW9ucy5pdGVtcykgPyBpbnN0Lm9wdGlvbnMuaXRlbXMuY2FsbChpbnN0LmVsZW1lbnQpIDogJChpbnN0Lm9wdGlvbnMuaXRlbXMsIGluc3QuZWxlbWVudCkubm90KCIudWktc29ydGFibGUtaGVscGVyIikubm90KCIudWktc29ydGFibGUtcGxhY2Vob2xkZXIiKSwgaW5zdF0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcXVlcmllcy5wdXNoKFskLmlzRnVuY3Rpb24odGhpcy5vcHRpb25zLml0ZW1zKSA\/IHRoaXMub3B0aW9ucy5pdGVtcy5jYWxsKHRoaXMuZWxlbWVudCwgbnVsbCwgeyBvcHRpb25zOiB0aGlzLm9wdGlvbnMsIGl0ZW06IHRoaXMuY3VycmVudEl0ZW0gfSkgOiAkKHRoaXMub3B0aW9ucy5pdGVtcywgdGhpcy5lbGVtZW50KS5ub3QoIi51aS1zb3J0YWJsZS1oZWxwZXIiKS5ub3QoIi51aS1zb3J0YWJsZS1wbGFjZWhvbGRlciIpLCB0aGlzXSk7CgoJCWZvciAoaSA9IHF1ZXJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewoJCQlxdWVyaWVzW2ldWzBdLmVhY2goZnVuY3Rpb24oKSB7CgkJCQlpdGVtcy5wdXNoKHRoaXMpOwoJCQl9KTsKCQl9CgoJCXJldHVybiAkKGl0ZW1zKTsKCgl9LAoKCV9yZW1vdmVDdXJyZW50c0Zyb21JdGVtczogZnVuY3Rpb24oKSB7CgoJCXZhciBsaXN0ID0gdGhpcy5jdXJyZW50SXRlbS5maW5kKCI6ZGF0YSgiICsgdGhpcy53aWRnZXROYW1lICsgIi1pdGVtKSIpOwoKCQl0aGlzLml0ZW1zID0gJC5ncmVwKHRoaXMuaXRlbXMsIGZ1bmN0aW9uIChpdGVtKSB7CgkJCWZvciAodmFyIGo9MDsgaiA8IGxpc3QubGVuZ3RoOyBqKyspIHsKCQkJCWlmKGxpc3Rbal0gPT09IGl0ZW0uaXRlbVswXSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9KTsKCgl9LAoKCV9yZWZyZXNoSXRlbXM6IGZ1bmN0aW9uKGV2ZW50KSB7CgoJCXRoaXMuaXRlbXMgPSBbXTsKCQl0aGlzLmNvbnRhaW5lcnMgPSBbdGhpc107CgoJCXZhciBpLCBqLCBjdXIsIGluc3QsIHRhcmdldERhdGEsIF9xdWVyaWVzLCBpdGVtLCBxdWVyaWVzTGVuZ3RoLAoJCQlpdGVtcyA9IHRoaXMuaXRlbXMsCgkJCXF1ZXJpZXMgPSBbWyQuaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMuaXRlbXMpID8gdGhpcy5vcHRpb25zLml0ZW1zLmNhbGwodGhpcy5lbGVtZW50WzBdLCBldmVudCwgeyBpdGVtOiB0aGlzLmN1cnJlbnRJdGVtIH0pIDogJCh0aGlzLm9wdGlvbnMuaXRlbXMsIHRoaXMuZWxlbWVudCksIHRoaXNdXSwKCQkJY29ubmVjdFdpdGggPSB0aGlzLl9jb25uZWN0V2l0aCgpOwoKCQlpZihjb25uZWN0V2l0aCAmJiB0aGlzLnJlYWR5KSB7IC8vU2hvdWxkbid0IGJlIHJ1biB0aGUgZmlyc3QgdGltZSB0aHJvdWdoIGR1ZSB0byBtYXNzaXZlIHNsb3ctZG93bgoJCQlmb3IgKGkgPSBjb25uZWN0V2l0aC5sZW5ndGggLSAxOyBpID49IDA7IGktLSl7CgkJCQljdXIgPSAkKGNvbm5lY3RXaXRoW2ldKTsKCQkJCWZvciAoaiA9IGN1ci5sZW5ndGggLSAxOyBqID49IDA7IGotLSl7CgkJCQkJaW5zdCA9ICQuZGF0YShjdXJbal0sIHRoaXMud2lkZ2V0RnVsbE5hbWUpOwoJCQkJCWlmKGluc3QgJiYgaW5zdCAhPT0gdGhpcyAmJiAhaW5zdC5vcHRpb25zLmRpc2FibGVkKSB7CgkJCQkJCXF1ZXJpZXMucHVzaChbJC5pc0Z1bmN0aW9uKGluc3Qub3B0aW9ucy5pdGVtcykgPyBpbnN0Lm9wdGlvbnMuaXRlbXMuY2FsbChpbnN0LmVsZW1lbnRbMF0sIGV2ZW50LCB7IGl0ZW06IHRoaXMuY3VycmVudEl0ZW0gfSkgOiAkKGluc3Qub3B0aW9ucy5pdGVtcywgaW5zdC5lbGVtZW50KSwgaW5zdF0pOwoJCQkJCQl0aGlzLmNvbnRhaW5lcnMucHVzaChpbnN0KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCWZvciAoaSA9IHF1ZXJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJdGFyZ2V0RGF0YSA9IHF1ZXJpZXNbaV1bMV07CgkJCV9xdWVyaWVzID0gcXVlcmllc1tpXVswXTsKCgkJCWZvciAoaj0wLCBxdWVyaWVzTGVuZ3RoID0gX3F1ZXJpZXMubGVuZ3RoOyBqIDwgcXVlcmllc0xlbmd0aDsgaisrKSB7CgkJCQlpdGVtID0gJChfcXVlcmllc1tqXSk7CgoJCQkJaXRlbS5kYXRhKHRoaXMud2lkZ2V0TmFtZSArICItaXRlbSIsIHRhcmdldERhdGEpOyAvLyBEYXRhIGZvciB0YXJnZXQgY2hlY2tpbmcgKG1vdXNlIG1hbmFnZXIpCgoJCQkJaXRlbXMucHVzaCh7CgkJCQkJaXRlbTogaXRlbSwKCQkJCQlpbnN0YW5jZTogdGFyZ2V0RGF0YSwKCQkJCQl3aWR0aDogMCwgaGVpZ2h0OiAwLAoJCQkJCWxlZnQ6IDAsIHRvcDogMAoJCQkJfSk7CgkJCX0KCQl9CgoJfSwKCglyZWZyZXNoUG9zaXRpb25zOiBmdW5jdGlvbihmYXN0KSB7CgoJCS8vVGhpcyBoYXMgdG8gYmUgcmVkb25lIGJlY2F1c2UgZHVlIHRvIHRoZSBpdGVtIGJlaW5nIG1vdmVkIG91dC9pbnRvIHRoZSBvZmZzZXRQYXJlbnQsIHRoZSBvZmZzZXRQYXJlbnQncyBwb3NpdGlvbiB3aWxsIGNoYW5nZQoJCWlmKHRoaXMub2Zmc2V0UGFyZW50ICYmIHRoaXMuaGVscGVyKSB7CgkJCXRoaXMub2Zmc2V0LnBhcmVudCA9IHRoaXMuX2dldFBhcmVudE9mZnNldCgpOwoJCX0KCgkJdmFyIGksIGl0ZW0sIHQsIHA7CgoJCWZvciAoaSA9IHRoaXMuaXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewoJCQlpdGVtID0gdGhpcy5pdGVtc1tpXTsKCgkJCS8vV2UgaWdub3JlIGNhbGN1bGF0aW5nIHBvc2l0aW9ucyBvZiBhbGwgY29ubmVjdGVkIGNvbnRhaW5lcnMgd2hlbiB3ZSdyZSBub3Qgb3ZlciB0aGVtCgkJCWlmKGl0ZW0uaW5zdGFuY2UgIT09IHRoaXMuY3VycmVudENvbnRhaW5lciAmJiB0aGlzLmN1cnJlbnRDb250YWluZXIgJiYgaXRlbS5pdGVtWzBdICE9PSB0aGlzLmN1cnJlbnRJdGVtWzBdKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJdCA9IHRoaXMub3B0aW9ucy50b2xlcmFuY2VFbGVtZW50ID8gJCh0aGlzLm9wdGlvbnMudG9sZXJhbmNlRWxlbWVudCwgaXRlbS5pdGVtKSA6IGl0ZW0uaXRlbTsKCgkJCWlmICghZmFzdCkgewoJCQkJaXRlbS53aWR0aCA9IHQub3V0ZXJXaWR0aCgpOwoJCQkJaXRlbS5oZWlnaHQgPSB0Lm91dGVySGVpZ2h0KCk7CgkJCX0KCgkJCXAgPSB0Lm9mZnNldCgpOwoJCQlpdGVtLmxlZnQgPSBwLmxlZnQ7CgkJCWl0ZW0udG9wID0gcC50b3A7CgkJfQoKCQlpZih0aGlzLm9wdGlvbnMuY3VzdG9tICYmIHRoaXMub3B0aW9ucy5jdXN0b20ucmVmcmVzaENvbnRhaW5lcnMpIHsKCQkJdGhpcy5vcHRpb25zLmN1c3RvbS5yZWZyZXNoQ29udGFpbmVycy5jYWxsKHRoaXMpOwoJCX0gZWxzZSB7CgkJCWZvciAoaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSl7CgkJCQlwID0gdGhpcy5jb250YWluZXJzW2ldLmVsZW1lbnQub2Zmc2V0KCk7CgkJCQl0aGlzLmNvbnRhaW5lcnNbaV0uY29udGFpbmVyQ2FjaGUubGVmdCA9IHAubGVmdDsKCQkJCXRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZS50b3AgPSBwLnRvcDsKCQkJCXRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZS53aWR0aAk9IHRoaXMuY29udGFpbmVyc1tpXS5lbGVtZW50Lm91dGVyV2lkdGgoKTsKCQkJCXRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZS5oZWlnaHQgPSB0aGlzLmNvbnRhaW5lcnNbaV0uZWxlbWVudC5vdXRlckhlaWdodCgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2NyZWF0ZVBsYWNlaG9sZGVyOiBmdW5jdGlvbih0aGF0KSB7CgkJdGhhdCA9IHRoYXQgfHwgdGhpczsKCQl2YXIgY2xhc3NOYW1lLAoJCQlvID0gdGhhdC5vcHRpb25zOwoKCQlpZighby5wbGFjZWhvbGRlciB8fCBvLnBsYWNlaG9sZGVyLmNvbnN0cnVjdG9yID09PSBTdHJpbmcpIHsKCQkJY2xhc3NOYW1lID0gby5wbGFjZWhvbGRlcjsKCQkJby5wbGFjZWhvbGRlciA9IHsKCQkJCWVsZW1lbnQ6IGZ1bmN0aW9uKCkgewoKCQkJCQl2YXIgbm9kZU5hbWUgPSB0aGF0LmN1cnJlbnRJdGVtWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJCWVsZW1lbnQgPSAkKCAiPCIgKyBub2RlTmFtZSArICI+IiwgdGhhdC5kb2N1bWVudFswXSApCgkJCQkJCQkuYWRkQ2xhc3MoY2xhc3NOYW1lIHx8IHRoYXQuY3VycmVudEl0ZW1bMF0uY2xhc3NOYW1lKyIgdWktc29ydGFibGUtcGxhY2Vob2xkZXIiKQoJCQkJCQkJLnJlbW92ZUNsYXNzKCJ1aS1zb3J0YWJsZS1oZWxwZXIiKTsKCgkJCQkJaWYgKCBub2RlTmFtZSA9PT0gInRyIiApIHsKCQkJCQkJdGhhdC5jdXJyZW50SXRlbS5jaGlsZHJlbigpLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQkkKCAiPHRkPiYjMTYwOzwvdGQ+IiwgdGhhdC5kb2N1bWVudFswXSApCgkJCQkJCQkJLmF0dHIoICJjb2xzcGFuIiwgJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApIHx8IDEgKQoJCQkJCQkJCS5hcHBlbmRUbyggZWxlbWVudCApOwoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImltZyIgKSB7CgkJCQkJCWVsZW1lbnQuYXR0ciggInNyYyIsIHRoYXQuY3VycmVudEl0ZW0uYXR0ciggInNyYyIgKSApOwoJCQkJCX0KCgkJCQkJaWYgKCAhY2xhc3NOYW1lICkgewoJCQkJCQllbGVtZW50LmNzcyggInZpc2liaWxpdHkiLCAiaGlkZGVuIiApOwoJCQkJCX0KCgkJCQkJcmV0dXJuIGVsZW1lbnQ7CgkJCQl9LAoJCQkJdXBkYXRlOiBmdW5jdGlvbihjb250YWluZXIsIHApIHsKCgkJCQkJLy8gMS4gSWYgYSBjbGFzc05hbWUgaXMgc2V0IGFzICdwbGFjZWhvbGRlciBvcHRpb24sIHdlIGRvbid0IGZvcmNlIHNpemVzIC0gdGhlIGNsYXNzIGlzIHJlc3BvbnNpYmxlIGZvciB0aGF0CgkJCQkJLy8gMi4gVGhlIG9wdGlvbiAnZm9yY2VQbGFjZWhvbGRlclNpemUgY2FuIGJlIGVuYWJsZWQgdG8gZm9yY2UgaXQgZXZlbiBpZiBhIGNsYXNzIG5hbWUgaXMgc3BlY2lmaWVkCgkJCQkJaWYoY2xhc3NOYW1lICYmICFvLmZvcmNlUGxhY2Vob2xkZXJTaXplKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCS8vSWYgdGhlIGVsZW1lbnQgZG9lc24ndCBoYXZlIGEgYWN0dWFsIGhlaWdodCBieSBpdHNlbGYgKHdpdGhvdXQgc3R5bGVzIGNvbWluZyBmcm9tIGEgc3R5bGVzaGVldCksIGl0IHJlY2VpdmVzIHRoZSBpbmxpbmUgaGVpZ2h0IGZyb20gdGhlIGRyYWdnZWQgaXRlbQoJCQkJCWlmKCFwLmhlaWdodCgpKSB7IHAuaGVpZ2h0KHRoYXQuY3VycmVudEl0ZW0uaW5uZXJIZWlnaHQoKSAtIHBhcnNlSW50KHRoYXQuY3VycmVudEl0ZW0uY3NzKCJwYWRkaW5nVG9wIil8fDAsIDEwKSAtIHBhcnNlSW50KHRoYXQuY3VycmVudEl0ZW0uY3NzKCJwYWRkaW5nQm90dG9tIil8fDAsIDEwKSk7IH0KCQkJCQlpZighcC53aWR0aCgpKSB7IHAud2lkdGgodGhhdC5jdXJyZW50SXRlbS5pbm5lcldpZHRoKCkgLSBwYXJzZUludCh0aGF0LmN1cnJlbnRJdGVtLmNzcygicGFkZGluZ0xlZnQiKXx8MCwgMTApIC0gcGFyc2VJbnQodGhhdC5jdXJyZW50SXRlbS5jc3MoInBhZGRpbmdSaWdodCIpfHwwLCAxMCkpOyB9CgkJCQl9CgkJCX07CgkJfQoKCQkvL0NyZWF0ZSB0aGUgcGxhY2Vob2xkZXIKCQl0aGF0LnBsYWNlaG9sZGVyID0gJChvLnBsYWNlaG9sZGVyLmVsZW1lbnQuY2FsbCh0aGF0LmVsZW1lbnQsIHRoYXQuY3VycmVudEl0ZW0pKTsKCgkJLy9BcHBlbmQgaXQgYWZ0ZXIgdGhlIGFjdHVhbCBjdXJyZW50IGl0ZW0KCQl0aGF0LmN1cnJlbnRJdGVtLmFmdGVyKHRoYXQucGxhY2Vob2xkZXIpOwoKCQkvL1VwZGF0ZSB0aGUgc2l6ZSBvZiB0aGUgcGxhY2Vob2xkZXIgKFRPRE86IExvZ2ljIHRvIGZ1enp5LCBzZWUgbGluZSAzMTYvMzE3KQoJCW8ucGxhY2Vob2xkZXIudXBkYXRlKHRoYXQsIHRoYXQucGxhY2Vob2xkZXIpOwoKCX0sCgoJX2NvbnRhY3RDb250YWluZXJzOiBmdW5jdGlvbihldmVudCkgewoJCXZhciBpLCBqLCBkaXN0LCBpdGVtV2l0aExlYXN0RGlzdGFuY2UsIHBvc1Byb3BlcnR5LCBzaXplUHJvcGVydHksIGJhc2UsIGN1ciwgbmVhckJvdHRvbSwgZmxvYXRpbmcsCgkJCWlubmVybW9zdENvbnRhaW5lciA9IG51bGwsCgkJCWlubmVybW9zdEluZGV4ID0gbnVsbDsKCgkJLy8gZ2V0IGlubmVybW9zdCBjb250YWluZXIgdGhhdCBpbnRlcnNlY3RzIHdpdGggaXRlbQoJCWZvciAoaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewoKCQkJLy8gbmV2ZXIgY29uc2lkZXIgYSBjb250YWluZXIgdGhhdCdzIGxvY2F0ZWQgd2l0aGluIHRoZSBpdGVtIGl0c2VsZgoJCQlpZigkLmNvbnRhaW5zKHRoaXMuY3VycmVudEl0ZW1bMF0sIHRoaXMuY29udGFpbmVyc1tpXS5lbGVtZW50WzBdKSkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCWlmKHRoaXMuX2ludGVyc2VjdHNXaXRoKHRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZSkpIHsKCgkJCQkvLyBpZiB3ZSd2ZSBhbHJlYWR5IGZvdW5kIGEgY29udGFpbmVyIGFuZCBpdCdzIG1vcmUgImlubmVyIiB0aGFuIHRoaXMsIHRoZW4gY29udGludWUKCQkJCWlmKGlubmVybW9zdENvbnRhaW5lciAmJiAkLmNvbnRhaW5zKHRoaXMuY29udGFpbmVyc1tpXS5lbGVtZW50WzBdLCBpbm5lcm1vc3RDb250YWluZXIuZWxlbWVudFswXSkpIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQlpbm5lcm1vc3RDb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcnNbaV07CgkJCQlpbm5lcm1vc3RJbmRleCA9IGk7CgoJCQl9IGVsc2UgewoJCQkJLy8gY29udGFpbmVyIGRvZXNuJ3QgaW50ZXJzZWN0LiB0cmlnZ2VyICJvdXQiIGV2ZW50IGlmIG5lY2Vzc2FyeQoJCQkJaWYodGhpcy5jb250YWluZXJzW2ldLmNvbnRhaW5lckNhY2hlLm92ZXIpIHsKCQkJCQl0aGlzLmNvbnRhaW5lcnNbaV0uX3RyaWdnZXIoIm91dCIsIGV2ZW50LCB0aGlzLl91aUhhc2godGhpcykpOwoJCQkJCXRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZS5vdmVyID0gMDsKCQkJCX0KCQkJfQoKCQl9CgoJCS8vIGlmIG5vIGludGVyc2VjdGluZyBjb250YWluZXJzIGZvdW5kLCByZXR1cm4KCQlpZighaW5uZXJtb3N0Q29udGFpbmVyKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIG1vdmUgdGhlIGl0ZW0gaW50byB0aGUgY29udGFpbmVyIGlmIGl0J3Mgbm90IHRoZXJlIGFscmVhZHkKCQlpZih0aGlzLmNvbnRhaW5lcnMubGVuZ3RoID09PSAxKSB7CgkJCWlmICghdGhpcy5jb250YWluZXJzW2lubmVybW9zdEluZGV4XS5jb250YWluZXJDYWNoZS5vdmVyKSB7CgkJCQl0aGlzLmNvbnRhaW5lcnNbaW5uZXJtb3N0SW5kZXhdLl90cmlnZ2VyKCJvdmVyIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCh0aGlzKSk7CgkJCQl0aGlzLmNvbnRhaW5lcnNbaW5uZXJtb3N0SW5kZXhdLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAxOwoJCQl9CgkJfSBlbHNlIHsKCgkJCS8vV2hlbiBlbnRlcmluZyBhIG5ldyBjb250YWluZXIsIHdlIHdpbGwgZmluZCB0aGUgaXRlbSB3aXRoIHRoZSBsZWFzdCBkaXN0YW5jZSBhbmQgYXBwZW5kIG91ciBpdGVtIG5lYXIgaXQKCQkJZGlzdCA9IDEwMDAwOwoJCQlpdGVtV2l0aExlYXN0RGlzdGFuY2UgPSBudWxsOwoJCQlmbG9hdGluZyA9IGlubmVybW9zdENvbnRhaW5lci5mbG9hdGluZyB8fCBpc0Zsb2F0aW5nKHRoaXMuY3VycmVudEl0ZW0pOwoJCQlwb3NQcm9wZXJ0eSA9IGZsb2F0aW5nID8gImxlZnQiIDogInRvcCI7CgkJCXNpemVQcm9wZXJ0eSA9IGZsb2F0aW5nID8gIndpZHRoIiA6ICJoZWlnaHQiOwoJCQliYXNlID0gdGhpcy5wb3NpdGlvbkFic1twb3NQcm9wZXJ0eV0gKyB0aGlzLm9mZnNldC5jbGlja1twb3NQcm9wZXJ0eV07CgkJCWZvciAoaiA9IHRoaXMuaXRlbXMubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0pIHsKCQkJCWlmKCEkLmNvbnRhaW5zKHRoaXMuY29udGFpbmVyc1tpbm5lcm1vc3RJbmRleF0uZWxlbWVudFswXSwgdGhpcy5pdGVtc1tqXS5pdGVtWzBdKSkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJaWYodGhpcy5pdGVtc1tqXS5pdGVtWzBdID09PSB0aGlzLmN1cnJlbnRJdGVtWzBdKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlpZiAoZmxvYXRpbmcgJiYgIWlzT3ZlckF4aXModGhpcy5wb3NpdGlvbkFicy50b3AgKyB0aGlzLm9mZnNldC5jbGljay50b3AsIHRoaXMuaXRlbXNbal0udG9wLCB0aGlzLml0ZW1zW2pdLmhlaWdodCkpIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCWN1ciA9IHRoaXMuaXRlbXNbal0uaXRlbS5vZmZzZXQoKVtwb3NQcm9wZXJ0eV07CgkJCQluZWFyQm90dG9tID0gZmFsc2U7CgkJCQlpZihNYXRoLmFicyhjdXIgLSBiYXNlKSA+IE1hdGguYWJzKGN1ciArIHRoaXMuaXRlbXNbal1bc2l6ZVByb3BlcnR5XSAtIGJhc2UpKXsKCQkJCQluZWFyQm90dG9tID0gdHJ1ZTsKCQkJCQljdXIgKz0gdGhpcy5pdGVtc1tqXVtzaXplUHJvcGVydHldOwoJCQkJfQoKCQkJCWlmKE1hdGguYWJzKGN1ciAtIGJhc2UpIDwgZGlzdCkgewoJCQkJCWRpc3QgPSBNYXRoLmFicyhjdXIgLSBiYXNlKTsgaXRlbVdpdGhMZWFzdERpc3RhbmNlID0gdGhpcy5pdGVtc1tqXTsKCQkJCQl0aGlzLmRpcmVjdGlvbiA9IG5lYXJCb3R0b20gPyAidXAiOiAiZG93biI7CgkJCQl9CgkJCX0KCgkJCS8vQ2hlY2sgaWYgZHJvcE9uRW1wdHkgaXMgZW5hYmxlZAoJCQlpZighaXRlbVdpdGhMZWFzdERpc3RhbmNlICYmICF0aGlzLm9wdGlvbnMuZHJvcE9uRW1wdHkpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYodGhpcy5jdXJyZW50Q29udGFpbmVyID09PSB0aGlzLmNvbnRhaW5lcnNbaW5uZXJtb3N0SW5kZXhdKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWl0ZW1XaXRoTGVhc3REaXN0YW5jZSA\/IHRoaXMuX3JlYXJyYW5nZShldmVudCwgaXRlbVdpdGhMZWFzdERpc3RhbmNlLCBudWxsLCB0cnVlKSA6IHRoaXMuX3JlYXJyYW5nZShldmVudCwgbnVsbCwgdGhpcy5jb250YWluZXJzW2lubmVybW9zdEluZGV4XS5lbGVtZW50LCB0cnVlKTsKCQkJdGhpcy5fdHJpZ2dlcigiY2hhbmdlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpKTsKCQkJdGhpcy5jb250YWluZXJzW2lubmVybW9zdEluZGV4XS5fdHJpZ2dlcigiY2hhbmdlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCh0aGlzKSk7CgkJCXRoaXMuY3VycmVudENvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyc1tpbm5lcm1vc3RJbmRleF07CgoJCQkvL1VwZGF0ZSB0aGUgcGxhY2Vob2xkZXIKCQkJdGhpcy5vcHRpb25zLnBsYWNlaG9sZGVyLnVwZGF0ZSh0aGlzLmN1cnJlbnRDb250YWluZXIsIHRoaXMucGxhY2Vob2xkZXIpOwoKCQkJdGhpcy5jb250YWluZXJzW2lubmVybW9zdEluZGV4XS5fdHJpZ2dlcigib3ZlciIsIGV2ZW50LCB0aGlzLl91aUhhc2godGhpcykpOwoJCQl0aGlzLmNvbnRhaW5lcnNbaW5uZXJtb3N0SW5kZXhdLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAxOwoJCX0KCgoJfSwKCglfY3JlYXRlSGVscGVyOiBmdW5jdGlvbihldmVudCkgewoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJaGVscGVyID0gJC5pc0Z1bmN0aW9uKG8uaGVscGVyKSA\/ICQoby5oZWxwZXIuYXBwbHkodGhpcy5lbGVtZW50WzBdLCBbZXZlbnQsIHRoaXMuY3VycmVudEl0ZW1dKSkgOiAoby5oZWxwZXIgPT09ICJjbG9uZSIgPyB0aGlzLmN1cnJlbnRJdGVtLmNsb25lKCkgOiB0aGlzLmN1cnJlbnRJdGVtKTsKCgkJLy9BZGQgdGhlIGhlbHBlciB0byB0aGUgRE9NIGlmIHRoYXQgZGlkbid0IGhhcHBlbiBhbHJlYWR5CgkJaWYoIWhlbHBlci5wYXJlbnRzKCJib2R5IikubGVuZ3RoKSB7CgkJCSQoby5hcHBlbmRUbyAhPT0gInBhcmVudCIgPyBvLmFwcGVuZFRvIDogdGhpcy5jdXJyZW50SXRlbVswXS5wYXJlbnROb2RlKVswXS5hcHBlbmRDaGlsZChoZWxwZXJbMF0pOwoJCX0KCgkJaWYoaGVscGVyWzBdID09PSB0aGlzLmN1cnJlbnRJdGVtWzBdKSB7CgkJCXRoaXMuX3N0b3JlZENTUyA9IHsgd2lkdGg6IHRoaXMuY3VycmVudEl0ZW1bMF0uc3R5bGUud2lkdGgsIGhlaWdodDogdGhpcy5jdXJyZW50SXRlbVswXS5zdHlsZS5oZWlnaHQsIHBvc2l0aW9uOiB0aGlzLmN1cnJlbnRJdGVtLmNzcygicG9zaXRpb24iKSwgdG9wOiB0aGlzLmN1cnJlbnRJdGVtLmNzcygidG9wIiksIGxlZnQ6IHRoaXMuY3VycmVudEl0ZW0uY3NzKCJsZWZ0IikgfTsKCQl9CgoJCWlmKCFoZWxwZXJbMF0uc3R5bGUud2lkdGggfHwgby5mb3JjZUhlbHBlclNpemUpIHsKCQkJaGVscGVyLndpZHRoKHRoaXMuY3VycmVudEl0ZW0ud2lkdGgoKSk7CgkJfQoJCWlmKCFoZWxwZXJbMF0uc3R5bGUuaGVpZ2h0IHx8IG8uZm9yY2VIZWxwZXJTaXplKSB7CgkJCWhlbHBlci5oZWlnaHQodGhpcy5jdXJyZW50SXRlbS5oZWlnaHQoKSk7CgkJfQoKCQlyZXR1cm4gaGVscGVyOwoKCX0sCgoJX2FkanVzdE9mZnNldEZyb21IZWxwZXI6IGZ1bmN0aW9uKG9iaikgewoJCWlmICh0eXBlb2Ygb2JqID09PSAic3RyaW5nIikgewoJCQlvYmogPSBvYmouc3BsaXQoIiAiKTsKCQl9CgkJaWYgKCQuaXNBcnJheShvYmopKSB7CgkJCW9iaiA9IHtsZWZ0OiArb2JqWzBdLCB0b3A6ICtvYmpbMV0gfHwgMH07CgkJfQoJCWlmICgibGVmdCIgaW4gb2JqKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPSBvYmoubGVmdCArIHRoaXMubWFyZ2lucy5sZWZ0OwoJCX0KCQlpZiAoInJpZ2h0IiBpbiBvYmopIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2subGVmdCA9IHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLSBvYmoucmlnaHQgKyB0aGlzLm1hcmdpbnMubGVmdDsKCQl9CgkJaWYgKCJ0b3AiIGluIG9iaikgewoJCQl0aGlzLm9mZnNldC5jbGljay50b3AgPSBvYmoudG9wICsgdGhpcy5tYXJnaW5zLnRvcDsKCQl9CgkJaWYgKCJib3R0b20iIGluIG9iaikgewoJCQl0aGlzLm9mZnNldC5jbGljay50b3AgPSB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIG9iai5ib3R0b20gKyB0aGlzLm1hcmdpbnMudG9wOwoJCX0KCX0sCgoJX2dldFBhcmVudE9mZnNldDogZnVuY3Rpb24oKSB7CgoKCQkvL0dldCB0aGUgb2Zmc2V0UGFyZW50IGFuZCBjYWNoZSBpdHMgcG9zaXRpb24KCQl0aGlzLm9mZnNldFBhcmVudCA9IHRoaXMuaGVscGVyLm9mZnNldFBhcmVudCgpOwoJCXZhciBwbyA9IHRoaXMub2Zmc2V0UGFyZW50Lm9mZnNldCgpOwoKCQkvLyBUaGlzIGlzIGEgc3BlY2lhbCBjYXNlIHdoZXJlIHdlIG5lZWQgdG8gbW9kaWZ5IGEgb2Zmc2V0IGNhbGN1bGF0ZWQgb24gc3RhcnQsIHNpbmNlIHRoZSBmb2xsb3dpbmcgaGFwcGVuZWQ6CgkJLy8gMS4gVGhlIHBvc2l0aW9uIG9mIHRoZSBoZWxwZXIgaXMgYWJzb2x1dGUsIHNvIGl0J3MgcG9zaXRpb24gaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiB0aGUgbmV4dCBwb3NpdGlvbmVkIHBhcmVudAoJCS8vIDIuIFRoZSBhY3R1YWwgb2Zmc2V0IHBhcmVudCBpcyBhIGNoaWxkIG9mIHRoZSBzY3JvbGwgcGFyZW50LCBhbmQgdGhlIHNjcm9sbCBwYXJlbnQgaXNuJ3QgdGhlIGRvY3VtZW50LCB3aGljaCBtZWFucyB0aGF0CgkJLy8gICAgdGhlIHNjcm9sbCBpcyBpbmNsdWRlZCBpbiB0aGUgaW5pdGlhbCBjYWxjdWxhdGlvbiBvZiB0aGUgb2Zmc2V0IG9mIHRoZSBwYXJlbnQsIGFuZCBuZXZlciByZWNhbGN1bGF0ZWQgdXBvbiBkcmFnCgkJaWYodGhpcy5jc3NQb3NpdGlvbiA9PT0gImFic29sdXRlIiAmJiB0aGlzLnNjcm9sbFBhcmVudFswXSAhPT0gZG9jdW1lbnQgJiYgJC5jb250YWlucyh0aGlzLnNjcm9sbFBhcmVudFswXSwgdGhpcy5vZmZzZXRQYXJlbnRbMF0pKSB7CgkJCXBvLmxlZnQgKz0gdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCgpOwoJCQlwby50b3AgKz0gdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCk7CgkJfQoKCQkvLyBUaGlzIG5lZWRzIHRvIGJlIGFjdHVhbGx5IGRvbmUgZm9yIGFsbCBicm93c2Vycywgc2luY2UgcGFnZVgvcGFnZVkgaW5jbHVkZXMgdGhpcyBpbmZvcm1hdGlvbgoJCS8vIHdpdGggYW4gdWdseSBJRSBmaXgKCQlpZiggdGhpcy5vZmZzZXRQYXJlbnRbMF0gPT09IGRvY3VtZW50LmJvZHkgfHwgKHRoaXMub2Zmc2V0UGFyZW50WzBdLnRhZ05hbWUgJiYgdGhpcy5vZmZzZXRQYXJlbnRbMF0udGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaHRtbCIgJiYgJC51aS5pZSkpIHsKCQkJcG8gPSB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgkJcmV0dXJuIHsKCQkJdG9wOiBwby50b3AgKyAocGFyc2VJbnQodGhpcy5vZmZzZXRQYXJlbnQuY3NzKCJib3JkZXJUb3BXaWR0aCIpLDEwKSB8fCAwKSwKCQkJbGVmdDogcG8ubGVmdCArIChwYXJzZUludCh0aGlzLm9mZnNldFBhcmVudC5jc3MoImJvcmRlckxlZnRXaWR0aCIpLDEwKSB8fCAwKQoJCX07CgoJfSwKCglfZ2V0UmVsYXRpdmVPZmZzZXQ6IGZ1bmN0aW9uKCkgewoKCQlpZih0aGlzLmNzc1Bvc2l0aW9uID09PSAicmVsYXRpdmUiKSB7CgkJCXZhciBwID0gdGhpcy5jdXJyZW50SXRlbS5wb3NpdGlvbigpOwoJCQlyZXR1cm4gewoJCQkJdG9wOiBwLnRvcCAtIChwYXJzZUludCh0aGlzLmhlbHBlci5jc3MoInRvcCIpLDEwKSB8fCAwKSArIHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpLAoJCQkJbGVmdDogcC5sZWZ0IC0gKHBhcnNlSW50KHRoaXMuaGVscGVyLmNzcygibGVmdCIpLDEwKSB8fCAwKSArIHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldHVybiB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgl9LAoKCV9jYWNoZU1hcmdpbnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMubWFyZ2lucyA9IHsKCQkJbGVmdDogKHBhcnNlSW50KHRoaXMuY3VycmVudEl0ZW0uY3NzKCJtYXJnaW5MZWZ0IiksMTApIHx8IDApLAoJCQl0b3A6IChwYXJzZUludCh0aGlzLmN1cnJlbnRJdGVtLmNzcygibWFyZ2luVG9wIiksMTApIHx8IDApCgkJfTsKCX0sCgoJX2NhY2hlSGVscGVyUHJvcG9ydGlvbnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMgPSB7CgkJCXdpZHRoOiB0aGlzLmhlbHBlci5vdXRlcldpZHRoKCksCgkJCWhlaWdodDogdGhpcy5oZWxwZXIub3V0ZXJIZWlnaHQoKQoJCX07Cgl9LAoKCV9zZXRDb250YWlubWVudDogZnVuY3Rpb24oKSB7CgoJCXZhciBjZSwgY28sIG92ZXIsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgkJaWYoby5jb250YWlubWVudCA9PT0gInBhcmVudCIpIHsKCQkJby5jb250YWlubWVudCA9IHRoaXMuaGVscGVyWzBdLnBhcmVudE5vZGU7CgkJfQoJCWlmKG8uY29udGFpbm1lbnQgPT09ICJkb2N1bWVudCIgfHwgby5jb250YWlubWVudCA9PT0gIndpbmRvdyIpIHsKCQkJdGhpcy5jb250YWlubWVudCA9IFsKCQkJCTAgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQsCgkJCQkwIC0gdGhpcy5vZmZzZXQucmVsYXRpdmUudG9wIC0gdGhpcy5vZmZzZXQucGFyZW50LnRvcCwKCQkJCSQoby5jb250YWlubWVudCA9PT0gImRvY3VtZW50IiA\/IGRvY3VtZW50IDogd2luZG93KS53aWR0aCgpIC0gdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJKCQoby5jb250YWlubWVudCA9PT0gImRvY3VtZW50IiA\/IGRvY3VtZW50IDogd2luZG93KS5oZWlnaHQoKSB8fCBkb2N1bWVudC5ib2R5LnBhcmVudE5vZGUuc2Nyb2xsSGVpZ2h0KSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcAoJCQldOwoJCX0KCgkJaWYoISgvXihkb2N1bWVudHx3aW5kb3d8cGFyZW50KSQvKS50ZXN0KG8uY29udGFpbm1lbnQpKSB7CgkJCWNlID0gJChvLmNvbnRhaW5tZW50KVswXTsKCQkJY28gPSAkKG8uY29udGFpbm1lbnQpLm9mZnNldCgpOwoJCQlvdmVyID0gKCQoY2UpLmNzcygib3ZlcmZsb3ciKSAhPT0gImhpZGRlbiIpOwoKCQkJdGhpcy5jb250YWlubWVudCA9IFsKCQkJCWNvLmxlZnQgKyAocGFyc2VJbnQoJChjZSkuY3NzKCJib3JkZXJMZWZ0V2lkdGgiKSwxMCkgfHwgMCkgKyAocGFyc2VJbnQoJChjZSkuY3NzKCJwYWRkaW5nTGVmdCIpLDEwKSB8fCAwKSAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJY28udG9wICsgKHBhcnNlSW50KCQoY2UpLmNzcygiYm9yZGVyVG9wV2lkdGgiKSwxMCkgfHwgMCkgKyAocGFyc2VJbnQoJChjZSkuY3NzKCJwYWRkaW5nVG9wIiksMTApIHx8IDApIC0gdGhpcy5tYXJnaW5zLnRvcCwKCQkJCWNvLmxlZnQrKG92ZXIgPyBNYXRoLm1heChjZS5zY3JvbGxXaWR0aCxjZS5vZmZzZXRXaWR0aCkgOiBjZS5vZmZzZXRXaWR0aCkgLSAocGFyc2VJbnQoJChjZSkuY3NzKCJib3JkZXJMZWZ0V2lkdGgiKSwxMCkgfHwgMCkgLSAocGFyc2VJbnQoJChjZSkuY3NzKCJwYWRkaW5nUmlnaHQiKSwxMCkgfHwgMCkgLSB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gdGhpcy5tYXJnaW5zLmxlZnQsCgkJCQljby50b3ArKG92ZXIgPyBNYXRoLm1heChjZS5zY3JvbGxIZWlnaHQsY2Uub2Zmc2V0SGVpZ2h0KSA6IGNlLm9mZnNldEhlaWdodCkgLSAocGFyc2VJbnQoJChjZSkuY3NzKCJib3JkZXJUb3BXaWR0aCIpLDEwKSB8fCAwKSAtIChwYXJzZUludCgkKGNlKS5jc3MoInBhZGRpbmdCb3R0b20iKSwxMCkgfHwgMCkgLSB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIHRoaXMubWFyZ2lucy50b3AKCQkJXTsKCQl9CgoJfSwKCglfY29udmVydFBvc2l0aW9uVG86IGZ1bmN0aW9uKGQsIHBvcykgewoKCQlpZighcG9zKSB7CgkJCXBvcyA9IHRoaXMucG9zaXRpb247CgkJfQoJCXZhciBtb2QgPSBkID09PSAiYWJzb2x1dGUiID8gMSA6IC0xLAoJCQlzY3JvbGwgPSB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmICEodGhpcy5zY3JvbGxQYXJlbnRbMF0gIT09IGRvY3VtZW50ICYmICQuY29udGFpbnModGhpcy5zY3JvbGxQYXJlbnRbMF0sIHRoaXMub2Zmc2V0UGFyZW50WzBdKSkgPyB0aGlzLm9mZnNldFBhcmVudCA6IHRoaXMuc2Nyb2xsUGFyZW50LAoJCQlzY3JvbGxJc1Jvb3ROb2RlID0gKC8oaHRtbHxib2R5KS9pKS50ZXN0KHNjcm9sbFswXS50YWdOYW1lKTsKCgkJcmV0dXJuIHsKCQkJdG9wOiAoCgkJCQlwb3MudG9wCSsJCQkJCQkJCQkJCQkJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgKiBtb2QgKwkJCQkJCQkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC50b3AgKiBtb2QgLQkJCQkJCQkJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCSggKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8gLXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpIDogKCBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHNjcm9sbC5zY3JvbGxUb3AoKSApICkgKiBtb2QpCgkJCSksCgkJCWxlZnQ6ICgKCQkJCXBvcy5sZWZ0ICsJCQkJCQkJCQkJCQkJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0ICogbW9kICsJCQkJCQkJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5wYXJlbnQubGVmdCAqIG1vZAktCQkJCQkJCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/IC10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkgOiBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHNjcm9sbC5zY3JvbGxMZWZ0KCkgKSAqIG1vZCkKCQkJKQoJCX07CgoJfSwKCglfZ2VuZXJhdGVQb3NpdGlvbjogZnVuY3Rpb24oZXZlbnQpIHsKCgkJdmFyIHRvcCwgbGVmdCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJcGFnZVggPSBldmVudC5wYWdlWCwKCQkJcGFnZVkgPSBldmVudC5wYWdlWSwKCQkJc2Nyb2xsID0gdGhpcy5jc3NQb3NpdGlvbiA9PT0gImFic29sdXRlIiAmJiAhKHRoaXMuc2Nyb2xsUGFyZW50WzBdICE9PSBkb2N1bWVudCAmJiAkLmNvbnRhaW5zKHRoaXMuc2Nyb2xsUGFyZW50WzBdLCB0aGlzLm9mZnNldFBhcmVudFswXSkpID8gdGhpcy5vZmZzZXRQYXJlbnQgOiB0aGlzLnNjcm9sbFBhcmVudCwgc2Nyb2xsSXNSb290Tm9kZSA9ICgvKGh0bWx8Ym9keSkvaSkudGVzdChzY3JvbGxbMF0udGFnTmFtZSk7CgoJCS8vIFRoaXMgaXMgYW5vdGhlciB2ZXJ5IHdlaXJkIHNwZWNpYWwgY2FzZSB0aGF0IG9ubHkgaGFwcGVucyBmb3IgcmVsYXRpdmUgZWxlbWVudHM6CgkJLy8gMS4gSWYgdGhlIGNzcyBwb3NpdGlvbiBpcyByZWxhdGl2ZQoJCS8vIDIuIGFuZCB0aGUgc2Nyb2xsIHBhcmVudCBpcyB0aGUgZG9jdW1lbnQgb3Igc2ltaWxhciB0byB0aGUgb2Zmc2V0IHBhcmVudAoJCS8vIHdlIGhhdmUgdG8gcmVmcmVzaCB0aGUgcmVsYXRpdmUgb2Zmc2V0IGR1cmluZyB0aGUgc2Nyb2xsIHNvIHRoZXJlIGFyZSBubyBqdW1wcwoJCWlmKHRoaXMuY3NzUG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgJiYgISh0aGlzLnNjcm9sbFBhcmVudFswXSAhPT0gZG9jdW1lbnQgJiYgdGhpcy5zY3JvbGxQYXJlbnRbMF0gIT09IHRoaXMub2Zmc2V0UGFyZW50WzBdKSkgewoJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZSA9IHRoaXMuX2dldFJlbGF0aXZlT2Zmc2V0KCk7CgkJfQoKCQkvKgoJCSAqIC0gUG9zaXRpb24gY29uc3RyYWluaW5nIC0KCQkgKiBDb25zdHJhaW4gdGhlIHBvc2l0aW9uIHRvIGEgbWl4IG9mIGdyaWQsIGNvbnRhaW5tZW50LgoJCSAqLwoKCQlpZih0aGlzLm9yaWdpbmFsUG9zaXRpb24pIHsgLy9JZiB3ZSBhcmUgbm90IGRyYWdnaW5nIHlldCwgd2Ugd29uJ3QgY2hlY2sgZm9yIG9wdGlvbnMKCgkJCWlmKHRoaXMuY29udGFpbm1lbnQpIHsKCQkJCWlmKGV2ZW50LnBhZ2VYIC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA8IHRoaXMuY29udGFpbm1lbnRbMF0pIHsKCQkJCQlwYWdlWCA9IHRoaXMuY29udGFpbm1lbnRbMF0gKyB0aGlzLm9mZnNldC5jbGljay5sZWZ0OwoJCQkJfQoJCQkJaWYoZXZlbnQucGFnZVkgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPCB0aGlzLmNvbnRhaW5tZW50WzFdKSB7CgkJCQkJcGFnZVkgPSB0aGlzLmNvbnRhaW5tZW50WzFdICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wOwoJCQkJfQoJCQkJaWYoZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID4gdGhpcy5jb250YWlubWVudFsyXSkgewoJCQkJCXBhZ2VYID0gdGhpcy5jb250YWlubWVudFsyXSArIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQ7CgkJCQl9CgkJCQlpZihldmVudC5wYWdlWSAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA+IHRoaXMuY29udGFpbm1lbnRbM10pIHsKCQkJCQlwYWdlWSA9IHRoaXMuY29udGFpbm1lbnRbM10gKyB0aGlzLm9mZnNldC5jbGljay50b3A7CgkJCQl9CgkJCX0KCgkJCWlmKG8uZ3JpZCkgewoJCQkJdG9wID0gdGhpcy5vcmlnaW5hbFBhZ2VZICsgTWF0aC5yb3VuZCgocGFnZVkgLSB0aGlzLm9yaWdpbmFsUGFnZVkpIC8gby5ncmlkWzFdKSAqIG8uZ3JpZFsxXTsKCQkJCXBhZ2VZID0gdGhpcy5jb250YWlubWVudCA\/ICggKHRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA+PSB0aGlzLmNvbnRhaW5tZW50WzFdICYmIHRvcCAtIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCA8PSB0aGlzLmNvbnRhaW5tZW50WzNdKSA\/IHRvcCA6ICgodG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID49IHRoaXMuY29udGFpbm1lbnRbMV0pID8gdG9wIC0gby5ncmlkWzFdIDogdG9wICsgby5ncmlkWzFdKSkgOiB0b3A7CgoJCQkJbGVmdCA9IHRoaXMub3JpZ2luYWxQYWdlWCArIE1hdGgucm91bmQoKHBhZ2VYIC0gdGhpcy5vcmlnaW5hbFBhZ2VYKSAvIG8uZ3JpZFswXSkgKiBvLmdyaWRbMF07CgkJCQlwYWdlWCA9IHRoaXMuY29udGFpbm1lbnQgPyAoIChsZWZ0IC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+PSB0aGlzLmNvbnRhaW5tZW50WzBdICYmIGxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0IDw9IHRoaXMuY29udGFpbm1lbnRbMl0pID8gbGVmdCA6ICgobGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPj0gdGhpcy5jb250YWlubWVudFswXSkgPyBsZWZ0IC0gby5ncmlkWzBdIDogbGVmdCArIG8uZ3JpZFswXSkpIDogbGVmdDsKCQkJfQoKCQl9CgoJCXJldHVybiB7CgkJCXRvcDogKAoJCQkJcGFnZVkgLQkJCQkJCQkJCQkJCQkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCAtCQkJCQkJCQkJCQkJCS8vIENsaWNrIG9mZnNldCAocmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQpCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AJLQkJCQkJCQkJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5wYXJlbnQudG9wICsJCQkJCQkJCQkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQoJCQkJKCAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPyAtdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCkgOiAoIHNjcm9sbElzUm9vdE5vZGUgPyAwIDogc2Nyb2xsLnNjcm9sbFRvcCgpICkgKSkKCQkJKSwKCQkJbGVmdDogKAoJCQkJcGFnZVggLQkJCQkJCQkJCQkJCQkJCQkvLyBUaGUgYWJzb2x1dGUgbW91c2UgcG9zaXRpb24KCQkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgLQkJCQkJCQkJCQkJCS8vIENsaWNrIG9mZnNldCAocmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQpCgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0CS0JCQkJCQkJCQkJCS8vIE9ubHkgZm9yIHJlbGF0aXZlIHBvc2l0aW9uZWQgbm9kZXM6IFJlbGF0aXZlIG9mZnNldCBmcm9tIGVsZW1lbnQgdG8gb2Zmc2V0IHBhcmVudAoJCQkJdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgKwkJCQkJCQkJCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/IC10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkgOiBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHNjcm9sbC5zY3JvbGxMZWZ0KCkgKSkKCQkJKQoJCX07CgoJfSwKCglfcmVhcnJhbmdlOiBmdW5jdGlvbihldmVudCwgaSwgYSwgaGFyZFJlZnJlc2gpIHsKCgkJYSA\/IGFbMF0uYXBwZW5kQ2hpbGQodGhpcy5wbGFjZWhvbGRlclswXSkgOiBpLml0ZW1bMF0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpcy5wbGFjZWhvbGRlclswXSwgKHRoaXMuZGlyZWN0aW9uID09PSAiZG93biIgPyBpLml0ZW1bMF0gOiBpLml0ZW1bMF0ubmV4dFNpYmxpbmcpKTsKCgkJLy9WYXJpb3VzIHRoaW5ncyBkb25lIGhlcmUgdG8gaW1wcm92ZSB0aGUgcGVyZm9ybWFuY2U6CgkJLy8gMS4gd2UgY3JlYXRlIGEgc2V0VGltZW91dCwgdGhhdCBjYWxscyByZWZyZXNoUG9zaXRpb25zCgkJLy8gMi4gb24gdGhlIGluc3RhbmNlLCB3ZSBoYXZlIGEgY291bnRlciB2YXJpYWJsZSwgdGhhdCBnZXQncyBoaWdoZXIgYWZ0ZXIgZXZlcnkgYXBwZW5kCgkJLy8gMy4gb24gdGhlIGxvY2FsIHNjb3BlLCB3ZSBjb3B5IHRoZSBjb3VudGVyIHZhcmlhYmxlLCBhbmQgY2hlY2sgaW4gdGhlIHRpbWVvdXQsIGlmIGl0J3Mgc3RpbGwgdGhlIHNhbWUKCQkvLyA0LiB0aGlzIGxldHMgb25seSB0aGUgbGFzdCBhZGRpdGlvbiB0byB0aGUgdGltZW91dCBzdGFjayB0aHJvdWdoCgkJdGhpcy5jb3VudGVyID0gdGhpcy5jb3VudGVyID8gKyt0aGlzLmNvdW50ZXIgOiAxOwoJCXZhciBjb3VudGVyID0gdGhpcy5jb3VudGVyOwoKCQl0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJaWYoY291bnRlciA9PT0gdGhpcy5jb3VudGVyKSB7CgkJCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoIWhhcmRSZWZyZXNoKTsgLy9QcmVjb21wdXRlIGFmdGVyIGVhY2ggRE9NIGluc2VydGlvbiwgTk9UIG9uIG1vdXNlbW92ZQoJCQl9CgkJfSk7CgoJfSwKCglfY2xlYXI6IGZ1bmN0aW9uKGV2ZW50LCBub1Byb3BhZ2F0aW9uKSB7CgoJCXRoaXMucmV2ZXJ0aW5nID0gZmFsc2U7CgkJLy8gV2UgZGVsYXkgYWxsIGV2ZW50cyB0aGF0IGhhdmUgdG8gYmUgdHJpZ2dlcmVkIHRvIGFmdGVyIHRoZSBwb2ludCB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgaGFzIGJlZW4gcmVtb3ZlZCBhbmQKCQkvLyBldmVyeXRoaW5nIGVsc2Ugbm9ybWFsaXplZCBhZ2FpbgoJCXZhciBpLAoJCQlkZWxheWVkVHJpZ2dlcnMgPSBbXTsKCgkJLy8gV2UgZmlyc3QgaGF2ZSB0byB1cGRhdGUgdGhlIGRvbSBwb3NpdGlvbiBvZiB0aGUgYWN0dWFsIGN1cnJlbnRJdGVtCgkJLy8gTm90ZTogZG9uJ3QgZG8gaXQgaWYgdGhlIGN1cnJlbnQgaXRlbSBpcyBhbHJlYWR5IHJlbW92ZWQgKGJ5IGEgdXNlciksIG9yIGl0IGdldHMgcmVhcHBlbmRlZCAoc2VlICM0MDg4KQoJCWlmKCF0aGlzLl9ub0ZpbmFsU29ydCAmJiB0aGlzLmN1cnJlbnRJdGVtLnBhcmVudCgpLmxlbmd0aCkgewoJCQl0aGlzLnBsYWNlaG9sZGVyLmJlZm9yZSh0aGlzLmN1cnJlbnRJdGVtKTsKCQl9CgkJdGhpcy5fbm9GaW5hbFNvcnQgPSBudWxsOwoKCQlpZih0aGlzLmhlbHBlclswXSA9PT0gdGhpcy5jdXJyZW50SXRlbVswXSkgewoJCQlmb3IoaSBpbiB0aGlzLl9zdG9yZWRDU1MpIHsKCQkJCWlmKHRoaXMuX3N0b3JlZENTU1tpXSA9PT0gImF1dG8iIHx8IHRoaXMuX3N0b3JlZENTU1tpXSA9PT0gInN0YXRpYyIpIHsKCQkJCQl0aGlzLl9zdG9yZWRDU1NbaV0gPSAiIjsKCQkJCX0KCQkJfQoJCQl0aGlzLmN1cnJlbnRJdGVtLmNzcyh0aGlzLl9zdG9yZWRDU1MpLnJlbW92ZUNsYXNzKCJ1aS1zb3J0YWJsZS1oZWxwZXIiKTsKCQl9IGVsc2UgewoJCQl0aGlzLmN1cnJlbnRJdGVtLnNob3coKTsKCQl9CgoJCWlmKHRoaXMuZnJvbU91dHNpZGUgJiYgIW5vUHJvcGFnYXRpb24pIHsKCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goZnVuY3Rpb24oZXZlbnQpIHsgdGhpcy5fdHJpZ2dlcigicmVjZWl2ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2godGhpcy5mcm9tT3V0c2lkZSkpOyB9KTsKCQl9CgkJaWYoKHRoaXMuZnJvbU91dHNpZGUgfHwgdGhpcy5kb21Qb3NpdGlvbi5wcmV2ICE9PSB0aGlzLmN1cnJlbnRJdGVtLnByZXYoKS5ub3QoIi51aS1zb3J0YWJsZS1oZWxwZXIiKVswXSB8fCB0aGlzLmRvbVBvc2l0aW9uLnBhcmVudCAhPT0gdGhpcy5jdXJyZW50SXRlbS5wYXJlbnQoKVswXSkgJiYgIW5vUHJvcGFnYXRpb24pIHsKCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goZnVuY3Rpb24oZXZlbnQpIHsgdGhpcy5fdHJpZ2dlcigidXBkYXRlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpKTsgfSk7IC8vVHJpZ2dlciB1cGRhdGUgY2FsbGJhY2sgaWYgdGhlIERPTSBwb3NpdGlvbiBoYXMgY2hhbmdlZAoJCX0KCgkJLy8gQ2hlY2sgaWYgdGhlIGl0ZW1zIENvbnRhaW5lciBoYXMgQ2hhbmdlZCBhbmQgdHJpZ2dlciBhcHByb3ByaWF0ZQoJCS8vIGV2ZW50cy4KCQlpZiAodGhpcyAhPT0gdGhpcy5jdXJyZW50Q29udGFpbmVyKSB7CgkJCWlmKCFub1Byb3BhZ2F0aW9uKSB7CgkJCQlkZWxheWVkVHJpZ2dlcnMucHVzaChmdW5jdGlvbihldmVudCkgeyB0aGlzLl90cmlnZ2VyKCJyZW1vdmUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkpOyB9KTsKCQkJCWRlbGF5ZWRUcmlnZ2Vycy5wdXNoKChmdW5jdGlvbihjKSB7IHJldHVybiBmdW5jdGlvbihldmVudCkgeyBjLl90cmlnZ2VyKCJyZWNlaXZlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCh0aGlzKSk7IH07ICB9KS5jYWxsKHRoaXMsIHRoaXMuY3VycmVudENvbnRhaW5lcikpOwoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goKGZ1bmN0aW9uKGMpIHsgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7IGMuX3RyaWdnZXIoInVwZGF0ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2godGhpcykpOyAgfTsgfSkuY2FsbCh0aGlzLCB0aGlzLmN1cnJlbnRDb250YWluZXIpKTsKCQkJfQoJCX0KCgoJCS8vUG9zdCBldmVudHMgdG8gY29udGFpbmVycwoJCWZvciAoaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSl7CgkJCWlmKCFub1Byb3BhZ2F0aW9uKSB7CgkJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCgoZnVuY3Rpb24oYykgeyByZXR1cm4gZnVuY3Rpb24oZXZlbnQpIHsgYy5fdHJpZ2dlcigiZGVhY3RpdmF0ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2godGhpcykpOyB9OyAgfSkuY2FsbCh0aGlzLCB0aGlzLmNvbnRhaW5lcnNbaV0pKTsKCQkJfQoJCQlpZih0aGlzLmNvbnRhaW5lcnNbaV0uY29udGFpbmVyQ2FjaGUub3ZlcikgewoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goKGZ1bmN0aW9uKGMpIHsgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7IGMuX3RyaWdnZXIoIm91dCIsIGV2ZW50LCB0aGlzLl91aUhhc2godGhpcykpOyB9OyAgfSkuY2FsbCh0aGlzLCB0aGlzLmNvbnRhaW5lcnNbaV0pKTsKCQkJCXRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZS5vdmVyID0gMDsKCQkJfQoJCX0KCgkJLy9EbyB3aGF0IHdhcyBvcmlnaW5hbGx5IGluIHBsdWdpbnMKCQlpZiAoIHRoaXMuc3RvcmVkQ3Vyc29yICkgewoJCQl0aGlzLmRvY3VtZW50LmZpbmQoICJib2R5IiApLmNzcyggImN1cnNvciIsIHRoaXMuc3RvcmVkQ3Vyc29yICk7CgkJCXRoaXMuc3RvcmVkU3R5bGVzaGVldC5yZW1vdmUoKTsKCQl9CgkJaWYodGhpcy5fc3RvcmVkT3BhY2l0eSkgewoJCQl0aGlzLmhlbHBlci5jc3MoIm9wYWNpdHkiLCB0aGlzLl9zdG9yZWRPcGFjaXR5KTsKCQl9CgkJaWYodGhpcy5fc3RvcmVkWkluZGV4KSB7CgkJCXRoaXMuaGVscGVyLmNzcygiekluZGV4IiwgdGhpcy5fc3RvcmVkWkluZGV4ID09PSAiYXV0byIgPyAiIiA6IHRoaXMuX3N0b3JlZFpJbmRleCk7CgkJfQoKCQl0aGlzLmRyYWdnaW5nID0gZmFsc2U7CgkJaWYodGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsKSB7CgkJCWlmKCFub1Byb3BhZ2F0aW9uKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCJiZWZvcmVTdG9wIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpKTsKCQkJCWZvciAoaT0wOyBpIDwgZGVsYXllZFRyaWdnZXJzLmxlbmd0aDsgaSsrKSB7CgkJCQkJZGVsYXllZFRyaWdnZXJzW2ldLmNhbGwodGhpcywgZXZlbnQpOwoJCQkJfSAvL1RyaWdnZXIgYWxsIGRlbGF5ZWQgZXZlbnRzCgkJCQl0aGlzLl90cmlnZ2VyKCJzdG9wIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpKTsKCQkJfQoKCQkJdGhpcy5mcm9tT3V0c2lkZSA9IGZhbHNlOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZighbm9Qcm9wYWdhdGlvbikgewoJCQl0aGlzLl90cmlnZ2VyKCJiZWZvcmVTdG9wIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpKTsKCQl9CgoJCS8vJCh0aGlzLnBsYWNlaG9sZGVyWzBdKS5yZW1vdmUoKTsgd291bGQgaGF2ZSBiZWVuIHRoZSBqUXVlcnkgd2F5IC0gdW5mb3J0dW5hdGVseSwgaXQgdW5iaW5kcyBBTEwgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIG5vZGUhCgkJdGhpcy5wbGFjZWhvbGRlclswXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMucGxhY2Vob2xkZXJbMF0pOwoKCQlpZih0aGlzLmhlbHBlclswXSAhPT0gdGhpcy5jdXJyZW50SXRlbVswXSkgewoJCQl0aGlzLmhlbHBlci5yZW1vdmUoKTsKCQl9CgkJdGhpcy5oZWxwZXIgPSBudWxsOwoKCQlpZighbm9Qcm9wYWdhdGlvbikgewoJCQlmb3IgKGk9MDsgaSA8IGRlbGF5ZWRUcmlnZ2Vycy5sZW5ndGg7IGkrKykgewoJCQkJZGVsYXllZFRyaWdnZXJzW2ldLmNhbGwodGhpcywgZXZlbnQpOwoJCQl9IC8vVHJpZ2dlciBhbGwgZGVsYXllZCBldmVudHMKCQkJdGhpcy5fdHJpZ2dlcigic3RvcCIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSk7CgkJfQoKCQl0aGlzLmZyb21PdXRzaWRlID0gZmFsc2U7CgkJcmV0dXJuIHRydWU7CgoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJaWYgKCQuV2lkZ2V0LnByb3RvdHlwZS5fdHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpID09PSBmYWxzZSkgewoJCQl0aGlzLmNhbmNlbCgpOwoJCX0KCX0sCgoJX3VpSGFzaDogZnVuY3Rpb24oX2luc3QpIHsKCQl2YXIgaW5zdCA9IF9pbnN0IHx8IHRoaXM7CgkJcmV0dXJuIHsKCQkJaGVscGVyOiBpbnN0LmhlbHBlciwKCQkJcGxhY2Vob2xkZXI6IGluc3QucGxhY2Vob2xkZXIgfHwgJChbXSksCgkJCXBvc2l0aW9uOiBpbnN0LnBvc2l0aW9uLAoJCQlvcmlnaW5hbFBvc2l0aW9uOiBpbnN0Lm9yaWdpbmFsUG9zaXRpb24sCgkJCW9mZnNldDogaW5zdC5wb3NpdGlvbkFicywKCQkJaXRlbTogaW5zdC5jdXJyZW50SXRlbSwKCQkJc2VuZGVyOiBfaW5zdCA\/IF9pbnN0LmVsZW1lbnQgOiBudWxsCgkJfTsKCX0KCn0pOwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdWlkID0gMCwKCWhpZGVQcm9wcyA9IHt9LAoJc2hvd1Byb3BzID0ge307CgpoaWRlUHJvcHMuaGVpZ2h0ID0gaGlkZVByb3BzLnBhZGRpbmdUb3AgPSBoaWRlUHJvcHMucGFkZGluZ0JvdHRvbSA9CgloaWRlUHJvcHMuYm9yZGVyVG9wV2lkdGggPSBoaWRlUHJvcHMuYm9yZGVyQm90dG9tV2lkdGggPSAiaGlkZSI7CnNob3dQcm9wcy5oZWlnaHQgPSBzaG93UHJvcHMucGFkZGluZ1RvcCA9IHNob3dQcm9wcy5wYWRkaW5nQm90dG9tID0KCXNob3dQcm9wcy5ib3JkZXJUb3BXaWR0aCA9IHNob3dQcm9wcy5ib3JkZXJCb3R0b21XaWR0aCA9ICJzaG93IjsKCiQud2lkZ2V0KCAidWkuYWNjb3JkaW9uIiwgewoJdmVyc2lvbjogIjEuMTAuMyIsCglvcHRpb25zOiB7CgkJYWN0aXZlOiAwLAoJCWFuaW1hdGU6IHt9LAoJCWNvbGxhcHNpYmxlOiBmYWxzZSwKCQlldmVudDogImNsaWNrIiwKCQloZWFkZXI6ICI+IGxpID4gOmZpcnN0LWNoaWxkLD4gOm5vdChsaSk6ZXZlbiIsCgkJaGVpZ2h0U3R5bGU6ICJhdXRvIiwKCQlpY29uczogewoJCQlhY3RpdmVIZWFkZXI6ICJ1aS1pY29uLXRyaWFuZ2xlLTEtcyIsCgkJCWhlYWRlcjogInVpLWljb24tdHJpYW5nbGUtMS1lIgoJCX0sCgoJCS8vIGNhbGxiYWNrcwoJCWFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZUFjdGl2YXRlOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXRoaXMucHJldlNob3cgPSB0aGlzLnByZXZIaWRlID0gJCgpOwoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWFjY29yZGlvbiB1aS13aWRnZXQgdWktaGVscGVyLXJlc2V0IiApCgkJCS8vIEFSSUEKCQkJLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCS8vIGRvbid0IGFsbG93IGNvbGxhcHNpYmxlOiBmYWxzZSBhbmQgYWN0aXZlOiBmYWxzZSAvIG51bGwKCQlpZiAoICFvcHRpb25zLmNvbGxhcHNpYmxlICYmIChvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgb3B0aW9ucy5hY3RpdmUgPT0gbnVsbCkgKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gMDsKCQl9CgoJCXRoaXMuX3Byb2Nlc3NQYW5lbHMoKTsKCQkvLyBoYW5kbGUgbmVnYXRpdmUgdmFsdWVzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA8IDAgKSB7CgkJCW9wdGlvbnMuYWN0aXZlICs9IHRoaXMuaGVhZGVycy5sZW5ndGg7CgkJfQoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJaGVhZGVyOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLmFjdGl2ZS5uZXh0KCksCgkJCWNvbnRlbnQ6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLmFjdGl2ZS5uZXh0KCkKCQl9OwoJfSwKCglfY3JlYXRlSWNvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBpY29ucyA9IHRoaXMub3B0aW9ucy5pY29uczsKCQlpZiAoIGljb25zICkgewoJCQkkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1hY2NvcmRpb24taGVhZGVyLWljb24gdWktaWNvbiAiICsgaWNvbnMuaGVhZGVyICkKCQkJCS5wcmVwZW5kVG8oIHRoaXMuaGVhZGVycyApOwoJCQl0aGlzLmFjdGl2ZS5jaGlsZHJlbiggIi51aS1hY2NvcmRpb24taGVhZGVyLWljb24iICkKCQkJCS5yZW1vdmVDbGFzcyggaWNvbnMuaGVhZGVyICkKCQkJCS5hZGRDbGFzcyggaWNvbnMuYWN0aXZlSGVhZGVyICk7CgkJCXRoaXMuaGVhZGVycy5hZGRDbGFzcyggInVpLWFjY29yZGlvbi1pY29ucyIgKTsKCQl9Cgl9LAoKCV9kZXN0cm95SWNvbnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGVhZGVycwoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1hY2NvcmRpb24taWNvbnMiICkKCQkJLmNoaWxkcmVuKCAiLnVpLWFjY29yZGlvbi1oZWFkZXItaWNvbiIgKQoJCQkJLnJlbW92ZSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRlbnRzOwoKCQkvLyBjbGVhbiB1cCBtYWluIGVsZW1lbnQKCQl0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCAidWktYWNjb3JkaW9uIHVpLXdpZGdldCB1aS1oZWxwZXItcmVzZXQiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQkvLyBjbGVhbiB1cCBoZWFkZXJzCgkJdGhpcy5oZWFkZXJzCgkJCS5yZW1vdmVDbGFzcyggInVpLWFjY29yZGlvbi1oZWFkZXIgdWktYWNjb3JkaW9uLWhlYWRlci1hY3RpdmUgdWktaGVscGVyLXJlc2V0IHVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLWFsbCB1aS1zdGF0ZS1hY3RpdmUgdWktc3RhdGUtZGlzYWJsZWQgdWktY29ybmVyLXRvcCIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLXNlbGVjdGVkIiApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKQoJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAvXnVpLWFjY29yZGlvbi8udGVzdCggdGhpcy5pZCApICkgewoJCQkJCXRoaXMucmVtb3ZlQXR0cmlidXRlKCAiaWQiICk7CgkJCQl9CgkJCX0pOwoJCXRoaXMuX2Rlc3Ryb3lJY29ucygpOwoKCQkvLyBjbGVhbiB1cCBjb250ZW50IHBhbmVscwoJCWNvbnRlbnRzID0gdGhpcy5oZWFkZXJzLm5leHQoKQoJCQkuY3NzKCAiZGlzcGxheSIsICIiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1leHBhbmRlZCIgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtaGlkZGVuIiApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiApCgkJCS5yZW1vdmVDbGFzcyggInVpLWhlbHBlci1yZXNldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYm90dG9tIHVpLWFjY29yZGlvbi1jb250ZW50IHVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSB1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkuZWFjaChmdW5jdGlvbigpIHsKCQkJCWlmICggL151aS1hY2NvcmRpb24vLnRlc3QoIHRoaXMuaWQgKSApIHsKCQkJCQl0aGlzLnJlbW92ZUF0dHJpYnV0ZSggImlkIiApOwoJCQkJfQoJCQl9KTsKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQljb250ZW50cy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLmV2ZW50ICkgewoJCQkJdGhpcy5fb2ZmKCB0aGlzLmhlYWRlcnMsIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCQl9CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJLy8gc2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgJiYgIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJpY29ucyIgKSB7CgkJCXRoaXMuX2Rlc3Ryb3lJY29ucygpOwoJCQlpZiAoIHZhbHVlICkgewoJCQkJdGhpcy5fY3JlYXRlSWNvbnMoKTsKCQkJfQoJCX0KCgkJLy8gIzUzMzIgLSBvcGFjaXR5IGRvZXNuJ3QgY2FzY2FkZSB0byBwb3NpdGlvbmVkIGVsZW1lbnRzIGluIElFCgkJLy8gc28gd2UgbmVlZCB0byBhZGQgdGhlIGRpc2FibGVkIGNsYXNzIHRvIHRoZSBoZWFkZXJzIGFuZCBwYW5lbHMKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy5oZWFkZXJzLmFkZCggdGhpcy5oZWFkZXJzLm5leHQoKSApCgkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQl9Cgl9LAoKCV9rZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLypqc2hpbnQgbWF4Y29tcGxleGl0eToxNSovCgkJaWYgKCBldmVudC5hbHRLZXkgfHwgZXZlbnQuY3RybEtleSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGtleUNvZGUgPSAkLnVpLmtleUNvZGUsCgkJCWxlbmd0aCA9IHRoaXMuaGVhZGVycy5sZW5ndGgsCgkJCWN1cnJlbnRJbmRleCA9IHRoaXMuaGVhZGVycy5pbmRleCggZXZlbnQudGFyZ2V0ICksCgkJCXRvRm9jdXMgPSBmYWxzZTsKCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSBrZXlDb2RlLlJJR0hUOgoJCQljYXNlIGtleUNvZGUuRE9XTjoKCQkJCXRvRm9jdXMgPSB0aGlzLmhlYWRlcnNbICggY3VycmVudEluZGV4ICsgMSApICUgbGVuZ3RoIF07CgkJCQlicmVhazsKCQkJY2FzZSBrZXlDb2RlLkxFRlQ6CgkJCWNhc2Uga2V5Q29kZS5VUDoKCQkJCXRvRm9jdXMgPSB0aGlzLmhlYWRlcnNbICggY3VycmVudEluZGV4IC0gMSArIGxlbmd0aCApICUgbGVuZ3RoIF07CgkJCQlicmVhazsKCQkJY2FzZSBrZXlDb2RlLlNQQUNFOgoJCQljYXNlIGtleUNvZGUuRU5URVI6CgkJCQl0aGlzLl9ldmVudEhhbmRsZXIoIGV2ZW50ICk7CgkJCQlicmVhazsKCQkJY2FzZSBrZXlDb2RlLkhPTUU6CgkJCQl0b0ZvY3VzID0gdGhpcy5oZWFkZXJzWyAwIF07CgkJCQlicmVhazsKCQkJY2FzZSBrZXlDb2RlLkVORDoKCQkJCXRvRm9jdXMgPSB0aGlzLmhlYWRlcnNbIGxlbmd0aCAtIDEgXTsKCQkJCWJyZWFrOwoJCX0KCgkJaWYgKCB0b0ZvY3VzICkgewoJCQkkKCBldmVudC50YXJnZXQgKS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCQkkKCB0b0ZvY3VzICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCQl0b0ZvY3VzLmZvY3VzKCk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCglfcGFuZWxLZXlEb3duIDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlVQICYmIGV2ZW50LmN0cmxLZXkgKSB7CgkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5wcmV2KCkuZm9jdXMoKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXRoaXMuX3Byb2Nlc3NQYW5lbHMoKTsKCgkJLy8gd2FzIGNvbGxhcHNlZCBvciBubyBwYW5lbAoJCWlmICggKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSA9PT0gdHJ1ZSApIHx8ICF0aGlzLmhlYWRlcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkvLyBhY3RpdmUgZmFsc2Ugb25seSB3aGVuIGNvbGxhcHNpYmxlIGlzIHRydWUKCQl9IGVsc2UgaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCAwICk7CgkJLy8gd2FzIGFjdGl2ZSwgYnV0IGFjdGl2ZSBwYW5lbCBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLmVsZW1lbnRbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQkvLyBhbGwgcmVtYWluaW5nIHBhbmVsIGFyZSBkaXNhYmxlZAoJCQlpZiAoIHRoaXMuaGVhZGVycy5sZW5ndGggPT09IHRoaXMuaGVhZGVycy5maW5kKCIudWktc3RhdGUtZGlzYWJsZWQiKS5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHBhbmVsCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggTWF0aC5tYXgoIDAsIG9wdGlvbnMuYWN0aXZlIC0gMSApICk7CgkJCX0KCQkvLyB3YXMgYWN0aXZlLCBhY3RpdmUgcGFuZWwgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy5oZWFkZXJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fZGVzdHJveUljb25zKCk7CgoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3Byb2Nlc3NQYW5lbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGVhZGVycyA9IHRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaGVhZGVyICkKCQkJLmFkZENsYXNzKCAidWktYWNjb3JkaW9uLWhlYWRlciB1aS1oZWxwZXItcmVzZXQgdWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItYWxsIiApOwoKCQl0aGlzLmhlYWRlcnMubmV4dCgpCgkJCS5hZGRDbGFzcyggInVpLWFjY29yZGlvbi1jb250ZW50IHVpLWhlbHBlci1yZXNldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYm90dG9tIiApCgkJCS5maWx0ZXIoIjpub3QoLnVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSkiKQoJCQkuaGlkZSgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaGVpZ2h0U3R5bGUgPSBvcHRpb25zLmhlaWdodFN0eWxlLAoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCWFjY29yZGlvbklkID0gdGhpcy5hY2NvcmRpb25JZCA9ICJ1aS1hY2NvcmRpb24tIiArCgkJCQkodGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSB8fCArK3VpZCk7CgoJCXRoaXMuYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggb3B0aW9ucy5hY3RpdmUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1hY2NvcmRpb24taGVhZGVyLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUgdWktY29ybmVyLXRvcCIgKQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiApOwoJCXRoaXMuYWN0aXZlLm5leHQoKQoJCQkuYWRkQ2xhc3MoICJ1aS1hY2NvcmRpb24tY29udGVudC1hY3RpdmUiICkKCQkJLnNob3coKTsKCgkJdGhpcy5oZWFkZXJzCgkJCS5hdHRyKCAicm9sZSIsICJ0YWIiICkKCQkJLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQl2YXIgaGVhZGVyID0gJCggdGhpcyApLAoJCQkJCWhlYWRlcklkID0gaGVhZGVyLmF0dHIoICJpZCIgKSwKCQkJCQlwYW5lbCA9IGhlYWRlci5uZXh0KCksCgkJCQkJcGFuZWxJZCA9IHBhbmVsLmF0dHIoICJpZCIgKTsKCQkJCWlmICggIWhlYWRlcklkICkgewoJCQkJCWhlYWRlcklkID0gYWNjb3JkaW9uSWQgKyAiLWhlYWRlci0iICsgaTsKCQkJCQloZWFkZXIuYXR0ciggImlkIiwgaGVhZGVySWQgKTsKCQkJCX0KCQkJCWlmICggIXBhbmVsSWQgKSB7CgkJCQkJcGFuZWxJZCA9IGFjY29yZGlvbklkICsgIi1wYW5lbC0iICsgaTsKCQkJCQlwYW5lbC5hdHRyKCAiaWQiLCBwYW5lbElkICk7CgkJCQl9CgkJCQloZWFkZXIuYXR0ciggImFyaWEtY29udHJvbHMiLCBwYW5lbElkICk7CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiwgaGVhZGVySWQgKTsKCQkJfSkKCQkJLm5leHQoKQoJCQkJLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoKCQl0aGlzLmhlYWRlcnMKCQkJLm5vdCggdGhpcy5hY3RpdmUgKQoJCQkuYXR0cih7CgkJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCQl0YWJJbmRleDogLTEKCQkJfSkKCQkJLm5leHQoKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQkJCX0pCgkJCQkuaGlkZSgpOwoKCQkvLyBtYWtlIHN1cmUgYXQgbGVhc3Qgb25lIGhlYWRlciBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmhlYWRlcnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUuYXR0cih7CgkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCXRhYkluZGV4OiAwCgkJCX0pCgkJCS5uZXh0KCkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9KTsKCQl9CgoJCXRoaXMuX2NyZWF0ZUljb25zKCk7CgoJCXRoaXMuX3NldHVwRXZlbnRzKCBvcHRpb25zLmV2ZW50ICk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmhlYWRlcnMuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmhlYWRlcnMubmV4dCgpCgkJCQkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuaGVpZ2h0KCBNYXRoLm1heCggMCwgbWF4SGVpZ2h0IC0KCQkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQkJfSkKCQkJCS5jc3MoICJvdmVyZmxvdyIsICJhdXRvIiApOwoJCX0gZWxzZSBpZiAoIGhlaWdodFN0eWxlID09PSAiYXV0byIgKSB7CgkJCW1heEhlaWdodCA9IDA7CgkJCXRoaXMuaGVhZGVycy5uZXh0KCkKCQkJCS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5jc3MoICJoZWlnaHQiLCAiIiApLmhlaWdodCgpICk7CgkJCQl9KQoJCQkJLmhlaWdodCggbWF4SGVpZ2h0ICk7CgkJfQoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggaW5kZXggKVsgMCBdOwoKCQkvLyB0cnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmUgPT09IHRoaXMuYWN0aXZlWyAwIF0gKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIHRyeWluZyB0byBjb2xsYXBzZSwgc2ltdWxhdGUgYSBjbGljayBvbiB0aGUgY3VycmVudGx5IGFjdGl2ZSBoZWFkZXIKCQlhY3RpdmUgPSBhY3RpdmUgfHwgdGhpcy5hY3RpdmVbIDAgXTsKCgkJdGhpcy5fZXZlbnRIYW5kbGVyKHsKCQkJdGFyZ2V0OiBhY3RpdmUsCgkJCWN1cnJlbnRUYXJnZXQ6IGFjdGl2ZSwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0pOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0eXBlb2Ygc2VsZWN0b3IgPT09ICJudW1iZXIiID8gdGhpcy5oZWFkZXJzLmVxKCBzZWxlY3RvciApIDogJCgpOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0gewoJCQlrZXlkb3duOiAiX2tleWRvd24iCgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuaGVhZGVycy5hZGQoIHRoaXMuaGVhZGVycy5uZXh0KCkgKSApOwoJCXRoaXMuX29uKCB0aGlzLmhlYWRlcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLmhlYWRlcnMubmV4dCgpLCB7IGtleWRvd246ICJfcGFuZWxLZXlEb3duIiB9KTsKCQl0aGlzLl9ob3ZlcmFibGUoIHRoaXMuaGVhZGVycyApOwoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy5oZWFkZXJzICk7Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWNsaWNrZWQgPSAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksCgkJCWNsaWNrZWRJc0FjdGl2ZSA9IGNsaWNrZWRbIDAgXSA9PT0gYWN0aXZlWyAwIF0sCgkJCWNvbGxhcHNpbmcgPSBjbGlja2VkSXNBY3RpdmUgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJdG9TaG93ID0gY29sbGFwc2luZyA\/ICQoKSA6IGNsaWNrZWQubmV4dCgpLAoJCQl0b0hpZGUgPSBhY3RpdmUubmV4dCgpLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRIZWFkZXI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdIZWFkZXI6IGNvbGxhcHNpbmcgPyAkKCkgOiBjbGlja2VkLAoJCQkJbmV3UGFuZWw6IHRvU2hvdwoJCQl9OwoKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQlpZiAoCgkJCQkvLyBjbGljayBvbiBhY3RpdmUgaGVhZGVyLCBidXQgbm90IGNvbGxhcHNpYmxlCgkJCQkoIGNsaWNrZWRJc0FjdGl2ZSAmJiAhb3B0aW9ucy5jb2xsYXBzaWJsZSApIHx8CgkJCQkvLyBhbGxvdyBjYW5jZWxpbmcgYWN0aXZhdGlvbgoJCQkJKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQWN0aXZhdGUiLCBldmVudCwgZXZlbnREYXRhICkgPT09IGZhbHNlICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW9wdGlvbnMuYWN0aXZlID0gY29sbGFwc2luZyA\/IGZhbHNlIDogdGhpcy5oZWFkZXJzLmluZGV4KCBjbGlja2VkICk7CgoJCS8vIHdoZW4gdGhlIGNhbGwgdG8gLl90b2dnbGUoKSBjb21lcyBhZnRlciB0aGUgY2xhc3MgY2hhbmdlcwoJCS8vIGl0IGNhdXNlcyBhIHZlcnkgb2RkIGJ1ZyBpbiBJRSA4IChzZWUgIzY3MjApCgkJdGhpcy5hY3RpdmUgPSBjbGlja2VkSXNBY3RpdmUgPyAkKCkgOiBjbGlja2VkOwoJCXRoaXMuX3RvZ2dsZSggZXZlbnREYXRhICk7CgoJCS8vIHN3aXRjaCBjbGFzc2VzCgkJLy8gY29ybmVyIGNsYXNzZXMgb24gdGhlIHByZXZpb3VzbHkgYWN0aXZlIGhlYWRlciBzdGF5IGFmdGVyIHRoZSBhbmltYXRpb24KCQlhY3RpdmUucmVtb3ZlQ2xhc3MoICJ1aS1hY2NvcmRpb24taGVhZGVyLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJaWYgKCBvcHRpb25zLmljb25zICkgewoJCQlhY3RpdmUuY2hpbGRyZW4oICIudWktYWNjb3JkaW9uLWhlYWRlci1pY29uIiApCgkJCQkucmVtb3ZlQ2xhc3MoIG9wdGlvbnMuaWNvbnMuYWN0aXZlSGVhZGVyICkKCQkJCS5hZGRDbGFzcyggb3B0aW9ucy5pY29ucy5oZWFkZXIgKTsKCQl9CgoJCWlmICggIWNsaWNrZWRJc0FjdGl2ZSApIHsKCQkJY2xpY2tlZAoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLWFsbCIgKQoJCQkJLmFkZENsYXNzKCAidWktYWNjb3JkaW9uLWhlYWRlci1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIHVpLWNvcm5lci10b3AiICk7CgkJCWlmICggb3B0aW9ucy5pY29ucyApIHsKCQkJCWNsaWNrZWQuY2hpbGRyZW4oICIudWktYWNjb3JkaW9uLWhlYWRlci1pY29uIiApCgkJCQkJLnJlbW92ZUNsYXNzKCBvcHRpb25zLmljb25zLmhlYWRlciApCgkJCQkJLmFkZENsYXNzKCBvcHRpb25zLmljb25zLmFjdGl2ZUhlYWRlciApOwoJCQl9CgoJCQljbGlja2VkCgkJCQkubmV4dCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1hY2NvcmRpb24tY29udGVudC1hY3RpdmUiICk7CgkJfQoJfSwKCglfdG9nZ2xlOiBmdW5jdGlvbiggZGF0YSApIHsKCQl2YXIgdG9TaG93ID0gZGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gdGhpcy5wcmV2U2hvdy5sZW5ndGggPyB0aGlzLnByZXZTaG93IDogZGF0YS5vbGRQYW5lbDsKCgkJLy8gaGFuZGxlIGFjdGl2YXRpbmcgYSBwYW5lbCBkdXJpbmcgdGhlIGFuaW1hdGlvbiBmb3IgYW5vdGhlciBhY3RpdmF0aW9uCgkJdGhpcy5wcmV2U2hvdy5hZGQoIHRoaXMucHJldkhpZGUgKS5zdG9wKCB0cnVlLCB0cnVlICk7CgkJdGhpcy5wcmV2U2hvdyA9IHRvU2hvdzsKCQl0aGlzLnByZXZIaWRlID0gdG9IaWRlOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLl9hbmltYXRlKCB0b1Nob3csIHRvSGlkZSwgZGF0YSApOwoJCX0gZWxzZSB7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXRvU2hvdy5zaG93KCk7CgkJCXRoaXMuX3RvZ2dsZUNvbXBsZXRlKCBkYXRhICk7CgkJfQoKCQl0b0hpZGUuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJfSk7CgkJdG9IaWRlLnByZXYoKS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkvLyBpZiB3ZSdyZSBzd2l0Y2hpbmcgcGFuZWxzLCByZW1vdmUgdGhlIG9sZCBoZWFkZXIgZnJvbSB0aGUgdGFiIG9yZGVyCgkJLy8gaWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyBoZWFkZXIgZnJvbSB0aGUgdGFiIG9yZGVyCgkJLy8gaWYgd2UncmUgY29sbGFwc2luZywgdGhlbiBrZWVwIHRoZSBjb2xsYXBzaW5nIGhlYWRlciBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCXRvSGlkZS5wcmV2KCkuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmhlYWRlcnMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0pCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93CgkJCS5hdHRyKHsKCQkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQl9KQoJCQkucHJldigpCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCQkJdGFiSW5kZXg6IDAKCQkJCX0pOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIHRvU2hvdywgdG9IaWRlLCBkYXRhICkgewoJCXZhciB0b3RhbCwgZWFzaW5nLCBkdXJhdGlvbiwKCQkJdGhhdCA9IHRoaXMsCgkJCWFkanVzdCA9IDAsCgkJCWRvd24gPSB0b1Nob3cubGVuZ3RoICYmCgkJCQkoICF0b0hpZGUubGVuZ3RoIHx8ICggdG9TaG93LmluZGV4KCkgPCB0b0hpZGUuaW5kZXgoKSApICksCgkJCWFuaW1hdGUgPSB0aGlzLm9wdGlvbnMuYW5pbWF0ZSB8fCB7fSwKCQkJb3B0aW9ucyA9IGRvd24gJiYgYW5pbWF0ZS5kb3duIHx8IGFuaW1hdGUsCgkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQl0aGF0Ll90b2dnbGVDb21wbGV0ZSggZGF0YSApOwoJCQl9OwoKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJZHVyYXRpb24gPSBvcHRpb25zOwoJCX0KCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJZWFzaW5nID0gb3B0aW9uczsKCQl9CgkJLy8gZmFsbCBiYWNrIGZyb20gb3B0aW9ucyB0byBhbmltYXRpb24gaW4gY2FzZSBvZiBwYXJ0aWFsIGRvd24gc2V0dGluZ3MKCQllYXNpbmcgPSBlYXNpbmcgfHwgb3B0aW9ucy5lYXNpbmcgfHwgYW5pbWF0ZS5lYXNpbmc7CgkJZHVyYXRpb24gPSBkdXJhdGlvbiB8fCBvcHRpb25zLmR1cmF0aW9uIHx8IGFuaW1hdGUuZHVyYXRpb247CgoJCWlmICggIXRvSGlkZS5sZW5ndGggKSB7CgkJCXJldHVybiB0b1Nob3cuYW5pbWF0ZSggc2hvd1Byb3BzLCBkdXJhdGlvbiwgZWFzaW5nLCBjb21wbGV0ZSApOwoJCX0KCQlpZiAoICF0b1Nob3cubGVuZ3RoICkgewoJCQlyZXR1cm4gdG9IaWRlLmFuaW1hdGUoIGhpZGVQcm9wcywgZHVyYXRpb24sIGVhc2luZywgY29tcGxldGUgKTsKCQl9CgoJCXRvdGFsID0gdG9TaG93LnNob3coKS5vdXRlckhlaWdodCgpOwoJCXRvSGlkZS5hbmltYXRlKCBoaWRlUHJvcHMsIHsKCQkJZHVyYXRpb246IGR1cmF0aW9uLAoJCQllYXNpbmc6IGVhc2luZywKCQkJc3RlcDogZnVuY3Rpb24oIG5vdywgZnggKSB7CgkJCQlmeC5ub3cgPSBNYXRoLnJvdW5kKCBub3cgKTsKCQkJfQoJCX0pOwoJCXRvU2hvdwoJCQkuaGlkZSgpCgkJCS5hbmltYXRlKCBzaG93UHJvcHMsIHsKCQkJCWR1cmF0aW9uOiBkdXJhdGlvbiwKCQkJCWVhc2luZzogZWFzaW5nLAoJCQkJY29tcGxldGU6IGNvbXBsZXRlLAoJCQkJc3RlcDogZnVuY3Rpb24oIG5vdywgZnggKSB7CgkJCQkJZngubm93ID0gTWF0aC5yb3VuZCggbm93ICk7CgkJCQkJaWYgKCBmeC5wcm9wICE9PSAiaGVpZ2h0IiApIHsKCQkJCQkJYWRqdXN0ICs9IGZ4Lm5vdzsKCQkJCQl9IGVsc2UgaWYgKCB0aGF0Lm9wdGlvbnMuaGVpZ2h0U3R5bGUgIT09ICJjb250ZW50IiApIHsKCQkJCQkJZngubm93ID0gTWF0aC5yb3VuZCggdG90YWwgLSB0b0hpZGUub3V0ZXJIZWlnaHQoKSAtIGFkanVzdCApOwoJCQkJCQlhZGp1c3QgPSAwOwoJCQkJCX0KCQkJCX0KCQkJfSk7Cgl9LAoKCV90b2dnbGVDb21wbGV0ZTogZnVuY3Rpb24oIGRhdGEgKSB7CgkJdmFyIHRvSGlkZSA9IGRhdGEub2xkUGFuZWw7CgoJCXRvSGlkZQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1hY2NvcmRpb24tY29udGVudC1hY3RpdmUiICkKCQkJLnByZXYoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktY29ybmVyLXRvcCIgKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCIgKTsKCgkJLy8gV29yayBhcm91bmQgZm9yIHJlbmRlcmluZyBidWcgaW4gSUUgKCM1NDIxKQoJCWlmICggdG9IaWRlLmxlbmd0aCApIHsKCQkJdG9IaWRlLnBhcmVudCgpWzBdLmNsYXNzTmFtZSA9IHRvSGlkZS5wYXJlbnQoKVswXS5jbGFzc05hbWU7CgkJfQoKCQl0aGlzLl90cmlnZ2VyKCAiYWN0aXZhdGUiLCBudWxsLCBkYXRhICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHVzZWQgdG8gcHJldmVudCByYWNlIGNvbmRpdGlvbnMgd2l0aCByZW1vdGUgZGF0YSBzb3VyY2VzCnZhciByZXF1ZXN0SW5kZXggPSAwOwoKJC53aWRnZXQoICJ1aS5hdXRvY29tcGxldGUiLCB7Cgl2ZXJzaW9uOiAiMS4xMC4zIiwKCWRlZmF1bHRFbGVtZW50OiAiPGlucHV0PiIsCglvcHRpb25zOiB7CgkJYXBwZW5kVG86IG51bGwsCgkJYXV0b0ZvY3VzOiBmYWxzZSwKCQlkZWxheTogMzAwLAoJCW1pbkxlbmd0aDogMSwKCQlwb3NpdGlvbjogewoJCQlteTogImxlZnQgdG9wIiwKCQkJYXQ6ICJsZWZ0IGJvdHRvbSIsCgkJCWNvbGxpc2lvbjogIm5vbmUiCgkJfSwKCQlzb3VyY2U6IG51bGwsCgoJCS8vIGNhbGxiYWNrcwoJCWNoYW5nZTogbnVsbCwKCQljbG9zZTogbnVsbCwKCQlmb2N1czogbnVsbCwKCQlvcGVuOiBudWxsLAoJCXJlc3BvbnNlOiBudWxsLAoJCXNlYXJjaDogbnVsbCwKCQlzZWxlY3Q6IG51bGwKCX0sCgoJcGVuZGluZzogMCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkvLyBTb21lIGJyb3dzZXJzIG9ubHkgcmVwZWF0IGtleWRvd24gZXZlbnRzLCBub3Qga2V5cHJlc3MgZXZlbnRzLAoJCS8vIHNvIHdlIHVzZSB0aGUgc3VwcHJlc3NLZXlQcmVzcyBmbGFnIHRvIGRldGVybWluZSBpZiB3ZSd2ZSBhbHJlYWR5CgkJLy8gaGFuZGxlZCB0aGUga2V5ZG93biBldmVudC4gIzcyNjkKCQkvLyBVbmZvcnR1bmF0ZWx5IHRoZSBjb2RlIGZvciAmIGluIGtleXByZXNzIGlzIHRoZSBzYW1lIGFzIHRoZSB1cCBhcnJvdywKCQkvLyBzbyB3ZSB1c2UgdGhlIHN1cHByZXNzS2V5UHJlc3NSZXBlYXQgZmxhZyB0byBhdm9pZCBoYW5kbGluZyBrZXlwcmVzcwoJCS8vIGV2ZW50cyB3aGVuIHdlIGtub3cgdGhlIGtleWRvd24gZXZlbnQgd2FzIHVzZWQgdG8gbW9kaWZ5IHRoZQoJCS8vIHNlYXJjaCB0ZXJtLiAjNzc5OQoJCXZhciBzdXBwcmVzc0tleVByZXNzLCBzdXBwcmVzc0tleVByZXNzUmVwZWF0LCBzdXBwcmVzc0lucHV0LAoJCQlub2RlTmFtZSA9IHRoaXMuZWxlbWVudFswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1RleHRhcmVhID0gbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIsCgkJCWlzSW5wdXQgPSBub2RlTmFtZSA9PT0gImlucHV0IjsKCgkJdGhpcy5pc011bHRpTGluZSA9CgkJCS8vIFRleHRhcmVhcyBhcmUgYWx3YXlzIG11bHRpLWxpbmUKCQkJaXNUZXh0YXJlYSA\/IHRydWUgOgoJCQkvLyBJbnB1dHMgYXJlIGFsd2F5cyBzaW5nbGUtbGluZSwgZXZlbiBpZiBpbnNpZGUgYSBjb250ZW50RWRpdGFibGUgZWxlbWVudAoJCQkvLyBJRSBhbHNvIHRyZWF0cyBpbnB1dHMgYXMgY29udGVudEVkaXRhYmxlCgkJCWlzSW5wdXQgPyBmYWxzZSA6CgkJCS8vIEFsbCBvdGhlciBlbGVtZW50IHR5cGVzIGFyZSBkZXRlcm1pbmVkIGJ5IHdoZXRoZXIgb3Igbm90IHRoZXkncmUgY29udGVudEVkaXRhYmxlCgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiaXNDb250ZW50RWRpdGFibGUiICk7CgoJCXRoaXMudmFsdWVNZXRob2QgPSB0aGlzLmVsZW1lbnRbIGlzVGV4dGFyZWEgfHwgaXNJbnB1dCA\/ICJ2YWwiIDogInRleHQiIF07CgkJdGhpcy5pc05ld01lbnUgPSB0cnVlOwoKCQl0aGlzLmVsZW1lbnQKCQkJLmFkZENsYXNzKCAidWktYXV0b2NvbXBsZXRlLWlucHV0IiApCgkJCS5hdHRyKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudCwgewoJCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvKmpzaGludCBtYXhjb21wbGV4aXR5OjE1Ki8KCQkJCWlmICggdGhpcy5lbGVtZW50LnByb3AoICJyZWFkT25seSIgKSApIHsKCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQlzdXBwcmVzc0lucHV0ID0gdHJ1ZTsKCQkJCQlzdXBwcmVzc0tleVByZXNzUmVwZWF0ID0gdHJ1ZTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IGZhbHNlOwoJCQkJc3VwcHJlc3NJbnB1dCA9IGZhbHNlOwoJCQkJc3VwcHJlc3NLZXlQcmVzc1JlcGVhdCA9IGZhbHNlOwoJCQkJdmFyIGtleUNvZGUgPSAkLnVpLmtleUNvZGU7CgkJCQlzd2l0Y2goIGV2ZW50LmtleUNvZGUgKSB7CgkJCQljYXNlIGtleUNvZGUuUEFHRV9VUDoKCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQl0aGlzLl9tb3ZlKCAicHJldmlvdXNQYWdlIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5QQUdFX0RPV046CgkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IHRydWU7CgkJCQkJdGhpcy5fbW92ZSggIm5leHRQYWdlIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5VUDoKCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQl0aGlzLl9rZXlFdmVudCggInByZXZpb3VzIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5ET1dOOgoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOwoJCQkJCXRoaXMuX2tleUV2ZW50KCAibmV4dCIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuRU5URVI6CgkJCQljYXNlIGtleUNvZGUuTlVNUEFEX0VOVEVSOgoJCQkJCS8vIHdoZW4gbWVudSBpcyBvcGVuIGFuZCBoYXMgZm9jdXMKCQkJCQlpZiAoIHRoaXMubWVudS5hY3RpdmUgKSB7CgkJCQkJCS8vICM2MDU1IC0gT3BlcmEgc3RpbGwgYWxsb3dzIHRoZSBrZXlwcmVzcyB0byBvY2N1cgoJCQkJCQkvLyB3aGljaCBjYXVzZXMgZm9ybXMgdG8gc3VibWl0CgkJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOwoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQl0aGlzLm1lbnUuc2VsZWN0KCBldmVudCApOwoJCQkJCX0KCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5UQUI6CgkJCQkJaWYgKCB0aGlzLm1lbnUuYWN0aXZlICkgewoJCQkJCQl0aGlzLm1lbnUuc2VsZWN0KCBldmVudCApOwoJCQkJCX0KCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5FU0NBUEU6CgkJCQkJaWYgKCB0aGlzLm1lbnUuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoJCQkJCQl0aGlzLl92YWx1ZSggdGhpcy50ZXJtICk7CgkJCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJCQkJCS8vIERpZmZlcmVudCBicm93c2VycyBoYXZlIGRpZmZlcmVudCBkZWZhdWx0IGJlaGF2aW9yIGZvciBlc2NhcGUKCQkJCQkJLy8gU2luZ2xlIHByZXNzIGNhbiBtZWFuIHVuZG8gb3IgY2xlYXIKCQkJCQkJLy8gRG91YmxlIHByZXNzIGluIElFIG1lYW5zIGNsZWFyIHRoZSB3aG9sZSBmb3JtCgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJCWJyZWFrOwoJCQkJZGVmYXVsdDoKCQkJCQlzdXBwcmVzc0tleVByZXNzUmVwZWF0ID0gdHJ1ZTsKCQkJCQkvLyBzZWFyY2ggdGltZW91dCBzaG91bGQgYmUgdHJpZ2dlcmVkIGJlZm9yZSB0aGUgaW5wdXQgdmFsdWUgaXMgY2hhbmdlZAoJCQkJCXRoaXMuX3NlYXJjaFRpbWVvdXQoIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0sCgkJCWtleXByZXNzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHN1cHByZXNzS2V5UHJlc3MgKSB7CgkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IGZhbHNlOwoJCQkJCWlmICggIXRoaXMuaXNNdWx0aUxpbmUgfHwgdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCBzdXBwcmVzc0tleVByZXNzUmVwZWF0ICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyByZXBsaWNhdGUgc29tZSBrZXkgaGFuZGxlcnMgdG8gYWxsb3cgdGhlbSB0byByZXBlYXQgaW4gRmlyZWZveCBhbmQgT3BlcmEKCQkJCXZhciBrZXlDb2RlID0gJC51aS5rZXlDb2RlOwoJCQkJc3dpdGNoKCBldmVudC5rZXlDb2RlICkgewoJCQkJY2FzZSBrZXlDb2RlLlBBR0VfVVA6CgkJCQkJdGhpcy5fbW92ZSggInByZXZpb3VzUGFnZSIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCXRoaXMuX21vdmUoICJuZXh0UGFnZSIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuVVA6CgkJCQkJdGhpcy5fa2V5RXZlbnQoICJwcmV2aW91cyIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuRE9XTjoKCQkJCQl0aGlzLl9rZXlFdmVudCggIm5leHQiLCBldmVudCApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9LAoJCQlpbnB1dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzdXBwcmVzc0lucHV0ICkgewoJCQkJCXN1cHByZXNzSW5wdXQgPSBmYWxzZTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXRoaXMuX3NlYXJjaFRpbWVvdXQoIGV2ZW50ICk7CgkJCX0sCgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2VsZWN0ZWRJdGVtID0gbnVsbDsKCQkJCXRoaXMucHJldmlvdXMgPSB0aGlzLl92YWx1ZSgpOwoJCQl9LAoJCQlibHVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHRoaXMuY2FuY2VsQmx1ciApIHsKCQkJCQlkZWxldGUgdGhpcy5jYW5jZWxCbHVyOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRoaXMuc2VhcmNoaW5nICk7CgkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoJCQkJdGhpcy5fY2hhbmdlKCBldmVudCApOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2luaXRTb3VyY2UoKTsKCQl0aGlzLm1lbnUgPSAkKCAiPHVsPiIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1hdXRvY29tcGxldGUgdWktZnJvbnQiICkKCQkJLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICkKCQkJLm1lbnUoewoJCQkJLy8gZGlzYWJsZSBBUklBIHN1cHBvcnQsIHRoZSBsaXZlIHJlZ2lvbiB0YWtlcyBjYXJlIG9mIHRoYXQKCQkJCXJvbGU6IG51bGwKCQkJfSkKCQkJLmhpZGUoKQoJCQkuZGF0YSggInVpLW1lbnUiICk7CgoJCXRoaXMuX29uKCB0aGlzLm1lbnUuZWxlbWVudCwgewoJCQltb3VzZWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIHByZXZlbnQgbW92aW5nIGZvY3VzIG91dCBvZiB0aGUgdGV4dCBmaWVsZAoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkvLyBJRSBkb2Vzbid0IHByZXZlbnQgbW92aW5nIGZvY3VzIGV2ZW4gd2l0aCBldmVudC5wcmV2ZW50RGVmYXVsdCgpCgkJCQkvLyBzbyB3ZSBzZXQgYSBmbGFnIHRvIGtub3cgd2hlbiB3ZSBzaG91bGQgaWdub3JlIHRoZSBibHVyIGV2ZW50CgkJCQl0aGlzLmNhbmNlbEJsdXIgPSB0cnVlOwoJCQkJdGhpcy5fZGVsYXkoZnVuY3Rpb24oKSB7CgkJCQkJZGVsZXRlIHRoaXMuY2FuY2VsQmx1cjsKCQkJCX0pOwoKCQkJCS8vIGNsaWNraW5nIG9uIHRoZSBzY3JvbGxiYXIgY2F1c2VzIGZvY3VzIHRvIHNoaWZ0IHRvIHRoZSBib2R5CgkJCQkvLyBidXQgd2UgY2FuJ3QgZGV0ZWN0IGEgbW91c2V1cCBvciBhIGNsaWNrIGltbWVkaWF0ZWx5IGFmdGVyd2FyZAoJCQkJLy8gc28gd2UgaGF2ZSB0byB0cmFjayB0aGUgbmV4dCBtb3VzZWRvd24gYW5kIGNsb3NlIHRoZSBtZW51IGlmCgkJCQkvLyB0aGUgdXNlciBjbGlja3Mgc29tZXdoZXJlIG91dHNpZGUgb2YgdGhlIGF1dG9jb21wbGV0ZQoJCQkJdmFyIG1lbnVFbGVtZW50ID0gdGhpcy5tZW51LmVsZW1lbnRbIDAgXTsKCQkJCWlmICggISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiApLmxlbmd0aCApIHsKCQkJCQl0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCQkJdmFyIHRoYXQgPSB0aGlzOwoJCQkJCQl0aGlzLmRvY3VtZW50Lm9uZSggIm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJCWlmICggZXZlbnQudGFyZ2V0ICE9PSB0aGF0LmVsZW1lbnRbIDAgXSAmJgoJCQkJCQkJCQlldmVudC50YXJnZXQgIT09IG1lbnVFbGVtZW50ICYmCgkJCQkJCQkJCSEkLmNvbnRhaW5zKCBtZW51RWxlbWVudCwgZXZlbnQudGFyZ2V0ICkgKSB7CgkJCQkJCQkJdGhhdC5jbG9zZSgpOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9KTsKCQkJCX0KCQkJfSwKCQkJbWVudWZvY3VzOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJLy8gc3VwcG9ydDogRmlyZWZveAoJCQkJLy8gUHJldmVudCBhY2NpZGVudGFsIGFjdGl2YXRpb24gb2YgbWVudSBpdGVtcyBpbiBGaXJlZm94ICgjNzAyNCAjOTExOCkKCQkJCWlmICggdGhpcy5pc05ld01lbnUgKSB7CgkJCQkJdGhpcy5pc05ld01lbnUgPSBmYWxzZTsKCQkJCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL15tb3VzZS8udGVzdCggZXZlbnQub3JpZ2luYWxFdmVudC50eXBlICkgKSB7CgkJCQkJCXRoaXMubWVudS5ibHVyKCk7CgoJCQkJCQl0aGlzLmRvY3VtZW50Lm9uZSggIm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggZXZlbnQudGFyZ2V0ICkudHJpZ2dlciggZXZlbnQub3JpZ2luYWxFdmVudCApOwoJCQkJCQl9KTsKCgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgoJCQkJdmFyIGl0ZW0gPSB1aS5pdGVtLmRhdGEoICJ1aS1hdXRvY29tcGxldGUtaXRlbSIgKTsKCQkJCWlmICggZmFsc2UgIT09IHRoaXMuX3RyaWdnZXIoICJmb2N1cyIsIGV2ZW50LCB7IGl0ZW06IGl0ZW0gfSApICkgewoJCQkJCS8vIHVzZSB2YWx1ZSB0byBtYXRjaCB3aGF0IHdpbGwgZW5kIHVwIGluIHRoZSBpbnB1dCwgaWYgaXQgd2FzIGEga2V5IGV2ZW50CgkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50ICYmIC9ea2V5Ly50ZXN0KCBldmVudC5vcmlnaW5hbEV2ZW50LnR5cGUgKSApIHsKCQkJCQkJdGhpcy5fdmFsdWUoIGl0ZW0udmFsdWUgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIE5vcm1hbGx5IHRoZSBpbnB1dCBpcyBwb3B1bGF0ZWQgd2l0aCB0aGUgaXRlbSdzIHZhbHVlIGFzIHRoZQoJCQkJCS8vIG1lbnUgaXMgbmF2aWdhdGVkLCBjYXVzaW5nIHNjcmVlbiByZWFkZXJzIHRvIG5vdGljZSBhIGNoYW5nZSBhbmQKCQkJCQkvLyBhbm5vdW5jZSB0aGUgaXRlbS4gU2luY2UgdGhlIGZvY3VzIGV2ZW50IHdhcyBjYW5jZWxlZCwgdGhpcyBkb2Vzbid0CgkJCQkJLy8gaGFwcGVuLCBzbyB3ZSB1cGRhdGUgdGhlIGxpdmUgcmVnaW9uIHNvIHRoYXQgc2NyZWVuIHJlYWRlcnMgY2FuCgkJCQkJLy8gc3RpbGwgbm90aWNlIHRoZSBjaGFuZ2UgYW5kIGFubm91bmNlIGl0LgoJCQkJCXRoaXMubGl2ZVJlZ2lvbi50ZXh0KCBpdGVtLnZhbHVlICk7CgkJCQl9CgkJCX0sCgkJCW1lbnVzZWxlY3Q6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQl2YXIgaXRlbSA9IHVpLml0ZW0uZGF0YSggInVpLWF1dG9jb21wbGV0ZS1pdGVtIiApLAoJCQkJCXByZXZpb3VzID0gdGhpcy5wcmV2aW91czsKCgkJCQkvLyBvbmx5IHRyaWdnZXIgd2hlbiBmb2N1cyB3YXMgbG9zdCAoY2xpY2sgb24gbWVudSkKCQkJCWlmICggdGhpcy5lbGVtZW50WzBdICE9PSB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKSB7CgkJCQkJdGhpcy5lbGVtZW50LmZvY3VzKCk7CgkJCQkJdGhpcy5wcmV2aW91cyA9IHByZXZpb3VzOwoJCQkJCS8vICM2MTA5IC0gSUUgdHJpZ2dlcnMgdHdvIGZvY3VzIGV2ZW50cyBhbmQgdGhlIHNlY29uZAoJCQkJCS8vIGlzIGFzeW5jaHJvbm91cywgc28gd2UgbmVlZCB0byByZXNldCB0aGUgcHJldmlvdXMKCQkJCQkvLyB0ZXJtIHN5bmNocm9ub3VzbHkgYW5kIGFzeW5jaHJvbm91c2x5IDotKAoJCQkJCXRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJCQl0aGlzLnByZXZpb3VzID0gcHJldmlvdXM7CgkJCQkJCXRoaXMuc2VsZWN0ZWRJdGVtID0gaXRlbTsKCQkJCQl9KTsKCQkJCX0KCgkJCQlpZiAoIGZhbHNlICE9PSB0aGlzLl90cmlnZ2VyKCAic2VsZWN0IiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICkgKSB7CgkJCQkJdGhpcy5fdmFsdWUoIGl0ZW0udmFsdWUgKTsKCQkJCX0KCQkJCS8vIHJlc2V0IHRoZSB0ZXJtIGFmdGVyIHRoZSBzZWxlY3QgZXZlbnQKCQkJCS8vIHRoaXMgYWxsb3dzIGN1c3RvbSBzZWxlY3QgaGFuZGxpbmcgdG8gd29yayBwcm9wZXJseQoJCQkJdGhpcy50ZXJtID0gdGhpcy5fdmFsdWUoKTsKCgkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoJCQkJdGhpcy5zZWxlY3RlZEl0ZW0gPSBpdGVtOwoJCQl9CgkJfSk7CgoJCXRoaXMubGl2ZVJlZ2lvbiA9ICQoICI8c3Bhbj4iLCB7CgkJCQlyb2xlOiAic3RhdHVzIiwKCQkJCSJhcmlhLWxpdmUiOiAicG9saXRlIgoJCQl9KQoJCQkuYWRkQ2xhc3MoICJ1aS1oZWxwZXItaGlkZGVuLWFjY2Vzc2libGUiICkKCQkJLmluc2VydEJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgoJCS8vIHR1cm5pbmcgb2ZmIGF1dG9jb21wbGV0ZSBwcmV2ZW50cyB0aGUgYnJvd3NlciBmcm9tIHJlbWVtYmVyaW5nIHRoZQoJCS8vIHZhbHVlIHdoZW4gbmF2aWdhdGluZyB0aHJvdWdoIGhpc3RvcnksIHNvIHdlIHJlLWVuYWJsZSBhdXRvY29tcGxldGUKCQkvLyBpZiB0aGUgcGFnZSBpcyB1bmxvYWRlZCBiZWZvcmUgdGhlIHdpZGdldCBpcyBkZXN0cm95ZWQuICM3NzkwCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCWJlZm9yZXVubG9hZDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggImF1dG9jb21wbGV0ZSIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLnNlYXJjaGluZyApOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1hdXRvY29tcGxldGUtaW5wdXQiICkKCQkJLnJlbW92ZUF0dHIoICJhdXRvY29tcGxldGUiICk7CgkJdGhpcy5tZW51LmVsZW1lbnQucmVtb3ZlKCk7CgkJdGhpcy5saXZlUmVnaW9uLnJlbW92ZSgpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJCWlmICgga2V5ID09PSAic291cmNlIiApIHsKCQkJdGhpcy5faW5pdFNvdXJjZSgpOwoJCX0KCQlpZiAoIGtleSA9PT0gImFwcGVuZFRvIiApIHsKCQkJdGhpcy5tZW51LmVsZW1lbnQuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCkgKTsKCQl9CgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgJiYgdmFsdWUgJiYgdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoJfSwKCglfYXBwZW5kVG86IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gdGhpcy5vcHRpb25zLmFwcGVuZFRvOwoKCQlpZiAoIGVsZW1lbnQgKSB7CgkJCWVsZW1lbnQgPSBlbGVtZW50LmpxdWVyeSB8fCBlbGVtZW50Lm5vZGVUeXBlID8KCQkJCSQoIGVsZW1lbnQgKSA6CgkJCQl0aGlzLmRvY3VtZW50LmZpbmQoIGVsZW1lbnQgKS5lcSggMCApOwoJCX0KCgkJaWYgKCAhZWxlbWVudCApIHsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLWZyb250IiApOwoJCX0KCgkJaWYgKCAhZWxlbWVudC5sZW5ndGggKSB7CgkJCWVsZW1lbnQgPSB0aGlzLmRvY3VtZW50WzBdLmJvZHk7CgkJfQoKCQlyZXR1cm4gZWxlbWVudDsKCX0sCgoJX2luaXRTb3VyY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBhcnJheSwgdXJsLAoJCQl0aGF0ID0gdGhpczsKCQlpZiAoICQuaXNBcnJheSh0aGlzLm9wdGlvbnMuc291cmNlKSApIHsKCQkJYXJyYXkgPSB0aGlzLm9wdGlvbnMuc291cmNlOwoJCQl0aGlzLnNvdXJjZSA9IGZ1bmN0aW9uKCByZXF1ZXN0LCByZXNwb25zZSApIHsKCQkJCXJlc3BvbnNlKCAkLnVpLmF1dG9jb21wbGV0ZS5maWx0ZXIoIGFycmF5LCByZXF1ZXN0LnRlcm0gKSApOwoJCQl9OwoJCX0gZWxzZSBpZiAoIHR5cGVvZiB0aGlzLm9wdGlvbnMuc291cmNlID09PSAic3RyaW5nIiApIHsKCQkJdXJsID0gdGhpcy5vcHRpb25zLnNvdXJjZTsKCQkJdGhpcy5zb3VyY2UgPSBmdW5jdGlvbiggcmVxdWVzdCwgcmVzcG9uc2UgKSB7CgkJCQlpZiAoIHRoYXQueGhyICkgewoJCQkJCXRoYXQueGhyLmFib3J0KCk7CgkJCQl9CgkJCQl0aGF0LnhociA9ICQuYWpheCh7CgkJCQkJdXJsOiB1cmwsCgkJCQkJZGF0YTogcmVxdWVzdCwKCQkJCQlkYXRhVHlwZTogImpzb24iLAoJCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBkYXRhICkgewoJCQkJCQlyZXNwb25zZSggZGF0YSApOwoJCQkJCX0sCgkJCQkJZXJyb3I6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXNwb25zZSggW10gKTsKCQkJCQl9CgkJCQl9KTsKCQkJfTsKCQl9IGVsc2UgewoJCQl0aGlzLnNvdXJjZSA9IHRoaXMub3B0aW9ucy5zb3VyY2U7CgkJfQoJfSwKCglfc2VhcmNoVGltZW91dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWNsZWFyVGltZW91dCggdGhpcy5zZWFyY2hpbmcgKTsKCQl0aGlzLnNlYXJjaGluZyA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkvLyBvbmx5IHNlYXJjaCBpZiB0aGUgdmFsdWUgaGFzIGNoYW5nZWQKCQkJaWYgKCB0aGlzLnRlcm0gIT09IHRoaXMuX3ZhbHVlKCkgKSB7CgkJCQl0aGlzLnNlbGVjdGVkSXRlbSA9IG51bGw7CgkJCQl0aGlzLnNlYXJjaCggbnVsbCwgZXZlbnQgKTsKCQkJfQoJCX0sIHRoaXMub3B0aW9ucy5kZWxheSApOwoJfSwKCglzZWFyY2g6IGZ1bmN0aW9uKCB2YWx1ZSwgZXZlbnQgKSB7CgkJdmFsdWUgPSB2YWx1ZSAhPSBudWxsID8gdmFsdWUgOiB0aGlzLl92YWx1ZSgpOwoKCQkvLyBhbHdheXMgc2F2ZSB0aGUgYWN0dWFsIHZhbHVlLCBub3QgdGhlIG9uZSBwYXNzZWQgYXMgYW4gYXJndW1lbnQKCQl0aGlzLnRlcm0gPSB0aGlzLl92YWx1ZSgpOwoKCQlpZiAoIHZhbHVlLmxlbmd0aCA8IHRoaXMub3B0aW9ucy5taW5MZW5ndGggKSB7CgkJCXJldHVybiB0aGlzLmNsb3NlKCBldmVudCApOwoJCX0KCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAic2VhcmNoIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCXJldHVybiB0aGlzLl9zZWFyY2goIHZhbHVlICk7Cgl9LAoKCV9zZWFyY2g6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLnBlbmRpbmcrKzsKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1hdXRvY29tcGxldGUtbG9hZGluZyIgKTsKCQl0aGlzLmNhbmNlbFNlYXJjaCA9IGZhbHNlOwoKCQl0aGlzLnNvdXJjZSggeyB0ZXJtOiB2YWx1ZSB9LCB0aGlzLl9yZXNwb25zZSgpICk7Cgl9LAoKCV9yZXNwb25zZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlpbmRleCA9ICsrcmVxdWVzdEluZGV4OwoKCQlyZXR1cm4gZnVuY3Rpb24oIGNvbnRlbnQgKSB7CgkJCWlmICggaW5kZXggPT09IHJlcXVlc3RJbmRleCApIHsKCQkJCXRoYXQuX19yZXNwb25zZSggY29udGVudCApOwoJCQl9CgoJCQl0aGF0LnBlbmRpbmctLTsKCQkJaWYgKCAhdGhhdC5wZW5kaW5nICkgewoJCQkJdGhhdC5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYXV0b2NvbXBsZXRlLWxvYWRpbmciICk7CgkJCX0KCQl9OwoJfSwKCglfX3Jlc3BvbnNlOiBmdW5jdGlvbiggY29udGVudCApIHsKCQlpZiAoIGNvbnRlbnQgKSB7CgkJCWNvbnRlbnQgPSB0aGlzLl9ub3JtYWxpemUoIGNvbnRlbnQgKTsKCQl9CgkJdGhpcy5fdHJpZ2dlciggInJlc3BvbnNlIiwgbnVsbCwgeyBjb250ZW50OiBjb250ZW50IH0gKTsKCQlpZiAoICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgJiYgY29udGVudCAmJiBjb250ZW50Lmxlbmd0aCAmJiAhdGhpcy5jYW5jZWxTZWFyY2ggKSB7CgkJCXRoaXMuX3N1Z2dlc3QoIGNvbnRlbnQgKTsKCQkJdGhpcy5fdHJpZ2dlciggIm9wZW4iICk7CgkJfSBlbHNlIHsKCQkJLy8gdXNlIC5fY2xvc2UoKSBpbnN0ZWFkIG9mIC5jbG9zZSgpIHNvIHdlIGRvbid0IGNhbmNlbCBmdXR1cmUgc2VhcmNoZXMKCQkJdGhpcy5fY2xvc2UoKTsKCQl9Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5jYW5jZWxTZWFyY2ggPSB0cnVlOwoJCXRoaXMuX2Nsb3NlKCBldmVudCApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgkJCXRoaXMubWVudS5lbGVtZW50LmhpZGUoKTsKCQkJdGhpcy5tZW51LmJsdXIoKTsKCQkJdGhpcy5pc05ld01lbnUgPSB0cnVlOwoJCQl0aGlzLl90cmlnZ2VyKCAiY2xvc2UiLCBldmVudCApOwoJCX0KCX0sCgoJX2NoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5wcmV2aW91cyAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB7IGl0ZW06IHRoaXMuc2VsZWN0ZWRJdGVtIH0gKTsKCQl9Cgl9LAoKCV9ub3JtYWxpemU6IGZ1bmN0aW9uKCBpdGVtcyApIHsKCQkvLyBhc3N1bWUgYWxsIGl0ZW1zIGhhdmUgdGhlIHJpZ2h0IGZvcm1hdCB3aGVuIHRoZSBmaXJzdCBpdGVtIGlzIGNvbXBsZXRlCgkJaWYgKCBpdGVtcy5sZW5ndGggJiYgaXRlbXNbMF0ubGFiZWwgJiYgaXRlbXNbMF0udmFsdWUgKSB7CgkJCXJldHVybiBpdGVtczsKCQl9CgkJcmV0dXJuICQubWFwKCBpdGVtcywgZnVuY3Rpb24oIGl0ZW0gKSB7CgkJCWlmICggdHlwZW9mIGl0ZW0gPT09ICJzdHJpbmciICkgewoJCQkJcmV0dXJuIHsKCQkJCQlsYWJlbDogaXRlbSwKCQkJCQl2YWx1ZTogaXRlbQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gJC5leHRlbmQoewoJCQkJbGFiZWw6IGl0ZW0ubGFiZWwgfHwgaXRlbS52YWx1ZSwKCQkJCXZhbHVlOiBpdGVtLnZhbHVlIHx8IGl0ZW0ubGFiZWwKCQkJfSwgaXRlbSApOwoJCX0pOwoJfSwKCglfc3VnZ2VzdDogZnVuY3Rpb24oIGl0ZW1zICkgewoJCXZhciB1bCA9IHRoaXMubWVudS5lbGVtZW50LmVtcHR5KCk7CgkJdGhpcy5fcmVuZGVyTWVudSggdWwsIGl0ZW1zICk7CgkJdGhpcy5pc05ld01lbnUgPSB0cnVlOwoJCXRoaXMubWVudS5yZWZyZXNoKCk7CgoJCS8vIHNpemUgYW5kIHBvc2l0aW9uIG1lbnUKCQl1bC5zaG93KCk7CgkJdGhpcy5fcmVzaXplTWVudSgpOwoJCXVsLnBvc2l0aW9uKCAkLmV4dGVuZCh7CgkJCW9mOiB0aGlzLmVsZW1lbnQKCQl9LCB0aGlzLm9wdGlvbnMucG9zaXRpb24gKSk7CgoJCWlmICggdGhpcy5vcHRpb25zLmF1dG9Gb2N1cyApIHsKCQkJdGhpcy5tZW51Lm5leHQoKTsKCQl9Cgl9LAoKCV9yZXNpemVNZW51OiBmdW5jdGlvbigpIHsKCQl2YXIgdWwgPSB0aGlzLm1lbnUuZWxlbWVudDsKCQl1bC5vdXRlcldpZHRoKCBNYXRoLm1heCgKCQkJLy8gRmlyZWZveCB3cmFwcyBsb25nIHRleHQgKHBvc3NpYmx5IGEgcm91bmRpbmcgYnVnKQoJCQkvLyBzbyB3ZSBhZGQgMXB4IHRvIGF2b2lkIHRoZSB3cmFwcGluZyAoIzc1MTMpCgkJCXVsLndpZHRoKCAiIiApLm91dGVyV2lkdGgoKSArIDEsCgkJCXRoaXMuZWxlbWVudC5vdXRlcldpZHRoKCkKCQkpICk7Cgl9LAoKCV9yZW5kZXJNZW51OiBmdW5jdGlvbiggdWwsIGl0ZW1zICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQkkLmVhY2goIGl0ZW1zLCBmdW5jdGlvbiggaW5kZXgsIGl0ZW0gKSB7CgkJCXRoYXQuX3JlbmRlckl0ZW1EYXRhKCB1bCwgaXRlbSApOwoJCX0pOwoJfSwKCglfcmVuZGVySXRlbURhdGE6IGZ1bmN0aW9uKCB1bCwgaXRlbSApIHsKCQlyZXR1cm4gdGhpcy5fcmVuZGVySXRlbSggdWwsIGl0ZW0gKS5kYXRhKCAidWktYXV0b2NvbXBsZXRlLWl0ZW0iLCBpdGVtICk7Cgl9LAoKCV9yZW5kZXJJdGVtOiBmdW5jdGlvbiggdWwsIGl0ZW0gKSB7CgkJcmV0dXJuICQoICI8bGk+IiApCgkJCS5hcHBlbmQoICQoICI8YT4iICkudGV4dCggaXRlbS5sYWJlbCApICkKCQkJLmFwcGVuZFRvKCB1bCApOwoJfSwKCglfbW92ZTogZnVuY3Rpb24oIGRpcmVjdGlvbiwgZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJdGhpcy5zZWFyY2goIG51bGwsIGV2ZW50ICk7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLm1lbnUuaXNGaXJzdEl0ZW0oKSAmJiAvXnByZXZpb3VzLy50ZXN0KCBkaXJlY3Rpb24gKSB8fAoJCQkJdGhpcy5tZW51LmlzTGFzdEl0ZW0oKSAmJiAvXm5leHQvLnRlc3QoIGRpcmVjdGlvbiApICkgewoJCQl0aGlzLl92YWx1ZSggdGhpcy50ZXJtICk7CgkJCXRoaXMubWVudS5ibHVyKCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5tZW51WyBkaXJlY3Rpb24gXSggZXZlbnQgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tZW51LmVsZW1lbnQ7Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudmFsdWVNZXRob2QuYXBwbHkoIHRoaXMuZWxlbWVudCwgYXJndW1lbnRzICk7Cgl9LAoKCV9rZXlFdmVudDogZnVuY3Rpb24oIGtleUV2ZW50LCBldmVudCApIHsKCQlpZiAoICF0aGlzLmlzTXVsdGlMaW5lIHx8IHRoaXMubWVudS5lbGVtZW50LmlzKCAiOnZpc2libGUiICkgKSB7CgkJCXRoaXMuX21vdmUoIGtleUV2ZW50LCBldmVudCApOwoKCQkJLy8gcHJldmVudHMgbW92aW5nIGN1cnNvciB0byBiZWdpbm5pbmcvZW5kIG9mIHRoZSB0ZXh0IGZpZWxkIGluIHNvbWUgYnJvd3NlcnMKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9Cn0pOwoKJC5leHRlbmQoICQudWkuYXV0b2NvbXBsZXRlLCB7Cgllc2NhcGVSZWdleDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXJldHVybiB2YWx1ZS5yZXBsYWNlKC9bXC1cW1xde30oKSorPy4sXFxcXiR8I1xzXS9nLCAiXFwkJiIpOwoJfSwKCWZpbHRlcjogZnVuY3Rpb24oYXJyYXksIHRlcm0pIHsKCQl2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoICQudWkuYXV0b2NvbXBsZXRlLmVzY2FwZVJlZ2V4KHRlcm0pLCAiaSIgKTsKCQlyZXR1cm4gJC5ncmVwKCBhcnJheSwgZnVuY3Rpb24odmFsdWUpIHsKCQkJcmV0dXJuIG1hdGNoZXIudGVzdCggdmFsdWUubGFiZWwgfHwgdmFsdWUudmFsdWUgfHwgdmFsdWUgKTsKCQl9KTsKCX0KfSk7CgoKLy8gbGl2ZSByZWdpb24gZXh0ZW5zaW9uLCBhZGRpbmcgYSBgbWVzc2FnZXNgIG9wdGlvbgovLyBOT1RFOiBUaGlzIGlzIGFuIGV4cGVyaW1lbnRhbCBBUEkuIFdlIGFyZSBzdGlsbCBpbnZlc3RpZ2F0aW5nCi8vIGEgZnVsbCBzb2x1dGlvbiBmb3Igc3RyaW5nIG1hbmlwdWxhdGlvbiBhbmQgaW50ZXJuYXRpb25hbGl6YXRpb24uCiQud2lkZ2V0KCAidWkuYXV0b2NvbXBsZXRlIiwgJC51aS5hdXRvY29tcGxldGUsIHsKCW9wdGlvbnM6IHsKCQltZXNzYWdlczogewoJCQlub1Jlc3VsdHM6ICJObyBzZWFyY2ggcmVzdWx0cy4iLAoJCQlyZXN1bHRzOiBmdW5jdGlvbiggYW1vdW50ICkgewoJCQkJcmV0dXJuIGFtb3VudCArICggYW1vdW50ID4gMSA\/ICIgcmVzdWx0cyBhcmUiIDogIiByZXN1bHQgaXMiICkgKwoJCQkJCSIgYXZhaWxhYmxlLCB1c2UgdXAgYW5kIGRvd24gYXJyb3cga2V5cyB0byBuYXZpZ2F0ZS4iOwoJCQl9CgkJfQoJfSwKCglfX3Jlc3BvbnNlOiBmdW5jdGlvbiggY29udGVudCApIHsKCQl2YXIgbWVzc2FnZTsKCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmNhbmNlbFNlYXJjaCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIGNvbnRlbnQgJiYgY29udGVudC5sZW5ndGggKSB7CgkJCW1lc3NhZ2UgPSB0aGlzLm9wdGlvbnMubWVzc2FnZXMucmVzdWx0cyggY29udGVudC5sZW5ndGggKTsKCQl9IGVsc2UgewoJCQltZXNzYWdlID0gdGhpcy5vcHRpb25zLm1lc3NhZ2VzLm5vUmVzdWx0czsKCQl9CgkJdGhpcy5saXZlUmVnaW9uLnRleHQoIG1lc3NhZ2UgKTsKCX0KfSk7Cgp9KCBqUXVlcnkgKSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGxhc3RBY3RpdmUsIHN0YXJ0WFBvcywgc3RhcnRZUG9zLCBjbGlja0RyYWdnZWQsCgliYXNlQ2xhc3NlcyA9ICJ1aS1idXR0b24gdWktd2lkZ2V0IHVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLWFsbCIsCglzdGF0ZUNsYXNzZXMgPSAidWktc3RhdGUtaG92ZXIgdWktc3RhdGUtYWN0aXZlICIsCgl0eXBlQ2xhc3NlcyA9ICJ1aS1idXR0b24taWNvbnMtb25seSB1aS1idXR0b24taWNvbi1vbmx5IHVpLWJ1dHRvbi10ZXh0LWljb25zIHVpLWJ1dHRvbi10ZXh0LWljb24tcHJpbWFyeSB1aS1idXR0b24tdGV4dC1pY29uLXNlY29uZGFyeSB1aS1idXR0b24tdGV4dC1vbmx5IiwKCWZvcm1SZXNldEhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQl2YXIgZm9ybSA9ICQoIHRoaXMgKTsKCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQlmb3JtLmZpbmQoICI6dWktYnV0dG9uIiApLmJ1dHRvbiggInJlZnJlc2giICk7CgkJfSwgMSApOwoJfSwKCXJhZGlvR3JvdXAgPSBmdW5jdGlvbiggcmFkaW8gKSB7CgkJdmFyIG5hbWUgPSByYWRpby5uYW1lLAoJCQlmb3JtID0gcmFkaW8uZm9ybSwKCQkJcmFkaW9zID0gJCggW10gKTsKCQlpZiAoIG5hbWUgKSB7CgkJCW5hbWUgPSBuYW1lLnJlcGxhY2UoIC8nL2csICJcXCciICk7CgkJCWlmICggZm9ybSApIHsKCQkJCXJhZGlvcyA9ICQoIGZvcm0gKS5maW5kKCAiW25hbWU9JyIgKyBuYW1lICsgIiddIiApOwoJCQl9IGVsc2UgewoJCQkJcmFkaW9zID0gJCggIltuYW1lPSciICsgbmFtZSArICInXSIsIHJhZGlvLm93bmVyRG9jdW1lbnQgKQoJCQkJCS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiAhdGhpcy5mb3JtOwoJCQkJCX0pOwoJCQl9CgkJfQoJCXJldHVybiByYWRpb3M7Cgl9OwoKJC53aWRnZXQoICJ1aS5idXR0b24iLCB7Cgl2ZXJzaW9uOiAiMS4xMC4zIiwKCWRlZmF1bHRFbGVtZW50OiAiPGJ1dHRvbj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBudWxsLAoJCXRleHQ6IHRydWUsCgkJbGFiZWw6IG51bGwsCgkJaWNvbnM6IHsKCQkJcHJpbWFyeTogbnVsbCwKCQkJc2Vjb25kYXJ5OiBudWxsCgkJfQoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKQoJCQkudW5iaW5kKCAicmVzZXQiICsgdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5iaW5kKCAicmVzZXQiICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZm9ybVJlc2V0SGFuZGxlciApOwoKCQlpZiAoIHR5cGVvZiB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgIT09ICJib29sZWFuIiApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gISF0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgoJCXRoaXMuX2RldGVybWluZUJ1dHRvblR5cGUoKTsKCQl0aGlzLmhhc1RpdGxlID0gISF0aGlzLmJ1dHRvbkVsZW1lbnQuYXR0ciggInRpdGxlIiApOwoKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXRvZ2dsZUJ1dHRvbiA9IHRoaXMudHlwZSA9PT0gImNoZWNrYm94IiB8fCB0aGlzLnR5cGUgPT09ICJyYWRpbyIsCgkJCWFjdGl2ZUNsYXNzID0gIXRvZ2dsZUJ1dHRvbiA\/ICJ1aS1zdGF0ZS1hY3RpdmUiIDogIiIsCgkJCWZvY3VzQ2xhc3MgPSAidWktc3RhdGUtZm9jdXMiOwoKCQlpZiAoIG9wdGlvbnMubGFiZWwgPT09IG51bGwgKSB7CgkJCW9wdGlvbnMubGFiZWwgPSAodGhpcy50eXBlID09PSAiaW5wdXQiID8gdGhpcy5idXR0b25FbGVtZW50LnZhbCgpIDogdGhpcy5idXR0b25FbGVtZW50Lmh0bWwoKSk7CgkJfQoKCQl0aGlzLl9ob3ZlcmFibGUoIHRoaXMuYnV0dG9uRWxlbWVudCApOwoKCQl0aGlzLmJ1dHRvbkVsZW1lbnQKCQkJLmFkZENsYXNzKCBiYXNlQ2xhc3NlcyApCgkJCS5hdHRyKCAicm9sZSIsICJidXR0b24iICkKCQkJLmJpbmQoICJtb3VzZWVudGVyIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBvcHRpb25zLmRpc2FibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICggdGhpcyA9PT0gbGFzdEFjdGl2ZSApIHsKCQkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0pCgkJCS5iaW5kKCAibW91c2VsZWF2ZSIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggb3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoIGFjdGl2ZUNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2xpY2siICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBvcHRpb25zLmRpc2FibGVkICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLmVsZW1lbnQKCQkJLmJpbmQoICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCS8vIG5vIG5lZWQgdG8gY2hlY2sgZGlzYWJsZWQsIGZvY3VzIHdvbid0IGJlIHRyaWdnZXJlZCBhbnl3YXkKCQkJCXRoYXQuYnV0dG9uRWxlbWVudC5hZGRDbGFzcyggZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImJsdXIiICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZnVuY3Rpb24oKSB7CgkJCQl0aGF0LmJ1dHRvbkVsZW1lbnQucmVtb3ZlQ2xhc3MoIGZvY3VzQ2xhc3MgKTsKCQkJfSk7CgoJCWlmICggdG9nZ2xlQnV0dG9uICkgewoJCQl0aGlzLmVsZW1lbnQuYmluZCggImNoYW5nZSIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggY2xpY2tEcmFnZ2VkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXRoYXQucmVmcmVzaCgpOwoJCQl9KTsKCQkJLy8gaWYgbW91c2UgbW92ZXMgYmV0d2VlbiBtb3VzZWRvd24gYW5kIG1vdXNldXAgKGRyYWcpIHNldCBjbGlja0RyYWdnZWQgZmxhZwoJCQkvLyBwcmV2ZW50cyBpc3N1ZSB3aGVyZSBidXR0b24gc3RhdGUgY2hhbmdlcyBidXQgY2hlY2tib3gvcmFkaW8gY2hlY2tlZCBzdGF0ZQoJCQkvLyBkb2VzIG5vdCBpbiBGaXJlZm94IChzZWUgdGlja2V0ICM2OTcwKQoJCQl0aGlzLmJ1dHRvbkVsZW1lbnQKCQkJCS5iaW5kKCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQkJY2xpY2tEcmFnZ2VkID0gZmFsc2U7CgkJCQkJc3RhcnRYUG9zID0gZXZlbnQucGFnZVg7CgkJCQkJc3RhcnRZUG9zID0gZXZlbnQucGFnZVk7CgkJCQl9KQoJCQkJLmJpbmQoICJtb3VzZXVwIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQkJaWYgKCBzdGFydFhQb3MgIT09IGV2ZW50LnBhZ2VYIHx8IHN0YXJ0WVBvcyAhPT0gZXZlbnQucGFnZVkgKSB7CgkJCQkJCWNsaWNrRHJhZ2dlZCA9IHRydWU7CgkJCQkJfQoJCQl9KTsKCQl9CgoJCWlmICggdGhpcy50eXBlID09PSAiY2hlY2tib3giICkgewoJCQl0aGlzLmJ1dHRvbkVsZW1lbnQuYmluZCggImNsaWNrIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBvcHRpb25zLmRpc2FibGVkIHx8IGNsaWNrRHJhZ2dlZCApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSBpZiAoIHRoaXMudHlwZSA9PT0gInJhZGlvIiApIHsKCQkJdGhpcy5idXR0b25FbGVtZW50LmJpbmQoICJjbGljayIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCBjbGlja0RyYWdnZWQgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJdGhhdC5idXR0b25FbGVtZW50LmF0dHIoICJhcmlhLXByZXNzZWQiLCAidHJ1ZSIgKTsKCgkJCQl2YXIgcmFkaW8gPSB0aGF0LmVsZW1lbnRbIDAgXTsKCQkJCXJhZGlvR3JvdXAoIHJhZGlvICkKCQkJCQkubm90KCByYWRpbyApCgkJCQkJLm1hcChmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuICQoIHRoaXMgKS5idXR0b24oICJ3aWRnZXQiIClbIDAgXTsKCQkJCQl9KQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkJCS5hdHRyKCAiYXJpYS1wcmVzc2VkIiwgImZhbHNlIiApOwoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmJ1dHRvbkVsZW1lbnQKCQkJCS5iaW5kKCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggb3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQkJbGFzdEFjdGl2ZSA9IHRoaXM7CgkJCQkJdGhhdC5kb2N1bWVudC5vbmUoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCQkJCWxhc3RBY3RpdmUgPSBudWxsOwoJCQkJCX0pOwoJCQkJfSkKCQkJCS5iaW5kKCAibW91c2V1cCIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQkJJCggdGhpcyApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJfSkKCQkJCS5iaW5kKCAia2V5ZG93biIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbihldmVudCkgewoJCQkJCWlmICggb3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCQlpZiAoIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5TUEFDRSB8fCBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuRU5URVIgKSB7CgkJCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQl9CgkJCQl9KQoJCQkJLy8gc2VlICM4NTU5LCB3ZSBiaW5kIHRvIGJsdXIgaGVyZSBpbiBjYXNlIHRoZSBidXR0b24gZWxlbWVudCBsb3NlcwoJCQkJLy8gZm9jdXMgYmV0d2VlbiBrZXlkb3duIGFuZCBrZXl1cCwgaXQgd291bGQgYmUgbGVmdCBpbiBhbiAiYWN0aXZlIiBzdGF0ZQoJCQkJLmJpbmQoICJrZXl1cCIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiBibHVyIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCX0pOwoKCQkJaWYgKCB0aGlzLmJ1dHRvbkVsZW1lbnQuaXMoImEiKSApIHsKCQkJCXRoaXMuYnV0dG9uRWxlbWVudC5rZXl1cChmdW5jdGlvbihldmVudCkgewoJCQkJCWlmICggZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlNQQUNFICkgewoJCQkJCQkvLyBUT0RPIHBhc3MgdGhyb3VnaCBvcmlnaW5hbCBldmVudCBjb3JyZWN0bHkgKGp1c3QgYXMgMm5kIGFyZ3VtZW50IGRvZXNuJ3Qgd29yaykKCQkJCQkJJCggdGhpcyApLmNsaWNrKCk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9CgoJCS8vIFRPRE86IHB1bGwgb3V0ICQuV2lkZ2V0J3MgaGFuZGxpbmcgZm9yIHRoZSBkaXNhYmxlZCBvcHRpb24gaW50bwoJCS8vICQuV2lkZ2V0LnByb3RvdHlwZS5fc2V0T3B0aW9uRGlzYWJsZWQgc28gaXQncyBlYXN5IHRvIHByb3h5IGFuZCBjYW4KCQkvLyBiZSBvdmVycmlkZGVuIGJ5IGluZGl2aWR1YWwgcGx1Z2lucwoJCXRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgb3B0aW9ucy5kaXNhYmxlZCApOwoJCXRoaXMuX3Jlc2V0QnV0dG9uKCk7Cgl9LAoKCV9kZXRlcm1pbmVCdXR0b25UeXBlOiBmdW5jdGlvbigpIHsKCQl2YXIgYW5jZXN0b3IsIGxhYmVsU2VsZWN0b3IsIGNoZWNrZWQ7CgoJCWlmICggdGhpcy5lbGVtZW50LmlzKCJbdHlwZT1jaGVja2JveF0iKSApIHsKCQkJdGhpcy50eXBlID0gImNoZWNrYm94IjsKCQl9IGVsc2UgaWYgKCB0aGlzLmVsZW1lbnQuaXMoIlt0eXBlPXJhZGlvXSIpICkgewoJCQl0aGlzLnR5cGUgPSAicmFkaW8iOwoJCX0gZWxzZSBpZiAoIHRoaXMuZWxlbWVudC5pcygiaW5wdXQiKSApIHsKCQkJdGhpcy50eXBlID0gImlucHV0IjsKCQl9IGVsc2UgewoJCQl0aGlzLnR5cGUgPSAiYnV0dG9uIjsKCQl9CgoJCWlmICggdGhpcy50eXBlID09PSAiY2hlY2tib3giIHx8IHRoaXMudHlwZSA9PT0gInJhZGlvIiApIHsKCQkJLy8gd2UgZG9uJ3Qgc2VhcmNoIGFnYWluc3QgdGhlIGRvY3VtZW50IGluIGNhc2UgdGhlIGVsZW1lbnQKCQkJLy8gaXMgZGlzY29ubmVjdGVkIGZyb20gdGhlIERPTQoJCQlhbmNlc3RvciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCkubGFzdCgpOwoJCQlsYWJlbFNlbGVjdG9yID0gImxhYmVsW2Zvcj0nIiArIHRoaXMuZWxlbWVudC5hdHRyKCJpZCIpICsgIiddIjsKCQkJdGhpcy5idXR0b25FbGVtZW50ID0gYW5jZXN0b3IuZmluZCggbGFiZWxTZWxlY3RvciApOwoJCQlpZiAoICF0aGlzLmJ1dHRvbkVsZW1lbnQubGVuZ3RoICkgewoJCQkJYW5jZXN0b3IgPSBhbmNlc3Rvci5sZW5ndGggPyBhbmNlc3Rvci5zaWJsaW5ncygpIDogdGhpcy5lbGVtZW50LnNpYmxpbmdzKCk7CgkJCQl0aGlzLmJ1dHRvbkVsZW1lbnQgPSBhbmNlc3Rvci5maWx0ZXIoIGxhYmVsU2VsZWN0b3IgKTsKCQkJCWlmICggIXRoaXMuYnV0dG9uRWxlbWVudC5sZW5ndGggKSB7CgkJCQkJdGhpcy5idXR0b25FbGVtZW50ID0gYW5jZXN0b3IuZmluZCggbGFiZWxTZWxlY3RvciApOwoJCQkJfQoJCQl9CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWhlbHBlci1oaWRkZW4tYWNjZXNzaWJsZSIgKTsKCgkJCWNoZWNrZWQgPSB0aGlzLmVsZW1lbnQuaXMoICI6Y2hlY2tlZCIgKTsKCQkJaWYgKCBjaGVja2VkICkgewoJCQkJdGhpcy5idXR0b25FbGVtZW50LmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQl9CgkJCXRoaXMuYnV0dG9uRWxlbWVudC5wcm9wKCAiYXJpYS1wcmVzc2VkIiwgY2hlY2tlZCApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYnV0dG9uRWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQl9Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYnV0dG9uRWxlbWVudDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1oZWxwZXItaGlkZGVuLWFjY2Vzc2libGUiICk7CgkJdGhpcy5idXR0b25FbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggYmFzZUNsYXNzZXMgKyAiICIgKyBzdGF0ZUNsYXNzZXMgKyAiICIgKyB0eXBlQ2xhc3NlcyApCgkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtcHJlc3NlZCIgKQoJCQkuaHRtbCggdGhpcy5idXR0b25FbGVtZW50LmZpbmQoIi51aS1idXR0b24tdGV4dCIpLmh0bWwoKSApOwoKCQlpZiAoICF0aGlzLmhhc1RpdGxlICkgewoJCQl0aGlzLmJ1dHRvbkVsZW1lbnQucmVtb3ZlQXR0ciggInRpdGxlIiApOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJaWYgKCB2YWx1ZSApIHsKCQkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgZmFsc2UgKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX3Jlc2V0QnV0dG9uKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCS8vU2VlICM4MjM3ICYgIzg4MjgKCQl2YXIgaXNEaXNhYmxlZCA9IHRoaXMuZWxlbWVudC5pcyggImlucHV0LCBidXR0b24iICkgPyB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkgOiB0aGlzLmVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1idXR0b24tZGlzYWJsZWQiICk7CgoJCWlmICggaXNEaXNhYmxlZCAhPT0gdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQl0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGlzRGlzYWJsZWQgKTsKCQl9CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJyYWRpbyIgKSB7CgkJCXJhZGlvR3JvdXAoIHRoaXMuZWxlbWVudFswXSApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5pcyggIjpjaGVja2VkIiApICkgewoJCQkJCSQoIHRoaXMgKS5idXR0b24oICJ3aWRnZXQiICkKCQkJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApCgkJCQkJCS5hdHRyKCAiYXJpYS1wcmVzc2VkIiwgInRydWUiICk7CgkJCQl9IGVsc2UgewoJCQkJCSQoIHRoaXMgKS5idXR0b24oICJ3aWRnZXQiICkKCQkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApCgkJCQkJCS5hdHRyKCAiYXJpYS1wcmVzc2VkIiwgImZhbHNlIiApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgKSB7CgkJCQl0aGlzLmJ1dHRvbkVsZW1lbnQKCQkJCQkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICkKCQkJCQkuYXR0ciggImFyaWEtcHJlc3NlZCIsICJ0cnVlIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5idXR0b25FbGVtZW50CgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApCgkJCQkJLmF0dHIoICJhcmlhLXByZXNzZWQiLCAiZmFsc2UiICk7CgkJCX0KCQl9Cgl9LAoKCV9yZXNldEJ1dHRvbjogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJpbnB1dCIgKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLmxhYmVsICkgewoJCQkJdGhpcy5lbGVtZW50LnZhbCggdGhpcy5vcHRpb25zLmxhYmVsICk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCQl2YXIgYnV0dG9uRWxlbWVudCA9IHRoaXMuYnV0dG9uRWxlbWVudC5yZW1vdmVDbGFzcyggdHlwZUNsYXNzZXMgKSwKCQkJYnV0dG9uVGV4dCA9ICQoICI8c3Bhbj48L3NwYW4+IiwgdGhpcy5kb2N1bWVudFswXSApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idXR0b24tdGV4dCIgKQoJCQkJLmh0bWwoIHRoaXMub3B0aW9ucy5sYWJlbCApCgkJCQkuYXBwZW5kVG8oIGJ1dHRvbkVsZW1lbnQuZW1wdHkoKSApCgkJCQkudGV4dCgpLAoJCQlpY29ucyA9IHRoaXMub3B0aW9ucy5pY29ucywKCQkJbXVsdGlwbGVJY29ucyA9IGljb25zLnByaW1hcnkgJiYgaWNvbnMuc2Vjb25kYXJ5LAoJCQlidXR0b25DbGFzc2VzID0gW107CgoJCWlmICggaWNvbnMucHJpbWFyeSB8fCBpY29ucy5zZWNvbmRhcnkgKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLnRleHQgKSB7CgkJCQlidXR0b25DbGFzc2VzLnB1c2goICJ1aS1idXR0b24tdGV4dC1pY29uIiArICggbXVsdGlwbGVJY29ucyA\/ICJzIiA6ICggaWNvbnMucHJpbWFyeSA\/ICItcHJpbWFyeSIgOiAiLXNlY29uZGFyeSIgKSApICk7CgkJCX0KCgkJCWlmICggaWNvbnMucHJpbWFyeSApIHsKCQkJCWJ1dHRvbkVsZW1lbnQucHJlcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1idXR0b24taWNvbi1wcmltYXJ5IHVpLWljb24gIiArIGljb25zLnByaW1hcnkgKyAiJz48L3NwYW4+IiApOwoJCQl9CgoJCQlpZiAoIGljb25zLnNlY29uZGFyeSApIHsKCQkJCWJ1dHRvbkVsZW1lbnQuYXBwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWJ1dHRvbi1pY29uLXNlY29uZGFyeSB1aS1pY29uICIgKyBpY29ucy5zZWNvbmRhcnkgKyAiJz48L3NwYW4+IiApOwoJCQl9CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCWJ1dHRvbkNsYXNzZXMucHVzaCggbXVsdGlwbGVJY29ucyA\/ICJ1aS1idXR0b24taWNvbnMtb25seSIgOiAidWktYnV0dG9uLWljb24tb25seSIgKTsKCgkJCQlpZiAoICF0aGlzLmhhc1RpdGxlICkgewoJCQkJCWJ1dHRvbkVsZW1lbnQuYXR0ciggInRpdGxlIiwgJC50cmltKCBidXR0b25UZXh0ICkgKTsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCWJ1dHRvbkNsYXNzZXMucHVzaCggInVpLWJ1dHRvbi10ZXh0LW9ubHkiICk7CgkJfQoJCWJ1dHRvbkVsZW1lbnQuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzZXMuam9pbiggIiAiICkgKTsKCX0KfSk7CgokLndpZGdldCggInVpLmJ1dHRvbnNldCIsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJb3B0aW9uczogewoJCWl0ZW1zOiAiYnV0dG9uLCBpbnB1dFt0eXBlPWJ1dHRvbl0sIGlucHV0W3R5cGU9c3VibWl0XSwgaW5wdXRbdHlwZT1yZXNldF0sIGlucHV0W3R5cGU9Y2hlY2tib3hdLCBpbnB1dFt0eXBlPXJhZGlvXSwgYSwgOmRhdGEodWktYnV0dG9uKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktYnV0dG9uc2V0IiApOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLmJ1dHRvbnMuYnV0dG9uKCAib3B0aW9uIiwga2V5LCB2YWx1ZSApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIHJ0bCA9IHRoaXMuZWxlbWVudC5jc3MoICJkaXJlY3Rpb24iICkgPT09ICJydGwiOwoKCQl0aGlzLmJ1dHRvbnMgPSB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkKCQkJLmZpbHRlciggIjp1aS1idXR0b24iICkKCQkJCS5idXR0b24oICJyZWZyZXNoIiApCgkJCS5lbmQoKQoJCQkubm90KCAiOnVpLWJ1dHRvbiIgKQoJCQkJLmJ1dHRvbigpCgkJCS5lbmQoKQoJCQkubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5idXR0b24oICJ3aWRnZXQiIClbIDAgXTsKCQkJfSkKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci1hbGwgdWktY29ybmVyLWxlZnQgdWktY29ybmVyLXJpZ2h0IiApCgkJCQkuZmlsdGVyKCAiOmZpcnN0IiApCgkJCQkJLmFkZENsYXNzKCBydGwgPyAidWktY29ybmVyLXJpZ2h0IiA6ICJ1aS1jb3JuZXItbGVmdCIgKQoJCQkJLmVuZCgpCgkJCQkuZmlsdGVyKCAiOmxhc3QiICkKCQkJCQkuYWRkQ2xhc3MoIHJ0bCA\/ICJ1aS1jb3JuZXItbGVmdCIgOiAidWktY29ybmVyLXJpZ2h0IiApCgkJCQkuZW5kKCkKCQkJLmVuZCgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYnV0dG9uc2V0IiApOwoJCXRoaXMuYnV0dG9ucwoJCQkubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5idXR0b24oICJ3aWRnZXQiIClbIDAgXTsKCQkJfSkKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci1sZWZ0IHVpLWNvcm5lci1yaWdodCIgKQoJCQkuZW5kKCkKCQkJLmJ1dHRvbiggImRlc3Ryb3kiICk7Cgl9Cn0pOwoKfSggalF1ZXJ5ICkgKTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmV4dGVuZCgkLnVpLCB7IGRhdGVwaWNrZXI6IHsgdmVyc2lvbjogIjEuMTAuMyIgfSB9KTsKCnZhciBQUk9QX05BTUUgPSAiZGF0ZXBpY2tlciIsCglpbnN0QWN0aXZlOwoKLyogRGF0ZSBwaWNrZXIgbWFuYWdlci4KICAgVXNlIHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcywgJC5kYXRlcGlja2VyLCB0byBpbnRlcmFjdCB3aXRoIHRoZSBkYXRlIHBpY2tlci4KICAgU2V0dGluZ3MgZm9yIChncm91cHMgb2YpIGRhdGUgcGlja2VycyBhcmUgbWFpbnRhaW5lZCBpbiBhbiBpbnN0YW5jZSBvYmplY3QsCiAgIGFsbG93aW5nIG11bHRpcGxlIGRpZmZlcmVudCBzZXR0aW5ncyBvbiB0aGUgc2FtZSBwYWdlLiAqLwoKZnVuY3Rpb24gRGF0ZXBpY2tlcigpIHsKCXRoaXMuX2N1ckluc3QgPSBudWxsOyAvLyBUaGUgY3VycmVudCBpbnN0YW5jZSBpbiB1c2UKCXRoaXMuX2tleUV2ZW50ID0gZmFsc2U7IC8vIElmIHRoZSBsYXN0IGV2ZW50IHdhcyBhIGtleSBldmVudAoJdGhpcy5fZGlzYWJsZWRJbnB1dHMgPSBbXTsgLy8gTGlzdCBvZiBkYXRlIHBpY2tlciBpbnB1dHMgdGhhdCBoYXZlIGJlZW4gZGlzYWJsZWQKCXRoaXMuX2RhdGVwaWNrZXJTaG93aW5nID0gZmFsc2U7IC8vIFRydWUgaWYgdGhlIHBvcHVwIHBpY2tlciBpcyBzaG93aW5nICwgZmFsc2UgaWYgbm90Cgl0aGlzLl9pbkRpYWxvZyA9IGZhbHNlOyAvLyBUcnVlIGlmIHNob3dpbmcgd2l0aGluIGEgImRpYWxvZyIsIGZhbHNlIGlmIG5vdAoJdGhpcy5fbWFpbkRpdklkID0gInVpLWRhdGVwaWNrZXItZGl2IjsgLy8gVGhlIElEIG9mIHRoZSBtYWluIGRhdGVwaWNrZXIgZGl2aXNpb24KCXRoaXMuX2lubGluZUNsYXNzID0gInVpLWRhdGVwaWNrZXItaW5saW5lIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGlubGluZSBtYXJrZXIgY2xhc3MKCXRoaXMuX2FwcGVuZENsYXNzID0gInVpLWRhdGVwaWNrZXItYXBwZW5kIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGFwcGVuZCBtYXJrZXIgY2xhc3MKCXRoaXMuX3RyaWdnZXJDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLXRyaWdnZXIiOyAvLyBUaGUgbmFtZSBvZiB0aGUgdHJpZ2dlciBtYXJrZXIgY2xhc3MKCXRoaXMuX2RpYWxvZ0NsYXNzID0gInVpLWRhdGVwaWNrZXItZGlhbG9nIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGRpYWxvZyBtYXJrZXIgY2xhc3MKCXRoaXMuX2Rpc2FibGVDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWRpc2FibGVkIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGRpc2FibGVkIGNvdmVyaW5nIG1hcmtlciBjbGFzcwoJdGhpcy5fdW5zZWxlY3RhYmxlQ2xhc3MgPSAidWktZGF0ZXBpY2tlci11bnNlbGVjdGFibGUiOyAvLyBUaGUgbmFtZSBvZiB0aGUgdW5zZWxlY3RhYmxlIGNlbGwgbWFya2VyIGNsYXNzCgl0aGlzLl9jdXJyZW50Q2xhc3MgPSAidWktZGF0ZXBpY2tlci1jdXJyZW50LWRheSI7IC8vIFRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IGRheSBtYXJrZXIgY2xhc3MKCXRoaXMuX2RheU92ZXJDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWRheXMtY2VsbC1vdmVyIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGRheSBob3ZlciBtYXJrZXIgY2xhc3MKCXRoaXMucmVnaW9uYWwgPSBbXTsgLy8gQXZhaWxhYmxlIHJlZ2lvbmFsIHNldHRpbmdzLCBpbmRleGVkIGJ5IGxhbmd1YWdlIGNvZGUKCXRoaXMucmVnaW9uYWxbIiJdID0geyAvLyBEZWZhdWx0IHJlZ2lvbmFsIHNldHRpbmdzCgkJY2xvc2VUZXh0OiAiRG9uZSIsIC8vIERpc3BsYXkgdGV4dCBmb3IgY2xvc2UgbGluawoJCXByZXZUZXh0OiAiUHJldiIsIC8vIERpc3BsYXkgdGV4dCBmb3IgcHJldmlvdXMgbW9udGggbGluawoJCW5leHRUZXh0OiAiTmV4dCIsIC8vIERpc3BsYXkgdGV4dCBmb3IgbmV4dCBtb250aCBsaW5rCgkJY3VycmVudFRleHQ6ICJUb2RheSIsIC8vIERpc3BsYXkgdGV4dCBmb3IgY3VycmVudCBtb250aCBsaW5rCgkJbW9udGhOYW1lczogWyJKYW51YXJ5IiwiRmVicnVhcnkiLCJNYXJjaCIsIkFwcmlsIiwiTWF5IiwiSnVuZSIsCgkJCSJKdWx5IiwiQXVndXN0IiwiU2VwdGVtYmVyIiwiT2N0b2JlciIsIk5vdmVtYmVyIiwiRGVjZW1iZXIiXSwgLy8gTmFtZXMgb2YgbW9udGhzIGZvciBkcm9wLWRvd24gYW5kIGZvcm1hdHRpbmcKCQltb250aE5hbWVzU2hvcnQ6IFsiSmFuIiwgIkZlYiIsICJNYXIiLCAiQXByIiwgIk1heSIsICJKdW4iLCAiSnVsIiwgIkF1ZyIsICJTZXAiLCAiT2N0IiwgIk5vdiIsICJEZWMiXSwgLy8gRm9yIGZvcm1hdHRpbmcKCQlkYXlOYW1lczogWyJTdW5kYXkiLCAiTW9uZGF5IiwgIlR1ZXNkYXkiLCAiV2VkbmVzZGF5IiwgIlRodXJzZGF5IiwgIkZyaWRheSIsICJTYXR1cmRheSJdLCAvLyBGb3IgZm9ybWF0dGluZwoJCWRheU5hbWVzU2hvcnQ6IFsiU3VuIiwgIk1vbiIsICJUdWUiLCAiV2VkIiwgIlRodSIsICJGcmkiLCAiU2F0Il0sIC8vIEZvciBmb3JtYXR0aW5nCgkJZGF5TmFtZXNNaW46IFsiU3UiLCJNbyIsIlR1IiwiV2UiLCJUaCIsIkZyIiwiU2EiXSwgLy8gQ29sdW1uIGhlYWRpbmdzIGZvciBkYXlzIHN0YXJ0aW5nIGF0IFN1bmRheQoJCXdlZWtIZWFkZXI6ICJXayIsIC8vIENvbHVtbiBoZWFkZXIgZm9yIHdlZWsgb2YgdGhlIHllYXIKCQlkYXRlRm9ybWF0OiAibW0vZGQveXkiLCAvLyBTZWUgZm9ybWF0IG9wdGlvbnMgb24gcGFyc2VEYXRlCgkJZmlyc3REYXk6IDAsIC8vIFRoZSBmaXJzdCBkYXkgb2YgdGhlIHdlZWssIFN1biA9IDAsIE1vbiA9IDEsIC4uLgoJCWlzUlRMOiBmYWxzZSwgLy8gVHJ1ZSBpZiByaWdodC10by1sZWZ0IGxhbmd1YWdlLCBmYWxzZSBpZiBsZWZ0LXRvLXJpZ2h0CgkJc2hvd01vbnRoQWZ0ZXJZZWFyOiBmYWxzZSwgLy8gVHJ1ZSBpZiB0aGUgeWVhciBzZWxlY3QgcHJlY2VkZXMgbW9udGgsIGZhbHNlIGZvciBtb250aCB0aGVuIHllYXIKCQl5ZWFyU3VmZml4OiAiIiAvLyBBZGRpdGlvbmFsIHRleHQgdG8gYXBwZW5kIHRvIHRoZSB5ZWFyIGluIHRoZSBtb250aCBoZWFkZXJzCgl9OwoJdGhpcy5fZGVmYXVsdHMgPSB7IC8vIEdsb2JhbCBkZWZhdWx0cyBmb3IgYWxsIHRoZSBkYXRlIHBpY2tlciBpbnN0YW5jZXMKCQlzaG93T246ICJmb2N1cyIsIC8vICJmb2N1cyIgZm9yIHBvcHVwIG9uIGZvY3VzLAoJCQkvLyAiYnV0dG9uIiBmb3IgdHJpZ2dlciBidXR0b24sIG9yICJib3RoIiBmb3IgZWl0aGVyCgkJc2hvd0FuaW06ICJmYWRlSW4iLCAvLyBOYW1lIG9mIGpRdWVyeSBhbmltYXRpb24gZm9yIHBvcHVwCgkJc2hvd09wdGlvbnM6IHt9LCAvLyBPcHRpb25zIGZvciBlbmhhbmNlZCBhbmltYXRpb25zCgkJZGVmYXVsdERhdGU6IG51bGwsIC8vIFVzZWQgd2hlbiBmaWVsZCBpcyBibGFuazogYWN0dWFsIGRhdGUsCgkJCS8vICsvLW51bWJlciBmb3Igb2Zmc2V0IGZyb20gdG9kYXksIG51bGwgZm9yIHRvZGF5CgkJYXBwZW5kVGV4dDogIiIsIC8vIERpc3BsYXkgdGV4dCBmb2xsb3dpbmcgdGhlIGlucHV0IGJveCwgZS5nLiBzaG93aW5nIHRoZSBmb3JtYXQKCQlidXR0b25UZXh0OiAiLi4uIiwgLy8gVGV4dCBmb3IgdHJpZ2dlciBidXR0b24KCQlidXR0b25JbWFnZTogIiIsIC8vIFVSTCBmb3IgdHJpZ2dlciBidXR0b24gaW1hZ2UKCQlidXR0b25JbWFnZU9ubHk6IGZhbHNlLCAvLyBUcnVlIGlmIHRoZSBpbWFnZSBhcHBlYXJzIGFsb25lLCBmYWxzZSBpZiBpdCBhcHBlYXJzIG9uIGEgYnV0dG9uCgkJaGlkZUlmTm9QcmV2TmV4dDogZmFsc2UsIC8vIFRydWUgdG8gaGlkZSBuZXh0L3ByZXZpb3VzIG1vbnRoIGxpbmtzCgkJCS8vIGlmIG5vdCBhcHBsaWNhYmxlLCBmYWxzZSB0byBqdXN0IGRpc2FibGUgdGhlbQoJCW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQ6IGZhbHNlLCAvLyBUcnVlIGlmIGRhdGUgZm9ybWF0dGluZyBhcHBsaWVkIHRvIHByZXYvdG9kYXkvbmV4dCBsaW5rcwoJCWdvdG9DdXJyZW50OiBmYWxzZSwgLy8gVHJ1ZSBpZiB0b2RheSBsaW5rIGdvZXMgYmFjayB0byBjdXJyZW50IHNlbGVjdGlvbiBpbnN0ZWFkCgkJY2hhbmdlTW9udGg6IGZhbHNlLCAvLyBUcnVlIGlmIG1vbnRoIGNhbiBiZSBzZWxlY3RlZCBkaXJlY3RseSwgZmFsc2UgaWYgb25seSBwcmV2L25leHQKCQljaGFuZ2VZZWFyOiBmYWxzZSwgLy8gVHJ1ZSBpZiB5ZWFyIGNhbiBiZSBzZWxlY3RlZCBkaXJlY3RseSwgZmFsc2UgaWYgb25seSBwcmV2L25leHQKCQl5ZWFyUmFuZ2U6ICJjLTEwOmMrMTAiLCAvLyBSYW5nZSBvZiB5ZWFycyB0byBkaXNwbGF5IGluIGRyb3AtZG93biwKCQkJLy8gZWl0aGVyIHJlbGF0aXZlIHRvIHRvZGF5J3MgeWVhciAoLW5uOitubiksIHJlbGF0aXZlIHRvIGN1cnJlbnRseSBkaXNwbGF5ZWQgeWVhcgoJCQkvLyAoYy1ubjpjK25uKSwgYWJzb2x1dGUgKG5ubm46bm5ubiksIG9yIGEgY29tYmluYXRpb24gb2YgdGhlIGFib3ZlIChubm5uOi1uKQoJCXNob3dPdGhlck1vbnRoczogZmFsc2UsIC8vIFRydWUgdG8gc2hvdyBkYXRlcyBpbiBvdGhlciBtb250aHMsIGZhbHNlIHRvIGxlYXZlIGJsYW5rCgkJc2VsZWN0T3RoZXJNb250aHM6IGZhbHNlLCAvLyBUcnVlIHRvIGFsbG93IHNlbGVjdGlvbiBvZiBkYXRlcyBpbiBvdGhlciBtb250aHMsIGZhbHNlIGZvciB1bnNlbGVjdGFibGUKCQlzaG93V2VlazogZmFsc2UsIC8vIFRydWUgdG8gc2hvdyB3ZWVrIG9mIHRoZSB5ZWFyLCBmYWxzZSB0byBub3Qgc2hvdyBpdAoJCWNhbGN1bGF0ZVdlZWs6IHRoaXMuaXNvODYwMVdlZWssIC8vIEhvdyB0byBjYWxjdWxhdGUgdGhlIHdlZWsgb2YgdGhlIHllYXIsCgkJCS8vIHRha2VzIGEgRGF0ZSBhbmQgcmV0dXJucyB0aGUgbnVtYmVyIG9mIHRoZSB3ZWVrIGZvciBpdAoJCXNob3J0WWVhckN1dG9mZjogIisxMCIsIC8vIFNob3J0IHllYXIgdmFsdWVzIDwgdGhpcyBhcmUgaW4gdGhlIGN1cnJlbnQgY2VudHVyeSwKCQkJLy8gPiB0aGlzIGFyZSBpbiB0aGUgcHJldmlvdXMgY2VudHVyeSwKCQkJLy8gc3RyaW5nIHZhbHVlIHN0YXJ0aW5nIHdpdGggIisiIGZvciBjdXJyZW50IHllYXIgKyB2YWx1ZQoJCW1pbkRhdGU6IG51bGwsIC8vIFRoZSBlYXJsaWVzdCBzZWxlY3RhYmxlIGRhdGUsIG9yIG51bGwgZm9yIG5vIGxpbWl0CgkJbWF4RGF0ZTogbnVsbCwgLy8gVGhlIGxhdGVzdCBzZWxlY3RhYmxlIGRhdGUsIG9yIG51bGwgZm9yIG5vIGxpbWl0CgkJZHVyYXRpb246ICJmYXN0IiwgLy8gRHVyYXRpb24gb2YgZGlzcGxheS9jbG9zdXJlCgkJYmVmb3JlU2hvd0RheTogbnVsbCwgLy8gRnVuY3Rpb24gdGhhdCB0YWtlcyBhIGRhdGUgYW5kIHJldHVybnMgYW4gYXJyYXkgd2l0aAoJCQkvLyBbMF0gPSB0cnVlIGlmIHNlbGVjdGFibGUsIGZhbHNlIGlmIG5vdCwgWzFdID0gY3VzdG9tIENTUyBjbGFzcyBuYW1lKHMpIG9yICIiLAoJCQkvLyBbMl0gPSBjZWxsIHRpdGxlIChvcHRpb25hbCksIGUuZy4gJC5kYXRlcGlja2VyLm5vV2Vla2VuZHMKCQliZWZvcmVTaG93OiBudWxsLCAvLyBGdW5jdGlvbiB0aGF0IHRha2VzIGFuIGlucHV0IGZpZWxkIGFuZAoJCQkvLyByZXR1cm5zIGEgc2V0IG9mIGN1c3RvbSBzZXR0aW5ncyBmb3IgdGhlIGRhdGUgcGlja2VyCgkJb25TZWxlY3Q6IG51bGwsIC8vIERlZmluZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gYSBkYXRlIGlzIHNlbGVjdGVkCgkJb25DaGFuZ2VNb250aFllYXI6IG51bGwsIC8vIERlZmluZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gdGhlIG1vbnRoIG9yIHllYXIgaXMgY2hhbmdlZAoJCW9uQ2xvc2U6IG51bGwsIC8vIERlZmluZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gdGhlIGRhdGVwaWNrZXIgaXMgY2xvc2VkCgkJbnVtYmVyT2ZNb250aHM6IDEsIC8vIE51bWJlciBvZiBtb250aHMgdG8gc2hvdyBhdCBhIHRpbWUKCQlzaG93Q3VycmVudEF0UG9zOiAwLCAvLyBUaGUgcG9zaXRpb24gaW4gbXVsdGlwZSBtb250aHMgYXQgd2hpY2ggdG8gc2hvdyB0aGUgY3VycmVudCBtb250aCAoc3RhcnRpbmcgYXQgMCkKCQlzdGVwTW9udGhzOiAxLCAvLyBOdW1iZXIgb2YgbW9udGhzIHRvIHN0ZXAgYmFjay9mb3J3YXJkCgkJc3RlcEJpZ01vbnRoczogMTIsIC8vIE51bWJlciBvZiBtb250aHMgdG8gc3RlcCBiYWNrL2ZvcndhcmQgZm9yIHRoZSBiaWcgbGlua3MKCQlhbHRGaWVsZDogIiIsIC8vIFNlbGVjdG9yIGZvciBhbiBhbHRlcm5hdGUgZmllbGQgdG8gc3RvcmUgc2VsZWN0ZWQgZGF0ZXMgaW50bwoJCWFsdEZvcm1hdDogIiIsIC8vIFRoZSBkYXRlIGZvcm1hdCB0byB1c2UgZm9yIHRoZSBhbHRlcm5hdGUgZmllbGQKCQljb25zdHJhaW5JbnB1dDogdHJ1ZSwgLy8gVGhlIGlucHV0IGlzIGNvbnN0cmFpbmVkIGJ5IHRoZSBjdXJyZW50IGRhdGUgZm9ybWF0CgkJc2hvd0J1dHRvblBhbmVsOiBmYWxzZSwgLy8gVHJ1ZSB0byBzaG93IGJ1dHRvbiBwYW5lbCwgZmFsc2UgdG8gbm90IHNob3cgaXQKCQlhdXRvU2l6ZTogZmFsc2UsIC8vIFRydWUgdG8gc2l6ZSB0aGUgaW5wdXQgZm9yIHRoZSBkYXRlIGZvcm1hdCwgZmFsc2UgdG8gbGVhdmUgYXMgaXMKCQlkaXNhYmxlZDogZmFsc2UgLy8gVGhlIGluaXRpYWwgZGlzYWJsZWQgc3RhdGUKCX07CgkkLmV4dGVuZCh0aGlzLl9kZWZhdWx0cywgdGhpcy5yZWdpb25hbFsiIl0pOwoJdGhpcy5kcERpdiA9IGJpbmRIb3ZlcigkKCI8ZGl2IGlkPSciICsgdGhpcy5fbWFpbkRpdklkICsgIicgY2xhc3M9J3VpLWRhdGVwaWNrZXIgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWhlbHBlci1jbGVhcmZpeCB1aS1jb3JuZXItYWxsJz48L2Rpdj4iKSk7Cn0KCiQuZXh0ZW5kKERhdGVwaWNrZXIucHJvdG90eXBlLCB7CgkvKiBDbGFzcyBuYW1lIGFkZGVkIHRvIGVsZW1lbnRzIHRvIGluZGljYXRlIGFscmVhZHkgY29uZmlndXJlZCB3aXRoIGEgZGF0ZSBwaWNrZXIuICovCgltYXJrZXJDbGFzc05hbWU6ICJoYXNEYXRlcGlja2VyIiwKCgkvL0tlZXAgdHJhY2sgb2YgdGhlIG1heGltdW0gbnVtYmVyIG9mIHJvd3MgZGlzcGxheWVkIChzZWUgIzcwNDMpCgltYXhSb3dzOiA0LAoKCS8vIFRPRE8gcmVuYW1lIHRvICJ3aWRnZXQiIHdoZW4gc3dpdGNoaW5nIHRvIHdpZGdldCBmYWN0b3J5Cglfd2lkZ2V0RGF0ZXBpY2tlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZHBEaXY7Cgl9LAoKCS8qIE92ZXJyaWRlIHRoZSBkZWZhdWx0IHNldHRpbmdzIGZvciBhbGwgaW5zdGFuY2VzIG9mIHRoZSBkYXRlIHBpY2tlci4KCSAqIEBwYXJhbSAgc2V0dGluZ3MgIG9iamVjdCAtIHRoZSBuZXcgc2V0dGluZ3MgdG8gdXNlIGFzIGRlZmF1bHRzIChhbm9ueW1vdXMgb2JqZWN0KQoJICogQHJldHVybiB0aGUgbWFuYWdlciBvYmplY3QKCSAqLwoJc2V0RGVmYXVsdHM6IGZ1bmN0aW9uKHNldHRpbmdzKSB7CgkJZXh0ZW5kUmVtb3ZlKHRoaXMuX2RlZmF1bHRzLCBzZXR0aW5ncyB8fCB7fSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qIEF0dGFjaCB0aGUgZGF0ZSBwaWNrZXIgdG8gYSBqUXVlcnkgc2VsZWN0aW9uLgoJICogQHBhcmFtICB0YXJnZXQJZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICogQHBhcmFtICBzZXR0aW5ncyAgb2JqZWN0IC0gdGhlIG5ldyBzZXR0aW5ncyB0byB1c2UgZm9yIHRoaXMgZGF0ZSBwaWNrZXIgaW5zdGFuY2UgKGFub255bW91cykKCSAqLwoJX2F0dGFjaERhdGVwaWNrZXI6IGZ1bmN0aW9uKHRhcmdldCwgc2V0dGluZ3MpIHsKCQl2YXIgbm9kZU5hbWUsIGlubGluZSwgaW5zdDsKCQlub2RlTmFtZSA9IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCWlubGluZSA9IChub2RlTmFtZSA9PT0gImRpdiIgfHwgbm9kZU5hbWUgPT09ICJzcGFuIik7CgkJaWYgKCF0YXJnZXQuaWQpIHsKCQkJdGhpcy51dWlkICs9IDE7CgkJCXRhcmdldC5pZCA9ICJkcCIgKyB0aGlzLnV1aWQ7CgkJfQoJCWluc3QgPSB0aGlzLl9uZXdJbnN0KCQodGFyZ2V0KSwgaW5saW5lKTsKCQlpbnN0LnNldHRpbmdzID0gJC5leHRlbmQoe30sIHNldHRpbmdzIHx8IHt9KTsKCQlpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIpIHsKCQkJdGhpcy5fY29ubmVjdERhdGVwaWNrZXIodGFyZ2V0LCBpbnN0KTsKCQl9IGVsc2UgaWYgKGlubGluZSkgewoJCQl0aGlzLl9pbmxpbmVEYXRlcGlja2VyKHRhcmdldCwgaW5zdCk7CgkJfQoJfSwKCgkvKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2JqZWN0LiAqLwoJX25ld0luc3Q6IGZ1bmN0aW9uKHRhcmdldCwgaW5saW5lKSB7CgkJdmFyIGlkID0gdGFyZ2V0WzBdLmlkLnJlcGxhY2UoLyhbXkEtWmEtejAtOV9cLV0pL2csICJcXFxcJDEiKTsgLy8gZXNjYXBlIGpRdWVyeSBtZXRhIGNoYXJzCgkJcmV0dXJuIHtpZDogaWQsIGlucHV0OiB0YXJnZXQsIC8vIGFzc29jaWF0ZWQgdGFyZ2V0CgkJCXNlbGVjdGVkRGF5OiAwLCBzZWxlY3RlZE1vbnRoOiAwLCBzZWxlY3RlZFllYXI6IDAsIC8vIGN1cnJlbnQgc2VsZWN0aW9uCgkJCWRyYXdNb250aDogMCwgZHJhd1llYXI6IDAsIC8vIG1vbnRoIGJlaW5nIGRyYXduCgkJCWlubGluZTogaW5saW5lLCAvLyBpcyBkYXRlcGlja2VyIGlubGluZSBvciBub3QKCQkJZHBEaXY6ICghaW5saW5lID8gdGhpcy5kcERpdiA6IC8vIHByZXNlbnRhdGlvbiBkaXYKCQkJYmluZEhvdmVyKCQoIjxkaXYgY2xhc3M9JyIgKyB0aGlzLl9pbmxpbmVDbGFzcyArICIgdWktZGF0ZXBpY2tlciB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktaGVscGVyLWNsZWFyZml4IHVpLWNvcm5lci1hbGwnPjwvZGl2PiIpKSl9OwoJfSwKCgkvKiBBdHRhY2ggdGhlIGRhdGUgcGlja2VyIHRvIGFuIGlucHV0IGZpZWxkLiAqLwoJX2Nvbm5lY3REYXRlcGlja2VyOiBmdW5jdGlvbih0YXJnZXQsIGluc3QpIHsKCQl2YXIgaW5wdXQgPSAkKHRhcmdldCk7CgkJaW5zdC5hcHBlbmQgPSAkKFtdKTsKCQlpbnN0LnRyaWdnZXIgPSAkKFtdKTsKCQlpZiAoaW5wdXQuaGFzQ2xhc3ModGhpcy5tYXJrZXJDbGFzc05hbWUpKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fYXR0YWNobWVudHMoaW5wdXQsIGluc3QpOwoJCWlucHV0LmFkZENsYXNzKHRoaXMubWFya2VyQ2xhc3NOYW1lKS5rZXlkb3duKHRoaXMuX2RvS2V5RG93bikuCgkJCWtleXByZXNzKHRoaXMuX2RvS2V5UHJlc3MpLmtleXVwKHRoaXMuX2RvS2V5VXApOwoJCXRoaXMuX2F1dG9TaXplKGluc3QpOwoJCSQuZGF0YSh0YXJnZXQsIFBST1BfTkFNRSwgaW5zdCk7CgkJLy9JZiBkaXNhYmxlZCBvcHRpb24gaXMgdHJ1ZSwgZGlzYWJsZSB0aGUgZGF0ZXBpY2tlciBvbmNlIGl0IGhhcyBiZWVuIGF0dGFjaGVkIHRvIHRoZSBpbnB1dCAoc2VlIHRpY2tldCAjNTY2NSkKCQlpZiggaW5zdC5zZXR0aW5ncy5kaXNhYmxlZCApIHsKCQkJdGhpcy5fZGlzYWJsZURhdGVwaWNrZXIoIHRhcmdldCApOwoJCX0KCX0sCgoJLyogTWFrZSBhdHRhY2htZW50cyBiYXNlZCBvbiBzZXR0aW5ncy4gKi8KCV9hdHRhY2htZW50czogZnVuY3Rpb24oaW5wdXQsIGluc3QpIHsKCQl2YXIgc2hvd09uLCBidXR0b25UZXh0LCBidXR0b25JbWFnZSwKCQkJYXBwZW5kVGV4dCA9IHRoaXMuX2dldChpbnN0LCAiYXBwZW5kVGV4dCIpLAoJCQlpc1JUTCA9IHRoaXMuX2dldChpbnN0LCAiaXNSVEwiKTsKCgkJaWYgKGluc3QuYXBwZW5kKSB7CgkJCWluc3QuYXBwZW5kLnJlbW92ZSgpOwoJCX0KCQlpZiAoYXBwZW5kVGV4dCkgewoJCQlpbnN0LmFwcGVuZCA9ICQoIjxzcGFuIGNsYXNzPSciICsgdGhpcy5fYXBwZW5kQ2xhc3MgKyAiJz4iICsgYXBwZW5kVGV4dCArICI8L3NwYW4+Iik7CgkJCWlucHV0W2lzUlRMID8gImJlZm9yZSIgOiAiYWZ0ZXIiXShpbnN0LmFwcGVuZCk7CgkJfQoKCQlpbnB1dC51bmJpbmQoImZvY3VzIiwgdGhpcy5fc2hvd0RhdGVwaWNrZXIpOwoKCQlpZiAoaW5zdC50cmlnZ2VyKSB7CgkJCWluc3QudHJpZ2dlci5yZW1vdmUoKTsKCQl9CgoJCXNob3dPbiA9IHRoaXMuX2dldChpbnN0LCAic2hvd09uIik7CgkJaWYgKHNob3dPbiA9PT0gImZvY3VzIiB8fCBzaG93T24gPT09ICJib3RoIikgeyAvLyBwb3AtdXAgZGF0ZSBwaWNrZXIgd2hlbiBpbiB0aGUgbWFya2VkIGZpZWxkCgkJCWlucHV0LmZvY3VzKHRoaXMuX3Nob3dEYXRlcGlja2VyKTsKCQl9CgkJaWYgKHNob3dPbiA9PT0gImJ1dHRvbiIgfHwgc2hvd09uID09PSAiYm90aCIpIHsgLy8gcG9wLXVwIGRhdGUgcGlja2VyIHdoZW4gYnV0dG9uIGNsaWNrZWQKCQkJYnV0dG9uVGV4dCA9IHRoaXMuX2dldChpbnN0LCAiYnV0dG9uVGV4dCIpOwoJCQlidXR0b25JbWFnZSA9IHRoaXMuX2dldChpbnN0LCAiYnV0dG9uSW1hZ2UiKTsKCQkJaW5zdC50cmlnZ2VyID0gJCh0aGlzLl9nZXQoaW5zdCwgImJ1dHRvbkltYWdlT25seSIpID8KCQkJCSQoIjxpbWcvPiIpLmFkZENsYXNzKHRoaXMuX3RyaWdnZXJDbGFzcykuCgkJCQkJYXR0cih7IHNyYzogYnV0dG9uSW1hZ2UsIGFsdDogYnV0dG9uVGV4dCwgdGl0bGU6IGJ1dHRvblRleHQgfSkgOgoJCQkJJCgiPGJ1dHRvbiB0eXBlPSdidXR0b24nPjwvYnV0dG9uPiIpLmFkZENsYXNzKHRoaXMuX3RyaWdnZXJDbGFzcykuCgkJCQkJaHRtbCghYnV0dG9uSW1hZ2UgPyBidXR0b25UZXh0IDogJCgiPGltZy8+IikuYXR0cigKCQkJCQl7IHNyYzpidXR0b25JbWFnZSwgYWx0OmJ1dHRvblRleHQsIHRpdGxlOmJ1dHRvblRleHQgfSkpKTsKCQkJaW5wdXRbaXNSVEwgPyAiYmVmb3JlIiA6ICJhZnRlciJdKGluc3QudHJpZ2dlcik7CgkJCWluc3QudHJpZ2dlci5jbGljayhmdW5jdGlvbigpIHsKCQkJCWlmICgkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nICYmICQuZGF0ZXBpY2tlci5fbGFzdElucHV0ID09PSBpbnB1dFswXSkgewoJCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQkJCX0gZWxzZSBpZiAoJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyAmJiAkLmRhdGVwaWNrZXIuX2xhc3RJbnB1dCAhPT0gaW5wdXRbMF0pIHsKCQkJCQkkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7CgkJCQkJJC5kYXRlcGlja2VyLl9zaG93RGF0ZXBpY2tlcihpbnB1dFswXSk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0ZXBpY2tlci5fc2hvd0RhdGVwaWNrZXIoaW5wdXRbMF0pOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KTsKCQl9Cgl9LAoKCS8qIEFwcGx5IHRoZSBtYXhpbXVtIGxlbmd0aCBmb3IgdGhlIGRhdGUgZm9ybWF0LiAqLwoJX2F1dG9TaXplOiBmdW5jdGlvbihpbnN0KSB7CgkJaWYgKHRoaXMuX2dldChpbnN0LCAiYXV0b1NpemUiKSAmJiAhaW5zdC5pbmxpbmUpIHsKCQkJdmFyIGZpbmRNYXgsIG1heCwgbWF4SSwgaSwKCQkJCWRhdGUgPSBuZXcgRGF0ZSgyMDA5LCAxMiAtIDEsIDIwKSwgLy8gRW5zdXJlIGRvdWJsZSBkaWdpdHMKCQkJCWRhdGVGb3JtYXQgPSB0aGlzLl9nZXQoaW5zdCwgImRhdGVGb3JtYXQiKTsKCgkJCWlmIChkYXRlRm9ybWF0Lm1hdGNoKC9bRE1dLykpIHsKCQkJCWZpbmRNYXggPSBmdW5jdGlvbihuYW1lcykgewoJCQkJCW1heCA9IDA7CgkJCQkJbWF4SSA9IDA7CgkJCQkJZm9yIChpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CgkJCQkJCWlmIChuYW1lc1tpXS5sZW5ndGggPiBtYXgpIHsKCQkJCQkJCW1heCA9IG5hbWVzW2ldLmxlbmd0aDsKCQkJCQkJCW1heEkgPSBpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiBtYXhJOwoJCQkJfTsKCQkJCWRhdGUuc2V0TW9udGgoZmluZE1heCh0aGlzLl9nZXQoaW5zdCwgKGRhdGVGb3JtYXQubWF0Y2goL01NLykgPwoJCQkJCSJtb250aE5hbWVzIiA6ICJtb250aE5hbWVzU2hvcnQiKSkpKTsKCQkJCWRhdGUuc2V0RGF0ZShmaW5kTWF4KHRoaXMuX2dldChpbnN0LCAoZGF0ZUZvcm1hdC5tYXRjaCgvREQvKSA\/CgkJCQkJImRheU5hbWVzIiA6ICJkYXlOYW1lc1Nob3J0IikpKSArIDIwIC0gZGF0ZS5nZXREYXkoKSk7CgkJCX0KCQkJaW5zdC5pbnB1dC5hdHRyKCJzaXplIiwgdGhpcy5fZm9ybWF0RGF0ZShpbnN0LCBkYXRlKS5sZW5ndGgpOwoJCX0KCX0sCgoJLyogQXR0YWNoIGFuIGlubGluZSBkYXRlIHBpY2tlciB0byBhIGRpdi4gKi8KCV9pbmxpbmVEYXRlcGlja2VyOiBmdW5jdGlvbih0YXJnZXQsIGluc3QpIHsKCQl2YXIgZGl2U3BhbiA9ICQodGFyZ2V0KTsKCQlpZiAoZGl2U3Bhbi5oYXNDbGFzcyh0aGlzLm1hcmtlckNsYXNzTmFtZSkpIHsKCQkJcmV0dXJuOwoJCX0KCQlkaXZTcGFuLmFkZENsYXNzKHRoaXMubWFya2VyQ2xhc3NOYW1lKS5hcHBlbmQoaW5zdC5kcERpdik7CgkJJC5kYXRhKHRhcmdldCwgUFJPUF9OQU1FLCBpbnN0KTsKCQl0aGlzLl9zZXREYXRlKGluc3QsIHRoaXMuX2dldERlZmF1bHREYXRlKGluc3QpLCB0cnVlKTsKCQl0aGlzLl91cGRhdGVEYXRlcGlja2VyKGluc3QpOwoJCXRoaXMuX3VwZGF0ZUFsdGVybmF0ZShpbnN0KTsKCQkvL0lmIGRpc2FibGVkIG9wdGlvbiBpcyB0cnVlLCBkaXNhYmxlIHRoZSBkYXRlcGlja2VyIGJlZm9yZSBzaG93aW5nIGl0IChzZWUgdGlja2V0ICM1NjY1KQoJCWlmKCBpbnN0LnNldHRpbmdzLmRpc2FibGVkICkgewoJCQl0aGlzLl9kaXNhYmxlRGF0ZXBpY2tlciggdGFyZ2V0ICk7CgkJfQoJCS8vIFNldCBkaXNwbGF5OmJsb2NrIGluIHBsYWNlIG9mIGluc3QuZHBEaXYuc2hvdygpIHdoaWNoIHdvbid0IHdvcmsgb24gZGlzY29ubmVjdGVkIGVsZW1lbnRzCgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5dWkuY29tL3RpY2tldC83NTUyIC0gQSBEYXRlcGlja2VyIGNyZWF0ZWQgb24gYSBkZXRhY2hlZCBkaXYgaGFzIHplcm8gaGVpZ2h0CgkJaW5zdC5kcERpdi5jc3MoICJkaXNwbGF5IiwgImJsb2NrIiApOwoJfSwKCgkvKiBQb3AtdXAgdGhlIGRhdGUgcGlja2VyIGluIGEgImRpYWxvZyIgYm94LgoJICogQHBhcmFtICBpbnB1dCBlbGVtZW50IC0gaWdub3JlZAoJICogQHBhcmFtICBkYXRlCXN0cmluZyBvciBEYXRlIC0gdGhlIGluaXRpYWwgZGF0ZSB0byBkaXNwbGF5CgkgKiBAcGFyYW0gIG9uU2VsZWN0ICBmdW5jdGlvbiAtIHRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gYSBkYXRlIGlzIHNlbGVjdGVkCgkgKiBAcGFyYW0gIHNldHRpbmdzICBvYmplY3QgLSB1cGRhdGUgdGhlIGRpYWxvZyBkYXRlIHBpY2tlciBpbnN0YW5jZSdzIHNldHRpbmdzIChhbm9ueW1vdXMgb2JqZWN0KQoJICogQHBhcmFtICBwb3MgaW50WzJdIC0gY29vcmRpbmF0ZXMgZm9yIHRoZSBkaWFsb2cncyBwb3NpdGlvbiB3aXRoaW4gdGhlIHNjcmVlbiBvcgoJICoJCQkJCWV2ZW50IC0gd2l0aCB4L3kgY29vcmRpbmF0ZXMgb3IKCSAqCQkJCQlsZWF2ZSBlbXB0eSBmb3IgZGVmYXVsdCAoc2NyZWVuIGNlbnRyZSkKCSAqIEByZXR1cm4gdGhlIG1hbmFnZXIgb2JqZWN0CgkgKi8KCV9kaWFsb2dEYXRlcGlja2VyOiBmdW5jdGlvbihpbnB1dCwgZGF0ZSwgb25TZWxlY3QsIHNldHRpbmdzLCBwb3MpIHsKCQl2YXIgaWQsIGJyb3dzZXJXaWR0aCwgYnJvd3NlckhlaWdodCwgc2Nyb2xsWCwgc2Nyb2xsWSwKCQkJaW5zdCA9IHRoaXMuX2RpYWxvZ0luc3Q7IC8vIGludGVybmFsIGluc3RhbmNlCgoJCWlmICghaW5zdCkgewoJCQl0aGlzLnV1aWQgKz0gMTsKCQkJaWQgPSAiZHAiICsgdGhpcy51dWlkOwoJCQl0aGlzLl9kaWFsb2dJbnB1dCA9ICQoIjxpbnB1dCB0eXBlPSd0ZXh0JyBpZD0nIiArIGlkICsKCQkJCSInIHN0eWxlPSdwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogLTEwMHB4OyB3aWR0aDogMHB4OycvPiIpOwoJCQl0aGlzLl9kaWFsb2dJbnB1dC5rZXlkb3duKHRoaXMuX2RvS2V5RG93bik7CgkJCSQoImJvZHkiKS5hcHBlbmQodGhpcy5fZGlhbG9nSW5wdXQpOwoJCQlpbnN0ID0gdGhpcy5fZGlhbG9nSW5zdCA9IHRoaXMuX25ld0luc3QodGhpcy5fZGlhbG9nSW5wdXQsIGZhbHNlKTsKCQkJaW5zdC5zZXR0aW5ncyA9IHt9OwoJCQkkLmRhdGEodGhpcy5fZGlhbG9nSW5wdXRbMF0sIFBST1BfTkFNRSwgaW5zdCk7CgkJfQoJCWV4dGVuZFJlbW92ZShpbnN0LnNldHRpbmdzLCBzZXR0aW5ncyB8fCB7fSk7CgkJZGF0ZSA9IChkYXRlICYmIGRhdGUuY29uc3RydWN0b3IgPT09IERhdGUgPyB0aGlzLl9mb3JtYXREYXRlKGluc3QsIGRhdGUpIDogZGF0ZSk7CgkJdGhpcy5fZGlhbG9nSW5wdXQudmFsKGRhdGUpOwoKCQl0aGlzLl9wb3MgPSAocG9zID8gKHBvcy5sZW5ndGggPyBwb3MgOiBbcG9zLnBhZ2VYLCBwb3MucGFnZVldKSA6IG51bGwpOwoJCWlmICghdGhpcy5fcG9zKSB7CgkJCWJyb3dzZXJXaWR0aCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDsKCQkJYnJvd3NlckhlaWdodCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQ7CgkJCXNjcm9sbFggPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQ7CgkJCXNjcm9sbFkgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIHx8IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wOwoJCQl0aGlzLl9wb3MgPSAvLyBzaG91bGQgdXNlIGFjdHVhbCB3aWR0aC9oZWlnaHQgYmVsb3cKCQkJCVsoYnJvd3NlcldpZHRoIC8gMikgLSAxMDAgKyBzY3JvbGxYLCAoYnJvd3NlckhlaWdodCAvIDIpIC0gMTUwICsgc2Nyb2xsWV07CgkJfQoKCQkvLyBtb3ZlIGlucHV0IG9uIHNjcmVlbiBmb3IgZm9jdXMsIGJ1dCBoaWRkZW4gYmVoaW5kIGRpYWxvZwoJCXRoaXMuX2RpYWxvZ0lucHV0LmNzcygibGVmdCIsICh0aGlzLl9wb3NbMF0gKyAyMCkgKyAicHgiKS5jc3MoInRvcCIsIHRoaXMuX3Bvc1sxXSArICJweCIpOwoJCWluc3Quc2V0dGluZ3Mub25TZWxlY3QgPSBvblNlbGVjdDsKCQl0aGlzLl9pbkRpYWxvZyA9IHRydWU7CgkJdGhpcy5kcERpdi5hZGRDbGFzcyh0aGlzLl9kaWFsb2dDbGFzcyk7CgkJdGhpcy5fc2hvd0RhdGVwaWNrZXIodGhpcy5fZGlhbG9nSW5wdXRbMF0pOwoJCWlmICgkLmJsb2NrVUkpIHsKCQkJJC5ibG9ja1VJKHRoaXMuZHBEaXYpOwoJCX0KCQkkLmRhdGEodGhpcy5fZGlhbG9nSW5wdXRbMF0sIFBST1BfTkFNRSwgaW5zdCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCS8qIERldGFjaCBhIGRhdGVwaWNrZXIgZnJvbSBpdHMgY29udHJvbC4KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqLwoJX2Rlc3Ryb3lEYXRlcGlja2VyOiBmdW5jdGlvbih0YXJnZXQpIHsKCQl2YXIgbm9kZU5hbWUsCgkJCSR0YXJnZXQgPSAkKHRhcmdldCksCgkJCWluc3QgPSAkLmRhdGEodGFyZ2V0LCBQUk9QX05BTUUpOwoKCQlpZiAoISR0YXJnZXQuaGFzQ2xhc3ModGhpcy5tYXJrZXJDbGFzc05hbWUpKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vZGVOYW1lID0gdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJJC5yZW1vdmVEYXRhKHRhcmdldCwgUFJPUF9OQU1FKTsKCQlpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIpIHsKCQkJaW5zdC5hcHBlbmQucmVtb3ZlKCk7CgkJCWluc3QudHJpZ2dlci5yZW1vdmUoKTsKCQkJJHRhcmdldC5yZW1vdmVDbGFzcyh0aGlzLm1hcmtlckNsYXNzTmFtZSkuCgkJCQl1bmJpbmQoImZvY3VzIiwgdGhpcy5fc2hvd0RhdGVwaWNrZXIpLgoJCQkJdW5iaW5kKCJrZXlkb3duIiwgdGhpcy5fZG9LZXlEb3duKS4KCQkJCXVuYmluZCgia2V5cHJlc3MiLCB0aGlzLl9kb0tleVByZXNzKS4KCQkJCXVuYmluZCgia2V5dXAiLCB0aGlzLl9kb0tleVVwKTsKCQl9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAiZGl2IiB8fCBub2RlTmFtZSA9PT0gInNwYW4iKSB7CgkJCSR0YXJnZXQucmVtb3ZlQ2xhc3ModGhpcy5tYXJrZXJDbGFzc05hbWUpLmVtcHR5KCk7CgkJfQoJfSwKCgkvKiBFbmFibGUgdGhlIGRhdGUgcGlja2VyIHRvIGEgalF1ZXJ5IHNlbGVjdGlvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqLwoJX2VuYWJsZURhdGVwaWNrZXI6IGZ1bmN0aW9uKHRhcmdldCkgewoJCXZhciBub2RlTmFtZSwgaW5saW5lLAoJCQkkdGFyZ2V0ID0gJCh0YXJnZXQpLAoJCQlpbnN0ID0gJC5kYXRhKHRhcmdldCwgUFJPUF9OQU1FKTsKCgkJaWYgKCEkdGFyZ2V0Lmhhc0NsYXNzKHRoaXMubWFya2VyQ2xhc3NOYW1lKSkgewoJCQlyZXR1cm47CgkJfQoKCQlub2RlTmFtZSA9IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCWlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewoJCQl0YXJnZXQuZGlzYWJsZWQgPSBmYWxzZTsKCQkJaW5zdC50cmlnZ2VyLmZpbHRlcigiYnV0dG9uIikuCgkJCQllYWNoKGZ1bmN0aW9uKCkgeyB0aGlzLmRpc2FibGVkID0gZmFsc2U7IH0pLmVuZCgpLgoJCQkJZmlsdGVyKCJpbWciKS5jc3Moe29wYWNpdHk6ICIxLjAiLCBjdXJzb3I6ICIifSk7CgkJfSBlbHNlIGlmIChub2RlTmFtZSA9PT0gImRpdiIgfHwgbm9kZU5hbWUgPT09ICJzcGFuIikgewoJCQlpbmxpbmUgPSAkdGFyZ2V0LmNoaWxkcmVuKCIuIiArIHRoaXMuX2lubGluZUNsYXNzKTsKCQkJaW5saW5lLmNoaWxkcmVuKCkucmVtb3ZlQ2xhc3MoInVpLXN0YXRlLWRpc2FibGVkIik7CgkJCWlubGluZS5maW5kKCJzZWxlY3QudWktZGF0ZXBpY2tlci1tb250aCwgc2VsZWN0LnVpLWRhdGVwaWNrZXIteWVhciIpLgoJCQkJcHJvcCgiZGlzYWJsZWQiLCBmYWxzZSk7CgkJfQoJCXRoaXMuX2Rpc2FibGVkSW5wdXRzID0gJC5tYXAodGhpcy5fZGlzYWJsZWRJbnB1dHMsCgkJCWZ1bmN0aW9uKHZhbHVlKSB7IHJldHVybiAodmFsdWUgPT09IHRhcmdldCA\/IG51bGwgOiB2YWx1ZSk7IH0pOyAvLyBkZWxldGUgZW50cnkKCX0sCgoJLyogRGlzYWJsZSB0aGUgZGF0ZSBwaWNrZXIgdG8gYSBqUXVlcnkgc2VsZWN0aW9uLgoJICogQHBhcmFtICB0YXJnZXQJZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICovCglfZGlzYWJsZURhdGVwaWNrZXI6IGZ1bmN0aW9uKHRhcmdldCkgewoJCXZhciBub2RlTmFtZSwgaW5saW5lLAoJCQkkdGFyZ2V0ID0gJCh0YXJnZXQpLAoJCQlpbnN0ID0gJC5kYXRhKHRhcmdldCwgUFJPUF9OQU1FKTsKCgkJaWYgKCEkdGFyZ2V0Lmhhc0NsYXNzKHRoaXMubWFya2VyQ2xhc3NOYW1lKSkgewoJCQlyZXR1cm47CgkJfQoKCQlub2RlTmFtZSA9IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCWlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewoJCQl0YXJnZXQuZGlzYWJsZWQgPSB0cnVlOwoJCQlpbnN0LnRyaWdnZXIuZmlsdGVyKCJidXR0b24iKS4KCQkJCWVhY2goZnVuY3Rpb24oKSB7IHRoaXMuZGlzYWJsZWQgPSB0cnVlOyB9KS5lbmQoKS4KCQkJCWZpbHRlcigiaW1nIikuY3NzKHtvcGFjaXR5OiAiMC41IiwgY3Vyc29yOiAiZGVmYXVsdCJ9KTsKCQl9IGVsc2UgaWYgKG5vZGVOYW1lID09PSAiZGl2IiB8fCBub2RlTmFtZSA9PT0gInNwYW4iKSB7CgkJCWlubGluZSA9ICR0YXJnZXQuY2hpbGRyZW4oIi4iICsgdGhpcy5faW5saW5lQ2xhc3MpOwoJCQlpbmxpbmUuY2hpbGRyZW4oKS5hZGRDbGFzcygidWktc3RhdGUtZGlzYWJsZWQiKTsKCQkJaW5saW5lLmZpbmQoInNlbGVjdC51aS1kYXRlcGlja2VyLW1vbnRoLCBzZWxlY3QudWktZGF0ZXBpY2tlci15ZWFyIikuCgkJCQlwcm9wKCJkaXNhYmxlZCIsIHRydWUpOwoJCX0KCQl0aGlzLl9kaXNhYmxlZElucHV0cyA9ICQubWFwKHRoaXMuX2Rpc2FibGVkSW5wdXRzLAoJCQlmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gKHZhbHVlID09PSB0YXJnZXQgPyBudWxsIDogdmFsdWUpOyB9KTsgLy8gZGVsZXRlIGVudHJ5CgkJdGhpcy5fZGlzYWJsZWRJbnB1dHNbdGhpcy5fZGlzYWJsZWRJbnB1dHMubGVuZ3RoXSA9IHRhcmdldDsKCX0sCgoJLyogSXMgdGhlIGZpcnN0IGZpZWxkIGluIGEgalF1ZXJ5IGNvbGxlY3Rpb24gZGlzYWJsZWQgYXMgYSBkYXRlcGlja2VyPwoJICogQHBhcmFtICB0YXJnZXQJZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICogQHJldHVybiBib29sZWFuIC0gdHJ1ZSBpZiBkaXNhYmxlZCwgZmFsc2UgaWYgZW5hYmxlZAoJICovCglfaXNEaXNhYmxlZERhdGVwaWNrZXI6IGZ1bmN0aW9uKHRhcmdldCkgewoJCWlmICghdGFyZ2V0KSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9kaXNhYmxlZElucHV0cy5sZW5ndGg7IGkrKykgewoJCQlpZiAodGhpcy5fZGlzYWJsZWRJbnB1dHNbaV0gPT09IHRhcmdldCkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCgkvKiBSZXRyaWV2ZSB0aGUgaW5zdGFuY2UgZGF0YSBmb3IgdGhlIHRhcmdldCBjb250cm9sLgoJICogQHBhcmFtICB0YXJnZXQgIGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqIEByZXR1cm4gIG9iamVjdCAtIHRoZSBhc3NvY2lhdGVkIGluc3RhbmNlIGRhdGEKCSAqIEB0aHJvd3MgIGVycm9yIGlmIGEgalF1ZXJ5IHByb2JsZW0gZ2V0dGluZyBkYXRhCgkgKi8KCV9nZXRJbnN0OiBmdW5jdGlvbih0YXJnZXQpIHsKCQl0cnkgewoJCQlyZXR1cm4gJC5kYXRhKHRhcmdldCwgUFJPUF9OQU1FKTsKCQl9CgkJY2F0Y2ggKGVycikgewoJCQl0aHJvdyAiTWlzc2luZyBpbnN0YW5jZSBkYXRhIGZvciB0aGlzIGRhdGVwaWNrZXIiOwoJCX0KCX0sCgoJLyogVXBkYXRlIG9yIHJldHJpZXZlIHRoZSBzZXR0aW5ncyBmb3IgYSBkYXRlIHBpY2tlciBhdHRhY2hlZCB0byBhbiBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0ICBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKiBAcGFyYW0gIG5hbWUJb2JqZWN0IC0gdGhlIG5ldyBzZXR0aW5ncyB0byB1cGRhdGUgb3IKCSAqCQkJCXN0cmluZyAtIHRoZSBuYW1lIG9mIHRoZSBzZXR0aW5nIHRvIGNoYW5nZSBvciByZXRyaWV2ZSwKCSAqCQkJCXdoZW4gcmV0cmlldmluZyBhbHNvICJhbGwiIGZvciBhbGwgaW5zdGFuY2Ugc2V0dGluZ3Mgb3IKCSAqCQkJCSJkZWZhdWx0cyIgZm9yIGFsbCBnbG9iYWwgZGVmYXVsdHMKCSAqIEBwYXJhbSAgdmFsdWUgICBhbnkgLSB0aGUgbmV3IHZhbHVlIGZvciB0aGUgc2V0dGluZwoJICoJCQkJKG9taXQgaWYgYWJvdmUgaXMgYW4gb2JqZWN0IG9yIHRvIHJldHJpZXZlIGEgdmFsdWUpCgkgKi8KCV9vcHRpb25EYXRlcGlja2VyOiBmdW5jdGlvbih0YXJnZXQsIG5hbWUsIHZhbHVlKSB7CgkJdmFyIHNldHRpbmdzLCBkYXRlLCBtaW5EYXRlLCBtYXhEYXRlLAoJCQlpbnN0ID0gdGhpcy5fZ2V0SW5zdCh0YXJnZXQpOwoKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIpIHsKCQkJcmV0dXJuIChuYW1lID09PSAiZGVmYXVsdHMiID8gJC5leHRlbmQoe30sICQuZGF0ZXBpY2tlci5fZGVmYXVsdHMpIDoKCQkJCShpbnN0ID8gKG5hbWUgPT09ICJhbGwiID8gJC5leHRlbmQoe30sIGluc3Quc2V0dGluZ3MpIDoKCQkJCXRoaXMuX2dldChpbnN0LCBuYW1lKSkgOiBudWxsKSk7CgkJfQoKCQlzZXR0aW5ncyA9IG5hbWUgfHwge307CgkJaWYgKHR5cGVvZiBuYW1lID09PSAic3RyaW5nIikgewoJCQlzZXR0aW5ncyA9IHt9OwoJCQlzZXR0aW5nc1tuYW1lXSA9IHZhbHVlOwoJCX0KCgkJaWYgKGluc3QpIHsKCQkJaWYgKHRoaXMuX2N1ckluc3QgPT09IGluc3QpIHsKCQkJCXRoaXMuX2hpZGVEYXRlcGlja2VyKCk7CgkJCX0KCgkJCWRhdGUgPSB0aGlzLl9nZXREYXRlRGF0ZXBpY2tlcih0YXJnZXQsIHRydWUpOwoJCQltaW5EYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZShpbnN0LCAibWluIik7CgkJCW1heERhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKGluc3QsICJtYXgiKTsKCQkJZXh0ZW5kUmVtb3ZlKGluc3Quc2V0dGluZ3MsIHNldHRpbmdzKTsKCQkJLy8gcmVmb3JtYXQgdGhlIG9sZCBtaW5EYXRlL21heERhdGUgdmFsdWVzIGlmIGRhdGVGb3JtYXQgY2hhbmdlcyBhbmQgYSBuZXcgbWluRGF0ZS9tYXhEYXRlIGlzbid0IHByb3ZpZGVkCgkJCWlmIChtaW5EYXRlICE9PSBudWxsICYmIHNldHRpbmdzLmRhdGVGb3JtYXQgIT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy5taW5EYXRlID09PSB1bmRlZmluZWQpIHsKCQkJCWluc3Quc2V0dGluZ3MubWluRGF0ZSA9IHRoaXMuX2Zvcm1hdERhdGUoaW5zdCwgbWluRGF0ZSk7CgkJCX0KCQkJaWYgKG1heERhdGUgIT09IG51bGwgJiYgc2V0dGluZ3MuZGF0ZUZvcm1hdCAhPT0gdW5kZWZpbmVkICYmIHNldHRpbmdzLm1heERhdGUgPT09IHVuZGVmaW5lZCkgewoJCQkJaW5zdC5zZXR0aW5ncy5tYXhEYXRlID0gdGhpcy5fZm9ybWF0RGF0ZShpbnN0LCBtYXhEYXRlKTsKCQkJfQoJCQlpZiAoICJkaXNhYmxlZCIgaW4gc2V0dGluZ3MgKSB7CgkJCQlpZiAoIHNldHRpbmdzLmRpc2FibGVkICkgewoJCQkJCXRoaXMuX2Rpc2FibGVEYXRlcGlja2VyKHRhcmdldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX2VuYWJsZURhdGVwaWNrZXIodGFyZ2V0KTsKCQkJCX0KCQkJfQoJCQl0aGlzLl9hdHRhY2htZW50cygkKHRhcmdldCksIGluc3QpOwoJCQl0aGlzLl9hdXRvU2l6ZShpbnN0KTsKCQkJdGhpcy5fc2V0RGF0ZShpbnN0LCBkYXRlKTsKCQkJdGhpcy5fdXBkYXRlQWx0ZXJuYXRlKGluc3QpOwoJCQl0aGlzLl91cGRhdGVEYXRlcGlja2VyKGluc3QpOwoJCX0KCX0sCgoJLy8gY2hhbmdlIG1ldGhvZCBkZXByZWNhdGVkCglfY2hhbmdlRGF0ZXBpY2tlcjogZnVuY3Rpb24odGFyZ2V0LCBuYW1lLCB2YWx1ZSkgewoJCXRoaXMuX29wdGlvbkRhdGVwaWNrZXIodGFyZ2V0LCBuYW1lLCB2YWx1ZSk7Cgl9LAoKCS8qIFJlZHJhdyB0aGUgZGF0ZSBwaWNrZXIgYXR0YWNoZWQgdG8gYW4gaW5wdXQgZmllbGQgb3IgZGl2aXNpb24uCgkgKiBAcGFyYW0gIHRhcmdldCAgZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICovCglfcmVmcmVzaERhdGVwaWNrZXI6IGZ1bmN0aW9uKHRhcmdldCkgewoJCXZhciBpbnN0ID0gdGhpcy5fZ2V0SW5zdCh0YXJnZXQpOwoJCWlmIChpbnN0KSB7CgkJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoaW5zdCk7CgkJfQoJfSwKCgkvKiBTZXQgdGhlIGRhdGVzIGZvciBhIGpRdWVyeSBzZWxlY3Rpb24uCgkgKiBAcGFyYW0gIHRhcmdldCBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKiBAcGFyYW0gIGRhdGUJRGF0ZSAtIHRoZSBuZXcgZGF0ZQoJICovCglfc2V0RGF0ZURhdGVwaWNrZXI6IGZ1bmN0aW9uKHRhcmdldCwgZGF0ZSkgewoJCXZhciBpbnN0ID0gdGhpcy5fZ2V0SW5zdCh0YXJnZXQpOwoJCWlmIChpbnN0KSB7CgkJCXRoaXMuX3NldERhdGUoaW5zdCwgZGF0ZSk7CgkJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoaW5zdCk7CgkJCXRoaXMuX3VwZGF0ZUFsdGVybmF0ZShpbnN0KTsKCQl9Cgl9LAoKCS8qIEdldCB0aGUgZGF0ZShzKSBmb3IgdGhlIGZpcnN0IGVudHJ5IGluIGEgalF1ZXJ5IHNlbGVjdGlvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0IGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqIEBwYXJhbSAgbm9EZWZhdWx0IGJvb2xlYW4gLSB0cnVlIGlmIG5vIGRlZmF1bHQgZGF0ZSBpcyB0byBiZSB1c2VkCgkgKiBAcmV0dXJuIERhdGUgLSB0aGUgY3VycmVudCBkYXRlCgkgKi8KCV9nZXREYXRlRGF0ZXBpY2tlcjogZnVuY3Rpb24odGFyZ2V0LCBub0RlZmF1bHQpIHsKCQl2YXIgaW5zdCA9IHRoaXMuX2dldEluc3QodGFyZ2V0KTsKCQlpZiAoaW5zdCAmJiAhaW5zdC5pbmxpbmUpIHsKCQkJdGhpcy5fc2V0RGF0ZUZyb21GaWVsZChpbnN0LCBub0RlZmF1bHQpOwoJCX0KCQlyZXR1cm4gKGluc3QgPyB0aGlzLl9nZXREYXRlKGluc3QpIDogbnVsbCk7Cgl9LAoKCS8qIEhhbmRsZSBrZXlzdHJva2VzLiAqLwoJX2RvS2V5RG93bjogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgb25TZWxlY3QsIGRhdGVTdHIsIHNlbCwKCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdChldmVudC50YXJnZXQpLAoJCQloYW5kbGVkID0gdHJ1ZSwKCQkJaXNSVEwgPSBpbnN0LmRwRGl2LmlzKCIudWktZGF0ZXBpY2tlci1ydGwiKTsKCgkJaW5zdC5fa2V5RXZlbnQgPSB0cnVlOwoJCWlmICgkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nKSB7CgkJCXN3aXRjaCAoZXZlbnQua2V5Q29kZSkgewoJCQkJY2FzZSA5OiAkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7CgkJCQkJCWhhbmRsZWQgPSBmYWxzZTsKCQkJCQkJYnJlYWs7IC8vIGhpZGUgb24gdGFiIG91dAoJCQkJY2FzZSAxMzogc2VsID0gJCgidGQuIiArICQuZGF0ZXBpY2tlci5fZGF5T3ZlckNsYXNzICsgIjpub3QoLiIgKwoJCQkJCQkJCQkkLmRhdGVwaWNrZXIuX2N1cnJlbnRDbGFzcyArICIpIiwgaW5zdC5kcERpdik7CgkJCQkJCWlmIChzZWxbMF0pIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fc2VsZWN0RGF5KGV2ZW50LnRhcmdldCwgaW5zdC5zZWxlY3RlZE1vbnRoLCBpbnN0LnNlbGVjdGVkWWVhciwgc2VsWzBdKTsKCQkJCQkJfQoKCQkJCQkJb25TZWxlY3QgPSAkLmRhdGVwaWNrZXIuX2dldChpbnN0LCAib25TZWxlY3QiKTsKCQkJCQkJaWYgKG9uU2VsZWN0KSB7CgkJCQkJCQlkYXRlU3RyID0gJC5kYXRlcGlja2VyLl9mb3JtYXREYXRlKGluc3QpOwoKCQkJCQkJCS8vIHRyaWdnZXIgY3VzdG9tIGNhbGxiYWNrCgkJCQkJCQlvblNlbGVjdC5hcHBseSgoaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXRbMF0gOiBudWxsKSwgW2RhdGVTdHIsIGluc3RdKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQkJCQkJfQoKCQkJCQkJcmV0dXJuIGZhbHNlOyAvLyBkb24ndCBzdWJtaXQgdGhlIGZvcm0KCQkJCWNhc2UgMjc6ICQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQkJCQkJYnJlYWs7IC8vIGhpZGUgb24gZXNjYXBlCgkJCQljYXNlIDMzOiAkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoZXZlbnQudGFyZ2V0LCAoZXZlbnQuY3RybEtleSA\/CgkJCQkJCQktJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgInN0ZXBCaWdNb250aHMiKSA6CgkJCQkJCQktJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgInN0ZXBNb250aHMiKSksICJNIik7CgkJCQkJCWJyZWFrOyAvLyBwcmV2aW91cyBtb250aC95ZWFyIG9uIHBhZ2UgdXAvKyBjdHJsCgkJCQljYXNlIDM0OiAkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoZXZlbnQudGFyZ2V0LCAoZXZlbnQuY3RybEtleSA\/CgkJCQkJCQkrJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgInN0ZXBCaWdNb250aHMiKSA6CgkJCQkJCQkrJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgInN0ZXBNb250aHMiKSksICJNIik7CgkJCQkJCWJyZWFrOyAvLyBuZXh0IG1vbnRoL3llYXIgb24gcGFnZSBkb3duLysgY3RybAoJCQkJY2FzZSAzNTogaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9jbGVhckRhdGUoZXZlbnQudGFyZ2V0KTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoJCQkJCQlicmVhazsgLy8gY2xlYXIgb24gY3RybCBvciBjb21tYW5kICtlbmQKCQkJCWNhc2UgMzY6IGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fZ290b1RvZGF5KGV2ZW50LnRhcmdldCk7CgkJCQkJCX0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsKCQkJCQkJYnJlYWs7IC8vIGN1cnJlbnQgb24gY3RybCBvciBjb21tYW5kICtob21lCgkJCQljYXNlIDM3OiBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5KSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoZXZlbnQudGFyZ2V0LCAoaXNSVEwgPyArMSA6IC0xKSwgIkQiKTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoJCQkJCQkvLyAtMSBkYXkgb24gY3RybCBvciBjb21tYW5kICtsZWZ0CgkJCQkJCWlmIChldmVudC5vcmlnaW5hbEV2ZW50LmFsdEtleSkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKGV2ZW50LnRhcmdldCwgKGV2ZW50LmN0cmxLZXkgPwoJCQkJCQkJCS0kLmRhdGVwaWNrZXIuX2dldChpbnN0LCAic3RlcEJpZ01vbnRocyIpIDoKCQkJCQkJCQktJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgInN0ZXBNb250aHMiKSksICJNIik7CgkJCQkJCX0KCQkJCQkJLy8gbmV4dCBtb250aC95ZWFyIG9uIGFsdCArbGVmdCBvbiBNYWMKCQkJCQkJYnJlYWs7CgkJCQljYXNlIDM4OiBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5KSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoZXZlbnQudGFyZ2V0LCAtNywgIkQiKTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoJCQkJCQlicmVhazsgLy8gLTEgd2VlayBvbiBjdHJsIG9yIGNvbW1hbmQgK3VwCgkJCQljYXNlIDM5OiBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5KSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoZXZlbnQudGFyZ2V0LCAoaXNSVEwgPyAtMSA6ICsxKSwgIkQiKTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoJCQkJCQkvLyArMSBkYXkgb24gY3RybCBvciBjb21tYW5kICtyaWdodAoJCQkJCQlpZiAoZXZlbnQub3JpZ2luYWxFdmVudC5hbHRLZXkpIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZShldmVudC50YXJnZXQsIChldmVudC5jdHJsS2V5ID8KCQkJCQkJCQkrJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgInN0ZXBCaWdNb250aHMiKSA6CgkJCQkJCQkJKyQuZGF0ZXBpY2tlci5fZ2V0KGluc3QsICJzdGVwTW9udGhzIikpLCAiTSIpOwoJCQkJCQl9CgkJCQkJCS8vIG5leHQgbW9udGgveWVhciBvbiBhbHQgK3JpZ2h0CgkJCQkJCWJyZWFrOwoJCQkJY2FzZSA0MDogaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKGV2ZW50LnRhcmdldCwgKzcsICJEIik7CgkJCQkJCX0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsKCQkJCQkJYnJlYWs7IC8vICsxIHdlZWsgb24gY3RybCBvciBjb21tYW5kICtkb3duCgkJCQlkZWZhdWx0OiBoYW5kbGVkID0gZmFsc2U7CgkJCX0KCQl9IGVsc2UgaWYgKGV2ZW50LmtleUNvZGUgPT09IDM2ICYmIGV2ZW50LmN0cmxLZXkpIHsgLy8gZGlzcGxheSB0aGUgZGF0ZSBwaWNrZXIgb24gY3RybCtob21lCgkJCSQuZGF0ZXBpY2tlci5fc2hvd0RhdGVwaWNrZXIodGhpcyk7CgkJfSBlbHNlIHsKCQkJaGFuZGxlZCA9IGZhbHNlOwoJCX0KCgkJaWYgKGhhbmRsZWQpIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCgkvKiBGaWx0ZXIgZW50ZXJlZCBjaGFyYWN0ZXJzIC0gYmFzZWQgb24gZGF0ZSBmb3JtYXQuICovCglfZG9LZXlQcmVzczogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgY2hhcnMsIGNociwKCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdChldmVudC50YXJnZXQpOwoKCQlpZiAoJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgImNvbnN0cmFpbklucHV0IikpIHsKCQkJY2hhcnMgPSAkLmRhdGVwaWNrZXIuX3Bvc3NpYmxlQ2hhcnMoJC5kYXRlcGlja2VyLl9nZXQoaW5zdCwgImRhdGVGb3JtYXQiKSk7CgkJCWNociA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZXZlbnQuY2hhckNvZGUgPT0gbnVsbCA\/IGV2ZW50LmtleUNvZGUgOiBldmVudC5jaGFyQ29kZSk7CgkJCXJldHVybiBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgKGNociA8ICIgIiB8fCAhY2hhcnMgfHwgY2hhcnMuaW5kZXhPZihjaHIpID4gLTEpOwoJCX0KCX0sCgoJLyogU3luY2hyb25pc2UgbWFudWFsIGVudHJ5IGFuZCBmaWVsZC9hbHRlcm5hdGUgZmllbGQuICovCglfZG9LZXlVcDogZnVuY3Rpb24oZXZlbnQpIHsKCQl2YXIgZGF0ZSwKCQkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdChldmVudC50YXJnZXQpOwoKCQlpZiAoaW5zdC5pbnB1dC52YWwoKSAhPT0gaW5zdC5sYXN0VmFsKSB7CgkJCXRyeSB7CgkJCQlkYXRlID0gJC5kYXRlcGlja2VyLnBhcnNlRGF0ZSgkLmRhdGVwaWNrZXIuX2dldChpbnN0LCAiZGF0ZUZvcm1hdCIpLAoJCQkJCShpbnN0LmlucHV0ID8gaW5zdC5pbnB1dC52YWwoKSA6IG51bGwpLAoJCQkJCSQuZGF0ZXBpY2tlci5fZ2V0Rm9ybWF0Q29uZmlnKGluc3QpKTsKCgkJCQlpZiAoZGF0ZSkgeyAvLyBvbmx5IGlmIHZhbGlkCgkJCQkJJC5kYXRlcGlja2VyLl9zZXREYXRlRnJvbUZpZWxkKGluc3QpOwoJCQkJCSQuZGF0ZXBpY2tlci5fdXBkYXRlQWx0ZXJuYXRlKGluc3QpOwoJCQkJCSQuZGF0ZXBpY2tlci5fdXBkYXRlRGF0ZXBpY2tlcihpbnN0KTsKCQkJCX0KCQkJfQoJCQljYXRjaCAoZXJyKSB7CgkJCX0KCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qIFBvcC11cCB0aGUgZGF0ZSBwaWNrZXIgZm9yIGEgZ2l2ZW4gaW5wdXQgZmllbGQuCgkgKiBJZiBmYWxzZSByZXR1cm5lZCBmcm9tIGJlZm9yZVNob3cgZXZlbnQgaGFuZGxlciBkbyBub3Qgc2hvdy4KCSAqIEBwYXJhbSAgaW5wdXQgIGVsZW1lbnQgLSB0aGUgaW5wdXQgZmllbGQgYXR0YWNoZWQgdG8gdGhlIGRhdGUgcGlja2VyIG9yCgkgKgkJCQkJZXZlbnQgLSBpZiB0cmlnZ2VyZWQgYnkgZm9jdXMKCSAqLwoJX3Nob3dEYXRlcGlja2VyOiBmdW5jdGlvbihpbnB1dCkgewoJCWlucHV0ID0gaW5wdXQudGFyZ2V0IHx8IGlucHV0OwoJCWlmIChpbnB1dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiaW5wdXQiKSB7IC8vIGZpbmQgZnJvbSBidXR0b24vaW1hZ2UgdHJpZ2dlcgoJCQlpbnB1dCA9ICQoImlucHV0IiwgaW5wdXQucGFyZW50Tm9kZSlbMF07CgkJfQoKCQlpZiAoJC5kYXRlcGlja2VyLl9pc0Rpc2FibGVkRGF0ZXBpY2tlcihpbnB1dCkgfHwgJC5kYXRlcGlja2VyLl9sYXN0SW5wdXQgPT09IGlucHV0KSB7IC8vIGFscmVhZHkgaGVyZQoJCQlyZXR1cm47CgkJfQoKCQl2YXIgaW5zdCwgYmVmb3JlU2hvdywgYmVmb3JlU2hvd1NldHRpbmdzLCBpc0ZpeGVkLAoJCQlvZmZzZXQsIHNob3dBbmltLCBkdXJhdGlvbjsKCgkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdChpbnB1dCk7CgkJaWYgKCQuZGF0ZXBpY2tlci5fY3VySW5zdCAmJiAkLmRhdGVwaWNrZXIuX2N1ckluc3QgIT09IGluc3QpIHsKCQkJJC5kYXRlcGlja2VyLl9jdXJJbnN0LmRwRGl2LnN0b3AodHJ1ZSwgdHJ1ZSk7CgkJCWlmICggaW5zdCAmJiAkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nICkgewoJCQkJJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlciggJC5kYXRlcGlja2VyLl9jdXJJbnN0LmlucHV0WzBdICk7CgkJCX0KCQl9CgoJCWJlZm9yZVNob3cgPSAkLmRhdGVwaWNrZXIuX2dldChpbnN0LCAiYmVmb3JlU2hvdyIpOwoJCWJlZm9yZVNob3dTZXR0aW5ncyA9IGJlZm9yZVNob3cgPyBiZWZvcmVTaG93LmFwcGx5KGlucHV0LCBbaW5wdXQsIGluc3RdKSA6IHt9OwoJCWlmKGJlZm9yZVNob3dTZXR0aW5ncyA9PT0gZmFsc2UpewoJCQlyZXR1cm47CgkJfQoJCWV4dGVuZFJlbW92ZShpbnN0LnNldHRpbmdzLCBiZWZvcmVTaG93U2V0dGluZ3MpOwoKCQlpbnN0Lmxhc3RWYWwgPSBudWxsOwoJCSQuZGF0ZXBpY2tlci5fbGFzdElucHV0ID0gaW5wdXQ7CgkJJC5kYXRlcGlja2VyLl9zZXREYXRlRnJvbUZpZWxkKGluc3QpOwoKCQlpZiAoJC5kYXRlcGlja2VyLl9pbkRpYWxvZykgeyAvLyBoaWRlIGN1cnNvcgoJCQlpbnB1dC52YWx1ZSA9ICIiOwoJCX0KCQlpZiAoISQuZGF0ZXBpY2tlci5fcG9zKSB7IC8vIHBvc2l0aW9uIGJlbG93IGlucHV0CgkJCSQuZGF0ZXBpY2tlci5fcG9zID0gJC5kYXRlcGlja2VyLl9maW5kUG9zKGlucHV0KTsKCQkJJC5kYXRlcGlja2VyLl9wb3NbMV0gKz0gaW5wdXQub2Zmc2V0SGVpZ2h0OyAvLyBhZGQgdGhlIGhlaWdodAoJCX0KCgkJaXNGaXhlZCA9IGZhbHNlOwoJCSQoaW5wdXQpLnBhcmVudHMoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpc0ZpeGVkIHw9ICQodGhpcykuY3NzKCJwb3NpdGlvbiIpID09PSAiZml4ZWQiOwoJCQlyZXR1cm4gIWlzRml4ZWQ7CgkJfSk7CgoJCW9mZnNldCA9IHtsZWZ0OiAkLmRhdGVwaWNrZXIuX3Bvc1swXSwgdG9wOiAkLmRhdGVwaWNrZXIuX3Bvc1sxXX07CgkJJC5kYXRlcGlja2VyLl9wb3MgPSBudWxsOwoJCS8vdG8gYXZvaWQgZmxhc2hlcyBvbiBGaXJlZm94CgkJaW5zdC5kcERpdi5lbXB0eSgpOwoJCS8vIGRldGVybWluZSBzaXppbmcgb2Zmc2NyZWVuCgkJaW5zdC5kcERpdi5jc3Moe3Bvc2l0aW9uOiAiYWJzb2x1dGUiLCBkaXNwbGF5OiAiYmxvY2siLCB0b3A6ICItMTAwMHB4In0pOwoJCSQuZGF0ZXBpY2tlci5fdXBkYXRlRGF0ZXBpY2tlcihpbnN0KTsKCQkvLyBmaXggd2lkdGggZm9yIGR5bmFtaWMgbnVtYmVyIG9mIGRhdGUgcGlja2VycwoJCS8vIGFuZCBhZGp1c3QgcG9zaXRpb24gYmVmb3JlIHNob3dpbmcKCQlvZmZzZXQgPSAkLmRhdGVwaWNrZXIuX2NoZWNrT2Zmc2V0KGluc3QsIG9mZnNldCwgaXNGaXhlZCk7CgkJaW5zdC5kcERpdi5jc3Moe3Bvc2l0aW9uOiAoJC5kYXRlcGlja2VyLl9pbkRpYWxvZyAmJiAkLmJsb2NrVUkgPwoJCQkic3RhdGljIiA6IChpc0ZpeGVkID8gImZpeGVkIiA6ICJhYnNvbHV0ZSIpKSwgZGlzcGxheTogIm5vbmUiLAoJCQlsZWZ0OiBvZmZzZXQubGVmdCArICJweCIsIHRvcDogb2Zmc2V0LnRvcCArICJweCJ9KTsKCgkJaWYgKCFpbnN0LmlubGluZSkgewoJCQlzaG93QW5pbSA9ICQuZGF0ZXBpY2tlci5fZ2V0KGluc3QsICJzaG93QW5pbSIpOwoJCQlkdXJhdGlvbiA9ICQuZGF0ZXBpY2tlci5fZ2V0KGluc3QsICJkdXJhdGlvbiIpOwoJCQlpbnN0LmRwRGl2LnpJbmRleCgkKGlucHV0KS56SW5kZXgoKSsxKTsKCQkJJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyA9IHRydWU7CgoJCQlpZiAoICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBzaG93QW5pbSBdICkgewoJCQkJaW5zdC5kcERpdi5zaG93KHNob3dBbmltLCAkLmRhdGVwaWNrZXIuX2dldChpbnN0LCAic2hvd09wdGlvbnMiKSwgZHVyYXRpb24pOwoJCQl9IGVsc2UgewoJCQkJaW5zdC5kcERpdltzaG93QW5pbSB8fCAic2hvdyJdKHNob3dBbmltID8gZHVyYXRpb24gOiBudWxsKTsKCQkJfQoKCQkJaWYgKCAkLmRhdGVwaWNrZXIuX3Nob3VsZEZvY3VzSW5wdXQoIGluc3QgKSApIHsKCQkJCWluc3QuaW5wdXQuZm9jdXMoKTsKCQkJfQoKCQkJJC5kYXRlcGlja2VyLl9jdXJJbnN0ID0gaW5zdDsKCQl9Cgl9LAoKCS8qIEdlbmVyYXRlIHRoZSBkYXRlIHBpY2tlciBjb250ZW50LiAqLwoJX3VwZGF0ZURhdGVwaWNrZXI6IGZ1bmN0aW9uKGluc3QpIHsKCQl0aGlzLm1heFJvd3MgPSA0OyAvL1Jlc2V0IHRoZSBtYXggbnVtYmVyIG9mIHJvd3MgYmVpbmcgZGlzcGxheWVkIChzZWUgIzcwNDMpCgkJaW5zdEFjdGl2ZSA9IGluc3Q7IC8vIGZvciBkZWxlZ2F0ZSBob3ZlciBldmVudHMKCQlpbnN0LmRwRGl2LmVtcHR5KCkuYXBwZW5kKHRoaXMuX2dlbmVyYXRlSFRNTChpbnN0KSk7CgkJdGhpcy5fYXR0YWNoSGFuZGxlcnMoaW5zdCk7CgkJaW5zdC5kcERpdi5maW5kKCIuIiArIHRoaXMuX2RheU92ZXJDbGFzcyArICIgYSIpLm1vdXNlb3ZlcigpOwoKCQl2YXIgb3JpZ3llYXJzaHRtbCwKCQkJbnVtTW9udGhzID0gdGhpcy5fZ2V0TnVtYmVyT2ZNb250aHMoaW5zdCksCgkJCWNvbHMgPSBudW1Nb250aHNbMV0sCgkJCXdpZHRoID0gMTc7CgoJCWluc3QuZHBEaXYucmVtb3ZlQ2xhc3MoInVpLWRhdGVwaWNrZXItbXVsdGktMiB1aS1kYXRlcGlja2VyLW11bHRpLTMgdWktZGF0ZXBpY2tlci1tdWx0aS00Iikud2lkdGgoIiIpOwoJCWlmIChjb2xzID4gMSkgewoJCQlpbnN0LmRwRGl2LmFkZENsYXNzKCJ1aS1kYXRlcGlja2VyLW11bHRpLSIgKyBjb2xzKS5jc3MoIndpZHRoIiwgKHdpZHRoICogY29scykgKyAiZW0iKTsKCQl9CgkJaW5zdC5kcERpdlsobnVtTW9udGhzWzBdICE9PSAxIHx8IG51bU1vbnRoc1sxXSAhPT0gMSA\/ICJhZGQiIDogInJlbW92ZSIpICsKCQkJIkNsYXNzIl0oInVpLWRhdGVwaWNrZXItbXVsdGkiKTsKCQlpbnN0LmRwRGl2Wyh0aGlzLl9nZXQoaW5zdCwgImlzUlRMIikgPyAiYWRkIiA6ICJyZW1vdmUiKSArCgkJCSJDbGFzcyJdKCJ1aS1kYXRlcGlja2VyLXJ0bCIpOwoKCQlpZiAoaW5zdCA9PT0gJC5kYXRlcGlja2VyLl9jdXJJbnN0ICYmICQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgJC5kYXRlcGlja2VyLl9zaG91bGRGb2N1c0lucHV0KCBpbnN0ICkgKSB7CgkJCWluc3QuaW5wdXQuZm9jdXMoKTsKCQl9CgoJCS8vIGRlZmZlcmVkIHJlbmRlciBvZiB0aGUgeWVhcnMgc2VsZWN0ICh0byBhdm9pZCBmbGFzaGVzIG9uIEZpcmVmb3gpCgkJaWYoIGluc3QueWVhcnNodG1sICl7CgkJCW9yaWd5ZWFyc2h0bWwgPSBpbnN0LnllYXJzaHRtbDsKCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJLy9hc3N1cmUgdGhhdCBpbnN0LnllYXJzaHRtbCBkaWRuJ3QgY2hhbmdlLgoJCQkJaWYoIG9yaWd5ZWFyc2h0bWwgPT09IGluc3QueWVhcnNodG1sICYmIGluc3QueWVhcnNodG1sICl7CgkJCQkJaW5zdC5kcERpdi5maW5kKCJzZWxlY3QudWktZGF0ZXBpY2tlci15ZWFyOmZpcnN0IikucmVwbGFjZVdpdGgoaW5zdC55ZWFyc2h0bWwpOwoJCQkJfQoJCQkJb3JpZ3llYXJzaHRtbCA9IGluc3QueWVhcnNodG1sID0gbnVsbDsKCQkJfSwgMCk7CgkJfQoJfSwKCgkvLyAjNjY5NCAtIGRvbid0IGZvY3VzIHRoZSBpbnB1dCBpZiBpdCdzIGFscmVhZHkgZm9jdXNlZAoJLy8gdGhpcyBicmVha3MgdGhlIGNoYW5nZSBldmVudCBpbiBJRQoJLy8gU3VwcG9ydDogSUUgYW5kIGpRdWVyeSA8MS45Cglfc2hvdWxkRm9jdXNJbnB1dDogZnVuY3Rpb24oIGluc3QgKSB7CgkJcmV0dXJuIGluc3QuaW5wdXQgJiYgaW5zdC5pbnB1dC5pcyggIjp2aXNpYmxlIiApICYmICFpbnN0LmlucHV0LmlzKCAiOmRpc2FibGVkIiApICYmICFpbnN0LmlucHV0LmlzKCAiOmZvY3VzIiApOwoJfSwKCgkvKiBDaGVjayBwb3NpdGlvbmluZyB0byByZW1haW4gb24gc2NyZWVuLiAqLwoJX2NoZWNrT2Zmc2V0OiBmdW5jdGlvbihpbnN0LCBvZmZzZXQsIGlzRml4ZWQpIHsKCQl2YXIgZHBXaWR0aCA9IGluc3QuZHBEaXYub3V0ZXJXaWR0aCgpLAoJCQlkcEhlaWdodCA9IGluc3QuZHBEaXYub3V0ZXJIZWlnaHQoKSwKCQkJaW5wdXRXaWR0aCA9IGluc3QuaW5wdXQgPyBpbnN0LmlucHV0Lm91dGVyV2lkdGgoKSA6IDAsCgkJCWlucHV0SGVpZ2h0ID0gaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQub3V0ZXJIZWlnaHQoKSA6IDAsCgkJCXZpZXdXaWR0aCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCArIChpc0ZpeGVkID8gMCA6ICQoZG9jdW1lbnQpLnNjcm9sbExlZnQoKSksCgkJCXZpZXdIZWlnaHQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0ICsgKGlzRml4ZWQgPyAwIDogJChkb2N1bWVudCkuc2Nyb2xsVG9wKCkpOwoKCQlvZmZzZXQubGVmdCAtPSAodGhpcy5fZ2V0KGluc3QsICJpc1JUTCIpID8gKGRwV2lkdGggLSBpbnB1dFdpZHRoKSA6IDApOwoJCW9mZnNldC5sZWZ0IC09IChpc0ZpeGVkICYmIG9mZnNldC5sZWZ0ID09PSBpbnN0LmlucHV0Lm9mZnNldCgpLmxlZnQpID8gJChkb2N1bWVudCkuc2Nyb2xsTGVmdCgpIDogMDsKCQlvZmZzZXQudG9wIC09IChpc0ZpeGVkICYmIG9mZnNldC50b3AgPT09IChpbnN0LmlucHV0Lm9mZnNldCgpLnRvcCArIGlucHV0SGVpZ2h0KSkgPyAkKGRvY3VtZW50KS5zY3JvbGxUb3AoKSA6IDA7CgoJCS8vIG5vdyBjaGVjayBpZiBkYXRlcGlja2VyIGlzIHNob3dpbmcgb3V0c2lkZSB3aW5kb3cgdmlld3BvcnQgLSBtb3ZlIHRvIGEgYmV0dGVyIHBsYWNlIGlmIHNvLgoJCW9mZnNldC5sZWZ0IC09IE1hdGgubWluKG9mZnNldC5sZWZ0LCAob2Zmc2V0LmxlZnQgKyBkcFdpZHRoID4gdmlld1dpZHRoICYmIHZpZXdXaWR0aCA+IGRwV2lkdGgpID8KCQkJTWF0aC5hYnMob2Zmc2V0LmxlZnQgKyBkcFdpZHRoIC0gdmlld1dpZHRoKSA6IDApOwoJCW9mZnNldC50b3AgLT0gTWF0aC5taW4ob2Zmc2V0LnRvcCwgKG9mZnNldC50b3AgKyBkcEhlaWdodCA+IHZpZXdIZWlnaHQgJiYgdmlld0hlaWdodCA+IGRwSGVpZ2h0KSA\/CgkJCU1hdGguYWJzKGRwSGVpZ2h0ICsgaW5wdXRIZWlnaHQpIDogMCk7CgoJCXJldHVybiBvZmZzZXQ7Cgl9LAoKCS8qIEZpbmQgYW4gb2JqZWN0J3MgcG9zaXRpb24gb24gdGhlIHNjcmVlbi4gKi8KCV9maW5kUG9zOiBmdW5jdGlvbihvYmopIHsKCQl2YXIgcG9zaXRpb24sCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KG9iaiksCgkJCWlzUlRMID0gdGhpcy5fZ2V0KGluc3QsICJpc1JUTCIpOwoKCQl3aGlsZSAob2JqICYmIChvYmoudHlwZSA9PT0gImhpZGRlbiIgfHwgb2JqLm5vZGVUeXBlICE9PSAxIHx8ICQuZXhwci5maWx0ZXJzLmhpZGRlbihvYmopKSkgewoJCQlvYmogPSBvYmpbaXNSVEwgPyAicHJldmlvdXNTaWJsaW5nIiA6ICJuZXh0U2libGluZyJdOwoJCX0KCgkJcG9zaXRpb24gPSAkKG9iaikub2Zmc2V0KCk7CgkJcmV0dXJuIFtwb3NpdGlvbi5sZWZ0LCBwb3NpdGlvbi50b3BdOwoJfSwKCgkvKiBIaWRlIHRoZSBkYXRlIHBpY2tlciBmcm9tIHZpZXcuCgkgKiBAcGFyYW0gIGlucHV0ICBlbGVtZW50IC0gdGhlIGlucHV0IGZpZWxkIGF0dGFjaGVkIHRvIHRoZSBkYXRlIHBpY2tlcgoJICovCglfaGlkZURhdGVwaWNrZXI6IGZ1bmN0aW9uKGlucHV0KSB7CgkJdmFyIHNob3dBbmltLCBkdXJhdGlvbiwgcG9zdFByb2Nlc3MsIG9uQ2xvc2UsCgkJCWluc3QgPSB0aGlzLl9jdXJJbnN0OwoKCQlpZiAoIWluc3QgfHwgKGlucHV0ICYmIGluc3QgIT09ICQuZGF0YShpbnB1dCwgUFJPUF9OQU1FKSkpIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKHRoaXMuX2RhdGVwaWNrZXJTaG93aW5nKSB7CgkJCXNob3dBbmltID0gdGhpcy5fZ2V0KGluc3QsICJzaG93QW5pbSIpOwoJCQlkdXJhdGlvbiA9IHRoaXMuX2dldChpbnN0LCAiZHVyYXRpb24iKTsKCQkJcG9zdFByb2Nlc3MgPSBmdW5jdGlvbigpIHsKCQkJCSQuZGF0ZXBpY2tlci5fdGlkeURpYWxvZyhpbnN0KTsKCQkJfTsKCgkJCS8vIERFUFJFQ0FURUQ6IGFmdGVyIEJDIGZvciAxLjgueCAkLmVmZmVjdHNbIHNob3dBbmltIF0gaXMgbm90IG5lZWRlZAoJCQlpZiAoICQuZWZmZWN0cyAmJiAoICQuZWZmZWN0cy5lZmZlY3RbIHNob3dBbmltIF0gfHwgJC5lZmZlY3RzWyBzaG93QW5pbSBdICkgKSB7CgkJCQlpbnN0LmRwRGl2LmhpZGUoc2hvd0FuaW0sICQuZGF0ZXBpY2tlci5fZ2V0KGluc3QsICJzaG93T3B0aW9ucyIpLCBkdXJhdGlvbiwgcG9zdFByb2Nlc3MpOwoJCQl9IGVsc2UgewoJCQkJaW5zdC5kcERpdlsoc2hvd0FuaW0gPT09ICJzbGlkZURvd24iID8gInNsaWRlVXAiIDoKCQkJCQkoc2hvd0FuaW0gPT09ICJmYWRlSW4iID8gImZhZGVPdXQiIDogImhpZGUiKSldKChzaG93QW5pbSA\/IGR1cmF0aW9uIDogbnVsbCksIHBvc3RQcm9jZXNzKTsKCQkJfQoKCQkJaWYgKCFzaG93QW5pbSkgewoJCQkJcG9zdFByb2Nlc3MoKTsKCQkJfQoJCQl0aGlzLl9kYXRlcGlja2VyU2hvd2luZyA9IGZhbHNlOwoKCQkJb25DbG9zZSA9IHRoaXMuX2dldChpbnN0LCAib25DbG9zZSIpOwoJCQlpZiAob25DbG9zZSkgewoJCQkJb25DbG9zZS5hcHBseSgoaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXRbMF0gOiBudWxsKSwgWyhpbnN0LmlucHV0ID8gaW5zdC5pbnB1dC52YWwoKSA6ICIiKSwgaW5zdF0pOwoJCQl9CgoJCQl0aGlzLl9sYXN0SW5wdXQgPSBudWxsOwoJCQlpZiAodGhpcy5faW5EaWFsb2cpIHsKCQkJCXRoaXMuX2RpYWxvZ0lucHV0LmNzcyh7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCBsZWZ0OiAiMCIsIHRvcDogIi0xMDBweCIgfSk7CgkJCQlpZiAoJC5ibG9ja1VJKSB7CgkJCQkJJC51bmJsb2NrVUkoKTsKCQkJCQkkKCJib2R5IikuYXBwZW5kKHRoaXMuZHBEaXYpOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2luRGlhbG9nID0gZmFsc2U7CgkJfQoJfSwKCgkvKiBUaWR5IHVwIGFmdGVyIGEgZGlhbG9nIGRpc3BsYXkuICovCglfdGlkeURpYWxvZzogZnVuY3Rpb24oaW5zdCkgewoJCWluc3QuZHBEaXYucmVtb3ZlQ2xhc3ModGhpcy5fZGlhbG9nQ2xhc3MpLnVuYmluZCgiLnVpLWRhdGVwaWNrZXItY2FsZW5kYXIiKTsKCX0sCgoJLyogQ2xvc2UgZGF0ZSBwaWNrZXIgaWYgY2xpY2tlZCBlbHNld2hlcmUuICovCglfY2hlY2tFeHRlcm5hbENsaWNrOiBmdW5jdGlvbihldmVudCkgewoJCWlmICghJC5kYXRlcGlja2VyLl9jdXJJbnN0KSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciAkdGFyZ2V0ID0gJChldmVudC50YXJnZXQpLAoJCQlpbnN0ID0gJC5kYXRlcGlja2VyLl9nZXRJbnN0KCR0YXJnZXRbMF0pOwoKCQlpZiAoICggKCAkdGFyZ2V0WzBdLmlkICE9PSAkLmRhdGVwaWNrZXIuX21haW5EaXZJZCAmJgoJCQkJJHRhcmdldC5wYXJlbnRzKCIjIiArICQuZGF0ZXBpY2tlci5fbWFpbkRpdklkKS5sZW5ndGggPT09IDAgJiYKCQkJCSEkdGFyZ2V0Lmhhc0NsYXNzKCQuZGF0ZXBpY2tlci5tYXJrZXJDbGFzc05hbWUpICYmCgkJCQkhJHRhcmdldC5jbG9zZXN0KCIuIiArICQuZGF0ZXBpY2tlci5fdHJpZ2dlckNsYXNzKS5sZW5ndGggJiYKCQkJCSQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgISgkLmRhdGVwaWNrZXIuX2luRGlhbG9nICYmICQuYmxvY2tVSSkgKSApIHx8CgkJCSggJHRhcmdldC5oYXNDbGFzcygkLmRhdGVwaWNrZXIubWFya2VyQ2xhc3NOYW1lKSAmJiAkLmRhdGVwaWNrZXIuX2N1ckluc3QgIT09IGluc3QgKSApIHsKCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQl9Cgl9LAoKCS8qIEFkanVzdCBvbmUgb2YgdGhlIGRhdGUgc3ViLWZpZWxkcy4gKi8KCV9hZGp1c3REYXRlOiBmdW5jdGlvbihpZCwgb2Zmc2V0LCBwZXJpb2QpIHsKCQl2YXIgdGFyZ2V0ID0gJChpZCksCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KHRhcmdldFswXSk7CgoJCWlmICh0aGlzLl9pc0Rpc2FibGVkRGF0ZXBpY2tlcih0YXJnZXRbMF0pKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fYWRqdXN0SW5zdERhdGUoaW5zdCwgb2Zmc2V0ICsKCQkJKHBlcmlvZCA9PT0gIk0iID8gdGhpcy5fZ2V0KGluc3QsICJzaG93Q3VycmVudEF0UG9zIikgOiAwKSwgLy8gdW5kbyBwb3NpdGlvbmluZwoJCQlwZXJpb2QpOwoJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoaW5zdCk7Cgl9LAoKCS8qIEFjdGlvbiBmb3IgY3VycmVudCBsaW5rLiAqLwoJX2dvdG9Ub2RheTogZnVuY3Rpb24oaWQpIHsKCQl2YXIgZGF0ZSwKCQkJdGFyZ2V0ID0gJChpZCksCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KHRhcmdldFswXSk7CgoJCWlmICh0aGlzLl9nZXQoaW5zdCwgImdvdG9DdXJyZW50IikgJiYgaW5zdC5jdXJyZW50RGF5KSB7CgkJCWluc3Quc2VsZWN0ZWREYXkgPSBpbnN0LmN1cnJlbnREYXk7CgkJCWluc3QuZHJhd01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoID0gaW5zdC5jdXJyZW50TW9udGg7CgkJCWluc3QuZHJhd1llYXIgPSBpbnN0LnNlbGVjdGVkWWVhciA9IGluc3QuY3VycmVudFllYXI7CgkJfSBlbHNlIHsKCQkJZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWluc3Quc2VsZWN0ZWREYXkgPSBkYXRlLmdldERhdGUoKTsKCQkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBkYXRlLmdldE1vbnRoKCk7CgkJCWluc3QuZHJhd1llYXIgPSBpbnN0LnNlbGVjdGVkWWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTsKCQl9CgkJdGhpcy5fbm90aWZ5Q2hhbmdlKGluc3QpOwoJCXRoaXMuX2FkanVzdERhdGUodGFyZ2V0KTsKCX0sCgoJLyogQWN0aW9uIGZvciBzZWxlY3RpbmcgYSBuZXcgbW9udGgveWVhci4gKi8KCV9zZWxlY3RNb250aFllYXI6IGZ1bmN0aW9uKGlkLCBzZWxlY3QsIHBlcmlvZCkgewoJCXZhciB0YXJnZXQgPSAkKGlkKSwKCQkJaW5zdCA9IHRoaXMuX2dldEluc3QodGFyZ2V0WzBdKTsKCgkJaW5zdFsic2VsZWN0ZWQiICsgKHBlcmlvZCA9PT0gIk0iID8gIk1vbnRoIiA6ICJZZWFyIildID0KCQlpbnN0WyJkcmF3IiArIChwZXJpb2QgPT09ICJNIiA\/ICJNb250aCIgOiAiWWVhciIpXSA9CgkJCXBhcnNlSW50KHNlbGVjdC5vcHRpb25zW3NlbGVjdC5zZWxlY3RlZEluZGV4XS52YWx1ZSwxMCk7CgoJCXRoaXMuX25vdGlmeUNoYW5nZShpbnN0KTsKCQl0aGlzLl9hZGp1c3REYXRlKHRhcmdldCk7Cgl9LAoKCS8qIEFjdGlvbiBmb3Igc2VsZWN0aW5nIGEgZGF5LiAqLwoJX3NlbGVjdERheTogZnVuY3Rpb24oaWQsIG1vbnRoLCB5ZWFyLCB0ZCkgewoJCXZhciBpbnN0LAoJCQl0YXJnZXQgPSAkKGlkKTsKCgkJaWYgKCQodGQpLmhhc0NsYXNzKHRoaXMuX3Vuc2VsZWN0YWJsZUNsYXNzKSB8fCB0aGlzLl9pc0Rpc2FibGVkRGF0ZXBpY2tlcih0YXJnZXRbMF0pKSB7CgkJCXJldHVybjsKCQl9CgoJCWluc3QgPSB0aGlzLl9nZXRJbnN0KHRhcmdldFswXSk7CgkJaW5zdC5zZWxlY3RlZERheSA9IGluc3QuY3VycmVudERheSA9ICQoImEiLCB0ZCkuaHRtbCgpOwoJCWluc3Quc2VsZWN0ZWRNb250aCA9IGluc3QuY3VycmVudE1vbnRoID0gbW9udGg7CgkJaW5zdC5zZWxlY3RlZFllYXIgPSBpbnN0LmN1cnJlbnRZZWFyID0geWVhcjsKCQl0aGlzLl9zZWxlY3REYXRlKGlkLCB0aGlzLl9mb3JtYXREYXRlKGluc3QsCgkJCWluc3QuY3VycmVudERheSwgaW5zdC5jdXJyZW50TW9udGgsIGluc3QuY3VycmVudFllYXIpKTsKCX0sCgoJLyogRXJhc2UgdGhlIGlucHV0IGZpZWxkIGFuZCBoaWRlIHRoZSBkYXRlIHBpY2tlci4gKi8KCV9jbGVhckRhdGU6IGZ1bmN0aW9uKGlkKSB7CgkJdmFyIHRhcmdldCA9ICQoaWQpOwoJCXRoaXMuX3NlbGVjdERhdGUodGFyZ2V0LCAiIik7Cgl9LAoKCS8qIFVwZGF0ZSB0aGUgaW5wdXQgZmllbGQgd2l0aCB0aGUgc2VsZWN0ZWQgZGF0ZS4gKi8KCV9zZWxlY3REYXRlOiBmdW5jdGlvbihpZCwgZGF0ZVN0cikgewoJCXZhciBvblNlbGVjdCwKCQkJdGFyZ2V0ID0gJChpZCksCgkJCWluc3QgPSB0aGlzLl9nZXRJbnN0KHRhcmdldFswXSk7CgoJCWRhdGVTdHIgPSAoZGF0ZVN0ciAhPSBudWxsID8gZGF0ZVN0ciA6IHRoaXMuX2Zvcm1hdERhdGUoaW5zdCkpOwoJCWlmIChpbnN0LmlucHV0KSB7CgkJCWluc3QuaW5wdXQudmFsKGRhdGVTdHIpOwoJCX0KCQl0aGlzLl91cGRhdGVBbHRlcm5hdGUoaW5zdCk7CgoJCW9uU2VsZWN0ID0gdGhpcy5fZ2V0KGluc3QsICJvblNlbGVjdCIpOwoJCWlmIChvblNlbGVjdCkgewoJCQlvblNlbGVjdC5hcHBseSgoaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXRbMF0gOiBudWxsKSwgW2RhdGVTdHIsIGluc3RdKTsgIC8vIHRyaWdnZXIgY3VzdG9tIGNhbGxiYWNrCgkJfSBlbHNlIGlmIChpbnN0LmlucHV0KSB7CgkJCWluc3QuaW5wdXQudHJpZ2dlcigiY2hhbmdlIik7IC8vIGZpcmUgdGhlIGNoYW5nZSBldmVudAoJCX0KCgkJaWYgKGluc3QuaW5saW5lKXsKCQkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlcihpbnN0KTsKCQl9IGVsc2UgewoJCQl0aGlzLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQl0aGlzLl9sYXN0SW5wdXQgPSBpbnN0LmlucHV0WzBdOwoJCQlpZiAodHlwZW9mKGluc3QuaW5wdXRbMF0pICE9PSAib2JqZWN0IikgewoJCQkJaW5zdC5pbnB1dC5mb2N1cygpOyAvLyByZXN0b3JlIGZvY3VzCgkJCX0KCQkJdGhpcy5fbGFzdElucHV0ID0gbnVsbDsKCQl9Cgl9LAoKCS8qIFVwZGF0ZSBhbnkgYWx0ZXJuYXRlIGZpZWxkIHRvIHN5bmNocm9uaXNlIHdpdGggdGhlIG1haW4gZmllbGQuICovCglfdXBkYXRlQWx0ZXJuYXRlOiBmdW5jdGlvbihpbnN0KSB7CgkJdmFyIGFsdEZvcm1hdCwgZGF0ZSwgZGF0ZVN0ciwKCQkJYWx0RmllbGQgPSB0aGlzLl9nZXQoaW5zdCwgImFsdEZpZWxkIik7CgoJCWlmIChhbHRGaWVsZCkgeyAvLyB1cGRhdGUgYWx0ZXJuYXRlIGZpZWxkIHRvbwoJCQlhbHRGb3JtYXQgPSB0aGlzLl9nZXQoaW5zdCwgImFsdEZvcm1hdCIpIHx8IHRoaXMuX2dldChpbnN0LCAiZGF0ZUZvcm1hdCIpOwoJCQlkYXRlID0gdGhpcy5fZ2V0RGF0ZShpbnN0KTsKCQkJZGF0ZVN0ciA9IHRoaXMuZm9ybWF0RGF0ZShhbHRGb3JtYXQsIGRhdGUsIHRoaXMuX2dldEZvcm1hdENvbmZpZyhpbnN0KSk7CgkJCSQoYWx0RmllbGQpLmVhY2goZnVuY3Rpb24oKSB7ICQodGhpcykudmFsKGRhdGVTdHIpOyB9KTsKCQl9Cgl9LAoKCS8qIFNldCBhcyBiZWZvcmVTaG93RGF5IGZ1bmN0aW9uIHRvIHByZXZlbnQgc2VsZWN0aW9uIG9mIHdlZWtlbmRzLgoJICogQHBhcmFtICBkYXRlICBEYXRlIC0gdGhlIGRhdGUgdG8gY3VzdG9taXNlCgkgKiBAcmV0dXJuIFtib29sZWFuLCBzdHJpbmddIC0gaXMgdGhpcyBkYXRlIHNlbGVjdGFibGU\/LCB3aGF0IGlzIGl0cyBDU1MgY2xhc3M\/CgkgKi8KCW5vV2Vla2VuZHM6IGZ1bmN0aW9uKGRhdGUpIHsKCQl2YXIgZGF5ID0gZGF0ZS5nZXREYXkoKTsKCQlyZXR1cm4gWyhkYXkgPiAwICYmIGRheSA8IDYpLCAiIl07Cgl9LAoKCS8qIFNldCBhcyBjYWxjdWxhdGVXZWVrIHRvIGRldGVybWluZSB0aGUgd2VlayBvZiB0aGUgeWVhciBiYXNlZCBvbiB0aGUgSVNPIDg2MDEgZGVmaW5pdGlvbi4KCSAqIEBwYXJhbSAgZGF0ZSAgRGF0ZSAtIHRoZSBkYXRlIHRvIGdldCB0aGUgd2VlayBmb3IKCSAqIEByZXR1cm4gIG51bWJlciAtIHRoZSBudW1iZXIgb2YgdGhlIHdlZWsgd2l0aGluIHRoZSB5ZWFyIHRoYXQgY29udGFpbnMgdGhpcyBkYXRlCgkgKi8KCWlzbzg2MDFXZWVrOiBmdW5jdGlvbihkYXRlKSB7CgkJdmFyIHRpbWUsCgkJCWNoZWNrRGF0ZSA9IG5ldyBEYXRlKGRhdGUuZ2V0VGltZSgpKTsKCgkJLy8gRmluZCBUaHVyc2RheSBvZiB0aGlzIHdlZWsgc3RhcnRpbmcgb24gTW9uZGF5CgkJY2hlY2tEYXRlLnNldERhdGUoY2hlY2tEYXRlLmdldERhdGUoKSArIDQgLSAoY2hlY2tEYXRlLmdldERheSgpIHx8IDcpKTsKCgkJdGltZSA9IGNoZWNrRGF0ZS5nZXRUaW1lKCk7CgkJY2hlY2tEYXRlLnNldE1vbnRoKDApOyAvLyBDb21wYXJlIHdpdGggSmFuIDEKCQljaGVja0RhdGUuc2V0RGF0ZSgxKTsKCQlyZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJvdW5kKCh0aW1lIC0gY2hlY2tEYXRlKSAvIDg2NDAwMDAwKSAvIDcpICsgMTsKCX0sCgoJLyogUGFyc2UgYSBzdHJpbmcgdmFsdWUgaW50byBhIGRhdGUgb2JqZWN0LgoJICogU2VlIGZvcm1hdERhdGUgYmVsb3cgZm9yIHRoZSBwb3NzaWJsZSBmb3JtYXRzLgoJICoKCSAqIEBwYXJhbSAgZm9ybWF0IHN0cmluZyAtIHRoZSBleHBlY3RlZCBmb3JtYXQgb2YgdGhlIGRhdGUKCSAqIEBwYXJhbSAgdmFsdWUgc3RyaW5nIC0gdGhlIGRhdGUgaW4gdGhlIGFib3ZlIGZvcm1hdAoJICogQHBhcmFtICBzZXR0aW5ncyBPYmplY3QgLSBhdHRyaWJ1dGVzIGluY2x1ZGU6CgkgKgkJCQkJc2hvcnRZZWFyQ3V0b2ZmICBudW1iZXIgLSB0aGUgY3V0b2ZmIHllYXIgZm9yIGRldGVybWluaW5nIHRoZSBjZW50dXJ5IChvcHRpb25hbCkKCSAqCQkJCQlkYXlOYW1lc1Nob3J0CXN0cmluZ1s3XSAtIGFiYnJldmlhdGVkIG5hbWVzIG9mIHRoZSBkYXlzIGZyb20gU3VuZGF5IChvcHRpb25hbCkKCSAqCQkJCQlkYXlOYW1lcwkJc3RyaW5nWzddIC0gbmFtZXMgb2YgdGhlIGRheXMgZnJvbSBTdW5kYXkgKG9wdGlvbmFsKQoJICoJCQkJCW1vbnRoTmFtZXNTaG9ydCBzdHJpbmdbMTJdIC0gYWJicmV2aWF0ZWQgbmFtZXMgb2YgdGhlIG1vbnRocyAob3B0aW9uYWwpCgkgKgkJCQkJbW9udGhOYW1lcwkJc3RyaW5nWzEyXSAtIG5hbWVzIG9mIHRoZSBtb250aHMgKG9wdGlvbmFsKQoJICogQHJldHVybiAgRGF0ZSAtIHRoZSBleHRyYWN0ZWQgZGF0ZSB2YWx1ZSBvciBudWxsIGlmIHZhbHVlIGlzIGJsYW5rCgkgKi8KCXBhcnNlRGF0ZTogZnVuY3Rpb24gKGZvcm1hdCwgdmFsdWUsIHNldHRpbmdzKSB7CgkJaWYgKGZvcm1hdCA9PSBudWxsIHx8IHZhbHVlID09IG51bGwpIHsKCQkJdGhyb3cgIkludmFsaWQgYXJndW1lbnRzIjsKCQl9CgoJCXZhbHVlID0gKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgPyB2YWx1ZS50b1N0cmluZygpIDogdmFsdWUgKyAiIik7CgkJaWYgKHZhbHVlID09PSAiIikgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCXZhciBpRm9ybWF0LCBkaW0sIGV4dHJhLAoJCQlpVmFsdWUgPSAwLAoJCQlzaG9ydFllYXJDdXRvZmZUZW1wID0gKHNldHRpbmdzID8gc2V0dGluZ3Muc2hvcnRZZWFyQ3V0b2ZmIDogbnVsbCkgfHwgdGhpcy5fZGVmYXVsdHMuc2hvcnRZZWFyQ3V0b2ZmLAoJCQlzaG9ydFllYXJDdXRvZmYgPSAodHlwZW9mIHNob3J0WWVhckN1dG9mZlRlbXAgIT09ICJzdHJpbmciID8gc2hvcnRZZWFyQ3V0b2ZmVGVtcCA6CgkJCQluZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgJSAxMDAgKyBwYXJzZUludChzaG9ydFllYXJDdXRvZmZUZW1wLCAxMCkpLAoJCQlkYXlOYW1lc1Nob3J0ID0gKHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXNTaG9ydCA6IG51bGwpIHx8IHRoaXMuX2RlZmF1bHRzLmRheU5hbWVzU2hvcnQsCgkJCWRheU5hbWVzID0gKHNldHRpbmdzID8gc2V0dGluZ3MuZGF5TmFtZXMgOiBudWxsKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lcywKCQkJbW9udGhOYW1lc1Nob3J0ID0gKHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lc1Nob3J0IDogbnVsbCkgfHwgdGhpcy5fZGVmYXVsdHMubW9udGhOYW1lc1Nob3J0LAoJCQltb250aE5hbWVzID0gKHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lcyA6IG51bGwpIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXMsCgkJCXllYXIgPSAtMSwKCQkJbW9udGggPSAtMSwKCQkJZGF5ID0gLTEsCgkJCWRveSA9IC0xLAoJCQlsaXRlcmFsID0gZmFsc2UsCgkJCWRhdGUsCgkJCS8vIENoZWNrIHdoZXRoZXIgYSBmb3JtYXQgY2hhcmFjdGVyIGlzIGRvdWJsZWQKCQkJbG9va0FoZWFkID0gZnVuY3Rpb24obWF0Y2gpIHsKCQkJCXZhciBtYXRjaGVzID0gKGlGb3JtYXQgKyAxIDwgZm9ybWF0Lmxlbmd0aCAmJiBmb3JtYXQuY2hhckF0KGlGb3JtYXQgKyAxKSA9PT0gbWF0Y2gpOwoJCQkJaWYgKG1hdGNoZXMpIHsKCQkJCQlpRm9ybWF0Kys7CgkJCQl9CgkJCQlyZXR1cm4gbWF0Y2hlczsKCQkJfSwKCQkJLy8gRXh0cmFjdCBhIG51bWJlciBmcm9tIHRoZSBzdHJpbmcgdmFsdWUKCQkJZ2V0TnVtYmVyID0gZnVuY3Rpb24obWF0Y2gpIHsKCQkJCXZhciBpc0RvdWJsZWQgPSBsb29rQWhlYWQobWF0Y2gpLAoJCQkJCXNpemUgPSAobWF0Y2ggPT09ICJAIiA\/IDE0IDogKG1hdGNoID09PSAiISIgPyAyMCA6CgkJCQkJKG1hdGNoID09PSAieSIgJiYgaXNEb3VibGVkID8gNCA6IChtYXRjaCA9PT0gIm8iID8gMyA6IDIpKSkpLAoJCQkJCWRpZ2l0cyA9IG5ldyBSZWdFeHAoIl5cXGR7MSwiICsgc2l6ZSArICJ9IiksCgkJCQkJbnVtID0gdmFsdWUuc3Vic3RyaW5nKGlWYWx1ZSkubWF0Y2goZGlnaXRzKTsKCQkJCWlmICghbnVtKSB7CgkJCQkJdGhyb3cgIk1pc3NpbmcgbnVtYmVyIGF0IHBvc2l0aW9uICIgKyBpVmFsdWU7CgkJCQl9CgkJCQlpVmFsdWUgKz0gbnVtWzBdLmxlbmd0aDsKCQkJCXJldHVybiBwYXJzZUludChudW1bMF0sIDEwKTsKCQkJfSwKCQkJLy8gRXh0cmFjdCBhIG5hbWUgZnJvbSB0aGUgc3RyaW5nIHZhbHVlIGFuZCBjb252ZXJ0IHRvIGFuIGluZGV4CgkJCWdldE5hbWUgPSBmdW5jdGlvbihtYXRjaCwgc2hvcnROYW1lcywgbG9uZ05hbWVzKSB7CgkJCQl2YXIgaW5kZXggPSAtMSwKCQkJCQluYW1lcyA9ICQubWFwKGxvb2tBaGVhZChtYXRjaCkgPyBsb25nTmFtZXMgOiBzaG9ydE5hbWVzLCBmdW5jdGlvbiAodiwgaykgewoJCQkJCQlyZXR1cm4gWyBbaywgdl0gXTsKCQkJCQl9KS5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CgkJCQkJCXJldHVybiAtKGFbMV0ubGVuZ3RoIC0gYlsxXS5sZW5ndGgpOwoJCQkJCX0pOwoKCQkJCSQuZWFjaChuYW1lcywgZnVuY3Rpb24gKGksIHBhaXIpIHsKCQkJCQl2YXIgbmFtZSA9IHBhaXJbMV07CgkJCQkJaWYgKHZhbHVlLnN1YnN0cihpVmFsdWUsIG5hbWUubGVuZ3RoKS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpIHsKCQkJCQkJaW5kZXggPSBwYWlyWzBdOwoJCQkJCQlpVmFsdWUgKz0gbmFtZS5sZW5ndGg7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9KTsKCQkJCWlmIChpbmRleCAhPT0gLTEpIHsKCQkJCQlyZXR1cm4gaW5kZXggKyAxOwoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyAiVW5rbm93biBuYW1lIGF0IHBvc2l0aW9uICIgKyBpVmFsdWU7CgkJCQl9CgkJCX0sCgkJCS8vIENvbmZpcm0gdGhhdCBhIGxpdGVyYWwgY2hhcmFjdGVyIG1hdGNoZXMgdGhlIHN0cmluZyB2YWx1ZQoJCQljaGVja0xpdGVyYWwgPSBmdW5jdGlvbigpIHsKCQkJCWlmICh2YWx1ZS5jaGFyQXQoaVZhbHVlKSAhPT0gZm9ybWF0LmNoYXJBdChpRm9ybWF0KSkgewoJCQkJCXRocm93ICJVbmV4cGVjdGVkIGxpdGVyYWwgYXQgcG9zaXRpb24gIiArIGlWYWx1ZTsKCQkJCX0KCQkJCWlWYWx1ZSsrOwoJCQl9OwoKCQlmb3IgKGlGb3JtYXQgPSAwOyBpRm9ybWF0IDwgZm9ybWF0Lmxlbmd0aDsgaUZvcm1hdCsrKSB7CgkJCWlmIChsaXRlcmFsKSB7CgkJCQlpZiAoZm9ybWF0LmNoYXJBdChpRm9ybWF0KSA9PT0gIiciICYmICFsb29rQWhlYWQoIiciKSkgewoJCQkJCWxpdGVyYWwgPSBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJY2hlY2tMaXRlcmFsKCk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlzd2l0Y2ggKGZvcm1hdC5jaGFyQXQoaUZvcm1hdCkpIHsKCQkJCQljYXNlICJkIjoKCQkJCQkJZGF5ID0gZ2V0TnVtYmVyKCJkIik7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIkQiOgoJCQkJCQlnZXROYW1lKCJEIiwgZGF5TmFtZXNTaG9ydCwgZGF5TmFtZXMpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJvIjoKCQkJCQkJZG95ID0gZ2V0TnVtYmVyKCJvIik7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIm0iOgoJCQkJCQltb250aCA9IGdldE51bWJlcigibSIpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJNIjoKCQkJCQkJbW9udGggPSBnZXROYW1lKCJNIiwgbW9udGhOYW1lc1Nob3J0LCBtb250aE5hbWVzKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAieSI6CgkJCQkJCXllYXIgPSBnZXROdW1iZXIoInkiKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiQCI6CgkJCQkJCWRhdGUgPSBuZXcgRGF0ZShnZXROdW1iZXIoIkAiKSk7CgkJCQkJCXllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7CgkJCQkJCW1vbnRoID0gZGF0ZS5nZXRNb250aCgpICsgMTsKCQkJCQkJZGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIiEiOgoJCQkJCQlkYXRlID0gbmV3IERhdGUoKGdldE51bWJlcigiISIpIC0gdGhpcy5fdGlja3NUbzE5NzApIC8gMTAwMDApOwoJCQkJCQl5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOwoJCQkJCQltb250aCA9IGRhdGUuZ2V0TW9udGgoKSArIDE7CgkJCQkJCWRheSA9IGRhdGUuZ2V0RGF0ZSgpOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICInIjoKCQkJCQkJaWYgKGxvb2tBaGVhZCgiJyIpKXsKCQkJCQkJCWNoZWNrTGl0ZXJhbCgpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJbGl0ZXJhbCA9IHRydWU7CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQkJZGVmYXVsdDoKCQkJCQkJY2hlY2tMaXRlcmFsKCk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmIChpVmFsdWUgPCB2YWx1ZS5sZW5ndGgpewoJCQlleHRyYSA9IHZhbHVlLnN1YnN0cihpVmFsdWUpOwoJCQlpZiAoIS9eXHMrLy50ZXN0KGV4dHJhKSkgewoJCQkJdGhyb3cgIkV4dHJhL3VucGFyc2VkIGNoYXJhY3RlcnMgZm91bmQgaW4gZGF0ZTogIiArIGV4dHJhOwoJCQl9CgkJfQoKCQlpZiAoeWVhciA9PT0gLTEpIHsKCQkJeWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTsKCQl9IGVsc2UgaWYgKHllYXIgPCAxMDApIHsKCQkJeWVhciArPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgLSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkgJSAxMDAgKwoJCQkJKHllYXIgPD0gc2hvcnRZZWFyQ3V0b2ZmID8gMCA6IC0xMDApOwoJCX0KCgkJaWYgKGRveSA+IC0xKSB7CgkJCW1vbnRoID0gMTsKCQkJZGF5ID0gZG95OwoJCQlkbyB7CgkJCQlkaW0gPSB0aGlzLl9nZXREYXlzSW5Nb250aCh5ZWFyLCBtb250aCAtIDEpOwoJCQkJaWYgKGRheSA8PSBkaW0pIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJCW1vbnRoKys7CgkJCQlkYXkgLT0gZGltOwoJCQl9IHdoaWxlICh0cnVlKTsKCQl9CgoJCWRhdGUgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdChuZXcgRGF0ZSh5ZWFyLCBtb250aCAtIDEsIGRheSkpOwoJCWlmIChkYXRlLmdldEZ1bGxZZWFyKCkgIT09IHllYXIgfHwgZGF0ZS5nZXRNb250aCgpICsgMSAhPT0gbW9udGggfHwgZGF0ZS5nZXREYXRlKCkgIT09IGRheSkgewoJCQl0aHJvdyAiSW52YWxpZCBkYXRlIjsgLy8gRS5nLiAzMS8wMi8wMAoJCX0KCQlyZXR1cm4gZGF0ZTsKCX0sCgoJLyogU3RhbmRhcmQgZGF0ZSBmb3JtYXRzLiAqLwoJQVRPTTogInl5LW1tLWRkIiwgLy8gUkZDIDMzMzkgKElTTyA4NjAxKQoJQ09PS0lFOiAiRCwgZGQgTSB5eSIsCglJU09fODYwMTogInl5LW1tLWRkIiwKCVJGQ184MjI6ICJELCBkIE0geSIsCglSRkNfODUwOiAiREQsIGRkLU0teSIsCglSRkNfMTAzNjogIkQsIGQgTSB5IiwKCVJGQ18xMTIzOiAiRCwgZCBNIHl5IiwKCVJGQ18yODIyOiAiRCwgZCBNIHl5IiwKCVJTUzogIkQsIGQgTSB5IiwgLy8gUkZDIDgyMgoJVElDS1M6ICIhIiwKCVRJTUVTVEFNUDogIkAiLAoJVzNDOiAieXktbW0tZGQiLCAvLyBJU08gODYwMQoKCV90aWNrc1RvMTk3MDogKCgoMTk3MCAtIDEpICogMzY1ICsgTWF0aC5mbG9vcigxOTcwIC8gNCkgLSBNYXRoLmZsb29yKDE5NzAgLyAxMDApICsKCQlNYXRoLmZsb29yKDE5NzAgLyA0MDApKSAqIDI0ICogNjAgKiA2MCAqIDEwMDAwMDAwKSwKCgkvKiBGb3JtYXQgYSBkYXRlIG9iamVjdCBpbnRvIGEgc3RyaW5nIHZhbHVlLgoJICogVGhlIGZvcm1hdCBjYW4gYmUgY29tYmluYXRpb25zIG9mIHRoZSBmb2xsb3dpbmc6CgkgKiBkICAtIGRheSBvZiBtb250aCAobm8gbGVhZGluZyB6ZXJvKQoJICogZGQgLSBkYXkgb2YgbW9udGggKHR3byBkaWdpdCkKCSAqIG8gIC0gZGF5IG9mIHllYXIgKG5vIGxlYWRpbmcgemVyb3MpCgkgKiBvbyAtIGRheSBvZiB5ZWFyICh0aHJlZSBkaWdpdCkKCSAqIEQgIC0gZGF5IG5hbWUgc2hvcnQKCSAqIEREIC0gZGF5IG5hbWUgbG9uZwoJICogbSAgLSBtb250aCBvZiB5ZWFyIChubyBsZWFkaW5nIHplcm8pCgkgKiBtbSAtIG1vbnRoIG9mIHllYXIgKHR3byBkaWdpdCkKCSAqIE0gIC0gbW9udGggbmFtZSBzaG9ydAoJICogTU0gLSBtb250aCBuYW1lIGxvbmcKCSAqIHkgIC0geWVhciAodHdvIGRpZ2l0KQoJICogeXkgLSB5ZWFyIChmb3VyIGRpZ2l0KQoJICogQCAtIFVuaXggdGltZXN0YW1wIChtcyBzaW5jZSAwMS8wMS8xOTcwKQoJICogISAtIFdpbmRvd3MgdGlja3MgKDEwMG5zIHNpbmNlIDAxLzAxLzAwMDEpCgkgKiAiLi4uIiAtIGxpdGVyYWwgdGV4dAoJICogJycgLSBzaW5nbGUgcXVvdGUKCSAqCgkgKiBAcGFyYW0gIGZvcm1hdCBzdHJpbmcgLSB0aGUgZGVzaXJlZCBmb3JtYXQgb2YgdGhlIGRhdGUKCSAqIEBwYXJhbSAgZGF0ZSBEYXRlIC0gdGhlIGRhdGUgdmFsdWUgdG8gZm9ybWF0CgkgKiBAcGFyYW0gIHNldHRpbmdzIE9iamVjdCAtIGF0dHJpYnV0ZXMgaW5jbHVkZToKCSAqCQkJCQlkYXlOYW1lc1Nob3J0CXN0cmluZ1s3XSAtIGFiYnJldmlhdGVkIG5hbWVzIG9mIHRoZSBkYXlzIGZyb20gU3VuZGF5IChvcHRpb25hbCkKCSAqCQkJCQlkYXlOYW1lcwkJc3RyaW5nWzddIC0gbmFtZXMgb2YgdGhlIGRheXMgZnJvbSBTdW5kYXkgKG9wdGlvbmFsKQoJICoJCQkJCW1vbnRoTmFtZXNTaG9ydCBzdHJpbmdbMTJdIC0gYWJicmV2aWF0ZWQgbmFtZXMgb2YgdGhlIG1vbnRocyAob3B0aW9uYWwpCgkgKgkJCQkJbW9udGhOYW1lcwkJc3RyaW5nWzEyXSAtIG5hbWVzIG9mIHRoZSBtb250aHMgKG9wdGlvbmFsKQoJICogQHJldHVybiAgc3RyaW5nIC0gdGhlIGRhdGUgaW4gdGhlIGFib3ZlIGZvcm1hdAoJICovCglmb3JtYXREYXRlOiBmdW5jdGlvbiAoZm9ybWF0LCBkYXRlLCBzZXR0aW5ncykgewoJCWlmICghZGF0ZSkgewoJCQlyZXR1cm4gIiI7CgkJfQoKCQl2YXIgaUZvcm1hdCwKCQkJZGF5TmFtZXNTaG9ydCA9IChzZXR0aW5ncyA\/IHNldHRpbmdzLmRheU5hbWVzU2hvcnQgOiBudWxsKSB8fCB0aGlzLl9kZWZhdWx0cy5kYXlOYW1lc1Nob3J0LAoJCQlkYXlOYW1lcyA9IChzZXR0aW5ncyA\/IHNldHRpbmdzLmRheU5hbWVzIDogbnVsbCkgfHwgdGhpcy5fZGVmYXVsdHMuZGF5TmFtZXMsCgkJCW1vbnRoTmFtZXNTaG9ydCA9IChzZXR0aW5ncyA\/IHNldHRpbmdzLm1vbnRoTmFtZXNTaG9ydCA6IG51bGwpIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXNTaG9ydCwKCQkJbW9udGhOYW1lcyA9IChzZXR0aW5ncyA\/IHNldHRpbmdzLm1vbnRoTmFtZXMgOiBudWxsKSB8fCB0aGlzLl9kZWZhdWx0cy5tb250aE5hbWVzLAoJCQkvLyBDaGVjayB3aGV0aGVyIGEgZm9ybWF0IGNoYXJhY3RlciBpcyBkb3VibGVkCgkJCWxvb2tBaGVhZCA9IGZ1bmN0aW9uKG1hdGNoKSB7CgkJCQl2YXIgbWF0Y2hlcyA9IChpRm9ybWF0ICsgMSA8IGZvcm1hdC5sZW5ndGggJiYgZm9ybWF0LmNoYXJBdChpRm9ybWF0ICsgMSkgPT09IG1hdGNoKTsKCQkJCWlmIChtYXRjaGVzKSB7CgkJCQkJaUZvcm1hdCsrOwoJCQkJfQoJCQkJcmV0dXJuIG1hdGNoZXM7CgkJCX0sCgkJCS8vIEZvcm1hdCBhIG51bWJlciwgd2l0aCBsZWFkaW5nIHplcm8gaWYgbmVjZXNzYXJ5CgkJCWZvcm1hdE51bWJlciA9IGZ1bmN0aW9uKG1hdGNoLCB2YWx1ZSwgbGVuKSB7CgkJCQl2YXIgbnVtID0gIiIgKyB2YWx1ZTsKCQkJCWlmIChsb29rQWhlYWQobWF0Y2gpKSB7CgkJCQkJd2hpbGUgKG51bS5sZW5ndGggPCBsZW4pIHsKCQkJCQkJbnVtID0gIjAiICsgbnVtOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiBudW07CgkJCX0sCgkJCS8vIEZvcm1hdCBhIG5hbWUsIHNob3J0IG9yIGxvbmcgYXMgcmVxdWVzdGVkCgkJCWZvcm1hdE5hbWUgPSBmdW5jdGlvbihtYXRjaCwgdmFsdWUsIHNob3J0TmFtZXMsIGxvbmdOYW1lcykgewoJCQkJcmV0dXJuIChsb29rQWhlYWQobWF0Y2gpID8gbG9uZ05hbWVzW3ZhbHVlXSA6IHNob3J0TmFtZXNbdmFsdWVdKTsKCQkJfSwKCQkJb3V0cHV0ID0gIiIsCgkJCWxpdGVyYWwgPSBmYWxzZTsKCgkJaWYgKGRhdGUpIHsKCQkJZm9yIChpRm9ybWF0ID0gMDsgaUZvcm1hdCA8IGZvcm1hdC5sZW5ndGg7IGlGb3JtYXQrKykgewoJCQkJaWYgKGxpdGVyYWwpIHsKCQkJCQlpZiAoZm9ybWF0LmNoYXJBdChpRm9ybWF0KSA9PT0gIiciICYmICFsb29rQWhlYWQoIiciKSkgewoJCQkJCQlsaXRlcmFsID0gZmFsc2U7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb3V0cHV0ICs9IGZvcm1hdC5jaGFyQXQoaUZvcm1hdCk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlzd2l0Y2ggKGZvcm1hdC5jaGFyQXQoaUZvcm1hdCkpIHsKCQkJCQkJY2FzZSAiZCI6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TnVtYmVyKCJkIiwgZGF0ZS5nZXREYXRlKCksIDIpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIkQiOgoJCQkJCQkJb3V0cHV0ICs9IGZvcm1hdE5hbWUoIkQiLCBkYXRlLmdldERheSgpLCBkYXlOYW1lc1Nob3J0LCBkYXlOYW1lcyk7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAibyI6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TnVtYmVyKCJvIiwKCQkJCQkJCQlNYXRoLnJvdW5kKChuZXcgRGF0ZShkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSwgZGF0ZS5nZXREYXRlKCkpLmdldFRpbWUoKSAtIG5ldyBEYXRlKGRhdGUuZ2V0RnVsbFllYXIoKSwgMCwgMCkuZ2V0VGltZSgpKSAvIDg2NDAwMDAwKSwgMyk7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAibSI6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TnVtYmVyKCJtIiwgZGF0ZS5nZXRNb250aCgpICsgMSwgMik7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiTSI6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TmFtZSgiTSIsIGRhdGUuZ2V0TW9udGgoKSwgbW9udGhOYW1lc1Nob3J0LCBtb250aE5hbWVzKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICJ5IjoKCQkJCQkJCW91dHB1dCArPSAobG9va0FoZWFkKCJ5IikgPyBkYXRlLmdldEZ1bGxZZWFyKCkgOgoJCQkJCQkJCShkYXRlLmdldFllYXIoKSAlIDEwMCA8IDEwID8gIjAiIDogIiIpICsgZGF0ZS5nZXRZZWFyKCkgJSAxMDApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIkAiOgoJCQkJCQkJb3V0cHV0ICs9IGRhdGUuZ2V0VGltZSgpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIiEiOgoJCQkJCQkJb3V0cHV0ICs9IGRhdGUuZ2V0VGltZSgpICogMTAwMDAgKyB0aGlzLl90aWNrc1RvMTk3MDsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICInIjoKCQkJCQkJCWlmIChsb29rQWhlYWQoIiciKSkgewoJCQkJCQkJCW91dHB1dCArPSAiJyI7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWxpdGVyYWwgPSB0cnVlOwoJCQkJCQkJfQoJCQkJCQkJYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0LmNoYXJBdChpRm9ybWF0KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIG91dHB1dDsKCX0sCgoJLyogRXh0cmFjdCBhbGwgcG9zc2libGUgY2hhcmFjdGVycyBmcm9tIHRoZSBkYXRlIGZvcm1hdC4gKi8KCV9wb3NzaWJsZUNoYXJzOiBmdW5jdGlvbiAoZm9ybWF0KSB7CgkJdmFyIGlGb3JtYXQsCgkJCWNoYXJzID0gIiIsCgkJCWxpdGVyYWwgPSBmYWxzZSwKCQkJLy8gQ2hlY2sgd2hldGhlciBhIGZvcm1hdCBjaGFyYWN0ZXIgaXMgZG91YmxlZAoJCQlsb29rQWhlYWQgPSBmdW5jdGlvbihtYXRjaCkgewoJCQkJdmFyIG1hdGNoZXMgPSAoaUZvcm1hdCArIDEgPCBmb3JtYXQubGVuZ3RoICYmIGZvcm1hdC5jaGFyQXQoaUZvcm1hdCArIDEpID09PSBtYXRjaCk7CgkJCQlpZiAobWF0Y2hlcykgewoJCQkJCWlGb3JtYXQrKzsKCQkJCX0KCQkJCXJldHVybiBtYXRjaGVzOwoJCQl9OwoKCQlmb3IgKGlGb3JtYXQgPSAwOyBpRm9ybWF0IDwgZm9ybWF0Lmxlbmd0aDsgaUZvcm1hdCsrKSB7CgkJCWlmIChsaXRlcmFsKSB7CgkJCQlpZiAoZm9ybWF0LmNoYXJBdChpRm9ybWF0KSA9PT0gIiciICYmICFsb29rQWhlYWQoIiciKSkgewoJCQkJCWxpdGVyYWwgPSBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJY2hhcnMgKz0gZm9ybWF0LmNoYXJBdChpRm9ybWF0KTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXN3aXRjaCAoZm9ybWF0LmNoYXJBdChpRm9ybWF0KSkgewoJCQkJCWNhc2UgImQiOiBjYXNlICJtIjogY2FzZSAieSI6IGNhc2UgIkAiOgoJCQkJCQljaGFycyArPSAiMDEyMzQ1Njc4OSI7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIkQiOiBjYXNlICJNIjoKCQkJCQkJcmV0dXJuIG51bGw7IC8vIEFjY2VwdCBhbnl0aGluZwoJCQkJCWNhc2UgIiciOgoJCQkJCQlpZiAobG9va0FoZWFkKCInIikpIHsKCQkJCQkJCWNoYXJzICs9ICInIjsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWxpdGVyYWwgPSB0cnVlOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWNoYXJzICs9IGZvcm1hdC5jaGFyQXQoaUZvcm1hdCk7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIGNoYXJzOwoJfSwKCgkvKiBHZXQgYSBzZXR0aW5nIHZhbHVlLCBkZWZhdWx0aW5nIGlmIG5lY2Vzc2FyeS4gKi8KCV9nZXQ6IGZ1bmN0aW9uKGluc3QsIG5hbWUpIHsKCQlyZXR1cm4gaW5zdC5zZXR0aW5nc1tuYW1lXSAhPT0gdW5kZWZpbmVkID8KCQkJaW5zdC5zZXR0aW5nc1tuYW1lXSA6IHRoaXMuX2RlZmF1bHRzW25hbWVdOwoJfSwKCgkvKiBQYXJzZSBleGlzdGluZyBkYXRlIGFuZCBpbml0aWFsaXNlIGRhdGUgcGlja2VyLiAqLwoJX3NldERhdGVGcm9tRmllbGQ6IGZ1bmN0aW9uKGluc3QsIG5vRGVmYXVsdCkgewoJCWlmIChpbnN0LmlucHV0LnZhbCgpID09PSBpbnN0Lmxhc3RWYWwpIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGRhdGVGb3JtYXQgPSB0aGlzLl9nZXQoaW5zdCwgImRhdGVGb3JtYXQiKSwKCQkJZGF0ZXMgPSBpbnN0Lmxhc3RWYWwgPSBpbnN0LmlucHV0ID8gaW5zdC5pbnB1dC52YWwoKSA6IG51bGwsCgkJCWRlZmF1bHREYXRlID0gdGhpcy5fZ2V0RGVmYXVsdERhdGUoaW5zdCksCgkJCWRhdGUgPSBkZWZhdWx0RGF0ZSwKCQkJc2V0dGluZ3MgPSB0aGlzLl9nZXRGb3JtYXRDb25maWcoaW5zdCk7CgoJCXRyeSB7CgkJCWRhdGUgPSB0aGlzLnBhcnNlRGF0ZShkYXRlRm9ybWF0LCBkYXRlcywgc2V0dGluZ3MpIHx8IGRlZmF1bHREYXRlOwoJCX0gY2F0Y2ggKGV2ZW50KSB7CgkJCWRhdGVzID0gKG5vRGVmYXVsdCA\/ICIiIDogZGF0ZXMpOwoJCX0KCQlpbnN0LnNlbGVjdGVkRGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBkYXRlLmdldE1vbnRoKCk7CgkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOwoJCWluc3QuY3VycmVudERheSA9IChkYXRlcyA\/IGRhdGUuZ2V0RGF0ZSgpIDogMCk7CgkJaW5zdC5jdXJyZW50TW9udGggPSAoZGF0ZXMgPyBkYXRlLmdldE1vbnRoKCkgOiAwKTsKCQlpbnN0LmN1cnJlbnRZZWFyID0gKGRhdGVzID8gZGF0ZS5nZXRGdWxsWWVhcigpIDogMCk7CgkJdGhpcy5fYWRqdXN0SW5zdERhdGUoaW5zdCk7Cgl9LAoKCS8qIFJldHJpZXZlIHRoZSBkZWZhdWx0IGRhdGUgc2hvd24gb24gb3BlbmluZy4gKi8KCV9nZXREZWZhdWx0RGF0ZTogZnVuY3Rpb24oaW5zdCkgewoJCXJldHVybiB0aGlzLl9yZXN0cmljdE1pbk1heChpbnN0LAoJCQl0aGlzLl9kZXRlcm1pbmVEYXRlKGluc3QsIHRoaXMuX2dldChpbnN0LCAiZGVmYXVsdERhdGUiKSwgbmV3IERhdGUoKSkpOwoJfSwKCgkvKiBBIGRhdGUgbWF5IGJlIHNwZWNpZmllZCBhcyBhbiBleGFjdCB2YWx1ZSBvciBhIHJlbGF0aXZlIG9uZS4gKi8KCV9kZXRlcm1pbmVEYXRlOiBmdW5jdGlvbihpbnN0LCBkYXRlLCBkZWZhdWx0RGF0ZSkgewoJCXZhciBvZmZzZXROdW1lcmljID0gZnVuY3Rpb24ob2Zmc2V0KSB7CgkJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCQlkYXRlLnNldERhdGUoZGF0ZS5nZXREYXRlKCkgKyBvZmZzZXQpOwoJCQkJcmV0dXJuIGRhdGU7CgkJCX0sCgkJCW9mZnNldFN0cmluZyA9IGZ1bmN0aW9uKG9mZnNldCkgewoJCQkJdHJ5IHsKCQkJCQlyZXR1cm4gJC5kYXRlcGlja2VyLnBhcnNlRGF0ZSgkLmRhdGVwaWNrZXIuX2dldChpbnN0LCAiZGF0ZUZvcm1hdCIpLAoJCQkJCQlvZmZzZXQsICQuZGF0ZXBpY2tlci5fZ2V0Rm9ybWF0Q29uZmlnKGluc3QpKTsKCQkJCX0KCQkJCWNhdGNoIChlKSB7CgkJCQkJLy8gSWdub3JlCgkJCQl9CgoJCQkJdmFyIGRhdGUgPSAob2Zmc2V0LnRvTG93ZXJDYXNlKCkubWF0Y2goL15jLykgPwoJCQkJCSQuZGF0ZXBpY2tlci5fZ2V0RGF0ZShpbnN0KSA6IG51bGwpIHx8IG5ldyBEYXRlKCksCgkJCQkJeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKSwKCQkJCQltb250aCA9IGRhdGUuZ2V0TW9udGgoKSwKCQkJCQlkYXkgPSBkYXRlLmdldERhdGUoKSwKCQkJCQlwYXR0ZXJuID0gLyhbK1wtXT9bMC05XSspXHMqKGR8RHx3fFd8bXxNfHl8WSk\/L2csCgkJCQkJbWF0Y2hlcyA9IHBhdHRlcm4uZXhlYyhvZmZzZXQpOwoKCQkJCXdoaWxlIChtYXRjaGVzKSB7CgkJCQkJc3dpdGNoIChtYXRjaGVzWzJdIHx8ICJkIikgewoJCQkJCQljYXNlICJkIiA6IGNhc2UgIkQiIDoKCQkJCQkJCWRheSArPSBwYXJzZUludChtYXRjaGVzWzFdLDEwKTsgYnJlYWs7CgkJCQkJCWNhc2UgInciIDogY2FzZSAiVyIgOgoJCQkJCQkJZGF5ICs9IHBhcnNlSW50KG1hdGNoZXNbMV0sMTApICogNzsgYnJlYWs7CgkJCQkJCWNhc2UgIm0iIDogY2FzZSAiTSIgOgoJCQkJCQkJbW9udGggKz0gcGFyc2VJbnQobWF0Y2hlc1sxXSwxMCk7CgkJCQkJCQlkYXkgPSBNYXRoLm1pbihkYXksICQuZGF0ZXBpY2tlci5fZ2V0RGF5c0luTW9udGgoeWVhciwgbW9udGgpKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICJ5IjogY2FzZSAiWSIgOgoJCQkJCQkJeWVhciArPSBwYXJzZUludChtYXRjaGVzWzFdLDEwKTsKCQkJCQkJCWRheSA9IE1hdGgubWluKGRheSwgJC5kYXRlcGlja2VyLl9nZXREYXlzSW5Nb250aCh5ZWFyLCBtb250aCkpOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJCW1hdGNoZXMgPSBwYXR0ZXJuLmV4ZWMob2Zmc2V0KTsKCQkJCX0KCQkJCXJldHVybiBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF5KTsKCQkJfSwKCQkJbmV3RGF0ZSA9IChkYXRlID09IG51bGwgfHwgZGF0ZSA9PT0gIiIgPyBkZWZhdWx0RGF0ZSA6ICh0eXBlb2YgZGF0ZSA9PT0gInN0cmluZyIgPyBvZmZzZXRTdHJpbmcoZGF0ZSkgOgoJCQkJKHR5cGVvZiBkYXRlID09PSAibnVtYmVyIiA\/IChpc05hTihkYXRlKSA\/IGRlZmF1bHREYXRlIDogb2Zmc2V0TnVtZXJpYyhkYXRlKSkgOiBuZXcgRGF0ZShkYXRlLmdldFRpbWUoKSkpKSk7CgoJCW5ld0RhdGUgPSAobmV3RGF0ZSAmJiBuZXdEYXRlLnRvU3RyaW5nKCkgPT09ICJJbnZhbGlkIERhdGUiID8gZGVmYXVsdERhdGUgOiBuZXdEYXRlKTsKCQlpZiAobmV3RGF0ZSkgewoJCQluZXdEYXRlLnNldEhvdXJzKDApOwoJCQluZXdEYXRlLnNldE1pbnV0ZXMoMCk7CgkJCW5ld0RhdGUuc2V0U2Vjb25kcygwKTsKCQkJbmV3RGF0ZS5zZXRNaWxsaXNlY29uZHMoMCk7CgkJfQoJCXJldHVybiB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdChuZXdEYXRlKTsKCX0sCgoJLyogSGFuZGxlIHN3aXRjaCB0by9mcm9tIGRheWxpZ2h0IHNhdmluZy4KCSAqIEhvdXJzIG1heSBiZSBub24temVybyBvbiBkYXlsaWdodCBzYXZpbmcgY3V0LW92ZXI6CgkgKiA+IDEyIHdoZW4gbWlkbmlnaHQgY2hhbmdlb3ZlciwgYnV0IHRoZW4gY2Fubm90IGdlbmVyYXRlCgkgKiBtaWRuaWdodCBkYXRldGltZSwgc28ganVtcCB0byAxQU0sIG90aGVyd2lzZSByZXNldC4KCSAqIEBwYXJhbSAgZGF0ZSAgKERhdGUpIHRoZSBkYXRlIHRvIGNoZWNrCgkgKiBAcmV0dXJuICAoRGF0ZSkgdGhlIGNvcnJlY3RlZCBkYXRlCgkgKi8KCV9kYXlsaWdodFNhdmluZ0FkanVzdDogZnVuY3Rpb24oZGF0ZSkgewoJCWlmICghZGF0ZSkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJZGF0ZS5zZXRIb3VycyhkYXRlLmdldEhvdXJzKCkgPiAxMiA\/IGRhdGUuZ2V0SG91cnMoKSArIDIgOiAwKTsKCQlyZXR1cm4gZGF0ZTsKCX0sCgoJLyogU2V0IHRoZSBkYXRlKHMpIGRpcmVjdGx5LiAqLwoJX3NldERhdGU6IGZ1bmN0aW9uKGluc3QsIGRhdGUsIG5vQ2hhbmdlKSB7CgkJdmFyIGNsZWFyID0gIWRhdGUsCgkJCW9yaWdNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCwKCQkJb3JpZ1llYXIgPSBpbnN0LnNlbGVjdGVkWWVhciwKCQkJbmV3RGF0ZSA9IHRoaXMuX3Jlc3RyaWN0TWluTWF4KGluc3QsIHRoaXMuX2RldGVybWluZURhdGUoaW5zdCwgZGF0ZSwgbmV3IERhdGUoKSkpOwoKCQlpbnN0LnNlbGVjdGVkRGF5ID0gaW5zdC5jdXJyZW50RGF5ID0gbmV3RGF0ZS5nZXREYXRlKCk7CgkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBpbnN0LmN1cnJlbnRNb250aCA9IG5ld0RhdGUuZ2V0TW9udGgoKTsKCQlpbnN0LmRyYXdZZWFyID0gaW5zdC5zZWxlY3RlZFllYXIgPSBpbnN0LmN1cnJlbnRZZWFyID0gbmV3RGF0ZS5nZXRGdWxsWWVhcigpOwoJCWlmICgob3JpZ01vbnRoICE9PSBpbnN0LnNlbGVjdGVkTW9udGggfHwgb3JpZ1llYXIgIT09IGluc3Quc2VsZWN0ZWRZZWFyKSAmJiAhbm9DaGFuZ2UpIHsKCQkJdGhpcy5fbm90aWZ5Q2hhbmdlKGluc3QpOwoJCX0KCQl0aGlzLl9hZGp1c3RJbnN0RGF0ZShpbnN0KTsKCQlpZiAoaW5zdC5pbnB1dCkgewoJCQlpbnN0LmlucHV0LnZhbChjbGVhciA\/ICIiIDogdGhpcy5fZm9ybWF0RGF0ZShpbnN0KSk7CgkJfQoJfSwKCgkvKiBSZXRyaWV2ZSB0aGUgZGF0ZShzKSBkaXJlY3RseS4gKi8KCV9nZXREYXRlOiBmdW5jdGlvbihpbnN0KSB7CgkJdmFyIHN0YXJ0RGF0ZSA9ICghaW5zdC5jdXJyZW50WWVhciB8fCAoaW5zdC5pbnB1dCAmJiBpbnN0LmlucHV0LnZhbCgpID09PSAiIikgPyBudWxsIDoKCQkJdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QobmV3IERhdGUoCgkJCWluc3QuY3VycmVudFllYXIsIGluc3QuY3VycmVudE1vbnRoLCBpbnN0LmN1cnJlbnREYXkpKSk7CgkJCXJldHVybiBzdGFydERhdGU7Cgl9LAoKCS8qIEF0dGFjaCB0aGUgb254eHggaGFuZGxlcnMuICBUaGVzZSBhcmUgZGVjbGFyZWQgc3RhdGljYWxseSBzbwoJICogdGhleSB3b3JrIHdpdGggc3RhdGljIGNvZGUgdHJhbnNmb3JtZXJzIGxpa2UgQ2FqYS4KCSAqLwoJX2F0dGFjaEhhbmRsZXJzOiBmdW5jdGlvbihpbnN0KSB7CgkJdmFyIHN0ZXBNb250aHMgPSB0aGlzLl9nZXQoaW5zdCwgInN0ZXBNb250aHMiKSwKCQkJaWQgPSAiIyIgKyBpbnN0LmlkLnJlcGxhY2UoIC9cXFxcL2csICJcXCIgKTsKCQlpbnN0LmRwRGl2LmZpbmQoIltkYXRhLWhhbmRsZXJdIikubWFwKGZ1bmN0aW9uICgpIHsKCQkJdmFyIGhhbmRsZXIgPSB7CgkJCQlwcmV2OiBmdW5jdGlvbiAoKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKGlkLCAtc3RlcE1vbnRocywgIk0iKTsKCQkJCX0sCgkJCQluZXh0OiBmdW5jdGlvbiAoKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKGlkLCArc3RlcE1vbnRocywgIk0iKTsKCQkJCX0sCgkJCQloaWRlOiBmdW5jdGlvbiAoKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQkJfSwKCQkJCXRvZGF5OiBmdW5jdGlvbiAoKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9nb3RvVG9kYXkoaWQpOwoJCQkJfSwKCQkJCXNlbGVjdERheTogZnVuY3Rpb24gKCkgewoJCQkJCSQuZGF0ZXBpY2tlci5fc2VsZWN0RGF5KGlkLCArdGhpcy5nZXRBdHRyaWJ1dGUoImRhdGEtbW9udGgiKSwgK3RoaXMuZ2V0QXR0cmlidXRlKCJkYXRhLXllYXIiKSwgdGhpcyk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSwKCQkJCXNlbGVjdE1vbnRoOiBmdW5jdGlvbiAoKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9zZWxlY3RNb250aFllYXIoaWQsIHRoaXMsICJNIik7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSwKCQkJCXNlbGVjdFllYXI6IGZ1bmN0aW9uICgpIHsKCQkJCQkkLmRhdGVwaWNrZXIuX3NlbGVjdE1vbnRoWWVhcihpZCwgdGhpcywgIlkiKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX07CgkJCSQodGhpcykuYmluZCh0aGlzLmdldEF0dHJpYnV0ZSgiZGF0YS1ldmVudCIpLCBoYW5kbGVyW3RoaXMuZ2V0QXR0cmlidXRlKCJkYXRhLWhhbmRsZXIiKV0pOwoJCX0pOwoJfSwKCgkvKiBHZW5lcmF0ZSB0aGUgSFRNTCBmb3IgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGRhdGUgcGlja2VyLiAqLwoJX2dlbmVyYXRlSFRNTDogZnVuY3Rpb24oaW5zdCkgewoJCXZhciBtYXhEcmF3LCBwcmV2VGV4dCwgcHJldiwgbmV4dFRleHQsIG5leHQsIGN1cnJlbnRUZXh0LCBnb3RvRGF0ZSwKCQkJY29udHJvbHMsIGJ1dHRvblBhbmVsLCBmaXJzdERheSwgc2hvd1dlZWssIGRheU5hbWVzLCBkYXlOYW1lc01pbiwKCQkJbW9udGhOYW1lcywgbW9udGhOYW1lc1Nob3J0LCBiZWZvcmVTaG93RGF5LCBzaG93T3RoZXJNb250aHMsCgkJCXNlbGVjdE90aGVyTW9udGhzLCBkZWZhdWx0RGF0ZSwgaHRtbCwgZG93LCByb3csIGdyb3VwLCBjb2wsIHNlbGVjdGVkRGF0ZSwKCQkJY29ybmVyQ2xhc3MsIGNhbGVuZGVyLCB0aGVhZCwgZGF5LCBkYXlzSW5Nb250aCwgbGVhZERheXMsIGN1clJvd3MsIG51bVJvd3MsCgkJCXByaW50RGF0ZSwgZFJvdywgdGJvZHksIGRheVNldHRpbmdzLCBvdGhlck1vbnRoLCB1bnNlbGVjdGFibGUsCgkJCXRlbXBEYXRlID0gbmV3IERhdGUoKSwKCQkJdG9kYXkgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCgKCQkJCW5ldyBEYXRlKHRlbXBEYXRlLmdldEZ1bGxZZWFyKCksIHRlbXBEYXRlLmdldE1vbnRoKCksIHRlbXBEYXRlLmdldERhdGUoKSkpLCAvLyBjbGVhciB0aW1lCgkJCWlzUlRMID0gdGhpcy5fZ2V0KGluc3QsICJpc1JUTCIpLAoJCQlzaG93QnV0dG9uUGFuZWwgPSB0aGlzLl9nZXQoaW5zdCwgInNob3dCdXR0b25QYW5lbCIpLAoJCQloaWRlSWZOb1ByZXZOZXh0ID0gdGhpcy5fZ2V0KGluc3QsICJoaWRlSWZOb1ByZXZOZXh0IiksCgkJCW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQgPSB0aGlzLl9nZXQoaW5zdCwgIm5hdmlnYXRpb25Bc0RhdGVGb3JtYXQiKSwKCQkJbnVtTW9udGhzID0gdGhpcy5fZ2V0TnVtYmVyT2ZNb250aHMoaW5zdCksCgkJCXNob3dDdXJyZW50QXRQb3MgPSB0aGlzLl9nZXQoaW5zdCwgInNob3dDdXJyZW50QXRQb3MiKSwKCQkJc3RlcE1vbnRocyA9IHRoaXMuX2dldChpbnN0LCAic3RlcE1vbnRocyIpLAoJCQlpc011bHRpTW9udGggPSAobnVtTW9udGhzWzBdICE9PSAxIHx8IG51bU1vbnRoc1sxXSAhPT0gMSksCgkJCWN1cnJlbnREYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoKCFpbnN0LmN1cnJlbnREYXkgPyBuZXcgRGF0ZSg5OTk5LCA5LCA5KSA6CgkJCQluZXcgRGF0ZShpbnN0LmN1cnJlbnRZZWFyLCBpbnN0LmN1cnJlbnRNb250aCwgaW5zdC5jdXJyZW50RGF5KSkpLAoJCQltaW5EYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZShpbnN0LCAibWluIiksCgkJCW1heERhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKGluc3QsICJtYXgiKSwKCQkJZHJhd01vbnRoID0gaW5zdC5kcmF3TW9udGggLSBzaG93Q3VycmVudEF0UG9zLAoJCQlkcmF3WWVhciA9IGluc3QuZHJhd1llYXI7CgoJCWlmIChkcmF3TW9udGggPCAwKSB7CgkJCWRyYXdNb250aCArPSAxMjsKCQkJZHJhd1llYXItLTsKCQl9CgkJaWYgKG1heERhdGUpIHsKCQkJbWF4RHJhdyA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KG5ldyBEYXRlKG1heERhdGUuZ2V0RnVsbFllYXIoKSwKCQkJCW1heERhdGUuZ2V0TW9udGgoKSAtIChudW1Nb250aHNbMF0gKiBudW1Nb250aHNbMV0pICsgMSwgbWF4RGF0ZS5nZXREYXRlKCkpKTsKCQkJbWF4RHJhdyA9IChtaW5EYXRlICYmIG1heERyYXcgPCBtaW5EYXRlID8gbWluRGF0ZSA6IG1heERyYXcpOwoJCQl3aGlsZSAodGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QobmV3IERhdGUoZHJhd1llYXIsIGRyYXdNb250aCwgMSkpID4gbWF4RHJhdykgewoJCQkJZHJhd01vbnRoLS07CgkJCQlpZiAoZHJhd01vbnRoIDwgMCkgewoJCQkJCWRyYXdNb250aCA9IDExOwoJCQkJCWRyYXdZZWFyLS07CgkJCQl9CgkJCX0KCQl9CgkJaW5zdC5kcmF3TW9udGggPSBkcmF3TW9udGg7CgkJaW5zdC5kcmF3WWVhciA9IGRyYXdZZWFyOwoKCQlwcmV2VGV4dCA9IHRoaXMuX2dldChpbnN0LCAicHJldlRleHQiKTsKCQlwcmV2VGV4dCA9ICghbmF2aWdhdGlvbkFzRGF0ZUZvcm1hdCA\/IHByZXZUZXh0IDogdGhpcy5mb3JtYXREYXRlKHByZXZUZXh0LAoJCQl0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdChuZXcgRGF0ZShkcmF3WWVhciwgZHJhd01vbnRoIC0gc3RlcE1vbnRocywgMSkpLAoJCQl0aGlzLl9nZXRGb3JtYXRDb25maWcoaW5zdCkpKTsKCgkJcHJldiA9ICh0aGlzLl9jYW5BZGp1c3RNb250aChpbnN0LCAtMSwgZHJhd1llYXIsIGRyYXdNb250aCkgPwoJCQkiPGEgY2xhc3M9J3VpLWRhdGVwaWNrZXItcHJldiB1aS1jb3JuZXItYWxsJyBkYXRhLWhhbmRsZXI9J3ByZXYnIGRhdGEtZXZlbnQ9J2NsaWNrJyIgKwoJCQkiIHRpdGxlPSciICsgcHJldlRleHQgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWNpcmNsZS10cmlhbmdsZS0iICsgKCBpc1JUTCA\/ICJlIiA6ICJ3IikgKyAiJz4iICsgcHJldlRleHQgKyAiPC9zcGFuPjwvYT4iIDoKCQkJKGhpZGVJZk5vUHJldk5leHQgPyAiIiA6ICI8YSBjbGFzcz0ndWktZGF0ZXBpY2tlci1wcmV2IHVpLWNvcm5lci1hbGwgdWktc3RhdGUtZGlzYWJsZWQnIHRpdGxlPSciKyBwcmV2VGV4dCArIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1jaXJjbGUtdHJpYW5nbGUtIiArICggaXNSVEwgPyAiZSIgOiAidyIpICsgIic+IiArIHByZXZUZXh0ICsgIjwvc3Bhbj48L2E+IikpOwoKCQluZXh0VGV4dCA9IHRoaXMuX2dldChpbnN0LCAibmV4dFRleHQiKTsKCQluZXh0VGV4dCA9ICghbmF2aWdhdGlvbkFzRGF0ZUZvcm1hdCA\/IG5leHRUZXh0IDogdGhpcy5mb3JtYXREYXRlKG5leHRUZXh0LAoJCQl0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdChuZXcgRGF0ZShkcmF3WWVhciwgZHJhd01vbnRoICsgc3RlcE1vbnRocywgMSkpLAoJCQl0aGlzLl9nZXRGb3JtYXRDb25maWcoaW5zdCkpKTsKCgkJbmV4dCA9ICh0aGlzLl9jYW5BZGp1c3RNb250aChpbnN0LCArMSwgZHJhd1llYXIsIGRyYXdNb250aCkgPwoJCQkiPGEgY2xhc3M9J3VpLWRhdGVwaWNrZXItbmV4dCB1aS1jb3JuZXItYWxsJyBkYXRhLWhhbmRsZXI9J25leHQnIGRhdGEtZXZlbnQ9J2NsaWNrJyIgKwoJCQkiIHRpdGxlPSciICsgbmV4dFRleHQgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWNpcmNsZS10cmlhbmdsZS0iICsgKCBpc1JUTCA\/ICJ3IiA6ICJlIikgKyAiJz4iICsgbmV4dFRleHQgKyAiPC9zcGFuPjwvYT4iIDoKCQkJKGhpZGVJZk5vUHJldk5leHQgPyAiIiA6ICI8YSBjbGFzcz0ndWktZGF0ZXBpY2tlci1uZXh0IHVpLWNvcm5lci1hbGwgdWktc3RhdGUtZGlzYWJsZWQnIHRpdGxlPSciKyBuZXh0VGV4dCArICInPjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tY2lyY2xlLXRyaWFuZ2xlLSIgKyAoIGlzUlRMID8gInciIDogImUiKSArICInPiIgKyBuZXh0VGV4dCArICI8L3NwYW4+PC9hPiIpKTsKCgkJY3VycmVudFRleHQgPSB0aGlzLl9nZXQoaW5zdCwgImN1cnJlbnRUZXh0Iik7CgkJZ290b0RhdGUgPSAodGhpcy5fZ2V0KGluc3QsICJnb3RvQ3VycmVudCIpICYmIGluc3QuY3VycmVudERheSA\/IGN1cnJlbnREYXRlIDogdG9kYXkpOwoJCWN1cnJlbnRUZXh0ID0gKCFuYXZpZ2F0aW9uQXNEYXRlRm9ybWF0ID8gY3VycmVudFRleHQgOgoJCQl0aGlzLmZvcm1hdERhdGUoY3VycmVudFRleHQsIGdvdG9EYXRlLCB0aGlzLl9nZXRGb3JtYXRDb25maWcoaW5zdCkpKTsKCgkJY29udHJvbHMgPSAoIWluc3QuaW5saW5lID8gIjxidXR0b24gdHlwZT0nYnV0dG9uJyBjbGFzcz0ndWktZGF0ZXBpY2tlci1jbG9zZSB1aS1zdGF0ZS1kZWZhdWx0IHVpLXByaW9yaXR5LXByaW1hcnkgdWktY29ybmVyLWFsbCcgZGF0YS1oYW5kbGVyPSdoaWRlJyBkYXRhLWV2ZW50PSdjbGljayc+IiArCgkJCXRoaXMuX2dldChpbnN0LCAiY2xvc2VUZXh0IikgKyAiPC9idXR0b24+IiA6ICIiKTsKCgkJYnV0dG9uUGFuZWwgPSAoc2hvd0J1dHRvblBhbmVsKSA\/ICI8ZGl2IGNsYXNzPSd1aS1kYXRlcGlja2VyLWJ1dHRvbnBhbmUgdWktd2lkZ2V0LWNvbnRlbnQnPiIgKyAoaXNSVEwgPyBjb250cm9scyA6ICIiKSArCgkJCSh0aGlzLl9pc0luUmFuZ2UoaW5zdCwgZ290b0RhdGUpID8gIjxidXR0b24gdHlwZT0nYnV0dG9uJyBjbGFzcz0ndWktZGF0ZXBpY2tlci1jdXJyZW50IHVpLXN0YXRlLWRlZmF1bHQgdWktcHJpb3JpdHktc2Vjb25kYXJ5IHVpLWNvcm5lci1hbGwnIGRhdGEtaGFuZGxlcj0ndG9kYXknIGRhdGEtZXZlbnQ9J2NsaWNrJyIgKwoJCQkiPiIgKyBjdXJyZW50VGV4dCArICI8L2J1dHRvbj4iIDogIiIpICsgKGlzUlRMID8gIiIgOiBjb250cm9scykgKyAiPC9kaXY+IiA6ICIiOwoKCQlmaXJzdERheSA9IHBhcnNlSW50KHRoaXMuX2dldChpbnN0LCAiZmlyc3REYXkiKSwxMCk7CgkJZmlyc3REYXkgPSAoaXNOYU4oZmlyc3REYXkpID8gMCA6IGZpcnN0RGF5KTsKCgkJc2hvd1dlZWsgPSB0aGlzLl9nZXQoaW5zdCwgInNob3dXZWVrIik7CgkJZGF5TmFtZXMgPSB0aGlzLl9nZXQoaW5zdCwgImRheU5hbWVzIik7CgkJZGF5TmFtZXNNaW4gPSB0aGlzLl9nZXQoaW5zdCwgImRheU5hbWVzTWluIik7CgkJbW9udGhOYW1lcyA9IHRoaXMuX2dldChpbnN0LCAibW9udGhOYW1lcyIpOwoJCW1vbnRoTmFtZXNTaG9ydCA9IHRoaXMuX2dldChpbnN0LCAibW9udGhOYW1lc1Nob3J0Iik7CgkJYmVmb3JlU2hvd0RheSA9IHRoaXMuX2dldChpbnN0LCAiYmVmb3JlU2hvd0RheSIpOwoJCXNob3dPdGhlck1vbnRocyA9IHRoaXMuX2dldChpbnN0LCAic2hvd090aGVyTW9udGhzIik7CgkJc2VsZWN0T3RoZXJNb250aHMgPSB0aGlzLl9nZXQoaW5zdCwgInNlbGVjdE90aGVyTW9udGhzIik7CgkJZGVmYXVsdERhdGUgPSB0aGlzLl9nZXREZWZhdWx0RGF0ZShpbnN0KTsKCQlodG1sID0gIiI7CgkJZG93OwoJCWZvciAocm93ID0gMDsgcm93IDwgbnVtTW9udGhzWzBdOyByb3crKykgewoJCQlncm91cCA9ICIiOwoJCQl0aGlzLm1heFJvd3MgPSA0OwoJCQlmb3IgKGNvbCA9IDA7IGNvbCA8IG51bU1vbnRoc1sxXTsgY29sKyspIHsKCQkJCXNlbGVjdGVkRGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KG5ldyBEYXRlKGRyYXdZZWFyLCBkcmF3TW9udGgsIGluc3Quc2VsZWN0ZWREYXkpKTsKCQkJCWNvcm5lckNsYXNzID0gIiB1aS1jb3JuZXItYWxsIjsKCQkJCWNhbGVuZGVyID0gIiI7CgkJCQlpZiAoaXNNdWx0aU1vbnRoKSB7CgkJCQkJY2FsZW5kZXIgKz0gIjxkaXYgY2xhc3M9J3VpLWRhdGVwaWNrZXItZ3JvdXAiOwoJCQkJCWlmIChudW1Nb250aHNbMV0gPiAxKSB7CgkJCQkJCXN3aXRjaCAoY29sKSB7CgkJCQkJCQljYXNlIDA6IGNhbGVuZGVyICs9ICIgdWktZGF0ZXBpY2tlci1ncm91cC1maXJzdCI7CgkJCQkJCQkJY29ybmVyQ2xhc3MgPSAiIHVpLWNvcm5lci0iICsgKGlzUlRMID8gInJpZ2h0IiA6ICJsZWZ0Iik7IGJyZWFrOwoJCQkJCQkJY2FzZSBudW1Nb250aHNbMV0tMTogY2FsZW5kZXIgKz0gIiB1aS1kYXRlcGlja2VyLWdyb3VwLWxhc3QiOwoJCQkJCQkJCWNvcm5lckNsYXNzID0gIiB1aS1jb3JuZXItIiArIChpc1JUTCA\/ICJsZWZ0IiA6ICJyaWdodCIpOyBicmVhazsKCQkJCQkJCWRlZmF1bHQ6IGNhbGVuZGVyICs9ICIgdWktZGF0ZXBpY2tlci1ncm91cC1taWRkbGUiOyBjb3JuZXJDbGFzcyA9ICIiOyBicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCQljYWxlbmRlciArPSAiJz4iOwoJCQkJfQoJCQkJY2FsZW5kZXIgKz0gIjxkaXYgY2xhc3M9J3VpLWRhdGVwaWNrZXItaGVhZGVyIHVpLXdpZGdldC1oZWFkZXIgdWktaGVscGVyLWNsZWFyZml4IiArIGNvcm5lckNsYXNzICsgIic+IiArCgkJCQkJKC9hbGx8bGVmdC8udGVzdChjb3JuZXJDbGFzcykgJiYgcm93ID09PSAwID8gKGlzUlRMID8gbmV4dCA6IHByZXYpIDogIiIpICsKCQkJCQkoL2FsbHxyaWdodC8udGVzdChjb3JuZXJDbGFzcykgJiYgcm93ID09PSAwID8gKGlzUlRMID8gcHJldiA6IG5leHQpIDogIiIpICsKCQkJCQl0aGlzLl9nZW5lcmF0ZU1vbnRoWWVhckhlYWRlcihpbnN0LCBkcmF3TW9udGgsIGRyYXdZZWFyLCBtaW5EYXRlLCBtYXhEYXRlLAoJCQkJCXJvdyA+IDAgfHwgY29sID4gMCwgbW9udGhOYW1lcywgbW9udGhOYW1lc1Nob3J0KSArIC8vIGRyYXcgbW9udGggaGVhZGVycwoJCQkJCSI8L2Rpdj48dGFibGUgY2xhc3M9J3VpLWRhdGVwaWNrZXItY2FsZW5kYXInPjx0aGVhZD4iICsKCQkJCQkiPHRyPiI7CgkJCQl0aGVhZCA9IChzaG93V2VlayA\/ICI8dGggY2xhc3M9J3VpLWRhdGVwaWNrZXItd2Vlay1jb2wnPiIgKyB0aGlzLl9nZXQoaW5zdCwgIndlZWtIZWFkZXIiKSArICI8L3RoPiIgOiAiIik7CgkJCQlmb3IgKGRvdyA9IDA7IGRvdyA8IDc7IGRvdysrKSB7IC8vIGRheXMgb2YgdGhlIHdlZWsKCQkJCQlkYXkgPSAoZG93ICsgZmlyc3REYXkpICUgNzsKCQkJCQl0aGVhZCArPSAiPHRoIiArICgoZG93ICsgZmlyc3REYXkgKyA2KSAlIDcgPj0gNSA\/ICIgY2xhc3M9J3VpLWRhdGVwaWNrZXItd2Vlay1lbmQnIiA6ICIiKSArICI+IiArCgkJCQkJCSI8c3BhbiB0aXRsZT0nIiArIGRheU5hbWVzW2RheV0gKyAiJz4iICsgZGF5TmFtZXNNaW5bZGF5XSArICI8L3NwYW4+PC90aD4iOwoJCQkJfQoJCQkJY2FsZW5kZXIgKz0gdGhlYWQgKyAiPC90cj48L3RoZWFkPjx0Ym9keT4iOwoJCQkJZGF5c0luTW9udGggPSB0aGlzLl9nZXREYXlzSW5Nb250aChkcmF3WWVhciwgZHJhd01vbnRoKTsKCQkJCWlmIChkcmF3WWVhciA9PT0gaW5zdC5zZWxlY3RlZFllYXIgJiYgZHJhd01vbnRoID09PSBpbnN0LnNlbGVjdGVkTW9udGgpIHsKCQkJCQlpbnN0LnNlbGVjdGVkRGF5ID0gTWF0aC5taW4oaW5zdC5zZWxlY3RlZERheSwgZGF5c0luTW9udGgpOwoJCQkJfQoJCQkJbGVhZERheXMgPSAodGhpcy5fZ2V0Rmlyc3REYXlPZk1vbnRoKGRyYXdZZWFyLCBkcmF3TW9udGgpIC0gZmlyc3REYXkgKyA3KSAlIDc7CgkJCQljdXJSb3dzID0gTWF0aC5jZWlsKChsZWFkRGF5cyArIGRheXNJbk1vbnRoKSAvIDcpOyAvLyBjYWxjdWxhdGUgdGhlIG51bWJlciBvZiByb3dzIHRvIGdlbmVyYXRlCgkJCQludW1Sb3dzID0gKGlzTXVsdGlNb250aCA\/IHRoaXMubWF4Um93cyA+IGN1clJvd3MgPyB0aGlzLm1heFJvd3MgOiBjdXJSb3dzIDogY3VyUm93cyk7IC8vSWYgbXVsdGlwbGUgbW9udGhzLCB1c2UgdGhlIGhpZ2hlciBudW1iZXIgb2Ygcm93cyAoc2VlICM3MDQzKQoJCQkJdGhpcy5tYXhSb3dzID0gbnVtUm93czsKCQkJCXByaW50RGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KG5ldyBEYXRlKGRyYXdZZWFyLCBkcmF3TW9udGgsIDEgLSBsZWFkRGF5cykpOwoJCQkJZm9yIChkUm93ID0gMDsgZFJvdyA8IG51bVJvd3M7IGRSb3crKykgeyAvLyBjcmVhdGUgZGF0ZSBwaWNrZXIgcm93cwoJCQkJCWNhbGVuZGVyICs9ICI8dHI+IjsKCQkJCQl0Ym9keSA9ICghc2hvd1dlZWsgPyAiIiA6ICI8dGQgY2xhc3M9J3VpLWRhdGVwaWNrZXItd2Vlay1jb2wnPiIgKwoJCQkJCQl0aGlzLl9nZXQoaW5zdCwgImNhbGN1bGF0ZVdlZWsiKShwcmludERhdGUpICsgIjwvdGQ+Iik7CgkJCQkJZm9yIChkb3cgPSAwOyBkb3cgPCA3OyBkb3crKykgeyAvLyBjcmVhdGUgZGF0ZSBwaWNrZXIgZGF5cwoJCQkJCQlkYXlTZXR0aW5ncyA9IChiZWZvcmVTaG93RGF5ID8KCQkJCQkJCWJlZm9yZVNob3dEYXkuYXBwbHkoKGluc3QuaW5wdXQgPyBpbnN0LmlucHV0WzBdIDogbnVsbCksIFtwcmludERhdGVdKSA6IFt0cnVlLCAiIl0pOwoJCQkJCQlvdGhlck1vbnRoID0gKHByaW50RGF0ZS5nZXRNb250aCgpICE9PSBkcmF3TW9udGgpOwoJCQkJCQl1bnNlbGVjdGFibGUgPSAob3RoZXJNb250aCAmJiAhc2VsZWN0T3RoZXJNb250aHMpIHx8ICFkYXlTZXR0aW5nc1swXSB8fAoJCQkJCQkJKG1pbkRhdGUgJiYgcHJpbnREYXRlIDwgbWluRGF0ZSkgfHwgKG1heERhdGUgJiYgcHJpbnREYXRlID4gbWF4RGF0ZSk7CgkJCQkJCXRib2R5ICs9ICI8dGQgY2xhc3M9JyIgKwoJCQkJCQkJKChkb3cgKyBmaXJzdERheSArIDYpICUgNyA+PSA1ID8gIiB1aS1kYXRlcGlja2VyLXdlZWstZW5kIiA6ICIiKSArIC8vIGhpZ2hsaWdodCB3ZWVrZW5kcwoJCQkJCQkJKG90aGVyTW9udGggPyAiIHVpLWRhdGVwaWNrZXItb3RoZXItbW9udGgiIDogIiIpICsgLy8gaGlnaGxpZ2h0IGRheXMgZnJvbSBvdGhlciBtb250aHMKCQkJCQkJCSgocHJpbnREYXRlLmdldFRpbWUoKSA9PT0gc2VsZWN0ZWREYXRlLmdldFRpbWUoKSAmJiBkcmF3TW9udGggPT09IGluc3Quc2VsZWN0ZWRNb250aCAmJiBpbnN0Ll9rZXlFdmVudCkgfHwgLy8gdXNlciBwcmVzc2VkIGtleQoJCQkJCQkJKGRlZmF1bHREYXRlLmdldFRpbWUoKSA9PT0gcHJpbnREYXRlLmdldFRpbWUoKSAmJiBkZWZhdWx0RGF0ZS5nZXRUaW1lKCkgPT09IHNlbGVjdGVkRGF0ZS5nZXRUaW1lKCkpID8KCQkJCQkJCS8vIG9yIGRlZmF1bHREYXRlIGlzIGN1cnJlbnQgcHJpbnRlZERhdGUgYW5kIGRlZmF1bHREYXRlIGlzIHNlbGVjdGVkRGF0ZQoJCQkJCQkJIiAiICsgdGhpcy5fZGF5T3ZlckNsYXNzIDogIiIpICsgLy8gaGlnaGxpZ2h0IHNlbGVjdGVkIGRheQoJCQkJCQkJKHVuc2VsZWN0YWJsZSA\/ICIgIiArIHRoaXMuX3Vuc2VsZWN0YWJsZUNsYXNzICsgIiB1aS1zdGF0ZS1kaXNhYmxlZCI6ICIiKSArICAvLyBoaWdobGlnaHQgdW5zZWxlY3RhYmxlIGRheXMKCQkJCQkJCShvdGhlck1vbnRoICYmICFzaG93T3RoZXJNb250aHMgPyAiIiA6ICIgIiArIGRheVNldHRpbmdzWzFdICsgLy8gaGlnaGxpZ2h0IGN1c3RvbSBkYXRlcwoJCQkJCQkJKHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IGN1cnJlbnREYXRlLmdldFRpbWUoKSA\/ICIgIiArIHRoaXMuX2N1cnJlbnRDbGFzcyA6ICIiKSArIC8vIGhpZ2hsaWdodCBzZWxlY3RlZCBkYXkKCQkJCQkJCShwcmludERhdGUuZ2V0VGltZSgpID09PSB0b2RheS5nZXRUaW1lKCkgPyAiIHVpLWRhdGVwaWNrZXItdG9kYXkiIDogIiIpKSArICInIiArIC8vIGhpZ2hsaWdodCB0b2RheSAoaWYgZGlmZmVyZW50KQoJCQkJCQkJKCghb3RoZXJNb250aCB8fCBzaG93T3RoZXJNb250aHMpICYmIGRheVNldHRpbmdzWzJdID8gIiB0aXRsZT0nIiArIGRheVNldHRpbmdzWzJdLnJlcGxhY2UoLycvZywgIiYjMzk7IikgKyAiJyIgOiAiIikgKyAvLyBjZWxsIHRpdGxlCgkJCQkJCQkodW5zZWxlY3RhYmxlID8gIiIgOiAiIGRhdGEtaGFuZGxlcj0nc2VsZWN0RGF5JyBkYXRhLWV2ZW50PSdjbGljaycgZGF0YS1tb250aD0nIiArIHByaW50RGF0ZS5nZXRNb250aCgpICsgIicgZGF0YS15ZWFyPSciICsgcHJpbnREYXRlLmdldEZ1bGxZZWFyKCkgKyAiJyIpICsgIj4iICsgLy8gYWN0aW9ucwoJCQkJCQkJKG90aGVyTW9udGggJiYgIXNob3dPdGhlck1vbnRocyA\/ICImI3hhMDsiIDogLy8gZGlzcGxheSBmb3Igb3RoZXIgbW9udGhzCgkJCQkJCQkodW5zZWxlY3RhYmxlID8gIjxzcGFuIGNsYXNzPSd1aS1zdGF0ZS1kZWZhdWx0Jz4iICsgcHJpbnREYXRlLmdldERhdGUoKSArICI8L3NwYW4+IiA6ICI8YSBjbGFzcz0ndWktc3RhdGUtZGVmYXVsdCIgKwoJCQkJCQkJKHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IHRvZGF5LmdldFRpbWUoKSA\/ICIgdWktc3RhdGUtaGlnaGxpZ2h0IiA6ICIiKSArCgkJCQkJCQkocHJpbnREYXRlLmdldFRpbWUoKSA9PT0gY3VycmVudERhdGUuZ2V0VGltZSgpID8gIiB1aS1zdGF0ZS1hY3RpdmUiIDogIiIpICsgLy8gaGlnaGxpZ2h0IHNlbGVjdGVkIGRheQoJCQkJCQkJKG90aGVyTW9udGggPyAiIHVpLXByaW9yaXR5LXNlY29uZGFyeSIgOiAiIikgKyAvLyBkaXN0aW5ndWlzaCBkYXRlcyBmcm9tIG90aGVyIG1vbnRocwoJCQkJCQkJIicgaHJlZj0nIyc+IiArIHByaW50RGF0ZS5nZXREYXRlKCkgKyAiPC9hPiIpKSArICI8L3RkPiI7IC8vIGRpc3BsYXkgc2VsZWN0YWJsZSBkYXRlCgkJCQkJCXByaW50RGF0ZS5zZXREYXRlKHByaW50RGF0ZS5nZXREYXRlKCkgKyAxKTsKCQkJCQkJcHJpbnREYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QocHJpbnREYXRlKTsKCQkJCQl9CgkJCQkJY2FsZW5kZXIgKz0gdGJvZHkgKyAiPC90cj4iOwoJCQkJfQoJCQkJZHJhd01vbnRoKys7CgkJCQlpZiAoZHJhd01vbnRoID4gMTEpIHsKCQkJCQlkcmF3TW9udGggPSAwOwoJCQkJCWRyYXdZZWFyKys7CgkJCQl9CgkJCQljYWxlbmRlciArPSAiPC90Ym9keT48L3RhYmxlPiIgKyAoaXNNdWx0aU1vbnRoID8gIjwvZGl2PiIgKwoJCQkJCQkJKChudW1Nb250aHNbMF0gPiAwICYmIGNvbCA9PT0gbnVtTW9udGhzWzFdLTEpID8gIjxkaXYgY2xhc3M9J3VpLWRhdGVwaWNrZXItcm93LWJyZWFrJz48L2Rpdj4iIDogIiIpIDogIiIpOwoJCQkJZ3JvdXAgKz0gY2FsZW5kZXI7CgkJCX0KCQkJaHRtbCArPSBncm91cDsKCQl9CgkJaHRtbCArPSBidXR0b25QYW5lbDsKCQlpbnN0Ll9rZXlFdmVudCA9IGZhbHNlOwoJCXJldHVybiBodG1sOwoJfSwKCgkvKiBHZW5lcmF0ZSB0aGUgbW9udGggYW5kIHllYXIgaGVhZGVyLiAqLwoJX2dlbmVyYXRlTW9udGhZZWFySGVhZGVyOiBmdW5jdGlvbihpbnN0LCBkcmF3TW9udGgsIGRyYXdZZWFyLCBtaW5EYXRlLCBtYXhEYXRlLAoJCQlzZWNvbmRhcnksIG1vbnRoTmFtZXMsIG1vbnRoTmFtZXNTaG9ydCkgewoKCQl2YXIgaW5NaW5ZZWFyLCBpbk1heFllYXIsIG1vbnRoLCB5ZWFycywgdGhpc1llYXIsIGRldGVybWluZVllYXIsIHllYXIsIGVuZFllYXIsCgkJCWNoYW5nZU1vbnRoID0gdGhpcy5fZ2V0KGluc3QsICJjaGFuZ2VNb250aCIpLAoJCQljaGFuZ2VZZWFyID0gdGhpcy5fZ2V0KGluc3QsICJjaGFuZ2VZZWFyIiksCgkJCXNob3dNb250aEFmdGVyWWVhciA9IHRoaXMuX2dldChpbnN0LCAic2hvd01vbnRoQWZ0ZXJZZWFyIiksCgkJCWh0bWwgPSAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci10aXRsZSc+IiwKCQkJbW9udGhIdG1sID0gIiI7CgoJCS8vIG1vbnRoIHNlbGVjdGlvbgoJCWlmIChzZWNvbmRhcnkgfHwgIWNoYW5nZU1vbnRoKSB7CgkJCW1vbnRoSHRtbCArPSAiPHNwYW4gY2xhc3M9J3VpLWRhdGVwaWNrZXItbW9udGgnPiIgKyBtb250aE5hbWVzW2RyYXdNb250aF0gKyAiPC9zcGFuPiI7CgkJfSBlbHNlIHsKCQkJaW5NaW5ZZWFyID0gKG1pbkRhdGUgJiYgbWluRGF0ZS5nZXRGdWxsWWVhcigpID09PSBkcmF3WWVhcik7CgkJCWluTWF4WWVhciA9IChtYXhEYXRlICYmIG1heERhdGUuZ2V0RnVsbFllYXIoKSA9PT0gZHJhd1llYXIpOwoJCQltb250aEh0bWwgKz0gIjxzZWxlY3QgY2xhc3M9J3VpLWRhdGVwaWNrZXItbW9udGgnIGRhdGEtaGFuZGxlcj0nc2VsZWN0TW9udGgnIGRhdGEtZXZlbnQ9J2NoYW5nZSc+IjsKCQkJZm9yICggbW9udGggPSAwOyBtb250aCA8IDEyOyBtb250aCsrKSB7CgkJCQlpZiAoKCFpbk1pblllYXIgfHwgbW9udGggPj0gbWluRGF0ZS5nZXRNb250aCgpKSAmJiAoIWluTWF4WWVhciB8fCBtb250aCA8PSBtYXhEYXRlLmdldE1vbnRoKCkpKSB7CgkJCQkJbW9udGhIdG1sICs9ICI8b3B0aW9uIHZhbHVlPSciICsgbW9udGggKyAiJyIgKwoJCQkJCQkobW9udGggPT09IGRyYXdNb250aCA\/ICIgc2VsZWN0ZWQ9J3NlbGVjdGVkJyIgOiAiIikgKwoJCQkJCQkiPiIgKyBtb250aE5hbWVzU2hvcnRbbW9udGhdICsgIjwvb3B0aW9uPiI7CgkJCQl9CgkJCX0KCQkJbW9udGhIdG1sICs9ICI8L3NlbGVjdD4iOwoJCX0KCgkJaWYgKCFzaG93TW9udGhBZnRlclllYXIpIHsKCQkJaHRtbCArPSBtb250aEh0bWwgKyAoc2Vjb25kYXJ5IHx8ICEoY2hhbmdlTW9udGggJiYgY2hhbmdlWWVhcikgPyAiJiN4YTA7IiA6ICIiKTsKCQl9CgoJCS8vIHllYXIgc2VsZWN0aW9uCgkJaWYgKCAhaW5zdC55ZWFyc2h0bWwgKSB7CgkJCWluc3QueWVhcnNodG1sID0gIiI7CgkJCWlmIChzZWNvbmRhcnkgfHwgIWNoYW5nZVllYXIpIHsKCQkJCWh0bWwgKz0gIjxzcGFuIGNsYXNzPSd1aS1kYXRlcGlja2VyLXllYXInPiIgKyBkcmF3WWVhciArICI8L3NwYW4+IjsKCQkJfSBlbHNlIHsKCQkJCS8vIGRldGVybWluZSByYW5nZSBvZiB5ZWFycyB0byBkaXNwbGF5CgkJCQl5ZWFycyA9IHRoaXMuX2dldChpbnN0LCAieWVhclJhbmdlIikuc3BsaXQoIjoiKTsKCQkJCXRoaXNZZWFyID0gbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpOwoJCQkJZGV0ZXJtaW5lWWVhciA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQkJdmFyIHllYXIgPSAodmFsdWUubWF0Y2goL2NbK1wtXS4qLykgPyBkcmF3WWVhciArIHBhcnNlSW50KHZhbHVlLnN1YnN0cmluZygxKSwgMTApIDoKCQkJCQkJKHZhbHVlLm1hdGNoKC9bK1wtXS4qLykgPyB0aGlzWWVhciArIHBhcnNlSW50KHZhbHVlLCAxMCkgOgoJCQkJCQlwYXJzZUludCh2YWx1ZSwgMTApKSk7CgkJCQkJcmV0dXJuIChpc05hTih5ZWFyKSA\/IHRoaXNZZWFyIDogeWVhcik7CgkJCQl9OwoJCQkJeWVhciA9IGRldGVybWluZVllYXIoeWVhcnNbMF0pOwoJCQkJZW5kWWVhciA9IE1hdGgubWF4KHllYXIsIGRldGVybWluZVllYXIoeWVhcnNbMV0gfHwgIiIpKTsKCQkJCXllYXIgPSAobWluRGF0ZSA\/IE1hdGgubWF4KHllYXIsIG1pbkRhdGUuZ2V0RnVsbFllYXIoKSkgOiB5ZWFyKTsKCQkJCWVuZFllYXIgPSAobWF4RGF0ZSA\/IE1hdGgubWluKGVuZFllYXIsIG1heERhdGUuZ2V0RnVsbFllYXIoKSkgOiBlbmRZZWFyKTsKCQkJCWluc3QueWVhcnNodG1sICs9ICI8c2VsZWN0IGNsYXNzPSd1aS1kYXRlcGlja2VyLXllYXInIGRhdGEtaGFuZGxlcj0nc2VsZWN0WWVhcicgZGF0YS1ldmVudD0nY2hhbmdlJz4iOwoJCQkJZm9yICg7IHllYXIgPD0gZW5kWWVhcjsgeWVhcisrKSB7CgkJCQkJaW5zdC55ZWFyc2h0bWwgKz0gIjxvcHRpb24gdmFsdWU9JyIgKyB5ZWFyICsgIiciICsKCQkJCQkJKHllYXIgPT09IGRyYXdZZWFyID8gIiBzZWxlY3RlZD0nc2VsZWN0ZWQnIiA6ICIiKSArCgkJCQkJCSI+IiArIHllYXIgKyAiPC9vcHRpb24+IjsKCQkJCX0KCQkJCWluc3QueWVhcnNodG1sICs9ICI8L3NlbGVjdD4iOwoKCQkJCWh0bWwgKz0gaW5zdC55ZWFyc2h0bWw7CgkJCQlpbnN0LnllYXJzaHRtbCA9IG51bGw7CgkJCX0KCQl9CgoJCWh0bWwgKz0gdGhpcy5fZ2V0KGluc3QsICJ5ZWFyU3VmZml4Iik7CgkJaWYgKHNob3dNb250aEFmdGVyWWVhcikgewoJCQlodG1sICs9IChzZWNvbmRhcnkgfHwgIShjaGFuZ2VNb250aCAmJiBjaGFuZ2VZZWFyKSA\/ICImI3hhMDsiIDogIiIpICsgbW9udGhIdG1sOwoJCX0KCQlodG1sICs9ICI8L2Rpdj4iOyAvLyBDbG9zZSBkYXRlcGlja2VyX2hlYWRlcgoJCXJldHVybiBodG1sOwoJfSwKCgkvKiBBZGp1c3Qgb25lIG9mIHRoZSBkYXRlIHN1Yi1maWVsZHMuICovCglfYWRqdXN0SW5zdERhdGU6IGZ1bmN0aW9uKGluc3QsIG9mZnNldCwgcGVyaW9kKSB7CgkJdmFyIHllYXIgPSBpbnN0LmRyYXdZZWFyICsgKHBlcmlvZCA9PT0gIlkiID8gb2Zmc2V0IDogMCksCgkJCW1vbnRoID0gaW5zdC5kcmF3TW9udGggKyAocGVyaW9kID09PSAiTSIgPyBvZmZzZXQgOiAwKSwKCQkJZGF5ID0gTWF0aC5taW4oaW5zdC5zZWxlY3RlZERheSwgdGhpcy5fZ2V0RGF5c0luTW9udGgoeWVhciwgbW9udGgpKSArIChwZXJpb2QgPT09ICJEIiA\/IG9mZnNldCA6IDApLAoJCQlkYXRlID0gdGhpcy5fcmVzdHJpY3RNaW5NYXgoaW5zdCwgdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QobmV3IERhdGUoeWVhciwgbW9udGgsIGRheSkpKTsKCgkJaW5zdC5zZWxlY3RlZERheSA9IGRhdGUuZ2V0RGF0ZSgpOwoJCWluc3QuZHJhd01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoID0gZGF0ZS5nZXRNb250aCgpOwoJCWluc3QuZHJhd1llYXIgPSBpbnN0LnNlbGVjdGVkWWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTsKCQlpZiAocGVyaW9kID09PSAiTSIgfHwgcGVyaW9kID09PSAiWSIpIHsKCQkJdGhpcy5fbm90aWZ5Q2hhbmdlKGluc3QpOwoJCX0KCX0sCgoJLyogRW5zdXJlIGEgZGF0ZSBpcyB3aXRoaW4gYW55IG1pbi9tYXggYm91bmRzLiAqLwoJX3Jlc3RyaWN0TWluTWF4OiBmdW5jdGlvbihpbnN0LCBkYXRlKSB7CgkJdmFyIG1pbkRhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKGluc3QsICJtaW4iKSwKCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoaW5zdCwgIm1heCIpLAoJCQluZXdEYXRlID0gKG1pbkRhdGUgJiYgZGF0ZSA8IG1pbkRhdGUgPyBtaW5EYXRlIDogZGF0ZSk7CgkJcmV0dXJuIChtYXhEYXRlICYmIG5ld0RhdGUgPiBtYXhEYXRlID8gbWF4RGF0ZSA6IG5ld0RhdGUpOwoJfSwKCgkvKiBOb3RpZnkgY2hhbmdlIG9mIG1vbnRoL3llYXIuICovCglfbm90aWZ5Q2hhbmdlOiBmdW5jdGlvbihpbnN0KSB7CgkJdmFyIG9uQ2hhbmdlID0gdGhpcy5fZ2V0KGluc3QsICJvbkNoYW5nZU1vbnRoWWVhciIpOwoJCWlmIChvbkNoYW5nZSkgewoJCQlvbkNoYW5nZS5hcHBseSgoaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXRbMF0gOiBudWxsKSwKCQkJCVtpbnN0LnNlbGVjdGVkWWVhciwgaW5zdC5zZWxlY3RlZE1vbnRoICsgMSwgaW5zdF0pOwoJCX0KCX0sCgoJLyogRGV0ZXJtaW5lIHRoZSBudW1iZXIgb2YgbW9udGhzIHRvIHNob3cuICovCglfZ2V0TnVtYmVyT2ZNb250aHM6IGZ1bmN0aW9uKGluc3QpIHsKCQl2YXIgbnVtTW9udGhzID0gdGhpcy5fZ2V0KGluc3QsICJudW1iZXJPZk1vbnRocyIpOwoJCXJldHVybiAobnVtTW9udGhzID09IG51bGwgPyBbMSwgMV0gOiAodHlwZW9mIG51bU1vbnRocyA9PT0gIm51bWJlciIgPyBbMSwgbnVtTW9udGhzXSA6IG51bU1vbnRocykpOwoJfSwKCgkvKiBEZXRlcm1pbmUgdGhlIGN1cnJlbnQgbWF4aW11bSBkYXRlIC0gZW5zdXJlIG5vIHRpbWUgY29tcG9uZW50cyBhcmUgc2V0LiAqLwoJX2dldE1pbk1heERhdGU6IGZ1bmN0aW9uKGluc3QsIG1pbk1heCkgewoJCXJldHVybiB0aGlzLl9kZXRlcm1pbmVEYXRlKGluc3QsIHRoaXMuX2dldChpbnN0LCBtaW5NYXggKyAiRGF0ZSIpLCBudWxsKTsKCX0sCgoJLyogRmluZCB0aGUgbnVtYmVyIG9mIGRheXMgaW4gYSBnaXZlbiBtb250aC4gKi8KCV9nZXREYXlzSW5Nb250aDogZnVuY3Rpb24oeWVhciwgbW9udGgpIHsKCQlyZXR1cm4gMzIgLSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdChuZXcgRGF0ZSh5ZWFyLCBtb250aCwgMzIpKS5nZXREYXRlKCk7Cgl9LAoKCS8qIEZpbmQgdGhlIGRheSBvZiB0aGUgd2VlayBvZiB0aGUgZmlyc3Qgb2YgYSBtb250aC4gKi8KCV9nZXRGaXJzdERheU9mTW9udGg6IGZ1bmN0aW9uKHllYXIsIG1vbnRoKSB7CgkJcmV0dXJuIG5ldyBEYXRlKHllYXIsIG1vbnRoLCAxKS5nZXREYXkoKTsKCX0sCgoJLyogRGV0ZXJtaW5lcyBpZiB3ZSBzaG91bGQgYWxsb3cgYSAibmV4dC9wcmV2IiBtb250aCBkaXNwbGF5IGNoYW5nZS4gKi8KCV9jYW5BZGp1c3RNb250aDogZnVuY3Rpb24oaW5zdCwgb2Zmc2V0LCBjdXJZZWFyLCBjdXJNb250aCkgewoJCXZhciBudW1Nb250aHMgPSB0aGlzLl9nZXROdW1iZXJPZk1vbnRocyhpbnN0KSwKCQkJZGF0ZSA9IHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KG5ldyBEYXRlKGN1clllYXIsCgkJCWN1ck1vbnRoICsgKG9mZnNldCA8IDAgPyBvZmZzZXQgOiBudW1Nb250aHNbMF0gKiBudW1Nb250aHNbMV0pLCAxKSk7CgoJCWlmIChvZmZzZXQgPCAwKSB7CgkJCWRhdGUuc2V0RGF0ZSh0aGlzLl9nZXREYXlzSW5Nb250aChkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSkpOwoJCX0KCQlyZXR1cm4gdGhpcy5faXNJblJhbmdlKGluc3QsIGRhdGUpOwoJfSwKCgkvKiBJcyB0aGUgZ2l2ZW4gZGF0ZSBpbiB0aGUgYWNjZXB0ZWQgcmFuZ2U\/ICovCglfaXNJblJhbmdlOiBmdW5jdGlvbihpbnN0LCBkYXRlKSB7CgkJdmFyIHllYXJTcGxpdCwgY3VycmVudFllYXIsCgkJCW1pbkRhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKGluc3QsICJtaW4iKSwKCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoaW5zdCwgIm1heCIpLAoJCQltaW5ZZWFyID0gbnVsbCwKCQkJbWF4WWVhciA9IG51bGwsCgkJCXllYXJzID0gdGhpcy5fZ2V0KGluc3QsICJ5ZWFyUmFuZ2UiKTsKCQkJaWYgKHllYXJzKXsKCQkJCXllYXJTcGxpdCA9IHllYXJzLnNwbGl0KCI6Iik7CgkJCQljdXJyZW50WWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTsKCQkJCW1pblllYXIgPSBwYXJzZUludCh5ZWFyU3BsaXRbMF0sIDEwKTsKCQkJCW1heFllYXIgPSBwYXJzZUludCh5ZWFyU3BsaXRbMV0sIDEwKTsKCQkJCWlmICggeWVhclNwbGl0WzBdLm1hdGNoKC9bK1wtXS4qLykgKSB7CgkJCQkJbWluWWVhciArPSBjdXJyZW50WWVhcjsKCQkJCX0KCQkJCWlmICggeWVhclNwbGl0WzFdLm1hdGNoKC9bK1wtXS4qLykgKSB7CgkJCQkJbWF4WWVhciArPSBjdXJyZW50WWVhcjsKCQkJCX0KCQkJfQoKCQlyZXR1cm4gKCghbWluRGF0ZSB8fCBkYXRlLmdldFRpbWUoKSA+PSBtaW5EYXRlLmdldFRpbWUoKSkgJiYKCQkJKCFtYXhEYXRlIHx8IGRhdGUuZ2V0VGltZSgpIDw9IG1heERhdGUuZ2V0VGltZSgpKSAmJgoJCQkoIW1pblllYXIgfHwgZGF0ZS5nZXRGdWxsWWVhcigpID49IG1pblllYXIpICYmCgkJCSghbWF4WWVhciB8fCBkYXRlLmdldEZ1bGxZZWFyKCkgPD0gbWF4WWVhcikpOwoJfSwKCgkvKiBQcm92aWRlIHRoZSBjb25maWd1cmF0aW9uIHNldHRpbmdzIGZvciBmb3JtYXR0aW5nL3BhcnNpbmcuICovCglfZ2V0Rm9ybWF0Q29uZmlnOiBmdW5jdGlvbihpbnN0KSB7CgkJdmFyIHNob3J0WWVhckN1dG9mZiA9IHRoaXMuX2dldChpbnN0LCAic2hvcnRZZWFyQ3V0b2ZmIik7CgkJc2hvcnRZZWFyQ3V0b2ZmID0gKHR5cGVvZiBzaG9ydFllYXJDdXRvZmYgIT09ICJzdHJpbmciID8gc2hvcnRZZWFyQ3V0b2ZmIDoKCQkJbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpICUgMTAwICsgcGFyc2VJbnQoc2hvcnRZZWFyQ3V0b2ZmLCAxMCkpOwoJCXJldHVybiB7c2hvcnRZZWFyQ3V0b2ZmOiBzaG9ydFllYXJDdXRvZmYsCgkJCWRheU5hbWVzU2hvcnQ6IHRoaXMuX2dldChpbnN0LCAiZGF5TmFtZXNTaG9ydCIpLCBkYXlOYW1lczogdGhpcy5fZ2V0KGluc3QsICJkYXlOYW1lcyIpLAoJCQltb250aE5hbWVzU2hvcnQ6IHRoaXMuX2dldChpbnN0LCAibW9udGhOYW1lc1Nob3J0IiksIG1vbnRoTmFtZXM6IHRoaXMuX2dldChpbnN0LCAibW9udGhOYW1lcyIpfTsKCX0sCgoJLyogRm9ybWF0IHRoZSBnaXZlbiBkYXRlIGZvciBkaXNwbGF5LiAqLwoJX2Zvcm1hdERhdGU6IGZ1bmN0aW9uKGluc3QsIGRheSwgbW9udGgsIHllYXIpIHsKCQlpZiAoIWRheSkgewoJCQlpbnN0LmN1cnJlbnREYXkgPSBpbnN0LnNlbGVjdGVkRGF5OwoJCQlpbnN0LmN1cnJlbnRNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aDsKCQkJaW5zdC5jdXJyZW50WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyOwoJCX0KCQl2YXIgZGF0ZSA9IChkYXkgPyAodHlwZW9mIGRheSA9PT0gIm9iamVjdCIgPyBkYXkgOgoJCQl0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdChuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF5KSkpIDoKCQkJdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QobmV3IERhdGUoaW5zdC5jdXJyZW50WWVhciwgaW5zdC5jdXJyZW50TW9udGgsIGluc3QuY3VycmVudERheSkpKTsKCQlyZXR1cm4gdGhpcy5mb3JtYXREYXRlKHRoaXMuX2dldChpbnN0LCAiZGF0ZUZvcm1hdCIpLCBkYXRlLCB0aGlzLl9nZXRGb3JtYXRDb25maWcoaW5zdCkpOwoJfQp9KTsKCi8qCiAqIEJpbmQgaG92ZXIgZXZlbnRzIGZvciBkYXRlcGlja2VyIGVsZW1lbnRzLgogKiBEb25lIHZpYSBkZWxlZ2F0ZSBzbyB0aGUgYmluZGluZyBvbmx5IG9jY3VycyBvbmNlIGluIHRoZSBsaWZldGltZSBvZiB0aGUgcGFyZW50IGRpdi4KICogR2xvYmFsIGluc3RBY3RpdmUsIHNldCBieSBfdXBkYXRlRGF0ZXBpY2tlciBhbGxvd3MgdGhlIGhhbmRsZXJzIHRvIGZpbmQgdGhlaXIgd2F5IGJhY2sgdG8gdGhlIGFjdGl2ZSBwaWNrZXIuCiAqLwpmdW5jdGlvbiBiaW5kSG92ZXIoZHBEaXYpIHsKCXZhciBzZWxlY3RvciA9ICJidXR0b24sIC51aS1kYXRlcGlja2VyLXByZXYsIC51aS1kYXRlcGlja2VyLW5leHQsIC51aS1kYXRlcGlja2VyLWNhbGVuZGFyIHRkIGEiOwoJcmV0dXJuIGRwRGl2LmRlbGVnYXRlKHNlbGVjdG9yLCAibW91c2VvdXQiLCBmdW5jdGlvbigpIHsKCQkJJCh0aGlzKS5yZW1vdmVDbGFzcygidWktc3RhdGUtaG92ZXIiKTsKCQkJaWYgKHRoaXMuY2xhc3NOYW1lLmluZGV4T2YoInVpLWRhdGVwaWNrZXItcHJldiIpICE9PSAtMSkgewoJCQkJJCh0aGlzKS5yZW1vdmVDbGFzcygidWktZGF0ZXBpY2tlci1wcmV2LWhvdmVyIik7CgkJCX0KCQkJaWYgKHRoaXMuY2xhc3NOYW1lLmluZGV4T2YoInVpLWRhdGVwaWNrZXItbmV4dCIpICE9PSAtMSkgewoJCQkJJCh0aGlzKS5yZW1vdmVDbGFzcygidWktZGF0ZXBpY2tlci1uZXh0LWhvdmVyIik7CgkJCX0KCQl9KQoJCS5kZWxlZ2F0ZShzZWxlY3RvciwgIm1vdXNlb3ZlciIsIGZ1bmN0aW9uKCl7CgkJCWlmICghJC5kYXRlcGlja2VyLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggaW5zdEFjdGl2ZS5pbmxpbmUgPyBkcERpdi5wYXJlbnQoKVswXSA6IGluc3RBY3RpdmUuaW5wdXRbMF0pKSB7CgkJCQkkKHRoaXMpLnBhcmVudHMoIi51aS1kYXRlcGlja2VyLWNhbGVuZGFyIikuZmluZCgiYSIpLnJlbW92ZUNsYXNzKCJ1aS1zdGF0ZS1ob3ZlciIpOwoJCQkJJCh0aGlzKS5hZGRDbGFzcygidWktc3RhdGUtaG92ZXIiKTsKCQkJCWlmICh0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCJ1aS1kYXRlcGlja2VyLXByZXYiKSAhPT0gLTEpIHsKCQkJCQkkKHRoaXMpLmFkZENsYXNzKCJ1aS1kYXRlcGlja2VyLXByZXYtaG92ZXIiKTsKCQkJCX0KCQkJCWlmICh0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCJ1aS1kYXRlcGlja2VyLW5leHQiKSAhPT0gLTEpIHsKCQkJCQkkKHRoaXMpLmFkZENsYXNzKCJ1aS1kYXRlcGlja2VyLW5leHQtaG92ZXIiKTsKCQkJCX0KCQkJfQoJCX0pOwp9CgovKiBqUXVlcnkgZXh0ZW5kIG5vdyBpZ25vcmVzIG51bGxzISAqLwpmdW5jdGlvbiBleHRlbmRSZW1vdmUodGFyZ2V0LCBwcm9wcykgewoJJC5leHRlbmQodGFyZ2V0LCBwcm9wcyk7Cglmb3IgKHZhciBuYW1lIGluIHByb3BzKSB7CgkJaWYgKHByb3BzW25hbWVdID09IG51bGwpIHsKCQkJdGFyZ2V0W25hbWVdID0gcHJvcHNbbmFtZV07CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfQoKLyogSW52b2tlIHRoZSBkYXRlcGlja2VyIGZ1bmN0aW9uYWxpdHkuCiAgIEBwYXJhbSAgb3B0aW9ucyAgc3RyaW5nIC0gYSBjb21tYW5kLCBvcHRpb25hbGx5IGZvbGxvd2VkIGJ5IGFkZGl0aW9uYWwgcGFyYW1ldGVycyBvcgoJCQkJCU9iamVjdCAtIHNldHRpbmdzIGZvciBhdHRhY2hpbmcgbmV3IGRhdGVwaWNrZXIgZnVuY3Rpb25hbGl0eQogICBAcmV0dXJuICBqUXVlcnkgb2JqZWN0ICovCiQuZm4uZGF0ZXBpY2tlciA9IGZ1bmN0aW9uKG9wdGlvbnMpewoKCS8qIFZlcmlmeSBhbiBlbXB0eSBjb2xsZWN0aW9uIHdhc24ndCBwYXNzZWQgLSBGaXhlcyAjNjk3NiAqLwoJaWYgKCAhdGhpcy5sZW5ndGggKSB7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyogSW5pdGlhbGlzZSB0aGUgZGF0ZSBwaWNrZXIuICovCglpZiAoISQuZGF0ZXBpY2tlci5pbml0aWFsaXplZCkgewoJCSQoZG9jdW1lbnQpLm1vdXNlZG93bigkLmRhdGVwaWNrZXIuX2NoZWNrRXh0ZXJuYWxDbGljayk7CgkJJC5kYXRlcGlja2VyLmluaXRpYWxpemVkID0gdHJ1ZTsKCX0KCgkvKiBBcHBlbmQgZGF0ZXBpY2tlciBtYWluIGNvbnRhaW5lciB0byBib2R5IGlmIG5vdCBleGlzdC4gKi8KCWlmICgkKCIjIiskLmRhdGVwaWNrZXIuX21haW5EaXZJZCkubGVuZ3RoID09PSAwKSB7CgkJJCgiYm9keSIpLmFwcGVuZCgkLmRhdGVwaWNrZXIuZHBEaXYpOwoJfQoKCXZhciBvdGhlckFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJaWYgKHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiAmJiAob3B0aW9ucyA9PT0gImlzRGlzYWJsZWQiIHx8IG9wdGlvbnMgPT09ICJnZXREYXRlIiB8fCBvcHRpb25zID09PSAid2lkZ2V0IikpIHsKCQlyZXR1cm4gJC5kYXRlcGlja2VyWyJfIiArIG9wdGlvbnMgKyAiRGF0ZXBpY2tlciJdLgoJCQlhcHBseSgkLmRhdGVwaWNrZXIsIFt0aGlzWzBdXS5jb25jYXQob3RoZXJBcmdzKSk7Cgl9CglpZiAob3B0aW9ucyA9PT0gIm9wdGlvbiIgJiYgYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAic3RyaW5nIikgewoJCXJldHVybiAkLmRhdGVwaWNrZXJbIl8iICsgb3B0aW9ucyArICJEYXRlcGlja2VyIl0uCgkJCWFwcGx5KCQuZGF0ZXBpY2tlciwgW3RoaXNbMF1dLmNvbmNhdChvdGhlckFyZ3MpKTsKCX0KCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciID8KCQkJJC5kYXRlcGlja2VyWyJfIiArIG9wdGlvbnMgKyAiRGF0ZXBpY2tlciJdLgoJCQkJYXBwbHkoJC5kYXRlcGlja2VyLCBbdGhpc10uY29uY2F0KG90aGVyQXJncykpIDoKCQkJJC5kYXRlcGlja2VyLl9hdHRhY2hEYXRlcGlja2VyKHRoaXMsIG9wdGlvbnMpOwoJfSk7Cn07CgokLmRhdGVwaWNrZXIgPSBuZXcgRGF0ZXBpY2tlcigpOyAvLyBzaW5nbGV0b24gaW5zdGFuY2UKJC5kYXRlcGlja2VyLmluaXRpYWxpemVkID0gZmFsc2U7CiQuZGF0ZXBpY2tlci51dWlkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiQuZGF0ZXBpY2tlci52ZXJzaW9uID0gIjEuMTAuMyI7Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBzaXplUmVsYXRlZE9wdGlvbnMgPSB7CgkJYnV0dG9uczogdHJ1ZSwKCQloZWlnaHQ6IHRydWUsCgkJbWF4SGVpZ2h0OiB0cnVlLAoJCW1heFdpZHRoOiB0cnVlLAoJCW1pbkhlaWdodDogdHJ1ZSwKCQltaW5XaWR0aDogdHJ1ZSwKCQl3aWR0aDogdHJ1ZQoJfSwKCXJlc2l6YWJsZVJlbGF0ZWRPcHRpb25zID0gewoJCW1heEhlaWdodDogdHJ1ZSwKCQltYXhXaWR0aDogdHJ1ZSwKCQltaW5IZWlnaHQ6IHRydWUsCgkJbWluV2lkdGg6IHRydWUKCX07CgokLndpZGdldCggInVpLmRpYWxvZyIsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJb3B0aW9uczogewoJCWFwcGVuZFRvOiAiYm9keSIsCgkJYXV0b09wZW46IHRydWUsCgkJYnV0dG9uczogW10sCgkJY2xvc2VPbkVzY2FwZTogdHJ1ZSwKCQljbG9zZVRleHQ6ICJjbG9zZSIsCgkJZGlhbG9nQ2xhc3M6ICIiLAoJCWRyYWdnYWJsZTogdHJ1ZSwKCQloaWRlOiBudWxsLAoJCWhlaWdodDogImF1dG8iLAoJCW1heEhlaWdodDogbnVsbCwKCQltYXhXaWR0aDogbnVsbCwKCQltaW5IZWlnaHQ6IDE1MCwKCQltaW5XaWR0aDogMTUwLAoJCW1vZGFsOiBmYWxzZSwKCQlwb3NpdGlvbjogewoJCQlteTogImNlbnRlciIsCgkJCWF0OiAiY2VudGVyIiwKCQkJb2Y6IHdpbmRvdywKCQkJY29sbGlzaW9uOiAiZml0IiwKCQkJLy8gRW5zdXJlIHRoZSB0aXRsZWJhciBpcyBhbHdheXMgdmlzaWJsZQoJCQl1c2luZzogZnVuY3Rpb24oIHBvcyApIHsKCQkJCXZhciB0b3BPZmZzZXQgPSAkKCB0aGlzICkuY3NzKCBwb3MgKS5vZmZzZXQoKS50b3A7CgkJCQlpZiAoIHRvcE9mZnNldCA8IDAgKSB7CgkJCQkJJCggdGhpcyApLmNzcyggInRvcCIsIHBvcy50b3AgLSB0b3BPZmZzZXQgKTsKCQkJCX0KCQkJfQoJCX0sCgkJcmVzaXphYmxlOiB0cnVlLAoJCXNob3c6IG51bGwsCgkJdGl0bGU6IG51bGwsCgkJd2lkdGg6IDMwMCwKCgkJLy8gY2FsbGJhY2tzCgkJYmVmb3JlQ2xvc2U6IG51bGwsCgkJY2xvc2U6IG51bGwsCgkJZHJhZzogbnVsbCwKCQlkcmFnU3RhcnQ6IG51bGwsCgkJZHJhZ1N0b3A6IG51bGwsCgkJZm9jdXM6IG51bGwsCgkJb3BlbjogbnVsbCwKCQlyZXNpemU6IG51bGwsCgkJcmVzaXplU3RhcnQ6IG51bGwsCgkJcmVzaXplU3RvcDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLm9yaWdpbmFsQ3NzID0gewoJCQlkaXNwbGF5OiB0aGlzLmVsZW1lbnRbMF0uc3R5bGUuZGlzcGxheSwKCQkJd2lkdGg6IHRoaXMuZWxlbWVudFswXS5zdHlsZS53aWR0aCwKCQkJbWluSGVpZ2h0OiB0aGlzLmVsZW1lbnRbMF0uc3R5bGUubWluSGVpZ2h0LAoJCQltYXhIZWlnaHQ6IHRoaXMuZWxlbWVudFswXS5zdHlsZS5tYXhIZWlnaHQsCgkJCWhlaWdodDogdGhpcy5lbGVtZW50WzBdLnN0eWxlLmhlaWdodAoJCX07CgkJdGhpcy5vcmlnaW5hbFBvc2l0aW9uID0gewoJCQlwYXJlbnQ6IHRoaXMuZWxlbWVudC5wYXJlbnQoKSwKCQkJaW5kZXg6IHRoaXMuZWxlbWVudC5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4KCB0aGlzLmVsZW1lbnQgKQoJCX07CgkJdGhpcy5vcmlnaW5hbFRpdGxlID0gdGhpcy5lbGVtZW50LmF0dHIoInRpdGxlIik7CgkJdGhpcy5vcHRpb25zLnRpdGxlID0gdGhpcy5vcHRpb25zLnRpdGxlIHx8IHRoaXMub3JpZ2luYWxUaXRsZTsKCgkJdGhpcy5fY3JlYXRlV3JhcHBlcigpOwoKCQl0aGlzLmVsZW1lbnQKCQkJLnNob3coKQoJCQkucmVtb3ZlQXR0cigidGl0bGUiKQoJCQkuYWRkQ2xhc3MoInVpLWRpYWxvZy1jb250ZW50IHVpLXdpZGdldC1jb250ZW50IikKCQkJLmFwcGVuZFRvKCB0aGlzLnVpRGlhbG9nICk7CgoJCXRoaXMuX2NyZWF0ZVRpdGxlYmFyKCk7CgkJdGhpcy5fY3JlYXRlQnV0dG9uUGFuZSgpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5kcmFnZ2FibGUgJiYgJC5mbi5kcmFnZ2FibGUgKSB7CgkJCXRoaXMuX21ha2VEcmFnZ2FibGUoKTsKCQl9CgkJaWYgKCB0aGlzLm9wdGlvbnMucmVzaXphYmxlICYmICQuZm4ucmVzaXphYmxlICkgewoJCQl0aGlzLl9tYWtlUmVzaXphYmxlKCk7CgkJfQoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmF1dG9PcGVuICkgewoJCQl0aGlzLm9wZW4oKTsKCQl9Cgl9LAoKCV9hcHBlbmRUbzogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLm9wdGlvbnMuYXBwZW5kVG87CgkJaWYgKCBlbGVtZW50ICYmIChlbGVtZW50LmpxdWVyeSB8fCBlbGVtZW50Lm5vZGVUeXBlKSApIHsKCQkJcmV0dXJuICQoIGVsZW1lbnQgKTsKCQl9CgkJcmV0dXJuIHRoaXMuZG9jdW1lbnQuZmluZCggZWxlbWVudCB8fCAiYm9keSIgKS5lcSggMCApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIG5leHQsCgkJCW9yaWdpbmFsUG9zaXRpb24gPSB0aGlzLm9yaWdpbmFsUG9zaXRpb247CgoJCXRoaXMuX2Rlc3Ryb3lPdmVybGF5KCk7CgoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlVW5pcXVlSWQoKQoJCQkucmVtb3ZlQ2xhc3MoInVpLWRpYWxvZy1jb250ZW50IHVpLXdpZGdldC1jb250ZW50IikKCQkJLmNzcyggdGhpcy5vcmlnaW5hbENzcyApCgkJCS8vIFdpdGhvdXQgZGV0YWNoaW5nIGZpcnN0LCB0aGUgZm9sbG93aW5nIGJlY29tZXMgcmVhbGx5IHNsb3cKCQkJLmRldGFjaCgpOwoKCQl0aGlzLnVpRGlhbG9nLnN0b3AoIHRydWUsIHRydWUgKS5yZW1vdmUoKTsKCgkJaWYgKCB0aGlzLm9yaWdpbmFsVGl0bGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiLCB0aGlzLm9yaWdpbmFsVGl0bGUgKTsKCQl9CgoJCW5leHQgPSBvcmlnaW5hbFBvc2l0aW9uLnBhcmVudC5jaGlsZHJlbigpLmVxKCBvcmlnaW5hbFBvc2l0aW9uLmluZGV4ICk7CgkJLy8gRG9uJ3QgdHJ5IHRvIHBsYWNlIHRoZSBkaWFsb2cgbmV4dCB0byBpdHNlbGYgKCM4NjEzKQoJCWlmICggbmV4dC5sZW5ndGggJiYgbmV4dFswXSAhPT0gdGhpcy5lbGVtZW50WzBdICkgewoJCQluZXh0LmJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJfSBlbHNlIHsKCQkJb3JpZ2luYWxQb3NpdGlvbi5wYXJlbnQuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCQl9Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudWlEaWFsb2c7Cgl9LAoKCWRpc2FibGU6ICQubm9vcCwKCWVuYWJsZTogJC5ub29wLAoKCWNsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gfHwgdGhpcy5fdHJpZ2dlciggImJlZm9yZUNsb3NlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoJCXRoaXMuX2Rlc3Ryb3lPdmVybGF5KCk7CgoJCWlmICggIXRoaXMub3BlbmVyLmZpbHRlcigiOmZvY3VzYWJsZSIpLmZvY3VzKCkubGVuZ3RoICkgewoJCQkvLyBIaWRpbmcgYSBmb2N1c2VkIGVsZW1lbnQgZG9lc24ndCB0cmlnZ2VyIGJsdXIgaW4gV2ViS2l0CgkJCS8vIHNvIGluIGNhc2Ugd2UgaGF2ZSBub3RoaW5nIHRvIGZvY3VzIG9uLCBleHBsaWNpdGx5IGJsdXIgdGhlIGFjdGl2ZSBlbGVtZW50CgkJCS8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD00NzE4MgoJCQkkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5ibHVyKCk7CgkJfQoKCQl0aGlzLl9oaWRlKCB0aGlzLnVpRGlhbG9nLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCXRoYXQuX3RyaWdnZXIoICJjbG9zZSIsIGV2ZW50ICk7CgkJfSk7Cgl9LAoKCWlzT3BlbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX2lzT3BlbjsKCX0sCgoJbW92ZVRvVG9wOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tb3ZlVG9Ub3AoKTsKCX0sCgoJX21vdmVUb1RvcDogZnVuY3Rpb24oIGV2ZW50LCBzaWxlbnQgKSB7CgkJdmFyIG1vdmVkID0gISF0aGlzLnVpRGlhbG9nLm5leHRBbGwoIjp2aXNpYmxlIikuaW5zZXJ0QmVmb3JlKCB0aGlzLnVpRGlhbG9nICkubGVuZ3RoOwoJCWlmICggbW92ZWQgJiYgIXNpbGVudCApIHsKCQkJdGhpcy5fdHJpZ2dlciggImZvY3VzIiwgZXZlbnQgKTsKCQl9CgkJcmV0dXJuIG1vdmVkOwoJfSwKCglvcGVuOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCWlmICggdGhpcy5fbW92ZVRvVG9wKCkgKSB7CgkJCQl0aGlzLl9mb2N1c1RhYmJhYmxlKCk7CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5faXNPcGVuID0gdHJ1ZTsKCQl0aGlzLm9wZW5lciA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uYWN0aXZlRWxlbWVudCApOwoKCQl0aGlzLl9zaXplKCk7CgkJdGhpcy5fcG9zaXRpb24oKTsKCQl0aGlzLl9jcmVhdGVPdmVybGF5KCk7CgkJdGhpcy5fbW92ZVRvVG9wKCBudWxsLCB0cnVlICk7CgkJdGhpcy5fc2hvdyggdGhpcy51aURpYWxvZywgdGhpcy5vcHRpb25zLnNob3csIGZ1bmN0aW9uKCkgewoJCQl0aGF0Ll9mb2N1c1RhYmJhYmxlKCk7CgkJCXRoYXQuX3RyaWdnZXIoImZvY3VzIik7CgkJfSk7CgoJCXRoaXMuX3RyaWdnZXIoIm9wZW4iKTsKCX0sCgoJX2ZvY3VzVGFiYmFibGU6IGZ1bmN0aW9uKCkgewoJCS8vIFNldCBmb2N1cyB0byB0aGUgZmlyc3QgbWF0Y2g6CgkJLy8gMS4gRmlyc3QgZWxlbWVudCBpbnNpZGUgdGhlIGRpYWxvZyBtYXRjaGluZyBbYXV0b2ZvY3VzXQoJCS8vIDIuIFRhYmJhYmxlIGVsZW1lbnQgaW5zaWRlIHRoZSBjb250ZW50IGVsZW1lbnQKCQkvLyAzLiBUYWJiYWJsZSBlbGVtZW50IGluc2lkZSB0aGUgYnV0dG9ucGFuZQoJCS8vIDQuIFRoZSBjbG9zZSBidXR0b24KCQkvLyA1LiBUaGUgZGlhbG9nIGl0c2VsZgoJCXZhciBoYXNGb2N1cyA9IHRoaXMuZWxlbWVudC5maW5kKCJbYXV0b2ZvY3VzXSIpOwoJCWlmICggIWhhc0ZvY3VzLmxlbmd0aCApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLmVsZW1lbnQuZmluZCgiOnRhYmJhYmxlIik7CgkJfQoJCWlmICggIWhhc0ZvY3VzLmxlbmd0aCApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZS5maW5kKCI6dGFiYmFibGUiKTsKCQl9CgkJaWYgKCAhaGFzRm9jdXMubGVuZ3RoICkgewoJCQloYXNGb2N1cyA9IHRoaXMudWlEaWFsb2dUaXRsZWJhckNsb3NlLmZpbHRlcigiOnRhYmJhYmxlIik7CgkJfQoJCWlmICggIWhhc0ZvY3VzLmxlbmd0aCApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLnVpRGlhbG9nOwoJCX0KCQloYXNGb2N1cy5lcSggMCApLmZvY3VzKCk7Cgl9LAoKCV9rZWVwRm9jdXM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlmdW5jdGlvbiBjaGVja0ZvY3VzKCkgewoJCQl2YXIgYWN0aXZlRWxlbWVudCA9IHRoaXMuZG9jdW1lbnRbMF0uYWN0aXZlRWxlbWVudCwKCQkJCWlzQWN0aXZlID0gdGhpcy51aURpYWxvZ1swXSA9PT0gYWN0aXZlRWxlbWVudCB8fAoJCQkJCSQuY29udGFpbnMoIHRoaXMudWlEaWFsb2dbMF0sIGFjdGl2ZUVsZW1lbnQgKTsKCQkJaWYgKCAhaXNBY3RpdmUgKSB7CgkJCQl0aGlzLl9mb2N1c1RhYmJhYmxlKCk7CgkJCX0KCQl9CgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljaGVja0ZvY3VzLmNhbGwoIHRoaXMgKTsKCQkvLyBzdXBwb3J0OiBJRQoJCS8vIElFIDw9IDggZG9lc24ndCBwcmV2ZW50IG1vdmluZyBmb2N1cyBldmVuIHdpdGggZXZlbnQucHJldmVudERlZmF1bHQoKQoJCS8vIHNvIHdlIGNoZWNrIGFnYWluIGxhdGVyCgkJdGhpcy5fZGVsYXkoIGNoZWNrRm9jdXMgKTsKCX0sCgoJX2NyZWF0ZVdyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMudWlEaWFsb2cgPSAkKCI8ZGl2PiIpCgkJCS5hZGRDbGFzcyggInVpLWRpYWxvZyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCB1aS1mcm9udCAiICsKCQkJCXRoaXMub3B0aW9ucy5kaWFsb2dDbGFzcyApCgkJCS5oaWRlKCkKCQkJLmF0dHIoewoJCQkJLy8gU2V0dGluZyB0YWJJbmRleCBtYWtlcyB0aGUgZGl2IGZvY3VzYWJsZQoJCQkJdGFiSW5kZXg6IC0xLAoJCQkJcm9sZTogImRpYWxvZyIKCQkJfSkKCQkJLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7CgoJCXRoaXMuX29uKCB0aGlzLnVpRGlhbG9nLCB7CgkJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmNsb3NlT25Fc2NhcGUgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICYmIGV2ZW50LmtleUNvZGUgJiYKCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIHByZXZlbnQgdGFiYmluZyBvdXQgb2YgZGlhbG9ncwoJCQkJaWYgKCBldmVudC5rZXlDb2RlICE9PSAkLnVpLmtleUNvZGUuVEFCICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXZhciB0YWJiYWJsZXMgPSB0aGlzLnVpRGlhbG9nLmZpbmQoIjp0YWJiYWJsZSIpLAoJCQkJCWZpcnN0ID0gdGFiYmFibGVzLmZpbHRlcigiOmZpcnN0IiksCgkJCQkJbGFzdCAgPSB0YWJiYWJsZXMuZmlsdGVyKCI6bGFzdCIpOwoKCQkJCWlmICggKCBldmVudC50YXJnZXQgPT09IGxhc3RbMF0gfHwgZXZlbnQudGFyZ2V0ID09PSB0aGlzLnVpRGlhbG9nWzBdICkgJiYgIWV2ZW50LnNoaWZ0S2V5ICkgewoJCQkJCWZpcnN0LmZvY3VzKCAxICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0gZWxzZSBpZiAoICggZXZlbnQudGFyZ2V0ID09PSBmaXJzdFswXSB8fCBldmVudC50YXJnZXQgPT09IHRoaXMudWlEaWFsb2dbMF0gKSAmJiBldmVudC5zaGlmdEtleSApIHsKCQkJCQlsYXN0LmZvY3VzKCAxICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfSwKCQkJbW91c2Vkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHRoaXMuX21vdmVUb1RvcCggZXZlbnQgKSApIHsKCQkJCQl0aGlzLl9mb2N1c1RhYmJhYmxlKCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy8gV2UgYXNzdW1lIHRoYXQgYW55IGV4aXN0aW5nIGFyaWEtZGVzY3JpYmVkYnkgYXR0cmlidXRlIG1lYW5zCgkJLy8gdGhhdCB0aGUgZGlhbG9nIGNvbnRlbnQgaXMgbWFya2VkIHVwIHByb3Blcmx5CgkJLy8gb3RoZXJ3aXNlIHdlIGJydXRlIGZvcmNlIHRoZSBjb250ZW50IGFzIHRoZSBkZXNjcmlwdGlvbgoJCWlmICggIXRoaXMuZWxlbWVudC5maW5kKCJbYXJpYS1kZXNjcmliZWRieV0iKS5sZW5ndGggKSB7CgkJCXRoaXMudWlEaWFsb2cuYXR0cih7CgkJCQkiYXJpYS1kZXNjcmliZWRieSI6IHRoaXMuZWxlbWVudC51bmlxdWVJZCgpLmF0dHIoImlkIikKCQkJfSk7CgkJfQoJfSwKCglfY3JlYXRlVGl0bGViYXI6IGZ1bmN0aW9uKCkgewoJCXZhciB1aURpYWxvZ1RpdGxlOwoKCQl0aGlzLnVpRGlhbG9nVGl0bGViYXIgPSAkKCI8ZGl2PiIpCgkJCS5hZGRDbGFzcygidWktZGlhbG9nLXRpdGxlYmFyIHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCB1aS1oZWxwZXItY2xlYXJmaXgiKQoJCQkucHJlcGVuZFRvKCB0aGlzLnVpRGlhbG9nICk7CgkJdGhpcy5fb24oIHRoaXMudWlEaWFsb2dUaXRsZWJhciwgewoJCQltb3VzZWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIERvbid0IHByZXZlbnQgY2xpY2sgb24gY2xvc2UgYnV0dG9uICgjODgzOCkKCQkJCS8vIEZvY3VzaW5nIGEgZGlhbG9nIHRoYXQgaXMgcGFydGlhbGx5IHNjcm9sbGVkIG91dCBvZiB2aWV3CgkJCQkvLyBjYXVzZXMgdGhlIGJyb3dzZXIgdG8gc2Nyb2xsIGl0IGludG8gdmlldywgcHJldmVudGluZyB0aGUgY2xpY2sgZXZlbnQKCQkJCWlmICggISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIi51aS1kaWFsb2ctdGl0bGViYXItY2xvc2UiKSApIHsKCQkJCQkvLyBEaWFsb2cgaXNuJ3QgZ2V0dGluZyBmb2N1cyB3aGVuIGRyYWdnaW5nICgjODA2MykKCQkJCQl0aGlzLnVpRGlhbG9nLmZvY3VzKCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJdGhpcy51aURpYWxvZ1RpdGxlYmFyQ2xvc2UgPSAkKCI8YnV0dG9uPjwvYnV0dG9uPiIpCgkJCS5idXR0b24oewoJCQkJbGFiZWw6IHRoaXMub3B0aW9ucy5jbG9zZVRleHQsCgkJCQlpY29uczogewoJCQkJCXByaW1hcnk6ICJ1aS1pY29uLWNsb3NldGhpY2siCgkJCQl9LAoJCQkJdGV4dDogZmFsc2UKCQkJfSkKCQkJLmFkZENsYXNzKCJ1aS1kaWFsb2ctdGl0bGViYXItY2xvc2UiKQoJCQkuYXBwZW5kVG8oIHRoaXMudWlEaWFsb2dUaXRsZWJhciApOwoJCXRoaXMuX29uKCB0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZSwgewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJCX0KCQl9KTsKCgkJdWlEaWFsb2dUaXRsZSA9ICQoIjxzcGFuPiIpCgkJCS51bmlxdWVJZCgpCgkJCS5hZGRDbGFzcygidWktZGlhbG9nLXRpdGxlIikKCQkJLnByZXBlbmRUbyggdGhpcy51aURpYWxvZ1RpdGxlYmFyICk7CgkJdGhpcy5fdGl0bGUoIHVpRGlhbG9nVGl0bGUgKTsKCgkJdGhpcy51aURpYWxvZy5hdHRyKHsKCQkJImFyaWEtbGFiZWxsZWRieSI6IHVpRGlhbG9nVGl0bGUuYXR0cigiaWQiKQoJCX0pOwoJfSwKCglfdGl0bGU6IGZ1bmN0aW9uKCB0aXRsZSApIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMudGl0bGUgKSB7CgkJCXRpdGxlLmh0bWwoIiYjMTYwOyIpOwoJCX0KCQl0aXRsZS50ZXh0KCB0aGlzLm9wdGlvbnMudGl0bGUgKTsKCX0sCgoJX2NyZWF0ZUJ1dHRvblBhbmU6IGZ1bmN0aW9uKCkgewoJCXRoaXMudWlEaWFsb2dCdXR0b25QYW5lID0gJCgiPGRpdj4iKQoJCQkuYWRkQ2xhc3MoInVpLWRpYWxvZy1idXR0b25wYW5lIHVpLXdpZGdldC1jb250ZW50IHVpLWhlbHBlci1jbGVhcmZpeCIpOwoKCQl0aGlzLnVpQnV0dG9uU2V0ID0gJCgiPGRpdj4iKQoJCQkuYWRkQ2xhc3MoInVpLWRpYWxvZy1idXR0b25zZXQiKQoJCQkuYXBwZW5kVG8oIHRoaXMudWlEaWFsb2dCdXR0b25QYW5lICk7CgoJCXRoaXMuX2NyZWF0ZUJ1dHRvbnMoKTsKCX0sCgoJX2NyZWF0ZUJ1dHRvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJYnV0dG9ucyA9IHRoaXMub3B0aW9ucy5idXR0b25zOwoKCQkvLyBpZiB3ZSBhbHJlYWR5IGhhdmUgYSBidXR0b24gcGFuZSwgcmVtb3ZlIGl0CgkJdGhpcy51aURpYWxvZ0J1dHRvblBhbmUucmVtb3ZlKCk7CgkJdGhpcy51aUJ1dHRvblNldC5lbXB0eSgpOwoKCQlpZiAoICQuaXNFbXB0eU9iamVjdCggYnV0dG9ucyApIHx8ICgkLmlzQXJyYXkoIGJ1dHRvbnMgKSAmJiAhYnV0dG9ucy5sZW5ndGgpICkgewoJCQl0aGlzLnVpRGlhbG9nLnJlbW92ZUNsYXNzKCJ1aS1kaWFsb2ctYnV0dG9ucyIpOwoJCQlyZXR1cm47CgkJfQoKCQkkLmVhY2goIGJ1dHRvbnMsIGZ1bmN0aW9uKCBuYW1lLCBwcm9wcyApIHsKCQkJdmFyIGNsaWNrLCBidXR0b25PcHRpb25zOwoJCQlwcm9wcyA9ICQuaXNGdW5jdGlvbiggcHJvcHMgKSA\/CgkJCQl7IGNsaWNrOiBwcm9wcywgdGV4dDogbmFtZSB9IDoKCQkJCXByb3BzOwoJCQkvLyBEZWZhdWx0IHRvIGEgbm9uLXN1Ym1pdHRpbmcgYnV0dG9uCgkJCXByb3BzID0gJC5leHRlbmQoIHsgdHlwZTogImJ1dHRvbiIgfSwgcHJvcHMgKTsKCQkJLy8gQ2hhbmdlIHRoZSBjb250ZXh0IGZvciB0aGUgY2xpY2sgY2FsbGJhY2sgdG8gYmUgdGhlIG1haW4gZWxlbWVudAoJCQljbGljayA9IHByb3BzLmNsaWNrOwoJCQlwcm9wcy5jbGljayA9IGZ1bmN0aW9uKCkgewoJCQkJY2xpY2suYXBwbHkoIHRoYXQuZWxlbWVudFswXSwgYXJndW1lbnRzICk7CgkJCX07CgkJCWJ1dHRvbk9wdGlvbnMgPSB7CgkJCQlpY29uczogcHJvcHMuaWNvbnMsCgkJCQl0ZXh0OiBwcm9wcy5zaG93VGV4dAoJCQl9OwoJCQlkZWxldGUgcHJvcHMuaWNvbnM7CgkJCWRlbGV0ZSBwcm9wcy5zaG93VGV4dDsKCQkJJCggIjxidXR0b24+PC9idXR0b24+IiwgcHJvcHMgKQoJCQkJLmJ1dHRvbiggYnV0dG9uT3B0aW9ucyApCgkJCQkuYXBwZW5kVG8oIHRoYXQudWlCdXR0b25TZXQgKTsKCQl9KTsKCQl0aGlzLnVpRGlhbG9nLmFkZENsYXNzKCJ1aS1kaWFsb2ctYnV0dG9ucyIpOwoJCXRoaXMudWlEaWFsb2dCdXR0b25QYW5lLmFwcGVuZFRvKCB0aGlzLnVpRGlhbG9nICk7Cgl9LAoKCV9tYWtlRHJhZ2dhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCWZ1bmN0aW9uIGZpbHRlcmVkVWkoIHVpICkgewoJCQlyZXR1cm4gewoJCQkJcG9zaXRpb246IHVpLnBvc2l0aW9uLAoJCQkJb2Zmc2V0OiB1aS5vZmZzZXQKCQkJfTsKCQl9CgoJCXRoaXMudWlEaWFsb2cuZHJhZ2dhYmxlKHsKCQkJY2FuY2VsOiAiLnVpLWRpYWxvZy1jb250ZW50LCAudWktZGlhbG9nLXRpdGxlYmFyLWNsb3NlIiwKCQkJaGFuZGxlOiAiLnVpLWRpYWxvZy10aXRsZWJhciIsCgkJCWNvbnRhaW5tZW50OiAiZG9jdW1lbnQiLAoJCQlzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcygidWktZGlhbG9nLWRyYWdnaW5nIik7CgkJCQl0aGF0Ll9ibG9ja0ZyYW1lcygpOwoJCQkJdGhhdC5fdHJpZ2dlciggImRyYWdTdGFydCIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0sCgkJCWRyYWc6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQl0aGF0Ll90cmlnZ2VyKCAiZHJhZyIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQlvcHRpb25zLnBvc2l0aW9uID0gWwoJCQkJCXVpLnBvc2l0aW9uLmxlZnQgLSB0aGF0LmRvY3VtZW50LnNjcm9sbExlZnQoKSwKCQkJCQl1aS5wb3NpdGlvbi50b3AgLSB0aGF0LmRvY3VtZW50LnNjcm9sbFRvcCgpCgkJCQldOwoJCQkJJCggdGhpcyApLnJlbW92ZUNsYXNzKCJ1aS1kaWFsb2ctZHJhZ2dpbmciKTsKCQkJCXRoYXQuX3VuYmxvY2tGcmFtZXMoKTsKCQkJCXRoYXQuX3RyaWdnZXIoICJkcmFnU3RvcCIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0KCQl9KTsKCX0sCgoJX21ha2VSZXNpemFibGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaGFuZGxlcyA9IG9wdGlvbnMucmVzaXphYmxlLAoJCQkvLyAudWktcmVzaXphYmxlIGhhcyBwb3NpdGlvbjogcmVsYXRpdmUgZGVmaW5lZCBpbiB0aGUgc3R5bGVzaGVldAoJCQkvLyBidXQgZGlhbG9ncyBoYXZlIHRvIHVzZSBhYnNvbHV0ZSBvciBmaXhlZCBwb3NpdGlvbmluZwoJCQlwb3NpdGlvbiA9IHRoaXMudWlEaWFsb2cuY3NzKCJwb3NpdGlvbiIpLAoJCQlyZXNpemVIYW5kbGVzID0gdHlwZW9mIGhhbmRsZXMgPT09ICJzdHJpbmciID8KCQkJCWhhbmRsZXMJOgoJCQkJIm4sZSxzLHcsc2Usc3csbmUsbnciOwoKCQlmdW5jdGlvbiBmaWx0ZXJlZFVpKCB1aSApIHsKCQkJcmV0dXJuIHsKCQkJCW9yaWdpbmFsUG9zaXRpb246IHVpLm9yaWdpbmFsUG9zaXRpb24sCgkJCQlvcmlnaW5hbFNpemU6IHVpLm9yaWdpbmFsU2l6ZSwKCQkJCXBvc2l0aW9uOiB1aS5wb3NpdGlvbiwKCQkJCXNpemU6IHVpLnNpemUKCQkJfTsKCQl9CgoJCXRoaXMudWlEaWFsb2cucmVzaXphYmxlKHsKCQkJY2FuY2VsOiAiLnVpLWRpYWxvZy1jb250ZW50IiwKCQkJY29udGFpbm1lbnQ6ICJkb2N1bWVudCIsCgkJCWFsc29SZXNpemU6IHRoaXMuZWxlbWVudCwKCQkJbWF4V2lkdGg6IG9wdGlvbnMubWF4V2lkdGgsCgkJCW1heEhlaWdodDogb3B0aW9ucy5tYXhIZWlnaHQsCgkJCW1pbldpZHRoOiBvcHRpb25zLm1pbldpZHRoLAoJCQltaW5IZWlnaHQ6IHRoaXMuX21pbkhlaWdodCgpLAoJCQloYW5kbGVzOiByZXNpemVIYW5kbGVzLAoJCQlzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcygidWktZGlhbG9nLXJlc2l6aW5nIik7CgkJCQl0aGF0Ll9ibG9ja0ZyYW1lcygpOwoJCQkJdGhhdC5fdHJpZ2dlciggInJlc2l6ZVN0YXJ0IiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsKCQkJfSwKCQkJcmVzaXplOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdGhhdC5fdHJpZ2dlciggInJlc2l6ZSIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQlvcHRpb25zLmhlaWdodCA9ICQoIHRoaXMgKS5oZWlnaHQoKTsKCQkJCW9wdGlvbnMud2lkdGggPSAkKCB0aGlzICkud2lkdGgoKTsKCQkJCSQoIHRoaXMgKS5yZW1vdmVDbGFzcygidWktZGlhbG9nLXJlc2l6aW5nIik7CgkJCQl0aGF0Ll91bmJsb2NrRnJhbWVzKCk7CgkJCQl0aGF0Ll90cmlnZ2VyKCAicmVzaXplU3RvcCIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0KCQl9KQoJCS5jc3MoICJwb3NpdGlvbiIsIHBvc2l0aW9uICk7Cgl9LAoKCV9taW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQlyZXR1cm4gb3B0aW9ucy5oZWlnaHQgPT09ICJhdXRvIiA\/CgkJCW9wdGlvbnMubWluSGVpZ2h0IDoKCQkJTWF0aC5taW4oIG9wdGlvbnMubWluSGVpZ2h0LCBvcHRpb25zLmhlaWdodCApOwoJfSwKCglfcG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCS8vIE5lZWQgdG8gc2hvdyB0aGUgZGlhbG9nIHRvIGdldCB0aGUgYWN0dWFsIG9mZnNldCBpbiB0aGUgcG9zaXRpb24gcGx1Z2luCgkJdmFyIGlzVmlzaWJsZSA9IHRoaXMudWlEaWFsb2cuaXMoIjp2aXNpYmxlIik7CgkJaWYgKCAhaXNWaXNpYmxlICkgewoJCQl0aGlzLnVpRGlhbG9nLnNob3coKTsKCQl9CgkJdGhpcy51aURpYWxvZy5wb3NpdGlvbiggdGhpcy5vcHRpb25zLnBvc2l0aW9uICk7CgkJaWYgKCAhaXNWaXNpYmxlICkgewoJCQl0aGlzLnVpRGlhbG9nLmhpZGUoKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXJlc2l6ZSA9IGZhbHNlLAoJCQlyZXNpemFibGVPcHRpb25zID0ge307CgoJCSQuZWFjaCggb3B0aW9ucywgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCXRoYXQuX3NldE9wdGlvbigga2V5LCB2YWx1ZSApOwoKCQkJaWYgKCBrZXkgaW4gc2l6ZVJlbGF0ZWRPcHRpb25zICkgewoJCQkJcmVzaXplID0gdHJ1ZTsKCQkJfQoJCQlpZiAoIGtleSBpbiByZXNpemFibGVSZWxhdGVkT3B0aW9ucyApIHsKCQkJCXJlc2l6YWJsZU9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9KTsKCgkJaWYgKCByZXNpemUgKSB7CgkJCXRoaXMuX3NpemUoKTsKCQkJdGhpcy5fcG9zaXRpb24oKTsKCQl9CgkJaWYgKCB0aGlzLnVpRGlhbG9nLmlzKCI6ZGF0YSh1aS1yZXNpemFibGUpIikgKSB7CgkJCXRoaXMudWlEaWFsb2cucmVzaXphYmxlKCAib3B0aW9uIiwgcmVzaXphYmxlT3B0aW9ucyApOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJLypqc2hpbnQgbWF4Y29tcGxleGl0eToxNSovCgkJdmFyIGlzRHJhZ2dhYmxlLCBpc1Jlc2l6YWJsZSwKCQkJdWlEaWFsb2cgPSB0aGlzLnVpRGlhbG9nOwoKCQlpZiAoIGtleSA9PT0gImRpYWxvZ0NsYXNzIiApIHsKCQkJdWlEaWFsb2cKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmRpYWxvZ0NsYXNzICkKCQkJCS5hZGRDbGFzcyggdmFsdWUgKTsKCQl9CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gImFwcGVuZFRvIiApIHsKCQkJdGhpcy51aURpYWxvZy5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJidXR0b25zIiApIHsKCQkJdGhpcy5fY3JlYXRlQnV0dG9ucygpOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJjbG9zZVRleHQiICkgewoJCQl0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZS5idXR0b24oewoJCQkJLy8gRW5zdXJlIHRoYXQgd2UgYWx3YXlzIHBhc3MgYSBzdHJpbmcKCQkJCWxhYmVsOiAiIiArIHZhbHVlCgkJCX0pOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJkcmFnZ2FibGUiICkgewoJCQlpc0RyYWdnYWJsZSA9IHVpRGlhbG9nLmlzKCI6ZGF0YSh1aS1kcmFnZ2FibGUpIik7CgkJCWlmICggaXNEcmFnZ2FibGUgJiYgIXZhbHVlICkgewoJCQkJdWlEaWFsb2cuZHJhZ2dhYmxlKCJkZXN0cm95Iik7CgkJCX0KCgkJCWlmICggIWlzRHJhZ2dhYmxlICYmIHZhbHVlICkgewoJCQkJdGhpcy5fbWFrZURyYWdnYWJsZSgpOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gInBvc2l0aW9uIiApIHsKCQkJdGhpcy5fcG9zaXRpb24oKTsKCQl9CgoJCWlmICgga2V5ID09PSAicmVzaXphYmxlIiApIHsKCQkJLy8gY3VycmVudGx5IHJlc2l6YWJsZSwgYmVjb21pbmcgbm9uLXJlc2l6YWJsZQoJCQlpc1Jlc2l6YWJsZSA9IHVpRGlhbG9nLmlzKCI6ZGF0YSh1aS1yZXNpemFibGUpIik7CgkJCWlmICggaXNSZXNpemFibGUgJiYgIXZhbHVlICkgewoJCQkJdWlEaWFsb2cucmVzaXphYmxlKCJkZXN0cm95Iik7CgkJCX0KCgkJCS8vIGN1cnJlbnRseSByZXNpemFibGUsIGNoYW5naW5nIGhhbmRsZXMKCQkJaWYgKCBpc1Jlc2l6YWJsZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICkgewoJCQkJdWlEaWFsb2cucmVzaXphYmxlKCAib3B0aW9uIiwgImhhbmRsZXMiLCB2YWx1ZSApOwoJCQl9CgoJCQkvLyBjdXJyZW50bHkgbm9uLXJlc2l6YWJsZSwgYmVjb21pbmcgcmVzaXphYmxlCgkJCWlmICggIWlzUmVzaXphYmxlICYmIHZhbHVlICE9PSBmYWxzZSApIHsKCQkJCXRoaXMuX21ha2VSZXNpemFibGUoKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJ0aXRsZSIgKSB7CgkJCXRoaXMuX3RpdGxlKCB0aGlzLnVpRGlhbG9nVGl0bGViYXIuZmluZCgiLnVpLWRpYWxvZy10aXRsZSIpICk7CgkJfQoJfSwKCglfc2l6ZTogZnVuY3Rpb24oKSB7CgkJLy8gSWYgdGhlIHVzZXIgaGFzIHJlc2l6ZWQgdGhlIGRpYWxvZywgdGhlIC51aS1kaWFsb2cgYW5kIC51aS1kaWFsb2ctY29udGVudAoJCS8vIGRpdnMgd2lsbCBib3RoIGhhdmUgd2lkdGggYW5kIGhlaWdodCBzZXQsIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlbQoJCXZhciBub25Db250ZW50SGVpZ2h0LCBtaW5Db250ZW50SGVpZ2h0LCBtYXhDb250ZW50SGVpZ2h0LAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBSZXNldCBjb250ZW50IHNpemluZwoJCXRoaXMuZWxlbWVudC5zaG93KCkuY3NzKHsKCQkJd2lkdGg6ICJhdXRvIiwKCQkJbWluSGVpZ2h0OiAwLAoJCQltYXhIZWlnaHQ6ICJub25lIiwKCQkJaGVpZ2h0OiAwCgkJfSk7CgoJCWlmICggb3B0aW9ucy5taW5XaWR0aCA+IG9wdGlvbnMud2lkdGggKSB7CgkJCW9wdGlvbnMud2lkdGggPSBvcHRpb25zLm1pbldpZHRoOwoJCX0KCgkJLy8gcmVzZXQgd3JhcHBlciBzaXppbmcKCQkvLyBkZXRlcm1pbmUgdGhlIGhlaWdodCBvZiBhbGwgdGhlIG5vbi1jb250ZW50IGVsZW1lbnRzCgkJbm9uQ29udGVudEhlaWdodCA9IHRoaXMudWlEaWFsb2cuY3NzKHsKCQkJCWhlaWdodDogImF1dG8iLAoJCQkJd2lkdGg6IG9wdGlvbnMud2lkdGgKCQkJfSkKCQkJLm91dGVySGVpZ2h0KCk7CgkJbWluQ29udGVudEhlaWdodCA9IE1hdGgubWF4KCAwLCBvcHRpb25zLm1pbkhlaWdodCAtIG5vbkNvbnRlbnRIZWlnaHQgKTsKCQltYXhDb250ZW50SGVpZ2h0ID0gdHlwZW9mIG9wdGlvbnMubWF4SGVpZ2h0ID09PSAibnVtYmVyIiA\/CgkJCU1hdGgubWF4KCAwLCBvcHRpb25zLm1heEhlaWdodCAtIG5vbkNvbnRlbnRIZWlnaHQgKSA6CgkJCSJub25lIjsKCgkJaWYgKCBvcHRpb25zLmhlaWdodCA9PT0gImF1dG8iICkgewoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCW1pbkhlaWdodDogbWluQ29udGVudEhlaWdodCwKCQkJCW1heEhlaWdodDogbWF4Q29udGVudEhlaWdodCwKCQkJCWhlaWdodDogImF1dG8iCgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5oZWlnaHQoIE1hdGgubWF4KCAwLCBvcHRpb25zLmhlaWdodCAtIG5vbkNvbnRlbnRIZWlnaHQgKSApOwoJCX0KCgkJaWYgKHRoaXMudWlEaWFsb2cuaXMoIjpkYXRhKHVpLXJlc2l6YWJsZSkiKSApIHsKCQkJdGhpcy51aURpYWxvZy5yZXNpemFibGUoICJvcHRpb24iLCAibWluSGVpZ2h0IiwgdGhpcy5fbWluSGVpZ2h0KCkgKTsKCQl9Cgl9LAoKCV9ibG9ja0ZyYW1lczogZnVuY3Rpb24oKSB7CgkJdGhpcy5pZnJhbWVCbG9ja3MgPSB0aGlzLmRvY3VtZW50LmZpbmQoICJpZnJhbWUiICkubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgaWZyYW1lID0gJCggdGhpcyApOwoKCQkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkJLmNzcyh7CgkJCQkJcG9zaXRpb246ICJhYnNvbHV0ZSIsCgkJCQkJd2lkdGg6IGlmcmFtZS5vdXRlcldpZHRoKCksCgkJCQkJaGVpZ2h0OiBpZnJhbWUub3V0ZXJIZWlnaHQoKQoJCQkJfSkKCQkJCS5hcHBlbmRUbyggaWZyYW1lLnBhcmVudCgpICkKCQkJCS5vZmZzZXQoIGlmcmFtZS5vZmZzZXQoKSApWzBdOwoJCX0pOwoJfSwKCglfdW5ibG9ja0ZyYW1lczogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlmcmFtZUJsb2NrcyApIHsKCQkJdGhpcy5pZnJhbWVCbG9ja3MucmVtb3ZlKCk7CgkJCWRlbGV0ZSB0aGlzLmlmcmFtZUJsb2NrczsKCQl9Cgl9LAoKCV9hbGxvd0ludGVyYWN0aW9uOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCIudWktZGlhbG9nIikubGVuZ3RoICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgoJCS8vIFRPRE86IFJlbW92ZSBoYWNrIHdoZW4gZGF0ZXBpY2tlciBpbXBsZW1lbnRzCgkJLy8gdGhlIC51aS1mcm9udCBsb2dpYyAoIzg5ODkpCgkJcmV0dXJuICEhJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCgiLnVpLWRhdGVwaWNrZXIiKS5sZW5ndGg7Cgl9LAoKCV9jcmVhdGVPdmVybGF5OiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMubW9kYWwgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0aGF0ID0gdGhpcywKCQkJd2lkZ2V0RnVsbE5hbWUgPSB0aGlzLndpZGdldEZ1bGxOYW1lOwoJCWlmICggISQudWkuZGlhbG9nLm92ZXJsYXlJbnN0YW5jZXMgKSB7CgkJCS8vIFByZXZlbnQgdXNlIG9mIGFuY2hvcnMgYW5kIGlucHV0cy4KCQkJLy8gV2UgdXNlIGEgZGVsYXkgaW4gY2FzZSB0aGUgb3ZlcmxheSBpcyBjcmVhdGVkIGZyb20gYW4KCQkJLy8gZXZlbnQgdGhhdCB3ZSdyZSBnb2luZyB0byBiZSBjYW5jZWxsaW5nLiAoIzI4MDQpCgkJCXRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJLy8gSGFuZGxlIC5kaWFsb2coKS5kaWFsb2coImNsb3NlIikgKCM0MDY1KQoJCQkJaWYgKCAkLnVpLmRpYWxvZy5vdmVybGF5SW5zdGFuY2VzICkgewoJCQkJCXRoaXMuZG9jdW1lbnQuYmluZCggImZvY3VzaW4uZGlhbG9nIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCQlpZiAoICF0aGF0Ll9hbGxvd0ludGVyYWN0aW9uKCBldmVudCApICkgewoJCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJCSQoIi51aS1kaWFsb2c6dmlzaWJsZTpsYXN0IC51aS1kaWFsb2ctY29udGVudCIpCgkJCQkJCQkJLmRhdGEoIHdpZGdldEZ1bGxOYW1lICkuX2ZvY3VzVGFiYmFibGUoKTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXRoaXMub3ZlcmxheSA9ICQoIjxkaXY+IikKCQkJLmFkZENsYXNzKCJ1aS13aWRnZXQtb3ZlcmxheSB1aS1mcm9udCIpCgkJCS5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOwoJCXRoaXMuX29uKCB0aGlzLm92ZXJsYXksIHsKCQkJbW91c2Vkb3duOiAiX2tlZXBGb2N1cyIKCQl9KTsKCQkkLnVpLmRpYWxvZy5vdmVybGF5SW5zdGFuY2VzKys7Cgl9LAoKCV9kZXN0cm95T3ZlcmxheTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5vcHRpb25zLm1vZGFsICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMub3ZlcmxheSApIHsKCQkJJC51aS5kaWFsb2cub3ZlcmxheUluc3RhbmNlcy0tOwoKCQkJaWYgKCAhJC51aS5kaWFsb2cub3ZlcmxheUluc3RhbmNlcyApIHsKCQkJCXRoaXMuZG9jdW1lbnQudW5iaW5kKCAiZm9jdXNpbi5kaWFsb2ciICk7CgkJCX0KCQkJdGhpcy5vdmVybGF5LnJlbW92ZSgpOwoJCQl0aGlzLm92ZXJsYXkgPSBudWxsOwoJCX0KCX0KfSk7CgokLnVpLmRpYWxvZy5vdmVybGF5SW5zdGFuY2VzID0gMDsKCi8vIERFUFJFQ0FURUQKaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgKSB7CgkvLyBwb3NpdGlvbiBvcHRpb24gd2l0aCBhcnJheSBub3RhdGlvbgoJLy8ganVzdCBvdmVycmlkZSB3aXRoIG9sZCBpbXBsZW1lbnRhdGlvbgoJJC53aWRnZXQoICJ1aS5kaWFsb2ciLCAkLnVpLmRpYWxvZywgewoJCV9wb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBwb3NpdGlvbiA9IHRoaXMub3B0aW9ucy5wb3NpdGlvbiwKCQkJCW15QXQgPSBbXSwKCQkJCW9mZnNldCA9IFsgMCwgMCBdLAoJCQkJaXNWaXNpYmxlOwoKCQkJaWYgKCBwb3NpdGlvbiApIHsKCQkJCWlmICggdHlwZW9mIHBvc2l0aW9uID09PSAic3RyaW5nIiB8fCAodHlwZW9mIHBvc2l0aW9uID09PSAib2JqZWN0IiAmJiAiMCIgaW4gcG9zaXRpb24gKSApIHsKCQkJCQlteUF0ID0gcG9zaXRpb24uc3BsaXQgPyBwb3NpdGlvbi5zcGxpdCgiICIpIDogWyBwb3NpdGlvblswXSwgcG9zaXRpb25bMV0gXTsKCQkJCQlpZiAoIG15QXQubGVuZ3RoID09PSAxICkgewoJCQkJCQlteUF0WzFdID0gbXlBdFswXTsKCQkJCQl9CgoJCQkJCSQuZWFjaCggWyAibGVmdCIsICJ0b3AiIF0sIGZ1bmN0aW9uKCBpLCBvZmZzZXRQb3NpdGlvbiApIHsKCQkJCQkJaWYgKCArbXlBdFsgaSBdID09PSBteUF0WyBpIF0gKSB7CgkJCQkJCQlvZmZzZXRbIGkgXSA9IG15QXRbIGkgXTsKCQkJCQkJCW15QXRbIGkgXSA9IG9mZnNldFBvc2l0aW9uOwoJCQkJCQl9CgkJCQkJfSk7CgoJCQkJCXBvc2l0aW9uID0gewoJCQkJCQlteTogbXlBdFswXSArIChvZmZzZXRbMF0gPCAwID8gb2Zmc2V0WzBdIDogIisiICsgb2Zmc2V0WzBdKSArICIgIiArCgkJCQkJCQlteUF0WzFdICsgKG9mZnNldFsxXSA8IDAgPyBvZmZzZXRbMV0gOiAiKyIgKyBvZmZzZXRbMV0pLAoJCQkJCQlhdDogbXlBdC5qb2luKCIgIikKCQkJCQl9OwoJCQkJfQoKCQkJCXBvc2l0aW9uID0gJC5leHRlbmQoIHt9LCAkLnVpLmRpYWxvZy5wcm90b3R5cGUub3B0aW9ucy5wb3NpdGlvbiwgcG9zaXRpb24gKTsKCQkJfSBlbHNlIHsKCQkJCXBvc2l0aW9uID0gJC51aS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMucG9zaXRpb247CgkJCX0KCgkJCS8vIG5lZWQgdG8gc2hvdyB0aGUgZGlhbG9nIHRvIGdldCB0aGUgYWN0dWFsIG9mZnNldCBpbiB0aGUgcG9zaXRpb24gcGx1Z2luCgkJCWlzVmlzaWJsZSA9IHRoaXMudWlEaWFsb2cuaXMoIjp2aXNpYmxlIik7CgkJCWlmICggIWlzVmlzaWJsZSApIHsKCQkJCXRoaXMudWlEaWFsb2cuc2hvdygpOwoJCQl9CgkJCXRoaXMudWlEaWFsb2cucG9zaXRpb24oIHBvc2l0aW9uICk7CgkJCWlmICggIWlzVmlzaWJsZSApIHsKCQkJCXRoaXMudWlEaWFsb2cuaGlkZSgpOwoJCQl9CgkJfQoJfSk7Cn0KCn0oIGpRdWVyeSApICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJ1aS5tZW51IiwgewoJdmVyc2lvbjogIjEuMTAuMyIsCglkZWZhdWx0RWxlbWVudDogIjx1bD4iLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlpY29uczogewoJCQlzdWJtZW51OiAidWktaWNvbi1jYXJhdC0xLWUiCgkJfSwKCQltZW51czogInVsIiwKCQlwb3NpdGlvbjogewoJCQlteTogImxlZnQgdG9wIiwKCQkJYXQ6ICJyaWdodCB0b3AiCgkJfSwKCQlyb2xlOiAibWVudSIsCgoJCS8vIGNhbGxiYWNrcwoJCWJsdXI6IG51bGwsCgkJZm9jdXM6IG51bGwsCgkJc2VsZWN0OiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuYWN0aXZlTWVudSA9IHRoaXMuZWxlbWVudDsKCQkvLyBmbGFnIHVzZWQgdG8gcHJldmVudCBmaXJpbmcgb2YgdGhlIGNsaWNrIGhhbmRsZXIKCQkvLyBhcyB0aGUgZXZlbnQgYnViYmxlcyB1cCB0aHJvdWdoIG5lc3RlZCBtZW51cwoJCXRoaXMubW91c2VIYW5kbGVkID0gZmFsc2U7CgkJdGhpcy5lbGVtZW50CgkJCS51bmlxdWVJZCgpCgkJCS5hZGRDbGFzcyggInVpLW1lbnUgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktbWVudS1pY29ucyIsICEhdGhpcy5lbGVtZW50LmZpbmQoICIudWktaWNvbiIgKS5sZW5ndGggKQoJCQkuYXR0cih7CgkJCQlyb2xlOiB0aGlzLm9wdGlvbnMucm9sZSwKCQkJCXRhYkluZGV4OiAwCgkJCX0pCgkJCS8vIG5lZWQgdG8gY2F0Y2ggYWxsIGNsaWNrcyBvbiBkaXNhYmxlZCBtZW51CgkJCS8vIG5vdCBwb3NzaWJsZSB0aHJvdWdoIF9vbgoJCQkuYmluZCggImNsaWNrIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsICQucHJveHkoZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfSwgdGhpcyApKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsICJ0cnVlIiApOwoJCX0KCgkJdGhpcy5fb24oewoJCQkvLyBQcmV2ZW50IGZvY3VzIGZyb20gc3RpY2tpbmcgdG8gbGlua3MgaW5zaWRlIG1lbnUgYWZ0ZXIgY2xpY2tpbmcKCQkJLy8gdGhlbSAoZm9jdXMgc2hvdWxkIGFsd2F5cyBzdGF5IG9uIFVMIGR1cmluZyBuYXZpZ2F0aW9uKS4KCQkJIm1vdXNlZG93biAudWktbWVudS1pdGVtID4gYSI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0sCgkJCSJjbGljayAudWktc3RhdGUtZGlzYWJsZWQgPiBhIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfSwKCQkJImNsaWNrIC51aS1tZW51LWl0ZW06aGFzKGEpIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiApOwoJCQkJaWYgKCAhdGhpcy5tb3VzZUhhbmRsZWQgJiYgdGFyZ2V0Lm5vdCggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKS5sZW5ndGggKSB7CgkJCQkJdGhpcy5tb3VzZUhhbmRsZWQgPSB0cnVlOwoKCQkJCQl0aGlzLnNlbGVjdCggZXZlbnQgKTsKCQkJCQkvLyBPcGVuIHN1Ym1lbnUgb24gY2xpY2sKCQkJCQlpZiAoIHRhcmdldC5oYXMoICIudWktbWVudSIgKS5sZW5ndGggKSB7CgkJCQkJCXRoaXMuZXhwYW5kKCBldmVudCApOwoJCQkJCX0gZWxzZSBpZiAoICF0aGlzLmVsZW1lbnQuaXMoICI6Zm9jdXMiICkgKSB7CgkJCQkJCS8vIFJlZGlyZWN0IGZvY3VzIHRvIHRoZSBtZW51CgkJCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiZm9jdXMiLCBbIHRydWUgXSApOwoKCQkJCQkJLy8gSWYgdGhlIGFjdGl2ZSBpdGVtIGlzIG9uIHRoZSB0b3AgbGV2ZWwsIGxldCBpdCBzdGF5IGFjdGl2ZS4KCQkJCQkJLy8gT3RoZXJ3aXNlLCBibHVyIHRoZSBhY3RpdmUgaXRlbSBzaW5jZSBpdCBpcyBubyBsb25nZXIgdmlzaWJsZS4KCQkJCQkJaWYgKCB0aGlzLmFjdGl2ZSAmJiB0aGlzLmFjdGl2ZS5wYXJlbnRzKCAiLnVpLW1lbnUiICkubGVuZ3RoID09PSAxICkgewoJCQkJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0sCgkJCSJtb3VzZWVudGVyIC51aS1tZW51LWl0ZW0iOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApOwoJCQkJLy8gUmVtb3ZlIHVpLXN0YXRlLWFjdGl2ZSBjbGFzcyBmcm9tIHNpYmxpbmdzIG9mIHRoZSBuZXdseSBmb2N1c2VkIG1lbnUgaXRlbQoJCQkJLy8gdG8gYXZvaWQgYSBqdW1wIGNhdXNlZCBieSBhZGphY2VudCBlbGVtZW50cyBib3RoIGhhdmluZyBhIGNsYXNzIHdpdGggYSBib3JkZXIKCQkJCXRhcmdldC5zaWJsaW5ncygpLmNoaWxkcmVuKCAiLnVpLXN0YXRlLWFjdGl2ZSIgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0YXJnZXQgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogImNvbGxhcHNlQWxsIiwKCQkJIm1vdXNlbGVhdmUgLnVpLW1lbnUiOiAiY29sbGFwc2VBbGwiLAoJCQlmb2N1czogZnVuY3Rpb24oIGV2ZW50LCBrZWVwQWN0aXZlSXRlbSApIHsKCQkJCS8vIElmIHRoZXJlJ3MgYWxyZWFkeSBhbiBhY3RpdmUgaXRlbSwga2VlcCBpdCBhY3RpdmUKCQkJCS8vIElmIG5vdCwgYWN0aXZhdGUgdGhlIGZpcnN0IGl0ZW0KCQkJCXZhciBpdGVtID0gdGhpcy5hY3RpdmUgfHwgdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbSIgKS5lcSggMCApOwoKCQkJCWlmICggIWtlZXBBY3RpdmVJdGVtICkgewoJCQkJCXRoaXMuZm9jdXMoIGV2ZW50LCBpdGVtICk7CgkJCQl9CgkJCX0sCgkJCWJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJCWlmICggISQuY29udGFpbnMoIHRoaXMuZWxlbWVudFswXSwgdGhpcy5kb2N1bWVudFswXS5hY3RpdmVFbGVtZW50ICkgKSB7CgkJCQkJCXRoaXMuY29sbGFwc2VBbGwoIGV2ZW50ICk7CgkJCQkJfQoJCQkJfSk7CgkJCX0sCgkJCWtleWRvd246ICJfa2V5ZG93biIKCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7CgoJCS8vIENsaWNrcyBvdXRzaWRlIG9mIGEgbWVudSBjb2xsYXBzZSBhbnkgb3BlbiBtZW51cwoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICEkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLW1lbnUiICkubGVuZ3RoICkgewoJCQkJCXRoaXMuY29sbGFwc2VBbGwoIGV2ZW50ICk7CgkJCQl9CgoJCQkJLy8gUmVzZXQgdGhlIG1vdXNlSGFuZGxlZCBmbGFnCgkJCQl0aGlzLm1vdXNlSGFuZGxlZCA9IGZhbHNlOwoJCQl9CgkJfSk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkvLyBEZXN0cm95IChzdWIpbWVudXMKCQl0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiICkKCQkJLmZpbmQoICIudWktbWVudSIgKS5hZGRCYWNrKCkKCQkJCS5yZW1vdmVDbGFzcyggInVpLW1lbnUgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwgdWktbWVudS1pY29ucyIgKQoJCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGFiZWxsZWRieSIgKQoJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWV4cGFuZGVkIiApCgkJCQkucmVtb3ZlQXR0ciggImFyaWEtaGlkZGVuIiApCgkJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJCS5yZW1vdmVVbmlxdWVJZCgpCgkJCQkuc2hvdygpOwoKCQkvLyBEZXN0cm95IG1lbnUgaXRlbXMKCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1tZW51LWl0ZW0iICkKCQkJLnJlbW92ZUNsYXNzKCAidWktbWVudS1pdGVtIiApCgkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLmNoaWxkcmVuKCAiYSIgKQoJCQkJLnJlbW92ZVVuaXF1ZUlkKCkKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci1hbGwgdWktc3RhdGUtaG92ZXIiICkKCQkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKQoJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWhhc3BvcHVwIiApCgkJCQkuY2hpbGRyZW4oKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgZWxlbSA9ICQoIHRoaXMgKTsKCQkJCQlpZiAoIGVsZW0uZGF0YSggInVpLW1lbnUtc3VibWVudS1jYXJhdCIgKSApIHsKCQkJCQkJZWxlbS5yZW1vdmUoKTsKCQkJCQl9CgkJCQl9KTsKCgkJLy8gRGVzdHJveSBtZW51IGRpdmlkZXJzCgkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktbWVudS1kaXZpZGVyIiApLnJlbW92ZUNsYXNzKCAidWktbWVudS1kaXZpZGVyIHVpLXdpZGdldC1jb250ZW50IiApOwoJfSwKCglfa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8qanNoaW50IG1heGNvbXBsZXhpdHk6MjAqLwoJCXZhciBtYXRjaCwgcHJldiwgY2hhcmFjdGVyLCBza2lwLCByZWdleCwKCQkJcHJldmVudERlZmF1bHQgPSB0cnVlOwoKCQlmdW5jdGlvbiBlc2NhcGUoIHZhbHVlICkgewoJCQlyZXR1cm4gdmFsdWUucmVwbGFjZSggL1tcLVxbXF17fSgpKis\/LixcXFxeJHwjXHNdL2csICJcXCQmIiApOwoJCX0KCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQljYXNlICQudWkua2V5Q29kZS5QQUdFX1VQOgoJCQl0aGlzLnByZXZpb3VzUGFnZSggZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOOgoJCQl0aGlzLm5leHRQYWdlKCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQl0aGlzLl9tb3ZlKCAiZmlyc3QiLCAiZmlyc3QiLCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCXRoaXMuX21vdmUoICJsYXN0IiwgImxhc3QiLCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJdGhpcy5wcmV2aW91cyggZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJdGhpcy5uZXh0KCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5MRUZUOgoJCQl0aGlzLmNvbGxhcHNlKCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJaWYgKCB0aGlzLmFjdGl2ZSAmJiAhdGhpcy5hY3RpdmUuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQl0aGlzLmV4cGFuZCggZXZlbnQgKTsKCQkJfQoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQljYXNlICQudWkua2V5Q29kZS5TUEFDRToKCQkJdGhpcy5fYWN0aXZhdGUoIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLkVTQ0FQRToKCQkJdGhpcy5jb2xsYXBzZSggZXZlbnQgKTsKCQkJYnJlYWs7CgkJZGVmYXVsdDoKCQkJcHJldmVudERlZmF1bHQgPSBmYWxzZTsKCQkJcHJldiA9IHRoaXMucHJldmlvdXNGaWx0ZXIgfHwgIiI7CgkJCWNoYXJhY3RlciA9IFN0cmluZy5mcm9tQ2hhckNvZGUoIGV2ZW50LmtleUNvZGUgKTsKCQkJc2tpcCA9IGZhbHNlOwoKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmZpbHRlclRpbWVyICk7CgoJCQlpZiAoIGNoYXJhY3RlciA9PT0gcHJldiApIHsKCQkJCXNraXAgPSB0cnVlOwoJCQl9IGVsc2UgewoJCQkJY2hhcmFjdGVyID0gcHJldiArIGNoYXJhY3RlcjsKCQkJfQoKCQkJcmVnZXggPSBuZXcgUmVnRXhwKCAiXiIgKyBlc2NhcGUoIGNoYXJhY3RlciApLCAiaSIgKTsKCQkJbWF0Y2ggPSB0aGlzLmFjdGl2ZU1lbnUuY2hpbGRyZW4oICIudWktbWVudS1pdGVtIiApLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiByZWdleC50ZXN0KCAkKCB0aGlzICkuY2hpbGRyZW4oICJhIiApLnRleHQoKSApOwoJCQl9KTsKCQkJbWF0Y2ggPSBza2lwICYmIG1hdGNoLmluZGV4KCB0aGlzLmFjdGl2ZS5uZXh0KCkgKSAhPT0gLTEgPwoJCQkJdGhpcy5hY3RpdmUubmV4dEFsbCggIi51aS1tZW51LWl0ZW0iICkgOgoJCQkJbWF0Y2g7CgoJCQkvLyBJZiBubyBtYXRjaGVzIG9uIHRoZSBjdXJyZW50IGZpbHRlciwgcmVzZXQgdG8gdGhlIGxhc3QgY2hhcmFjdGVyIHByZXNzZWQKCQkJLy8gdG8gbW92ZSBkb3duIHRoZSBtZW51IHRvIHRoZSBmaXJzdCBpdGVtIHRoYXQgc3RhcnRzIHdpdGggdGhhdCBjaGFyYWN0ZXIKCQkJaWYgKCAhbWF0Y2gubGVuZ3RoICkgewoJCQkJY2hhcmFjdGVyID0gU3RyaW5nLmZyb21DaGFyQ29kZSggZXZlbnQua2V5Q29kZSApOwoJCQkJcmVnZXggPSBuZXcgUmVnRXhwKCAiXiIgKyBlc2NhcGUoIGNoYXJhY3RlciApLCAiaSIgKTsKCQkJCW1hdGNoID0gdGhpcy5hY3RpdmVNZW51LmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbSIgKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHJlZ2V4LnRlc3QoICQoIHRoaXMgKS5jaGlsZHJlbiggImEiICkudGV4dCgpICk7CgkJCQl9KTsKCQkJfQoKCQkJaWYgKCBtYXRjaC5sZW5ndGggKSB7CgkJCQl0aGlzLmZvY3VzKCBldmVudCwgbWF0Y2ggKTsKCQkJCWlmICggbWF0Y2gubGVuZ3RoID4gMSApIHsKCQkJCQl0aGlzLnByZXZpb3VzRmlsdGVyID0gY2hhcmFjdGVyOwoJCQkJCXRoaXMuZmlsdGVyVGltZXIgPSB0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCQkJZGVsZXRlIHRoaXMucHJldmlvdXNGaWx0ZXI7CgkJCQkJfSwgMTAwMCApOwoJCQkJfSBlbHNlIHsKCQkJCQlkZWxldGUgdGhpcy5wcmV2aW91c0ZpbHRlcjsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWRlbGV0ZSB0aGlzLnByZXZpb3VzRmlsdGVyOwoJCQl9CgkJfQoKCQlpZiAoIHByZXZlbnREZWZhdWx0ICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX2FjdGl2YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5hY3RpdmUuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWlmICggdGhpcy5hY3RpdmUuY2hpbGRyZW4oICJhW2FyaWEtaGFzcG9wdXA9J3RydWUnXSIgKS5sZW5ndGggKSB7CgkJCQl0aGlzLmV4cGFuZCggZXZlbnQgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuc2VsZWN0KCBldmVudCApOwoJCQl9CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgbWVudXMsCgkJCWljb24gPSB0aGlzLm9wdGlvbnMuaWNvbnMuc3VibWVudSwKCQkJc3VibWVudXMgPSB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLm1lbnVzICk7CgoJCS8vIEluaXRpYWxpemUgbmVzdGVkIG1lbnVzCgkJc3VibWVudXMuZmlsdGVyKCAiOm5vdCgudWktbWVudSkiICkKCQkJLmFkZENsYXNzKCAidWktbWVudSB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCIgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKHsKCQkJCXJvbGU6IHRoaXMub3B0aW9ucy5yb2xlLAoJCQkJImFyaWEtaGlkZGVuIjogInRydWUiLAoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiCgkJCX0pCgkJCS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIG1lbnUgPSAkKCB0aGlzICksCgkJCQkJaXRlbSA9IG1lbnUucHJldiggImEiICksCgkJCQkJc3VibWVudUNhcmF0ID0gJCggIjxzcGFuPiIgKQoJCQkJCQkuYWRkQ2xhc3MoICJ1aS1tZW51LWljb24gdWktaWNvbiAiICsgaWNvbiApCgkJCQkJCS5kYXRhKCAidWktbWVudS1zdWJtZW51LWNhcmF0IiwgdHJ1ZSApOwoKCQkJCWl0ZW0KCQkJCQkuYXR0ciggImFyaWEtaGFzcG9wdXAiLCAidHJ1ZSIgKQoJCQkJCS5wcmVwZW5kKCBzdWJtZW51Q2FyYXQgKTsKCQkJCW1lbnUuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGl0ZW0uYXR0ciggImlkIiApICk7CgkJCX0pOwoKCQltZW51cyA9IHN1Ym1lbnVzLmFkZCggdGhpcy5lbGVtZW50ICk7CgoJCS8vIERvbid0IHJlZnJlc2ggbGlzdCBpdGVtcyB0aGF0IGFyZSBhbHJlYWR5IGFkYXB0ZWQKCQltZW51cy5jaGlsZHJlbiggIjpub3QoLnVpLW1lbnUtaXRlbSk6aGFzKGEpIiApCgkJCS5hZGRDbGFzcyggInVpLW1lbnUtaXRlbSIgKQoJCQkuYXR0ciggInJvbGUiLCAicHJlc2VudGF0aW9uIiApCgkJCS5jaGlsZHJlbiggImEiICkKCQkJCS51bmlxdWVJZCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiApCgkJCQkuYXR0cih7CgkJCQkJdGFiSW5kZXg6IC0xLAoJCQkJCXJvbGU6IHRoaXMuX2l0ZW1Sb2xlKCkKCQkJCX0pOwoKCQkvLyBJbml0aWFsaXplIHVubGlua2VkIG1lbnUtaXRlbXMgY29udGFpbmluZyBzcGFjZXMgYW5kL29yIGRhc2hlcyBvbmx5IGFzIGRpdmlkZXJzCgkJbWVudXMuY2hpbGRyZW4oICI6bm90KC51aS1tZW51LWl0ZW0pIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBpdGVtID0gJCggdGhpcyApOwoJCQkvLyBoeXBoZW4sIGVtIGRhc2gsIGVuIGRhc2gKCQkJaWYgKCAhL1teXC1cdTIwMTRcdTIwMTNcc10vLnRlc3QoIGl0ZW0udGV4dCgpICkgKSB7CgkJCQlpdGVtLmFkZENsYXNzKCAidWktd2lkZ2V0LWNvbnRlbnQgdWktbWVudS1kaXZpZGVyIiApOwoJCQl9CgkJfSk7CgoJCS8vIEFkZCBhcmlhLWRpc2FibGVkIGF0dHJpYnV0ZSB0byBhbnkgZGlzYWJsZWQgbWVudSBpdGVtCgkJbWVudXMuY2hpbGRyZW4oICIudWktc3RhdGUtZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCgkJLy8gSWYgdGhlIGFjdGl2ZSBpdGVtIGhhcyBiZWVuIHJlbW92ZWQsIGJsdXIgdGhlIG1lbnUKCQlpZiAoIHRoaXMuYWN0aXZlICYmICEkLmNvbnRhaW5zKCB0aGlzLmVsZW1lbnRbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQl0aGlzLmJsdXIoKTsKCQl9Cgl9LAoKCV9pdGVtUm9sZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJbWVudTogIm1lbnVpdGVtIiwKCQkJbGlzdGJveDogIm9wdGlvbiIKCQl9WyB0aGlzLm9wdGlvbnMucm9sZSBdOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImljb25zIiApIHsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktbWVudS1pY29uIiApCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5pY29ucy5zdWJtZW51ICkKCQkJCS5hZGRDbGFzcyggdmFsdWUuc3VibWVudSApOwoJCX0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJfSwKCglmb2N1czogZnVuY3Rpb24oIGV2ZW50LCBpdGVtICkgewoJCXZhciBuZXN0ZWQsIGZvY3VzZWQ7CgkJdGhpcy5ibHVyKCBldmVudCwgZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gImZvY3VzIiApOwoKCQl0aGlzLl9zY3JvbGxJbnRvVmlldyggaXRlbSApOwoKCQl0aGlzLmFjdGl2ZSA9IGl0ZW0uZmlyc3QoKTsKCQlmb2N1c2VkID0gdGhpcy5hY3RpdmUuY2hpbGRyZW4oICJhIiApLmFkZENsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJLy8gT25seSB1cGRhdGUgYXJpYS1hY3RpdmVkZXNjZW5kYW50IGlmIHRoZXJlJ3MgYSByb2xlCgkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBmb2N1cyBpcyBtYW5hZ2VkIGVsc2V3aGVyZQoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwgZm9jdXNlZC5hdHRyKCAiaWQiICkgKTsKCQl9CgoJCS8vIEhpZ2hsaWdodCBhY3RpdmUgcGFyZW50IG1lbnUgaXRlbSwgaWYgYW55CgkJdGhpcy5hY3RpdmUKCQkJLnBhcmVudCgpCgkJCS5jbG9zZXN0KCAiLnVpLW1lbnUtaXRlbSIgKQoJCQkuY2hpbGRyZW4oICJhOmZpcnN0IiApCgkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCgkJaWYgKCBldmVudCAmJiBldmVudC50eXBlID09PSAia2V5ZG93biIgKSB7CgkJCXRoaXMuX2Nsb3NlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fY2xvc2UoKTsKCQkJfSwgdGhpcy5kZWxheSApOwoJCX0KCgkJbmVzdGVkID0gaXRlbS5jaGlsZHJlbiggIi51aS1tZW51IiApOwoJCWlmICggbmVzdGVkLmxlbmd0aCAmJiAoIC9ebW91c2UvLnRlc3QoIGV2ZW50LnR5cGUgKSApICkgewoJCQl0aGlzLl9zdGFydE9wZW5pbmcobmVzdGVkKTsKCQl9CgkJdGhpcy5hY3RpdmVNZW51ID0gaXRlbS5wYXJlbnQoKTsKCgkJdGhpcy5fdHJpZ2dlciggImZvY3VzIiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICk7Cgl9LAoKCV9zY3JvbGxJbnRvVmlldzogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJdmFyIGJvcmRlclRvcCwgcGFkZGluZ1RvcCwgb2Zmc2V0LCBzY3JvbGwsIGVsZW1lbnRIZWlnaHQsIGl0ZW1IZWlnaHQ7CgkJaWYgKCB0aGlzLl9oYXNTY3JvbGwoKSApIHsKCQkJYm9yZGVyVG9wID0gcGFyc2VGbG9hdCggJC5jc3MoIHRoaXMuYWN0aXZlTWVudVswXSwgImJvcmRlclRvcFdpZHRoIiApICkgfHwgMDsKCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoICQuY3NzKCB0aGlzLmFjdGl2ZU1lbnVbMF0sICJwYWRkaW5nVG9wIiApICkgfHwgMDsKCQkJb2Zmc2V0ID0gaXRlbS5vZmZzZXQoKS50b3AgLSB0aGlzLmFjdGl2ZU1lbnUub2Zmc2V0KCkudG9wIC0gYm9yZGVyVG9wIC0gcGFkZGluZ1RvcDsKCQkJc2Nyb2xsID0gdGhpcy5hY3RpdmVNZW51LnNjcm9sbFRvcCgpOwoJCQllbGVtZW50SGVpZ2h0ID0gdGhpcy5hY3RpdmVNZW51LmhlaWdodCgpOwoJCQlpdGVtSGVpZ2h0ID0gaXRlbS5oZWlnaHQoKTsKCgkJCWlmICggb2Zmc2V0IDwgMCApIHsKCQkJCXRoaXMuYWN0aXZlTWVudS5zY3JvbGxUb3AoIHNjcm9sbCArIG9mZnNldCApOwoJCQl9IGVsc2UgaWYgKCBvZmZzZXQgKyBpdGVtSGVpZ2h0ID4gZWxlbWVudEhlaWdodCApIHsKCQkJCXRoaXMuYWN0aXZlTWVudS5zY3JvbGxUb3AoIHNjcm9sbCArIG9mZnNldCAtIGVsZW1lbnRIZWlnaHQgKyBpdGVtSGVpZ2h0ICk7CgkJCX0KCQl9Cgl9LAoKCWJsdXI6IGZ1bmN0aW9uKCBldmVudCwgZnJvbUZvY3VzICkgewoJCWlmICggIWZyb21Gb2N1cyApIHsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJfQoKCQlpZiAoICF0aGlzLmFjdGl2ZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5hY3RpdmUuY2hpbGRyZW4oICJhIiApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJdGhpcy5hY3RpdmUgPSBudWxsOwoKCQl0aGlzLl90cmlnZ2VyKCAiYmx1ciIsIGV2ZW50LCB7IGl0ZW06IHRoaXMuYWN0aXZlIH0gKTsKCX0sCgoJX3N0YXJ0T3BlbmluZzogZnVuY3Rpb24oIHN1Ym1lbnUgKSB7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgoJCS8vIERvbid0IG9wZW4gaWYgYWxyZWFkeSBvcGVuIGZpeGVzIGEgRmlyZWZveCBidWcgdGhhdCBjYXVzZWQgYSAuNSBwaXhlbAoJCS8vIHNoaWZ0IGluIHRoZSBzdWJtZW51IHBvc2l0aW9uIHdoZW4gbW91c2luZyBvdmVyIHRoZSBjYXJhdCBpY29uCgkJaWYgKCBzdWJtZW51LmF0dHIoICJhcmlhLWhpZGRlbiIgKSAhPT0gInRydWUiICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLnRpbWVyID0gdGhpcy5fZGVsYXkoZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2Nsb3NlKCk7CgkJCXRoaXMuX29wZW4oIHN1Ym1lbnUgKTsKCQl9LCB0aGlzLmRlbGF5ICk7Cgl9LAoKCV9vcGVuOiBmdW5jdGlvbiggc3VibWVudSApIHsKCQl2YXIgcG9zaXRpb24gPSAkLmV4dGVuZCh7CgkJCW9mOiB0aGlzLmFjdGl2ZQoJCX0sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApOwoKCQljbGVhclRpbWVvdXQoIHRoaXMudGltZXIgKTsKCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1tZW51IiApLm5vdCggc3VibWVudS5wYXJlbnRzKCAiLnVpLW1lbnUiICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCAidHJ1ZSIgKTsKCgkJc3VibWVudQoJCQkuc2hvdygpCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgInRydWUiICkKCQkJLnBvc2l0aW9uKCBwb3NpdGlvbiApOwoJfSwKCgljb2xsYXBzZUFsbDogZnVuY3Rpb24oIGV2ZW50LCBhbGwgKSB7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB3ZSB3ZXJlIHBhc3NlZCBhbiBldmVudCwgbG9vayBmb3IgdGhlIHN1Ym1lbnUgdGhhdCBjb250YWlucyB0aGUgZXZlbnQKCQkJdmFyIGN1cnJlbnRNZW51ID0gYWxsID8gdGhpcy5lbGVtZW50IDoKCQkJCSQoIGV2ZW50ICYmIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLW1lbnUiICkgKTsKCgkJCS8vIElmIHdlIGZvdW5kIG5vIHZhbGlkIHN1Ym1lbnUgYW5jZXN0b3IsIHVzZSB0aGUgbWFpbiBtZW51IHRvIGNsb3NlIGFsbCBzdWIgbWVudXMgYW55d2F5CgkJCWlmICggIWN1cnJlbnRNZW51Lmxlbmd0aCApIHsKCQkJCWN1cnJlbnRNZW51ID0gdGhpcy5lbGVtZW50OwoJCQl9CgoJCQl0aGlzLl9jbG9zZSggY3VycmVudE1lbnUgKTsKCgkJCXRoaXMuYmx1ciggZXZlbnQgKTsKCQkJdGhpcy5hY3RpdmVNZW51ID0gY3VycmVudE1lbnU7CgkJfSwgdGhpcy5kZWxheSApOwoJfSwKCgkvLyBXaXRoIG5vIGFyZ3VtZW50cywgY2xvc2VzIHRoZSBjdXJyZW50bHkgYWN0aXZlIG1lbnUgLSBpZiBub3RoaW5nIGlzIGFjdGl2ZQoJLy8gaXQgY2xvc2VzIGFsbCBtZW51cy4gIElmIHBhc3NlZCBhbiBhcmd1bWVudCwgaXQgd2lsbCBzZWFyY2ggZm9yIG1lbnVzIEJFTE9XCglfY2xvc2U6IGZ1bmN0aW9uKCBzdGFydE1lbnUgKSB7CgkJaWYgKCAhc3RhcnRNZW51ICkgewoJCQlzdGFydE1lbnUgPSB0aGlzLmFjdGl2ZSA\/IHRoaXMuYWN0aXZlLnBhcmVudCgpIDogdGhpcy5lbGVtZW50OwoJCX0KCgkJc3RhcnRNZW51CgkJCS5maW5kKCAiLnVpLW1lbnUiICkKCQkJCS5oaWRlKCkKCQkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCAidHJ1ZSIgKQoJCQkJLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgImZhbHNlIiApCgkJCS5lbmQoKQoJCQkuZmluZCggImEudWktc3RhdGUtYWN0aXZlIiApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7Cgl9LAoKCWNvbGxhcHNlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIG5ld0l0ZW0gPSB0aGlzLmFjdGl2ZSAmJgoJCQl0aGlzLmFjdGl2ZS5wYXJlbnQoKS5jbG9zZXN0KCAiLnVpLW1lbnUtaXRlbSIsIHRoaXMuZWxlbWVudCApOwoJCWlmICggbmV3SXRlbSAmJiBuZXdJdGVtLmxlbmd0aCApIHsKCQkJdGhpcy5fY2xvc2UoKTsKCQkJdGhpcy5mb2N1cyggZXZlbnQsIG5ld0l0ZW0gKTsKCQl9Cgl9LAoKCWV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBuZXdJdGVtID0gdGhpcy5hY3RpdmUgJiYKCQkJdGhpcy5hY3RpdmUKCQkJCS5jaGlsZHJlbiggIi51aS1tZW51ICIgKQoJCQkJLmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbSIgKQoJCQkJLmZpcnN0KCk7CgoJCWlmICggbmV3SXRlbSAmJiBuZXdJdGVtLmxlbmd0aCApIHsKCQkJdGhpcy5fb3BlbiggbmV3SXRlbS5wYXJlbnQoKSApOwoKCQkJLy8gRGVsYXkgc28gRmlyZWZveCB3aWxsIG5vdCBoaWRlIGFjdGl2ZWRlc2NlbmRhbnQgY2hhbmdlIGluIGV4cGFuZGluZyBzdWJtZW51IGZyb20gQVQKCQkJdGhpcy5fZGVsYXkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmZvY3VzKCBldmVudCwgbmV3SXRlbSApOwoJCQl9KTsKCQl9Cgl9LAoKCW5leHQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9tb3ZlKCAibmV4dCIsICJmaXJzdCIsIGV2ZW50ICk7Cgl9LAoKCXByZXZpb3VzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fbW92ZSggInByZXYiLCAibGFzdCIsIGV2ZW50ICk7Cgl9LAoKCWlzRmlyc3RJdGVtOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5hY3RpdmUgJiYgIXRoaXMuYWN0aXZlLnByZXZBbGwoICIudWktbWVudS1pdGVtIiApLmxlbmd0aDsKCX0sCgoJaXNMYXN0SXRlbTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYWN0aXZlICYmICF0aGlzLmFjdGl2ZS5uZXh0QWxsKCAiLnVpLW1lbnUtaXRlbSIgKS5sZW5ndGg7Cgl9LAoKCV9tb3ZlOiBmdW5jdGlvbiggZGlyZWN0aW9uLCBmaWx0ZXIsIGV2ZW50ICkgewoJCXZhciBuZXh0OwoJCWlmICggdGhpcy5hY3RpdmUgKSB7CgkJCWlmICggZGlyZWN0aW9uID09PSAiZmlyc3QiIHx8IGRpcmVjdGlvbiA9PT0gImxhc3QiICkgewoJCQkJbmV4dCA9IHRoaXMuYWN0aXZlCgkJCQkJWyBkaXJlY3Rpb24gPT09ICJmaXJzdCIgPyAicHJldkFsbCIgOiAibmV4dEFsbCIgXSggIi51aS1tZW51LWl0ZW0iICkKCQkJCQkuZXEoIC0xICk7CgkJCX0gZWxzZSB7CgkJCQluZXh0ID0gdGhpcy5hY3RpdmUKCQkJCQlbIGRpcmVjdGlvbiArICJBbGwiIF0oICIudWktbWVudS1pdGVtIiApCgkJCQkJLmVxKCAwICk7CgkJCX0KCQl9CgkJaWYgKCAhbmV4dCB8fCAhbmV4dC5sZW5ndGggfHwgIXRoaXMuYWN0aXZlICkgewoJCQluZXh0ID0gdGhpcy5hY3RpdmVNZW51LmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbSIgKVsgZmlsdGVyIF0oKTsKCQl9CgoJCXRoaXMuZm9jdXMoIGV2ZW50LCBuZXh0ICk7Cgl9LAoKCW5leHRQYWdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGl0ZW0sIGJhc2UsIGhlaWdodDsKCgkJaWYgKCAhdGhpcy5hY3RpdmUgKSB7CgkJCXRoaXMubmV4dCggZXZlbnQgKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaXNMYXN0SXRlbSgpICkgewoJCQlyZXR1cm47CgkJfQoJCWlmICggdGhpcy5faGFzU2Nyb2xsKCkgKSB7CgkJCWJhc2UgPSB0aGlzLmFjdGl2ZS5vZmZzZXQoKS50b3A7CgkJCWhlaWdodCA9IHRoaXMuZWxlbWVudC5oZWlnaHQoKTsKCQkJdGhpcy5hY3RpdmUubmV4dEFsbCggIi51aS1tZW51LWl0ZW0iICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCWl0ZW0gPSAkKCB0aGlzICk7CgkJCQlyZXR1cm4gaXRlbS5vZmZzZXQoKS50b3AgLSBiYXNlIC0gaGVpZ2h0IDwgMDsKCQkJfSk7CgoJCQl0aGlzLmZvY3VzKCBldmVudCwgaXRlbSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0aGlzLmFjdGl2ZU1lbnUuY2hpbGRyZW4oICIudWktbWVudS1pdGVtIiApCgkJCQlbICF0aGlzLmFjdGl2ZSA\/ICJmaXJzdCIgOiAibGFzdCIgXSgpICk7CgkJfQoJfSwKCglwcmV2aW91c1BhZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaXRlbSwgYmFzZSwgaGVpZ2h0OwoJCWlmICggIXRoaXMuYWN0aXZlICkgewoJCQl0aGlzLm5leHQoIGV2ZW50ICk7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLmlzRmlyc3RJdGVtKCkgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLl9oYXNTY3JvbGwoKSApIHsKCQkJYmFzZSA9IHRoaXMuYWN0aXZlLm9mZnNldCgpLnRvcDsKCQkJaGVpZ2h0ID0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoJCQl0aGlzLmFjdGl2ZS5wcmV2QWxsKCAiLnVpLW1lbnUtaXRlbSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJaXRlbSA9ICQoIHRoaXMgKTsKCQkJCXJldHVybiBpdGVtLm9mZnNldCgpLnRvcCAtIGJhc2UgKyBoZWlnaHQgPiAwOwoJCQl9KTsKCgkJCXRoaXMuZm9jdXMoIGV2ZW50LCBpdGVtICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5mb2N1cyggZXZlbnQsIHRoaXMuYWN0aXZlTWVudS5jaGlsZHJlbiggIi51aS1tZW51LWl0ZW0iICkuZmlyc3QoKSApOwoJCX0KCX0sCgoJX2hhc1Njcm9sbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIDwgdGhpcy5lbGVtZW50LnByb3AoICJzY3JvbGxIZWlnaHQiICk7Cgl9LAoKCXNlbGVjdDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIFRPRE86IEl0IHNob3VsZCBuZXZlciBiZSBwb3NzaWJsZSB0byBub3QgaGF2ZSBhbiBhY3RpdmUgaXRlbSBhdCB0aGlzCgkJLy8gcG9pbnQsIGJ1dCB0aGUgdGVzdHMgZG9uJ3QgdHJpZ2dlciBtb3VzZWVudGVyIGJlZm9yZSBjbGljay4KCQl0aGlzLmFjdGl2ZSA9IHRoaXMuYWN0aXZlIHx8ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktbWVudS1pdGVtIiApOwoJCXZhciB1aSA9IHsgaXRlbTogdGhpcy5hY3RpdmUgfTsKCQlpZiAoICF0aGlzLmFjdGl2ZS5oYXMoICIudWktbWVudSIgKS5sZW5ndGggKSB7CgkJCXRoaXMuY29sbGFwc2VBbGwoIGV2ZW50LCB0cnVlICk7CgkJfQoJCXRoaXMuX3RyaWdnZXIoICJzZWxlY3QiLCBldmVudCwgdWkgKTsKCX0KfSk7Cgp9KCBqUXVlcnkgKSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJ1aS5wcm9ncmVzc2JhciIsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJb3B0aW9uczogewoJCW1heDogMTAwLAoJCXZhbHVlOiAwLAoKCQljaGFuZ2U6IG51bGwsCgkJY29tcGxldGU6IG51bGwKCX0sCgoJbWluOiAwLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCS8vIENvbnN0cmFpbiBpbml0aWFsIHZhbHVlCgkJdGhpcy5vbGRWYWx1ZSA9IHRoaXMub3B0aW9ucy52YWx1ZSA9IHRoaXMuX2NvbnN0cmFpbmVkVmFsdWUoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXByb2dyZXNzYmFyIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIiApCgkJCS5hdHRyKHsKCQkJCS8vIE9ubHkgc2V0IHN0YXRpYyB2YWx1ZXMsIGFyaWEtdmFsdWVub3cgYW5kIGFyaWEtdmFsdWVtYXggYXJlCgkJCQkvLyBzZXQgaW5zaWRlIF9yZWZyZXNoVmFsdWUoKQoJCQkJcm9sZTogInByb2dyZXNzYmFyIiwKCQkJCSJhcmlhLXZhbHVlbWluIjogdGhpcy5taW4KCQkJfSk7CgoJCXRoaXMudmFsdWVEaXYgPSAkKCAiPGRpdiBjbGFzcz0ndWktcHJvZ3Jlc3NiYXItdmFsdWUgdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItbGVmdCc+PC9kaXY+IiApCgkJCS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLXByb2dyZXNzYmFyIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIiApCgkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtdmFsdWVtaW4iICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLXZhbHVlbWF4IiApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS12YWx1ZW5vdyIgKTsKCgkJdGhpcy52YWx1ZURpdi5yZW1vdmUoKTsKCX0sCgoJdmFsdWU6IGZ1bmN0aW9uKCBuZXdWYWx1ZSApIHsKCQlpZiAoIG5ld1ZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLm9wdGlvbnMudmFsdWU7CgkJfQoKCQl0aGlzLm9wdGlvbnMudmFsdWUgPSB0aGlzLl9jb25zdHJhaW5lZFZhbHVlKCBuZXdWYWx1ZSApOwoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJfSwKCglfY29uc3RyYWluZWRWYWx1ZTogZnVuY3Rpb24oIG5ld1ZhbHVlICkgewoJCWlmICggbmV3VmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJbmV3VmFsdWUgPSB0aGlzLm9wdGlvbnMudmFsdWU7CgkJfQoKCQl0aGlzLmluZGV0ZXJtaW5hdGUgPSBuZXdWYWx1ZSA9PT0gZmFsc2U7CgoJCS8vIHNhbml0aXplIHZhbHVlCgkJaWYgKCB0eXBlb2YgbmV3VmFsdWUgIT09ICJudW1iZXIiICkgewoJCQluZXdWYWx1ZSA9IDA7CgkJfQoKCQlyZXR1cm4gdGhpcy5pbmRldGVybWluYXRlID8gZmFsc2UgOgoJCQlNYXRoLm1pbiggdGhpcy5vcHRpb25zLm1heCwgTWF0aC5tYXgoIHRoaXMubWluLCBuZXdWYWx1ZSApICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkvLyBFbnN1cmUgInZhbHVlIiBvcHRpb24gaXMgc2V0IGFmdGVyIG90aGVyIHZhbHVlcyAobGlrZSBtYXgpCgkJdmFyIHZhbHVlID0gb3B0aW9ucy52YWx1ZTsKCQlkZWxldGUgb3B0aW9ucy52YWx1ZTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fY29uc3RyYWluZWRWYWx1ZSggdmFsdWUgKTsKCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJtYXgiICkgewoJCQkvLyBEb24ndCBhbGxvdyBhIG1heCBsZXNzIHRoYW4gbWluCgkJCXZhbHVlID0gTWF0aC5tYXgoIHRoaXMubWluLCB2YWx1ZSApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCX0sCgoJX3BlcmNlbnRhZ2U6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmluZGV0ZXJtaW5hdGUgPyAxMDAgOiAxMDAgKiAoIHRoaXMub3B0aW9ucy52YWx1ZSAtIHRoaXMubWluICkgLyAoIHRoaXMub3B0aW9ucy5tYXggLSB0aGlzLm1pbiApOwoJfSwKCglfcmVmcmVzaFZhbHVlOiBmdW5jdGlvbigpIHsKCQl2YXIgdmFsdWUgPSB0aGlzLm9wdGlvbnMudmFsdWUsCgkJCXBlcmNlbnRhZ2UgPSB0aGlzLl9wZXJjZW50YWdlKCk7CgoJCXRoaXMudmFsdWVEaXYKCQkJLnRvZ2dsZSggdGhpcy5pbmRldGVybWluYXRlIHx8IHZhbHVlID4gdGhpcy5taW4gKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItcmlnaHQiLCB2YWx1ZSA9PT0gdGhpcy5vcHRpb25zLm1heCApCgkJCS53aWR0aCggcGVyY2VudGFnZS50b0ZpeGVkKDApICsgIiUiICk7CgoJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXByb2dyZXNzYmFyLWluZGV0ZXJtaW5hdGUiLCB0aGlzLmluZGV0ZXJtaW5hdGUgKTsKCgkJaWYgKCB0aGlzLmluZGV0ZXJtaW5hdGUgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVBdHRyKCAiYXJpYS12YWx1ZW5vdyIgKTsKCQkJaWYgKCAhdGhpcy5vdmVybGF5RGl2ICkgewoJCQkJdGhpcy5vdmVybGF5RGl2ID0gJCggIjxkaXYgY2xhc3M9J3VpLXByb2dyZXNzYmFyLW92ZXJsYXknPjwvZGl2PiIgKS5hcHBlbmRUbyggdGhpcy52YWx1ZURpdiApOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoewoJCQkJImFyaWEtdmFsdWVtYXgiOiB0aGlzLm9wdGlvbnMubWF4LAoJCQkJImFyaWEtdmFsdWVub3ciOiB2YWx1ZQoJCQl9KTsKCQkJaWYgKCB0aGlzLm92ZXJsYXlEaXYgKSB7CgkJCQl0aGlzLm92ZXJsYXlEaXYucmVtb3ZlKCk7CgkJCQl0aGlzLm92ZXJsYXlEaXYgPSBudWxsOwoJCQl9CgkJfQoKCQlpZiAoIHRoaXMub2xkVmFsdWUgIT09IHZhbHVlICkgewoJCQl0aGlzLm9sZFZhbHVlID0gdmFsdWU7CgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiICk7CgkJfQoJCWlmICggdmFsdWUgPT09IHRoaXMub3B0aW9ucy5tYXggKSB7CgkJCXRoaXMuX3RyaWdnZXIoICJjb21wbGV0ZSIgKTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIG51bWJlciBvZiBwYWdlcyBpbiBhIHNsaWRlcgovLyAoaG93IG1hbnkgdGltZXMgY2FuIHlvdSBwYWdlIHVwL2Rvd24gdG8gZ28gdGhyb3VnaCB0aGUgd2hvbGUgcmFuZ2UpCnZhciBudW1QYWdlcyA9IDU7CgokLndpZGdldCggInVpLnNsaWRlciIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCWFuaW1hdGU6IGZhbHNlLAoJCWRpc3RhbmNlOiAwLAoJCW1heDogMTAwLAoJCW1pbjogMCwKCQlvcmllbnRhdGlvbjogImhvcml6b250YWwiLAoJCXJhbmdlOiBmYWxzZSwKCQlzdGVwOiAxLAoJCXZhbHVlOiAwLAoJCXZhbHVlczogbnVsbCwKCgkJLy8gY2FsbGJhY2tzCgkJY2hhbmdlOiBudWxsLAoJCXNsaWRlOiBudWxsLAoJCXN0YXJ0OiBudWxsLAoJCXN0b3A6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCXRoaXMuX21vdXNlU2xpZGluZyA9IGZhbHNlOwoJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOwoJCXRoaXMuX2hhbmRsZUluZGV4ID0gbnVsbDsKCQl0aGlzLl9kZXRlY3RPcmllbnRhdGlvbigpOwoJCXRoaXMuX21vdXNlSW5pdCgpOwoKCQl0aGlzLmVsZW1lbnQKCQkJLmFkZENsYXNzKCAidWktc2xpZGVyIiArCgkJCQkiIHVpLXNsaWRlci0iICsgdGhpcy5vcmllbnRhdGlvbiArCgkJCQkiIHVpLXdpZGdldCIgKwoJCQkJIiB1aS13aWRnZXQtY29udGVudCIgKwoJCQkJIiB1aS1jb3JuZXItYWxsIik7CgoJCXRoaXMuX3JlZnJlc2goKTsKCQl0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApOwoKCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9jcmVhdGVSYW5nZSgpOwoJCXRoaXMuX2NyZWF0ZUhhbmRsZXMoKTsKCQl0aGlzLl9zZXR1cEV2ZW50cygpOwoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJfSwKCglfY3JlYXRlSGFuZGxlczogZnVuY3Rpb24oKSB7CgkJdmFyIGksIGhhbmRsZUNvdW50LAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlleGlzdGluZ0hhbmRsZXMgPSB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1zbGlkZXItaGFuZGxlIiApLmFkZENsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItYWxsIiApLAoJCQloYW5kbGUgPSAiPGEgY2xhc3M9J3VpLXNsaWRlci1oYW5kbGUgdWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItYWxsJyBocmVmPScjJz48L2E+IiwKCQkJaGFuZGxlcyA9IFtdOwoKCQloYW5kbGVDb3VudCA9ICggb3B0aW9ucy52YWx1ZXMgJiYgb3B0aW9ucy52YWx1ZXMubGVuZ3RoICkgfHwgMTsKCgkJaWYgKCBleGlzdGluZ0hhbmRsZXMubGVuZ3RoID4gaGFuZGxlQ291bnQgKSB7CgkJCWV4aXN0aW5nSGFuZGxlcy5zbGljZSggaGFuZGxlQ291bnQgKS5yZW1vdmUoKTsKCQkJZXhpc3RpbmdIYW5kbGVzID0gZXhpc3RpbmdIYW5kbGVzLnNsaWNlKCAwLCBoYW5kbGVDb3VudCApOwoJCX0KCgkJZm9yICggaSA9IGV4aXN0aW5nSGFuZGxlcy5sZW5ndGg7IGkgPCBoYW5kbGVDb3VudDsgaSsrICkgewoJCQloYW5kbGVzLnB1c2goIGhhbmRsZSApOwoJCX0KCgkJdGhpcy5oYW5kbGVzID0gZXhpc3RpbmdIYW5kbGVzLmFkZCggJCggaGFuZGxlcy5qb2luKCAiIiApICkuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApICk7CgoJCXRoaXMuaGFuZGxlID0gdGhpcy5oYW5kbGVzLmVxKCAwICk7CgoJCXRoaXMuaGFuZGxlcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkkKCB0aGlzICkuZGF0YSggInVpLXNsaWRlci1oYW5kbGUtaW5kZXgiLCBpICk7CgkJfSk7Cgl9LAoKCV9jcmVhdGVSYW5nZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWNsYXNzZXMgPSAiIjsKCgkJaWYgKCBvcHRpb25zLnJhbmdlICkgewoJCQlpZiAoIG9wdGlvbnMucmFuZ2UgPT09IHRydWUgKSB7CgkJCQlpZiAoICFvcHRpb25zLnZhbHVlcyApIHsKCQkJCQlvcHRpb25zLnZhbHVlcyA9IFsgdGhpcy5fdmFsdWVNaW4oKSwgdGhpcy5fdmFsdWVNaW4oKSBdOwoJCQkJfSBlbHNlIGlmICggb3B0aW9ucy52YWx1ZXMubGVuZ3RoICYmIG9wdGlvbnMudmFsdWVzLmxlbmd0aCAhPT0gMiApIHsKCQkJCQlvcHRpb25zLnZhbHVlcyA9IFsgb3B0aW9ucy52YWx1ZXNbMF0sIG9wdGlvbnMudmFsdWVzWzBdIF07CgkJCQl9IGVsc2UgaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMudmFsdWVzICkgKSB7CgkJCQkJb3B0aW9ucy52YWx1ZXMgPSBvcHRpb25zLnZhbHVlcy5zbGljZSgwKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCAhdGhpcy5yYW5nZSB8fCAhdGhpcy5yYW5nZS5sZW5ndGggKSB7CgkJCQl0aGlzLnJhbmdlID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCQkJLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCgkJCQljbGFzc2VzID0gInVpLXNsaWRlci1yYW5nZSIgKwoJCQkJLy8gbm90ZTogdGhpcyBpc24ndCB0aGUgbW9zdCBmaXR0aW5nbHkgc2VtYW50aWMgZnJhbWV3b3JrIGNsYXNzIGZvciB0aGlzIGVsZW1lbnQsCgkJCQkvLyBidXQgd29ya2VkIGJlc3QgdmlzdWFsbHkgd2l0aCBhIHZhcmlldHkgb2YgdGhlbWVzCgkJCQkiIHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCI7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLnJhbmdlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLXJhbmdlLW1pbiB1aS1zbGlkZXItcmFuZ2UtbWF4IiApCgkJCQkJLy8gSGFuZGxlIHJhbmdlIHN3aXRjaGluZyBmcm9tIHRydWUgdG8gbWluL21heAoJCQkJCS5jc3MoewoJCQkJCQkibGVmdCI6ICIiLAoJCQkJCQkiYm90dG9tIjogIiIKCQkJCQl9KTsKCQkJfQoKCQkJdGhpcy5yYW5nZS5hZGRDbGFzcyggY2xhc3NlcyArCgkJCQkoICggb3B0aW9ucy5yYW5nZSA9PT0gIm1pbiIgfHwgb3B0aW9ucy5yYW5nZSA9PT0gIm1heCIgKSA\/ICIgdWktc2xpZGVyLXJhbmdlLSIgKyBvcHRpb25zLnJhbmdlIDogIiIgKSApOwoJCX0gZWxzZSB7CgkJCXRoaXMucmFuZ2UgPSAkKFtdKTsKCQl9Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnRzID0gdGhpcy5oYW5kbGVzLmFkZCggdGhpcy5yYW5nZSApLmZpbHRlciggImEiICk7CgkJdGhpcy5fb2ZmKCBlbGVtZW50cyApOwoJCXRoaXMuX29uKCBlbGVtZW50cywgdGhpcy5faGFuZGxlRXZlbnRzICk7CgkJdGhpcy5faG92ZXJhYmxlKCBlbGVtZW50cyApOwoJCXRoaXMuX2ZvY3VzYWJsZSggZWxlbWVudHMgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGFuZGxlcy5yZW1vdmUoKTsKCQl0aGlzLnJhbmdlLnJlbW92ZSgpOwoKCQl0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyIiArCgkJCQkiIHVpLXNsaWRlci1ob3Jpem9udGFsIiArCgkJCQkiIHVpLXNsaWRlci12ZXJ0aWNhbCIgKwoJCQkJIiB1aS13aWRnZXQiICsKCQkJCSIgdWktd2lkZ2V0LWNvbnRlbnQiICsKCQkJCSIgdWktY29ybmVyLWFsbCIgKTsKCgkJdGhpcy5fbW91c2VEZXN0cm95KCk7Cgl9LAoKCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgcG9zaXRpb24sIG5vcm1WYWx1ZSwgZGlzdGFuY2UsIGNsb3Nlc3RIYW5kbGUsIGluZGV4LCBhbGxvd2VkLCBvZmZzZXQsIG1vdXNlT3ZlckhhbmRsZSwKCQkJdGhhdCA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5kaXNhYmxlZCApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5lbGVtZW50U2l6ZSA9IHsKCQkJd2lkdGg6IHRoaXMuZWxlbWVudC5vdXRlcldpZHRoKCksCgkJCWhlaWdodDogdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkKCQl9OwoJCXRoaXMuZWxlbWVudE9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJcG9zaXRpb24gPSB7IHg6IGV2ZW50LnBhZ2VYLCB5OiBldmVudC5wYWdlWSB9OwoJCW5vcm1WYWx1ZSA9IHRoaXMuX25vcm1WYWx1ZUZyb21Nb3VzZSggcG9zaXRpb24gKTsKCQlkaXN0YW5jZSA9IHRoaXMuX3ZhbHVlTWF4KCkgLSB0aGlzLl92YWx1ZU1pbigpICsgMTsKCQl0aGlzLmhhbmRsZXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJdmFyIHRoaXNEaXN0YW5jZSA9IE1hdGguYWJzKCBub3JtVmFsdWUgLSB0aGF0LnZhbHVlcyhpKSApOwoJCQlpZiAoKCBkaXN0YW5jZSA+IHRoaXNEaXN0YW5jZSApIHx8CgkJCQkoIGRpc3RhbmNlID09PSB0aGlzRGlzdGFuY2UgJiYKCQkJCQkoaSA9PT0gdGhhdC5fbGFzdENoYW5nZWRWYWx1ZSB8fCB0aGF0LnZhbHVlcyhpKSA9PT0gby5taW4gKSkpIHsKCQkJCWRpc3RhbmNlID0gdGhpc0Rpc3RhbmNlOwoJCQkJY2xvc2VzdEhhbmRsZSA9ICQoIHRoaXMgKTsKCQkJCWluZGV4ID0gaTsKCQkJfQoJCX0pOwoKCQlhbGxvd2VkID0gdGhpcy5fc3RhcnQoIGV2ZW50LCBpbmRleCApOwoJCWlmICggYWxsb3dlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5fbW91c2VTbGlkaW5nID0gdHJ1ZTsKCgkJdGhpcy5faGFuZGxlSW5kZXggPSBpbmRleDsKCgkJY2xvc2VzdEhhbmRsZQoJCQkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICkKCQkJLmZvY3VzKCk7CgoJCW9mZnNldCA9IGNsb3Nlc3RIYW5kbGUub2Zmc2V0KCk7CgkJbW91c2VPdmVySGFuZGxlID0gISQoIGV2ZW50LnRhcmdldCApLnBhcmVudHMoKS5hZGRCYWNrKCkuaXMoICIudWktc2xpZGVyLWhhbmRsZSIgKTsKCQl0aGlzLl9jbGlja09mZnNldCA9IG1vdXNlT3ZlckhhbmRsZSA\/IHsgbGVmdDogMCwgdG9wOiAwIH0gOiB7CgkJCWxlZnQ6IGV2ZW50LnBhZ2VYIC0gb2Zmc2V0LmxlZnQgLSAoIGNsb3Nlc3RIYW5kbGUud2lkdGgoKSAvIDIgKSwKCQkJdG9wOiBldmVudC5wYWdlWSAtIG9mZnNldC50b3AgLQoJCQkJKCBjbG9zZXN0SGFuZGxlLmhlaWdodCgpIC8gMiApIC0KCQkJCSggcGFyc2VJbnQoIGNsb3Nlc3RIYW5kbGUuY3NzKCJib3JkZXJUb3BXaWR0aCIpLCAxMCApIHx8IDAgKSAtCgkJCQkoIHBhcnNlSW50KCBjbG9zZXN0SGFuZGxlLmNzcygiYm9yZGVyQm90dG9tV2lkdGgiKSwgMTAgKSB8fCAwKSArCgkJCQkoIHBhcnNlSW50KCBjbG9zZXN0SGFuZGxlLmNzcygibWFyZ2luVG9wIiksIDEwICkgfHwgMCkKCQl9OwoKCQlpZiAoICF0aGlzLmhhbmRsZXMuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKSApIHsKCQkJdGhpcy5fc2xpZGUoIGV2ZW50LCBpbmRleCwgbm9ybVZhbHVlICk7CgkJfQoJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOwoJCXJldHVybiB0cnVlOwoJfSwKCglfbW91c2VTdGFydDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZURyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgcG9zaXRpb24gPSB7IHg6IGV2ZW50LnBhZ2VYLCB5OiBldmVudC5wYWdlWSB9LAoJCQlub3JtVmFsdWUgPSB0aGlzLl9ub3JtVmFsdWVGcm9tTW91c2UoIHBvc2l0aW9uICk7CgoJCXRoaXMuX3NsaWRlKCBldmVudCwgdGhpcy5faGFuZGxlSW5kZXgsIG5vcm1WYWx1ZSApOwoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLmhhbmRsZXMucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJdGhpcy5fbW91c2VTbGlkaW5nID0gZmFsc2U7CgoJCXRoaXMuX3N0b3AoIGV2ZW50LCB0aGlzLl9oYW5kbGVJbmRleCApOwoJCXRoaXMuX2NoYW5nZSggZXZlbnQsIHRoaXMuX2hhbmRsZUluZGV4ICk7CgoJCXRoaXMuX2hhbmRsZUluZGV4ID0gbnVsbDsKCQl0aGlzLl9jbGlja09mZnNldCA9IG51bGw7CgkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOwoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9kZXRlY3RPcmllbnRhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5vcmllbnRhdGlvbiA9ICggdGhpcy5vcHRpb25zLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgPyAidmVydGljYWwiIDogImhvcml6b250YWwiOwoJfSwKCglfbm9ybVZhbHVlRnJvbU1vdXNlOiBmdW5jdGlvbiggcG9zaXRpb24gKSB7CgkJdmFyIHBpeGVsVG90YWwsCgkJCXBpeGVsTW91c2UsCgkJCXBlcmNlbnRNb3VzZSwKCQkJdmFsdWVUb3RhbCwKCQkJdmFsdWVNb3VzZTsKCgkJaWYgKCB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7CgkJCXBpeGVsVG90YWwgPSB0aGlzLmVsZW1lbnRTaXplLndpZHRoOwoJCQlwaXhlbE1vdXNlID0gcG9zaXRpb24ueCAtIHRoaXMuZWxlbWVudE9mZnNldC5sZWZ0IC0gKCB0aGlzLl9jbGlja09mZnNldCA\/IHRoaXMuX2NsaWNrT2Zmc2V0LmxlZnQgOiAwICk7CgkJfSBlbHNlIHsKCQkJcGl4ZWxUb3RhbCA9IHRoaXMuZWxlbWVudFNpemUuaGVpZ2h0OwoJCQlwaXhlbE1vdXNlID0gcG9zaXRpb24ueSAtIHRoaXMuZWxlbWVudE9mZnNldC50b3AgLSAoIHRoaXMuX2NsaWNrT2Zmc2V0ID8gdGhpcy5fY2xpY2tPZmZzZXQudG9wIDogMCApOwoJCX0KCgkJcGVyY2VudE1vdXNlID0gKCBwaXhlbE1vdXNlIC8gcGl4ZWxUb3RhbCApOwoJCWlmICggcGVyY2VudE1vdXNlID4gMSApIHsKCQkJcGVyY2VudE1vdXNlID0gMTsKCQl9CgkJaWYgKCBwZXJjZW50TW91c2UgPCAwICkgewoJCQlwZXJjZW50TW91c2UgPSAwOwoJCX0KCQlpZiAoIHRoaXMub3JpZW50YXRpb24gPT09ICJ2ZXJ0aWNhbCIgKSB7CgkJCXBlcmNlbnRNb3VzZSA9IDEgLSBwZXJjZW50TW91c2U7CgkJfQoKCQl2YWx1ZVRvdGFsID0gdGhpcy5fdmFsdWVNYXgoKSAtIHRoaXMuX3ZhbHVlTWluKCk7CgkJdmFsdWVNb3VzZSA9IHRoaXMuX3ZhbHVlTWluKCkgKyBwZXJjZW50TW91c2UgKiB2YWx1ZVRvdGFsOwoKCQlyZXR1cm4gdGhpcy5fdHJpbUFsaWduVmFsdWUoIHZhbHVlTW91c2UgKTsKCX0sCgoJX3N0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIGluZGV4ICkgewoJCXZhciB1aUhhc2ggPSB7CgkJCWhhbmRsZTogdGhpcy5oYW5kbGVzWyBpbmRleCBdLAoJCQl2YWx1ZTogdGhpcy52YWx1ZSgpCgkJfTsKCQlpZiAoIHRoaXMub3B0aW9ucy52YWx1ZXMgJiYgdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGggKSB7CgkJCXVpSGFzaC52YWx1ZSA9IHRoaXMudmFsdWVzKCBpbmRleCApOwoJCQl1aUhhc2gudmFsdWVzID0gdGhpcy52YWx1ZXMoKTsKCQl9CgkJcmV0dXJuIHRoaXMuX3RyaWdnZXIoICJzdGFydCIsIGV2ZW50LCB1aUhhc2ggKTsKCX0sCgoJX3NsaWRlOiBmdW5jdGlvbiggZXZlbnQsIGluZGV4LCBuZXdWYWwgKSB7CgkJdmFyIG90aGVyVmFsLAoJCQluZXdWYWx1ZXMsCgkJCWFsbG93ZWQ7CgoJCWlmICggdGhpcy5vcHRpb25zLnZhbHVlcyAmJiB0aGlzLm9wdGlvbnMudmFsdWVzLmxlbmd0aCApIHsKCQkJb3RoZXJWYWwgPSB0aGlzLnZhbHVlcyggaW5kZXggPyAwIDogMSApOwoKCQkJaWYgKCAoIHRoaXMub3B0aW9ucy52YWx1ZXMubGVuZ3RoID09PSAyICYmIHRoaXMub3B0aW9ucy5yYW5nZSA9PT0gdHJ1ZSApICYmCgkJCQkJKCAoIGluZGV4ID09PSAwICYmIG5ld1ZhbCA+IG90aGVyVmFsKSB8fCAoIGluZGV4ID09PSAxICYmIG5ld1ZhbCA8IG90aGVyVmFsICkgKQoJCQkJKSB7CgkJCQluZXdWYWwgPSBvdGhlclZhbDsKCQkJfQoKCQkJaWYgKCBuZXdWYWwgIT09IHRoaXMudmFsdWVzKCBpbmRleCApICkgewoJCQkJbmV3VmFsdWVzID0gdGhpcy52YWx1ZXMoKTsKCQkJCW5ld1ZhbHVlc1sgaW5kZXggXSA9IG5ld1ZhbDsKCQkJCS8vIEEgc2xpZGUgY2FuIGJlIGNhbmNlbGVkIGJ5IHJldHVybmluZyBmYWxzZSBmcm9tIHRoZSBzbGlkZSBjYWxsYmFjawoJCQkJYWxsb3dlZCA9IHRoaXMuX3RyaWdnZXIoICJzbGlkZSIsIGV2ZW50LCB7CgkJCQkJaGFuZGxlOiB0aGlzLmhhbmRsZXNbIGluZGV4IF0sCgkJCQkJdmFsdWU6IG5ld1ZhbCwKCQkJCQl2YWx1ZXM6IG5ld1ZhbHVlcwoJCQkJfSApOwoJCQkJb3RoZXJWYWwgPSB0aGlzLnZhbHVlcyggaW5kZXggPyAwIDogMSApOwoJCQkJaWYgKCBhbGxvd2VkICE9PSBmYWxzZSApIHsKCQkJCQl0aGlzLnZhbHVlcyggaW5kZXgsIG5ld1ZhbCwgdHJ1ZSApOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCBuZXdWYWwgIT09IHRoaXMudmFsdWUoKSApIHsKCQkJCS8vIEEgc2xpZGUgY2FuIGJlIGNhbmNlbGVkIGJ5IHJldHVybmluZyBmYWxzZSBmcm9tIHRoZSBzbGlkZSBjYWxsYmFjawoJCQkJYWxsb3dlZCA9IHRoaXMuX3RyaWdnZXIoICJzbGlkZSIsIGV2ZW50LCB7CgkJCQkJaGFuZGxlOiB0aGlzLmhhbmRsZXNbIGluZGV4IF0sCgkJCQkJdmFsdWU6IG5ld1ZhbAoJCQkJfSApOwoJCQkJaWYgKCBhbGxvd2VkICE9PSBmYWxzZSApIHsKCQkJCQl0aGlzLnZhbHVlKCBuZXdWYWwgKTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJX3N0b3A6IGZ1bmN0aW9uKCBldmVudCwgaW5kZXggKSB7CgkJdmFyIHVpSGFzaCA9IHsKCQkJaGFuZGxlOiB0aGlzLmhhbmRsZXNbIGluZGV4IF0sCgkJCXZhbHVlOiB0aGlzLnZhbHVlKCkKCQl9OwoJCWlmICggdGhpcy5vcHRpb25zLnZhbHVlcyAmJiB0aGlzLm9wdGlvbnMudmFsdWVzLmxlbmd0aCApIHsKCQkJdWlIYXNoLnZhbHVlID0gdGhpcy52YWx1ZXMoIGluZGV4ICk7CgkJCXVpSGFzaC52YWx1ZXMgPSB0aGlzLnZhbHVlcygpOwoJCX0KCgkJdGhpcy5fdHJpZ2dlciggInN0b3AiLCBldmVudCwgdWlIYXNoICk7Cgl9LAoKCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCwgaW5kZXggKSB7CgkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyAmJiAhdGhpcy5fbW91c2VTbGlkaW5nICkgewoJCQl2YXIgdWlIYXNoID0gewoJCQkJaGFuZGxlOiB0aGlzLmhhbmRsZXNbIGluZGV4IF0sCgkJCQl2YWx1ZTogdGhpcy52YWx1ZSgpCgkJCX07CgkJCWlmICggdGhpcy5vcHRpb25zLnZhbHVlcyAmJiB0aGlzLm9wdGlvbnMudmFsdWVzLmxlbmd0aCApIHsKCQkJCXVpSGFzaC52YWx1ZSA9IHRoaXMudmFsdWVzKCBpbmRleCApOwoJCQkJdWlIYXNoLnZhbHVlcyA9IHRoaXMudmFsdWVzKCk7CgkJCX0KCgkJCS8vc3RvcmUgdGhlIGxhc3QgY2hhbmdlZCB2YWx1ZSBpbmRleCBmb3IgcmVmZXJlbmNlIHdoZW4gaGFuZGxlcyBvdmVybGFwCgkJCXRoaXMuX2xhc3RDaGFuZ2VkVmFsdWUgPSBpbmRleDsKCgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiLCBldmVudCwgdWlIYXNoICk7CgkJfQoJfSwKCgl2YWx1ZTogZnVuY3Rpb24oIG5ld1ZhbHVlICkgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIG5ld1ZhbHVlICk7CgkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQl0aGlzLl9jaGFuZ2UoIG51bGwsIDAgKTsKCQkJcmV0dXJuOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3ZhbHVlKCk7Cgl9LAoKCXZhbHVlczogZnVuY3Rpb24oIGluZGV4LCBuZXdWYWx1ZSApIHsKCQl2YXIgdmFscywKCQkJbmV3VmFsdWVzLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPiAxICkgewoJCQl0aGlzLm9wdGlvbnMudmFsdWVzWyBpbmRleCBdID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIG5ld1ZhbHVlICk7CgkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQl0aGlzLl9jaGFuZ2UoIG51bGwsIGluZGV4ICk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJaWYgKCAkLmlzQXJyYXkoIGFyZ3VtZW50c1sgMCBdICkgKSB7CgkJCQl2YWxzID0gdGhpcy5vcHRpb25zLnZhbHVlczsKCQkJCW5ld1ZhbHVlcyA9IGFyZ3VtZW50c1sgMCBdOwoJCQkJZm9yICggaSA9IDA7IGkgPCB2YWxzLmxlbmd0aDsgaSArPSAxICkgewoJCQkJCXZhbHNbIGkgXSA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCBuZXdWYWx1ZXNbIGkgXSApOwoJCQkJCXRoaXMuX2NoYW5nZSggbnVsbCwgaSApOwoJCQkJfQoJCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy52YWx1ZXMgJiYgdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGggKSB7CgkJCQkJcmV0dXJuIHRoaXMuX3ZhbHVlcyggaW5kZXggKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIHRoaXMudmFsdWUoKTsKCQkJCX0KCQkJfQoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLl92YWx1ZXMoKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBpLAoJCQl2YWxzTGVuZ3RoID0gMDsKCgkJaWYgKCBrZXkgPT09ICJyYW5nZSIgJiYgdGhpcy5vcHRpb25zLnJhbmdlID09PSB0cnVlICkgewoJCQlpZiAoIHZhbHVlID09PSAibWluIiApIHsKCQkJCXRoaXMub3B0aW9ucy52YWx1ZSA9IHRoaXMuX3ZhbHVlcyggMCApOwoJCQkJdGhpcy5vcHRpb25zLnZhbHVlcyA9IG51bGw7CgkJCX0gZWxzZSBpZiAoIHZhbHVlID09PSAibWF4IiApIHsKCQkJCXRoaXMub3B0aW9ucy52YWx1ZSA9IHRoaXMuX3ZhbHVlcyggdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGgtMSApOwoJCQkJdGhpcy5vcHRpb25zLnZhbHVlcyA9IG51bGw7CgkJCX0KCQl9CgoJCWlmICggJC5pc0FycmF5KCB0aGlzLm9wdGlvbnMudmFsdWVzICkgKSB7CgkJCXZhbHNMZW5ndGggPSB0aGlzLm9wdGlvbnMudmFsdWVzLmxlbmd0aDsKCQl9CgoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fc2V0T3B0aW9uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJc3dpdGNoICgga2V5ICkgewoJCQljYXNlICJvcmllbnRhdGlvbiI6CgkJCQl0aGlzLl9kZXRlY3RPcmllbnRhdGlvbigpOwoJCQkJdGhpcy5lbGVtZW50CgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhvcml6b250YWwgdWktc2xpZGVyLXZlcnRpY2FsIiApCgkJCQkJLmFkZENsYXNzKCAidWktc2xpZGVyLSIgKyB0aGlzLm9yaWVudGF0aW9uICk7CgkJCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCQkJCWJyZWFrOwoJCQljYXNlICJ2YWx1ZSI6CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gdHJ1ZTsKCQkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQkJdGhpcy5fY2hhbmdlKCBudWxsLCAwICk7CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7CgkJCQlicmVhazsKCQkJY2FzZSAidmFsdWVzIjoKCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOwoJCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHZhbHNMZW5ndGg7IGkgKz0gMSApIHsKCQkJCQl0aGlzLl9jaGFuZ2UoIG51bGwsIGkgKTsKCQkJCX0KCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSBmYWxzZTsKCQkJCWJyZWFrOwoJCQljYXNlICJtaW4iOgoJCQljYXNlICJtYXgiOgoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7CgkJCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSBmYWxzZTsKCQkJCWJyZWFrOwoJCQljYXNlICJyYW5nZSI6CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gdHJ1ZTsKCQkJCXRoaXMuX3JlZnJlc2goKTsKCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSBmYWxzZTsKCQkJCWJyZWFrOwoJCX0KCX0sCgoJLy9pbnRlcm5hbCB2YWx1ZSBnZXR0ZXIKCS8vIF92YWx1ZSgpIHJldHVybnMgdmFsdWUgdHJpbW1lZCBieSBtaW4gYW5kIG1heCwgYWxpZ25lZCBieSBzdGVwCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwgPSB0aGlzLm9wdGlvbnMudmFsdWU7CgkJdmFsID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIHZhbCApOwoKCQlyZXR1cm4gdmFsOwoJfSwKCgkvL2ludGVybmFsIHZhbHVlcyBnZXR0ZXIKCS8vIF92YWx1ZXMoKSByZXR1cm5zIGFycmF5IG9mIHZhbHVlcyB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4LCBhbGlnbmVkIGJ5IHN0ZXAKCS8vIF92YWx1ZXMoIGluZGV4ICkgcmV0dXJucyBzaW5nbGUgdmFsdWUgdHJpbW1lZCBieSBtaW4gYW5kIG1heCwgYWxpZ25lZCBieSBzdGVwCglfdmFsdWVzOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIHZhbCwKCQkJdmFscywKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl2YWwgPSB0aGlzLm9wdGlvbnMudmFsdWVzWyBpbmRleCBdOwoJCQl2YWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsICk7CgoJCQlyZXR1cm4gdmFsOwoJCX0gZWxzZSBpZiAoIHRoaXMub3B0aW9ucy52YWx1ZXMgJiYgdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGggKSB7CgkJCS8vIC5zbGljZSgpIGNyZWF0ZXMgYSBjb3B5IG9mIHRoZSBhcnJheQoJCQkvLyB0aGlzIGNvcHkgZ2V0cyB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4IGFuZCB0aGVuIHJldHVybmVkCgkJCXZhbHMgPSB0aGlzLm9wdGlvbnMudmFsdWVzLnNsaWNlKCk7CgkJCWZvciAoIGkgPSAwOyBpIDwgdmFscy5sZW5ndGg7IGkrPSAxKSB7CgkJCQl2YWxzWyBpIF0gPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsc1sgaSBdICk7CgkJCX0KCgkJCXJldHVybiB2YWxzOwoJCX0gZWxzZSB7CgkJCXJldHVybiBbXTsKCQl9Cgl9LAoKCS8vIHJldHVybnMgdGhlIHN0ZXAtYWxpZ25lZCB2YWx1ZSB0aGF0IHZhbCBpcyBjbG9zZXN0IHRvLCBiZXR3ZWVuIChpbmNsdXNpdmUpIG1pbiBhbmQgbWF4CglfdHJpbUFsaWduVmFsdWU6IGZ1bmN0aW9uKCB2YWwgKSB7CgkJaWYgKCB2YWwgPD0gdGhpcy5fdmFsdWVNaW4oKSApIHsKCQkJcmV0dXJuIHRoaXMuX3ZhbHVlTWluKCk7CgkJfQoJCWlmICggdmFsID49IHRoaXMuX3ZhbHVlTWF4KCkgKSB7CgkJCXJldHVybiB0aGlzLl92YWx1ZU1heCgpOwoJCX0KCQl2YXIgc3RlcCA9ICggdGhpcy5vcHRpb25zLnN0ZXAgPiAwICkgPyB0aGlzLm9wdGlvbnMuc3RlcCA6IDEsCgkJCXZhbE1vZFN0ZXAgPSAodmFsIC0gdGhpcy5fdmFsdWVNaW4oKSkgJSBzdGVwLAoJCQlhbGlnblZhbHVlID0gdmFsIC0gdmFsTW9kU3RlcDsKCgkJaWYgKCBNYXRoLmFicyh2YWxNb2RTdGVwKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgIzQxMjQpCgkJcmV0dXJuIHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoJfSwKCglfdmFsdWVNaW46IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubWluOwoJfSwKCglfdmFsdWVNYXg6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubWF4OwoJfSwKCglfcmVmcmVzaFZhbHVlOiBmdW5jdGlvbigpIHsKCQl2YXIgbGFzdFZhbFBlcmNlbnQsIHZhbFBlcmNlbnQsIHZhbHVlLCB2YWx1ZU1pbiwgdmFsdWVNYXgsCgkJCW9SYW5nZSA9IHRoaXMub3B0aW9ucy5yYW5nZSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhhdCA9IHRoaXMsCgkJCWFuaW1hdGUgPSAoICF0aGlzLl9hbmltYXRlT2ZmICkgPyBvLmFuaW1hdGUgOiBmYWxzZSwKCQkJX3NldCA9IHt9OwoKCQlpZiAoIHRoaXMub3B0aW9ucy52YWx1ZXMgJiYgdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGggKSB7CgkJCXRoaXMuaGFuZGxlcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJdmFsUGVyY2VudCA9ICggdGhhdC52YWx1ZXMoaSkgLSB0aGF0Ll92YWx1ZU1pbigpICkgLyAoIHRoYXQuX3ZhbHVlTWF4KCkgLSB0aGF0Ll92YWx1ZU1pbigpICkgKiAxMDA7CgkJCQlfc2V0WyB0aGF0Lm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgPyAibGVmdCIgOiAiYm90dG9tIiBdID0gdmFsUGVyY2VudCArICIlIjsKCQkJCSQoIHRoaXMgKS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCBfc2V0LCBvLmFuaW1hdGUgKTsKCQkJCWlmICggdGhhdC5vcHRpb25zLnJhbmdlID09PSB0cnVlICkgewoJCQkJCWlmICggdGhhdC5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiICkgewoJCQkJCQlpZiAoIGkgPT09IDAgKSB7CgkJCQkJCQl0aGF0LnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA\/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsgbGVmdDogdmFsUGVyY2VudCArICIlIiB9LCBvLmFuaW1hdGUgKTsKCQkJCQkJfQoJCQkJCQlpZiAoIGkgPT09IDEgKSB7CgkJCQkJCQl0aGF0LnJhbmdlWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggeyB3aWR0aDogKCB2YWxQZXJjZW50IC0gbGFzdFZhbFBlcmNlbnQgKSArICIlIiB9LCB7IHF1ZXVlOiBmYWxzZSwgZHVyYXRpb246IG8uYW5pbWF0ZSB9ICk7CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAoIGkgPT09IDAgKSB7CgkJCQkJCQl0aGF0LnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA\/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsgYm90dG9tOiAoIHZhbFBlcmNlbnQgKSArICIlIiB9LCBvLmFuaW1hdGUgKTsKCQkJCQkJfQoJCQkJCQlpZiAoIGkgPT09IDEgKSB7CgkJCQkJCQl0aGF0LnJhbmdlWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggeyBoZWlnaHQ6ICggdmFsUGVyY2VudCAtIGxhc3RWYWxQZXJjZW50ICkgKyAiJSIgfSwgeyBxdWV1ZTogZmFsc2UsIGR1cmF0aW9uOiBvLmFuaW1hdGUgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJbGFzdFZhbFBlcmNlbnQgPSB2YWxQZXJjZW50OwoJCQl9KTsKCQl9IGVsc2UgewoJCQl2YWx1ZSA9IHRoaXMudmFsdWUoKTsKCQkJdmFsdWVNaW4gPSB0aGlzLl92YWx1ZU1pbigpOwoJCQl2YWx1ZU1heCA9IHRoaXMuX3ZhbHVlTWF4KCk7CgkJCXZhbFBlcmNlbnQgPSAoIHZhbHVlTWF4ICE9PSB2YWx1ZU1pbiApID8KCQkJCQkoIHZhbHVlIC0gdmFsdWVNaW4gKSAvICggdmFsdWVNYXggLSB2YWx1ZU1pbiApICogMTAwIDoKCQkJCQkwOwoJCQlfc2V0WyB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgPyAibGVmdCIgOiAiYm90dG9tIiBdID0gdmFsUGVyY2VudCArICIlIjsKCQkJdGhpcy5oYW5kbGUuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggX3NldCwgby5hbmltYXRlICk7CgoJCQlpZiAoIG9SYW5nZSA9PT0gIm1pbiIgJiYgdGhpcy5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiICkgewoJCQkJdGhpcy5yYW5nZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7IHdpZHRoOiB2YWxQZXJjZW50ICsgIiUiIH0sIG8uYW5pbWF0ZSApOwoJCQl9CgkJCWlmICggb1JhbmdlID09PSAibWF4IiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7CgkJCQl0aGlzLnJhbmdlWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggeyB3aWR0aDogKCAxMDAgLSB2YWxQZXJjZW50ICkgKyAiJSIgfSwgeyBxdWV1ZTogZmFsc2UsIGR1cmF0aW9uOiBvLmFuaW1hdGUgfSApOwoJCQl9CgkJCWlmICggb1JhbmdlID09PSAibWluIiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgewoJCQkJdGhpcy5yYW5nZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7IGhlaWdodDogdmFsUGVyY2VudCArICIlIiB9LCBvLmFuaW1hdGUgKTsKCQkJfQoJCQlpZiAoIG9SYW5nZSA9PT0gIm1heCIgJiYgdGhpcy5vcmllbnRhdGlvbiA9PT0gInZlcnRpY2FsIiApIHsKCQkJCXRoaXMucmFuZ2VbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7IGhlaWdodDogKCAxMDAgLSB2YWxQZXJjZW50ICkgKyAiJSIgfSwgeyBxdWV1ZTogZmFsc2UsIGR1cmF0aW9uOiBvLmFuaW1hdGUgfSApOwoJCQl9CgkJfQoJfSwKCglfaGFuZGxlRXZlbnRzOiB7CgkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvKmpzaGludCBtYXhjb21wbGV4aXR5OjI1Ki8KCQkJdmFyIGFsbG93ZWQsIGN1clZhbCwgbmV3VmFsLCBzdGVwLAoJCQkJaW5kZXggPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAidWktc2xpZGVyLWhhbmRsZS1pbmRleCIgKTsKCgkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuRU5EOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9VUDoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLlVQOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWlmICggIXRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCQkkKCBldmVudC50YXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCQkJYWxsb3dlZCA9IHRoaXMuX3N0YXJ0KCBldmVudCwgaW5kZXggKTsKCQkJCQkJaWYgKCBhbGxvd2VkID09PSBmYWxzZSApIHsKCQkJCQkJCXJldHVybjsKCQkJCQkJfQoJCQkJCX0KCQkJCQlicmVhazsKCQkJfQoKCQkJc3RlcCA9IHRoaXMub3B0aW9ucy5zdGVwOwoJCQlpZiAoIHRoaXMub3B0aW9ucy52YWx1ZXMgJiYgdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGggKSB7CgkJCQljdXJWYWwgPSBuZXdWYWwgPSB0aGlzLnZhbHVlcyggaW5kZXggKTsKCQkJfSBlbHNlIHsKCQkJCWN1clZhbCA9IG5ld1ZhbCA9IHRoaXMudmFsdWUoKTsKCQkJfQoKCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6CgkJCQkJbmV3VmFsID0gdGhpcy5fdmFsdWVNaW4oKTsKCQkJCQlicmVhazsKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCQluZXdWYWwgPSB0aGlzLl92YWx1ZU1heCgpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9VUDoKCQkJCQluZXdWYWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggY3VyVmFsICsgKCAodGhpcy5fdmFsdWVNYXgoKSAtIHRoaXMuX3ZhbHVlTWluKCkpIC8gbnVtUGFnZXMgKSApOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCW5ld1ZhbCA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCBjdXJWYWwgLSAoICh0aGlzLl92YWx1ZU1heCgpIC0gdGhpcy5fdmFsdWVNaW4oKSkgLyBudW1QYWdlcyApICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOgoJCQkJCWlmICggY3VyVmFsID09PSB0aGlzLl92YWx1ZU1heCgpICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCW5ld1ZhbCA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCBjdXJWYWwgKyBzdGVwICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCQlpZiAoIGN1clZhbCA9PT0gdGhpcy5fdmFsdWVNaW4oKSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQluZXdWYWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggY3VyVmFsIC0gc3RlcCApOwoJCQkJCWJyZWFrOwoJCQl9CgoJCQl0aGlzLl9zbGlkZSggZXZlbnQsIGluZGV4LCBuZXdWYWwgKTsKCQl9LAoJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSwKCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaW5kZXggPSAkKCBldmVudC50YXJnZXQgKS5kYXRhKCAidWktc2xpZGVyLWhhbmRsZS1pbmRleCIgKTsKCgkJCWlmICggdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCXRoaXMuX3N0b3AoIGV2ZW50LCBpbmRleCApOwoJCQkJdGhpcy5fY2hhbmdlKCBldmVudCwgaW5kZXggKTsKCQkJCSQoIGV2ZW50LnRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQl9CgkJfQoJfQoKfSk7Cgp9KGpRdWVyeSkpOwooZnVuY3Rpb24oICQgKSB7CgpmdW5jdGlvbiBtb2RpZmllciggZm4gKSB7CglyZXR1cm4gZnVuY3Rpb24oKSB7CgkJdmFyIHByZXZpb3VzID0gdGhpcy5lbGVtZW50LnZhbCgpOwoJCWZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl9yZWZyZXNoKCk7CgkJaWYgKCBwcmV2aW91cyAhPT0gdGhpcy5lbGVtZW50LnZhbCgpICkgewoJCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiApOwoJCX0KCX07Cn0KCiQud2lkZ2V0KCAidWkuc3Bpbm5lciIsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8aW5wdXQ+IiwKCXdpZGdldEV2ZW50UHJlZml4OiAic3BpbiIsCglvcHRpb25zOiB7CgkJY3VsdHVyZTogbnVsbCwKCQlpY29uczogewoJCQlkb3duOiAidWktaWNvbi10cmlhbmdsZS0xLXMiLAoJCQl1cDogInVpLWljb24tdHJpYW5nbGUtMS1uIgoJCX0sCgkJaW5jcmVtZW50YWw6IHRydWUsCgkJbWF4OiBudWxsLAoJCW1pbjogbnVsbCwKCQludW1iZXJGb3JtYXQ6IG51bGwsCgkJcGFnZTogMTAsCgkJc3RlcDogMSwKCgkJY2hhbmdlOiBudWxsLAoJCXNwaW46IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkvLyBoYW5kbGUgc3RyaW5nIHZhbHVlcyB0aGF0IG5lZWQgdG8gYmUgcGFyc2VkCgkJdGhpcy5fc2V0T3B0aW9uKCAibWF4IiwgdGhpcy5vcHRpb25zLm1heCApOwoJCXRoaXMuX3NldE9wdGlvbiggIm1pbiIsIHRoaXMub3B0aW9ucy5taW4gKTsKCQl0aGlzLl9zZXRPcHRpb24oICJzdGVwIiwgdGhpcy5vcHRpb25zLnN0ZXAgKTsKCgkJLy8gZm9ybWF0IHRoZSB2YWx1ZSwgYnV0IGRvbid0IGNvbnN0cmFpbgoJCXRoaXMuX3ZhbHVlKCB0aGlzLmVsZW1lbnQudmFsKCksIHRydWUgKTsKCgkJdGhpcy5fZHJhdygpOwoJCXRoaXMuX29uKCB0aGlzLl9ldmVudHMgKTsKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCS8vIHR1cm5pbmcgb2ZmIGF1dG9jb21wbGV0ZSBwcmV2ZW50cyB0aGUgYnJvd3NlciBmcm9tIHJlbWVtYmVyaW5nIHRoZQoJCS8vIHZhbHVlIHdoZW4gbmF2aWdhdGluZyB0aHJvdWdoIGhpc3RvcnksIHNvIHdlIHJlLWVuYWJsZSBhdXRvY29tcGxldGUKCQkvLyBpZiB0aGUgcGFnZSBpcyB1bmxvYWRlZCBiZWZvcmUgdGhlIHdpZGdldCBpcyBkZXN0cm95ZWQuICM3NzkwCgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCWJlZm9yZXVubG9hZDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggImF1dG9jb21wbGV0ZSIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB7fSwKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCgkJJC5lYWNoKCBbICJtaW4iLCAibWF4IiwgInN0ZXAiIF0sIGZ1bmN0aW9uKCBpLCBvcHRpb24gKSB7CgkJCXZhciB2YWx1ZSA9IGVsZW1lbnQuYXR0ciggb3B0aW9uICk7CgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZS5sZW5ndGggKSB7CgkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfZXZlbnRzOiB7CgkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoIHRoaXMuX3N0YXJ0KCBldmVudCApICYmIHRoaXMuX2tleWRvd24oIGV2ZW50ICkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfSwKCQlrZXl1cDogIl9zdG9wIiwKCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCXRoaXMucHJldmlvdXMgPSB0aGlzLmVsZW1lbnQudmFsKCk7CgkJfSwKCQlibHVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggdGhpcy5jYW5jZWxCbHVyICkgewoJCQkJZGVsZXRlIHRoaXMuY2FuY2VsQmx1cjsKCQkJCXJldHVybjsKCQkJfQoKCQkJdGhpcy5fc3RvcCgpOwoJCQl0aGlzLl9yZWZyZXNoKCk7CgkJCWlmICggdGhpcy5wcmV2aW91cyAhPT0gdGhpcy5lbGVtZW50LnZhbCgpICkgewoJCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50ICk7CgkJCX0KCQl9LAoJCW1vdXNld2hlZWw6IGZ1bmN0aW9uKCBldmVudCwgZGVsdGEgKSB7CgkJCWlmICggIWRlbHRhICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggIXRoaXMuc3Bpbm5pbmcgJiYgIXRoaXMuX3N0YXJ0KCBldmVudCApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl0aGlzLl9zcGluKCAoZGVsdGEgPiAwID8gMSA6IC0xKSAqIHRoaXMub3B0aW9ucy5zdGVwLCBldmVudCApOwoJCQljbGVhclRpbWVvdXQoIHRoaXMubW91c2V3aGVlbFRpbWVyICk7CgkJCXRoaXMubW91c2V3aGVlbFRpbWVyID0gdGhpcy5fZGVsYXkoZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMuc3Bpbm5pbmcgKSB7CgkJCQkJdGhpcy5fc3RvcCggZXZlbnQgKTsKCQkJCX0KCQkJfSwgMTAwICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSwKCQkibW91c2Vkb3duIC51aS1zcGlubmVyLWJ1dHRvbiI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHByZXZpb3VzOwoKCQkJLy8gV2UgbmV2ZXIgd2FudCB0aGUgYnV0dG9ucyB0byBoYXZlIGZvY3VzOyB3aGVuZXZlciB0aGUgdXNlciBpcwoJCQkvLyBpbnRlcmFjdGluZyB3aXRoIHRoZSBzcGlubmVyLCB0aGUgZm9jdXMgc2hvdWxkIGJlIG9uIHRoZSBpbnB1dC4KCQkJLy8gSWYgdGhlIGlucHV0IGlzIGZvY3VzZWQgdGhlbiB0aGlzLnByZXZpb3VzIGlzIHByb3Blcmx5IHNldCBmcm9tCgkJCS8vIHdoZW4gdGhlIGlucHV0IGZpcnN0IHJlY2VpdmVkIGZvY3VzLiBJZiB0aGUgaW5wdXQgaXMgbm90IGZvY3VzZWQKCQkJLy8gdGhlbiB3ZSBuZWVkIHRvIHNldCB0aGlzLnByZXZpb3VzIGJhc2VkIG9uIHRoZSB2YWx1ZSBiZWZvcmUgc3Bpbm5pbmcuCgkJCXByZXZpb3VzID0gdGhpcy5lbGVtZW50WzBdID09PSB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgPwoJCQkJdGhpcy5wcmV2aW91cyA6IHRoaXMuZWxlbWVudC52YWwoKTsKCQkJZnVuY3Rpb24gY2hlY2tGb2N1cygpIHsKCQkJCXZhciBpc0FjdGl2ZSA9IHRoaXMuZWxlbWVudFswXSA9PT0gdGhpcy5kb2N1bWVudFswXS5hY3RpdmVFbGVtZW50OwoJCQkJaWYgKCAhaXNBY3RpdmUgKSB7CgkJCQkJdGhpcy5lbGVtZW50LmZvY3VzKCk7CgkJCQkJdGhpcy5wcmV2aW91cyA9IHByZXZpb3VzOwoJCQkJCS8vIHN1cHBvcnQ6IElFCgkJCQkJLy8gSUUgc2V0cyBmb2N1cyBhc3luY2hyb25vdXNseSwgc28gd2UgbmVlZCB0byBjaGVjayBpZiBmb2N1cwoJCQkJCS8vIG1vdmVkIG9mZiBvZiB0aGUgaW5wdXQgYmVjYXVzZSB0aGUgdXNlciBjbGlja2VkIG9uIHRoZSBidXR0b24uCgkJCQkJdGhpcy5fZGVsYXkoZnVuY3Rpb24oKSB7CgkJCQkJCXRoaXMucHJldmlvdXMgPSBwcmV2aW91czsKCQkJCQl9KTsKCQkJCX0KCQkJfQoKCQkJLy8gZW5zdXJlIGZvY3VzIGlzIG9uIChvciBzdGF5cyBvbikgdGhlIHRleHQgZmllbGQKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJY2hlY2tGb2N1cy5jYWxsKCB0aGlzICk7CgoJCQkvLyBzdXBwb3J0OiBJRQoJCQkvLyBJRSBkb2Vzbid0IHByZXZlbnQgbW92aW5nIGZvY3VzIGV2ZW4gd2l0aCBldmVudC5wcmV2ZW50RGVmYXVsdCgpCgkJCS8vIHNvIHdlIHNldCBhIGZsYWcgdG8ga25vdyB3aGVuIHdlIHNob3VsZCBpZ25vcmUgdGhlIGJsdXIgZXZlbnQKCQkJLy8gYW5kIGNoZWNrIChhZ2FpbikgaWYgZm9jdXMgbW92ZWQgb2ZmIG9mIHRoZSBpbnB1dC4KCQkJdGhpcy5jYW5jZWxCbHVyID0gdHJ1ZTsKCQkJdGhpcy5fZGVsYXkoZnVuY3Rpb24oKSB7CgkJCQlkZWxldGUgdGhpcy5jYW5jZWxCbHVyOwoJCQkJY2hlY2tGb2N1cy5jYWxsKCB0aGlzICk7CgkJCX0pOwoKCQkJaWYgKCB0aGlzLl9zdGFydCggZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgJCggZXZlbnQuY3VycmVudFRhcmdldCApLmhhc0NsYXNzKCAidWktc3Bpbm5lci11cCIgKSA\/IDEgOiAtMSwgZXZlbnQgKTsKCQl9LAoJCSJtb3VzZXVwIC51aS1zcGlubmVyLWJ1dHRvbiI6ICJfc3RvcCIsCgkJIm1vdXNlZW50ZXIgLnVpLXNwaW5uZXItYnV0dG9uIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBidXR0b24gd2lsbCBhZGQgdWktc3RhdGUtYWN0aXZlIGlmIG1vdXNlIHdhcyBkb3duIHdoaWxlIG1vdXNlbGVhdmUgYW5kIGtlcHQgZG93bgoJCQlpZiAoICEkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fc3RhcnQoIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgJCggZXZlbnQuY3VycmVudFRhcmdldCApLmhhc0NsYXNzKCAidWktc3Bpbm5lci11cCIgKSA\/IDEgOiAtMSwgZXZlbnQgKTsKCQl9LAoJCS8vIFRPRE86IGRvIHdlIHJlYWxseSB3YW50IHRvIGNvbnNpZGVyIHRoaXMgYSBzdG9wPwoJCS8vIHNob3VsZG4ndCB3ZSBqdXN0IHN0b3AgdGhlIHJlcGVhdGVyIGFuZCB3YWl0IHVudGlsIG1vdXNldXAgYmVmb3JlCgkJLy8gd2UgdHJpZ2dlciB0aGUgc3RvcCBldmVudD8KCQkibW91c2VsZWF2ZSAudWktc3Bpbm5lci1idXR0b24iOiAiX3N0b3AiCgl9LAoKCV9kcmF3OiBmdW5jdGlvbigpIHsKCQl2YXIgdWlTcGlubmVyID0gdGhpcy51aVNwaW5uZXIgPSB0aGlzLmVsZW1lbnQKCQkJLmFkZENsYXNzKCAidWktc3Bpbm5lci1pbnB1dCIgKQoJCQkuYXR0ciggImF1dG9jb21wbGV0ZSIsICJvZmYiICkKCQkJLndyYXAoIHRoaXMuX3VpU3Bpbm5lckh0bWwoKSApCgkJCS5wYXJlbnQoKQoJCQkJLy8gYWRkIGJ1dHRvbnMKCQkJCS5hcHBlbmQoIHRoaXMuX2J1dHRvbkh0bWwoKSApOwoKCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCAic3BpbmJ1dHRvbiIgKTsKCgkJLy8gYnV0dG9uIGJpbmRpbmdzCgkJdGhpcy5idXR0b25zID0gdWlTcGlubmVyLmZpbmQoICIudWktc3Bpbm5lci1idXR0b24iICkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICkKCQkJLmJ1dHRvbigpCgkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci1hbGwiICk7CgoJCS8vIElFIDYgZG9lc24ndCB1bmRlcnN0YW5kIGhlaWdodDogNTAlIGZvciB0aGUgYnV0dG9ucwoJCS8vIHVubGVzcyB0aGUgd3JhcHBlciBoYXMgYW4gZXhwbGljaXQgaGVpZ2h0CgkJaWYgKCB0aGlzLmJ1dHRvbnMuaGVpZ2h0KCkgPiBNYXRoLmNlaWwoIHVpU3Bpbm5lci5oZWlnaHQoKSAqIDAuNSApICYmCgkJCQl1aVNwaW5uZXIuaGVpZ2h0KCkgPiAwICkgewoJCQl1aVNwaW5uZXIuaGVpZ2h0KCB1aVNwaW5uZXIuaGVpZ2h0KCkgKTsKCQl9CgoJCS8vIGRpc2FibGUgc3Bpbm5lciBpZiBlbGVtZW50IHdhcyBhbHJlYWR5IGRpc2FibGVkCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCX0sCgoJX2tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2V5Q29kZSA9ICQudWkua2V5Q29kZTsKCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQljYXNlIGtleUNvZGUuVVA6CgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgMSwgZXZlbnQgKTsKCQkJcmV0dXJuIHRydWU7CgkJY2FzZSBrZXlDb2RlLkRPV046CgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgLTEsIGV2ZW50ICk7CgkJCXJldHVybiB0cnVlOwoJCWNhc2Uga2V5Q29kZS5QQUdFX1VQOgoJCQl0aGlzLl9yZXBlYXQoIG51bGwsIG9wdGlvbnMucGFnZSwgZXZlbnQgKTsKCQkJcmV0dXJuIHRydWU7CgkJY2FzZSBrZXlDb2RlLlBBR0VfRE9XTjoKCQkJdGhpcy5fcmVwZWF0KCBudWxsLCAtb3B0aW9ucy5wYWdlLCBldmVudCApOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3VpU3Bpbm5lckh0bWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAiPHNwYW4gY2xhc3M9J3VpLXNwaW5uZXIgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwnPjwvc3Bhbj4iOwoJfSwKCglfYnV0dG9uSHRtbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICIiICsKCQkJIjxhIGNsYXNzPSd1aS1zcGlubmVyLWJ1dHRvbiB1aS1zcGlubmVyLXVwIHVpLWNvcm5lci10cic+IiArCgkJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24gIiArIHRoaXMub3B0aW9ucy5pY29ucy51cCArICInPiYjOTY1MDs8L3NwYW4+IiArCgkJCSI8L2E+IiArCgkJCSI8YSBjbGFzcz0ndWktc3Bpbm5lci1idXR0b24gdWktc3Bpbm5lci1kb3duIHVpLWNvcm5lci1icic+IiArCgkJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24gIiArIHRoaXMub3B0aW9ucy5pY29ucy5kb3duICsgIic+JiM5NjYwOzwvc3Bhbj4iICsKCQkJIjwvYT4iOwoJfSwKCglfc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoICF0aGlzLnNwaW5uaW5nICYmIHRoaXMuX3RyaWdnZXIoICJzdGFydCIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZiAoICF0aGlzLmNvdW50ZXIgKSB7CgkJCXRoaXMuY291bnRlciA9IDE7CgkJfQoJCXRoaXMuc3Bpbm5pbmcgPSB0cnVlOwoJCXJldHVybiB0cnVlOwoJfSwKCglfcmVwZWF0OiBmdW5jdGlvbiggaSwgc3RlcHMsIGV2ZW50ICkgewoJCWkgPSBpIHx8IDUwMDsKCgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9yZXBlYXQoIDQwLCBzdGVwcywgZXZlbnQgKTsKCQl9LCBpICk7CgoJCXRoaXMuX3NwaW4oIHN0ZXBzICogdGhpcy5vcHRpb25zLnN0ZXAsIGV2ZW50ICk7Cgl9LAoKCV9zcGluOiBmdW5jdGlvbiggc3RlcCwgZXZlbnQgKSB7CgkJdmFyIHZhbHVlID0gdGhpcy52YWx1ZSgpIHx8IDA7CgoJCWlmICggIXRoaXMuY291bnRlciApIHsKCQkJdGhpcy5jb3VudGVyID0gMTsKCQl9CgoJCXZhbHVlID0gdGhpcy5fYWRqdXN0VmFsdWUoIHZhbHVlICsgc3RlcCAqIHRoaXMuX2luY3JlbWVudCggdGhpcy5jb3VudGVyICkgKTsKCgkJaWYgKCAhdGhpcy5zcGlubmluZyB8fCB0aGlzLl90cmlnZ2VyKCAic3BpbiIsIGV2ZW50LCB7IHZhbHVlOiB2YWx1ZSB9ICkgIT09IGZhbHNlKSB7CgkJCXRoaXMuX3ZhbHVlKCB2YWx1ZSApOwoJCQl0aGlzLmNvdW50ZXIrKzsKCQl9Cgl9LAoKCV9pbmNyZW1lbnQ6IGZ1bmN0aW9uKCBpICkgewoJCXZhciBpbmNyZW1lbnRhbCA9IHRoaXMub3B0aW9ucy5pbmNyZW1lbnRhbDsKCgkJaWYgKCBpbmNyZW1lbnRhbCApIHsKCQkJcmV0dXJuICQuaXNGdW5jdGlvbiggaW5jcmVtZW50YWwgKSA\/CgkJCQlpbmNyZW1lbnRhbCggaSApIDoKCQkJCU1hdGguZmxvb3IoIGkqaSppLzUwMDAwIC0gaSppLzUwMCArIDE3KmkvMjAwICsgMSApOwoJCX0KCgkJcmV0dXJuIDE7Cgl9LAoKCV9wcmVjaXNpb246IGZ1bmN0aW9uKCkgewoJCXZhciBwcmVjaXNpb24gPSB0aGlzLl9wcmVjaXNpb25PZiggdGhpcy5vcHRpb25zLnN0ZXAgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5taW4gIT09IG51bGwgKSB7CgkJCXByZWNpc2lvbiA9IE1hdGgubWF4KCBwcmVjaXNpb24sIHRoaXMuX3ByZWNpc2lvbk9mKCB0aGlzLm9wdGlvbnMubWluICkgKTsKCQl9CgkJcmV0dXJuIHByZWNpc2lvbjsKCX0sCgoJX3ByZWNpc2lvbk9mOiBmdW5jdGlvbiggbnVtICkgewoJCXZhciBzdHIgPSBudW0udG9TdHJpbmcoKSwKCQkJZGVjaW1hbCA9IHN0ci5pbmRleE9mKCAiLiIgKTsKCQlyZXR1cm4gZGVjaW1hbCA9PT0gLTEgPyAwIDogc3RyLmxlbmd0aCAtIGRlY2ltYWwgLSAxOwoJfSwKCglfYWRqdXN0VmFsdWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgYmFzZSwgYWJvdmVNaW4sCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIG1ha2Ugc3VyZSB3ZSdyZSBhdCBhIHZhbGlkIHN0ZXAKCQkvLyAtIGZpbmQgb3V0IHdoZXJlIHdlIGFyZSByZWxhdGl2ZSB0byB0aGUgYmFzZSAobWluIG9yIDApCgkJYmFzZSA9IG9wdGlvbnMubWluICE9PSBudWxsID8gb3B0aW9ucy5taW4gOiAwOwoJCWFib3ZlTWluID0gdmFsdWUgLSBiYXNlOwoJCS8vIC0gcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCWFib3ZlTWluID0gTWF0aC5yb3VuZChhYm92ZU1pbiAvIG9wdGlvbnMuc3RlcCkgKiBvcHRpb25zLnN0ZXA7CgkJLy8gLSByb3VuZGluZyBpcyBiYXNlZCBvbiAwLCBzbyBhZGp1c3QgYmFjayB0byBvdXIgYmFzZQoJCXZhbHVlID0gYmFzZSArIGFib3ZlTWluOwoKCQkvLyBmaXggcHJlY2lzaW9uIGZyb20gYmFkIEpTIGZsb2F0aW5nIHBvaW50IG1hdGgKCQl2YWx1ZSA9IHBhcnNlRmxvYXQoIHZhbHVlLnRvRml4ZWQoIHRoaXMuX3ByZWNpc2lvbigpICkgKTsKCgkJLy8gY2xhbXAgdGhlIHZhbHVlCgkJaWYgKCBvcHRpb25zLm1heCAhPT0gbnVsbCAmJiB2YWx1ZSA+IG9wdGlvbnMubWF4KSB7CgkJCXJldHVybiBvcHRpb25zLm1heDsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbiAhPT0gbnVsbCAmJiB2YWx1ZSA8IG9wdGlvbnMubWluICkgewoJCQlyZXR1cm4gb3B0aW9ucy5taW47CgkJfQoKCQlyZXR1cm4gdmFsdWU7Cgl9LAoKCV9zdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5zcGlubmluZyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLm1vdXNld2hlZWxUaW1lciApOwoJCXRoaXMuY291bnRlciA9IDA7CgkJdGhpcy5zcGlubmluZyA9IGZhbHNlOwoJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiwgZXZlbnQgKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJjdWx0dXJlIiB8fCBrZXkgPT09ICJudW1iZXJGb3JtYXQiICkgewoJCQl2YXIgcHJldlZhbHVlID0gdGhpcy5fcGFyc2UoIHRoaXMuZWxlbWVudC52YWwoKSApOwoJCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCXRoaXMuZWxlbWVudC52YWwoIHRoaXMuX2Zvcm1hdCggcHJldlZhbHVlICkgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJtYXgiIHx8IGtleSA9PT0gIm1pbiIgfHwga2V5ID09PSAic3RlcCIgKSB7CgkJCWlmICggdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiApIHsKCQkJCXZhbHVlID0gdGhpcy5fcGFyc2UoIHZhbHVlICk7CgkJCX0KCQl9CgkJaWYgKCBrZXkgPT09ICJpY29ucyIgKSB7CgkJCXRoaXMuYnV0dG9ucy5maXJzdCgpLmZpbmQoICIudWktaWNvbiIgKQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuaWNvbnMudXAgKQoJCQkJLmFkZENsYXNzKCB2YWx1ZS51cCApOwoJCQl0aGlzLmJ1dHRvbnMubGFzdCgpLmZpbmQoICIudWktaWNvbiIgKQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuaWNvbnMuZG93biApCgkJCQkuYWRkQ2xhc3MoIHZhbHVlLmRvd24gKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQlpZiAoIHZhbHVlICkgewoJCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHRydWUgKTsKCQkJCXRoaXMuYnV0dG9ucy5idXR0b24oICJkaXNhYmxlIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJCQl0aGlzLmJ1dHRvbnMuYnV0dG9uKCAiZW5hYmxlIiApOwoJCQl9CgkJfQoJfSwKCglfc2V0T3B0aW9uczogbW9kaWZpZXIoZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl0aGlzLl92YWx1ZSggdGhpcy5lbGVtZW50LnZhbCgpICk7Cgl9KSwKCglfcGFyc2U6IGZ1bmN0aW9uKCB2YWwgKSB7CgkJaWYgKCB0eXBlb2YgdmFsID09PSAic3RyaW5nIiAmJiB2YWwgIT09ICIiICkgewoJCQl2YWwgPSB3aW5kb3cuR2xvYmFsaXplICYmIHRoaXMub3B0aW9ucy5udW1iZXJGb3JtYXQgPwoJCQkJR2xvYmFsaXplLnBhcnNlRmxvYXQoIHZhbCwgMTAsIHRoaXMub3B0aW9ucy5jdWx0dXJlICkgOiArdmFsOwoJCX0KCQlyZXR1cm4gdmFsID09PSAiIiB8fCBpc05hTiggdmFsICkgPyBudWxsIDogdmFsOwoJfSwKCglfZm9ybWF0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJaWYgKCB2YWx1ZSA9PT0gIiIgKSB7CgkJCXJldHVybiAiIjsKCQl9CgkJcmV0dXJuIHdpbmRvdy5HbG9iYWxpemUgJiYgdGhpcy5vcHRpb25zLm51bWJlckZvcm1hdCA\/CgkJCUdsb2JhbGl6ZS5mb3JtYXQoIHZhbHVlLCB0aGlzLm9wdGlvbnMubnVtYmVyRm9ybWF0LCB0aGlzLm9wdGlvbnMuY3VsdHVyZSApIDoKCQkJdmFsdWU7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0cih7CgkJCSJhcmlhLXZhbHVlbWluIjogdGhpcy5vcHRpb25zLm1pbiwKCQkJImFyaWEtdmFsdWVtYXgiOiB0aGlzLm9wdGlvbnMubWF4LAoJCQkvLyBUT0RPOiB3aGF0IHNob3VsZCB3ZSBkbyB3aXRoIHZhbHVlcyB0aGF0IGNhbid0IGJlIHBhcnNlZD8KCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl9wYXJzZSggdGhpcy5lbGVtZW50LnZhbCgpICkKCQl9KTsKCX0sCgoJLy8gdXBkYXRlIHRoZSB2YWx1ZSB3aXRob3V0IHRyaWdnZXJpbmcgY2hhbmdlCglfdmFsdWU6IGZ1bmN0aW9uKCB2YWx1ZSwgYWxsb3dBbnkgKSB7CgkJdmFyIHBhcnNlZDsKCQlpZiAoIHZhbHVlICE9PSAiIiApIHsKCQkJcGFyc2VkID0gdGhpcy5fcGFyc2UoIHZhbHVlICk7CgkJCWlmICggcGFyc2VkICE9PSBudWxsICkgewoJCQkJaWYgKCAhYWxsb3dBbnkgKSB7CgkJCQkJcGFyc2VkID0gdGhpcy5fYWRqdXN0VmFsdWUoIHBhcnNlZCApOwoJCQkJfQoJCQkJdmFsdWUgPSB0aGlzLl9mb3JtYXQoIHBhcnNlZCApOwoJCQl9CgkJfQoJCXRoaXMuZWxlbWVudC52YWwoIHZhbHVlICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLXNwaW5uZXItaW5wdXQiICkKCQkJLnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICkKCQkJLnJlbW92ZUF0dHIoICJhdXRvY29tcGxldGUiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS12YWx1ZW1pbiIgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtdmFsdWVtYXgiICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLXZhbHVlbm93IiApOwoJCXRoaXMudWlTcGlubmVyLnJlcGxhY2VXaXRoKCB0aGlzLmVsZW1lbnQgKTsKCX0sCgoJc3RlcFVwOiBtb2RpZmllcihmdW5jdGlvbiggc3RlcHMgKSB7CgkJdGhpcy5fc3RlcFVwKCBzdGVwcyApOwoJfSksCglfc3RlcFVwOiBmdW5jdGlvbiggc3RlcHMgKSB7CgkJaWYgKCB0aGlzLl9zdGFydCgpICkgewoJCQl0aGlzLl9zcGluKCAoc3RlcHMgfHwgMSkgKiB0aGlzLm9wdGlvbnMuc3RlcCApOwoJCQl0aGlzLl9zdG9wKCk7CgkJfQoJfSwKCglzdGVwRG93bjogbW9kaWZpZXIoZnVuY3Rpb24oIHN0ZXBzICkgewoJCXRoaXMuX3N0ZXBEb3duKCBzdGVwcyApOwoJfSksCglfc3RlcERvd246IGZ1bmN0aW9uKCBzdGVwcyApIHsKCQlpZiAoIHRoaXMuX3N0YXJ0KCkgKSB7CgkJCXRoaXMuX3NwaW4oIChzdGVwcyB8fCAxKSAqIC10aGlzLm9wdGlvbnMuc3RlcCApOwoJCQl0aGlzLl9zdG9wKCk7CgkJfQoJfSwKCglwYWdlVXA6IG1vZGlmaWVyKGZ1bmN0aW9uKCBwYWdlcyApIHsKCQl0aGlzLl9zdGVwVXAoIChwYWdlcyB8fCAxKSAqIHRoaXMub3B0aW9ucy5wYWdlICk7Cgl9KSwKCglwYWdlRG93bjogbW9kaWZpZXIoZnVuY3Rpb24oIHBhZ2VzICkgewoJCXRoaXMuX3N0ZXBEb3duKCAocGFnZXMgfHwgMSkgKiB0aGlzLm9wdGlvbnMucGFnZSApOwoJfSksCgoJdmFsdWU6IGZ1bmN0aW9uKCBuZXdWYWwgKSB7CgkJaWYgKCAhYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJcmV0dXJuIHRoaXMuX3BhcnNlKCB0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQl9CgkJbW9kaWZpZXIoIHRoaXMuX3ZhbHVlICkuY2FsbCggdGhpcywgbmV3VmFsICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudWlTcGlubmVyOwoJfQp9KTsKCn0oIGpRdWVyeSApICk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHRhYklkID0gMCwKCXJoYXNoID0gLyMuKiQvOwoKZnVuY3Rpb24gZ2V0TmV4dFRhYklkKCkgewoJcmV0dXJuICsrdGFiSWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwoIGFuY2hvciApIHsKCXJldHVybiBhbmNob3IuaGFzaC5sZW5ndGggPiAxICYmCgkJZGVjb2RlVVJJQ29tcG9uZW50KCBhbmNob3IuaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApID09PQoJCQlkZWNvZGVVUklDb21wb25lbnQoIGxvY2F0aW9uLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKTsKfQoKJC53aWRnZXQoICJ1aS50YWJzIiwgewoJdmVyc2lvbjogIjEuMTAuMyIsCglkZWxheTogMzAwLAoJb3B0aW9uczogewoJCWFjdGl2ZTogbnVsbCwKCQljb2xsYXBzaWJsZTogZmFsc2UsCgkJZXZlbnQ6ICJjbGljayIsCgkJaGVpZ2h0U3R5bGU6ICJjb250ZW50IiwKCQloaWRlOiBudWxsLAoJCXNob3c6IG51bGwsCgoJCS8vIGNhbGxiYWNrcwoJCWFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZUFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZUxvYWQ6IG51bGwsCgkJbG9hZDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoKCQl0aGlzLmVsZW1lbnQKCQkJLmFkZENsYXNzKCAidWktdGFicyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCIgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgb3B0aW9ucy5jb2xsYXBzaWJsZSApCgkJCS8vIFByZXZlbnQgdXNlcnMgZnJvbSBmb2N1c2luZyBkaXNhYmxlZCB0YWJzIHZpYSBjbGljawoJCQkuZGVsZWdhdGUoICIudWktdGFicy1uYXYgPiBsaSIsICJtb3VzZWRvd24iICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfSkKCQkJLy8gc3VwcG9ydDogSUUgPDkKCQkJLy8gUHJldmVudGluZyB0aGUgZGVmYXVsdCBhY3Rpb24gaW4gbW91c2Vkb3duIGRvZXNuJ3QgcHJldmVudCBJRQoJCQkvLyBmcm9tIGZvY3VzaW5nIHRoZSBlbGVtZW50LCBzbyBpZiB0aGUgYW5jaG9yIGdldHMgZm9jdXNlZCwgYmx1ci4KCQkJLy8gV2UgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBmb2N1c2luZyB0aGUgcHJldmlvdXNseSBmb2N1c2VkCgkJCS8vIGVsZW1lbnQgc2luY2UgY2xpY2tpbmcgb24gYSBub24tZm9jdXNhYmxlIGVsZW1lbnQgc2hvdWxkIGZvY3VzCgkJCS8vIHRoZSBib2R5IGFueXdheS4KCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtYW5jaG9yIiwgImZvY3VzIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCXRoaXMuYmx1cigpOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCQlvcHRpb25zLmFjdGl2ZSA9IHRoaXMuX2luaXRpYWxBY3RpdmUoKTsKCgkJLy8gVGFrZSBkaXNhYmxpbmcgdGFicyB2aWEgY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIGludG8gYWNjb3VudCBhbmQgdXBkYXRlIG9wdGlvbiBwcm9wZXJseS4KCQlpZiAoICQuaXNBcnJheSggb3B0aW9ucy5kaXNhYmxlZCApICkgewoJCQlvcHRpb25zLmRpc2FibGVkID0gJC51bmlxdWUoIG9wdGlvbnMuZGlzYWJsZWQuY29uY2F0KAoJCQkJJC5tYXAoIHRoaXMudGFicy5maWx0ZXIoICIudWktc3RhdGUtZGlzYWJsZWQiICksIGZ1bmN0aW9uKCBsaSApIHsKCQkJCQlyZXR1cm4gdGhhdC50YWJzLmluZGV4KCBsaSApOwoJCQkJfSkKCQkJKSApLnNvcnQoKTsKCQl9CgoJCS8vIGNoZWNrIGZvciBsZW5ndGggYXZvaWRzIGVycm9yIHdoZW4gaW5pdGlhbGl6aW5nIGVtcHR5IGxpc3QKCQlpZiAoIHRoaXMub3B0aW9ucy5hY3RpdmUgIT09IGZhbHNlICYmIHRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCXRoaXMuYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggb3B0aW9ucy5hY3RpdmUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2goKTsKCgkJaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggKSB7CgkJCXRoaXMubG9hZCggb3B0aW9ucy5hY3RpdmUgKTsKCQl9Cgl9LAoKCV9pbml0aWFsQWN0aXZlOiBmdW5jdGlvbigpIHsKCQl2YXIgYWN0aXZlID0gdGhpcy5vcHRpb25zLmFjdGl2ZSwKCQkJY29sbGFwc2libGUgPSB0aGlzLm9wdGlvbnMuY29sbGFwc2libGUsCgkJCWxvY2F0aW9uSGFzaCA9IGxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKCAxICk7CgoJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkvLyBjaGVjayB0aGUgZnJhZ21lbnQgaWRlbnRpZmllciBpbiB0aGUgVVJMCgkJCWlmICggbG9jYXRpb25IYXNoICkgewoJCQkJdGhpcy50YWJzLmVhY2goZnVuY3Rpb24oIGksIHRhYiApIHsKCQkJCQlpZiAoICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApID09PSBsb2NhdGlvbkhhc2ggKSB7CgkJCQkJCWFjdGl2ZSA9IGk7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJLy8gY2hlY2sgZm9yIGEgdGFiIG1hcmtlZCBhY3RpdmUgdmlhIGEgY2xhc3MKCQkJaWYgKCBhY3RpdmUgPT09IG51bGwgKSB7CgkJCQlhY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMudGFicy5maWx0ZXIoICIudWktdGFicy1hY3RpdmUiICkgKTsKCQkJfQoKCQkJLy8gbm8gYWN0aXZlIHRhYiwgc2V0IHRvIGZhbHNlCgkJCWlmICggYWN0aXZlID09PSBudWxsIHx8IGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSB0aGlzLnRhYnMubGVuZ3RoID8gMCA6IGZhbHNlOwoJCQl9CgkJfQoKCQkvLyBoYW5kbGUgbnVtYmVyczogbmVnYXRpdmUsIG91dCBvZiByYW5nZQoJCWlmICggYWN0aXZlICE9PSBmYWxzZSApIHsKCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZXEoIGFjdGl2ZSApICk7CgkJCWlmICggYWN0aXZlID09PSAtMSApIHsKCQkJCWFjdGl2ZSA9IGNvbGxhcHNpYmxlID8gZmFsc2UgOiAwOwoJCQl9CgkJfQoKCQkvLyBkb24ndCBhbGxvdyBjb2xsYXBzaWJsZTogZmFsc2UgYW5kIGFjdGl2ZTogZmFsc2UKCQlpZiAoICFjb2xsYXBzaWJsZSAmJiBhY3RpdmUgPT09IGZhbHNlICYmIHRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IDA7CgkJfQoKCQlyZXR1cm4gYWN0aXZlOwoJfSwKCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gewoJCQl0YWI6IHRoaXMuYWN0aXZlLAoJCQlwYW5lbDogIXRoaXMuYWN0aXZlLmxlbmd0aCA\/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJfTsKCX0sCgoJX3RhYktleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvKmpzaGludCBtYXhjb21wbGV4aXR5OjE1Ki8KCQl2YXIgZm9jdXNlZFRhYiA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uYWN0aXZlRWxlbWVudCApLmNsb3Nlc3QoICJsaSIgKSwKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMudGFicy5pbmRleCggZm9jdXNlZFRhYiApLAoJCQlnb2luZ0ZvcndhcmQgPSB0cnVlOwoKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOgoJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQkJc2VsZWN0ZWRJbmRleCsrOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlVQOgoJCQljYXNlICQudWkua2V5Q29kZS5MRUZUOgoJCQkJZ29pbmdGb3J3YXJkID0gZmFsc2U7CgkJCQlzZWxlY3RlZEluZGV4LS07CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuRU5EOgoJCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuYW5jaG9ycy5sZW5ndGggLSAxOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkhPTUU6CgkJCQlzZWxlY3RlZEluZGV4ID0gMDsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5TUEFDRToKCQkJCS8vIEFjdGl2YXRlIG9ubHksIG5vIGNvbGxhcHNpbmcKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggKTsKCQkJCXJldHVybjsKCQkJY2FzZSAkLnVpLmtleUNvZGUuRU5URVI6CgkJCQkvLyBUb2dnbGUgKGNhbmNlbCBkZWxheWVkIGFjdGl2YXRpb24sIGFsbG93IGNvbGxhcHNpbmcpCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQkJCS8vIERldGVybWluZSBpZiB3ZSBzaG91bGQgY29sbGFwc2Ugb3IgYWN0aXZhdGUKCQkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ID09PSB0aGlzLm9wdGlvbnMuYWN0aXZlID8gZmFsc2UgOiBzZWxlY3RlZEluZGV4ICk7CgkJCQlyZXR1cm47CgkJCWRlZmF1bHQ6CgkJCQlyZXR1cm47CgkJfQoKCQkvLyBGb2N1cyB0aGUgYXBwcm9wcmlhdGUgdGFiLCBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuX2ZvY3VzTmV4dFRhYiggc2VsZWN0ZWRJbmRleCwgZ29pbmdGb3J3YXJkICk7CgoJCS8vIE5hdmlnYXRpbmcgd2l0aCBjb250cm9sIGtleSB3aWxsIHByZXZlbnQgYXV0b21hdGljIGFjdGl2YXRpb24KCQlpZiAoICFldmVudC5jdHJsS2V5ICkgewoJCQkvLyBVcGRhdGUgYXJpYS1zZWxlY3RlZCBpbW1lZGlhdGVseSBzbyB0aGF0IEFUIHRoaW5rIHRoZSB0YWIgaXMgYWxyZWFkeSBzZWxlY3RlZC4KCQkJLy8gT3RoZXJ3aXNlIEFUIG1heSBjb25mdXNlIHRoZSB1c2VyIGJ5IHN0YXRpbmcgdGhhdCB0aGV5IG5lZWQgdG8gYWN0aXZhdGUgdGhlIHRhYiwKCQkJLy8gYnV0IHRoZSB0YWIgd2lsbCBhbHJlYWR5IGJlIGFjdGl2YXRlZCBieSB0aGUgdGltZSB0aGUgYW5ub3VuY2VtZW50IGZpbmlzaGVzLgoJCQlmb2N1c2VkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCQl0aGlzLnRhYnMuZXEoIHNlbGVjdGVkSW5kZXggKS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJ0cnVlIiApOwoKCQkJdGhpcy5hY3RpdmF0aW5nID0gdGhpcy5fZGVsYXkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLm9wdGlvbiggImFjdGl2ZSIsIHNlbGVjdGVkSW5kZXggKTsKCQkJfSwgdGhpcy5kZWxheSApOwoJCX0KCX0sCgoJX3BhbmVsS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ3RybCt1cCBtb3ZlcyBmb2N1cyB0byB0aGUgY3VycmVudCB0YWIKCQlpZiAoIGV2ZW50LmN0cmxLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlVQICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl0aGlzLmFjdGl2ZS5mb2N1cygpOwoJCX0KCX0sCgoJLy8gQWx0K3BhZ2UgdXAvZG93biBtb3ZlcyBmb2N1cyB0byB0aGUgcHJldmlvdXMvbmV4dCB0YWIgKGFuZCBhY3RpdmF0ZXMpCglfaGFuZGxlUGFnZU5hdjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX1VQICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlIC0gMSwgZmFsc2UgKSApOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfRE9XTiApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSArIDEsIHRydWUgKSApOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9LAoKCV9maW5kTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJdmFyIGxhc3RUYWJJbmRleCA9IHRoaXMudGFicy5sZW5ndGggLSAxOwoKCQlmdW5jdGlvbiBjb25zdHJhaW4oKSB7CgkJCWlmICggaW5kZXggPiBsYXN0VGFiSW5kZXggKSB7CgkJCQlpbmRleCA9IDA7CgkJCX0KCQkJaWYgKCBpbmRleCA8IDAgKSB7CgkJCQlpbmRleCA9IGxhc3RUYWJJbmRleDsKCQkJfQoJCQlyZXR1cm4gaW5kZXg7CgkJfQoKCQl3aGlsZSAoICQuaW5BcnJheSggY29uc3RyYWluKCksIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApICE9PSAtMSApIHsKCQkJaW5kZXggPSBnb2luZ0ZvcndhcmQgPyBpbmRleCArIDEgOiBpbmRleCAtIDE7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9mb2N1c05leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCWluZGV4ID0gdGhpcy5fZmluZE5leHRUYWIoIGluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCQl0aGlzLnRhYnMuZXEoIGluZGV4ICkuZm9jdXMoKTsKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiYWN0aXZlIiApIHsKCQkJLy8gX2FjdGl2YXRlKCkgd2lsbCBoYW5kbGUgaW52YWxpZCB2YWx1ZXMgYW5kIHVwZGF0ZSB0aGlzLm9wdGlvbnMKCQkJdGhpcy5fYWN0aXZhdGUoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQkvLyBkb24ndCB1c2UgdGhlIHdpZGdldCBmYWN0b3J5J3MgZGlzYWJsZWQgaGFuZGxpbmcKCQkJdGhpcy5fc2V0dXBEaXNhYmxlZCggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUpOwoKCQlpZiAoIGtleSA9PT0gImNvbGxhcHNpYmxlIiApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIHZhbHVlICk7CgkJCS8vIFNldHRpbmcgY29sbGFwc2libGU6IGZhbHNlIHdoaWxlIGNvbGxhcHNlZDsgb3BlbiBmaXJzdCBwYW5lbAoJCQlpZiAoICF2YWx1ZSAmJiB0aGlzLm9wdGlvbnMuYWN0aXZlID09PSBmYWxzZSApIHsKCQkJCXRoaXMuX2FjdGl2YXRlKCAwICk7CgkJCX0KCQl9CgoJCWlmICgga2V5ID09PSAiZXZlbnQiICkgewoJCQl0aGlzLl9zZXR1cEV2ZW50cyggdmFsdWUgKTsKCQl9CgoJCWlmICgga2V5ID09PSAiaGVpZ2h0U3R5bGUiICkgewoJCQl0aGlzLl9zZXR1cEhlaWdodFN0eWxlKCB2YWx1ZSApOwoJCX0KCX0sCgoJX3RhYklkOiBmdW5jdGlvbiggdGFiICkgewoJCXJldHVybiB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICkgfHwgInVpLXRhYnMtIiArIGdldE5leHRUYWJJZCgpOwoJfSwKCglfc2FuaXRpemVTZWxlY3RvcjogZnVuY3Rpb24oIGhhc2ggKSB7CgkJcmV0dXJuIGhhc2ggPyBoYXNoLnJlcGxhY2UoIC9bISIkJSYnKCkqKywuXC86Ozw9Pj9AXFtcXVxeYHt8fX5dL2csICJcXCQmIiApIDogIiI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlsaXMgPSB0aGlzLnRhYmxpc3QuY2hpbGRyZW4oICI6aGFzKGFbaHJlZl0pIiApOwoKCQkvLyBnZXQgZGlzYWJsZWQgdGFicyBmcm9tIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyB0aGlzIHdpbGwgZ2V0IGNvbnZlcnRlZCB0byBhIGJvb2xlYW4gaWYgbmVlZGVkIGluIF9yZWZyZXNoKCkKCQlvcHRpb25zLmRpc2FibGVkID0gJC5tYXAoIGxpcy5maWx0ZXIoICIudWktc3RhdGUtZGlzYWJsZWQiICksIGZ1bmN0aW9uKCB0YWIgKSB7CgkJCXJldHVybiBsaXMuaW5kZXgoIHRhYiApOwoJCX0pOwoKCQl0aGlzLl9wcm9jZXNzVGFicygpOwoKCQkvLyB3YXMgY29sbGFwc2VkIG9yIG5vIHRhYnMKCQlpZiAoIG9wdGlvbnMuYWN0aXZlID09PSBmYWxzZSB8fCAhdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJb3B0aW9ucy5hY3RpdmUgPSBmYWxzZTsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJLy8gd2FzIGFjdGl2ZSwgYnV0IGFjdGl2ZSB0YWIgaXMgZ29uZQoJCX0gZWxzZSBpZiAoIHRoaXMuYWN0aXZlLmxlbmd0aCAmJiAhJC5jb250YWlucyggdGhpcy50YWJsaXN0WyAwIF0sIHRoaXMuYWN0aXZlWyAwIF0gKSApIHsKCQkJLy8gYWxsIHJlbWFpbmluZyB0YWJzIGFyZSBkaXNhYmxlZAoJCQlpZiAoIHRoaXMudGFicy5sZW5ndGggPT09IG9wdGlvbnMuZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJb3B0aW9ucy5hY3RpdmUgPSBmYWxzZTsKCQkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCQkvLyBhY3RpdmF0ZSBwcmV2aW91cyB0YWIKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9maW5kTmV4dFRhYiggTWF0aC5tYXgoIDAsIG9wdGlvbnMuYWN0aXZlIC0gMSApLCBmYWxzZSApICk7CgkJCX0KCQkvLyB3YXMgYWN0aXZlLCBhY3RpdmUgdGFiIHN0aWxsIGV4aXN0cwoJCX0gZWxzZSB7CgkJCS8vIG1ha2Ugc3VyZSBhY3RpdmUgaW5kZXggaXMgY29ycmVjdAoJCQlvcHRpb25zLmFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy5hY3RpdmUgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldHVwRGlzYWJsZWQoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApOwoJCXRoaXMuX3NldHVwRXZlbnRzKCB0aGlzLm9wdGlvbnMuZXZlbnQgKTsKCQl0aGlzLl9zZXR1cEhlaWdodFN0eWxlKCB0aGlzLm9wdGlvbnMuaGVpZ2h0U3R5bGUgKTsKCgkJdGhpcy50YWJzLm5vdCggdGhpcy5hY3RpdmUgKS5hdHRyKHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAiZmFsc2UiLAoJCQl0YWJJbmRleDogLTEKCQl9KTsKCQl0aGlzLnBhbmVscy5ub3QoIHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApICkKCQkJLmhpZGUoKQoJCQkuYXR0cih7CgkJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQkJfSk7CgoJCS8vIE1ha2Ugc3VyZSBvbmUgdGFiIGlzIGluIHRoZSB0YWIgb3JkZXIKCQlpZiAoICF0aGlzLmFjdGl2ZS5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5lcSggMCApLmF0dHIoICJ0YWJJbmRleCIsIDAgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmFjdGl2ZQoJCQkJLmFkZENsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCQkJdGFiSW5kZXg6IDAKCQkJCX0pOwoJCQl0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCQkJLnNob3coKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkJCSJhcmlhLWhpZGRlbiI6ICJmYWxzZSIKCQkJCX0pOwoJCX0KCX0sCgoJX3Byb2Nlc3NUYWJzOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMudGFibGlzdCA9IHRoaXMuX2dldExpc3QoKQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLW5hdiB1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCIgKQoJCQkuYXR0ciggInJvbGUiLCAidGFibGlzdCIgKTsKCgkJdGhpcy50YWJzID0gdGhpcy50YWJsaXN0LmZpbmQoICI+IGxpOmhhcyhhW2hyZWZdKSIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1kZWZhdWx0IHVpLWNvcm5lci10b3AiICkKCQkJLmF0dHIoewoJCQkJcm9sZTogInRhYiIsCgkJCQl0YWJJbmRleDogLTEKCQkJfSk7CgoJCXRoaXMuYW5jaG9ycyA9IHRoaXMudGFicy5tYXAoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggImEiLCB0aGlzIClbIDAgXTsKCQkJfSkKCQkJLmFkZENsYXNzKCAidWktdGFicy1hbmNob3IiICkKCQkJLmF0dHIoewoJCQkJcm9sZTogInByZXNlbnRhdGlvbiIsCgkJCQl0YWJJbmRleDogLTEKCQkJfSk7CgoJCXRoaXMucGFuZWxzID0gJCgpOwoKCQl0aGlzLmFuY2hvcnMuZWFjaChmdW5jdGlvbiggaSwgYW5jaG9yICkgewoJCQl2YXIgc2VsZWN0b3IsIHBhbmVsLCBwYW5lbElkLAoJCQkJYW5jaG9ySWQgPSAkKCBhbmNob3IgKS51bmlxdWVJZCgpLmF0dHIoICJpZCIgKSwKCQkJCXRhYiA9ICQoIGFuY2hvciApLmNsb3Nlc3QoICJsaSIgKSwKCQkJCW9yaWdpbmFsQXJpYUNvbnRyb2xzID0gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoKCQkJLy8gaW5saW5lIHRhYgoJCQlpZiAoIGlzTG9jYWwoIGFuY2hvciApICkgewoJCQkJc2VsZWN0b3IgPSBhbmNob3IuaGFzaDsKCQkJCXBhbmVsID0gdGhhdC5lbGVtZW50LmZpbmQoIHRoYXQuX3Nhbml0aXplU2VsZWN0b3IoIHNlbGVjdG9yICkgKTsKCQkJLy8gcmVtb3RlIHRhYgoJCQl9IGVsc2UgewoJCQkJcGFuZWxJZCA9IHRoYXQuX3RhYklkKCB0YWIgKTsKCQkJCXNlbGVjdG9yID0gIiMiICsgcGFuZWxJZDsKCQkJCXBhbmVsID0gdGhhdC5lbGVtZW50LmZpbmQoIHNlbGVjdG9yICk7CgkJCQlpZiAoICFwYW5lbC5sZW5ndGggKSB7CgkJCQkJcGFuZWwgPSB0aGF0Ll9jcmVhdGVQYW5lbCggcGFuZWxJZCApOwoJCQkJCXBhbmVsLmluc2VydEFmdGVyKCB0aGF0LnBhbmVsc1sgaSAtIDEgXSB8fCB0aGF0LnRhYmxpc3QgKTsKCQkJCX0KCQkJCXBhbmVsLmF0dHIoICJhcmlhLWxpdmUiLCAicG9saXRlIiApOwoJCQl9CgoJCQlpZiAoIHBhbmVsLmxlbmd0aCkgewoJCQkJdGhhdC5wYW5lbHMgPSB0aGF0LnBhbmVscy5hZGQoIHBhbmVsICk7CgkJCX0KCQkJaWYgKCBvcmlnaW5hbEFyaWFDb250cm9scyApIHsKCQkJCXRhYi5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiwgb3JpZ2luYWxBcmlhQ29udHJvbHMgKTsKCQkJfQoJCQl0YWIuYXR0cih7CgkJCQkiYXJpYS1jb250cm9scyI6IHNlbGVjdG9yLnN1YnN0cmluZyggMSApLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGFuY2hvcklkCgkJCX0pOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiwgYW5jaG9ySWQgKTsKCQl9KTsKCgkJdGhpcy5wYW5lbHMKCQkJLmFkZENsYXNzKCAidWktdGFicy1wYW5lbCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYm90dG9tIiApCgkJCS5hdHRyKCAicm9sZSIsICJ0YWJwYW5lbCIgKTsKCX0sCgoJLy8gYWxsb3cgb3ZlcnJpZGluZyBob3cgdG8gZmluZCB0aGUgbGlzdCBmb3IgcmFyZSB1c2FnZSBzY2VuYXJpb3MgKCM3NzE1KQoJX2dldExpc3Q6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQuZmluZCggIm9sLHVsIiApLmVxKCAwICk7Cgl9LAoKCV9jcmVhdGVQYW5lbDogZnVuY3Rpb24oIGlkICkgewoJCXJldHVybiAkKCAiPGRpdj4iICkKCQkJLmF0dHIoICJpZCIsIGlkICkKCQkJLmFkZENsYXNzKCAidWktdGFicy1wYW5lbCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYm90dG9tIiApCgkJCS5kYXRhKCAidWktdGFicy1kZXN0cm95IiwgdHJ1ZSApOwoJfSwKCglfc2V0dXBEaXNhYmxlZDogZnVuY3Rpb24oIGRpc2FibGVkICkgewoJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQlpZiAoICFkaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlkaXNhYmxlZCA9IGZhbHNlOwoJCQl9IGVsc2UgaWYgKCBkaXNhYmxlZC5sZW5ndGggPT09IHRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCQlkaXNhYmxlZCA9IHRydWU7CgkJCX0KCQl9CgoJCS8vIGRpc2FibGUgdGFicwoJCWZvciAoIHZhciBpID0gMCwgbGk7ICggbGkgPSB0aGlzLnRhYnNbIGkgXSApOyBpKysgKSB7CgkJCWlmICggZGlzYWJsZWQgPT09IHRydWUgfHwgJC5pbkFycmF5KCBpLCBkaXNhYmxlZCApICE9PSAtMSApIHsKCQkJCSQoIGxpICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsICJ0cnVlIiApOwoJCQl9IGVsc2UgewoJCQkJJCggbGkgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApOwoJCQl9CgkJfQoKCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSBkaXNhYmxlZDsKCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGV2ZW50cyA9IHsKCQkJY2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9OwoJCWlmICggZXZlbnQgKSB7CgkJCSQuZWFjaCggZXZlbnQuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGluZGV4LCBldmVudE5hbWUgKSB7CgkJCQlldmVudHNbIGV2ZW50TmFtZSBdID0gIl9ldmVudEhhbmRsZXIiOwoJCQl9KTsKCQl9CgoJCXRoaXMuX29mZiggdGhpcy5hbmNob3JzLmFkZCggdGhpcy50YWJzICkuYWRkKCB0aGlzLnBhbmVscyApICk7CgkJdGhpcy5fb24oIHRoaXMuYW5jaG9ycywgZXZlbnRzICk7CgkJdGhpcy5fb24oIHRoaXMudGFicywgeyBrZXlkb3duOiAiX3RhYktleWRvd24iIH0gKTsKCQl0aGlzLl9vbiggdGhpcy5wYW5lbHMsIHsga2V5ZG93bjogIl9wYW5lbEtleWRvd24iIH0gKTsKCgkJdGhpcy5fZm9jdXNhYmxlKCB0aGlzLnRhYnMgKTsKCQl0aGlzLl9ob3ZlcmFibGUoIHRoaXMudGFicyApOwoJfSwKCglfc2V0dXBIZWlnaHRTdHlsZTogZnVuY3Rpb24oIGhlaWdodFN0eWxlICkgewoJCXZhciBtYXhIZWlnaHQsCgkJCXBhcmVudCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCgkJaWYgKCBoZWlnaHRTdHlsZSA9PT0gImZpbGwiICkgewoJCQltYXhIZWlnaHQgPSBwYXJlbnQuaGVpZ2h0KCk7CgkJCW1heEhlaWdodCAtPSB0aGlzLmVsZW1lbnQub3V0ZXJIZWlnaHQoKSAtIHRoaXMuZWxlbWVudC5oZWlnaHQoKTsKCgkJCXRoaXMuZWxlbWVudC5zaWJsaW5ncyggIjp2aXNpYmxlIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWxlbSA9ICQoIHRoaXMgKSwKCQkJCQlwb3NpdGlvbiA9IGVsZW0uY3NzKCAicG9zaXRpb24iICk7CgoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQltYXhIZWlnaHQgLT0gZWxlbS5vdXRlckhlaWdodCggdHJ1ZSApOwoJCQl9KTsKCgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbigpLm5vdCggdGhpcy5wYW5lbHMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0IC09ICQoIHRoaXMgKS5vdXRlckhlaWdodCggdHJ1ZSApOwoJCQl9KTsKCgkJCXRoaXMucGFuZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuaGVpZ2h0KCBNYXRoLm1heCggMCwgbWF4SGVpZ2h0IC0KCQkJCQkkKCB0aGlzICkuaW5uZXJIZWlnaHQoKSArICQoIHRoaXMgKS5oZWlnaHQoKSApICk7CgkJCX0pCgkJCS5jc3MoICJvdmVyZmxvdyIsICJhdXRvIiApOwoJCX0gZWxzZSBpZiAoIGhlaWdodFN0eWxlID09PSAiYXV0byIgKSB7CgkJCW1heEhlaWdodCA9IDA7CgkJCXRoaXMucGFuZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgPSBNYXRoLm1heCggbWF4SGVpZ2h0LCAkKCB0aGlzICkuaGVpZ2h0KCAiIiApLmhlaWdodCgpICk7CgkJCX0pLmhlaWdodCggbWF4SGVpZ2h0ICk7CgkJfQoJfSwKCglfZXZlbnRIYW5kbGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlLAoJCQlhbmNob3IgPSAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksCgkJCXRhYiA9IGFuY2hvci5jbG9zZXN0KCAibGkiICksCgkJCWNsaWNrZWRJc0FjdGl2ZSA9IHRhYlsgMCBdID09PSBhY3RpdmVbIDAgXSwKCQkJY29sbGFwc2luZyA9IGNsaWNrZWRJc0FjdGl2ZSAmJiBvcHRpb25zLmNvbGxhcHNpYmxlLAoJCQl0b1Nob3cgPSBjb2xsYXBzaW5nID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRhYiApLAoJCQl0b0hpZGUgPSAhYWN0aXZlLmxlbmd0aCA\/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCBhY3RpdmUgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJb2xkVGFiOiBhY3RpdmUsCgkJCQlvbGRQYW5lbDogdG9IaWRlLAoJCQkJbmV3VGFiOiBjb2xsYXBzaW5nID8gJCgpIDogdGFiLAoJCQkJbmV3UGFuZWw6IHRvU2hvdwoJCQl9OwoKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQlpZiAoIHRhYi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApIHx8CgkJCQkvLyB0YWIgaXMgYWxyZWFkeSBsb2FkaW5nCgkJCQl0YWIuaGFzQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICkgfHwKCQkJCS8vIGNhbid0IHN3aXRjaCBkdXJuaW5nIGFuIGFuaW1hdGlvbgoJCQkJdGhpcy5ydW5uaW5nIHx8CgkJCQkvLyBjbGljayBvbiBhY3RpdmUgaGVhZGVyLCBidXQgbm90IGNvbGxhcHNpYmxlCgkJCQkoIGNsaWNrZWRJc0FjdGl2ZSAmJiAhb3B0aW9ucy5jb2xsYXBzaWJsZSApIHx8CgkJCQkvLyBhbGxvdyBjYW5jZWxpbmcgYWN0aXZhdGlvbgoJCQkJKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQWN0aXZhdGUiLCBldmVudCwgZXZlbnREYXRhICkgPT09IGZhbHNlICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW9wdGlvbnMuYWN0aXZlID0gY29sbGFwc2luZyA\/IGZhbHNlIDogdGhpcy50YWJzLmluZGV4KCB0YWIgKTsKCgkJdGhpcy5hY3RpdmUgPSBjbGlja2VkSXNBY3RpdmUgPyAkKCkgOiB0YWI7CgkJaWYgKCB0aGlzLnhociApIHsKCQkJdGhpcy54aHIuYWJvcnQoKTsKCQl9CgoJCWlmICggIXRvSGlkZS5sZW5ndGggJiYgIXRvU2hvdy5sZW5ndGggKSB7CgkJCSQuZXJyb3IoICJqUXVlcnkgVUkgVGFiczogTWlzbWF0Y2hpbmcgZnJhZ21lbnQgaWRlbnRpZmllci4iICk7CgkJfQoKCQlpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMubG9hZCggdGhpcy50YWJzLmluZGV4KCB0YWIgKSwgZXZlbnQgKTsKCQl9CgkJdGhpcy5fdG9nZ2xlKCBldmVudCwgZXZlbnREYXRhICk7Cgl9LAoKCS8vIGhhbmRsZXMgc2hvdy9oaWRlIGZvciBzZWxlY3RpbmcgdGFicwoJX3RvZ2dsZTogZnVuY3Rpb24oIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0b1Nob3cgPSBldmVudERhdGEubmV3UGFuZWwsCgkJCXRvSGlkZSA9IGV2ZW50RGF0YS5vbGRQYW5lbDsKCgkJdGhpcy5ydW5uaW5nID0gdHJ1ZTsKCgkJZnVuY3Rpb24gY29tcGxldGUoKSB7CgkJCXRoYXQucnVubmluZyA9IGZhbHNlOwoJCQl0aGF0Ll90cmlnZ2VyKCAiYWN0aXZhdGUiLCBldmVudCwgZXZlbnREYXRhICk7CgkJfQoKCQlmdW5jdGlvbiBzaG93KCkgewoJCQlldmVudERhdGEubmV3VGFiLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCgkJCWlmICggdG9TaG93Lmxlbmd0aCAmJiB0aGF0Lm9wdGlvbnMuc2hvdyApIHsKCQkJCXRoYXQuX3Nob3coIHRvU2hvdywgdGhhdC5vcHRpb25zLnNob3csIGNvbXBsZXRlICk7CgkJCX0gZWxzZSB7CgkJCQl0b1Nob3cuc2hvdygpOwoJCQkJY29tcGxldGUoKTsKCQkJfQoJCX0KCgkJLy8gc3RhcnQgb3V0IGJ5IGhpZGluZywgdGhlbiBzaG93aW5nLCB0aGVuIGNvbXBsZXRpbmcKCQlpZiAoIHRvSGlkZS5sZW5ndGggJiYgdGhpcy5vcHRpb25zLmhpZGUgKSB7CgkJCXRoaXMuX2hpZGUoIHRvSGlkZSwgdGhpcy5vcHRpb25zLmhpZGUsIGZ1bmN0aW9uKCkgewoJCQkJZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQlzaG93KCk7CgkJCX0pOwoJCX0gZWxzZSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLnJlbW92ZUNsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoJCQl0b0hpZGUuaGlkZSgpOwoJCQlzaG93KCk7CgkJfQoKCQl0b0hpZGUuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJfSk7CgkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkvLyBJZiB3ZSdyZSBzd2l0Y2hpbmcgdGFicywgcmVtb3ZlIHRoZSBvbGQgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBvcGVuaW5nIGZyb20gY29sbGFwc2VkIHN0YXRlLCByZW1vdmUgdGhlIHByZXZpb3VzIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgY29sbGFwc2luZywgdGhlbiBrZWVwIHRoZSBjb2xsYXBzaW5nIHRhYiBpbiB0aGUgdGFiIG9yZGVyLgoJCWlmICggdG9TaG93Lmxlbmd0aCAmJiB0b0hpZGUubGVuZ3RoICkgewoJCQlldmVudERhdGEub2xkVGFiLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfSBlbHNlIGlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy50YWJzLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkuYXR0ciggInRhYkluZGV4IiApID09PSAwOwoJCQl9KQoJCQkuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9CgoJCXRvU2hvdy5hdHRyKHsKCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCSJhcmlhLWhpZGRlbiI6ICJmYWxzZSIKCQl9KTsKCQlldmVudERhdGEubmV3VGFiLmF0dHIoewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJdGFiSW5kZXg6IDAKCQl9KTsKCX0sCgoJX2FjdGl2YXRlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGFuY2hvciwKCQkJYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggaW5kZXggKTsKCgkJLy8gdHJ5aW5nIHRvIGFjdGl2YXRlIHRoZSBhbHJlYWR5IGFjdGl2ZSBwYW5lbAoJCWlmICggYWN0aXZlWyAwIF0gPT09IHRoaXMuYWN0aXZlWyAwIF0gKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIHRyeWluZyB0byBjb2xsYXBzZSwgc2ltdWxhdGUgYSBjbGljayBvbiB0aGUgY3VycmVudCBhY3RpdmUgaGVhZGVyCgkJaWYgKCAhYWN0aXZlLmxlbmd0aCApIHsKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmU7CgkJfQoKCQlhbmNob3IgPSBhY3RpdmUuZmluZCggIi51aS10YWJzLWFuY2hvciIgKVsgMCBdOwoJCXRoaXMuX2V2ZW50SGFuZGxlcih7CgkJCXRhcmdldDogYW5jaG9yLAoJCQljdXJyZW50VGFyZ2V0OiBhbmNob3IsCgkJCXByZXZlbnREZWZhdWx0OiAkLm5vb3AKCQl9KTsKCX0sCgoJX2ZpbmRBY3RpdmU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQlyZXR1cm4gaW5kZXggPT09IGZhbHNlID8gJCgpIDogdGhpcy50YWJzLmVxKCBpbmRleCApOwoJfSwKCglfZ2V0SW5kZXg6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQkvLyBtZXRhLWZ1bmN0aW9uIHRvIGdpdmUgdXNlcnMgb3B0aW9uIHRvIHByb3ZpZGUgYSBocmVmIHN0cmluZyBpbnN0ZWFkIG9mIGEgbnVtZXJpY2FsIGluZGV4LgoJCWlmICggdHlwZW9mIGluZGV4ID09PSAic3RyaW5nIiApIHsKCQkJaW5kZXggPSB0aGlzLmFuY2hvcnMuaW5kZXgoIHRoaXMuYW5jaG9ycy5maWx0ZXIoICJbaHJlZiQ9JyIgKyBpbmRleCArICInXSIgKSApOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnhociApIHsKCQkJdGhpcy54aHIuYWJvcnQoKTsKCQl9CgoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwgdWktdGFicy1jb2xsYXBzaWJsZSIgKTsKCgkJdGhpcy50YWJsaXN0CgkJCS5yZW1vdmVDbGFzcyggInVpLXRhYnMtbmF2IHVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsIiApCgkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCgkJdGhpcy5hbmNob3JzCgkJCS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYW5jaG9yIiApCgkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKQoJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCS5yZW1vdmVVbmlxdWVJZCgpOwoKCQl0aGlzLnRhYnMuYWRkKCB0aGlzLnBhbmVscyApLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggJC5kYXRhKCB0aGlzLCAidWktdGFicy1kZXN0cm95IiApICkgewoJCQkJJCggdGhpcyApLnJlbW92ZSgpOwoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1zdGF0ZS1hY3RpdmUgdWktc3RhdGUtZGlzYWJsZWQgIiArCgkJCQkJCSJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20gdWktd2lkZ2V0LWNvbnRlbnQgdWktdGFicy1hY3RpdmUgdWktdGFicy1wYW5lbCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGl2ZSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1idXN5IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLXNlbGVjdGVkIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWxhYmVsbGVkYnkiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtaGlkZGVuIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWV4cGFuZGVkIiApCgkJCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoJCQl9CgkJfSk7CgoJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgbGkgPSAkKCB0aGlzICksCgkJCQlwcmV2ID0gbGkuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIgKTsKCQkJaWYgKCBwcmV2ICkgewoJCQkJbGkKCQkJCQkuYXR0ciggImFyaWEtY29udHJvbHMiLCBwcmV2ICkKCQkJCQkucmVtb3ZlRGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIgKTsKCQkJfSBlbHNlIHsKCQkJCWxpLnJlbW92ZUF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoJCQl9CgkJfSk7CgoJCXRoaXMucGFuZWxzLnNob3coKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGVpZ2h0U3R5bGUgIT09ICJjb250ZW50IiApIHsKCQkJdGhpcy5wYW5lbHMuY3NzKCAiaGVpZ2h0IiwgIiIgKTsKCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBpbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQlkaXNhYmxlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggZGlzYWJsZWQsIGZ1bmN0aW9uKCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCB0aGlzLnRhYnMsIGZ1bmN0aW9uKCBsaSwgbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0pOwoJCQl9CgkJfQoJCXRoaXMuX3NldHVwRGlzYWJsZWQoIGRpc2FibGVkICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBpbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQlkaXNhYmxlZCA9IHRydWU7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmluQXJyYXkoIGluZGV4LCBkaXNhYmxlZCApICE9PSAtMSApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tZXJnZSggWyBpbmRleCBdLCBkaXNhYmxlZCApLnNvcnQoKTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gWyBpbmRleCBdOwoJCQl9CgkJfQoJCXRoaXMuX3NldHVwRGlzYWJsZWQoIGRpc2FibGVkICk7Cgl9LAoKCWxvYWQ6IGZ1bmN0aW9uKCBpbmRleCwgZXZlbnQgKSB7CgkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRhYiA9IHRoaXMudGFicy5lcSggaW5kZXggKSwKCQkJYW5jaG9yID0gdGFiLmZpbmQoICIudWktdGFicy1hbmNob3IiICksCgkJCXBhbmVsID0gdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRhYiApLAoJCQlldmVudERhdGEgPSB7CgkJCQl0YWI6IHRhYiwKCQkJCXBhbmVsOiBwYW5lbAoJCQl9OwoKCQkvLyBub3QgcmVtb3RlCgkJaWYgKCBpc0xvY2FsKCBhbmNob3JbIDAgXSApICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLnhociA9ICQuYWpheCggdGhpcy5fYWpheFNldHRpbmdzKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSApOwoKCQkvLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAoJCS8vIGpRdWVyeSA8MS44IHJldHVybnMgZmFsc2UgaWYgdGhlIHJlcXVlc3QgaXMgY2FuY2VsZWQgaW4gYmVmb3JlU2VuZCwKCQkvLyBidXQgYXMgb2YgMS44LCAkLmFqYXgoKSBhbHdheXMgcmV0dXJucyBhIGpxWEhSIG9iamVjdC4KCQlpZiAoIHRoaXMueGhyICYmIHRoaXMueGhyLnN0YXR1c1RleHQgIT09ICJjYW5jZWxlZCIgKSB7CgkJCXRhYi5hZGRDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJcGFuZWwuYXR0ciggImFyaWEtYnVzeSIsICJ0cnVlIiApOwoKCQkJdGhpcy54aHIKCQkJCS5zdWNjZXNzKGZ1bmN0aW9uKCByZXNwb25zZSApIHsKCQkJCQkvLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAoJCQkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzExNzc4CgkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJcGFuZWwuaHRtbCggcmVzcG9uc2UgKTsKCQkJCQkJdGhhdC5fdHJpZ2dlciggImxvYWQiLCBldmVudCwgZXZlbnREYXRhICk7CgkJCQkJfSwgMSApOwoJCQkJfSkKCQkJCS5jb21wbGV0ZShmdW5jdGlvbigganFYSFIsIHN0YXR1cyApIHsKCQkJCQkvLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAoJCQkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzExNzc4CgkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkJaWYgKCBzdGF0dXMgPT09ICJhYm9ydCIgKSB7CgkJCQkJCQl0aGF0LnBhbmVscy5zdG9wKCBmYWxzZSwgdHJ1ZSApOwoJCQkJCQl9CgoJCQkJCQl0YWIucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCQkJCXBhbmVsLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICk7CgoJCQkJCQlpZiAoIGpxWEhSID09PSB0aGF0LnhociApIHsKCQkJCQkJCWRlbGV0ZSB0aGF0LnhocjsKCQkJCQkJfQoJCQkJCX0sIDEgKTsKCQkJCX0pOwoJCX0KCX0sCgoJX2FqYXhTZXR0aW5nczogZnVuY3Rpb24oIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgkJcmV0dXJuIHsKCQkJdXJsOiBhbmNob3IuYXR0ciggImhyZWYiICksCgkJCWJlZm9yZVNlbmQ6IGZ1bmN0aW9uKCBqcVhIUiwgc2V0dGluZ3MgKSB7CgkJCQlyZXR1cm4gdGhhdC5fdHJpZ2dlciggImJlZm9yZUxvYWQiLCBldmVudCwKCQkJCQkkLmV4dGVuZCggeyBqcVhIUiA6IGpxWEhSLCBhamF4U2V0dGluZ3M6IHNldHRpbmdzIH0sIGV2ZW50RGF0YSApICk7CgkJCX0KCQl9OwoJfSwKCglfZ2V0UGFuZWxGb3JUYWI6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJdmFyIGlkID0gJCggdGFiICkuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCB0aGlzLl9zYW5pdGl6ZVNlbGVjdG9yKCAiIyIgKyBpZCApICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQgKSB7Cgp2YXIgaW5jcmVtZW50cyA9IDA7CgpmdW5jdGlvbiBhZGREZXNjcmliZWRCeSggZWxlbSwgaWQgKSB7Cgl2YXIgZGVzY3JpYmVkYnkgPSAoZWxlbS5hdHRyKCAiYXJpYS1kZXNjcmliZWRieSIgKSB8fCAiIikuc3BsaXQoIC9ccysvICk7CglkZXNjcmliZWRieS5wdXNoKCBpZCApOwoJZWxlbQoJCS5kYXRhKCAidWktdG9vbHRpcC1pZCIsIGlkICkKCQkuYXR0ciggImFyaWEtZGVzY3JpYmVkYnkiLCAkLnRyaW0oIGRlc2NyaWJlZGJ5LmpvaW4oICIgIiApICkgKTsKfQoKZnVuY3Rpb24gcmVtb3ZlRGVzY3JpYmVkQnkoIGVsZW0gKSB7Cgl2YXIgaWQgPSBlbGVtLmRhdGEoICJ1aS10b29sdGlwLWlkIiApLAoJCWRlc2NyaWJlZGJ5ID0gKGVsZW0uYXR0ciggImFyaWEtZGVzY3JpYmVkYnkiICkgfHwgIiIpLnNwbGl0KCAvXHMrLyApLAoJCWluZGV4ID0gJC5pbkFycmF5KCBpZCwgZGVzY3JpYmVkYnkgKTsKCWlmICggaW5kZXggIT09IC0xICkgewoJCWRlc2NyaWJlZGJ5LnNwbGljZSggaW5kZXgsIDEgKTsKCX0KCgllbGVtLnJlbW92ZURhdGEoICJ1aS10b29sdGlwLWlkIiApOwoJZGVzY3JpYmVkYnkgPSAkLnRyaW0oIGRlc2NyaWJlZGJ5LmpvaW4oICIgIiApICk7CglpZiAoIGRlc2NyaWJlZGJ5ICkgewoJCWVsZW0uYXR0ciggImFyaWEtZGVzY3JpYmVkYnkiLCBkZXNjcmliZWRieSApOwoJfSBlbHNlIHsKCQllbGVtLnJlbW92ZUF0dHIoICJhcmlhLWRlc2NyaWJlZGJ5IiApOwoJfQp9CgokLndpZGdldCggInVpLnRvb2x0aXAiLCB7Cgl2ZXJzaW9uOiAiMS4xMC4zIiwKCW9wdGlvbnM6IHsKCQljb250ZW50OiBmdW5jdGlvbigpIHsKCQkJLy8gc3VwcG9ydDogSUU8OSwgT3BlcmEgaW4galF1ZXJ5IDwxLjcKCQkJLy8gLnRleHQoKSBjYW4ndCBhY2NlcHQgdW5kZWZpbmVkLCBzbyBjb2VyY2UgdG8gYSBzdHJpbmcKCQkJdmFyIHRpdGxlID0gJCggdGhpcyApLmF0dHIoICJ0aXRsZSIgKSB8fCAiIjsKCQkJLy8gRXNjYXBlIHRpdGxlLCBzaW5jZSB3ZSdyZSBnb2luZyBmcm9tIGFuIGF0dHJpYnV0ZSB0byByYXcgSFRNTAoJCQlyZXR1cm4gJCggIjxhPiIgKS50ZXh0KCB0aXRsZSApLmh0bWwoKTsKCQl9LAoJCWhpZGU6IHRydWUsCgkJLy8gRGlzYWJsZWQgZWxlbWVudHMgaGF2ZSBpbmNvbnNpc3RlbnQgYmVoYXZpb3IgYWNyb3NzIGJyb3dzZXJzICgjODY2MSkKCQlpdGVtczogIlt0aXRsZV06bm90KFtkaXNhYmxlZF0pIiwKCQlwb3NpdGlvbjogewoJCQlteTogImxlZnQgdG9wKzE1IiwKCQkJYXQ6ICJsZWZ0IGJvdHRvbSIsCgkJCWNvbGxpc2lvbjogImZsaXBmaXQgZmxpcCIKCQl9LAoJCXNob3c6IHRydWUsCgkJdG9vbHRpcENsYXNzOiBudWxsLAoJCXRyYWNrOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY2xvc2U6IG51bGwsCgkJb3BlbjogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbih7CgkJCW1vdXNlb3ZlcjogIm9wZW4iLAoJCQlmb2N1c2luOiAib3BlbiIKCQl9KTsKCgkJLy8gSURzIG9mIGdlbmVyYXRlZCB0b29sdGlwcywgbmVlZGVkIGZvciBkZXN0cm95CgkJdGhpcy50b29sdGlwcyA9IHt9OwoJCS8vIElEcyBvZiBwYXJlbnQgdG9vbHRpcHMgd2hlcmUgd2UgcmVtb3ZlZCB0aGUgdGl0bGUgYXR0cmlidXRlCgkJdGhpcy5wYXJlbnRzID0ge307CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQl0aGlzLl9kaXNhYmxlKCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzWyB2YWx1ZSA\/ICJfZGlzYWJsZSIgOiAiX2VuYWJsZSIgXSgpOwoJCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCS8vIGRpc2FibGUgZWxlbWVudCBzdHlsZSBjaGFuZ2VzCgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCWlmICgga2V5ID09PSAiY29udGVudCIgKSB7CgkJCSQuZWFjaCggdGhpcy50b29sdGlwcywgZnVuY3Rpb24oIGlkLCBlbGVtZW50ICkgewoJCQkJdGhhdC5fdXBkYXRlQ29udGVudCggZWxlbWVudCApOwoJCQl9KTsKCQl9Cgl9LAoKCV9kaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCS8vIGNsb3NlIG9wZW4gdG9vbHRpcHMKCQkkLmVhY2goIHRoaXMudG9vbHRpcHMsIGZ1bmN0aW9uKCBpZCwgZWxlbWVudCApIHsKCQkJdmFyIGV2ZW50ID0gJC5FdmVudCggImJsdXIiICk7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBlbGVtZW50WzBdOwoJCQl0aGF0LmNsb3NlKCBldmVudCwgdHJ1ZSApOwoJCX0pOwoKCQkvLyByZW1vdmUgdGl0bGUgYXR0cmlidXRlcyB0byBwcmV2ZW50IG5hdGl2ZSB0b29sdGlwcwoJCXRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaXRlbXMgKS5hZGRCYWNrKCkuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICk7CgkJCWlmICggZWxlbWVudC5pcyggIlt0aXRsZV0iICkgKSB7CgkJCQllbGVtZW50CgkJCQkJLmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiwgZWxlbWVudC5hdHRyKCAidGl0bGUiICkgKQoJCQkJCS5hdHRyKCAidGl0bGUiLCAiIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV9lbmFibGU6IGZ1bmN0aW9uKCkgewoJCS8vIHJlc3RvcmUgdGl0bGUgYXR0cmlidXRlcwoJCXRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaXRlbXMgKS5hZGRCYWNrKCkuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICk7CgkJCWlmICggZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApIHsKCQkJCWVsZW1lbnQuYXR0ciggInRpdGxlIiwgZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOwoJCQl9CgkJfSk7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRhcmdldCA9ICQoIGV2ZW50ID8gZXZlbnQudGFyZ2V0IDogdGhpcy5lbGVtZW50ICkKCQkJCS8vIHdlIG5lZWQgY2xvc2VzdCBoZXJlIGR1ZSB0byBtb3VzZW92ZXIgYnViYmxpbmcsCgkJCQkvLyBidXQgYWx3YXlzIHBvaW50aW5nIGF0IHRoZSBzYW1lIGV2ZW50IHRhcmdldAoJCQkJLmNsb3Nlc3QoIHRoaXMub3B0aW9ucy5pdGVtcyApOwoKCQkvLyBObyBlbGVtZW50IHRvIHNob3cgYSB0b29sdGlwIGZvciBvciB0aGUgdG9vbHRpcCBpcyBhbHJlYWR5IG9wZW4KCQlpZiAoICF0YXJnZXQubGVuZ3RoIHx8IHRhcmdldC5kYXRhKCAidWktdG9vbHRpcC1pZCIgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0YXJnZXQuYXR0ciggInRpdGxlIiApICkgewoJCQl0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiLCB0YXJnZXQuYXR0ciggInRpdGxlIiApICk7CgkJfQoKCQl0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtb3BlbiIsIHRydWUgKTsKCgkJLy8ga2lsbCBwYXJlbnQgdG9vbHRpcHMsIGN1c3RvbSBvciBuYXRpdmUsIGZvciBob3ZlcgoJCWlmICggZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlb3ZlciIgKSB7CgkJCXRhcmdldC5wYXJlbnRzKCkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBwYXJlbnQgPSAkKCB0aGlzICksCgkJCQkJYmx1ckV2ZW50OwoJCQkJaWYgKCBwYXJlbnQuZGF0YSggInVpLXRvb2x0aXAtb3BlbiIgKSApIHsKCQkJCQlibHVyRXZlbnQgPSAkLkV2ZW50KCAiYmx1ciIgKTsKCQkJCQlibHVyRXZlbnQudGFyZ2V0ID0gYmx1ckV2ZW50LmN1cnJlbnRUYXJnZXQgPSB0aGlzOwoJCQkJCXRoYXQuY2xvc2UoIGJsdXJFdmVudCwgdHJ1ZSApOwoJCQkJfQoJCQkJaWYgKCBwYXJlbnQuYXR0ciggInRpdGxlIiApICkgewoJCQkJCXBhcmVudC51bmlxdWVJZCgpOwoJCQkJCXRoYXQucGFyZW50c1sgdGhpcy5pZCBdID0gewoJCQkJCQllbGVtZW50OiB0aGlzLAoJCQkJCQl0aXRsZTogcGFyZW50LmF0dHIoICJ0aXRsZSIgKQoJCQkJCX07CgkJCQkJcGFyZW50LmF0dHIoICJ0aXRsZSIsICIiICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJdGhpcy5fdXBkYXRlQ29udGVudCggdGFyZ2V0LCBldmVudCApOwoJfSwKCglfdXBkYXRlQ29udGVudDogZnVuY3Rpb24oIHRhcmdldCwgZXZlbnQgKSB7CgkJdmFyIGNvbnRlbnQsCgkJCWNvbnRlbnRPcHRpb24gPSB0aGlzLm9wdGlvbnMuY29udGVudCwKCQkJdGhhdCA9IHRoaXMsCgkJCWV2ZW50VHlwZSA9IGV2ZW50ID8gZXZlbnQudHlwZSA6IG51bGw7CgoJCWlmICggdHlwZW9mIGNvbnRlbnRPcHRpb24gPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gdGhpcy5fb3BlbiggZXZlbnQsIHRhcmdldCwgY29udGVudE9wdGlvbiApOwoJCX0KCgkJY29udGVudCA9IGNvbnRlbnRPcHRpb24uY2FsbCggdGFyZ2V0WzBdLCBmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgkJCS8vIGlnbm9yZSBhc3luYyByZXNwb25zZSBpZiB0b29sdGlwIHdhcyBjbG9zZWQgYWxyZWFkeQoJCQlpZiAoICF0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtb3BlbiIgKSApIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvLyBJRSBtYXkgaW5zdGFudGx5IHNlcnZlIGEgY2FjaGVkIHJlc3BvbnNlIGZvciBhamF4IHJlcXVlc3RzCgkJCS8vIGRlbGF5IHRoaXMgY2FsbCB0byBfb3BlbiBzbyB0aGUgb3RoZXIgY2FsbCB0byBfb3BlbiBydW5zIGZpcnN0CgkJCXRoYXQuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJLy8galF1ZXJ5IGNyZWF0ZXMgYSBzcGVjaWFsIGV2ZW50IGZvciBmb2N1c2luIHdoZW4gaXQgZG9lc24ndAoJCQkJLy8gZXhpc3QgbmF0aXZlbHkuIFRvIGltcHJvdmUgcGVyZm9ybWFuY2UsIHRoZSBuYXRpdmUgZXZlbnQKCQkJCS8vIG9iamVjdCBpcyByZXVzZWQgYW5kIHRoZSB0eXBlIGlzIGNoYW5nZWQuIFRoZXJlZm9yZSwgd2UgY2FuJ3QKCQkJCS8vIHJlbHkgb24gdGhlIHR5cGUgYmVpbmcgY29ycmVjdCBhZnRlciB0aGUgZXZlbnQgZmluaXNoZWQKCQkJCS8vIGJ1YmJsaW5nLCBzbyB3ZSBzZXQgaXQgYmFjayB0byB0aGUgcHJldmlvdXMgdmFsdWUuICgjODc0MCkKCQkJCWlmICggZXZlbnQgKSB7CgkJCQkJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCQkJCX0KCQkJCXRoaXMuX29wZW4oIGV2ZW50LCB0YXJnZXQsIHJlc3BvbnNlICk7CgkJCX0pOwoJCX0pOwoJCWlmICggY29udGVudCApIHsKCQkJdGhpcy5fb3BlbiggZXZlbnQsIHRhcmdldCwgY29udGVudCApOwoJCX0KCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBldmVudCwgdGFyZ2V0LCBjb250ZW50ICkgewoJCXZhciB0b29sdGlwLCBldmVudHMsIGRlbGF5ZWRTaG93LAoJCQlwb3NpdGlvbk9wdGlvbiA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLnBvc2l0aW9uICk7CgoJCWlmICggIWNvbnRlbnQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIENvbnRlbnQgY2FuIGJlIHVwZGF0ZWQgbXVsdGlwbGUgdGltZXMuIElmIHRoZSB0b29sdGlwIGFscmVhZHkKCQkvLyBleGlzdHMsIHRoZW4ganVzdCB1cGRhdGUgdGhlIGNvbnRlbnQgYW5kIGJhaWwuCgkJdG9vbHRpcCA9IHRoaXMuX2ZpbmQoIHRhcmdldCApOwoJCWlmICggdG9vbHRpcC5sZW5ndGggKSB7CgkJCXRvb2x0aXAuZmluZCggIi51aS10b29sdGlwLWNvbnRlbnQiICkuaHRtbCggY29udGVudCApOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBpZiB3ZSBoYXZlIGEgdGl0bGUsIGNsZWFyIGl0IHRvIHByZXZlbnQgdGhlIG5hdGl2ZSB0b29sdGlwCgkJLy8gd2UgaGF2ZSB0byBjaGVjayBmaXJzdCB0byBhdm9pZCBkZWZpbmluZyBhIHRpdGxlIGlmIG5vbmUgZXhpc3RzCgkJLy8gKHdlIGRvbid0IHdhbnQgdG8gY2F1c2UgYW4gZWxlbWVudCB0byBzdGFydCBtYXRjaGluZyBbdGl0bGVdKQoJCS8vCgkJLy8gV2UgdXNlIHJlbW92ZUF0dHIgb25seSBmb3Iga2V5IGV2ZW50cywgdG8gYWxsb3cgSUUgdG8gZXhwb3J0IHRoZSBjb3JyZWN0CgkJLy8gYWNjZXNzaWJsZSBhdHRyaWJ1dGVzLiBGb3IgbW91c2UgZXZlbnRzLCBzZXQgdG8gZW1wdHkgc3RyaW5nIHRvIGF2b2lkCgkJLy8gbmF0aXZlIHRvb2x0aXAgc2hvd2luZyB1cCAoaGFwcGVucyBvbmx5IHdoZW4gcmVtb3ZpbmcgaW5zaWRlIG1vdXNlb3ZlcikuCgkJaWYgKCB0YXJnZXQuaXMoICJbdGl0bGVdIiApICkgewoJCQlpZiAoIGV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW92ZXIiICkgewoJCQkJdGFyZ2V0LmF0dHIoICJ0aXRsZSIsICIiICk7CgkJCX0gZWxzZSB7CgkJCQl0YXJnZXQucmVtb3ZlQXR0ciggInRpdGxlIiApOwoJCQl9CgkJfQoKCQl0b29sdGlwID0gdGhpcy5fdG9vbHRpcCggdGFyZ2V0ICk7CgkJYWRkRGVzY3JpYmVkQnkoIHRhcmdldCwgdG9vbHRpcC5hdHRyKCAiaWQiICkgKTsKCQl0b29sdGlwLmZpbmQoICIudWktdG9vbHRpcC1jb250ZW50IiApLmh0bWwoIGNvbnRlbnQgKTsKCgkJZnVuY3Rpb24gcG9zaXRpb24oIGV2ZW50ICkgewoJCQlwb3NpdGlvbk9wdGlvbi5vZiA9IGV2ZW50OwoJCQlpZiAoIHRvb2x0aXAuaXMoICI6aGlkZGVuIiApICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRvb2x0aXAucG9zaXRpb24oIHBvc2l0aW9uT3B0aW9uICk7CgkJfQoJCWlmICggdGhpcy5vcHRpb25zLnRyYWNrICYmIGV2ZW50ICYmIC9ebW91c2UvLnRlc3QoIGV2ZW50LnR5cGUgKSApIHsKCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCW1vdXNlbW92ZTogcG9zaXRpb24KCQkJfSk7CgkJCS8vIHRyaWdnZXIgb25jZSB0byBvdmVycmlkZSBlbGVtZW50LXJlbGF0aXZlIHBvc2l0aW9uaW5nCgkJCXBvc2l0aW9uKCBldmVudCApOwoJCX0gZWxzZSB7CgkJCXRvb2x0aXAucG9zaXRpb24oICQuZXh0ZW5kKHsKCQkJCW9mOiB0YXJnZXQKCQkJfSwgdGhpcy5vcHRpb25zLnBvc2l0aW9uICkgKTsKCQl9CgoJCXRvb2x0aXAuaGlkZSgpOwoKCQl0aGlzLl9zaG93KCB0b29sdGlwLCB0aGlzLm9wdGlvbnMuc2hvdyApOwoJCS8vIEhhbmRsZSB0cmFja2luZyB0b29sdGlwcyB0aGF0IGFyZSBzaG93biB3aXRoIGEgZGVsYXkgKCM4NjQ0KS4gQXMgc29vbgoJCS8vIGFzIHRoZSB0b29sdGlwIGlzIHZpc2libGUsIHBvc2l0aW9uIHRoZSB0b29sdGlwIHVzaW5nIHRoZSBtb3N0IHJlY2VudAoJCS8vIGV2ZW50LgoJCWlmICggdGhpcy5vcHRpb25zLnNob3cgJiYgdGhpcy5vcHRpb25zLnNob3cuZGVsYXkgKSB7CgkJCWRlbGF5ZWRTaG93ID0gdGhpcy5kZWxheWVkU2hvdyA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0b29sdGlwLmlzKCAiOnZpc2libGUiICkgKSB7CgkJCQkJcG9zaXRpb24oIHBvc2l0aW9uT3B0aW9uLm9mICk7CgkJCQkJY2xlYXJJbnRlcnZhbCggZGVsYXllZFNob3cgKTsKCQkJCX0KCQkJfSwgJC5meC5pbnRlcnZhbCApOwoJCX0KCgkJdGhpcy5fdHJpZ2dlciggIm9wZW4iLCBldmVudCwgeyB0b29sdGlwOiB0b29sdGlwIH0gKTsKCgkJZXZlbnRzID0gewoJCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuRVNDQVBFICkgewoJCQkJCXZhciBmYWtlRXZlbnQgPSAkLkV2ZW50KGV2ZW50KTsKCQkJCQlmYWtlRXZlbnQuY3VycmVudFRhcmdldCA9IHRhcmdldFswXTsKCQkJCQl0aGlzLmNsb3NlKCBmYWtlRXZlbnQsIHRydWUgKTsKCQkJCX0KCQkJfSwKCQkJcmVtb3ZlOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3JlbW92ZVRvb2x0aXAoIHRvb2x0aXAgKTsKCQkJfQoJCX07CgkJaWYgKCAhZXZlbnQgfHwgZXZlbnQudHlwZSA9PT0gIm1vdXNlb3ZlciIgKSB7CgkJCWV2ZW50cy5tb3VzZWxlYXZlID0gImNsb3NlIjsKCQl9CgkJaWYgKCAhZXZlbnQgfHwgZXZlbnQudHlwZSA9PT0gImZvY3VzaW4iICkgewoJCQlldmVudHMuZm9jdXNvdXQgPSAiY2xvc2UiOwoJCX0KCQl0aGlzLl9vbiggdHJ1ZSwgdGFyZ2V0LCBldmVudHMgKTsKCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRhcmdldCA9ICQoIGV2ZW50ID8gZXZlbnQuY3VycmVudFRhcmdldCA6IHRoaXMuZWxlbWVudCApLAoJCQl0b29sdGlwID0gdGhpcy5fZmluZCggdGFyZ2V0ICk7CgoJCS8vIGRpc2FibGluZyBjbG9zZXMgdGhlIHRvb2x0aXAsIHNvIHdlIG5lZWQgdG8gdHJhY2sgd2hlbiB3ZSdyZSBjbG9zaW5nCgkJLy8gdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCBpbiBjYXNlIHRoZSB0b29sdGlwIGJlY29tZXMgZGlzYWJsZWQgb24gY2xvc2UKCQlpZiAoIHRoaXMuY2xvc2luZyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2xlYXIgdGhlIGludGVydmFsIGZvciBkZWxheWVkIHRyYWNraW5nIHRvb2x0aXBzCgkJY2xlYXJJbnRlcnZhbCggdGhpcy5kZWxheWVkU2hvdyApOwoKCQkvLyBvbmx5IHNldCB0aXRsZSBpZiB3ZSBoYWQgb25lIGJlZm9yZSAoc2VlIGNvbW1lbnQgaW4gX29wZW4oKSkKCQlpZiAoIHRhcmdldC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApIHsKCQkJdGFyZ2V0LmF0dHIoICJ0aXRsZSIsIHRhcmdldC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOwoJCX0KCgkJcmVtb3ZlRGVzY3JpYmVkQnkoIHRhcmdldCApOwoKCQl0b29sdGlwLnN0b3AoIHRydWUgKTsKCQl0aGlzLl9oaWRlKCB0b29sdGlwLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCXRoYXQuX3JlbW92ZVRvb2x0aXAoICQoIHRoaXMgKSApOwoJCX0pOwoKCQl0YXJnZXQucmVtb3ZlRGF0YSggInVpLXRvb2x0aXAtb3BlbiIgKTsKCQl0aGlzLl9vZmYoIHRhcmdldCwgIm1vdXNlbGVhdmUgZm9jdXNvdXQga2V5dXAiICk7CgkJLy8gUmVtb3ZlICdyZW1vdmUnIGJpbmRpbmcgb25seSBvbiBkZWxlZ2F0ZWQgdGFyZ2V0cwoJCWlmICggdGFyZ2V0WzBdICE9PSB0aGlzLmVsZW1lbnRbMF0gKSB7CgkJCXRoaXMuX29mZiggdGFyZ2V0LCAicmVtb3ZlIiApOwoJCX0KCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQsICJtb3VzZW1vdmUiICk7CgoJCWlmICggZXZlbnQgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlbGVhdmUiICkgewoJCQkkLmVhY2goIHRoaXMucGFyZW50cywgZnVuY3Rpb24oIGlkLCBwYXJlbnQgKSB7CgkJCQkkKCBwYXJlbnQuZWxlbWVudCApLmF0dHIoICJ0aXRsZSIsIHBhcmVudC50aXRsZSApOwoJCQkJZGVsZXRlIHRoYXQucGFyZW50c1sgaWQgXTsKCQkJfSk7CgkJfQoKCQl0aGlzLmNsb3NpbmcgPSB0cnVlOwoJCXRoaXMuX3RyaWdnZXIoICJjbG9zZSIsIGV2ZW50LCB7IHRvb2x0aXA6IHRvb2x0aXAgfSApOwoJCXRoaXMuY2xvc2luZyA9IGZhbHNlOwoJfSwKCglfdG9vbHRpcDogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIGlkID0gInVpLXRvb2x0aXAtIiArIGluY3JlbWVudHMrKywKCQkJdG9vbHRpcCA9ICQoICI8ZGl2PiIgKQoJCQkJLmF0dHIoewoJCQkJCWlkOiBpZCwKCQkJCQlyb2xlOiAidG9vbHRpcCIKCQkJCX0pCgkJCQkuYWRkQ2xhc3MoICJ1aS10b29sdGlwIHVpLXdpZGdldCB1aS1jb3JuZXItYWxsIHVpLXdpZGdldC1jb250ZW50ICIgKwoJCQkJCSggdGhpcy5vcHRpb25zLnRvb2x0aXBDbGFzcyB8fCAiIiApICk7CgkJJCggIjxkaXY+IiApCgkJCS5hZGRDbGFzcyggInVpLXRvb2x0aXAtY29udGVudCIgKQoJCQkuYXBwZW5kVG8oIHRvb2x0aXAgKTsKCQl0b29sdGlwLmFwcGVuZFRvKCB0aGlzLmRvY3VtZW50WzBdLmJvZHkgKTsKCQl0aGlzLnRvb2x0aXBzWyBpZCBdID0gZWxlbWVudDsKCQlyZXR1cm4gdG9vbHRpcDsKCX0sCgoJX2ZpbmQ6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdmFyIGlkID0gdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLWlkIiApOwoJCXJldHVybiBpZCA\/ICQoICIjIiArIGlkICkgOiAkKCk7Cgl9LAoKCV9yZW1vdmVUb29sdGlwOiBmdW5jdGlvbiggdG9vbHRpcCApIHsKCQl0b29sdGlwLnJlbW92ZSgpOwoJCWRlbGV0ZSB0aGlzLnRvb2x0aXBzWyB0b29sdGlwLmF0dHIoICJpZCIgKSBdOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQkvLyBjbG9zZSBvcGVuIHRvb2x0aXBzCgkJJC5lYWNoKCB0aGlzLnRvb2x0aXBzLCBmdW5jdGlvbiggaWQsIGVsZW1lbnQgKSB7CgkJCS8vIERlbGVnYXRlIHRvIGNsb3NlIG1ldGhvZCB0byBoYW5kbGUgY29tbW9uIGNsZWFudXAKCQkJdmFyIGV2ZW50ID0gJC5FdmVudCggImJsdXIiICk7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBlbGVtZW50WzBdOwoJCQl0aGF0LmNsb3NlKCBldmVudCwgdHJ1ZSApOwoKCQkJLy8gUmVtb3ZlIGltbWVkaWF0ZWx5OyBkZXN0cm95aW5nIGFuIG9wZW4gdG9vbHRpcCBkb2Vzbid0IHVzZSB0aGUKCQkJLy8gaGlkZSBhbmltYXRpb24KCQkJJCggIiMiICsgaWQgKS5yZW1vdmUoKTsKCgkJCS8vIFJlc3RvcmUgdGhlIHRpdGxlCgkJCWlmICggZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApIHsKCQkJCWVsZW1lbnQuYXR0ciggInRpdGxlIiwgZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOwoJCQkJZWxlbWVudC5yZW1vdmVEYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKTsKCQkJfQoJCX0pOwoJfQp9KTsKCn0oIGpRdWVyeSApICk7CihmdW5jdGlvbigkLCB1bmRlZmluZWQpIHsKCnZhciBkYXRhU3BhY2UgPSAidWktZWZmZWN0cy0iOwoKJC5lZmZlY3RzID0gewoJZWZmZWN0OiB7fQp9OwoKLyohCiAqIGpRdWVyeSBDb2xvciBBbmltYXRpb25zIHYyLjEuMgogKiBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1jb2xvcgogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiBXZWQgSmFuIDE2IDA4OjQ3OjA5IDIwMTMgLTA2MDAKICovCihmdW5jdGlvbiggalF1ZXJ5LCB1bmRlZmluZWQgKSB7CgoJdmFyIHN0ZXBIb29rcyA9ICJiYWNrZ3JvdW5kQ29sb3IgYm9yZGVyQm90dG9tQ29sb3IgYm9yZGVyTGVmdENvbG9yIGJvcmRlclJpZ2h0Q29sb3IgYm9yZGVyVG9wQ29sb3IgY29sb3IgY29sdW1uUnVsZUNvbG9yIG91dGxpbmVDb2xvciB0ZXh0RGVjb3JhdGlvbkNvbG9yIHRleHRFbXBoYXNpc0NvbG9yIiwKCgkvLyBwbHVzZXF1YWxzIHRlc3QgZm9yICs9IDEwMCAtPSAxMDAKCXJwbHVzZXF1YWxzID0gL14oW1wtK10pPVxzKihcZCtcLj9cZCopLywKCS8vIGEgc2V0IG9mIFJFJ3MgdGhhdCBjYW4gbWF0Y2ggc3RyaW5ncyBhbmQgZ2VuZXJhdGUgY29sb3IgdHVwbGVzLgoJc3RyaW5nUGFyc2VycyA9IFt7CgkJCXJlOiAvcmdiYT9cKFxzKihcZHsxLDN9KVxzKixccyooXGR7MSwzfSlccyosXHMqKFxkezEsM30pXHMqKD86LFxzKihcZD8oPzpcLlxkKyk\/KVxzKik\/XCkvLAoJCQlwYXJzZTogZnVuY3Rpb24oIGV4ZWNSZXN1bHQgKSB7CgkJCQlyZXR1cm4gWwoJCQkJCWV4ZWNSZXN1bHRbIDEgXSwKCQkJCQlleGVjUmVzdWx0WyAyIF0sCgkJCQkJZXhlY1Jlc3VsdFsgMyBdLAoJCQkJCWV4ZWNSZXN1bHRbIDQgXQoJCQkJXTsKCQkJfQoJCX0sIHsKCQkJcmU6IC9yZ2JhP1woXHMqKFxkKyg\/OlwuXGQrKT8pXCVccyosXHMqKFxkKyg\/OlwuXGQrKT8pXCVccyosXHMqKFxkKyg\/OlwuXGQrKT8pXCVccyooPzosXHMqKFxkPyg\/OlwuXGQrKT8pXHMqKT9cKS8sCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsKCQkJCXJldHVybiBbCgkJCQkJZXhlY1Jlc3VsdFsgMSBdICogMi41NSwKCQkJCQlleGVjUmVzdWx0WyAyIF0gKiAyLjU1LAoJCQkJCWV4ZWNSZXN1bHRbIDMgXSAqIDIuNTUsCgkJCQkJZXhlY1Jlc3VsdFsgNCBdCgkJCQldOwoJCQl9CgkJfSwgewoJCQkvLyB0aGlzIHJlZ2V4IGlnbm9yZXMgQS1GIGJlY2F1c2UgaXQncyBjb21wYXJlZCBhZ2FpbnN0IGFuIGFscmVhZHkgbG93ZXJjYXNlZCBzdHJpbmcKCQkJcmU6IC8jKFthLWYwLTldezJ9KShbYS1mMC05XXsyfSkoW2EtZjAtOV17Mn0pLywKCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgewoJCQkJcmV0dXJuIFsKCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMSBdLCAxNiApLAoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAyIF0sIDE2ICksCgkJCQkJcGFyc2VJbnQoIGV4ZWNSZXN1bHRbIDMgXSwgMTYgKQoJCQkJXTsKCQkJfQoJCX0sIHsKCQkJLy8gdGhpcyByZWdleCBpZ25vcmVzIEEtRiBiZWNhdXNlIGl0J3MgY29tcGFyZWQgYWdhaW5zdCBhbiBhbHJlYWR5IGxvd2VyY2FzZWQgc3RyaW5nCgkJCXJlOiAvIyhbYS1mMC05XSkoW2EtZjAtOV0pKFthLWYwLTldKS8sCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsKCQkJCXJldHVybiBbCgkJCQkJcGFyc2VJbnQoIGV4ZWNSZXN1bHRbIDEgXSArIGV4ZWNSZXN1bHRbIDEgXSwgMTYgKSwKCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMiBdICsgZXhlY1Jlc3VsdFsgMiBdLCAxNiApLAoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAzIF0gKyBleGVjUmVzdWx0WyAzIF0sIDE2ICkKCQkJCV07CgkJCX0KCQl9LCB7CgkJCXJlOiAvaHNsYT9cKFxzKihcZCsoPzpcLlxkKyk\/KVxzKixccyooXGQrKD86XC5cZCspPylcJVxzKixccyooXGQrKD86XC5cZCspPylcJVxzKig\/OixccyooXGQ\/KD86XC5cZCspPylccyopP1wpLywKCQkJc3BhY2U6ICJoc2xhIiwKCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgewoJCQkJcmV0dXJuIFsKCQkJCQlleGVjUmVzdWx0WyAxIF0sCgkJCQkJZXhlY1Jlc3VsdFsgMiBdIC8gMTAwLAoJCQkJCWV4ZWNSZXN1bHRbIDMgXSAvIDEwMCwKCQkJCQlleGVjUmVzdWx0WyA0IF0KCQkJCV07CgkJCX0KCQl9XSwKCgkvLyBqUXVlcnkuQ29sb3IoICkKCWNvbG9yID0galF1ZXJ5LkNvbG9yID0gZnVuY3Rpb24oIGNvbG9yLCBncmVlbiwgYmx1ZSwgYWxwaGEgKSB7CgkJcmV0dXJuIG5ldyBqUXVlcnkuQ29sb3IuZm4ucGFyc2UoIGNvbG9yLCBncmVlbiwgYmx1ZSwgYWxwaGEgKTsKCX0sCglzcGFjZXMgPSB7CgkJcmdiYTogewoJCQlwcm9wczogewoJCQkJcmVkOiB7CgkJCQkJaWR4OiAwLAoJCQkJCXR5cGU6ICJieXRlIgoJCQkJfSwKCQkJCWdyZWVuOiB7CgkJCQkJaWR4OiAxLAoJCQkJCXR5cGU6ICJieXRlIgoJCQkJfSwKCQkJCWJsdWU6IHsKCQkJCQlpZHg6IDIsCgkJCQkJdHlwZTogImJ5dGUiCgkJCQl9CgkJCX0KCQl9LAoKCQloc2xhOiB7CgkJCXByb3BzOiB7CgkJCQlodWU6IHsKCQkJCQlpZHg6IDAsCgkJCQkJdHlwZTogImRlZ3JlZXMiCgkJCQl9LAoJCQkJc2F0dXJhdGlvbjogewoJCQkJCWlkeDogMSwKCQkJCQl0eXBlOiAicGVyY2VudCIKCQkJCX0sCgkJCQlsaWdodG5lc3M6IHsKCQkJCQlpZHg6IDIsCgkJCQkJdHlwZTogInBlcmNlbnQiCgkJCQl9CgkJCX0KCQl9Cgl9LAoJcHJvcFR5cGVzID0gewoJCSJieXRlIjogewoJCQlmbG9vcjogdHJ1ZSwKCQkJbWF4OiAyNTUKCQl9LAoJCSJwZXJjZW50IjogewoJCQltYXg6IDEKCQl9LAoJCSJkZWdyZWVzIjogewoJCQltb2Q6IDM2MCwKCQkJZmxvb3I6IHRydWUKCQl9Cgl9LAoJc3VwcG9ydCA9IGNvbG9yLnN1cHBvcnQgPSB7fSwKCgkvLyBlbGVtZW50IGZvciBzdXBwb3J0IHRlc3RzCglzdXBwb3J0RWxlbSA9IGpRdWVyeSggIjxwPiIgKVsgMCBdLAoKCS8vIGNvbG9ycyA9IGpRdWVyeS5Db2xvci5uYW1lcwoJY29sb3JzLAoKCS8vIGxvY2FsIGFsaWFzZXMgb2YgZnVuY3Rpb25zIGNhbGxlZCBvZnRlbgoJZWFjaCA9IGpRdWVyeS5lYWNoOwoKLy8gZGV0ZXJtaW5lIHJnYmEgc3VwcG9ydCBpbW1lZGlhdGVseQpzdXBwb3J0RWxlbS5zdHlsZS5jc3NUZXh0ID0gImJhY2tncm91bmQtY29sb3I6cmdiYSgxLDEsMSwuNSkiOwpzdXBwb3J0LnJnYmEgPSBzdXBwb3J0RWxlbS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IuaW5kZXhPZiggInJnYmEiICkgPiAtMTsKCi8vIGRlZmluZSBjYWNoZSBuYW1lIGFuZCBhbHBoYSBwcm9wZXJ0aWVzCi8vIGZvciByZ2JhIGFuZCBoc2xhIHNwYWNlcwplYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgewoJc3BhY2UuY2FjaGUgPSAiXyIgKyBzcGFjZU5hbWU7CglzcGFjZS5wcm9wcy5hbHBoYSA9IHsKCQlpZHg6IDMsCgkJdHlwZTogInBlcmNlbnQiLAoJCWRlZjogMQoJfTsKfSk7CgpmdW5jdGlvbiBjbGFtcCggdmFsdWUsIHByb3AsIGFsbG93RW1wdHkgKSB7Cgl2YXIgdHlwZSA9IHByb3BUeXBlc1sgcHJvcC50eXBlIF0gfHwge307CgoJaWYgKCB2YWx1ZSA9PSBudWxsICkgewoJCXJldHVybiAoYWxsb3dFbXB0eSB8fCAhcHJvcC5kZWYpID8gbnVsbCA6IHByb3AuZGVmOwoJfQoKCS8vIH5+IGlzIGFuIHNob3J0IHdheSBvZiBkb2luZyBmbG9vciBmb3IgcG9zaXRpdmUgbnVtYmVycwoJdmFsdWUgPSB0eXBlLmZsb29yID8gfn52YWx1ZSA6IHBhcnNlRmxvYXQoIHZhbHVlICk7CgoJLy8gSUUgd2lsbCBwYXNzIGluIGVtcHR5IHN0cmluZ3MgYXMgdmFsdWUgZm9yIGFscGhhLAoJLy8gd2hpY2ggd2lsbCBoaXQgdGhpcyBjYXNlCglpZiAoIGlzTmFOKCB2YWx1ZSApICkgewoJCXJldHVybiBwcm9wLmRlZjsKCX0KCglpZiAoIHR5cGUubW9kICkgewoJCS8vIHdlIGFkZCBtb2QgYmVmb3JlIG1vZGRpbmcgdG8gbWFrZSBzdXJlIHRoYXQgbmVnYXRpdmVzIHZhbHVlcwoJCS8vIGdldCBjb252ZXJ0ZWQgcHJvcGVybHk6IC0xMCAtPiAzNTAKCQlyZXR1cm4gKHZhbHVlICsgdHlwZS5tb2QpICUgdHlwZS5tb2Q7Cgl9CgoJLy8gZm9yIG5vdyBhbGwgcHJvcGVydHkgdHlwZXMgd2l0aG91dCBtb2QgaGF2ZSBtaW4gYW5kIG1heAoJcmV0dXJuIDAgPiB2YWx1ZSA\/IDAgOiB0eXBlLm1heCA8IHZhbHVlID8gdHlwZS5tYXggOiB2YWx1ZTsKfQoKZnVuY3Rpb24gc3RyaW5nUGFyc2UoIHN0cmluZyApIHsKCXZhciBpbnN0ID0gY29sb3IoKSwKCQlyZ2JhID0gaW5zdC5fcmdiYSA9IFtdOwoKCXN0cmluZyA9IHN0cmluZy50b0xvd2VyQ2FzZSgpOwoKCWVhY2goIHN0cmluZ1BhcnNlcnMsIGZ1bmN0aW9uKCBpLCBwYXJzZXIgKSB7CgkJdmFyIHBhcnNlZCwKCQkJbWF0Y2ggPSBwYXJzZXIucmUuZXhlYyggc3RyaW5nICksCgkJCXZhbHVlcyA9IG1hdGNoICYmIHBhcnNlci5wYXJzZSggbWF0Y2ggKSwKCQkJc3BhY2VOYW1lID0gcGFyc2VyLnNwYWNlIHx8ICJyZ2JhIjsKCgkJaWYgKCB2YWx1ZXMgKSB7CgkJCXBhcnNlZCA9IGluc3RbIHNwYWNlTmFtZSBdKCB2YWx1ZXMgKTsKCgkJCS8vIGlmIHRoaXMgd2FzIGFuIHJnYmEgcGFyc2UgdGhlIGFzc2lnbm1lbnQgbWlnaHQgaGFwcGVuIHR3aWNlCgkJCS8vIG9oIHdlbGwuLi4uCgkJCWluc3RbIHNwYWNlc1sgc3BhY2VOYW1lIF0uY2FjaGUgXSA9IHBhcnNlZFsgc3BhY2VzWyBzcGFjZU5hbWUgXS5jYWNoZSBdOwoJCQlyZ2JhID0gaW5zdC5fcmdiYSA9IHBhcnNlZC5fcmdiYTsKCgkJCS8vIGV4aXQgZWFjaCggc3RyaW5nUGFyc2VycyApIGhlcmUgYmVjYXVzZSB3ZSBtYXRjaGVkCgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9KTsKCgkvLyBGb3VuZCBhIHN0cmluZ1BhcnNlciB0aGF0IGhhbmRsZWQgaXQKCWlmICggcmdiYS5sZW5ndGggKSB7CgoJCS8vIGlmIHRoaXMgY2FtZSBmcm9tIGEgcGFyc2VkIHN0cmluZywgZm9yY2UgInRyYW5zcGFyZW50IiB3aGVuIGFscGhhIGlzIDAKCQkvLyBjaHJvbWUsIChhbmQgbWF5YmUgb3RoZXJzKSByZXR1cm4gInRyYW5zcGFyZW50IiBhcyByZ2JhKDAsMCwwLDApCgkJaWYgKCByZ2JhLmpvaW4oKSA9PT0gIjAsMCwwLDAiICkgewoJCQlqUXVlcnkuZXh0ZW5kKCByZ2JhLCBjb2xvcnMudHJhbnNwYXJlbnQgKTsKCQl9CgkJcmV0dXJuIGluc3Q7Cgl9CgoJLy8gbmFtZWQgY29sb3JzCglyZXR1cm4gY29sb3JzWyBzdHJpbmcgXTsKfQoKY29sb3IuZm4gPSBqUXVlcnkuZXh0ZW5kKCBjb2xvci5wcm90b3R5cGUsIHsKCXBhcnNlOiBmdW5jdGlvbiggcmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEgKSB7CgkJaWYgKCByZWQgPT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fcmdiYSA9IFsgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCBdOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCByZWQuanF1ZXJ5IHx8IHJlZC5ub2RlVHlwZSApIHsKCQkJcmVkID0galF1ZXJ5KCByZWQgKS5jc3MoIGdyZWVuICk7CgkJCWdyZWVuID0gdW5kZWZpbmVkOwoJCX0KCgkJdmFyIGluc3QgPSB0aGlzLAoJCQl0eXBlID0galF1ZXJ5LnR5cGUoIHJlZCApLAoJCQlyZ2JhID0gdGhpcy5fcmdiYSA9IFtdOwoKCQkvLyBtb3JlIHRoYW4gMSBhcmd1bWVudCBzcGVjaWZpZWQgLSBhc3N1bWUgKCByZWQsIGdyZWVuLCBibHVlLCBhbHBoYSApCgkJaWYgKCBncmVlbiAhPT0gdW5kZWZpbmVkICkgewoJCQlyZWQgPSBbIHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhIF07CgkJCXR5cGUgPSAiYXJyYXkiOwoJCX0KCgkJaWYgKCB0eXBlID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIHRoaXMucGFyc2UoIHN0cmluZ1BhcnNlKCByZWQgKSB8fCBjb2xvcnMuX2RlZmF1bHQgKTsKCQl9CgoJCWlmICggdHlwZSA9PT0gImFycmF5IiApIHsKCQkJZWFjaCggc3BhY2VzLnJnYmEucHJvcHMsIGZ1bmN0aW9uKCBrZXksIHByb3AgKSB7CgkJCQlyZ2JhWyBwcm9wLmlkeCBdID0gY2xhbXAoIHJlZFsgcHJvcC5pZHggXSwgcHJvcCApOwoJCQl9KTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoIHR5cGUgPT09ICJvYmplY3QiICkgewoJCQlpZiAoIHJlZCBpbnN0YW5jZW9mIGNvbG9yICkgewoJCQkJZWFjaCggc3BhY2VzLCBmdW5jdGlvbiggc3BhY2VOYW1lLCBzcGFjZSApIHsKCQkJCQlpZiAoIHJlZFsgc3BhY2UuY2FjaGUgXSApIHsKCQkJCQkJaW5zdFsgc3BhY2UuY2FjaGUgXSA9IHJlZFsgc3BhY2UuY2FjaGUgXS5zbGljZSgpOwoJCQkJCX0KCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJZWFjaCggc3BhY2VzLCBmdW5jdGlvbiggc3BhY2VOYW1lLCBzcGFjZSApIHsKCQkJCQl2YXIgY2FjaGUgPSBzcGFjZS5jYWNoZTsKCQkJCQllYWNoKCBzcGFjZS5wcm9wcywgZnVuY3Rpb24oIGtleSwgcHJvcCApIHsKCgkJCQkJCS8vIGlmIHRoZSBjYWNoZSBkb2Vzbid0IGV4aXN0LCBhbmQgd2Uga25vdyBob3cgdG8gY29udmVydAoJCQkJCQlpZiAoICFpbnN0WyBjYWNoZSBdICYmIHNwYWNlLnRvICkgewoKCQkJCQkJCS8vIGlmIHRoZSB2YWx1ZSB3YXMgbnVsbCwgd2UgZG9uJ3QgbmVlZCB0byBjb3B5IGl0CgkJCQkJCQkvLyBpZiB0aGUga2V5IHdhcyBhbHBoYSwgd2UgZG9uJ3QgbmVlZCB0byBjb3B5IGl0IGVpdGhlcgoJCQkJCQkJaWYgKCBrZXkgPT09ICJhbHBoYSIgfHwgcmVkWyBrZXkgXSA9PSBudWxsICkgewoJCQkJCQkJCXJldHVybjsKCQkJCQkJCX0KCQkJCQkJCWluc3RbIGNhY2hlIF0gPSBzcGFjZS50byggaW5zdC5fcmdiYSApOwoJCQkJCQl9CgoJCQkJCQkvLyB0aGlzIGlzIHRoZSBvbmx5IGNhc2Ugd2hlcmUgd2UgYWxsb3cgbnVsbHMgZm9yIEFMTCBwcm9wZXJ0aWVzLgoJCQkJCQkvLyBjYWxsIGNsYW1wIHdpdGggYWx3YXlzQWxsb3dFbXB0eQoJCQkJCQlpbnN0WyBjYWNoZSBdWyBwcm9wLmlkeCBdID0gY2xhbXAoIHJlZFsga2V5IF0sIHByb3AsIHRydWUgKTsKCQkJCQl9KTsKCgkJCQkJLy8gZXZlcnl0aGluZyBkZWZpbmVkIGJ1dCBhbHBoYT8KCQkJCQlpZiAoIGluc3RbIGNhY2hlIF0gJiYgalF1ZXJ5LmluQXJyYXkoIG51bGwsIGluc3RbIGNhY2hlIF0uc2xpY2UoIDAsIDMgKSApIDwgMCApIHsKCQkJCQkJLy8gdXNlIHRoZSBkZWZhdWx0IG9mIDEKCQkJCQkJaW5zdFsgY2FjaGUgXVsgMyBdID0gMTsKCQkJCQkJaWYgKCBzcGFjZS5mcm9tICkgewoJCQkJCQkJaW5zdC5fcmdiYSA9IHNwYWNlLmZyb20oIGluc3RbIGNhY2hlIF0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCX0sCglpczogZnVuY3Rpb24oIGNvbXBhcmUgKSB7CgkJdmFyIGlzID0gY29sb3IoIGNvbXBhcmUgKSwKCQkJc2FtZSA9IHRydWUsCgkJCWluc3QgPSB0aGlzOwoKCQllYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBfLCBzcGFjZSApIHsKCQkJdmFyIGxvY2FsQ2FjaGUsCgkJCQlpc0NhY2hlID0gaXNbIHNwYWNlLmNhY2hlIF07CgkJCWlmIChpc0NhY2hlKSB7CgkJCQlsb2NhbENhY2hlID0gaW5zdFsgc3BhY2UuY2FjaGUgXSB8fCBzcGFjZS50byAmJiBzcGFjZS50byggaW5zdC5fcmdiYSApIHx8IFtdOwoJCQkJZWFjaCggc3BhY2UucHJvcHMsIGZ1bmN0aW9uKCBfLCBwcm9wICkgewoJCQkJCWlmICggaXNDYWNoZVsgcHJvcC5pZHggXSAhPSBudWxsICkgewoJCQkJCQlzYW1lID0gKCBpc0NhY2hlWyBwcm9wLmlkeCBdID09PSBsb2NhbENhY2hlWyBwcm9wLmlkeCBdICk7CgkJCQkJCXJldHVybiBzYW1lOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJCXJldHVybiBzYW1lOwoJCX0pOwoJCXJldHVybiBzYW1lOwoJfSwKCV9zcGFjZTogZnVuY3Rpb24oKSB7CgkJdmFyIHVzZWQgPSBbXSwKCQkJaW5zdCA9IHRoaXM7CgkJZWFjaCggc3BhY2VzLCBmdW5jdGlvbiggc3BhY2VOYW1lLCBzcGFjZSApIHsKCQkJaWYgKCBpbnN0WyBzcGFjZS5jYWNoZSBdICkgewoJCQkJdXNlZC5wdXNoKCBzcGFjZU5hbWUgKTsKCQkJfQoJCX0pOwoJCXJldHVybiB1c2VkLnBvcCgpOwoJfSwKCXRyYW5zaXRpb246IGZ1bmN0aW9uKCBvdGhlciwgZGlzdGFuY2UgKSB7CgkJdmFyIGVuZCA9IGNvbG9yKCBvdGhlciApLAoJCQlzcGFjZU5hbWUgPSBlbmQuX3NwYWNlKCksCgkJCXNwYWNlID0gc3BhY2VzWyBzcGFjZU5hbWUgXSwKCQkJc3RhcnRDb2xvciA9IHRoaXMuYWxwaGEoKSA9PT0gMCA\/IGNvbG9yKCAidHJhbnNwYXJlbnQiICkgOiB0aGlzLAoJCQlzdGFydCA9IHN0YXJ0Q29sb3JbIHNwYWNlLmNhY2hlIF0gfHwgc3BhY2UudG8oIHN0YXJ0Q29sb3IuX3JnYmEgKSwKCQkJcmVzdWx0ID0gc3RhcnQuc2xpY2UoKTsKCgkJZW5kID0gZW5kWyBzcGFjZS5jYWNoZSBdOwoJCWVhY2goIHNwYWNlLnByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgewoJCQl2YXIgaW5kZXggPSBwcm9wLmlkeCwKCQkJCXN0YXJ0VmFsdWUgPSBzdGFydFsgaW5kZXggXSwKCQkJCWVuZFZhbHVlID0gZW5kWyBpbmRleCBdLAoJCQkJdHlwZSA9IHByb3BUeXBlc1sgcHJvcC50eXBlIF0gfHwge307CgoJCQkvLyBpZiBudWxsLCBkb24ndCBvdmVycmlkZSBzdGFydCB2YWx1ZQoJCQlpZiAoIGVuZFZhbHVlID09PSBudWxsICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vIGlmIG51bGwgLSB1c2UgZW5kCgkJCWlmICggc3RhcnRWYWx1ZSA9PT0gbnVsbCApIHsKCQkJCXJlc3VsdFsgaW5kZXggXSA9IGVuZFZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB0eXBlLm1vZCApIHsKCQkJCQlpZiAoIGVuZFZhbHVlIC0gc3RhcnRWYWx1ZSA+IHR5cGUubW9kIC8gMiApIHsKCQkJCQkJc3RhcnRWYWx1ZSArPSB0eXBlLm1vZDsKCQkJCQl9IGVsc2UgaWYgKCBzdGFydFZhbHVlIC0gZW5kVmFsdWUgPiB0eXBlLm1vZCAvIDIgKSB7CgkJCQkJCXN0YXJ0VmFsdWUgLT0gdHlwZS5tb2Q7CgkJCQkJfQoJCQkJfQoJCQkJcmVzdWx0WyBpbmRleCBdID0gY2xhbXAoICggZW5kVmFsdWUgLSBzdGFydFZhbHVlICkgKiBkaXN0YW5jZSArIHN0YXJ0VmFsdWUsIHByb3AgKTsKCQkJfQoJCX0pOwoJCXJldHVybiB0aGlzWyBzcGFjZU5hbWUgXSggcmVzdWx0ICk7Cgl9LAoJYmxlbmQ6IGZ1bmN0aW9uKCBvcGFxdWUgKSB7CgkJLy8gaWYgd2UgYXJlIGFscmVhZHkgb3BhcXVlIC0gcmV0dXJuIG91cnNlbGYKCQlpZiAoIHRoaXMuX3JnYmFbIDMgXSA9PT0gMSApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl2YXIgcmdiID0gdGhpcy5fcmdiYS5zbGljZSgpLAoJCQlhID0gcmdiLnBvcCgpLAoJCQlibGVuZCA9IGNvbG9yKCBvcGFxdWUgKS5fcmdiYTsKCgkJcmV0dXJuIGNvbG9yKCBqUXVlcnkubWFwKCByZ2IsIGZ1bmN0aW9uKCB2LCBpICkgewoJCQlyZXR1cm4gKCAxIC0gYSApICogYmxlbmRbIGkgXSArIGEgKiB2OwoJCX0pKTsKCX0sCgl0b1JnYmFTdHJpbmc6IGZ1bmN0aW9uKCkgewoJCXZhciBwcmVmaXggPSAicmdiYSgiLAoJCQlyZ2JhID0galF1ZXJ5Lm1hcCggdGhpcy5fcmdiYSwgZnVuY3Rpb24oIHYsIGkgKSB7CgkJCQlyZXR1cm4gdiA9PSBudWxsID8gKCBpID4gMiA\/IDEgOiAwICkgOiB2OwoJCQl9KTsKCgkJaWYgKCByZ2JhWyAzIF0gPT09IDEgKSB7CgkJCXJnYmEucG9wKCk7CgkJCXByZWZpeCA9ICJyZ2IoIjsKCQl9CgoJCXJldHVybiBwcmVmaXggKyByZ2JhLmpvaW4oKSArICIpIjsKCX0sCgl0b0hzbGFTdHJpbmc6IGZ1bmN0aW9uKCkgewoJCXZhciBwcmVmaXggPSAiaHNsYSgiLAoJCQloc2xhID0galF1ZXJ5Lm1hcCggdGhpcy5oc2xhKCksIGZ1bmN0aW9uKCB2LCBpICkgewoJCQkJaWYgKCB2ID09IG51bGwgKSB7CgkJCQkJdiA9IGkgPiAyID8gMSA6IDA7CgkJCQl9CgoJCQkJLy8gY2F0Y2ggMSBhbmQgMgoJCQkJaWYgKCBpICYmIGkgPCAzICkgewoJCQkJCXYgPSBNYXRoLnJvdW5kKCB2ICogMTAwICkgKyAiJSI7CgkJCQl9CgkJCQlyZXR1cm4gdjsKCQkJfSk7CgoJCWlmICggaHNsYVsgMyBdID09PSAxICkgewoJCQloc2xhLnBvcCgpOwoJCQlwcmVmaXggPSAiaHNsKCI7CgkJfQoJCXJldHVybiBwcmVmaXggKyBoc2xhLmpvaW4oKSArICIpIjsKCX0sCgl0b0hleFN0cmluZzogZnVuY3Rpb24oIGluY2x1ZGVBbHBoYSApIHsKCQl2YXIgcmdiYSA9IHRoaXMuX3JnYmEuc2xpY2UoKSwKCQkJYWxwaGEgPSByZ2JhLnBvcCgpOwoKCQlpZiAoIGluY2x1ZGVBbHBoYSApIHsKCQkJcmdiYS5wdXNoKCB+figgYWxwaGEgKiAyNTUgKSApOwoJCX0KCgkJcmV0dXJuICIjIiArIGpRdWVyeS5tYXAoIHJnYmEsIGZ1bmN0aW9uKCB2ICkgewoKCQkJLy8gZGVmYXVsdCB0byAwIHdoZW4gbnVsbHMgZXhpc3QKCQkJdiA9ICggdiB8fCAwICkudG9TdHJpbmcoIDE2ICk7CgkJCXJldHVybiB2Lmxlbmd0aCA9PT0gMSA\/ICIwIiArIHYgOiB2OwoJCX0pLmpvaW4oIiIpOwoJfSwKCXRvU3RyaW5nOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fcmdiYVsgMyBdID09PSAwID8gInRyYW5zcGFyZW50IiA6IHRoaXMudG9SZ2JhU3RyaW5nKCk7Cgl9Cn0pOwpjb2xvci5mbi5wYXJzZS5wcm90b3R5cGUgPSBjb2xvci5mbjsKCi8vIGhzbGEgY29udmVyc2lvbnMgYWRhcHRlZCBmcm9tOgovLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL21hYXNoYWFjay9zb3VyY2UvYnJvd3NlL3BhY2thZ2VzL2dyYXBoaWNzL3RydW5rL3NyYy9ncmFwaGljcy9jb2xvcnMvSFVFMlJHQi5hcz9yPTUwMjEKCmZ1bmN0aW9uIGh1ZTJyZ2IoIHAsIHEsIGggKSB7CgloID0gKCBoICsgMSApICUgMTsKCWlmICggaCAqIDYgPCAxICkgewoJCXJldHVybiBwICsgKHEgLSBwKSAqIGggKiA2OwoJfQoJaWYgKCBoICogMiA8IDEpIHsKCQlyZXR1cm4gcTsKCX0KCWlmICggaCAqIDMgPCAyICkgewoJCXJldHVybiBwICsgKHEgLSBwKSAqICgoMi8zKSAtIGgpICogNjsKCX0KCXJldHVybiBwOwp9CgpzcGFjZXMuaHNsYS50byA9IGZ1bmN0aW9uICggcmdiYSApIHsKCWlmICggcmdiYVsgMCBdID09IG51bGwgfHwgcmdiYVsgMSBdID09IG51bGwgfHwgcmdiYVsgMiBdID09IG51bGwgKSB7CgkJcmV0dXJuIFsgbnVsbCwgbnVsbCwgbnVsbCwgcmdiYVsgMyBdIF07Cgl9Cgl2YXIgciA9IHJnYmFbIDAgXSAvIDI1NSwKCQlnID0gcmdiYVsgMSBdIC8gMjU1LAoJCWIgPSByZ2JhWyAyIF0gLyAyNTUsCgkJYSA9IHJnYmFbIDMgXSwKCQltYXggPSBNYXRoLm1heCggciwgZywgYiApLAoJCW1pbiA9IE1hdGgubWluKCByLCBnLCBiICksCgkJZGlmZiA9IG1heCAtIG1pbiwKCQlhZGQgPSBtYXggKyBtaW4sCgkJbCA9IGFkZCAqIDAuNSwKCQloLCBzOwoKCWlmICggbWluID09PSBtYXggKSB7CgkJaCA9IDA7Cgl9IGVsc2UgaWYgKCByID09PSBtYXggKSB7CgkJaCA9ICggNjAgKiAoIGcgLSBiICkgLyBkaWZmICkgKyAzNjA7Cgl9IGVsc2UgaWYgKCBnID09PSBtYXggKSB7CgkJaCA9ICggNjAgKiAoIGIgLSByICkgLyBkaWZmICkgKyAxMjA7Cgl9IGVsc2UgewoJCWggPSAoIDYwICogKCByIC0gZyApIC8gZGlmZiApICsgMjQwOwoJfQoKCS8vIGNocm9tYSAoZGlmZikgPT0gMCBtZWFucyBncmV5c2NhbGUgd2hpY2gsIGJ5IGRlZmluaXRpb24sIHNhdHVyYXRpb24gPSAwJQoJLy8gb3RoZXJ3aXNlLCBzYXR1cmF0aW9uIGlzIGJhc2VkIG9uIHRoZSByYXRpbyBvZiBjaHJvbWEgKGRpZmYpIHRvIGxpZ2h0bmVzcyAoYWRkKQoJaWYgKCBkaWZmID09PSAwICkgewoJCXMgPSAwOwoJfSBlbHNlIGlmICggbCA8PSAwLjUgKSB7CgkJcyA9IGRpZmYgLyBhZGQ7Cgl9IGVsc2UgewoJCXMgPSBkaWZmIC8gKCAyIC0gYWRkICk7Cgl9CglyZXR1cm4gWyBNYXRoLnJvdW5kKGgpICUgMzYwLCBzLCBsLCBhID09IG51bGwgPyAxIDogYSBdOwp9OwoKc3BhY2VzLmhzbGEuZnJvbSA9IGZ1bmN0aW9uICggaHNsYSApIHsKCWlmICggaHNsYVsgMCBdID09IG51bGwgfHwgaHNsYVsgMSBdID09IG51bGwgfHwgaHNsYVsgMiBdID09IG51bGwgKSB7CgkJcmV0dXJuIFsgbnVsbCwgbnVsbCwgbnVsbCwgaHNsYVsgMyBdIF07Cgl9Cgl2YXIgaCA9IGhzbGFbIDAgXSAvIDM2MCwKCQlzID0gaHNsYVsgMSBdLAoJCWwgPSBoc2xhWyAyIF0sCgkJYSA9IGhzbGFbIDMgXSwKCQlxID0gbCA8PSAwLjUgPyBsICogKCAxICsgcyApIDogbCArIHMgLSBsICogcywKCQlwID0gMiAqIGwgLSBxOwoKCXJldHVybiBbCgkJTWF0aC5yb3VuZCggaHVlMnJnYiggcCwgcSwgaCArICggMSAvIDMgKSApICogMjU1ICksCgkJTWF0aC5yb3VuZCggaHVlMnJnYiggcCwgcSwgaCApICogMjU1ICksCgkJTWF0aC5yb3VuZCggaHVlMnJnYiggcCwgcSwgaCAtICggMSAvIDMgKSApICogMjU1ICksCgkJYQoJXTsKfTsKCgplYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgewoJdmFyIHByb3BzID0gc3BhY2UucHJvcHMsCgkJY2FjaGUgPSBzcGFjZS5jYWNoZSwKCQl0byA9IHNwYWNlLnRvLAoJCWZyb20gPSBzcGFjZS5mcm9tOwoKCS8vIG1ha2VzIHJnYmEoKSBhbmQgaHNsYSgpCgljb2xvci5mblsgc3BhY2VOYW1lIF0gPSBmdW5jdGlvbiggdmFsdWUgKSB7CgoJCS8vIGdlbmVyYXRlIGEgY2FjaGUgZm9yIHRoaXMgc3BhY2UgaWYgaXQgZG9lc24ndCBleGlzdAoJCWlmICggdG8gJiYgIXRoaXNbIGNhY2hlIF0gKSB7CgkJCXRoaXNbIGNhY2hlIF0gPSB0byggdGhpcy5fcmdiYSApOwoJCX0KCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzWyBjYWNoZSBdLnNsaWNlKCk7CgkJfQoKCQl2YXIgcmV0LAoJCQl0eXBlID0galF1ZXJ5LnR5cGUoIHZhbHVlICksCgkJCWFyciA9ICggdHlwZSA9PT0gImFycmF5IiB8fCB0eXBlID09PSAib2JqZWN0IiApID8gdmFsdWUgOiBhcmd1bWVudHMsCgkJCWxvY2FsID0gdGhpc1sgY2FjaGUgXS5zbGljZSgpOwoKCQllYWNoKCBwcm9wcywgZnVuY3Rpb24oIGtleSwgcHJvcCApIHsKCQkJdmFyIHZhbCA9IGFyclsgdHlwZSA9PT0gIm9iamVjdCIgPyBrZXkgOiBwcm9wLmlkeCBdOwoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gbG9jYWxbIHByb3AuaWR4IF07CgkJCX0KCQkJbG9jYWxbIHByb3AuaWR4IF0gPSBjbGFtcCggdmFsLCBwcm9wICk7CgkJfSk7CgoJCWlmICggZnJvbSApIHsKCQkJcmV0ID0gY29sb3IoIGZyb20oIGxvY2FsICkgKTsKCQkJcmV0WyBjYWNoZSBdID0gbG9jYWw7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGNvbG9yKCBsb2NhbCApOwoJCX0KCX07CgoJLy8gbWFrZXMgcmVkKCkgZ3JlZW4oKSBibHVlKCkgYWxwaGEoKSBodWUoKSBzYXR1cmF0aW9uKCkgbGlnaHRuZXNzKCkKCWVhY2goIHByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgewoJCS8vIGFscGhhIGlzIGluY2x1ZGVkIGluIG1vcmUgdGhhbiBvbmUgc3BhY2UKCQlpZiAoIGNvbG9yLmZuWyBrZXkgXSApIHsKCQkJcmV0dXJuOwoJCX0KCQljb2xvci5mblsga2V5IF0gPSBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciB2dHlwZSA9IGpRdWVyeS50eXBlKCB2YWx1ZSApLAoJCQkJZm4gPSAoIGtleSA9PT0gImFscGhhIiA\/ICggdGhpcy5faHNsYSA\/ICJoc2xhIiA6ICJyZ2JhIiApIDogc3BhY2VOYW1lICksCgkJCQlsb2NhbCA9IHRoaXNbIGZuIF0oKSwKCQkJCWN1ciA9IGxvY2FsWyBwcm9wLmlkeCBdLAoJCQkJbWF0Y2g7CgoJCQlpZiAoIHZ0eXBlID09PSAidW5kZWZpbmVkIiApIHsKCQkJCXJldHVybiBjdXI7CgkJCX0KCgkJCWlmICggdnR5cGUgPT09ICJmdW5jdGlvbiIgKSB7CgkJCQl2YWx1ZSA9IHZhbHVlLmNhbGwoIHRoaXMsIGN1ciApOwoJCQkJdnR5cGUgPSBqUXVlcnkudHlwZSggdmFsdWUgKTsKCQkJfQoJCQlpZiAoIHZhbHVlID09IG51bGwgJiYgcHJvcC5lbXB0eSApIHsKCQkJCXJldHVybiB0aGlzOwoJCQl9CgkJCWlmICggdnR5cGUgPT09ICJzdHJpbmciICkgewoJCQkJbWF0Y2ggPSBycGx1c2VxdWFscy5leGVjKCB2YWx1ZSApOwoJCQkJaWYgKCBtYXRjaCApIHsKCQkJCQl2YWx1ZSA9IGN1ciArIHBhcnNlRmxvYXQoIG1hdGNoWyAyIF0gKSAqICggbWF0Y2hbIDEgXSA9PT0gIisiID8gMSA6IC0xICk7CgkJCQl9CgkJCX0KCQkJbG9jYWxbIHByb3AuaWR4IF0gPSB2YWx1ZTsKCQkJcmV0dXJuIHRoaXNbIGZuIF0oIGxvY2FsICk7CgkJfTsKCX0pOwp9KTsKCi8vIGFkZCBjc3NIb29rIGFuZCAuZnguc3RlcCBmdW5jdGlvbiBmb3IgZWFjaCBuYW1lZCBob29rLgovLyBhY2NlcHQgYSBzcGFjZSBzZXBhcmF0ZWQgc3RyaW5nIG9mIHByb3BlcnRpZXMKY29sb3IuaG9vayA9IGZ1bmN0aW9uKCBob29rICkgewoJdmFyIGhvb2tzID0gaG9vay5zcGxpdCggIiAiICk7CgllYWNoKCBob29rcywgZnVuY3Rpb24oIGksIGhvb2sgKSB7CgkJalF1ZXJ5LmNzc0hvb2tzWyBob29rIF0gPSB7CgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJdmFyIHBhcnNlZCwgY3VyRWxlbSwKCQkJCQliYWNrZ3JvdW5kQ29sb3IgPSAiIjsKCgkJCQlpZiAoIHZhbHVlICE9PSAidHJhbnNwYXJlbnQiICYmICggalF1ZXJ5LnR5cGUoIHZhbHVlICkgIT09ICJzdHJpbmciIHx8ICggcGFyc2VkID0gc3RyaW5nUGFyc2UoIHZhbHVlICkgKSApICkgewoJCQkJCXZhbHVlID0gY29sb3IoIHBhcnNlZCB8fCB2YWx1ZSApOwoJCQkJCWlmICggIXN1cHBvcnQucmdiYSAmJiB2YWx1ZS5fcmdiYVsgMyBdICE9PSAxICkgewoJCQkJCQljdXJFbGVtID0gaG9vayA9PT0gImJhY2tncm91bmRDb2xvciIgPyBlbGVtLnBhcmVudE5vZGUgOiBlbGVtOwoJCQkJCQl3aGlsZSAoCgkJCQkJCQkoYmFja2dyb3VuZENvbG9yID09PSAiIiB8fCBiYWNrZ3JvdW5kQ29sb3IgPT09ICJ0cmFuc3BhcmVudCIpICYmCgkJCQkJCQljdXJFbGVtICYmIGN1ckVsZW0uc3R5bGUKCQkJCQkJKSB7CgkJCQkJCQl0cnkgewoJCQkJCQkJCWJhY2tncm91bmRDb2xvciA9IGpRdWVyeS5jc3MoIGN1ckVsZW0sICJiYWNrZ3JvdW5kQ29sb3IiICk7CgkJCQkJCQkJY3VyRWxlbSA9IGN1ckVsZW0ucGFyZW50Tm9kZTsKCQkJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQl2YWx1ZSA9IHZhbHVlLmJsZW5kKCBiYWNrZ3JvdW5kQ29sb3IgJiYgYmFja2dyb3VuZENvbG9yICE9PSAidHJhbnNwYXJlbnQiID8KCQkJCQkJCWJhY2tncm91bmRDb2xvciA6CgkJCQkJCQkiX2RlZmF1bHQiICk7CgkJCQkJfQoKCQkJCQl2YWx1ZSA9IHZhbHVlLnRvUmdiYVN0cmluZygpOwoJCQkJfQoJCQkJdHJ5IHsKCQkJCQllbGVtLnN0eWxlWyBob29rIF0gPSB2YWx1ZTsKCQkJCX0gY2F0Y2goIGUgKSB7CgkJCQkJLy8gd3JhcHBlZCB0byBwcmV2ZW50IElFIGZyb20gdGhyb3dpbmcgZXJyb3JzIG9uICJpbnZhbGlkIiB2YWx1ZXMgbGlrZSAnYXV0bycgb3IgJ2luaGVyaXQnCgkJCQl9CgkJCX0KCQl9OwoJCWpRdWVyeS5meC5zdGVwWyBob29rIF0gPSBmdW5jdGlvbiggZnggKSB7CgkJCWlmICggIWZ4LmNvbG9ySW5pdCApIHsKCQkJCWZ4LnN0YXJ0ID0gY29sb3IoIGZ4LmVsZW0sIGhvb2sgKTsKCQkJCWZ4LmVuZCA9IGNvbG9yKCBmeC5lbmQgKTsKCQkJCWZ4LmNvbG9ySW5pdCA9IHRydWU7CgkJCX0KCQkJalF1ZXJ5LmNzc0hvb2tzWyBob29rIF0uc2V0KCBmeC5lbGVtLCBmeC5zdGFydC50cmFuc2l0aW9uKCBmeC5lbmQsIGZ4LnBvcyApICk7CgkJfTsKCX0pOwoKfTsKCmNvbG9yLmhvb2soIHN0ZXBIb29rcyApOwoKalF1ZXJ5LmNzc0hvb2tzLmJvcmRlckNvbG9yID0gewoJZXhwYW5kOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGV4cGFuZGVkID0ge307CgoJCWVhY2goIFsgIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCIgXSwgZnVuY3Rpb24oIGksIHBhcnQgKSB7CgkJCWV4cGFuZGVkWyAiYm9yZGVyIiArIHBhcnQgKyAiQ29sb3IiIF0gPSB2YWx1ZTsKCQl9KTsKCQlyZXR1cm4gZXhwYW5kZWQ7Cgl9Cn07CgovLyBCYXNpYyBjb2xvciBuYW1lcyBvbmx5LgovLyBVc2FnZSBvZiBhbnkgb2YgdGhlIG90aGVyIGNvbG9yIG5hbWVzIHJlcXVpcmVzIGFkZGluZyB5b3Vyc2VsZiBvciBpbmNsdWRpbmcKLy8ganF1ZXJ5LmNvbG9yLnN2Zy1uYW1lcy5qcy4KY29sb3JzID0galF1ZXJ5LkNvbG9yLm5hbWVzID0gewoJLy8gNC4xLiBCYXNpYyBjb2xvciBrZXl3b3JkcwoJYXF1YTogIiMwMGZmZmYiLAoJYmxhY2s6ICIjMDAwMDAwIiwKCWJsdWU6ICIjMDAwMGZmIiwKCWZ1Y2hzaWE6ICIjZmYwMGZmIiwKCWdyYXk6ICIjODA4MDgwIiwKCWdyZWVuOiAiIzAwODAwMCIsCglsaW1lOiAiIzAwZmYwMCIsCgltYXJvb246ICIjODAwMDAwIiwKCW5hdnk6ICIjMDAwMDgwIiwKCW9saXZlOiAiIzgwODAwMCIsCglwdXJwbGU6ICIjODAwMDgwIiwKCXJlZDogIiNmZjAwMDAiLAoJc2lsdmVyOiAiI2MwYzBjMCIsCgl0ZWFsOiAiIzAwODA4MCIsCgl3aGl0ZTogIiNmZmZmZmYiLAoJeWVsbG93OiAiI2ZmZmYwMCIsCgoJLy8gNC4yLjMuICJ0cmFuc3BhcmVudCIgY29sb3Iga2V5d29yZAoJdHJhbnNwYXJlbnQ6IFsgbnVsbCwgbnVsbCwgbnVsbCwgMCBdLAoKCV9kZWZhdWx0OiAiI2ZmZmZmZiIKfTsKCn0pKCBqUXVlcnkgKTsKCgovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqIENMQVNTIEFOSU1BVElPTlMgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwooZnVuY3Rpb24oKSB7Cgp2YXIgY2xhc3NBbmltYXRpb25BY3Rpb25zID0gWyAiYWRkIiwgInJlbW92ZSIsICJ0b2dnbGUiIF0sCglzaG9ydGhhbmRTdHlsZXMgPSB7CgkJYm9yZGVyOiAxLAoJCWJvcmRlckJvdHRvbTogMSwKCQlib3JkZXJDb2xvcjogMSwKCQlib3JkZXJMZWZ0OiAxLAoJCWJvcmRlclJpZ2h0OiAxLAoJCWJvcmRlclRvcDogMSwKCQlib3JkZXJXaWR0aDogMSwKCQltYXJnaW46IDEsCgkJcGFkZGluZzogMQoJfTsKCiQuZWFjaChbICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJUb3BTdHlsZSIgXSwgZnVuY3Rpb24oIF8sIHByb3AgKSB7CgkkLmZ4LnN0ZXBbIHByb3AgXSA9IGZ1bmN0aW9uKCBmeCApIHsKCQlpZiAoIGZ4LmVuZCAhPT0gIm5vbmUiICYmICFmeC5zZXRBdHRyIHx8IGZ4LnBvcyA9PT0gMSAmJiAhZnguc2V0QXR0ciApIHsKCQkJalF1ZXJ5LnN0eWxlKCBmeC5lbGVtLCBwcm9wLCBmeC5lbmQgKTsKCQkJZnguc2V0QXR0ciA9IHRydWU7CgkJfQoJfTsKfSk7CgpmdW5jdGlvbiBnZXRFbGVtZW50U3R5bGVzKCBlbGVtICkgewoJdmFyIGtleSwgbGVuLAoJCXN0eWxlID0gZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3ID8KCQkJZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoIGVsZW0sIG51bGwgKSA6CgkJCWVsZW0uY3VycmVudFN0eWxlLAoJCXN0eWxlcyA9IHt9OwoKCWlmICggc3R5bGUgJiYgc3R5bGUubGVuZ3RoICYmIHN0eWxlWyAwIF0gJiYgc3R5bGVbIHN0eWxlWyAwIF0gXSApIHsKCQlsZW4gPSBzdHlsZS5sZW5ndGg7CgkJd2hpbGUgKCBsZW4tLSApIHsKCQkJa2V5ID0gc3R5bGVbIGxlbiBdOwoJCQlpZiAoIHR5cGVvZiBzdHlsZVsga2V5IF0gPT09ICJzdHJpbmciICkgewoJCQkJc3R5bGVzWyAkLmNhbWVsQ2FzZSgga2V5ICkgXSA9IHN0eWxlWyBrZXkgXTsKCQkJfQoJCX0KCS8vIHN1cHBvcnQ6IE9wZXJhLCBJRSA8OQoJfSBlbHNlIHsKCQlmb3IgKCBrZXkgaW4gc3R5bGUgKSB7CgkJCWlmICggdHlwZW9mIHN0eWxlWyBrZXkgXSA9PT0gInN0cmluZyIgKSB7CgkJCQlzdHlsZXNbIGtleSBdID0gc3R5bGVbIGtleSBdOwoJCQl9CgkJfQoJfQoKCXJldHVybiBzdHlsZXM7Cn0KCgpmdW5jdGlvbiBzdHlsZURpZmZlcmVuY2UoIG9sZFN0eWxlLCBuZXdTdHlsZSApIHsKCXZhciBkaWZmID0ge30sCgkJbmFtZSwgdmFsdWU7CgoJZm9yICggbmFtZSBpbiBuZXdTdHlsZSApIHsKCQl2YWx1ZSA9IG5ld1N0eWxlWyBuYW1lIF07CgkJaWYgKCBvbGRTdHlsZVsgbmFtZSBdICE9PSB2YWx1ZSApIHsKCQkJaWYgKCAhc2hvcnRoYW5kU3R5bGVzWyBuYW1lIF0gKSB7CgkJCQlpZiAoICQuZnguc3RlcFsgbmFtZSBdIHx8ICFpc05hTiggcGFyc2VGbG9hdCggdmFsdWUgKSApICkgewoJCQkJCWRpZmZbIG5hbWUgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoKCXJldHVybiBkaWZmOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgokLmVmZmVjdHMuYW5pbWF0ZUNsYXNzID0gZnVuY3Rpb24oIHZhbHVlLCBkdXJhdGlvbiwgZWFzaW5nLCBjYWxsYmFjayApIHsKCXZhciBvID0gJC5zcGVlZCggZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2sgKTsKCglyZXR1cm4gdGhpcy5xdWV1ZSggZnVuY3Rpb24oKSB7CgkJdmFyIGFuaW1hdGVkID0gJCggdGhpcyApLAoJCQliYXNlQ2xhc3MgPSBhbmltYXRlZC5hdHRyKCAiY2xhc3MiICkgfHwgIiIsCgkJCWFwcGx5Q2xhc3NDaGFuZ2UsCgkJCWFsbEFuaW1hdGlvbnMgPSBvLmNoaWxkcmVuID8gYW5pbWF0ZWQuZmluZCggIioiICkuYWRkQmFjaygpIDogYW5pbWF0ZWQ7CgoJCS8vIG1hcCB0aGUgYW5pbWF0ZWQgb2JqZWN0cyB0byBzdG9yZSB0aGUgb3JpZ2luYWwgc3R5bGVzLgoJCWFsbEFuaW1hdGlvbnMgPSBhbGxBbmltYXRpb25zLm1hcChmdW5jdGlvbigpIHsKCQkJdmFyIGVsID0gJCggdGhpcyApOwoJCQlyZXR1cm4gewoJCQkJZWw6IGVsLAoJCQkJc3RhcnQ6IGdldEVsZW1lbnRTdHlsZXMoIHRoaXMgKQoJCQl9OwoJCX0pOwoKCQkvLyBhcHBseSBjbGFzcyBjaGFuZ2UKCQlhcHBseUNsYXNzQ2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCSQuZWFjaCggY2xhc3NBbmltYXRpb25BY3Rpb25zLCBmdW5jdGlvbihpLCBhY3Rpb24pIHsKCQkJCWlmICggdmFsdWVbIGFjdGlvbiBdICkgewoJCQkJCWFuaW1hdGVkWyBhY3Rpb24gKyAiQ2xhc3MiIF0oIHZhbHVlWyBhY3Rpb24gXSApOwoJCQkJfQoJCQl9KTsKCQl9OwoJCWFwcGx5Q2xhc3NDaGFuZ2UoKTsKCgkJLy8gbWFwIGFsbCBhbmltYXRlZCBvYmplY3RzIGFnYWluIC0gY2FsY3VsYXRlIG5ldyBzdHlsZXMgYW5kIGRpZmYKCQlhbGxBbmltYXRpb25zID0gYWxsQW5pbWF0aW9ucy5tYXAoZnVuY3Rpb24oKSB7CgkJCXRoaXMuZW5kID0gZ2V0RWxlbWVudFN0eWxlcyggdGhpcy5lbFsgMCBdICk7CgkJCXRoaXMuZGlmZiA9IHN0eWxlRGlmZmVyZW5jZSggdGhpcy5zdGFydCwgdGhpcy5lbmQgKTsKCQkJcmV0dXJuIHRoaXM7CgkJfSk7CgoJCS8vIGFwcGx5IG9yaWdpbmFsIGNsYXNzCgkJYW5pbWF0ZWQuYXR0ciggImNsYXNzIiwgYmFzZUNsYXNzICk7CgoJCS8vIG1hcCBhbGwgYW5pbWF0ZWQgb2JqZWN0cyBhZ2FpbiAtIHRoaXMgdGltZSBjb2xsZWN0aW5nIGEgcHJvbWlzZQoJCWFsbEFuaW1hdGlvbnMgPSBhbGxBbmltYXRpb25zLm1hcChmdW5jdGlvbigpIHsKCQkJdmFyIHN0eWxlSW5mbyA9IHRoaXMsCgkJCQlkZmQgPSAkLkRlZmVycmVkKCksCgkJCQlvcHRzID0gJC5leHRlbmQoe30sIG8sIHsKCQkJCQlxdWV1ZTogZmFsc2UsCgkJCQkJY29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQkJCQlkZmQucmVzb2x2ZSggc3R5bGVJbmZvICk7CgkJCQkJfQoJCQkJfSk7CgoJCQl0aGlzLmVsLmFuaW1hdGUoIHRoaXMuZGlmZiwgb3B0cyApOwoJCQlyZXR1cm4gZGZkLnByb21pc2UoKTsKCQl9KTsKCgkJLy8gb25jZSBhbGwgYW5pbWF0aW9ucyBoYXZlIGNvbXBsZXRlZDoKCQkkLndoZW4uYXBwbHkoICQsIGFsbEFuaW1hdGlvbnMuZ2V0KCkgKS5kb25lKGZ1bmN0aW9uKCkgewoKCQkJLy8gc2V0IHRoZSBmaW5hbCBjbGFzcwoJCQlhcHBseUNsYXNzQ2hhbmdlKCk7CgoJCQkvLyBmb3IgZWFjaCBhbmltYXRlZCBlbGVtZW50LAoJCQkvLyBjbGVhciBhbGwgY3NzIHByb3BlcnRpZXMgdGhhdCB3ZXJlIGFuaW1hdGVkCgkJCSQuZWFjaCggYXJndW1lbnRzLCBmdW5jdGlvbigpIHsKCQkJCXZhciBlbCA9IHRoaXMuZWw7CgkJCQkkLmVhY2goIHRoaXMuZGlmZiwgZnVuY3Rpb24oa2V5KSB7CgkJCQkJZWwuY3NzKCBrZXksICIiICk7CgkJCQl9KTsKCQkJfSk7CgoJCQkvLyB0aGlzIGlzIGd1YXJudGVlZCB0byBiZSB0aGVyZSBpZiB5b3UgdXNlIGpRdWVyeS5zcGVlZCgpCgkJCS8vIGl0IGFsc28gaGFuZGxlcyBkZXF1ZXVpbmcgdGhlIG5leHQgYW5pbS4uLgoJCQlvLmNvbXBsZXRlLmNhbGwoIGFuaW1hdGVkWyAwIF0gKTsKCQl9KTsKCX0pOwp9OwoKJC5mbi5leHRlbmQoewoJYWRkQ2xhc3M6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGNsYXNzTmFtZXMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCQlyZXR1cm4gc3BlZWQgPwoJCQkJJC5lZmZlY3RzLmFuaW1hdGVDbGFzcy5jYWxsKCB0aGlzLAoJCQkJCXsgYWRkOiBjbGFzc05hbWVzIH0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgOgoJCQkJb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCX0pKCAkLmZuLmFkZENsYXNzICksCgoJcmVtb3ZlQ2xhc3M6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGNsYXNzTmFtZXMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCQlyZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgPwoJCQkJJC5lZmZlY3RzLmFuaW1hdGVDbGFzcy5jYWxsKCB0aGlzLAoJCQkJCXsgcmVtb3ZlOiBjbGFzc05hbWVzIH0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgOgoJCQkJb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCX0pKCAkLmZuLnJlbW92ZUNsYXNzICksCgoJdG9nZ2xlQ2xhc3M6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGNsYXNzTmFtZXMsIGZvcmNlLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQkJaWYgKCB0eXBlb2YgZm9yY2UgPT09ICJib29sZWFuIiB8fCBmb3JjZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJaWYgKCAhc3BlZWQgKSB7CgkJCQkJLy8gd2l0aG91dCBzcGVlZCBwYXJhbWV0ZXIKCQkJCQlyZXR1cm4gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiAkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsCgkJCQkJCShmb3JjZSA\/IHsgYWRkOiBjbGFzc05hbWVzIH0gOiB7IHJlbW92ZTogY2xhc3NOYW1lcyB9KSwKCQkJCQkJc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCS8vIHdpdGhvdXQgZm9yY2UgcGFyYW1ldGVyCgkJCQlyZXR1cm4gJC5lZmZlY3RzLmFuaW1hdGVDbGFzcy5jYWxsKCB0aGlzLAoJCQkJCXsgdG9nZ2xlOiBjbGFzc05hbWVzIH0sIGZvcmNlLCBzcGVlZCwgZWFzaW5nICk7CgkJCX0KCQl9OwoJfSkoICQuZm4udG9nZ2xlQ2xhc3MgKSwKCglzd2l0Y2hDbGFzczogZnVuY3Rpb24oIHJlbW92ZSwgYWRkLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewoJCXJldHVybiAkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsIHsKCQkJYWRkOiBhZGQsCgkJCXJlbW92ZTogcmVtb3ZlCgkJfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0KfSk7Cgp9KSgpOwoKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqIEVGRkVDVFMgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCihmdW5jdGlvbigpIHsKCiQuZXh0ZW5kKCAkLmVmZmVjdHMsIHsKCXZlcnNpb246ICIxLjEwLjMiLAoKCS8vIFNhdmVzIGEgc2V0IG9mIHByb3BlcnRpZXMgaW4gYSBkYXRhIHN0b3JhZ2UKCXNhdmU6IGZ1bmN0aW9uKCBlbGVtZW50LCBzZXQgKSB7CgkJZm9yKCB2YXIgaT0wOyBpIDwgc2V0Lmxlbmd0aDsgaSsrICkgewoJCQlpZiAoIHNldFsgaSBdICE9PSBudWxsICkgewoJCQkJZWxlbWVudC5kYXRhKCBkYXRhU3BhY2UgKyBzZXRbIGkgXSwgZWxlbWVudFsgMCBdLnN0eWxlWyBzZXRbIGkgXSBdICk7CgkJCX0KCQl9Cgl9LAoKCS8vIFJlc3RvcmVzIGEgc2V0IG9mIHByZXZpb3VzbHkgc2F2ZWQgcHJvcGVydGllcyBmcm9tIGEgZGF0YSBzdG9yYWdlCglyZXN0b3JlOiBmdW5jdGlvbiggZWxlbWVudCwgc2V0ICkgewoJCXZhciB2YWwsIGk7CgkJZm9yKCBpPTA7IGkgPCBzZXQubGVuZ3RoOyBpKysgKSB7CgkJCWlmICggc2V0WyBpIF0gIT09IG51bGwgKSB7CgkJCQl2YWwgPSBlbGVtZW50LmRhdGEoIGRhdGFTcGFjZSArIHNldFsgaSBdICk7CgkJCQkvLyBzdXBwb3J0OiBqUXVlcnkgMS42LjIKCQkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk5MTcKCQkJCS8vIGpRdWVyeSAxLjYuMiBpbmNvcnJlY3RseSByZXR1cm5zIHVuZGVmaW5lZCBmb3IgYW55IGZhbHN5IHZhbHVlLgoJCQkJLy8gV2UgY2FuJ3QgZGlmZmVyZW50aWF0ZSBiZXR3ZWVuICIiIGFuZCAwIGhlcmUsIHNvIHdlIGp1c3QgYXNzdW1lCgkJCQkvLyBlbXB0eSBzdHJpbmcgc2luY2UgaXQncyBsaWtlbHkgdG8gYmUgYSBtb3JlIGNvbW1vbiB2YWx1ZS4uLgoJCQkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQl2YWwgPSAiIjsKCQkJCX0KCQkJCWVsZW1lbnQuY3NzKCBzZXRbIGkgXSwgdmFsICk7CgkJCX0KCQl9Cgl9LAoKCXNldE1vZGU6IGZ1bmN0aW9uKCBlbCwgbW9kZSApIHsKCQlpZiAobW9kZSA9PT0gInRvZ2dsZSIpIHsKCQkJbW9kZSA9IGVsLmlzKCAiOmhpZGRlbiIgKSA\/ICJzaG93IiA6ICJoaWRlIjsKCQl9CgkJcmV0dXJuIG1vZGU7Cgl9LAoKCS8vIFRyYW5zbGF0ZXMgYSBbdG9wLGxlZnRdIGFycmF5IGludG8gYSBiYXNlbGluZSB2YWx1ZQoJLy8gdGhpcyBzaG91bGQgYmUgYSBsaXR0bGUgbW9yZSBmbGV4aWJsZSBpbiB0aGUgZnV0dXJlIHRvIGhhbmRsZSBhIHN0cmluZyAmIGhhc2gKCWdldEJhc2VsaW5lOiBmdW5jdGlvbiggb3JpZ2luLCBvcmlnaW5hbCApIHsKCQl2YXIgeSwgeDsKCQlzd2l0Y2ggKCBvcmlnaW5bIDAgXSApIHsKCQkJY2FzZSAidG9wIjogeSA9IDA7IGJyZWFrOwoJCQljYXNlICJtaWRkbGUiOiB5ID0gMC41OyBicmVhazsKCQkJY2FzZSAiYm90dG9tIjogeSA9IDE7IGJyZWFrOwoJCQlkZWZhdWx0OiB5ID0gb3JpZ2luWyAwIF0gLyBvcmlnaW5hbC5oZWlnaHQ7CgkJfQoJCXN3aXRjaCAoIG9yaWdpblsgMSBdICkgewoJCQljYXNlICJsZWZ0IjogeCA9IDA7IGJyZWFrOwoJCQljYXNlICJjZW50ZXIiOiB4ID0gMC41OyBicmVhazsKCQkJY2FzZSAicmlnaHQiOiB4ID0gMTsgYnJlYWs7CgkJCWRlZmF1bHQ6IHggPSBvcmlnaW5bIDEgXSAvIG9yaWdpbmFsLndpZHRoOwoJCX0KCQlyZXR1cm4gewoJCQl4OiB4LAoJCQl5OiB5CgkJfTsKCX0sCgoJLy8gV3JhcHMgdGhlIGVsZW1lbnQgYXJvdW5kIGEgd3JhcHBlciB0aGF0IGNvcGllcyBwb3NpdGlvbiBwcm9wZXJ0aWVzCgljcmVhdGVXcmFwcGVyOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCgkJLy8gaWYgdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSB3cmFwcGVkLCByZXR1cm4gaXQKCQlpZiAoIGVsZW1lbnQucGFyZW50KCkuaXMoICIudWktZWZmZWN0cy13cmFwcGVyIiApKSB7CgkJCXJldHVybiBlbGVtZW50LnBhcmVudCgpOwoJCX0KCgkJLy8gd3JhcCB0aGUgZWxlbWVudAoJCXZhciBwcm9wcyA9IHsKCQkJCXdpZHRoOiBlbGVtZW50Lm91dGVyV2lkdGgodHJ1ZSksCgkJCQloZWlnaHQ6IGVsZW1lbnQub3V0ZXJIZWlnaHQodHJ1ZSksCgkJCQkiZmxvYXQiOiBlbGVtZW50LmNzcyggImZsb2F0IiApCgkJCX0sCgkJCXdyYXBwZXIgPSAkKCAiPGRpdj48L2Rpdj4iICkKCQkJCS5hZGRDbGFzcyggInVpLWVmZmVjdHMtd3JhcHBlciIgKQoJCQkJLmNzcyh7CgkJCQkJZm9udFNpemU6ICIxMDAlIiwKCQkJCQliYWNrZ3JvdW5kOiAidHJhbnNwYXJlbnQiLAoJCQkJCWJvcmRlcjogIm5vbmUiLAoJCQkJCW1hcmdpbjogMCwKCQkJCQlwYWRkaW5nOiAwCgkJCQl9KSwKCQkJLy8gU3RvcmUgdGhlIHNpemUgaW4gY2FzZSB3aWR0aC9oZWlnaHQgYXJlIGRlZmluZWQgaW4gJSAtIEZpeGVzICM1MjQ1CgkJCXNpemUgPSB7CgkJCQl3aWR0aDogZWxlbWVudC53aWR0aCgpLAoJCQkJaGVpZ2h0OiBlbGVtZW50LmhlaWdodCgpCgkJCX0sCgkJCWFjdGl2ZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CgoJCS8vIHN1cHBvcnQ6IEZpcmVmb3gKCQkvLyBGaXJlZm94IGluY29ycmVjdGx5IGV4cG9zZXMgYW5vbnltb3VzIGNvbnRlbnQKCQkvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD01NjE2NjQKCQl0cnkgewoJCQlhY3RpdmUuaWQ7CgkJfSBjYXRjaCggZSApIHsKCQkJYWN0aXZlID0gZG9jdW1lbnQuYm9keTsKCQl9CgoJCWVsZW1lbnQud3JhcCggd3JhcHBlciApOwoKCQkvLyBGaXhlcyAjNzU5NSAtIEVsZW1lbnRzIGxvc2UgZm9jdXMgd2hlbiB3cmFwcGVkLgoJCWlmICggZWxlbWVudFsgMCBdID09PSBhY3RpdmUgfHwgJC5jb250YWlucyggZWxlbWVudFsgMCBdLCBhY3RpdmUgKSApIHsKCQkJJCggYWN0aXZlICkuZm9jdXMoKTsKCQl9CgoJCXdyYXBwZXIgPSBlbGVtZW50LnBhcmVudCgpOyAvL0hvdGZpeCBmb3IgalF1ZXJ5IDEuNCBzaW5jZSBzb21lIGNoYW5nZSBpbiB3cmFwKCkgc2VlbXMgdG8gYWN0dWFsbHkgbG9zZSB0aGUgcmVmZXJlbmNlIHRvIHRoZSB3cmFwcGVkIGVsZW1lbnQKCgkJLy8gdHJhbnNmZXIgcG9zaXRpb25pbmcgcHJvcGVydGllcyB0byB0aGUgd3JhcHBlcgoJCWlmICggZWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSA9PT0gInN0YXRpYyIgKSB7CgkJCXdyYXBwZXIuY3NzKHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSk7CgkJCWVsZW1lbnQuY3NzKHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSk7CgkJfSBlbHNlIHsKCQkJJC5leHRlbmQoIHByb3BzLCB7CgkJCQlwb3NpdGlvbjogZWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSwKCQkJCXpJbmRleDogZWxlbWVudC5jc3MoICJ6LWluZGV4IiApCgkJCX0pOwoJCQkkLmVhY2goWyAidG9wIiwgImxlZnQiLCAiYm90dG9tIiwgInJpZ2h0IiBdLCBmdW5jdGlvbihpLCBwb3MpIHsKCQkJCXByb3BzWyBwb3MgXSA9IGVsZW1lbnQuY3NzKCBwb3MgKTsKCQkJCWlmICggaXNOYU4oIHBhcnNlSW50KCBwcm9wc1sgcG9zIF0sIDEwICkgKSApIHsKCQkJCQlwcm9wc1sgcG9zIF0gPSAiYXV0byI7CgkJCQl9CgkJCX0pOwoJCQllbGVtZW50LmNzcyh7CgkJCQlwb3NpdGlvbjogInJlbGF0aXZlIiwKCQkJCXRvcDogMCwKCQkJCWxlZnQ6IDAsCgkJCQlyaWdodDogImF1dG8iLAoJCQkJYm90dG9tOiAiYXV0byIKCQkJfSk7CgkJfQoJCWVsZW1lbnQuY3NzKHNpemUpOwoKCQlyZXR1cm4gd3JhcHBlci5jc3MoIHByb3BzICkuc2hvdygpOwoJfSwKCglyZW1vdmVXcmFwcGVyOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgYWN0aXZlID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCgkJaWYgKCBlbGVtZW50LnBhcmVudCgpLmlzKCAiLnVpLWVmZmVjdHMtd3JhcHBlciIgKSApIHsKCQkJZWxlbWVudC5wYXJlbnQoKS5yZXBsYWNlV2l0aCggZWxlbWVudCApOwoKCQkJLy8gRml4ZXMgIzc1OTUgLSBFbGVtZW50cyBsb3NlIGZvY3VzIHdoZW4gd3JhcHBlZC4KCQkJaWYgKCBlbGVtZW50WyAwIF0gPT09IGFjdGl2ZSB8fCAkLmNvbnRhaW5zKCBlbGVtZW50WyAwIF0sIGFjdGl2ZSApICkgewoJCQkJJCggYWN0aXZlICkuZm9jdXMoKTsKCQkJfQoJCX0KCgoJCXJldHVybiBlbGVtZW50OwoJfSwKCglzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiggZWxlbWVudCwgbGlzdCwgZmFjdG9yLCB2YWx1ZSApIHsKCQl2YWx1ZSA9IHZhbHVlIHx8IHt9OwoJCSQuZWFjaCggbGlzdCwgZnVuY3Rpb24oIGksIHggKSB7CgkJCXZhciB1bml0ID0gZWxlbWVudC5jc3NVbml0KCB4ICk7CgkJCWlmICggdW5pdFsgMCBdID4gMCApIHsKCQkJCXZhbHVlWyB4IF0gPSB1bml0WyAwIF0gKiBmYWN0b3IgKyB1bml0WyAxIF07CgkJCX0KCQl9KTsKCQlyZXR1cm4gdmFsdWU7Cgl9Cn0pOwoKLy8gcmV0dXJuIGFuIGVmZmVjdCBvcHRpb25zIG9iamVjdCBmb3IgdGhlIGdpdmVuIHBhcmFtZXRlcnM6CmZ1bmN0aW9uIF9ub3JtYWxpemVBcmd1bWVudHMoIGVmZmVjdCwgb3B0aW9ucywgc3BlZWQsIGNhbGxiYWNrICkgewoKCS8vIGFsbG93IHBhc3NpbmcgYWxsIG9wdGlvbnMgYXMgdGhlIGZpcnN0IHBhcmFtZXRlcgoJaWYgKCAkLmlzUGxhaW5PYmplY3QoIGVmZmVjdCApICkgewoJCW9wdGlvbnMgPSBlZmZlY3Q7CgkJZWZmZWN0ID0gZWZmZWN0LmVmZmVjdDsKCX0KCgkvLyBjb252ZXJ0IHRvIGFuIG9iamVjdAoJZWZmZWN0ID0geyBlZmZlY3Q6IGVmZmVjdCB9OwoKCS8vIGNhdGNoIChlZmZlY3QsIG51bGwsIC4uLikKCWlmICggb3B0aW9ucyA9PSBudWxsICkgewoJCW9wdGlvbnMgPSB7fTsKCX0KCgkvLyBjYXRjaCAoZWZmZWN0LCBjYWxsYmFjaykKCWlmICggJC5pc0Z1bmN0aW9uKCBvcHRpb25zICkgKSB7CgkJY2FsbGJhY2sgPSBvcHRpb25zOwoJCXNwZWVkID0gbnVsbDsKCQlvcHRpb25zID0ge307Cgl9CgoJLy8gY2F0Y2ggKGVmZmVjdCwgc3BlZWQsID8pCglpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiB8fCAkLmZ4LnNwZWVkc1sgb3B0aW9ucyBdICkgewoJCWNhbGxiYWNrID0gc3BlZWQ7CgkJc3BlZWQgPSBvcHRpb25zOwoJCW9wdGlvbnMgPSB7fTsKCX0KCgkvLyBjYXRjaCAoZWZmZWN0LCBvcHRpb25zLCBjYWxsYmFjaykKCWlmICggJC5pc0Z1bmN0aW9uKCBzcGVlZCApICkgewoJCWNhbGxiYWNrID0gc3BlZWQ7CgkJc3BlZWQgPSBudWxsOwoJfQoKCS8vIGFkZCBvcHRpb25zIHRvIGVmZmVjdAoJaWYgKCBvcHRpb25zICkgewoJCSQuZXh0ZW5kKCBlZmZlY3QsIG9wdGlvbnMgKTsKCX0KCglzcGVlZCA9IHNwZWVkIHx8IG9wdGlvbnMuZHVyYXRpb247CgllZmZlY3QuZHVyYXRpb24gPSAkLmZ4Lm9mZiA\/IDAgOgoJCXR5cGVvZiBzcGVlZCA9PT0gIm51bWJlciIgPyBzcGVlZCA6CgkJc3BlZWQgaW4gJC5meC5zcGVlZHMgPyAkLmZ4LnNwZWVkc1sgc3BlZWQgXSA6CgkJJC5meC5zcGVlZHMuX2RlZmF1bHQ7CgoJZWZmZWN0LmNvbXBsZXRlID0gY2FsbGJhY2sgfHwgb3B0aW9ucy5jb21wbGV0ZTsKCglyZXR1cm4gZWZmZWN0Owp9CgpmdW5jdGlvbiBzdGFuZGFyZEFuaW1hdGlvbk9wdGlvbiggb3B0aW9uICkgewoJLy8gVmFsaWQgc3RhbmRhcmQgc3BlZWRzIChub3RoaW5nLCBudW1iZXIsIG5hbWVkIHNwZWVkKQoJaWYgKCAhb3B0aW9uIHx8IHR5cGVvZiBvcHRpb24gPT09ICJudW1iZXIiIHx8ICQuZnguc3BlZWRzWyBvcHRpb24gXSApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCgkvLyBJbnZhbGlkIHN0cmluZ3MgLSB0cmVhdCBhcyAibm9ybWFsIiBzcGVlZAoJaWYgKCB0eXBlb2Ygb3B0aW9uID09PSAic3RyaW5nIiAmJiAhJC5lZmZlY3RzLmVmZmVjdFsgb3B0aW9uIF0gKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8gQ29tcGxldGUgY2FsbGJhY2sKCWlmICggJC5pc0Z1bmN0aW9uKCBvcHRpb24gKSApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCgkvLyBPcHRpb25zIGhhc2ggKGJ1dCBub3QgbmFtaW5nIGFuIGVmZmVjdCkKCWlmICggdHlwZW9mIG9wdGlvbiA9PT0gIm9iamVjdCIgJiYgIW9wdGlvbi5lZmZlY3QgKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8gRGlkbid0IG1hdGNoIGFueSBzdGFuZGFyZCBBUEkKCXJldHVybiBmYWxzZTsKfQoKJC5mbi5leHRlbmQoewoJZWZmZWN0OiBmdW5jdGlvbiggLyogZWZmZWN0LCBvcHRpb25zLCBzcGVlZCwgY2FsbGJhY2sgKi8gKSB7CgkJdmFyIGFyZ3MgPSBfbm9ybWFsaXplQXJndW1lbnRzLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJbW9kZSA9IGFyZ3MubW9kZSwKCQkJcXVldWUgPSBhcmdzLnF1ZXVlLAoJCQllZmZlY3RNZXRob2QgPSAkLmVmZmVjdHMuZWZmZWN0WyBhcmdzLmVmZmVjdCBdOwoKCQlpZiAoICQuZngub2ZmIHx8ICFlZmZlY3RNZXRob2QgKSB7CgkJCS8vIGRlbGVnYXRlIHRvIHRoZSBvcmlnaW5hbCBtZXRob2QgKGUuZy4sIC5zaG93KCkpIGlmIHBvc3NpYmxlCgkJCWlmICggbW9kZSApIHsKCQkJCXJldHVybiB0aGlzWyBtb2RlIF0oIGFyZ3MuZHVyYXRpb24sIGFyZ3MuY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggYXJncy5jb21wbGV0ZSApIHsKCQkJCQkJYXJncy5jb21wbGV0ZS5jYWxsKCB0aGlzICk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9CgoJCWZ1bmN0aW9uIHJ1biggbmV4dCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQljb21wbGV0ZSA9IGFyZ3MuY29tcGxldGUsCgkJCQltb2RlID0gYXJncy5tb2RlOwoKCQkJZnVuY3Rpb24gZG9uZSgpIHsKCQkJCWlmICggJC5pc0Z1bmN0aW9uKCBjb21wbGV0ZSApICkgewoJCQkJCWNvbXBsZXRlLmNhbGwoIGVsZW1bMF0gKTsKCQkJCX0KCQkJCWlmICggJC5pc0Z1bmN0aW9uKCBuZXh0ICkgKSB7CgkJCQkJbmV4dCgpOwoJCQkJfQoJCQl9CgoJCQkvLyBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyB0aGUgY29ycmVjdCBmaW5hbCBzdGF0ZSwgZGVsZWdhdGUgdG8KCQkJLy8gdGhlIGNvcmUgbWV0aG9kcyBzbyB0aGUgaW50ZXJuYWwgdHJhY2tpbmcgb2YgIm9sZGRpc3BsYXkiIHdvcmtzLgoJCQlpZiAoIGVsZW0uaXMoICI6aGlkZGVuIiApID8gbW9kZSA9PT0gImhpZGUiIDogbW9kZSA9PT0gInNob3ciICkgewoJCQkJZWxlbVsgbW9kZSBdKCk7CgkJCQlkb25lKCk7CgkJCX0gZWxzZSB7CgkJCQllZmZlY3RNZXRob2QuY2FsbCggZWxlbVswXSwgYXJncywgZG9uZSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcXVldWUgPT09IGZhbHNlID8gdGhpcy5lYWNoKCBydW4gKSA6IHRoaXMucXVldWUoIHF1ZXVlIHx8ICJmeCIsIHJ1biApOwoJfSwKCglzaG93OiAoZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgkJCWlmICggc3RhbmRhcmRBbmltYXRpb25PcHRpb24oIG9wdGlvbiApICkgewoJCQkJcmV0dXJuIG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9IGVsc2UgewoJCQkJdmFyIGFyZ3MgPSBfbm9ybWFsaXplQXJndW1lbnRzLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCWFyZ3MubW9kZSA9ICJzaG93IjsKCQkJCXJldHVybiB0aGlzLmVmZmVjdC5jYWxsKCB0aGlzLCBhcmdzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4uc2hvdyApLAoKCWhpZGU6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbiApIHsKCQkJaWYgKCBzdGFuZGFyZEFuaW1hdGlvbk9wdGlvbiggb3B0aW9uICkgKSB7CgkJCQlyZXR1cm4gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0gZWxzZSB7CgkJCQl2YXIgYXJncyA9IF9ub3JtYWxpemVBcmd1bWVudHMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJYXJncy5tb2RlID0gImhpZGUiOwoJCQkJcmV0dXJuIHRoaXMuZWZmZWN0LmNhbGwoIHRoaXMsIGFyZ3MgKTsKCQkJfQoJCX07Cgl9KSggJC5mbi5oaWRlICksCgoJdG9nZ2xlOiAoZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBvcHRpb24gKSB7CgkJCWlmICggc3RhbmRhcmRBbmltYXRpb25PcHRpb24oIG9wdGlvbiApIHx8IHR5cGVvZiBvcHRpb24gPT09ICJib29sZWFuIiApIHsKCQkJCXJldHVybiBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfSBlbHNlIHsKCQkJCXZhciBhcmdzID0gX25vcm1hbGl6ZUFyZ3VtZW50cy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQlhcmdzLm1vZGUgPSAidG9nZ2xlIjsKCQkJCXJldHVybiB0aGlzLmVmZmVjdC5jYWxsKCB0aGlzLCBhcmdzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4udG9nZ2xlICksCgoJLy8gaGVscGVyIGZ1bmN0aW9ucwoJY3NzVW5pdDogZnVuY3Rpb24oa2V5KSB7CgkJdmFyIHN0eWxlID0gdGhpcy5jc3MoIGtleSApLAoJCQl2YWwgPSBbXTsKCgkJJC5lYWNoKCBbICJlbSIsICJweCIsICIlIiwgInB0IiBdLCBmdW5jdGlvbiggaSwgdW5pdCApIHsKCQkJaWYgKCBzdHlsZS5pbmRleE9mKCB1bml0ICkgPiAwICkgewoJCQkJdmFsID0gWyBwYXJzZUZsb2F0KCBzdHlsZSApLCB1bml0IF07CgkJCX0KCQl9KTsKCQlyZXR1cm4gdmFsOwoJfQp9KTsKCn0pKCk7CgovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogRUFTSU5HICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKKGZ1bmN0aW9uKCkgewoKLy8gYmFzZWQgb24gZWFzaW5nIGVxdWF0aW9ucyBmcm9tIFJvYmVydCBQZW5uZXIgKGh0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcpCgp2YXIgYmFzZUVhc2luZ3MgPSB7fTsKCiQuZWFjaCggWyAiUXVhZCIsICJDdWJpYyIsICJRdWFydCIsICJRdWludCIsICJFeHBvIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCWJhc2VFYXNpbmdzWyBuYW1lIF0gPSBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gTWF0aC5wb3coIHAsIGkgKyAyICk7Cgl9Owp9KTsKCiQuZXh0ZW5kKCBiYXNlRWFzaW5ncywgewoJU2luZTogZnVuY3Rpb24gKCBwICkgewoJCXJldHVybiAxIC0gTWF0aC5jb3MoIHAgKiBNYXRoLlBJIC8gMiApOwoJfSwKCUNpcmM6IGZ1bmN0aW9uICggcCApIHsKCQlyZXR1cm4gMSAtIE1hdGguc3FydCggMSAtIHAgKiBwICk7Cgl9LAoJRWxhc3RpYzogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIHAgPT09IDAgfHwgcCA9PT0gMSA\/IHAgOgoJCQktTWF0aC5wb3coIDIsIDggKiAocCAtIDEpICkgKiBNYXRoLnNpbiggKCAocCAtIDEpICogODAgLSA3LjUgKSAqIE1hdGguUEkgLyAxNSApOwoJfSwKCUJhY2s6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiBwICogcCAqICggMyAqIHAgLSAyICk7Cgl9LAoJQm91bmNlOiBmdW5jdGlvbiAoIHAgKSB7CgkJdmFyIHBvdzIsCgkJCWJvdW5jZSA9IDQ7CgoJCXdoaWxlICggcCA8ICggKCBwb3cyID0gTWF0aC5wb3coIDIsIC0tYm91bmNlICkgKSAtIDEgKSAvIDExICkge30KCQlyZXR1cm4gMSAvIE1hdGgucG93KCA0LCAzIC0gYm91bmNlICkgLSA3LjU2MjUgKiBNYXRoLnBvdyggKCBwb3cyICogMyAtIDIgKSAvIDIyIC0gcCwgMiApOwoJfQp9KTsKCiQuZWFjaCggYmFzZUVhc2luZ3MsIGZ1bmN0aW9uKCBuYW1lLCBlYXNlSW4gKSB7CgkkLmVhc2luZ1sgImVhc2VJbiIgKyBuYW1lIF0gPSBlYXNlSW47CgkkLmVhc2luZ1sgImVhc2VPdXQiICsgbmFtZSBdID0gZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDEgLSBlYXNlSW4oIDEgLSBwICk7Cgl9OwoJJC5lYXNpbmdbICJlYXNlSW5PdXQiICsgbmFtZSBdID0gZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIHAgPCAwLjUgPwoJCQllYXNlSW4oIHAgKiAyICkgLyAyIDoKCQkJMSAtIGVhc2VJbiggcCAqIC0yICsgMiApIC8gMjsKCX07Cn0pOwoKfSkoKTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJ2ZXJ0aWNhbCA9IC91cHxkb3dufHZlcnRpY2FsLywKCXJwb3NpdGl2ZW1vdGlvbiA9IC91cHxsZWZ0fHZlcnRpY2FsfGhvcml6b250YWwvOwoKJC5lZmZlY3RzLmVmZmVjdC5ibGluZCA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoJLy8gQ3JlYXRlIGVsZW1lbnQKCXZhciBlbCA9ICQoIHRoaXMgKSwKCQlwcm9wcyA9IFsgInBvc2l0aW9uIiwgInRvcCIsICJib3R0b20iLCAibGVmdCIsICJyaWdodCIsICJoZWlnaHQiLCAid2lkdGgiIF0sCgkJbW9kZSA9ICQuZWZmZWN0cy5zZXRNb2RlKCBlbCwgby5tb2RlIHx8ICJoaWRlIiApLAoJCWRpcmVjdGlvbiA9IG8uZGlyZWN0aW9uIHx8ICJ1cCIsCgkJdmVydGljYWwgPSBydmVydGljYWwudGVzdCggZGlyZWN0aW9uICksCgkJcmVmID0gdmVydGljYWwgPyAiaGVpZ2h0IiA6ICJ3aWR0aCIsCgkJcmVmMiA9IHZlcnRpY2FsID8gInRvcCIgOiAibGVmdCIsCgkJbW90aW9uID0gcnBvc2l0aXZlbW90aW9uLnRlc3QoIGRpcmVjdGlvbiApLAoJCWFuaW1hdGlvbiA9IHt9LAoJCXNob3cgPSBtb2RlID09PSAic2hvdyIsCgkJd3JhcHBlciwgZGlzdGFuY2UsIG1hcmdpbjsKCgkvLyBpZiBhbHJlYWR5IHdyYXBwZWQsIHRoZSB3cmFwcGVyJ3MgcHJvcGVydGllcyBhcmUgbXkgcHJvcGVydHkuICM2MjQ1CglpZiAoIGVsLnBhcmVudCgpLmlzKCAiLnVpLWVmZmVjdHMtd3JhcHBlciIgKSApIHsKCQkkLmVmZmVjdHMuc2F2ZSggZWwucGFyZW50KCksIHByb3BzICk7Cgl9IGVsc2UgewoJCSQuZWZmZWN0cy5zYXZlKCBlbCwgcHJvcHMgKTsKCX0KCWVsLnNob3coKTsKCXdyYXBwZXIgPSAkLmVmZmVjdHMuY3JlYXRlV3JhcHBlciggZWwgKS5jc3MoewoJCW92ZXJmbG93OiAiaGlkZGVuIgoJfSk7CgoJZGlzdGFuY2UgPSB3cmFwcGVyWyByZWYgXSgpOwoJbWFyZ2luID0gcGFyc2VGbG9hdCggd3JhcHBlci5jc3MoIHJlZjIgKSApIHx8IDA7CgoJYW5pbWF0aW9uWyByZWYgXSA9IHNob3cgPyBkaXN0YW5jZSA6IDA7CglpZiAoICFtb3Rpb24gKSB7CgkJZWwKCQkJLmNzcyggdmVydGljYWwgPyAiYm90dG9tIiA6ICJyaWdodCIsIDAgKQoJCQkuY3NzKCB2ZXJ0aWNhbCA\/ICJ0b3AiIDogImxlZnQiLCAiYXV0byIgKQoJCQkuY3NzKHsgcG9zaXRpb246ICJhYnNvbHV0ZSIgfSk7CgoJCWFuaW1hdGlvblsgcmVmMiBdID0gc2hvdyA\/IG1hcmdpbiA6IGRpc3RhbmNlICsgbWFyZ2luOwoJfQoKCS8vIHN0YXJ0IGF0IDAgaWYgd2UgYXJlIHNob3dpbmcKCWlmICggc2hvdyApIHsKCQl3cmFwcGVyLmNzcyggcmVmLCAwICk7CgkJaWYgKCAhIG1vdGlvbiApIHsKCQkJd3JhcHBlci5jc3MoIHJlZjIsIG1hcmdpbiArIGRpc3RhbmNlICk7CgkJfQoJfQoKCS8vIEFuaW1hdGUKCXdyYXBwZXIuYW5pbWF0ZSggYW5pbWF0aW9uLCB7CgkJZHVyYXRpb246IG8uZHVyYXRpb24sCgkJZWFzaW5nOiBvLmVhc2luZywKCQlxdWV1ZTogZmFsc2UsCgkJY29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIG1vZGUgPT09ICJoaWRlIiApIHsKCQkJCWVsLmhpZGUoKTsKCQkJfQoJCQkkLmVmZmVjdHMucmVzdG9yZSggZWwsIHByb3BzICk7CgkJCSQuZWZmZWN0cy5yZW1vdmVXcmFwcGVyKCBlbCApOwoJCQlkb25lKCk7CgkJfQoJfSk7Cgp9OwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmVmZmVjdHMuZWZmZWN0LmJvdW5jZSA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoJdmFyIGVsID0gJCggdGhpcyApLAoJCXByb3BzID0gWyAicG9zaXRpb24iLCAidG9wIiwgImJvdHRvbSIsICJsZWZ0IiwgInJpZ2h0IiwgImhlaWdodCIsICJ3aWR0aCIgXSwKCgkJLy8gZGVmYXVsdHM6CgkJbW9kZSA9ICQuZWZmZWN0cy5zZXRNb2RlKCBlbCwgby5tb2RlIHx8ICJlZmZlY3QiICksCgkJaGlkZSA9IG1vZGUgPT09ICJoaWRlIiwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoJCWRpcmVjdGlvbiA9IG8uZGlyZWN0aW9uIHx8ICJ1cCIsCgkJZGlzdGFuY2UgPSBvLmRpc3RhbmNlLAoJCXRpbWVzID0gby50aW1lcyB8fCA1LAoKCQkvLyBudW1iZXIgb2YgaW50ZXJuYWwgYW5pbWF0aW9ucwoJCWFuaW1zID0gdGltZXMgKiAyICsgKCBzaG93IHx8IGhpZGUgPyAxIDogMCApLAoJCXNwZWVkID0gby5kdXJhdGlvbiAvIGFuaW1zLAoJCWVhc2luZyA9IG8uZWFzaW5nLAoKCQkvLyB1dGlsaXR5OgoJCXJlZiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImRvd24iICkgPyAidG9wIiA6ICJsZWZ0IiwKCQltb3Rpb24gPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJsZWZ0IiApLAoJCWksCgkJdXBBbmltLAoJCWRvd25BbmltLAoKCQkvLyB3ZSB3aWxsIG5lZWQgdG8gcmUtYXNzZW1ibGUgdGhlIHF1ZXVlIHRvIHN0YWNrIG91ciBhbmltYXRpb25zIGluIHBsYWNlCgkJcXVldWUgPSBlbC5xdWV1ZSgpLAoJCXF1ZXVlbGVuID0gcXVldWUubGVuZ3RoOwoKCS8vIEF2b2lkIHRvdWNoaW5nIG9wYWNpdHkgdG8gcHJldmVudCBjbGVhclR5cGUgYW5kIFBORyBpc3N1ZXMgaW4gSUUKCWlmICggc2hvdyB8fCBoaWRlICkgewoJCXByb3BzLnB1c2goICJvcGFjaXR5IiApOwoJfQoKCSQuZWZmZWN0cy5zYXZlKCBlbCwgcHJvcHMgKTsKCWVsLnNob3coKTsKCSQuZWZmZWN0cy5jcmVhdGVXcmFwcGVyKCBlbCApOyAvLyBDcmVhdGUgV3JhcHBlcgoKCS8vIGRlZmF1bHQgZGlzdGFuY2UgZm9yIHRoZSBCSUdHRVNUIGJvdW5jZSBpcyB0aGUgb3V0ZXIgRGlzdGFuY2UgLyAzCglpZiAoICFkaXN0YW5jZSApIHsKCQlkaXN0YW5jZSA9IGVsWyByZWYgPT09ICJ0b3AiID8gIm91dGVySGVpZ2h0IiA6ICJvdXRlcldpZHRoIiBdKCkgLyAzOwoJfQoKCWlmICggc2hvdyApIHsKCQlkb3duQW5pbSA9IHsgb3BhY2l0eTogMSB9OwoJCWRvd25BbmltWyByZWYgXSA9IDA7CgoJCS8vIGlmIHdlIGFyZSBzaG93aW5nLCBmb3JjZSBvcGFjaXR5IDAgYW5kIHNldCB0aGUgaW5pdGlhbCBwb3NpdGlvbgoJCS8vIHRoZW4gZG8gdGhlICJmaXJzdCIgYW5pbWF0aW9uCgkJZWwuY3NzKCAib3BhY2l0eSIsIDAgKQoJCQkuY3NzKCByZWYsIG1vdGlvbiA\/IC1kaXN0YW5jZSAqIDIgOiBkaXN0YW5jZSAqIDIgKQoJCQkuYW5pbWF0ZSggZG93bkFuaW0sIHNwZWVkLCBlYXNpbmcgKTsKCX0KCgkvLyBzdGFydCBhdCB0aGUgc21hbGxlc3QgZGlzdGFuY2UgaWYgd2UgYXJlIGhpZGluZwoJaWYgKCBoaWRlICkgewoJCWRpc3RhbmNlID0gZGlzdGFuY2UgLyBNYXRoLnBvdyggMiwgdGltZXMgLSAxICk7Cgl9CgoJZG93bkFuaW0gPSB7fTsKCWRvd25BbmltWyByZWYgXSA9IDA7CgkvLyBCb3VuY2VzIHVwL2Rvd24vbGVmdC9yaWdodCB0aGVuIGJhY2sgdG8gMCAtLSB0aW1lcyAqIDIgYW5pbWF0aW9ucyBoYXBwZW4gaGVyZQoJZm9yICggaSA9IDA7IGkgPCB0aW1lczsgaSsrICkgewoJCXVwQW5pbSA9IHt9OwoJCXVwQW5pbVsgcmVmIF0gPSAoIG1vdGlvbiA\/ICItPSIgOiAiKz0iICkgKyBkaXN0YW5jZTsKCgkJZWwuYW5pbWF0ZSggdXBBbmltLCBzcGVlZCwgZWFzaW5nICkKCQkJLmFuaW1hdGUoIGRvd25BbmltLCBzcGVlZCwgZWFzaW5nICk7CgoJCWRpc3RhbmNlID0gaGlkZSA\/IGRpc3RhbmNlICogMiA6IGRpc3RhbmNlIC8gMjsKCX0KCgkvLyBMYXN0IEJvdW5jZSB3aGVuIEhpZGluZwoJaWYgKCBoaWRlICkgewoJCXVwQW5pbSA9IHsgb3BhY2l0eTogMCB9OwoJCXVwQW5pbVsgcmVmIF0gPSAoIG1vdGlvbiA\/ICItPSIgOiAiKz0iICkgKyBkaXN0YW5jZTsKCgkJZWwuYW5pbWF0ZSggdXBBbmltLCBzcGVlZCwgZWFzaW5nICk7Cgl9CgoJZWwucXVldWUoZnVuY3Rpb24oKSB7CgkJaWYgKCBoaWRlICkgewoJCQllbC5oaWRlKCk7CgkJfQoJCSQuZWZmZWN0cy5yZXN0b3JlKCBlbCwgcHJvcHMgKTsKCQkkLmVmZmVjdHMucmVtb3ZlV3JhcHBlciggZWwgKTsKCQlkb25lKCk7Cgl9KTsKCgkvLyBpbmplY3QgYWxsIHRoZSBhbmltYXRpb25zIHdlIGp1c3QgcXVldWVkIHRvIGJlIGZpcnN0IGluIGxpbmUgKGFmdGVyICJpbnByb2dyZXNzIikKCWlmICggcXVldWVsZW4gPiAxKSB7CgkJcXVldWUuc3BsaWNlLmFwcGx5KCBxdWV1ZSwKCQkJWyAxLCAwIF0uY29uY2F0KCBxdWV1ZS5zcGxpY2UoIHF1ZXVlbGVuLCBhbmltcyArIDEgKSApICk7Cgl9CgllbC5kZXF1ZXVlKCk7Cgp9OwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmVmZmVjdHMuZWZmZWN0LmNsaXAgPSBmdW5jdGlvbiggbywgZG9uZSApIHsKCS8vIENyZWF0ZSBlbGVtZW50Cgl2YXIgZWwgPSAkKCB0aGlzICksCgkJcHJvcHMgPSBbICJwb3NpdGlvbiIsICJ0b3AiLCAiYm90dG9tIiwgImxlZnQiLCAicmlnaHQiLCAiaGVpZ2h0IiwgIndpZHRoIiBdLAoJCW1vZGUgPSAkLmVmZmVjdHMuc2V0TW9kZSggZWwsIG8ubW9kZSB8fCAiaGlkZSIgKSwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoJCWRpcmVjdGlvbiA9IG8uZGlyZWN0aW9uIHx8ICJ2ZXJ0aWNhbCIsCgkJdmVydCA9IGRpcmVjdGlvbiA9PT0gInZlcnRpY2FsIiwKCQlzaXplID0gdmVydCA\/ICJoZWlnaHQiIDogIndpZHRoIiwKCQlwb3NpdGlvbiA9IHZlcnQgPyAidG9wIiA6ICJsZWZ0IiwKCQlhbmltYXRpb24gPSB7fSwKCQl3cmFwcGVyLCBhbmltYXRlLCBkaXN0YW5jZTsKCgkvLyBTYXZlICYgU2hvdwoJJC5lZmZlY3RzLnNhdmUoIGVsLCBwcm9wcyApOwoJZWwuc2hvdygpOwoKCS8vIENyZWF0ZSBXcmFwcGVyCgl3cmFwcGVyID0gJC5lZmZlY3RzLmNyZWF0ZVdyYXBwZXIoIGVsICkuY3NzKHsKCQlvdmVyZmxvdzogImhpZGRlbiIKCX0pOwoJYW5pbWF0ZSA9ICggZWxbMF0udGFnTmFtZSA9PT0gIklNRyIgKSA\/IHdyYXBwZXIgOiBlbDsKCWRpc3RhbmNlID0gYW5pbWF0ZVsgc2l6ZSBdKCk7CgoJLy8gU2hpZnQKCWlmICggc2hvdyApIHsKCQlhbmltYXRlLmNzcyggc2l6ZSwgMCApOwoJCWFuaW1hdGUuY3NzKCBwb3NpdGlvbiwgZGlzdGFuY2UgLyAyICk7Cgl9CgoJLy8gQ3JlYXRlIEFuaW1hdGlvbiBPYmplY3Q6CglhbmltYXRpb25bIHNpemUgXSA9IHNob3cgPyBkaXN0YW5jZSA6IDA7CglhbmltYXRpb25bIHBvc2l0aW9uIF0gPSBzaG93ID8gMCA6IGRpc3RhbmNlIC8gMjsKCgkvLyBBbmltYXRlCglhbmltYXRlLmFuaW1hdGUoIGFuaW1hdGlvbiwgewoJCXF1ZXVlOiBmYWxzZSwKCQlkdXJhdGlvbjogby5kdXJhdGlvbiwKCQllYXNpbmc6IG8uZWFzaW5nLAoJCWNvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhc2hvdyApIHsKCQkJCWVsLmhpZGUoKTsKCQkJfQoJCQkkLmVmZmVjdHMucmVzdG9yZSggZWwsIHByb3BzICk7CgkJCSQuZWZmZWN0cy5yZW1vdmVXcmFwcGVyKCBlbCApOwoJCQlkb25lKCk7CgkJfQoJfSk7Cgp9OwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmVmZmVjdHMuZWZmZWN0LmRyb3AgPSBmdW5jdGlvbiggbywgZG9uZSApIHsKCgl2YXIgZWwgPSAkKCB0aGlzICksCgkJcHJvcHMgPSBbICJwb3NpdGlvbiIsICJ0b3AiLCAiYm90dG9tIiwgImxlZnQiLCAicmlnaHQiLCAib3BhY2l0eSIsICJoZWlnaHQiLCAid2lkdGgiIF0sCgkJbW9kZSA9ICQuZWZmZWN0cy5zZXRNb2RlKCBlbCwgby5tb2RlIHx8ICJoaWRlIiApLAoJCXNob3cgPSBtb2RlID09PSAic2hvdyIsCgkJZGlyZWN0aW9uID0gby5kaXJlY3Rpb24gfHwgImxlZnQiLAoJCXJlZiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImRvd24iICkgPyAidG9wIiA6ICJsZWZ0IiwKCQltb3Rpb24gPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJsZWZ0IiApID8gInBvcyIgOiAibmVnIiwKCQlhbmltYXRpb24gPSB7CgkJCW9wYWNpdHk6IHNob3cgPyAxIDogMAoJCX0sCgkJZGlzdGFuY2U7CgoJLy8gQWRqdXN0CgkkLmVmZmVjdHMuc2F2ZSggZWwsIHByb3BzICk7CgllbC5zaG93KCk7CgkkLmVmZmVjdHMuY3JlYXRlV3JhcHBlciggZWwgKTsKCglkaXN0YW5jZSA9IG8uZGlzdGFuY2UgfHwgZWxbIHJlZiA9PT0gInRvcCIgPyAib3V0ZXJIZWlnaHQiOiAib3V0ZXJXaWR0aCIgXSggdHJ1ZSApIC8gMjsKCglpZiAoIHNob3cgKSB7CgkJZWwKCQkJLmNzcyggIm9wYWNpdHkiLCAwICkKCQkJLmNzcyggcmVmLCBtb3Rpb24gPT09ICJwb3MiID8gLWRpc3RhbmNlIDogZGlzdGFuY2UgKTsKCX0KCgkvLyBBbmltYXRpb24KCWFuaW1hdGlvblsgcmVmIF0gPSAoIHNob3cgPwoJCSggbW90aW9uID09PSAicG9zIiA\/ICIrPSIgOiAiLT0iICkgOgoJCSggbW90aW9uID09PSAicG9zIiA\/ICItPSIgOiAiKz0iICkgKSArCgkJZGlzdGFuY2U7CgoJLy8gQW5pbWF0ZQoJZWwuYW5pbWF0ZSggYW5pbWF0aW9uLCB7CgkJcXVldWU6IGZhbHNlLAoJCWR1cmF0aW9uOiBvLmR1cmF0aW9uLAoJCWVhc2luZzogby5lYXNpbmcsCgkJY29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIG1vZGUgPT09ICJoaWRlIiApIHsKCQkJCWVsLmhpZGUoKTsKCQkJfQoJCQkkLmVmZmVjdHMucmVzdG9yZSggZWwsIHByb3BzICk7CgkJCSQuZWZmZWN0cy5yZW1vdmVXcmFwcGVyKCBlbCApOwoJCQlkb25lKCk7CgkJfQoJfSk7Cn07Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZWZmZWN0cy5lZmZlY3QuZXhwbG9kZSA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoKCXZhciByb3dzID0gby5waWVjZXMgPyBNYXRoLnJvdW5kKCBNYXRoLnNxcnQoIG8ucGllY2VzICkgKSA6IDMsCgkJY2VsbHMgPSByb3dzLAoJCWVsID0gJCggdGhpcyApLAoJCW1vZGUgPSAkLmVmZmVjdHMuc2V0TW9kZSggZWwsIG8ubW9kZSB8fCAiaGlkZSIgKSwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoKCQkvLyBzaG93IGFuZCB0aGVuIHZpc2liaWxpdHk6aGlkZGVuIHRoZSBlbGVtZW50IGJlZm9yZSBjYWxjdWxhdGluZyBvZmZzZXQKCQlvZmZzZXQgPSBlbC5zaG93KCkuY3NzKCAidmlzaWJpbGl0eSIsICJoaWRkZW4iICkub2Zmc2V0KCksCgoJCS8vIHdpZHRoIGFuZCBoZWlnaHQgb2YgYSBwaWVjZQoJCXdpZHRoID0gTWF0aC5jZWlsKCBlbC5vdXRlcldpZHRoKCkgLyBjZWxscyApLAoJCWhlaWdodCA9IE1hdGguY2VpbCggZWwub3V0ZXJIZWlnaHQoKSAvIHJvd3MgKSwKCQlwaWVjZXMgPSBbXSwKCgkJLy8gbG9vcAoJCWksIGosIGxlZnQsIHRvcCwgbXgsIG15OwoKCS8vIGNoaWxkcmVuIGFuaW1hdGUgY29tcGxldGU6CglmdW5jdGlvbiBjaGlsZENvbXBsZXRlKCkgewoJCXBpZWNlcy5wdXNoKCB0aGlzICk7CgkJaWYgKCBwaWVjZXMubGVuZ3RoID09PSByb3dzICogY2VsbHMgKSB7CgkJCWFuaW1Db21wbGV0ZSgpOwoJCX0KCX0KCgkvLyBjbG9uZSB0aGUgZWxlbWVudCBmb3IgZWFjaCByb3cgYW5kIGNlbGwuCglmb3IoIGkgPSAwOyBpIDwgcm93cyA7IGkrKyApIHsgLy8gPT09PgoJCXRvcCA9IG9mZnNldC50b3AgKyBpICogaGVpZ2h0OwoJCW15ID0gaSAtICggcm93cyAtIDEgKSAvIDIgOwoKCQlmb3IoIGogPSAwOyBqIDwgY2VsbHMgOyBqKysgKSB7IC8vIHx8fAoJCQlsZWZ0ID0gb2Zmc2V0LmxlZnQgKyBqICogd2lkdGg7CgkJCW14ID0gaiAtICggY2VsbHMgLSAxICkgLyAyIDsKCgkJCS8vIENyZWF0ZSBhIGNsb25lIG9mIHRoZSBub3cgaGlkZGVuIG1haW4gZWxlbWVudCB0aGF0IHdpbGwgYmUgYWJzb2x1dGUgcG9zaXRpb25lZAoJCQkvLyB3aXRoaW4gYSB3cmFwcGVyIGRpdiBvZmYgdGhlIC1sZWZ0IGFuZCAtdG9wIGVxdWFsIHRvIHNpemUgb2Ygb3VyIHBpZWNlcwoJCQllbAoJCQkJLmNsb25lKCkKCQkJCS5hcHBlbmRUbyggImJvZHkiICkKCQkJCS53cmFwKCAiPGRpdj48L2Rpdj4iICkKCQkJCS5jc3MoewoJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLAoJCQkJCXZpc2liaWxpdHk6ICJ2aXNpYmxlIiwKCQkJCQlsZWZ0OiAtaiAqIHdpZHRoLAoJCQkJCXRvcDogLWkgKiBoZWlnaHQKCQkJCX0pCgoJCQkvLyBzZWxlY3QgdGhlIHdyYXBwZXIgLSBtYWtlIGl0IG92ZXJmbG93OiBoaWRkZW4gYW5kIGFic29sdXRlIHBvc2l0aW9uZWQgYmFzZWQgb24KCQkJLy8gd2hlcmUgdGhlIG9yaWdpbmFsIHdhcyBsb2NhdGVkICtsZWZ0IGFuZCArdG9wIGVxdWFsIHRvIHRoZSBzaXplIG9mIHBpZWNlcwoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1lZmZlY3RzLWV4cGxvZGUiICkKCQkJCS5jc3MoewoJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLAoJCQkJCW92ZXJmbG93OiAiaGlkZGVuIiwKCQkJCQl3aWR0aDogd2lkdGgsCgkJCQkJaGVpZ2h0OiBoZWlnaHQsCgkJCQkJbGVmdDogbGVmdCArICggc2hvdyA\/IG14ICogd2lkdGggOiAwICksCgkJCQkJdG9wOiB0b3AgKyAoIHNob3cgPyBteSAqIGhlaWdodCA6IDAgKSwKCQkJCQlvcGFjaXR5OiBzaG93ID8gMCA6IDEKCQkJCX0pLmFuaW1hdGUoewoJCQkJCWxlZnQ6IGxlZnQgKyAoIHNob3cgPyAwIDogbXggKiB3aWR0aCApLAoJCQkJCXRvcDogdG9wICsgKCBzaG93ID8gMCA6IG15ICogaGVpZ2h0ICksCgkJCQkJb3BhY2l0eTogc2hvdyA\/IDEgOiAwCgkJCQl9LCBvLmR1cmF0aW9uIHx8IDUwMCwgby5lYXNpbmcsIGNoaWxkQ29tcGxldGUgKTsKCQl9Cgl9CgoJZnVuY3Rpb24gYW5pbUNvbXBsZXRlKCkgewoJCWVsLmNzcyh7CgkJCXZpc2liaWxpdHk6ICJ2aXNpYmxlIgoJCX0pOwoJCSQoIHBpZWNlcyApLnJlbW92ZSgpOwoJCWlmICggIXNob3cgKSB7CgkJCWVsLmhpZGUoKTsKCQl9CgkJZG9uZSgpOwoJfQp9OwoKfSkoalF1ZXJ5KTsKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmVmZmVjdHMuZWZmZWN0LmZhZGUgPSBmdW5jdGlvbiggbywgZG9uZSApIHsKCXZhciBlbCA9ICQoIHRoaXMgKSwKCQltb2RlID0gJC5lZmZlY3RzLnNldE1vZGUoIGVsLCBvLm1vZGUgfHwgInRvZ2dsZSIgKTsKCgllbC5hbmltYXRlKHsKCQlvcGFjaXR5OiBtb2RlCgl9LCB7CgkJcXVldWU6IGZhbHNlLAoJCWR1cmF0aW9uOiBvLmR1cmF0aW9uLAoJCWVhc2luZzogby5lYXNpbmcsCgkJY29tcGxldGU6IGRvbmUKCX0pOwp9OwoKfSkoIGpRdWVyeSApOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZWZmZWN0cy5lZmZlY3QuZm9sZCA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoKCS8vIENyZWF0ZSBlbGVtZW50Cgl2YXIgZWwgPSAkKCB0aGlzICksCgkJcHJvcHMgPSBbICJwb3NpdGlvbiIsICJ0b3AiLCAiYm90dG9tIiwgImxlZnQiLCAicmlnaHQiLCAiaGVpZ2h0IiwgIndpZHRoIiBdLAoJCW1vZGUgPSAkLmVmZmVjdHMuc2V0TW9kZSggZWwsIG8ubW9kZSB8fCAiaGlkZSIgKSwKCQlzaG93ID0gbW9kZSA9PT0gInNob3ciLAoJCWhpZGUgPSBtb2RlID09PSAiaGlkZSIsCgkJc2l6ZSA9IG8uc2l6ZSB8fCAxNSwKCQlwZXJjZW50ID0gLyhbMC05XSspJS8uZXhlYyggc2l6ZSApLAoJCWhvcml6Rmlyc3QgPSAhIW8uaG9yaXpGaXJzdCwKCQl3aWR0aEZpcnN0ID0gc2hvdyAhPT0gaG9yaXpGaXJzdCwKCQlyZWYgPSB3aWR0aEZpcnN0ID8gWyAid2lkdGgiLCAiaGVpZ2h0IiBdIDogWyAiaGVpZ2h0IiwgIndpZHRoIiBdLAoJCWR1cmF0aW9uID0gby5kdXJhdGlvbiAvIDIsCgkJd3JhcHBlciwgZGlzdGFuY2UsCgkJYW5pbWF0aW9uMSA9IHt9LAoJCWFuaW1hdGlvbjIgPSB7fTsKCgkkLmVmZmVjdHMuc2F2ZSggZWwsIHByb3BzICk7CgllbC5zaG93KCk7CgoJLy8gQ3JlYXRlIFdyYXBwZXIKCXdyYXBwZXIgPSAkLmVmZmVjdHMuY3JlYXRlV3JhcHBlciggZWwgKS5jc3MoewoJCW92ZXJmbG93OiAiaGlkZGVuIgoJfSk7CglkaXN0YW5jZSA9IHdpZHRoRmlyc3QgPwoJCVsgd3JhcHBlci53aWR0aCgpLCB3cmFwcGVyLmhlaWdodCgpIF0gOgoJCVsgd3JhcHBlci5oZWlnaHQoKSwgd3JhcHBlci53aWR0aCgpIF07CgoJaWYgKCBwZXJjZW50ICkgewoJCXNpemUgPSBwYXJzZUludCggcGVyY2VudFsgMSBdLCAxMCApIC8gMTAwICogZGlzdGFuY2VbIGhpZGUgPyAwIDogMSBdOwoJfQoJaWYgKCBzaG93ICkgewoJCXdyYXBwZXIuY3NzKCBob3JpekZpcnN0ID8gewoJCQloZWlnaHQ6IDAsCgkJCXdpZHRoOiBzaXplCgkJfSA6IHsKCQkJaGVpZ2h0OiBzaXplLAoJCQl3aWR0aDogMAoJCX0pOwoJfQoKCS8vIEFuaW1hdGlvbgoJYW5pbWF0aW9uMVsgcmVmWyAwIF0gXSA9IHNob3cgPyBkaXN0YW5jZVsgMCBdIDogc2l6ZTsKCWFuaW1hdGlvbjJbIHJlZlsgMSBdIF0gPSBzaG93ID8gZGlzdGFuY2VbIDEgXSA6IDA7CgoJLy8gQW5pbWF0ZQoJd3JhcHBlcgoJCS5hbmltYXRlKCBhbmltYXRpb24xLCBkdXJhdGlvbiwgby5lYXNpbmcgKQoJCS5hbmltYXRlKCBhbmltYXRpb24yLCBkdXJhdGlvbiwgby5lYXNpbmcsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIGhpZGUgKSB7CgkJCQllbC5oaWRlKCk7CgkJCX0KCQkJJC5lZmZlY3RzLnJlc3RvcmUoIGVsLCBwcm9wcyApOwoJCQkkLmVmZmVjdHMucmVtb3ZlV3JhcHBlciggZWwgKTsKCQkJZG9uZSgpOwoJCX0pOwoKfTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5lZmZlY3RzLmVmZmVjdC5oaWdobGlnaHQgPSBmdW5jdGlvbiggbywgZG9uZSApIHsKCXZhciBlbGVtID0gJCggdGhpcyApLAoJCXByb3BzID0gWyAiYmFja2dyb3VuZEltYWdlIiwgImJhY2tncm91bmRDb2xvciIsICJvcGFjaXR5IiBdLAoJCW1vZGUgPSAkLmVmZmVjdHMuc2V0TW9kZSggZWxlbSwgby5tb2RlIHx8ICJzaG93IiApLAoJCWFuaW1hdGlvbiA9IHsKCQkJYmFja2dyb3VuZENvbG9yOiBlbGVtLmNzcyggImJhY2tncm91bmRDb2xvciIgKQoJCX07CgoJaWYgKG1vZGUgPT09ICJoaWRlIikgewoJCWFuaW1hdGlvbi5vcGFjaXR5ID0gMDsKCX0KCgkkLmVmZmVjdHMuc2F2ZSggZWxlbSwgcHJvcHMgKTsKCgllbGVtCgkJLnNob3coKQoJCS5jc3MoewoJCQliYWNrZ3JvdW5kSW1hZ2U6ICJub25lIiwKCQkJYmFja2dyb3VuZENvbG9yOiBvLmNvbG9yIHx8ICIjZmZmZjk5IgoJCX0pCgkJLmFuaW1hdGUoIGFuaW1hdGlvbiwgewoJCQlxdWV1ZTogZmFsc2UsCgkJCWR1cmF0aW9uOiBvLmR1cmF0aW9uLAoJCQllYXNpbmc6IG8uZWFzaW5nLAoJCQljb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIG1vZGUgPT09ICJoaWRlIiApIHsKCQkJCQllbGVtLmhpZGUoKTsKCQkJCX0KCQkJCSQuZWZmZWN0cy5yZXN0b3JlKCBlbGVtLCBwcm9wcyApOwoJCQkJZG9uZSgpOwoJCQl9CgkJfSk7Cn07Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZWZmZWN0cy5lZmZlY3QucHVsc2F0ZSA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJbW9kZSA9ICQuZWZmZWN0cy5zZXRNb2RlKCBlbGVtLCBvLm1vZGUgfHwgInNob3ciICksCgkJc2hvdyA9IG1vZGUgPT09ICJzaG93IiwKCQloaWRlID0gbW9kZSA9PT0gImhpZGUiLAoJCXNob3doaWRlID0gKCBzaG93IHx8IG1vZGUgPT09ICJoaWRlIiApLAoKCQkvLyBzaG93aW5nIG9yIGhpZGluZyBsZWF2ZXMgb2YgdGhlICJsYXN0IiBhbmltYXRpb24KCQlhbmltcyA9ICggKCBvLnRpbWVzIHx8IDUgKSAqIDIgKSArICggc2hvd2hpZGUgPyAxIDogMCApLAoJCWR1cmF0aW9uID0gby5kdXJhdGlvbiAvIGFuaW1zLAoJCWFuaW1hdGVUbyA9IDAsCgkJcXVldWUgPSBlbGVtLnF1ZXVlKCksCgkJcXVldWVsZW4gPSBxdWV1ZS5sZW5ndGgsCgkJaTsKCglpZiAoIHNob3cgfHwgIWVsZW0uaXMoIjp2aXNpYmxlIikpIHsKCQllbGVtLmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpOwoJCWFuaW1hdGVUbyA9IDE7Cgl9CgoJLy8gYW5pbXMgLSAxIG9wYWNpdHkgInRvZ2dsZXMiCglmb3IgKCBpID0gMTsgaSA8IGFuaW1zOyBpKysgKSB7CgkJZWxlbS5hbmltYXRlKHsKCQkJb3BhY2l0eTogYW5pbWF0ZVRvCgkJfSwgZHVyYXRpb24sIG8uZWFzaW5nICk7CgkJYW5pbWF0ZVRvID0gMSAtIGFuaW1hdGVUbzsKCX0KCgllbGVtLmFuaW1hdGUoewoJCW9wYWNpdHk6IGFuaW1hdGVUbwoJfSwgZHVyYXRpb24sIG8uZWFzaW5nKTsKCgllbGVtLnF1ZXVlKGZ1bmN0aW9uKCkgewoJCWlmICggaGlkZSApIHsKCQkJZWxlbS5oaWRlKCk7CgkJfQoJCWRvbmUoKTsKCX0pOwoKCS8vIFdlIGp1c3QgcXVldWVkIHVwICJhbmltcyIgYW5pbWF0aW9ucywgd2UgbmVlZCB0byBwdXQgdGhlbSBuZXh0IGluIHRoZSBxdWV1ZQoJaWYgKCBxdWV1ZWxlbiA+IDEgKSB7CgkJcXVldWUuc3BsaWNlLmFwcGx5KCBxdWV1ZSwKCQkJWyAxLCAwIF0uY29uY2F0KCBxdWV1ZS5zcGxpY2UoIHF1ZXVlbGVuLCBhbmltcyArIDEgKSApICk7Cgl9CgllbGVtLmRlcXVldWUoKTsKfTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5lZmZlY3RzLmVmZmVjdC5wdWZmID0gZnVuY3Rpb24oIG8sIGRvbmUgKSB7Cgl2YXIgZWxlbSA9ICQoIHRoaXMgKSwKCQltb2RlID0gJC5lZmZlY3RzLnNldE1vZGUoIGVsZW0sIG8ubW9kZSB8fCAiaGlkZSIgKSwKCQloaWRlID0gbW9kZSA9PT0gImhpZGUiLAoJCXBlcmNlbnQgPSBwYXJzZUludCggby5wZXJjZW50LCAxMCApIHx8IDE1MCwKCQlmYWN0b3IgPSBwZXJjZW50IC8gMTAwLAoJCW9yaWdpbmFsID0gewoJCQloZWlnaHQ6IGVsZW0uaGVpZ2h0KCksCgkJCXdpZHRoOiBlbGVtLndpZHRoKCksCgkJCW91dGVySGVpZ2h0OiBlbGVtLm91dGVySGVpZ2h0KCksCgkJCW91dGVyV2lkdGg6IGVsZW0ub3V0ZXJXaWR0aCgpCgkJfTsKCgkkLmV4dGVuZCggbywgewoJCWVmZmVjdDogInNjYWxlIiwKCQlxdWV1ZTogZmFsc2UsCgkJZmFkZTogdHJ1ZSwKCQltb2RlOiBtb2RlLAoJCWNvbXBsZXRlOiBkb25lLAoJCXBlcmNlbnQ6IGhpZGUgPyBwZXJjZW50IDogMTAwLAoJCWZyb206IGhpZGUgPwoJCQlvcmlnaW5hbCA6CgkJCXsKCQkJCWhlaWdodDogb3JpZ2luYWwuaGVpZ2h0ICogZmFjdG9yLAoJCQkJd2lkdGg6IG9yaWdpbmFsLndpZHRoICogZmFjdG9yLAoJCQkJb3V0ZXJIZWlnaHQ6IG9yaWdpbmFsLm91dGVySGVpZ2h0ICogZmFjdG9yLAoJCQkJb3V0ZXJXaWR0aDogb3JpZ2luYWwub3V0ZXJXaWR0aCAqIGZhY3RvcgoJCQl9Cgl9KTsKCgllbGVtLmVmZmVjdCggbyApOwp9OwoKJC5lZmZlY3RzLmVmZmVjdC5zY2FsZSA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoKCS8vIENyZWF0ZSBlbGVtZW50Cgl2YXIgZWwgPSAkKCB0aGlzICksCgkJb3B0aW9ucyA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwgbyApLAoJCW1vZGUgPSAkLmVmZmVjdHMuc2V0TW9kZSggZWwsIG8ubW9kZSB8fCAiZWZmZWN0IiApLAoJCXBlcmNlbnQgPSBwYXJzZUludCggby5wZXJjZW50LCAxMCApIHx8CgkJCSggcGFyc2VJbnQoIG8ucGVyY2VudCwgMTAgKSA9PT0gMCA\/IDAgOiAoIG1vZGUgPT09ICJoaWRlIiA\/IDAgOiAxMDAgKSApLAoJCWRpcmVjdGlvbiA9IG8uZGlyZWN0aW9uIHx8ICJib3RoIiwKCQlvcmlnaW4gPSBvLm9yaWdpbiwKCQlvcmlnaW5hbCA9IHsKCQkJaGVpZ2h0OiBlbC5oZWlnaHQoKSwKCQkJd2lkdGg6IGVsLndpZHRoKCksCgkJCW91dGVySGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpLAoJCQlvdXRlcldpZHRoOiBlbC5vdXRlcldpZHRoKCkKCQl9LAoJCWZhY3RvciA9IHsKCQkJeTogZGlyZWN0aW9uICE9PSAiaG9yaXpvbnRhbCIgPyAocGVyY2VudCAvIDEwMCkgOiAxLAoJCQl4OiBkaXJlY3Rpb24gIT09ICJ2ZXJ0aWNhbCIgPyAocGVyY2VudCAvIDEwMCkgOiAxCgkJfTsKCgkvLyBXZSBhcmUgZ29pbmcgdG8gcGFzcyB0aGlzIGVmZmVjdCB0byB0aGUgc2l6ZSBlZmZlY3Q6CglvcHRpb25zLmVmZmVjdCA9ICJzaXplIjsKCW9wdGlvbnMucXVldWUgPSBmYWxzZTsKCW9wdGlvbnMuY29tcGxldGUgPSBkb25lOwoKCS8vIFNldCBkZWZhdWx0IG9yaWdpbiBhbmQgcmVzdG9yZSBmb3Igc2hvdy9oaWRlCglpZiAoIG1vZGUgIT09ICJlZmZlY3QiICkgewoJCW9wdGlvbnMub3JpZ2luID0gb3JpZ2luIHx8IFsibWlkZGxlIiwiY2VudGVyIl07CgkJb3B0aW9ucy5yZXN0b3JlID0gdHJ1ZTsKCX0KCglvcHRpb25zLmZyb20gPSBvLmZyb20gfHwgKCBtb2RlID09PSAic2hvdyIgPyB7CgkJaGVpZ2h0OiAwLAoJCXdpZHRoOiAwLAoJCW91dGVySGVpZ2h0OiAwLAoJCW91dGVyV2lkdGg6IDAKCX0gOiBvcmlnaW5hbCApOwoJb3B0aW9ucy50byA9IHsKCQloZWlnaHQ6IG9yaWdpbmFsLmhlaWdodCAqIGZhY3Rvci55LAoJCXdpZHRoOiBvcmlnaW5hbC53aWR0aCAqIGZhY3Rvci54LAoJCW91dGVySGVpZ2h0OiBvcmlnaW5hbC5vdXRlckhlaWdodCAqIGZhY3Rvci55LAoJCW91dGVyV2lkdGg6IG9yaWdpbmFsLm91dGVyV2lkdGggKiBmYWN0b3IueAoJfTsKCgkvLyBGYWRlIG9wdGlvbiB0byBzdXBwb3J0IHB1ZmYKCWlmICggb3B0aW9ucy5mYWRlICkgewoJCWlmICggbW9kZSA9PT0gInNob3ciICkgewoJCQlvcHRpb25zLmZyb20ub3BhY2l0eSA9IDA7CgkJCW9wdGlvbnMudG8ub3BhY2l0eSA9IDE7CgkJfQoJCWlmICggbW9kZSA9PT0gImhpZGUiICkgewoJCQlvcHRpb25zLmZyb20ub3BhY2l0eSA9IDE7CgkJCW9wdGlvbnMudG8ub3BhY2l0eSA9IDA7CgkJfQoJfQoKCS8vIEFuaW1hdGUKCWVsLmVmZmVjdCggb3B0aW9ucyApOwoKfTsKCiQuZWZmZWN0cy5lZmZlY3Quc2l6ZSA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoKCS8vIENyZWF0ZSBlbGVtZW50Cgl2YXIgb3JpZ2luYWwsIGJhc2VsaW5lLCBmYWN0b3IsCgkJZWwgPSAkKCB0aGlzICksCgkJcHJvcHMwID0gWyAicG9zaXRpb24iLCAidG9wIiwgImJvdHRvbSIsICJsZWZ0IiwgInJpZ2h0IiwgIndpZHRoIiwgImhlaWdodCIsICJvdmVyZmxvdyIsICJvcGFjaXR5IiBdLAoKCQkvLyBBbHdheXMgcmVzdG9yZQoJCXByb3BzMSA9IFsgInBvc2l0aW9uIiwgInRvcCIsICJib3R0b20iLCAibGVmdCIsICJyaWdodCIsICJvdmVyZmxvdyIsICJvcGFjaXR5IiBdLAoKCQkvLyBDb3B5IGZvciBjaGlsZHJlbgoJCXByb3BzMiA9IFsgIndpZHRoIiwgImhlaWdodCIsICJvdmVyZmxvdyIgXSwKCQljUHJvcHMgPSBbICJmb250U2l6ZSIgXSwKCQl2UHJvcHMgPSBbICJib3JkZXJUb3BXaWR0aCIsICJib3JkZXJCb3R0b21XaWR0aCIsICJwYWRkaW5nVG9wIiwgInBhZGRpbmdCb3R0b20iIF0sCgkJaFByb3BzID0gWyAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiBdLAoKCQkvLyBTZXQgb3B0aW9ucwoJCW1vZGUgPSAkLmVmZmVjdHMuc2V0TW9kZSggZWwsIG8ubW9kZSB8fCAiZWZmZWN0IiApLAoJCXJlc3RvcmUgPSBvLnJlc3RvcmUgfHwgbW9kZSAhPT0gImVmZmVjdCIsCgkJc2NhbGUgPSBvLnNjYWxlIHx8ICJib3RoIiwKCQlvcmlnaW4gPSBvLm9yaWdpbiB8fCBbICJtaWRkbGUiLCAiY2VudGVyIiBdLAoJCXBvc2l0aW9uID0gZWwuY3NzKCAicG9zaXRpb24iICksCgkJcHJvcHMgPSByZXN0b3JlID8gcHJvcHMwIDogcHJvcHMxLAoJCXplcm8gPSB7CgkJCWhlaWdodDogMCwKCQkJd2lkdGg6IDAsCgkJCW91dGVySGVpZ2h0OiAwLAoJCQlvdXRlcldpZHRoOiAwCgkJfTsKCglpZiAoIG1vZGUgPT09ICJzaG93IiApIHsKCQllbC5zaG93KCk7Cgl9CglvcmlnaW5hbCA9IHsKCQloZWlnaHQ6IGVsLmhlaWdodCgpLAoJCXdpZHRoOiBlbC53aWR0aCgpLAoJCW91dGVySGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpLAoJCW91dGVyV2lkdGg6IGVsLm91dGVyV2lkdGgoKQoJfTsKCglpZiAoIG8ubW9kZSA9PT0gInRvZ2dsZSIgJiYgbW9kZSA9PT0gInNob3ciICkgewoJCWVsLmZyb20gPSBvLnRvIHx8IHplcm87CgkJZWwudG8gPSBvLmZyb20gfHwgb3JpZ2luYWw7Cgl9IGVsc2UgewoJCWVsLmZyb20gPSBvLmZyb20gfHwgKCBtb2RlID09PSAic2hvdyIgPyB6ZXJvIDogb3JpZ2luYWwgKTsKCQllbC50byA9IG8udG8gfHwgKCBtb2RlID09PSAiaGlkZSIgPyB6ZXJvIDogb3JpZ2luYWwgKTsKCX0KCgkvLyBTZXQgc2NhbGluZyBmYWN0b3IKCWZhY3RvciA9IHsKCQlmcm9tOiB7CgkJCXk6IGVsLmZyb20uaGVpZ2h0IC8gb3JpZ2luYWwuaGVpZ2h0LAoJCQl4OiBlbC5mcm9tLndpZHRoIC8gb3JpZ2luYWwud2lkdGgKCQl9LAoJCXRvOiB7CgkJCXk6IGVsLnRvLmhlaWdodCAvIG9yaWdpbmFsLmhlaWdodCwKCQkJeDogZWwudG8ud2lkdGggLyBvcmlnaW5hbC53aWR0aAoJCX0KCX07CgoJLy8gU2NhbGUgdGhlIGNzcyBib3gKCWlmICggc2NhbGUgPT09ICJib3giIHx8IHNjYWxlID09PSAiYm90aCIgKSB7CgoJCS8vIFZlcnRpY2FsIHByb3BzIHNjYWxpbmcKCQlpZiAoIGZhY3Rvci5mcm9tLnkgIT09IGZhY3Rvci50by55ICkgewoJCQlwcm9wcyA9IHByb3BzLmNvbmNhdCggdlByb3BzICk7CgkJCWVsLmZyb20gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWwsIHZQcm9wcywgZmFjdG9yLmZyb20ueSwgZWwuZnJvbSApOwoJCQllbC50byA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbCwgdlByb3BzLCBmYWN0b3IudG8ueSwgZWwudG8gKTsKCQl9CgoJCS8vIEhvcml6b250YWwgcHJvcHMgc2NhbGluZwoJCWlmICggZmFjdG9yLmZyb20ueCAhPT0gZmFjdG9yLnRvLnggKSB7CgkJCXByb3BzID0gcHJvcHMuY29uY2F0KCBoUHJvcHMgKTsKCQkJZWwuZnJvbSA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbCwgaFByb3BzLCBmYWN0b3IuZnJvbS54LCBlbC5mcm9tICk7CgkJCWVsLnRvID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGVsLCBoUHJvcHMsIGZhY3Rvci50by54LCBlbC50byApOwoJCX0KCX0KCgkvLyBTY2FsZSB0aGUgY29udGVudAoJaWYgKCBzY2FsZSA9PT0gImNvbnRlbnQiIHx8IHNjYWxlID09PSAiYm90aCIgKSB7CgoJCS8vIFZlcnRpY2FsIHByb3BzIHNjYWxpbmcKCQlpZiAoIGZhY3Rvci5mcm9tLnkgIT09IGZhY3Rvci50by55ICkgewoJCQlwcm9wcyA9IHByb3BzLmNvbmNhdCggY1Byb3BzICkuY29uY2F0KCBwcm9wczIgKTsKCQkJZWwuZnJvbSA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbCwgY1Byb3BzLCBmYWN0b3IuZnJvbS55LCBlbC5mcm9tICk7CgkJCWVsLnRvID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGVsLCBjUHJvcHMsIGZhY3Rvci50by55LCBlbC50byApOwoJCX0KCX0KCgkkLmVmZmVjdHMuc2F2ZSggZWwsIHByb3BzICk7CgllbC5zaG93KCk7CgkkLmVmZmVjdHMuY3JlYXRlV3JhcHBlciggZWwgKTsKCWVsLmNzcyggIm92ZXJmbG93IiwgImhpZGRlbiIgKS5jc3MoIGVsLmZyb20gKTsKCgkvLyBBZGp1c3QKCWlmIChvcmlnaW4pIHsgLy8gQ2FsY3VsYXRlIGJhc2VsaW5lIHNoaWZ0cwoJCWJhc2VsaW5lID0gJC5lZmZlY3RzLmdldEJhc2VsaW5lKCBvcmlnaW4sIG9yaWdpbmFsICk7CgkJZWwuZnJvbS50b3AgPSAoIG9yaWdpbmFsLm91dGVySGVpZ2h0IC0gZWwub3V0ZXJIZWlnaHQoKSApICogYmFzZWxpbmUueTsKCQllbC5mcm9tLmxlZnQgPSAoIG9yaWdpbmFsLm91dGVyV2lkdGggLSBlbC5vdXRlcldpZHRoKCkgKSAqIGJhc2VsaW5lLng7CgkJZWwudG8udG9wID0gKCBvcmlnaW5hbC5vdXRlckhlaWdodCAtIGVsLnRvLm91dGVySGVpZ2h0ICkgKiBiYXNlbGluZS55OwoJCWVsLnRvLmxlZnQgPSAoIG9yaWdpbmFsLm91dGVyV2lkdGggLSBlbC50by5vdXRlcldpZHRoICkgKiBiYXNlbGluZS54OwoJfQoJZWwuY3NzKCBlbC5mcm9tICk7IC8vIHNldCB0b3AgJiBsZWZ0CgoJLy8gQW5pbWF0ZQoJaWYgKCBzY2FsZSA9PT0gImNvbnRlbnQiIHx8IHNjYWxlID09PSAiYm90aCIgKSB7IC8vIFNjYWxlIHRoZSBjaGlsZHJlbgoKCQkvLyBBZGQgbWFyZ2lucy9mb250LXNpemUKCQl2UHJvcHMgPSB2UHJvcHMuY29uY2F0KFsgIm1hcmdpblRvcCIsICJtYXJnaW5Cb3R0b20iIF0pLmNvbmNhdChjUHJvcHMpOwoJCWhQcm9wcyA9IGhQcm9wcy5jb25jYXQoWyAibWFyZ2luTGVmdCIsICJtYXJnaW5SaWdodCIgXSk7CgkJcHJvcHMyID0gcHJvcHMwLmNvbmNhdCh2UHJvcHMpLmNvbmNhdChoUHJvcHMpOwoKCQllbC5maW5kKCAiKlt3aWR0aF0iICkuZWFjaCggZnVuY3Rpb24oKXsKCQkJdmFyIGNoaWxkID0gJCggdGhpcyApLAoJCQkJY19vcmlnaW5hbCA9IHsKCQkJCQloZWlnaHQ6IGNoaWxkLmhlaWdodCgpLAoJCQkJCXdpZHRoOiBjaGlsZC53aWR0aCgpLAoJCQkJCW91dGVySGVpZ2h0OiBjaGlsZC5vdXRlckhlaWdodCgpLAoJCQkJCW91dGVyV2lkdGg6IGNoaWxkLm91dGVyV2lkdGgoKQoJCQkJfTsKCQkJaWYgKHJlc3RvcmUpIHsKCQkJCSQuZWZmZWN0cy5zYXZlKGNoaWxkLCBwcm9wczIpOwoJCQl9CgoJCQljaGlsZC5mcm9tID0gewoJCQkJaGVpZ2h0OiBjX29yaWdpbmFsLmhlaWdodCAqIGZhY3Rvci5mcm9tLnksCgkJCQl3aWR0aDogY19vcmlnaW5hbC53aWR0aCAqIGZhY3Rvci5mcm9tLngsCgkJCQlvdXRlckhlaWdodDogY19vcmlnaW5hbC5vdXRlckhlaWdodCAqIGZhY3Rvci5mcm9tLnksCgkJCQlvdXRlcldpZHRoOiBjX29yaWdpbmFsLm91dGVyV2lkdGggKiBmYWN0b3IuZnJvbS54CgkJCX07CgkJCWNoaWxkLnRvID0gewoJCQkJaGVpZ2h0OiBjX29yaWdpbmFsLmhlaWdodCAqIGZhY3Rvci50by55LAoJCQkJd2lkdGg6IGNfb3JpZ2luYWwud2lkdGggKiBmYWN0b3IudG8ueCwKCQkJCW91dGVySGVpZ2h0OiBjX29yaWdpbmFsLmhlaWdodCAqIGZhY3Rvci50by55LAoJCQkJb3V0ZXJXaWR0aDogY19vcmlnaW5hbC53aWR0aCAqIGZhY3Rvci50by54CgkJCX07CgoJCQkvLyBWZXJ0aWNhbCBwcm9wcyBzY2FsaW5nCgkJCWlmICggZmFjdG9yLmZyb20ueSAhPT0gZmFjdG9yLnRvLnkgKSB7CgkJCQljaGlsZC5mcm9tID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGNoaWxkLCB2UHJvcHMsIGZhY3Rvci5mcm9tLnksIGNoaWxkLmZyb20gKTsKCQkJCWNoaWxkLnRvID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGNoaWxkLCB2UHJvcHMsIGZhY3Rvci50by55LCBjaGlsZC50byApOwoJCQl9CgoJCQkvLyBIb3Jpem9udGFsIHByb3BzIHNjYWxpbmcKCQkJaWYgKCBmYWN0b3IuZnJvbS54ICE9PSBmYWN0b3IudG8ueCApIHsKCQkJCWNoaWxkLmZyb20gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggY2hpbGQsIGhQcm9wcywgZmFjdG9yLmZyb20ueCwgY2hpbGQuZnJvbSApOwoJCQkJY2hpbGQudG8gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggY2hpbGQsIGhQcm9wcywgZmFjdG9yLnRvLngsIGNoaWxkLnRvICk7CgkJCX0KCgkJCS8vIEFuaW1hdGUgY2hpbGRyZW4KCQkJY2hpbGQuY3NzKCBjaGlsZC5mcm9tICk7CgkJCWNoaWxkLmFuaW1hdGUoIGNoaWxkLnRvLCBvLmR1cmF0aW9uLCBvLmVhc2luZywgZnVuY3Rpb24oKSB7CgoJCQkJLy8gUmVzdG9yZSBjaGlsZHJlbgoJCQkJaWYgKCByZXN0b3JlICkgewoJCQkJCSQuZWZmZWN0cy5yZXN0b3JlKCBjaGlsZCwgcHJvcHMyICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJfQoKCS8vIEFuaW1hdGUKCWVsLmFuaW1hdGUoIGVsLnRvLCB7CgkJcXVldWU6IGZhbHNlLAoJCWR1cmF0aW9uOiBvLmR1cmF0aW9uLAoJCWVhc2luZzogby5lYXNpbmcsCgkJY29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIGVsLnRvLm9wYWNpdHkgPT09IDAgKSB7CgkJCQllbC5jc3MoICJvcGFjaXR5IiwgZWwuZnJvbS5vcGFjaXR5ICk7CgkJCX0KCQkJaWYoIG1vZGUgPT09ICJoaWRlIiApIHsKCQkJCWVsLmhpZGUoKTsKCQkJfQoJCQkkLmVmZmVjdHMucmVzdG9yZSggZWwsIHByb3BzICk7CgkJCWlmICggIXJlc3RvcmUgKSB7CgoJCQkJLy8gd2UgbmVlZCB0byBjYWxjdWxhdGUgb3VyIG5ldyBwb3NpdGlvbmluZyBiYXNlZCBvbiB0aGUgc2NhbGluZwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gInN0YXRpYyIgKSB7CgkJCQkJZWwuY3NzKHsKCQkJCQkJcG9zaXRpb246ICJyZWxhdGl2ZSIsCgkJCQkJCXRvcDogZWwudG8udG9wLAoJCQkJCQlsZWZ0OiBlbC50by5sZWZ0CgkJCQkJfSk7CgkJCQl9IGVsc2UgewoJCQkJCSQuZWFjaChbICJ0b3AiLCAibGVmdCIgXSwgZnVuY3Rpb24oIGlkeCwgcG9zICkgewoJCQkJCQllbC5jc3MoIHBvcywgZnVuY3Rpb24oIF8sIHN0ciApIHsKCQkJCQkJCXZhciB2YWwgPSBwYXJzZUludCggc3RyLCAxMCApLAoJCQkJCQkJCXRvUmVmID0gaWR4ID8gZWwudG8ubGVmdCA6IGVsLnRvLnRvcDsKCgkJCQkJCQkvLyBpZiBvcmlnaW5hbCB3YXMgImF1dG8iLCByZWNhbGN1bGF0ZSB0aGUgbmV3IHZhbHVlIGZyb20gd3JhcHBlcgoJCQkJCQkJaWYgKCBzdHIgPT09ICJhdXRvIiApIHsKCQkJCQkJCQlyZXR1cm4gdG9SZWYgKyAicHgiOwoJCQkJCQkJfQoKCQkJCQkJCXJldHVybiB2YWwgKyB0b1JlZiArICJweCI7CgkJCQkJCX0pOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkkLmVmZmVjdHMucmVtb3ZlV3JhcHBlciggZWwgKTsKCQkJZG9uZSgpOwoJCX0KCX0pOwoKfTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5lZmZlY3RzLmVmZmVjdC5zaGFrZSA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoKCXZhciBlbCA9ICQoIHRoaXMgKSwKCQlwcm9wcyA9IFsgInBvc2l0aW9uIiwgInRvcCIsICJib3R0b20iLCAibGVmdCIsICJyaWdodCIsICJoZWlnaHQiLCAid2lkdGgiIF0sCgkJbW9kZSA9ICQuZWZmZWN0cy5zZXRNb2RlKCBlbCwgby5tb2RlIHx8ICJlZmZlY3QiICksCgkJZGlyZWN0aW9uID0gby5kaXJlY3Rpb24gfHwgImxlZnQiLAoJCWRpc3RhbmNlID0gby5kaXN0YW5jZSB8fCAyMCwKCQl0aW1lcyA9IG8udGltZXMgfHwgMywKCQlhbmltcyA9IHRpbWVzICogMiArIDEsCgkJc3BlZWQgPSBNYXRoLnJvdW5kKG8uZHVyYXRpb24vYW5pbXMpLAoJCXJlZiA9IChkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAiZG93biIpID8gInRvcCIgOiAibGVmdCIsCgkJcG9zaXRpdmVNb3Rpb24gPSAoZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImxlZnQiKSwKCQlhbmltYXRpb24gPSB7fSwKCQlhbmltYXRpb24xID0ge30sCgkJYW5pbWF0aW9uMiA9IHt9LAoJCWksCgoJCS8vIHdlIHdpbGwgbmVlZCB0byByZS1hc3NlbWJsZSB0aGUgcXVldWUgdG8gc3RhY2sgb3VyIGFuaW1hdGlvbnMgaW4gcGxhY2UKCQlxdWV1ZSA9IGVsLnF1ZXVlKCksCgkJcXVldWVsZW4gPSBxdWV1ZS5sZW5ndGg7CgoJJC5lZmZlY3RzLnNhdmUoIGVsLCBwcm9wcyApOwoJZWwuc2hvdygpOwoJJC5lZmZlY3RzLmNyZWF0ZVdyYXBwZXIoIGVsICk7CgoJLy8gQW5pbWF0aW9uCglhbmltYXRpb25bIHJlZiBdID0gKCBwb3NpdGl2ZU1vdGlvbiA\/ICItPSIgOiAiKz0iICkgKyBkaXN0YW5jZTsKCWFuaW1hdGlvbjFbIHJlZiBdID0gKCBwb3NpdGl2ZU1vdGlvbiA\/ICIrPSIgOiAiLT0iICkgKyBkaXN0YW5jZSAqIDI7CglhbmltYXRpb24yWyByZWYgXSA9ICggcG9zaXRpdmVNb3Rpb24gPyAiLT0iIDogIis9IiApICsgZGlzdGFuY2UgKiAyOwoKCS8vIEFuaW1hdGUKCWVsLmFuaW1hdGUoIGFuaW1hdGlvbiwgc3BlZWQsIG8uZWFzaW5nICk7CgoJLy8gU2hha2VzCglmb3IgKCBpID0gMTsgaSA8IHRpbWVzOyBpKysgKSB7CgkJZWwuYW5pbWF0ZSggYW5pbWF0aW9uMSwgc3BlZWQsIG8uZWFzaW5nICkuYW5pbWF0ZSggYW5pbWF0aW9uMiwgc3BlZWQsIG8uZWFzaW5nICk7Cgl9CgllbAoJCS5hbmltYXRlKCBhbmltYXRpb24xLCBzcGVlZCwgby5lYXNpbmcgKQoJCS5hbmltYXRlKCBhbmltYXRpb24sIHNwZWVkIC8gMiwgby5lYXNpbmcgKQoJCS5xdWV1ZShmdW5jdGlvbigpIHsKCQkJaWYgKCBtb2RlID09PSAiaGlkZSIgKSB7CgkJCQllbC5oaWRlKCk7CgkJCX0KCQkJJC5lZmZlY3RzLnJlc3RvcmUoIGVsLCBwcm9wcyApOwoJCQkkLmVmZmVjdHMucmVtb3ZlV3JhcHBlciggZWwgKTsKCQkJZG9uZSgpOwoJCX0pOwoKCS8vIGluamVjdCBhbGwgdGhlIGFuaW1hdGlvbnMgd2UganVzdCBxdWV1ZWQgdG8gYmUgZmlyc3QgaW4gbGluZSAoYWZ0ZXIgImlucHJvZ3Jlc3MiKQoJaWYgKCBxdWV1ZWxlbiA+IDEpIHsKCQlxdWV1ZS5zcGxpY2UuYXBwbHkoIHF1ZXVlLAoJCQlbIDEsIDAgXS5jb25jYXQoIHF1ZXVlLnNwbGljZSggcXVldWVsZW4sIGFuaW1zICsgMSApICkgKTsKCX0KCWVsLmRlcXVldWUoKTsKCn07Cgp9KShqUXVlcnkpOwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZWZmZWN0cy5lZmZlY3Quc2xpZGUgPSBmdW5jdGlvbiggbywgZG9uZSApIHsKCgkvLyBDcmVhdGUgZWxlbWVudAoJdmFyIGVsID0gJCggdGhpcyApLAoJCXByb3BzID0gWyAicG9zaXRpb24iLCAidG9wIiwgImJvdHRvbSIsICJsZWZ0IiwgInJpZ2h0IiwgIndpZHRoIiwgImhlaWdodCIgXSwKCQltb2RlID0gJC5lZmZlY3RzLnNldE1vZGUoIGVsLCBvLm1vZGUgfHwgInNob3ciICksCgkJc2hvdyA9IG1vZGUgPT09ICJzaG93IiwKCQlkaXJlY3Rpb24gPSBvLmRpcmVjdGlvbiB8fCAibGVmdCIsCgkJcmVmID0gKGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJkb3duIikgPyAidG9wIiA6ICJsZWZ0IiwKCQlwb3NpdGl2ZU1vdGlvbiA9IChkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAibGVmdCIpLAoJCWRpc3RhbmNlLAoJCWFuaW1hdGlvbiA9IHt9OwoKCS8vIEFkanVzdAoJJC5lZmZlY3RzLnNhdmUoIGVsLCBwcm9wcyApOwoJZWwuc2hvdygpOwoJZGlzdGFuY2UgPSBvLmRpc3RhbmNlIHx8IGVsWyByZWYgPT09ICJ0b3AiID8gIm91dGVySGVpZ2h0IiA6ICJvdXRlcldpZHRoIiBdKCB0cnVlICk7CgoJJC5lZmZlY3RzLmNyZWF0ZVdyYXBwZXIoIGVsICkuY3NzKHsKCQlvdmVyZmxvdzogImhpZGRlbiIKCX0pOwoKCWlmICggc2hvdyApIHsKCQllbC5jc3MoIHJlZiwgcG9zaXRpdmVNb3Rpb24gPyAoaXNOYU4oZGlzdGFuY2UpID8gIi0iICsgZGlzdGFuY2UgOiAtZGlzdGFuY2UpIDogZGlzdGFuY2UgKTsKCX0KCgkvLyBBbmltYXRpb24KCWFuaW1hdGlvblsgcmVmIF0gPSAoIHNob3cgPwoJCSggcG9zaXRpdmVNb3Rpb24gPyAiKz0iIDogIi09IikgOgoJCSggcG9zaXRpdmVNb3Rpb24gPyAiLT0iIDogIis9IikpICsKCQlkaXN0YW5jZTsKCgkvLyBBbmltYXRlCgllbC5hbmltYXRlKCBhbmltYXRpb24sIHsKCQlxdWV1ZTogZmFsc2UsCgkJZHVyYXRpb246IG8uZHVyYXRpb24sCgkJZWFzaW5nOiBvLmVhc2luZywKCQljb21wbGV0ZTogZnVuY3Rpb24oKSB7CgkJCWlmICggbW9kZSA9PT0gImhpZGUiICkgewoJCQkJZWwuaGlkZSgpOwoJCQl9CgkJCSQuZWZmZWN0cy5yZXN0b3JlKCBlbCwgcHJvcHMgKTsKCQkJJC5lZmZlY3RzLnJlbW92ZVdyYXBwZXIoIGVsICk7CgkJCWRvbmUoKTsKCQl9Cgl9KTsKfTsKCn0pKGpRdWVyeSk7CihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5lZmZlY3RzLmVmZmVjdC50cmFuc2ZlciA9IGZ1bmN0aW9uKCBvLCBkb25lICkgewoJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJdGFyZ2V0ID0gJCggby50byApLAoJCXRhcmdldEZpeGVkID0gdGFyZ2V0LmNzcyggInBvc2l0aW9uIiApID09PSAiZml4ZWQiLAoJCWJvZHkgPSAkKCJib2R5IiksCgkJZml4VG9wID0gdGFyZ2V0Rml4ZWQgPyBib2R5LnNjcm9sbFRvcCgpIDogMCwKCQlmaXhMZWZ0ID0gdGFyZ2V0Rml4ZWQgPyBib2R5LnNjcm9sbExlZnQoKSA6IDAsCgkJZW5kUG9zaXRpb24gPSB0YXJnZXQub2Zmc2V0KCksCgkJYW5pbWF0aW9uID0gewoJCQl0b3A6IGVuZFBvc2l0aW9uLnRvcCAtIGZpeFRvcCAsCgkJCWxlZnQ6IGVuZFBvc2l0aW9uLmxlZnQgLSBmaXhMZWZ0ICwKCQkJaGVpZ2h0OiB0YXJnZXQuaW5uZXJIZWlnaHQoKSwKCQkJd2lkdGg6IHRhcmdldC5pbm5lcldpZHRoKCkKCQl9LAoJCXN0YXJ0UG9zaXRpb24gPSBlbGVtLm9mZnNldCgpLAoJCXRyYW5zZmVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWVmZmVjdHMtdHJhbnNmZXInPjwvZGl2PiIgKQoJCQkuYXBwZW5kVG8oIGRvY3VtZW50LmJvZHkgKQoJCQkuYWRkQ2xhc3MoIG8uY2xhc3NOYW1lICkKCQkJLmNzcyh7CgkJCQl0b3A6IHN0YXJ0UG9zaXRpb24udG9wIC0gZml4VG9wICwKCQkJCWxlZnQ6IHN0YXJ0UG9zaXRpb24ubGVmdCAtIGZpeExlZnQgLAoJCQkJaGVpZ2h0OiBlbGVtLmlubmVySGVpZ2h0KCksCgkJCQl3aWR0aDogZWxlbS5pbm5lcldpZHRoKCksCgkJCQlwb3NpdGlvbjogdGFyZ2V0Rml4ZWQgPyAiZml4ZWQiIDogImFic29sdXRlIgoJCQl9KQoJCQkuYW5pbWF0ZSggYW5pbWF0aW9uLCBvLmR1cmF0aW9uLCBvLmVhc2luZywgZnVuY3Rpb24oKSB7CgkJCQl0cmFuc2Zlci5yZW1vdmUoKTsKCQkJCWRvbmUoKTsKCQkJfSk7Cn07Cgp9KShqUXVlcnkpOwo=",
    "size": "435812"
}