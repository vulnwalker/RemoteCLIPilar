{
    "namaFile": "pages\/admin\/menu\/assets\/js\/libs\/flot\/jquery.flot.js",
    "lastUpdate": "2018-03-22+14:21:09.28",
    "contentFile": "LyogSmF2YXNjcmlwdCBwbG90dGluZyBsaWJyYXJ5IGZvciBqUXVlcnksIHZlcnNpb24gMC44LjMuCgpDb3B5cmlnaHQgKGMpIDIwMDctMjAxNCBJT0xBIGFuZCBPbGUgTGF1cnNlbi4KTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoKKi8KCi8vIGZpcnN0IGFuIGlubGluZSBkZXBlbmRlbmN5LCBqcXVlcnkuY29sb3JoZWxwZXJzLmpzLCB3ZSBpbmxpbmUgaXQgaGVyZQovLyBmb3IgY29udmVuaWVuY2UKCi8qIFBsdWdpbiBmb3IgalF1ZXJ5IGZvciB3b3JraW5nIHdpdGggY29sb3JzLgogKgogKiBWZXJzaW9uIDEuMS4KICoKICogSW5zcGlyYXRpb24gZnJvbSBqUXVlcnkgY29sb3IgYW5pbWF0aW9uIHBsdWdpbiBieSBKb2huIFJlc2lnLgogKgogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgYnkgT2xlIExhdXJzZW4sIE9jdG9iZXIgMjAwOS4KICoKICogRXhhbXBsZXM6CiAqCiAqICAgJC5jb2xvci5wYXJzZSgiI2ZmZiIpLnNjYWxlKCdyZ2InLCAwLjI1KS5hZGQoJ2EnLCAtMC41KS50b1N0cmluZygpCiAqICAgdmFyIGMgPSAkLmNvbG9yLmV4dHJhY3QoJCgiI215ZGl2IiksICdiYWNrZ3JvdW5kLWNvbG9yJyk7CiAqICAgY29uc29sZS5sb2coYy5yLCBjLmcsIGMuYiwgYy5hKTsKICogICAkLmNvbG9yLm1ha2UoMTAwLCA1MCwgMjUsIDAuNCkudG9TdHJpbmcoKSAvLyByZXR1cm5zICJyZ2JhKDEwMCw1MCwyNSwwLjQpIgogKgogKiBOb3RlIHRoYXQgLnNjYWxlKCkgYW5kIC5hZGQoKSByZXR1cm4gdGhlIHNhbWUgbW9kaWZpZWQgb2JqZWN0CiAqIGluc3RlYWQgb2YgbWFraW5nIGEgbmV3IG9uZS4KICoKICogVi4gMS4xOiBGaXggZXJyb3IgaGFuZGxpbmcgc28gZS5nLiBwYXJzaW5nIGFuIGVtcHR5IHN0cmluZyBkb2VzCiAqIHByb2R1Y2UgYSBjb2xvciByYXRoZXIgdGhhbiBqdXN0IGNyYXNoaW5nLgogKi8KKGZ1bmN0aW9uKCQpeyQuY29sb3I9e307JC5jb2xvci5tYWtlPWZ1bmN0aW9uKHIsZyxiLGEpe3ZhciBvPXt9O28ucj1yfHwwO28uZz1nfHwwO28uYj1ifHwwO28uYT1hIT1udWxsP2E6MTtvLmFkZD1mdW5jdGlvbihjLGQpe2Zvcih2YXIgaT0wO2k8Yy5sZW5ndGg7KytpKW9bYy5jaGFyQXQoaSldKz1kO3JldHVybiBvLm5vcm1hbGl6ZSgpfTtvLnNjYWxlPWZ1bmN0aW9uKGMsZil7Zm9yKHZhciBpPTA7aTxjLmxlbmd0aDsrK2kpb1tjLmNoYXJBdChpKV0qPWY7cmV0dXJuIG8ubm9ybWFsaXplKCl9O28udG9TdHJpbmc9ZnVuY3Rpb24oKXtpZihvLmE+PTEpe3JldHVybiJyZ2IoIitbby5yLG8uZyxvLmJdLmpvaW4oIiwiKSsiKSJ9ZWxzZXtyZXR1cm4icmdiYSgiK1tvLnIsby5nLG8uYixvLmFdLmpvaW4oIiwiKSsiKSJ9fTtvLm5vcm1hbGl6ZT1mdW5jdGlvbigpe2Z1bmN0aW9uIGNsYW1wKG1pbix2YWx1ZSxtYXgpe3JldHVybiB2YWx1ZTxtaW4\/bWluOnZhbHVlPm1heD9tYXg6dmFsdWV9by5yPWNsYW1wKDAscGFyc2VJbnQoby5yKSwyNTUpO28uZz1jbGFtcCgwLHBhcnNlSW50KG8uZyksMjU1KTtvLmI9Y2xhbXAoMCxwYXJzZUludChvLmIpLDI1NSk7by5hPWNsYW1wKDAsby5hLDEpO3JldHVybiBvfTtvLmNsb25lPWZ1bmN0aW9uKCl7cmV0dXJuICQuY29sb3IubWFrZShvLnIsby5iLG8uZyxvLmEpfTtyZXR1cm4gby5ub3JtYWxpemUoKX07JC5jb2xvci5leHRyYWN0PWZ1bmN0aW9uKGVsZW0sY3NzKXt2YXIgYztkb3tjPWVsZW0uY3NzKGNzcykudG9Mb3dlckNhc2UoKTtpZihjIT0iIiYmYyE9InRyYW5zcGFyZW50IilicmVhaztlbGVtPWVsZW0ucGFyZW50KCl9d2hpbGUoZWxlbS5sZW5ndGgmJiEkLm5vZGVOYW1lKGVsZW0uZ2V0KDApLCJib2R5IikpO2lmKGM9PSJyZ2JhKDAsIDAsIDAsIDApIiljPSJ0cmFuc3BhcmVudCI7cmV0dXJuICQuY29sb3IucGFyc2UoYyl9OyQuY29sb3IucGFyc2U9ZnVuY3Rpb24oc3RyKXt2YXIgcmVzLG09JC5jb2xvci5tYWtlO2lmKHJlcz0vcmdiXChccyooWzAtOV17MSwzfSlccyosXHMqKFswLTldezEsM30pXHMqLFxzKihbMC05XXsxLDN9KVxzKlwpLy5leGVjKHN0cikpcmV0dXJuIG0ocGFyc2VJbnQocmVzWzFdLDEwKSxwYXJzZUludChyZXNbMl0sMTApLHBhcnNlSW50KHJlc1szXSwxMCkpO2lmKHJlcz0vcmdiYVwoXHMqKFswLTldezEsM30pXHMqLFxzKihbMC05XXsxLDN9KVxzKixccyooWzAtOV17MSwzfSlccyosXHMqKFswLTldKyg\/OlwuWzAtOV0rKT8pXHMqXCkvLmV4ZWMoc3RyKSlyZXR1cm4gbShwYXJzZUludChyZXNbMV0sMTApLHBhcnNlSW50KHJlc1syXSwxMCkscGFyc2VJbnQocmVzWzNdLDEwKSxwYXJzZUZsb2F0KHJlc1s0XSkpO2lmKHJlcz0vcmdiXChccyooWzAtOV0rKD86XC5bMC05XSspPylcJVxzKixccyooWzAtOV0rKD86XC5bMC05XSspPylcJVxzKixccyooWzAtOV0rKD86XC5bMC05XSspPylcJVxzKlwpLy5leGVjKHN0cikpcmV0dXJuIG0ocGFyc2VGbG9hdChyZXNbMV0pKjIuNTUscGFyc2VGbG9hdChyZXNbMl0pKjIuNTUscGFyc2VGbG9hdChyZXNbM10pKjIuNTUpO2lmKHJlcz0vcmdiYVwoXHMqKFswLTldKyg\/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg\/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg\/OlwuWzAtOV0rKT8pXCVccyosXHMqKFswLTldKyg\/OlwuWzAtOV0rKT8pXHMqXCkvLmV4ZWMoc3RyKSlyZXR1cm4gbShwYXJzZUZsb2F0KHJlc1sxXSkqMi41NSxwYXJzZUZsb2F0KHJlc1syXSkqMi41NSxwYXJzZUZsb2F0KHJlc1szXSkqMi41NSxwYXJzZUZsb2F0KHJlc1s0XSkpO2lmKHJlcz0vIyhbYS1mQS1GMC05XXsyfSkoW2EtZkEtRjAtOV17Mn0pKFthLWZBLUYwLTldezJ9KS8uZXhlYyhzdHIpKXJldHVybiBtKHBhcnNlSW50KHJlc1sxXSwxNikscGFyc2VJbnQocmVzWzJdLDE2KSxwYXJzZUludChyZXNbM10sMTYpKTtpZihyZXM9LyMoW2EtZkEtRjAtOV0pKFthLWZBLUYwLTldKShbYS1mQS1GMC05XSkvLmV4ZWMoc3RyKSlyZXR1cm4gbShwYXJzZUludChyZXNbMV0rcmVzWzFdLDE2KSxwYXJzZUludChyZXNbMl0rcmVzWzJdLDE2KSxwYXJzZUludChyZXNbM10rcmVzWzNdLDE2KSk7dmFyIG5hbWU9JC50cmltKHN0cikudG9Mb3dlckNhc2UoKTtpZihuYW1lPT0idHJhbnNwYXJlbnQiKXJldHVybiBtKDI1NSwyNTUsMjU1LDApO2Vsc2V7cmVzPWxvb2t1cENvbG9yc1tuYW1lXXx8WzAsMCwwXTtyZXR1cm4gbShyZXNbMF0scmVzWzFdLHJlc1syXSl9fTt2YXIgbG9va3VwQ29sb3JzPXthcXVhOlswLDI1NSwyNTVdLGF6dXJlOlsyNDAsMjU1LDI1NV0sYmVpZ2U6WzI0NSwyNDUsMjIwXSxibGFjazpbMCwwLDBdLGJsdWU6WzAsMCwyNTVdLGJyb3duOlsxNjUsNDIsNDJdLGN5YW46WzAsMjU1LDI1NV0sZGFya2JsdWU6WzAsMCwxMzldLGRhcmtjeWFuOlswLDEzOSwxMzldLGRhcmtncmV5OlsxNjksMTY5LDE2OV0sZGFya2dyZWVuOlswLDEwMCwwXSxkYXJra2hha2k6WzE4OSwxODMsMTA3XSxkYXJrbWFnZW50YTpbMTM5LDAsMTM5XSxkYXJrb2xpdmVncmVlbjpbODUsMTA3LDQ3XSxkYXJrb3JhbmdlOlsyNTUsMTQwLDBdLGRhcmtvcmNoaWQ6WzE1Myw1MCwyMDRdLGRhcmtyZWQ6WzEzOSwwLDBdLGRhcmtzYWxtb246WzIzMywxNTAsMTIyXSxkYXJrdmlvbGV0OlsxNDgsMCwyMTFdLGZ1Y2hzaWE6WzI1NSwwLDI1NV0sZ29sZDpbMjU1LDIxNSwwXSxncmVlbjpbMCwxMjgsMF0saW5kaWdvOls3NSwwLDEzMF0sa2hha2k6WzI0MCwyMzAsMTQwXSxsaWdodGJsdWU6WzE3MywyMTYsMjMwXSxsaWdodGN5YW46WzIyNCwyNTUsMjU1XSxsaWdodGdyZWVuOlsxNDQsMjM4LDE0NF0sbGlnaHRncmV5OlsyMTEsMjExLDIxMV0sbGlnaHRwaW5rOlsyNTUsMTgyLDE5M10sbGlnaHR5ZWxsb3c6WzI1NSwyNTUsMjI0XSxsaW1lOlswLDI1NSwwXSxtYWdlbnRhOlsyNTUsMCwyNTVdLG1hcm9vbjpbMTI4LDAsMF0sbmF2eTpbMCwwLDEyOF0sb2xpdmU6WzEyOCwxMjgsMF0sb3JhbmdlOlsyNTUsMTY1LDBdLHBpbms6WzI1NSwxOTIsMjAzXSxwdXJwbGU6WzEyOCwwLDEyOF0sdmlvbGV0OlsxMjgsMCwxMjhdLHJlZDpbMjU1LDAsMF0sc2lsdmVyOlsxOTIsMTkyLDE5Ml0sd2hpdGU6WzI1NSwyNTUsMjU1XSx5ZWxsb3c6WzI1NSwyNTUsMF19fSkoalF1ZXJ5KTsKCi8vIHRoZSBhY3R1YWwgRmxvdCBjb2RlCihmdW5jdGlvbigkKSB7CgoJLy8gQ2FjaGUgdGhlIHByb3RvdHlwZSBoYXNPd25Qcm9wZXJ0eSBmb3IgZmFzdGVyIGFjY2VzcwoKCXZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgogICAgLy8gQSBzaGltIHRvIHByb3ZpZGUgJ2RldGFjaCcgdG8galF1ZXJ5IHZlcnNpb25zIHByaW9yIHRvIDEuNC4gIFVzaW5nIGEgRE9NCiAgICAvLyBvcGVyYXRpb24gcHJvZHVjZXMgdGhlIHNhbWUgZWZmZWN0IGFzIGRldGFjaCwgaS5lLiByZW1vdmluZyB0aGUgZWxlbWVudAogICAgLy8gd2l0aG91dCB0b3VjaGluZyBpdHMgalF1ZXJ5IGRhdGEuCgogICAgLy8gRG8gbm90IG1lcmdlIHRoaXMgaW50byBGbG90IDAuOSwgc2luY2UgaXQgcmVxdWlyZXMgalF1ZXJ5IDEuNC40Ky4KCiAgICBpZiAoISQuZm4uZGV0YWNoKSB7CiAgICAgICAgJC5mbi5kZXRhY2ggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHRoaXMgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgIH0KCgkvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCS8vIFRoZSBDYW52YXMgb2JqZWN0IGlzIGEgd3JhcHBlciBhcm91bmQgYW4gSFRNTDUgPGNhbnZhcz4gdGFnLgoJLy8KCS8vIEBjb25zdHJ1Y3RvcgoJLy8gQHBhcmFtIHtzdHJpbmd9IGNscyBMaXN0IG9mIGNsYXNzZXMgdG8gYXBwbHkgdG8gdGhlIGNhbnZhcy4KCS8vIEBwYXJhbSB7ZWxlbWVudH0gY29udGFpbmVyIEVsZW1lbnQgb250byB3aGljaCB0byBhcHBlbmQgdGhlIGNhbnZhcy4KCS8vCgkvLyBSZXF1aXJpbmcgYSBjb250YWluZXIgaXMgYSBsaXR0bGUgaWZmeSwgYnV0IHVuZm9ydHVuYXRlbHkgY2FudmFzCgkvLyBvcGVyYXRpb25zIGRvbid0IHdvcmsgdW5sZXNzIHRoZSBjYW52YXMgaXMgYXR0YWNoZWQgdG8gdGhlIERPTS4KCglmdW5jdGlvbiBDYW52YXMoY2xzLCBjb250YWluZXIpIHsKCgkJdmFyIGVsZW1lbnQgPSBjb250YWluZXIuY2hpbGRyZW4oIi4iICsgY2xzKVswXTsKCgkJaWYgKGVsZW1lbnQgPT0gbnVsbCkgewoKCQkJZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwoJCQllbGVtZW50LmNsYXNzTmFtZSA9IGNsczsKCgkJCSQoZWxlbWVudCkuY3NzKHsgZGlyZWN0aW9uOiAibHRyIiwgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGxlZnQ6IDAsIHRvcDogMCB9KQoJCQkJLmFwcGVuZFRvKGNvbnRhaW5lcik7CgoJCQkvLyBJZiBIVE1MNSBDYW52YXMgaXNuJ3QgYXZhaWxhYmxlLCBmYWxsIGJhY2sgdG8gW0V4fEZsYXNoXWNhbnZhcwoKCQkJaWYgKCFlbGVtZW50LmdldENvbnRleHQpIHsKCQkJCWlmICh3aW5kb3cuR192bWxDYW52YXNNYW5hZ2VyKSB7CgkJCQkJZWxlbWVudCA9IHdpbmRvdy5HX3ZtbENhbnZhc01hbmFnZXIuaW5pdEVsZW1lbnQoZWxlbWVudCk7CgkJCQl9IGVsc2UgewoJCQkJCXRocm93IG5ldyBFcnJvcigiQ2FudmFzIGlzIG5vdCBhdmFpbGFibGUuIElmIHlvdSdyZSB1c2luZyBJRSB3aXRoIGEgZmFsbC1iYWNrIHN1Y2ggYXMgRXhjYW52YXMsIHRoZW4gdGhlcmUncyBlaXRoZXIgYSBtaXN0YWtlIGluIHlvdXIgY29uZGl0aW9uYWwgaW5jbHVkZSwgb3IgdGhlIHBhZ2UgaGFzIG5vIERPQ1RZUEUgYW5kIGlzIHJlbmRlcmluZyBpbiBRdWlya3MgTW9kZS4iKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKCgkJdmFyIGNvbnRleHQgPSB0aGlzLmNvbnRleHQgPSBlbGVtZW50LmdldENvbnRleHQoIjJkIik7CgoJCS8vIERldGVybWluZSB0aGUgc2NyZWVuJ3MgcmF0aW8gb2YgcGh5c2ljYWwgdG8gZGV2aWNlLWluZGVwZW5kZW50CgkJLy8gcGl4ZWxzLiAgVGhpcyBpcyB0aGUgcmF0aW8gYmV0d2VlbiB0aGUgY2FudmFzIHdpZHRoIHRoYXQgdGhlIGJyb3dzZXIKCQkvLyBhZHZlcnRpc2VzIGFuZCB0aGUgbnVtYmVyIG9mIHBpeGVscyBhY3R1YWxseSBwcmVzZW50IGluIHRoYXQgc3BhY2UuCgoJCS8vIFRoZSBpUGhvbmUgNCwgZm9yIGV4YW1wbGUsIGhhcyBhIGRldmljZS1pbmRlcGVuZGVudCB3aWR0aCBvZiAzMjBweCwKCQkvLyBidXQgaXRzIHNjcmVlbiBpcyBhY3R1YWxseSA2NDBweCB3aWRlLiAgSXQgdGhlcmVmb3JlIGhhcyBhIHBpeGVsCgkJLy8gcmF0aW8gb2YgMiwgd2hpbGUgbW9zdCBub3JtYWwgZGV2aWNlcyBoYXZlIGEgcmF0aW8gb2YgMS4KCgkJdmFyIGRldmljZVBpeGVsUmF0aW8gPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxLAoJCQliYWNraW5nU3RvcmVSYXRpbyA9CgkJCQljb250ZXh0LndlYmtpdEJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwKCQkJCWNvbnRleHQubW96QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fAoJCQkJY29udGV4dC5tc0JhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwKCQkJCWNvbnRleHQub0JhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwKCQkJCWNvbnRleHQuYmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCAxOwoKCQl0aGlzLnBpeGVsUmF0aW8gPSBkZXZpY2VQaXhlbFJhdGlvIC8gYmFja2luZ1N0b3JlUmF0aW87CgoJCS8vIFNpemUgdGhlIGNhbnZhcyB0byBtYXRjaCB0aGUgaW50ZXJuYWwgZGltZW5zaW9ucyBvZiBpdHMgY29udGFpbmVyCgoJCXRoaXMucmVzaXplKGNvbnRhaW5lci53aWR0aCgpLCBjb250YWluZXIuaGVpZ2h0KCkpOwoKCQkvLyBDb2xsZWN0aW9uIG9mIEhUTUwgZGl2IGxheWVycyBmb3IgdGV4dCBvdmVybGFpZCBvbnRvIHRoZSBjYW52YXMKCgkJdGhpcy50ZXh0Q29udGFpbmVyID0gbnVsbDsKCQl0aGlzLnRleHQgPSB7fTsKCgkJLy8gQ2FjaGUgb2YgdGV4dCBmcmFnbWVudHMgYW5kIG1ldHJpY3MsIHNvIHdlIGNhbiBhdm9pZCBleHBlbnNpdmVseQoJCS8vIHJlLWNhbGN1bGF0aW5nIHRoZW0gd2hlbiB0aGUgcGxvdCBpcyByZS1yZW5kZXJlZCBpbiBhIGxvb3AuCgoJCXRoaXMuX3RleHRDYWNoZSA9IHt9OwoJfQoKCS8vIFJlc2l6ZXMgdGhlIGNhbnZhcyB0byB0aGUgZ2l2ZW4gZGltZW5zaW9ucy4KCS8vCgkvLyBAcGFyYW0ge251bWJlcn0gd2lkdGggTmV3IHdpZHRoIG9mIHRoZSBjYW52YXMsIGluIHBpeGVscy4KCS8vIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCBOZXcgaGVpZ2h0IG9mIHRoZSBjYW52YXMsIGluIHBpeGVscy4KCglDYW52YXMucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKCgkJaWYgKHdpZHRoIDw9IDAgfHwgaGVpZ2h0IDw9IDApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGRpbWVuc2lvbnMgZm9yIHBsb3QsIHdpZHRoID0gIiArIHdpZHRoICsgIiwgaGVpZ2h0ID0gIiArIGhlaWdodCk7CgkJfQoKCQl2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJY29udGV4dCA9IHRoaXMuY29udGV4dCwKCQkJcGl4ZWxSYXRpbyA9IHRoaXMucGl4ZWxSYXRpbzsKCgkJLy8gUmVzaXplIHRoZSBjYW52YXMsIGluY3JlYXNpbmcgaXRzIGRlbnNpdHkgYmFzZWQgb24gdGhlIGRpc3BsYXkncwoJCS8vIHBpeGVsIHJhdGlvOyBiYXNpY2FsbHkgZ2l2aW5nIGl0IG1vcmUgcGl4ZWxzIHdpdGhvdXQgaW5jcmVhc2luZyB0aGUKCQkvLyBzaXplIG9mIGl0cyBlbGVtZW50LCB0byB0YWtlIGFkdmFudGFnZSBvZiB0aGUgZmFjdCB0aGF0IHJldGluYQoJCS8vIGRpc3BsYXlzIGhhdmUgdGhhdCBtYW55IG1vcmUgcGl4ZWxzIGluIHRoZSBzYW1lIGFkdmVydGlzZWQgc3BhY2UuCgoJCS8vIFJlc2l6aW5nIHNob3VsZCByZXNldCB0aGUgc3RhdGUgKGV4Y2FudmFzIHNlZW1zIHRvIGJlIGJ1Z2d5IHRob3VnaCkKCgkJaWYgKHRoaXMud2lkdGggIT0gd2lkdGgpIHsKCQkJZWxlbWVudC53aWR0aCA9IHdpZHRoICogcGl4ZWxSYXRpbzsKCQkJZWxlbWVudC5zdHlsZS53aWR0aCA9IHdpZHRoICsgInB4IjsKCQkJdGhpcy53aWR0aCA9IHdpZHRoOwoJCX0KCgkJaWYgKHRoaXMuaGVpZ2h0ICE9IGhlaWdodCkgewoJCQllbGVtZW50LmhlaWdodCA9IGhlaWdodCAqIHBpeGVsUmF0aW87CgkJCWVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgInB4IjsKCQkJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgkJfQoKCQkvLyBTYXZlIHRoZSBjb250ZXh0LCBzbyB3ZSBjYW4gcmVzZXQgaW4gY2FzZSB3ZSBnZXQgcmVwbG90dGVkLiAgVGhlCgkJLy8gcmVzdG9yZSBlbnN1cmUgdGhhdCB3ZSdyZSByZWFsbHkgYmFjayBhdCB0aGUgaW5pdGlhbCBzdGF0ZSwgYW5kCgkJLy8gc2hvdWxkIGJlIHNhZmUgZXZlbiBpZiB3ZSBoYXZlbid0IHNhdmVkIHRoZSBpbml0aWFsIHN0YXRlIHlldC4KCgkJY29udGV4dC5yZXN0b3JlKCk7CgkJY29udGV4dC5zYXZlKCk7CgoJCS8vIFNjYWxlIHRoZSBjb29yZGluYXRlIHNwYWNlIHRvIG1hdGNoIHRoZSBkaXNwbGF5IGRlbnNpdHk7IHNvIGV2ZW4gdGhvdWdoIHdlCgkJLy8gbWF5IGhhdmUgdHdpY2UgYXMgbWFueSBwaXhlbHMsIHdlIHN0aWxsIHdhbnQgbGluZXMgYW5kIG90aGVyIGRyYXdpbmcgdG8KCQkvLyBhcHBlYXIgYXQgdGhlIHNhbWUgc2l6ZTsgdGhlIGV4dHJhIHBpeGVscyB3aWxsIGp1c3QgbWFrZSB0aGVtIGNyaXNwZXIuCgoJCWNvbnRleHQuc2NhbGUocGl4ZWxSYXRpbywgcGl4ZWxSYXRpbyk7Cgl9OwoKCS8vIENsZWFycyB0aGUgZW50aXJlIGNhbnZhcyBhcmVhLCBub3QgaW5jbHVkaW5nIGFueSBvdmVybGFpZCBIVE1MIHRleHQKCglDYW52YXMucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7Cgl9OwoKCS8vIEZpbmlzaGVzIHJlbmRlcmluZyB0aGUgY2FudmFzLCBpbmNsdWRpbmcgbWFuYWdpbmcgdGhlIHRleHQgb3ZlcmxheS4KCglDYW52YXMucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkgewoKCQl2YXIgY2FjaGUgPSB0aGlzLl90ZXh0Q2FjaGU7CgoJCS8vIEZvciBlYWNoIHRleHQgbGF5ZXIsIGFkZCBlbGVtZW50cyBtYXJrZWQgYXMgYWN0aXZlIHRoYXQgaGF2ZW4ndAoJCS8vIGFscmVhZHkgYmVlbiByZW5kZXJlZCwgYW5kIHJlbW92ZSB0aG9zZSB0aGF0IGFyZSBubyBsb25nZXIgYWN0aXZlLgoKCQlmb3IgKHZhciBsYXllcktleSBpbiBjYWNoZSkgewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjYWNoZSwgbGF5ZXJLZXkpKSB7CgoJCQkJdmFyIGxheWVyID0gdGhpcy5nZXRUZXh0TGF5ZXIobGF5ZXJLZXkpLAoJCQkJCWxheWVyQ2FjaGUgPSBjYWNoZVtsYXllcktleV07CgoJCQkJbGF5ZXIuaGlkZSgpOwoKCQkJCWZvciAodmFyIHN0eWxlS2V5IGluIGxheWVyQ2FjaGUpIHsKCQkJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChsYXllckNhY2hlLCBzdHlsZUtleSkpIHsKCQkJCQkJdmFyIHN0eWxlQ2FjaGUgPSBsYXllckNhY2hlW3N0eWxlS2V5XTsKCQkJCQkJZm9yICh2YXIga2V5IGluIHN0eWxlQ2FjaGUpIHsKCQkJCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHN0eWxlQ2FjaGUsIGtleSkpIHsKCgkJCQkJCQkJdmFyIHBvc2l0aW9ucyA9IHN0eWxlQ2FjaGVba2V5XS5wb3NpdGlvbnM7CgoJCQkJCQkJCWZvciAodmFyIGkgPSAwLCBwb3NpdGlvbjsgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07IGkrKykgewoJCQkJCQkJCQlpZiAocG9zaXRpb24uYWN0aXZlKSB7CgkJCQkJCQkJCQlpZiAoIXBvc2l0aW9uLnJlbmRlcmVkKSB7CgkJCQkJCQkJCQkJbGF5ZXIuYXBwZW5kKHBvc2l0aW9uLmVsZW1lbnQpOwoJCQkJCQkJCQkJCXBvc2l0aW9uLnJlbmRlcmVkID0gdHJ1ZTsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJCXBvc2l0aW9ucy5zcGxpY2UoaS0tLCAxKTsKCQkJCQkJCQkJCWlmIChwb3NpdGlvbi5yZW5kZXJlZCkgewoJCQkJCQkJCQkJCXBvc2l0aW9uLmVsZW1lbnQuZGV0YWNoKCk7CgkJCQkJCQkJCQl9CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgoJCQkJCQkJCWlmIChwb3NpdGlvbnMubGVuZ3RoID09IDApIHsKCQkJCQkJCQkJZGVsZXRlIHN0eWxlQ2FjaGVba2V5XTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJbGF5ZXIuc2hvdygpOwoJCQl9CgkJfQoJfTsKCgkvLyBDcmVhdGVzIChpZiBuZWNlc3NhcnkpIGFuZCByZXR1cm5zIHRoZSB0ZXh0IG92ZXJsYXkgY29udGFpbmVyLgoJLy8KCS8vIEBwYXJhbSB7c3RyaW5nfSBjbGFzc2VzIFN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTIGNsYXNzZXMgdXNlZCB0bwoJLy8gICAgIHVuaXF1ZWx5IGlkZW50aWZ5IHRoZSB0ZXh0IGxheWVyLgoJLy8gQHJldHVybiB7b2JqZWN0fSBUaGUgalF1ZXJ5LXdyYXBwZWQgdGV4dC1sYXllciBkaXYuCgoJQ2FudmFzLnByb3RvdHlwZS5nZXRUZXh0TGF5ZXIgPSBmdW5jdGlvbihjbGFzc2VzKSB7CgoJCXZhciBsYXllciA9IHRoaXMudGV4dFtjbGFzc2VzXTsKCgkJLy8gQ3JlYXRlIHRoZSB0ZXh0IGxheWVyIGlmIGl0IGRvZXNuJ3QgZXhpc3QKCgkJaWYgKGxheWVyID09IG51bGwpIHsKCgkJCS8vIENyZWF0ZSB0aGUgdGV4dCBsYXllciBjb250YWluZXIsIGlmIGl0IGRvZXNuJ3QgZXhpc3QKCgkJCWlmICh0aGlzLnRleHRDb250YWluZXIgPT0gbnVsbCkgewoJCQkJdGhpcy50ZXh0Q29udGFpbmVyID0gJCgiPGRpdiBjbGFzcz0nZmxvdC10ZXh0Jz48L2Rpdj4iKQoJCQkJCS5jc3MoewoJCQkJCQlwb3NpdGlvbjogImFic29sdXRlIiwKCQkJCQkJdG9wOiAwLAoJCQkJCQlsZWZ0OiAwLAoJCQkJCQlib3R0b206IDAsCgkJCQkJCXJpZ2h0OiAwLAoJCQkJCQknZm9udC1zaXplJzogInNtYWxsZXIiLAoJCQkJCQljb2xvcjogIiM1NDU0NTQiCgkJCQkJfSkKCQkJCQkuaW5zZXJ0QWZ0ZXIodGhpcy5lbGVtZW50KTsKCQkJfQoKCQkJbGF5ZXIgPSB0aGlzLnRleHRbY2xhc3Nlc10gPSAkKCI8ZGl2PjwvZGl2PiIpCgkJCQkuYWRkQ2xhc3MoY2xhc3NlcykKCQkJCS5jc3MoewoJCQkJCXBvc2l0aW9uOiAiYWJzb2x1dGUiLAoJCQkJCXRvcDogMCwKCQkJCQlsZWZ0OiAwLAoJCQkJCWJvdHRvbTogMCwKCQkJCQlyaWdodDogMAoJCQkJfSkKCQkJCS5hcHBlbmRUbyh0aGlzLnRleHRDb250YWluZXIpOwoJCX0KCgkJcmV0dXJuIGxheWVyOwoJfTsKCgkvLyBDcmVhdGVzIChpZiBuZWNlc3NhcnkpIGFuZCByZXR1cm5zIGEgdGV4dCBpbmZvIG9iamVjdC4KCS8vCgkvLyBUaGUgb2JqZWN0IGxvb2tzIGxpa2UgdGhpczoKCS8vCgkvLyB7CgkvLyAgICAgd2lkdGg6IFdpZHRoIG9mIHRoZSB0ZXh0J3Mgd3JhcHBlciBkaXYuCgkvLyAgICAgaGVpZ2h0OiBIZWlnaHQgb2YgdGhlIHRleHQncyB3cmFwcGVyIGRpdi4KCS8vICAgICBlbGVtZW50OiBUaGUgalF1ZXJ5LXdyYXBwZWQgSFRNTCBkaXYgY29udGFpbmluZyB0aGUgdGV4dC4KCS8vICAgICBwb3NpdGlvbnM6IEFycmF5IG9mIHBvc2l0aW9ucyBhdCB3aGljaCB0aGlzIHRleHQgaXMgZHJhd24uCgkvLyB9CgkvLwoJLy8gVGhlIHBvc2l0aW9ucyBhcnJheSBjb250YWlucyBvYmplY3RzIHRoYXQgbG9vayBsaWtlIHRoaXM6CgkvLwoJLy8gewoJLy8gICAgIGFjdGl2ZTogRmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHRleHQgc2hvdWxkIGJlIHZpc2libGUuCgkvLyAgICAgcmVuZGVyZWQ6IEZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIHRoZSB0ZXh0IGlzIGN1cnJlbnRseSB2aXNpYmxlLgoJLy8gICAgIGVsZW1lbnQ6IFRoZSBqUXVlcnktd3JhcHBlZCBIVE1MIGRpdiBjb250YWluaW5nIHRoZSB0ZXh0LgoJLy8gICAgIHg6IFggY29vcmRpbmF0ZSBhdCB3aGljaCB0byBkcmF3IHRoZSB0ZXh0LgoJLy8gICAgIHk6IFkgY29vcmRpbmF0ZSBhdCB3aGljaCB0byBkcmF3IHRoZSB0ZXh0LgoJLy8gfQoJLy8KCS8vIEVhY2ggcG9zaXRpb24gYWZ0ZXIgdGhlIGZpcnN0IHJlY2VpdmVzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGVsZW1lbnQuCgkvLwoJLy8gVGhlIGlkZWEgaXMgdGhhdCB0aGF0IHRoZSB3aWR0aCwgaGVpZ2h0LCBhbmQgZ2VuZXJhbCAnaWRlbnRpdHknIG9mIHRoZQoJLy8gdGV4dCBpcyBjb25zdGFudCBubyBtYXR0ZXIgd2hlcmUgaXQgaXMgcGxhY2VkOyB0aGUgcGxhY2VtZW50cyBhcmUgYQoJLy8gc2Vjb25kYXJ5IHByb3BlcnR5LgoJLy8KCS8vIENhbnZhcyBtYWludGFpbnMgYSBjYWNoZSBvZiByZWNlbnRseS11c2VkIHRleHQgaW5mbyBvYmplY3RzOyBnZXRUZXh0SW5mbwoJLy8gZWl0aGVyIHJldHVybnMgdGhlIGNhY2hlZCBlbGVtZW50IG9yIGNyZWF0ZXMgYSBuZXcgZW50cnkuCgkvLwoJLy8gQHBhcmFtIHtzdHJpbmd9IGxheWVyIEEgc3RyaW5nIG9mIHNwYWNlLXNlcGFyYXRlZCBDU1MgY2xhc3NlcyB1bmlxdWVseQoJLy8gICAgIGlkZW50aWZ5aW5nIHRoZSBsYXllciBjb250YWluaW5nIHRoaXMgdGV4dC4KCS8vIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRleHQgc3RyaW5nIHRvIHJldHJpZXZlIGluZm8gZm9yLgoJLy8gQHBhcmFtIHsoc3RyaW5nfG9iamVjdCk9fSBmb250IEVpdGhlciBhIHN0cmluZyBvZiBzcGFjZS1zZXBhcmF0ZWQgQ1NTCgkvLyAgICAgY2xhc3NlcyBvciBhIGZvbnQtc3BlYyBvYmplY3QsIGRlZmluaW5nIHRoZSB0ZXh0J3MgZm9udCBhbmQgc3R5bGUuCgkvLyBAcGFyYW0ge251bWJlcj19IGFuZ2xlIEFuZ2xlIGF0IHdoaWNoIHRvIHJvdGF0ZSB0aGUgdGV4dCwgaW4gZGVncmVlcy4KCS8vICAgICBBbmdsZSBpcyBjdXJyZW50bHkgdW51c2VkLCBpdCB3aWxsIGJlIGltcGxlbWVudGVkIGluIHRoZSBmdXR1cmUuCgkvLyBAcGFyYW0ge251bWJlcj19IHdpZHRoIE1heGltdW0gd2lkdGggb2YgdGhlIHRleHQgYmVmb3JlIGl0IHdyYXBzLgoJLy8gQHJldHVybiB7b2JqZWN0fSBhIHRleHQgaW5mbyBvYmplY3QuCgoJQ2FudmFzLnByb3RvdHlwZS5nZXRUZXh0SW5mbyA9IGZ1bmN0aW9uKGxheWVyLCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgpIHsKCgkJdmFyIHRleHRTdHlsZSwgbGF5ZXJDYWNoZSwgc3R5bGVDYWNoZSwgaW5mbzsKCgkJLy8gQ2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcsIGluIGNhc2Ugd2Ugd2VyZSBnaXZlbiBhIG51bWJlciBvciBzdWNoCgoJCXRleHQgPSAiIiArIHRleHQ7CgoJCS8vIElmIHRoZSBmb250IGlzIGEgZm9udC1zcGVjIG9iamVjdCwgZ2VuZXJhdGUgYSBDU1MgZm9udCBkZWZpbml0aW9uCgoJCWlmICh0eXBlb2YgZm9udCA9PT0gIm9iamVjdCIpIHsKCQkJdGV4dFN0eWxlID0gZm9udC5zdHlsZSArICIgIiArIGZvbnQudmFyaWFudCArICIgIiArIGZvbnQud2VpZ2h0ICsgIiAiICsgZm9udC5zaXplICsgInB4LyIgKyBmb250LmxpbmVIZWlnaHQgKyAicHggIiArIGZvbnQuZmFtaWx5OwoJCX0gZWxzZSB7CgkJCXRleHRTdHlsZSA9IGZvbnQ7CgkJfQoKCQkvLyBSZXRyaWV2ZSAob3IgY3JlYXRlKSB0aGUgY2FjaGUgZm9yIHRoZSB0ZXh0J3MgbGF5ZXIgYW5kIHN0eWxlcwoKCQlsYXllckNhY2hlID0gdGhpcy5fdGV4dENhY2hlW2xheWVyXTsKCgkJaWYgKGxheWVyQ2FjaGUgPT0gbnVsbCkgewoJCQlsYXllckNhY2hlID0gdGhpcy5fdGV4dENhY2hlW2xheWVyXSA9IHt9OwoJCX0KCgkJc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbdGV4dFN0eWxlXTsKCgkJaWYgKHN0eWxlQ2FjaGUgPT0gbnVsbCkgewoJCQlzdHlsZUNhY2hlID0gbGF5ZXJDYWNoZVt0ZXh0U3R5bGVdID0ge307CgkJfQoKCQlpbmZvID0gc3R5bGVDYWNoZVt0ZXh0XTsKCgkJLy8gSWYgd2UgY2FuJ3QgZmluZCBhIG1hdGNoaW5nIGVsZW1lbnQgaW4gb3VyIGNhY2hlLCBjcmVhdGUgYSBuZXcgb25lCgoJCWlmIChpbmZvID09IG51bGwpIHsKCgkJCXZhciBlbGVtZW50ID0gJCgiPGRpdj48L2Rpdj4iKS5odG1sKHRleHQpCgkJCQkuY3NzKHsKCQkJCQlwb3NpdGlvbjogImFic29sdXRlIiwKCQkJCQknbWF4LXdpZHRoJzogd2lkdGgsCgkJCQkJdG9wOiAtOTk5OQoJCQkJfSkKCQkJCS5hcHBlbmRUbyh0aGlzLmdldFRleHRMYXllcihsYXllcikpOwoKCQkJaWYgKHR5cGVvZiBmb250ID09PSAib2JqZWN0IikgewoJCQkJZWxlbWVudC5jc3MoewoJCQkJCWZvbnQ6IHRleHRTdHlsZSwKCQkJCQljb2xvcjogZm9udC5jb2xvcgoJCQkJfSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mIGZvbnQgPT09ICJzdHJpbmciKSB7CgkJCQllbGVtZW50LmFkZENsYXNzKGZvbnQpOwoJCQl9CgoJCQlpbmZvID0gc3R5bGVDYWNoZVt0ZXh0XSA9IHsKCQkJCXdpZHRoOiBlbGVtZW50Lm91dGVyV2lkdGgodHJ1ZSksCgkJCQloZWlnaHQ6IGVsZW1lbnQub3V0ZXJIZWlnaHQodHJ1ZSksCgkJCQllbGVtZW50OiBlbGVtZW50LAoJCQkJcG9zaXRpb25zOiBbXQoJCQl9OwoKCQkJZWxlbWVudC5kZXRhY2goKTsKCQl9CgoJCXJldHVybiBpbmZvOwoJfTsKCgkvLyBBZGRzIGEgdGV4dCBzdHJpbmcgdG8gdGhlIGNhbnZhcyB0ZXh0IG92ZXJsYXkuCgkvLwoJLy8gVGhlIHRleHQgaXNuJ3QgZHJhd24gaW1tZWRpYXRlbHk7IGl0IGlzIG1hcmtlZCBhcyByZW5kZXJpbmcsIHdoaWNoIHdpbGwKCS8vIHJlc3VsdCBpbiBpdHMgYWRkaXRpb24gdG8gdGhlIGNhbnZhcyBvbiB0aGUgbmV4dCByZW5kZXIgcGFzcy4KCS8vCgkvLyBAcGFyYW0ge3N0cmluZ30gbGF5ZXIgQSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUyBjbGFzc2VzIHVuaXF1ZWx5CgkvLyAgICAgaWRlbnRpZnlpbmcgdGhlIGxheWVyIGNvbnRhaW5pbmcgdGhpcyB0ZXh0LgoJLy8gQHBhcmFtIHtudW1iZXJ9IHggWCBjb29yZGluYXRlIGF0IHdoaWNoIHRvIGRyYXcgdGhlIHRleHQuCgkvLyBAcGFyYW0ge251bWJlcn0geSBZIGNvb3JkaW5hdGUgYXQgd2hpY2ggdG8gZHJhdyB0aGUgdGV4dC4KCS8vIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRleHQgc3RyaW5nIHRvIGRyYXcuCgkvLyBAcGFyYW0geyhzdHJpbmd8b2JqZWN0KT19IGZvbnQgRWl0aGVyIGEgc3RyaW5nIG9mIHNwYWNlLXNlcGFyYXRlZCBDU1MKCS8vICAgICBjbGFzc2VzIG9yIGEgZm9udC1zcGVjIG9iamVjdCwgZGVmaW5pbmcgdGhlIHRleHQncyBmb250IGFuZCBzdHlsZS4KCS8vIEBwYXJhbSB7bnVtYmVyPX0gYW5nbGUgQW5nbGUgYXQgd2hpY2ggdG8gcm90YXRlIHRoZSB0ZXh0LCBpbiBkZWdyZWVzLgoJLy8gICAgIEFuZ2xlIGlzIGN1cnJlbnRseSB1bnVzZWQsIGl0IHdpbGwgYmUgaW1wbGVtZW50ZWQgaW4gdGhlIGZ1dHVyZS4KCS8vIEBwYXJhbSB7bnVtYmVyPX0gd2lkdGggTWF4aW11bSB3aWR0aCBvZiB0aGUgdGV4dCBiZWZvcmUgaXQgd3JhcHMuCgkvLyBAcGFyYW0ge3N0cmluZz19IGhhbGlnbiBIb3Jpem9udGFsIGFsaWdubWVudCBvZiB0aGUgdGV4dDsgZWl0aGVyICJsZWZ0IiwKCS8vICAgICAiY2VudGVyIiBvciAicmlnaHQiLgoJLy8gQHBhcmFtIHtzdHJpbmc9fSB2YWxpZ24gVmVydGljYWwgYWxpZ25tZW50IG9mIHRoZSB0ZXh0OyBlaXRoZXIgInRvcCIsCgkvLyAgICAgIm1pZGRsZSIgb3IgImJvdHRvbSIuCgoJQ2FudmFzLnByb3RvdHlwZS5hZGRUZXh0ID0gZnVuY3Rpb24obGF5ZXIsIHgsIHksIHRleHQsIGZvbnQsIGFuZ2xlLCB3aWR0aCwgaGFsaWduLCB2YWxpZ24pIHsKCgkJdmFyIGluZm8gPSB0aGlzLmdldFRleHRJbmZvKGxheWVyLCB0ZXh0LCBmb250LCBhbmdsZSwgd2lkdGgpLAoJCQlwb3NpdGlvbnMgPSBpbmZvLnBvc2l0aW9uczsKCgkJLy8gVHdlYWsgdGhlIGRpdidzIHBvc2l0aW9uIHRvIG1hdGNoIHRoZSB0ZXh0J3MgYWxpZ25tZW50CgoJCWlmIChoYWxpZ24gPT0gImNlbnRlciIpIHsKCQkJeCAtPSBpbmZvLndpZHRoIC8gMjsKCQl9IGVsc2UgaWYgKGhhbGlnbiA9PSAicmlnaHQiKSB7CgkJCXggLT0gaW5mby53aWR0aDsKCQl9CgoJCWlmICh2YWxpZ24gPT0gIm1pZGRsZSIpIHsKCQkJeSAtPSBpbmZvLmhlaWdodCAvIDI7CgkJfSBlbHNlIGlmICh2YWxpZ24gPT0gImJvdHRvbSIpIHsKCQkJeSAtPSBpbmZvLmhlaWdodDsKCQl9CgoJCS8vIERldGVybWluZSB3aGV0aGVyIHRoaXMgdGV4dCBhbHJlYWR5IGV4aXN0cyBhdCB0aGlzIHBvc2l0aW9uLgoJCS8vIElmIHNvLCBtYXJrIGl0IGZvciBpbmNsdXNpb24gaW4gdGhlIG5leHQgcmVuZGVyIHBhc3MuCgoJCWZvciAodmFyIGkgPSAwLCBwb3NpdGlvbjsgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07IGkrKykgewoJCQlpZiAocG9zaXRpb24ueCA9PSB4ICYmIHBvc2l0aW9uLnkgPT0geSkgewoJCQkJcG9zaXRpb24uYWN0aXZlID0gdHJ1ZTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJLy8gSWYgdGhlIHRleHQgZG9lc24ndCBleGlzdCBhdCB0aGlzIHBvc2l0aW9uLCBjcmVhdGUgYSBuZXcgZW50cnkKCgkJLy8gRm9yIHRoZSB2ZXJ5IGZpcnN0IHBvc2l0aW9uIHdlJ2xsIHJlLXVzZSB0aGUgb3JpZ2luYWwgZWxlbWVudCwKCQkvLyB3aGlsZSBmb3Igc3Vic2VxdWVudCBvbmVzIHdlJ2xsIGNsb25lIGl0LgoKCQlwb3NpdGlvbiA9IHsKCQkJYWN0aXZlOiB0cnVlLAoJCQlyZW5kZXJlZDogZmFsc2UsCgkJCWVsZW1lbnQ6IHBvc2l0aW9ucy5sZW5ndGggPyBpbmZvLmVsZW1lbnQuY2xvbmUoKSA6IGluZm8uZWxlbWVudCwKCQkJeDogeCwKCQkJeTogeQoJCX07CgoJCXBvc2l0aW9ucy5wdXNoKHBvc2l0aW9uKTsKCgkJLy8gTW92ZSB0aGUgZWxlbWVudCB0byBpdHMgZmluYWwgcG9zaXRpb24gd2l0aGluIHRoZSBjb250YWluZXIKCgkJcG9zaXRpb24uZWxlbWVudC5jc3MoewoJCQl0b3A6IE1hdGgucm91bmQoeSksCgkJCWxlZnQ6IE1hdGgucm91bmQoeCksCgkJCSd0ZXh0LWFsaWduJzogaGFsaWduCS8vIEluIGNhc2UgdGhlIHRleHQgd3JhcHMKCQl9KTsKCX07CgoJLy8gUmVtb3ZlcyBvbmUgb3IgbW9yZSB0ZXh0IHN0cmluZ3MgZnJvbSB0aGUgY2FudmFzIHRleHQgb3ZlcmxheS4KCS8vCgkvLyBJZiBubyBwYXJhbWV0ZXJzIGFyZSBnaXZlbiwgYWxsIHRleHQgd2l0aGluIHRoZSBsYXllciBpcyByZW1vdmVkLgoJLy8KCS8vIE5vdGUgdGhhdCB0aGUgdGV4dCBpcyBub3QgaW1tZWRpYXRlbHkgcmVtb3ZlZDsgaXQgaXMgc2ltcGx5IG1hcmtlZCBhcwoJLy8gaW5hY3RpdmUsIHdoaWNoIHdpbGwgcmVzdWx0IGluIGl0cyByZW1vdmFsIG9uIHRoZSBuZXh0IHJlbmRlciBwYXNzLgoJLy8gVGhpcyBhdm9pZHMgdGhlIHBlcmZvcm1hbmNlIHBlbmFsdHkgZm9yICdjbGVhciBhbmQgcmVkcmF3JyBiZWhhdmlvciwKCS8vIHdoZXJlIHdlIHBvdGVudGlhbGx5IGdldCByaWQgb2YgYWxsIHRleHQgb24gYSBsYXllciwgYnV0IHdpbGwgbGlrZWx5CgkvLyBhZGQgYmFjayBtb3N0IG9yIGFsbCBvZiBpdCBsYXRlciwgYXMgd2hlbiByZWRyYXdpbmcgYXhlcywgZm9yIGV4YW1wbGUuCgkvLwoJLy8gQHBhcmFtIHtzdHJpbmd9IGxheWVyIEEgc3RyaW5nIG9mIHNwYWNlLXNlcGFyYXRlZCBDU1MgY2xhc3NlcyB1bmlxdWVseQoJLy8gICAgIGlkZW50aWZ5aW5nIHRoZSBsYXllciBjb250YWluaW5nIHRoaXMgdGV4dC4KCS8vIEBwYXJhbSB7bnVtYmVyPX0geCBYIGNvb3JkaW5hdGUgb2YgdGhlIHRleHQuCgkvLyBAcGFyYW0ge251bWJlcj19IHkgWSBjb29yZGluYXRlIG9mIHRoZSB0ZXh0LgoJLy8gQHBhcmFtIHtzdHJpbmc9fSB0ZXh0IFRleHQgc3RyaW5nIHRvIHJlbW92ZS4KCS8vIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpPX0gZm9udCBFaXRoZXIgYSBzdHJpbmcgb2Ygc3BhY2Utc2VwYXJhdGVkIENTUwoJLy8gICAgIGNsYXNzZXMgb3IgYSBmb250LXNwZWMgb2JqZWN0LCBkZWZpbmluZyB0aGUgdGV4dCdzIGZvbnQgYW5kIHN0eWxlLgoJLy8gQHBhcmFtIHtudW1iZXI9fSBhbmdsZSBBbmdsZSBhdCB3aGljaCB0aGUgdGV4dCBpcyByb3RhdGVkLCBpbiBkZWdyZWVzLgoJLy8gICAgIEFuZ2xlIGlzIGN1cnJlbnRseSB1bnVzZWQsIGl0IHdpbGwgYmUgaW1wbGVtZW50ZWQgaW4gdGhlIGZ1dHVyZS4KCglDYW52YXMucHJvdG90eXBlLnJlbW92ZVRleHQgPSBmdW5jdGlvbihsYXllciwgeCwgeSwgdGV4dCwgZm9udCwgYW5nbGUpIHsKCQlpZiAodGV4dCA9PSBudWxsKSB7CgkJCXZhciBsYXllckNhY2hlID0gdGhpcy5fdGV4dENhY2hlW2xheWVyXTsKCQkJaWYgKGxheWVyQ2FjaGUgIT0gbnVsbCkgewoJCQkJZm9yICh2YXIgc3R5bGVLZXkgaW4gbGF5ZXJDYWNoZSkgewoJCQkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGxheWVyQ2FjaGUsIHN0eWxlS2V5KSkgewoJCQkJCQl2YXIgc3R5bGVDYWNoZSA9IGxheWVyQ2FjaGVbc3R5bGVLZXldOwoJCQkJCQlmb3IgKHZhciBrZXkgaW4gc3R5bGVDYWNoZSkgewoJCQkJCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwoc3R5bGVDYWNoZSwga2V5KSkgewoJCQkJCQkJCXZhciBwb3NpdGlvbnMgPSBzdHlsZUNhY2hlW2tleV0ucG9zaXRpb25zOwoJCQkJCQkJCWZvciAodmFyIGkgPSAwLCBwb3NpdGlvbjsgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07IGkrKykgewoJCQkJCQkJCQlwb3NpdGlvbi5hY3RpdmUgPSBmYWxzZTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQl2YXIgcG9zaXRpb25zID0gdGhpcy5nZXRUZXh0SW5mbyhsYXllciwgdGV4dCwgZm9udCwgYW5nbGUpLnBvc2l0aW9uczsKCQkJZm9yICh2YXIgaSA9IDAsIHBvc2l0aW9uOyBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsgaSsrKSB7CgkJCQlpZiAocG9zaXRpb24ueCA9PSB4ICYmIHBvc2l0aW9uLnkgPT0geSkgewoJCQkJCXBvc2l0aW9uLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfQoJCQl9CgkJfQoJfTsKCgkvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCS8vIFRoZSB0b3AtbGV2ZWwgY29udGFpbmVyIGZvciB0aGUgZW50aXJlIHBsb3QuCgogICAgZnVuY3Rpb24gUGxvdChwbGFjZWhvbGRlciwgZGF0YV8sIG9wdGlvbnNfLCBwbHVnaW5zKSB7CiAgICAgICAgLy8gZGF0YSBpcyBvbiB0aGUgZm9ybToKICAgICAgICAvLyAgIFsgc2VyaWVzMSwgc2VyaWVzMiAuLi4gXQogICAgICAgIC8vIHdoZXJlIHNlcmllcyBpcyBlaXRoZXIganVzdCB0aGUgZGF0YSBhcyBbIFt4MSwgeTFdLCBbeDIsIHkyXSwgLi4uIF0KICAgICAgICAvLyBvciB7IGRhdGE6IFsgW3gxLCB5MV0sIFt4MiwgeTJdLCAuLi4gXSwgbGFiZWw6ICJzb21lIGxhYmVsIiwgLi4uIH0KCiAgICAgICAgdmFyIHNlcmllcyA9IFtdLAogICAgICAgICAgICBvcHRpb25zID0gewogICAgICAgICAgICAgICAgLy8gdGhlIGNvbG9yIHRoZW1lIHVzZWQgZm9yIGdyYXBocwogICAgICAgICAgICAgICAgY29sb3JzOiBbIiNlZGMyNDAiLCAiI2FmZDhmOCIsICIjY2I0YjRiIiwgIiM0ZGE3NGQiLCAiIzk0NDBlZCJdLAogICAgICAgICAgICAgICAgbGVnZW5kOiB7CiAgICAgICAgICAgICAgICAgICAgc2hvdzogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBub0NvbHVtbnM6IDEsIC8vIG51bWJlciBvZiBjb2x1bXMgaW4gbGVnZW5kIHRhYmxlCiAgICAgICAgICAgICAgICAgICAgbGFiZWxGb3JtYXR0ZXI6IG51bGwsIC8vIGZuOiBzdHJpbmcgLT4gc3RyaW5nCiAgICAgICAgICAgICAgICAgICAgbGFiZWxCb3hCb3JkZXJDb2xvcjogIiNjY2MiLCAvLyBib3JkZXIgY29sb3IgZm9yIHRoZSBsaXR0bGUgbGFiZWwgYm94ZXMKICAgICAgICAgICAgICAgICAgICBjb250YWluZXI6IG51bGwsIC8vIGNvbnRhaW5lciAoYXMgalF1ZXJ5IG9iamVjdCkgdG8gcHV0IGxlZ2VuZCBpbiwgbnVsbCBtZWFucyBkZWZhdWx0IG9uIHRvcCBvZiBncmFwaAogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAibmUiLCAvLyBwb3NpdGlvbiBvZiBkZWZhdWx0IGxlZ2VuZCBjb250YWluZXIgd2l0aGluIHBsb3QKICAgICAgICAgICAgICAgICAgICBtYXJnaW46IDUsIC8vIGRpc3RhbmNlIGZyb20gZ3JpZCBlZGdlIHRvIGRlZmF1bHQgbGVnZW5kIGNvbnRhaW5lciB3aXRoaW4gcGxvdAogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogbnVsbCwgLy8gbnVsbCBtZWFucyBhdXRvLWRldGVjdAogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRPcGFjaXR5OiAwLjg1LCAvLyBzZXQgdG8gMCB0byBhdm9pZCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICAgICAgc29ydGVkOiBudWxsICAgIC8vIGRlZmF1bHQgdG8gbm8gbGVnZW5kIHNvcnRpbmcKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB4YXhpczogewogICAgICAgICAgICAgICAgICAgIHNob3c6IG51bGwsIC8vIG51bGwgPSBhdXRvLWRldGVjdCwgdHJ1ZSA9IGFsd2F5cywgZmFsc2UgPSBuZXZlcgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYm90dG9tIiwgLy8gb3IgInRvcCIKICAgICAgICAgICAgICAgICAgICBtb2RlOiBudWxsLCAvLyBudWxsIG9yICJ0aW1lIgogICAgICAgICAgICAgICAgICAgIGZvbnQ6IG51bGwsIC8vIG51bGwgKGRlcml2ZWQgZnJvbSBDU1MgaW4gcGxhY2Vob2xkZXIpIG9yIG9iamVjdCBsaWtlIHsgc2l6ZTogMTEsIGxpbmVIZWlnaHQ6IDEzLCBzdHlsZTogIml0YWxpYyIsIHdlaWdodDogImJvbGQiLCBmYW1pbHk6ICJzYW5zLXNlcmlmIiwgdmFyaWFudDogInNtYWxsLWNhcHMiIH0KICAgICAgICAgICAgICAgICAgICBjb2xvcjogbnVsbCwgLy8gYmFzZSBjb2xvciwgbGFiZWxzLCB0aWNrcwogICAgICAgICAgICAgICAgICAgIHRpY2tDb2xvcjogbnVsbCwgLy8gcG9zc2libHkgZGlmZmVyZW50IGNvbG9yIG9mIHRpY2tzLCBlLmcuICJyZ2JhKDAsMCwwLDAuMTUpIgogICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogbnVsbCwgLy8gbnVsbCBvciBmOiBudW1iZXIgLT4gbnVtYmVyIHRvIHRyYW5zZm9ybSBheGlzCiAgICAgICAgICAgICAgICAgICAgaW52ZXJzZVRyYW5zZm9ybTogbnVsbCwgLy8gaWYgdHJhbnNmb3JtIGlzIHNldCwgdGhpcyBzaG91bGQgYmUgdGhlIGludmVyc2UgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICBtaW46IG51bGwsIC8vIG1pbi4gdmFsdWUgdG8gc2hvdywgbnVsbCBtZWFucyBzZXQgYXV0b21hdGljYWxseQogICAgICAgICAgICAgICAgICAgIG1heDogbnVsbCwgLy8gbWF4LiB2YWx1ZSB0byBzaG93LCBudWxsIG1lYW5zIHNldCBhdXRvbWF0aWNhbGx5CiAgICAgICAgICAgICAgICAgICAgYXV0b3NjYWxlTWFyZ2luOiBudWxsLCAvLyBtYXJnaW4gaW4gJSB0byBhZGQgaWYgYXV0by1zZXR0aW5nIG1pbi9tYXgKICAgICAgICAgICAgICAgICAgICB0aWNrczogbnVsbCwgLy8gZWl0aGVyIFsxLCAzXSBvciBbWzEsICJhIl0sIDNdIG9yIChmbjogYXhpcyBpbmZvIC0+IHRpY2tzKSBvciBhcHAuIG51bWJlciBvZiB0aWNrcyBmb3IgYXV0by10aWNrcwogICAgICAgICAgICAgICAgICAgIHRpY2tGb3JtYXR0ZXI6IG51bGwsIC8vIGZuOiBudW1iZXIgLT4gc3RyaW5nCiAgICAgICAgICAgICAgICAgICAgbGFiZWxXaWR0aDogbnVsbCwgLy8gc2l6ZSBvZiB0aWNrIGxhYmVscyBpbiBwaXhlbHMKICAgICAgICAgICAgICAgICAgICBsYWJlbEhlaWdodDogbnVsbCwKICAgICAgICAgICAgICAgICAgICByZXNlcnZlU3BhY2U6IG51bGwsIC8vIHdoZXRoZXIgdG8gcmVzZXJ2ZSBzcGFjZSBldmVuIGlmIGF4aXMgaXNuJ3Qgc2hvd24KICAgICAgICAgICAgICAgICAgICB0aWNrTGVuZ3RoOiBudWxsLCAvLyBzaXplIGluIHBpeGVscyBvZiB0aWNrcywgb3IgImZ1bGwiIGZvciB3aG9sZSBsaW5lCiAgICAgICAgICAgICAgICAgICAgYWxpZ25UaWNrc1dpdGhBeGlzOiBudWxsLCAvLyBheGlzIG51bWJlciBvciBudWxsIGZvciBubyBzeW5jCiAgICAgICAgICAgICAgICAgICAgdGlja0RlY2ltYWxzOiBudWxsLCAvLyBuby4gb2YgZGVjaW1hbHMsIG51bGwgbWVhbnMgYXV0bwogICAgICAgICAgICAgICAgICAgIHRpY2tTaXplOiBudWxsLCAvLyBudW1iZXIgb3IgW251bWJlciwgInVuaXQiXQogICAgICAgICAgICAgICAgICAgIG1pblRpY2tTaXplOiBudWxsIC8vIG51bWJlciBvciBbbnVtYmVyLCAidW5pdCJdCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgeWF4aXM6IHsKICAgICAgICAgICAgICAgICAgICBhdXRvc2NhbGVNYXJnaW46IDAuMDIsCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJsZWZ0IiAvLyBvciAicmlnaHQiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgeGF4ZXM6IFtdLAogICAgICAgICAgICAgICAgeWF4ZXM6IFtdLAogICAgICAgICAgICAgICAgc2VyaWVzOiB7CiAgICAgICAgICAgICAgICAgICAgcG9pbnRzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3c6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICByYWRpdXM6IDMsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVXaWR0aDogMiwgLy8gaW4gcGl4ZWxzCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxDb2xvcjogIiNmZmZmZmYiLAogICAgICAgICAgICAgICAgICAgICAgICBzeW1ib2w6ICJjaXJjbGUiIC8vIG9yIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBsaW5lczogewogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBwdXQgaW4gc2hvdzogZmFsc2Ugc28gd2UgY2FuIHNlZQogICAgICAgICAgICAgICAgICAgICAgICAvLyB3aGV0aGVyIGxpbmVzIHdlcmUgYWN0aXZlbHkgZGlzYWJsZWQKICAgICAgICAgICAgICAgICAgICAgICAgbGluZVdpZHRoOiAyLCAvLyBpbiBwaXhlbHMKICAgICAgICAgICAgICAgICAgICAgICAgZmlsbDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxDb2xvcjogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcHM6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9taXQgJ3plcm8nLCBzbyB3ZSBjYW4gbGF0ZXIgZGVmYXVsdCBpdHMgdmFsdWUgdG8KICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWF0Y2ggdGhhdCBvZiB0aGUgJ2ZpbGwnIG9wdGlvbi4KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGJhcnM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdzogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVXaWR0aDogMiwgLy8gaW4gcGl4ZWxzCiAgICAgICAgICAgICAgICAgICAgICAgIGJhcldpZHRoOiAxLCAvLyBpbiB1bml0cyBvZiB0aGUgeCBheGlzCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGw6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGxDb2xvcjogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ246ICJsZWZ0IiwgLy8gImxlZnQiLCAicmlnaHQiLCBvciAiY2VudGVyIgogICAgICAgICAgICAgICAgICAgICAgICBob3Jpem9udGFsOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgemVybzogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2hhZG93U2l6ZTogMywKICAgICAgICAgICAgICAgICAgICBoaWdobGlnaHRDb2xvcjogbnVsbAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGdyaWQ6IHsKICAgICAgICAgICAgICAgICAgICBzaG93OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGFib3ZlRGF0YTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgY29sb3I6ICIjNTQ1NDU0IiwgLy8gcHJpbWFyeSBjb2xvciB1c2VkIGZvciBvdXRsaW5lIGFuZCBsYWJlbHMKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG51bGwsIC8vIG51bGwgZm9yIHRyYW5zcGFyZW50LCBlbHNlIGNvbG9yCiAgICAgICAgICAgICAgICAgICAgYm9yZGVyQ29sb3I6IG51bGwsIC8vIHNldCBpZiBkaWZmZXJlbnQgZnJvbSB0aGUgZ3JpZCBjb2xvcgogICAgICAgICAgICAgICAgICAgIHRpY2tDb2xvcjogbnVsbCwgLy8gY29sb3IgZm9yIHRoZSB0aWNrcywgZS5nLiAicmdiYSgwLDAsMCwwLjE1KSIKICAgICAgICAgICAgICAgICAgICBtYXJnaW46IDAsIC8vIGRpc3RhbmNlIGZyb20gdGhlIGNhbnZhcyBlZGdlIHRvIHRoZSBncmlkCiAgICAgICAgICAgICAgICAgICAgbGFiZWxNYXJnaW46IDUsIC8vIGluIHBpeGVscwogICAgICAgICAgICAgICAgICAgIGF4aXNNYXJnaW46IDgsIC8vIGluIHBpeGVscwogICAgICAgICAgICAgICAgICAgIGJvcmRlcldpZHRoOiAyLCAvLyBpbiBwaXhlbHMKICAgICAgICAgICAgICAgICAgICBtaW5Cb3JkZXJNYXJnaW46IG51bGwsIC8vIGluIHBpeGVscywgbnVsbCBtZWFucyB0YWtlbiBmcm9tIHBvaW50cyByYWRpdXMKICAgICAgICAgICAgICAgICAgICBtYXJraW5nczogbnVsbCwgLy8gYXJyYXkgb2YgcmFuZ2VzIG9yIGZuOiBheGVzIC0+IGFycmF5IG9mIHJhbmdlcwogICAgICAgICAgICAgICAgICAgIG1hcmtpbmdzQ29sb3I6ICIjZjRmNGY0IiwKICAgICAgICAgICAgICAgICAgICBtYXJraW5nc0xpbmVXaWR0aDogMiwKICAgICAgICAgICAgICAgICAgICAvLyBpbnRlcmFjdGl2ZSBzdHVmZgogICAgICAgICAgICAgICAgICAgIGNsaWNrYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaG92ZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBhdXRvSGlnaGxpZ2h0OiB0cnVlLCAvLyBoaWdobGlnaHQgaW4gY2FzZSBtb3VzZSBpcyBuZWFyCiAgICAgICAgICAgICAgICAgICAgbW91c2VBY3RpdmVSYWRpdXM6IDEwIC8vIGhvdyBmYXIgdGhlIG1vdXNlIGNhbiBiZSBhd2F5IHRvIGFjdGl2YXRlIGFuIGl0ZW0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnRlcmFjdGlvbjogewogICAgICAgICAgICAgICAgICAgIHJlZHJhd092ZXJsYXlJbnRlcnZhbDogMTAwMC82MCAvLyB0aW1lIGJldHdlZW4gdXBkYXRlcywgLTEgbWVhbnMgaW4gc2FtZSBmbG93CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaG9va3M6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgc3VyZmFjZSA9IG51bGwsICAgICAvLyB0aGUgY2FudmFzIGZvciB0aGUgcGxvdCBpdHNlbGYKICAgICAgICBvdmVybGF5ID0gbnVsbCwgICAgIC8vIGNhbnZhcyBmb3IgaW50ZXJhY3RpdmUgc3R1ZmYgb24gdG9wIG9mIHBsb3QKICAgICAgICBldmVudEhvbGRlciA9IG51bGwsIC8vIGpRdWVyeSBvYmplY3QgdGhhdCBldmVudHMgc2hvdWxkIGJlIGJvdW5kIHRvCiAgICAgICAgY3R4ID0gbnVsbCwgb2N0eCA9IG51bGwsCiAgICAgICAgeGF4ZXMgPSBbXSwgeWF4ZXMgPSBbXSwKICAgICAgICBwbG90T2Zmc2V0ID0geyBsZWZ0OiAwLCByaWdodDogMCwgdG9wOiAwLCBib3R0b206IDB9LAogICAgICAgIHBsb3RXaWR0aCA9IDAsIHBsb3RIZWlnaHQgPSAwLAogICAgICAgIGhvb2tzID0gewogICAgICAgICAgICBwcm9jZXNzT3B0aW9uczogW10sCiAgICAgICAgICAgIHByb2Nlc3NSYXdEYXRhOiBbXSwKICAgICAgICAgICAgcHJvY2Vzc0RhdGFwb2ludHM6IFtdLAogICAgICAgICAgICBwcm9jZXNzT2Zmc2V0OiBbXSwKICAgICAgICAgICAgZHJhd0JhY2tncm91bmQ6IFtdLAogICAgICAgICAgICBkcmF3U2VyaWVzOiBbXSwKICAgICAgICAgICAgZHJhdzogW10sCiAgICAgICAgICAgIGJpbmRFdmVudHM6IFtdLAogICAgICAgICAgICBkcmF3T3ZlcmxheTogW10sCiAgICAgICAgICAgIHNodXRkb3duOiBbXQogICAgICAgIH0sCiAgICAgICAgcGxvdCA9IHRoaXM7CgogICAgICAgIC8vIHB1YmxpYyBmdW5jdGlvbnMKICAgICAgICBwbG90LnNldERhdGEgPSBzZXREYXRhOwogICAgICAgIHBsb3Quc2V0dXBHcmlkID0gc2V0dXBHcmlkOwogICAgICAgIHBsb3QuZHJhdyA9IGRyYXc7CiAgICAgICAgcGxvdC5nZXRQbGFjZWhvbGRlciA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gcGxhY2Vob2xkZXI7IH07CiAgICAgICAgcGxvdC5nZXRDYW52YXMgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHN1cmZhY2UuZWxlbWVudDsgfTsKICAgICAgICBwbG90LmdldFBsb3RPZmZzZXQgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHBsb3RPZmZzZXQ7IH07CiAgICAgICAgcGxvdC53aWR0aCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHBsb3RXaWR0aDsgfTsKICAgICAgICBwbG90LmhlaWdodCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHBsb3RIZWlnaHQ7IH07CiAgICAgICAgcGxvdC5vZmZzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBvID0gZXZlbnRIb2xkZXIub2Zmc2V0KCk7CiAgICAgICAgICAgIG8ubGVmdCArPSBwbG90T2Zmc2V0LmxlZnQ7CiAgICAgICAgICAgIG8udG9wICs9IHBsb3RPZmZzZXQudG9wOwogICAgICAgICAgICByZXR1cm4gbzsKICAgICAgICB9OwogICAgICAgIHBsb3QuZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHNlcmllczsgfTsKICAgICAgICBwbG90LmdldEF4ZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciByZXMgPSB7fSwgaTsKICAgICAgICAgICAgJC5lYWNoKHhheGVzLmNvbmNhdCh5YXhlcyksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXhpcykKICAgICAgICAgICAgICAgICAgICByZXNbYXhpcy5kaXJlY3Rpb24gKyAoYXhpcy5uICE9IDEgPyBheGlzLm4gOiAiIikgKyAiYXhpcyJdID0gYXhpczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfTsKICAgICAgICBwbG90LmdldFhBeGVzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4geGF4ZXM7IH07CiAgICAgICAgcGxvdC5nZXRZQXhlcyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHlheGVzOyB9OwogICAgICAgIHBsb3QuYzJwID0gY2FudmFzVG9BeGlzQ29vcmRzOwogICAgICAgIHBsb3QucDJjID0gYXhpc1RvQ2FudmFzQ29vcmRzOwogICAgICAgIHBsb3QuZ2V0T3B0aW9ucyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIG9wdGlvbnM7IH07CiAgICAgICAgcGxvdC5oaWdobGlnaHQgPSBoaWdobGlnaHQ7CiAgICAgICAgcGxvdC51bmhpZ2hsaWdodCA9IHVuaGlnaGxpZ2h0OwogICAgICAgIHBsb3QudHJpZ2dlclJlZHJhd092ZXJsYXkgPSB0cmlnZ2VyUmVkcmF3T3ZlcmxheTsKICAgICAgICBwbG90LnBvaW50T2Zmc2V0ID0gZnVuY3Rpb24ocG9pbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGxlZnQ6IHBhcnNlSW50KHhheGVzW2F4aXNOdW1iZXIocG9pbnQsICJ4IikgLSAxXS5wMmMoK3BvaW50LngpICsgcGxvdE9mZnNldC5sZWZ0LCAxMCksCiAgICAgICAgICAgICAgICB0b3A6IHBhcnNlSW50KHlheGVzW2F4aXNOdW1iZXIocG9pbnQsICJ5IikgLSAxXS5wMmMoK3BvaW50LnkpICsgcGxvdE9mZnNldC50b3AsIDEwKQogICAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgcGxvdC5zaHV0ZG93biA9IHNodXRkb3duOwogICAgICAgIHBsb3QuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2h1dGRvd24oKTsKICAgICAgICAgICAgcGxhY2Vob2xkZXIucmVtb3ZlRGF0YSgicGxvdCIpLmVtcHR5KCk7CgogICAgICAgICAgICBzZXJpZXMgPSBbXTsKICAgICAgICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHN1cmZhY2UgPSBudWxsOwogICAgICAgICAgICBvdmVybGF5ID0gbnVsbDsKICAgICAgICAgICAgZXZlbnRIb2xkZXIgPSBudWxsOwogICAgICAgICAgICBjdHggPSBudWxsOwogICAgICAgICAgICBvY3R4ID0gbnVsbDsKICAgICAgICAgICAgeGF4ZXMgPSBbXTsKICAgICAgICAgICAgeWF4ZXMgPSBbXTsKICAgICAgICAgICAgaG9va3MgPSBudWxsOwogICAgICAgICAgICBoaWdobGlnaHRzID0gW107CiAgICAgICAgICAgIHBsb3QgPSBudWxsOwogICAgICAgIH07CiAgICAgICAgcGxvdC5yZXNpemUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgCXZhciB3aWR0aCA9IHBsYWNlaG9sZGVyLndpZHRoKCksCiAgICAgICAgCQloZWlnaHQgPSBwbGFjZWhvbGRlci5oZWlnaHQoKTsKICAgICAgICAgICAgc3VyZmFjZS5yZXNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgIG92ZXJsYXkucmVzaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICAgIH07CgogICAgICAgIC8vIHB1YmxpYyBhdHRyaWJ1dGVzCiAgICAgICAgcGxvdC5ob29rcyA9IGhvb2tzOwoKICAgICAgICAvLyBpbml0aWFsaXplCiAgICAgICAgaW5pdFBsdWdpbnMocGxvdCk7CiAgICAgICAgcGFyc2VPcHRpb25zKG9wdGlvbnNfKTsKICAgICAgICBzZXR1cENhbnZhc2VzKCk7CiAgICAgICAgc2V0RGF0YShkYXRhXyk7CiAgICAgICAgc2V0dXBHcmlkKCk7CiAgICAgICAgZHJhdygpOwogICAgICAgIGJpbmRFdmVudHMoKTsKCgogICAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVIb29rcyhob29rLCBhcmdzKSB7CiAgICAgICAgICAgIGFyZ3MgPSBbcGxvdF0uY29uY2F0KGFyZ3MpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2subGVuZ3RoOyArK2kpCiAgICAgICAgICAgICAgICBob29rW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5pdFBsdWdpbnMoKSB7CgogICAgICAgICAgICAvLyBSZWZlcmVuY2VzIHRvIGtleSBjbGFzc2VzLCBhbGxvd2luZyBwbHVnaW5zIHRvIG1vZGlmeSB0aGVtCgogICAgICAgICAgICB2YXIgY2xhc3NlcyA9IHsKICAgICAgICAgICAgICAgIENhbnZhczogQ2FudmFzCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsdWdpbnMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBwID0gcGx1Z2luc1tpXTsKICAgICAgICAgICAgICAgIHAuaW5pdChwbG90LCBjbGFzc2VzKTsKICAgICAgICAgICAgICAgIGlmIChwLm9wdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgJC5leHRlbmQodHJ1ZSwgb3B0aW9ucywgcC5vcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGFyc2VPcHRpb25zKG9wdHMpIHsKCiAgICAgICAgICAgICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMsIG9wdHMpOwoKICAgICAgICAgICAgLy8gJC5leHRlbmQgbWVyZ2VzIGFycmF5cywgcmF0aGVyIHRoYW4gcmVwbGFjaW5nIHRoZW0uICBXaGVuIGxlc3MKICAgICAgICAgICAgLy8gY29sb3JzIGFyZSBwcm92aWRlZCB0aGFuIHRoZSBzaXplIG9mIHRoZSBkZWZhdWx0IHBhbGV0dGUsIHdlCiAgICAgICAgICAgIC8vIGVuZCB1cCB3aXRoIHRob3NlIGNvbG9ycyBwbHVzIHRoZSByZW1haW5pbmcgZGVmYXVsdHMsIHdoaWNoIGlzCiAgICAgICAgICAgIC8vIG5vdCBleHBlY3RlZCBiZWhhdmlvcjsgYXZvaWQgaXQgYnkgcmVwbGFjaW5nIHRoZW0gaGVyZS4KCiAgICAgICAgICAgIGlmIChvcHRzICYmIG9wdHMuY29sb3JzKSB7CiAgICAgICAgICAgIAlvcHRpb25zLmNvbG9ycyA9IG9wdHMuY29sb3JzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy54YXhpcy5jb2xvciA9PSBudWxsKQogICAgICAgICAgICAgICAgb3B0aW9ucy54YXhpcy5jb2xvciA9ICQuY29sb3IucGFyc2Uob3B0aW9ucy5ncmlkLmNvbG9yKS5zY2FsZSgnYScsIDAuMjIpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIGlmIChvcHRpb25zLnlheGlzLmNvbG9yID09IG51bGwpCiAgICAgICAgICAgICAgICBvcHRpb25zLnlheGlzLmNvbG9yID0gJC5jb2xvci5wYXJzZShvcHRpb25zLmdyaWQuY29sb3IpLnNjYWxlKCdhJywgMC4yMikudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIGlmIChvcHRpb25zLnhheGlzLnRpY2tDb2xvciA9PSBudWxsKSAvLyBncmlkLnRpY2tDb2xvciBmb3IgYmFjay1jb21wYXRpYmlsaXR5CiAgICAgICAgICAgICAgICBvcHRpb25zLnhheGlzLnRpY2tDb2xvciA9IG9wdGlvbnMuZ3JpZC50aWNrQ29sb3IgfHwgb3B0aW9ucy54YXhpcy5jb2xvcjsKICAgICAgICAgICAgaWYgKG9wdGlvbnMueWF4aXMudGlja0NvbG9yID09IG51bGwpIC8vIGdyaWQudGlja0NvbG9yIGZvciBiYWNrLWNvbXBhdGliaWxpdHkKICAgICAgICAgICAgICAgIG9wdGlvbnMueWF4aXMudGlja0NvbG9yID0gb3B0aW9ucy5ncmlkLnRpY2tDb2xvciB8fCBvcHRpb25zLnlheGlzLmNvbG9yOwoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuZ3JpZC5ib3JkZXJDb2xvciA9PSBudWxsKQogICAgICAgICAgICAgICAgb3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yID0gb3B0aW9ucy5ncmlkLmNvbG9yOwogICAgICAgICAgICBpZiAob3B0aW9ucy5ncmlkLnRpY2tDb2xvciA9PSBudWxsKQogICAgICAgICAgICAgICAgb3B0aW9ucy5ncmlkLnRpY2tDb2xvciA9ICQuY29sb3IucGFyc2Uob3B0aW9ucy5ncmlkLmNvbG9yKS5zY2FsZSgnYScsIDAuMjIpLnRvU3RyaW5nKCk7CgogICAgICAgICAgICAvLyBGaWxsIGluIGRlZmF1bHRzIGZvciBheGlzIG9wdGlvbnMsIGluY2x1ZGluZyBhbnkgdW5zcGVjaWZpZWQKICAgICAgICAgICAgLy8gZm9udC1zcGVjIGZpZWxkcywgaWYgYSBmb250LXNwZWMgd2FzIHByb3ZpZGVkLgoKICAgICAgICAgICAgLy8gSWYgbm8geC95IGF4aXMgb3B0aW9ucyB3ZXJlIHByb3ZpZGVkLCBjcmVhdGUgb25lIG9mIGVhY2ggYW55d2F5LAogICAgICAgICAgICAvLyBzaW5jZSB0aGUgcmVzdCBvZiB0aGUgY29kZSBhc3N1bWVzIHRoYXQgdGhleSBleGlzdC4KCiAgICAgICAgICAgIHZhciBpLCBheGlzT3B0aW9ucywgYXhpc0NvdW50LAogICAgICAgICAgICAgICAgZm9udFNpemUgPSBwbGFjZWhvbGRlci5jc3MoImZvbnQtc2l6ZSIpLAogICAgICAgICAgICAgICAgZm9udFNpemVEZWZhdWx0ID0gZm9udFNpemUgPyArZm9udFNpemUucmVwbGFjZSgicHgiLCAiIikgOiAxMywKICAgICAgICAgICAgICAgIGZvbnREZWZhdWx0cyA9IHsKICAgICAgICAgICAgICAgICAgICBzdHlsZTogcGxhY2Vob2xkZXIuY3NzKCJmb250LXN0eWxlIiksCiAgICAgICAgICAgICAgICAgICAgc2l6ZTogTWF0aC5yb3VuZCgwLjggKiBmb250U2l6ZURlZmF1bHQpLAogICAgICAgICAgICAgICAgICAgIHZhcmlhbnQ6IHBsYWNlaG9sZGVyLmNzcygiZm9udC12YXJpYW50IiksCiAgICAgICAgICAgICAgICAgICAgd2VpZ2h0OiBwbGFjZWhvbGRlci5jc3MoImZvbnQtd2VpZ2h0IiksCiAgICAgICAgICAgICAgICAgICAgZmFtaWx5OiBwbGFjZWhvbGRlci5jc3MoImZvbnQtZmFtaWx5IikKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICBheGlzQ291bnQgPSBvcHRpb25zLnhheGVzLmxlbmd0aCB8fCAxOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXhpc0NvdW50OyArK2kpIHsKCiAgICAgICAgICAgICAgICBheGlzT3B0aW9ucyA9IG9wdGlvbnMueGF4ZXNbaV07CiAgICAgICAgICAgICAgICBpZiAoYXhpc09wdGlvbnMgJiYgIWF4aXNPcHRpb25zLnRpY2tDb2xvcikgewogICAgICAgICAgICAgICAgICAgIGF4aXNPcHRpb25zLnRpY2tDb2xvciA9IGF4aXNPcHRpb25zLmNvbG9yOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGF4aXNPcHRpb25zID0gJC5leHRlbmQodHJ1ZSwge30sIG9wdGlvbnMueGF4aXMsIGF4aXNPcHRpb25zKTsKICAgICAgICAgICAgICAgIG9wdGlvbnMueGF4ZXNbaV0gPSBheGlzT3B0aW9uczsKCiAgICAgICAgICAgICAgICBpZiAoYXhpc09wdGlvbnMuZm9udCkgewogICAgICAgICAgICAgICAgICAgIGF4aXNPcHRpb25zLmZvbnQgPSAkLmV4dGVuZCh7fSwgZm9udERlZmF1bHRzLCBheGlzT3B0aW9ucy5mb250KTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWF4aXNPcHRpb25zLmZvbnQuY29sb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXhpc09wdGlvbnMuZm9udC5jb2xvciA9IGF4aXNPcHRpb25zLmNvbG9yOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWF4aXNPcHRpb25zLmZvbnQubGluZUhlaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICBheGlzT3B0aW9ucy5mb250LmxpbmVIZWlnaHQgPSBNYXRoLnJvdW5kKGF4aXNPcHRpb25zLmZvbnQuc2l6ZSAqIDEuMTUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXhpc0NvdW50ID0gb3B0aW9ucy55YXhlcy5sZW5ndGggfHwgMTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGF4aXNDb3VudDsgKytpKSB7CgogICAgICAgICAgICAgICAgYXhpc09wdGlvbnMgPSBvcHRpb25zLnlheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXNPcHRpb25zICYmICFheGlzT3B0aW9ucy50aWNrQ29sb3IpIHsKICAgICAgICAgICAgICAgICAgICBheGlzT3B0aW9ucy50aWNrQ29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBheGlzT3B0aW9ucyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zLnlheGlzLCBheGlzT3B0aW9ucyk7CiAgICAgICAgICAgICAgICBvcHRpb25zLnlheGVzW2ldID0gYXhpc09wdGlvbnM7CgogICAgICAgICAgICAgICAgaWYgKGF4aXNPcHRpb25zLmZvbnQpIHsKICAgICAgICAgICAgICAgICAgICBheGlzT3B0aW9ucy5mb250ID0gJC5leHRlbmQoe30sIGZvbnREZWZhdWx0cywgYXhpc09wdGlvbnMuZm9udCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmNvbG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF4aXNPcHRpb25zLmZvbnQuY29sb3IgPSBheGlzT3B0aW9ucy5jb2xvcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFheGlzT3B0aW9ucy5mb250LmxpbmVIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXhpc09wdGlvbnMuZm9udC5saW5lSGVpZ2h0ID0gTWF0aC5yb3VuZChheGlzT3B0aW9ucy5mb250LnNpemUgKiAxLjE1KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCB0byBiZSByZW1vdmVkIGluIGZ1dHVyZQogICAgICAgICAgICBpZiAob3B0aW9ucy54YXhpcy5ub1RpY2tzICYmIG9wdGlvbnMueGF4aXMudGlja3MgPT0gbnVsbCkKICAgICAgICAgICAgICAgIG9wdGlvbnMueGF4aXMudGlja3MgPSBvcHRpb25zLnhheGlzLm5vVGlja3M7CiAgICAgICAgICAgIGlmIChvcHRpb25zLnlheGlzLm5vVGlja3MgJiYgb3B0aW9ucy55YXhpcy50aWNrcyA9PSBudWxsKQogICAgICAgICAgICAgICAgb3B0aW9ucy55YXhpcy50aWNrcyA9IG9wdGlvbnMueWF4aXMubm9UaWNrczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMueDJheGlzKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnhheGVzWzFdID0gJC5leHRlbmQodHJ1ZSwge30sIG9wdGlvbnMueGF4aXMsIG9wdGlvbnMueDJheGlzKTsKICAgICAgICAgICAgICAgIG9wdGlvbnMueGF4ZXNbMV0ucG9zaXRpb24gPSAidG9wIjsKICAgICAgICAgICAgICAgIC8vIE92ZXJyaWRlIHRoZSBpbmhlcml0IHRvIGFsbG93IHRoZSBheGlzIHRvIGF1dG8tc2NhbGUKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLngyYXhpcy5taW4gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMueGF4ZXNbMV0ubWluID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLngyYXhpcy5tYXggPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMueGF4ZXNbMV0ubWF4ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy55MmF4aXMpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMueWF4ZXNbMV0gPSAkLmV4dGVuZCh0cnVlLCB7fSwgb3B0aW9ucy55YXhpcywgb3B0aW9ucy55MmF4aXMpOwogICAgICAgICAgICAgICAgb3B0aW9ucy55YXhlc1sxXS5wb3NpdGlvbiA9ICJyaWdodCI7CiAgICAgICAgICAgICAgICAvLyBPdmVycmlkZSB0aGUgaW5oZXJpdCB0byBhbGxvdyB0aGUgYXhpcyB0byBhdXRvLXNjYWxlCiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy55MmF4aXMubWluID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnlheGVzWzFdLm1pbiA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy55MmF4aXMubWF4ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnlheGVzWzFdLm1heCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMuZ3JpZC5jb2xvcmVkQXJlYXMpCiAgICAgICAgICAgICAgICBvcHRpb25zLmdyaWQubWFya2luZ3MgPSBvcHRpb25zLmdyaWQuY29sb3JlZEFyZWFzOwogICAgICAgICAgICBpZiAob3B0aW9ucy5ncmlkLmNvbG9yZWRBcmVhc0NvbG9yKQogICAgICAgICAgICAgICAgb3B0aW9ucy5ncmlkLm1hcmtpbmdzQ29sb3IgPSBvcHRpb25zLmdyaWQuY29sb3JlZEFyZWFzQ29sb3I7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmxpbmVzKQogICAgICAgICAgICAgICAgJC5leHRlbmQodHJ1ZSwgb3B0aW9ucy5zZXJpZXMubGluZXMsIG9wdGlvbnMubGluZXMpOwogICAgICAgICAgICBpZiAob3B0aW9ucy5wb2ludHMpCiAgICAgICAgICAgICAgICAkLmV4dGVuZCh0cnVlLCBvcHRpb25zLnNlcmllcy5wb2ludHMsIG9wdGlvbnMucG9pbnRzKTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYmFycykKICAgICAgICAgICAgICAgICQuZXh0ZW5kKHRydWUsIG9wdGlvbnMuc2VyaWVzLmJhcnMsIG9wdGlvbnMuYmFycyk7CiAgICAgICAgICAgIGlmIChvcHRpb25zLnNoYWRvd1NpemUgIT0gbnVsbCkKICAgICAgICAgICAgICAgIG9wdGlvbnMuc2VyaWVzLnNoYWRvd1NpemUgPSBvcHRpb25zLnNoYWRvd1NpemU7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmhpZ2hsaWdodENvbG9yICE9IG51bGwpCiAgICAgICAgICAgICAgICBvcHRpb25zLnNlcmllcy5oaWdobGlnaHRDb2xvciA9IG9wdGlvbnMuaGlnaGxpZ2h0Q29sb3I7CgogICAgICAgICAgICAvLyBzYXZlIG9wdGlvbnMgb24gYXhlcyBmb3IgZnV0dXJlIHJlZmVyZW5jZQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3B0aW9ucy54YXhlcy5sZW5ndGg7ICsraSkKICAgICAgICAgICAgICAgIGdldE9yQ3JlYXRlQXhpcyh4YXhlcywgaSArIDEpLm9wdGlvbnMgPSBvcHRpb25zLnhheGVzW2ldOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3B0aW9ucy55YXhlcy5sZW5ndGg7ICsraSkKICAgICAgICAgICAgICAgIGdldE9yQ3JlYXRlQXhpcyh5YXhlcywgaSArIDEpLm9wdGlvbnMgPSBvcHRpb25zLnlheGVzW2ldOwoKICAgICAgICAgICAgLy8gYWRkIGhvb2tzIGZyb20gb3B0aW9ucwogICAgICAgICAgICBmb3IgKHZhciBuIGluIGhvb2tzKQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaG9va3Nbbl0gJiYgb3B0aW9ucy5ob29rc1tuXS5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgaG9va3Nbbl0gPSBob29rc1tuXS5jb25jYXQob3B0aW9ucy5ob29rc1tuXSk7CgogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucHJvY2Vzc09wdGlvbnMsIFtvcHRpb25zXSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXREYXRhKGQpIHsKICAgICAgICAgICAgc2VyaWVzID0gcGFyc2VEYXRhKGQpOwogICAgICAgICAgICBmaWxsSW5TZXJpZXNPcHRpb25zKCk7CiAgICAgICAgICAgIHByb2Nlc3NEYXRhKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwYXJzZURhdGEoZCkgewogICAgICAgICAgICB2YXIgcmVzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZC5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIHMgPSAkLmV4dGVuZCh0cnVlLCB7fSwgb3B0aW9ucy5zZXJpZXMpOwoKICAgICAgICAgICAgICAgIGlmIChkW2ldLmRhdGEgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHMuZGF0YSA9IGRbaV0uZGF0YTsgLy8gbW92ZSB0aGUgZGF0YSBpbnN0ZWFkIG9mIGRlZXAtY29weQogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkW2ldLmRhdGE7CgogICAgICAgICAgICAgICAgICAgICQuZXh0ZW5kKHRydWUsIHMsIGRbaV0pOwoKICAgICAgICAgICAgICAgICAgICBkW2ldLmRhdGEgPSBzLmRhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgcy5kYXRhID0gZFtpXTsKICAgICAgICAgICAgICAgIHJlcy5wdXNoKHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYXhpc051bWJlcihvYmosIGNvb3JkKSB7CiAgICAgICAgICAgIHZhciBhID0gb2JqW2Nvb3JkICsgImF4aXMiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhID09ICJvYmplY3QiKSAvLyBpZiB3ZSBnb3QgYSByZWFsIGF4aXMsIGV4dHJhY3QgbnVtYmVyCiAgICAgICAgICAgICAgICBhID0gYS5uOwogICAgICAgICAgICBpZiAodHlwZW9mIGEgIT0gIm51bWJlciIpCiAgICAgICAgICAgICAgICBhID0gMTsgLy8gZGVmYXVsdCB0byBmaXJzdCBheGlzCiAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWxsQXhlcygpIHsKICAgICAgICAgICAgLy8gcmV0dXJuIGZsYXQgYXJyYXkgd2l0aG91dCBhbm5veWluZyBudWxsIGVudHJpZXMKICAgICAgICAgICAgcmV0dXJuICQuZ3JlcCh4YXhlcy5jb25jYXQoeWF4ZXMpLCBmdW5jdGlvbiAoYSkgeyByZXR1cm4gYTsgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjYW52YXNUb0F4aXNDb29yZHMocG9zKSB7CiAgICAgICAgICAgIC8vIHJldHVybiBhbiBvYmplY3Qgd2l0aCB4L3kgY29ycmVzcG9uZGluZyB0byBhbGwgdXNlZCBheGVzCiAgICAgICAgICAgIHZhciByZXMgPSB7fSwgaSwgYXhpczsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHhheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBheGlzID0geGF4ZXNbaV07CiAgICAgICAgICAgICAgICBpZiAoYXhpcyAmJiBheGlzLnVzZWQpCiAgICAgICAgICAgICAgICAgICAgcmVzWyJ4IiArIGF4aXMubl0gPSBheGlzLmMycChwb3MubGVmdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB5YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgYXhpcyA9IHlheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXMgJiYgYXhpcy51c2VkKQogICAgICAgICAgICAgICAgICAgIHJlc1sieSIgKyBheGlzLm5dID0gYXhpcy5jMnAocG9zLnRvcCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyZXMueDEgIT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIHJlcy54ID0gcmVzLngxOwogICAgICAgICAgICBpZiAocmVzLnkxICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICByZXMueSA9IHJlcy55MTsKCiAgICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBheGlzVG9DYW52YXNDb29yZHMocG9zKSB7CiAgICAgICAgICAgIC8vIGdldCBjYW52YXMgY29vcmRzIGZyb20gdGhlIGZpcnN0IHBhaXIgb2YgeC95IGZvdW5kIGluIHBvcwogICAgICAgICAgICB2YXIgcmVzID0ge30sIGksIGF4aXMsIGtleTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB4YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgYXhpcyA9IHhheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXMgJiYgYXhpcy51c2VkKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gIngiICsgYXhpcy5uOwogICAgICAgICAgICAgICAgICAgIGlmIChwb3Nba2V5XSA9PSBudWxsICYmIGF4aXMubiA9PSAxKQogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSAieCI7CgogICAgICAgICAgICAgICAgICAgIGlmIChwb3Nba2V5XSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5sZWZ0ID0gYXhpcy5wMmMocG9zW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB5YXhlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgYXhpcyA9IHlheGVzW2ldOwogICAgICAgICAgICAgICAgaWYgKGF4aXMgJiYgYXhpcy51c2VkKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gInkiICsgYXhpcy5uOwogICAgICAgICAgICAgICAgICAgIGlmIChwb3Nba2V5XSA9PSBudWxsICYmIGF4aXMubiA9PSAxKQogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSAieSI7CgogICAgICAgICAgICAgICAgICAgIGlmIChwb3Nba2V5XSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy50b3AgPSBheGlzLnAyYyhwb3Nba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldE9yQ3JlYXRlQXhpcyhheGVzLCBudW1iZXIpIHsKICAgICAgICAgICAgaWYgKCFheGVzW251bWJlciAtIDFdKQogICAgICAgICAgICAgICAgYXhlc1tudW1iZXIgLSAxXSA9IHsKICAgICAgICAgICAgICAgICAgICBuOiBudW1iZXIsIC8vIHNhdmUgdGhlIG51bWJlciBmb3IgZnV0dXJlIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogYXhlcyA9PSB4YXhlcyA\/ICJ4IiA6ICJ5IiwKICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiAkLmV4dGVuZCh0cnVlLCB7fSwgYXhlcyA9PSB4YXhlcyA\/IG9wdGlvbnMueGF4aXMgOiBvcHRpb25zLnlheGlzKQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBheGVzW251bWJlciAtIDFdOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmlsbEluU2VyaWVzT3B0aW9ucygpIHsKCiAgICAgICAgICAgIHZhciBuZWVkZWRDb2xvcnMgPSBzZXJpZXMubGVuZ3RoLCBtYXhJbmRleCA9IC0xLCBpOwoKICAgICAgICAgICAgLy8gU3VidHJhY3QgdGhlIG51bWJlciBvZiBzZXJpZXMgdGhhdCBhbHJlYWR5IGhhdmUgZml4ZWQgY29sb3JzIG9yCiAgICAgICAgICAgIC8vIGNvbG9yIGluZGV4ZXMgZnJvbSB0aGUgbnVtYmVyIHRoYXQgd2Ugc3RpbGwgbmVlZCB0byBnZW5lcmF0ZS4KCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBzYyA9IHNlcmllc1tpXS5jb2xvcjsKICAgICAgICAgICAgICAgIGlmIChzYyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZGVkQ29sb3JzLS07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzYyA9PSAibnVtYmVyIiAmJiBzYyA+IG1heEluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1heEluZGV4ID0gc2M7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiBhbnkgb2YgdGhlIHNlcmllcyBoYXZlIGZpeGVkIGNvbG9yIGluZGV4ZXMsIHRoZW4gd2UgbmVlZCB0bwogICAgICAgICAgICAvLyBnZW5lcmF0ZSBhdCBsZWFzdCBhcyBtYW55IGNvbG9ycyBhcyB0aGUgaGlnaGVzdCBpbmRleC4KCiAgICAgICAgICAgIGlmIChuZWVkZWRDb2xvcnMgPD0gbWF4SW5kZXgpIHsKICAgICAgICAgICAgICAgIG5lZWRlZENvbG9ycyA9IG1heEluZGV4ICsgMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2VuZXJhdGUgYWxsIHRoZSBjb2xvcnMsIHVzaW5nIGZpcnN0IHRoZSBvcHRpb24gY29sb3JzIGFuZCB0aGVuCiAgICAgICAgICAgIC8vIHZhcmlhdGlvbnMgb24gdGhvc2UgY29sb3JzIG9uY2UgdGhleSdyZSBleGhhdXN0ZWQuCgogICAgICAgICAgICB2YXIgYywgY29sb3JzID0gW10sIGNvbG9yUG9vbCA9IG9wdGlvbnMuY29sb3JzLAogICAgICAgICAgICAgICAgY29sb3JQb29sU2l6ZSA9IGNvbG9yUG9vbC5sZW5ndGgsIHZhcmlhdGlvbiA9IDA7CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbmVlZGVkQ29sb3JzOyBpKyspIHsKCiAgICAgICAgICAgICAgICBjID0gJC5jb2xvci5wYXJzZShjb2xvclBvb2xbaSAlIGNvbG9yUG9vbFNpemVdIHx8ICIjNjY2Iik7CgogICAgICAgICAgICAgICAgLy8gRWFjaCB0aW1lIHdlIGV4aGF1c3QgdGhlIGNvbG9ycyBpbiB0aGUgcG9vbCB3ZSBhZGp1c3QKICAgICAgICAgICAgICAgIC8vIGEgc2NhbGluZyBmYWN0b3IgdXNlZCB0byBwcm9kdWNlIG1vcmUgdmFyaWF0aW9ucyBvbgogICAgICAgICAgICAgICAgLy8gdGhvc2UgY29sb3JzLiBUaGUgZmFjdG9yIGFsdGVybmF0ZXMgbmVnYXRpdmUvcG9zaXRpdmUKICAgICAgICAgICAgICAgIC8vIHRvIHByb2R1Y2UgbGlnaHRlci9kYXJrZXIgY29sb3JzLgoKICAgICAgICAgICAgICAgIC8vIFJlc2V0IHRoZSB2YXJpYXRpb24gYWZ0ZXIgZXZlcnkgZmV3IGN5Y2xlcywgb3IgZWxzZQogICAgICAgICAgICAgICAgLy8gaXQgd2lsbCBlbmQgdXAgcHJvZHVjaW5nIG9ubHkgd2hpdGUgb3IgYmxhY2sgY29sb3JzLgoKICAgICAgICAgICAgICAgIGlmIChpICUgY29sb3JQb29sU2l6ZSA9PSAwICYmIGkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFyaWF0aW9uID49IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhcmlhdGlvbiA8IDAuNSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWF0aW9uID0gLXZhcmlhdGlvbiAtIDAuMjsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHZhcmlhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHZhcmlhdGlvbiA9IC12YXJpYXRpb247CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29sb3JzW2ldID0gYy5zY2FsZSgncmdiJywgMSArIHZhcmlhdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZpbmFsaXplIHRoZSBzZXJpZXMgb3B0aW9ucywgZmlsbGluZyBpbiB0aGVpciBjb2xvcnMKCiAgICAgICAgICAgIHZhciBjb2xvcmkgPSAwLCBzOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBzID0gc2VyaWVzW2ldOwoKICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBjb2xvcnMKICAgICAgICAgICAgICAgIGlmIChzLmNvbG9yID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzLmNvbG9yID0gY29sb3JzW2NvbG9yaV0udG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICArK2NvbG9yaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBzLmNvbG9yID09ICJudW1iZXIiKQogICAgICAgICAgICAgICAgICAgIHMuY29sb3IgPSBjb2xvcnNbcy5jb2xvcl0udG9TdHJpbmcoKTsKCiAgICAgICAgICAgICAgICAvLyB0dXJuIG9uIGxpbmVzIGF1dG9tYXRpY2FsbHkgaW4gY2FzZSBub3RoaW5nIGlzIHNldAogICAgICAgICAgICAgICAgaWYgKHMubGluZXMuc2hvdyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHYsIHNob3cgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGZvciAodiBpbiBzKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc1t2XSAmJiBzW3ZdLnNob3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3cgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHNob3cpCiAgICAgICAgICAgICAgICAgICAgICAgIHMubGluZXMuc2hvdyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgbm90aGluZyB3YXMgcHJvdmlkZWQgZm9yIGxpbmVzLnplcm8sIGRlZmF1bHQgaXQgdG8gbWF0Y2gKICAgICAgICAgICAgICAgIC8vIGxpbmVzLmZpbGwsIHNpbmNlIGFyZWFzIGJ5IGRlZmF1bHQgc2hvdWxkIGV4dGVuZCB0byB6ZXJvLgoKICAgICAgICAgICAgICAgIGlmIChzLmxpbmVzLnplcm8gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHMubGluZXMuemVybyA9ICEhcy5saW5lcy5maWxsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHNldHVwIGF4ZXMKICAgICAgICAgICAgICAgIHMueGF4aXMgPSBnZXRPckNyZWF0ZUF4aXMoeGF4ZXMsIGF4aXNOdW1iZXIocywgIngiKSk7CiAgICAgICAgICAgICAgICBzLnlheGlzID0gZ2V0T3JDcmVhdGVBeGlzKHlheGVzLCBheGlzTnVtYmVyKHMsICJ5IikpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGF0YSgpIHsKICAgICAgICAgICAgdmFyIHRvcFNlbnRyeSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwKICAgICAgICAgICAgICAgIGJvdHRvbVNlbnRyeSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwKICAgICAgICAgICAgICAgIGZha2VJbmZpbml0eSA9IE51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICAgICAgICBpLCBqLCBrLCBtLCBsZW5ndGgsCiAgICAgICAgICAgICAgICBzLCBwb2ludHMsIHBzLCB4LCB5LCBheGlzLCB2YWwsIGYsIHAsCiAgICAgICAgICAgICAgICBkYXRhLCBmb3JtYXQ7CgogICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVBeGlzKGF4aXMsIG1pbiwgbWF4KSB7CiAgICAgICAgICAgICAgICBpZiAobWluIDwgYXhpcy5kYXRhbWluICYmIG1pbiAhPSAtZmFrZUluZmluaXR5KQogICAgICAgICAgICAgICAgICAgIGF4aXMuZGF0YW1pbiA9IG1pbjsKICAgICAgICAgICAgICAgIGlmIChtYXggPiBheGlzLmRhdGFtYXggJiYgbWF4ICE9IGZha2VJbmZpbml0eSkKICAgICAgICAgICAgICAgICAgICBheGlzLmRhdGFtYXggPSBtYXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgICAgICAgICAvLyBpbml0IGF4aXMKICAgICAgICAgICAgICAgIGF4aXMuZGF0YW1pbiA9IHRvcFNlbnRyeTsKICAgICAgICAgICAgICAgIGF4aXMuZGF0YW1heCA9IGJvdHRvbVNlbnRyeTsKICAgICAgICAgICAgICAgIGF4aXMudXNlZCA9IGZhbHNlOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHMgPSBzZXJpZXNbaV07CiAgICAgICAgICAgICAgICBzLmRhdGFwb2ludHMgPSB7IHBvaW50czogW10gfTsKCiAgICAgICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucHJvY2Vzc1Jhd0RhdGEsIFsgcywgcy5kYXRhLCBzLmRhdGFwb2ludHMgXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpcnN0IHBhc3M6IGNsZWFuIGFuZCBjb3B5IGRhdGEKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgcyA9IHNlcmllc1tpXTsKCiAgICAgICAgICAgICAgICBkYXRhID0gcy5kYXRhOwogICAgICAgICAgICAgICAgZm9ybWF0ID0gcy5kYXRhcG9pbnRzLmZvcm1hdDsKCiAgICAgICAgICAgICAgICBpZiAoIWZvcm1hdCkgewogICAgICAgICAgICAgICAgICAgIGZvcm1hdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIC8vIGZpbmQgb3V0IGhvdyB0byBjb3B5CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0LnB1c2goeyB4OiB0cnVlLCBudW1iZXI6IHRydWUsIHJlcXVpcmVkOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgICAgIGZvcm1hdC5wdXNoKHsgeTogdHJ1ZSwgbnVtYmVyOiB0cnVlLCByZXF1aXJlZDogdHJ1ZSB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHMuYmFycy5zaG93IHx8IChzLmxpbmVzLnNob3cgJiYgcy5saW5lcy5maWxsKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXV0b3NjYWxlID0gISEoKHMuYmFycy5zaG93ICYmIHMuYmFycy56ZXJvKSB8fCAocy5saW5lcy5zaG93ICYmIHMubGluZXMuemVybykpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQucHVzaCh7IHk6IHRydWUsIG51bWJlcjogdHJ1ZSwgcmVxdWlyZWQ6IGZhbHNlLCBkZWZhdWx0VmFsdWU6IDAsIGF1dG9zY2FsZTogYXV0b3NjYWxlIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5iYXJzLmhvcml6b250YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBmb3JtYXRbZm9ybWF0Lmxlbmd0aCAtIDFdLnk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRbZm9ybWF0Lmxlbmd0aCAtIDFdLnggPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzLmRhdGFwb2ludHMuZm9ybWF0ID0gZm9ybWF0OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzLmRhdGFwb2ludHMucG9pbnRzaXplICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7IC8vIGFscmVhZHkgZmlsbGVkIGluCgogICAgICAgICAgICAgICAgcy5kYXRhcG9pbnRzLnBvaW50c2l6ZSA9IGZvcm1hdC5sZW5ndGg7CgogICAgICAgICAgICAgICAgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgICAgICAgICAgcG9pbnRzID0gcy5kYXRhcG9pbnRzLnBvaW50czsKCiAgICAgICAgICAgICAgICB2YXIgaW5zZXJ0U3RlcHMgPSBzLmxpbmVzLnNob3cgJiYgcy5saW5lcy5zdGVwczsKICAgICAgICAgICAgICAgIHMueGF4aXMudXNlZCA9IHMueWF4aXMudXNlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgZm9yIChqID0gayA9IDA7IGogPCBkYXRhLmxlbmd0aDsgKytqLCBrICs9IHBzKSB7CiAgICAgICAgICAgICAgICAgICAgcCA9IGRhdGFbal07CgogICAgICAgICAgICAgICAgICAgIHZhciBudWxsaWZ5ID0gcCA9PSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmICghbnVsbGlmeSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gcFttXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYgPSBmb3JtYXRbbV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZi5udW1iZXIgJiYgdmFsICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gK3ZhbDsgLy8gY29udmVydCB0byBudW1iZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKHZhbCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh2YWwgPT0gSW5maW5pdHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBmYWtlSW5maW5pdHk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZhbCA9PSAtSW5maW5pdHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAtZmFrZUluZmluaXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmLnJlcXVpcmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbGlmeSA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZi5kZWZhdWx0VmFsdWUgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGYuZGVmYXVsdFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludHNbayArIG1dID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbGlmeSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG0gPSAwOyBtIDwgcHM7ICsrbSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gcG9pbnRzW2sgKyBtXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYgPSBmb3JtYXRbbV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXh0cmFjdCBtaW4vbWF4IGluZm8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZi5hdXRvc2NhbGUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmLngpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUF4aXMocy54YXhpcywgdmFsLCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmLnkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUF4aXMocy55YXhpcywgdmFsLCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzW2sgKyBtXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGEgbGl0dGxlIGJpdCBvZiBsaW5lIHNwZWNpZmljIHN0dWZmIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGVyaGFwcyBzaG91bGRuJ3QgYmUgaGVyZSwgYnV0IGxhY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmV0dGVyIG1lYW5zLi4uCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnNlcnRTdGVwcyAmJiBrID4gMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgcG9pbnRzW2sgLSBwc10gIT0gbnVsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgcG9pbnRzW2sgLSBwc10gIT0gcG9pbnRzW2tdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiBwb2ludHNbayAtIHBzICsgMV0gIT0gcG9pbnRzW2sgKyAxXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29weSB0aGUgcG9pbnQgdG8gbWFrZSByb29tIGZvciBhIG1pZGRsZSBwb2ludAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChtID0gMDsgbSA8IHBzOyArK20pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzW2sgKyBwcyArIG1dID0gcG9pbnRzW2sgKyBtXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtaWRkbGUgcG9pbnQgaGFzIHNhbWUgeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzW2sgKyAxXSA9IHBvaW50c1trIC0gcHMgKyAxXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSd2ZSBhZGRlZCBhIHBvaW50LCBiZXR0ZXIgcmVmbGVjdCB0aGF0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrICs9IHBzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBnaXZlIHRoZSBob29rcyBhIGNoYW5jZSB0byBydW4KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlcmllcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgcyA9IHNlcmllc1tpXTsKCiAgICAgICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MucHJvY2Vzc0RhdGFwb2ludHMsIFsgcywgcy5kYXRhcG9pbnRzXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNlY29uZCBwYXNzOiBmaW5kIGRhdGFtYXgvZGF0YW1pbiBmb3IgYXV0by1zY2FsaW5nCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHMgPSBzZXJpZXNbaV07CiAgICAgICAgICAgICAgICBwb2ludHMgPSBzLmRhdGFwb2ludHMucG9pbnRzOwogICAgICAgICAgICAgICAgcHMgPSBzLmRhdGFwb2ludHMucG9pbnRzaXplOwogICAgICAgICAgICAgICAgZm9ybWF0ID0gcy5kYXRhcG9pbnRzLmZvcm1hdDsKCiAgICAgICAgICAgICAgICB2YXIgeG1pbiA9IHRvcFNlbnRyeSwgeW1pbiA9IHRvcFNlbnRyeSwKICAgICAgICAgICAgICAgICAgICB4bWF4ID0gYm90dG9tU2VudHJ5LCB5bWF4ID0gYm90dG9tU2VudHJ5OwoKICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBwb2ludHMubGVuZ3RoOyBqICs9IHBzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBvaW50c1tqXSA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChtID0gMDsgbSA8IHBzOyArK20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gcG9pbnRzW2ogKyBtXTsKICAgICAgICAgICAgICAgICAgICAgICAgZiA9IGZvcm1hdFttXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmIHx8IGYuYXV0b3NjYWxlID09PSBmYWxzZSB8fCB2YWwgPT0gZmFrZUluZmluaXR5IHx8IHZhbCA9PSAtZmFrZUluZmluaXR5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZi54KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsIDwgeG1pbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4bWluID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA+IHhtYXgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1heCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZi55KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsIDwgeW1pbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5bWluID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA+IHltYXgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW1heCA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAocy5iYXJzLnNob3cpIHsKICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgd2UgZ290IHJvb20gZm9yIHRoZSBiYXIgb24gdGhlIGRhbmNpbmcgZmxvb3IKICAgICAgICAgICAgICAgICAgICB2YXIgZGVsdGE7CgogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocy5iYXJzLmFsaWduKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImxlZnQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhID0gLXMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgPSAtcy5iYXJzLmJhcldpZHRoIC8gMjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChzLmJhcnMuaG9yaXpvbnRhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB5bWluICs9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB5bWF4ICs9IGRlbHRhICsgcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgeG1pbiArPSBkZWx0YTsKICAgICAgICAgICAgICAgICAgICAgICAgeG1heCArPSBkZWx0YSArIHMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdXBkYXRlQXhpcyhzLnhheGlzLCB4bWluLCB4bWF4KTsKICAgICAgICAgICAgICAgIHVwZGF0ZUF4aXMocy55YXhpcywgeW1pbiwgeW1heCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXhpcy5kYXRhbWluID09IHRvcFNlbnRyeSkKICAgICAgICAgICAgICAgICAgICBheGlzLmRhdGFtaW4gPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKGF4aXMuZGF0YW1heCA9PSBib3R0b21TZW50cnkpCiAgICAgICAgICAgICAgICAgICAgYXhpcy5kYXRhbWF4ID0gbnVsbDsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXR1cENhbnZhc2VzKCkgewoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoZSBwbGFjZWhvbGRlciBpcyBjbGVhciBvZiBldmVyeXRoaW5nIGV4Y2VwdCBjYW52YXNlcwogICAgICAgICAgICAvLyBmcm9tIGEgcHJldmlvdXMgcGxvdCBpbiB0aGlzIGNvbnRhaW5lciB0aGF0IHdlJ2xsIHRyeSB0byByZS11c2UuCgogICAgICAgICAgICBwbGFjZWhvbGRlci5jc3MoInBhZGRpbmciLCAwKSAvLyBwYWRkaW5nIG1lc3NlcyB1cCB0aGUgcG9zaXRpb25pbmcKICAgICAgICAgICAgICAgIC5jaGlsZHJlbigpLmZpbHRlcihmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhJCh0aGlzKS5oYXNDbGFzcygiZmxvdC1vdmVybGF5IikgJiYgISQodGhpcykuaGFzQ2xhc3MoJ2Zsb3QtYmFzZScpOwogICAgICAgICAgICAgICAgfSkucmVtb3ZlKCk7CgogICAgICAgICAgICBpZiAocGxhY2Vob2xkZXIuY3NzKCJwb3NpdGlvbiIpID09ICdzdGF0aWMnKQogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIuY3NzKCJwb3NpdGlvbiIsICJyZWxhdGl2ZSIpOyAvLyBmb3IgcG9zaXRpb25pbmcgbGFiZWxzIGFuZCBvdmVybGF5CgogICAgICAgICAgICBzdXJmYWNlID0gbmV3IENhbnZhcygiZmxvdC1iYXNlIiwgcGxhY2Vob2xkZXIpOwogICAgICAgICAgICBvdmVybGF5ID0gbmV3IENhbnZhcygiZmxvdC1vdmVybGF5IiwgcGxhY2Vob2xkZXIpOyAvLyBvdmVybGF5IGNhbnZhcyBmb3IgaW50ZXJhY3RpdmUgZmVhdHVyZXMKCiAgICAgICAgICAgIGN0eCA9IHN1cmZhY2UuY29udGV4dDsKICAgICAgICAgICAgb2N0eCA9IG92ZXJsYXkuY29udGV4dDsKCiAgICAgICAgICAgIC8vIGRlZmluZSB3aGljaCBlbGVtZW50IHdlJ3JlIGxpc3RlbmluZyBmb3IgZXZlbnRzIG9uCiAgICAgICAgICAgIGV2ZW50SG9sZGVyID0gJChvdmVybGF5LmVsZW1lbnQpLnVuYmluZCgpOwoKICAgICAgICAgICAgLy8gSWYgd2UncmUgcmUtdXNpbmcgYSBwbG90IG9iamVjdCwgc2h1dCBkb3duIHRoZSBvbGQgb25lCgogICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSBwbGFjZWhvbGRlci5kYXRhKCJwbG90Iik7CgogICAgICAgICAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nLnNodXRkb3duKCk7CiAgICAgICAgICAgICAgICBvdmVybGF5LmNsZWFyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNhdmUgaW4gY2FzZSB3ZSBnZXQgcmVwbG90dGVkCiAgICAgICAgICAgIHBsYWNlaG9sZGVyLmRhdGEoInBsb3QiLCBwbG90KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGJpbmRFdmVudHMoKSB7CiAgICAgICAgICAgIC8vIGJpbmQgZXZlbnRzCiAgICAgICAgICAgIGlmIChvcHRpb25zLmdyaWQuaG92ZXJhYmxlKSB7CiAgICAgICAgICAgICAgICBldmVudEhvbGRlci5tb3VzZW1vdmUob25Nb3VzZU1vdmUpOwoKICAgICAgICAgICAgICAgIC8vIFVzZSBiaW5kLCByYXRoZXIgdGhhbiAubW91c2VsZWF2ZSwgYmVjYXVzZSB3ZSBvZmZpY2lhbGx5CiAgICAgICAgICAgICAgICAvLyBzdGlsbCBzdXBwb3J0IGpRdWVyeSAxLjIuNiwgd2hpY2ggZG9lc24ndCBkZWZpbmUgYSBzaG9ydGN1dAogICAgICAgICAgICAgICAgLy8gZm9yIG1vdXNlZW50ZXIgb3IgbW91c2VsZWF2ZS4gIFRoaXMgd2FzIGEgYnVnL292ZXJzaWdodCB0aGF0CiAgICAgICAgICAgICAgICAvLyB3YXMgZml4ZWQgc29tZXdoZXJlIGFyb3VuZCAxLjMueC4gIFdlIGNhbiByZXR1cm4gdG8gdXNpbmcKICAgICAgICAgICAgICAgIC8vIC5tb3VzZWxlYXZlIHdoZW4gd2UgZHJvcCBzdXBwb3J0IGZvciAxLjIuNi4KCiAgICAgICAgICAgICAgICBldmVudEhvbGRlci5iaW5kKCJtb3VzZWxlYXZlIiwgb25Nb3VzZUxlYXZlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuZ3JpZC5jbGlja2FibGUpCiAgICAgICAgICAgICAgICBldmVudEhvbGRlci5jbGljayhvbkNsaWNrKTsKCiAgICAgICAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5iaW5kRXZlbnRzLCBbZXZlbnRIb2xkZXJdKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNodXRkb3duKCkgewogICAgICAgICAgICBpZiAocmVkcmF3VGltZW91dCkKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZWRyYXdUaW1lb3V0KTsKCiAgICAgICAgICAgIGV2ZW50SG9sZGVyLnVuYmluZCgibW91c2Vtb3ZlIiwgb25Nb3VzZU1vdmUpOwogICAgICAgICAgICBldmVudEhvbGRlci51bmJpbmQoIm1vdXNlbGVhdmUiLCBvbk1vdXNlTGVhdmUpOwogICAgICAgICAgICBldmVudEhvbGRlci51bmJpbmQoImNsaWNrIiwgb25DbGljayk7CgogICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3Muc2h1dGRvd24sIFtldmVudEhvbGRlcl0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0VHJhbnNmb3JtYXRpb25IZWxwZXJzKGF4aXMpIHsKICAgICAgICAgICAgLy8gc2V0IGhlbHBlciBmdW5jdGlvbnMgb24gdGhlIGF4aXMsIGFzc3VtZXMgcGxvdCBhcmVhCiAgICAgICAgICAgIC8vIGhhcyBiZWVuIGNvbXB1dGVkIGFscmVhZHkKCiAgICAgICAgICAgIGZ1bmN0aW9uIGlkZW50aXR5KHgpIHsgcmV0dXJuIHg7IH0KCiAgICAgICAgICAgIHZhciBzLCBtLCB0ID0gYXhpcy5vcHRpb25zLnRyYW5zZm9ybSB8fCBpZGVudGl0eSwKICAgICAgICAgICAgICAgIGl0ID0gYXhpcy5vcHRpb25zLmludmVyc2VUcmFuc2Zvcm07CgogICAgICAgICAgICAvLyBwcmVjb21wdXRlIGhvdyBtdWNoIHRoZSBheGlzIGlzIHNjYWxpbmcgYSBwb2ludAogICAgICAgICAgICAvLyBpbiBjYW52YXMgc3BhY2UKICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikgewogICAgICAgICAgICAgICAgcyA9IGF4aXMuc2NhbGUgPSBwbG90V2lkdGggLyBNYXRoLmFicyh0KGF4aXMubWF4KSAtIHQoYXhpcy5taW4pKTsKICAgICAgICAgICAgICAgIG0gPSBNYXRoLm1pbih0KGF4aXMubWF4KSwgdChheGlzLm1pbikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgcyA9IGF4aXMuc2NhbGUgPSBwbG90SGVpZ2h0IC8gTWF0aC5hYnModChheGlzLm1heCkgLSB0KGF4aXMubWluKSk7CiAgICAgICAgICAgICAgICBzID0gLXM7CiAgICAgICAgICAgICAgICBtID0gTWF0aC5tYXgodChheGlzLm1heCksIHQoYXhpcy5taW4pKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZGF0YSBwb2ludCB0byBjYW52YXMgY29vcmRpbmF0ZQogICAgICAgICAgICBpZiAodCA9PSBpZGVudGl0eSkgLy8gc2xpZ2h0IG9wdGltaXphdGlvbgogICAgICAgICAgICAgICAgYXhpcy5wMmMgPSBmdW5jdGlvbiAocCkgeyByZXR1cm4gKHAgLSBtKSAqIHM7IH07CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGF4aXMucDJjID0gZnVuY3Rpb24gKHApIHsgcmV0dXJuICh0KHApIC0gbSkgKiBzOyB9OwogICAgICAgICAgICAvLyBjYW52YXMgY29vcmRpbmF0ZSB0byBkYXRhIHBvaW50CiAgICAgICAgICAgIGlmICghaXQpCiAgICAgICAgICAgICAgICBheGlzLmMycCA9IGZ1bmN0aW9uIChjKSB7IHJldHVybiBtICsgYyAvIHM7IH07CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGF4aXMuYzJwID0gZnVuY3Rpb24gKGMpIHsgcmV0dXJuIGl0KG0gKyBjIC8gcyk7IH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBtZWFzdXJlVGlja0xhYmVscyhheGlzKSB7CgogICAgICAgICAgICB2YXIgb3B0cyA9IGF4aXMub3B0aW9ucywKICAgICAgICAgICAgICAgIHRpY2tzID0gYXhpcy50aWNrcyB8fCBbXSwKICAgICAgICAgICAgICAgIGxhYmVsV2lkdGggPSBvcHRzLmxhYmVsV2lkdGggfHwgMCwKICAgICAgICAgICAgICAgIGxhYmVsSGVpZ2h0ID0gb3B0cy5sYWJlbEhlaWdodCB8fCAwLAogICAgICAgICAgICAgICAgbWF4V2lkdGggPSBsYWJlbFdpZHRoIHx8IChheGlzLmRpcmVjdGlvbiA9PSAieCIgPyBNYXRoLmZsb29yKHN1cmZhY2Uud2lkdGggLyAodGlja3MubGVuZ3RoIHx8IDEpKSA6IG51bGwpLAogICAgICAgICAgICAgICAgbGVnYWN5U3R5bGVzID0gYXhpcy5kaXJlY3Rpb24gKyAiQXhpcyAiICsgYXhpcy5kaXJlY3Rpb24gKyBheGlzLm4gKyAiQXhpcyIsCiAgICAgICAgICAgICAgICBsYXllciA9ICJmbG90LSIgKyBheGlzLmRpcmVjdGlvbiArICItYXhpcyBmbG90LSIgKyBheGlzLmRpcmVjdGlvbiArIGF4aXMubiArICItYXhpcyAiICsgbGVnYWN5U3R5bGVzLAogICAgICAgICAgICAgICAgZm9udCA9IG9wdHMuZm9udCB8fCAiZmxvdC10aWNrLWxhYmVsIHRpY2tMYWJlbCI7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRpY2tzLmxlbmd0aDsgKytpKSB7CgogICAgICAgICAgICAgICAgdmFyIHQgPSB0aWNrc1tpXTsKCiAgICAgICAgICAgICAgICBpZiAoIXQubGFiZWwpCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgdmFyIGluZm8gPSBzdXJmYWNlLmdldFRleHRJbmZvKGxheWVyLCB0LmxhYmVsLCBmb250LCBudWxsLCBtYXhXaWR0aCk7CgogICAgICAgICAgICAgICAgbGFiZWxXaWR0aCA9IE1hdGgubWF4KGxhYmVsV2lkdGgsIGluZm8ud2lkdGgpOwogICAgICAgICAgICAgICAgbGFiZWxIZWlnaHQgPSBNYXRoLm1heChsYWJlbEhlaWdodCwgaW5mby5oZWlnaHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBheGlzLmxhYmVsV2lkdGggPSBvcHRzLmxhYmVsV2lkdGggfHwgbGFiZWxXaWR0aDsKICAgICAgICAgICAgYXhpcy5sYWJlbEhlaWdodCA9IG9wdHMubGFiZWxIZWlnaHQgfHwgbGFiZWxIZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhbGxvY2F0ZUF4aXNCb3hGaXJzdFBoYXNlKGF4aXMpIHsKICAgICAgICAgICAgLy8gZmluZCB0aGUgYm91bmRpbmcgYm94IG9mIHRoZSBheGlzIGJ5IGxvb2tpbmcgYXQgbGFiZWwKICAgICAgICAgICAgLy8gd2lkdGhzL2hlaWdodHMgYW5kIHRpY2tzLCBtYWtlIHJvb20gYnkgZGltaW5pc2hpbmcgdGhlCiAgICAgICAgICAgIC8vIHBsb3RPZmZzZXQ7IHRoaXMgZmlyc3QgcGhhc2Ugb25seSBsb29rcyBhdCBvbmUKICAgICAgICAgICAgLy8gZGltZW5zaW9uIHBlciBheGlzLCB0aGUgb3RoZXIgZGltZW5zaW9uIGRlcGVuZHMgb24gdGhlCiAgICAgICAgICAgIC8vIG90aGVyIGF4ZXMgc28gd2lsbCBoYXZlIHRvIHdhaXQKCiAgICAgICAgICAgIHZhciBsdyA9IGF4aXMubGFiZWxXaWR0aCwKICAgICAgICAgICAgICAgIGxoID0gYXhpcy5sYWJlbEhlaWdodCwKICAgICAgICAgICAgICAgIHBvcyA9IGF4aXMub3B0aW9ucy5wb3NpdGlvbiwKICAgICAgICAgICAgICAgIGlzWEF4aXMgPSBheGlzLmRpcmVjdGlvbiA9PT0gIngiLAogICAgICAgICAgICAgICAgdGlja0xlbmd0aCA9IGF4aXMub3B0aW9ucy50aWNrTGVuZ3RoLAogICAgICAgICAgICAgICAgYXhpc01hcmdpbiA9IG9wdGlvbnMuZ3JpZC5heGlzTWFyZ2luLAogICAgICAgICAgICAgICAgcGFkZGluZyA9IG9wdGlvbnMuZ3JpZC5sYWJlbE1hcmdpbiwKICAgICAgICAgICAgICAgIGlubmVybW9zdCA9IHRydWUsCiAgICAgICAgICAgICAgICBvdXRlcm1vc3QgPSB0cnVlLAogICAgICAgICAgICAgICAgZmlyc3QgPSB0cnVlLAogICAgICAgICAgICAgICAgZm91bmQgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIERldGVybWluZSB0aGUgYXhpcydzIHBvc2l0aW9uIGluIGl0cyBkaXJlY3Rpb24gYW5kIG9uIGl0cyBzaWRlCgogICAgICAgICAgICAkLmVhY2goaXNYQXhpcyA\/IHhheGVzIDogeWF4ZXMsIGZ1bmN0aW9uKGksIGEpIHsKICAgICAgICAgICAgICAgIGlmIChhICYmIChhLnNob3cgfHwgYS5yZXNlcnZlU3BhY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEgPT09IGF4aXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYS5vcHRpb25zLnBvc2l0aW9uID09PSBwb3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRlcm1vc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlubmVybW9zdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVGhlIG91dGVybW9zdCBheGlzIG9uIGVhY2ggc2lkZSBoYXMgbm8gbWFyZ2luCgogICAgICAgICAgICBpZiAob3V0ZXJtb3N0KSB7CiAgICAgICAgICAgICAgICBheGlzTWFyZ2luID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGhlIHRpY2tzIGZvciB0aGUgZmlyc3QgYXhpcyBpbiBlYWNoIGRpcmVjdGlvbiBzdHJldGNoIGFjcm9zcwoKICAgICAgICAgICAgaWYgKHRpY2tMZW5ndGggPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGlja0xlbmd0aCA9IGZpcnN0ID8gImZ1bGwiIDogNTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFpc05hTigrdGlja0xlbmd0aCkpCiAgICAgICAgICAgICAgICBwYWRkaW5nICs9ICt0aWNrTGVuZ3RoOwoKICAgICAgICAgICAgaWYgKGlzWEF4aXMpIHsKICAgICAgICAgICAgICAgIGxoICs9IHBhZGRpbmc7CgogICAgICAgICAgICAgICAgaWYgKHBvcyA9PSAiYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgIHBsb3RPZmZzZXQuYm90dG9tICs9IGxoICsgYXhpc01hcmdpbjsKICAgICAgICAgICAgICAgICAgICBheGlzLmJveCA9IHsgdG9wOiBzdXJmYWNlLmhlaWdodCAtIHBsb3RPZmZzZXQuYm90dG9tLCBoZWlnaHQ6IGxoIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBheGlzLmJveCA9IHsgdG9wOiBwbG90T2Zmc2V0LnRvcCArIGF4aXNNYXJnaW4sIGhlaWdodDogbGggfTsKICAgICAgICAgICAgICAgICAgICBwbG90T2Zmc2V0LnRvcCArPSBsaCArIGF4aXNNYXJnaW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBsdyArPSBwYWRkaW5nOwoKICAgICAgICAgICAgICAgIGlmIChwb3MgPT0gImxlZnQiKSB7CiAgICAgICAgICAgICAgICAgICAgYXhpcy5ib3ggPSB7IGxlZnQ6IHBsb3RPZmZzZXQubGVmdCArIGF4aXNNYXJnaW4sIHdpZHRoOiBsdyB9OwogICAgICAgICAgICAgICAgICAgIHBsb3RPZmZzZXQubGVmdCArPSBsdyArIGF4aXNNYXJnaW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwbG90T2Zmc2V0LnJpZ2h0ICs9IGx3ICsgYXhpc01hcmdpbjsKICAgICAgICAgICAgICAgICAgICBheGlzLmJveCA9IHsgbGVmdDogc3VyZmFjZS53aWR0aCAtIHBsb3RPZmZzZXQucmlnaHQsIHdpZHRoOiBsdyB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAgLy8gc2F2ZSBmb3IgZnV0dXJlIHJlZmVyZW5jZQogICAgICAgICAgICBheGlzLnBvc2l0aW9uID0gcG9zOwogICAgICAgICAgICBheGlzLnRpY2tMZW5ndGggPSB0aWNrTGVuZ3RoOwogICAgICAgICAgICBheGlzLmJveC5wYWRkaW5nID0gcGFkZGluZzsKICAgICAgICAgICAgYXhpcy5pbm5lcm1vc3QgPSBpbm5lcm1vc3Q7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhbGxvY2F0ZUF4aXNCb3hTZWNvbmRQaGFzZShheGlzKSB7CiAgICAgICAgICAgIC8vIG5vdyB0aGF0IGFsbCBheGlzIGJveGVzIGhhdmUgYmVlbiBwbGFjZWQgaW4gb25lCiAgICAgICAgICAgIC8vIGRpbWVuc2lvbiwgd2UgY2FuIHNldCB0aGUgcmVtYWluaW5nIGRpbWVuc2lvbiBjb29yZGluYXRlcwogICAgICAgICAgICBpZiAoYXhpcy5kaXJlY3Rpb24gPT0gIngiKSB7CiAgICAgICAgICAgICAgICBheGlzLmJveC5sZWZ0ID0gcGxvdE9mZnNldC5sZWZ0IC0gYXhpcy5sYWJlbFdpZHRoIC8gMjsKICAgICAgICAgICAgICAgIGF4aXMuYm94LndpZHRoID0gc3VyZmFjZS53aWR0aCAtIHBsb3RPZmZzZXQubGVmdCAtIHBsb3RPZmZzZXQucmlnaHQgKyBheGlzLmxhYmVsV2lkdGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBheGlzLmJveC50b3AgPSBwbG90T2Zmc2V0LnRvcCAtIGF4aXMubGFiZWxIZWlnaHQgLyAyOwogICAgICAgICAgICAgICAgYXhpcy5ib3guaGVpZ2h0ID0gc3VyZmFjZS5oZWlnaHQgLSBwbG90T2Zmc2V0LmJvdHRvbSAtIHBsb3RPZmZzZXQudG9wICsgYXhpcy5sYWJlbEhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRqdXN0TGF5b3V0Rm9yVGhpbmdzU3RpY2tpbmdPdXQoKSB7CiAgICAgICAgICAgIC8vIHBvc3NpYmx5IGFkanVzdCBwbG90IG9mZnNldCB0byBlbnN1cmUgZXZlcnl0aGluZyBzdGF5cwogICAgICAgICAgICAvLyBpbnNpZGUgdGhlIGNhbnZhcyBhbmQgaXNuJ3QgY2xpcHBlZCBvZmYKCiAgICAgICAgICAgIHZhciBtaW5NYXJnaW4gPSBvcHRpb25zLmdyaWQubWluQm9yZGVyTWFyZ2luLAogICAgICAgICAgICAgICAgYXhpcywgaTsKCiAgICAgICAgICAgIC8vIGNoZWNrIHN0dWZmIGZyb20gdGhlIHBsb3QgKEZJWE1FOiB0aGlzIHNob3VsZCBqdXN0IHJlYWQKICAgICAgICAgICAgLy8gYSB2YWx1ZSBmcm9tIHRoZSBzZXJpZXMsIG90aGVyd2lzZSBpdCdzIGltcG9zc2libGUgdG8KICAgICAgICAgICAgLy8gY3VzdG9taXplKQogICAgICAgICAgICBpZiAobWluTWFyZ2luID09IG51bGwpIHsKICAgICAgICAgICAgICAgIG1pbk1hcmdpbiA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKQogICAgICAgICAgICAgICAgICAgIG1pbk1hcmdpbiA9IE1hdGgubWF4KG1pbk1hcmdpbiwgMiAqIChzZXJpZXNbaV0ucG9pbnRzLnJhZGl1cyArIHNlcmllc1tpXS5wb2ludHMubGluZVdpZHRoLzIpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG1hcmdpbnMgPSB7CiAgICAgICAgICAgICAgICBsZWZ0OiBtaW5NYXJnaW4sCiAgICAgICAgICAgICAgICByaWdodDogbWluTWFyZ2luLAogICAgICAgICAgICAgICAgdG9wOiBtaW5NYXJnaW4sCiAgICAgICAgICAgICAgICBib3R0b206IG1pbk1hcmdpbgogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gY2hlY2sgYXhpcyBsYWJlbHMsIG5vdGUgd2UgZG9uJ3QgY2hlY2sgdGhlIGFjdHVhbAogICAgICAgICAgICAvLyBsYWJlbHMgYnV0IGluc3RlYWQgdXNlIHRoZSBvdmVyYWxsIHdpZHRoL2hlaWdodCB0byBub3QKICAgICAgICAgICAgLy8ganVtcCBhcyBtdWNoIGFyb3VuZCB3aXRoIHJlcGxvdHMKICAgICAgICAgICAgJC5lYWNoKGFsbEF4ZXMoKSwgZnVuY3Rpb24gKF8sIGF4aXMpIHsKICAgICAgICAgICAgICAgIGlmIChheGlzLnJlc2VydmVTcGFjZSAmJiBheGlzLnRpY2tzICYmIGF4aXMudGlja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09PSAieCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2lucy5sZWZ0ID0gTWF0aC5tYXgobWFyZ2lucy5sZWZ0LCBheGlzLmxhYmVsV2lkdGggLyAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2lucy5yaWdodCA9IE1hdGgubWF4KG1hcmdpbnMucmlnaHQsIGF4aXMubGFiZWxXaWR0aCAvIDIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbnMuYm90dG9tID0gTWF0aC5tYXgobWFyZ2lucy5ib3R0b20sIGF4aXMubGFiZWxIZWlnaHQgLyAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2lucy50b3AgPSBNYXRoLm1heChtYXJnaW5zLnRvcCwgYXhpcy5sYWJlbEhlaWdodCAvIDIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBwbG90T2Zmc2V0LmxlZnQgPSBNYXRoLmNlaWwoTWF0aC5tYXgobWFyZ2lucy5sZWZ0LCBwbG90T2Zmc2V0LmxlZnQpKTsKICAgICAgICAgICAgcGxvdE9mZnNldC5yaWdodCA9IE1hdGguY2VpbChNYXRoLm1heChtYXJnaW5zLnJpZ2h0LCBwbG90T2Zmc2V0LnJpZ2h0KSk7CiAgICAgICAgICAgIHBsb3RPZmZzZXQudG9wID0gTWF0aC5jZWlsKE1hdGgubWF4KG1hcmdpbnMudG9wLCBwbG90T2Zmc2V0LnRvcCkpOwogICAgICAgICAgICBwbG90T2Zmc2V0LmJvdHRvbSA9IE1hdGguY2VpbChNYXRoLm1heChtYXJnaW5zLmJvdHRvbSwgcGxvdE9mZnNldC5ib3R0b20pKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldHVwR3JpZCgpIHsKICAgICAgICAgICAgdmFyIGksIGF4ZXMgPSBhbGxBeGVzKCksIHNob3dHcmlkID0gb3B0aW9ucy5ncmlkLnNob3c7CgogICAgICAgICAgICAvLyBJbml0aWFsaXplIHRoZSBwbG90J3Mgb2Zmc2V0IGZyb20gdGhlIGVkZ2Ugb2YgdGhlIGNhbnZhcwoKICAgICAgICAgICAgZm9yICh2YXIgYSBpbiBwbG90T2Zmc2V0KSB7CiAgICAgICAgICAgICAgICB2YXIgbWFyZ2luID0gb3B0aW9ucy5ncmlkLm1hcmdpbiB8fCAwOwogICAgICAgICAgICAgICAgcGxvdE9mZnNldFthXSA9IHR5cGVvZiBtYXJnaW4gPT0gIm51bWJlciIgPyBtYXJnaW4gOiBtYXJnaW5bYV0gfHwgMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLnByb2Nlc3NPZmZzZXQsIFtwbG90T2Zmc2V0XSk7CgogICAgICAgICAgICAvLyBJZiB0aGUgZ3JpZCBpcyB2aXNpYmxlLCBhZGQgaXRzIGJvcmRlciB3aWR0aCB0byB0aGUgb2Zmc2V0CgogICAgICAgICAgICBmb3IgKHZhciBhIGluIHBsb3RPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZihvcHRpb25zLmdyaWQuYm9yZGVyV2lkdGgpID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgcGxvdE9mZnNldFthXSArPSBzaG93R3JpZCA\/IG9wdGlvbnMuZ3JpZC5ib3JkZXJXaWR0aFthXSA6IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwbG90T2Zmc2V0W2FdICs9IHNob3dHcmlkID8gb3B0aW9ucy5ncmlkLmJvcmRlcldpZHRoIDogMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5lYWNoKGF4ZXMsIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgICAgICAgICB2YXIgYXhpc09wdHMgPSBheGlzLm9wdGlvbnM7CiAgICAgICAgICAgICAgICBheGlzLnNob3cgPSBheGlzT3B0cy5zaG93ID09IG51bGwgPyBheGlzLnVzZWQgOiBheGlzT3B0cy5zaG93OwogICAgICAgICAgICAgICAgYXhpcy5yZXNlcnZlU3BhY2UgPSBheGlzT3B0cy5yZXNlcnZlU3BhY2UgPT0gbnVsbCA\/IGF4aXMuc2hvdyA6IGF4aXNPcHRzLnJlc2VydmVTcGFjZTsKICAgICAgICAgICAgICAgIHNldFJhbmdlKGF4aXMpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChzaG93R3JpZCkgewoKICAgICAgICAgICAgICAgIHZhciBhbGxvY2F0ZWRBeGVzID0gJC5ncmVwKGF4ZXMsIGZ1bmN0aW9uIChheGlzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF4aXMuc2hvdyB8fCBheGlzLnJlc2VydmVTcGFjZTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICQuZWFjaChhbGxvY2F0ZWRBeGVzLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgICAgICAgICAgICAgIC8vIG1ha2UgdGhlIHRpY2tzCiAgICAgICAgICAgICAgICAgICAgc2V0dXBUaWNrR2VuZXJhdGlvbihheGlzKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaWNrcyhheGlzKTsKICAgICAgICAgICAgICAgICAgICBzbmFwUmFuZ2VUb1RpY2tzKGF4aXMsIGF4aXMudGlja3MpOwogICAgICAgICAgICAgICAgICAgIC8vIGZpbmQgbGFiZWxXaWR0aC9IZWlnaHQgZm9yIGF4aXMKICAgICAgICAgICAgICAgICAgICBtZWFzdXJlVGlja0xhYmVscyhheGlzKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIHdpdGggYWxsIGRpbWVuc2lvbnMgY2FsY3VsYXRlZCwgd2UgY2FuIGNvbXB1dGUgdGhlCiAgICAgICAgICAgICAgICAvLyBheGlzIGJvdW5kaW5nIGJveGVzLCBzdGFydCBmcm9tIHRoZSBvdXRzaWRlCiAgICAgICAgICAgICAgICAvLyAocmV2ZXJzZSBvcmRlcikKICAgICAgICAgICAgICAgIGZvciAoaSA9IGFsbG9jYXRlZEF4ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpCiAgICAgICAgICAgICAgICAgICAgYWxsb2NhdGVBeGlzQm94Rmlyc3RQaGFzZShhbGxvY2F0ZWRBeGVzW2ldKTsKCiAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgd2UndmUgZ290IGVub3VnaCBzcGFjZSBmb3IgdGhpbmdzIHRoYXQKICAgICAgICAgICAgICAgIC8vIG1pZ2h0IHN0aWNrIG91dAogICAgICAgICAgICAgICAgYWRqdXN0TGF5b3V0Rm9yVGhpbmdzU3RpY2tpbmdPdXQoKTsKCiAgICAgICAgICAgICAgICAkLmVhY2goYWxsb2NhdGVkQXhlcywgZnVuY3Rpb24gKF8sIGF4aXMpIHsKICAgICAgICAgICAgICAgICAgICBhbGxvY2F0ZUF4aXNCb3hTZWNvbmRQaGFzZShheGlzKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwbG90V2lkdGggPSBzdXJmYWNlLndpZHRoIC0gcGxvdE9mZnNldC5sZWZ0IC0gcGxvdE9mZnNldC5yaWdodDsKICAgICAgICAgICAgcGxvdEhlaWdodCA9IHN1cmZhY2UuaGVpZ2h0IC0gcGxvdE9mZnNldC5ib3R0b20gLSBwbG90T2Zmc2V0LnRvcDsKCiAgICAgICAgICAgIC8vIG5vdyB3ZSBnb3QgdGhlIHByb3BlciBwbG90IGRpbWVuc2lvbnMsIHdlIGNhbiBjb21wdXRlIHRoZSBzY2FsaW5nCiAgICAgICAgICAgICQuZWFjaChheGVzLCBmdW5jdGlvbiAoXywgYXhpcykgewogICAgICAgICAgICAgICAgc2V0VHJhbnNmb3JtYXRpb25IZWxwZXJzKGF4aXMpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChzaG93R3JpZCkgewogICAgICAgICAgICAgICAgZHJhd0F4aXNMYWJlbHMoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW5zZXJ0TGVnZW5kKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXRSYW5nZShheGlzKSB7CiAgICAgICAgICAgIHZhciBvcHRzID0gYXhpcy5vcHRpb25zLAogICAgICAgICAgICAgICAgbWluID0gKyhvcHRzLm1pbiAhPSBudWxsID8gb3B0cy5taW4gOiBheGlzLmRhdGFtaW4pLAogICAgICAgICAgICAgICAgbWF4ID0gKyhvcHRzLm1heCAhPSBudWxsID8gb3B0cy5tYXggOiBheGlzLmRhdGFtYXgpLAogICAgICAgICAgICAgICAgZGVsdGEgPSBtYXggLSBtaW47CgogICAgICAgICAgICBpZiAoZGVsdGEgPT0gMC4wKSB7CiAgICAgICAgICAgICAgICAvLyBkZWdlbmVyYXRlIGNhc2UKICAgICAgICAgICAgICAgIHZhciB3aWRlbiA9IG1heCA9PSAwID8gMSA6IDAuMDE7CgogICAgICAgICAgICAgICAgaWYgKG9wdHMubWluID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgbWluIC09IHdpZGVuOwogICAgICAgICAgICAgICAgLy8gYWx3YXlzIHdpZGVuIG1heCBpZiB3ZSBjb3VsZG4ndCB3aWRlbiBtaW4gdG8gZW5zdXJlIHdlCiAgICAgICAgICAgICAgICAvLyBkb24ndCBmYWxsIGludG8gbWluID09IG1heCB3aGljaCBkb2Vzbid0IHdvcmsKICAgICAgICAgICAgICAgIGlmIChvcHRzLm1heCA9PSBudWxsIHx8IG9wdHMubWluICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgbWF4ICs9IHdpZGVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgLy8gY29uc2lkZXIgYXV0b3NjYWxpbmcKICAgICAgICAgICAgICAgIHZhciBtYXJnaW4gPSBvcHRzLmF1dG9zY2FsZU1hcmdpbjsKICAgICAgICAgICAgICAgIGlmIChtYXJnaW4gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvcHRzLm1pbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbiAtPSBkZWx0YSAqIG1hcmdpbjsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGRvbid0IGdvIGJlbG93IHplcm8gaWYgYWxsIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgICAvLyBhcmUgcG9zaXRpdmUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pbiA8IDAgJiYgYXhpcy5kYXRhbWluICE9IG51bGwgJiYgYXhpcy5kYXRhbWluID49IDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW4gPSAwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5tYXggPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXggKz0gZGVsdGEgKiBtYXJnaW47CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXggPiAwICYmIGF4aXMuZGF0YW1heCAhPSBudWxsICYmIGF4aXMuZGF0YW1heCA8PSAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXhpcy5taW4gPSBtaW47CiAgICAgICAgICAgIGF4aXMubWF4ID0gbWF4OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0dXBUaWNrR2VuZXJhdGlvbihheGlzKSB7CiAgICAgICAgICAgIHZhciBvcHRzID0gYXhpcy5vcHRpb25zOwoKICAgICAgICAgICAgLy8gZXN0aW1hdGUgbnVtYmVyIG9mIHRpY2tzCiAgICAgICAgICAgIHZhciBub1RpY2tzOwogICAgICAgICAgICBpZiAodHlwZW9mIG9wdHMudGlja3MgPT0gIm51bWJlciIgJiYgb3B0cy50aWNrcyA+IDApCiAgICAgICAgICAgICAgICBub1RpY2tzID0gb3B0cy50aWNrczsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgLy8gaGV1cmlzdGljIGJhc2VkIG9uIHRoZSBtb2RlbCBhKnNxcnQoeCkgZml0dGVkIHRvCiAgICAgICAgICAgICAgICAvLyBzb21lIGRhdGEgcG9pbnRzIHRoYXQgc2VlbWVkIHJlYXNvbmFibGUKICAgICAgICAgICAgICAgIG5vVGlja3MgPSAwLjMgKiBNYXRoLnNxcnQoYXhpcy5kaXJlY3Rpb24gPT0gIngiID8gc3VyZmFjZS53aWR0aCA6IHN1cmZhY2UuaGVpZ2h0KTsKCiAgICAgICAgICAgIHZhciBkZWx0YSA9IChheGlzLm1heCAtIGF4aXMubWluKSAvIG5vVGlja3MsCiAgICAgICAgICAgICAgICBkZWMgPSAtTWF0aC5mbG9vcihNYXRoLmxvZyhkZWx0YSkgLyBNYXRoLkxOMTApLAogICAgICAgICAgICAgICAgbWF4RGVjID0gb3B0cy50aWNrRGVjaW1hbHM7CgogICAgICAgICAgICBpZiAobWF4RGVjICE9IG51bGwgJiYgZGVjID4gbWF4RGVjKSB7CiAgICAgICAgICAgICAgICBkZWMgPSBtYXhEZWM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtYWduID0gTWF0aC5wb3coMTAsIC1kZWMpLAogICAgICAgICAgICAgICAgbm9ybSA9IGRlbHRhIC8gbWFnbiwgLy8gbm9ybSBpcyBiZXR3ZWVuIDEuMCBhbmQgMTAuMAogICAgICAgICAgICAgICAgc2l6ZTsKCiAgICAgICAgICAgIGlmIChub3JtIDwgMS41KSB7CiAgICAgICAgICAgICAgICBzaXplID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChub3JtIDwgMykgewogICAgICAgICAgICAgICAgc2l6ZSA9IDI7CiAgICAgICAgICAgICAgICAvLyBzcGVjaWFsIGNhc2UgZm9yIDIuNSwgcmVxdWlyZXMgYW4gZXh0cmEgZGVjaW1hbAogICAgICAgICAgICAgICAgaWYgKG5vcm0gPiAyLjI1ICYmIChtYXhEZWMgPT0gbnVsbCB8fCBkZWMgKyAxIDw9IG1heERlYykpIHsKICAgICAgICAgICAgICAgICAgICBzaXplID0gMi41OwogICAgICAgICAgICAgICAgICAgICsrZGVjOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vcm0gPCA3LjUpIHsKICAgICAgICAgICAgICAgIHNpemUgPSA1OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2l6ZSA9IDEwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzaXplICo9IG1hZ247CgogICAgICAgICAgICBpZiAob3B0cy5taW5UaWNrU2l6ZSAhPSBudWxsICYmIHNpemUgPCBvcHRzLm1pblRpY2tTaXplKSB7CiAgICAgICAgICAgICAgICBzaXplID0gb3B0cy5taW5UaWNrU2l6ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXhpcy5kZWx0YSA9IGRlbHRhOwogICAgICAgICAgICBheGlzLnRpY2tEZWNpbWFscyA9IE1hdGgubWF4KDAsIG1heERlYyAhPSBudWxsID8gbWF4RGVjIDogZGVjKTsKICAgICAgICAgICAgYXhpcy50aWNrU2l6ZSA9IG9wdHMudGlja1NpemUgfHwgc2l6ZTsKCiAgICAgICAgICAgIC8vIFRpbWUgbW9kZSB3YXMgbW92ZWQgdG8gYSBwbHVnLWluIGluIDAuOCwgYW5kIHNpbmNlIHNvIG1hbnkgcGVvcGxlIHVzZSBpdAogICAgICAgICAgICAvLyB3ZSdsbCBhZGQgYW4gZXNwZWNpYWxseSBmcmllbmRseSByZW1pbmRlciB0byBtYWtlIHN1cmUgdGhleSBpbmNsdWRlZCBpdC4KCiAgICAgICAgICAgIGlmIChvcHRzLm1vZGUgPT0gInRpbWUiICYmICFheGlzLnRpY2tHZW5lcmF0b3IpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGltZSBtb2RlIHJlcXVpcmVzIHRoZSBmbG90LnRpbWUgcGx1Z2luLiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBGbG90IHN1cHBvcnRzIGJhc2UtMTAgYXhlczsgYW55IG90aGVyIG1vZGUgZWxzZSBpcyBoYW5kbGVkIGJ5IGEgcGx1Zy1pbiwKICAgICAgICAgICAgLy8gbGlrZSBmbG90LnRpbWUuanMuCgogICAgICAgICAgICBpZiAoIWF4aXMudGlja0dlbmVyYXRvcikgewoKICAgICAgICAgICAgICAgIGF4aXMudGlja0dlbmVyYXRvciA9IGZ1bmN0aW9uIChheGlzKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciB0aWNrcyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGZsb29ySW5CYXNlKGF4aXMubWluLCBheGlzLnRpY2tTaXplKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBOdW1iZXIuTmFOLAogICAgICAgICAgICAgICAgICAgICAgICBwcmV2OwoKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXYgPSB2OwogICAgICAgICAgICAgICAgICAgICAgICB2ID0gc3RhcnQgKyBpICogYXhpcy50aWNrU2l6ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGlja3MucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgKytpOwogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHYgPCBheGlzLm1heCAmJiB2ICE9IHByZXYpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aWNrczsKICAgICAgICAgICAgICAgIH07CgoJCQkJYXhpcy50aWNrRm9ybWF0dGVyID0gZnVuY3Rpb24gKHZhbHVlLCBheGlzKSB7CgoJCQkJCXZhciBmYWN0b3IgPSBheGlzLnRpY2tEZWNpbWFscyA\/IE1hdGgucG93KDEwLCBheGlzLnRpY2tEZWNpbWFscykgOiAxOwoJCQkJCXZhciBmb3JtYXR0ZWQgPSAiIiArIE1hdGgucm91bmQodmFsdWUgKiBmYWN0b3IpIC8gZmFjdG9yOwoKCQkJCQkvLyBJZiB0aWNrRGVjaW1hbHMgd2FzIHNwZWNpZmllZCwgZW5zdXJlIHRoYXQgd2UgaGF2ZSBleGFjdGx5IHRoYXQKCQkJCQkvLyBtdWNoIHByZWNpc2lvbjsgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gdGhlIHZhbHVlJ3Mgb3duIHByZWNpc2lvbi4KCgkJCQkJaWYgKGF4aXMudGlja0RlY2ltYWxzICE9IG51bGwpIHsKCQkJCQkJdmFyIGRlY2ltYWwgPSBmb3JtYXR0ZWQuaW5kZXhPZigiLiIpOwoJCQkJCQl2YXIgcHJlY2lzaW9uID0gZGVjaW1hbCA9PSAtMSA\/IDAgOiBmb3JtYXR0ZWQubGVuZ3RoIC0gZGVjaW1hbCAtIDE7CgkJCQkJCWlmIChwcmVjaXNpb24gPCBheGlzLnRpY2tEZWNpbWFscykgewoJCQkJCQkJcmV0dXJuIChwcmVjaXNpb24gPyBmb3JtYXR0ZWQgOiBmb3JtYXR0ZWQgKyAiLiIpICsgKCIiICsgZmFjdG9yKS5zdWJzdHIoMSwgYXhpcy50aWNrRGVjaW1hbHMgLSBwcmVjaXNpb24pOwoJCQkJCQl9CgkJCQkJfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm9ybWF0dGVkOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihvcHRzLnRpY2tGb3JtYXR0ZXIpKQogICAgICAgICAgICAgICAgYXhpcy50aWNrRm9ybWF0dGVyID0gZnVuY3Rpb24gKHYsIGF4aXMpIHsgcmV0dXJuICIiICsgb3B0cy50aWNrRm9ybWF0dGVyKHYsIGF4aXMpOyB9OwoKICAgICAgICAgICAgaWYgKG9wdHMuYWxpZ25UaWNrc1dpdGhBeGlzICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvdGhlckF4aXMgPSAoYXhpcy5kaXJlY3Rpb24gPT0gIngiID8geGF4ZXMgOiB5YXhlcylbb3B0cy5hbGlnblRpY2tzV2l0aEF4aXMgLSAxXTsKICAgICAgICAgICAgICAgIGlmIChvdGhlckF4aXMgJiYgb3RoZXJBeGlzLnVzZWQgJiYgb3RoZXJBeGlzICE9IGF4aXMpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjb25zaWRlciBzbmFwcGluZyBtaW4vbWF4IHRvIG91dGVybW9zdCBuaWNlIHRpY2tzCiAgICAgICAgICAgICAgICAgICAgdmFyIG5pY2VUaWNrcyA9IGF4aXMudGlja0dlbmVyYXRvcihheGlzKTsKICAgICAgICAgICAgICAgICAgICBpZiAobmljZVRpY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMubWluID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBheGlzLm1pbiA9IE1hdGgubWluKGF4aXMubWluLCBuaWNlVGlja3NbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5tYXggPT0gbnVsbCAmJiBuaWNlVGlja3MubGVuZ3RoID4gMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF4aXMubWF4ID0gTWF0aC5tYXgoYXhpcy5tYXgsIG5pY2VUaWNrc1tuaWNlVGlja3MubGVuZ3RoIC0gMV0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYXhpcy50aWNrR2VuZXJhdG9yID0gZnVuY3Rpb24gKGF4aXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29weSB0aWNrcywgc2NhbGVkIHRvIHRoaXMgYXhpcwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGlja3MgPSBbXSwgdiwgaTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG90aGVyQXhpcy50aWNrcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IChvdGhlckF4aXMudGlja3NbaV0udiAtIG90aGVyQXhpcy5taW4pIC8gKG90aGVyQXhpcy5tYXggLSBvdGhlckF4aXMubWluKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBheGlzLm1pbiArIHYgKiAoYXhpcy5tYXggLSBheGlzLm1pbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aWNrcy5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aWNrczsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBtaWdodCBuZWVkIGFuIGV4dHJhIGRlY2ltYWwgc2luY2UgZm9yY2VkCiAgICAgICAgICAgICAgICAgICAgLy8gdGlja3MgZG9uJ3QgbmVjZXNzYXJpbHkgZml0IG5hdHVyYWxseQogICAgICAgICAgICAgICAgICAgIGlmICghYXhpcy5tb2RlICYmIG9wdHMudGlja0RlY2ltYWxzID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV4dHJhRGVjID0gTWF0aC5tYXgoMCwgLU1hdGguZmxvb3IoTWF0aC5sb2coYXhpcy5kZWx0YSkgLyBNYXRoLkxOMTApICsgMSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cyA9IGF4aXMudGlja0dlbmVyYXRvcihheGlzKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9ubHkgcHJvY2VlZCBpZiB0aGUgdGljayBpbnRlcnZhbCByb3VuZGVkCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpdGggYW4gZXh0cmEgZGVjaW1hbCBkb2Vzbid0IGdpdmUgdXMgYQogICAgICAgICAgICAgICAgICAgICAgICAvLyB6ZXJvIGF0IGVuZAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISh0cy5sZW5ndGggPiAxICYmIC9cLi4qMCQvLnRlc3QoKHRzWzFdIC0gdHNbMF0pLnRvRml4ZWQoZXh0cmFEZWMpKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBheGlzLnRpY2tEZWNpbWFscyA9IGV4dHJhRGVjOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2V0VGlja3MoYXhpcykgewogICAgICAgICAgICB2YXIgb3RpY2tzID0gYXhpcy5vcHRpb25zLnRpY2tzLCB0aWNrcyA9IFtdOwogICAgICAgICAgICBpZiAob3RpY2tzID09IG51bGwgfHwgKHR5cGVvZiBvdGlja3MgPT0gIm51bWJlciIgJiYgb3RpY2tzID4gMCkpCiAgICAgICAgICAgICAgICB0aWNrcyA9IGF4aXMudGlja0dlbmVyYXRvcihheGlzKTsKICAgICAgICAgICAgZWxzZSBpZiAob3RpY2tzKSB7CiAgICAgICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKG90aWNrcykpCiAgICAgICAgICAgICAgICAgICAgLy8gZ2VuZXJhdGUgdGhlIHRpY2tzCiAgICAgICAgICAgICAgICAgICAgdGlja3MgPSBvdGlja3MoYXhpcyk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgdGlja3MgPSBvdGlja3M7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNsZWFuIHVwL2xhYmVsaWZ5IHRoZSBzdXBwbGllZCB0aWNrcywgY29weSB0aGVtIG92ZXIKICAgICAgICAgICAgdmFyIGksIHY7CiAgICAgICAgICAgIGF4aXMudGlja3MgPSBbXTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRpY2tzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHQgPSB0aWNrc1tpXTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdCA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHYgPSArdFswXTsKICAgICAgICAgICAgICAgICAgICBpZiAodC5sZW5ndGggPiAxKQogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IHRbMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgdiA9ICt0OwogICAgICAgICAgICAgICAgaWYgKGxhYmVsID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBheGlzLnRpY2tGb3JtYXR0ZXIodiwgYXhpcyk7CiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKHYpKQogICAgICAgICAgICAgICAgICAgIGF4aXMudGlja3MucHVzaCh7IHY6IHYsIGxhYmVsOiBsYWJlbCB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc25hcFJhbmdlVG9UaWNrcyhheGlzLCB0aWNrcykgewogICAgICAgICAgICBpZiAoYXhpcy5vcHRpb25zLmF1dG9zY2FsZU1hcmdpbiAmJiB0aWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAvLyBzbmFwIHRvIHRpY2tzCiAgICAgICAgICAgICAgICBpZiAoYXhpcy5vcHRpb25zLm1pbiA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgIGF4aXMubWluID0gTWF0aC5taW4oYXhpcy5taW4sIHRpY2tzWzBdLnYpOwogICAgICAgICAgICAgICAgaWYgKGF4aXMub3B0aW9ucy5tYXggPT0gbnVsbCAmJiB0aWNrcy5sZW5ndGggPiAxKQogICAgICAgICAgICAgICAgICAgIGF4aXMubWF4ID0gTWF0aC5tYXgoYXhpcy5tYXgsIHRpY2tzW3RpY2tzLmxlbmd0aCAtIDFdLnYpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3KCkgewoKICAgICAgICAgICAgc3VyZmFjZS5jbGVhcigpOwoKICAgICAgICAgICAgZXhlY3V0ZUhvb2tzKGhvb2tzLmRyYXdCYWNrZ3JvdW5kLCBbY3R4XSk7CgogICAgICAgICAgICB2YXIgZ3JpZCA9IG9wdGlvbnMuZ3JpZDsKCiAgICAgICAgICAgIC8vIGRyYXcgYmFja2dyb3VuZCwgaWYgYW55CiAgICAgICAgICAgIGlmIChncmlkLnNob3cgJiYgZ3JpZC5iYWNrZ3JvdW5kQ29sb3IpCiAgICAgICAgICAgICAgICBkcmF3QmFja2dyb3VuZCgpOwoKICAgICAgICAgICAgaWYgKGdyaWQuc2hvdyAmJiAhZ3JpZC5hYm92ZURhdGEpIHsKICAgICAgICAgICAgICAgIGRyYXdHcmlkKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VyaWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBleGVjdXRlSG9va3MoaG9va3MuZHJhd1NlcmllcywgW2N0eCwgc2VyaWVzW2ldXSk7CiAgICAgICAgICAgICAgICBkcmF3U2VyaWVzKHNlcmllc1tpXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5kcmF3LCBbY3R4XSk7CgogICAgICAgICAgICBpZiAoZ3JpZC5zaG93ICYmIGdyaWQuYWJvdmVEYXRhKSB7CiAgICAgICAgICAgICAgICBkcmF3R3JpZCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXJmYWNlLnJlbmRlcigpOwoKICAgICAgICAgICAgLy8gQSBkcmF3IGltcGxpZXMgdGhhdCBlaXRoZXIgdGhlIGF4ZXMgb3IgZGF0YSBoYXZlIGNoYW5nZWQsIHNvIHdlCiAgICAgICAgICAgIC8vIHNob3VsZCBwcm9iYWJseSB1cGRhdGUgdGhlIG92ZXJsYXkgaGlnaGxpZ2h0cyBhcyB3ZWxsLgoKICAgICAgICAgICAgdHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RSYW5nZShyYW5nZXMsIGNvb3JkKSB7CiAgICAgICAgICAgIHZhciBheGlzLCBmcm9tLCB0bywga2V5LCBheGVzID0gYWxsQXhlcygpOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBheGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBheGlzID0gYXhlc1tpXTsKICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSBjb29yZCkgewogICAgICAgICAgICAgICAgICAgIGtleSA9IGNvb3JkICsgYXhpcy5uICsgImF4aXMiOwogICAgICAgICAgICAgICAgICAgIGlmICghcmFuZ2VzW2tleV0gJiYgYXhpcy5uID09IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGNvb3JkICsgImF4aXMiOyAvLyBzdXBwb3J0IHgxYXhpcyBhcyB4YXhpcwogICAgICAgICAgICAgICAgICAgIGlmIChyYW5nZXNba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gcmFuZ2VzW2tleV0uZnJvbTsKICAgICAgICAgICAgICAgICAgICAgICAgdG8gPSByYW5nZXNba2V5XS50bzsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMtY29tcGF0IHN0dWZmIC0gdG8gYmUgcmVtb3ZlZCBpbiBmdXR1cmUKICAgICAgICAgICAgaWYgKCFyYW5nZXNba2V5XSkgewogICAgICAgICAgICAgICAgYXhpcyA9IGNvb3JkID09ICJ4IiA\/IHhheGVzWzBdIDogeWF4ZXNbMF07CiAgICAgICAgICAgICAgICBmcm9tID0gcmFuZ2VzW2Nvb3JkICsgIjEiXTsKICAgICAgICAgICAgICAgIHRvID0gcmFuZ2VzW2Nvb3JkICsgIjIiXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gYXV0by1yZXZlcnNlIGFzIGFuIGFkZGVkIGJvbnVzCiAgICAgICAgICAgIGlmIChmcm9tICE9IG51bGwgJiYgdG8gIT0gbnVsbCAmJiBmcm9tID4gdG8pIHsKICAgICAgICAgICAgICAgIHZhciB0bXAgPSBmcm9tOwogICAgICAgICAgICAgICAgZnJvbSA9IHRvOwogICAgICAgICAgICAgICAgdG8gPSB0bXA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7IGZyb206IGZyb20sIHRvOiB0bywgYXhpczogYXhpcyB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZHJhd0JhY2tncm91bmQoKSB7CiAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgIGN0eC50cmFuc2xhdGUocGxvdE9mZnNldC5sZWZ0LCBwbG90T2Zmc2V0LnRvcCk7CgogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZ2V0Q29sb3JPckdyYWRpZW50KG9wdGlvbnMuZ3JpZC5iYWNrZ3JvdW5kQ29sb3IsIHBsb3RIZWlnaHQsIDAsICJyZ2JhKDI1NSwgMjU1LCAyNTUsIDApIik7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBwbG90V2lkdGgsIHBsb3RIZWlnaHQpOwogICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZHJhd0dyaWQoKSB7CiAgICAgICAgICAgIHZhciBpLCBheGVzLCBidywgYmM7CgogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwoKICAgICAgICAgICAgLy8gZHJhdyBtYXJraW5ncwogICAgICAgICAgICB2YXIgbWFya2luZ3MgPSBvcHRpb25zLmdyaWQubWFya2luZ3M7CiAgICAgICAgICAgIGlmIChtYXJraW5ncykgewogICAgICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihtYXJraW5ncykpIHsKICAgICAgICAgICAgICAgICAgICBheGVzID0gcGxvdC5nZXRBeGVzKCk7CiAgICAgICAgICAgICAgICAgICAgLy8geG1pbiBldGMuIGlzIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCB0byBiZQogICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZWQgaW4gdGhlIGZ1dHVyZQogICAgICAgICAgICAgICAgICAgIGF4ZXMueG1pbiA9IGF4ZXMueGF4aXMubWluOwogICAgICAgICAgICAgICAgICAgIGF4ZXMueG1heCA9IGF4ZXMueGF4aXMubWF4OwogICAgICAgICAgICAgICAgICAgIGF4ZXMueW1pbiA9IGF4ZXMueWF4aXMubWluOwogICAgICAgICAgICAgICAgICAgIGF4ZXMueW1heCA9IGF4ZXMueWF4aXMubWF4OwoKICAgICAgICAgICAgICAgICAgICBtYXJraW5ncyA9IG1hcmtpbmdzKGF4ZXMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBtYXJraW5ncy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtID0gbWFya2luZ3NbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHhyYW5nZSA9IGV4dHJhY3RSYW5nZShtLCAieCIpLAogICAgICAgICAgICAgICAgICAgICAgICB5cmFuZ2UgPSBleHRyYWN0UmFuZ2UobSwgInkiKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZmlsbCBpbiBtaXNzaW5nCiAgICAgICAgICAgICAgICAgICAgaWYgKHhyYW5nZS5mcm9tID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgIHhyYW5nZS5mcm9tID0geHJhbmdlLmF4aXMubWluOwogICAgICAgICAgICAgICAgICAgIGlmICh4cmFuZ2UudG8gPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgeHJhbmdlLnRvID0geHJhbmdlLmF4aXMubWF4OwogICAgICAgICAgICAgICAgICAgIGlmICh5cmFuZ2UuZnJvbSA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICB5cmFuZ2UuZnJvbSA9IHlyYW5nZS5heGlzLm1pbjsKICAgICAgICAgICAgICAgICAgICBpZiAoeXJhbmdlLnRvID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgIHlyYW5nZS50byA9IHlyYW5nZS5heGlzLm1heDsKCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcAogICAgICAgICAgICAgICAgICAgIGlmICh4cmFuZ2UudG8gPCB4cmFuZ2UuYXhpcy5taW4gfHwgeHJhbmdlLmZyb20gPiB4cmFuZ2UuYXhpcy5tYXggfHwKICAgICAgICAgICAgICAgICAgICAgICAgeXJhbmdlLnRvIDwgeXJhbmdlLmF4aXMubWluIHx8IHlyYW5nZS5mcm9tID4geXJhbmdlLmF4aXMubWF4KQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgeHJhbmdlLmZyb20gPSBNYXRoLm1heCh4cmFuZ2UuZnJvbSwgeHJhbmdlLmF4aXMubWluKTsKICAgICAgICAgICAgICAgICAgICB4cmFuZ2UudG8gPSBNYXRoLm1pbih4cmFuZ2UudG8sIHhyYW5nZS5heGlzLm1heCk7CiAgICAgICAgICAgICAgICAgICAgeXJhbmdlLmZyb20gPSBNYXRoLm1heCh5cmFuZ2UuZnJvbSwgeXJhbmdlLmF4aXMubWluKTsKICAgICAgICAgICAgICAgICAgICB5cmFuZ2UudG8gPSBNYXRoLm1pbih5cmFuZ2UudG8sIHlyYW5nZS5heGlzLm1heCk7CgogICAgICAgICAgICAgICAgICAgIHZhciB4ZXF1YWwgPSB4cmFuZ2UuZnJvbSA9PT0geHJhbmdlLnRvLAogICAgICAgICAgICAgICAgICAgICAgICB5ZXF1YWwgPSB5cmFuZ2UuZnJvbSA9PT0geXJhbmdlLnRvOwoKICAgICAgICAgICAgICAgICAgICBpZiAoeGVxdWFsICYmIHllcXVhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gZHJhdwogICAgICAgICAgICAgICAgICAgIHhyYW5nZS5mcm9tID0gTWF0aC5mbG9vcih4cmFuZ2UuYXhpcy5wMmMoeHJhbmdlLmZyb20pKTsKICAgICAgICAgICAgICAgICAgICB4cmFuZ2UudG8gPSBNYXRoLmZsb29yKHhyYW5nZS5heGlzLnAyYyh4cmFuZ2UudG8pKTsKICAgICAgICAgICAgICAgICAgICB5cmFuZ2UuZnJvbSA9IE1hdGguZmxvb3IoeXJhbmdlLmF4aXMucDJjKHlyYW5nZS5mcm9tKSk7CiAgICAgICAgICAgICAgICAgICAgeXJhbmdlLnRvID0gTWF0aC5mbG9vcih5cmFuZ2UuYXhpcy5wMmMoeXJhbmdlLnRvKSk7CgogICAgICAgICAgICAgICAgICAgIGlmICh4ZXF1YWwgfHwgeWVxdWFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW5lV2lkdGggPSBtLmxpbmVXaWR0aCB8fCBvcHRpb25zLmdyaWQubWFya2luZ3NMaW5lV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJQaXhlbCA9IGxpbmVXaWR0aCAlIDIgPyAwLjUgOiAwOwogICAgICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IG0uY29sb3IgfHwgb3B0aW9ucy5ncmlkLm1hcmtpbmdzQ29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBsaW5lV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4ZXF1YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeHJhbmdlLnRvICsgc3ViUGl4ZWwsIHlyYW5nZS5mcm9tKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeHJhbmdlLnRvICsgc3ViUGl4ZWwsIHlyYW5nZS50byk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHhyYW5nZS5mcm9tLCB5cmFuZ2UudG8gKyBzdWJQaXhlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKHhyYW5nZS50bywgeXJhbmdlLnRvICsgc3ViUGl4ZWwpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IG0uY29sb3IgfHwgb3B0aW9ucy5ncmlkLm1hcmtpbmdzQ29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsUmVjdCh4cmFuZ2UuZnJvbSwgeXJhbmdlLnRvLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeHJhbmdlLnRvIC0geHJhbmdlLmZyb20sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5cmFuZ2UuZnJvbSAtIHlyYW5nZS50byk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBkcmF3IHRoZSB0aWNrcwogICAgICAgICAgICBheGVzID0gYWxsQXhlcygpOwogICAgICAgICAgICBidyA9IG9wdGlvbnMuZ3JpZC5ib3JkZXJXaWR0aDsKCiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXhlcy5sZW5ndGg7ICsraikgewogICAgICAgICAgICAgICAgdmFyIGF4aXMgPSBheGVzW2pdLCBib3ggPSBheGlzLmJveCwKICAgICAgICAgICAgICAgICAgICB0ID0gYXhpcy50aWNrTGVuZ3RoLCB4LCB5LCB4b2ZmLCB5b2ZmOwogICAgICAgICAgICAgICAgaWYgKCFheGlzLnNob3cgfHwgYXhpcy50aWNrcy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMTsKCiAgICAgICAgICAgICAgICAvLyBmaW5kIHRoZSBlZGdlcwogICAgICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikgewogICAgICAgICAgICAgICAgICAgIHggPSAwOwogICAgICAgICAgICAgICAgICAgIGlmICh0ID09ICJmdWxsIikKICAgICAgICAgICAgICAgICAgICAgICAgeSA9IChheGlzLnBvc2l0aW9uID09ICJ0b3AiID8gMCA6IHBsb3RIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgeSA9IGJveC50b3AgLSBwbG90T2Zmc2V0LnRvcCArIChheGlzLnBvc2l0aW9uID09ICJ0b3AiID8gYm94LmhlaWdodCA6IDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgeSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQgPT0gImZ1bGwiKQogICAgICAgICAgICAgICAgICAgICAgICB4ID0gKGF4aXMucG9zaXRpb24gPT0gImxlZnQiID8gMCA6IHBsb3RXaWR0aCk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB4ID0gYm94LmxlZnQgLSBwbG90T2Zmc2V0LmxlZnQgKyAoYXhpcy5wb3NpdGlvbiA9PSAibGVmdCIgPyBib3gud2lkdGggOiAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBkcmF3IHRpY2sgYmFyCiAgICAgICAgICAgICAgICBpZiAoIWF4aXMuaW5uZXJtb3N0KSB7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYXhpcy5vcHRpb25zLmNvbG9yOwogICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICB4b2ZmID0geW9mZiA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikKICAgICAgICAgICAgICAgICAgICAgICAgeG9mZiA9IHBsb3RXaWR0aCArIDE7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB5b2ZmID0gcGxvdEhlaWdodCArIDE7CgogICAgICAgICAgICAgICAgICAgIGlmIChjdHgubGluZVdpZHRoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMuZGlyZWN0aW9uID09ICJ4IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IE1hdGguZmxvb3IoeSkgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gTWF0aC5mbG9vcih4KSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4LCB5KTsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKHggKyB4b2ZmLCB5ICsgeW9mZik7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGRyYXcgdGlja3MKCiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBheGlzLm9wdGlvbnMudGlja0NvbG9yOwoKICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBheGlzLnRpY2tzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHYgPSBheGlzLnRpY2tzW2ldLnY7CgogICAgICAgICAgICAgICAgICAgIHhvZmYgPSB5b2ZmID0gMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKHYpIHx8IHYgPCBheGlzLm1pbiB8fCB2ID4gYXhpcy5tYXgKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2tpcCB0aG9zZSBseWluZyBvbiB0aGUgYXhlcyBpZiB3ZSBnb3QgYSBib3JkZXIKICAgICAgICAgICAgICAgICAgICAgICAgfHwgKHQgPT0gImZ1bGwiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAmJiAoKHR5cGVvZiBidyA9PSAib2JqZWN0IiAmJiBid1theGlzLnBvc2l0aW9uXSA+IDApIHx8IGJ3ID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmICh2ID09IGF4aXMubWluIHx8IHYgPT0gYXhpcy5tYXgpKSkKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgeCA9IGF4aXMucDJjKHYpOwogICAgICAgICAgICAgICAgICAgICAgICB5b2ZmID0gdCA9PSAiZnVsbCIgPyAtcGxvdEhlaWdodCA6IHQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PSAidG9wIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlvZmYgPSAteW9mZjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBheGlzLnAyYyh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgeG9mZiA9IHQgPT0gImZ1bGwiID8gLXBsb3RXaWR0aCA6IHQ7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PSAibGVmdCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4b2ZmID0gLXhvZmY7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoY3R4LmxpbmVXaWR0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gTWF0aC5mbG9vcih4KSArIDAuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IE1hdGguZmxvb3IoeSkgKyAwLjU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHgsIHkpOwogICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oeCArIHhvZmYsIHkgKyB5b2ZmKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvLyBkcmF3IGJvcmRlcgogICAgICAgICAgICBpZiAoYncpIHsKICAgICAgICAgICAgICAgIC8vIElmIGVpdGhlciBib3JkZXJXaWR0aCBvciBib3JkZXJDb2xvciBpcyBhbiBvYmplY3QsIHRoZW4gZHJhdyB0aGUgYm9yZGVyCiAgICAgICAgICAgICAgICAvLyBsaW5lIGJ5IGxpbmUgaW5zdGVhZCBvZiBhcyBvbmUgcmVjdGFuZ2xlCiAgICAgICAgICAgICAgICBiYyA9IG9wdGlvbnMuZ3JpZC5ib3JkZXJDb2xvcjsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBidyA9PSAib2JqZWN0IiB8fCB0eXBlb2YgYmMgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGJ3ICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgICAgICBidyA9IHt0b3A6IGJ3LCByaWdodDogYncsIGJvdHRvbTogYncsIGxlZnQ6IGJ3fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBiYyAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmMgPSB7dG9wOiBiYywgcmlnaHQ6IGJjLCBib3R0b206IGJjLCBsZWZ0OiBiY307CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoYncudG9wID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBiYy50b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBidy50b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbygwIC0gYncubGVmdCwgMCAtIGJ3LnRvcC8yKTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhwbG90V2lkdGgsIDAgLSBidy50b3AvMik7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChidy5yaWdodCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYmMucmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBidy5yaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKHBsb3RXaWR0aCArIGJ3LnJpZ2h0IC8gMiwgMCAtIGJ3LnRvcCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8ocGxvdFdpZHRoICsgYncucmlnaHQgLyAyLCBwbG90SGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGJ3LmJvdHRvbSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gYmMuYm90dG9tOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYncuYm90dG9tOwogICAgICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8ocGxvdFdpZHRoICsgYncucmlnaHQsIHBsb3RIZWlnaHQgKyBidy5ib3R0b20gLyAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbygwLCBwbG90SGVpZ2h0ICsgYncuYm90dG9tIC8gMik7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChidy5sZWZ0ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBiYy5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYncubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubW92ZVRvKDAgLSBidy5sZWZ0LzIsIHBsb3RIZWlnaHQgKyBidy5ib3R0b20pOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKDAtIGJ3LmxlZnQvMiwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gYnc7CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gb3B0aW9ucy5ncmlkLmJvcmRlckNvbG9yOwogICAgICAgICAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KC1idy8yLCAtYncvMiwgcGxvdFdpZHRoICsgYncsIHBsb3RIZWlnaHQgKyBidyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3QXhpc0xhYmVscygpIHsKCiAgICAgICAgICAgICQuZWFjaChhbGxBeGVzKCksIGZ1bmN0aW9uIChfLCBheGlzKSB7CiAgICAgICAgICAgICAgICB2YXIgYm94ID0gYXhpcy5ib3gsCiAgICAgICAgICAgICAgICAgICAgbGVnYWN5U3R5bGVzID0gYXhpcy5kaXJlY3Rpb24gKyAiQXhpcyAiICsgYXhpcy5kaXJlY3Rpb24gKyBheGlzLm4gKyAiQXhpcyIsCiAgICAgICAgICAgICAgICAgICAgbGF5ZXIgPSAiZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyAiLWF4aXMgZmxvdC0iICsgYXhpcy5kaXJlY3Rpb24gKyBheGlzLm4gKyAiLWF4aXMgIiArIGxlZ2FjeVN0eWxlcywKICAgICAgICAgICAgICAgICAgICBmb250ID0gYXhpcy5vcHRpb25zLmZvbnQgfHwgImZsb3QtdGljay1sYWJlbCB0aWNrTGFiZWwiLAogICAgICAgICAgICAgICAgICAgIHRpY2ssIHgsIHksIGhhbGlnbiwgdmFsaWduOwoKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0ZXh0IGJlZm9yZSBjaGVja2luZyBmb3IgYXhpcy5zaG93IGFuZCB0aWNrcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UgcGx1Z2lucywgbGlrZSBmbG90LXRpY2tyb3RvciwgdGhhdCBkcmF3IHRoZWlyIG93bgogICAgICAgICAgICAgICAgLy8gdGljayBsYWJlbHMgd2lsbCBlbmQgdXAgd2l0aCBib3RoIHRoZWlycyBhbmQgdGhlIGRlZmF1bHRzLgoKICAgICAgICAgICAgICAgIHN1cmZhY2UucmVtb3ZlVGV4dChsYXllcik7CgogICAgICAgICAgICAgICAgaWYgKCFheGlzLnNob3cgfHwgYXhpcy50aWNrcy5sZW5ndGggPT0gMCkKICAgICAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBheGlzLnRpY2tzLmxlbmd0aDsgKytpKSB7CgogICAgICAgICAgICAgICAgICAgIHRpY2sgPSBheGlzLnRpY2tzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICghdGljay5sYWJlbCB8fCB0aWNrLnYgPCBheGlzLm1pbiB8fCB0aWNrLnYgPiBheGlzLm1heCkKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgIGlmIChheGlzLmRpcmVjdGlvbiA9PSAieCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGFsaWduID0gImNlbnRlciI7CiAgICAgICAgICAgICAgICAgICAgICAgIHggPSBwbG90T2Zmc2V0LmxlZnQgKyBheGlzLnAyYyh0aWNrLnYpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXhpcy5wb3NpdGlvbiA9PSAiYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IGJveC50b3AgKyBib3gucGFkZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBib3gudG9wICsgYm94LmhlaWdodCAtIGJveC5wYWRkaW5nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWduID0gImJvdHRvbSI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZ24gPSAibWlkZGxlIjsKICAgICAgICAgICAgICAgICAgICAgICAgeSA9IHBsb3RPZmZzZXQudG9wICsgYXhpcy5wMmModGljay52KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4aXMucG9zaXRpb24gPT0gImxlZnQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gYm94LmxlZnQgKyBib3gud2lkdGggLSBib3gucGFkZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbGlnbiA9ICJyaWdodCI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gYm94LmxlZnQgKyBib3gucGFkZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgc3VyZmFjZS5hZGRUZXh0KGxheWVyLCB4LCB5LCB0aWNrLmxhYmVsLCBmb250LCBudWxsLCBudWxsLCBoYWxpZ24sIHZhbGlnbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZHJhd1NlcmllcyhzZXJpZXMpIHsKICAgICAgICAgICAgaWYgKHNlcmllcy5saW5lcy5zaG93KQogICAgICAgICAgICAgICAgZHJhd1Nlcmllc0xpbmVzKHNlcmllcyk7CiAgICAgICAgICAgIGlmIChzZXJpZXMuYmFycy5zaG93KQogICAgICAgICAgICAgICAgZHJhd1Nlcmllc0JhcnMoc2VyaWVzKTsKICAgICAgICAgICAgaWYgKHNlcmllcy5wb2ludHMuc2hvdykKICAgICAgICAgICAgICAgIGRyYXdTZXJpZXNQb2ludHMoc2VyaWVzKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdTZXJpZXNMaW5lcyhzZXJpZXMpIHsKICAgICAgICAgICAgZnVuY3Rpb24gcGxvdExpbmUoZGF0YXBvaW50cywgeG9mZnNldCwgeW9mZnNldCwgYXhpc3gsIGF4aXN5KSB7CiAgICAgICAgICAgICAgICB2YXIgcG9pbnRzID0gZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgICAgICAgICAgcHMgPSBkYXRhcG9pbnRzLnBvaW50c2l6ZSwKICAgICAgICAgICAgICAgICAgICBwcmV2eCA9IG51bGwsIHByZXZ5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gcHM7IGkgPCBwb2ludHMubGVuZ3RoOyBpICs9IHBzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHgxID0gcG9pbnRzW2kgLSBwc10sIHkxID0gcG9pbnRzW2kgLSBwcyArIDFdLAogICAgICAgICAgICAgICAgICAgICAgICB4MiA9IHBvaW50c1tpXSwgeTIgPSBwb2ludHNbaSArIDFdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPT0gbnVsbCB8fCB4MiA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcCB3aXRoIHltaW4KICAgICAgICAgICAgICAgICAgICBpZiAoeTEgPD0geTIgJiYgeTEgPCBheGlzeS5taW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHkyIDwgYXhpc3kubWluKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7ICAgLy8gbGluZSBzZWdtZW50IGlzIG91dHNpZGUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29tcHV0ZSBuZXcgaW50ZXJzZWN0aW9uIHBvaW50CiAgICAgICAgICAgICAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICAgICAgICAgICAgICB5MSA9IGF4aXN5Lm1pbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeTIgPD0geTEgJiYgeTIgPCBheGlzeS5taW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHkxIDwgYXhpc3kubWluKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHgyID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICAgICAgICAgICAgICB5MiA9IGF4aXN5Lm1pbjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsaXAgd2l0aCB5bWF4CiAgICAgICAgICAgICAgICAgICAgaWYgKHkxID49IHkyICYmIHkxID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh5MiA+IGF4aXN5Lm1heCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB4MSA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICAgICAgeTEgPSBheGlzeS5tYXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHkyID49IHkxICYmIHkyID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh5MSA+IGF4aXN5Lm1heCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB4MiA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICAgICAgeTIgPSBheGlzeS5tYXg7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBjbGlwIHdpdGggeG1pbgogICAgICAgICAgICAgICAgICAgIGlmICh4MSA8PSB4MiAmJiB4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeDIgPCBheGlzeC5taW4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgeTEgPSAoYXhpc3gubWluIC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgICAgICAgICAgICAgIHgxID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh4MiA8PSB4MSAmJiB4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPCBheGlzeC5taW4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgeTIgPSAoYXhpc3gubWluIC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgICAgICAgICAgICAgIHgyID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcCB3aXRoIHhtYXgKICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPj0geDIgJiYgeDEgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHgyID4gYXhpc3gubWF4KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHkxID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgICAgICB4MSA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeDIgPj0geDEgJiYgeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHgxID4gYXhpc3gubWF4KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgICAgICB4MiA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh4MSAhPSBwcmV2eCB8fCB5MSAhPSBwcmV2eSkKICAgICAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyhheGlzeC5wMmMoeDEpICsgeG9mZnNldCwgYXhpc3kucDJjKHkxKSArIHlvZmZzZXQpOwoKICAgICAgICAgICAgICAgICAgICBwcmV2eCA9IHgyOwogICAgICAgICAgICAgICAgICAgIHByZXZ5ID0geTI7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpICsgeG9mZnNldCwgYXhpc3kucDJjKHkyKSArIHlvZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBwbG90TGluZUFyZWEoZGF0YXBvaW50cywgYXhpc3gsIGF4aXN5KSB7CiAgICAgICAgICAgICAgICB2YXIgcG9pbnRzID0gZGF0YXBvaW50cy5wb2ludHMsCiAgICAgICAgICAgICAgICAgICAgcHMgPSBkYXRhcG9pbnRzLnBvaW50c2l6ZSwKICAgICAgICAgICAgICAgICAgICBib3R0b20gPSBNYXRoLm1pbihNYXRoLm1heCgwLCBheGlzeS5taW4pLCBheGlzeS5tYXgpLAogICAgICAgICAgICAgICAgICAgIGkgPSAwLCB0b3AsIGFyZWFPcGVuID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgeXBvcyA9IDEsIHNlZ21lbnRTdGFydCA9IDAsIHNlZ21lbnRFbmQgPSAwOwoKICAgICAgICAgICAgICAgIC8vIHdlIHByb2Nlc3MgZWFjaCBzZWdtZW50IGluIHR3byB0dXJucywgZmlyc3QgZm9yd2FyZAogICAgICAgICAgICAgICAgLy8gZGlyZWN0aW9uIHRvIHNrZXRjaCBvdXQgdG9wLCB0aGVuIG9uY2Ugd2UgaGl0IHRoZQogICAgICAgICAgICAgICAgLy8gZW5kIHdlIGdvIGJhY2t3YXJkcyB0byBza2V0Y2ggdGhlIGJvdHRvbQogICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHMgPiAwICYmIGkgPiBwb2ludHMubGVuZ3RoICsgcHMpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICBpICs9IHBzOyAvLyBwcyBpcyBuZWdhdGl2ZSBpZiBnb2luZyBiYWNrd2FyZHMKCiAgICAgICAgICAgICAgICAgICAgdmFyIHgxID0gcG9pbnRzW2kgLSBwc10sCiAgICAgICAgICAgICAgICAgICAgICAgIHkxID0gcG9pbnRzW2kgLSBwcyArIHlwb3NdLAogICAgICAgICAgICAgICAgICAgICAgICB4MiA9IHBvaW50c1tpXSwgeTIgPSBwb2ludHNbaSArIHlwb3NdOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYXJlYU9wZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBzID4gMCAmJiB4MSAhPSBudWxsICYmIHgyID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGF0IHR1cm5pbmcgcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRFbmQgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHMgPSAtcHM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5cG9zID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHMgPCAwICYmIGkgPT0gc2VnbWVudFN0YXJ0ICsgcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvbmUgd2l0aCB0aGUgcmV2ZXJzZSBzd2VlcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZWFPcGVuID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcyA9IC1wczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlwb3MgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHNlZ21lbnRTdGFydCA9IHNlZ21lbnRFbmQgKyBwczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPT0gbnVsbCB8fCB4MiA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcCB4IHZhbHVlcwoKICAgICAgICAgICAgICAgICAgICAvLyBjbGlwIHdpdGggeG1pbgogICAgICAgICAgICAgICAgICAgIGlmICh4MSA8PSB4MiAmJiB4MSA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeDIgPCBheGlzeC5taW4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgeTEgPSAoYXhpc3gubWluIC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgICAgICAgICAgICAgIHgxID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh4MiA8PSB4MSAmJiB4MiA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPCBheGlzeC5taW4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgeTIgPSAoYXhpc3gubWluIC0geDEpIC8gKHgyIC0geDEpICogKHkyIC0geTEpICsgeTE7CiAgICAgICAgICAgICAgICAgICAgICAgIHgyID0gYXhpc3gubWluOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcCB3aXRoIHhtYXgKICAgICAgICAgICAgICAgICAgICBpZiAoeDEgPj0geDIgJiYgeDEgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHgyID4gYXhpc3gubWF4KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHkxID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgICAgICB4MSA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeDIgPj0geDEgJiYgeDIgPiBheGlzeC5tYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHgxID4gYXhpc3gubWF4KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHkyID0gKGF4aXN4Lm1heCAtIHgxKSAvICh4MiAtIHgxKSAqICh5MiAtIHkxKSArIHkxOwogICAgICAgICAgICAgICAgICAgICAgICB4MiA9IGF4aXN4Lm1heDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghYXJlYU9wZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gb3BlbiBhcmVhCiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyhheGlzeC5wMmMoeDEpLCBheGlzeS5wMmMoYm90dG9tKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZWFPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIG5vdyBmaXJzdCBjaGVjayB0aGUgY2FzZSB3aGVyZSBib3RoIGlzIG91dHNpZGUKICAgICAgICAgICAgICAgICAgICBpZiAoeTEgPj0gYXhpc3kubWF4ICYmIHkyID49IGF4aXN5Lm1heCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MSksIGF4aXN5LnAyYyhheGlzeS5tYXgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpLCBheGlzeS5wMmMoYXhpc3kubWF4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh5MSA8PSBheGlzeS5taW4gJiYgeTIgPD0gYXhpc3kubWluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgxKSwgYXhpc3kucDJjKGF4aXN5Lm1pbikpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgubGluZVRvKGF4aXN4LnAyYyh4MiksIGF4aXN5LnAyYyhheGlzeS5taW4pKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBlbHNlIGl0J3MgYSBiaXQgbW9yZSBjb21wbGljYXRlZCwgdGhlcmUgbWlnaHQKICAgICAgICAgICAgICAgICAgICAvLyBiZSBhIGZsYXQgbWF4ZWQgb3V0IHJlY3RhbmdsZSBmaXJzdCwgdGhlbiBhCiAgICAgICAgICAgICAgICAgICAgLy8gdHJpYW5ndWxhciBjdXRvdXQgb3IgcmV2ZXJzZTsgdG8gZmluZCB0aGVzZQogICAgICAgICAgICAgICAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhlIGN1cnJlbnQgeCB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICB2YXIgeDFvbGQgPSB4MSwgeDJvbGQgPSB4MjsKCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcCB0aGUgeSB2YWx1ZXMsIHdpdGhvdXQgc2hvcnRjdXR0aW5nLCB3ZQogICAgICAgICAgICAgICAgICAgIC8vIGdvIHRocm91Z2ggYWxsIGNhc2VzIGluIHR1cm4KCiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcCB3aXRoIHltaW4KICAgICAgICAgICAgICAgICAgICBpZiAoeTEgPD0geTIgJiYgeTEgPCBheGlzeS5taW4gJiYgeTIgPj0gYXhpc3kubWluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHgxID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICAgICAgICAgICAgICB5MSA9IGF4aXN5Lm1pbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeTIgPD0geTEgJiYgeTIgPCBheGlzeS5taW4gJiYgeTEgPj0gYXhpc3kubWluKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHgyID0gKGF4aXN5Lm1pbiAtIHkxKSAvICh5MiAtIHkxKSAqICh4MiAtIHgxKSArIHgxOwogICAgICAgICAgICAgICAgICAgICAgICB5MiA9IGF4aXN5Lm1pbjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNsaXAgd2l0aCB5bWF4CiAgICAgICAgICAgICAgICAgICAgaWYgKHkxID49IHkyICYmIHkxID4gYXhpc3kubWF4ICYmIHkyIDw9IGF4aXN5Lm1heCkgewogICAgICAgICAgICAgICAgICAgICAgICB4MSA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICAgICAgeTEgPSBheGlzeS5tYXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHkyID49IHkxICYmIHkyID4gYXhpc3kubWF4ICYmIHkxIDw9IGF4aXN5Lm1heCkgewogICAgICAgICAgICAgICAgICAgICAgICB4MiA9IChheGlzeS5tYXggLSB5MSkgLyAoeTIgLSB5MSkgKiAoeDIgLSB4MSkgKyB4MTsKICAgICAgICAgICAgICAgICAgICAgICAgeTIgPSBheGlzeS5tYXg7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgeCB2YWx1ZSB3YXMgY2hhbmdlZCB3ZSBnb3QgYSByZWN0YW5nbGUKICAgICAgICAgICAgICAgICAgICAvLyB0byBmaWxsCiAgICAgICAgICAgICAgICAgICAgaWYgKHgxICE9IHgxb2xkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgxb2xkKSwgYXhpc3kucDJjKHkxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGl0IGdvZXMgdG8gKHgxLCB5MSksIGJ1dCB3ZSBmaWxsIHRoYXQgYmVsb3cKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGZpbGwgdHJpYW5ndWxhciBzZWN0aW9uLCB0aGlzIHNvbWV0aW1lcyByZXN1bHQKICAgICAgICAgICAgICAgICAgICAvLyBpbiByZWR1bmRhbnQgcG9pbnRzIGlmICh4MSwgeTEpIGhhc24ndCBjaGFuZ2VkCiAgICAgICAgICAgICAgICAgICAgLy8gZnJvbSBwcmV2aW91cyBsaW5lIHRvLCBidXQgd2UganVzdCBpZ25vcmUgdGhhdAogICAgICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oYXhpc3gucDJjKHgxKSwgYXhpc3kucDJjKHkxKSk7CiAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpLCBheGlzeS5wMmMoeTIpKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZmlsbCB0aGUgb3RoZXIgcmVjdGFuZ2xlIGlmIGl0J3MgdGhlcmUKICAgICAgICAgICAgICAgICAgICBpZiAoeDIgIT0geDJvbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDIpLCBheGlzeS5wMmMoeTIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmxpbmVUbyhheGlzeC5wMmMoeDJvbGQpLCBheGlzeS5wMmMoeTIpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgIGN0eC50cmFuc2xhdGUocGxvdE9mZnNldC5sZWZ0LCBwbG90T2Zmc2V0LnRvcCk7CiAgICAgICAgICAgIGN0eC5saW5lSm9pbiA9ICJyb3VuZCI7CgogICAgICAgICAgICB2YXIgbHcgPSBzZXJpZXMubGluZXMubGluZVdpZHRoLAogICAgICAgICAgICAgICAgc3cgPSBzZXJpZXMuc2hhZG93U2l6ZTsKICAgICAgICAgICAgLy8gRklYTUU6IGNvbnNpZGVyIGFub3RoZXIgZm9ybSBvZiBzaGFkb3cgd2hlbiBmaWxsaW5nIGlzIHR1cm5lZCBvbgogICAgICAgICAgICBpZiAobHcgPiAwICYmIHN3ID4gMCkgewogICAgICAgICAgICAgICAgLy8gZHJhdyBzaGFkb3cgYXMgYSB0aGljayBhbmQgdGhpbiBsaW5lIHdpdGggdHJhbnNwYXJlbmN5CiAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gc3c7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAicmdiYSgwLDAsMCwwLjEpIjsKICAgICAgICAgICAgICAgIC8vIHBvc2l0aW9uIHNoYWRvdyBhdCBhbmdsZSBmcm9tIHRoZSBtaWQgb2YgbGluZQogICAgICAgICAgICAgICAgdmFyIGFuZ2xlID0gTWF0aC5QSS8xODsKICAgICAgICAgICAgICAgIHBsb3RMaW5lKHNlcmllcy5kYXRhcG9pbnRzLCBNYXRoLnNpbihhbmdsZSkgKiAobHcvMiArIHN3LzIpLCBNYXRoLmNvcyhhbmdsZSkgKiAobHcvMiArIHN3LzIpLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcyk7CiAgICAgICAgICAgICAgICBjdHgubGluZVdpZHRoID0gc3cvMjsKICAgICAgICAgICAgICAgIHBsb3RMaW5lKHNlcmllcy5kYXRhcG9pbnRzLCBNYXRoLnNpbihhbmdsZSkgKiAobHcvMiArIHN3LzQpLCBNYXRoLmNvcyhhbmdsZSkgKiAobHcvMiArIHN3LzQpLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSBsdzsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gc2VyaWVzLmNvbG9yOwogICAgICAgICAgICB2YXIgZmlsbFN0eWxlID0gZ2V0RmlsbFN0eWxlKHNlcmllcy5saW5lcywgc2VyaWVzLmNvbG9yLCAwLCBwbG90SGVpZ2h0KTsKICAgICAgICAgICAgaWYgKGZpbGxTdHlsZSkgewogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGZpbGxTdHlsZTsKICAgICAgICAgICAgICAgIHBsb3RMaW5lQXJlYShzZXJpZXMuZGF0YXBvaW50cywgc2VyaWVzLnhheGlzLCBzZXJpZXMueWF4aXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobHcgPiAwKQogICAgICAgICAgICAgICAgcGxvdExpbmUoc2VyaWVzLmRhdGFwb2ludHMsIDAsIDAsIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdTZXJpZXNQb2ludHMoc2VyaWVzKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIHBsb3RQb2ludHMoZGF0YXBvaW50cywgcmFkaXVzLCBmaWxsU3R5bGUsIG9mZnNldCwgc2hhZG93LCBheGlzeCwgYXhpc3ksIHN5bWJvbCkgewogICAgICAgICAgICAgICAgdmFyIHBvaW50cyA9IGRhdGFwb2ludHMucG9pbnRzLCBwcyA9IGRhdGFwb2ludHMucG9pbnRzaXplOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSArPSBwcykgewogICAgICAgICAgICAgICAgICAgIHZhciB4ID0gcG9pbnRzW2ldLCB5ID0gcG9pbnRzW2kgKyAxXTsKICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSBudWxsIHx8IHggPCBheGlzeC5taW4gfHwgeCA+IGF4aXN4Lm1heCB8fCB5IDwgYXhpc3kubWluIHx8IHkgPiBheGlzeS5tYXgpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgeCA9IGF4aXN4LnAyYyh4KTsKICAgICAgICAgICAgICAgICAgICB5ID0gYXhpc3kucDJjKHkpICsgb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIGlmIChzeW1ib2wgPT0gImNpcmNsZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5hcmMoeCwgeSwgcmFkaXVzLCAwLCBzaGFkb3cgPyBNYXRoLlBJIDogTWF0aC5QSSAqIDIsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHN5bWJvbChjdHgsIHgsIHksIHJhZGl1cywgc2hhZG93KTsKICAgICAgICAgICAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CgogICAgICAgICAgICAgICAgICAgIGlmIChmaWxsU3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGZpbGxTdHlsZTsKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwoKICAgICAgICAgICAgdmFyIGx3ID0gc2VyaWVzLnBvaW50cy5saW5lV2lkdGgsCiAgICAgICAgICAgICAgICBzdyA9IHNlcmllcy5zaGFkb3dTaXplLAogICAgICAgICAgICAgICAgcmFkaXVzID0gc2VyaWVzLnBvaW50cy5yYWRpdXMsCiAgICAgICAgICAgICAgICBzeW1ib2wgPSBzZXJpZXMucG9pbnRzLnN5bWJvbDsKCiAgICAgICAgICAgIC8vIElmIHRoZSB1c2VyIHNldHMgdGhlIGxpbmUgd2lkdGggdG8gMCwgd2UgY2hhbmdlIGl0IHRvIGEgdmVyeSAKICAgICAgICAgICAgLy8gc21hbGwgdmFsdWUuIEEgbGluZSB3aWR0aCBvZiAwIHNlZW1zIHRvIGZvcmNlIHRoZSBkZWZhdWx0IG9mIDEuCiAgICAgICAgICAgIC8vIERvaW5nIHRoZSBjb25kaXRpb25hbCBoZXJlIGFsbG93cyB0aGUgc2hhZG93IHNldHRpbmcgdG8gc3RpbGwgYmUgCiAgICAgICAgICAgIC8vIG9wdGlvbmFsIGV2ZW4gd2l0aCBhIGxpbmVXaWR0aCBvZiAwLgoKICAgICAgICAgICAgaWYoIGx3ID09IDAgKQogICAgICAgICAgICAgICAgbHcgPSAwLjAwMDE7CgogICAgICAgICAgICBpZiAobHcgPiAwICYmIHN3ID4gMCkgewogICAgICAgICAgICAgICAgLy8gZHJhdyBzaGFkb3cgaW4gdHdvIHN0ZXBzCiAgICAgICAgICAgICAgICB2YXIgdyA9IHN3IC8gMjsKICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSB3OwogICAgICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gInJnYmEoMCwwLDAsMC4xKSI7CiAgICAgICAgICAgICAgICBwbG90UG9pbnRzKHNlcmllcy5kYXRhcG9pbnRzLCByYWRpdXMsIG51bGwsIHcgKyB3LzIsIHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzLCBzeW1ib2wpOwoKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9ICJyZ2JhKDAsMCwwLDAuMikiOwogICAgICAgICAgICAgICAgcGxvdFBvaW50cyhzZXJpZXMuZGF0YXBvaW50cywgcmFkaXVzLCBudWxsLCB3LzIsIHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcmllcy54YXhpcywgc2VyaWVzLnlheGlzLCBzeW1ib2wpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gbHc7CiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IHNlcmllcy5jb2xvcjsKICAgICAgICAgICAgcGxvdFBvaW50cyhzZXJpZXMuZGF0YXBvaW50cywgcmFkaXVzLAogICAgICAgICAgICAgICAgICAgICAgIGdldEZpbGxTdHlsZShzZXJpZXMucG9pbnRzLCBzZXJpZXMuY29sb3IpLCAwLCBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgc3ltYm9sKTsKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdCYXIoeCwgeSwgYiwgYmFyTGVmdCwgYmFyUmlnaHQsIGZpbGxTdHlsZUNhbGxiYWNrLCBheGlzeCwgYXhpc3ksIGMsIGhvcml6b250YWwsIGxpbmVXaWR0aCkgewogICAgICAgICAgICB2YXIgbGVmdCwgcmlnaHQsIGJvdHRvbSwgdG9wLAogICAgICAgICAgICAgICAgZHJhd0xlZnQsIGRyYXdSaWdodCwgZHJhd1RvcCwgZHJhd0JvdHRvbSwKICAgICAgICAgICAgICAgIHRtcDsKCiAgICAgICAgICAgIC8vIGluIGhvcml6b250YWwgbW9kZSwgd2Ugc3RhcnQgdGhlIGJhciBmcm9tIHRoZSBsZWZ0CiAgICAgICAgICAgIC8vIGluc3RlYWQgb2YgZnJvbSB0aGUgYm90dG9tIHNvIGl0IGFwcGVhcnMgdG8gYmUKICAgICAgICAgICAgLy8gaG9yaXpvbnRhbCByYXRoZXIgdGhhbiB2ZXJ0aWNhbAogICAgICAgICAgICBpZiAoaG9yaXpvbnRhbCkgewogICAgICAgICAgICAgICAgZHJhd0JvdHRvbSA9IGRyYXdSaWdodCA9IGRyYXdUb3AgPSB0cnVlOwogICAgICAgICAgICAgICAgZHJhd0xlZnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGxlZnQgPSBiOwogICAgICAgICAgICAgICAgcmlnaHQgPSB4OwogICAgICAgICAgICAgICAgdG9wID0geSArIGJhckxlZnQ7CiAgICAgICAgICAgICAgICBib3R0b20gPSB5ICsgYmFyUmlnaHQ7CgogICAgICAgICAgICAgICAgLy8gYWNjb3VudCBmb3IgbmVnYXRpdmUgYmFycwogICAgICAgICAgICAgICAgaWYgKHJpZ2h0IDwgbGVmdCkgewogICAgICAgICAgICAgICAgICAgIHRtcCA9IHJpZ2h0OwogICAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gbGVmdDsKICAgICAgICAgICAgICAgICAgICBsZWZ0ID0gdG1wOwogICAgICAgICAgICAgICAgICAgIGRyYXdMZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBkcmF3UmlnaHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGRyYXdMZWZ0ID0gZHJhd1JpZ2h0ID0gZHJhd1RvcCA9IHRydWU7CiAgICAgICAgICAgICAgICBkcmF3Qm90dG9tID0gZmFsc2U7CiAgICAgICAgICAgICAgICBsZWZ0ID0geCArIGJhckxlZnQ7CiAgICAgICAgICAgICAgICByaWdodCA9IHggKyBiYXJSaWdodDsKICAgICAgICAgICAgICAgIGJvdHRvbSA9IGI7CiAgICAgICAgICAgICAgICB0b3AgPSB5OwoKICAgICAgICAgICAgICAgIC8vIGFjY291bnQgZm9yIG5lZ2F0aXZlIGJhcnMKICAgICAgICAgICAgICAgIGlmICh0b3AgPCBib3R0b20pIHsKICAgICAgICAgICAgICAgICAgICB0bXAgPSB0b3A7CiAgICAgICAgICAgICAgICAgICAgdG9wID0gYm90dG9tOwogICAgICAgICAgICAgICAgICAgIGJvdHRvbSA9IHRtcDsKICAgICAgICAgICAgICAgICAgICBkcmF3Qm90dG9tID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBkcmF3VG9wID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNsaXAKICAgICAgICAgICAgaWYgKHJpZ2h0IDwgYXhpc3gubWluIHx8IGxlZnQgPiBheGlzeC5tYXggfHwKICAgICAgICAgICAgICAgIHRvcCA8IGF4aXN5Lm1pbiB8fCBib3R0b20gPiBheGlzeS5tYXgpCiAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICBpZiAobGVmdCA8IGF4aXN4Lm1pbikgewogICAgICAgICAgICAgICAgbGVmdCA9IGF4aXN4Lm1pbjsKICAgICAgICAgICAgICAgIGRyYXdMZWZ0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyaWdodCA+IGF4aXN4Lm1heCkgewogICAgICAgICAgICAgICAgcmlnaHQgPSBheGlzeC5tYXg7CiAgICAgICAgICAgICAgICBkcmF3UmlnaHQgPSBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJvdHRvbSA8IGF4aXN5Lm1pbikgewogICAgICAgICAgICAgICAgYm90dG9tID0gYXhpc3kubWluOwogICAgICAgICAgICAgICAgZHJhd0JvdHRvbSA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodG9wID4gYXhpc3kubWF4KSB7CiAgICAgICAgICAgICAgICB0b3AgPSBheGlzeS5tYXg7CiAgICAgICAgICAgICAgICBkcmF3VG9wID0gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxlZnQgPSBheGlzeC5wMmMobGVmdCk7CiAgICAgICAgICAgIGJvdHRvbSA9IGF4aXN5LnAyYyhib3R0b20pOwogICAgICAgICAgICByaWdodCA9IGF4aXN4LnAyYyhyaWdodCk7CiAgICAgICAgICAgIHRvcCA9IGF4aXN5LnAyYyh0b3ApOwoKICAgICAgICAgICAgLy8gZmlsbCB0aGUgYmFyCiAgICAgICAgICAgIGlmIChmaWxsU3R5bGVDYWxsYmFjaykgewogICAgICAgICAgICAgICAgYy5maWxsU3R5bGUgPSBmaWxsU3R5bGVDYWxsYmFjayhib3R0b20sIHRvcCk7CiAgICAgICAgICAgICAgICBjLmZpbGxSZWN0KGxlZnQsIHRvcCwgcmlnaHQgLSBsZWZ0LCBib3R0b20gLSB0b3ApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGRyYXcgb3V0bGluZQogICAgICAgICAgICBpZiAobGluZVdpZHRoID4gMCAmJiAoZHJhd0xlZnQgfHwgZHJhd1JpZ2h0IHx8IGRyYXdUb3AgfHwgZHJhd0JvdHRvbSkpIHsKICAgICAgICAgICAgICAgIGMuYmVnaW5QYXRoKCk7CgogICAgICAgICAgICAgICAgLy8gRklYTUU6IGlubGluZSBtb3ZlVG8gaXMgYnVnZ3kgd2l0aCBleGNhbnZhcwogICAgICAgICAgICAgICAgYy5tb3ZlVG8obGVmdCwgYm90dG9tKTsKICAgICAgICAgICAgICAgIGlmIChkcmF3TGVmdCkKICAgICAgICAgICAgICAgICAgICBjLmxpbmVUbyhsZWZ0LCB0b3ApOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGMubW92ZVRvKGxlZnQsIHRvcCk7CiAgICAgICAgICAgICAgICBpZiAoZHJhd1RvcCkKICAgICAgICAgICAgICAgICAgICBjLmxpbmVUbyhyaWdodCwgdG9wKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjLm1vdmVUbyhyaWdodCwgdG9wKTsKICAgICAgICAgICAgICAgIGlmIChkcmF3UmlnaHQpCiAgICAgICAgICAgICAgICAgICAgYy5saW5lVG8ocmlnaHQsIGJvdHRvbSk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgYy5tb3ZlVG8ocmlnaHQsIGJvdHRvbSk7CiAgICAgICAgICAgICAgICBpZiAoZHJhd0JvdHRvbSkKICAgICAgICAgICAgICAgICAgICBjLmxpbmVUbyhsZWZ0LCBib3R0b20pOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGMubW92ZVRvKGxlZnQsIGJvdHRvbSk7CiAgICAgICAgICAgICAgICBjLnN0cm9rZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkcmF3U2VyaWVzQmFycyhzZXJpZXMpIHsKICAgICAgICAgICAgZnVuY3Rpb24gcGxvdEJhcnMoZGF0YXBvaW50cywgYmFyTGVmdCwgYmFyUmlnaHQsIGZpbGxTdHlsZUNhbGxiYWNrLCBheGlzeCwgYXhpc3kpIHsKICAgICAgICAgICAgICAgIHZhciBwb2ludHMgPSBkYXRhcG9pbnRzLnBvaW50cywgcHMgPSBkYXRhcG9pbnRzLnBvaW50c2l6ZTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvaW50cy5sZW5ndGg7IGkgKz0gcHMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocG9pbnRzW2ldID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIGRyYXdCYXIocG9pbnRzW2ldLCBwb2ludHNbaSArIDFdLCBwb2ludHNbaSArIDJdLCBiYXJMZWZ0LCBiYXJSaWdodCwgZmlsbFN0eWxlQ2FsbGJhY2ssIGF4aXN4LCBheGlzeSwgY3R4LCBzZXJpZXMuYmFycy5ob3Jpem9udGFsLCBzZXJpZXMuYmFycy5saW5lV2lkdGgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKHBsb3RPZmZzZXQubGVmdCwgcGxvdE9mZnNldC50b3ApOwoKICAgICAgICAgICAgLy8gRklYTUU6IGZpZ3VyZSBvdXQgYSB3YXkgdG8gYWRkIHNoYWRvd3MgKGZvciBpbnN0YW5jZSBhbG9uZyB0aGUgcmlnaHQgZWRnZSkKICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IHNlcmllcy5iYXJzLmxpbmVXaWR0aDsKICAgICAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gc2VyaWVzLmNvbG9yOwoKICAgICAgICAgICAgdmFyIGJhckxlZnQ7CgogICAgICAgICAgICBzd2l0Y2ggKHNlcmllcy5iYXJzLmFsaWduKSB7CiAgICAgICAgICAgICAgICBjYXNlICJsZWZ0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoIC8gMjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGZpbGxTdHlsZUNhbGxiYWNrID0gc2VyaWVzLmJhcnMuZmlsbCA\/IGZ1bmN0aW9uIChib3R0b20sIHRvcCkgeyByZXR1cm4gZ2V0RmlsbFN0eWxlKHNlcmllcy5iYXJzLCBzZXJpZXMuY29sb3IsIGJvdHRvbSwgdG9wKTsgfSA6IG51bGw7CiAgICAgICAgICAgIHBsb3RCYXJzKHNlcmllcy5kYXRhcG9pbnRzLCBiYXJMZWZ0LCBiYXJMZWZ0ICsgc2VyaWVzLmJhcnMuYmFyV2lkdGgsIGZpbGxTdHlsZUNhbGxiYWNrLCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcyk7CiAgICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRGaWxsU3R5bGUoZmlsbG9wdGlvbnMsIHNlcmllc0NvbG9yLCBib3R0b20sIHRvcCkgewogICAgICAgICAgICB2YXIgZmlsbCA9IGZpbGxvcHRpb25zLmZpbGw7CiAgICAgICAgICAgIGlmICghZmlsbCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwoKICAgICAgICAgICAgaWYgKGZpbGxvcHRpb25zLmZpbGxDb2xvcikKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb2xvck9yR3JhZGllbnQoZmlsbG9wdGlvbnMuZmlsbENvbG9yLCBib3R0b20sIHRvcCwgc2VyaWVzQ29sb3IpOwoKICAgICAgICAgICAgdmFyIGMgPSAkLmNvbG9yLnBhcnNlKHNlcmllc0NvbG9yKTsKICAgICAgICAgICAgYy5hID0gdHlwZW9mIGZpbGwgPT0gIm51bWJlciIgPyBmaWxsIDogMC40OwogICAgICAgICAgICBjLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICByZXR1cm4gYy50b1N0cmluZygpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0TGVnZW5kKCkgewoKICAgICAgICAgICAgaWYgKG9wdGlvbnMubGVnZW5kLmNvbnRhaW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAkKG9wdGlvbnMubGVnZW5kLmNvbnRhaW5lcikuaHRtbCgiIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlci5maW5kKCIubGVnZW5kIikucmVtb3ZlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5sZWdlbmQuc2hvdykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZnJhZ21lbnRzID0gW10sIGVudHJpZXMgPSBbXSwgcm93U3RhcnRlZCA9IGZhbHNlLAogICAgICAgICAgICAgICAgbGYgPSBvcHRpb25zLmxlZ2VuZC5sYWJlbEZvcm1hdHRlciwgcywgbGFiZWw7CgogICAgICAgICAgICAvLyBCdWlsZCBhIGxpc3Qgb2YgbGVnZW5kIGVudHJpZXMsIHdpdGggZWFjaCBoYXZpbmcgYSBsYWJlbCBhbmQgYSBjb2xvcgoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHMgPSBzZXJpZXNbaV07CiAgICAgICAgICAgICAgICBpZiAocy5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgIGxhYmVsID0gbGYgPyBsZihzLmxhYmVsLCBzKSA6IHMubGFiZWw7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogcy5jb2xvcgogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNvcnQgdGhlIGxlZ2VuZCB1c2luZyBlaXRoZXIgdGhlIGRlZmF1bHQgb3IgYSBjdXN0b20gY29tcGFyYXRvcgoKICAgICAgICAgICAgaWYgKG9wdGlvbnMubGVnZW5kLnNvcnRlZCkgewogICAgICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihvcHRpb25zLmxlZ2VuZC5zb3J0ZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgZW50cmllcy5zb3J0KG9wdGlvbnMubGVnZW5kLnNvcnRlZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMubGVnZW5kLnNvcnRlZCA9PSAicmV2ZXJzZSIpIHsKICAgICAgICAgICAgICAgIAllbnRyaWVzLnJldmVyc2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFzY2VuZGluZyA9IG9wdGlvbnMubGVnZW5kLnNvcnRlZCAhPSAiZGVzY2VuZGluZyI7CiAgICAgICAgICAgICAgICAgICAgZW50cmllcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEubGFiZWwgPT0gYi5sYWJlbCA\/IDAgOiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYS5sYWJlbCA8IGIubGFiZWwpICE9IGFzY2VuZGluZyA\/IDEgOiAtMSAgIC8vIExvZ2ljYWwgWE9SCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEdlbmVyYXRlIG1hcmt1cCBmb3IgdGhlIGxpc3Qgb2YgZW50cmllcywgaW4gdGhlaXIgZmluYWwgb3JkZXIKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZW50cmllcy5sZW5ndGg7ICsraSkgewoKICAgICAgICAgICAgICAgIHZhciBlbnRyeSA9IGVudHJpZXNbaV07CgogICAgICAgICAgICAgICAgaWYgKGkgJSBvcHRpb25zLmxlZ2VuZC5ub0NvbHVtbnMgPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChyb3dTdGFydGVkKQogICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudHMucHVzaCgnPC90cj4nKTsKICAgICAgICAgICAgICAgICAgICBmcmFnbWVudHMucHVzaCgnPHRyPicpOwogICAgICAgICAgICAgICAgICAgIHJvd1N0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZyYWdtZW50cy5wdXNoKAogICAgICAgICAgICAgICAgICAgICc8dGQgY2xhc3M9ImxlZ2VuZENvbG9yQm94Ij48ZGl2IHN0eWxlPSJib3JkZXI6MXB4IHNvbGlkICcgKyBvcHRpb25zLmxlZ2VuZC5sYWJlbEJveEJvcmRlckNvbG9yICsgJztwYWRkaW5nOjFweCI+PGRpdiBzdHlsZT0id2lkdGg6NHB4O2hlaWdodDowO2JvcmRlcjo1cHggc29saWQgJyArIGVudHJ5LmNvbG9yICsgJztvdmVyZmxvdzpoaWRkZW4iPjwvZGl2PjwvZGl2PjwvdGQ+JyArCiAgICAgICAgICAgICAgICAgICAgJzx0ZCBjbGFzcz0ibGVnZW5kTGFiZWwiPicgKyBlbnRyeS5sYWJlbCArICc8L3RkPicKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChyb3dTdGFydGVkKQogICAgICAgICAgICAgICAgZnJhZ21lbnRzLnB1c2goJzwvdHI+Jyk7CgogICAgICAgICAgICBpZiAoZnJhZ21lbnRzLmxlbmd0aCA9PSAwKQogICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgdmFyIHRhYmxlID0gJzx0YWJsZSBzdHlsZT0iZm9udC1zaXplOnNtYWxsZXI7Y29sb3I6JyArIG9wdGlvbnMuZ3JpZC5jb2xvciArICciPicgKyBmcmFnbWVudHMuam9pbigiIikgKyAnPC90YWJsZT4nOwogICAgICAgICAgICBpZiAob3B0aW9ucy5sZWdlbmQuY29udGFpbmVyICE9IG51bGwpCiAgICAgICAgICAgICAgICAkKG9wdGlvbnMubGVnZW5kLmNvbnRhaW5lcikuaHRtbCh0YWJsZSk7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHBvcyA9ICIiLAogICAgICAgICAgICAgICAgICAgIHAgPSBvcHRpb25zLmxlZ2VuZC5wb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICBtID0gb3B0aW9ucy5sZWdlbmQubWFyZ2luOwogICAgICAgICAgICAgICAgaWYgKG1bMF0gPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICBtID0gW20sIG1dOwogICAgICAgICAgICAgICAgaWYgKHAuY2hhckF0KDApID09ICJuIikKICAgICAgICAgICAgICAgICAgICBwb3MgKz0gJ3RvcDonICsgKG1bMV0gKyBwbG90T2Zmc2V0LnRvcCkgKyAncHg7JzsKICAgICAgICAgICAgICAgIGVsc2UgaWYgKHAuY2hhckF0KDApID09ICJzIikKICAgICAgICAgICAgICAgICAgICBwb3MgKz0gJ2JvdHRvbTonICsgKG1bMV0gKyBwbG90T2Zmc2V0LmJvdHRvbSkgKyAncHg7JzsKICAgICAgICAgICAgICAgIGlmIChwLmNoYXJBdCgxKSA9PSAiZSIpCiAgICAgICAgICAgICAgICAgICAgcG9zICs9ICdyaWdodDonICsgKG1bMF0gKyBwbG90T2Zmc2V0LnJpZ2h0KSArICdweDsnOwogICAgICAgICAgICAgICAgZWxzZSBpZiAocC5jaGFyQXQoMSkgPT0gInciKQogICAgICAgICAgICAgICAgICAgIHBvcyArPSAnbGVmdDonICsgKG1bMF0gKyBwbG90T2Zmc2V0LmxlZnQpICsgJ3B4Oyc7CiAgICAgICAgICAgICAgICB2YXIgbGVnZW5kID0gJCgnPGRpdiBjbGFzcz0ibGVnZW5kIj4nICsgdGFibGUucmVwbGFjZSgnc3R5bGU9IicsICdzdHlsZT0icG9zaXRpb246YWJzb2x1dGU7JyArIHBvcyArJzsnKSArICc8L2Rpdj4nKS5hcHBlbmRUbyhwbGFjZWhvbGRlcik7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5sZWdlbmQuYmFja2dyb3VuZE9wYWNpdHkgIT0gMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcHV0IGluIHRoZSB0cmFuc3BhcmVudCBiYWNrZ3JvdW5kCiAgICAgICAgICAgICAgICAgICAgLy8gc2VwYXJhdGVseSB0byBhdm9pZCBibGVuZGVkIGxhYmVscyBhbmQKICAgICAgICAgICAgICAgICAgICAvLyBsYWJlbCBib3hlcwogICAgICAgICAgICAgICAgICAgIHZhciBjID0gb3B0aW9ucy5sZWdlbmQuYmFja2dyb3VuZENvbG9yOwogICAgICAgICAgICAgICAgICAgIGlmIChjID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYyA9IG9wdGlvbnMuZ3JpZC5iYWNrZ3JvdW5kQ29sb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjICYmIHR5cGVvZiBjID09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYyA9ICQuY29sb3IucGFyc2UoYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMgPSAkLmNvbG9yLmV4dHJhY3QobGVnZW5kLCAnYmFja2dyb3VuZC1jb2xvcicpOwogICAgICAgICAgICAgICAgICAgICAgICBjLmEgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBjID0gYy50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgZGl2ID0gbGVnZW5kLmNoaWxkcmVuKCk7CiAgICAgICAgICAgICAgICAgICAgJCgnPGRpdiBzdHlsZT0icG9zaXRpb246YWJzb2x1dGU7d2lkdGg6JyArIGRpdi53aWR0aCgpICsgJ3B4O2hlaWdodDonICsgZGl2LmhlaWdodCgpICsgJ3B4OycgKyBwb3MgKydiYWNrZ3JvdW5kLWNvbG9yOicgKyBjICsgJzsiPiA8L2Rpdj4nKS5wcmVwZW5kVG8obGVnZW5kKS5jc3MoJ29wYWNpdHknLCBvcHRpb25zLmxlZ2VuZC5iYWNrZ3JvdW5kT3BhY2l0eSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICAvLyBpbnRlcmFjdGl2ZSBmZWF0dXJlcwoKICAgICAgICB2YXIgaGlnaGxpZ2h0cyA9IFtdLAogICAgICAgICAgICByZWRyYXdUaW1lb3V0ID0gbnVsbDsKCiAgICAgICAgLy8gcmV0dXJucyB0aGUgZGF0YSBpdGVtIHRoZSBtb3VzZSBpcyBvdmVyLCBvciBudWxsIGlmIG5vbmUgaXMgZm91bmQKICAgICAgICBmdW5jdGlvbiBmaW5kTmVhcmJ5SXRlbShtb3VzZVgsIG1vdXNlWSwgc2VyaWVzRmlsdGVyKSB7CiAgICAgICAgICAgIHZhciBtYXhEaXN0YW5jZSA9IG9wdGlvbnMuZ3JpZC5tb3VzZUFjdGl2ZVJhZGl1cywKICAgICAgICAgICAgICAgIHNtYWxsZXN0RGlzdGFuY2UgPSBtYXhEaXN0YW5jZSAqIG1heERpc3RhbmNlICsgMSwKICAgICAgICAgICAgICAgIGl0ZW0gPSBudWxsLCBmb3VuZFBvaW50ID0gZmFsc2UsIGksIGosIHBzOwoKICAgICAgICAgICAgZm9yIChpID0gc2VyaWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgICAgICBpZiAoIXNlcmllc0ZpbHRlcihzZXJpZXNbaV0pKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBzID0gc2VyaWVzW2ldLAogICAgICAgICAgICAgICAgICAgIGF4aXN4ID0gcy54YXhpcywKICAgICAgICAgICAgICAgICAgICBheGlzeSA9IHMueWF4aXMsCiAgICAgICAgICAgICAgICAgICAgcG9pbnRzID0gcy5kYXRhcG9pbnRzLnBvaW50cywKICAgICAgICAgICAgICAgICAgICBteCA9IGF4aXN4LmMycChtb3VzZVgpLCAvLyBwcmVjb21wdXRlIHNvbWUgc3R1ZmYgdG8gbWFrZSB0aGUgbG9vcCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICBteSA9IGF4aXN5LmMycChtb3VzZVkpLAogICAgICAgICAgICAgICAgICAgIG1heHggPSBtYXhEaXN0YW5jZSAvIGF4aXN4LnNjYWxlLAogICAgICAgICAgICAgICAgICAgIG1heHkgPSBtYXhEaXN0YW5jZSAvIGF4aXN5LnNjYWxlOwoKICAgICAgICAgICAgICAgIHBzID0gcy5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKICAgICAgICAgICAgICAgIC8vIHdpdGggaW52ZXJzZSB0cmFuc2Zvcm1zLCB3ZSBjYW4ndCB1c2UgdGhlIG1heHgvbWF4eQogICAgICAgICAgICAgICAgLy8gb3B0aW1pemF0aW9uLCBzYWRseQogICAgICAgICAgICAgICAgaWYgKGF4aXN4Lm9wdGlvbnMuaW52ZXJzZVRyYW5zZm9ybSkKICAgICAgICAgICAgICAgICAgICBtYXh4ID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICAgICAgICAgIGlmIChheGlzeS5vcHRpb25zLmludmVyc2VUcmFuc2Zvcm0pCiAgICAgICAgICAgICAgICAgICAgbWF4eSA9IE51bWJlci5NQVhfVkFMVUU7CgogICAgICAgICAgICAgICAgaWYgKHMubGluZXMuc2hvdyB8fCBzLnBvaW50cy5zaG93KSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHBvaW50cy5sZW5ndGg7IGogKz0gcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHggPSBwb2ludHNbal0sIHkgPSBwb2ludHNbaiArIDFdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGb3IgcG9pbnRzIGFuZCBsaW5lcywgdGhlIGN1cnNvciBtdXN0IGJlIHdpdGhpbiBhCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNlcnRhaW4gZGlzdGFuY2UgdG8gdGhlIGRhdGEgcG9pbnQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggLSBteCA+IG1heHggfHwgeCAtIG14IDwgLW1heHggfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgLSBteSA+IG1heHkgfHwgeSAtIG15IDwgLW1heHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgdG8gY2FsY3VsYXRlIGRpc3RhbmNlcyBpbiBwaXhlbHMsIG5vdCBpbgogICAgICAgICAgICAgICAgICAgICAgICAvLyBkYXRhIHVuaXRzLCBiZWNhdXNlIHRoZSBzY2FsZXMgb2YgdGhlIGF4ZXMgbWF5IGJlIGRpZmZlcmVudAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHggPSBNYXRoLmFicyhheGlzeC5wMmMoeCkgLSBtb3VzZVgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHkgPSBNYXRoLmFicyhheGlzeS5wMmMoeSkgLSBtb3VzZVkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzdCA9IGR4ICogZHggKyBkeSAqIGR5OyAvLyB3ZSBzYXZlIHRoZSBzcXJ0CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB1c2UgPD0gdG8gZW5zdXJlIGxhc3QgcG9pbnQgdGFrZXMgcHJlY2VkZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAvLyAobGFzdCBnZW5lcmFsbHkgbWVhbnMgb24gdG9wIG9mKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA8IHNtYWxsZXN0RGlzdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNtYWxsZXN0RGlzdGFuY2UgPSBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IFtpLCBqIC8gcHNdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzLmJhcnMuc2hvdyAmJiAhaXRlbSkgeyAvLyBubyBvdGhlciBwb2ludCBjYW4gYmUgbmVhcmJ5CgogICAgICAgICAgICAgICAgICAgIHZhciBiYXJMZWZ0LCBiYXJSaWdodDsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChzLmJhcnMuYWxpZ24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAibGVmdCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyaWdodCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLXMuYmFycy5iYXJXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFyTGVmdCA9IC1zLmJhcnMuYmFyV2lkdGggLyAyOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgYmFyUmlnaHQgPSBiYXJMZWZ0ICsgcy5iYXJzLmJhcldpZHRoOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgcG9pbnRzLmxlbmd0aDsgaiArPSBwcykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgeCA9IHBvaW50c1tqXSwgeSA9IHBvaW50c1tqICsgMV0sIGIgPSBwb2ludHNbaiArIDJdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeCA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3IgYSBiYXIgZ3JhcGgsIHRoZSBjdXJzb3IgbXVzdCBiZSBpbnNpZGUgdGhlIGJhcgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VyaWVzW2ldLmJhcnMuaG9yaXpvbnRhbCA\/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobXggPD0gTWF0aC5tYXgoYiwgeCkgJiYgbXggPj0gTWF0aC5taW4oYiwgeCkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteSA+PSB5ICsgYmFyTGVmdCAmJiBteSA8PSB5ICsgYmFyUmlnaHQpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChteCA+PSB4ICsgYmFyTGVmdCAmJiBteCA8PSB4ICsgYmFyUmlnaHQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteSA+PSBNYXRoLm1pbihiLCB5KSAmJiBteSA8PSBNYXRoLm1heChiLCB5KSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IFtpLCBqIC8gcHNdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICAgIGkgPSBpdGVtWzBdOwogICAgICAgICAgICAgICAgaiA9IGl0ZW1bMV07CiAgICAgICAgICAgICAgICBwcyA9IHNlcmllc1tpXS5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKCiAgICAgICAgICAgICAgICByZXR1cm4geyBkYXRhcG9pbnQ6IHNlcmllc1tpXS5kYXRhcG9pbnRzLnBvaW50cy5zbGljZShqICogcHMsIChqICsgMSkgKiBwcyksCiAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhSW5kZXg6IGosCiAgICAgICAgICAgICAgICAgICAgICAgICBzZXJpZXM6IHNlcmllc1tpXSwKICAgICAgICAgICAgICAgICAgICAgICAgIHNlcmllc0luZGV4OiBpIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25Nb3VzZU1vdmUoZSkgewogICAgICAgICAgICBpZiAob3B0aW9ucy5ncmlkLmhvdmVyYWJsZSkKICAgICAgICAgICAgICAgIHRyaWdnZXJDbGlja0hvdmVyRXZlbnQoInBsb3Rob3ZlciIsIGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzKSB7IHJldHVybiBzWyJob3ZlcmFibGUiXSAhPSBmYWxzZTsgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbk1vdXNlTGVhdmUoZSkgewogICAgICAgICAgICBpZiAob3B0aW9ucy5ncmlkLmhvdmVyYWJsZSkKICAgICAgICAgICAgICAgIHRyaWdnZXJDbGlja0hvdmVyRXZlbnQoInBsb3Rob3ZlciIsIGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChzKSB7IHJldHVybiBmYWxzZTsgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkNsaWNrKGUpIHsKICAgICAgICAgICAgdHJpZ2dlckNsaWNrSG92ZXJFdmVudCgicGxvdGNsaWNrIiwgZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocykgeyByZXR1cm4gc1siY2xpY2thYmxlIl0gIT0gZmFsc2U7IH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gdHJpZ2dlciBjbGljayBvciBob3ZlciBldmVudCAodGhleSBzZW5kIHRoZSBzYW1lIHBhcmFtZXRlcnMKICAgICAgICAvLyBzbyB3ZSBzaGFyZSB0aGVpciBjb2RlKQogICAgICAgIGZ1bmN0aW9uIHRyaWdnZXJDbGlja0hvdmVyRXZlbnQoZXZlbnRuYW1lLCBldmVudCwgc2VyaWVzRmlsdGVyKSB7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSBldmVudEhvbGRlci5vZmZzZXQoKSwKICAgICAgICAgICAgICAgIGNhbnZhc1ggPSBldmVudC5wYWdlWCAtIG9mZnNldC5sZWZ0IC0gcGxvdE9mZnNldC5sZWZ0LAogICAgICAgICAgICAgICAgY2FudmFzWSA9IGV2ZW50LnBhZ2VZIC0gb2Zmc2V0LnRvcCAtIHBsb3RPZmZzZXQudG9wLAogICAgICAgICAgICBwb3MgPSBjYW52YXNUb0F4aXNDb29yZHMoeyBsZWZ0OiBjYW52YXNYLCB0b3A6IGNhbnZhc1kgfSk7CgogICAgICAgICAgICBwb3MucGFnZVggPSBldmVudC5wYWdlWDsKICAgICAgICAgICAgcG9zLnBhZ2VZID0gZXZlbnQucGFnZVk7CgogICAgICAgICAgICB2YXIgaXRlbSA9IGZpbmROZWFyYnlJdGVtKGNhbnZhc1gsIGNhbnZhc1ksIHNlcmllc0ZpbHRlcik7CgogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgLy8gZmlsbCBpbiBtb3VzZSBwb3MgZm9yIGFueSBsaXN0ZW5lcnMgb3V0IHRoZXJlCiAgICAgICAgICAgICAgICBpdGVtLnBhZ2VYID0gcGFyc2VJbnQoaXRlbS5zZXJpZXMueGF4aXMucDJjKGl0ZW0uZGF0YXBvaW50WzBdKSArIG9mZnNldC5sZWZ0ICsgcGxvdE9mZnNldC5sZWZ0LCAxMCk7CiAgICAgICAgICAgICAgICBpdGVtLnBhZ2VZID0gcGFyc2VJbnQoaXRlbS5zZXJpZXMueWF4aXMucDJjKGl0ZW0uZGF0YXBvaW50WzFdKSArIG9mZnNldC50b3AgKyBwbG90T2Zmc2V0LnRvcCwgMTApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5ncmlkLmF1dG9IaWdobGlnaHQpIHsKICAgICAgICAgICAgICAgIC8vIGNsZWFyIGF1dG8taGlnaGxpZ2h0cwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoaWdobGlnaHRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGggPSBoaWdobGlnaHRzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmIChoLmF1dG8gPT0gZXZlbnRuYW1lICYmCiAgICAgICAgICAgICAgICAgICAgICAgICEoaXRlbSAmJiBoLnNlcmllcyA9PSBpdGVtLnNlcmllcyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIGgucG9pbnRbMF0gPT0gaXRlbS5kYXRhcG9pbnRbMF0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICBoLnBvaW50WzFdID09IGl0ZW0uZGF0YXBvaW50WzFdKSkKICAgICAgICAgICAgICAgICAgICAgICAgdW5oaWdobGlnaHQoaC5zZXJpZXMsIGgucG9pbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChpdGVtKQogICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodChpdGVtLnNlcmllcywgaXRlbS5kYXRhcG9pbnQsIGV2ZW50bmFtZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBsYWNlaG9sZGVyLnRyaWdnZXIoZXZlbnRuYW1lLCBbIHBvcywgaXRlbSBdKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRyaWdnZXJSZWRyYXdPdmVybGF5KCkgewogICAgICAgICAgICB2YXIgdCA9IG9wdGlvbnMuaW50ZXJhY3Rpb24ucmVkcmF3T3ZlcmxheUludGVydmFsOwogICAgICAgICAgICBpZiAodCA9PSAtMSkgeyAgICAgIC8vIHNraXAgZXZlbnQgcXVldWUKICAgICAgICAgICAgICAgIGRyYXdPdmVybGF5KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghcmVkcmF3VGltZW91dCkKICAgICAgICAgICAgICAgIHJlZHJhd1RpbWVvdXQgPSBzZXRUaW1lb3V0KGRyYXdPdmVybGF5LCB0KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRyYXdPdmVybGF5KCkgewogICAgICAgICAgICByZWRyYXdUaW1lb3V0ID0gbnVsbDsKCiAgICAgICAgICAgIC8vIGRyYXcgaGlnaGxpZ2h0cwogICAgICAgICAgICBvY3R4LnNhdmUoKTsKICAgICAgICAgICAgb3ZlcmxheS5jbGVhcigpOwogICAgICAgICAgICBvY3R4LnRyYW5zbGF0ZShwbG90T2Zmc2V0LmxlZnQsIHBsb3RPZmZzZXQudG9wKTsKCiAgICAgICAgICAgIHZhciBpLCBoaTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhpZ2hsaWdodHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGhpID0gaGlnaGxpZ2h0c1tpXTsKCiAgICAgICAgICAgICAgICBpZiAoaGkuc2VyaWVzLmJhcnMuc2hvdykKICAgICAgICAgICAgICAgICAgICBkcmF3QmFySGlnaGxpZ2h0KGhpLnNlcmllcywgaGkucG9pbnQpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGRyYXdQb2ludEhpZ2hsaWdodChoaS5zZXJpZXMsIGhpLnBvaW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvY3R4LnJlc3RvcmUoKTsKCiAgICAgICAgICAgIGV4ZWN1dGVIb29rcyhob29rcy5kcmF3T3ZlcmxheSwgW29jdHhdKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGhpZ2hsaWdodChzLCBwb2ludCwgYXV0bykgewogICAgICAgICAgICBpZiAodHlwZW9mIHMgPT0gIm51bWJlciIpCiAgICAgICAgICAgICAgICBzID0gc2VyaWVzW3NdOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBwb2ludCA9PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgdmFyIHBzID0gcy5kYXRhcG9pbnRzLnBvaW50c2l6ZTsKICAgICAgICAgICAgICAgIHBvaW50ID0gcy5kYXRhcG9pbnRzLnBvaW50cy5zbGljZShwcyAqIHBvaW50LCBwcyAqIChwb2ludCArIDEpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGkgPSBpbmRleE9mSGlnaGxpZ2h0KHMsIHBvaW50KTsKICAgICAgICAgICAgaWYgKGkgPT0gLTEpIHsKICAgICAgICAgICAgICAgIGhpZ2hsaWdodHMucHVzaCh7IHNlcmllczogcywgcG9pbnQ6IHBvaW50LCBhdXRvOiBhdXRvIH0pOwoKICAgICAgICAgICAgICAgIHRyaWdnZXJSZWRyYXdPdmVybGF5KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoIWF1dG8pCiAgICAgICAgICAgICAgICBoaWdobGlnaHRzW2ldLmF1dG8gPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVuaGlnaGxpZ2h0KHMsIHBvaW50KSB7CiAgICAgICAgICAgIGlmIChzID09IG51bGwgJiYgcG9pbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaGlnaGxpZ2h0cyA9IFtdOwogICAgICAgICAgICAgICAgdHJpZ2dlclJlZHJhd092ZXJsYXkoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBzID09ICJudW1iZXIiKQogICAgICAgICAgICAgICAgcyA9IHNlcmllc1tzXTsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgcG9pbnQgPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHZhciBwcyA9IHMuZGF0YXBvaW50cy5wb2ludHNpemU7CiAgICAgICAgICAgICAgICBwb2ludCA9IHMuZGF0YXBvaW50cy5wb2ludHMuc2xpY2UocHMgKiBwb2ludCwgcHMgKiAocG9pbnQgKyAxKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpID0gaW5kZXhPZkhpZ2hsaWdodChzLCBwb2ludCk7CiAgICAgICAgICAgIGlmIChpICE9IC0xKSB7CiAgICAgICAgICAgICAgICBoaWdobGlnaHRzLnNwbGljZShpLCAxKTsKCiAgICAgICAgICAgICAgICB0cmlnZ2VyUmVkcmF3T3ZlcmxheSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpbmRleE9mSGlnaGxpZ2h0KHMsIHApIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoaWdobGlnaHRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgaCA9IGhpZ2hsaWdodHNbaV07CiAgICAgICAgICAgICAgICBpZiAoaC5zZXJpZXMgPT0gcyAmJiBoLnBvaW50WzBdID09IHBbMF0KICAgICAgICAgICAgICAgICAgICAmJiBoLnBvaW50WzFdID09IHBbMV0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZHJhd1BvaW50SGlnaGxpZ2h0KHNlcmllcywgcG9pbnQpIHsKICAgICAgICAgICAgdmFyIHggPSBwb2ludFswXSwgeSA9IHBvaW50WzFdLAogICAgICAgICAgICAgICAgYXhpc3ggPSBzZXJpZXMueGF4aXMsIGF4aXN5ID0gc2VyaWVzLnlheGlzLAogICAgICAgICAgICAgICAgaGlnaGxpZ2h0Q29sb3IgPSAodHlwZW9mIHNlcmllcy5oaWdobGlnaHRDb2xvciA9PT0gInN0cmluZyIpID8gc2VyaWVzLmhpZ2hsaWdodENvbG9yIDogJC5jb2xvci5wYXJzZShzZXJpZXMuY29sb3IpLnNjYWxlKCdhJywgMC41KS50b1N0cmluZygpOwoKICAgICAgICAgICAgaWYgKHggPCBheGlzeC5taW4gfHwgeCA+IGF4aXN4Lm1heCB8fCB5IDwgYXhpc3kubWluIHx8IHkgPiBheGlzeS5tYXgpCiAgICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICB2YXIgcG9pbnRSYWRpdXMgPSBzZXJpZXMucG9pbnRzLnJhZGl1cyArIHNlcmllcy5wb2ludHMubGluZVdpZHRoIC8gMjsKICAgICAgICAgICAgb2N0eC5saW5lV2lkdGggPSBwb2ludFJhZGl1czsKICAgICAgICAgICAgb2N0eC5zdHJva2VTdHlsZSA9IGhpZ2hsaWdodENvbG9yOwogICAgICAgICAgICB2YXIgcmFkaXVzID0gMS41ICogcG9pbnRSYWRpdXM7CiAgICAgICAgICAgIHggPSBheGlzeC5wMmMoeCk7CiAgICAgICAgICAgIHkgPSBheGlzeS5wMmMoeSk7CgogICAgICAgICAgICBvY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgICBpZiAoc2VyaWVzLnBvaW50cy5zeW1ib2wgPT0gImNpcmNsZSIpCiAgICAgICAgICAgICAgICBvY3R4LmFyYyh4LCB5LCByYWRpdXMsIDAsIDIgKiBNYXRoLlBJLCBmYWxzZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHNlcmllcy5wb2ludHMuc3ltYm9sKG9jdHgsIHgsIHksIHJhZGl1cywgZmFsc2UpOwogICAgICAgICAgICBvY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICBvY3R4LnN0cm9rZSgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZHJhd0JhckhpZ2hsaWdodChzZXJpZXMsIHBvaW50KSB7CiAgICAgICAgICAgIHZhciBoaWdobGlnaHRDb2xvciA9ICh0eXBlb2Ygc2VyaWVzLmhpZ2hsaWdodENvbG9yID09PSAic3RyaW5nIikgPyBzZXJpZXMuaGlnaGxpZ2h0Q29sb3IgOiAkLmNvbG9yLnBhcnNlKHNlcmllcy5jb2xvcikuc2NhbGUoJ2EnLCAwLjUpLnRvU3RyaW5nKCksCiAgICAgICAgICAgICAgICBmaWxsU3R5bGUgPSBoaWdobGlnaHRDb2xvciwKICAgICAgICAgICAgICAgIGJhckxlZnQ7CgogICAgICAgICAgICBzd2l0Y2ggKHNlcmllcy5iYXJzLmFsaWduKSB7CiAgICAgICAgICAgICAgICBjYXNlICJsZWZ0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gMDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJpZ2h0IjoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBiYXJMZWZ0ID0gLXNlcmllcy5iYXJzLmJhcldpZHRoIC8gMjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb2N0eC5saW5lV2lkdGggPSBzZXJpZXMuYmFycy5saW5lV2lkdGg7CiAgICAgICAgICAgIG9jdHguc3Ryb2tlU3R5bGUgPSBoaWdobGlnaHRDb2xvcjsKCiAgICAgICAgICAgIGRyYXdCYXIocG9pbnRbMF0sIHBvaW50WzFdLCBwb2ludFsyXSB8fCAwLCBiYXJMZWZ0LCBiYXJMZWZ0ICsgc2VyaWVzLmJhcnMuYmFyV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gZmlsbFN0eWxlOyB9LCBzZXJpZXMueGF4aXMsIHNlcmllcy55YXhpcywgb2N0eCwgc2VyaWVzLmJhcnMuaG9yaXpvbnRhbCwgc2VyaWVzLmJhcnMubGluZVdpZHRoKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldENvbG9yT3JHcmFkaWVudChzcGVjLCBib3R0b20sIHRvcCwgZGVmYXVsdENvbG9yKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3BlYyA9PSAic3RyaW5nIikKICAgICAgICAgICAgICAgIHJldHVybiBzcGVjOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGFzc3VtZSB0aGlzIGlzIGEgZ3JhZGllbnQgc3BlYzsgSUUgY3VycmVudGx5IG9ubHkKICAgICAgICAgICAgICAgIC8vIHN1cHBvcnRzIGEgc2ltcGxlIHZlcnRpY2FsIGdyYWRpZW50IHByb3Blcmx5LCBzbyB0aGF0J3MKICAgICAgICAgICAgICAgIC8vIHdoYXQgd2Ugc3VwcG9ydCB0b28KICAgICAgICAgICAgICAgIHZhciBncmFkaWVudCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudCgwLCB0b3AsIDAsIGJvdHRvbSk7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBzcGVjLmNvbG9ycy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IHNwZWMuY29sb3JzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYyAhPSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY28gPSAkLmNvbG9yLnBhcnNlKGRlZmF1bHRDb2xvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLmJyaWdodG5lc3MgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvID0gY28uc2NhbGUoJ3JnYicsIGMuYnJpZ2h0bmVzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLm9wYWNpdHkgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvLmEgKj0gYy5vcGFjaXR5OwogICAgICAgICAgICAgICAgICAgICAgICBjID0gY28udG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuYWRkQ29sb3JTdG9wKGkgLyAobCAtIDEpLCBjKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZ3JhZGllbnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gQWRkIHRoZSBwbG90IGZ1bmN0aW9uIHRvIHRoZSB0b3AgbGV2ZWwgb2YgdGhlIGpRdWVyeSBvYmplY3QKCiAgICAkLnBsb3QgPSBmdW5jdGlvbihwbGFjZWhvbGRlciwgZGF0YSwgb3B0aW9ucykgewogICAgICAgIC8vdmFyIHQwID0gbmV3IERhdGUoKTsKICAgICAgICB2YXIgcGxvdCA9IG5ldyBQbG90KCQocGxhY2Vob2xkZXIpLCBkYXRhLCBvcHRpb25zLCAkLnBsb3QucGx1Z2lucyk7CiAgICAgICAgLy8od2luZG93LmNvbnNvbGUgPyBjb25zb2xlLmxvZyA6IGFsZXJ0KSgidGltZSB1c2VkIChtc2Vjcyk6ICIgKyAoKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHQwLmdldFRpbWUoKSkpOwogICAgICAgIHJldHVybiBwbG90OwogICAgfTsKCiAgICAkLnBsb3QudmVyc2lvbiA9ICIwLjguMyI7CgogICAgJC5wbG90LnBsdWdpbnMgPSBbXTsKCiAgICAvLyBBbHNvIGFkZCB0aGUgcGxvdCBmdW5jdGlvbiBhcyBhIGNoYWluYWJsZSBwcm9wZXJ0eQoKICAgICQuZm4ucGxvdCA9IGZ1bmN0aW9uKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkLnBsb3QodGhpcywgZGF0YSwgb3B0aW9ucyk7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIC8vIHJvdW5kIHRvIG5lYXJieSBsb3dlciBtdWx0aXBsZSBvZiBiYXNlCiAgICBmdW5jdGlvbiBmbG9vckluQmFzZShuLCBiYXNlKSB7CiAgICAgICAgcmV0dXJuIGJhc2UgKiBNYXRoLmZsb29yKG4gLyBiYXNlKTsKICAgIH0KCn0pKGpRdWVyeSk7Cg==",
    "size": "122971"
}