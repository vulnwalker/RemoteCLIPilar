{
    "namaFile": "lib\/PHPExcel\/Classes\/PHPExcel\/Calculation\/Financial.php",
    "lastUpdate": "2017-12-25+01:39:38.00",
    "contentFile": "PD9waHAKCi8qKiBQSFBFeGNlbCByb290IGRpcmVjdG9yeSAqLwppZiAoIWRlZmluZWQoJ1BIUEVYQ0VMX1JPT1QnKSkgewogICAgLyoqCiAgICAgKiBAaWdub3JlCiAgICAgKi8KICAgIGRlZmluZSgnUEhQRVhDRUxfUk9PVCcsIGRpcm5hbWUoX19GSUxFX18pIC4gJy8uLi8uLi8nKTsKICAgIHJlcXVpcmUoUEhQRVhDRUxfUk9PVCAuICdQSFBFeGNlbC9BdXRvbG9hZGVyLnBocCcpOwp9CgovKiogRklOQU5DSUFMX01BWF9JVEVSQVRJT05TICovCmRlZmluZSgnRklOQU5DSUFMX01BWF9JVEVSQVRJT05TJywgMTI4KTsKCi8qKiBGSU5BTkNJQUxfUFJFQ0lTSU9OICovCmRlZmluZSgnRklOQU5DSUFMX1BSRUNJU0lPTicsIDEuMGUtMDgpOwoKLyoqCiAqIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0ZpbmFuY2lhbAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDYgLSAyMDE1IFBIUEV4Y2VsCiAqCiAqIFRoaXMgbGlicmFyeSBpcyBmcmVlIHNvZnR3YXJlOyB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IKICogbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYwogKiBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIKICogdmVyc2lvbiAyLjEgb2YgdGhlIExpY2Vuc2UsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiAqCiAqIFRoaXMgbGlicmFyeSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAogKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgogKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VCiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCiAqCiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMKICogTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgbGlicmFyeTsgaWYgbm90LCB3cml0ZSB0byB0aGUgRnJlZSBTb2Z0d2FyZQogKiBGb3VuZGF0aW9uLCBJbmMuLCA1MSBGcmFua2xpbiBTdHJlZXQsIEZpZnRoIEZsb29yLCBCb3N0b24sIE1BIDAyMTEwLTEzMDEgVVNBCiAqCiAqIEBjYXRlZ29yeSAgICBQSFBFeGNlbAogKiBAcGFja2FnZSAgICAgICAgUEhQRXhjZWxfQ2FsY3VsYXRpb24KICogQGNvcHlyaWdodCAgICBDb3B5cmlnaHQgKGMpIDIwMDYgLSAyMDE1IFBIUEV4Y2VsIChodHRwOi8vd3d3LmNvZGVwbGV4LmNvbS9QSFBFeGNlbCkKICogQGxpY2Vuc2UgICAgICAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9vbGQtbGljZW5zZXMvbGdwbC0yLjEudHh0ICAgIExHUEwKICogQHZlcnNpb24gICAgICAgICMjVkVSU0lPTiMjLCAjI0RBVEUjIwogKi8KY2xhc3MgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRmluYW5jaWFsCnsKICAgIC8qKgogICAgICogaXNMYXN0RGF5T2ZNb250aAogICAgICoKICAgICAqIFJldHVybnMgYSBib29sZWFuIFRSVUUvRkFMU0UgaW5kaWNhdGluZyBpZiB0aGlzIGRhdGUgaXMgdGhlIGxhc3QgZGF0ZSBvZiB0aGUgbW9udGgKICAgICAqCiAgICAgKiBAcGFyYW0gICAgRGF0ZVRpbWUgICAgJHRlc3REYXRlICAgIFRoZSBkYXRlIGZvciB0ZXN0aW5nCiAgICAgKiBAcmV0dXJuICAgIGJvb2xlYW4KICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gaXNMYXN0RGF5T2ZNb250aCgkdGVzdERhdGUpCiAgICB7CiAgICAgICAgcmV0dXJuICgkdGVzdERhdGUtPmZvcm1hdCgnZCcpID09ICR0ZXN0RGF0ZS0+Zm9ybWF0KCd0JykpOwogICAgfQoKCiAgICAvKioKICAgICAqIGlzRmlyc3REYXlPZk1vbnRoCiAgICAgKgogICAgICogUmV0dXJucyBhIGJvb2xlYW4gVFJVRS9GQUxTRSBpbmRpY2F0aW5nIGlmIHRoaXMgZGF0ZSBpcyB0aGUgZmlyc3QgZGF0ZSBvZiB0aGUgbW9udGgKICAgICAqCiAgICAgKiBAcGFyYW0gICAgRGF0ZVRpbWUgICAgJHRlc3REYXRlICAgIFRoZSBkYXRlIGZvciB0ZXN0aW5nCiAgICAgKiBAcmV0dXJuICAgIGJvb2xlYW4KICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gaXNGaXJzdERheU9mTW9udGgoJHRlc3REYXRlKQogICAgewogICAgICAgIHJldHVybiAoJHRlc3REYXRlLT5mb3JtYXQoJ2QnKSA9PSAxKTsKICAgIH0KCgogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gY291cG9uRmlyc3RQZXJpb2REYXRlKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksICRuZXh0KQogICAgewogICAgICAgICRtb250aHMgPSAxMiAvICRmcmVxdWVuY3k7CgogICAgICAgICRyZXN1bHQgPSBQSFBFeGNlbF9TaGFyZWRfRGF0ZTo6RXhjZWxUb1BIUE9iamVjdCgkbWF0dXJpdHkpOwogICAgICAgICRlb20gPSBzZWxmOjppc0xhc3REYXlPZk1vbnRoKCRyZXN1bHQpOwoKICAgICAgICB3aGlsZSAoJHNldHRsZW1lbnQgPCBQSFBFeGNlbF9TaGFyZWRfRGF0ZTo6UEhQVG9FeGNlbCgkcmVzdWx0KSkgewogICAgICAgICAgICAkcmVzdWx0LT5tb2RpZnkoJy0nLiRtb250aHMuJyBtb250aHMnKTsKICAgICAgICB9CiAgICAgICAgaWYgKCRuZXh0KSB7CiAgICAgICAgICAgICRyZXN1bHQtPm1vZGlmeSgnKycuJG1vbnRocy4nIG1vbnRocycpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCRlb20pIHsKICAgICAgICAgICAgJHJlc3VsdC0+bW9kaWZ5KCctMSBkYXknKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBQSFBFeGNlbF9TaGFyZWRfRGF0ZTo6UEhQVG9FeGNlbCgkcmVzdWx0KTsKICAgIH0KCgogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gaXNWYWxpZEZyZXF1ZW5jeSgkZnJlcXVlbmN5KQogICAgewogICAgICAgIGlmICgoJGZyZXF1ZW5jeSA9PSAxKSB8fCAoJGZyZXF1ZW5jeSA9PSAyKSB8fCAoJGZyZXF1ZW5jeSA9PSA0KSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmdldENvbXBhdGliaWxpdHlNb2RlKCkgPT0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpDT01QQVRJQklMSVRZX0dOVU1FUklDKSAmJgogICAgICAgICAgICAoKCRmcmVxdWVuY3kgPT0gNikgfHwgKCRmcmVxdWVuY3kgPT0gMTIpKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKCiAgICAvKioKICAgICAqIGRheXNQZXJZZWFyCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIGRheXMgaW4gYSBzcGVjaWZpZWQgeWVhciwgYXMgZGVmaW5lZCBieSB0aGUgImJhc2lzIiB2YWx1ZQogICAgICoKICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICAgICAkeWVhciAgICBUaGUgeWVhciBhZ2FpbnN0IHdoaWNoIHdlJ3JlIHRlc3RpbmcKICAgICAqIEBwYXJhbSAgIGludGVnZXIgICAgICAgICRiYXNpcyAgICBUaGUgdHlwZSBvZiBkYXkgY291bnQ6CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCBVUyAoTkFTRCkgICAgMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgICAgICAgICBBY3R1YWwgKDM2NSBvciAzNjYgaW4gYSBsZWFwIHllYXIpCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgICAgICAgICAzNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICAgICAgICAgIDM2NQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgICAgICAgICAgRXVyb3BlYW4gMzYwCiAgICAgKiBAcmV0dXJuICAgIGludGVnZXIKICAgICAqLwogICAgcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gZGF5c1BlclllYXIoJHllYXIsICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgc3dpdGNoICgkYmFzaXMpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICRkYXlzUGVyWWVhciA9IDM2MDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAkZGF5c1BlclllYXIgPSAzNjU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgJGRheXNQZXJZZWFyID0gKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjppc0xlYXBZZWFyKCR5ZWFyKSkgPyAzNjYgOiAzNjU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJGRheXNQZXJZZWFyOwogICAgfQoKCiAgICBwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBpbnRlcmVzdEFuZFByaW5jaXBhbCgkcmF0ZSA9IDAsICRwZXIgPSAwLCAkbnBlciA9IDAsICRwdiA9IDAsICRmdiA9IDAsICR0eXBlID0gMCkKICAgIHsKICAgICAgICAkcG10ID0gc2VsZjo6UE1UKCRyYXRlLCAkbnBlciwgJHB2LCAkZnYsICR0eXBlKTsKICAgICAgICAkY2FwaXRhbCA9ICRwdjsKICAgICAgICBmb3IgKCRpID0gMTsgJGk8PSAkcGVyOyArKyRpKSB7CiAgICAgICAgICAgICRpbnRlcmVzdCA9ICgkdHlwZSAmJiAkaSA9PSAxKSA\/IDAgOiAtJGNhcGl0YWwgKiAkcmF0ZTsKICAgICAgICAgICAgJHByaW5jaXBhbCA9ICRwbXQgLSAkaW50ZXJlc3Q7CiAgICAgICAgICAgICRjYXBpdGFsICs9ICRwcmluY2lwYWw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcnJheSgkaW50ZXJlc3QsICRwcmluY2lwYWwpOwogICAgfQoKCiAgICAvKioKICAgICAqIEFDQ1JJTlQKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBhY2NydWVkIGludGVyZXN0IGZvciBhIHNlY3VyaXR5IHRoYXQgcGF5cyBwZXJpb2RpYyBpbnRlcmVzdC4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBBQ0NSSU5UKGlzc3VlLGZpcnN0aW50ZXJlc3Qsc2V0dGxlbWVudCxyYXRlLHBhcixmcmVxdWVuY3lbLGJhc2lzXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IEZpbmFuY2lhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICAkaXNzdWUgICAgICAgICAgICBUaGUgc2VjdXJpdHkncyBpc3N1ZSBkYXRlLgogICAgICogQHBhcmFtICAgIG1peGVkICAgICRmaXJzdGludGVyZXN0ICAgIFRoZSBzZWN1cml0eSdzIGZpcnN0IGludGVyZXN0IGRhdGUuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgJHNldHRsZW1lbnQgICAgICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHNlY3VyaXR5IHNldHRsZW1lbnQgZGF0ZSBpcyB0aGUgZGF0ZSBhZnRlciB0aGUgaXNzdWUgZGF0ZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGVuIHRoZSBzZWN1cml0eSBpcyB0cmFkZWQgdG8gdGhlIGJ1eWVyLgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRyYXRlICAgICAgICAgICAgVGhlIHNlY3VyaXR5J3MgYW5udWFsIGNvdXBvbiByYXRlLgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRwYXIgICAgICAgICAgICBUaGUgc2VjdXJpdHkncyBwYXIgdmFsdWUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElmIHlvdSBvbWl0IHBhciwgQUNDUklOVCB1c2VzICQxLDAwMC4KICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICRmcmVxdWVuY3kgICAgICAgIHRoZSBudW1iZXIgb2YgY291cG9uIHBheW1lbnRzIHBlciB5ZWFyLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBWYWxpZCBmcmVxdWVuY3kgdmFsdWVzIGFyZToKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICAgIFNlbWktQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgIFF1YXJ0ZXJseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB3b3JraW5nIGluIEdudW1lcmljIE1vZGUsIHRoZSBmb2xsb3dpbmcgZnJlcXVlbmN5IG9wdGlvbnMgYXJlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsc28gYXZhaWxhYmxlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA2ICAgIEJpbW9udGhseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTIgICAgTW9udGhseQogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgJGJhc2lzICAgICAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEFDQ1JJTlQoJGlzc3VlLCAkZmlyc3RpbnRlcmVzdCwgJHNldHRsZW1lbnQsICRyYXRlLCAkcGFyID0gMTAwMCwgJGZyZXF1ZW5jeSA9IDEsICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgJGlzc3VlICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRpc3N1ZSk7CiAgICAgICAgJGZpcnN0aW50ZXJlc3QgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZmlyc3RpbnRlcmVzdCk7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJHJhdGUgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJhdGUpOwogICAgICAgICRwYXIgICAgICAgID0gKGlzX251bGwoJHBhcikpICAgICAgICA\/IDEwMDAgOiAgICBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcGFyKTsKICAgICAgICAkZnJlcXVlbmN5ICAgID0gKGlzX251bGwoJGZyZXF1ZW5jeSkpICAgID8gMSAgICA6ICAgICAgICAgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZyZXF1ZW5jeSk7CiAgICAgICAgJGJhc2lzICAgICAgICA9IChpc19udWxsKCRiYXNpcykpICAgICAgICA\/IDAgICAgOiAgICAgICAgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGJhc2lzKTsKCiAgICAgICAgLy8gICAgVmFsaWRhdGUKICAgICAgICBpZiAoKGlzX251bWVyaWMoJHJhdGUpKSAmJiAoaXNfbnVtZXJpYygkcGFyKSkpIHsKICAgICAgICAgICAgJHJhdGUgICAgPSAoZmxvYXQpICRyYXRlOwogICAgICAgICAgICAkcGFyICAgID0gKGZsb2F0KSAkcGFyOwogICAgICAgICAgICBpZiAoKCRyYXRlIDw9IDApIHx8ICgkcGFyIDw9IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGF5c0JldHdlZW5Jc3N1ZUFuZFNldHRsZW1lbnQgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUkZSQUMoJGlzc3VlLCAkc2V0dGxlbWVudCwgJGJhc2lzKTsKICAgICAgICAgICAgaWYgKCFpc19udW1lcmljKCRkYXlzQmV0d2Vlbklzc3VlQW5kU2V0dGxlbWVudCkpIHsKICAgICAgICAgICAgICAgIC8vICAgIHJldHVybiBkYXRlIGVycm9yCiAgICAgICAgICAgICAgICByZXR1cm4gJGRheXNCZXR3ZWVuSXNzdWVBbmRTZXR0bGVtZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJHBhciAqICRyYXRlICogJGRheXNCZXR3ZWVuSXNzdWVBbmRTZXR0bGVtZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIEFDQ1JJTlRNCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgYWNjcnVlZCBpbnRlcmVzdCBmb3IgYSBzZWN1cml0eSB0aGF0IHBheXMgaW50ZXJlc3QgYXQgbWF0dXJpdHkuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgQUNDUklOVE0oaXNzdWUsc2V0dGxlbWVudCxyYXRlWyxwYXJbLGJhc2lzXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBGaW5hbmNpYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgaXNzdWUgICAgICAgIFRoZSBzZWN1cml0eSdzIGlzc3VlIGRhdGUuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgc2V0dGxlbWVudCAgICBUaGUgc2VjdXJpdHkncyBzZXR0bGVtZW50IChvciBtYXR1cml0eSkgZGF0ZS4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICByYXRlICAgICAgICBUaGUgc2VjdXJpdHkncyBhbm51YWwgY291cG9uIHJhdGUuCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgcGFyICAgICAgICAgICAgVGhlIHNlY3VyaXR5J3MgcGFyIHZhbHVlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB5b3Ugb21pdCBwYXIsIEFDQ1JJTlQgdXNlcyAkMSwwMDAuCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICBiYXNpcyAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEFDQ1JJTlRNKCRpc3N1ZSwgJHNldHRsZW1lbnQsICRyYXRlLCAkcGFyID0gMTAwMCwgJGJhc2lzID0gMCkKICAgIHsKICAgICAgICAkaXNzdWUgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGlzc3VlKTsKICAgICAgICAkc2V0dGxlbWVudCAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRzZXR0bGVtZW50KTsKICAgICAgICAkcmF0ZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJHBhciAgICAgICAgPSAoaXNfbnVsbCgkcGFyKSkgICAgPyAxMDAwIDogICAgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHBhcik7CiAgICAgICAgJGJhc2lzICAgICAgICA9IChpc19udWxsKCRiYXNpcykpICAgID8gMCA6ICAgICAgICBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYmFzaXMpOwoKICAgICAgICAvLyAgICBWYWxpZGF0ZQogICAgICAgIGlmICgoaXNfbnVtZXJpYygkcmF0ZSkpICYmIChpc19udW1lcmljKCRwYXIpKSkgewogICAgICAgICAgICAkcmF0ZSAgICA9IChmbG9hdCkgJHJhdGU7CiAgICAgICAgICAgICRwYXIgICAgPSAoZmxvYXQpICRwYXI7CiAgICAgICAgICAgIGlmICgoJHJhdGUgPD0gMCkgfHwgKCRwYXIgPD0gMCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkYXlzQmV0d2Vlbklzc3VlQW5kU2V0dGxlbWVudCA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkaXNzdWUsICRzZXR0bGVtZW50LCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNCZXR3ZWVuSXNzdWVBbmRTZXR0bGVtZW50KSkgewogICAgICAgICAgICAgICAgLy8gICAgcmV0dXJuIGRhdGUgZXJyb3IKICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c0JldHdlZW5Jc3N1ZUFuZFNldHRsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICRwYXIgKiAkcmF0ZSAqICRkYXlzQmV0d2Vlbklzc3VlQW5kU2V0dGxlbWVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBBTU9SREVHUkMKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBkZXByZWNpYXRpb24gZm9yIGVhY2ggYWNjb3VudGluZyBwZXJpb2QuCiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHByb3ZpZGVkIGZvciB0aGUgRnJlbmNoIGFjY291bnRpbmcgc3lzdGVtLiBJZiBhbiBhc3NldCBpcyBwdXJjaGFzZWQgaW4KICAgICAqIHRoZSBtaWRkbGUgb2YgdGhlIGFjY291bnRpbmcgcGVyaW9kLCB0aGUgcHJvcmF0ZWQgZGVwcmVjaWF0aW9uIGlzIHRha2VuIGludG8gYWNjb3VudC4KICAgICAqIFRoZSBmdW5jdGlvbiBpcyBzaW1pbGFyIHRvIEFNT1JMSU5DLCBleGNlcHQgdGhhdCBhIGRlcHJlY2lhdGlvbiBjb2VmZmljaWVudCBpcyBhcHBsaWVkIGluCiAgICAgKiB0aGUgY2FsY3VsYXRpb24gZGVwZW5kaW5nIG9uIHRoZSBsaWZlIG9mIHRoZSBhc3NldHMuCiAgICAgKiBUaGlzIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSBkZXByZWNpYXRpb24gdW50aWwgdGhlIGxhc3QgcGVyaW9kIG9mIHRoZSBsaWZlIG9mIHRoZSBhc3NldHMKICAgICAqIG9yIHVudGlsIHRoZSBjdW11bGF0ZWQgdmFsdWUgb2YgZGVwcmVjaWF0aW9uIGlzIGdyZWF0ZXIgdGhhbiB0aGUgY29zdCBvZiB0aGUgYXNzZXRzIG1pbnVzCiAgICAgKiB0aGUgc2FsdmFnZSB2YWx1ZS4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBBTU9SREVHUkMoY29zdCxwdXJjaGFzZWQsZmlyc3RQZXJpb2Qsc2FsdmFnZSxwZXJpb2QscmF0ZVssYmFzaXNdKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgIGNvc3QgICAgICAgIFRoZSBjb3N0IG9mIHRoZSBhc3NldC4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBwdXJjaGFzZWQgICAgRGF0ZSBvZiB0aGUgcHVyY2hhc2Ugb2YgdGhlIGFzc2V0LgogICAgICogQHBhcmFtICAgIG1peGVkICAgIGZpcnN0UGVyaW9kICAgIERhdGUgb2YgdGhlIGVuZCBvZiB0aGUgZmlyc3QgcGVyaW9kLgogICAgICogQHBhcmFtICAgIG1peGVkICAgIHNhbHZhZ2UgICAgICAgIFRoZSBzYWx2YWdlIHZhbHVlIGF0IHRoZSBlbmQgb2YgdGhlIGxpZmUgb2YgdGhlIGFzc2V0LgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgIHBlcmlvZCAgICAgICAgVGhlIHBlcmlvZC4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICByYXRlICAgICAgICBSYXRlIG9mIGRlcHJlY2lhdGlvbi4KICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgIGJhc2lzICAgICAgICBUaGUgdHlwZSBvZiBkYXkgY291bnQgdG8gdXNlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCBvciBvbWl0dGVkICAgIFVTIChOQVNEKSAzMC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgQWN0dWFsL2FjdHVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAgICAgICAgICAgICAgICBBY3R1YWwvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAzICAgICAgICAgICAgICAgIEFjdHVhbC8zNjUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgICAgICAgICAgICAgRXVyb3BlYW4gMzAvMzYwCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gQU1PUkRFR1JDKCRjb3N0LCAkcHVyY2hhc2VkLCAkZmlyc3RQZXJpb2QsICRzYWx2YWdlLCAkcGVyaW9kLCAkcmF0ZSwgJGJhc2lzID0gMCkKICAgIHsKICAgICAgICAkY29zdCAgICAgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGNvc3QpOwogICAgICAgICRwdXJjaGFzZWQgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHB1cmNoYXNlZCk7CiAgICAgICAgJGZpcnN0UGVyaW9kICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZpcnN0UGVyaW9kKTsKICAgICAgICAkc2FsdmFnZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2FsdmFnZSk7CiAgICAgICAgJHBlcmlvZCAgICAgICAgICAgID0gZmxvb3IoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHBlcmlvZCkpOwogICAgICAgICRyYXRlICAgICAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJGJhc2lzICAgICAgICAgICAgPSAoaXNfbnVsbCgkYmFzaXMpKSAgICA\/IDAgOiAgICAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYmFzaXMpOwoKICAgICAgICAvLyAgICBUaGUgZGVwcmVjaWF0aW9uIGNvZWZmaWNpZW50cyBhcmU6CiAgICAgICAgLy8gICAgTGlmZSBvZiBhc3NldHMgKDEvcmF0ZSkgICAgICAgIERlcHJlY2lhdGlvbiBjb2VmZmljaWVudAogICAgICAgIC8vICAgIExlc3MgdGhhbiAzIHllYXJzICAgICAgICAgICAgMQogICAgICAgIC8vICAgIEJldHdlZW4gMyBhbmQgNCB5ZWFycyAgICAgICAgMS41CiAgICAgICAgLy8gICAgQmV0d2VlbiA1IGFuZCA2IHllYXJzICAgICAgICAyCiAgICAgICAgLy8gICAgTW9yZSB0aGFuIDYgeWVhcnMgICAgICAgICAgICAyLjUKICAgICAgICAkZlVzZVBlciA9IDEuMCAvICRyYXRlOwogICAgICAgIGlmICgkZlVzZVBlciA8IDMuMCkgewogICAgICAgICAgICAkYW1vcnRpc2VDb2VmZiA9IDEuMDsKICAgICAgICB9IGVsc2VpZiAoJGZVc2VQZXIgPCA1LjApIHsKICAgICAgICAgICAgJGFtb3J0aXNlQ29lZmYgPSAxLjU7CiAgICAgICAgfSBlbHNlaWYgKCRmVXNlUGVyIDw9IDYuMCkgewogICAgICAgICAgICAkYW1vcnRpc2VDb2VmZiA9IDIuMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkYW1vcnRpc2VDb2VmZiA9IDIuNTsKICAgICAgICB9CgogICAgICAgICRyYXRlICo9ICRhbW9ydGlzZUNvZWZmOwogICAgICAgICRmTlJhdGUgPSByb3VuZChQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUkZSQUMoJHB1cmNoYXNlZCwgJGZpcnN0UGVyaW9kLCAkYmFzaXMpICogJHJhdGUgKiAkY29zdCwgMCk7CiAgICAgICAgJGNvc3QgLT0gJGZOUmF0ZTsKICAgICAgICAkZlJlc3QgPSAkY29zdCAtICRzYWx2YWdlOwoKICAgICAgICBmb3IgKCRuID0gMDsgJG4gPCAkcGVyaW9kOyArKyRuKSB7CiAgICAgICAgICAgICRmTlJhdGUgPSByb3VuZCgkcmF0ZSAqICRjb3N0LCAwKTsKICAgICAgICAgICAgJGZSZXN0IC09ICRmTlJhdGU7CgogICAgICAgICAgICBpZiAoJGZSZXN0IDwgMC4wKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKCRwZXJpb2QgLSAkbikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByb3VuZCgkY29zdCAqIDAuNSwgMCk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAkY29zdCAtPSAkZk5SYXRlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJGZOUmF0ZTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBBTU9STElOQwogICAgICoKICAgICAqIFJldHVybnMgdGhlIGRlcHJlY2lhdGlvbiBmb3IgZWFjaCBhY2NvdW50aW5nIHBlcmlvZC4KICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgcHJvdmlkZWQgZm9yIHRoZSBGcmVuY2ggYWNjb3VudGluZyBzeXN0ZW0uIElmIGFuIGFzc2V0IGlzIHB1cmNoYXNlZCBpbgogICAgICogdGhlIG1pZGRsZSBvZiB0aGUgYWNjb3VudGluZyBwZXJpb2QsIHRoZSBwcm9yYXRlZCBkZXByZWNpYXRpb24gaXMgdGFrZW4gaW50byBhY2NvdW50LgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIEFNT1JMSU5DKGNvc3QscHVyY2hhc2VkLGZpcnN0UGVyaW9kLHNhbHZhZ2UscGVyaW9kLHJhdGVbLGJhc2lzXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IEZpbmFuY2lhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICBjb3N0ICAgICAgICBUaGUgY29zdCBvZiB0aGUgYXNzZXQuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgcHVyY2hhc2VkICAgIERhdGUgb2YgdGhlIHB1cmNoYXNlIG9mIHRoZSBhc3NldC4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBmaXJzdFBlcmlvZCAgICBEYXRlIG9mIHRoZSBlbmQgb2YgdGhlIGZpcnN0IHBlcmlvZC4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzYWx2YWdlICAgICAgICBUaGUgc2FsdmFnZSB2YWx1ZSBhdCB0aGUgZW5kIG9mIHRoZSBsaWZlIG9mIHRoZSBhc3NldC4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICBwZXJpb2QgICAgICAgIFRoZSBwZXJpb2QuCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgcmF0ZSAgICAgICAgUmF0ZSBvZiBkZXByZWNpYXRpb24uCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICBiYXNpcyAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEFNT1JMSU5DKCRjb3N0LCAkcHVyY2hhc2VkLCAkZmlyc3RQZXJpb2QsICRzYWx2YWdlLCAkcGVyaW9kLCAkcmF0ZSwgJGJhc2lzID0gMCkKICAgIHsKICAgICAgICAkY29zdCAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkY29zdCk7CiAgICAgICAgJHB1cmNoYXNlZCAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHB1cmNoYXNlZCk7CiAgICAgICAgJGZpcnN0UGVyaW9kID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZpcnN0UGVyaW9kKTsKICAgICAgICAkc2FsdmFnZSAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2FsdmFnZSk7CiAgICAgICAgJHBlcmlvZCAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHBlcmlvZCk7CiAgICAgICAgJHJhdGUgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJhdGUpOwogICAgICAgICRiYXNpcyAgICAgICA9IChpc19udWxsKCRiYXNpcykpID8gMCA6IChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiYXNpcyk7CgogICAgICAgICRmT25lUmF0ZSA9ICRjb3N0ICogJHJhdGU7CiAgICAgICAgJGZDb3N0RGVsdGEgPSAkY29zdCAtICRzYWx2YWdlOwogICAgICAgIC8vICAgIE5vdGUsIHF1aXJreSB2YXJpYXRpb24gZm9yIGxlYXAgeWVhcnMgb24gdGhlIFlFQVJGUkFDIGZvciB0aGlzIGZ1bmN0aW9uCiAgICAgICAgJHB1cmNoYXNlZFllYXIgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUigkcHVyY2hhc2VkKTsKICAgICAgICAkeWVhckZyYWMgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUkZSQUMoJHB1cmNoYXNlZCwgJGZpcnN0UGVyaW9kLCAkYmFzaXMpOwoKICAgICAgICBpZiAoKCRiYXNpcyA9PSAxKSAmJiAoJHllYXJGcmFjIDwgMSkgJiYgKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjppc0xlYXBZZWFyKCRwdXJjaGFzZWRZZWFyKSkpIHsKICAgICAgICAgICAgJHllYXJGcmFjICo9IDM2NSAvIDM2NjsKICAgICAgICB9CgogICAgICAgICRmMFJhdGUgPSAkeWVhckZyYWMgKiAkcmF0ZSAqICRjb3N0OwogICAgICAgICRuTnVtT2ZGdWxsUGVyaW9kcyA9IGludHZhbCgoJGNvc3QgLSAkc2FsdmFnZSAtICRmMFJhdGUpIC8gJGZPbmVSYXRlKTsKCiAgICAgICAgaWYgKCRwZXJpb2QgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gJGYwUmF0ZTsKICAgICAgICB9IGVsc2VpZiAoJHBlcmlvZCA8PSAkbk51bU9mRnVsbFBlcmlvZHMpIHsKICAgICAgICAgICAgcmV0dXJuICRmT25lUmF0ZTsKICAgICAgICB9IGVsc2VpZiAoJHBlcmlvZCA9PSAoJG5OdW1PZkZ1bGxQZXJpb2RzICsgMSkpIHsKICAgICAgICAgICAgcmV0dXJuICgkZkNvc3REZWx0YSAtICRmT25lUmF0ZSAqICRuTnVtT2ZGdWxsUGVyaW9kcyAtICRmMFJhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAwLjA7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIENPVVBEQVlCUwogICAgICoKICAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBkYXlzIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY291cG9uIHBlcmlvZCB0byB0aGUgc2V0dGxlbWVudCBkYXRlLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIENPVVBEQVlCUyhzZXR0bGVtZW50LG1hdHVyaXR5LGZyZXF1ZW5jeVssYmFzaXNdKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgIHNldHRsZW1lbnQgICAgVGhlIHNlY3VyaXR5J3Mgc2V0dGxlbWVudCBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBzZWN1cml0eSBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZSB3aGVuIHRoZSBzZWN1cml0eSBpcyB0cmFkZWQgdG8gdGhlIGJ1eWVyLgogICAgICogQHBhcmFtICAgIG1peGVkICAgIG1hdHVyaXR5ICAgIFRoZSBzZWN1cml0eSdzIG1hdHVyaXR5IGRhdGUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG1hdHVyaXR5IGRhdGUgaXMgdGhlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgZXhwaXJlcy4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBmcmVxdWVuY3kgICAgdGhlIG51bWJlciBvZiBjb3Vwb24gcGF5bWVudHMgcGVyIHllYXIuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFZhbGlkIGZyZXF1ZW5jeSB2YWx1ZXMgYXJlOgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICBBbm51YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgU2VtaS1Bbm51YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgUXVhcnRlcmx5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElmIHdvcmtpbmcgaW4gR251bWVyaWMgTW9kZSwgdGhlIGZvbGxvd2luZyBmcmVxdWVuY3kgb3B0aW9ucyBhcmUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxzbyBhdmFpbGFibGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDYgICAgQmltb250aGx5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxMiAgICBNb250aGx5CiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICAgICAgYmFzaXMgICAgICAgIFRoZSB0eXBlIG9mIGRheSBjb3VudCB0byB1c2UuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwIG9yIG9taXR0ZWQgICAgVVMgKE5BU0QpIDMwLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICAgICAgICAgICAgICBBY3R1YWwvYWN0dWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICAgICAgICAgICAgICAgIEFjdHVhbC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDMgICAgICAgICAgICAgICAgQWN0dWFsLzM2NQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgNCAgICAgICAgICAgICAgICBFdXJvcGVhbiAzMC8zNjAKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDT1VQREFZQlMoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGZyZXF1ZW5jeSwgJGJhc2lzID0gMCkKICAgIHsKICAgICAgICAkc2V0dGxlbWVudCA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRzZXR0bGVtZW50KTsKICAgICAgICAkbWF0dXJpdHkgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtYXR1cml0eSk7CiAgICAgICAgJGZyZXF1ZW5jeSAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZnJlcXVlbmN5KTsKICAgICAgICAkYmFzaXMgICAgICA9IChpc19udWxsKCRiYXNpcykpID8gMCA6IChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiYXNpcyk7CgogICAgICAgIGlmIChpc19zdHJpbmcoJHNldHRsZW1lbnQgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6Z2V0RGF0ZVZhbHVlKCRzZXR0bGVtZW50KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzX3N0cmluZygkbWF0dXJpdHkgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6Z2V0RGF0ZVZhbHVlKCRtYXR1cml0eSkpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoKCRzZXR0bGVtZW50ID4gJG1hdHVyaXR5KSB8fAogICAgICAgICAgICAoIXNlbGY6OmlzVmFsaWRGcmVxdWVuY3koJGZyZXF1ZW5jeSkpIHx8CiAgICAgICAgICAgICgoJGJhc2lzIDwgMCkgfHwgKCRiYXNpcyA+IDQpKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CgogICAgICAgICRkYXlzUGVyWWVhciA9IHNlbGY6OmRheXNQZXJZZWFyKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSKCRzZXR0bGVtZW50KSwgJGJhc2lzKTsKICAgICAgICAkcHJldiA9IHNlbGY6OmNvdXBvbkZpcnN0UGVyaW9kRGF0ZSgkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkZnJlcXVlbmN5LCBmYWxzZSk7CgogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUkZSQUMoJHByZXYsICRzZXR0bGVtZW50LCAkYmFzaXMpICogJGRheXNQZXJZZWFyOwogICAgfQoKCiAgICAvKioKICAgICAqIENPVVBEQVlTCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIGRheXMgaW4gdGhlIGNvdXBvbiBwZXJpb2QgdGhhdCBjb250YWlucyB0aGUgc2V0dGxlbWVudCBkYXRlLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIENPVVBEQVlTKHNldHRsZW1lbnQsbWF0dXJpdHksZnJlcXVlbmN5WyxiYXNpc10pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBGaW5hbmNpYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgc2V0dGxlbWVudCAgICBUaGUgc2VjdXJpdHkncyBzZXR0bGVtZW50IGRhdGUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHNlY3VyaXR5IHNldHRsZW1lbnQgZGF0ZSBpcyB0aGUgZGF0ZSBhZnRlciB0aGUgaXNzdWUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGlzIHRyYWRlZCB0byB0aGUgYnV5ZXIuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgbWF0dXJpdHkgICAgVGhlIHNlY3VyaXR5J3MgbWF0dXJpdHkgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgbWF0dXJpdHkgZGF0ZSBpcyB0aGUgZGF0ZSB3aGVuIHRoZSBzZWN1cml0eSBleHBpcmVzLgogICAgICogQHBhcmFtICAgIG1peGVkICAgIGZyZXF1ZW5jeSAgICB0aGUgbnVtYmVyIG9mIGNvdXBvbiBwYXltZW50cyBwZXIgeWVhci4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVmFsaWQgZnJlcXVlbmN5IHZhbHVlcyBhcmU6CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgIEFubnVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAgICBTZW1pLUFubnVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgNCAgICBRdWFydGVybHkKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgd29ya2luZyBpbiBHbnVtZXJpYyBNb2RlLCB0aGUgZm9sbG93aW5nIGZyZXF1ZW5jeSBvcHRpb25zIGFyZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHNvIGF2YWlsYWJsZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgNiAgICBCaW1vbnRobHkKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEyICAgIE1vbnRobHkKICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICAgICBiYXNpcyAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIENPVVBEQVlTKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbWF0dXJpdHkpOwogICAgICAgICRmcmVxdWVuY3kgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZyZXF1ZW5jeSk7CiAgICAgICAgJGJhc2lzICAgICAgPSAoaXNfbnVsbCgkYmFzaXMpKSA\/IDAgOiAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYmFzaXMpOwoKICAgICAgICBpZiAoaXNfc3RyaW5nKCRzZXR0bGVtZW50ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkc2V0dGxlbWVudCkpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgIGlmIChpc19zdHJpbmcoJG1hdHVyaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkbWF0dXJpdHkpKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCgkc2V0dGxlbWVudCA+ICRtYXR1cml0eSkgfHwKICAgICAgICAgICAgKCFzZWxmOjppc1ZhbGlkRnJlcXVlbmN5KCRmcmVxdWVuY3kpKSB8fAogICAgICAgICAgICAoKCRiYXNpcyA8IDApIHx8ICgkYmFzaXMgPiA0KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgfQoKICAgICAgICBzd2l0Y2ggKCRiYXNpcykgewogICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAvLyBBY3R1YWwvMzY1CiAgICAgICAgICAgICAgICByZXR1cm4gMzY1IC8gJGZyZXF1ZW5jeTsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgLy8gQWN0dWFsL2FjdHVhbAogICAgICAgICAgICAgICAgaWYgKCRmcmVxdWVuY3kgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICRkYXlzUGVyWWVhciA9IHNlbGY6OmRheXNQZXJZZWFyKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSKCRtYXR1cml0eSksICRiYXNpcyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgkZGF5c1BlclllYXIgLyAkZnJlcXVlbmN5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRwcmV2ID0gc2VsZjo6Y291cG9uRmlyc3RQZXJpb2REYXRlKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksIGZhbHNlKTsKICAgICAgICAgICAgICAgICRuZXh0ID0gc2VsZjo6Y291cG9uRmlyc3RQZXJpb2REYXRlKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksIHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuICgkbmV4dCAtICRwcmV2KTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIC8vIFVTIChOQVNEKSAzMC8zNjAsIEFjdHVhbC8zNjAgb3IgRXVyb3BlYW4gMzAvMzYwCiAgICAgICAgICAgICAgICByZXR1cm4gMzYwIC8gJGZyZXF1ZW5jeTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDT1VQREFZU05DCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIGRheXMgZnJvbSB0aGUgc2V0dGxlbWVudCBkYXRlIHRvIHRoZSBuZXh0IGNvdXBvbiBkYXRlLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIENPVVBEQVlTTkMoc2V0dGxlbWVudCxtYXR1cml0eSxmcmVxdWVuY3lbLGJhc2lzXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IEZpbmFuY2lhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzZXR0bGVtZW50ICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkgc2V0dGxlbWVudCBkYXRlIGlzIHRoZSBkYXRlIGFmdGVyIHRoZSBpc3N1ZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICBUaGUgc2VjdXJpdHkncyBtYXR1cml0eSBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBtYXR1cml0eSBkYXRlIGlzIHRoZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGV4cGlyZXMuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgZnJlcXVlbmN5ICAgIHRoZSBudW1iZXIgb2YgY291cG9uIHBheW1lbnRzIHBlciB5ZWFyLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBWYWxpZCBmcmVxdWVuY3kgdmFsdWVzIGFyZToKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICAgIFNlbWktQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgIFF1YXJ0ZXJseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB3b3JraW5nIGluIEdudW1lcmljIE1vZGUsIHRoZSBmb2xsb3dpbmcgZnJlcXVlbmN5IG9wdGlvbnMgYXJlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsc28gYXZhaWxhYmxlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA2ICAgIEJpbW9udGhseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTIgICAgTW9udGhseQogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgICAgIGJhc2lzICAgICAgICBUaGUgdHlwZSBvZiBkYXkgY291bnQgdG8gdXNlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCBvciBvbWl0dGVkICAgIFVTIChOQVNEKSAzMC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgQWN0dWFsL2FjdHVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAgICAgICAgICAgICAgICBBY3R1YWwvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAzICAgICAgICAgICAgICAgIEFjdHVhbC8zNjUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgICAgICAgICAgICAgRXVyb3BlYW4gMzAvMzYwCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gQ09VUERBWVNOQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkZnJlcXVlbmN5LCAkYmFzaXMgPSAwKQogICAgewogICAgICAgICRzZXR0bGVtZW50ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNldHRsZW1lbnQpOwogICAgICAgICRtYXR1cml0eSAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkZnJlcXVlbmN5ICA9IChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRmcmVxdWVuY3kpOwogICAgICAgICRiYXNpcyAgICAgID0gKGlzX251bGwoJGJhc2lzKSkgPyAwIDogKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGJhc2lzKTsKCiAgICAgICAgaWYgKGlzX3N0cmluZygkc2V0dGxlbWVudCA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJHNldHRsZW1lbnQpKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNfc3RyaW5nKCRtYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJG1hdHVyaXR5KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CgogICAgICAgIGlmICgoJHNldHRsZW1lbnQgPiAkbWF0dXJpdHkpIHx8CiAgICAgICAgICAgICghc2VsZjo6aXNWYWxpZEZyZXF1ZW5jeSgkZnJlcXVlbmN5KSkgfHwKICAgICAgICAgICAgKCgkYmFzaXMgPCAwKSB8fCAoJGJhc2lzID4gNCkpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KCiAgICAgICAgJGRheXNQZXJZZWFyID0gc2VsZjo6ZGF5c1BlclllYXIoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OllFQVIoJHNldHRsZW1lbnQpLCAkYmFzaXMpOwogICAgICAgICRuZXh0ID0gc2VsZjo6Y291cG9uRmlyc3RQZXJpb2REYXRlKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksIHRydWUpOwoKICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OllFQVJGUkFDKCRzZXR0bGVtZW50LCAkbmV4dCwgJGJhc2lzKSAqICRkYXlzUGVyWWVhcjsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDT1VQTkNECiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbmV4dCBjb3Vwb24gZGF0ZSBhZnRlciB0aGUgc2V0dGxlbWVudCBkYXRlLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIENPVVBOQ0Qoc2V0dGxlbWVudCxtYXR1cml0eSxmcmVxdWVuY3lbLGJhc2lzXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IEZpbmFuY2lhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzZXR0bGVtZW50ICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkgc2V0dGxlbWVudCBkYXRlIGlzIHRoZSBkYXRlIGFmdGVyIHRoZSBpc3N1ZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICBUaGUgc2VjdXJpdHkncyBtYXR1cml0eSBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBtYXR1cml0eSBkYXRlIGlzIHRoZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGV4cGlyZXMuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgZnJlcXVlbmN5ICAgIHRoZSBudW1iZXIgb2YgY291cG9uIHBheW1lbnRzIHBlciB5ZWFyLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBWYWxpZCBmcmVxdWVuY3kgdmFsdWVzIGFyZToKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICAgIFNlbWktQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgIFF1YXJ0ZXJseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB3b3JraW5nIGluIEdudW1lcmljIE1vZGUsIHRoZSBmb2xsb3dpbmcgZnJlcXVlbmN5IG9wdGlvbnMgYXJlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsc28gYXZhaWxhYmxlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA2ICAgIEJpbW9udGhseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTIgICAgTW9udGhseQogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgICAgIGJhc2lzICAgICAgICBUaGUgdHlwZSBvZiBkYXkgY291bnQgdG8gdXNlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCBvciBvbWl0dGVkICAgIFVTIChOQVNEKSAzMC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgQWN0dWFsL2FjdHVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAgICAgICAgICAgICAgICBBY3R1YWwvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAzICAgICAgICAgICAgICAgIEFjdHVhbC8zNjUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgICAgICAgICAgICAgRXVyb3BlYW4gMzAvMzYwCiAgICAgKiBAcmV0dXJuICAgIG1peGVkICAgIEV4Y2VsIGRhdGUvdGltZSBzZXJpYWwgdmFsdWUsIFBIUCBkYXRlL3RpbWUgc2VyaWFsIHZhbHVlIG9yIFBIUCBkYXRlL3RpbWUgb2JqZWN0LAogICAgICogICAgICAgICAgICAgICAgICAgICAgICBkZXBlbmRpbmcgb24gdGhlIHZhbHVlIG9mIHRoZSBSZXR1cm5EYXRlVHlwZSBmbGFnCiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gQ09VUE5DRCgkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkZnJlcXVlbmN5LCAkYmFzaXMgPSAwKQogICAgewogICAgICAgICRzZXR0bGVtZW50ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNldHRsZW1lbnQpOwogICAgICAgICRtYXR1cml0eSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtYXR1cml0eSk7CiAgICAgICAgJGZyZXF1ZW5jeSAgICA9IChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRmcmVxdWVuY3kpOwogICAgICAgICRiYXNpcyAgICAgICAgPSAoaXNfbnVsbCgkYmFzaXMpKSAgICA\/IDAgOiAgICAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYmFzaXMpOwoKICAgICAgICBpZiAoaXNfc3RyaW5nKCRzZXR0bGVtZW50ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkc2V0dGxlbWVudCkpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgIGlmIChpc19zdHJpbmcoJG1hdHVyaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkbWF0dXJpdHkpKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCgkc2V0dGxlbWVudCA+ICRtYXR1cml0eSkgfHwKICAgICAgICAgICAgKCFzZWxmOjppc1ZhbGlkRnJlcXVlbmN5KCRmcmVxdWVuY3kpKSB8fAogICAgICAgICAgICAoKCRiYXNpcyA8IDApIHx8ICgkYmFzaXMgPiA0KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2VsZjo6Y291cG9uRmlyc3RQZXJpb2REYXRlKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksIHRydWUpOwogICAgfQoKCiAgICAvKioKICAgICAqIENPVVBOVU0KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgY291cG9ucyBwYXlhYmxlIGJldHdlZW4gdGhlIHNldHRsZW1lbnQgZGF0ZSBhbmQgbWF0dXJpdHkgZGF0ZSwKICAgICAqIHJvdW5kZWQgdXAgdG8gdGhlIG5lYXJlc3Qgd2hvbGUgY291cG9uLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIENPVVBOVU0oc2V0dGxlbWVudCxtYXR1cml0eSxmcmVxdWVuY3lbLGJhc2lzXSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IEZpbmFuY2lhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzZXR0bGVtZW50ICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkgc2V0dGxlbWVudCBkYXRlIGlzIHRoZSBkYXRlIGFmdGVyIHRoZSBpc3N1ZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICBUaGUgc2VjdXJpdHkncyBtYXR1cml0eSBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBtYXR1cml0eSBkYXRlIGlzIHRoZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGV4cGlyZXMuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgZnJlcXVlbmN5ICAgIHRoZSBudW1iZXIgb2YgY291cG9uIHBheW1lbnRzIHBlciB5ZWFyLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBWYWxpZCBmcmVxdWVuY3kgdmFsdWVzIGFyZToKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICAgIFNlbWktQW5udWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgIFF1YXJ0ZXJseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB3b3JraW5nIGluIEdudW1lcmljIE1vZGUsIHRoZSBmb2xsb3dpbmcgZnJlcXVlbmN5IG9wdGlvbnMgYXJlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsc28gYXZhaWxhYmxlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA2ICAgIEJpbW9udGhseQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMTIgICAgTW9udGhseQogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgICAgIGJhc2lzICAgICAgICBUaGUgdHlwZSBvZiBkYXkgY291bnQgdG8gdXNlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCBvciBvbWl0dGVkICAgIFVTIChOQVNEKSAzMC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgQWN0dWFsL2FjdHVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAgICAgICAgICAgICAgICBBY3R1YWwvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAzICAgICAgICAgICAgICAgIEFjdHVhbC8zNjUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgICAgICAgICAgICAgRXVyb3BlYW4gMzAvMzYwCiAgICAgKiBAcmV0dXJuICAgIGludGVnZXIKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDT1VQTlVNKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkZnJlcXVlbmN5ICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZyZXF1ZW5jeSk7CiAgICAgICAgJGJhc2lzICAgICAgICA9IChpc19udWxsKCRiYXNpcykpICAgID8gMCA6ICAgIChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiYXNpcyk7CgogICAgICAgIGlmIChpc19zdHJpbmcoJHNldHRsZW1lbnQgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6Z2V0RGF0ZVZhbHVlKCRzZXR0bGVtZW50KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzX3N0cmluZygkbWF0dXJpdHkgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6Z2V0RGF0ZVZhbHVlKCRtYXR1cml0eSkpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoKCRzZXR0bGVtZW50ID4gJG1hdHVyaXR5KSB8fAogICAgICAgICAgICAoIXNlbGY6OmlzVmFsaWRGcmVxdWVuY3koJGZyZXF1ZW5jeSkpIHx8CiAgICAgICAgICAgICgoJGJhc2lzIDwgMCkgfHwgKCRiYXNpcyA+IDQpKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CgogICAgICAgICRzZXR0bGVtZW50ID0gc2VsZjo6Y291cG9uRmlyc3RQZXJpb2REYXRlKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksIHRydWUpOwogICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkYmFzaXMpICogMzY1OwoKICAgICAgICBzd2l0Y2ggKCRmcmVxdWVuY3kpIHsKICAgICAgICAgICAgY2FzZSAxOiAvLyBhbm51YWwgcGF5bWVudHMKICAgICAgICAgICAgICAgIHJldHVybiBjZWlsKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSAvIDM2MCk7CiAgICAgICAgICAgIGNhc2UgMjogLy8gaGFsZi15ZWFybHkKICAgICAgICAgICAgICAgIHJldHVybiBjZWlsKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSAvIDE4MCk7CiAgICAgICAgICAgIGNhc2UgNDogLy8gcXVhcnRlcmx5CiAgICAgICAgICAgICAgICByZXR1cm4gY2VpbCgkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkgLyA5MCk7CiAgICAgICAgICAgIGNhc2UgNjogLy8gYmltb250aGx5CiAgICAgICAgICAgICAgICByZXR1cm4gY2VpbCgkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkgLyA2MCk7CiAgICAgICAgICAgIGNhc2UgMTI6IC8vIG1vbnRobHkKICAgICAgICAgICAgICAgIHJldHVybiBjZWlsKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSAvIDMwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBDT1VQUENECiAgICAgKgogICAgICogUmV0dXJucyB0aGUgcHJldmlvdXMgY291cG9uIGRhdGUgYmVmb3JlIHRoZSBzZXR0bGVtZW50IGRhdGUuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgQ09VUFBDRChzZXR0bGVtZW50LG1hdHVyaXR5LGZyZXF1ZW5jeVssYmFzaXNdKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgIHNldHRsZW1lbnQgICAgVGhlIHNlY3VyaXR5J3Mgc2V0dGxlbWVudCBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBzZWN1cml0eSBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZSB3aGVuIHRoZSBzZWN1cml0eSBpcyB0cmFkZWQgdG8gdGhlIGJ1eWVyLgogICAgICogQHBhcmFtICAgIG1peGVkICAgIG1hdHVyaXR5ICAgIFRoZSBzZWN1cml0eSdzIG1hdHVyaXR5IGRhdGUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG1hdHVyaXR5IGRhdGUgaXMgdGhlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgZXhwaXJlcy4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBmcmVxdWVuY3kgICAgdGhlIG51bWJlciBvZiBjb3Vwb24gcGF5bWVudHMgcGVyIHllYXIuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFZhbGlkIGZyZXF1ZW5jeSB2YWx1ZXMgYXJlOgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICBBbm51YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgU2VtaS1Bbm51YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgUXVhcnRlcmx5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElmIHdvcmtpbmcgaW4gR251bWVyaWMgTW9kZSwgdGhlIGZvbGxvd2luZyBmcmVxdWVuY3kgb3B0aW9ucyBhcmUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxzbyBhdmFpbGFibGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDYgICAgQmltb250aGx5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxMiAgICBNb250aGx5CiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICAgICAgYmFzaXMgICAgICAgIFRoZSB0eXBlIG9mIGRheSBjb3VudCB0byB1c2UuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwIG9yIG9taXR0ZWQgICAgVVMgKE5BU0QpIDMwLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICAgICAgICAgICAgICBBY3R1YWwvYWN0dWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICAgICAgICAgICAgICAgIEFjdHVhbC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDMgICAgICAgICAgICAgICAgQWN0dWFsLzM2NQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgNCAgICAgICAgICAgICAgICBFdXJvcGVhbiAzMC8zNjAKICAgICAqIEByZXR1cm4gICAgbWl4ZWQgICAgRXhjZWwgZGF0ZS90aW1lIHNlcmlhbCB2YWx1ZSwgUEhQIGRhdGUvdGltZSBzZXJpYWwgdmFsdWUgb3IgUEhQIGRhdGUvdGltZSBvYmplY3QsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgIGRlcGVuZGluZyBvbiB0aGUgdmFsdWUgb2YgdGhlIFJldHVybkRhdGVUeXBlIGZsYWcKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDT1VQUENEKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkZnJlcXVlbmN5ICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZyZXF1ZW5jeSk7CiAgICAgICAgJGJhc2lzICAgICAgICA9IChpc19udWxsKCRiYXNpcykpICAgID8gMCA6ICAgIChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiYXNpcyk7CgogICAgICAgIGlmIChpc19zdHJpbmcoJHNldHRsZW1lbnQgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6Z2V0RGF0ZVZhbHVlKCRzZXR0bGVtZW50KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzX3N0cmluZygkbWF0dXJpdHkgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6Z2V0RGF0ZVZhbHVlKCRtYXR1cml0eSkpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoKCRzZXR0bGVtZW50ID4gJG1hdHVyaXR5KSB8fAogICAgICAgICAgICAoIXNlbGY6OmlzVmFsaWRGcmVxdWVuY3koJGZyZXF1ZW5jeSkpIHx8CiAgICAgICAgICAgICgoJGJhc2lzIDwgMCkgfHwgKCRiYXNpcyA+IDQpKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWxmOjpjb3Vwb25GaXJzdFBlcmlvZERhdGUoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGZyZXF1ZW5jeSwgZmFsc2UpOwogICAgfQoKCiAgICAvKioKICAgICAqIENVTUlQTVQKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBjdW11bGF0aXZlIGludGVyZXN0IHBhaWQgb24gYSBsb2FuIGJldHdlZW4gdGhlIHN0YXJ0IGFuZCBlbmQgcGVyaW9kcy4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBDVU1JUE1UKHJhdGUsbnBlcixwdixzdGFydCxlbmRbLHR5cGVdKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRyYXRlICAgIFRoZSBJbnRlcmVzdCByYXRlCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICAkbnBlciAgICBUaGUgdG90YWwgbnVtYmVyIG9mIHBheW1lbnQgcGVyaW9kcwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRwdiAgICAgICAgUHJlc2VudCBWYWx1ZQogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgJHN0YXJ0ICAgIFRoZSBmaXJzdCBwZXJpb2QgaW4gdGhlIGNhbGN1bGF0aW9uLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgUGF5bWVudCBwZXJpb2RzIGFyZSBudW1iZXJlZCBiZWdpbm5pbmcgd2l0aCAxLgogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgJGVuZCAgICBUaGUgbGFzdCBwZXJpb2QgaW4gdGhlIGNhbGN1bGF0aW9uLgogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgJHR5cGUgICAgQSBudW1iZXIgMCBvciAxIGFuZCBpbmRpY2F0ZXMgd2hlbiBwYXltZW50cyBhcmUgZHVlOgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBBdCB0aGUgZW5kIG9mIHRoZSBwZXJpb2QuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICAgICAgICAgICAgICBBdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBwZXJpb2QuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gQ1VNSVBNVCgkcmF0ZSwgJG5wZXIsICRwdiwgJHN0YXJ0LCAkZW5kLCAkdHlwZSA9IDApCiAgICB7CiAgICAgICAgJHJhdGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJG5wZXIgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbnBlcik7CiAgICAgICAgJHB2ICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwdik7CiAgICAgICAgJHN0YXJ0ICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHN0YXJ0KTsKICAgICAgICAkZW5kICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGVuZCk7CiAgICAgICAgJHR5cGUgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdHlwZSk7CgogICAgICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMKICAgICAgICBpZiAoJHR5cGUgIT0gMCAmJiAkdHlwZSAhPSAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KICAgICAgICBpZiAoJHN0YXJ0IDwgMSB8fCAkc3RhcnQgPiAkZW5kKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUKICAgICAgICAkaW50ZXJlc3QgPSAwOwogICAgICAgIGZvciAoJHBlciA9ICRzdGFydDsgJHBlciA8PSAkZW5kOyArKyRwZXIpIHsKICAgICAgICAgICAgJGludGVyZXN0ICs9IHNlbGY6OklQTVQoJHJhdGUsICRwZXIsICRucGVyLCAkcHYsIDAsICR0eXBlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkaW50ZXJlc3Q7CiAgICB9CgoKICAgIC8qKgogICAgICogQ1VNUFJJTkMKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBjdW11bGF0aXZlIHByaW5jaXBhbCBwYWlkIG9uIGEgbG9hbiBiZXR3ZWVuIHRoZSBzdGFydCBhbmQgZW5kIHBlcmlvZHMuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgQ1VNUFJJTkMocmF0ZSxucGVyLHB2LHN0YXJ0LGVuZFssdHlwZV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBGaW5hbmNpYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHJhdGUgICAgVGhlIEludGVyZXN0IHJhdGUKICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICRucGVyICAgIFRoZSB0b3RhbCBudW1iZXIgb2YgcGF5bWVudCBwZXJpb2RzCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHB2ICAgICAgICBQcmVzZW50IFZhbHVlCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICAkc3RhcnQgICAgVGhlIGZpcnN0IHBlcmlvZCBpbiB0aGUgY2FsY3VsYXRpb24uCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYXltZW50IHBlcmlvZHMgYXJlIG51bWJlcmVkIGJlZ2lubmluZyB3aXRoIDEuCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICAkZW5kICAgIFRoZSBsYXN0IHBlcmlvZCBpbiB0aGUgY2FsY3VsYXRpb24uCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICAkdHlwZSAgICBBIG51bWJlciAwIG9yIDEgYW5kIGluZGljYXRlcyB3aGVuIHBheW1lbnRzIGFyZSBkdWU6CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCBvciBvbWl0dGVkICAgIEF0IHRoZSBlbmQgb2YgdGhlIHBlcmlvZC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIHBlcmlvZC4KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBDVU1QUklOQygkcmF0ZSwgJG5wZXIsICRwdiwgJHN0YXJ0LCAkZW5kLCAkdHlwZSA9IDApCiAgICB7CiAgICAgICAgJHJhdGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJG5wZXIgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbnBlcik7CiAgICAgICAgJHB2ICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwdik7CiAgICAgICAgJHN0YXJ0ICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHN0YXJ0KTsKICAgICAgICAkZW5kICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGVuZCk7CiAgICAgICAgJHR5cGUgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdHlwZSk7CgogICAgICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMKICAgICAgICBpZiAoJHR5cGUgIT0gMCAmJiAkdHlwZSAhPSAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KICAgICAgICBpZiAoJHN0YXJ0IDwgMSB8fCAkc3RhcnQgPiAkZW5kKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUKICAgICAgICAkcHJpbmNpcGFsID0gMDsKICAgICAgICBmb3IgKCRwZXIgPSAkc3RhcnQ7ICRwZXIgPD0gJGVuZDsgKyskcGVyKSB7CiAgICAgICAgICAgICRwcmluY2lwYWwgKz0gc2VsZjo6UFBNVCgkcmF0ZSwgJHBlciwgJG5wZXIsICRwdiwgMCwgJHR5cGUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRwcmluY2lwYWw7CiAgICB9CgoKICAgIC8qKgogICAgICogREIKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBkZXByZWNpYXRpb24gb2YgYW4gYXNzZXQgZm9yIGEgc3BlY2lmaWVkIHBlcmlvZCB1c2luZyB0aGUKICAgICAqIGZpeGVkLWRlY2xpbmluZyBiYWxhbmNlIG1ldGhvZC4KICAgICAqIFRoaXMgZm9ybSBvZiBkZXByZWNpYXRpb24gaXMgdXNlZCBpZiB5b3Ugd2FudCB0byBnZXQgYSBoaWdoZXIgZGVwcmVjaWF0aW9uIHZhbHVlCiAgICAgKiBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBkZXByZWNpYXRpb24gKGFzIG9wcG9zZWQgdG8gbGluZWFyIGRlcHJlY2lhdGlvbikuIFRoZQogICAgICogZGVwcmVjaWF0aW9uIHZhbHVlIGlzIHJlZHVjZWQgd2l0aCBldmVyeSBkZXByZWNpYXRpb24gcGVyaW9kIGJ5IHRoZSBkZXByZWNpYXRpb24KICAgICAqIGFscmVhZHkgZGVkdWN0ZWQgZnJvbSB0aGUgaW5pdGlhbCBjb3N0LgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIERCKGNvc3Qsc2FsdmFnZSxsaWZlLHBlcmlvZFssbW9udGhdKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgIGNvc3QgICAgICAgIEluaXRpYWwgY29zdCBvZiB0aGUgYXNzZXQuCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgc2FsdmFnZSAgICAgICAgVmFsdWUgYXQgdGhlIGVuZCBvZiB0aGUgZGVwcmVjaWF0aW9uLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChTb21ldGltZXMgY2FsbGVkIHRoZSBzYWx2YWdlIHZhbHVlIG9mIHRoZSBhc3NldCkKICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgIGxpZmUgICAgICAgIE51bWJlciBvZiBwZXJpb2RzIG92ZXIgd2hpY2ggdGhlIGFzc2V0IGlzIGRlcHJlY2lhdGVkLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChTb21ldGltZXMgY2FsbGVkIHRoZSB1c2VmdWwgbGlmZSBvZiB0aGUgYXNzZXQpCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICBwZXJpb2QgICAgICAgIFRoZSBwZXJpb2QgZm9yIHdoaWNoIHlvdSB3YW50IHRvIGNhbGN1bGF0ZSB0aGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXByZWNpYXRpb24uIFBlcmlvZCBtdXN0IHVzZSB0aGUgc2FtZSB1bml0cyBhcyBsaWZlLgogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgbW9udGggICAgICAgIE51bWJlciBvZiBtb250aHMgaW4gdGhlIGZpcnN0IHllYXIuIElmIG1vbnRoIGlzIG9taXR0ZWQsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXQgZGVmYXVsdHMgdG8gMTIuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gREIoJGNvc3QsICRzYWx2YWdlLCAkbGlmZSwgJHBlcmlvZCwgJG1vbnRoID0gMTIpCiAgICB7CiAgICAgICAgJGNvc3QgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGNvc3QpOwogICAgICAgICRzYWx2YWdlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNhbHZhZ2UpOwogICAgICAgICRsaWZlICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRsaWZlKTsKICAgICAgICAkcGVyaW9kICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwZXJpb2QpOwogICAgICAgICRtb250aCAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbW9udGgpOwoKICAgICAgICAvLyAgICBWYWxpZGF0ZQogICAgICAgIGlmICgoaXNfbnVtZXJpYygkY29zdCkpICYmIChpc19udW1lcmljKCRzYWx2YWdlKSkgJiYgKGlzX251bWVyaWMoJGxpZmUpKSAmJiAoaXNfbnVtZXJpYygkcGVyaW9kKSkgJiYgKGlzX251bWVyaWMoJG1vbnRoKSkpIHsKICAgICAgICAgICAgJGNvc3QgICAgPSAoZmxvYXQpICRjb3N0OwogICAgICAgICAgICAkc2FsdmFnZSA9IChmbG9hdCkgJHNhbHZhZ2U7CiAgICAgICAgICAgICRsaWZlICAgID0gKGludCkgJGxpZmU7CiAgICAgICAgICAgICRwZXJpb2QgID0gKGludCkgJHBlcmlvZDsKICAgICAgICAgICAgJG1vbnRoICAgPSAoaW50KSAkbW9udGg7CiAgICAgICAgICAgIGlmICgkY29zdCA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMC4wOwogICAgICAgICAgICB9IGVsc2VpZiAoKCRjb3N0IDwgMCkgfHwgKCgkc2FsdmFnZSAvICRjb3N0KSA8IDApIHx8ICgkbGlmZSA8PSAwKSB8fCAoJHBlcmlvZCA8IDEpIHx8ICgkbW9udGggPCAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gICAgU2V0IEZpeGVkIERlcHJlY2lhdGlvbiBSYXRlCiAgICAgICAgICAgICRmaXhlZERlcHJlY2lhdGlvblJhdGUgPSAxIC0gcG93KCgkc2FsdmFnZSAvICRjb3N0KSwgKDEgLyAkbGlmZSkpOwogICAgICAgICAgICAkZml4ZWREZXByZWNpYXRpb25SYXRlID0gcm91bmQoJGZpeGVkRGVwcmVjaWF0aW9uUmF0ZSwgMyk7CgogICAgICAgICAgICAvLyAgICBMb29wIHRocm91Z2ggZWFjaCBwZXJpb2QgY2FsY3VsYXRpbmcgdGhlIGRlcHJlY2lhdGlvbgogICAgICAgICAgICAkcHJldmlvdXNEZXByZWNpYXRpb24gPSAwOwogICAgICAgICAgICBmb3IgKCRwZXIgPSAxOyAkcGVyIDw9ICRwZXJpb2Q7ICsrJHBlcikgewogICAgICAgICAgICAgICAgaWYgKCRwZXIgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICRkZXByZWNpYXRpb24gPSAkY29zdCAqICRmaXhlZERlcHJlY2lhdGlvblJhdGUgKiAkbW9udGggLyAxMjsKICAgICAgICAgICAgICAgIH0gZWxzZWlmICgkcGVyID09ICgkbGlmZSArIDEpKSB7CiAgICAgICAgICAgICAgICAgICAgJGRlcHJlY2lhdGlvbiA9ICgkY29zdCAtICRwcmV2aW91c0RlcHJlY2lhdGlvbikgKiAkZml4ZWREZXByZWNpYXRpb25SYXRlICogKDEyIC0gJG1vbnRoKSAvIDEyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkZGVwcmVjaWF0aW9uID0gKCRjb3N0IC0gJHByZXZpb3VzRGVwcmVjaWF0aW9uKSAqICRmaXhlZERlcHJlY2lhdGlvblJhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkcHJldmlvdXNEZXByZWNpYXRpb24gKz0gJGRlcHJlY2lhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpnZXRDb21wYXRpYmlsaXR5TW9kZSgpID09IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Q09NUEFUSUJJTElUWV9HTlVNRVJJQykgewogICAgICAgICAgICAgICAgJGRlcHJlY2lhdGlvbiA9IHJvdW5kKCRkZXByZWNpYXRpb24sIDIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAkZGVwcmVjaWF0aW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIEREQgogICAgICoKICAgICAqIFJldHVybnMgdGhlIGRlcHJlY2lhdGlvbiBvZiBhbiBhc3NldCBmb3IgYSBzcGVjaWZpZWQgcGVyaW9kIHVzaW5nIHRoZQogICAgICogZG91YmxlLWRlY2xpbmluZyBiYWxhbmNlIG1ldGhvZCBvciBzb21lIG90aGVyIG1ldGhvZCB5b3Ugc3BlY2lmeS4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBEREIoY29zdCxzYWx2YWdlLGxpZmUscGVyaW9kWyxmYWN0b3JdKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgIGNvc3QgICAgICAgIEluaXRpYWwgY29zdCBvZiB0aGUgYXNzZXQuCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgc2FsdmFnZSAgICAgICAgVmFsdWUgYXQgdGhlIGVuZCBvZiB0aGUgZGVwcmVjaWF0aW9uLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChTb21ldGltZXMgY2FsbGVkIHRoZSBzYWx2YWdlIHZhbHVlIG9mIHRoZSBhc3NldCkKICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgIGxpZmUgICAgICAgIE51bWJlciBvZiBwZXJpb2RzIG92ZXIgd2hpY2ggdGhlIGFzc2V0IGlzIGRlcHJlY2lhdGVkLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChTb21ldGltZXMgY2FsbGVkIHRoZSB1c2VmdWwgbGlmZSBvZiB0aGUgYXNzZXQpCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICBwZXJpb2QgICAgICAgIFRoZSBwZXJpb2QgZm9yIHdoaWNoIHlvdSB3YW50IHRvIGNhbGN1bGF0ZSB0aGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXByZWNpYXRpb24uIFBlcmlvZCBtdXN0IHVzZSB0aGUgc2FtZSB1bml0cyBhcyBsaWZlLgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgIGZhY3RvciAgICAgICAgVGhlIHJhdGUgYXQgd2hpY2ggdGhlIGJhbGFuY2UgZGVjbGluZXMuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgZmFjdG9yIGlzIG9taXR0ZWQsIGl0IGlzIGFzc3VtZWQgdG8gYmUgMiAodGhlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG91YmxlLWRlY2xpbmluZyBiYWxhbmNlIG1ldGhvZCkuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gRERCKCRjb3N0LCAkc2FsdmFnZSwgJGxpZmUsICRwZXJpb2QsICRmYWN0b3IgPSAyLjApCiAgICB7CiAgICAgICAgJGNvc3QgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGNvc3QpOwogICAgICAgICRzYWx2YWdlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNhbHZhZ2UpOwogICAgICAgICRsaWZlICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRsaWZlKTsKICAgICAgICAkcGVyaW9kICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwZXJpb2QpOwogICAgICAgICRmYWN0b3IgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZhY3Rvcik7CgogICAgICAgIC8vICAgIFZhbGlkYXRlCiAgICAgICAgaWYgKChpc19udW1lcmljKCRjb3N0KSkgJiYgKGlzX251bWVyaWMoJHNhbHZhZ2UpKSAmJiAoaXNfbnVtZXJpYygkbGlmZSkpICYmIChpc19udW1lcmljKCRwZXJpb2QpKSAmJiAoaXNfbnVtZXJpYygkZmFjdG9yKSkpIHsKICAgICAgICAgICAgJGNvc3QgICAgPSAoZmxvYXQpICRjb3N0OwogICAgICAgICAgICAkc2FsdmFnZSA9IChmbG9hdCkgJHNhbHZhZ2U7CiAgICAgICAgICAgICRsaWZlICAgID0gKGludCkgJGxpZmU7CiAgICAgICAgICAgICRwZXJpb2QgID0gKGludCkgJHBlcmlvZDsKICAgICAgICAgICAgJGZhY3RvciAgPSAoZmxvYXQpICRmYWN0b3I7CiAgICAgICAgICAgIGlmICgoJGNvc3QgPD0gMCkgfHwgKCgkc2FsdmFnZSAvICRjb3N0KSA8IDApIHx8ICgkbGlmZSA8PSAwKSB8fCAoJHBlcmlvZCA8IDEpIHx8ICgkZmFjdG9yIDw9IDAuMCkgfHwgKCRwZXJpb2QgPiAkbGlmZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vICAgIFNldCBGaXhlZCBEZXByZWNpYXRpb24gUmF0ZQogICAgICAgICAgICAkZml4ZWREZXByZWNpYXRpb25SYXRlID0gMSAtIHBvdygoJHNhbHZhZ2UgLyAkY29zdCksICgxIC8gJGxpZmUpKTsKICAgICAgICAgICAgJGZpeGVkRGVwcmVjaWF0aW9uUmF0ZSA9IHJvdW5kKCRmaXhlZERlcHJlY2lhdGlvblJhdGUsIDMpOwoKICAgICAgICAgICAgLy8gICAgTG9vcCB0aHJvdWdoIGVhY2ggcGVyaW9kIGNhbGN1bGF0aW5nIHRoZSBkZXByZWNpYXRpb24KICAgICAgICAgICAgJHByZXZpb3VzRGVwcmVjaWF0aW9uID0gMDsKICAgICAgICAgICAgZm9yICgkcGVyID0gMTsgJHBlciA8PSAkcGVyaW9kOyArKyRwZXIpIHsKICAgICAgICAgICAgICAgICRkZXByZWNpYXRpb24gPSBtaW4oKCRjb3N0IC0gJHByZXZpb3VzRGVwcmVjaWF0aW9uKSAqICgkZmFjdG9yIC8gJGxpZmUpLCAoJGNvc3QgLSAkc2FsdmFnZSAtICRwcmV2aW91c0RlcHJlY2lhdGlvbikpOwogICAgICAgICAgICAgICAgJHByZXZpb3VzRGVwcmVjaWF0aW9uICs9ICRkZXByZWNpYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Z2V0Q29tcGF0aWJpbGl0eU1vZGUoKSA9PSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkNPTVBBVElCSUxJVFlfR05VTUVSSUMpIHsKICAgICAgICAgICAgICAgICRkZXByZWNpYXRpb24gPSByb3VuZCgkZGVwcmVjaWF0aW9uLCAyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJGRlcHJlY2lhdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBESVNDCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgZGlzY291bnQgcmF0ZSBmb3IgYSBzZWN1cml0eS4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBESVNDKHNldHRsZW1lbnQsbWF0dXJpdHkscHJpY2UscmVkZW1wdGlvblssYmFzaXNdKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIG1peGVkICAgIHNldHRsZW1lbnQgICAgVGhlIHNlY3VyaXR5J3Mgc2V0dGxlbWVudCBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBzZWN1cml0eSBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZSB3aGVuIHRoZSBzZWN1cml0eSBpcyB0cmFkZWQgdG8gdGhlIGJ1eWVyLgogICAgICogQHBhcmFtICAgIG1peGVkICAgIG1hdHVyaXR5ICAgIFRoZSBzZWN1cml0eSdzIG1hdHVyaXR5IGRhdGUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG1hdHVyaXR5IGRhdGUgaXMgdGhlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgZXhwaXJlcy4KICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgIHByaWNlICAgICAgICBUaGUgc2VjdXJpdHkncyBwcmljZSBwZXIgJDEwMCBmYWNlIHZhbHVlLgogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgcmVkZW1wdGlvbiAgICBUaGUgc2VjdXJpdHkncyByZWRlbXB0aW9uIHZhbHVlIHBlciAkMTAwIGZhY2UgdmFsdWUuCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICBiYXNpcyAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIERJU0MoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJHByaWNlLCAkcmVkZW1wdGlvbiwgJGJhc2lzID0gMCkKICAgIHsKICAgICAgICAkc2V0dGxlbWVudCAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRzZXR0bGVtZW50KTsKICAgICAgICAkbWF0dXJpdHkgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbWF0dXJpdHkpOwogICAgICAgICRwcmljZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcHJpY2UpOwogICAgICAgICRyZWRlbXB0aW9uICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJlZGVtcHRpb24pOwogICAgICAgICRiYXNpcyAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYmFzaXMpOwoKICAgICAgICAvLyAgICBWYWxpZGF0ZQogICAgICAgIGlmICgoaXNfbnVtZXJpYygkcHJpY2UpKSAmJiAoaXNfbnVtZXJpYygkcmVkZW1wdGlvbikpICYmIChpc19udW1lcmljKCRiYXNpcykpKSB7CiAgICAgICAgICAgICRwcmljZSAgICAgICAgPSAoZmxvYXQpICRwcmljZTsKICAgICAgICAgICAgJHJlZGVtcHRpb24gICAgPSAoZmxvYXQpICRyZWRlbXB0aW9uOwogICAgICAgICAgICAkYmFzaXMgICAgICAgID0gKGludCkgJGJhc2lzOwogICAgICAgICAgICBpZiAoKCRwcmljZSA8PSAwKSB8fCAoJHJlZGVtcHRpb24gPD0gMCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5KSkgewogICAgICAgICAgICAgICAgLy8gICAgcmV0dXJuIGRhdGUgZXJyb3IKICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAoKDEgLSAkcHJpY2UgLyAkcmVkZW1wdGlvbikgLyAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIERPTExBUkRFCiAgICAgKgogICAgICogQ29udmVydHMgYSBkb2xsYXIgcHJpY2UgZXhwcmVzc2VkIGFzIGFuIGludGVnZXIgcGFydCBhbmQgYSBmcmFjdGlvbgogICAgICogICAgICAgIHBhcnQgaW50byBhIGRvbGxhciBwcmljZSBleHByZXNzZWQgYXMgYSBkZWNpbWFsIG51bWJlci4KICAgICAqIEZyYWN0aW9uYWwgZG9sbGFyIG51bWJlcnMgYXJlIHNvbWV0aW1lcyB1c2VkIGZvciBzZWN1cml0eSBwcmljZXMuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgRE9MTEFSREUoZnJhY3Rpb25hbF9kb2xsYXIsZnJhY3Rpb24pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBGaW5hbmNpYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJGZyYWN0aW9uYWxfZG9sbGFyICAgIEZyYWN0aW9uYWwgRG9sbGFyCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICAkZnJhY3Rpb24gICAgICAgICAgICBGcmFjdGlvbgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIERPTExBUkRFKCRmcmFjdGlvbmFsX2RvbGxhciA9IG51bGwsICRmcmFjdGlvbiA9IDApCiAgICB7CiAgICAgICAgJGZyYWN0aW9uYWxfZG9sbGFyICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZyYWN0aW9uYWxfZG9sbGFyKTsKICAgICAgICAkZnJhY3Rpb24gICAgICAgICAgICA9IChpbnQpUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZyYWN0aW9uKTsKCiAgICAgICAgLy8gVmFsaWRhdGUgcGFyYW1ldGVycwogICAgICAgIGlmIChpc19udWxsKCRmcmFjdGlvbmFsX2RvbGxhcikgfHwgJGZyYWN0aW9uIDwgMCkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CiAgICAgICAgaWYgKCRmcmFjdGlvbiA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OkRJVjAoKTsKICAgICAgICB9CgogICAgICAgICRkb2xsYXJzID0gZmxvb3IoJGZyYWN0aW9uYWxfZG9sbGFyKTsKICAgICAgICAkY2VudHMgPSBmbW9kKCRmcmFjdGlvbmFsX2RvbGxhciwgMSk7CiAgICAgICAgJGNlbnRzIC89ICRmcmFjdGlvbjsKICAgICAgICAkY2VudHMgKj0gcG93KDEwLCBjZWlsKGxvZzEwKCRmcmFjdGlvbikpKTsKICAgICAgICByZXR1cm4gJGRvbGxhcnMgKyAkY2VudHM7CiAgICB9CgoKICAgIC8qKgogICAgICogRE9MTEFSRlIKICAgICAqCiAgICAgKiBDb252ZXJ0cyBhIGRvbGxhciBwcmljZSBleHByZXNzZWQgYXMgYSBkZWNpbWFsIG51bWJlciBpbnRvIGEgZG9sbGFyIHByaWNlCiAgICAgKiAgICAgICAgZXhwcmVzc2VkIGFzIGEgZnJhY3Rpb24uCiAgICAgKiBGcmFjdGlvbmFsIGRvbGxhciBudW1iZXJzIGFyZSBzb21ldGltZXMgdXNlZCBmb3Igc2VjdXJpdHkgcHJpY2VzLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIERPTExBUkZSKGRlY2ltYWxfZG9sbGFyLGZyYWN0aW9uKQogICAgICoKICAgICAqIEBhY2Nlc3MgICAgcHVibGljCiAgICAgKiBAY2F0ZWdvcnkgRmluYW5jaWFsIEZ1bmN0aW9ucwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRkZWNpbWFsX2RvbGxhciAgICAgICAgRGVjaW1hbCBEb2xsYXIKICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICRmcmFjdGlvbiAgICAgICAgICAgIEZyYWN0aW9uCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gRE9MTEFSRlIoJGRlY2ltYWxfZG9sbGFyID0gbnVsbCwgJGZyYWN0aW9uID0gMCkKICAgIHsKICAgICAgICAkZGVjaW1hbF9kb2xsYXIgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZGVjaW1hbF9kb2xsYXIpOwogICAgICAgICRmcmFjdGlvbiAgICAgICAgPSAoaW50KVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRmcmFjdGlvbik7CgogICAgICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMKICAgICAgICBpZiAoaXNfbnVsbCgkZGVjaW1hbF9kb2xsYXIpIHx8ICRmcmFjdGlvbiA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgfQogICAgICAgIGlmICgkZnJhY3Rpb24gPT0gMCkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpESVYwKCk7CiAgICAgICAgfQoKICAgICAgICAkZG9sbGFycyA9IGZsb29yKCRkZWNpbWFsX2RvbGxhcik7CiAgICAgICAgJGNlbnRzID0gZm1vZCgkZGVjaW1hbF9kb2xsYXIsIDEpOwogICAgICAgICRjZW50cyAqPSAkZnJhY3Rpb247CiAgICAgICAgJGNlbnRzICo9IHBvdygxMCwgLWNlaWwobG9nMTAoJGZyYWN0aW9uKSkpOwogICAgICAgIHJldHVybiAkZG9sbGFycyArICRjZW50czsKICAgIH0KCgogICAgLyoqCiAgICAgKiBFRkZFQ1QKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBlZmZlY3RpdmUgaW50ZXJlc3QgcmF0ZSBnaXZlbiB0aGUgbm9taW5hbCByYXRlIGFuZCB0aGUgbnVtYmVyIG9mCiAgICAgKiAgICAgICAgY29tcG91bmRpbmcgcGF5bWVudHMgcGVyIHllYXIuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgRUZGRUNUKG5vbWluYWxfcmF0ZSxucGVyeSkKICAgICAqCiAgICAgKiBAYWNjZXNzICAgIHB1YmxpYwogICAgICogQGNhdGVnb3J5IEZpbmFuY2lhbCBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkbm9taW5hbF9yYXRlICAgICAgICBOb21pbmFsIGludGVyZXN0IHJhdGUKICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICRucGVyeSAgICAgICAgICAgICAgICBOdW1iZXIgb2YgY29tcG91bmRpbmcgcGF5bWVudHMgcGVyIHllYXIKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBFRkZFQ1QoJG5vbWluYWxfcmF0ZSA9IDAsICRucGVyeSA9IDApCiAgICB7CiAgICAgICAgJG5vbWluYWxfcmF0ZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRub21pbmFsX3JhdGUpOwogICAgICAgICRucGVyeSAgICAgICAgICAgID0gKGludClQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbnBlcnkpOwoKICAgICAgICAvLyBWYWxpZGF0ZSBwYXJhbWV0ZXJzCiAgICAgICAgaWYgKCRub21pbmFsX3JhdGUgPD0gMCB8fCAkbnBlcnkgPCAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBvdygoMSArICRub21pbmFsX3JhdGUgLyAkbnBlcnkpLCAkbnBlcnkpIC0gMTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBGVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIEZ1dHVyZSBWYWx1ZSBvZiBhIGNhc2ggZmxvdyB3aXRoIGNvbnN0YW50IHBheW1lbnRzIGFuZCBpbnRlcmVzdCByYXRlIChhbm51aXRpZXMpLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIEZWKHJhdGUsbnBlcixwbXRbLHB2Wyx0eXBlXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBGaW5hbmNpYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHJhdGUgICAgVGhlIGludGVyZXN0IHJhdGUgcGVyIHBlcmlvZAogICAgICogQHBhcmFtICAgIGludCAgICAgICAgJG5wZXIgICAgVG90YWwgbnVtYmVyIG9mIHBheW1lbnQgcGVyaW9kcyBpbiBhbiBhbm51aXR5CiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHBtdCAgICBUaGUgcGF5bWVudCBtYWRlIGVhY2ggcGVyaW9kOiBpdCBjYW5ub3QgY2hhbmdlIG92ZXIgdGhlCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWZlIG9mIHRoZSBhbm51aXR5LiBUeXBpY2FsbHksIHBtdCBjb250YWlucyBwcmluY2lwYWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBpbnRlcmVzdCBidXQgbm8gb3RoZXIgZmVlcyBvciB0YXhlcy4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkcHYgICAgICAgIFByZXNlbnQgVmFsdWUsIG9yIHRoZSBsdW1wLXN1bSBhbW91bnQgdGhhdCBhIHNlcmllcyBvZgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnV0dXJlIHBheW1lbnRzIGlzIHdvcnRoIHJpZ2h0IG5vdy4KICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICR0eXBlICAgIEEgbnVtYmVyIDAgb3IgMSBhbmQgaW5kaWNhdGVzIHdoZW4gcGF5bWVudHMgYXJlIGR1ZToKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwIG9yIG9taXR0ZWQgICAgQXQgdGhlIGVuZCBvZiB0aGUgcGVyaW9kLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgQXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgcGVyaW9kLgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEZWKCRyYXRlID0gMCwgJG5wZXIgPSAwLCAkcG10ID0gMCwgJHB2ID0gMCwgJHR5cGUgPSAwKQogICAgewogICAgICAgICRyYXRlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJhdGUpOwogICAgICAgICRucGVyICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG5wZXIpOwogICAgICAgICRwbXQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcG10KTsKICAgICAgICAkcHYgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHB2KTsKICAgICAgICAkdHlwZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR0eXBlKTsKCiAgICAgICAgLy8gVmFsaWRhdGUgcGFyYW1ldGVycwogICAgICAgIGlmICgkdHlwZSAhPSAwICYmICR0eXBlICE9IDEpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUKICAgICAgICBpZiAoIWlzX251bGwoJHJhdGUpICYmICRyYXRlICE9IDApIHsKICAgICAgICAgICAgcmV0dXJuIC0kcHYgKiBwb3coMSArICRyYXRlLCAkbnBlcikgLSAkcG10ICogKDEgKyAkcmF0ZSAqICR0eXBlKSAqIChwb3coMSArICRyYXRlLCAkbnBlcikgLSAxKSAvICRyYXRlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gLSRwdiAtICRwbXQgKiAkbnBlcjsKICAgIH0KCgogICAgLyoqCiAgICAgKiBGVlNDSEVEVUxFCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgZnV0dXJlIHZhbHVlIG9mIGFuIGluaXRpYWwgcHJpbmNpcGFsIGFmdGVyIGFwcGx5aW5nIGEgc2VyaWVzIG9mIGNvbXBvdW5kIGludGVyZXN0IHJhdGVzLgogICAgICogVXNlIEZWU0NIRURVTEUgdG8gY2FsY3VsYXRlIHRoZSBmdXR1cmUgdmFsdWUgb2YgYW4gaW52ZXN0bWVudCB3aXRoIGEgdmFyaWFibGUgb3IgYWRqdXN0YWJsZSByYXRlLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIEZWU0NIRURVTEUocHJpbmNpcGFsLHNjaGVkdWxlKQogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkcHJpbmNpcGFsICAgIFRoZSBwcmVzZW50IHZhbHVlLgogICAgICogQHBhcmFtICAgIGZsb2F0W10gICAgJHNjaGVkdWxlICAgIEFuIGFycmF5IG9mIGludGVyZXN0IHJhdGVzIHRvIGFwcGx5LgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIEZWU0NIRURVTEUoJHByaW5jaXBhbCwgJHNjaGVkdWxlKQogICAgewogICAgICAgICRwcmluY2lwYWwgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcHJpbmNpcGFsKTsKICAgICAgICAkc2NoZWR1bGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkc2NoZWR1bGUpOwoKICAgICAgICBmb3JlYWNoICgkc2NoZWR1bGUgYXMgJHJhdGUpIHsKICAgICAgICAgICAgJHByaW5jaXBhbCAqPSAxICsgJHJhdGU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHByaW5jaXBhbDsKICAgIH0KCgogICAgLyoqCiAgICAgKiBJTlRSQVRFCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgaW50ZXJlc3QgcmF0ZSBmb3IgYSBmdWxseSBpbnZlc3RlZCBzZWN1cml0eS4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBJTlRSQVRFKHNldHRsZW1lbnQsbWF0dXJpdHksaW52ZXN0bWVudCxyZWRlbXB0aW9uWyxiYXNpc10pCiAgICAgKgogICAgICogQHBhcmFtICAgIG1peGVkICAgICRzZXR0bGVtZW50ICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkgc2V0dGxlbWVudCBkYXRlIGlzIHRoZSBkYXRlIGFmdGVyIHRoZSBpc3N1ZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGlzIHRyYWRlZCB0byB0aGUgYnV5ZXIuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgJG1hdHVyaXR5ICAgIFRoZSBzZWN1cml0eSdzIG1hdHVyaXR5IGRhdGUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG1hdHVyaXR5IGRhdGUgaXMgdGhlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgZXhwaXJlcy4KICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICRpbnZlc3RtZW50ICAgIFRoZSBhbW91bnQgaW52ZXN0ZWQgaW4gdGhlIHNlY3VyaXR5LgogICAgICogQHBhcmFtICAgIGludGVnZXIgICAgJHJlZGVtcHRpb24gICAgVGhlIGFtb3VudCB0byBiZSByZWNlaXZlZCBhdCBtYXR1cml0eS4KICAgICAqIEBwYXJhbSAgICBpbnRlZ2VyICAgICRiYXNpcyAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIElOVFJBVEUoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGludmVzdG1lbnQsICRyZWRlbXB0aW9uLCAkYmFzaXMgPSAwKQogICAgewogICAgICAgICRzZXR0bGVtZW50ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNldHRsZW1lbnQpOwogICAgICAgICRtYXR1cml0eSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtYXR1cml0eSk7CiAgICAgICAgJGludmVzdG1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkaW52ZXN0bWVudCk7CiAgICAgICAgJHJlZGVtcHRpb24gICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmVkZW1wdGlvbik7CiAgICAgICAgJGJhc2lzICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiYXNpcyk7CgogICAgICAgIC8vICAgIFZhbGlkYXRlCiAgICAgICAgaWYgKChpc19udW1lcmljKCRpbnZlc3RtZW50KSkgJiYgKGlzX251bWVyaWMoJHJlZGVtcHRpb24pKSAmJiAoaXNfbnVtZXJpYygkYmFzaXMpKSkgewogICAgICAgICAgICAkaW52ZXN0bWVudCAgICA9IChmbG9hdCkgJGludmVzdG1lbnQ7CiAgICAgICAgICAgICRyZWRlbXB0aW9uICAgID0gKGZsb2F0KSAkcmVkZW1wdGlvbjsKICAgICAgICAgICAgJGJhc2lzICAgICAgICA9IChpbnQpICRiYXNpczsKICAgICAgICAgICAgaWYgKCgkaW52ZXN0bWVudCA8PSAwKSB8fCAoJHJlZGVtcHRpb24gPD0gMCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5KSkgewogICAgICAgICAgICAgICAgLy8gICAgcmV0dXJuIGRhdGUgZXJyb3IKICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAoKCRyZWRlbXB0aW9uIC8gJGludmVzdG1lbnQpIC0gMSkgLyAoJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBJUE1UCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgaW50ZXJlc3QgcGF5bWVudCBmb3IgYSBnaXZlbiBwZXJpb2QgZm9yIGFuIGludmVzdG1lbnQgYmFzZWQgb24gcGVyaW9kaWMsIGNvbnN0YW50IHBheW1lbnRzIGFuZCBhIGNvbnN0YW50IGludGVyZXN0IHJhdGUuCiAgICAgKgogICAgICogRXhjZWwgRnVuY3Rpb246CiAgICAgKiAgICAgICAgSVBNVChyYXRlLHBlcixucGVyLHB2Wyxmdl1bLHR5cGVdKQogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkcmF0ZSAgICBJbnRlcmVzdCByYXRlIHBlciBwZXJpb2QKICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgICRwZXIgICAgUGVyaW9kIGZvciB3aGljaCB3ZSB3YW50IHRvIGZpbmQgdGhlIGludGVyZXN0CiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICAkbnBlciAgICBOdW1iZXIgb2YgcGVyaW9kcwogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRwdiAgICAgICAgUHJlc2VudCBWYWx1ZQogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRmdiAgICAgICAgRnV0dXJlIFZhbHVlCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICAkdHlwZSAgICBQYXltZW50IHR5cGU6IDAgPSBhdCB0aGUgZW5kIG9mIGVhY2ggcGVyaW9kLCAxID0gYXQgdGhlIGJlZ2lubmluZyBvZiBlYWNoIHBlcmlvZAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIElQTVQoJHJhdGUsICRwZXIsICRucGVyLCAkcHYsICRmdiA9IDAsICR0eXBlID0gMCkKICAgIHsKICAgICAgICAkcmF0ZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRyYXRlKTsKICAgICAgICAkcGVyICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHBlcik7CiAgICAgICAgJG5wZXIgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbnBlcik7CiAgICAgICAgJHB2ICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwdik7CiAgICAgICAgJGZ2ICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRmdik7CiAgICAgICAgJHR5cGUgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdHlwZSk7CgogICAgICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMKICAgICAgICBpZiAoJHR5cGUgIT0gMCAmJiAkdHlwZSAhPSAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KICAgICAgICBpZiAoJHBlciA8PSAwIHx8ICRwZXIgPiAkbnBlcikgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FsY3VsYXRlCiAgICAgICAgJGludGVyZXN0QW5kUHJpbmNpcGFsID0gc2VsZjo6aW50ZXJlc3RBbmRQcmluY2lwYWwoJHJhdGUsICRwZXIsICRucGVyLCAkcHYsICRmdiwgJHR5cGUpOwogICAgICAgIHJldHVybiAkaW50ZXJlc3RBbmRQcmluY2lwYWxbMF07CiAgICB9CgogICAgLyoqCiAgICAgKiBJUlIKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBpbnRlcm5hbCByYXRlIG9mIHJldHVybiBmb3IgYSBzZXJpZXMgb2YgY2FzaCBmbG93cyByZXByZXNlbnRlZCBieSB0aGUgbnVtYmVycyBpbiB2YWx1ZXMuCiAgICAgKiBUaGVzZSBjYXNoIGZsb3dzIGRvIG5vdCBoYXZlIHRvIGJlIGV2ZW4sIGFzIHRoZXkgd291bGQgYmUgZm9yIGFuIGFubnVpdHkuIEhvd2V2ZXIsIHRoZSBjYXNoIGZsb3dzIG11c3Qgb2NjdXIKICAgICAqIGF0IHJlZ3VsYXIgaW50ZXJ2YWxzLCBzdWNoIGFzIG1vbnRobHkgb3IgYW5udWFsbHkuIFRoZSBpbnRlcm5hbCByYXRlIG9mIHJldHVybiBpcyB0aGUgaW50ZXJlc3QgcmF0ZSByZWNlaXZlZAogICAgICogZm9yIGFuIGludmVzdG1lbnQgY29uc2lzdGluZyBvZiBwYXltZW50cyAobmVnYXRpdmUgdmFsdWVzKSBhbmQgaW5jb21lIChwb3NpdGl2ZSB2YWx1ZXMpIHRoYXQgb2NjdXIgYXQgcmVndWxhcgogICAgICogcGVyaW9kcy4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBJUlIodmFsdWVzWyxndWVzc10pCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0W10gICAgJHZhbHVlcyAgICAgICAgQW4gYXJyYXkgb3IgYSByZWZlcmVuY2UgdG8gY2VsbHMgdGhhdCBjb250YWluIG51bWJlcnMgZm9yIHdoaWNoIHlvdSB3YW50CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGNhbGN1bGF0ZSB0aGUgaW50ZXJuYWwgcmF0ZSBvZiByZXR1cm4uCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVmFsdWVzIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgcG9zaXRpdmUgdmFsdWUgYW5kIG9uZSBuZWdhdGl2ZSB2YWx1ZSB0bwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxjdWxhdGUgdGhlIGludGVybmFsIHJhdGUgb2YgcmV0dXJuLgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRndWVzcyAgICAgICAgQSBudW1iZXIgdGhhdCB5b3UgZ3Vlc3MgaXMgY2xvc2UgdG8gdGhlIHJlc3VsdCBvZiBJUlIKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBJUlIoJHZhbHVlcywgJGd1ZXNzID0gMC4xKQogICAgewogICAgICAgIGlmICghaXNfYXJyYXkoJHZhbHVlcykpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgJHZhbHVlcyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCR2YWx1ZXMpOwogICAgICAgICRndWVzcyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRndWVzcyk7CgogICAgICAgIC8vIGNyZWF0ZSBhbiBpbml0aWFsIHJhbmdlLCB3aXRoIGEgcm9vdCBzb21ld2hlcmUgYmV0d2VlbiAwIGFuZCBndWVzcwogICAgICAgICR4MSA9IDAuMDsKICAgICAgICAkeDIgPSAkZ3Vlc3M7CiAgICAgICAgJGYxID0gc2VsZjo6TlBWKCR4MSwgJHZhbHVlcyk7CiAgICAgICAgJGYyID0gc2VsZjo6TlBWKCR4MiwgJHZhbHVlcyk7CiAgICAgICAgZm9yICgkaSA9IDA7ICRpIDwgRklOQU5DSUFMX01BWF9JVEVSQVRJT05TOyArKyRpKSB7CiAgICAgICAgICAgIGlmICgoJGYxICogJGYyKSA8IDAuMCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGFicygkZjEpIDwgYWJzKCRmMikpIHsKICAgICAgICAgICAgICAgICRmMSA9IHNlbGY6Ok5QVigkeDEgKz0gMS42ICogKCR4MSAtICR4MiksICR2YWx1ZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJGYyID0gc2VsZjo6TlBWKCR4MiArPSAxLjYgKiAoJHgyIC0gJHgxKSwgJHZhbHVlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCgkZjEgKiAkZjIpID4gMC4wKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQoKICAgICAgICAkZiA9IHNlbGY6Ok5QVigkeDEsICR2YWx1ZXMpOwogICAgICAgIGlmICgkZiA8IDAuMCkgewogICAgICAgICAgICAkcnRiID0gJHgxOwogICAgICAgICAgICAkZHggPSAkeDIgLSAkeDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJHJ0YiA9ICR4MjsKICAgICAgICAgICAgJGR4ID0gJHgxIC0gJHgyOwogICAgICAgIH0KCiAgICAgICAgZm9yICgkaSA9IDA7ICRpIDwgRklOQU5DSUFMX01BWF9JVEVSQVRJT05TOyArKyRpKSB7CiAgICAgICAgICAgICRkeCAqPSAwLjU7CiAgICAgICAgICAgICR4X21pZCA9ICRydGIgKyAkZHg7CiAgICAgICAgICAgICRmX21pZCA9IHNlbGY6Ok5QVigkeF9taWQsICR2YWx1ZXMpOwogICAgICAgICAgICBpZiAoJGZfbWlkIDw9IDAuMCkgewogICAgICAgICAgICAgICAgJHJ0YiA9ICR4X21pZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGFicygkZl9taWQpIDwgRklOQU5DSUFMX1BSRUNJU0lPTikgfHwgKGFicygkZHgpIDwgRklOQU5DSUFMX1BSRUNJU0lPTikpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkeF9taWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBJU1BNVAogICAgICoKICAgICAqIFJldHVybnMgdGhlIGludGVyZXN0IHBheW1lbnQgZm9yIGFuIGludmVzdG1lbnQgYmFzZWQgb24gYW4gaW50ZXJlc3QgcmF0ZSBhbmQgYSBjb25zdGFudCBwYXltZW50IHNjaGVkdWxlLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgID1JU1BNVChpbnRlcmVzdF9yYXRlLCBwZXJpb2QsIG51bWJlcl9wYXltZW50cywgUFYpCiAgICAgKgogICAgICogaW50ZXJlc3RfcmF0ZSBpcyB0aGUgaW50ZXJlc3QgcmF0ZSBmb3IgdGhlIGludmVzdG1lbnQKICAgICAqCiAgICAgKiBwZXJpb2QgaXMgdGhlIHBlcmlvZCB0byBjYWxjdWxhdGUgdGhlIGludGVyZXN0IHJhdGUuICBJdCBtdXN0IGJlIGJldHdlZWVuIDEgYW5kIG51bWJlcl9wYXltZW50cy4KICAgICAqCiAgICAgKiBudW1iZXJfcGF5bWVudHMgaXMgdGhlIG51bWJlciBvZiBwYXltZW50cyBmb3IgdGhlIGFubnVpdHkKICAgICAqCiAgICAgKiBQViBpcyB0aGUgbG9hbiBhbW91bnQgb3IgcHJlc2VudCB2YWx1ZSBvZiB0aGUgcGF5bWVudHMKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBJU1BNVCgpCiAgICB7CiAgICAgICAgLy8gUmV0dXJuIHZhbHVlCiAgICAgICAgJHJldHVyblZhbHVlID0gMDsKCiAgICAgICAgLy8gR2V0IHRoZSBwYXJhbWV0ZXJzCiAgICAgICAgJGFBcmdzID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoZnVuY19nZXRfYXJncygpKTsKICAgICAgICAkaW50ZXJlc3RSYXRlID0gYXJyYXlfc2hpZnQoJGFBcmdzKTsKICAgICAgICAkcGVyaW9kID0gYXJyYXlfc2hpZnQoJGFBcmdzKTsKICAgICAgICAkbnVtYmVyUGVyaW9kcyA9IGFycmF5X3NoaWZ0KCRhQXJncyk7CiAgICAgICAgJHByaW5jaXBsZVJlbWFpbmluZyA9IGFycmF5X3NoaWZ0KCRhQXJncyk7CgogICAgICAgIC8vIENhbGN1bGF0ZQogICAgICAgICRwcmluY2lwbGVQYXltZW50ID0gKCRwcmluY2lwbGVSZW1haW5pbmcgKiAxLjApIC8gKCRudW1iZXJQZXJpb2RzICogMS4wKTsKICAgICAgICBmb3IgKCRpPTA7ICRpIDw9ICRwZXJpb2Q7ICsrJGkpIHsKICAgICAgICAgICAgJHJldHVyblZhbHVlID0gJGludGVyZXN0UmF0ZSAqICRwcmluY2lwbGVSZW1haW5pbmcgKiAtMTsKICAgICAgICAgICAgJHByaW5jaXBsZVJlbWFpbmluZyAtPSAkcHJpbmNpcGxlUGF5bWVudDsKICAgICAgICAgICAgLy8gcHJpbmNpcGxlIG5lZWRzIHRvIGJlIDAgYWZ0ZXIgdGhlIGxhc3QgcGF5bWVudCwgZG9uJ3QgbGV0IGZsb2F0aW5nIHBvaW50IHNjcmV3IGl0IHVwCiAgICAgICAgICAgIGlmICgkaSA9PSAkbnVtYmVyUGVyaW9kcykgewogICAgICAgICAgICAgICAgJHJldHVyblZhbHVlID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4oJHJldHVyblZhbHVlKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBNSVJSCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgbW9kaWZpZWQgaW50ZXJuYWwgcmF0ZSBvZiByZXR1cm4gZm9yIGEgc2VyaWVzIG9mIHBlcmlvZGljIGNhc2ggZmxvd3MuIE1JUlIgY29uc2lkZXJzIGJvdGgKICAgICAqICAgICAgICB0aGUgY29zdCBvZiB0aGUgaW52ZXN0bWVudCBhbmQgdGhlIGludGVyZXN0IHJlY2VpdmVkIG9uIHJlaW52ZXN0bWVudCBvZiBjYXNoLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgIE1JUlIodmFsdWVzLGZpbmFuY2VfcmF0ZSwgcmVpbnZlc3RtZW50X3JhdGUpCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0W10gICAgJHZhbHVlcyAgICAgICAgICAgICAgICBBbiBhcnJheSBvciBhIHJlZmVyZW5jZSB0byBjZWxscyB0aGF0IGNvbnRhaW4gYSBzZXJpZXMgb2YgcGF5bWVudHMgYW5kCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5jb21lIG9jY3VycmluZyBhdCByZWd1bGFyIGludGVydmFscy4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBheW1lbnRzIGFyZSBuZWdhdGl2ZSB2YWx1ZSwgaW5jb21lIGlzIHBvc2l0aXZlIHZhbHVlcy4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkZmluYW5jZV9yYXRlICAgICAgICBUaGUgaW50ZXJlc3QgcmF0ZSB5b3UgcGF5IG9uIHRoZSBtb25leSB1c2VkIGluIHRoZSBjYXNoIGZsb3dzCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHJlaW52ZXN0bWVudF9yYXRlICAgIFRoZSBpbnRlcmVzdCByYXRlIHlvdSByZWNlaXZlIG9uIHRoZSBjYXNoIGZsb3dzIGFzIHlvdSByZWludmVzdCB0aGVtCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gTUlSUigkdmFsdWVzLCAkZmluYW5jZV9yYXRlLCAkcmVpbnZlc3RtZW50X3JhdGUpCiAgICB7CiAgICAgICAgaWYgKCFpc19hcnJheSgkdmFsdWVzKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KICAgICAgICAkdmFsdWVzICAgICAgICAgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoJHZhbHVlcyk7CiAgICAgICAgJGZpbmFuY2VfcmF0ZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZmluYW5jZV9yYXRlKTsKICAgICAgICAkcmVpbnZlc3RtZW50X3JhdGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmVpbnZlc3RtZW50X3JhdGUpOwogICAgICAgICRuID0gY291bnQoJHZhbHVlcyk7CgogICAgICAgICRyciA9IDEuMCArICRyZWludmVzdG1lbnRfcmF0ZTsKICAgICAgICAkZnIgPSAxLjAgKyAkZmluYW5jZV9yYXRlOwoKICAgICAgICAkbnB2X3BvcyA9ICRucHZfbmVnID0gMC4wOwogICAgICAgIGZvcmVhY2ggKCR2YWx1ZXMgYXMgJGkgPT4gJHYpIHsKICAgICAgICAgICAgaWYgKCR2ID49IDApIHsKICAgICAgICAgICAgICAgICRucHZfcG9zICs9ICR2IC8gcG93KCRyciwgJGkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJG5wdl9uZWcgKz0gJHYgLyBwb3coJGZyLCAkaSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICgoJG5wdl9uZWcgPT0gMCkgfHwgKCRucHZfcG9zID09IDApIHx8ICgkcmVpbnZlc3RtZW50X3JhdGUgPD0gLTEpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQoKICAgICAgICAkbWlyciA9IHBvdygoLSRucHZfcG9zICogcG93KCRyciwgJG4pKQogICAgICAgICAgICAgICAgLyAoJG5wdl9uZWcgKiAoJHJyKSksICgxLjAgLyAoJG4gLSAxKSkpIC0gMS4wOwoKICAgICAgICByZXR1cm4gKGlzX2Zpbml0ZSgkbWlycikgPyAkbWlyciA6IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKSk7CiAgICB9CgoKICAgIC8qKgogICAgICogTk9NSU5BTAogICAgICoKICAgICAqIFJldHVybnMgdGhlIG5vbWluYWwgaW50ZXJlc3QgcmF0ZSBnaXZlbiB0aGUgZWZmZWN0aXZlIHJhdGUgYW5kIHRoZSBudW1iZXIgb2YgY29tcG91bmRpbmcgcGF5bWVudHMgcGVyIHllYXIuCiAgICAgKgogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRlZmZlY3RfcmF0ZSAgICBFZmZlY3RpdmUgaW50ZXJlc3QgcmF0ZQogICAgICogQHBhcmFtICAgIGludCAgICAgICAgJG5wZXJ5ICAgICAgICAgICAgTnVtYmVyIG9mIGNvbXBvdW5kaW5nIHBheW1lbnRzIHBlciB5ZWFyCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gTk9NSU5BTCgkZWZmZWN0X3JhdGUgPSAwLCAkbnBlcnkgPSAwKQogICAgewogICAgICAgICRlZmZlY3RfcmF0ZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRlZmZlY3RfcmF0ZSk7CiAgICAgICAgJG5wZXJ5ICAgICAgICAgICAgPSAoaW50KVBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRucGVyeSk7CgogICAgICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMKICAgICAgICBpZiAoJGVmZmVjdF9yYXRlIDw9IDAgfHwgJG5wZXJ5IDwgMSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CgogICAgICAgIC8vIENhbGN1bGF0ZQogICAgICAgIHJldHVybiAkbnBlcnkgKiAocG93KCRlZmZlY3RfcmF0ZSArIDEsIDEgLyAkbnBlcnkpIC0gMSk7CiAgICB9CgoKICAgIC8qKgogICAgICogTlBFUgogICAgICoKICAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBwZXJpb2RzIGZvciBhIGNhc2ggZmxvdyB3aXRoIGNvbnN0YW50IHBlcmlvZGljIHBheW1lbnRzIChhbm51aXRpZXMpLCBhbmQgaW50ZXJlc3QgcmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHJhdGUgICAgSW50ZXJlc3QgcmF0ZSBwZXIgcGVyaW9kCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICAkcG10ICAgIFBlcmlvZGljIHBheW1lbnQgKGFubnVpdHkpCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHB2ICAgICAgICBQcmVzZW50IFZhbHVlCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJGZ2ICAgICAgICBGdXR1cmUgVmFsdWUKICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgICR0eXBlICAgIFBheW1lbnQgdHlwZTogMCA9IGF0IHRoZSBlbmQgb2YgZWFjaCBwZXJpb2QsIDEgPSBhdCB0aGUgYmVnaW5uaW5nIG9mIGVhY2ggcGVyaW9kCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gTlBFUigkcmF0ZSA9IDAsICRwbXQgPSAwLCAkcHYgPSAwLCAkZnYgPSAwLCAkdHlwZSA9IDApCiAgICB7CiAgICAgICAgJHJhdGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJHBtdCAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwbXQpOwogICAgICAgICRwdiAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcHYpOwogICAgICAgICRmdiAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZnYpOwogICAgICAgICR0eXBlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHR5cGUpOwoKICAgICAgICAvLyBWYWxpZGF0ZSBwYXJhbWV0ZXJzCiAgICAgICAgaWYgKCR0eXBlICE9IDAgJiYgJHR5cGUgIT0gMSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CgogICAgICAgIC8vIENhbGN1bGF0ZQogICAgICAgIGlmICghaXNfbnVsbCgkcmF0ZSkgJiYgJHJhdGUgIT0gMCkgewogICAgICAgICAgICBpZiAoJHBtdCA9PSAwICYmICRwdiA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbG9nKCgkcG10ICogKDEgKyAkcmF0ZSAqICR0eXBlKSAvICRyYXRlIC0gJGZ2KSAvICgkcHYgKyAkcG10ICogKDEgKyAkcmF0ZSAqICR0eXBlKSAvICRyYXRlKSkgLyBsb2coMSArICRyYXRlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCRwbXQgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICgtJHB2IC0kZnYpIC8gJHBtdDsKICAgIH0KCiAgICAvKioKICAgICAqIE5QVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIE5ldCBQcmVzZW50IFZhbHVlIG9mIGEgY2FzaCBmbG93IHNlcmllcyBnaXZlbiBhIGRpc2NvdW50IHJhdGUuCiAgICAgKgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIE5QVigpCiAgICB7CiAgICAgICAgLy8gUmV0dXJuIHZhbHVlCiAgICAgICAgJHJldHVyblZhbHVlID0gMDsKCiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFyZ3VtZW50cwogICAgICAgICRhQXJncyA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KGZ1bmNfZ2V0X2FyZ3MoKSk7CgogICAgICAgIC8vIENhbGN1bGF0ZQogICAgICAgICRyYXRlID0gYXJyYXlfc2hpZnQoJGFBcmdzKTsKICAgICAgICBmb3IgKCRpID0gMTsgJGkgPD0gY291bnQoJGFBcmdzKTsgKyskaSkgewogICAgICAgICAgICAvLyBJcyBpdCBhIG51bWVyaWMgdmFsdWU\/CiAgICAgICAgICAgIGlmIChpc19udW1lcmljKCRhQXJnc1skaSAtIDFdKSkgewogICAgICAgICAgICAgICAgJHJldHVyblZhbHVlICs9ICRhQXJnc1skaSAtIDFdIC8gcG93KDEgKyAkcmF0ZSwgJGkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSZXR1cm4KICAgICAgICByZXR1cm4gJHJldHVyblZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUE1UCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgY29uc3RhbnQgcGF5bWVudCAoYW5udWl0eSkgZm9yIGEgY2FzaCBmbG93IHdpdGggYSBjb25zdGFudCBpbnRlcmVzdCByYXRlLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkcmF0ZSAgICBJbnRlcmVzdCByYXRlIHBlciBwZXJpb2QKICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgICRucGVyICAgIE51bWJlciBvZiBwZXJpb2RzCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHB2ICAgICAgICBQcmVzZW50IFZhbHVlCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJGZ2ICAgICAgICBGdXR1cmUgVmFsdWUKICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgICR0eXBlICAgIFBheW1lbnQgdHlwZTogMCA9IGF0IHRoZSBlbmQgb2YgZWFjaCBwZXJpb2QsIDEgPSBhdCB0aGUgYmVnaW5uaW5nIG9mIGVhY2ggcGVyaW9kCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gUE1UKCRyYXRlID0gMCwgJG5wZXIgPSAwLCAkcHYgPSAwLCAkZnYgPSAwLCAkdHlwZSA9IDApCiAgICB7CiAgICAgICAgJHJhdGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJG5wZXIgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbnBlcik7CiAgICAgICAgJHB2ICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwdik7CiAgICAgICAgJGZ2ICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRmdik7CiAgICAgICAgJHR5cGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkdHlwZSk7CgogICAgICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMKICAgICAgICBpZiAoJHR5cGUgIT0gMCAmJiAkdHlwZSAhPSAxKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FsY3VsYXRlCiAgICAgICAgaWYgKCFpc19udWxsKCRyYXRlKSAmJiAkcmF0ZSAhPSAwKSB7CiAgICAgICAgICAgIHJldHVybiAoLSRmdiAtICRwdiAqIHBvdygxICsgJHJhdGUsICRucGVyKSkgLyAoMSArICRyYXRlICogJHR5cGUpIC8gKChwb3coMSArICRyYXRlLCAkbnBlcikgLSAxKSAvICRyYXRlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICgtJHB2IC0gJGZ2KSAvICRucGVyOwogICAgfQoKCiAgICAvKioKICAgICAqIFBQTVQKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBpbnRlcmVzdCBwYXltZW50IGZvciBhIGdpdmVuIHBlcmlvZCBmb3IgYW4gaW52ZXN0bWVudCBiYXNlZCBvbiBwZXJpb2RpYywgY29uc3RhbnQgcGF5bWVudHMgYW5kIGEgY29uc3RhbnQgaW50ZXJlc3QgcmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHJhdGUgICAgSW50ZXJlc3QgcmF0ZSBwZXIgcGVyaW9kCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICAkcGVyICAgIFBlcmlvZCBmb3Igd2hpY2ggd2Ugd2FudCB0byBmaW5kIHRoZSBpbnRlcmVzdAogICAgICogQHBhcmFtICAgIGludCAgICAgICAgJG5wZXIgICAgTnVtYmVyIG9mIHBlcmlvZHMKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkcHYgICAgICAgIFByZXNlbnQgVmFsdWUKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkZnYgICAgICAgIEZ1dHVyZSBWYWx1ZQogICAgICogQHBhcmFtICAgIGludCAgICAgICAgJHR5cGUgICAgUGF5bWVudCB0eXBlOiAwID0gYXQgdGhlIGVuZCBvZiBlYWNoIHBlcmlvZCwgMSA9IGF0IHRoZSBiZWdpbm5pbmcgb2YgZWFjaCBwZXJpb2QKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBQUE1UKCRyYXRlLCAkcGVyLCAkbnBlciwgJHB2LCAkZnYgPSAwLCAkdHlwZSA9IDApCiAgICB7CiAgICAgICAgJHJhdGUgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJHBlciAgICA9IChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRwZXIpOwogICAgICAgICRucGVyICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG5wZXIpOwogICAgICAgICRwdiAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcHYpOwogICAgICAgICRmdiAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZnYpOwogICAgICAgICR0eXBlICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHR5cGUpOwoKICAgICAgICAvLyBWYWxpZGF0ZSBwYXJhbWV0ZXJzCiAgICAgICAgaWYgKCR0eXBlICE9IDAgJiYgJHR5cGUgIT0gMSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CiAgICAgICAgaWYgKCRwZXIgPD0gMCB8fCAkcGVyID4gJG5wZXIpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CgogICAgICAgIC8vIENhbGN1bGF0ZQogICAgICAgICRpbnRlcmVzdEFuZFByaW5jaXBhbCA9IHNlbGY6OmludGVyZXN0QW5kUHJpbmNpcGFsKCRyYXRlLCAkcGVyLCAkbnBlciwgJHB2LCAkZnYsICR0eXBlKTsKICAgICAgICByZXR1cm4gJGludGVyZXN0QW5kUHJpbmNpcGFsWzFdOwogICAgfQoKCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFBSSUNFKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRyYXRlLCAkeWllbGQsICRyZWRlbXB0aW9uLCAkZnJlcXVlbmN5LCAkYmFzaXMgPSAwKQogICAgewogICAgICAgICRzZXR0bGVtZW50ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNldHRsZW1lbnQpOwogICAgICAgICRtYXR1cml0eSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtYXR1cml0eSk7CiAgICAgICAgJHJhdGUgICAgICAgID0gKGZsb2F0KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJHlpZWxkICAgICAgICA9IChmbG9hdCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHlpZWxkKTsKICAgICAgICAkcmVkZW1wdGlvbiAgICA9IChmbG9hdCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJlZGVtcHRpb24pOwogICAgICAgICRmcmVxdWVuY3kgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZnJlcXVlbmN5KTsKICAgICAgICAkYmFzaXMgICAgICAgID0gKGlzX251bGwoJGJhc2lzKSkgICAgPyAwIDogICAgKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGJhc2lzKTsKCiAgICAgICAgaWYgKGlzX3N0cmluZygkc2V0dGxlbWVudCA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJHNldHRsZW1lbnQpKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNfc3RyaW5nKCRtYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJG1hdHVyaXR5KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CgogICAgICAgIGlmICgoJHNldHRsZW1lbnQgPiAkbWF0dXJpdHkpIHx8CiAgICAgICAgICAgICghc2VsZjo6aXNWYWxpZEZyZXF1ZW5jeSgkZnJlcXVlbmN5KSkgfHwKICAgICAgICAgICAgKCgkYmFzaXMgPCAwKSB8fCAoJGJhc2lzID4gNCkpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KCiAgICAgICAgJGRzYyA9IHNlbGY6OkNPVVBEQVlTTkMoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGZyZXF1ZW5jeSwgJGJhc2lzKTsKICAgICAgICAkZSA9IHNlbGY6OkNPVVBEQVlTKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksICRiYXNpcyk7CiAgICAgICAgJG4gPSBzZWxmOjpDT1VQTlVNKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRmcmVxdWVuY3ksICRiYXNpcyk7CiAgICAgICAgJGEgPSBzZWxmOjpDT1VQREFZQlMoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGZyZXF1ZW5jeSwgJGJhc2lzKTsKCiAgICAgICAgJGJhc2VZRiAgICA9IDEuMCArICgkeWllbGQgLyAkZnJlcXVlbmN5KTsKICAgICAgICAkcmZwICAgID0gMTAwICogKCRyYXRlIC8gJGZyZXF1ZW5jeSk7CiAgICAgICAgJGRlICAgID0gJGRzYyAvICRlOwoKICAgICAgICAkcmVzdWx0ID0gJHJlZGVtcHRpb24gLyBwb3coJGJhc2VZRiwgKC0tJG4gKyAkZGUpKTsKICAgICAgICBmb3IgKCRrID0gMDsgJGsgPD0gJG47ICsrJGspIHsKICAgICAgICAgICAgJHJlc3VsdCArPSAkcmZwIC8gKHBvdygkYmFzZVlGLCAoJGsgKyAkZGUpKSk7CiAgICAgICAgfQogICAgICAgICRyZXN1bHQgLT0gJHJmcCAqICgkYSAvICRlKTsKCiAgICAgICAgcmV0dXJuICRyZXN1bHQ7CiAgICB9CgoKICAgIC8qKgogICAgICogUFJJQ0VESVNDCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgcHJpY2UgcGVyICQxMDAgZmFjZSB2YWx1ZSBvZiBhIGRpc2NvdW50ZWQgc2VjdXJpdHkuCiAgICAgKgogICAgICogQHBhcmFtICAgIG1peGVkICAgIHNldHRsZW1lbnQgICAgVGhlIHNlY3VyaXR5J3Mgc2V0dGxlbWVudCBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBzZWN1cml0eSBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICBUaGUgc2VjdXJpdHkncyBtYXR1cml0eSBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBtYXR1cml0eSBkYXRlIGlzIHRoZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGV4cGlyZXMuCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICBkaXNjb3VudCAgICBUaGUgc2VjdXJpdHkncyBkaXNjb3VudCByYXRlLgogICAgICogQHBhcmFtICAgIGludCAgICAgICAgcmVkZW1wdGlvbiAgICBUaGUgc2VjdXJpdHkncyByZWRlbXB0aW9uIHZhbHVlIHBlciAkMTAwIGZhY2UgdmFsdWUuCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICBiYXNpcyAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFBSSUNFRElTQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkZGlzY291bnQsICRyZWRlbXB0aW9uLCAkYmFzaXMgPSAwKQogICAgewogICAgICAgICRzZXR0bGVtZW50ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNldHRsZW1lbnQpOwogICAgICAgICRtYXR1cml0eSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtYXR1cml0eSk7CiAgICAgICAgJGRpc2NvdW50ICAgID0gKGZsb2F0KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZGlzY291bnQpOwogICAgICAgICRyZWRlbXB0aW9uICAgID0gKGZsb2F0KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmVkZW1wdGlvbik7CiAgICAgICAgJGJhc2lzICAgICAgICA9IChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiYXNpcyk7CgogICAgICAgIC8vICAgIFZhbGlkYXRlCiAgICAgICAgaWYgKChpc19udW1lcmljKCRkaXNjb3VudCkpICYmIChpc19udW1lcmljKCRyZWRlbXB0aW9uKSkgJiYgKGlzX251bWVyaWMoJGJhc2lzKSkpIHsKICAgICAgICAgICAgaWYgKCgkZGlzY291bnQgPD0gMCkgfHwgKCRyZWRlbXB0aW9uIDw9IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUkZSQUMoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGJhc2lzKTsKICAgICAgICAgICAgaWYgKCFpc19udW1lcmljKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSkpIHsKICAgICAgICAgICAgICAgIC8vICAgIHJldHVybiBkYXRlIGVycm9yCiAgICAgICAgICAgICAgICByZXR1cm4gJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJHJlZGVtcHRpb24gKiAoMSAtICRkaXNjb3VudCAqICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogUFJJQ0VNQVQKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBwcmljZSBwZXIgJDEwMCBmYWNlIHZhbHVlIG9mIGEgc2VjdXJpdHkgdGhhdCBwYXlzIGludGVyZXN0IGF0IG1hdHVyaXR5LgogICAgICoKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzZXR0bGVtZW50ICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkncyBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICBUaGUgc2VjdXJpdHkncyBtYXR1cml0eSBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBtYXR1cml0eSBkYXRlIGlzIHRoZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGV4cGlyZXMuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgaXNzdWUgICAgICAgIFRoZSBzZWN1cml0eSdzIGlzc3VlIGRhdGUuCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICByYXRlICAgICAgICBUaGUgc2VjdXJpdHkncyBpbnRlcmVzdCByYXRlIGF0IGRhdGUgb2YgaXNzdWUuCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICB5aWVsZCAgICAgICAgVGhlIHNlY3VyaXR5J3MgYW5udWFsIHlpZWxkLgogICAgICogQHBhcmFtICAgIGludCAgICAgICAgYmFzaXMgICAgICAgIFRoZSB0eXBlIG9mIGRheSBjb3VudCB0byB1c2UuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwIG9yIG9taXR0ZWQgICAgVVMgKE5BU0QpIDMwLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICAgICAgICAgICAgICBBY3R1YWwvYWN0dWFsCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICAgICAgICAgICAgICAgIEFjdHVhbC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDMgICAgICAgICAgICAgICAgQWN0dWFsLzM2NQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgNCAgICAgICAgICAgICAgICBFdXJvcGVhbiAzMC8zNjAKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBQUklDRU1BVCgkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkaXNzdWUsICRyYXRlLCAkeWllbGQsICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkaXNzdWUgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGlzc3VlKTsKICAgICAgICAkcmF0ZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcmF0ZSk7CiAgICAgICAgJHlpZWxkICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR5aWVsZCk7CiAgICAgICAgJGJhc2lzICAgICAgICA9IChpbnQpIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRiYXNpcyk7CgogICAgICAgIC8vICAgIFZhbGlkYXRlCiAgICAgICAgaWYgKGlzX251bWVyaWMoJHJhdGUpICYmIGlzX251bWVyaWMoJHlpZWxkKSkgewogICAgICAgICAgICBpZiAoKCRyYXRlIDw9IDApIHx8ICgkeWllbGQgPD0gMCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkYXlzUGVyWWVhciA9IHNlbGY6OmRheXNQZXJZZWFyKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSKCRzZXR0bGVtZW50KSwgJGJhc2lzKTsKICAgICAgICAgICAgaWYgKCFpc19udW1lcmljKCRkYXlzUGVyWWVhcikpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c1BlclllYXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGRheXNCZXR3ZWVuSXNzdWVBbmRTZXR0bGVtZW50ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OllFQVJGUkFDKCRpc3N1ZSwgJHNldHRsZW1lbnQsICRiYXNpcyk7CiAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkZGF5c0JldHdlZW5Jc3N1ZUFuZFNldHRsZW1lbnQpKSB7CiAgICAgICAgICAgICAgICAvLyAgICByZXR1cm4gZGF0ZSBlcnJvcgogICAgICAgICAgICAgICAgcmV0dXJuICRkYXlzQmV0d2Vlbklzc3VlQW5kU2V0dGxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGF5c0JldHdlZW5Jc3N1ZUFuZFNldHRsZW1lbnQgKj0gJGRheXNQZXJZZWFyOwogICAgICAgICAgICAkZGF5c0JldHdlZW5Jc3N1ZUFuZE1hdHVyaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OllFQVJGUkFDKCRpc3N1ZSwgJG1hdHVyaXR5LCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNCZXR3ZWVuSXNzdWVBbmRNYXR1cml0eSkpIHsKICAgICAgICAgICAgICAgIC8vICAgIHJldHVybiBkYXRlIGVycm9yCiAgICAgICAgICAgICAgICByZXR1cm4gJGRheXNCZXR3ZWVuSXNzdWVBbmRNYXR1cml0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGF5c0JldHdlZW5Jc3N1ZUFuZE1hdHVyaXR5ICo9ICRkYXlzUGVyWWVhcjsKICAgICAgICAgICAgJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OllFQVJGUkFDKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRiYXNpcyk7CiAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkpKSB7CiAgICAgICAgICAgICAgICAvLyAgICByZXR1cm4gZGF0ZSBlcnJvcgogICAgICAgICAgICAgICAgcmV0dXJuICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkgKj0gJGRheXNQZXJZZWFyOwoKICAgICAgICAgICAgcmV0dXJuICgoMTAwICsgKCgkZGF5c0JldHdlZW5Jc3N1ZUFuZE1hdHVyaXR5IC8gJGRheXNQZXJZZWFyKSAqICRyYXRlICogMTAwKSkgLwogICAgICAgICAgICAgICAgICAgKDEgKyAoKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSAvICRkYXlzUGVyWWVhcikgKiAkeWllbGQpKSAtCiAgICAgICAgICAgICAgICAgICAoKCRkYXlzQmV0d2Vlbklzc3VlQW5kU2V0dGxlbWVudCAvICRkYXlzUGVyWWVhcikgKiAkcmF0ZSAqIDEwMCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIFBWCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgUHJlc2VudCBWYWx1ZSBvZiBhIGNhc2ggZmxvdyB3aXRoIGNvbnN0YW50IHBheW1lbnRzIGFuZCBpbnRlcmVzdCByYXRlIChhbm51aXRpZXMpLgogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAkcmF0ZSAgICBJbnRlcmVzdCByYXRlIHBlciBwZXJpb2QKICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgICRucGVyICAgIE51bWJlciBvZiBwZXJpb2RzCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgJHBtdCAgICBQZXJpb2RpYyBwYXltZW50IChhbm51aXR5KQogICAgICogQHBhcmFtICAgIGZsb2F0ICAgICRmdiAgICAgICAgRnV0dXJlIFZhbHVlCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICAkdHlwZSAgICBQYXltZW50IHR5cGU6IDAgPSBhdCB0aGUgZW5kIG9mIGVhY2ggcGVyaW9kLCAxID0gYXQgdGhlIGJlZ2lubmluZyBvZiBlYWNoIHBlcmlvZAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFBWKCRyYXRlID0gMCwgJG5wZXIgPSAwLCAkcG10ID0gMCwgJGZ2ID0gMCwgJHR5cGUgPSAwKQogICAgewogICAgICAgICRyYXRlICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJhdGUpOwogICAgICAgICRucGVyICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG5wZXIpOwogICAgICAgICRwbXQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcG10KTsKICAgICAgICAkZnYgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGZ2KTsKICAgICAgICAkdHlwZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCR0eXBlKTsKCiAgICAgICAgLy8gVmFsaWRhdGUgcGFyYW1ldGVycwogICAgICAgIGlmICgkdHlwZSAhPSAwICYmICR0eXBlICE9IDEpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUKICAgICAgICBpZiAoIWlzX251bGwoJHJhdGUpICYmICRyYXRlICE9IDApIHsKICAgICAgICAgICAgcmV0dXJuICgtJHBtdCAqICgxICsgJHJhdGUgKiAkdHlwZSkgKiAoKHBvdygxICsgJHJhdGUsICRucGVyKSAtIDEpIC8gJHJhdGUpIC0gJGZ2KSAvIHBvdygxICsgJHJhdGUsICRucGVyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0kZnYgLSAkcG10ICogJG5wZXI7CiAgICB9CgoKICAgIC8qKgogICAgICogUkFURQogICAgICoKICAgICAqIFJldHVybnMgdGhlIGludGVyZXN0IHJhdGUgcGVyIHBlcmlvZCBvZiBhbiBhbm51aXR5LgogICAgICogUkFURSBpcyBjYWxjdWxhdGVkIGJ5IGl0ZXJhdGlvbiBhbmQgY2FuIGhhdmUgemVybyBvciBtb3JlIHNvbHV0aW9ucy4KICAgICAqIElmIHRoZSBzdWNjZXNzaXZlIHJlc3VsdHMgb2YgUkFURSBkbyBub3QgY29udmVyZ2UgdG8gd2l0aGluIDAuMDAwMDAwMSBhZnRlciAyMCBpdGVyYXRpb25zLAogICAgICogUkFURSByZXR1cm5zIHRoZSAjTlVNISBlcnJvciB2YWx1ZS4KICAgICAqCiAgICAgKiBFeGNlbCBGdW5jdGlvbjoKICAgICAqICAgICAgICBSQVRFKG5wZXIscG10LHB2WyxmdlssdHlwZVssZ3Vlc3NdXV0pCiAgICAgKgogICAgICogQGFjY2VzcyAgICBwdWJsaWMKICAgICAqIEBjYXRlZ29yeSBGaW5hbmNpYWwgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgbnBlciAgICAgICAgVGhlIHRvdGFsIG51bWJlciBvZiBwYXltZW50IHBlcmlvZHMgaW4gYW4gYW5udWl0eS4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICBwbXQgICAgICAgICAgICBUaGUgcGF5bWVudCBtYWRlIGVhY2ggcGVyaW9kIGFuZCBjYW5ub3QgY2hhbmdlIG92ZXIgdGhlIGxpZmUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2YgdGhlIGFubnVpdHkuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVHlwaWNhbGx5LCBwbXQgaW5jbHVkZXMgcHJpbmNpcGFsIGFuZCBpbnRlcmVzdCBidXQgbm8gb3RoZXIKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVlcyBvciB0YXhlcy4KICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICBwdiAgICAgICAgICAgIFRoZSBwcmVzZW50IHZhbHVlIC0gdGhlIHRvdGFsIGFtb3VudCB0aGF0IGEgc2VyaWVzIG9mIGZ1dHVyZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXltZW50cyBpcyB3b3J0aCBub3cuCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgZnYgICAgICAgICAgICBUaGUgZnV0dXJlIHZhbHVlLCBvciBhIGNhc2ggYmFsYW5jZSB5b3Ugd2FudCB0byBhdHRhaW4gYWZ0ZXIKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIGxhc3QgcGF5bWVudCBpcyBtYWRlLiBJZiBmdiBpcyBvbWl0dGVkLCBpdCBpcyBhc3N1bWVkCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGJlIDAgKHRoZSBmdXR1cmUgdmFsdWUgb2YgYSBsb2FuLCBmb3IgZXhhbXBsZSwgaXMgMCkuCiAgICAgKiBAcGFyYW0gICAgaW50ZWdlciAgICB0eXBlICAgICAgICBBIG51bWJlciAwIG9yIDEgYW5kIGluZGljYXRlcyB3aGVuIHBheW1lbnRzIGFyZSBkdWU6CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwIG9yIG9taXR0ZWQgICAgQXQgdGhlIGVuZCBvZiB0aGUgcGVyaW9kLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSAgICAgICAgICAgICAgICBBdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBwZXJpb2QuCiAgICAgKiBAcGFyYW0gICAgZmxvYXQgICAgZ3Vlc3MgICAgICAgIFlvdXIgZ3Vlc3MgZm9yIHdoYXQgdGhlIHJhdGUgd2lsbCBiZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSWYgeW91IG9taXQgZ3Vlc3MsIGl0IGlzIGFzc3VtZWQgdG8gYmUgMTAgcGVyY2VudC4KICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gUkFURSgkbnBlciwgJHBtdCwgJHB2LCAkZnYgPSAwLjAsICR0eXBlID0gMCwgJGd1ZXNzID0gMC4xKQogICAgewogICAgICAgICRucGVyICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG5wZXIpOwogICAgICAgICRwbXQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcG10KTsKICAgICAgICAkcHYgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHB2KTsKICAgICAgICAkZnYgICAgICAgID0gKGlzX251bGwoJGZ2KSkgICAgPyAwLjAgICAgOiAgICBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZnYpOwogICAgICAgICR0eXBlICAgID0gKGlzX251bGwoJHR5cGUpKSAgICA\/IDAgICAgICAgIDogICAgKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHR5cGUpOwogICAgICAgICRndWVzcyAgICA9IChpc19udWxsKCRndWVzcykpICAgID8gMC4xICAgIDogICAgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGd1ZXNzKTsKCiAgICAgICAgJHJhdGUgPSAkZ3Vlc3M7CiAgICAgICAgaWYgKGFicygkcmF0ZSkgPCBGSU5BTkNJQUxfUFJFQ0lTSU9OKSB7CiAgICAgICAgICAgICR5ID0gJHB2ICogKDEgKyAkbnBlciAqICRyYXRlKSArICRwbXQgKiAoMSArICRyYXRlICogJHR5cGUpICogJG5wZXIgKyAkZnY7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGYgPSBleHAoJG5wZXIgKiBsb2coMSArICRyYXRlKSk7CiAgICAgICAgICAgICR5ID0gJHB2ICogJGYgKyAkcG10ICogKDEgLyAkcmF0ZSArICR0eXBlKSAqICgkZiAtIDEpICsgJGZ2OwogICAgICAgIH0KICAgICAgICAkeTAgPSAkcHYgKyAkcG10ICogJG5wZXIgKyAkZnY7CiAgICAgICAgJHkxID0gJHB2ICogJGYgKyAkcG10ICogKDEgLyAkcmF0ZSArICR0eXBlKSAqICgkZiAtIDEpICsgJGZ2OwoKICAgICAgICAvLyBmaW5kIHJvb3QgYnkgc2VjYW50IG1ldGhvZAogICAgICAgICRpICA9ICR4MCA9IDAuMDsKICAgICAgICAkeDEgPSAkcmF0ZTsKICAgICAgICB3aGlsZSAoKGFicygkeTAgLSAkeTEpID4gRklOQU5DSUFMX1BSRUNJU0lPTikgJiYgKCRpIDwgRklOQU5DSUFMX01BWF9JVEVSQVRJT05TKSkgewogICAgICAgICAgICAkcmF0ZSA9ICgkeTEgKiAkeDAgLSAkeTAgKiAkeDEpIC8gKCR5MSAtICR5MCk7CiAgICAgICAgICAgICR4MCA9ICR4MTsKICAgICAgICAgICAgJHgxID0gJHJhdGU7CiAgICAgICAgICAgIGlmICgoJG5wZXIgKiBhYnMoJHBtdCkpID4gKCRwdiAtICRmdikpIHsKICAgICAgICAgICAgICAgICR4MSA9IGFicygkeDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhYnMoJHJhdGUpIDwgRklOQU5DSUFMX1BSRUNJU0lPTikgewogICAgICAgICAgICAgICAgJHkgPSAkcHYgKiAoMSArICRucGVyICogJHJhdGUpICsgJHBtdCAqICgxICsgJHJhdGUgKiAkdHlwZSkgKiAkbnBlciArICRmdjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRmID0gZXhwKCRucGVyICogbG9nKDEgKyAkcmF0ZSkpOwogICAgICAgICAgICAgICAgJHkgPSAkcHYgKiAkZiArICRwbXQgKiAoMSAvICRyYXRlICsgJHR5cGUpICogKCRmIC0gMSkgKyAkZnY7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICR5MCA9ICR5MTsKICAgICAgICAgICAgJHkxID0gJHk7CiAgICAgICAgICAgICsrJGk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmF0ZTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBSRUNFSVZFRAogICAgICoKICAgICAqIFJldHVybnMgdGhlIHByaWNlIHBlciAkMTAwIGZhY2UgdmFsdWUgb2YgYSBkaXNjb3VudGVkIHNlY3VyaXR5LgogICAgICoKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzZXR0bGVtZW50ICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkgc2V0dGxlbWVudCBkYXRlIGlzIHRoZSBkYXRlIGFmdGVyIHRoZSBpc3N1ZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGlzIHRyYWRlZCB0byB0aGUgYnV5ZXIuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgbWF0dXJpdHkgICAgVGhlIHNlY3VyaXR5J3MgbWF0dXJpdHkgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgbWF0dXJpdHkgZGF0ZSBpcyB0aGUgZGF0ZSB3aGVuIHRoZSBzZWN1cml0eSBleHBpcmVzLgogICAgICogQHBhcmFtICAgIGludCAgICAgICAgaW52ZXN0bWVudCAgICBUaGUgYW1vdW50IGludmVzdGVkIGluIHRoZSBzZWN1cml0eS4KICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgIGRpc2NvdW50ICAgIFRoZSBzZWN1cml0eSdzIGRpc2NvdW50IHJhdGUuCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICBiYXNpcyAgICAgICAgVGhlIHR5cGUgb2YgZGF5IGNvdW50IHRvIHVzZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgb3Igb21pdHRlZCAgICBVUyAoTkFTRCkgMzAvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICAgICAgICAgICAgICAgIEFjdHVhbC9hY3R1YWwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgICAgICAgICAgICAgICAgQWN0dWFsLzM2MAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMyAgICAgICAgICAgICAgICBBY3R1YWwvMzY1CiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA0ICAgICAgICAgICAgICAgIEV1cm9wZWFuIDMwLzM2MAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFJFQ0VJVkVEKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRpbnZlc3RtZW50LCAkZGlzY291bnQsICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkaW52ZXN0bWVudCAgICA9IChmbG9hdCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGludmVzdG1lbnQpOwogICAgICAgICRkaXNjb3VudCAgICA9IChmbG9hdCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGRpc2NvdW50KTsKICAgICAgICAkYmFzaXMgICAgICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGJhc2lzKTsKCiAgICAgICAgLy8gICAgVmFsaWRhdGUKICAgICAgICBpZiAoKGlzX251bWVyaWMoJGludmVzdG1lbnQpKSAmJiAoaXNfbnVtZXJpYygkZGlzY291bnQpKSAmJiAoaXNfbnVtZXJpYygkYmFzaXMpKSkgewogICAgICAgICAgICBpZiAoKCRpbnZlc3RtZW50IDw9IDApIHx8ICgkZGlzY291bnQgPD0gMCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5KSkgewogICAgICAgICAgICAgICAgLy8gICAgcmV0dXJuIGRhdGUgZXJyb3IKICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkaW52ZXN0bWVudCAvICggMSAtICgkZGlzY291bnQgKiAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBTTE4KICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBzdHJhaWdodC1saW5lIGRlcHJlY2lhdGlvbiBvZiBhbiBhc3NldCBmb3Igb25lIHBlcmlvZAogICAgICoKICAgICAqIEBwYXJhbSAgICBjb3N0ICAgICAgICBJbml0aWFsIGNvc3Qgb2YgdGhlIGFzc2V0CiAgICAgKiBAcGFyYW0gICAgc2FsdmFnZSAgICAgICAgVmFsdWUgYXQgdGhlIGVuZCBvZiB0aGUgZGVwcmVjaWF0aW9uCiAgICAgKiBAcGFyYW0gICAgbGlmZSAgICAgICAgTnVtYmVyIG9mIHBlcmlvZHMgb3ZlciB3aGljaCB0aGUgYXNzZXQgaXMgZGVwcmVjaWF0ZWQKICAgICAqIEByZXR1cm4gICAgZmxvYXQKICAgICAqLwogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBTTE4oJGNvc3QsICRzYWx2YWdlLCAkbGlmZSkKICAgIHsKICAgICAgICAkY29zdCAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkY29zdCk7CiAgICAgICAgJHNhbHZhZ2UgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2FsdmFnZSk7CiAgICAgICAgJGxpZmUgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGxpZmUpOwoKICAgICAgICAvLyBDYWxjdWxhdGUKICAgICAgICBpZiAoKGlzX251bWVyaWMoJGNvc3QpKSAmJiAoaXNfbnVtZXJpYygkc2FsdmFnZSkpICYmIChpc19udW1lcmljKCRsaWZlKSkpIHsKICAgICAgICAgICAgaWYgKCRsaWZlIDwgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICgkY29zdCAtICRzYWx2YWdlKSAvICRsaWZlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgfQoKCiAgICAvKioKICAgICAqIFNZRAogICAgICoKICAgICAqIFJldHVybnMgdGhlIHN1bS1vZi15ZWFycycgZGlnaXRzIGRlcHJlY2lhdGlvbiBvZiBhbiBhc3NldCBmb3IgYSBzcGVjaWZpZWQgcGVyaW9kLgogICAgICoKICAgICAqIEBwYXJhbSAgICBjb3N0ICAgICAgICBJbml0aWFsIGNvc3Qgb2YgdGhlIGFzc2V0CiAgICAgKiBAcGFyYW0gICAgc2FsdmFnZSAgICAgICAgVmFsdWUgYXQgdGhlIGVuZCBvZiB0aGUgZGVwcmVjaWF0aW9uCiAgICAgKiBAcGFyYW0gICAgbGlmZSAgICAgICAgTnVtYmVyIG9mIHBlcmlvZHMgb3ZlciB3aGljaCB0aGUgYXNzZXQgaXMgZGVwcmVjaWF0ZWQKICAgICAqIEBwYXJhbSAgICBwZXJpb2QgICAgICAgIFBlcmlvZAogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFNZRCgkY29zdCwgJHNhbHZhZ2UsICRsaWZlLCAkcGVyaW9kKQogICAgewogICAgICAgICRjb3N0ICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRjb3N0KTsKICAgICAgICAkc2FsdmFnZSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRzYWx2YWdlKTsKICAgICAgICAkbGlmZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkbGlmZSk7CiAgICAgICAgJHBlcmlvZCAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcGVyaW9kKTsKCiAgICAgICAgLy8gQ2FsY3VsYXRlCiAgICAgICAgaWYgKChpc19udW1lcmljKCRjb3N0KSkgJiYgKGlzX251bWVyaWMoJHNhbHZhZ2UpKSAmJiAoaXNfbnVtZXJpYygkbGlmZSkpICYmIChpc19udW1lcmljKCRwZXJpb2QpKSkgewogICAgICAgICAgICBpZiAoKCRsaWZlIDwgMSkgfHwgKCRwZXJpb2QgPiAkbGlmZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoKCRjb3N0IC0gJHNhbHZhZ2UpICogKCRsaWZlIC0gJHBlcmlvZCArIDEpICogMikgLyAoJGxpZmUgKiAoJGxpZmUgKyAxKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogVEJJTExFUQogICAgICoKICAgICAqIFJldHVybnMgdGhlIGJvbmQtZXF1aXZhbGVudCB5aWVsZCBmb3IgYSBUcmVhc3VyeSBiaWxsLgogICAgICoKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzZXR0bGVtZW50ICAgIFRoZSBUcmVhc3VyeSBiaWxsJ3Mgc2V0dGxlbWVudCBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBUcmVhc3VyeSBiaWxsJ3Mgc2V0dGxlbWVudCBkYXRlIGlzIHRoZSBkYXRlIGFmdGVyIHRoZSBpc3N1ZSBkYXRlIHdoZW4gdGhlIFRyZWFzdXJ5IGJpbGwgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICBUaGUgVHJlYXN1cnkgYmlsbCdzIG1hdHVyaXR5IGRhdGUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG1hdHVyaXR5IGRhdGUgaXMgdGhlIGRhdGUgd2hlbiB0aGUgVHJlYXN1cnkgYmlsbCBleHBpcmVzLgogICAgICogQHBhcmFtICAgIGludCAgICAgICAgZGlzY291bnQgICAgVGhlIFRyZWFzdXJ5IGJpbGwncyBkaXNjb3VudCByYXRlLgogICAgICogQHJldHVybiAgICBmbG9hdAogICAgICovCiAgICBwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIFRCSUxMRVEoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGRpc2NvdW50KQogICAgewogICAgICAgICRzZXR0bGVtZW50ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNldHRsZW1lbnQpOwogICAgICAgICRtYXR1cml0eSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtYXR1cml0eSk7CiAgICAgICAgJGRpc2NvdW50ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGRpc2NvdW50KTsKCiAgICAgICAgLy8gICAgVXNlIFRCSUxMUFJJQ0UgZm9yIHZhbGlkYXRpb24KICAgICAgICAkdGVzdFZhbHVlID0gc2VsZjo6VEJJTExQUklDRSgkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkZGlzY291bnQpOwogICAgICAgIGlmIChpc19zdHJpbmcoJHRlc3RWYWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuICR0ZXN0VmFsdWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNfc3RyaW5nKCRtYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJG1hdHVyaXR5KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CgogICAgICAgIGlmIChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmdldENvbXBhdGliaWxpdHlNb2RlKCkgPT0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpDT01QQVRJQklMSVRZX09QRU5PRkZJQ0UpIHsKICAgICAgICAgICAgKyskbWF0dXJpdHk7CiAgICAgICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5KSAqIDM2MDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkgPSAoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkbWF0dXJpdHkpIC0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkc2V0dGxlbWVudCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICgzNjUgKiAkZGlzY291bnQpIC8gKDM2MCAtICRkaXNjb3VudCAqICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSk7CiAgICB9CgoKICAgIC8qKgogICAgICogVEJJTExQUklDRQogICAgICoKICAgICAqIFJldHVybnMgdGhlIHlpZWxkIGZvciBhIFRyZWFzdXJ5IGJpbGwuCiAgICAgKgogICAgICogQHBhcmFtICAgIG1peGVkICAgIHNldHRsZW1lbnQgICAgVGhlIFRyZWFzdXJ5IGJpbGwncyBzZXR0bGVtZW50IGRhdGUuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIFRyZWFzdXJ5IGJpbGwncyBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlIGRhdGUgd2hlbiB0aGUgVHJlYXN1cnkgYmlsbCBpcyB0cmFkZWQgdG8gdGhlIGJ1eWVyLgogICAgICogQHBhcmFtICAgIG1peGVkICAgIG1hdHVyaXR5ICAgIFRoZSBUcmVhc3VyeSBiaWxsJ3MgbWF0dXJpdHkgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgbWF0dXJpdHkgZGF0ZSBpcyB0aGUgZGF0ZSB3aGVuIHRoZSBUcmVhc3VyeSBiaWxsIGV4cGlyZXMuCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICBkaXNjb3VudCAgICBUaGUgVHJlYXN1cnkgYmlsbCdzIGRpc2NvdW50IHJhdGUuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gVEJJTExQUklDRSgkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkZGlzY291bnQpCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkZGlzY291bnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkZGlzY291bnQpOwoKICAgICAgICBpZiAoaXNfc3RyaW5nKCRtYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJG1hdHVyaXR5KSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CgogICAgICAgIC8vICAgIFZhbGlkYXRlCiAgICAgICAgaWYgKGlzX251bWVyaWMoJGRpc2NvdW50KSkgewogICAgICAgICAgICBpZiAoJGRpc2NvdW50IDw9IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpnZXRDb21wYXRpYmlsaXR5TW9kZSgpID09IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6Q09NUEFUSUJJTElUWV9PUEVOT0ZGSUNFKSB7CiAgICAgICAgICAgICAgICArKyRtYXR1cml0eTsKICAgICAgICAgICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5KSAqIDM2MDsKICAgICAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gICAgcmV0dXJuIGRhdGUgZXJyb3IKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5ID0gKFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJG1hdHVyaXR5KSAtIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpnZXREYXRlVmFsdWUoJHNldHRsZW1lbnQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA+IDM2MCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRwcmljZSA9IDEwMCAqICgxIC0gKCgkZGlzY291bnQgKiAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkpIC8gMzYwKSk7CiAgICAgICAgICAgIGlmICgkcHJpY2UgPD0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICRwcmljZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBUQklMTFlJRUxECiAgICAgKgogICAgICogUmV0dXJucyB0aGUgeWllbGQgZm9yIGEgVHJlYXN1cnkgYmlsbC4KICAgICAqCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgc2V0dGxlbWVudCAgICBUaGUgVHJlYXN1cnkgYmlsbCdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgVHJlYXN1cnkgYmlsbCdzIHNldHRsZW1lbnQgZGF0ZSBpcyB0aGUgZGF0ZSBhZnRlciB0aGUgaXNzdWUgZGF0ZSB3aGVuIHRoZSBUcmVhc3VyeSBiaWxsIGlzIHRyYWRlZCB0byB0aGUgYnV5ZXIuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgbWF0dXJpdHkgICAgVGhlIFRyZWFzdXJ5IGJpbGwncyBtYXR1cml0eSBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBtYXR1cml0eSBkYXRlIGlzIHRoZSBkYXRlIHdoZW4gdGhlIFRyZWFzdXJ5IGJpbGwgZXhwaXJlcy4KICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgIHByaWNlICAgICAgICBUaGUgVHJlYXN1cnkgYmlsbCdzIHByaWNlIHBlciAkMTAwIGZhY2UgdmFsdWUuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gVEJJTExZSUVMRCgkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkcHJpY2UpCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkcHJpY2UgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHByaWNlKTsKCiAgICAgICAgLy8gICAgVmFsaWRhdGUKICAgICAgICBpZiAoaXNfbnVtZXJpYygkcHJpY2UpKSB7CiAgICAgICAgICAgIGlmICgkcHJpY2UgPD0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmdldENvbXBhdGliaWxpdHlNb2RlKCkgPT0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpDT01QQVRJQklMSVRZX09QRU5PRkZJQ0UpIHsKICAgICAgICAgICAgICAgICsrJG1hdHVyaXR5OwogICAgICAgICAgICAgICAgJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5ID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OllFQVJGUkFDKCRzZXR0bGVtZW50LCAkbWF0dXJpdHkpICogMzYwOwogICAgICAgICAgICAgICAgaWYgKCFpc19udW1lcmljKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyAgICByZXR1cm4gZGF0ZSBlcnJvcgogICAgICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkgPSAoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkbWF0dXJpdHkpIC0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OmdldERhdGVWYWx1ZSgkc2V0dGxlbWVudCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5ID4gMzYwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICgoMTAwIC0gJHByaWNlKSAvICRwcmljZSkgKiAoMzYwIC8gJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgIH0KCgogICAgcHVibGljIHN0YXRpYyBmdW5jdGlvbiBYSVJSKCR2YWx1ZXMsICRkYXRlcywgJGd1ZXNzID0gMC4xKQogICAgewogICAgICAgIGlmICgoIWlzX2FycmF5KCR2YWx1ZXMpKSAmJiAoIWlzX2FycmF5KCRkYXRlcykpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgfQogICAgICAgICR2YWx1ZXMgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5BcnJheSgkdmFsdWVzKTsKICAgICAgICAkZGF0ZXMgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuQXJyYXkoJGRhdGVzKTsKICAgICAgICAkZ3Vlc3MgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGd1ZXNzKTsKICAgICAgICBpZiAoY291bnQoJHZhbHVlcykgIT0gY291bnQoJGRhdGVzKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICB9CgogICAgICAgIC8vIGNyZWF0ZSBhbiBpbml0aWFsIHJhbmdlLCB3aXRoIGEgcm9vdCBzb21ld2hlcmUgYmV0d2VlbiAwIGFuZCBndWVzcwogICAgICAgICR4MSA9IDAuMDsKICAgICAgICAkeDIgPSAkZ3Vlc3M7CiAgICAgICAgJGYxID0gc2VsZjo6WE5QVigkeDEsICR2YWx1ZXMsICRkYXRlcyk7CiAgICAgICAgJGYyID0gc2VsZjo6WE5QVigkeDIsICR2YWx1ZXMsICRkYXRlcyk7CiAgICAgICAgZm9yICgkaSA9IDA7ICRpIDwgRklOQU5DSUFMX01BWF9JVEVSQVRJT05TOyArKyRpKSB7CiAgICAgICAgICAgIGlmICgoJGYxICogJGYyKSA8IDAuMCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZWlmIChhYnMoJGYxKSA8IGFicygkZjIpKSB7CiAgICAgICAgICAgICAgICAkZjEgPSBzZWxmOjpYTlBWKCR4MSArPSAxLjYgKiAoJHgxIC0gJHgyKSwgJHZhbHVlcywgJGRhdGVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRmMiA9IHNlbGY6OlhOUFYoJHgyICs9IDEuNiAqICgkeDIgLSAkeDEpLCAkdmFsdWVzLCAkZGF0ZXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgoJGYxICogJGYyKSA+IDAuMCkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KCiAgICAgICAgJGYgPSBzZWxmOjpYTlBWKCR4MSwgJHZhbHVlcywgJGRhdGVzKTsKICAgICAgICBpZiAoJGYgPCAwLjApIHsKICAgICAgICAgICAgJHJ0YiA9ICR4MTsKICAgICAgICAgICAgJGR4ID0gJHgyIC0gJHgxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRydGIgPSAkeDI7CiAgICAgICAgICAgICRkeCA9ICR4MSAtICR4MjsKICAgICAgICB9CgogICAgICAgIGZvciAoJGkgPSAwOyAkaSA8IEZJTkFOQ0lBTF9NQVhfSVRFUkFUSU9OUzsgKyskaSkgewogICAgICAgICAgICAkZHggKj0gMC41OwogICAgICAgICAgICAkeF9taWQgPSAkcnRiICsgJGR4OwogICAgICAgICAgICAkZl9taWQgPSBzZWxmOjpYTlBWKCR4X21pZCwgJHZhbHVlcywgJGRhdGVzKTsKICAgICAgICAgICAgaWYgKCRmX21pZCA8PSAwLjApIHsKICAgICAgICAgICAgICAgICRydGIgPSAkeF9taWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChhYnMoJGZfbWlkKSA8IEZJTkFOQ0lBTF9QUkVDSVNJT04pIHx8IChhYnMoJGR4KSA8IEZJTkFOQ0lBTF9QUkVDSVNJT04pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHhfbWlkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogWE5QVgogICAgICoKICAgICAqIFJldHVybnMgdGhlIG5ldCBwcmVzZW50IHZhbHVlIGZvciBhIHNjaGVkdWxlIG9mIGNhc2ggZmxvd3MgdGhhdCBpcyBub3QgbmVjZXNzYXJpbHkgcGVyaW9kaWMuCiAgICAgKiBUbyBjYWxjdWxhdGUgdGhlIG5ldCBwcmVzZW50IHZhbHVlIGZvciBhIHNlcmllcyBvZiBjYXNoIGZsb3dzIHRoYXQgaXMgcGVyaW9kaWMsIHVzZSB0aGUgTlBWIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEV4Y2VsIEZ1bmN0aW9uOgogICAgICogICAgICAgID1YTlBWKHJhdGUsdmFsdWVzLGRhdGVzKQogICAgICoKICAgICAqIEBwYXJhbSAgICBmbG9hdCAgICAgICAgICAgICRyYXRlICAgICAgICBUaGUgZGlzY291bnQgcmF0ZSB0byBhcHBseSB0byB0aGUgY2FzaCBmbG93cy4KICAgICAqIEBwYXJhbSAgICBhcnJheSBvZiBmbG9hdCAgICAkdmFsdWVzICAgICBBIHNlcmllcyBvZiBjYXNoIGZsb3dzIHRoYXQgY29ycmVzcG9uZHMgdG8gYSBzY2hlZHVsZSBvZiBwYXltZW50cyBpbiBkYXRlcy4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZmlyc3QgcGF5bWVudCBpcyBvcHRpb25hbCBhbmQgY29ycmVzcG9uZHMgdG8gYSBjb3N0IG9yIHBheW1lbnQgdGhhdCBvY2N1cnMgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgaW52ZXN0bWVudC4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiB0aGUgZmlyc3QgdmFsdWUgaXMgYSBjb3N0IG9yIHBheW1lbnQsIGl0IG11c3QgYmUgYSBuZWdhdGl2ZSB2YWx1ZS4gQWxsIHN1Y2NlZWRpbmcgcGF5bWVudHMgYXJlIGRpc2NvdW50ZWQgYmFzZWQgb24gYSAzNjUtZGF5IHllYXIuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHNlcmllcyBvZiB2YWx1ZXMgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBwb3NpdGl2ZSB2YWx1ZSBhbmQgb25lIG5lZ2F0aXZlIHZhbHVlLgogICAgICogQHBhcmFtICAgIGFycmF5IG9mIG1peGVkICAgICRkYXRlcyAgICAgIEEgc2NoZWR1bGUgb2YgcGF5bWVudCBkYXRlcyB0aGF0IGNvcnJlc3BvbmRzIHRvIHRoZSBjYXNoIGZsb3cgcGF5bWVudHMuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZpcnN0IHBheW1lbnQgZGF0ZSBpbmRpY2F0ZXMgdGhlIGJlZ2lubmluZyBvZiB0aGUgc2NoZWR1bGUgb2YgcGF5bWVudHMuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxsIG90aGVyIGRhdGVzIG11c3QgYmUgbGF0ZXIgdGhhbiB0aGlzIGRhdGUsIGJ1dCB0aGV5IG1heSBvY2N1ciBpbiBhbnkgb3JkZXIuCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gWE5QVigkcmF0ZSwgJHZhbHVlcywgJGRhdGVzKQogICAgewogICAgICAgICRyYXRlID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJhdGUpOwogICAgICAgIGlmICghaXNfbnVtZXJpYygkcmF0ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCghaXNfYXJyYXkoJHZhbHVlcykpIHx8ICghaXNfYXJyYXkoJGRhdGVzKSkpIHsKICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6VkFMVUUoKTsKICAgICAgICB9CiAgICAgICAgJHZhbHVlcyAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCR2YWx1ZXMpOwogICAgICAgICRkYXRlcyAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlbkFycmF5KCRkYXRlcyk7CiAgICAgICAgJHZhbENvdW50ID0gY291bnQoJHZhbHVlcyk7CiAgICAgICAgaWYgKCR2YWxDb3VudCAhPSBjb3VudCgkZGF0ZXMpKSB7CiAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6Ok5hTigpOwogICAgICAgIH0KICAgICAgICBpZiAoKG1pbigkdmFsdWVzKSA+IDApIHx8IChtYXgoJHZhbHVlcykgPCAwKSkgewogICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpWQUxVRSgpOwogICAgICAgIH0KCiAgICAgICAgJHhucHYgPSAwLjA7CiAgICAgICAgZm9yICgkaSA9IDA7ICRpIDwgJHZhbENvdW50OyArKyRpKSB7CiAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkdmFsdWVzWyRpXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJHhucHYgKz0gJHZhbHVlc1skaV0gLyBwb3coMSArICRyYXRlLCBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6REFURURJRigkZGF0ZXNbMF0sICRkYXRlc1skaV0sICdkJykgLyAzNjUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKGlzX2Zpbml0ZSgkeG5wdikpID8gJHhucHYgOiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogWUlFTERESVNDCiAgICAgKgogICAgICogUmV0dXJucyB0aGUgYW5udWFsIHlpZWxkIG9mIGEgc2VjdXJpdHkgdGhhdCBwYXlzIGludGVyZXN0IGF0IG1hdHVyaXR5LgogICAgICoKICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBzZXR0bGVtZW50ICAgICAgVGhlIHNlY3VyaXR5J3Mgc2V0dGxlbWVudCBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkncyBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICAgICAgVGhlIHNlY3VyaXR5J3MgbWF0dXJpdHkgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG1hdHVyaXR5IGRhdGUgaXMgdGhlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgZXhwaXJlcy4KICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgIHByaWNlICAgICAgICAgVGhlIHNlY3VyaXR5J3MgcHJpY2UgcGVyICQxMDAgZmFjZSB2YWx1ZS4KICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgIHJlZGVtcHRpb24gICAgVGhlIHNlY3VyaXR5J3MgcmVkZW1wdGlvbiB2YWx1ZSBwZXIgJDEwMCBmYWNlIHZhbHVlLgogICAgICogQHBhcmFtICAgIGludCAgICAgICAgYmFzaXMgICAgICAgICBUaGUgdHlwZSBvZiBkYXkgY291bnQgdG8gdXNlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCBvciBvbWl0dGVkICAgIFVTIChOQVNEKSAzMC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgQWN0dWFsL2FjdHVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAgICAgICAgICAgICAgICBBY3R1YWwvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAzICAgICAgICAgICAgICAgIEFjdHVhbC8zNjUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgICAgICAgICAgICAgRXVyb3BlYW4gMzAvMzYwCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gWUlFTERESVNDKCRzZXR0bGVtZW50LCAkbWF0dXJpdHksICRwcmljZSwgJHJlZGVtcHRpb24sICRiYXNpcyA9IDApCiAgICB7CiAgICAgICAgJHNldHRsZW1lbnQgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkc2V0dGxlbWVudCk7CiAgICAgICAgJG1hdHVyaXR5ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJG1hdHVyaXR5KTsKICAgICAgICAkcHJpY2UgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHByaWNlKTsKICAgICAgICAkcmVkZW1wdGlvbiAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRyZWRlbXB0aW9uKTsKICAgICAgICAkYmFzaXMgICAgICAgID0gKGludCkgUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJGJhc2lzKTsKCiAgICAgICAgLy8gICAgVmFsaWRhdGUKICAgICAgICBpZiAoaXNfbnVtZXJpYygkcHJpY2UpICYmIGlzX251bWVyaWMoJHJlZGVtcHRpb24pKSB7CiAgICAgICAgICAgIGlmICgoJHByaWNlIDw9IDApIHx8ICgkcmVkZW1wdGlvbiA8PSAwKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6TmFOKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGRheXNQZXJZZWFyID0gc2VsZjo6ZGF5c1BlclllYXIoUEhQRXhjZWxfQ2FsY3VsYXRpb25fRGF0ZVRpbWU6OllFQVIoJHNldHRsZW1lbnQpLCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNQZXJZZWFyKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRkYXlzUGVyWWVhcjsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHkgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUkZSQUMoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGJhc2lzKTsKICAgICAgICAgICAgaWYgKCFpc19udW1lcmljKCRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSkpIHsKICAgICAgICAgICAgICAgIC8vICAgIHJldHVybiBkYXRlIGVycm9yCiAgICAgICAgICAgICAgICByZXR1cm4gJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5OwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSAqPSAkZGF5c1BlclllYXI7CgogICAgICAgICAgICByZXR1cm4gKCgkcmVkZW1wdGlvbiAtICRwcmljZSkgLyAkcHJpY2UpICogKCRkYXlzUGVyWWVhciAvICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9CgoKICAgIC8qKgogICAgICogWUlFTERNQVQKICAgICAqCiAgICAgKiBSZXR1cm5zIHRoZSBhbm51YWwgeWllbGQgb2YgYSBzZWN1cml0eSB0aGF0IHBheXMgaW50ZXJlc3QgYXQgbWF0dXJpdHkuCiAgICAgKgogICAgICogQHBhcmFtICAgIG1peGVkICAgIHNldHRsZW1lbnQgICAgIFRoZSBzZWN1cml0eSdzIHNldHRsZW1lbnQgZGF0ZS4KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgc2VjdXJpdHkncyBzZXR0bGVtZW50IGRhdGUgaXMgdGhlIGRhdGUgYWZ0ZXIgdGhlIGlzc3VlIGRhdGUgd2hlbiB0aGUgc2VjdXJpdHkgaXMgdHJhZGVkIHRvIHRoZSBidXllci4KICAgICAqIEBwYXJhbSAgICBtaXhlZCAgICBtYXR1cml0eSAgICAgICBUaGUgc2VjdXJpdHkncyBtYXR1cml0eSBkYXRlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBtYXR1cml0eSBkYXRlIGlzIHRoZSBkYXRlIHdoZW4gdGhlIHNlY3VyaXR5IGV4cGlyZXMuCiAgICAgKiBAcGFyYW0gICAgbWl4ZWQgICAgaXNzdWUgICAgICAgICAgVGhlIHNlY3VyaXR5J3MgaXNzdWUgZGF0ZS4KICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgIHJhdGUgICAgICAgICBUaGUgc2VjdXJpdHkncyBpbnRlcmVzdCByYXRlIGF0IGRhdGUgb2YgaXNzdWUuCiAgICAgKiBAcGFyYW0gICAgaW50ICAgICAgICBwcmljZSAgICAgICAgVGhlIHNlY3VyaXR5J3MgcHJpY2UgcGVyICQxMDAgZmFjZSB2YWx1ZS4KICAgICAqIEBwYXJhbSAgICBpbnQgICAgICAgIGJhc2lzICAgICAgICBUaGUgdHlwZSBvZiBkYXkgY291bnQgdG8gdXNlLgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCBvciBvbWl0dGVkICAgIFVTIChOQVNEKSAzMC8zNjAKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgICAgICAgICAgICAgICAgQWN0dWFsL2FjdHVhbAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMiAgICAgICAgICAgICAgICBBY3R1YWwvMzYwCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAzICAgICAgICAgICAgICAgIEFjdHVhbC8zNjUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQgICAgICAgICAgICAgICAgRXVyb3BlYW4gMzAvMzYwCiAgICAgKiBAcmV0dXJuICAgIGZsb2F0CiAgICAgKi8KICAgIHB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gWUlFTERNQVQoJHNldHRsZW1lbnQsICRtYXR1cml0eSwgJGlzc3VlLCAkcmF0ZSwgJHByaWNlLCAkYmFzaXMgPSAwKQogICAgewogICAgICAgICRzZXR0bGVtZW50ICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHNldHRsZW1lbnQpOwogICAgICAgICRtYXR1cml0eSAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRtYXR1cml0eSk7CiAgICAgICAgJGlzc3VlICAgICAgICA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0Z1bmN0aW9uczo6ZmxhdHRlblNpbmdsZVZhbHVlKCRpc3N1ZSk7CiAgICAgICAgJHJhdGUgICAgICAgID0gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpmbGF0dGVuU2luZ2xlVmFsdWUoJHJhdGUpOwogICAgICAgICRwcmljZSAgICAgICAgPSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkcHJpY2UpOwogICAgICAgICRiYXNpcyAgICAgICAgPSAoaW50KSBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OmZsYXR0ZW5TaW5nbGVWYWx1ZSgkYmFzaXMpOwoKICAgICAgICAvLyAgICBWYWxpZGF0ZQogICAgICAgIGlmIChpc19udW1lcmljKCRyYXRlKSAmJiBpc19udW1lcmljKCRwcmljZSkpIHsKICAgICAgICAgICAgaWYgKCgkcmF0ZSA8PSAwKSB8fCAoJHByaWNlIDw9IDApKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUEhQRXhjZWxfQ2FsY3VsYXRpb25fRnVuY3Rpb25zOjpOYU4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZGF5c1BlclllYXIgPSBzZWxmOjpkYXlzUGVyWWVhcihQSFBFeGNlbF9DYWxjdWxhdGlvbl9EYXRlVGltZTo6WUVBUigkc2V0dGxlbWVudCksICRiYXNpcyk7CiAgICAgICAgICAgIGlmICghaXNfbnVtZXJpYygkZGF5c1BlclllYXIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGRheXNQZXJZZWFyOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRkYXlzQmV0d2Vlbklzc3VlQW5kU2V0dGxlbWVudCA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkaXNzdWUsICRzZXR0bGVtZW50LCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNCZXR3ZWVuSXNzdWVBbmRTZXR0bGVtZW50KSkgewogICAgICAgICAgICAgICAgLy8gICAgcmV0dXJuIGRhdGUgZXJyb3IKICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c0JldHdlZW5Jc3N1ZUFuZFNldHRsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGRheXNCZXR3ZWVuSXNzdWVBbmRTZXR0bGVtZW50ICo9ICRkYXlzUGVyWWVhcjsKICAgICAgICAgICAgJGRheXNCZXR3ZWVuSXNzdWVBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkaXNzdWUsICRtYXR1cml0eSwgJGJhc2lzKTsKICAgICAgICAgICAgaWYgKCFpc19udW1lcmljKCRkYXlzQmV0d2Vlbklzc3VlQW5kTWF0dXJpdHkpKSB7CiAgICAgICAgICAgICAgICAvLyAgICByZXR1cm4gZGF0ZSBlcnJvcgogICAgICAgICAgICAgICAgcmV0dXJuICRkYXlzQmV0d2Vlbklzc3VlQW5kTWF0dXJpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGRheXNCZXR3ZWVuSXNzdWVBbmRNYXR1cml0eSAqPSAkZGF5c1BlclllYXI7CiAgICAgICAgICAgICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSA9IFBIUEV4Y2VsX0NhbGN1bGF0aW9uX0RhdGVUaW1lOjpZRUFSRlJBQygkc2V0dGxlbWVudCwgJG1hdHVyaXR5LCAkYmFzaXMpOwogICAgICAgICAgICBpZiAoIWlzX251bWVyaWMoJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5KSkgewogICAgICAgICAgICAgICAgLy8gICAgcmV0dXJuIGRhdGUgZXJyb3IKICAgICAgICAgICAgICAgIHJldHVybiAkZGF5c0JldHdlZW5TZXR0bGVtZW50QW5kTWF0dXJpdHk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGRheXNCZXR3ZWVuU2V0dGxlbWVudEFuZE1hdHVyaXR5ICo9ICRkYXlzUGVyWWVhcjsKCiAgICAgICAgICAgIHJldHVybiAoKDEgKyAoKCRkYXlzQmV0d2Vlbklzc3VlQW5kTWF0dXJpdHkgLyAkZGF5c1BlclllYXIpICogJHJhdGUpIC0gKCgkcHJpY2UgLyAxMDApICsgKCgkZGF5c0JldHdlZW5Jc3N1ZUFuZFNldHRsZW1lbnQgLyAkZGF5c1BlclllYXIpICogJHJhdGUpKSkgLwogICAgICAgICAgICAgICAgICAgKCgkcHJpY2UgLyAxMDApICsgKCgkZGF5c0JldHdlZW5Jc3N1ZUFuZFNldHRsZW1lbnQgLyAkZGF5c1BlclllYXIpICogJHJhdGUpKSkgKgogICAgICAgICAgICAgICAgICAgKCRkYXlzUGVyWWVhciAvICRkYXlzQmV0d2VlblNldHRsZW1lbnRBbmRNYXR1cml0eSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQSFBFeGNlbF9DYWxjdWxhdGlvbl9GdW5jdGlvbnM6OlZBTFVFKCk7CiAgICB9Cn0K",
    "size": "108945"
}