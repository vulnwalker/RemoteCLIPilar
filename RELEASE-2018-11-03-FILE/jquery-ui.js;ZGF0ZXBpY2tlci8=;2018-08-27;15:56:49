{
    "namaFile": "datepicker\/jquery-ui.js",
    "lastUpdate": "2018-08-27+15:56:49.97",
    "contentFile": "LyohIGpRdWVyeSBVSSAtIHYxLjEyLjEgLSAyMDE2LTA5LTE0CiogaHR0cDovL2pxdWVyeXVpLmNvbQoqIEluY2x1ZGVzOiB3aWRnZXQuanMsIHBvc2l0aW9uLmpzLCBkYXRhLmpzLCBkaXNhYmxlLXNlbGVjdGlvbi5qcywgZWZmZWN0LmpzLCBlZmZlY3RzL2VmZmVjdC1ibGluZC5qcywgZWZmZWN0cy9lZmZlY3QtYm91bmNlLmpzLCBlZmZlY3RzL2VmZmVjdC1jbGlwLmpzLCBlZmZlY3RzL2VmZmVjdC1kcm9wLmpzLCBlZmZlY3RzL2VmZmVjdC1leHBsb2RlLmpzLCBlZmZlY3RzL2VmZmVjdC1mYWRlLmpzLCBlZmZlY3RzL2VmZmVjdC1mb2xkLmpzLCBlZmZlY3RzL2VmZmVjdC1oaWdobGlnaHQuanMsIGVmZmVjdHMvZWZmZWN0LXB1ZmYuanMsIGVmZmVjdHMvZWZmZWN0LXB1bHNhdGUuanMsIGVmZmVjdHMvZWZmZWN0LXNjYWxlLmpzLCBlZmZlY3RzL2VmZmVjdC1zaGFrZS5qcywgZWZmZWN0cy9lZmZlY3Qtc2l6ZS5qcywgZWZmZWN0cy9lZmZlY3Qtc2xpZGUuanMsIGVmZmVjdHMvZWZmZWN0LXRyYW5zZmVyLmpzLCBmb2N1c2FibGUuanMsIGZvcm0tcmVzZXQtbWl4aW4uanMsIGpxdWVyeS0xLTcuanMsIGtleWNvZGUuanMsIGxhYmVscy5qcywgc2Nyb2xsLXBhcmVudC5qcywgdGFiYmFibGUuanMsIHVuaXF1ZS1pZC5qcywgd2lkZ2V0cy9hY2NvcmRpb24uanMsIHdpZGdldHMvYXV0b2NvbXBsZXRlLmpzLCB3aWRnZXRzL2J1dHRvbi5qcywgd2lkZ2V0cy9jaGVja2JveHJhZGlvLmpzLCB3aWRnZXRzL2NvbnRyb2xncm91cC5qcywgd2lkZ2V0cy9kYXRlcGlja2VyLmpzLCB3aWRnZXRzL2RpYWxvZy5qcywgd2lkZ2V0cy9kcmFnZ2FibGUuanMsIHdpZGdldHMvZHJvcHBhYmxlLmpzLCB3aWRnZXRzL21lbnUuanMsIHdpZGdldHMvbW91c2UuanMsIHdpZGdldHMvcHJvZ3Jlc3NiYXIuanMsIHdpZGdldHMvcmVzaXphYmxlLmpzLCB3aWRnZXRzL3NlbGVjdGFibGUuanMsIHdpZGdldHMvc2VsZWN0bWVudS5qcywgd2lkZ2V0cy9zbGlkZXIuanMsIHdpZGdldHMvc29ydGFibGUuanMsIHdpZGdldHMvc3Bpbm5lci5qcywgd2lkZ2V0cy90YWJzLmpzLCB3aWRnZXRzL3Rvb2x0aXAuanMKKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9yczsgTGljZW5zZWQgTUlUICovCgooZnVuY3Rpb24oIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZShbICJqcXVlcnkiIF0sIGZhY3RvcnkgKTsKCX0gZWxzZSB7CgoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIGpRdWVyeSApOwoJfQp9KGZ1bmN0aW9uKCAkICkgewoKJC51aSA9ICQudWkgfHwge307Cgp2YXIgdmVyc2lvbiA9ICQudWkudmVyc2lvbiA9ICIxLjEyLjEiOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogV2lkZ2V0Ci8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IFByb3ZpZGVzIGEgZmFjdG9yeSBmb3IgY3JlYXRpbmcgc3RhdGVmdWwgd2lkZ2V0cyB3aXRoIGEgY29tbW9uIEFQSS4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS93aWRnZXQvCgoKCnZhciB3aWRnZXRVdWlkID0gMDsKdmFyIHdpZGdldFNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKJC5jbGVhbkRhdGEgPSAoIGZ1bmN0aW9uKCBvcmlnICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtcyApIHsKCQl2YXIgZXZlbnRzLCBlbGVtLCBpOwoJCWZvciAoIGkgPSAwOyAoIGVsZW0gPSBlbGVtc1sgaSBdICkgIT0gbnVsbDsgaSsrICkgewoJCQl0cnkgewoKCQkJCS8vIE9ubHkgdHJpZ2dlciByZW1vdmUgd2hlbiBuZWNlc3NhcnkgdG8gc2F2ZSB0aW1lCgkJCQlldmVudHMgPSAkLl9kYXRhKCBlbGVtLCAiZXZlbnRzIiApOwoJCQkJaWYgKCBldmVudHMgJiYgZXZlbnRzLnJlbW92ZSApIHsKCQkJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJCQl9CgoJCQkvLyBIdHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJCX0gY2F0Y2ggKCBlICkge30KCQl9CgkJb3JpZyggZWxlbXMgKTsKCX07Cn0gKSggJC5jbGVhbkRhdGEgKTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZTsKCgkvLyBQcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkvLyBzbyB0aGF0IGl0IGNhbiBiZSB1c2VkIGFzIGEgbWl4aW4gZm9yIG11bHRpcGxlIHdpZGdldHMgKCM4ODc2KQoJdmFyIHByb3hpZWRQcm90b3R5cGUgPSB7fTsKCgl2YXIgbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJdmFyIGZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJaWYgKCAkLmlzQXJyYXkoIHByb3RvdHlwZSApICkgewoJCXByb3RvdHlwZSA9ICQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIHt9IF0uY29uY2F0KCBwcm90b3R5cGUgKSApOwoJfQoKCS8vIENyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoKCQkvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gQWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCgkvLyBFeHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoKCQkvLyBDb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoKCQkvLyBUcmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0gKTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCgkvLyBXZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggISQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gdmFsdWU7CgkJCXJldHVybjsKCQl9CgkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gKCBmdW5jdGlvbigpIHsKCQkJZnVuY3Rpb24gX3N1cGVyKCkgewoJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQlmdW5jdGlvbiBfc3VwZXJBcHBseSggYXJncyApIHsKCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCX0KCgkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXI7CgkJCQl2YXIgX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseTsKCQkJCXZhciByZXR1cm5WYWx1ZTsKCgkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJfTsKCQl9ICkoKTsKCX0gKTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyAoIGJhc2VQcm90b3R5cGUud2lkZ2V0RXZlbnRQcmVmaXggfHwgbmFtZSApIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSApOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIFJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLAoJCQkJY2hpbGQuX3Byb3RvICk7CgkJfSApOwoKCQkvLyBSZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7CgoJcmV0dXJuIGNvbnN0cnVjdG9yOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHdpZGdldFNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApOwoJdmFyIGlucHV0SW5kZXggPSAwOwoJdmFyIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoOwoJdmFyIGtleTsKCXZhciB2YWx1ZTsKCglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoIGlucHV0WyBpbnB1dEluZGV4IF0uaGFzT3duUHJvcGVydHkoIGtleSApICYmIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoKCQkJCS8vIENvcHkgZXZlcnl0aGluZyBlbHNlIGJ5IHJlZmVyZW5jZQoJCQkJfSBlbHNlIHsKCQkJCQl0YXJnZXRbIGtleSBdID0gdmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWUgfHwgbmFtZTsKCSQuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBpc01ldGhvZENhbGwgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyI7CgkJdmFyIGFyZ3MgPSB3aWRnZXRTbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsKCQl2YXIgcmV0dXJuVmFsdWUgPSB0aGlzOwoKCQlpZiAoIGlzTWV0aG9kQ2FsbCApIHsKCgkJCS8vIElmIHRoaXMgaXMgYW4gZW1wdHkgY29sbGVjdGlvbiwgd2UgbmVlZCB0byBoYXZlIHRoZSBpbnN0YW5jZSBtZXRob2QKCQkJLy8gcmV0dXJuIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIHRoZSBqUXVlcnkgaW5zdGFuY2UKCQkJaWYgKCAhdGhpcy5sZW5ndGggJiYgb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCXJldHVyblZhbHVlID0gdW5kZWZpbmVkOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgbWV0aG9kVmFsdWU7CgkJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoKCQkJCQlpZiAoIG9wdGlvbnMgPT09ICJpbnN0YW5jZSIgKSB7CgkJCQkJCXJldHVyblZhbHVlID0gaW5zdGFuY2U7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgoJCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKwoJCQkJCQkJIiBwcmlvciB0byBpbml0aWFsaXphdGlvbjsgIiArCgkJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJCX0KCgkJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVsgb3B0aW9ucyBdICkgfHwgb3B0aW9ucy5jaGFyQXQoIDAgKSA9PT0gIl8iICkgewoJCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArCgkJCQkJCQkiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCQl9CgoJCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCgkJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQkJcmV0dXJuVmFsdWUucHVzaFN0YWNrKCBtZXRob2RWYWx1ZS5nZXQoKSApIDoKCQkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJfSBlbHNlIHsKCgkJCS8vIEFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCQlpZiAoIGFyZ3MubGVuZ3RoICkgewoJCQkJb3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZC5hcHBseSggbnVsbCwgWyBvcHRpb25zIF0uY29uY2F0KCBhcmdzICkgKTsKCQkJfQoKCQkJdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICk7CgkJCQkJaWYgKCBpbnN0YW5jZS5faW5pdCApIHsKCQkJCQkJaW5zdGFuY2UuX2luaXQoKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCSQuZGF0YSggdGhpcywgZnVsbE5hbWUsIG5ldyBvYmplY3QoIG9wdGlvbnMsIHRoaXMgKSApOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCgoJb3B0aW9uczogewoJCWNsYXNzZXM6IHt9LAoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gQ2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCWVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHRoaXMuZGVmYXVsdEVsZW1lbnQgfHwgdGhpcyApWyAwIF07CgkJdGhpcy5lbGVtZW50ID0gJCggZWxlbWVudCApOwoJCXRoaXMudXVpZCA9IHdpZGdldFV1aWQrKzsKCQl0aGlzLmV2ZW50TmFtZXNwYWNlID0gIi4iICsgdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoJCXRoaXMuY2xhc3Nlc0VsZW1lbnRMb29rdXAgPSB7fTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoJCQl0aGlzLmRvY3VtZW50ID0gJCggZWxlbWVudC5zdHlsZSA\/CgoJCQkJLy8gRWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoKCQkJCS8vIEVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFsgMCBdLnBhcmVudFdpbmRvdyApOwoJCX0KCgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5fY3JlYXRlKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQl0aGlzLl9zZXRPcHRpb25EaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJfQoKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4ge307Cgl9LAoKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCglfY3JlYXRlOiAkLm5vb3AsCgoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMuX2Rlc3Ryb3koKTsKCQkkLmVhY2goIHRoaXMuY2xhc3Nlc0VsZW1lbnRMb29rdXAsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQl0aGF0Ll9yZW1vdmVDbGFzcyggdmFsdWUsIGtleSApOwoJCX0gKTsKCgkJLy8gV2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS5vZmYoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLm9mZiggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCgkJLy8gQ2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLm9mZiggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJfSwKCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleTsKCQl2YXIgcGFydHM7CgkJdmFyIGN1ck9wdGlvbjsKCQl2YXIgaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoKCQkJLy8gRG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgoJCQkvLyBIYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA\/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAxICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJjbGFzc2VzIiApIHsKCQkJdGhpcy5fc2V0T3B0aW9uQ2xhc3NlcyggdmFsdWUgKTsKCQl9CgoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMuX3NldE9wdGlvbkRpc2FibGVkKCB2YWx1ZSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9zZXRPcHRpb25DbGFzc2VzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzS2V5LCBlbGVtZW50cywgY3VycmVudEVsZW1lbnRzOwoKCQlmb3IgKCBjbGFzc0tleSBpbiB2YWx1ZSApIHsKCQkJY3VycmVudEVsZW1lbnRzID0gdGhpcy5jbGFzc2VzRWxlbWVudExvb2t1cFsgY2xhc3NLZXkgXTsKCQkJaWYgKCB2YWx1ZVsgY2xhc3NLZXkgXSA9PT0gdGhpcy5vcHRpb25zLmNsYXNzZXNbIGNsYXNzS2V5IF0gfHwKCQkJCQkhY3VycmVudEVsZW1lbnRzIHx8CgkJCQkJIWN1cnJlbnRFbGVtZW50cy5sZW5ndGggKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gV2UgYXJlIGRvaW5nIHRoaXMgdG8gY3JlYXRlIGEgbmV3IGpRdWVyeSBvYmplY3QgYmVjYXVzZSB0aGUgX3JlbW92ZUNsYXNzKCkgY2FsbAoJCQkvLyBvbiB0aGUgbmV4dCBsaW5lIGlzIGdvaW5nIHRvIGRlc3Ryb3kgdGhlIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBlbGVtZW50cyBiZWluZwoJCQkvLyB0cmFja2VkLiBXZSBuZWVkIHRvIHNhdmUgYSBjb3B5IG9mIHRoaXMgY29sbGVjdGlvbiBzbyB0aGF0IHdlIGNhbiBhZGQgdGhlIG5ldyBjbGFzc2VzCgkJCS8vIGJlbG93LgoJCQllbGVtZW50cyA9ICQoIGN1cnJlbnRFbGVtZW50cy5nZXQoKSApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggY3VycmVudEVsZW1lbnRzLCBjbGFzc0tleSApOwoKCQkJLy8gV2UgZG9uJ3QgdXNlIF9hZGRDbGFzcygpIGhlcmUsIGJlY2F1c2UgdGhhdCB1c2VzIHRoaXMub3B0aW9ucy5jbGFzc2VzCgkJCS8vIGZvciBnZW5lcmF0aW5nIHRoZSBzdHJpbmcgb2YgY2xhc3Nlcy4gV2Ugd2FudCB0byB1c2UgdGhlIHZhbHVlIHBhc3NlZCBpbiBmcm9tCgkJCS8vIF9zZXRPcHRpb24oKSwgdGhpcyBpcyB0aGUgbmV3IHZhbHVlIG9mIHRoZSBjbGFzc2VzIG9wdGlvbiB3aGljaCB3YXMgcGFzc2VkIHRvCgkJCS8vIF9zZXRPcHRpb24oKS4gV2UgcGFzcyB0aGlzIHZhbHVlIGRpcmVjdGx5IHRvIF9jbGFzc2VzKCkuCgkJCWVsZW1lbnRzLmFkZENsYXNzKCB0aGlzLl9jbGFzc2VzKCB7CgkJCQllbGVtZW50OiBlbGVtZW50cywKCQkJCWtleXM6IGNsYXNzS2V5LAoJCQkJY2xhc3NlczogdmFsdWUsCgkJCQlhZGQ6IHRydWUKCQkJfSApICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy53aWRnZXQoKSwgdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQiLCBudWxsLCAhIXZhbHVlICk7CgoJCS8vIElmIHRoZSB3aWRnZXQgaXMgYmVjb21pbmcgZGlzYWJsZWQsIHRoZW4gbm90aGluZyBpcyBpbnRlcmFjdGl2ZQoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmhvdmVyYWJsZSwgbnVsbCwgInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5mb2N1c2FibGUsIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoIHsgZGlzYWJsZWQ6IGZhbHNlIH0gKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoIHsgZGlzYWJsZWQ6IHRydWUgfSApOwoJfSwKCglfY2xhc3NlczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGZ1bGwgPSBbXTsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCW9wdGlvbnMgPSAkLmV4dGVuZCggewoJCQllbGVtZW50OiB0aGlzLmVsZW1lbnQsCgkJCWNsYXNzZXM6IHRoaXMub3B0aW9ucy5jbGFzc2VzIHx8IHt9CgkJfSwgb3B0aW9ucyApOwoKCQlmdW5jdGlvbiBwcm9jZXNzQ2xhc3NTdHJpbmcoIGNsYXNzZXMsIGNoZWNrT3B0aW9uICkgewoJCQl2YXIgY3VycmVudCwgaTsKCQkJZm9yICggaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrICkgewoJCQkJY3VycmVudCA9IHRoYXQuY2xhc3Nlc0VsZW1lbnRMb29rdXBbIGNsYXNzZXNbIGkgXSBdIHx8ICQoKTsKCQkJCWlmICggb3B0aW9ucy5hZGQgKSB7CgkJCQkJY3VycmVudCA9ICQoICQudW5pcXVlKCBjdXJyZW50LmdldCgpLmNvbmNhdCggb3B0aW9ucy5lbGVtZW50LmdldCgpICkgKSApOwoJCQkJfSBlbHNlIHsKCQkJCQljdXJyZW50ID0gJCggY3VycmVudC5ub3QoIG9wdGlvbnMuZWxlbWVudCApLmdldCgpICk7CgkJCQl9CgkJCQl0aGF0LmNsYXNzZXNFbGVtZW50TG9va3VwWyBjbGFzc2VzWyBpIF0gXSA9IGN1cnJlbnQ7CgkJCQlmdWxsLnB1c2goIGNsYXNzZXNbIGkgXSApOwoJCQkJaWYgKCBjaGVja09wdGlvbiAmJiBvcHRpb25zLmNsYXNzZXNbIGNsYXNzZXNbIGkgXSBdICkgewoJCQkJCWZ1bGwucHVzaCggb3B0aW9ucy5jbGFzc2VzWyBjbGFzc2VzWyBpIF0gXSApOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLl9vbiggb3B0aW9ucy5lbGVtZW50LCB7CgkJCSJyZW1vdmUiOiAiX3VudHJhY2tDbGFzc2VzRWxlbWVudCIKCQl9ICk7CgoJCWlmICggb3B0aW9ucy5rZXlzICkgewoJCQlwcm9jZXNzQ2xhc3NTdHJpbmcoIG9wdGlvbnMua2V5cy5tYXRjaCggL1xTKy9nICkgfHwgW10sIHRydWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmV4dHJhICkgewoJCQlwcm9jZXNzQ2xhc3NTdHJpbmcoIG9wdGlvbnMuZXh0cmEubWF0Y2goIC9cUysvZyApIHx8IFtdICk7CgkJfQoKCQlyZXR1cm4gZnVsbC5qb2luKCAiICIgKTsKCX0sCgoJX3VudHJhY2tDbGFzc2VzRWxlbWVudDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQkkLmVhY2goIHRoYXQuY2xhc3Nlc0VsZW1lbnRMb29rdXAsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQlpZiAoICQuaW5BcnJheSggZXZlbnQudGFyZ2V0LCB2YWx1ZSApICE9PSAtMSApIHsKCQkJCXRoYXQuY2xhc3Nlc0VsZW1lbnRMb29rdXBbIGtleSBdID0gJCggdmFsdWUubm90KCBldmVudC50YXJnZXQgKS5nZXQoKSApOwoJCQl9CgkJfSApOwoJfSwKCglfcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKCBlbGVtZW50LCBrZXlzLCBleHRyYSApIHsKCQlyZXR1cm4gdGhpcy5fdG9nZ2xlQ2xhc3MoIGVsZW1lbnQsIGtleXMsIGV4dHJhLCBmYWxzZSApOwoJfSwKCglfYWRkQ2xhc3M6IGZ1bmN0aW9uKCBlbGVtZW50LCBrZXlzLCBleHRyYSApIHsKCQlyZXR1cm4gdGhpcy5fdG9nZ2xlQ2xhc3MoIGVsZW1lbnQsIGtleXMsIGV4dHJhLCB0cnVlICk7Cgl9LAoKCV90b2dnbGVDbGFzczogZnVuY3Rpb24oIGVsZW1lbnQsIGtleXMsIGV4dHJhLCBhZGQgKSB7CgkJYWRkID0gKCB0eXBlb2YgYWRkID09PSAiYm9vbGVhbiIgKSA\/IGFkZCA6IGV4dHJhOwoJCXZhciBzaGlmdCA9ICggdHlwZW9mIGVsZW1lbnQgPT09ICJzdHJpbmciIHx8IGVsZW1lbnQgPT09IG51bGwgKSwKCQkJb3B0aW9ucyA9IHsKCQkJCWV4dHJhOiBzaGlmdCA\/IGtleXMgOiBleHRyYSwKCQkJCWtleXM6IHNoaWZ0ID8gZWxlbWVudCA6IGtleXMsCgkJCQllbGVtZW50OiBzaGlmdCA\/IHRoaXMuZWxlbWVudCA6IGVsZW1lbnQsCgkJCQlhZGQ6IGFkZAoJCQl9OwoJCW9wdGlvbnMuZWxlbWVudC50b2dnbGVDbGFzcyggdGhpcy5fY2xhc3Nlcyggb3B0aW9ucyApLCBhZGQgKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50OwoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIE5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gTm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudCA9IGRlbGVnYXRlRWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQkkLmVhY2goIGhhbmRsZXJzLCBmdW5jdGlvbiggZXZlbnQsIGhhbmRsZXIgKSB7CgkJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCgkJCQkvLyBBbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJCX0KCgkJCS8vIENvcHkgdGhlIGd1aWQgc28gZGlyZWN0IHVuYmluZGluZyB3b3JrcwoJCQlpZiAoIHR5cGVvZiBoYW5kbGVyICE9PSAic3RyaW5nIiApIHsKCQkJCWhhbmRsZXJQcm94eS5ndWlkID0gaGFuZGxlci5ndWlkID0KCQkJCQloYW5kbGVyLmd1aWQgfHwgaGFuZGxlclByb3h5Lmd1aWQgfHwgJC5ndWlkKys7CgkJCX0KCgkJCXZhciBtYXRjaCA9IGV2ZW50Lm1hdGNoKCAvXihbXHc6LV0qKVxzKiguKikkLyApOwoJCQl2YXIgZXZlbnROYW1lID0gbWF0Y2hbIDEgXSArIGluc3RhbmNlLmV2ZW50TmFtZXNwYWNlOwoJCQl2YXIgc2VsZWN0b3IgPSBtYXRjaFsgMiBdOwoKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWRlbGVnYXRlRWxlbWVudC5vbiggZXZlbnROYW1lLCBzZWxlY3RvciwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50Lm9uKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSApOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9ICggZXZlbnROYW1lIHx8ICIiICkuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArCgkJCXRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC5vZmYoIGV2ZW50TmFtZSApLm9mZiggZXZlbnROYW1lICk7CgoJCS8vIENsZWFyIHRoZSBzdGFjayB0byBhdm9pZCBtZW1vcnkgbGVha3MgKCMxMDA1NikKCQl0aGlzLmJpbmRpbmdzID0gJCggdGhpcy5iaW5kaW5ncy5ub3QoIGVsZW1lbnQgKS5nZXQoKSApOwoJCXRoaXMuZm9jdXNhYmxlID0gJCggdGhpcy5mb2N1c2FibGUubm90KCBlbGVtZW50ICkuZ2V0KCkgKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoIHRoaXMuaG92ZXJhYmxlLm5vdCggZWxlbWVudCApLmdldCgpICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwgbnVsbCwgInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSApOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX2FkZENsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICksIG51bGwsICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0gKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZzsKCQl2YXIgY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoKCQkvLyBUaGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIENvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFsgMCBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgoJCXZhciBoYXNPcHRpb25zOwoJCXZhciBlZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQltZXRob2QgOgoJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA\/CgkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKCBmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0gKTsKCQl9Cgl9Owp9ICk7Cgp2YXIgd2lkZ2V0ID0gJC53aWRnZXQ7CgoKLyohCiAqIGpRdWVyeSBVSSBQb3NpdGlvbiAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vcG9zaXRpb24vCiAqLwoKLy8+PmxhYmVsOiBQb3NpdGlvbgovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBQb3NpdGlvbnMgZWxlbWVudHMgcmVsYXRpdmUgdG8gb3RoZXIgZWxlbWVudHMuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wb3NpdGlvbi8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3Bvc2l0aW9uLwoKCiggZnVuY3Rpb24oKSB7CnZhciBjYWNoZWRTY3JvbGxiYXJXaWR0aCwKCW1heCA9IE1hdGgubWF4LAoJYWJzID0gTWF0aC5hYnMsCglyaG9yaXpvbnRhbCA9IC9sZWZ0fGNlbnRlcnxyaWdodC8sCglydmVydGljYWwgPSAvdG9wfGNlbnRlcnxib3R0b20vLAoJcm9mZnNldCA9IC9bXCtcLV1cZCsoXC5bXGRdKyk\/JT8vLAoJcnBvc2l0aW9uID0gL15cdysvLAoJcnBlcmNlbnQgPSAvJSQvLAoJX3Bvc2l0aW9uID0gJC5mbi5wb3NpdGlvbjsKCmZ1bmN0aW9uIGdldE9mZnNldHMoIG9mZnNldHMsIHdpZHRoLCBoZWlnaHQgKSB7CglyZXR1cm4gWwoJCXBhcnNlRmxvYXQoIG9mZnNldHNbIDAgXSApICogKCBycGVyY2VudC50ZXN0KCBvZmZzZXRzWyAwIF0gKSA\/IHdpZHRoIC8gMTAwIDogMSApLAoJCXBhcnNlRmxvYXQoIG9mZnNldHNbIDEgXSApICogKCBycGVyY2VudC50ZXN0KCBvZmZzZXRzWyAxIF0gKSA\/IGhlaWdodCAvIDEwMCA6IDEgKQoJXTsKfQoKZnVuY3Rpb24gcGFyc2VDc3MoIGVsZW1lbnQsIHByb3BlcnR5ICkgewoJcmV0dXJuIHBhcnNlSW50KCAkLmNzcyggZWxlbWVudCwgcHJvcGVydHkgKSwgMTAgKSB8fCAwOwp9CgpmdW5jdGlvbiBnZXREaW1lbnNpb25zKCBlbGVtICkgewoJdmFyIHJhdyA9IGVsZW1bIDAgXTsKCWlmICggcmF3Lm5vZGVUeXBlID09PSA5ICkgewoJCXJldHVybiB7CgkJCXdpZHRoOiBlbGVtLndpZHRoKCksCgkJCWhlaWdodDogZWxlbS5oZWlnaHQoKSwKCQkJb2Zmc2V0OiB7IHRvcDogMCwgbGVmdDogMCB9CgkJfTsKCX0KCWlmICggJC5pc1dpbmRvdyggcmF3ICkgKSB7CgkJcmV0dXJuIHsKCQkJd2lkdGg6IGVsZW0ud2lkdGgoKSwKCQkJaGVpZ2h0OiBlbGVtLmhlaWdodCgpLAoJCQlvZmZzZXQ6IHsgdG9wOiBlbGVtLnNjcm9sbFRvcCgpLCBsZWZ0OiBlbGVtLnNjcm9sbExlZnQoKSB9CgkJfTsKCX0KCWlmICggcmF3LnByZXZlbnREZWZhdWx0ICkgewoJCXJldHVybiB7CgkJCXdpZHRoOiAwLAoJCQloZWlnaHQ6IDAsCgkJCW9mZnNldDogeyB0b3A6IHJhdy5wYWdlWSwgbGVmdDogcmF3LnBhZ2VYIH0KCQl9OwoJfQoJcmV0dXJuIHsKCQl3aWR0aDogZWxlbS5vdXRlcldpZHRoKCksCgkJaGVpZ2h0OiBlbGVtLm91dGVySGVpZ2h0KCksCgkJb2Zmc2V0OiBlbGVtLm9mZnNldCgpCgl9Owp9CgokLnBvc2l0aW9uID0gewoJc2Nyb2xsYmFyV2lkdGg6IGZ1bmN0aW9uKCkgewoJCWlmICggY2FjaGVkU2Nyb2xsYmFyV2lkdGggIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGNhY2hlZFNjcm9sbGJhcldpZHRoOwoJCX0KCQl2YXIgdzEsIHcyLAoJCQlkaXYgPSAkKCAiPGRpdiAiICsKCQkJCSJzdHlsZT0nZGlzcGxheTpibG9jaztwb3NpdGlvbjphYnNvbHV0ZTt3aWR0aDo1MHB4O2hlaWdodDo1MHB4O292ZXJmbG93OmhpZGRlbjsnPiIgKwoJCQkJIjxkaXYgc3R5bGU9J2hlaWdodDoxMDBweDt3aWR0aDphdXRvOyc+PC9kaXY+PC9kaXY+IiApLAoJCQlpbm5lckRpdiA9IGRpdi5jaGlsZHJlbigpWyAwIF07CgoJCSQoICJib2R5IiApLmFwcGVuZCggZGl2ICk7CgkJdzEgPSBpbm5lckRpdi5vZmZzZXRXaWR0aDsKCQlkaXYuY3NzKCAib3ZlcmZsb3ciLCAic2Nyb2xsIiApOwoKCQl3MiA9IGlubmVyRGl2Lm9mZnNldFdpZHRoOwoKCQlpZiAoIHcxID09PSB3MiApIHsKCQkJdzIgPSBkaXZbIDAgXS5jbGllbnRXaWR0aDsKCQl9CgoJCWRpdi5yZW1vdmUoKTsKCgkJcmV0dXJuICggY2FjaGVkU2Nyb2xsYmFyV2lkdGggPSB3MSAtIHcyICk7Cgl9LAoJZ2V0U2Nyb2xsSW5mbzogZnVuY3Rpb24oIHdpdGhpbiApIHsKCQl2YXIgb3ZlcmZsb3dYID0gd2l0aGluLmlzV2luZG93IHx8IHdpdGhpbi5pc0RvY3VtZW50ID8gIiIgOgoJCQkJd2l0aGluLmVsZW1lbnQuY3NzKCAib3ZlcmZsb3cteCIgKSwKCQkJb3ZlcmZsb3dZID0gd2l0aGluLmlzV2luZG93IHx8IHdpdGhpbi5pc0RvY3VtZW50ID8gIiIgOgoJCQkJd2l0aGluLmVsZW1lbnQuY3NzKCAib3ZlcmZsb3cteSIgKSwKCQkJaGFzT3ZlcmZsb3dYID0gb3ZlcmZsb3dYID09PSAic2Nyb2xsIiB8fAoJCQkJKCBvdmVyZmxvd1ggPT09ICJhdXRvIiAmJiB3aXRoaW4ud2lkdGggPCB3aXRoaW4uZWxlbWVudFsgMCBdLnNjcm9sbFdpZHRoICksCgkJCWhhc092ZXJmbG93WSA9IG92ZXJmbG93WSA9PT0gInNjcm9sbCIgfHwKCQkJCSggb3ZlcmZsb3dZID09PSAiYXV0byIgJiYgd2l0aGluLmhlaWdodCA8IHdpdGhpbi5lbGVtZW50WyAwIF0uc2Nyb2xsSGVpZ2h0ICk7CgkJcmV0dXJuIHsKCQkJd2lkdGg6IGhhc092ZXJmbG93WSA\/ICQucG9zaXRpb24uc2Nyb2xsYmFyV2lkdGgoKSA6IDAsCgkJCWhlaWdodDogaGFzT3ZlcmZsb3dYID8gJC5wb3NpdGlvbi5zY3JvbGxiYXJXaWR0aCgpIDogMAoJCX07Cgl9LAoJZ2V0V2l0aGluSW5mbzogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIHdpdGhpbkVsZW1lbnQgPSAkKCBlbGVtZW50IHx8IHdpbmRvdyApLAoJCQlpc1dpbmRvdyA9ICQuaXNXaW5kb3coIHdpdGhpbkVsZW1lbnRbIDAgXSApLAoJCQlpc0RvY3VtZW50ID0gISF3aXRoaW5FbGVtZW50WyAwIF0gJiYgd2l0aGluRWxlbWVudFsgMCBdLm5vZGVUeXBlID09PSA5LAoJCQloYXNPZmZzZXQgPSAhaXNXaW5kb3cgJiYgIWlzRG9jdW1lbnQ7CgkJcmV0dXJuIHsKCQkJZWxlbWVudDogd2l0aGluRWxlbWVudCwKCQkJaXNXaW5kb3c6IGlzV2luZG93LAoJCQlpc0RvY3VtZW50OiBpc0RvY3VtZW50LAoJCQlvZmZzZXQ6IGhhc09mZnNldCA\/ICQoIGVsZW1lbnQgKS5vZmZzZXQoKSA6IHsgbGVmdDogMCwgdG9wOiAwIH0sCgkJCXNjcm9sbExlZnQ6IHdpdGhpbkVsZW1lbnQuc2Nyb2xsTGVmdCgpLAoJCQlzY3JvbGxUb3A6IHdpdGhpbkVsZW1lbnQuc2Nyb2xsVG9wKCksCgkJCXdpZHRoOiB3aXRoaW5FbGVtZW50Lm91dGVyV2lkdGgoKSwKCQkJaGVpZ2h0OiB3aXRoaW5FbGVtZW50Lm91dGVySGVpZ2h0KCkKCQl9OwoJfQp9OwoKJC5mbi5wb3NpdGlvbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJaWYgKCAhb3B0aW9ucyB8fCAhb3B0aW9ucy5vZiApIHsKCQlyZXR1cm4gX3Bvc2l0aW9uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX0KCgkvLyBNYWtlIGEgY29weSwgd2UgZG9uJ3Qgd2FudCB0byBtb2RpZnkgYXJndW1lbnRzCglvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJdmFyIGF0T2Zmc2V0LCB0YXJnZXRXaWR0aCwgdGFyZ2V0SGVpZ2h0LCB0YXJnZXRPZmZzZXQsIGJhc2VQb3NpdGlvbiwgZGltZW5zaW9ucywKCQl0YXJnZXQgPSAkKCBvcHRpb25zLm9mICksCgkJd2l0aGluID0gJC5wb3NpdGlvbi5nZXRXaXRoaW5JbmZvKCBvcHRpb25zLndpdGhpbiApLAoJCXNjcm9sbEluZm8gPSAkLnBvc2l0aW9uLmdldFNjcm9sbEluZm8oIHdpdGhpbiApLAoJCWNvbGxpc2lvbiA9ICggb3B0aW9ucy5jb2xsaXNpb24gfHwgImZsaXAiICkuc3BsaXQoICIgIiApLAoJCW9mZnNldHMgPSB7fTsKCglkaW1lbnNpb25zID0gZ2V0RGltZW5zaW9ucyggdGFyZ2V0ICk7CglpZiAoIHRhcmdldFsgMCBdLnByZXZlbnREZWZhdWx0ICkgewoKCQkvLyBGb3JjZSBsZWZ0IHRvcCB0byBhbGxvdyBmbGlwcGluZwoJCW9wdGlvbnMuYXQgPSAibGVmdCB0b3AiOwoJfQoJdGFyZ2V0V2lkdGggPSBkaW1lbnNpb25zLndpZHRoOwoJdGFyZ2V0SGVpZ2h0ID0gZGltZW5zaW9ucy5oZWlnaHQ7Cgl0YXJnZXRPZmZzZXQgPSBkaW1lbnNpb25zLm9mZnNldDsKCgkvLyBDbG9uZSB0byByZXVzZSBvcmlnaW5hbCB0YXJnZXRPZmZzZXQgbGF0ZXIKCWJhc2VQb3NpdGlvbiA9ICQuZXh0ZW5kKCB7fSwgdGFyZ2V0T2Zmc2V0ICk7CgoJLy8gRm9yY2UgbXkgYW5kIGF0IHRvIGhhdmUgdmFsaWQgaG9yaXpvbnRhbCBhbmQgdmVydGljYWwgcG9zaXRpb25zCgkvLyBpZiBhIHZhbHVlIGlzIG1pc3Npbmcgb3IgaW52YWxpZCwgaXQgd2lsbCBiZSBjb252ZXJ0ZWQgdG8gY2VudGVyCgkkLmVhY2goIFsgIm15IiwgImF0IiBdLCBmdW5jdGlvbigpIHsKCQl2YXIgcG9zID0gKCBvcHRpb25zWyB0aGlzIF0gfHwgIiIgKS5zcGxpdCggIiAiICksCgkJCWhvcml6b250YWxPZmZzZXQsCgkJCXZlcnRpY2FsT2Zmc2V0OwoKCQlpZiAoIHBvcy5sZW5ndGggPT09IDEgKSB7CgkJCXBvcyA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPwoJCQkJcG9zLmNvbmNhdCggWyAiY2VudGVyIiBdICkgOgoJCQkJcnZlcnRpY2FsLnRlc3QoIHBvc1sgMCBdICkgPwoJCQkJCVsgImNlbnRlciIgXS5jb25jYXQoIHBvcyApIDoKCQkJCQlbICJjZW50ZXIiLCAiY2VudGVyIiBdOwoJCX0KCQlwb3NbIDAgXSA9IHJob3Jpem9udGFsLnRlc3QoIHBvc1sgMCBdICkgPyBwb3NbIDAgXSA6ICJjZW50ZXIiOwoJCXBvc1sgMSBdID0gcnZlcnRpY2FsLnRlc3QoIHBvc1sgMSBdICkgPyBwb3NbIDEgXSA6ICJjZW50ZXIiOwoKCQkvLyBDYWxjdWxhdGUgb2Zmc2V0cwoJCWhvcml6b250YWxPZmZzZXQgPSByb2Zmc2V0LmV4ZWMoIHBvc1sgMCBdICk7CgkJdmVydGljYWxPZmZzZXQgPSByb2Zmc2V0LmV4ZWMoIHBvc1sgMSBdICk7CgkJb2Zmc2V0c1sgdGhpcyBdID0gWwoJCQlob3Jpem9udGFsT2Zmc2V0ID8gaG9yaXpvbnRhbE9mZnNldFsgMCBdIDogMCwKCQkJdmVydGljYWxPZmZzZXQgPyB2ZXJ0aWNhbE9mZnNldFsgMCBdIDogMAoJCV07CgoJCS8vIFJlZHVjZSB0byBqdXN0IHRoZSBwb3NpdGlvbnMgd2l0aG91dCB0aGUgb2Zmc2V0cwoJCW9wdGlvbnNbIHRoaXMgXSA9IFsKCQkJcnBvc2l0aW9uLmV4ZWMoIHBvc1sgMCBdIClbIDAgXSwKCQkJcnBvc2l0aW9uLmV4ZWMoIHBvc1sgMSBdIClbIDAgXQoJCV07Cgl9ICk7CgoJLy8gTm9ybWFsaXplIGNvbGxpc2lvbiBvcHRpb24KCWlmICggY29sbGlzaW9uLmxlbmd0aCA9PT0gMSApIHsKCQljb2xsaXNpb25bIDEgXSA9IGNvbGxpc2lvblsgMCBdOwoJfQoKCWlmICggb3B0aW9ucy5hdFsgMCBdID09PSAicmlnaHQiICkgewoJCWJhc2VQb3NpdGlvbi5sZWZ0ICs9IHRhcmdldFdpZHRoOwoJfSBlbHNlIGlmICggb3B0aW9ucy5hdFsgMCBdID09PSAiY2VudGVyIiApIHsKCQliYXNlUG9zaXRpb24ubGVmdCArPSB0YXJnZXRXaWR0aCAvIDI7Cgl9CgoJaWYgKCBvcHRpb25zLmF0WyAxIF0gPT09ICJib3R0b20iICkgewoJCWJhc2VQb3NpdGlvbi50b3AgKz0gdGFyZ2V0SGVpZ2h0OwoJfSBlbHNlIGlmICggb3B0aW9ucy5hdFsgMSBdID09PSAiY2VudGVyIiApIHsKCQliYXNlUG9zaXRpb24udG9wICs9IHRhcmdldEhlaWdodCAvIDI7Cgl9CgoJYXRPZmZzZXQgPSBnZXRPZmZzZXRzKCBvZmZzZXRzLmF0LCB0YXJnZXRXaWR0aCwgdGFyZ2V0SGVpZ2h0ICk7CgliYXNlUG9zaXRpb24ubGVmdCArPSBhdE9mZnNldFsgMCBdOwoJYmFzZVBvc2l0aW9uLnRvcCArPSBhdE9mZnNldFsgMSBdOwoKCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCXZhciBjb2xsaXNpb25Qb3NpdGlvbiwgdXNpbmcsCgkJCWVsZW0gPSAkKCB0aGlzICksCgkJCWVsZW1XaWR0aCA9IGVsZW0ub3V0ZXJXaWR0aCgpLAoJCQllbGVtSGVpZ2h0ID0gZWxlbS5vdXRlckhlaWdodCgpLAoJCQltYXJnaW5MZWZ0ID0gcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5MZWZ0IiApLAoJCQltYXJnaW5Ub3AgPSBwYXJzZUNzcyggdGhpcywgIm1hcmdpblRvcCIgKSwKCQkJY29sbGlzaW9uV2lkdGggPSBlbGVtV2lkdGggKyBtYXJnaW5MZWZ0ICsgcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5SaWdodCIgKSArCgkJCQlzY3JvbGxJbmZvLndpZHRoLAoJCQljb2xsaXNpb25IZWlnaHQgPSBlbGVtSGVpZ2h0ICsgbWFyZ2luVG9wICsgcGFyc2VDc3MoIHRoaXMsICJtYXJnaW5Cb3R0b20iICkgKwoJCQkJc2Nyb2xsSW5mby5oZWlnaHQsCgkJCXBvc2l0aW9uID0gJC5leHRlbmQoIHt9LCBiYXNlUG9zaXRpb24gKSwKCQkJbXlPZmZzZXQgPSBnZXRPZmZzZXRzKCBvZmZzZXRzLm15LCBlbGVtLm91dGVyV2lkdGgoKSwgZWxlbS5vdXRlckhlaWdodCgpICk7CgoJCWlmICggb3B0aW9ucy5teVsgMCBdID09PSAicmlnaHQiICkgewoJCQlwb3NpdGlvbi5sZWZ0IC09IGVsZW1XaWR0aDsKCQl9IGVsc2UgaWYgKCBvcHRpb25zLm15WyAwIF0gPT09ICJjZW50ZXIiICkgewoJCQlwb3NpdGlvbi5sZWZ0IC09IGVsZW1XaWR0aCAvIDI7CgkJfQoKCQlpZiAoIG9wdGlvbnMubXlbIDEgXSA9PT0gImJvdHRvbSIgKSB7CgkJCXBvc2l0aW9uLnRvcCAtPSBlbGVtSGVpZ2h0OwoJCX0gZWxzZSBpZiAoIG9wdGlvbnMubXlbIDEgXSA9PT0gImNlbnRlciIgKSB7CgkJCXBvc2l0aW9uLnRvcCAtPSBlbGVtSGVpZ2h0IC8gMjsKCQl9CgoJCXBvc2l0aW9uLmxlZnQgKz0gbXlPZmZzZXRbIDAgXTsKCQlwb3NpdGlvbi50b3AgKz0gbXlPZmZzZXRbIDEgXTsKCgkJY29sbGlzaW9uUG9zaXRpb24gPSB7CgkJCW1hcmdpbkxlZnQ6IG1hcmdpbkxlZnQsCgkJCW1hcmdpblRvcDogbWFyZ2luVG9wCgkJfTsKCgkJJC5lYWNoKCBbICJsZWZ0IiwgInRvcCIgXSwgZnVuY3Rpb24oIGksIGRpciApIHsKCQkJaWYgKCAkLnVpLnBvc2l0aW9uWyBjb2xsaXNpb25bIGkgXSBdICkgewoJCQkJJC51aS5wb3NpdGlvblsgY29sbGlzaW9uWyBpIF0gXVsgZGlyIF0oIHBvc2l0aW9uLCB7CgkJCQkJdGFyZ2V0V2lkdGg6IHRhcmdldFdpZHRoLAoJCQkJCXRhcmdldEhlaWdodDogdGFyZ2V0SGVpZ2h0LAoJCQkJCWVsZW1XaWR0aDogZWxlbVdpZHRoLAoJCQkJCWVsZW1IZWlnaHQ6IGVsZW1IZWlnaHQsCgkJCQkJY29sbGlzaW9uUG9zaXRpb246IGNvbGxpc2lvblBvc2l0aW9uLAoJCQkJCWNvbGxpc2lvbldpZHRoOiBjb2xsaXNpb25XaWR0aCwKCQkJCQljb2xsaXNpb25IZWlnaHQ6IGNvbGxpc2lvbkhlaWdodCwKCQkJCQlvZmZzZXQ6IFsgYXRPZmZzZXRbIDAgXSArIG15T2Zmc2V0WyAwIF0sIGF0T2Zmc2V0IFsgMSBdICsgbXlPZmZzZXRbIDEgXSBdLAoJCQkJCW15OiBvcHRpb25zLm15LAoJCQkJCWF0OiBvcHRpb25zLmF0LAoJCQkJCXdpdGhpbjogd2l0aGluLAoJCQkJCWVsZW06IGVsZW0KCQkJCX0gKTsKCQkJfQoJCX0gKTsKCgkJaWYgKCBvcHRpb25zLnVzaW5nICkgewoKCQkJLy8gQWRkcyBmZWVkYmFjayBhcyBzZWNvbmQgYXJndW1lbnQgdG8gdXNpbmcgY2FsbGJhY2ssIGlmIHByZXNlbnQKCQkJdXNpbmcgPSBmdW5jdGlvbiggcHJvcHMgKSB7CgkJCQl2YXIgbGVmdCA9IHRhcmdldE9mZnNldC5sZWZ0IC0gcG9zaXRpb24ubGVmdCwKCQkJCQlyaWdodCA9IGxlZnQgKyB0YXJnZXRXaWR0aCAtIGVsZW1XaWR0aCwKCQkJCQl0b3AgPSB0YXJnZXRPZmZzZXQudG9wIC0gcG9zaXRpb24udG9wLAoJCQkJCWJvdHRvbSA9IHRvcCArIHRhcmdldEhlaWdodCAtIGVsZW1IZWlnaHQsCgkJCQkJZmVlZGJhY2sgPSB7CgkJCQkJCXRhcmdldDogewoJCQkJCQkJZWxlbWVudDogdGFyZ2V0LAoJCQkJCQkJbGVmdDogdGFyZ2V0T2Zmc2V0LmxlZnQsCgkJCQkJCQl0b3A6IHRhcmdldE9mZnNldC50b3AsCgkJCQkJCQl3aWR0aDogdGFyZ2V0V2lkdGgsCgkJCQkJCQloZWlnaHQ6IHRhcmdldEhlaWdodAoJCQkJCQl9LAoJCQkJCQllbGVtZW50OiB7CgkJCQkJCQllbGVtZW50OiBlbGVtLAoJCQkJCQkJbGVmdDogcG9zaXRpb24ubGVmdCwKCQkJCQkJCXRvcDogcG9zaXRpb24udG9wLAoJCQkJCQkJd2lkdGg6IGVsZW1XaWR0aCwKCQkJCQkJCWhlaWdodDogZWxlbUhlaWdodAoJCQkJCQl9LAoJCQkJCQlob3Jpem9udGFsOiByaWdodCA8IDAgPyAibGVmdCIgOiBsZWZ0ID4gMCA\/ICJyaWdodCIgOiAiY2VudGVyIiwKCQkJCQkJdmVydGljYWw6IGJvdHRvbSA8IDAgPyAidG9wIiA6IHRvcCA+IDAgPyAiYm90dG9tIiA6ICJtaWRkbGUiCgkJCQkJfTsKCQkJCWlmICggdGFyZ2V0V2lkdGggPCBlbGVtV2lkdGggJiYgYWJzKCBsZWZ0ICsgcmlnaHQgKSA8IHRhcmdldFdpZHRoICkgewoJCQkJCWZlZWRiYWNrLmhvcml6b250YWwgPSAiY2VudGVyIjsKCQkJCX0KCQkJCWlmICggdGFyZ2V0SGVpZ2h0IDwgZWxlbUhlaWdodCAmJiBhYnMoIHRvcCArIGJvdHRvbSApIDwgdGFyZ2V0SGVpZ2h0ICkgewoJCQkJCWZlZWRiYWNrLnZlcnRpY2FsID0gIm1pZGRsZSI7CgkJCQl9CgkJCQlpZiAoIG1heCggYWJzKCBsZWZ0ICksIGFicyggcmlnaHQgKSApID4gbWF4KCBhYnMoIHRvcCApLCBhYnMoIGJvdHRvbSApICkgKSB7CgkJCQkJZmVlZGJhY2suaW1wb3J0YW50ID0gImhvcml6b250YWwiOwoJCQkJfSBlbHNlIHsKCQkJCQlmZWVkYmFjay5pbXBvcnRhbnQgPSAidmVydGljYWwiOwoJCQkJfQoJCQkJb3B0aW9ucy51c2luZy5jYWxsKCB0aGlzLCBwcm9wcywgZmVlZGJhY2sgKTsKCQkJfTsKCQl9CgoJCWVsZW0ub2Zmc2V0KCAkLmV4dGVuZCggcG9zaXRpb24sIHsgdXNpbmc6IHVzaW5nIH0gKSApOwoJfSApOwp9OwoKJC51aS5wb3NpdGlvbiA9IHsKCWZpdDogewoJCWxlZnQ6IGZ1bmN0aW9uKCBwb3NpdGlvbiwgZGF0YSApIHsKCQkJdmFyIHdpdGhpbiA9IGRhdGEud2l0aGluLAoJCQkJd2l0aGluT2Zmc2V0ID0gd2l0aGluLmlzV2luZG93ID8gd2l0aGluLnNjcm9sbExlZnQgOiB3aXRoaW4ub2Zmc2V0LmxlZnQsCgkJCQlvdXRlcldpZHRoID0gd2l0aGluLndpZHRoLAoJCQkJY29sbGlzaW9uUG9zTGVmdCA9IHBvc2l0aW9uLmxlZnQgLSBkYXRhLmNvbGxpc2lvblBvc2l0aW9uLm1hcmdpbkxlZnQsCgkJCQlvdmVyTGVmdCA9IHdpdGhpbk9mZnNldCAtIGNvbGxpc2lvblBvc0xlZnQsCgkJCQlvdmVyUmlnaHQgPSBjb2xsaXNpb25Qb3NMZWZ0ICsgZGF0YS5jb2xsaXNpb25XaWR0aCAtIG91dGVyV2lkdGggLSB3aXRoaW5PZmZzZXQsCgkJCQluZXdPdmVyUmlnaHQ7CgoJCQkvLyBFbGVtZW50IGlzIHdpZGVyIHRoYW4gd2l0aGluCgkJCWlmICggZGF0YS5jb2xsaXNpb25XaWR0aCA+IG91dGVyV2lkdGggKSB7CgoJCQkJLy8gRWxlbWVudCBpcyBpbml0aWFsbHkgb3ZlciB0aGUgbGVmdCBzaWRlIG9mIHdpdGhpbgoJCQkJaWYgKCBvdmVyTGVmdCA+IDAgJiYgb3ZlclJpZ2h0IDw9IDAgKSB7CgkJCQkJbmV3T3ZlclJpZ2h0ID0gcG9zaXRpb24ubGVmdCArIG92ZXJMZWZ0ICsgZGF0YS5jb2xsaXNpb25XaWR0aCAtIG91dGVyV2lkdGggLQoJCQkJCQl3aXRoaW5PZmZzZXQ7CgkJCQkJcG9zaXRpb24ubGVmdCArPSBvdmVyTGVmdCAtIG5ld092ZXJSaWdodDsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIHJpZ2h0IHNpZGUgb2Ygd2l0aGluCgkJCQl9IGVsc2UgaWYgKCBvdmVyUmlnaHQgPiAwICYmIG92ZXJMZWZ0IDw9IDAgKSB7CgkJCQkJcG9zaXRpb24ubGVmdCA9IHdpdGhpbk9mZnNldDsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIGJvdGggbGVmdCBhbmQgcmlnaHQgc2lkZXMgb2Ygd2l0aGluCgkJCQl9IGVsc2UgewoJCQkJCWlmICggb3ZlckxlZnQgPiBvdmVyUmlnaHQgKSB7CgkJCQkJCXBvc2l0aW9uLmxlZnQgPSB3aXRoaW5PZmZzZXQgKyBvdXRlcldpZHRoIC0gZGF0YS5jb2xsaXNpb25XaWR0aDsKCQkJCQl9IGVsc2UgewoJCQkJCQlwb3NpdGlvbi5sZWZ0ID0gd2l0aGluT2Zmc2V0OwoJCQkJCX0KCQkJCX0KCgkJCS8vIFRvbyBmYXIgbGVmdCAtPiBhbGlnbiB3aXRoIGxlZnQgZWRnZQoJCQl9IGVsc2UgaWYgKCBvdmVyTGVmdCA+IDAgKSB7CgkJCQlwb3NpdGlvbi5sZWZ0ICs9IG92ZXJMZWZ0OwoKCQkJLy8gVG9vIGZhciByaWdodCAtPiBhbGlnbiB3aXRoIHJpZ2h0IGVkZ2UKCQkJfSBlbHNlIGlmICggb3ZlclJpZ2h0ID4gMCApIHsKCQkJCXBvc2l0aW9uLmxlZnQgLT0gb3ZlclJpZ2h0OwoKCQkJLy8gQWRqdXN0IGJhc2VkIG9uIHBvc2l0aW9uIGFuZCBtYXJnaW4KCQkJfSBlbHNlIHsKCQkJCXBvc2l0aW9uLmxlZnQgPSBtYXgoIHBvc2l0aW9uLmxlZnQgLSBjb2xsaXNpb25Qb3NMZWZ0LCBwb3NpdGlvbi5sZWZ0ICk7CgkJCX0KCQl9LAoJCXRvcDogZnVuY3Rpb24oIHBvc2l0aW9uLCBkYXRhICkgewoJCQl2YXIgd2l0aGluID0gZGF0YS53aXRoaW4sCgkJCQl3aXRoaW5PZmZzZXQgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsVG9wIDogd2l0aGluLm9mZnNldC50b3AsCgkJCQlvdXRlckhlaWdodCA9IGRhdGEud2l0aGluLmhlaWdodCwKCQkJCWNvbGxpc2lvblBvc1RvcCA9IHBvc2l0aW9uLnRvcCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luVG9wLAoJCQkJb3ZlclRvcCA9IHdpdGhpbk9mZnNldCAtIGNvbGxpc2lvblBvc1RvcCwKCQkJCW92ZXJCb3R0b20gPSBjb2xsaXNpb25Qb3NUb3AgKyBkYXRhLmNvbGxpc2lvbkhlaWdodCAtIG91dGVySGVpZ2h0IC0gd2l0aGluT2Zmc2V0LAoJCQkJbmV3T3ZlckJvdHRvbTsKCgkJCS8vIEVsZW1lbnQgaXMgdGFsbGVyIHRoYW4gd2l0aGluCgkJCWlmICggZGF0YS5jb2xsaXNpb25IZWlnaHQgPiBvdXRlckhlaWdodCApIHsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIHRoZSB0b3Agb2Ygd2l0aGluCgkJCQlpZiAoIG92ZXJUb3AgPiAwICYmIG92ZXJCb3R0b20gPD0gMCApIHsKCQkJCQluZXdPdmVyQm90dG9tID0gcG9zaXRpb24udG9wICsgb3ZlclRvcCArIGRhdGEuY29sbGlzaW9uSGVpZ2h0IC0gb3V0ZXJIZWlnaHQgLQoJCQkJCQl3aXRoaW5PZmZzZXQ7CgkJCQkJcG9zaXRpb24udG9wICs9IG92ZXJUb3AgLSBuZXdPdmVyQm90dG9tOwoKCQkJCS8vIEVsZW1lbnQgaXMgaW5pdGlhbGx5IG92ZXIgYm90dG9tIG9mIHdpdGhpbgoJCQkJfSBlbHNlIGlmICggb3ZlckJvdHRvbSA+IDAgJiYgb3ZlclRvcCA8PSAwICkgewoJCQkJCXBvc2l0aW9uLnRvcCA9IHdpdGhpbk9mZnNldDsKCgkJCQkvLyBFbGVtZW50IGlzIGluaXRpYWxseSBvdmVyIGJvdGggdG9wIGFuZCBib3R0b20gb2Ygd2l0aGluCgkJCQl9IGVsc2UgewoJCQkJCWlmICggb3ZlclRvcCA+IG92ZXJCb3R0b20gKSB7CgkJCQkJCXBvc2l0aW9uLnRvcCA9IHdpdGhpbk9mZnNldCArIG91dGVySGVpZ2h0IC0gZGF0YS5jb2xsaXNpb25IZWlnaHQ7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcG9zaXRpb24udG9wID0gd2l0aGluT2Zmc2V0OwoJCQkJCX0KCQkJCX0KCgkJCS8vIFRvbyBmYXIgdXAgLT4gYWxpZ24gd2l0aCB0b3AKCQkJfSBlbHNlIGlmICggb3ZlclRvcCA+IDAgKSB7CgkJCQlwb3NpdGlvbi50b3AgKz0gb3ZlclRvcDsKCgkJCS8vIFRvbyBmYXIgZG93biAtPiBhbGlnbiB3aXRoIGJvdHRvbSBlZGdlCgkJCX0gZWxzZSBpZiAoIG92ZXJCb3R0b20gPiAwICkgewoJCQkJcG9zaXRpb24udG9wIC09IG92ZXJCb3R0b207CgoJCQkvLyBBZGp1c3QgYmFzZWQgb24gcG9zaXRpb24gYW5kIG1hcmdpbgoJCQl9IGVsc2UgewoJCQkJcG9zaXRpb24udG9wID0gbWF4KCBwb3NpdGlvbi50b3AgLSBjb2xsaXNpb25Qb3NUb3AsIHBvc2l0aW9uLnRvcCApOwoJCQl9CgkJfQoJfSwKCWZsaXA6IHsKCQlsZWZ0OiBmdW5jdGlvbiggcG9zaXRpb24sIGRhdGEgKSB7CgkJCXZhciB3aXRoaW4gPSBkYXRhLndpdGhpbiwKCQkJCXdpdGhpbk9mZnNldCA9IHdpdGhpbi5vZmZzZXQubGVmdCArIHdpdGhpbi5zY3JvbGxMZWZ0LAoJCQkJb3V0ZXJXaWR0aCA9IHdpdGhpbi53aWR0aCwKCQkJCW9mZnNldExlZnQgPSB3aXRoaW4uaXNXaW5kb3cgPyB3aXRoaW4uc2Nyb2xsTGVmdCA6IHdpdGhpbi5vZmZzZXQubGVmdCwKCQkJCWNvbGxpc2lvblBvc0xlZnQgPSBwb3NpdGlvbi5sZWZ0IC0gZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5MZWZ0LAoJCQkJb3ZlckxlZnQgPSBjb2xsaXNpb25Qb3NMZWZ0IC0gb2Zmc2V0TGVmdCwKCQkJCW92ZXJSaWdodCA9IGNvbGxpc2lvblBvc0xlZnQgKyBkYXRhLmNvbGxpc2lvbldpZHRoIC0gb3V0ZXJXaWR0aCAtIG9mZnNldExlZnQsCgkJCQlteU9mZnNldCA9IGRhdGEubXlbIDAgXSA9PT0gImxlZnQiID8KCQkJCQktZGF0YS5lbGVtV2lkdGggOgoJCQkJCWRhdGEubXlbIDAgXSA9PT0gInJpZ2h0IiA\/CgkJCQkJCWRhdGEuZWxlbVdpZHRoIDoKCQkJCQkJMCwKCQkJCWF0T2Zmc2V0ID0gZGF0YS5hdFsgMCBdID09PSAibGVmdCIgPwoJCQkJCWRhdGEudGFyZ2V0V2lkdGggOgoJCQkJCWRhdGEuYXRbIDAgXSA9PT0gInJpZ2h0IiA\/CgkJCQkJCS1kYXRhLnRhcmdldFdpZHRoIDoKCQkJCQkJMCwKCQkJCW9mZnNldCA9IC0yICogZGF0YS5vZmZzZXRbIDAgXSwKCQkJCW5ld092ZXJSaWdodCwKCQkJCW5ld092ZXJMZWZ0OwoKCQkJaWYgKCBvdmVyTGVmdCA8IDAgKSB7CgkJCQluZXdPdmVyUmlnaHQgPSBwb3NpdGlvbi5sZWZ0ICsgbXlPZmZzZXQgKyBhdE9mZnNldCArIG9mZnNldCArIGRhdGEuY29sbGlzaW9uV2lkdGggLQoJCQkJCW91dGVyV2lkdGggLSB3aXRoaW5PZmZzZXQ7CgkJCQlpZiAoIG5ld092ZXJSaWdodCA8IDAgfHwgbmV3T3ZlclJpZ2h0IDwgYWJzKCBvdmVyTGVmdCApICkgewoJCQkJCXBvc2l0aW9uLmxlZnQgKz0gbXlPZmZzZXQgKyBhdE9mZnNldCArIG9mZnNldDsKCQkJCX0KCQkJfSBlbHNlIGlmICggb3ZlclJpZ2h0ID4gMCApIHsKCQkJCW5ld092ZXJMZWZ0ID0gcG9zaXRpb24ubGVmdCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luTGVmdCArIG15T2Zmc2V0ICsKCQkJCQlhdE9mZnNldCArIG9mZnNldCAtIG9mZnNldExlZnQ7CgkJCQlpZiAoIG5ld092ZXJMZWZ0ID4gMCB8fCBhYnMoIG5ld092ZXJMZWZ0ICkgPCBvdmVyUmlnaHQgKSB7CgkJCQkJcG9zaXRpb24ubGVmdCArPSBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0OwoJCQkJfQoJCQl9CgkJfSwKCQl0b3A6IGZ1bmN0aW9uKCBwb3NpdGlvbiwgZGF0YSApIHsKCQkJdmFyIHdpdGhpbiA9IGRhdGEud2l0aGluLAoJCQkJd2l0aGluT2Zmc2V0ID0gd2l0aGluLm9mZnNldC50b3AgKyB3aXRoaW4uc2Nyb2xsVG9wLAoJCQkJb3V0ZXJIZWlnaHQgPSB3aXRoaW4uaGVpZ2h0LAoJCQkJb2Zmc2V0VG9wID0gd2l0aGluLmlzV2luZG93ID8gd2l0aGluLnNjcm9sbFRvcCA6IHdpdGhpbi5vZmZzZXQudG9wLAoJCQkJY29sbGlzaW9uUG9zVG9wID0gcG9zaXRpb24udG9wIC0gZGF0YS5jb2xsaXNpb25Qb3NpdGlvbi5tYXJnaW5Ub3AsCgkJCQlvdmVyVG9wID0gY29sbGlzaW9uUG9zVG9wIC0gb2Zmc2V0VG9wLAoJCQkJb3ZlckJvdHRvbSA9IGNvbGxpc2lvblBvc1RvcCArIGRhdGEuY29sbGlzaW9uSGVpZ2h0IC0gb3V0ZXJIZWlnaHQgLSBvZmZzZXRUb3AsCgkJCQl0b3AgPSBkYXRhLm15WyAxIF0gPT09ICJ0b3AiLAoJCQkJbXlPZmZzZXQgPSB0b3AgPwoJCQkJCS1kYXRhLmVsZW1IZWlnaHQgOgoJCQkJCWRhdGEubXlbIDEgXSA9PT0gImJvdHRvbSIgPwoJCQkJCQlkYXRhLmVsZW1IZWlnaHQgOgoJCQkJCQkwLAoJCQkJYXRPZmZzZXQgPSBkYXRhLmF0WyAxIF0gPT09ICJ0b3AiID8KCQkJCQlkYXRhLnRhcmdldEhlaWdodCA6CgkJCQkJZGF0YS5hdFsgMSBdID09PSAiYm90dG9tIiA\/CgkJCQkJCS1kYXRhLnRhcmdldEhlaWdodCA6CgkJCQkJCTAsCgkJCQlvZmZzZXQgPSAtMiAqIGRhdGEub2Zmc2V0WyAxIF0sCgkJCQluZXdPdmVyVG9wLAoJCQkJbmV3T3ZlckJvdHRvbTsKCQkJaWYgKCBvdmVyVG9wIDwgMCApIHsKCQkJCW5ld092ZXJCb3R0b20gPSBwb3NpdGlvbi50b3AgKyBteU9mZnNldCArIGF0T2Zmc2V0ICsgb2Zmc2V0ICsgZGF0YS5jb2xsaXNpb25IZWlnaHQgLQoJCQkJCW91dGVySGVpZ2h0IC0gd2l0aGluT2Zmc2V0OwoJCQkJaWYgKCBuZXdPdmVyQm90dG9tIDwgMCB8fCBuZXdPdmVyQm90dG9tIDwgYWJzKCBvdmVyVG9wICkgKSB7CgkJCQkJcG9zaXRpb24udG9wICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIG92ZXJCb3R0b20gPiAwICkgewoJCQkJbmV3T3ZlclRvcCA9IHBvc2l0aW9uLnRvcCAtIGRhdGEuY29sbGlzaW9uUG9zaXRpb24ubWFyZ2luVG9wICsgbXlPZmZzZXQgKyBhdE9mZnNldCArCgkJCQkJb2Zmc2V0IC0gb2Zmc2V0VG9wOwoJCQkJaWYgKCBuZXdPdmVyVG9wID4gMCB8fCBhYnMoIG5ld092ZXJUb3AgKSA8IG92ZXJCb3R0b20gKSB7CgkJCQkJcG9zaXRpb24udG9wICs9IG15T2Zmc2V0ICsgYXRPZmZzZXQgKyBvZmZzZXQ7CgkJCQl9CgkJCX0KCQl9Cgl9LAoJZmxpcGZpdDogewoJCWxlZnQ6IGZ1bmN0aW9uKCkgewoJCQkkLnVpLnBvc2l0aW9uLmZsaXAubGVmdC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCSQudWkucG9zaXRpb24uZml0LmxlZnQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX0sCgkJdG9wOiBmdW5jdGlvbigpIHsKCQkJJC51aS5wb3NpdGlvbi5mbGlwLnRvcC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCSQudWkucG9zaXRpb24uZml0LnRvcC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfQoJfQp9OwoKfSApKCk7Cgp2YXIgcG9zaXRpb24gPSAkLnVpLnBvc2l0aW9uOwoKCi8qIQogKiBqUXVlcnkgVUkgOmRhdGEgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiA6ZGF0YSBTZWxlY3RvcgovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBTZWxlY3RzIGVsZW1lbnRzIHdoaWNoIGhhdmUgZGF0YSBzdG9yZWQgdW5kZXIgdGhlIHNwZWNpZmllZCBrZXkuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9kYXRhLXNlbGVjdG9yLwoKCnZhciBkYXRhID0gJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oIGZ1bmN0aW9uKCBkYXRhTmFtZSApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBkYXRhTmFtZSApOwoJCQl9OwoJCX0gKSA6CgoJCS8vIFN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9Cn0gKTsKCi8qIQogKiBqUXVlcnkgVUkgRGlzYWJsZSBTZWxlY3Rpb24gMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBkaXNhYmxlU2VsZWN0aW9uCi8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IERpc2FibGUgc2VsZWN0aW9uIG9mIHRleHQgY29udGVudCB3aXRoaW4gdGhlIHNldCBvZiBtYXRjaGVkIGVsZW1lbnRzLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZGlzYWJsZVNlbGVjdGlvbi8KCi8vIFRoaXMgZmlsZSBpcyBkZXByZWNhdGVkCgoKdmFyIGRpc2FibGVTZWxlY3Rpb24gPSAkLmZuLmV4dGVuZCggewoJZGlzYWJsZVNlbGVjdGlvbjogKCBmdW5jdGlvbigpIHsKCQl2YXIgZXZlbnRUeXBlID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICkgPwoJCQkic2VsZWN0c3RhcnQiIDoKCQkJIm1vdXNlZG93biI7CgoJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMub24oIGV2ZW50VHlwZSArICIudWktZGlzYWJsZVNlbGVjdGlvbiIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0gKTsKCQl9OwoJfSApKCksCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5vZmYoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEVmZmVjdHMgQ29yZQovLz4+Z3JvdXA6IEVmZmVjdHMKLy8ganNjczpkaXNhYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8vPj5kZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgaW50ZXJuYWwgalF1ZXJ5IGVmZmVjdHMuIEluY2x1ZGVzIG1vcnBoaW5nIGFuZCBlYXNpbmcuIFJlcXVpcmVkIGJ5IGFsbCBvdGhlciBlZmZlY3RzLgovLyBqc2NzOmVuYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY2F0ZWdvcnkvZWZmZWN0cy1jb3JlLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZGF0YVNwYWNlID0gInVpLWVmZmVjdHMtIiwKCWRhdGFTcGFjZVN0eWxlID0gInVpLWVmZmVjdHMtc3R5bGUiLAoJZGF0YVNwYWNlQW5pbWF0ZWQgPSAidWktZWZmZWN0cy1hbmltYXRlZCIsCgoJLy8gQ3JlYXRlIGEgbG9jYWwgalF1ZXJ5IGJlY2F1c2UgalF1ZXJ5IENvbG9yIHJlbGllcyBvbiBpdCBhbmQgdGhlCgkvLyBnbG9iYWwgbWF5IG5vdCBleGlzdCB3aXRoIEFNRCBhbmQgYSBjdXN0b20gYnVpbGQgKCMxMDE5OSkKCWpRdWVyeSA9ICQ7CgokLmVmZmVjdHMgPSB7CgllZmZlY3Q6IHt9Cn07CgovKiEKICogalF1ZXJ5IENvbG9yIEFuaW1hdGlvbnMgdjIuMS4yCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LWNvbG9yCiAqCiAqIENvcHlyaWdodCAyMDE0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIERhdGU6IFdlZCBKYW4gMTYgMDg6NDc6MDkgMjAxMyAtMDYwMAogKi8KKCBmdW5jdGlvbiggalF1ZXJ5LCB1bmRlZmluZWQgKSB7CgoJdmFyIHN0ZXBIb29rcyA9ICJiYWNrZ3JvdW5kQ29sb3IgYm9yZGVyQm90dG9tQ29sb3IgYm9yZGVyTGVmdENvbG9yIGJvcmRlclJpZ2h0Q29sb3IgIiArCgkJImJvcmRlclRvcENvbG9yIGNvbG9yIGNvbHVtblJ1bGVDb2xvciBvdXRsaW5lQ29sb3IgdGV4dERlY29yYXRpb25Db2xvciB0ZXh0RW1waGFzaXNDb2xvciIsCgoJLy8gUGx1c2VxdWFscyB0ZXN0IGZvciArPSAxMDAgLT0gMTAwCglycGx1c2VxdWFscyA9IC9eKFtcLStdKT1ccyooXGQrXC4\/XGQqKS8sCgoJLy8gQSBzZXQgb2YgUkUncyB0aGF0IGNhbiBtYXRjaCBzdHJpbmdzIGFuZCBnZW5lcmF0ZSBjb2xvciB0dXBsZXMuCglzdHJpbmdQYXJzZXJzID0gWyB7CgkJCXJlOiAvcmdiYT9cKFxzKihcZHsxLDN9KVxzKixccyooXGR7MSwzfSlccyosXHMqKFxkezEsM30pXHMqKD86LFxzKihcZD8oPzpcLlxkKyk\/KVxzKik\/XCkvLAoJCQlwYXJzZTogZnVuY3Rpb24oIGV4ZWNSZXN1bHQgKSB7CgkJCQlyZXR1cm4gWwoJCQkJCWV4ZWNSZXN1bHRbIDEgXSwKCQkJCQlleGVjUmVzdWx0WyAyIF0sCgkJCQkJZXhlY1Jlc3VsdFsgMyBdLAoJCQkJCWV4ZWNSZXN1bHRbIDQgXQoJCQkJXTsKCQkJfQoJCX0sIHsKCQkJcmU6IC9yZ2JhP1woXHMqKFxkKyg\/OlwuXGQrKT8pXCVccyosXHMqKFxkKyg\/OlwuXGQrKT8pXCVccyosXHMqKFxkKyg\/OlwuXGQrKT8pXCVccyooPzosXHMqKFxkPyg\/OlwuXGQrKT8pXHMqKT9cKS8sCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsKCQkJCXJldHVybiBbCgkJCQkJZXhlY1Jlc3VsdFsgMSBdICogMi41NSwKCQkJCQlleGVjUmVzdWx0WyAyIF0gKiAyLjU1LAoJCQkJCWV4ZWNSZXN1bHRbIDMgXSAqIDIuNTUsCgkJCQkJZXhlY1Jlc3VsdFsgNCBdCgkJCQldOwoJCQl9CgkJfSwgewoKCQkJLy8gVGhpcyByZWdleCBpZ25vcmVzIEEtRiBiZWNhdXNlIGl0J3MgY29tcGFyZWQgYWdhaW5zdCBhbiBhbHJlYWR5IGxvd2VyY2FzZWQgc3RyaW5nCgkJCXJlOiAvIyhbYS1mMC05XXsyfSkoW2EtZjAtOV17Mn0pKFthLWYwLTldezJ9KS8sCgkJCXBhcnNlOiBmdW5jdGlvbiggZXhlY1Jlc3VsdCApIHsKCQkJCXJldHVybiBbCgkJCQkJcGFyc2VJbnQoIGV4ZWNSZXN1bHRbIDEgXSwgMTYgKSwKCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMiBdLCAxNiApLAoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAzIF0sIDE2ICkKCQkJCV07CgkJCX0KCQl9LCB7CgoJCQkvLyBUaGlzIHJlZ2V4IGlnbm9yZXMgQS1GIGJlY2F1c2UgaXQncyBjb21wYXJlZCBhZ2FpbnN0IGFuIGFscmVhZHkgbG93ZXJjYXNlZCBzdHJpbmcKCQkJcmU6IC8jKFthLWYwLTldKShbYS1mMC05XSkoW2EtZjAtOV0pLywKCQkJcGFyc2U6IGZ1bmN0aW9uKCBleGVjUmVzdWx0ICkgewoJCQkJcmV0dXJuIFsKCQkJCQlwYXJzZUludCggZXhlY1Jlc3VsdFsgMSBdICsgZXhlY1Jlc3VsdFsgMSBdLCAxNiApLAoJCQkJCXBhcnNlSW50KCBleGVjUmVzdWx0WyAyIF0gKyBleGVjUmVzdWx0WyAyIF0sIDE2ICksCgkJCQkJcGFyc2VJbnQoIGV4ZWNSZXN1bHRbIDMgXSArIGV4ZWNSZXN1bHRbIDMgXSwgMTYgKQoJCQkJXTsKCQkJfQoJCX0sIHsKCQkJcmU6IC9oc2xhP1woXHMqKFxkKyg\/OlwuXGQrKT8pXHMqLFxzKihcZCsoPzpcLlxkKyk\/KVwlXHMqLFxzKihcZCsoPzpcLlxkKyk\/KVwlXHMqKD86LFxzKihcZD8oPzpcLlxkKyk\/KVxzKik\/XCkvLAoJCQlzcGFjZTogImhzbGEiLAoJCQlwYXJzZTogZnVuY3Rpb24oIGV4ZWNSZXN1bHQgKSB7CgkJCQlyZXR1cm4gWwoJCQkJCWV4ZWNSZXN1bHRbIDEgXSwKCQkJCQlleGVjUmVzdWx0WyAyIF0gLyAxMDAsCgkJCQkJZXhlY1Jlc3VsdFsgMyBdIC8gMTAwLAoJCQkJCWV4ZWNSZXN1bHRbIDQgXQoJCQkJXTsKCQkJfQoJCX0gXSwKCgkvLyBKUXVlcnkuQ29sb3IoICkKCWNvbG9yID0galF1ZXJ5LkNvbG9yID0gZnVuY3Rpb24oIGNvbG9yLCBncmVlbiwgYmx1ZSwgYWxwaGEgKSB7CgkJcmV0dXJuIG5ldyBqUXVlcnkuQ29sb3IuZm4ucGFyc2UoIGNvbG9yLCBncmVlbiwgYmx1ZSwgYWxwaGEgKTsKCX0sCglzcGFjZXMgPSB7CgkJcmdiYTogewoJCQlwcm9wczogewoJCQkJcmVkOiB7CgkJCQkJaWR4OiAwLAoJCQkJCXR5cGU6ICJieXRlIgoJCQkJfSwKCQkJCWdyZWVuOiB7CgkJCQkJaWR4OiAxLAoJCQkJCXR5cGU6ICJieXRlIgoJCQkJfSwKCQkJCWJsdWU6IHsKCQkJCQlpZHg6IDIsCgkJCQkJdHlwZTogImJ5dGUiCgkJCQl9CgkJCX0KCQl9LAoKCQloc2xhOiB7CgkJCXByb3BzOiB7CgkJCQlodWU6IHsKCQkJCQlpZHg6IDAsCgkJCQkJdHlwZTogImRlZ3JlZXMiCgkJCQl9LAoJCQkJc2F0dXJhdGlvbjogewoJCQkJCWlkeDogMSwKCQkJCQl0eXBlOiAicGVyY2VudCIKCQkJCX0sCgkJCQlsaWdodG5lc3M6IHsKCQkJCQlpZHg6IDIsCgkJCQkJdHlwZTogInBlcmNlbnQiCgkJCQl9CgkJCX0KCQl9Cgl9LAoJcHJvcFR5cGVzID0gewoJCSJieXRlIjogewoJCQlmbG9vcjogdHJ1ZSwKCQkJbWF4OiAyNTUKCQl9LAoJCSJwZXJjZW50IjogewoJCQltYXg6IDEKCQl9LAoJCSJkZWdyZWVzIjogewoJCQltb2Q6IDM2MCwKCQkJZmxvb3I6IHRydWUKCQl9Cgl9LAoJc3VwcG9ydCA9IGNvbG9yLnN1cHBvcnQgPSB7fSwKCgkvLyBFbGVtZW50IGZvciBzdXBwb3J0IHRlc3RzCglzdXBwb3J0RWxlbSA9IGpRdWVyeSggIjxwPiIgKVsgMCBdLAoKCS8vIENvbG9ycyA9IGpRdWVyeS5Db2xvci5uYW1lcwoJY29sb3JzLAoKCS8vIExvY2FsIGFsaWFzZXMgb2YgZnVuY3Rpb25zIGNhbGxlZCBvZnRlbgoJZWFjaCA9IGpRdWVyeS5lYWNoOwoKLy8gRGV0ZXJtaW5lIHJnYmEgc3VwcG9ydCBpbW1lZGlhdGVseQpzdXBwb3J0RWxlbS5zdHlsZS5jc3NUZXh0ID0gImJhY2tncm91bmQtY29sb3I6cmdiYSgxLDEsMSwuNSkiOwpzdXBwb3J0LnJnYmEgPSBzdXBwb3J0RWxlbS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IuaW5kZXhPZiggInJnYmEiICkgPiAtMTsKCi8vIERlZmluZSBjYWNoZSBuYW1lIGFuZCBhbHBoYSBwcm9wZXJ0aWVzCi8vIGZvciByZ2JhIGFuZCBoc2xhIHNwYWNlcwplYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgewoJc3BhY2UuY2FjaGUgPSAiXyIgKyBzcGFjZU5hbWU7CglzcGFjZS5wcm9wcy5hbHBoYSA9IHsKCQlpZHg6IDMsCgkJdHlwZTogInBlcmNlbnQiLAoJCWRlZjogMQoJfTsKfSApOwoKZnVuY3Rpb24gY2xhbXAoIHZhbHVlLCBwcm9wLCBhbGxvd0VtcHR5ICkgewoJdmFyIHR5cGUgPSBwcm9wVHlwZXNbIHByb3AudHlwZSBdIHx8IHt9OwoKCWlmICggdmFsdWUgPT0gbnVsbCApIHsKCQlyZXR1cm4gKCBhbGxvd0VtcHR5IHx8ICFwcm9wLmRlZiApID8gbnVsbCA6IHByb3AuZGVmOwoJfQoKCS8vIH5+IGlzIGFuIHNob3J0IHdheSBvZiBkb2luZyBmbG9vciBmb3IgcG9zaXRpdmUgbnVtYmVycwoJdmFsdWUgPSB0eXBlLmZsb29yID8gfn52YWx1ZSA6IHBhcnNlRmxvYXQoIHZhbHVlICk7CgoJLy8gSUUgd2lsbCBwYXNzIGluIGVtcHR5IHN0cmluZ3MgYXMgdmFsdWUgZm9yIGFscGhhLAoJLy8gd2hpY2ggd2lsbCBoaXQgdGhpcyBjYXNlCglpZiAoIGlzTmFOKCB2YWx1ZSApICkgewoJCXJldHVybiBwcm9wLmRlZjsKCX0KCglpZiAoIHR5cGUubW9kICkgewoKCQkvLyBXZSBhZGQgbW9kIGJlZm9yZSBtb2RkaW5nIHRvIG1ha2Ugc3VyZSB0aGF0IG5lZ2F0aXZlcyB2YWx1ZXMKCQkvLyBnZXQgY29udmVydGVkIHByb3Blcmx5OiAtMTAgLT4gMzUwCgkJcmV0dXJuICggdmFsdWUgKyB0eXBlLm1vZCApICUgdHlwZS5tb2Q7Cgl9CgoJLy8gRm9yIG5vdyBhbGwgcHJvcGVydHkgdHlwZXMgd2l0aG91dCBtb2QgaGF2ZSBtaW4gYW5kIG1heAoJcmV0dXJuIDAgPiB2YWx1ZSA\/IDAgOiB0eXBlLm1heCA8IHZhbHVlID8gdHlwZS5tYXggOiB2YWx1ZTsKfQoKZnVuY3Rpb24gc3RyaW5nUGFyc2UoIHN0cmluZyApIHsKCXZhciBpbnN0ID0gY29sb3IoKSwKCQlyZ2JhID0gaW5zdC5fcmdiYSA9IFtdOwoKCXN0cmluZyA9IHN0cmluZy50b0xvd2VyQ2FzZSgpOwoKCWVhY2goIHN0cmluZ1BhcnNlcnMsIGZ1bmN0aW9uKCBpLCBwYXJzZXIgKSB7CgkJdmFyIHBhcnNlZCwKCQkJbWF0Y2ggPSBwYXJzZXIucmUuZXhlYyggc3RyaW5nICksCgkJCXZhbHVlcyA9IG1hdGNoICYmIHBhcnNlci5wYXJzZSggbWF0Y2ggKSwKCQkJc3BhY2VOYW1lID0gcGFyc2VyLnNwYWNlIHx8ICJyZ2JhIjsKCgkJaWYgKCB2YWx1ZXMgKSB7CgkJCXBhcnNlZCA9IGluc3RbIHNwYWNlTmFtZSBdKCB2YWx1ZXMgKTsKCgkJCS8vIElmIHRoaXMgd2FzIGFuIHJnYmEgcGFyc2UgdGhlIGFzc2lnbm1lbnQgbWlnaHQgaGFwcGVuIHR3aWNlCgkJCS8vIG9oIHdlbGwuLi4uCgkJCWluc3RbIHNwYWNlc1sgc3BhY2VOYW1lIF0uY2FjaGUgXSA9IHBhcnNlZFsgc3BhY2VzWyBzcGFjZU5hbWUgXS5jYWNoZSBdOwoJCQlyZ2JhID0gaW5zdC5fcmdiYSA9IHBhcnNlZC5fcmdiYTsKCgkJCS8vIEV4aXQgZWFjaCggc3RyaW5nUGFyc2VycyApIGhlcmUgYmVjYXVzZSB3ZSBtYXRjaGVkCgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9ICk7CgoJLy8gRm91bmQgYSBzdHJpbmdQYXJzZXIgdGhhdCBoYW5kbGVkIGl0CglpZiAoIHJnYmEubGVuZ3RoICkgewoKCQkvLyBJZiB0aGlzIGNhbWUgZnJvbSBhIHBhcnNlZCBzdHJpbmcsIGZvcmNlICJ0cmFuc3BhcmVudCIgd2hlbiBhbHBoYSBpcyAwCgkJLy8gY2hyb21lLCAoYW5kIG1heWJlIG90aGVycykgcmV0dXJuICJ0cmFuc3BhcmVudCIgYXMgcmdiYSgwLDAsMCwwKQoJCWlmICggcmdiYS5qb2luKCkgPT09ICIwLDAsMCwwIiApIHsKCQkJalF1ZXJ5LmV4dGVuZCggcmdiYSwgY29sb3JzLnRyYW5zcGFyZW50ICk7CgkJfQoJCXJldHVybiBpbnN0OwoJfQoKCS8vIE5hbWVkIGNvbG9ycwoJcmV0dXJuIGNvbG9yc1sgc3RyaW5nIF07Cn0KCmNvbG9yLmZuID0galF1ZXJ5LmV4dGVuZCggY29sb3IucHJvdG90eXBlLCB7CglwYXJzZTogZnVuY3Rpb24oIHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhICkgewoJCWlmICggcmVkID09PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3JnYmEgPSBbIG51bGwsIG51bGwsIG51bGwsIG51bGwgXTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggcmVkLmpxdWVyeSB8fCByZWQubm9kZVR5cGUgKSB7CgkJCXJlZCA9IGpRdWVyeSggcmVkICkuY3NzKCBncmVlbiApOwoJCQlncmVlbiA9IHVuZGVmaW5lZDsKCQl9CgoJCXZhciBpbnN0ID0gdGhpcywKCQkJdHlwZSA9IGpRdWVyeS50eXBlKCByZWQgKSwKCQkJcmdiYSA9IHRoaXMuX3JnYmEgPSBbXTsKCgkJLy8gTW9yZSB0aGFuIDEgYXJndW1lbnQgc3BlY2lmaWVkIC0gYXNzdW1lICggcmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEgKQoJCWlmICggZ3JlZW4gIT09IHVuZGVmaW5lZCApIHsKCQkJcmVkID0gWyByZWQsIGdyZWVuLCBibHVlLCBhbHBoYSBdOwoJCQl0eXBlID0gImFycmF5IjsKCQl9CgoJCWlmICggdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCXJldHVybiB0aGlzLnBhcnNlKCBzdHJpbmdQYXJzZSggcmVkICkgfHwgY29sb3JzLl9kZWZhdWx0ICk7CgkJfQoKCQlpZiAoIHR5cGUgPT09ICJhcnJheSIgKSB7CgkJCWVhY2goIHNwYWNlcy5yZ2JhLnByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgewoJCQkJcmdiYVsgcHJvcC5pZHggXSA9IGNsYW1wKCByZWRbIHByb3AuaWR4IF0sIHByb3AgKTsKCQkJfSApOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICggdHlwZSA9PT0gIm9iamVjdCIgKSB7CgkJCWlmICggcmVkIGluc3RhbmNlb2YgY29sb3IgKSB7CgkJCQllYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgewoJCQkJCWlmICggcmVkWyBzcGFjZS5jYWNoZSBdICkgewoJCQkJCQlpbnN0WyBzcGFjZS5jYWNoZSBdID0gcmVkWyBzcGFjZS5jYWNoZSBdLnNsaWNlKCk7CgkJCQkJfQoJCQkJfSApOwoJCQl9IGVsc2UgewoJCQkJZWFjaCggc3BhY2VzLCBmdW5jdGlvbiggc3BhY2VOYW1lLCBzcGFjZSApIHsKCQkJCQl2YXIgY2FjaGUgPSBzcGFjZS5jYWNoZTsKCQkJCQllYWNoKCBzcGFjZS5wcm9wcywgZnVuY3Rpb24oIGtleSwgcHJvcCApIHsKCgkJCQkJCS8vIElmIHRoZSBjYWNoZSBkb2Vzbid0IGV4aXN0LCBhbmQgd2Uga25vdyBob3cgdG8gY29udmVydAoJCQkJCQlpZiAoICFpbnN0WyBjYWNoZSBdICYmIHNwYWNlLnRvICkgewoKCQkJCQkJCS8vIElmIHRoZSB2YWx1ZSB3YXMgbnVsbCwgd2UgZG9uJ3QgbmVlZCB0byBjb3B5IGl0CgkJCQkJCQkvLyBpZiB0aGUga2V5IHdhcyBhbHBoYSwgd2UgZG9uJ3QgbmVlZCB0byBjb3B5IGl0IGVpdGhlcgoJCQkJCQkJaWYgKCBrZXkgPT09ICJhbHBoYSIgfHwgcmVkWyBrZXkgXSA9PSBudWxsICkgewoJCQkJCQkJCXJldHVybjsKCQkJCQkJCX0KCQkJCQkJCWluc3RbIGNhY2hlIF0gPSBzcGFjZS50byggaW5zdC5fcmdiYSApOwoJCQkJCQl9CgoJCQkJCQkvLyBUaGlzIGlzIHRoZSBvbmx5IGNhc2Ugd2hlcmUgd2UgYWxsb3cgbnVsbHMgZm9yIEFMTCBwcm9wZXJ0aWVzLgoJCQkJCQkvLyBjYWxsIGNsYW1wIHdpdGggYWx3YXlzQWxsb3dFbXB0eQoJCQkJCQlpbnN0WyBjYWNoZSBdWyBwcm9wLmlkeCBdID0gY2xhbXAoIHJlZFsga2V5IF0sIHByb3AsIHRydWUgKTsKCQkJCQl9ICk7CgoJCQkJCS8vIEV2ZXJ5dGhpbmcgZGVmaW5lZCBidXQgYWxwaGE\/CgkJCQkJaWYgKCBpbnN0WyBjYWNoZSBdICYmCgkJCQkJCQlqUXVlcnkuaW5BcnJheSggbnVsbCwgaW5zdFsgY2FjaGUgXS5zbGljZSggMCwgMyApICkgPCAwICkgewoKCQkJCQkJLy8gVXNlIHRoZSBkZWZhdWx0IG9mIDEKCQkJCQkJaW5zdFsgY2FjaGUgXVsgMyBdID0gMTsKCQkJCQkJaWYgKCBzcGFjZS5mcm9tICkgewoJCQkJCQkJaW5zdC5fcmdiYSA9IHNwYWNlLmZyb20oIGluc3RbIGNhY2hlIF0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCQlyZXR1cm4gdGhpczsKCQl9Cgl9LAoJaXM6IGZ1bmN0aW9uKCBjb21wYXJlICkgewoJCXZhciBpcyA9IGNvbG9yKCBjb21wYXJlICksCgkJCXNhbWUgPSB0cnVlLAoJCQlpbnN0ID0gdGhpczsKCgkJZWFjaCggc3BhY2VzLCBmdW5jdGlvbiggXywgc3BhY2UgKSB7CgkJCXZhciBsb2NhbENhY2hlLAoJCQkJaXNDYWNoZSA9IGlzWyBzcGFjZS5jYWNoZSBdOwoJCQlpZiAoIGlzQ2FjaGUgKSB7CgkJCQlsb2NhbENhY2hlID0gaW5zdFsgc3BhY2UuY2FjaGUgXSB8fCBzcGFjZS50byAmJiBzcGFjZS50byggaW5zdC5fcmdiYSApIHx8IFtdOwoJCQkJZWFjaCggc3BhY2UucHJvcHMsIGZ1bmN0aW9uKCBfLCBwcm9wICkgewoJCQkJCWlmICggaXNDYWNoZVsgcHJvcC5pZHggXSAhPSBudWxsICkgewoJCQkJCQlzYW1lID0gKCBpc0NhY2hlWyBwcm9wLmlkeCBdID09PSBsb2NhbENhY2hlWyBwcm9wLmlkeCBdICk7CgkJCQkJCXJldHVybiBzYW1lOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCQlyZXR1cm4gc2FtZTsKCQl9ICk7CgkJcmV0dXJuIHNhbWU7Cgl9LAoJX3NwYWNlOiBmdW5jdGlvbigpIHsKCQl2YXIgdXNlZCA9IFtdLAoJCQlpbnN0ID0gdGhpczsKCQllYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgewoJCQlpZiAoIGluc3RbIHNwYWNlLmNhY2hlIF0gKSB7CgkJCQl1c2VkLnB1c2goIHNwYWNlTmFtZSApOwoJCQl9CgkJfSApOwoJCXJldHVybiB1c2VkLnBvcCgpOwoJfSwKCXRyYW5zaXRpb246IGZ1bmN0aW9uKCBvdGhlciwgZGlzdGFuY2UgKSB7CgkJdmFyIGVuZCA9IGNvbG9yKCBvdGhlciApLAoJCQlzcGFjZU5hbWUgPSBlbmQuX3NwYWNlKCksCgkJCXNwYWNlID0gc3BhY2VzWyBzcGFjZU5hbWUgXSwKCQkJc3RhcnRDb2xvciA9IHRoaXMuYWxwaGEoKSA9PT0gMCA\/IGNvbG9yKCAidHJhbnNwYXJlbnQiICkgOiB0aGlzLAoJCQlzdGFydCA9IHN0YXJ0Q29sb3JbIHNwYWNlLmNhY2hlIF0gfHwgc3BhY2UudG8oIHN0YXJ0Q29sb3IuX3JnYmEgKSwKCQkJcmVzdWx0ID0gc3RhcnQuc2xpY2UoKTsKCgkJZW5kID0gZW5kWyBzcGFjZS5jYWNoZSBdOwoJCWVhY2goIHNwYWNlLnByb3BzLCBmdW5jdGlvbigga2V5LCBwcm9wICkgewoJCQl2YXIgaW5kZXggPSBwcm9wLmlkeCwKCQkJCXN0YXJ0VmFsdWUgPSBzdGFydFsgaW5kZXggXSwKCQkJCWVuZFZhbHVlID0gZW5kWyBpbmRleCBdLAoJCQkJdHlwZSA9IHByb3BUeXBlc1sgcHJvcC50eXBlIF0gfHwge307CgoJCQkvLyBJZiBudWxsLCBkb24ndCBvdmVycmlkZSBzdGFydCB2YWx1ZQoJCQlpZiAoIGVuZFZhbHVlID09PSBudWxsICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBudWxsIC0gdXNlIGVuZAoJCQlpZiAoIHN0YXJ0VmFsdWUgPT09IG51bGwgKSB7CgkJCQlyZXN1bHRbIGluZGV4IF0gPSBlbmRWYWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdHlwZS5tb2QgKSB7CgkJCQkJaWYgKCBlbmRWYWx1ZSAtIHN0YXJ0VmFsdWUgPiB0eXBlLm1vZCAvIDIgKSB7CgkJCQkJCXN0YXJ0VmFsdWUgKz0gdHlwZS5tb2Q7CgkJCQkJfSBlbHNlIGlmICggc3RhcnRWYWx1ZSAtIGVuZFZhbHVlID4gdHlwZS5tb2QgLyAyICkgewoJCQkJCQlzdGFydFZhbHVlIC09IHR5cGUubW9kOwoJCQkJCX0KCQkJCX0KCQkJCXJlc3VsdFsgaW5kZXggXSA9IGNsYW1wKCAoIGVuZFZhbHVlIC0gc3RhcnRWYWx1ZSApICogZGlzdGFuY2UgKyBzdGFydFZhbHVlLCBwcm9wICk7CgkJCX0KCQl9ICk7CgkJcmV0dXJuIHRoaXNbIHNwYWNlTmFtZSBdKCByZXN1bHQgKTsKCX0sCglibGVuZDogZnVuY3Rpb24oIG9wYXF1ZSApIHsKCgkJLy8gSWYgd2UgYXJlIGFscmVhZHkgb3BhcXVlIC0gcmV0dXJuIG91cnNlbGYKCQlpZiAoIHRoaXMuX3JnYmFbIDMgXSA9PT0gMSApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl2YXIgcmdiID0gdGhpcy5fcmdiYS5zbGljZSgpLAoJCQlhID0gcmdiLnBvcCgpLAoJCQlibGVuZCA9IGNvbG9yKCBvcGFxdWUgKS5fcmdiYTsKCgkJcmV0dXJuIGNvbG9yKCBqUXVlcnkubWFwKCByZ2IsIGZ1bmN0aW9uKCB2LCBpICkgewoJCQlyZXR1cm4gKCAxIC0gYSApICogYmxlbmRbIGkgXSArIGEgKiB2OwoJCX0gKSApOwoJfSwKCXRvUmdiYVN0cmluZzogZnVuY3Rpb24oKSB7CgkJdmFyIHByZWZpeCA9ICJyZ2JhKCIsCgkJCXJnYmEgPSBqUXVlcnkubWFwKCB0aGlzLl9yZ2JhLCBmdW5jdGlvbiggdiwgaSApIHsKCQkJCXJldHVybiB2ID09IG51bGwgPyAoIGkgPiAyID8gMSA6IDAgKSA6IHY7CgkJCX0gKTsKCgkJaWYgKCByZ2JhWyAzIF0gPT09IDEgKSB7CgkJCXJnYmEucG9wKCk7CgkJCXByZWZpeCA9ICJyZ2IoIjsKCQl9CgoJCXJldHVybiBwcmVmaXggKyByZ2JhLmpvaW4oKSArICIpIjsKCX0sCgl0b0hzbGFTdHJpbmc6IGZ1bmN0aW9uKCkgewoJCXZhciBwcmVmaXggPSAiaHNsYSgiLAoJCQloc2xhID0galF1ZXJ5Lm1hcCggdGhpcy5oc2xhKCksIGZ1bmN0aW9uKCB2LCBpICkgewoJCQkJaWYgKCB2ID09IG51bGwgKSB7CgkJCQkJdiA9IGkgPiAyID8gMSA6IDA7CgkJCQl9CgoJCQkJLy8gQ2F0Y2ggMSBhbmQgMgoJCQkJaWYgKCBpICYmIGkgPCAzICkgewoJCQkJCXYgPSBNYXRoLnJvdW5kKCB2ICogMTAwICkgKyAiJSI7CgkJCQl9CgkJCQlyZXR1cm4gdjsKCQkJfSApOwoKCQlpZiAoIGhzbGFbIDMgXSA9PT0gMSApIHsKCQkJaHNsYS5wb3AoKTsKCQkJcHJlZml4ID0gImhzbCgiOwoJCX0KCQlyZXR1cm4gcHJlZml4ICsgaHNsYS5qb2luKCkgKyAiKSI7Cgl9LAoJdG9IZXhTdHJpbmc6IGZ1bmN0aW9uKCBpbmNsdWRlQWxwaGEgKSB7CgkJdmFyIHJnYmEgPSB0aGlzLl9yZ2JhLnNsaWNlKCksCgkJCWFscGhhID0gcmdiYS5wb3AoKTsKCgkJaWYgKCBpbmNsdWRlQWxwaGEgKSB7CgkJCXJnYmEucHVzaCggfn4oIGFscGhhICogMjU1ICkgKTsKCQl9CgoJCXJldHVybiAiIyIgKyBqUXVlcnkubWFwKCByZ2JhLCBmdW5jdGlvbiggdiApIHsKCgkJCS8vIERlZmF1bHQgdG8gMCB3aGVuIG51bGxzIGV4aXN0CgkJCXYgPSAoIHYgfHwgMCApLnRvU3RyaW5nKCAxNiApOwoJCQlyZXR1cm4gdi5sZW5ndGggPT09IDEgPyAiMCIgKyB2IDogdjsKCQl9ICkuam9pbiggIiIgKTsKCX0sCgl0b1N0cmluZzogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3JnYmFbIDMgXSA9PT0gMCA\/ICJ0cmFuc3BhcmVudCIgOiB0aGlzLnRvUmdiYVN0cmluZygpOwoJfQp9ICk7CmNvbG9yLmZuLnBhcnNlLnByb3RvdHlwZSA9IGNvbG9yLmZuOwoKLy8gSHNsYSBjb252ZXJzaW9ucyBhZGFwdGVkIGZyb206Ci8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvbWFhc2hhYWNrL3NvdXJjZS9icm93c2UvcGFja2FnZXMvZ3JhcGhpY3MvdHJ1bmsvc3JjL2dyYXBoaWNzL2NvbG9ycy9IVUUyUkdCLmFzP3I9NTAyMQoKZnVuY3Rpb24gaHVlMnJnYiggcCwgcSwgaCApIHsKCWggPSAoIGggKyAxICkgJSAxOwoJaWYgKCBoICogNiA8IDEgKSB7CgkJcmV0dXJuIHAgKyAoIHEgLSBwICkgKiBoICogNjsKCX0KCWlmICggaCAqIDIgPCAxICkgewoJCXJldHVybiBxOwoJfQoJaWYgKCBoICogMyA8IDIgKSB7CgkJcmV0dXJuIHAgKyAoIHEgLSBwICkgKiAoICggMiAvIDMgKSAtIGggKSAqIDY7Cgl9CglyZXR1cm4gcDsKfQoKc3BhY2VzLmhzbGEudG8gPSBmdW5jdGlvbiggcmdiYSApIHsKCWlmICggcmdiYVsgMCBdID09IG51bGwgfHwgcmdiYVsgMSBdID09IG51bGwgfHwgcmdiYVsgMiBdID09IG51bGwgKSB7CgkJcmV0dXJuIFsgbnVsbCwgbnVsbCwgbnVsbCwgcmdiYVsgMyBdIF07Cgl9Cgl2YXIgciA9IHJnYmFbIDAgXSAvIDI1NSwKCQlnID0gcmdiYVsgMSBdIC8gMjU1LAoJCWIgPSByZ2JhWyAyIF0gLyAyNTUsCgkJYSA9IHJnYmFbIDMgXSwKCQltYXggPSBNYXRoLm1heCggciwgZywgYiApLAoJCW1pbiA9IE1hdGgubWluKCByLCBnLCBiICksCgkJZGlmZiA9IG1heCAtIG1pbiwKCQlhZGQgPSBtYXggKyBtaW4sCgkJbCA9IGFkZCAqIDAuNSwKCQloLCBzOwoKCWlmICggbWluID09PSBtYXggKSB7CgkJaCA9IDA7Cgl9IGVsc2UgaWYgKCByID09PSBtYXggKSB7CgkJaCA9ICggNjAgKiAoIGcgLSBiICkgLyBkaWZmICkgKyAzNjA7Cgl9IGVsc2UgaWYgKCBnID09PSBtYXggKSB7CgkJaCA9ICggNjAgKiAoIGIgLSByICkgLyBkaWZmICkgKyAxMjA7Cgl9IGVsc2UgewoJCWggPSAoIDYwICogKCByIC0gZyApIC8gZGlmZiApICsgMjQwOwoJfQoKCS8vIENocm9tYSAoZGlmZikgPT0gMCBtZWFucyBncmV5c2NhbGUgd2hpY2gsIGJ5IGRlZmluaXRpb24sIHNhdHVyYXRpb24gPSAwJQoJLy8gb3RoZXJ3aXNlLCBzYXR1cmF0aW9uIGlzIGJhc2VkIG9uIHRoZSByYXRpbyBvZiBjaHJvbWEgKGRpZmYpIHRvIGxpZ2h0bmVzcyAoYWRkKQoJaWYgKCBkaWZmID09PSAwICkgewoJCXMgPSAwOwoJfSBlbHNlIGlmICggbCA8PSAwLjUgKSB7CgkJcyA9IGRpZmYgLyBhZGQ7Cgl9IGVsc2UgewoJCXMgPSBkaWZmIC8gKCAyIC0gYWRkICk7Cgl9CglyZXR1cm4gWyBNYXRoLnJvdW5kKCBoICkgJSAzNjAsIHMsIGwsIGEgPT0gbnVsbCA\/IDEgOiBhIF07Cn07CgpzcGFjZXMuaHNsYS5mcm9tID0gZnVuY3Rpb24oIGhzbGEgKSB7CglpZiAoIGhzbGFbIDAgXSA9PSBudWxsIHx8IGhzbGFbIDEgXSA9PSBudWxsIHx8IGhzbGFbIDIgXSA9PSBudWxsICkgewoJCXJldHVybiBbIG51bGwsIG51bGwsIG51bGwsIGhzbGFbIDMgXSBdOwoJfQoJdmFyIGggPSBoc2xhWyAwIF0gLyAzNjAsCgkJcyA9IGhzbGFbIDEgXSwKCQlsID0gaHNsYVsgMiBdLAoJCWEgPSBoc2xhWyAzIF0sCgkJcSA9IGwgPD0gMC41ID8gbCAqICggMSArIHMgKSA6IGwgKyBzIC0gbCAqIHMsCgkJcCA9IDIgKiBsIC0gcTsKCglyZXR1cm4gWwoJCU1hdGgucm91bmQoIGh1ZTJyZ2IoIHAsIHEsIGggKyAoIDEgLyAzICkgKSAqIDI1NSApLAoJCU1hdGgucm91bmQoIGh1ZTJyZ2IoIHAsIHEsIGggKSAqIDI1NSApLAoJCU1hdGgucm91bmQoIGh1ZTJyZ2IoIHAsIHEsIGggLSAoIDEgLyAzICkgKSAqIDI1NSApLAoJCWEKCV07Cn07CgplYWNoKCBzcGFjZXMsIGZ1bmN0aW9uKCBzcGFjZU5hbWUsIHNwYWNlICkgewoJdmFyIHByb3BzID0gc3BhY2UucHJvcHMsCgkJY2FjaGUgPSBzcGFjZS5jYWNoZSwKCQl0byA9IHNwYWNlLnRvLAoJCWZyb20gPSBzcGFjZS5mcm9tOwoKCS8vIE1ha2VzIHJnYmEoKSBhbmQgaHNsYSgpCgljb2xvci5mblsgc3BhY2VOYW1lIF0gPSBmdW5jdGlvbiggdmFsdWUgKSB7CgoJCS8vIEdlbmVyYXRlIGEgY2FjaGUgZm9yIHRoaXMgc3BhY2UgaWYgaXQgZG9lc24ndCBleGlzdAoJCWlmICggdG8gJiYgIXRoaXNbIGNhY2hlIF0gKSB7CgkJCXRoaXNbIGNhY2hlIF0gPSB0byggdGhpcy5fcmdiYSApOwoJCX0KCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzWyBjYWNoZSBdLnNsaWNlKCk7CgkJfQoKCQl2YXIgcmV0LAoJCQl0eXBlID0galF1ZXJ5LnR5cGUoIHZhbHVlICksCgkJCWFyciA9ICggdHlwZSA9PT0gImFycmF5IiB8fCB0eXBlID09PSAib2JqZWN0IiApID8gdmFsdWUgOiBhcmd1bWVudHMsCgkJCWxvY2FsID0gdGhpc1sgY2FjaGUgXS5zbGljZSgpOwoKCQllYWNoKCBwcm9wcywgZnVuY3Rpb24oIGtleSwgcHJvcCApIHsKCQkJdmFyIHZhbCA9IGFyclsgdHlwZSA9PT0gIm9iamVjdCIgPyBrZXkgOiBwcm9wLmlkeCBdOwoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gbG9jYWxbIHByb3AuaWR4IF07CgkJCX0KCQkJbG9jYWxbIHByb3AuaWR4IF0gPSBjbGFtcCggdmFsLCBwcm9wICk7CgkJfSApOwoKCQlpZiAoIGZyb20gKSB7CgkJCXJldCA9IGNvbG9yKCBmcm9tKCBsb2NhbCApICk7CgkJCXJldFsgY2FjaGUgXSA9IGxvY2FsOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCXJldHVybiBjb2xvciggbG9jYWwgKTsKCQl9Cgl9OwoKCS8vIE1ha2VzIHJlZCgpIGdyZWVuKCkgYmx1ZSgpIGFscGhhKCkgaHVlKCkgc2F0dXJhdGlvbigpIGxpZ2h0bmVzcygpCgllYWNoKCBwcm9wcywgZnVuY3Rpb24oIGtleSwgcHJvcCApIHsKCgkJLy8gQWxwaGEgaXMgaW5jbHVkZWQgaW4gbW9yZSB0aGFuIG9uZSBzcGFjZQoJCWlmICggY29sb3IuZm5bIGtleSBdICkgewoJCQlyZXR1cm47CgkJfQoJCWNvbG9yLmZuWyBrZXkgXSA9IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdmFyIHZ0eXBlID0galF1ZXJ5LnR5cGUoIHZhbHVlICksCgkJCQlmbiA9ICgga2V5ID09PSAiYWxwaGEiID8gKCB0aGlzLl9oc2xhID8gImhzbGEiIDogInJnYmEiICkgOiBzcGFjZU5hbWUgKSwKCQkJCWxvY2FsID0gdGhpc1sgZm4gXSgpLAoJCQkJY3VyID0gbG9jYWxbIHByb3AuaWR4IF0sCgkJCQltYXRjaDsKCgkJCWlmICggdnR5cGUgPT09ICJ1bmRlZmluZWQiICkgewoJCQkJcmV0dXJuIGN1cjsKCQkJfQoKCQkJaWYgKCB2dHlwZSA9PT0gImZ1bmN0aW9uIiApIHsKCQkJCXZhbHVlID0gdmFsdWUuY2FsbCggdGhpcywgY3VyICk7CgkJCQl2dHlwZSA9IGpRdWVyeS50eXBlKCB2YWx1ZSApOwoJCQl9CgkJCWlmICggdmFsdWUgPT0gbnVsbCAmJiBwcm9wLmVtcHR5ICkgewoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQkJaWYgKCB2dHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCQltYXRjaCA9IHJwbHVzZXF1YWxzLmV4ZWMoIHZhbHVlICk7CgkJCQlpZiAoIG1hdGNoICkgewoJCQkJCXZhbHVlID0gY3VyICsgcGFyc2VGbG9hdCggbWF0Y2hbIDIgXSApICogKCBtYXRjaFsgMSBdID09PSAiKyIgPyAxIDogLTEgKTsKCQkJCX0KCQkJfQoJCQlsb2NhbFsgcHJvcC5pZHggXSA9IHZhbHVlOwoJCQlyZXR1cm4gdGhpc1sgZm4gXSggbG9jYWwgKTsKCQl9OwoJfSApOwp9ICk7CgovLyBBZGQgY3NzSG9vayBhbmQgLmZ4LnN0ZXAgZnVuY3Rpb24gZm9yIGVhY2ggbmFtZWQgaG9vay4KLy8gYWNjZXB0IGEgc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBvZiBwcm9wZXJ0aWVzCmNvbG9yLmhvb2sgPSBmdW5jdGlvbiggaG9vayApIHsKCXZhciBob29rcyA9IGhvb2suc3BsaXQoICIgIiApOwoJZWFjaCggaG9va3MsIGZ1bmN0aW9uKCBpLCBob29rICkgewoJCWpRdWVyeS5jc3NIb29rc1sgaG9vayBdID0gewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCXZhciBwYXJzZWQsIGN1ckVsZW0sCgkJCQkJYmFja2dyb3VuZENvbG9yID0gIiI7CgoJCQkJaWYgKCB2YWx1ZSAhPT0gInRyYW5zcGFyZW50IiAmJiAoIGpRdWVyeS50eXBlKCB2YWx1ZSApICE9PSAic3RyaW5nIiB8fAoJCQkJCQkoIHBhcnNlZCA9IHN0cmluZ1BhcnNlKCB2YWx1ZSApICkgKSApIHsKCQkJCQl2YWx1ZSA9IGNvbG9yKCBwYXJzZWQgfHwgdmFsdWUgKTsKCQkJCQlpZiAoICFzdXBwb3J0LnJnYmEgJiYgdmFsdWUuX3JnYmFbIDMgXSAhPT0gMSApIHsKCQkJCQkJY3VyRWxlbSA9IGhvb2sgPT09ICJiYWNrZ3JvdW5kQ29sb3IiID8gZWxlbS5wYXJlbnROb2RlIDogZWxlbTsKCQkJCQkJd2hpbGUgKAoJCQkJCQkJKCBiYWNrZ3JvdW5kQ29sb3IgPT09ICIiIHx8IGJhY2tncm91bmRDb2xvciA9PT0gInRyYW5zcGFyZW50IiApICYmCgkJCQkJCQljdXJFbGVtICYmIGN1ckVsZW0uc3R5bGUKCQkJCQkJKSB7CgkJCQkJCQl0cnkgewoJCQkJCQkJCWJhY2tncm91bmRDb2xvciA9IGpRdWVyeS5jc3MoIGN1ckVsZW0sICJiYWNrZ3JvdW5kQ29sb3IiICk7CgkJCQkJCQkJY3VyRWxlbSA9IGN1ckVsZW0ucGFyZW50Tm9kZTsKCQkJCQkJCX0gY2F0Y2ggKCBlICkgewoJCQkJCQkJfQoJCQkJCQl9CgoJCQkJCQl2YWx1ZSA9IHZhbHVlLmJsZW5kKCBiYWNrZ3JvdW5kQ29sb3IgJiYgYmFja2dyb3VuZENvbG9yICE9PSAidHJhbnNwYXJlbnQiID8KCQkJCQkJCWJhY2tncm91bmRDb2xvciA6CgkJCQkJCQkiX2RlZmF1bHQiICk7CgkJCQkJfQoKCQkJCQl2YWx1ZSA9IHZhbHVlLnRvUmdiYVN0cmluZygpOwoJCQkJfQoJCQkJdHJ5IHsKCQkJCQllbGVtLnN0eWxlWyBob29rIF0gPSB2YWx1ZTsKCQkJCX0gY2F0Y2ggKCBlICkgewoKCQkJCQkvLyBXcmFwcGVkIHRvIHByZXZlbnQgSUUgZnJvbSB0aHJvd2luZyBlcnJvcnMgb24gImludmFsaWQiIHZhbHVlcyBsaWtlCgkJCQkJLy8gJ2F1dG8nIG9yICdpbmhlcml0JwoJCQkJfQoJCQl9CgkJfTsKCQlqUXVlcnkuZnguc3RlcFsgaG9vayBdID0gZnVuY3Rpb24oIGZ4ICkgewoJCQlpZiAoICFmeC5jb2xvckluaXQgKSB7CgkJCQlmeC5zdGFydCA9IGNvbG9yKCBmeC5lbGVtLCBob29rICk7CgkJCQlmeC5lbmQgPSBjb2xvciggZnguZW5kICk7CgkJCQlmeC5jb2xvckluaXQgPSB0cnVlOwoJCQl9CgkJCWpRdWVyeS5jc3NIb29rc1sgaG9vayBdLnNldCggZnguZWxlbSwgZnguc3RhcnQudHJhbnNpdGlvbiggZnguZW5kLCBmeC5wb3MgKSApOwoJCX07Cgl9ICk7Cgp9OwoKY29sb3IuaG9vayggc3RlcEhvb2tzICk7CgpqUXVlcnkuY3NzSG9va3MuYm9yZGVyQ29sb3IgPSB7CglleHBhbmQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgZXhwYW5kZWQgPSB7fTsKCgkJZWFjaCggWyAiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0IiBdLCBmdW5jdGlvbiggaSwgcGFydCApIHsKCQkJZXhwYW5kZWRbICJib3JkZXIiICsgcGFydCArICJDb2xvciIgXSA9IHZhbHVlOwoJCX0gKTsKCQlyZXR1cm4gZXhwYW5kZWQ7Cgl9Cn07CgovLyBCYXNpYyBjb2xvciBuYW1lcyBvbmx5LgovLyBVc2FnZSBvZiBhbnkgb2YgdGhlIG90aGVyIGNvbG9yIG5hbWVzIHJlcXVpcmVzIGFkZGluZyB5b3Vyc2VsZiBvciBpbmNsdWRpbmcKLy8ganF1ZXJ5LmNvbG9yLnN2Zy1uYW1lcy5qcy4KY29sb3JzID0galF1ZXJ5LkNvbG9yLm5hbWVzID0gewoKCS8vIDQuMS4gQmFzaWMgY29sb3Iga2V5d29yZHMKCWFxdWE6ICIjMDBmZmZmIiwKCWJsYWNrOiAiIzAwMDAwMCIsCglibHVlOiAiIzAwMDBmZiIsCglmdWNoc2lhOiAiI2ZmMDBmZiIsCglncmF5OiAiIzgwODA4MCIsCglncmVlbjogIiMwMDgwMDAiLAoJbGltZTogIiMwMGZmMDAiLAoJbWFyb29uOiAiIzgwMDAwMCIsCgluYXZ5OiAiIzAwMDA4MCIsCglvbGl2ZTogIiM4MDgwMDAiLAoJcHVycGxlOiAiIzgwMDA4MCIsCglyZWQ6ICIjZmYwMDAwIiwKCXNpbHZlcjogIiNjMGMwYzAiLAoJdGVhbDogIiMwMDgwODAiLAoJd2hpdGU6ICIjZmZmZmZmIiwKCXllbGxvdzogIiNmZmZmMDAiLAoKCS8vIDQuMi4zLiAidHJhbnNwYXJlbnQiIGNvbG9yIGtleXdvcmQKCXRyYW5zcGFyZW50OiBbIG51bGwsIG51bGwsIG51bGwsIDAgXSwKCglfZGVmYXVsdDogIiNmZmZmZmYiCn07Cgp9ICkoIGpRdWVyeSApOwoKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiBDTEFTUyBBTklNQVRJT05TICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KKCBmdW5jdGlvbigpIHsKCnZhciBjbGFzc0FuaW1hdGlvbkFjdGlvbnMgPSBbICJhZGQiLCAicmVtb3ZlIiwgInRvZ2dsZSIgXSwKCXNob3J0aGFuZFN0eWxlcyA9IHsKCQlib3JkZXI6IDEsCgkJYm9yZGVyQm90dG9tOiAxLAoJCWJvcmRlckNvbG9yOiAxLAoJCWJvcmRlckxlZnQ6IDEsCgkJYm9yZGVyUmlnaHQ6IDEsCgkJYm9yZGVyVG9wOiAxLAoJCWJvcmRlcldpZHRoOiAxLAoJCW1hcmdpbjogMSwKCQlwYWRkaW5nOiAxCgl9OwoKJC5lYWNoKAoJWyAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyVG9wU3R5bGUiIF0sCglmdW5jdGlvbiggXywgcHJvcCApIHsKCQkkLmZ4LnN0ZXBbIHByb3AgXSA9IGZ1bmN0aW9uKCBmeCApIHsKCQkJaWYgKCBmeC5lbmQgIT09ICJub25lIiAmJiAhZnguc2V0QXR0ciB8fCBmeC5wb3MgPT09IDEgJiYgIWZ4LnNldEF0dHIgKSB7CgkJCQlqUXVlcnkuc3R5bGUoIGZ4LmVsZW0sIHByb3AsIGZ4LmVuZCApOwoJCQkJZnguc2V0QXR0ciA9IHRydWU7CgkJCX0KCQl9OwoJfQopOwoKZnVuY3Rpb24gZ2V0RWxlbWVudFN0eWxlcyggZWxlbSApIHsKCXZhciBrZXksIGxlbiwKCQlzdHlsZSA9IGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyA\/CgkJCWVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKCBlbGVtLCBudWxsICkgOgoJCQllbGVtLmN1cnJlbnRTdHlsZSwKCQlzdHlsZXMgPSB7fTsKCglpZiAoIHN0eWxlICYmIHN0eWxlLmxlbmd0aCAmJiBzdHlsZVsgMCBdICYmIHN0eWxlWyBzdHlsZVsgMCBdIF0gKSB7CgkJbGVuID0gc3R5bGUubGVuZ3RoOwoJCXdoaWxlICggbGVuLS0gKSB7CgkJCWtleSA9IHN0eWxlWyBsZW4gXTsKCQkJaWYgKCB0eXBlb2Ygc3R5bGVbIGtleSBdID09PSAic3RyaW5nIiApIHsKCQkJCXN0eWxlc1sgJC5jYW1lbENhc2UoIGtleSApIF0gPSBzdHlsZVsga2V5IF07CgkJCX0KCQl9CgoJLy8gU3VwcG9ydDogT3BlcmEsIElFIDw5Cgl9IGVsc2UgewoJCWZvciAoIGtleSBpbiBzdHlsZSApIHsKCQkJaWYgKCB0eXBlb2Ygc3R5bGVbIGtleSBdID09PSAic3RyaW5nIiApIHsKCQkJCXN0eWxlc1sga2V5IF0gPSBzdHlsZVsga2V5IF07CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHN0eWxlczsKfQoKZnVuY3Rpb24gc3R5bGVEaWZmZXJlbmNlKCBvbGRTdHlsZSwgbmV3U3R5bGUgKSB7Cgl2YXIgZGlmZiA9IHt9LAoJCW5hbWUsIHZhbHVlOwoKCWZvciAoIG5hbWUgaW4gbmV3U3R5bGUgKSB7CgkJdmFsdWUgPSBuZXdTdHlsZVsgbmFtZSBdOwoJCWlmICggb2xkU3R5bGVbIG5hbWUgXSAhPT0gdmFsdWUgKSB7CgkJCWlmICggIXNob3J0aGFuZFN0eWxlc1sgbmFtZSBdICkgewoJCQkJaWYgKCAkLmZ4LnN0ZXBbIG5hbWUgXSB8fCAhaXNOYU4oIHBhcnNlRmxvYXQoIHZhbHVlICkgKSApIHsKCQkJCQlkaWZmWyBuYW1lIF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4gZGlmZjsKfQoKLy8gU3VwcG9ydDogalF1ZXJ5IDwxLjgKaWYgKCAhJC5mbi5hZGRCYWNrICkgewoJJC5mbi5hZGRCYWNrID0gZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLmFkZCggc2VsZWN0b3IgPT0gbnVsbCA\/CgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoIHNlbGVjdG9yICkKCQkpOwoJfTsKfQoKJC5lZmZlY3RzLmFuaW1hdGVDbGFzcyA9IGZ1bmN0aW9uKCB2YWx1ZSwgZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2sgKSB7Cgl2YXIgbyA9ICQuc3BlZWQoIGR1cmF0aW9uLCBlYXNpbmcsIGNhbGxiYWNrICk7CgoJcmV0dXJuIHRoaXMucXVldWUoIGZ1bmN0aW9uKCkgewoJCXZhciBhbmltYXRlZCA9ICQoIHRoaXMgKSwKCQkJYmFzZUNsYXNzID0gYW5pbWF0ZWQuYXR0ciggImNsYXNzIiApIHx8ICIiLAoJCQlhcHBseUNsYXNzQ2hhbmdlLAoJCQlhbGxBbmltYXRpb25zID0gby5jaGlsZHJlbiA\/IGFuaW1hdGVkLmZpbmQoICIqIiApLmFkZEJhY2soKSA6IGFuaW1hdGVkOwoKCQkvLyBNYXAgdGhlIGFuaW1hdGVkIG9iamVjdHMgdG8gc3RvcmUgdGhlIG9yaWdpbmFsIHN0eWxlcy4KCQlhbGxBbmltYXRpb25zID0gYWxsQW5pbWF0aW9ucy5tYXAoIGZ1bmN0aW9uKCkgewoJCQl2YXIgZWwgPSAkKCB0aGlzICk7CgkJCXJldHVybiB7CgkJCQllbDogZWwsCgkJCQlzdGFydDogZ2V0RWxlbWVudFN0eWxlcyggdGhpcyApCgkJCX07CgkJfSApOwoKCQkvLyBBcHBseSBjbGFzcyBjaGFuZ2UKCQlhcHBseUNsYXNzQ2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCSQuZWFjaCggY2xhc3NBbmltYXRpb25BY3Rpb25zLCBmdW5jdGlvbiggaSwgYWN0aW9uICkgewoJCQkJaWYgKCB2YWx1ZVsgYWN0aW9uIF0gKSB7CgkJCQkJYW5pbWF0ZWRbIGFjdGlvbiArICJDbGFzcyIgXSggdmFsdWVbIGFjdGlvbiBdICk7CgkJCQl9CgkJCX0gKTsKCQl9OwoJCWFwcGx5Q2xhc3NDaGFuZ2UoKTsKCgkJLy8gTWFwIGFsbCBhbmltYXRlZCBvYmplY3RzIGFnYWluIC0gY2FsY3VsYXRlIG5ldyBzdHlsZXMgYW5kIGRpZmYKCQlhbGxBbmltYXRpb25zID0gYWxsQW5pbWF0aW9ucy5tYXAoIGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVuZCA9IGdldEVsZW1lbnRTdHlsZXMoIHRoaXMuZWxbIDAgXSApOwoJCQl0aGlzLmRpZmYgPSBzdHlsZURpZmZlcmVuY2UoIHRoaXMuc3RhcnQsIHRoaXMuZW5kICk7CgkJCXJldHVybiB0aGlzOwoJCX0gKTsKCgkJLy8gQXBwbHkgb3JpZ2luYWwgY2xhc3MKCQlhbmltYXRlZC5hdHRyKCAiY2xhc3MiLCBiYXNlQ2xhc3MgKTsKCgkJLy8gTWFwIGFsbCBhbmltYXRlZCBvYmplY3RzIGFnYWluIC0gdGhpcyB0aW1lIGNvbGxlY3RpbmcgYSBwcm9taXNlCgkJYWxsQW5pbWF0aW9ucyA9IGFsbEFuaW1hdGlvbnMubWFwKCBmdW5jdGlvbigpIHsKCQkJdmFyIHN0eWxlSW5mbyA9IHRoaXMsCgkJCQlkZmQgPSAkLkRlZmVycmVkKCksCgkJCQlvcHRzID0gJC5leHRlbmQoIHt9LCBvLCB7CgkJCQkJcXVldWU6IGZhbHNlLAoJCQkJCWNvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQkJCQkJZGZkLnJlc29sdmUoIHN0eWxlSW5mbyApOwoJCQkJCX0KCQkJCX0gKTsKCgkJCXRoaXMuZWwuYW5pbWF0ZSggdGhpcy5kaWZmLCBvcHRzICk7CgkJCXJldHVybiBkZmQucHJvbWlzZSgpOwoJCX0gKTsKCgkJLy8gT25jZSBhbGwgYW5pbWF0aW9ucyBoYXZlIGNvbXBsZXRlZDoKCQkkLndoZW4uYXBwbHkoICQsIGFsbEFuaW1hdGlvbnMuZ2V0KCkgKS5kb25lKCBmdW5jdGlvbigpIHsKCgkJCS8vIFNldCB0aGUgZmluYWwgY2xhc3MKCQkJYXBwbHlDbGFzc0NoYW5nZSgpOwoKCQkJLy8gRm9yIGVhY2ggYW5pbWF0ZWQgZWxlbWVudCwKCQkJLy8gY2xlYXIgYWxsIGNzcyBwcm9wZXJ0aWVzIHRoYXQgd2VyZSBhbmltYXRlZAoJCQkkLmVhY2goIGFyZ3VtZW50cywgZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWwgPSB0aGlzLmVsOwoJCQkJJC5lYWNoKCB0aGlzLmRpZmYsIGZ1bmN0aW9uKCBrZXkgKSB7CgkJCQkJZWwuY3NzKCBrZXksICIiICk7CgkJCQl9ICk7CgkJCX0gKTsKCgkJCS8vIFRoaXMgaXMgZ3Vhcm50ZWVkIHRvIGJlIHRoZXJlIGlmIHlvdSB1c2UgalF1ZXJ5LnNwZWVkKCkKCQkJLy8gaXQgYWxzbyBoYW5kbGVzIGRlcXVldWluZyB0aGUgbmV4dCBhbmltLi4uCgkJCW8uY29tcGxldGUuY2FsbCggYW5pbWF0ZWRbIDAgXSApOwoJCX0gKTsKCX0gKTsKfTsKCiQuZm4uZXh0ZW5kKCB7CglhZGRDbGFzczogKCBmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGNsYXNzTmFtZXMsIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgewoJCQlyZXR1cm4gc3BlZWQgPwoJCQkJJC5lZmZlY3RzLmFuaW1hdGVDbGFzcy5jYWxsKCB0aGlzLAoJCQkJCXsgYWRkOiBjbGFzc05hbWVzIH0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICkgOgoJCQkJb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCX0gKSggJC5mbi5hZGRDbGFzcyApLAoKCXJlbW92ZUNsYXNzOiAoIGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggY2xhc3NOYW1lcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMSA\/CgkJCQkkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsCgkJCQkJeyByZW1vdmU6IGNsYXNzTmFtZXMgfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSApKCAkLmZuLnJlbW92ZUNsYXNzICksCgoJdG9nZ2xlQ2xhc3M6ICggZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCBjbGFzc05hbWVzLCBmb3JjZSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJCWlmICggdHlwZW9mIGZvcmNlID09PSAiYm9vbGVhbiIgfHwgZm9yY2UgPT09IHVuZGVmaW5lZCApIHsKCQkJCWlmICggIXNwZWVkICkgewoKCQkJCQkvLyBXaXRob3V0IHNwZWVkIHBhcmFtZXRlcgoJCQkJCXJldHVybiBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuICQuZWZmZWN0cy5hbmltYXRlQ2xhc3MuY2FsbCggdGhpcywKCQkJCQkJKCBmb3JjZSA\/IHsgYWRkOiBjbGFzc05hbWVzIH0gOiB7IHJlbW92ZTogY2xhc3NOYW1lcyB9ICksCgkJCQkJCXNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7CgkJCQl9CgkJCX0gZWxzZSB7CgoJCQkJLy8gV2l0aG91dCBmb3JjZSBwYXJhbWV0ZXIKCQkJCXJldHVybiAkLmVmZmVjdHMuYW5pbWF0ZUNsYXNzLmNhbGwoIHRoaXMsCgkJCQkJeyB0b2dnbGU6IGNsYXNzTmFtZXMgfSwgZm9yY2UsIHNwZWVkLCBlYXNpbmcgKTsKCQkJfQoJCX07Cgl9ICkoICQuZm4udG9nZ2xlQ2xhc3MgKSwKCglzd2l0Y2hDbGFzczogZnVuY3Rpb24oIHJlbW92ZSwgYWRkLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gJC5lZmZlY3RzLmFuaW1hdGVDbGFzcy5jYWxsKCB0aGlzLCB7CgkJCWFkZDogYWRkLAoJCQlyZW1vdmU6IHJlbW92ZQoJCX0sIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrICk7Cgl9Cn0gKTsKCn0gKSgpOwoKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqIEVGRkVDVFMgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KCiggZnVuY3Rpb24oKSB7CgppZiAoICQuZXhwciAmJiAkLmV4cHIuZmlsdGVycyAmJiAkLmV4cHIuZmlsdGVycy5hbmltYXRlZCApIHsKCSQuZXhwci5maWx0ZXJzLmFuaW1hdGVkID0gKCBmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAhISQoIGVsZW0gKS5kYXRhKCBkYXRhU3BhY2VBbmltYXRlZCApIHx8IG9yaWcoIGVsZW0gKTsKCQl9OwoJfSApKCAkLmV4cHIuZmlsdGVycy5hbmltYXRlZCApOwp9CgppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCSQuZXh0ZW5kKCAkLmVmZmVjdHMsIHsKCgkJLy8gU2F2ZXMgYSBzZXQgb2YgcHJvcGVydGllcyBpbiBhIGRhdGEgc3RvcmFnZQoJCXNhdmU6IGZ1bmN0aW9uKCBlbGVtZW50LCBzZXQgKSB7CgkJCXZhciBpID0gMCwgbGVuZ3RoID0gc2V0Lmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHNldFsgaSBdICE9PSBudWxsICkgewoJCQkJCWVsZW1lbnQuZGF0YSggZGF0YVNwYWNlICsgc2V0WyBpIF0sIGVsZW1lbnRbIDAgXS5zdHlsZVsgc2V0WyBpIF0gXSApOwoJCQkJfQoJCQl9CgkJfSwKCgkJLy8gUmVzdG9yZXMgYSBzZXQgb2YgcHJldmlvdXNseSBzYXZlZCBwcm9wZXJ0aWVzIGZyb20gYSBkYXRhIHN0b3JhZ2UKCQlyZXN0b3JlOiBmdW5jdGlvbiggZWxlbWVudCwgc2V0ICkgewoJCQl2YXIgdmFsLCBpID0gMCwgbGVuZ3RoID0gc2V0Lmxlbmd0aDsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHNldFsgaSBdICE9PSBudWxsICkgewoJCQkJCXZhbCA9IGVsZW1lbnQuZGF0YSggZGF0YVNwYWNlICsgc2V0WyBpIF0gKTsKCQkJCQllbGVtZW50LmNzcyggc2V0WyBpIF0sIHZhbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJc2V0TW9kZTogZnVuY3Rpb24oIGVsLCBtb2RlICkgewoJCQlpZiAoIG1vZGUgPT09ICJ0b2dnbGUiICkgewoJCQkJbW9kZSA9IGVsLmlzKCAiOmhpZGRlbiIgKSA\/ICJzaG93IiA6ICJoaWRlIjsKCQkJfQoJCQlyZXR1cm4gbW9kZTsKCQl9LAoKCQkvLyBXcmFwcyB0aGUgZWxlbWVudCBhcm91bmQgYSB3cmFwcGVyIHRoYXQgY29waWVzIHBvc2l0aW9uIHByb3BlcnRpZXMKCQljcmVhdGVXcmFwcGVyOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCgkJCS8vIElmIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgd3JhcHBlZCwgcmV0dXJuIGl0CgkJCWlmICggZWxlbWVudC5wYXJlbnQoKS5pcyggIi51aS1lZmZlY3RzLXdyYXBwZXIiICkgKSB7CgkJCQlyZXR1cm4gZWxlbWVudC5wYXJlbnQoKTsKCQkJfQoKCQkJLy8gV3JhcCB0aGUgZWxlbWVudAoJCQl2YXIgcHJvcHMgPSB7CgkJCQkJd2lkdGg6IGVsZW1lbnQub3V0ZXJXaWR0aCggdHJ1ZSApLAoJCQkJCWhlaWdodDogZWxlbWVudC5vdXRlckhlaWdodCggdHJ1ZSApLAoJCQkJCSJmbG9hdCI6IGVsZW1lbnQuY3NzKCAiZmxvYXQiICkKCQkJCX0sCgkJCQl3cmFwcGVyID0gJCggIjxkaXY+PC9kaXY+IiApCgkJCQkJLmFkZENsYXNzKCAidWktZWZmZWN0cy13cmFwcGVyIiApCgkJCQkJLmNzcyggewoJCQkJCQlmb250U2l6ZTogIjEwMCUiLAoJCQkJCQliYWNrZ3JvdW5kOiAidHJhbnNwYXJlbnQiLAoJCQkJCQlib3JkZXI6ICJub25lIiwKCQkJCQkJbWFyZ2luOiAwLAoJCQkJCQlwYWRkaW5nOiAwCgkJCQkJfSApLAoKCQkJCS8vIFN0b3JlIHRoZSBzaXplIGluIGNhc2Ugd2lkdGgvaGVpZ2h0IGFyZSBkZWZpbmVkIGluICUgLSBGaXhlcyAjNTI0NQoJCQkJc2l6ZSA9IHsKCQkJCQl3aWR0aDogZWxlbWVudC53aWR0aCgpLAoJCQkJCWhlaWdodDogZWxlbWVudC5oZWlnaHQoKQoJCQkJfSwKCQkJCWFjdGl2ZSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CgoJCQkvLyBTdXBwb3J0OiBGaXJlZm94CgkJCS8vIEZpcmVmb3ggaW5jb3JyZWN0bHkgZXhwb3NlcyBhbm9ueW1vdXMgY29udGVudAoJCQkvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD01NjE2NjQKCQkJdHJ5IHsKCQkJCWFjdGl2ZS5pZDsKCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQlhY3RpdmUgPSBkb2N1bWVudC5ib2R5OwoJCQl9CgoJCQllbGVtZW50LndyYXAoIHdyYXBwZXIgKTsKCgkJCS8vIEZpeGVzICM3NTk1IC0gRWxlbWVudHMgbG9zZSBmb2N1cyB3aGVuIHdyYXBwZWQuCgkJCWlmICggZWxlbWVudFsgMCBdID09PSBhY3RpdmUgfHwgJC5jb250YWlucyggZWxlbWVudFsgMCBdLCBhY3RpdmUgKSApIHsKCQkJCSQoIGFjdGl2ZSApLnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJfQoKCQkJLy8gSG90Zml4IGZvciBqUXVlcnkgMS40IHNpbmNlIHNvbWUgY2hhbmdlIGluIHdyYXAoKSBzZWVtcyB0byBhY3R1YWxseQoJCQkvLyBsb3NlIHRoZSByZWZlcmVuY2UgdG8gdGhlIHdyYXBwZWQgZWxlbWVudAoJCQl3cmFwcGVyID0gZWxlbWVudC5wYXJlbnQoKTsKCgkJCS8vIFRyYW5zZmVyIHBvc2l0aW9uaW5nIHByb3BlcnRpZXMgdG8gdGhlIHdyYXBwZXIKCQkJaWYgKCBlbGVtZW50LmNzcyggInBvc2l0aW9uIiApID09PSAic3RhdGljIiApIHsKCQkJCXdyYXBwZXIuY3NzKCB7IHBvc2l0aW9uOiAicmVsYXRpdmUiIH0gKTsKCQkJCWVsZW1lbnQuY3NzKCB7IHBvc2l0aW9uOiAicmVsYXRpdmUiIH0gKTsKCQkJfSBlbHNlIHsKCQkJCSQuZXh0ZW5kKCBwcm9wcywgewoJCQkJCXBvc2l0aW9uOiBlbGVtZW50LmNzcyggInBvc2l0aW9uIiApLAoJCQkJCXpJbmRleDogZWxlbWVudC5jc3MoICJ6LWluZGV4IiApCgkJCQl9ICk7CgkJCQkkLmVhY2goIFsgInRvcCIsICJsZWZ0IiwgImJvdHRvbSIsICJyaWdodCIgXSwgZnVuY3Rpb24oIGksIHBvcyApIHsKCQkJCQlwcm9wc1sgcG9zIF0gPSBlbGVtZW50LmNzcyggcG9zICk7CgkJCQkJaWYgKCBpc05hTiggcGFyc2VJbnQoIHByb3BzWyBwb3MgXSwgMTAgKSApICkgewoJCQkJCQlwcm9wc1sgcG9zIF0gPSAiYXV0byI7CgkJCQkJfQoJCQkJfSApOwoJCQkJZWxlbWVudC5jc3MoIHsKCQkJCQlwb3NpdGlvbjogInJlbGF0aXZlIiwKCQkJCQl0b3A6IDAsCgkJCQkJbGVmdDogMCwKCQkJCQlyaWdodDogImF1dG8iLAoJCQkJCWJvdHRvbTogImF1dG8iCgkJCQl9ICk7CgkJCX0KCQkJZWxlbWVudC5jc3MoIHNpemUgKTsKCgkJCXJldHVybiB3cmFwcGVyLmNzcyggcHJvcHMgKS5zaG93KCk7CgkJfSwKCgkJcmVtb3ZlV3JhcHBlcjogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJCXZhciBhY3RpdmUgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwoKCQkJaWYgKCBlbGVtZW50LnBhcmVudCgpLmlzKCAiLnVpLWVmZmVjdHMtd3JhcHBlciIgKSApIHsKCQkJCWVsZW1lbnQucGFyZW50KCkucmVwbGFjZVdpdGgoIGVsZW1lbnQgKTsKCgkJCQkvLyBGaXhlcyAjNzU5NSAtIEVsZW1lbnRzIGxvc2UgZm9jdXMgd2hlbiB3cmFwcGVkLgoJCQkJaWYgKCBlbGVtZW50WyAwIF0gPT09IGFjdGl2ZSB8fCAkLmNvbnRhaW5zKCBlbGVtZW50WyAwIF0sIGFjdGl2ZSApICkgewoJCQkJCSQoIGFjdGl2ZSApLnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGVsZW1lbnQ7CgkJfQoJfSApOwp9CgokLmV4dGVuZCggJC5lZmZlY3RzLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCglkZWZpbmU6IGZ1bmN0aW9uKCBuYW1lLCBtb2RlLCBlZmZlY3QgKSB7CgkJaWYgKCAhZWZmZWN0ICkgewoJCQllZmZlY3QgPSBtb2RlOwoJCQltb2RlID0gImVmZmVjdCI7CgkJfQoKCQkkLmVmZmVjdHMuZWZmZWN0WyBuYW1lIF0gPSBlZmZlY3Q7CgkJJC5lZmZlY3RzLmVmZmVjdFsgbmFtZSBdLm1vZGUgPSBtb2RlOwoKCQlyZXR1cm4gZWZmZWN0OwoJfSwKCglzY2FsZWREaW1lbnNpb25zOiBmdW5jdGlvbiggZWxlbWVudCwgcGVyY2VudCwgZGlyZWN0aW9uICkgewoJCWlmICggcGVyY2VudCA9PT0gMCApIHsKCQkJcmV0dXJuIHsKCQkJCWhlaWdodDogMCwKCQkJCXdpZHRoOiAwLAoJCQkJb3V0ZXJIZWlnaHQ6IDAsCgkJCQlvdXRlcldpZHRoOiAwCgkJCX07CgkJfQoKCQl2YXIgeCA9IGRpcmVjdGlvbiAhPT0gImhvcml6b250YWwiID8gKCAoIHBlcmNlbnQgfHwgMTAwICkgLyAxMDAgKSA6IDEsCgkJCXkgPSBkaXJlY3Rpb24gIT09ICJ2ZXJ0aWNhbCIgPyAoICggcGVyY2VudCB8fCAxMDAgKSAvIDEwMCApIDogMTsKCgkJcmV0dXJuIHsKCQkJaGVpZ2h0OiBlbGVtZW50LmhlaWdodCgpICogeSwKCQkJd2lkdGg6IGVsZW1lbnQud2lkdGgoKSAqIHgsCgkJCW91dGVySGVpZ2h0OiBlbGVtZW50Lm91dGVySGVpZ2h0KCkgKiB5LAoJCQlvdXRlcldpZHRoOiBlbGVtZW50Lm91dGVyV2lkdGgoKSAqIHgKCQl9OwoKCX0sCgoJY2xpcFRvQm94OiBmdW5jdGlvbiggYW5pbWF0aW9uICkgewoJCXJldHVybiB7CgkJCXdpZHRoOiBhbmltYXRpb24uY2xpcC5yaWdodCAtIGFuaW1hdGlvbi5jbGlwLmxlZnQsCgkJCWhlaWdodDogYW5pbWF0aW9uLmNsaXAuYm90dG9tIC0gYW5pbWF0aW9uLmNsaXAudG9wLAoJCQlsZWZ0OiBhbmltYXRpb24uY2xpcC5sZWZ0LAoJCQl0b3A6IGFuaW1hdGlvbi5jbGlwLnRvcAoJCX07Cgl9LAoKCS8vIEluamVjdHMgcmVjZW50bHkgcXVldWVkIGZ1bmN0aW9ucyB0byBiZSBmaXJzdCBpbiBsaW5lIChhZnRlciAiaW5wcm9ncmVzcyIpCgl1bnNoaWZ0OiBmdW5jdGlvbiggZWxlbWVudCwgcXVldWVMZW5ndGgsIGNvdW50ICkgewoJCXZhciBxdWV1ZSA9IGVsZW1lbnQucXVldWUoKTsKCgkJaWYgKCBxdWV1ZUxlbmd0aCA+IDEgKSB7CgkJCXF1ZXVlLnNwbGljZS5hcHBseSggcXVldWUsCgkJCQlbIDEsIDAgXS5jb25jYXQoIHF1ZXVlLnNwbGljZSggcXVldWVMZW5ndGgsIGNvdW50ICkgKSApOwoJCX0KCQllbGVtZW50LmRlcXVldWUoKTsKCX0sCgoJc2F2ZVN0eWxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQllbGVtZW50LmRhdGEoIGRhdGFTcGFjZVN0eWxlLCBlbGVtZW50WyAwIF0uc3R5bGUuY3NzVGV4dCApOwoJfSwKCglyZXN0b3JlU3R5bGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCWVsZW1lbnRbIDAgXS5zdHlsZS5jc3NUZXh0ID0gZWxlbWVudC5kYXRhKCBkYXRhU3BhY2VTdHlsZSApIHx8ICIiOwoJCWVsZW1lbnQucmVtb3ZlRGF0YSggZGF0YVNwYWNlU3R5bGUgKTsKCX0sCgoJbW9kZTogZnVuY3Rpb24oIGVsZW1lbnQsIG1vZGUgKSB7CgkJdmFyIGhpZGRlbiA9IGVsZW1lbnQuaXMoICI6aGlkZGVuIiApOwoKCQlpZiAoIG1vZGUgPT09ICJ0b2dnbGUiICkgewoJCQltb2RlID0gaGlkZGVuID8gInNob3ciIDogImhpZGUiOwoJCX0KCQlpZiAoIGhpZGRlbiA\/IG1vZGUgPT09ICJoaWRlIiA6IG1vZGUgPT09ICJzaG93IiApIHsKCQkJbW9kZSA9ICJub25lIjsKCQl9CgkJcmV0dXJuIG1vZGU7Cgl9LAoKCS8vIFRyYW5zbGF0ZXMgYSBbdG9wLGxlZnRdIGFycmF5IGludG8gYSBiYXNlbGluZSB2YWx1ZQoJZ2V0QmFzZWxpbmU6IGZ1bmN0aW9uKCBvcmlnaW4sIG9yaWdpbmFsICkgewoJCXZhciB5LCB4OwoKCQlzd2l0Y2ggKCBvcmlnaW5bIDAgXSApIHsKCQljYXNlICJ0b3AiOgoJCQl5ID0gMDsKCQkJYnJlYWs7CgkJY2FzZSAibWlkZGxlIjoKCQkJeSA9IDAuNTsKCQkJYnJlYWs7CgkJY2FzZSAiYm90dG9tIjoKCQkJeSA9IDE7CgkJCWJyZWFrOwoJCWRlZmF1bHQ6CgkJCXkgPSBvcmlnaW5bIDAgXSAvIG9yaWdpbmFsLmhlaWdodDsKCQl9CgoJCXN3aXRjaCAoIG9yaWdpblsgMSBdICkgewoJCWNhc2UgImxlZnQiOgoJCQl4ID0gMDsKCQkJYnJlYWs7CgkJY2FzZSAiY2VudGVyIjoKCQkJeCA9IDAuNTsKCQkJYnJlYWs7CgkJY2FzZSAicmlnaHQiOgoJCQl4ID0gMTsKCQkJYnJlYWs7CgkJZGVmYXVsdDoKCQkJeCA9IG9yaWdpblsgMSBdIC8gb3JpZ2luYWwud2lkdGg7CgkJfQoKCQlyZXR1cm4gewoJCQl4OiB4LAoJCQl5OiB5CgkJfTsKCX0sCgoJLy8gQ3JlYXRlcyBhIHBsYWNlaG9sZGVyIGVsZW1lbnQgc28gdGhhdCB0aGUgb3JpZ2luYWwgZWxlbWVudCBjYW4gYmUgbWFkZSBhYnNvbHV0ZQoJY3JlYXRlUGxhY2Vob2xkZXI6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXZhciBwbGFjZWhvbGRlciwKCQkJY3NzUG9zaXRpb24gPSBlbGVtZW50LmNzcyggInBvc2l0aW9uIiApLAoJCQlwb3NpdGlvbiA9IGVsZW1lbnQucG9zaXRpb24oKTsKCgkJLy8gTG9jayBpbiBtYXJnaW5zIGZpcnN0IHRvIGFjY291bnQgZm9yIGZvcm0gZWxlbWVudHMsIHdoaWNoCgkJLy8gd2lsbCBjaGFuZ2UgbWFyZ2luIGlmIHlvdSBleHBsaWNpdGx5IHNldCBoZWlnaHQKCQkvLyBzZWU6IGh0dHA6Ly9qc2ZpZGRsZS5uZXQvSlpTTXQvMy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEwNzM4MAoJCS8vIFN1cHBvcnQ6IFNhZmFyaQoJCWVsZW1lbnQuY3NzKCB7CgkJCW1hcmdpblRvcDogZWxlbWVudC5jc3MoICJtYXJnaW5Ub3AiICksCgkJCW1hcmdpbkJvdHRvbTogZWxlbWVudC5jc3MoICJtYXJnaW5Cb3R0b20iICksCgkJCW1hcmdpbkxlZnQ6IGVsZW1lbnQuY3NzKCAibWFyZ2luTGVmdCIgKSwKCQkJbWFyZ2luUmlnaHQ6IGVsZW1lbnQuY3NzKCAibWFyZ2luUmlnaHQiICkKCQl9ICkKCQkub3V0ZXJXaWR0aCggZWxlbWVudC5vdXRlcldpZHRoKCkgKQoJCS5vdXRlckhlaWdodCggZWxlbWVudC5vdXRlckhlaWdodCgpICk7CgoJCWlmICggL14oc3RhdGljfHJlbGF0aXZlKS8udGVzdCggY3NzUG9zaXRpb24gKSApIHsKCQkJY3NzUG9zaXRpb24gPSAiYWJzb2x1dGUiOwoKCQkJcGxhY2Vob2xkZXIgPSAkKCAiPCIgKyBlbGVtZW50WyAwIF0ubm9kZU5hbWUgKyAiPiIgKS5pbnNlcnRBZnRlciggZWxlbWVudCApLmNzcyggewoKCQkJCS8vIENvbnZlcnQgaW5saW5lIHRvIGlubGluZSBibG9jayB0byBhY2NvdW50IGZvciBpbmxpbmUgZWxlbWVudHMKCQkJCS8vIHRoYXQgdHVybiB0byBpbmxpbmUgYmxvY2sgYmFzZWQgb24gY29udGVudCAobGlrZSBpbWcpCgkJCQlkaXNwbGF5OiAvXihpbmxpbmV8cnVieSkvLnRlc3QoIGVsZW1lbnQuY3NzKCAiZGlzcGxheSIgKSApID8KCQkJCQkiaW5saW5lLWJsb2NrIiA6CgkJCQkJImJsb2NrIiwKCQkJCXZpc2liaWxpdHk6ICJoaWRkZW4iLAoKCQkJCS8vIE1hcmdpbnMgbmVlZCB0byBiZSBzZXQgdG8gYWNjb3VudCBmb3IgbWFyZ2luIGNvbGxhcHNlCgkJCQltYXJnaW5Ub3A6IGVsZW1lbnQuY3NzKCAibWFyZ2luVG9wIiApLAoJCQkJbWFyZ2luQm90dG9tOiBlbGVtZW50LmNzcyggIm1hcmdpbkJvdHRvbSIgKSwKCQkJCW1hcmdpbkxlZnQ6IGVsZW1lbnQuY3NzKCAibWFyZ2luTGVmdCIgKSwKCQkJCW1hcmdpblJpZ2h0OiBlbGVtZW50LmNzcyggIm1hcmdpblJpZ2h0IiApLAoJCQkJImZsb2F0IjogZWxlbWVudC5jc3MoICJmbG9hdCIgKQoJCQl9ICkKCQkJLm91dGVyV2lkdGgoIGVsZW1lbnQub3V0ZXJXaWR0aCgpICkKCQkJLm91dGVySGVpZ2h0KCBlbGVtZW50Lm91dGVySGVpZ2h0KCkgKQoJCQkuYWRkQ2xhc3MoICJ1aS1lZmZlY3RzLXBsYWNlaG9sZGVyIiApOwoKCQkJZWxlbWVudC5kYXRhKCBkYXRhU3BhY2UgKyAicGxhY2Vob2xkZXIiLCBwbGFjZWhvbGRlciApOwoJCX0KCgkJZWxlbWVudC5jc3MoIHsKCQkJcG9zaXRpb246IGNzc1Bvc2l0aW9uLAoJCQlsZWZ0OiBwb3NpdGlvbi5sZWZ0LAoJCQl0b3A6IHBvc2l0aW9uLnRvcAoJCX0gKTsKCgkJcmV0dXJuIHBsYWNlaG9sZGVyOwoJfSwKCglyZW1vdmVQbGFjZWhvbGRlcjogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIGRhdGFLZXkgPSBkYXRhU3BhY2UgKyAicGxhY2Vob2xkZXIiLAoJCQkJcGxhY2Vob2xkZXIgPSBlbGVtZW50LmRhdGEoIGRhdGFLZXkgKTsKCgkJaWYgKCBwbGFjZWhvbGRlciApIHsKCQkJcGxhY2Vob2xkZXIucmVtb3ZlKCk7CgkJCWVsZW1lbnQucmVtb3ZlRGF0YSggZGF0YUtleSApOwoJCX0KCX0sCgoJLy8gUmVtb3ZlcyBhIHBsYWNlaG9sZGVyIGlmIGl0IGV4aXN0cyBhbmQgcmVzdG9yZXMKCS8vIHByb3BlcnRpZXMgdGhhdCB3ZXJlIG1vZGlmaWVkIGR1cmluZyBwbGFjZWhvbGRlciBjcmVhdGlvbgoJY2xlYW5VcDogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJJC5lZmZlY3RzLnJlc3RvcmVTdHlsZSggZWxlbWVudCApOwoJCSQuZWZmZWN0cy5yZW1vdmVQbGFjZWhvbGRlciggZWxlbWVudCApOwoJfSwKCglzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiggZWxlbWVudCwgbGlzdCwgZmFjdG9yLCB2YWx1ZSApIHsKCQl2YWx1ZSA9IHZhbHVlIHx8IHt9OwoJCSQuZWFjaCggbGlzdCwgZnVuY3Rpb24oIGksIHggKSB7CgkJCXZhciB1bml0ID0gZWxlbWVudC5jc3NVbml0KCB4ICk7CgkJCWlmICggdW5pdFsgMCBdID4gMCApIHsKCQkJCXZhbHVlWyB4IF0gPSB1bml0WyAwIF0gKiBmYWN0b3IgKyB1bml0WyAxIF07CgkJCX0KCQl9ICk7CgkJcmV0dXJuIHZhbHVlOwoJfQp9ICk7CgovLyBSZXR1cm4gYW4gZWZmZWN0IG9wdGlvbnMgb2JqZWN0IGZvciB0aGUgZ2l2ZW4gcGFyYW1ldGVyczoKZnVuY3Rpb24gX25vcm1hbGl6ZUFyZ3VtZW50cyggZWZmZWN0LCBvcHRpb25zLCBzcGVlZCwgY2FsbGJhY2sgKSB7CgoJLy8gQWxsb3cgcGFzc2luZyBhbGwgb3B0aW9ucyBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyCglpZiAoICQuaXNQbGFpbk9iamVjdCggZWZmZWN0ICkgKSB7CgkJb3B0aW9ucyA9IGVmZmVjdDsKCQllZmZlY3QgPSBlZmZlY3QuZWZmZWN0OwoJfQoKCS8vIENvbnZlcnQgdG8gYW4gb2JqZWN0CgllZmZlY3QgPSB7IGVmZmVjdDogZWZmZWN0IH07CgoJLy8gQ2F0Y2ggKGVmZmVjdCwgbnVsbCwgLi4uKQoJaWYgKCBvcHRpb25zID09IG51bGwgKSB7CgkJb3B0aW9ucyA9IHt9OwoJfQoKCS8vIENhdGNoIChlZmZlY3QsIGNhbGxiYWNrKQoJaWYgKCAkLmlzRnVuY3Rpb24oIG9wdGlvbnMgKSApIHsKCQljYWxsYmFjayA9IG9wdGlvbnM7CgkJc3BlZWQgPSBudWxsOwoJCW9wdGlvbnMgPSB7fTsKCX0KCgkvLyBDYXRjaCAoZWZmZWN0LCBzcGVlZCwgPykKCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiIHx8ICQuZnguc3BlZWRzWyBvcHRpb25zIF0gKSB7CgkJY2FsbGJhY2sgPSBzcGVlZDsKCQlzcGVlZCA9IG9wdGlvbnM7CgkJb3B0aW9ucyA9IHt9OwoJfQoKCS8vIENhdGNoIChlZmZlY3QsIG9wdGlvbnMsIGNhbGxiYWNrKQoJaWYgKCAkLmlzRnVuY3Rpb24oIHNwZWVkICkgKSB7CgkJY2FsbGJhY2sgPSBzcGVlZDsKCQlzcGVlZCA9IG51bGw7Cgl9CgoJLy8gQWRkIG9wdGlvbnMgdG8gZWZmZWN0CglpZiAoIG9wdGlvbnMgKSB7CgkJJC5leHRlbmQoIGVmZmVjdCwgb3B0aW9ucyApOwoJfQoKCXNwZWVkID0gc3BlZWQgfHwgb3B0aW9ucy5kdXJhdGlvbjsKCWVmZmVjdC5kdXJhdGlvbiA9ICQuZngub2ZmID8gMCA6CgkJdHlwZW9mIHNwZWVkID09PSAibnVtYmVyIiA\/IHNwZWVkIDoKCQlzcGVlZCBpbiAkLmZ4LnNwZWVkcyA\/ICQuZnguc3BlZWRzWyBzcGVlZCBdIDoKCQkkLmZ4LnNwZWVkcy5fZGVmYXVsdDsKCgllZmZlY3QuY29tcGxldGUgPSBjYWxsYmFjayB8fCBvcHRpb25zLmNvbXBsZXRlOwoKCXJldHVybiBlZmZlY3Q7Cn0KCmZ1bmN0aW9uIHN0YW5kYXJkQW5pbWF0aW9uT3B0aW9uKCBvcHRpb24gKSB7CgoJLy8gVmFsaWQgc3RhbmRhcmQgc3BlZWRzIChub3RoaW5nLCBudW1iZXIsIG5hbWVkIHNwZWVkKQoJaWYgKCAhb3B0aW9uIHx8IHR5cGVvZiBvcHRpb24gPT09ICJudW1iZXIiIHx8ICQuZnguc3BlZWRzWyBvcHRpb24gXSApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCgkvLyBJbnZhbGlkIHN0cmluZ3MgLSB0cmVhdCBhcyAibm9ybWFsIiBzcGVlZAoJaWYgKCB0eXBlb2Ygb3B0aW9uID09PSAic3RyaW5nIiAmJiAhJC5lZmZlY3RzLmVmZmVjdFsgb3B0aW9uIF0gKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8gQ29tcGxldGUgY2FsbGJhY2sKCWlmICggJC5pc0Z1bmN0aW9uKCBvcHRpb24gKSApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCgkvLyBPcHRpb25zIGhhc2ggKGJ1dCBub3QgbmFtaW5nIGFuIGVmZmVjdCkKCWlmICggdHlwZW9mIG9wdGlvbiA9PT0gIm9iamVjdCIgJiYgIW9wdGlvbi5lZmZlY3QgKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJLy8gRGlkbid0IG1hdGNoIGFueSBzdGFuZGFyZCBBUEkKCXJldHVybiBmYWxzZTsKfQoKJC5mbi5leHRlbmQoIHsKCWVmZmVjdDogZnVuY3Rpb24oIC8qIGVmZmVjdCwgb3B0aW9ucywgc3BlZWQsIGNhbGxiYWNrICovICkgewoJCXZhciBhcmdzID0gX25vcm1hbGl6ZUFyZ3VtZW50cy5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCWVmZmVjdE1ldGhvZCA9ICQuZWZmZWN0cy5lZmZlY3RbIGFyZ3MuZWZmZWN0IF0sCgkJCWRlZmF1bHRNb2RlID0gZWZmZWN0TWV0aG9kLm1vZGUsCgkJCXF1ZXVlID0gYXJncy5xdWV1ZSwKCQkJcXVldWVOYW1lID0gcXVldWUgfHwgImZ4IiwKCQkJY29tcGxldGUgPSBhcmdzLmNvbXBsZXRlLAoJCQltb2RlID0gYXJncy5tb2RlLAoJCQltb2RlcyA9IFtdLAoJCQlwcmVmaWx0ZXIgPSBmdW5jdGlvbiggbmV4dCApIHsKCQkJCXZhciBlbCA9ICQoIHRoaXMgKSwKCQkJCQlub3JtYWxpemVkTW9kZSA9ICQuZWZmZWN0cy5tb2RlKCBlbCwgbW9kZSApIHx8IGRlZmF1bHRNb2RlOwoKCQkJCS8vIFNlbnRpbmVsIGZvciBkdWNrLXB1bmNoaW5nIHRoZSA6YW5pbWF0ZWQgcHN1ZWRvLXNlbGVjdG9yCgkJCQllbC5kYXRhKCBkYXRhU3BhY2VBbmltYXRlZCwgdHJ1ZSApOwoKCQkJCS8vIFNhdmUgZWZmZWN0IG1vZGUgZm9yIGxhdGVyIHVzZSwKCQkJCS8vIHdlIGNhbid0IGp1c3QgY2FsbCAkLmVmZmVjdHMubW9kZSBhZ2FpbiBsYXRlciwKCQkJCS8vIGFzIHRoZSAuc2hvdygpIGJlbG93IGRlc3Ryb3lzIHRoZSBpbml0aWFsIHN0YXRlCgkJCQltb2Rlcy5wdXNoKCBub3JtYWxpemVkTW9kZSApOwoKCQkJCS8vIFNlZSAkLnVpQmFja0NvbXBhdCBpbnNpZGUgb2YgcnVuKCkgZm9yIHJlbW92YWwgb2YgZGVmYXVsdE1vZGUgaW4gMS4xMwoJCQkJaWYgKCBkZWZhdWx0TW9kZSAmJiAoIG5vcm1hbGl6ZWRNb2RlID09PSAic2hvdyIgfHwKCQkJCQkJKCBub3JtYWxpemVkTW9kZSA9PT0gZGVmYXVsdE1vZGUgJiYgbm9ybWFsaXplZE1vZGUgPT09ICJoaWRlIiApICkgKSB7CgkJCQkJZWwuc2hvdygpOwoJCQkJfQoKCQkJCWlmICggIWRlZmF1bHRNb2RlIHx8IG5vcm1hbGl6ZWRNb2RlICE9PSAibm9uZSIgKSB7CgkJCQkJJC5lZmZlY3RzLnNhdmVTdHlsZSggZWwgKTsKCQkJCX0KCgkJCQlpZiAoICQuaXNGdW5jdGlvbiggbmV4dCApICkgewoJCQkJCW5leHQoKTsKCQkJCX0KCQkJfTsKCgkJaWYgKCAkLmZ4Lm9mZiB8fCAhZWZmZWN0TWV0aG9kICkgewoKCQkJLy8gRGVsZWdhdGUgdG8gdGhlIG9yaWdpbmFsIG1ldGhvZCAoZS5nLiwgLnNob3coKSkgaWYgcG9zc2libGUKCQkJaWYgKCBtb2RlICkgewoJCQkJcmV0dXJuIHRoaXNbIG1vZGUgXSggYXJncy5kdXJhdGlvbiwgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggY29tcGxldGUgKSB7CgkJCQkJCWNvbXBsZXRlLmNhbGwoIHRoaXMgKTsKCQkJCQl9CgkJCQl9ICk7CgkJCX0KCQl9CgoJCWZ1bmN0aW9uIHJ1biggbmV4dCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzICk7CgoJCQlmdW5jdGlvbiBjbGVhbnVwKCkgewoJCQkJZWxlbS5yZW1vdmVEYXRhKCBkYXRhU3BhY2VBbmltYXRlZCApOwoKCQkJCSQuZWZmZWN0cy5jbGVhblVwKCBlbGVtICk7CgoJCQkJaWYgKCBhcmdzLm1vZGUgPT09ICJoaWRlIiApIHsKCQkJCQllbGVtLmhpZGUoKTsKCQkJCX0KCgkJCQlkb25lKCk7CgkJCX0KCgkJCWZ1bmN0aW9uIGRvbmUoKSB7CgkJCQlpZiAoICQuaXNGdW5jdGlvbiggY29tcGxldGUgKSApIHsKCQkJCQljb21wbGV0ZS5jYWxsKCBlbGVtWyAwIF0gKTsKCQkJCX0KCgkJCQlpZiAoICQuaXNGdW5jdGlvbiggbmV4dCApICkgewoJCQkJCW5leHQoKTsKCQkJCX0KCQkJfQoKCQkJLy8gT3ZlcnJpZGUgbW9kZSBvcHRpb24gb24gYSBwZXIgZWxlbWVudCBiYXNpcywKCQkJLy8gYXMgdG9nZ2xlIGNhbiBiZSBlaXRoZXIgc2hvdyBvciBoaWRlIGRlcGVuZGluZyBvbiBlbGVtZW50IHN0YXRlCgkJCWFyZ3MubW9kZSA9IG1vZGVzLnNoaWZ0KCk7CgoJCQlpZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSAmJiAhZGVmYXVsdE1vZGUgKSB7CgkJCQlpZiAoIGVsZW0uaXMoICI6aGlkZGVuIiApID8gbW9kZSA9PT0gImhpZGUiIDogbW9kZSA9PT0gInNob3ciICkgewoKCQkJCQkvLyBDYWxsIHRoZSBjb3JlIG1ldGhvZCB0byB0cmFjayAib2xkZGlzcGxheSIgcHJvcGVybHkKCQkJCQllbGVtWyBtb2RlIF0oKTsKCQkJCQlkb25lKCk7CgkJCQl9IGVsc2UgewoJCQkJCWVmZmVjdE1ldGhvZC5jYWxsKCBlbGVtWyAwIF0sIGFyZ3MsIGRvbmUgKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWlmICggYXJncy5tb2RlID09PSAibm9uZSIgKSB7CgoJCQkJCS8vIENhbGwgdGhlIGNvcmUgbWV0aG9kIHRvIHRyYWNrICJvbGRkaXNwbGF5IiBwcm9wZXJseQoJCQkJCWVsZW1bIG1vZGUgXSgpOwoJCQkJCWRvbmUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJZWZmZWN0TWV0aG9kLmNhbGwoIGVsZW1bIDAgXSwgYXJncywgY2xlYW51cCApOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBSdW4gcHJlZmlsdGVyIG9uIGFsbCBlbGVtZW50cyBmaXJzdCB0byBlbnN1cmUgdGhhdAoJCS8vIGFueSBzaG93aW5nIG9yIGhpZGluZyBoYXBwZW5zIGJlZm9yZSBwbGFjZWhvbGRlciBjcmVhdGlvbiwKCQkvLyB3aGljaCBlbnN1cmVzIHRoYXQgYW55IGxheW91dCBjaGFuZ2VzIGFyZSBjb3JyZWN0bHkgY2FwdHVyZWQuCgkJcmV0dXJuIHF1ZXVlID09PSBmYWxzZSA\/CgkJCXRoaXMuZWFjaCggcHJlZmlsdGVyICkuZWFjaCggcnVuICkgOgoJCQl0aGlzLnF1ZXVlKCBxdWV1ZU5hbWUsIHByZWZpbHRlciApLnF1ZXVlKCBxdWV1ZU5hbWUsIHJ1biApOwoJfSwKCglzaG93OiAoIGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggb3B0aW9uICkgewoJCQlpZiAoIHN0YW5kYXJkQW5pbWF0aW9uT3B0aW9uKCBvcHRpb24gKSApIHsKCQkJCXJldHVybiBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfSBlbHNlIHsKCQkJCXZhciBhcmdzID0gX25vcm1hbGl6ZUFyZ3VtZW50cy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQlhcmdzLm1vZGUgPSAic2hvdyI7CgkJCQlyZXR1cm4gdGhpcy5lZmZlY3QuY2FsbCggdGhpcywgYXJncyApOwoJCQl9CgkJfTsKCX0gKSggJC5mbi5zaG93ICksCgoJaGlkZTogKCBmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbiApIHsKCQkJaWYgKCBzdGFuZGFyZEFuaW1hdGlvbk9wdGlvbiggb3B0aW9uICkgKSB7CgkJCQlyZXR1cm4gb3JpZy5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX0gZWxzZSB7CgkJCQl2YXIgYXJncyA9IF9ub3JtYWxpemVBcmd1bWVudHMuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJYXJncy5tb2RlID0gImhpZGUiOwoJCQkJcmV0dXJuIHRoaXMuZWZmZWN0LmNhbGwoIHRoaXMsIGFyZ3MgKTsKCQkJfQoJCX07Cgl9ICkoICQuZm4uaGlkZSApLAoKCXRvZ2dsZTogKCBmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbiApIHsKCQkJaWYgKCBzdGFuZGFyZEFuaW1hdGlvbk9wdGlvbiggb3B0aW9uICkgfHwgdHlwZW9mIG9wdGlvbiA9PT0gImJvb2xlYW4iICkgewoJCQkJcmV0dXJuIG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9IGVsc2UgewoJCQkJdmFyIGFyZ3MgPSBfbm9ybWFsaXplQXJndW1lbnRzLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCWFyZ3MubW9kZSA9ICJ0b2dnbGUiOwoJCQkJcmV0dXJuIHRoaXMuZWZmZWN0LmNhbGwoIHRoaXMsIGFyZ3MgKTsKCQkJfQoJCX07Cgl9ICkoICQuZm4udG9nZ2xlICksCgoJY3NzVW5pdDogZnVuY3Rpb24oIGtleSApIHsKCQl2YXIgc3R5bGUgPSB0aGlzLmNzcygga2V5ICksCgkJCXZhbCA9IFtdOwoKCQkkLmVhY2goIFsgImVtIiwgInB4IiwgIiUiLCAicHQiIF0sIGZ1bmN0aW9uKCBpLCB1bml0ICkgewoJCQlpZiAoIHN0eWxlLmluZGV4T2YoIHVuaXQgKSA+IDAgKSB7CgkJCQl2YWwgPSBbIHBhcnNlRmxvYXQoIHN0eWxlICksIHVuaXQgXTsKCQkJfQoJCX0gKTsKCQlyZXR1cm4gdmFsOwoJfSwKCgljc3NDbGlwOiBmdW5jdGlvbiggY2xpcE9iaiApIHsKCQlpZiAoIGNsaXBPYmogKSB7CgkJCXJldHVybiB0aGlzLmNzcyggImNsaXAiLCAicmVjdCgiICsgY2xpcE9iai50b3AgKyAicHggIiArIGNsaXBPYmoucmlnaHQgKyAicHggIiArCgkJCQljbGlwT2JqLmJvdHRvbSArICJweCAiICsgY2xpcE9iai5sZWZ0ICsgInB4KSIgKTsKCQl9CgkJcmV0dXJuIHBhcnNlQ2xpcCggdGhpcy5jc3MoICJjbGlwIiApLCB0aGlzICk7Cgl9LAoKCXRyYW5zZmVyOiBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwKCQkJdGFyZ2V0ID0gJCggb3B0aW9ucy50byApLAoJCQl0YXJnZXRGaXhlZCA9IHRhcmdldC5jc3MoICJwb3NpdGlvbiIgKSA9PT0gImZpeGVkIiwKCQkJYm9keSA9ICQoICJib2R5IiApLAoJCQlmaXhUb3AgPSB0YXJnZXRGaXhlZCA\/IGJvZHkuc2Nyb2xsVG9wKCkgOiAwLAoJCQlmaXhMZWZ0ID0gdGFyZ2V0Rml4ZWQgPyBib2R5LnNjcm9sbExlZnQoKSA6IDAsCgkJCWVuZFBvc2l0aW9uID0gdGFyZ2V0Lm9mZnNldCgpLAoJCQlhbmltYXRpb24gPSB7CgkJCQl0b3A6IGVuZFBvc2l0aW9uLnRvcCAtIGZpeFRvcCwKCQkJCWxlZnQ6IGVuZFBvc2l0aW9uLmxlZnQgLSBmaXhMZWZ0LAoJCQkJaGVpZ2h0OiB0YXJnZXQuaW5uZXJIZWlnaHQoKSwKCQkJCXdpZHRoOiB0YXJnZXQuaW5uZXJXaWR0aCgpCgkJCX0sCgkJCXN0YXJ0UG9zaXRpb24gPSBlbGVtZW50Lm9mZnNldCgpLAoJCQl0cmFuc2ZlciA9ICQoICI8ZGl2IGNsYXNzPSd1aS1lZmZlY3RzLXRyYW5zZmVyJz48L2Rpdj4iICkKCQkJCS5hcHBlbmRUbyggImJvZHkiICkKCQkJCS5hZGRDbGFzcyggb3B0aW9ucy5jbGFzc05hbWUgKQoJCQkJLmNzcyggewoJCQkJCXRvcDogc3RhcnRQb3NpdGlvbi50b3AgLSBmaXhUb3AsCgkJCQkJbGVmdDogc3RhcnRQb3NpdGlvbi5sZWZ0IC0gZml4TGVmdCwKCQkJCQloZWlnaHQ6IGVsZW1lbnQuaW5uZXJIZWlnaHQoKSwKCQkJCQl3aWR0aDogZWxlbWVudC5pbm5lcldpZHRoKCksCgkJCQkJcG9zaXRpb246IHRhcmdldEZpeGVkID8gImZpeGVkIiA6ICJhYnNvbHV0ZSIKCQkJCX0gKQoJCQkJLmFuaW1hdGUoIGFuaW1hdGlvbiwgb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGZ1bmN0aW9uKCkgewoJCQkJCXRyYW5zZmVyLnJlbW92ZSgpOwoJCQkJCWlmICggJC5pc0Z1bmN0aW9uKCBkb25lICkgKSB7CgkJCQkJCWRvbmUoKTsKCQkJCQl9CgkJCQl9ICk7Cgl9Cn0gKTsKCmZ1bmN0aW9uIHBhcnNlQ2xpcCggc3RyLCBlbGVtZW50ICkgewoJCXZhciBvdXRlcldpZHRoID0gZWxlbWVudC5vdXRlcldpZHRoKCksCgkJCW91dGVySGVpZ2h0ID0gZWxlbWVudC5vdXRlckhlaWdodCgpLAoJCQljbGlwUmVnZXggPSAvXnJlY3RcKCgtP1xkKlwuP1xkKnB4fC0\/XGQrJXxhdXRvKSw\/XHMqKC0\/XGQqXC4\/XGQqcHh8LT9cZCslfGF1dG8pLD9ccyooLT9cZCpcLj9cZCpweHwtP1xkKyV8YXV0byksP1xzKigtP1xkKlwuP1xkKnB4fC0\/XGQrJXxhdXRvKVwpJC8sCgkJCXZhbHVlcyA9IGNsaXBSZWdleC5leGVjKCBzdHIgKSB8fCBbICIiLCAwLCBvdXRlcldpZHRoLCBvdXRlckhlaWdodCwgMCBdOwoKCQlyZXR1cm4gewoJCQl0b3A6IHBhcnNlRmxvYXQoIHZhbHVlc1sgMSBdICkgfHwgMCwKCQkJcmlnaHQ6IHZhbHVlc1sgMiBdID09PSAiYXV0byIgPyBvdXRlcldpZHRoIDogcGFyc2VGbG9hdCggdmFsdWVzWyAyIF0gKSwKCQkJYm90dG9tOiB2YWx1ZXNbIDMgXSA9PT0gImF1dG8iID8gb3V0ZXJIZWlnaHQgOiBwYXJzZUZsb2F0KCB2YWx1ZXNbIDMgXSApLAoJCQlsZWZ0OiBwYXJzZUZsb2F0KCB2YWx1ZXNbIDQgXSApIHx8IDAKCQl9Owp9CgokLmZ4LnN0ZXAuY2xpcCA9IGZ1bmN0aW9uKCBmeCApIHsKCWlmICggIWZ4LmNsaXBJbml0ICkgewoJCWZ4LnN0YXJ0ID0gJCggZnguZWxlbSApLmNzc0NsaXAoKTsKCQlpZiAoIHR5cGVvZiBmeC5lbmQgPT09ICJzdHJpbmciICkgewoJCQlmeC5lbmQgPSBwYXJzZUNsaXAoIGZ4LmVuZCwgZnguZWxlbSApOwoJCX0KCQlmeC5jbGlwSW5pdCA9IHRydWU7Cgl9CgoJJCggZnguZWxlbSApLmNzc0NsaXAoIHsKCQl0b3A6IGZ4LnBvcyAqICggZnguZW5kLnRvcCAtIGZ4LnN0YXJ0LnRvcCApICsgZnguc3RhcnQudG9wLAoJCXJpZ2h0OiBmeC5wb3MgKiAoIGZ4LmVuZC5yaWdodCAtIGZ4LnN0YXJ0LnJpZ2h0ICkgKyBmeC5zdGFydC5yaWdodCwKCQlib3R0b206IGZ4LnBvcyAqICggZnguZW5kLmJvdHRvbSAtIGZ4LnN0YXJ0LmJvdHRvbSApICsgZnguc3RhcnQuYm90dG9tLAoJCWxlZnQ6IGZ4LnBvcyAqICggZnguZW5kLmxlZnQgLSBmeC5zdGFydC5sZWZ0ICkgKyBmeC5zdGFydC5sZWZ0Cgl9ICk7Cn07Cgp9ICkoKTsKCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiBFQVNJTkcgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCgooIGZ1bmN0aW9uKCkgewoKLy8gQmFzZWQgb24gZWFzaW5nIGVxdWF0aW9ucyBmcm9tIFJvYmVydCBQZW5uZXIgKGh0dHA6Ly93d3cucm9iZXJ0cGVubmVyLmNvbS9lYXNpbmcpCgp2YXIgYmFzZUVhc2luZ3MgPSB7fTsKCiQuZWFjaCggWyAiUXVhZCIsICJDdWJpYyIsICJRdWFydCIsICJRdWludCIsICJFeHBvIiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCWJhc2VFYXNpbmdzWyBuYW1lIF0gPSBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gTWF0aC5wb3coIHAsIGkgKyAyICk7Cgl9Owp9ICk7CgokLmV4dGVuZCggYmFzZUVhc2luZ3MsIHsKCVNpbmU6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiAxIC0gTWF0aC5jb3MoIHAgKiBNYXRoLlBJIC8gMiApOwoJfSwKCUNpcmM6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiAxIC0gTWF0aC5zcXJ0KCAxIC0gcCAqIHAgKTsKCX0sCglFbGFzdGljOiBmdW5jdGlvbiggcCApIHsKCQlyZXR1cm4gcCA9PT0gMCB8fCBwID09PSAxID8gcCA6CgkJCS1NYXRoLnBvdyggMiwgOCAqICggcCAtIDEgKSApICogTWF0aC5zaW4oICggKCBwIC0gMSApICogODAgLSA3LjUgKSAqIE1hdGguUEkgLyAxNSApOwoJfSwKCUJhY2s6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiBwICogcCAqICggMyAqIHAgLSAyICk7Cgl9LAoJQm91bmNlOiBmdW5jdGlvbiggcCApIHsKCQl2YXIgcG93MiwKCQkJYm91bmNlID0gNDsKCgkJd2hpbGUgKCBwIDwgKCAoIHBvdzIgPSBNYXRoLnBvdyggMiwgLS1ib3VuY2UgKSApIC0gMSApIC8gMTEgKSB7fQoJCXJldHVybiAxIC8gTWF0aC5wb3coIDQsIDMgLSBib3VuY2UgKSAtIDcuNTYyNSAqIE1hdGgucG93KCAoIHBvdzIgKiAzIC0gMiApIC8gMjIgLSBwLCAyICk7Cgl9Cn0gKTsKCiQuZWFjaCggYmFzZUVhc2luZ3MsIGZ1bmN0aW9uKCBuYW1lLCBlYXNlSW4gKSB7CgkkLmVhc2luZ1sgImVhc2VJbiIgKyBuYW1lIF0gPSBlYXNlSW47CgkkLmVhc2luZ1sgImVhc2VPdXQiICsgbmFtZSBdID0gZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIDEgLSBlYXNlSW4oIDEgLSBwICk7Cgl9OwoJJC5lYXNpbmdbICJlYXNlSW5PdXQiICsgbmFtZSBdID0gZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIHAgPCAwLjUgPwoJCQllYXNlSW4oIHAgKiAyICkgLyAyIDoKCQkJMSAtIGVhc2VJbiggcCAqIC0yICsgMiApIC8gMjsKCX07Cn0gKTsKCn0gKSgpOwoKdmFyIGVmZmVjdCA9ICQuZWZmZWN0czsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgQmxpbmQgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBCbGluZCBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogQmxpbmRzIHRoZSBlbGVtZW50LgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vYmxpbmQtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdEJsaW5kID0gJC5lZmZlY3RzLmRlZmluZSggImJsaW5kIiwgImhpZGUiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCXZhciBtYXAgPSB7CgkJCXVwOiBbICJib3R0b20iLCAidG9wIiBdLAoJCQl2ZXJ0aWNhbDogWyAiYm90dG9tIiwgInRvcCIgXSwKCQkJZG93bjogWyAidG9wIiwgImJvdHRvbSIgXSwKCQkJbGVmdDogWyAicmlnaHQiLCAibGVmdCIgXSwKCQkJaG9yaXpvbnRhbDogWyAicmlnaHQiLCAibGVmdCIgXSwKCQkJcmlnaHQ6IFsgImxlZnQiLCAicmlnaHQiIF0KCQl9LAoJCWVsZW1lbnQgPSAkKCB0aGlzICksCgkJZGlyZWN0aW9uID0gb3B0aW9ucy5kaXJlY3Rpb24gfHwgInVwIiwKCQlzdGFydCA9IGVsZW1lbnQuY3NzQ2xpcCgpLAoJCWFuaW1hdGUgPSB7IGNsaXA6ICQuZXh0ZW5kKCB7fSwgc3RhcnQgKSB9LAoJCXBsYWNlaG9sZGVyID0gJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7CgoJYW5pbWF0ZS5jbGlwWyBtYXBbIGRpcmVjdGlvbiBdWyAwIF0gXSA9IGFuaW1hdGUuY2xpcFsgbWFwWyBkaXJlY3Rpb24gXVsgMSBdIF07CgoJaWYgKCBvcHRpb25zLm1vZGUgPT09ICJzaG93IiApIHsKCQllbGVtZW50LmNzc0NsaXAoIGFuaW1hdGUuY2xpcCApOwoJCWlmICggcGxhY2Vob2xkZXIgKSB7CgkJCXBsYWNlaG9sZGVyLmNzcyggJC5lZmZlY3RzLmNsaXBUb0JveCggYW5pbWF0ZSApICk7CgkJfQoKCQlhbmltYXRlLmNsaXAgPSBzdGFydDsKCX0KCglpZiAoIHBsYWNlaG9sZGVyICkgewoJCXBsYWNlaG9sZGVyLmFuaW1hdGUoICQuZWZmZWN0cy5jbGlwVG9Cb3goIGFuaW1hdGUgKSwgb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcgKTsKCX0KCgllbGVtZW50LmFuaW1hdGUoIGFuaW1hdGUsIHsKCQlxdWV1ZTogZmFsc2UsCgkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJZWFzaW5nOiBvcHRpb25zLmVhc2luZywKCQljb21wbGV0ZTogZG9uZQoJfSApOwp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIEJvdW5jZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEJvdW5jZSBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogQm91bmNlcyBhbiBlbGVtZW50IGhvcml6b250YWxseSBvciB2ZXJ0aWNhbGx5IG4gdGltZXMuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9ib3VuY2UtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdEJvdW5jZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJib3VuY2UiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCXZhciB1cEFuaW0sIGRvd25BbmltLCByZWZWYWx1ZSwKCQllbGVtZW50ID0gJCggdGhpcyApLAoKCQkvLyBEZWZhdWx0czoKCQltb2RlID0gb3B0aW9ucy5tb2RlLAoJCWhpZGUgPSBtb2RlID09PSAiaGlkZSIsCgkJc2hvdyA9IG1vZGUgPT09ICJzaG93IiwKCQlkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiB8fCAidXAiLAoJCWRpc3RhbmNlID0gb3B0aW9ucy5kaXN0YW5jZSwKCQl0aW1lcyA9IG9wdGlvbnMudGltZXMgfHwgNSwKCgkJLy8gTnVtYmVyIG9mIGludGVybmFsIGFuaW1hdGlvbnMKCQlhbmltcyA9IHRpbWVzICogMiArICggc2hvdyB8fCBoaWRlID8gMSA6IDAgKSwKCQlzcGVlZCA9IG9wdGlvbnMuZHVyYXRpb24gLyBhbmltcywKCQllYXNpbmcgPSBvcHRpb25zLmVhc2luZywKCgkJLy8gVXRpbGl0eToKCQlyZWYgPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJkb3duIiApID8gInRvcCIgOiAibGVmdCIsCgkJbW90aW9uID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAibGVmdCIgKSwKCQlpID0gMCwKCgkJcXVldWVsZW4gPSBlbGVtZW50LnF1ZXVlKCkubGVuZ3RoOwoKCSQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApOwoKCXJlZlZhbHVlID0gZWxlbWVudC5jc3MoIHJlZiApOwoKCS8vIERlZmF1bHQgZGlzdGFuY2UgZm9yIHRoZSBCSUdHRVNUIGJvdW5jZSBpcyB0aGUgb3V0ZXIgRGlzdGFuY2UgLyAzCglpZiAoICFkaXN0YW5jZSApIHsKCQlkaXN0YW5jZSA9IGVsZW1lbnRbIHJlZiA9PT0gInRvcCIgPyAib3V0ZXJIZWlnaHQiIDogIm91dGVyV2lkdGgiIF0oKSAvIDM7Cgl9CgoJaWYgKCBzaG93ICkgewoJCWRvd25BbmltID0geyBvcGFjaXR5OiAxIH07CgkJZG93bkFuaW1bIHJlZiBdID0gcmVmVmFsdWU7CgoJCS8vIElmIHdlIGFyZSBzaG93aW5nLCBmb3JjZSBvcGFjaXR5IDAgYW5kIHNldCB0aGUgaW5pdGlhbCBwb3NpdGlvbgoJCS8vIHRoZW4gZG8gdGhlICJmaXJzdCIgYW5pbWF0aW9uCgkJZWxlbWVudAoJCQkuY3NzKCAib3BhY2l0eSIsIDAgKQoJCQkuY3NzKCByZWYsIG1vdGlvbiA\/IC1kaXN0YW5jZSAqIDIgOiBkaXN0YW5jZSAqIDIgKQoJCQkuYW5pbWF0ZSggZG93bkFuaW0sIHNwZWVkLCBlYXNpbmcgKTsKCX0KCgkvLyBTdGFydCBhdCB0aGUgc21hbGxlc3QgZGlzdGFuY2UgaWYgd2UgYXJlIGhpZGluZwoJaWYgKCBoaWRlICkgewoJCWRpc3RhbmNlID0gZGlzdGFuY2UgLyBNYXRoLnBvdyggMiwgdGltZXMgLSAxICk7Cgl9CgoJZG93bkFuaW0gPSB7fTsKCWRvd25BbmltWyByZWYgXSA9IHJlZlZhbHVlOwoKCS8vIEJvdW5jZXMgdXAvZG93bi9sZWZ0L3JpZ2h0IHRoZW4gYmFjayB0byAwIC0tIHRpbWVzICogMiBhbmltYXRpb25zIGhhcHBlbiBoZXJlCglmb3IgKCA7IGkgPCB0aW1lczsgaSsrICkgewoJCXVwQW5pbSA9IHt9OwoJCXVwQW5pbVsgcmVmIF0gPSAoIG1vdGlvbiA\/ICItPSIgOiAiKz0iICkgKyBkaXN0YW5jZTsKCgkJZWxlbWVudAoJCQkuYW5pbWF0ZSggdXBBbmltLCBzcGVlZCwgZWFzaW5nICkKCQkJLmFuaW1hdGUoIGRvd25BbmltLCBzcGVlZCwgZWFzaW5nICk7CgoJCWRpc3RhbmNlID0gaGlkZSA\/IGRpc3RhbmNlICogMiA6IGRpc3RhbmNlIC8gMjsKCX0KCgkvLyBMYXN0IEJvdW5jZSB3aGVuIEhpZGluZwoJaWYgKCBoaWRlICkgewoJCXVwQW5pbSA9IHsgb3BhY2l0eTogMCB9OwoJCXVwQW5pbVsgcmVmIF0gPSAoIG1vdGlvbiA\/ICItPSIgOiAiKz0iICkgKyBkaXN0YW5jZTsKCgkJZWxlbWVudC5hbmltYXRlKCB1cEFuaW0sIHNwZWVkLCBlYXNpbmcgKTsKCX0KCgllbGVtZW50LnF1ZXVlKCBkb25lICk7CgoJJC5lZmZlY3RzLnVuc2hpZnQoIGVsZW1lbnQsIHF1ZXVlbGVuLCBhbmltcyArIDEgKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBDbGlwIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogQ2xpcCBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogQ2xpcHMgdGhlIGVsZW1lbnQgb24gYW5kIG9mZiBsaWtlIGFuIG9sZCBUVi4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NsaXAtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdENsaXAgPSAkLmVmZmVjdHMuZGVmaW5lKCAiY2xpcCIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7Cgl2YXIgc3RhcnQsCgkJYW5pbWF0ZSA9IHt9LAoJCWVsZW1lbnQgPSAkKCB0aGlzICksCgkJZGlyZWN0aW9uID0gb3B0aW9ucy5kaXJlY3Rpb24gfHwgInZlcnRpY2FsIiwKCQlib3RoID0gZGlyZWN0aW9uID09PSAiYm90aCIsCgkJaG9yaXpvbnRhbCA9IGJvdGggfHwgZGlyZWN0aW9uID09PSAiaG9yaXpvbnRhbCIsCgkJdmVydGljYWwgPSBib3RoIHx8IGRpcmVjdGlvbiA9PT0gInZlcnRpY2FsIjsKCglzdGFydCA9IGVsZW1lbnQuY3NzQ2xpcCgpOwoJYW5pbWF0ZS5jbGlwID0gewoJCXRvcDogdmVydGljYWwgPyAoIHN0YXJ0LmJvdHRvbSAtIHN0YXJ0LnRvcCApIC8gMiA6IHN0YXJ0LnRvcCwKCQlyaWdodDogaG9yaXpvbnRhbCA\/ICggc3RhcnQucmlnaHQgLSBzdGFydC5sZWZ0ICkgLyAyIDogc3RhcnQucmlnaHQsCgkJYm90dG9tOiB2ZXJ0aWNhbCA\/ICggc3RhcnQuYm90dG9tIC0gc3RhcnQudG9wICkgLyAyIDogc3RhcnQuYm90dG9tLAoJCWxlZnQ6IGhvcml6b250YWwgPyAoIHN0YXJ0LnJpZ2h0IC0gc3RhcnQubGVmdCApIC8gMiA6IHN0YXJ0LmxlZnQKCX07CgoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7CgoJaWYgKCBvcHRpb25zLm1vZGUgPT09ICJzaG93IiApIHsKCQllbGVtZW50LmNzc0NsaXAoIGFuaW1hdGUuY2xpcCApOwoJCWFuaW1hdGUuY2xpcCA9IHN0YXJ0OwoJfQoKCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0ZSwgewoJCXF1ZXVlOiBmYWxzZSwKCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLAoJCWNvbXBsZXRlOiBkb25lCgl9ICk7Cgp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIERyb3AgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBEcm9wIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBNb3ZlcyBhbiBlbGVtZW50IGluIG9uZSBkaXJlY3Rpb24gYW5kIGhpZGVzIGl0IGF0IHRoZSBzYW1lIHRpbWUuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9kcm9wLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3REcm9wID0gJC5lZmZlY3RzLmRlZmluZSggImRyb3AiLCAiaGlkZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoKCXZhciBkaXN0YW5jZSwKCQllbGVtZW50ID0gJCggdGhpcyApLAoJCW1vZGUgPSBvcHRpb25zLm1vZGUsCgkJc2hvdyA9IG1vZGUgPT09ICJzaG93IiwKCQlkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiB8fCAibGVmdCIsCgkJcmVmID0gKCBkaXJlY3Rpb24gPT09ICJ1cCIgfHwgZGlyZWN0aW9uID09PSAiZG93biIgKSA\/ICJ0b3AiIDogImxlZnQiLAoJCW1vdGlvbiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImxlZnQiICkgPyAiLT0iIDogIis9IiwKCQlvcHBvc2l0ZU1vdGlvbiA9ICggbW90aW9uID09PSAiKz0iICkgPyAiLT0iIDogIis9IiwKCQlhbmltYXRpb24gPSB7CgkJCW9wYWNpdHk6IDAKCQl9OwoKCSQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApOwoKCWRpc3RhbmNlID0gb3B0aW9ucy5kaXN0YW5jZSB8fAoJCWVsZW1lbnRbIHJlZiA9PT0gInRvcCIgPyAib3V0ZXJIZWlnaHQiIDogIm91dGVyV2lkdGgiIF0oIHRydWUgKSAvIDI7CgoJYW5pbWF0aW9uWyByZWYgXSA9IG1vdGlvbiArIGRpc3RhbmNlOwoKCWlmICggc2hvdyApIHsKCQllbGVtZW50LmNzcyggYW5pbWF0aW9uICk7CgoJCWFuaW1hdGlvblsgcmVmIF0gPSBvcHBvc2l0ZU1vdGlvbiArIGRpc3RhbmNlOwoJCWFuaW1hdGlvbi5vcGFjaXR5ID0gMTsKCX0KCgkvLyBBbmltYXRlCgllbGVtZW50LmFuaW1hdGUoIGFuaW1hdGlvbiwgewoJCXF1ZXVlOiBmYWxzZSwKCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLAoJCWNvbXBsZXRlOiBkb25lCgl9ICk7Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgRXhwbG9kZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEV4cGxvZGUgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLyBqc2NzOmRpc2FibGUgbWF4aW11bUxpbmVMZW5ndGgKLy8+PmRlc2NyaXB0aW9uOiBFeHBsb2RlcyBhbiBlbGVtZW50IGluIGFsbCBkaXJlY3Rpb25zIGludG8gbiBwaWVjZXMuIEltcGxvZGVzIGFuIGVsZW1lbnQgdG8gaXRzIG9yaWdpbmFsIHdob2xlbmVzcy4KLy8ganNjczplbmFibGUgbWF4aW11bUxpbmVMZW5ndGgKLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2V4cGxvZGUtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdEV4cGxvZGUgPSAkLmVmZmVjdHMuZGVmaW5lKCAiZXhwbG9kZSIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7CgoJdmFyIGksIGosIGxlZnQsIHRvcCwgbXgsIG15LAoJCXJvd3MgPSBvcHRpb25zLnBpZWNlcyA\/IE1hdGgucm91bmQoIE1hdGguc3FydCggb3B0aW9ucy5waWVjZXMgKSApIDogMywKCQljZWxscyA9IHJvd3MsCgkJZWxlbWVudCA9ICQoIHRoaXMgKSwKCQltb2RlID0gb3B0aW9ucy5tb2RlLAoJCXNob3cgPSBtb2RlID09PSAic2hvdyIsCgoJCS8vIFNob3cgYW5kIHRoZW4gdmlzaWJpbGl0eTpoaWRkZW4gdGhlIGVsZW1lbnQgYmVmb3JlIGNhbGN1bGF0aW5nIG9mZnNldAoJCW9mZnNldCA9IGVsZW1lbnQuc2hvdygpLmNzcyggInZpc2liaWxpdHkiLCAiaGlkZGVuIiApLm9mZnNldCgpLAoKCQkvLyBXaWR0aCBhbmQgaGVpZ2h0IG9mIGEgcGllY2UKCQl3aWR0aCA9IE1hdGguY2VpbCggZWxlbWVudC5vdXRlcldpZHRoKCkgLyBjZWxscyApLAoJCWhlaWdodCA9IE1hdGguY2VpbCggZWxlbWVudC5vdXRlckhlaWdodCgpIC8gcm93cyApLAoJCXBpZWNlcyA9IFtdOwoKCS8vIENoaWxkcmVuIGFuaW1hdGUgY29tcGxldGU6CglmdW5jdGlvbiBjaGlsZENvbXBsZXRlKCkgewoJCXBpZWNlcy5wdXNoKCB0aGlzICk7CgkJaWYgKCBwaWVjZXMubGVuZ3RoID09PSByb3dzICogY2VsbHMgKSB7CgkJCWFuaW1Db21wbGV0ZSgpOwoJCX0KCX0KCgkvLyBDbG9uZSB0aGUgZWxlbWVudCBmb3IgZWFjaCByb3cgYW5kIGNlbGwuCglmb3IgKCBpID0gMDsgaSA8IHJvd3M7IGkrKyApIHsgLy8gPT09PgoJCXRvcCA9IG9mZnNldC50b3AgKyBpICogaGVpZ2h0OwoJCW15ID0gaSAtICggcm93cyAtIDEgKSAvIDI7CgoJCWZvciAoIGogPSAwOyBqIDwgY2VsbHM7IGorKyApIHsgLy8gfHx8CgkJCWxlZnQgPSBvZmZzZXQubGVmdCArIGogKiB3aWR0aDsKCQkJbXggPSBqIC0gKCBjZWxscyAtIDEgKSAvIDI7CgoJCQkvLyBDcmVhdGUgYSBjbG9uZSBvZiB0aGUgbm93IGhpZGRlbiBtYWluIGVsZW1lbnQgdGhhdCB3aWxsIGJlIGFic29sdXRlIHBvc2l0aW9uZWQKCQkJLy8gd2l0aGluIGEgd3JhcHBlciBkaXYgb2ZmIHRoZSAtbGVmdCBhbmQgLXRvcCBlcXVhbCB0byBzaXplIG9mIG91ciBwaWVjZXMKCQkJZWxlbWVudAoJCQkJLmNsb25lKCkKCQkJCS5hcHBlbmRUbyggImJvZHkiICkKCQkJCS53cmFwKCAiPGRpdj48L2Rpdj4iICkKCQkJCS5jc3MoIHsKCQkJCQlwb3NpdGlvbjogImFic29sdXRlIiwKCQkJCQl2aXNpYmlsaXR5OiAidmlzaWJsZSIsCgkJCQkJbGVmdDogLWogKiB3aWR0aCwKCQkJCQl0b3A6IC1pICogaGVpZ2h0CgkJCQl9ICkKCgkJCQkvLyBTZWxlY3QgdGhlIHdyYXBwZXIgLSBtYWtlIGl0IG92ZXJmbG93OiBoaWRkZW4gYW5kIGFic29sdXRlIHBvc2l0aW9uZWQgYmFzZWQgb24KCQkJCS8vIHdoZXJlIHRoZSBvcmlnaW5hbCB3YXMgbG9jYXRlZCArbGVmdCBhbmQgK3RvcCBlcXVhbCB0byB0aGUgc2l6ZSBvZiBwaWVjZXMKCQkJCS5wYXJlbnQoKQoJCQkJCS5hZGRDbGFzcyggInVpLWVmZmVjdHMtZXhwbG9kZSIgKQoJCQkJCS5jc3MoIHsKCQkJCQkJcG9zaXRpb246ICJhYnNvbHV0ZSIsCgkJCQkJCW92ZXJmbG93OiAiaGlkZGVuIiwKCQkJCQkJd2lkdGg6IHdpZHRoLAoJCQkJCQloZWlnaHQ6IGhlaWdodCwKCQkJCQkJbGVmdDogbGVmdCArICggc2hvdyA\/IG14ICogd2lkdGggOiAwICksCgkJCQkJCXRvcDogdG9wICsgKCBzaG93ID8gbXkgKiBoZWlnaHQgOiAwICksCgkJCQkJCW9wYWNpdHk6IHNob3cgPyAwIDogMQoJCQkJCX0gKQoJCQkJCS5hbmltYXRlKCB7CgkJCQkJCWxlZnQ6IGxlZnQgKyAoIHNob3cgPyAwIDogbXggKiB3aWR0aCApLAoJCQkJCQl0b3A6IHRvcCArICggc2hvdyA\/IDAgOiBteSAqIGhlaWdodCApLAoJCQkJCQlvcGFjaXR5OiBzaG93ID8gMSA6IDAKCQkJCQl9LCBvcHRpb25zLmR1cmF0aW9uIHx8IDUwMCwgb3B0aW9ucy5lYXNpbmcsIGNoaWxkQ29tcGxldGUgKTsKCQl9Cgl9CgoJZnVuY3Rpb24gYW5pbUNvbXBsZXRlKCkgewoJCWVsZW1lbnQuY3NzKCB7CgkJCXZpc2liaWxpdHk6ICJ2aXNpYmxlIgoJCX0gKTsKCQkkKCBwaWVjZXMgKS5yZW1vdmUoKTsKCQlkb25lKCk7Cgl9Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgRmFkZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEZhZGUgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IEZhZGVzIHRoZSBlbGVtZW50LgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZmFkZS1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0RmFkZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJmYWRlIiwgInRvZ2dsZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoJdmFyIHNob3cgPSBvcHRpb25zLm1vZGUgPT09ICJzaG93IjsKCgkkKCB0aGlzICkKCQkuY3NzKCAib3BhY2l0eSIsIHNob3cgPyAwIDogMSApCgkJLmFuaW1hdGUoIHsKCQkJb3BhY2l0eTogc2hvdyA\/IDEgOiAwCgkJfSwgewoJCQlxdWV1ZTogZmFsc2UsCgkJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLAoJCQljb21wbGV0ZTogZG9uZQoJCX0gKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBGb2xkIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogRm9sZCBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogRm9sZHMgYW4gZWxlbWVudCBmaXJzdCBob3Jpem9udGFsbHkgYW5kIHRoZW4gdmVydGljYWxseS4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2ZvbGQtZWZmZWN0LwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vZWZmZWN0LwoKCgp2YXIgZWZmZWN0c0VmZmVjdEZvbGQgPSAkLmVmZmVjdHMuZGVmaW5lKCAiZm9sZCIsICJoaWRlIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7CgoJLy8gQ3JlYXRlIGVsZW1lbnQKCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCW1vZGUgPSBvcHRpb25zLm1vZGUsCgkJc2hvdyA9IG1vZGUgPT09ICJzaG93IiwKCQloaWRlID0gbW9kZSA9PT0gImhpZGUiLAoJCXNpemUgPSBvcHRpb25zLnNpemUgfHwgMTUsCgkJcGVyY2VudCA9IC8oWzAtOV0rKSUvLmV4ZWMoIHNpemUgKSwKCQlob3JpekZpcnN0ID0gISFvcHRpb25zLmhvcml6Rmlyc3QsCgkJcmVmID0gaG9yaXpGaXJzdCA\/IFsgInJpZ2h0IiwgImJvdHRvbSIgXSA6IFsgImJvdHRvbSIsICJyaWdodCIgXSwKCQlkdXJhdGlvbiA9IG9wdGlvbnMuZHVyYXRpb24gLyAyLAoKCQlwbGFjZWhvbGRlciA9ICQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApLAoKCQlzdGFydCA9IGVsZW1lbnQuY3NzQ2xpcCgpLAoJCWFuaW1hdGlvbjEgPSB7IGNsaXA6ICQuZXh0ZW5kKCB7fSwgc3RhcnQgKSB9LAoJCWFuaW1hdGlvbjIgPSB7IGNsaXA6ICQuZXh0ZW5kKCB7fSwgc3RhcnQgKSB9LAoKCQlkaXN0YW5jZSA9IFsgc3RhcnRbIHJlZlsgMCBdIF0sIHN0YXJ0WyByZWZbIDEgXSBdIF0sCgoJCXF1ZXVlbGVuID0gZWxlbWVudC5xdWV1ZSgpLmxlbmd0aDsKCglpZiAoIHBlcmNlbnQgKSB7CgkJc2l6ZSA9IHBhcnNlSW50KCBwZXJjZW50WyAxIF0sIDEwICkgLyAxMDAgKiBkaXN0YW5jZVsgaGlkZSA\/IDAgOiAxIF07Cgl9CglhbmltYXRpb24xLmNsaXBbIHJlZlsgMCBdIF0gPSBzaXplOwoJYW5pbWF0aW9uMi5jbGlwWyByZWZbIDAgXSBdID0gc2l6ZTsKCWFuaW1hdGlvbjIuY2xpcFsgcmVmWyAxIF0gXSA9IDA7CgoJaWYgKCBzaG93ICkgewoJCWVsZW1lbnQuY3NzQ2xpcCggYW5pbWF0aW9uMi5jbGlwICk7CgkJaWYgKCBwbGFjZWhvbGRlciApIHsKCQkJcGxhY2Vob2xkZXIuY3NzKCAkLmVmZmVjdHMuY2xpcFRvQm94KCBhbmltYXRpb24yICkgKTsKCQl9CgoJCWFuaW1hdGlvbjIuY2xpcCA9IHN0YXJ0OwoJfQoKCS8vIEFuaW1hdGUKCWVsZW1lbnQKCQkucXVldWUoIGZ1bmN0aW9uKCBuZXh0ICkgewoJCQlpZiAoIHBsYWNlaG9sZGVyICkgewoJCQkJcGxhY2Vob2xkZXIKCQkJCQkuYW5pbWF0ZSggJC5lZmZlY3RzLmNsaXBUb0JveCggYW5pbWF0aW9uMSApLCBkdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcgKQoJCQkJCS5hbmltYXRlKCAkLmVmZmVjdHMuY2xpcFRvQm94KCBhbmltYXRpb24yICksIGR1cmF0aW9uLCBvcHRpb25zLmVhc2luZyApOwoJCQl9CgoJCQluZXh0KCk7CgkJfSApCgkJLmFuaW1hdGUoIGFuaW1hdGlvbjEsIGR1cmF0aW9uLCBvcHRpb25zLmVhc2luZyApCgkJLmFuaW1hdGUoIGFuaW1hdGlvbjIsIGR1cmF0aW9uLCBvcHRpb25zLmVhc2luZyApCgkJLnF1ZXVlKCBkb25lICk7CgoJJC5lZmZlY3RzLnVuc2hpZnQoIGVsZW1lbnQsIHF1ZXVlbGVuLCA0ICk7Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgSGlnaGxpZ2h0IDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogSGlnaGxpZ2h0IEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBIaWdobGlnaHRzIHRoZSBiYWNrZ3JvdW5kIG9mIGFuIGVsZW1lbnQgaW4gYSBkZWZpbmVkIGNvbG9yIGZvciBhIGN1c3RvbSBkdXJhdGlvbi4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2hpZ2hsaWdodC1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0SGlnaGxpZ2h0ID0gJC5lZmZlY3RzLmRlZmluZSggImhpZ2hsaWdodCIsICJzaG93IiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7Cgl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwKCQlhbmltYXRpb24gPSB7CgkJCWJhY2tncm91bmRDb2xvcjogZWxlbWVudC5jc3MoICJiYWNrZ3JvdW5kQ29sb3IiICkKCQl9OwoKCWlmICggb3B0aW9ucy5tb2RlID09PSAiaGlkZSIgKSB7CgkJYW5pbWF0aW9uLm9wYWNpdHkgPSAwOwoJfQoKCSQuZWZmZWN0cy5zYXZlU3R5bGUoIGVsZW1lbnQgKTsKCgllbGVtZW50CgkJLmNzcyggewoJCQliYWNrZ3JvdW5kSW1hZ2U6ICJub25lIiwKCQkJYmFja2dyb3VuZENvbG9yOiBvcHRpb25zLmNvbG9yIHx8ICIjZmZmZjk5IgoJCX0gKQoJCS5hbmltYXRlKCBhbmltYXRpb24sIHsKCQkJcXVldWU6IGZhbHNlLAoJCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKCQkJZWFzaW5nOiBvcHRpb25zLmVhc2luZywKCQkJY29tcGxldGU6IGRvbmUKCQl9ICk7Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgU2l6ZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNpemUgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IFJlc2l6ZSBhbiBlbGVtZW50IHRvIGEgc3BlY2lmaWVkIHdpZHRoIGFuZCBoZWlnaHQuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9zaXplLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RTaXplID0gJC5lZmZlY3RzLmRlZmluZSggInNpemUiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCgkvLyBDcmVhdGUgZWxlbWVudAoJdmFyIGJhc2VsaW5lLCBmYWN0b3IsIHRlbXAsCgkJZWxlbWVudCA9ICQoIHRoaXMgKSwKCgkJLy8gQ29weSBmb3IgY2hpbGRyZW4KCQljUHJvcHMgPSBbICJmb250U2l6ZSIgXSwKCQl2UHJvcHMgPSBbICJib3JkZXJUb3BXaWR0aCIsICJib3JkZXJCb3R0b21XaWR0aCIsICJwYWRkaW5nVG9wIiwgInBhZGRpbmdCb3R0b20iIF0sCgkJaFByb3BzID0gWyAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiBdLAoKCQkvLyBTZXQgb3B0aW9ucwoJCW1vZGUgPSBvcHRpb25zLm1vZGUsCgkJcmVzdG9yZSA9IG1vZGUgIT09ICJlZmZlY3QiLAoJCXNjYWxlID0gb3B0aW9ucy5zY2FsZSB8fCAiYm90aCIsCgkJb3JpZ2luID0gb3B0aW9ucy5vcmlnaW4gfHwgWyAibWlkZGxlIiwgImNlbnRlciIgXSwKCQlwb3NpdGlvbiA9IGVsZW1lbnQuY3NzKCAicG9zaXRpb24iICksCgkJcG9zID0gZWxlbWVudC5wb3NpdGlvbigpLAoJCW9yaWdpbmFsID0gJC5lZmZlY3RzLnNjYWxlZERpbWVuc2lvbnMoIGVsZW1lbnQgKSwKCQlmcm9tID0gb3B0aW9ucy5mcm9tIHx8IG9yaWdpbmFsLAoJCXRvID0gb3B0aW9ucy50byB8fCAkLmVmZmVjdHMuc2NhbGVkRGltZW5zaW9ucyggZWxlbWVudCwgMCApOwoKCSQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApOwoKCWlmICggbW9kZSA9PT0gInNob3ciICkgewoJCXRlbXAgPSBmcm9tOwoJCWZyb20gPSB0bzsKCQl0byA9IHRlbXA7Cgl9CgoJLy8gU2V0IHNjYWxpbmcgZmFjdG9yCglmYWN0b3IgPSB7CgkJZnJvbTogewoJCQl5OiBmcm9tLmhlaWdodCAvIG9yaWdpbmFsLmhlaWdodCwKCQkJeDogZnJvbS53aWR0aCAvIG9yaWdpbmFsLndpZHRoCgkJfSwKCQl0bzogewoJCQl5OiB0by5oZWlnaHQgLyBvcmlnaW5hbC5oZWlnaHQsCgkJCXg6IHRvLndpZHRoIC8gb3JpZ2luYWwud2lkdGgKCQl9Cgl9OwoKCS8vIFNjYWxlIHRoZSBjc3MgYm94CglpZiAoIHNjYWxlID09PSAiYm94IiB8fCBzY2FsZSA9PT0gImJvdGgiICkgewoKCQkvLyBWZXJ0aWNhbCBwcm9wcyBzY2FsaW5nCgkJaWYgKCBmYWN0b3IuZnJvbS55ICE9PSBmYWN0b3IudG8ueSApIHsKCQkJZnJvbSA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBlbGVtZW50LCB2UHJvcHMsIGZhY3Rvci5mcm9tLnksIGZyb20gKTsKCQkJdG8gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWxlbWVudCwgdlByb3BzLCBmYWN0b3IudG8ueSwgdG8gKTsKCQl9CgoJCS8vIEhvcml6b250YWwgcHJvcHMgc2NhbGluZwoJCWlmICggZmFjdG9yLmZyb20ueCAhPT0gZmFjdG9yLnRvLnggKSB7CgkJCWZyb20gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWxlbWVudCwgaFByb3BzLCBmYWN0b3IuZnJvbS54LCBmcm9tICk7CgkJCXRvID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGVsZW1lbnQsIGhQcm9wcywgZmFjdG9yLnRvLngsIHRvICk7CgkJfQoJfQoKCS8vIFNjYWxlIHRoZSBjb250ZW50CglpZiAoIHNjYWxlID09PSAiY29udGVudCIgfHwgc2NhbGUgPT09ICJib3RoIiApIHsKCgkJLy8gVmVydGljYWwgcHJvcHMgc2NhbGluZwoJCWlmICggZmFjdG9yLmZyb20ueSAhPT0gZmFjdG9yLnRvLnkgKSB7CgkJCWZyb20gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggZWxlbWVudCwgY1Byb3BzLCBmYWN0b3IuZnJvbS55LCBmcm9tICk7CgkJCXRvID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGVsZW1lbnQsIGNQcm9wcywgZmFjdG9yLnRvLnksIHRvICk7CgkJfQoJfQoKCS8vIEFkanVzdCB0aGUgcG9zaXRpb24gcHJvcGVydGllcyBiYXNlZCBvbiB0aGUgcHJvdmlkZWQgb3JpZ2luIHBvaW50cwoJaWYgKCBvcmlnaW4gKSB7CgkJYmFzZWxpbmUgPSAkLmVmZmVjdHMuZ2V0QmFzZWxpbmUoIG9yaWdpbiwgb3JpZ2luYWwgKTsKCQlmcm9tLnRvcCA9ICggb3JpZ2luYWwub3V0ZXJIZWlnaHQgLSBmcm9tLm91dGVySGVpZ2h0ICkgKiBiYXNlbGluZS55ICsgcG9zLnRvcDsKCQlmcm9tLmxlZnQgPSAoIG9yaWdpbmFsLm91dGVyV2lkdGggLSBmcm9tLm91dGVyV2lkdGggKSAqIGJhc2VsaW5lLnggKyBwb3MubGVmdDsKCQl0by50b3AgPSAoIG9yaWdpbmFsLm91dGVySGVpZ2h0IC0gdG8ub3V0ZXJIZWlnaHQgKSAqIGJhc2VsaW5lLnkgKyBwb3MudG9wOwoJCXRvLmxlZnQgPSAoIG9yaWdpbmFsLm91dGVyV2lkdGggLSB0by5vdXRlcldpZHRoICkgKiBiYXNlbGluZS54ICsgcG9zLmxlZnQ7Cgl9CgllbGVtZW50LmNzcyggZnJvbSApOwoKCS8vIEFuaW1hdGUgdGhlIGNoaWxkcmVuIGlmIGRlc2lyZWQKCWlmICggc2NhbGUgPT09ICJjb250ZW50IiB8fCBzY2FsZSA9PT0gImJvdGgiICkgewoKCQl2UHJvcHMgPSB2UHJvcHMuY29uY2F0KCBbICJtYXJnaW5Ub3AiLCAibWFyZ2luQm90dG9tIiBdICkuY29uY2F0KCBjUHJvcHMgKTsKCQloUHJvcHMgPSBoUHJvcHMuY29uY2F0KCBbICJtYXJnaW5MZWZ0IiwgIm1hcmdpblJpZ2h0IiBdICk7CgoJCS8vIE9ubHkgYW5pbWF0ZSBjaGlsZHJlbiB3aXRoIHdpZHRoIGF0dHJpYnV0ZXMgc3BlY2lmaWVkCgkJLy8gVE9ETzogaXMgdGhpcyByaWdodD8gc2hvdWxkIHdlIGluY2x1ZGUgYW55dGhpbmcgd2l0aCBjc3Mgd2lkdGggc3BlY2lmaWVkIGFzIHdlbGwKCQllbGVtZW50LmZpbmQoICIqW3dpZHRoXSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoaWxkID0gJCggdGhpcyApLAoJCQkJY2hpbGRPcmlnaW5hbCA9ICQuZWZmZWN0cy5zY2FsZWREaW1lbnNpb25zKCBjaGlsZCApLAoJCQkJY2hpbGRGcm9tID0gewoJCQkJCWhlaWdodDogY2hpbGRPcmlnaW5hbC5oZWlnaHQgKiBmYWN0b3IuZnJvbS55LAoJCQkJCXdpZHRoOiBjaGlsZE9yaWdpbmFsLndpZHRoICogZmFjdG9yLmZyb20ueCwKCQkJCQlvdXRlckhlaWdodDogY2hpbGRPcmlnaW5hbC5vdXRlckhlaWdodCAqIGZhY3Rvci5mcm9tLnksCgkJCQkJb3V0ZXJXaWR0aDogY2hpbGRPcmlnaW5hbC5vdXRlcldpZHRoICogZmFjdG9yLmZyb20ueAoJCQkJfSwKCQkJCWNoaWxkVG8gPSB7CgkJCQkJaGVpZ2h0OiBjaGlsZE9yaWdpbmFsLmhlaWdodCAqIGZhY3Rvci50by55LAoJCQkJCXdpZHRoOiBjaGlsZE9yaWdpbmFsLndpZHRoICogZmFjdG9yLnRvLngsCgkJCQkJb3V0ZXJIZWlnaHQ6IGNoaWxkT3JpZ2luYWwuaGVpZ2h0ICogZmFjdG9yLnRvLnksCgkJCQkJb3V0ZXJXaWR0aDogY2hpbGRPcmlnaW5hbC53aWR0aCAqIGZhY3Rvci50by54CgkJCQl9OwoKCQkJLy8gVmVydGljYWwgcHJvcHMgc2NhbGluZwoJCQlpZiAoIGZhY3Rvci5mcm9tLnkgIT09IGZhY3Rvci50by55ICkgewoJCQkJY2hpbGRGcm9tID0gJC5lZmZlY3RzLnNldFRyYW5zaXRpb24oIGNoaWxkLCB2UHJvcHMsIGZhY3Rvci5mcm9tLnksIGNoaWxkRnJvbSApOwoJCQkJY2hpbGRUbyA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBjaGlsZCwgdlByb3BzLCBmYWN0b3IudG8ueSwgY2hpbGRUbyApOwoJCQl9CgoJCQkvLyBIb3Jpem9udGFsIHByb3BzIHNjYWxpbmcKCQkJaWYgKCBmYWN0b3IuZnJvbS54ICE9PSBmYWN0b3IudG8ueCApIHsKCQkJCWNoaWxkRnJvbSA9ICQuZWZmZWN0cy5zZXRUcmFuc2l0aW9uKCBjaGlsZCwgaFByb3BzLCBmYWN0b3IuZnJvbS54LCBjaGlsZEZyb20gKTsKCQkJCWNoaWxkVG8gPSAkLmVmZmVjdHMuc2V0VHJhbnNpdGlvbiggY2hpbGQsIGhQcm9wcywgZmFjdG9yLnRvLngsIGNoaWxkVG8gKTsKCQkJfQoKCQkJaWYgKCByZXN0b3JlICkgewoJCQkJJC5lZmZlY3RzLnNhdmVTdHlsZSggY2hpbGQgKTsKCQkJfQoKCQkJLy8gQW5pbWF0ZSBjaGlsZHJlbgoJCQljaGlsZC5jc3MoIGNoaWxkRnJvbSApOwoJCQljaGlsZC5hbmltYXRlKCBjaGlsZFRvLCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgZnVuY3Rpb24oKSB7CgoJCQkJLy8gUmVzdG9yZSBjaGlsZHJlbgoJCQkJaWYgKCByZXN0b3JlICkgewoJCQkJCSQuZWZmZWN0cy5yZXN0b3JlU3R5bGUoIGNoaWxkICk7CgkJCQl9CgkJCX0gKTsKCQl9ICk7Cgl9CgoJLy8gQW5pbWF0ZQoJZWxlbWVudC5hbmltYXRlKCB0bywgewoJCXF1ZXVlOiBmYWxzZSwKCQlkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbiwKCQllYXNpbmc6IG9wdGlvbnMuZWFzaW5nLAoJCWNvbXBsZXRlOiBmdW5jdGlvbigpIHsKCgkJCXZhciBvZmZzZXQgPSBlbGVtZW50Lm9mZnNldCgpOwoKCQkJaWYgKCB0by5vcGFjaXR5ID09PSAwICkgewoJCQkJZWxlbWVudC5jc3MoICJvcGFjaXR5IiwgZnJvbS5vcGFjaXR5ICk7CgkJCX0KCgkJCWlmICggIXJlc3RvcmUgKSB7CgkJCQllbGVtZW50CgkJCQkJLmNzcyggInBvc2l0aW9uIiwgcG9zaXRpb24gPT09ICJzdGF0aWMiID8gInJlbGF0aXZlIiA6IHBvc2l0aW9uICkKCQkJCQkub2Zmc2V0KCBvZmZzZXQgKTsKCgkJCQkvLyBOZWVkIHRvIHNhdmUgc3R5bGUgaGVyZSBzbyB0aGF0IGF1dG9tYXRpYyBzdHlsZSByZXN0b3JhdGlvbgoJCQkJLy8gZG9lc24ndCByZXN0b3JlIHRvIHRoZSBvcmlnaW5hbCBzdHlsZXMgZnJvbSBiZWZvcmUgdGhlIGFuaW1hdGlvbi4KCQkJCSQuZWZmZWN0cy5zYXZlU3R5bGUoIGVsZW1lbnQgKTsKCQkJfQoKCQkJZG9uZSgpOwoJCX0KCX0gKTsKCn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgU2NhbGUgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBTY2FsZSBFZmZlY3QKLy8+Pmdyb3VwOiBFZmZlY3RzCi8vPj5kZXNjcmlwdGlvbjogR3Jvd3Mgb3Igc2hyaW5rcyBhbiBlbGVtZW50IGFuZCBpdHMgY29udGVudC4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NjYWxlLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RTY2FsZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJzY2FsZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoKCS8vIENyZWF0ZSBlbGVtZW50Cgl2YXIgZWwgPSAkKCB0aGlzICksCgkJbW9kZSA9IG9wdGlvbnMubW9kZSwKCQlwZXJjZW50ID0gcGFyc2VJbnQoIG9wdGlvbnMucGVyY2VudCwgMTAgKSB8fAoJCQkoIHBhcnNlSW50KCBvcHRpb25zLnBlcmNlbnQsIDEwICkgPT09IDAgPyAwIDogKCBtb2RlICE9PSAiZWZmZWN0IiA\/IDAgOiAxMDAgKSApLAoKCQluZXdPcHRpb25zID0gJC5leHRlbmQoIHRydWUsIHsKCQkJZnJvbTogJC5lZmZlY3RzLnNjYWxlZERpbWVuc2lvbnMoIGVsICksCgkJCXRvOiAkLmVmZmVjdHMuc2NhbGVkRGltZW5zaW9ucyggZWwsIHBlcmNlbnQsIG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJib3RoIiApLAoJCQlvcmlnaW46IG9wdGlvbnMub3JpZ2luIHx8IFsgIm1pZGRsZSIsICJjZW50ZXIiIF0KCQl9LCBvcHRpb25zICk7CgoJLy8gRmFkZSBvcHRpb24gdG8gc3VwcG9ydCBwdWZmCglpZiAoIG9wdGlvbnMuZmFkZSApIHsKCQluZXdPcHRpb25zLmZyb20ub3BhY2l0eSA9IDE7CgkJbmV3T3B0aW9ucy50by5vcGFjaXR5ID0gMDsKCX0KCgkkLmVmZmVjdHMuZWZmZWN0LnNpemUuY2FsbCggdGhpcywgbmV3T3B0aW9ucywgZG9uZSApOwp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIFB1ZmYgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBQdWZmIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBDcmVhdGVzIGEgcHVmZiBlZmZlY3QgYnkgc2NhbGluZyB0aGUgZWxlbWVudCB1cCBhbmQgaGlkaW5nIGl0IGF0IHRoZSBzYW1lIHRpbWUuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wdWZmLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RQdWZmID0gJC5lZmZlY3RzLmRlZmluZSggInB1ZmYiLCAiaGlkZSIsIGZ1bmN0aW9uKCBvcHRpb25zLCBkb25lICkgewoJdmFyIG5ld09wdGlvbnMgPSAkLmV4dGVuZCggdHJ1ZSwge30sIG9wdGlvbnMsIHsKCQlmYWRlOiB0cnVlLAoJCXBlcmNlbnQ6IHBhcnNlSW50KCBvcHRpb25zLnBlcmNlbnQsIDEwICkgfHwgMTUwCgl9ICk7CgoJJC5lZmZlY3RzLmVmZmVjdC5zY2FsZS5jYWxsKCB0aGlzLCBuZXdPcHRpb25zLCBkb25lICk7Cn0gKTsKCgovKiEKICogalF1ZXJ5IFVJIEVmZmVjdHMgUHVsc2F0ZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFB1bHNhdGUgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IFB1bHNhdGVzIGFuIGVsZW1lbnQgbiB0aW1lcyBieSBjaGFuZ2luZyB0aGUgb3BhY2l0eSB0byB6ZXJvIGFuZCBiYWNrLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vcHVsc2F0ZS1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0UHVsc2F0ZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJwdWxzYXRlIiwgInNob3ciLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCW1vZGUgPSBvcHRpb25zLm1vZGUsCgkJc2hvdyA9IG1vZGUgPT09ICJzaG93IiwKCQloaWRlID0gbW9kZSA9PT0gImhpZGUiLAoJCXNob3doaWRlID0gc2hvdyB8fCBoaWRlLAoKCQkvLyBTaG93aW5nIG9yIGhpZGluZyBsZWF2ZXMgb2ZmIHRoZSAibGFzdCIgYW5pbWF0aW9uCgkJYW5pbXMgPSAoICggb3B0aW9ucy50aW1lcyB8fCA1ICkgKiAyICkgKyAoIHNob3doaWRlID8gMSA6IDAgKSwKCQlkdXJhdGlvbiA9IG9wdGlvbnMuZHVyYXRpb24gLyBhbmltcywKCQlhbmltYXRlVG8gPSAwLAoJCWkgPSAxLAoJCXF1ZXVlbGVuID0gZWxlbWVudC5xdWV1ZSgpLmxlbmd0aDsKCglpZiAoIHNob3cgfHwgIWVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQllbGVtZW50LmNzcyggIm9wYWNpdHkiLCAwICkuc2hvdygpOwoJCWFuaW1hdGVUbyA9IDE7Cgl9CgoJLy8gQW5pbXMgLSAxIG9wYWNpdHkgInRvZ2dsZXMiCglmb3IgKCA7IGkgPCBhbmltczsgaSsrICkgewoJCWVsZW1lbnQuYW5pbWF0ZSggeyBvcGFjaXR5OiBhbmltYXRlVG8gfSwgZHVyYXRpb24sIG9wdGlvbnMuZWFzaW5nICk7CgkJYW5pbWF0ZVRvID0gMSAtIGFuaW1hdGVUbzsKCX0KCgllbGVtZW50LmFuaW1hdGUoIHsgb3BhY2l0eTogYW5pbWF0ZVRvIH0sIGR1cmF0aW9uLCBvcHRpb25zLmVhc2luZyApOwoKCWVsZW1lbnQucXVldWUoIGRvbmUgKTsKCgkkLmVmZmVjdHMudW5zaGlmdCggZWxlbWVudCwgcXVldWVsZW4sIGFuaW1zICsgMSApOwp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBFZmZlY3RzIFNoYWtlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogU2hha2UgRWZmZWN0Ci8vPj5ncm91cDogRWZmZWN0cwovLz4+ZGVzY3JpcHRpb246IFNoYWtlcyBhbiBlbGVtZW50IGhvcml6b250YWxseSBvciB2ZXJ0aWNhbGx5IG4gdGltZXMuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9zaGFrZS1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3RzRWZmZWN0U2hha2UgPSAkLmVmZmVjdHMuZGVmaW5lKCAic2hha2UiLCBmdW5jdGlvbiggb3B0aW9ucywgZG9uZSApIHsKCgl2YXIgaSA9IDEsCgkJZWxlbWVudCA9ICQoIHRoaXMgKSwKCQlkaXJlY3Rpb24gPSBvcHRpb25zLmRpcmVjdGlvbiB8fCAibGVmdCIsCgkJZGlzdGFuY2UgPSBvcHRpb25zLmRpc3RhbmNlIHx8IDIwLAoJCXRpbWVzID0gb3B0aW9ucy50aW1lcyB8fCAzLAoJCWFuaW1zID0gdGltZXMgKiAyICsgMSwKCQlzcGVlZCA9IE1hdGgucm91bmQoIG9wdGlvbnMuZHVyYXRpb24gLyBhbmltcyApLAoJCXJlZiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImRvd24iICkgPyAidG9wIiA6ICJsZWZ0IiwKCQlwb3NpdGl2ZU1vdGlvbiA9ICggZGlyZWN0aW9uID09PSAidXAiIHx8IGRpcmVjdGlvbiA9PT0gImxlZnQiICksCgkJYW5pbWF0aW9uID0ge30sCgkJYW5pbWF0aW9uMSA9IHt9LAoJCWFuaW1hdGlvbjIgPSB7fSwKCgkJcXVldWVsZW4gPSBlbGVtZW50LnF1ZXVlKCkubGVuZ3RoOwoKCSQuZWZmZWN0cy5jcmVhdGVQbGFjZWhvbGRlciggZWxlbWVudCApOwoKCS8vIEFuaW1hdGlvbgoJYW5pbWF0aW9uWyByZWYgXSA9ICggcG9zaXRpdmVNb3Rpb24gPyAiLT0iIDogIis9IiApICsgZGlzdGFuY2U7CglhbmltYXRpb24xWyByZWYgXSA9ICggcG9zaXRpdmVNb3Rpb24gPyAiKz0iIDogIi09IiApICsgZGlzdGFuY2UgKiAyOwoJYW5pbWF0aW9uMlsgcmVmIF0gPSAoIHBvc2l0aXZlTW90aW9uID8gIi09IiA6ICIrPSIgKSArIGRpc3RhbmNlICogMjsKCgkvLyBBbmltYXRlCgllbGVtZW50LmFuaW1hdGUoIGFuaW1hdGlvbiwgc3BlZWQsIG9wdGlvbnMuZWFzaW5nICk7CgoJLy8gU2hha2VzCglmb3IgKCA7IGkgPCB0aW1lczsgaSsrICkgewoJCWVsZW1lbnQKCQkJLmFuaW1hdGUoIGFuaW1hdGlvbjEsIHNwZWVkLCBvcHRpb25zLmVhc2luZyApCgkJCS5hbmltYXRlKCBhbmltYXRpb24yLCBzcGVlZCwgb3B0aW9ucy5lYXNpbmcgKTsKCX0KCgllbGVtZW50CgkJLmFuaW1hdGUoIGFuaW1hdGlvbjEsIHNwZWVkLCBvcHRpb25zLmVhc2luZyApCgkJLmFuaW1hdGUoIGFuaW1hdGlvbiwgc3BlZWQgLyAyLCBvcHRpb25zLmVhc2luZyApCgkJLnF1ZXVlKCBkb25lICk7CgoJJC5lZmZlY3RzLnVuc2hpZnQoIGVsZW1lbnQsIHF1ZXVlbGVuLCBhbmltcyArIDEgKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBTbGlkZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNsaWRlIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBTbGlkZXMgYW4gZWxlbWVudCBpbiBhbmQgb3V0IG9mIHRoZSB2aWV3cG9ydC4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NsaWRlLWVmZmVjdC8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2VmZmVjdC8KCgoKdmFyIGVmZmVjdHNFZmZlY3RTbGlkZSA9ICQuZWZmZWN0cy5kZWZpbmUoICJzbGlkZSIsICJzaG93IiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7Cgl2YXIgc3RhcnRDbGlwLCBzdGFydFJlZiwKCQllbGVtZW50ID0gJCggdGhpcyApLAoJCW1hcCA9IHsKCQkJdXA6IFsgImJvdHRvbSIsICJ0b3AiIF0sCgkJCWRvd246IFsgInRvcCIsICJib3R0b20iIF0sCgkJCWxlZnQ6IFsgInJpZ2h0IiwgImxlZnQiIF0sCgkJCXJpZ2h0OiBbICJsZWZ0IiwgInJpZ2h0IiBdCgkJfSwKCQltb2RlID0gb3B0aW9ucy5tb2RlLAoJCWRpcmVjdGlvbiA9IG9wdGlvbnMuZGlyZWN0aW9uIHx8ICJsZWZ0IiwKCQlyZWYgPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJkb3duIiApID8gInRvcCIgOiAibGVmdCIsCgkJcG9zaXRpdmVNb3Rpb24gPSAoIGRpcmVjdGlvbiA9PT0gInVwIiB8fCBkaXJlY3Rpb24gPT09ICJsZWZ0IiApLAoJCWRpc3RhbmNlID0gb3B0aW9ucy5kaXN0YW5jZSB8fAoJCQllbGVtZW50WyByZWYgPT09ICJ0b3AiID8gIm91dGVySGVpZ2h0IiA6ICJvdXRlcldpZHRoIiBdKCB0cnVlICksCgkJYW5pbWF0aW9uID0ge307CgoJJC5lZmZlY3RzLmNyZWF0ZVBsYWNlaG9sZGVyKCBlbGVtZW50ICk7CgoJc3RhcnRDbGlwID0gZWxlbWVudC5jc3NDbGlwKCk7CglzdGFydFJlZiA9IGVsZW1lbnQucG9zaXRpb24oKVsgcmVmIF07CgoJLy8gRGVmaW5lIGhpZGUgYW5pbWF0aW9uCglhbmltYXRpb25bIHJlZiBdID0gKCBwb3NpdGl2ZU1vdGlvbiA\/IC0xIDogMSApICogZGlzdGFuY2UgKyBzdGFydFJlZjsKCWFuaW1hdGlvbi5jbGlwID0gZWxlbWVudC5jc3NDbGlwKCk7CglhbmltYXRpb24uY2xpcFsgbWFwWyBkaXJlY3Rpb24gXVsgMSBdIF0gPSBhbmltYXRpb24uY2xpcFsgbWFwWyBkaXJlY3Rpb24gXVsgMCBdIF07CgoJLy8gUmV2ZXJzZSB0aGUgYW5pbWF0aW9uIGlmIHdlJ3JlIHNob3dpbmcKCWlmICggbW9kZSA9PT0gInNob3ciICkgewoJCWVsZW1lbnQuY3NzQ2xpcCggYW5pbWF0aW9uLmNsaXAgKTsKCQllbGVtZW50LmNzcyggcmVmLCBhbmltYXRpb25bIHJlZiBdICk7CgkJYW5pbWF0aW9uLmNsaXAgPSBzdGFydENsaXA7CgkJYW5pbWF0aW9uWyByZWYgXSA9IHN0YXJ0UmVmOwoJfQoKCS8vIEFjdHVhbGx5IGFuaW1hdGUKCWVsZW1lbnQuYW5pbWF0ZSggYW5pbWF0aW9uLCB7CgkJcXVldWU6IGZhbHNlLAoJCWR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAoJCWVhc2luZzogb3B0aW9ucy5lYXNpbmcsCgkJY29tcGxldGU6IGRvbmUKCX0gKTsKfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgRWZmZWN0cyBUcmFuc2ZlciAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFRyYW5zZmVyIEVmZmVjdAovLz4+Z3JvdXA6IEVmZmVjdHMKLy8+PmRlc2NyaXB0aW9uOiBEaXNwbGF5cyBhIHRyYW5zZmVyIGVmZmVjdCBmcm9tIG9uZSBlbGVtZW50IHRvIGFub3RoZXIuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS90cmFuc2Zlci1lZmZlY3QvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9lZmZlY3QvCgoKCnZhciBlZmZlY3Q7CmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgewoJZWZmZWN0ID0gJC5lZmZlY3RzLmRlZmluZSggInRyYW5zZmVyIiwgZnVuY3Rpb24oIG9wdGlvbnMsIGRvbmUgKSB7CgkJJCggdGhpcyApLnRyYW5zZmVyKCBvcHRpb25zLCBkb25lICk7Cgl9ICk7Cn0KdmFyIGVmZmVjdHNFZmZlY3RUcmFuc2ZlciA9IGVmZmVjdDsKCgovKiEKICogalF1ZXJ5IFVJIEZvY3VzYWJsZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IDpmb2N1c2FibGUgU2VsZWN0b3IKLy8+Pmdyb3VwOiBDb3JlCi8vPj5kZXNjcmlwdGlvbjogU2VsZWN0cyBlbGVtZW50cyB3aGljaCBjYW4gYmUgZm9jdXNlZC4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2ZvY3VzYWJsZS1zZWxlY3Rvci8KCgoKLy8gU2VsZWN0b3JzCiQudWkuZm9jdXNhYmxlID0gZnVuY3Rpb24oIGVsZW1lbnQsIGhhc1RhYmluZGV4ICkgewoJdmFyIG1hcCwgbWFwTmFtZSwgaW1nLCBmb2N1c2FibGVJZlZpc2libGUsIGZpZWxkc2V0LAoJCW5vZGVOYW1lID0gZWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9JyMiICsgbWFwTmFtZSArICInXSIgKTsKCQlyZXR1cm4gaW1nLmxlbmd0aCA+IDAgJiYgaW1nLmlzKCAiOnZpc2libGUiICk7Cgl9CgoJaWYgKCAvXihpbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9ufG9iamVjdCkkLy50ZXN0KCBub2RlTmFtZSApICkgewoJCWZvY3VzYWJsZUlmVmlzaWJsZSA9ICFlbGVtZW50LmRpc2FibGVkOwoKCQlpZiAoIGZvY3VzYWJsZUlmVmlzaWJsZSApIHsKCgkJCS8vIEZvcm0gY29udHJvbHMgd2l0aGluIGEgZGlzYWJsZWQgZmllbGRzZXQgYXJlIGRpc2FibGVkLgoJCQkvLyBIb3dldmVyLCBjb250cm9scyB3aXRoaW4gdGhlIGZpZWxkc2V0J3MgbGVnZW5kIGRvIG5vdCBnZXQgZGlzYWJsZWQuCgkJCS8vIFNpbmNlIGNvbnRyb2xzIGdlbmVyYWxseSBhcmVuJ3QgcGxhY2VkIGluc2lkZSBsZWdlbmRzLCB3ZSBza2lwCgkJCS8vIHRoaXMgcG9ydGlvbiBvZiB0aGUgY2hlY2suCgkJCWZpZWxkc2V0ID0gJCggZWxlbWVudCApLmNsb3Nlc3QoICJmaWVsZHNldCIgKVsgMCBdOwoJCQlpZiAoIGZpZWxkc2V0ICkgewoJCQkJZm9jdXNhYmxlSWZWaXNpYmxlID0gIWZpZWxkc2V0LmRpc2FibGVkOwoJCQl9CgkJfQoJfSBlbHNlIGlmICggImEiID09PSBub2RlTmFtZSApIHsKCQlmb2N1c2FibGVJZlZpc2libGUgPSBlbGVtZW50LmhyZWYgfHwgaGFzVGFiaW5kZXg7Cgl9IGVsc2UgewoJCWZvY3VzYWJsZUlmVmlzaWJsZSA9IGhhc1RhYmluZGV4OwoJfQoKCXJldHVybiBmb2N1c2FibGVJZlZpc2libGUgJiYgJCggZWxlbWVudCApLmlzKCAiOnZpc2libGUiICkgJiYgdmlzaWJsZSggJCggZWxlbWVudCApICk7Cn07CgovLyBTdXBwb3J0OiBJRSA4IG9ubHkKLy8gSUUgOCBkb2Vzbid0IHJlc29sdmUgaW5oZXJpdCB0byB2aXNpYmxlL2hpZGRlbiBmb3IgY29tcHV0ZWQgdmFsdWVzCmZ1bmN0aW9uIHZpc2libGUoIGVsZW1lbnQgKSB7Cgl2YXIgdmlzaWJpbGl0eSA9IGVsZW1lbnQuY3NzKCAidmlzaWJpbGl0eSIgKTsKCXdoaWxlICggdmlzaWJpbGl0eSA9PT0gImluaGVyaXQiICkgewoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwoJCXZpc2liaWxpdHkgPSBlbGVtZW50LmNzcyggInZpc2liaWxpdHkiICk7Cgl9CglyZXR1cm4gdmlzaWJpbGl0eSAhPT0gImhpZGRlbiI7Cn0KCiQuZXh0ZW5kKCAkLmV4cHJbICI6IiBdLCB7Cglmb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXJldHVybiAkLnVpLmZvY3VzYWJsZSggZWxlbWVudCwgJC5hdHRyKCBlbGVtZW50LCAidGFiaW5kZXgiICkgIT0gbnVsbCApOwoJfQp9ICk7Cgp2YXIgZm9jdXNhYmxlID0gJC51aS5mb2N1c2FibGU7CgoKCgovLyBTdXBwb3J0OiBJRTggT25seQovLyBJRTggZG9lcyBub3Qgc3VwcG9ydCB0aGUgZm9ybSBhdHRyaWJ1dGUgYW5kIHdoZW4gaXQgaXMgc3VwcGxpZWQuIEl0IG92ZXJ3cml0ZXMgdGhlIGZvcm0gcHJvcAovLyB3aXRoIGEgc3RyaW5nLCBzbyB3ZSBuZWVkIHRvIGZpbmQgdGhlIHByb3BlciBmb3JtLgp2YXIgZm9ybSA9ICQuZm4uZm9ybSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuIHR5cGVvZiB0aGlzWyAwIF0uZm9ybSA9PT0gInN0cmluZyIgPyB0aGlzLmNsb3Nlc3QoICJmb3JtIiApIDogJCggdGhpc1sgMCBdLmZvcm0gKTsKfTsKCgovKiEKICogalF1ZXJ5IFVJIEZvcm0gUmVzZXQgTWl4aW4gMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBGb3JtIFJlc2V0IE1peGluCi8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IFJlZnJlc2ggaW5wdXQgd2lkZ2V0cyB3aGVuIHRoZWlyIGZvcm0gaXMgcmVzZXQKLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2Zvcm0tcmVzZXQtbWl4aW4vCgoKCnZhciBmb3JtUmVzZXRNaXhpbiA9ICQudWkuZm9ybVJlc2V0TWl4aW4gPSB7CglfZm9ybVJlc2V0SGFuZGxlcjogZnVuY3Rpb24oKSB7CgkJdmFyIGZvcm0gPSAkKCB0aGlzICk7CgoJCS8vIFdhaXQgZm9yIHRoZSBmb3JtIHJlc2V0IHRvIGFjdHVhbGx5IGhhcHBlbiBiZWZvcmUgcmVmcmVzaGluZwoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQl2YXIgaW5zdGFuY2VzID0gZm9ybS5kYXRhKCAidWktZm9ybS1yZXNldC1pbnN0YW5jZXMiICk7CgkJCSQuZWFjaCggaW5zdGFuY2VzLCBmdW5jdGlvbigpIHsKCQkJCXRoaXMucmVmcmVzaCgpOwoJCQl9ICk7CgkJfSApOwoJfSwKCglfYmluZEZvcm1SZXNldEhhbmRsZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZm9ybSA9IHRoaXMuZWxlbWVudC5mb3JtKCk7CgkJaWYgKCAhdGhpcy5mb3JtLmxlbmd0aCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGluc3RhbmNlcyA9IHRoaXMuZm9ybS5kYXRhKCAidWktZm9ybS1yZXNldC1pbnN0YW5jZXMiICkgfHwgW107CgkJaWYgKCAhaW5zdGFuY2VzLmxlbmd0aCApIHsKCgkJCS8vIFdlIGRvbid0IHVzZSBfb24oKSBoZXJlIGJlY2F1c2Ugd2UgdXNlIGEgc2luZ2xlIGV2ZW50IGhhbmRsZXIgcGVyIGZvcm0KCQkJdGhpcy5mb3JtLm9uKCAicmVzZXQudWktZm9ybS1yZXNldCIsIHRoaXMuX2Zvcm1SZXNldEhhbmRsZXIgKTsKCQl9CgkJaW5zdGFuY2VzLnB1c2goIHRoaXMgKTsKCQl0aGlzLmZvcm0uZGF0YSggInVpLWZvcm0tcmVzZXQtaW5zdGFuY2VzIiwgaW5zdGFuY2VzICk7Cgl9LAoKCV91bmJpbmRGb3JtUmVzZXRIYW5kbGVyOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLmZvcm0ubGVuZ3RoICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgaW5zdGFuY2VzID0gdGhpcy5mb3JtLmRhdGEoICJ1aS1mb3JtLXJlc2V0LWluc3RhbmNlcyIgKTsKCQlpbnN0YW5jZXMuc3BsaWNlKCAkLmluQXJyYXkoIHRoaXMsIGluc3RhbmNlcyApLCAxICk7CgkJaWYgKCBpbnN0YW5jZXMubGVuZ3RoICkgewoJCQl0aGlzLmZvcm0uZGF0YSggInVpLWZvcm0tcmVzZXQtaW5zdGFuY2VzIiwgaW5zdGFuY2VzICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5mb3JtCgkJCQkucmVtb3ZlRGF0YSggInVpLWZvcm0tcmVzZXQtaW5zdGFuY2VzIiApCgkJCQkub2ZmKCAicmVzZXQudWktZm9ybS1yZXNldCIgKTsKCQl9Cgl9Cn07CgoKLyohCiAqIGpRdWVyeSBVSSBTdXBwb3J0IGZvciBqUXVlcnkgY29yZSAxLjcueCAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICovCgovLz4+bGFiZWw6IGpRdWVyeSAxLjcgU3VwcG9ydAovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBTdXBwb3J0IHZlcnNpb24gMS43Lnggb2YgalF1ZXJ5IGNvcmUKCgoKLy8gU3VwcG9ydDogalF1ZXJ5IDEuNyBvbmx5Ci8vIE5vdCBhIGdyZWF0IHdheSB0byBjaGVjayB2ZXJzaW9ucywgYnV0IHNpbmNlIHdlIG9ubHkgc3VwcG9ydCAxLjcrIGFuZCBvbmx5Ci8vIG5lZWQgdG8gZGV0ZWN0IDwxLjgsIHRoaXMgaXMgYSBzaW1wbGUgY2hlY2sgdGhhdCBzaG91bGQgc3VmZmljZS4gQ2hlY2tpbmcKLy8gZm9yICIxLjcuIiB3b3VsZCBiZSBhIGJpdCBzYWZlciwgYnV0IHRoZSB2ZXJzaW9uIHN0cmluZyBpcyAxLjcsIG5vdCAxLjcuMAovLyBhbmQgd2UnbGwgbmV2ZXIgcmVhY2ggMS43MC4wIChpZiB3ZSBkbywgd2UgY2VydGFpbmx5IHdvbid0IGJlIHN1cHBvcnRpbmcKLy8gMS43IGFueW1vcmUpLiBTZWUgIzExMTk3IGZvciB3aHkgd2UncmUgbm90IHVzaW5nIGZlYXR1cmUgZGV0ZWN0aW9uLgppZiAoICQuZm4uanF1ZXJ5LnN1YnN0cmluZyggMCwgMyApID09PSAiMS43IiApIHsKCgkvLyBTZXR0ZXJzIGZvciAuaW5uZXJXaWR0aCgpLCAuaW5uZXJIZWlnaHQoKSwgLm91dGVyV2lkdGgoKSwgLm91dGVySGVpZ2h0KCkKCS8vIFVubGlrZSBqUXVlcnkgQ29yZSAxLjgrLCB0aGVzZSBvbmx5IHN1cHBvcnQgbnVtZXJpYyB2YWx1ZXMgdG8gc2V0IHRoZQoJLy8gZGltZW5zaW9ucyBpbiBwaXhlbHMKCSQuZWFjaCggWyAiV2lkdGgiLCAiSGVpZ2h0IiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCQl2YXIgc2lkZSA9IG5hbWUgPT09ICJXaWR0aCIgPyBbICJMZWZ0IiwgIlJpZ2h0IiBdIDogWyAiVG9wIiwgIkJvdHRvbSIgXSwKCQkJdHlwZSA9IG5hbWUudG9Mb3dlckNhc2UoKSwKCQkJb3JpZyA9IHsKCQkJCWlubmVyV2lkdGg6ICQuZm4uaW5uZXJXaWR0aCwKCQkJCWlubmVySGVpZ2h0OiAkLmZuLmlubmVySGVpZ2h0LAoJCQkJb3V0ZXJXaWR0aDogJC5mbi5vdXRlcldpZHRoLAoJCQkJb3V0ZXJIZWlnaHQ6ICQuZm4ub3V0ZXJIZWlnaHQKCQkJfTsKCgkJZnVuY3Rpb24gcmVkdWNlKCBlbGVtLCBzaXplLCBib3JkZXIsIG1hcmdpbiApIHsKCQkJJC5lYWNoKCBzaWRlLCBmdW5jdGlvbigpIHsKCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJwYWRkaW5nIiArIHRoaXMgKSApIHx8IDA7CgkJCQlpZiAoIGJvcmRlciApIHsKCQkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAiYm9yZGVyIiArIHRoaXMgKyAiV2lkdGgiICkgKSB8fCAwOwoJCQkJfQoJCQkJaWYgKCBtYXJnaW4gKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgIm1hcmdpbiIgKyB0aGlzICkgKSB8fCAwOwoJCQkJfQoJCQl9ICk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuY3NzKCB0eXBlLCByZWR1Y2UoIHRoaXMsIHNpemUgKSArICJweCIgKTsKCQkJfSApOwoJCX07CgoJCSQuZm5bICJvdXRlciIgKyBuYW1lIF0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuY3NzKCB0eXBlLCByZWR1Y2UoIHRoaXMsIHNpemUsIHRydWUsIG1hcmdpbiApICsgInB4IiApOwoJCQl9ICk7CgkJfTsKCX0gKTsKCgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9Cgo7Ci8qIQogKiBqUXVlcnkgVUkgS2V5Y29kZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IEtleWNvZGUKLy8+Pmdyb3VwOiBDb3JlCi8vPj5kZXNjcmlwdGlvbjogUHJvdmlkZSBrZXljb2RlcyBhcyBrZXluYW1lcwovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20valF1ZXJ5LnVpLmtleUNvZGUvCgoKdmFyIGtleWNvZGUgPSAkLnVpLmtleUNvZGUgPSB7CglCQUNLU1BBQ0U6IDgsCglDT01NQTogMTg4LAoJREVMRVRFOiA0NiwKCURPV046IDQwLAoJRU5EOiAzNSwKCUVOVEVSOiAxMywKCUVTQ0FQRTogMjcsCglIT01FOiAzNiwKCUxFRlQ6IDM3LAoJUEFHRV9ET1dOOiAzNCwKCVBBR0VfVVA6IDMzLAoJUEVSSU9EOiAxOTAsCglSSUdIVDogMzksCglTUEFDRTogMzIsCglUQUI6IDksCglVUDogMzgKfTsKCgoKCi8vIEludGVybmFsIHVzZSBvbmx5CnZhciBlc2NhcGVTZWxlY3RvciA9ICQudWkuZXNjYXBlU2VsZWN0b3IgPSAoIGZ1bmN0aW9uKCkgewoJdmFyIHNlbGVjdG9yRXNjYXBlID0gLyhbISIjJCUmJygpKissLi86Ozw9Pj9AW1xdXmB7fH1+XSkvZzsKCXJldHVybiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHNlbGVjdG9yLnJlcGxhY2UoIHNlbGVjdG9yRXNjYXBlLCAiXFwkMSIgKTsKCX07Cn0gKSgpOwoKCi8qIQogKiBqUXVlcnkgVUkgTGFiZWxzIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogbGFiZWxzCi8vPj5ncm91cDogQ29yZQovLz4+ZGVzY3JpcHRpb246IEZpbmQgYWxsIHRoZSBsYWJlbHMgYXNzb2NpYXRlZCB3aXRoIGEgZ2l2ZW4gaW5wdXQKLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2xhYmVscy8KCgoKdmFyIGxhYmVscyA9ICQuZm4ubGFiZWxzID0gZnVuY3Rpb24oKSB7Cgl2YXIgYW5jZXN0b3IsIHNlbGVjdG9yLCBpZCwgbGFiZWxzLCBhbmNlc3RvcnM7CgoJLy8gQ2hlY2sgY29udHJvbC5sYWJlbHMgZmlyc3QKCWlmICggdGhpc1sgMCBdLmxhYmVscyAmJiB0aGlzWyAwIF0ubGFiZWxzLmxlbmd0aCApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHRoaXNbIDAgXS5sYWJlbHMgKTsKCX0KCgkvLyBTdXBwb3J0OiBJRSA8PSAxMSwgRkYgPD0gMzcsIEFuZHJvaWQgPD0gMi4zIG9ubHkKCS8vIEFib3ZlIGJyb3dzZXJzIGRvIG5vdCBzdXBwb3J0IGNvbnRyb2wubGFiZWxzLiBFdmVyeXRoaW5nIGJlbG93IGlzIHRvIHN1cHBvcnQgdGhlbQoJLy8gYXMgd2VsbCBhcyBkb2N1bWVudCBmcmFnbWVudHMuIGNvbnRyb2wubGFiZWxzIGRvZXMgbm90IHdvcmsgb24gZG9jdW1lbnQgZnJhZ21lbnRzCglsYWJlbHMgPSB0aGlzLmVxKCAwICkucGFyZW50cyggImxhYmVsIiApOwoKCS8vIExvb2sgZm9yIHRoZSBsYWJlbCBiYXNlZCBvbiB0aGUgaWQKCWlkID0gdGhpcy5hdHRyKCAiaWQiICk7CglpZiAoIGlkICkgewoKCQkvLyBXZSBkb24ndCBzZWFyY2ggYWdhaW5zdCB0aGUgZG9jdW1lbnQgaW4gY2FzZSB0aGUgZWxlbWVudAoJCS8vIGlzIGRpc2Nvbm5lY3RlZCBmcm9tIHRoZSBET00KCQlhbmNlc3RvciA9IHRoaXMuZXEoIDAgKS5wYXJlbnRzKCkubGFzdCgpOwoKCQkvLyBHZXQgYSBmdWxsIHNldCBvZiB0b3AgbGV2ZWwgYW5jZXN0b3JzCgkJYW5jZXN0b3JzID0gYW5jZXN0b3IuYWRkKCBhbmNlc3Rvci5sZW5ndGggPyBhbmNlc3Rvci5zaWJsaW5ncygpIDogdGhpcy5zaWJsaW5ncygpICk7CgoJCS8vIENyZWF0ZSBhIHNlbGVjdG9yIGZvciB0aGUgbGFiZWwgYmFzZWQgb24gdGhlIGlkCgkJc2VsZWN0b3IgPSAibGFiZWxbZm9yPSciICsgJC51aS5lc2NhcGVTZWxlY3RvciggaWQgKSArICInXSI7CgoJCWxhYmVscyA9IGxhYmVscy5hZGQoIGFuY2VzdG9ycy5maW5kKCBzZWxlY3RvciApLmFkZEJhY2soIHNlbGVjdG9yICkgKTsKCgl9CgoJLy8gUmV0dXJuIHdoYXRldmVyIHdlIGhhdmUgZm91bmQgZm9yIGxhYmVscwoJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBsYWJlbHMgKTsKfTsKCgovKiEKICogalF1ZXJ5IFVJIFNjcm9sbCBQYXJlbnQgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBzY3JvbGxQYXJlbnQKLy8+Pmdyb3VwOiBDb3JlCi8vPj5kZXNjcmlwdGlvbjogR2V0IHRoZSBjbG9zZXN0IGFuY2VzdG9yIGVsZW1lbnQgdGhhdCBpcyBzY3JvbGxhYmxlLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2Nyb2xsUGFyZW50LwoKCgp2YXIgc2Nyb2xsUGFyZW50ID0gJC5mbi5zY3JvbGxQYXJlbnQgPSBmdW5jdGlvbiggaW5jbHVkZUhpZGRlbiApIHsKCXZhciBwb3NpdGlvbiA9IHRoaXMuY3NzKCAicG9zaXRpb24iICksCgkJZXhjbHVkZVN0YXRpY1BhcmVudCA9IHBvc2l0aW9uID09PSAiYWJzb2x1dGUiLAoJCW92ZXJmbG93UmVnZXggPSBpbmNsdWRlSGlkZGVuID8gLyhhdXRvfHNjcm9sbHxoaWRkZW4pLyA6IC8oYXV0b3xzY3JvbGwpLywKCQlzY3JvbGxQYXJlbnQgPSB0aGlzLnBhcmVudHMoKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFyZW50ID0gJCggdGhpcyApOwoJCQlpZiAoIGV4Y2x1ZGVTdGF0aWNQYXJlbnQgJiYgcGFyZW50LmNzcyggInBvc2l0aW9uIiApID09PSAic3RhdGljIiApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlyZXR1cm4gb3ZlcmZsb3dSZWdleC50ZXN0KCBwYXJlbnQuY3NzKCAib3ZlcmZsb3ciICkgKyBwYXJlbnQuY3NzKCAib3ZlcmZsb3cteSIgKSArCgkJCQlwYXJlbnQuY3NzKCAib3ZlcmZsb3cteCIgKSApOwoJCX0gKS5lcSggMCApOwoKCXJldHVybiBwb3NpdGlvbiA9PT0gImZpeGVkIiB8fCAhc2Nyb2xsUGFyZW50Lmxlbmd0aCA\/CgkJJCggdGhpc1sgMCBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQgKSA6CgkJc2Nyb2xsUGFyZW50Owp9OwoKCi8qIQogKiBqUXVlcnkgVUkgVGFiYmFibGUgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiA6dGFiYmFibGUgU2VsZWN0b3IKLy8+Pmdyb3VwOiBDb3JlCi8vPj5kZXNjcmlwdGlvbjogU2VsZWN0cyBlbGVtZW50cyB3aGljaCBjYW4gYmUgdGFiYmVkIHRvLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vdGFiYmFibGUtc2VsZWN0b3IvCgoKCnZhciB0YWJiYWJsZSA9ICQuZXh0ZW5kKCAkLmV4cHJbICI6IiBdLCB7Cgl0YWJiYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdmFyIHRhYkluZGV4ID0gJC5hdHRyKCBlbGVtZW50LCAidGFiaW5kZXgiICksCgkJCWhhc1RhYmluZGV4ID0gdGFiSW5kZXggIT0gbnVsbDsKCQlyZXR1cm4gKCAhaGFzVGFiaW5kZXggfHwgdGFiSW5kZXggPj0gMCApICYmICQudWkuZm9jdXNhYmxlKCBlbGVtZW50LCBoYXNUYWJpbmRleCApOwoJfQp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBVbmlxdWUgSUQgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiB1bmlxdWVJZAovLz4+Z3JvdXA6IENvcmUKLy8+PmRlc2NyaXB0aW9uOiBGdW5jdGlvbnMgdG8gZ2VuZXJhdGUgYW5kIHJlbW92ZSB1bmlxdWVJZCdzCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS91bmlxdWVJZC8KCgoKdmFyIHVuaXF1ZUlkID0gJC5mbi5leHRlbmQoIHsKCXVuaXF1ZUlkOiAoIGZ1bmN0aW9uKCkgewoJCXZhciB1dWlkID0gMDsKCgkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCWlmICggIXRoaXMuaWQgKSB7CgkJCQkJdGhpcy5pZCA9ICJ1aS1pZC0iICsgKCArK3V1aWQgKTsKCQkJCX0KCQkJfSApOwoJCX07Cgl9ICkoKSwKCglyZW1vdmVVbmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWlmICggL151aS1pZC1cZCskLy50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSApOwoJfQp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBBY2NvcmRpb24gMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBBY2NvcmRpb24KLy8+Pmdyb3VwOiBXaWRnZXRzCi8vIGpzY3M6ZGlzYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZGVzY3JpcHRpb246IERpc3BsYXlzIGNvbGxhcHNpYmxlIGNvbnRlbnQgcGFuZWxzIGZvciBwcmVzZW50aW5nIGluZm9ybWF0aW9uIGluIGEgbGltaXRlZCBhbW91bnQgb2Ygc3BhY2UuCi8vIGpzY3M6ZW5hYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9hY2NvcmRpb24vCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9hY2NvcmRpb24vCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvYWNjb3JkaW9uLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKdmFyIHdpZGdldHNBY2NvcmRpb24gPSAkLndpZGdldCggInVpLmFjY29yZGlvbiIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJb3B0aW9uczogewoJCWFjdGl2ZTogMCwKCQlhbmltYXRlOiB7fSwKCQljbGFzc2VzOiB7CgkJCSJ1aS1hY2NvcmRpb24taGVhZGVyIjogInVpLWNvcm5lci10b3AiLAoJCQkidWktYWNjb3JkaW9uLWhlYWRlci1jb2xsYXBzZWQiOiAidWktY29ybmVyLWFsbCIsCgkJCSJ1aS1hY2NvcmRpb24tY29udGVudCI6ICJ1aS1jb3JuZXItYm90dG9tIgoJCX0sCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlYWRlcjogIj4gbGkgPiA6Zmlyc3QtY2hpbGQsID4gOm5vdChsaSk6ZXZlbiIsCgkJaGVpZ2h0U3R5bGU6ICJhdXRvIiwKCQlpY29uczogewoJCQlhY3RpdmVIZWFkZXI6ICJ1aS1pY29uLXRyaWFuZ2xlLTEtcyIsCgkJCWhlYWRlcjogInVpLWljb24tdHJpYW5nbGUtMS1lIgoJCX0sCgoJCS8vIENhbGxiYWNrcwoJCWFjdGl2YXRlOiBudWxsLAoJCWJlZm9yZUFjdGl2YXRlOiBudWxsCgl9LAoKCWhpZGVQcm9wczogewoJCWJvcmRlclRvcFdpZHRoOiAiaGlkZSIsCgkJYm9yZGVyQm90dG9tV2lkdGg6ICJoaWRlIiwKCQlwYWRkaW5nVG9wOiAiaGlkZSIsCgkJcGFkZGluZ0JvdHRvbTogImhpZGUiLAoJCWhlaWdodDogImhpZGUiCgl9LAoKCXNob3dQcm9wczogewoJCWJvcmRlclRvcFdpZHRoOiAic2hvdyIsCgkJYm9yZGVyQm90dG9tV2lkdGg6ICJzaG93IiwKCQlwYWRkaW5nVG9wOiAic2hvdyIsCgkJcGFkZGluZ0JvdHRvbTogInNob3ciLAoJCWhlaWdodDogInNob3ciCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnByZXZTaG93ID0gdGhpcy5wcmV2SGlkZSA9ICQoKTsKCQl0aGlzLl9hZGRDbGFzcyggInVpLWFjY29yZGlvbiIsICJ1aS13aWRnZXQgdWktaGVscGVyLXJlc2V0IiApOwoJCXRoaXMuZWxlbWVudC5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoKCQkvLyBEb24ndCBhbGxvdyBjb2xsYXBzaWJsZTogZmFsc2UgYW5kIGFjdGl2ZTogZmFsc2UgLyBudWxsCgkJaWYgKCAhb3B0aW9ucy5jb2xsYXBzaWJsZSAmJiAoIG9wdGlvbnMuYWN0aXZlID09PSBmYWxzZSB8fCBvcHRpb25zLmFjdGl2ZSA9PSBudWxsICkgKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gMDsKCQl9CgoJCXRoaXMuX3Byb2Nlc3NQYW5lbHMoKTsKCgkJLy8gaGFuZGxlIG5lZ2F0aXZlIHZhbHVlcwoJCWlmICggb3B0aW9ucy5hY3RpdmUgPCAwICkgewoJCQlvcHRpb25zLmFjdGl2ZSArPSB0aGlzLmhlYWRlcnMubGVuZ3RoOwoJCX0KCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9nZXRDcmVhdGVFdmVudERhdGE6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCWhlYWRlcjogdGhpcy5hY3RpdmUsCgkJCXBhbmVsOiAhdGhpcy5hY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5hY3RpdmUubmV4dCgpCgkJfTsKCX0sCgoJX2NyZWF0ZUljb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgaWNvbiwgY2hpbGRyZW4sCgkJCWljb25zID0gdGhpcy5vcHRpb25zLmljb25zOwoKCQlpZiAoIGljb25zICkgewoJCQlpY29uID0gJCggIjxzcGFuPiIgKTsKCQkJdGhpcy5fYWRkQ2xhc3MoIGljb24sICJ1aS1hY2NvcmRpb24taGVhZGVyLWljb24iLCAidWktaWNvbiAiICsgaWNvbnMuaGVhZGVyICk7CgkJCWljb24ucHJlcGVuZFRvKCB0aGlzLmhlYWRlcnMgKTsKCQkJY2hpbGRyZW4gPSB0aGlzLmFjdGl2ZS5jaGlsZHJlbiggIi51aS1hY2NvcmRpb24taGVhZGVyLWljb24iICk7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBjaGlsZHJlbiwgaWNvbnMuaGVhZGVyICkKCQkJCS5fYWRkQ2xhc3MoIGNoaWxkcmVuLCBudWxsLCBpY29ucy5hY3RpdmVIZWFkZXIgKQoJCQkJLl9hZGRDbGFzcyggdGhpcy5oZWFkZXJzLCAidWktYWNjb3JkaW9uLWljb25zIiApOwoJCX0KCX0sCgoJX2Rlc3Ryb3lJY29uczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuaGVhZGVycywgInVpLWFjY29yZGlvbi1pY29ucyIgKTsKCQl0aGlzLmhlYWRlcnMuY2hpbGRyZW4oICIudWktYWNjb3JkaW9uLWhlYWRlci1pY29uIiApLnJlbW92ZSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRlbnRzOwoKCQkvLyBDbGVhbiB1cCBtYWluIGVsZW1lbnQKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggInJvbGUiICk7CgoJCS8vIENsZWFuIHVwIGhlYWRlcnMKCQl0aGlzLmhlYWRlcnMKCQkJLnJlbW92ZUF0dHIoICJyb2xlIGFyaWEtZXhwYW5kZWQgYXJpYS1zZWxlY3RlZCBhcmlhLWNvbnRyb2xzIHRhYkluZGV4IiApCgkJCS5yZW1vdmVVbmlxdWVJZCgpOwoKCQl0aGlzLl9kZXN0cm95SWNvbnMoKTsKCgkJLy8gQ2xlYW4gdXAgY29udGVudCBwYW5lbHMKCQljb250ZW50cyA9IHRoaXMuaGVhZGVycy5uZXh0KCkKCQkJLmNzcyggImRpc3BsYXkiLCAiIiApCgkJCS5yZW1vdmVBdHRyKCAicm9sZSBhcmlhLWhpZGRlbiBhcmlhLWxhYmVsbGVkYnkiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7CgkJCWNvbnRlbnRzLmNzcyggImhlaWdodCIsICIiICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLmV2ZW50ICkgewoJCQkJdGhpcy5fb2ZmKCB0aGlzLmhlYWRlcnMsIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCQl9CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgJiYgIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJpY29ucyIgKSB7CgkJCXRoaXMuX2Rlc3Ryb3lJY29ucygpOwoJCQlpZiAoIHZhbHVlICkgewoJCQkJdGhpcy5fY3JlYXRlSWNvbnMoKTsKCQkJfQoJCX0KCX0sCgoJX3NldE9wdGlvbkRpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7CgoJCXRoaXMuZWxlbWVudC5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgoJCS8vIFN1cHBvcnQ6IElFOCBPbmx5CgkJLy8gIzUzMzIgLyAjNjA1OSAtIG9wYWNpdHkgZG9lc24ndCBjYXNjYWRlIHRvIHBvc2l0aW9uZWQgZWxlbWVudHMgaW4gSUUKCQkvLyBzbyB3ZSBuZWVkIHRvIGFkZCB0aGUgZGlzYWJsZWQgY2xhc3MgdG8gdGhlIGhlYWRlcnMgYW5kIHBhbmVscwoJCXRoaXMuX3RvZ2dsZUNsYXNzKCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICk7CgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIHRoaXMuaGVhZGVycy5hZGQoIHRoaXMuaGVhZGVycy5uZXh0KCkgKSwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwKCQkJISF2YWx1ZSApOwoJfSwKCglfa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnQuYWx0S2V5IHx8IGV2ZW50LmN0cmxLZXkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBrZXlDb2RlID0gJC51aS5rZXlDb2RlLAoJCQlsZW5ndGggPSB0aGlzLmhlYWRlcnMubGVuZ3RoLAoJCQljdXJyZW50SW5kZXggPSB0aGlzLmhlYWRlcnMuaW5kZXgoIGV2ZW50LnRhcmdldCApLAoJCQl0b0ZvY3VzID0gZmFsc2U7CgoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJY2FzZSBrZXlDb2RlLlJJR0hUOgoJCWNhc2Uga2V5Q29kZS5ET1dOOgoJCQl0b0ZvY3VzID0gdGhpcy5oZWFkZXJzWyAoIGN1cnJlbnRJbmRleCArIDEgKSAlIGxlbmd0aCBdOwoJCQlicmVhazsKCQljYXNlIGtleUNvZGUuTEVGVDoKCQljYXNlIGtleUNvZGUuVVA6CgkJCXRvRm9jdXMgPSB0aGlzLmhlYWRlcnNbICggY3VycmVudEluZGV4IC0gMSArIGxlbmd0aCApICUgbGVuZ3RoIF07CgkJCWJyZWFrOwoJCWNhc2Uga2V5Q29kZS5TUEFDRToKCQljYXNlIGtleUNvZGUuRU5URVI6CgkJCXRoaXMuX2V2ZW50SGFuZGxlciggZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSBrZXlDb2RlLkhPTUU6CgkJCXRvRm9jdXMgPSB0aGlzLmhlYWRlcnNbIDAgXTsKCQkJYnJlYWs7CgkJY2FzZSBrZXlDb2RlLkVORDoKCQkJdG9Gb2N1cyA9IHRoaXMuaGVhZGVyc1sgbGVuZ3RoIC0gMSBdOwoJCQlicmVhazsKCQl9CgoJCWlmICggdG9Gb2N1cyApIHsKCQkJJCggZXZlbnQudGFyZ2V0ICkuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQkJJCggdG9Gb2N1cyApLmF0dHIoICJ0YWJJbmRleCIsIDAgKTsKCQkJJCggdG9Gb2N1cyApLnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9LAoKCV9wYW5lbEtleURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCAmJiBldmVudC5jdHJsS2V5ICkgewoJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucHJldigpLnRyaWdnZXIoICJmb2N1cyIgKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXRoaXMuX3Byb2Nlc3NQYW5lbHMoKTsKCgkJLy8gV2FzIGNvbGxhcHNlZCBvciBubyBwYW5lbAoJCWlmICggKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSA9PT0gdHJ1ZSApIHx8CgkJCQkhdGhpcy5oZWFkZXJzLmxlbmd0aCApIHsKCQkJb3B0aW9ucy5hY3RpdmUgPSBmYWxzZTsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgoJCS8vIGFjdGl2ZSBmYWxzZSBvbmx5IHdoZW4gY29sbGFwc2libGUgaXMgdHJ1ZQoJCX0gZWxzZSBpZiAoIG9wdGlvbnMuYWN0aXZlID09PSBmYWxzZSApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCgkJLy8gd2FzIGFjdGl2ZSwgYnV0IGFjdGl2ZSBwYW5lbCBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLmVsZW1lbnRbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoKCQkJLy8gYWxsIHJlbWFpbmluZyBwYW5lbCBhcmUgZGlzYWJsZWQKCQkJaWYgKCB0aGlzLmhlYWRlcnMubGVuZ3RoID09PSB0aGlzLmhlYWRlcnMuZmluZCggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKS5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgoJCQkvLyBhY3RpdmF0ZSBwcmV2aW91cyBwYW5lbAoJCQl9IGVsc2UgewoJCQkJdGhpcy5fYWN0aXZhdGUoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSApOwoJCQl9CgoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSBwYW5lbCBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy5oZWFkZXJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fZGVzdHJveUljb25zKCk7CgoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3Byb2Nlc3NQYW5lbHM6IGZ1bmN0aW9uKCkgewoJCXZhciBwcmV2SGVhZGVycyA9IHRoaXMuaGVhZGVycywKCQkJcHJldlBhbmVscyA9IHRoaXMucGFuZWxzOwoKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5vcHRpb25zLmhlYWRlciApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmhlYWRlcnMsICJ1aS1hY2NvcmRpb24taGVhZGVyIHVpLWFjY29yZGlvbi1oZWFkZXItY29sbGFwc2VkIiwKCQkJInVpLXN0YXRlLWRlZmF1bHQiICk7CgoJCXRoaXMucGFuZWxzID0gdGhpcy5oZWFkZXJzLm5leHQoKS5maWx0ZXIoICI6bm90KC51aS1hY2NvcmRpb24tY29udGVudC1hY3RpdmUpIiApLmhpZGUoKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5wYW5lbHMsICJ1aS1hY2NvcmRpb24tY29udGVudCIsICJ1aS1oZWxwZXItcmVzZXQgdWktd2lkZ2V0LWNvbnRlbnQiICk7CgoJCS8vIEF2b2lkIG1lbW9yeSBsZWFrcyAoIzEwMDU2KQoJCWlmICggcHJldlBhbmVscyApIHsKCQkJdGhpcy5fb2ZmKCBwcmV2SGVhZGVycy5ub3QoIHRoaXMuaGVhZGVycyApICk7CgkJCXRoaXMuX29mZiggcHJldlBhbmVscy5ub3QoIHRoaXMucGFuZWxzICkgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgbWF4SGVpZ2h0LAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQloZWlnaHRTdHlsZSA9IG9wdGlvbnMuaGVpZ2h0U3R5bGUsCgkJCXBhcmVudCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCgkJdGhpcy5hY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBvcHRpb25zLmFjdGl2ZSApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmFjdGl2ZSwgInVpLWFjY29yZGlvbi1oZWFkZXItYWN0aXZlIiwgInVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkuX3JlbW92ZUNsYXNzKCB0aGlzLmFjdGl2ZSwgInVpLWFjY29yZGlvbi1oZWFkZXItY29sbGFwc2VkIiApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmFjdGl2ZS5uZXh0KCksICJ1aS1hY2NvcmRpb24tY29udGVudC1hY3RpdmUiICk7CgkJdGhpcy5hY3RpdmUubmV4dCgpLnNob3coKTsKCgkJdGhpcy5oZWFkZXJzCgkJCS5hdHRyKCAicm9sZSIsICJ0YWIiICkKCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGhlYWRlciA9ICQoIHRoaXMgKSwKCQkJCQloZWFkZXJJZCA9IGhlYWRlci51bmlxdWVJZCgpLmF0dHIoICJpZCIgKSwKCQkJCQlwYW5lbCA9IGhlYWRlci5uZXh0KCksCgkJCQkJcGFuZWxJZCA9IHBhbmVsLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApOwoJCQkJaGVhZGVyLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcGFuZWxJZCApOwoJCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGhlYWRlcklkICk7CgkJCX0gKQoJCQkubmV4dCgpCgkJCQkuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7CgoJCXRoaXMuaGVhZGVycwoJCQkubm90KCB0aGlzLmFjdGl2ZSApCgkJCQkuYXR0ciggewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCQkJdGFiSW5kZXg6IC0xCgkJCQl9ICkKCQkJCS5uZXh0KCkKCQkJCQkuYXR0ciggewoJCQkJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQkJCQl9ICkKCQkJCQkuaGlkZSgpOwoKCQkvLyBNYWtlIHN1cmUgYXQgbGVhc3Qgb25lIGhlYWRlciBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmhlYWRlcnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUuYXR0ciggewoJCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCXRhYkluZGV4OiAwCgkJCX0gKQoJCQkJLm5leHQoKQoJCQkJCS5hdHRyKCB7CgkJCQkJCSJhcmlhLWhpZGRlbiI6ICJmYWxzZSIKCQkJCQl9ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGVJY29ucygpOwoKCQl0aGlzLl9zZXR1cEV2ZW50cyggb3B0aW9ucy5ldmVudCApOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWxlbSA9ICQoIHRoaXMgKSwKCQkJCQlwb3NpdGlvbiA9IGVsZW0uY3NzKCAicG9zaXRpb24iICk7CgoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQltYXhIZWlnaHQgLT0gZWxlbS5vdXRlckhlaWdodCggdHJ1ZSApOwoJCQl9ICk7CgoJCQl0aGlzLmhlYWRlcnMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0gKTsKCgkJCXRoaXMuaGVhZGVycy5uZXh0KCkKCQkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuaGVpZ2h0KCBNYXRoLm1heCggMCwgbWF4SGVpZ2h0IC0KCQkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQkJfSApCgkJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLmhlYWRlcnMubmV4dCgpCgkJCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGlzVmlzaWJsZSA9ICQoIHRoaXMgKS5pcyggIjp2aXNpYmxlIiApOwoJCQkJCWlmICggIWlzVmlzaWJsZSApIHsKCQkJCQkJJCggdGhpcyApLnNob3coKTsKCQkJCQl9CgkJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmNzcyggImhlaWdodCIsICIiICkuaGVpZ2h0KCkgKTsKCQkJCQlpZiAoICFpc1Zpc2libGUgKSB7CgkJCQkJCSQoIHRoaXMgKS5oaWRlKCk7CgkJCQkJfQoJCQkJfSApCgkJCQkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApWyAwIF07CgoJCS8vIFRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwKCQlpZiAoIGFjdGl2ZSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gVHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50bHkgYWN0aXZlIGhlYWRlcgoJCWFjdGl2ZSA9IGFjdGl2ZSB8fCB0aGlzLmFjdGl2ZVsgMCBdOwoKCQl0aGlzLl9ldmVudEhhbmRsZXIoIHsKCQkJdGFyZ2V0OiBhY3RpdmUsCgkJCWN1cnJlbnRUYXJnZXQ6IGFjdGl2ZSwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0gKTsKCX0sCgoJX2ZpbmRBY3RpdmU6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdHlwZW9mIHNlbGVjdG9yID09PSAibnVtYmVyIiA\/IHRoaXMuaGVhZGVycy5lcSggc2VsZWN0b3IgKSA6ICQoKTsKCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGV2ZW50cyA9IHsKCQkJa2V5ZG93bjogIl9rZXlkb3duIgoJCX07CgkJaWYgKCBldmVudCApIHsKCQkJJC5lYWNoKCBldmVudC5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSApOwoJCX0KCgkJdGhpcy5fb2ZmKCB0aGlzLmhlYWRlcnMuYWRkKCB0aGlzLmhlYWRlcnMubmV4dCgpICkgKTsKCQl0aGlzLl9vbiggdGhpcy5oZWFkZXJzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy5oZWFkZXJzLm5leHQoKSwgeyBrZXlkb3duOiAiX3BhbmVsS2V5RG93biIgfSApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy5oZWFkZXJzICk7CgkJdGhpcy5fZm9jdXNhYmxlKCB0aGlzLmhlYWRlcnMgKTsKCX0sCgoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBhY3RpdmVDaGlsZHJlbiwgY2xpY2tlZENoaWxkcmVuLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwKCQkJY2xpY2tlZCA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gY2xpY2tlZFsgMCBdID09PSBhY3RpdmVbIDAgXSwKCQkJY29sbGFwc2luZyA9IGNsaWNrZWRJc0FjdGl2ZSAmJiBvcHRpb25zLmNvbGxhcHNpYmxlLAoJCQl0b1Nob3cgPSBjb2xsYXBzaW5nID8gJCgpIDogY2xpY2tlZC5uZXh0KCksCgkJCXRvSGlkZSA9IGFjdGl2ZS5uZXh0KCksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCW9sZEhlYWRlcjogYWN0aXZlLAoJCQkJb2xkUGFuZWw6IHRvSGlkZSwKCQkJCW5ld0hlYWRlcjogY29sbGFwc2luZyA\/ICQoKSA6IGNsaWNrZWQsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICgKCgkJCQkvLyBjbGljayBvbiBhY3RpdmUgaGVhZGVyLCBidXQgbm90IGNvbGxhcHNpYmxlCgkJCQkoIGNsaWNrZWRJc0FjdGl2ZSAmJiAhb3B0aW9ucy5jb2xsYXBzaWJsZSApIHx8CgoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMuaGVhZGVycy5pbmRleCggY2xpY2tlZCApOwoKCQkvLyBXaGVuIHRoZSBjYWxsIHRvIC5fdG9nZ2xlKCkgY29tZXMgYWZ0ZXIgdGhlIGNsYXNzIGNoYW5nZXMKCQkvLyBpdCBjYXVzZXMgYSB2ZXJ5IG9kZCBidWcgaW4gSUUgOCAoc2VlICM2NzIwKQoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogY2xpY2tlZDsKCQl0aGlzLl90b2dnbGUoIGV2ZW50RGF0YSApOwoKCQkvLyBTd2l0Y2ggY2xhc3NlcwoJCS8vIGNvcm5lciBjbGFzc2VzIG9uIHRoZSBwcmV2aW91c2x5IGFjdGl2ZSBoZWFkZXIgc3RheSBhZnRlciB0aGUgYW5pbWF0aW9uCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGFjdGl2ZSwgInVpLWFjY29yZGlvbi1oZWFkZXItYWN0aXZlIiwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQlpZiAoIG9wdGlvbnMuaWNvbnMgKSB7CgkJCWFjdGl2ZUNoaWxkcmVuID0gYWN0aXZlLmNoaWxkcmVuKCAiLnVpLWFjY29yZGlvbi1oZWFkZXItaWNvbiIgKTsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGFjdGl2ZUNoaWxkcmVuLCBudWxsLCBvcHRpb25zLmljb25zLmFjdGl2ZUhlYWRlciApCgkJCQkuX2FkZENsYXNzKCBhY3RpdmVDaGlsZHJlbiwgbnVsbCwgb3B0aW9ucy5pY29ucy5oZWFkZXIgKTsKCQl9CgoJCWlmICggIWNsaWNrZWRJc0FjdGl2ZSApIHsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGNsaWNrZWQsICJ1aS1hY2NvcmRpb24taGVhZGVyLWNvbGxhcHNlZCIgKQoJCQkJLl9hZGRDbGFzcyggY2xpY2tlZCwgInVpLWFjY29yZGlvbi1oZWFkZXItYWN0aXZlIiwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJaWYgKCBvcHRpb25zLmljb25zICkgewoJCQkJY2xpY2tlZENoaWxkcmVuID0gY2xpY2tlZC5jaGlsZHJlbiggIi51aS1hY2NvcmRpb24taGVhZGVyLWljb24iICk7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggY2xpY2tlZENoaWxkcmVuLCBudWxsLCBvcHRpb25zLmljb25zLmhlYWRlciApCgkJCQkJLl9hZGRDbGFzcyggY2xpY2tlZENoaWxkcmVuLCBudWxsLCBvcHRpb25zLmljb25zLmFjdGl2ZUhlYWRlciApOwoJCQl9CgoJCQl0aGlzLl9hZGRDbGFzcyggY2xpY2tlZC5uZXh0KCksICJ1aS1hY2NvcmRpb24tY29udGVudC1hY3RpdmUiICk7CgkJfQoJfSwKCglfdG9nZ2xlOiBmdW5jdGlvbiggZGF0YSApIHsKCQl2YXIgdG9TaG93ID0gZGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gdGhpcy5wcmV2U2hvdy5sZW5ndGggPyB0aGlzLnByZXZTaG93IDogZGF0YS5vbGRQYW5lbDsKCgkJLy8gSGFuZGxlIGFjdGl2YXRpbmcgYSBwYW5lbCBkdXJpbmcgdGhlIGFuaW1hdGlvbiBmb3IgYW5vdGhlciBhY3RpdmF0aW9uCgkJdGhpcy5wcmV2U2hvdy5hZGQoIHRoaXMucHJldkhpZGUgKS5zdG9wKCB0cnVlLCB0cnVlICk7CgkJdGhpcy5wcmV2U2hvdyA9IHRvU2hvdzsKCQl0aGlzLnByZXZIaWRlID0gdG9IaWRlOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLl9hbmltYXRlKCB0b1Nob3csIHRvSGlkZSwgZGF0YSApOwoJCX0gZWxzZSB7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXRvU2hvdy5zaG93KCk7CgkJCXRoaXMuX3RvZ2dsZUNvbXBsZXRlKCBkYXRhICk7CgkJfQoKCQl0b0hpZGUuYXR0ciggewoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQl9ICk7CgkJdG9IaWRlLnByZXYoKS5hdHRyKCB7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiCgkJfSApOwoKCQkvLyBpZiB3ZSdyZSBzd2l0Y2hpbmcgcGFuZWxzLCByZW1vdmUgdGhlIG9sZCBoZWFkZXIgZnJvbSB0aGUgdGFiIG9yZGVyCgkJLy8gaWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyBoZWFkZXIgZnJvbSB0aGUgdGFiIG9yZGVyCgkJLy8gaWYgd2UncmUgY29sbGFwc2luZywgdGhlbiBrZWVwIHRoZSBjb2xsYXBzaW5nIGhlYWRlciBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCXRvSGlkZS5wcmV2KCkuYXR0ciggewoJCQkJInRhYkluZGV4IjogLTEsCgkJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIKCQkJfSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMuaGVhZGVycy5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHBhcnNlSW50KCAkKCB0aGlzICkuYXR0ciggInRhYkluZGV4IiApLCAxMCApID09PSAwOwoJCQl9ICkKCQkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93CgkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCAiZmFsc2UiICkKCQkJLnByZXYoKQoJCQkJLmF0dHIoIHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSApOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIHRvU2hvdywgdG9IaWRlLCBkYXRhICkgewoJCXZhciB0b3RhbCwgZWFzaW5nLCBkdXJhdGlvbiwKCQkJdGhhdCA9IHRoaXMsCgkJCWFkanVzdCA9IDAsCgkJCWJveFNpemluZyA9IHRvU2hvdy5jc3MoICJib3gtc2l6aW5nIiApLAoJCQlkb3duID0gdG9TaG93Lmxlbmd0aCAmJgoJCQkJKCAhdG9IaWRlLmxlbmd0aCB8fCAoIHRvU2hvdy5pbmRleCgpIDwgdG9IaWRlLmluZGV4KCkgKSApLAoJCQlhbmltYXRlID0gdGhpcy5vcHRpb25zLmFuaW1hdGUgfHwge30sCgkJCW9wdGlvbnMgPSBkb3duICYmIGFuaW1hdGUuZG93biB8fCBhbmltYXRlLAoJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCQkJdGhhdC5fdG9nZ2xlQ29tcGxldGUoIGRhdGEgKTsKCQkJfTsKCgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCWR1cmF0aW9uID0gb3B0aW9uczsKCQl9CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7CgkJCWVhc2luZyA9IG9wdGlvbnM7CgkJfQoKCQkvLyBmYWxsIGJhY2sgZnJvbSBvcHRpb25zIHRvIGFuaW1hdGlvbiBpbiBjYXNlIG9mIHBhcnRpYWwgZG93biBzZXR0aW5ncwoJCWVhc2luZyA9IGVhc2luZyB8fCBvcHRpb25zLmVhc2luZyB8fCBhbmltYXRlLmVhc2luZzsKCQlkdXJhdGlvbiA9IGR1cmF0aW9uIHx8IG9wdGlvbnMuZHVyYXRpb24gfHwgYW5pbWF0ZS5kdXJhdGlvbjsKCgkJaWYgKCAhdG9IaWRlLmxlbmd0aCApIHsKCQkJcmV0dXJuIHRvU2hvdy5hbmltYXRlKCB0aGlzLnNob3dQcm9wcywgZHVyYXRpb24sIGVhc2luZywgY29tcGxldGUgKTsKCQl9CgkJaWYgKCAhdG9TaG93Lmxlbmd0aCApIHsKCQkJcmV0dXJuIHRvSGlkZS5hbmltYXRlKCB0aGlzLmhpZGVQcm9wcywgZHVyYXRpb24sIGVhc2luZywgY29tcGxldGUgKTsKCQl9CgoJCXRvdGFsID0gdG9TaG93LnNob3coKS5vdXRlckhlaWdodCgpOwoJCXRvSGlkZS5hbmltYXRlKCB0aGlzLmhpZGVQcm9wcywgewoJCQlkdXJhdGlvbjogZHVyYXRpb24sCgkJCWVhc2luZzogZWFzaW5nLAoJCQlzdGVwOiBmdW5jdGlvbiggbm93LCBmeCApIHsKCQkJCWZ4Lm5vdyA9IE1hdGgucm91bmQoIG5vdyApOwoJCQl9CgkJfSApOwoJCXRvU2hvdwoJCQkuaGlkZSgpCgkJCS5hbmltYXRlKCB0aGlzLnNob3dQcm9wcywgewoJCQkJZHVyYXRpb246IGR1cmF0aW9uLAoJCQkJZWFzaW5nOiBlYXNpbmcsCgkJCQljb21wbGV0ZTogY29tcGxldGUsCgkJCQlzdGVwOiBmdW5jdGlvbiggbm93LCBmeCApIHsKCQkJCQlmeC5ub3cgPSBNYXRoLnJvdW5kKCBub3cgKTsKCQkJCQlpZiAoIGZ4LnByb3AgIT09ICJoZWlnaHQiICkgewoJCQkJCQlpZiAoIGJveFNpemluZyA9PT0gImNvbnRlbnQtYm94IiApIHsKCQkJCQkJCWFkanVzdCArPSBmeC5ub3c7CgkJCQkJCX0KCQkJCQl9IGVsc2UgaWYgKCB0aGF0Lm9wdGlvbnMuaGVpZ2h0U3R5bGUgIT09ICJjb250ZW50IiApIHsKCQkJCQkJZngubm93ID0gTWF0aC5yb3VuZCggdG90YWwgLSB0b0hpZGUub3V0ZXJIZWlnaHQoKSAtIGFkanVzdCApOwoJCQkJCQlhZGp1c3QgPSAwOwoJCQkJCX0KCQkJCX0KCQkJfSApOwoJfSwKCglfdG9nZ2xlQ29tcGxldGU6IGZ1bmN0aW9uKCBkYXRhICkgewoJCXZhciB0b0hpZGUgPSBkYXRhLm9sZFBhbmVsLAoJCQlwcmV2ID0gdG9IaWRlLnByZXYoKTsKCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRvSGlkZSwgInVpLWFjY29yZGlvbi1jb250ZW50LWFjdGl2ZSIgKTsKCQl0aGlzLl9yZW1vdmVDbGFzcyggcHJldiwgInVpLWFjY29yZGlvbi1oZWFkZXItYWN0aXZlIiApCgkJCS5fYWRkQ2xhc3MoIHByZXYsICJ1aS1hY2NvcmRpb24taGVhZGVyLWNvbGxhcHNlZCIgKTsKCgkJLy8gV29yayBhcm91bmQgZm9yIHJlbmRlcmluZyBidWcgaW4gSUUgKCM1NDIxKQoJCWlmICggdG9IaWRlLmxlbmd0aCApIHsKCQkJdG9IaWRlLnBhcmVudCgpWyAwIF0uY2xhc3NOYW1lID0gdG9IaWRlLnBhcmVudCgpWyAwIF0uY2xhc3NOYW1lOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiYWN0aXZhdGUiLCBudWxsLCBkYXRhICk7Cgl9Cn0gKTsKCgoKdmFyIHNhZmVBY3RpdmVFbGVtZW50ID0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCA9IGZ1bmN0aW9uKCBkb2N1bWVudCApIHsKCXZhciBhY3RpdmVFbGVtZW50OwoKCS8vIFN1cHBvcnQ6IElFIDkgb25seQoJLy8gSUU5IHRocm93cyBhbiAiVW5zcGVjaWZpZWQgZXJyb3IiIGFjY2Vzc2luZyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGZyb20gYW4gPGlmcmFtZT4KCXRyeSB7CgkJYWN0aXZlRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7Cgl9IGNhdGNoICggZXJyb3IgKSB7CgkJYWN0aXZlRWxlbWVudCA9IGRvY3VtZW50LmJvZHk7Cgl9CgoJLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHkKCS8vIElFIG1heSByZXR1cm4gbnVsbCBpbnN0ZWFkIG9mIGFuIGVsZW1lbnQKCS8vIEludGVyZXN0aW5nbHksIHRoaXMgb25seSBzZWVtcyB0byBvY2N1ciB3aGVuIE5PVCBpbiBhbiBpZnJhbWUKCWlmICggIWFjdGl2ZUVsZW1lbnQgKSB7CgkJYWN0aXZlRWxlbWVudCA9IGRvY3VtZW50LmJvZHk7Cgl9CgoJLy8gU3VwcG9ydDogSUUgMTEgb25seQoJLy8gSUUxMSByZXR1cm5zIGEgc2VlbWluZ2x5IGVtcHR5IG9iamVjdCBpbiBzb21lIGNhc2VzIHdoZW4gYWNjZXNzaW5nCgkvLyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGZyb20gYW4gPGlmcmFtZT4KCWlmICggIWFjdGl2ZUVsZW1lbnQubm9kZU5hbWUgKSB7CgkJYWN0aXZlRWxlbWVudCA9IGRvY3VtZW50LmJvZHk7Cgl9CgoJcmV0dXJuIGFjdGl2ZUVsZW1lbnQ7Cn07CgoKLyohCiAqIGpRdWVyeSBVSSBNZW51IDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogTWVudQovLz4+Z3JvdXA6IFdpZGdldHMKLy8+PmRlc2NyaXB0aW9uOiBDcmVhdGVzIG5lc3RhYmxlIG1lbnVzLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vbWVudS8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL21lbnUvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvbWVudS5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCnZhciB3aWRnZXRzTWVudSA9ICQud2lkZ2V0KCAidWkubWVudSIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8dWw+IiwKCWRlbGF5OiAzMDAsCglvcHRpb25zOiB7CgkJaWNvbnM6IHsKCQkJc3VibWVudTogInVpLWljb24tY2FyZXQtMS1lIgoJCX0sCgkJaXRlbXM6ICI+ICoiLAoJCW1lbnVzOiAidWwiLAoJCXBvc2l0aW9uOiB7CgkJCW15OiAibGVmdCB0b3AiLAoJCQlhdDogInJpZ2h0IHRvcCIKCQl9LAoJCXJvbGU6ICJtZW51IiwKCgkJLy8gQ2FsbGJhY2tzCgkJYmx1cjogbnVsbCwKCQlmb2N1czogbnVsbCwKCQlzZWxlY3Q6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5hY3RpdmVNZW51ID0gdGhpcy5lbGVtZW50OwoKCQkvLyBGbGFnIHVzZWQgdG8gcHJldmVudCBmaXJpbmcgb2YgdGhlIGNsaWNrIGhhbmRsZXIKCQkvLyBhcyB0aGUgZXZlbnQgYnViYmxlcyB1cCB0aHJvdWdoIG5lc3RlZCBtZW51cwoJCXRoaXMubW91c2VIYW5kbGVkID0gZmFsc2U7CgkJdGhpcy5lbGVtZW50CgkJCS51bmlxdWVJZCgpCgkJCS5hdHRyKCB7CgkJCQlyb2xlOiB0aGlzLm9wdGlvbnMucm9sZSwKCQkJCXRhYkluZGV4OiAwCgkJCX0gKTsKCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1tZW51IiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCIgKTsKCQl0aGlzLl9vbiggewoKCQkJLy8gUHJldmVudCBmb2N1cyBmcm9tIHN0aWNraW5nIHRvIGxpbmtzIGluc2lkZSBtZW51IGFmdGVyIGNsaWNraW5nCgkJCS8vIHRoZW0gKGZvY3VzIHNob3VsZCBhbHdheXMgc3RheSBvbiBVTCBkdXJpbmcgbmF2aWdhdGlvbikuCgkJCSJtb3VzZWRvd24gLnVpLW1lbnUtaXRlbSI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0sCgkJCSJjbGljayAudWktbWVudS1pdGVtIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApOwoJCQkJdmFyIGFjdGl2ZSA9ICQoICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICk7CgkJCQlpZiAoICF0aGlzLm1vdXNlSGFuZGxlZCAmJiB0YXJnZXQubm90KCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLmxlbmd0aCApIHsKCQkJCQl0aGlzLnNlbGVjdCggZXZlbnQgKTsKCgkJCQkJLy8gT25seSBzZXQgdGhlIG1vdXNlSGFuZGxlZCBmbGFnIGlmIHRoZSBldmVudCB3aWxsIGJ1YmJsZSwgc2VlICM5NDY5LgoJCQkJCWlmICggIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQkJCXRoaXMubW91c2VIYW5kbGVkID0gdHJ1ZTsKCQkJCQl9CgoJCQkJCS8vIE9wZW4gc3VibWVudSBvbiBjbGljawoJCQkJCWlmICggdGFyZ2V0LmhhcyggIi51aS1tZW51IiApLmxlbmd0aCApIHsKCQkJCQkJdGhpcy5leHBhbmQoIGV2ZW50ICk7CgkJCQkJfSBlbHNlIGlmICggIXRoaXMuZWxlbWVudC5pcyggIjpmb2N1cyIgKSAmJgoJCQkJCQkJYWN0aXZlLmNsb3Nlc3QoICIudWktbWVudSIgKS5sZW5ndGggKSB7CgoJCQkJCQkvLyBSZWRpcmVjdCBmb2N1cyB0byB0aGUgbWVudQoJCQkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImZvY3VzIiwgWyB0cnVlIF0gKTsKCgkJCQkJCS8vIElmIHRoZSBhY3RpdmUgaXRlbSBpcyBvbiB0aGUgdG9wIGxldmVsLCBsZXQgaXQgc3RheSBhY3RpdmUuCgkJCQkJCS8vIE90aGVyd2lzZSwgYmx1ciB0aGUgYWN0aXZlIGl0ZW0gc2luY2UgaXQgaXMgbm8gbG9uZ2VyIHZpc2libGUuCgkJCQkJCWlmICggdGhpcy5hY3RpdmUgJiYgdGhpcy5hY3RpdmUucGFyZW50cyggIi51aS1tZW51IiApLmxlbmd0aCA9PT0gMSApIHsKCQkJCQkJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9LAoJCQkibW91c2VlbnRlciAudWktbWVudS1pdGVtIjogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIElnbm9yZSBtb3VzZSBldmVudHMgd2hpbGUgdHlwZWFoZWFkIGlzIGFjdGl2ZSwgc2VlICMxMDQ1OC4KCQkJCS8vIFByZXZlbnRzIGZvY3VzaW5nIHRoZSB3cm9uZyBpdGVtIHdoZW4gdHlwZWFoZWFkIGNhdXNlcyBhIHNjcm9sbCB3aGlsZSB0aGUgbW91c2UKCQkJCS8vIGlzIG92ZXIgYW4gaXRlbSBpbiB0aGUgbWVudQoJCQkJaWYgKCB0aGlzLnByZXZpb3VzRmlsdGVyICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQl2YXIgYWN0dWFsVGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1tZW51LWl0ZW0iICksCgkJCQkJdGFyZ2V0ID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApOwoKCQkJCS8vIElnbm9yZSBidWJibGVkIGV2ZW50cyBvbiBwYXJlbnQgaXRlbXMsIHNlZSAjMTE2NDEKCQkJCWlmICggYWN0dWFsVGFyZ2V0WyAwIF0gIT09IHRhcmdldFsgMCBdICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgdWktc3RhdGUtYWN0aXZlIGNsYXNzIGZyb20gc2libGluZ3Mgb2YgdGhlIG5ld2x5IGZvY3VzZWQgbWVudSBpdGVtCgkJCQkvLyB0byBhdm9pZCBhIGp1bXAgY2F1c2VkIGJ5IGFkamFjZW50IGVsZW1lbnRzIGJvdGggaGF2aW5nIGEgY2xhc3Mgd2l0aCBhIGJvcmRlcgoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRhcmdldC5zaWJsaW5ncygpLmNoaWxkcmVuKCAiLnVpLXN0YXRlLWFjdGl2ZSIgKSwKCQkJCQludWxsLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJdGhpcy5mb2N1cyggZXZlbnQsIHRhcmdldCApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiAiY29sbGFwc2VBbGwiLAoJCQkibW91c2VsZWF2ZSAudWktbWVudSI6ICJjb2xsYXBzZUFsbCIsCgkJCWZvY3VzOiBmdW5jdGlvbiggZXZlbnQsIGtlZXBBY3RpdmVJdGVtICkgewoKCQkJCS8vIElmIHRoZXJlJ3MgYWxyZWFkeSBhbiBhY3RpdmUgaXRlbSwga2VlcCBpdCBhY3RpdmUKCQkJCS8vIElmIG5vdCwgYWN0aXZhdGUgdGhlIGZpcnN0IGl0ZW0KCQkJCXZhciBpdGVtID0gdGhpcy5hY3RpdmUgfHwgdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApLmVxKCAwICk7CgoJCQkJaWYgKCAha2VlcEFjdGl2ZUl0ZW0gKSB7CgkJCQkJdGhpcy5mb2N1cyggZXZlbnQsIGl0ZW0gKTsKCQkJCX0KCQkJfSwKCQkJYmx1cjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBub3RDb250YWluZWQgPSAhJC5jb250YWlucygKCQkJCQkJdGhpcy5lbGVtZW50WyAwIF0sCgkJCQkJCSQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApCgkJCQkJKTsKCQkJCQlpZiAoIG5vdENvbnRhaW5lZCApIHsKCQkJCQkJdGhpcy5jb2xsYXBzZUFsbCggZXZlbnQgKTsKCQkJCQl9CgkJCQl9ICk7CgkJCX0sCgkJCWtleWRvd246ICJfa2V5ZG93biIKCQl9ICk7CgoJCXRoaXMucmVmcmVzaCgpOwoKCQkvLyBDbGlja3Mgb3V0c2lkZSBvZiBhIG1lbnUgY29sbGFwc2UgYW55IG9wZW4gbWVudXMKCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCB0aGlzLl9jbG9zZU9uRG9jdW1lbnRDbGljayggZXZlbnQgKSApIHsKCQkJCQl0aGlzLmNvbGxhcHNlQWxsKCBldmVudCApOwoJCQkJfQoKCQkJCS8vIFJlc2V0IHRoZSBtb3VzZUhhbmRsZWQgZmxhZwoJCQkJdGhpcy5tb3VzZUhhbmRsZWQgPSBmYWxzZTsKCQkJfQoJCX0gKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtcyA9IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLW1lbnUtaXRlbSIgKQoJCQkJLnJlbW92ZUF0dHIoICJyb2xlIGFyaWEtZGlzYWJsZWQiICksCgkJCXN1Ym1lbnVzID0gaXRlbXMuY2hpbGRyZW4oICIudWktbWVudS1pdGVtLXdyYXBwZXIiICkKCQkJCS5yZW1vdmVVbmlxdWVJZCgpCgkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IHJvbGUgYXJpYS1oYXNwb3B1cCIgKTsKCgkJLy8gRGVzdHJveSAoc3ViKW1lbnVzCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiApCgkJCS5maW5kKCAiLnVpLW1lbnUiICkuYWRkQmFjaygpCgkJCQkucmVtb3ZlQXR0ciggInJvbGUgYXJpYS1sYWJlbGxlZGJ5IGFyaWEtZXhwYW5kZWQgYXJpYS1oaWRkZW4gYXJpYS1kaXNhYmxlZCAiICsKCQkJCQkidGFiSW5kZXgiICkKCQkJCS5yZW1vdmVVbmlxdWVJZCgpCgkJCQkuc2hvdygpOwoKCQlzdWJtZW51cy5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgZWxlbSA9ICQoIHRoaXMgKTsKCQkJaWYgKCBlbGVtLmRhdGEoICJ1aS1tZW51LXN1Ym1lbnUtY2FyZXQiICkgKSB7CgkJCQllbGVtLnJlbW92ZSgpOwoJCQl9CgkJfSApOwoJfSwKCglfa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBtYXRjaCwgcHJldiwgY2hhcmFjdGVyLCBza2lwLAoJCQlwcmV2ZW50RGVmYXVsdCA9IHRydWU7CgoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJY2FzZSAkLnVpLmtleUNvZGUuUEFHRV9VUDoKCQkJdGhpcy5wcmV2aW91c1BhZ2UoIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJdGhpcy5uZXh0UGFnZSggZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJdGhpcy5fbW92ZSggImZpcnN0IiwgImZpcnN0IiwgZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuRU5EOgoJCQl0aGlzLl9tb3ZlKCAibGFzdCIsICJsYXN0IiwgZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCXRoaXMucHJldmlvdXMoIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLkRPV046CgkJCXRoaXMubmV4dCggZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJdGhpcy5jb2xsYXBzZSggZXZlbnQgKTsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJCWlmICggdGhpcy5hY3RpdmUgJiYgIXRoaXMuYWN0aXZlLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJdGhpcy5leHBhbmQoIGV2ZW50ICk7CgkJCX0KCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuRU5URVI6CgkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCXRoaXMuX2FjdGl2YXRlKCBldmVudCApOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5FU0NBUEU6CgkJCXRoaXMuY29sbGFwc2UoIGV2ZW50ICk7CgkJCWJyZWFrOwoJCWRlZmF1bHQ6CgkJCXByZXZlbnREZWZhdWx0ID0gZmFsc2U7CgkJCXByZXYgPSB0aGlzLnByZXZpb3VzRmlsdGVyIHx8ICIiOwoJCQlza2lwID0gZmFsc2U7CgoJCQkvLyBTdXBwb3J0IG51bWJlciBwYWQgdmFsdWVzCgkJCWNoYXJhY3RlciA9IGV2ZW50LmtleUNvZGUgPj0gOTYgJiYgZXZlbnQua2V5Q29kZSA8PSAxMDUgPwoJCQkJKCBldmVudC5rZXlDb2RlIC0gOTYgKS50b1N0cmluZygpIDogU3RyaW5nLmZyb21DaGFyQ29kZSggZXZlbnQua2V5Q29kZSApOwoKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmZpbHRlclRpbWVyICk7CgoJCQlpZiAoIGNoYXJhY3RlciA9PT0gcHJldiApIHsKCQkJCXNraXAgPSB0cnVlOwoJCQl9IGVsc2UgewoJCQkJY2hhcmFjdGVyID0gcHJldiArIGNoYXJhY3RlcjsKCQkJfQoKCQkJbWF0Y2ggPSB0aGlzLl9maWx0ZXJNZW51SXRlbXMoIGNoYXJhY3RlciApOwoJCQltYXRjaCA9IHNraXAgJiYgbWF0Y2guaW5kZXgoIHRoaXMuYWN0aXZlLm5leHQoKSApICE9PSAtMSA\/CgkJCQl0aGlzLmFjdGl2ZS5uZXh0QWxsKCAiLnVpLW1lbnUtaXRlbSIgKSA6CgkJCQltYXRjaDsKCgkJCS8vIElmIG5vIG1hdGNoZXMgb24gdGhlIGN1cnJlbnQgZmlsdGVyLCByZXNldCB0byB0aGUgbGFzdCBjaGFyYWN0ZXIgcHJlc3NlZAoJCQkvLyB0byBtb3ZlIGRvd24gdGhlIG1lbnUgdG8gdGhlIGZpcnN0IGl0ZW0gdGhhdCBzdGFydHMgd2l0aCB0aGF0IGNoYXJhY3RlcgoJCQlpZiAoICFtYXRjaC5sZW5ndGggKSB7CgkJCQljaGFyYWN0ZXIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCBldmVudC5rZXlDb2RlICk7CgkJCQltYXRjaCA9IHRoaXMuX2ZpbHRlck1lbnVJdGVtcyggY2hhcmFjdGVyICk7CgkJCX0KCgkJCWlmICggbWF0Y2gubGVuZ3RoICkgewoJCQkJdGhpcy5mb2N1cyggZXZlbnQsIG1hdGNoICk7CgkJCQl0aGlzLnByZXZpb3VzRmlsdGVyID0gY2hhcmFjdGVyOwoJCQkJdGhpcy5maWx0ZXJUaW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCQlkZWxldGUgdGhpcy5wcmV2aW91c0ZpbHRlcjsKCQkJCX0sIDEwMDAgKTsKCQkJfSBlbHNlIHsKCQkJCWRlbGV0ZSB0aGlzLnByZXZpb3VzRmlsdGVyOwoJCQl9CgkJfQoKCQlpZiAoIHByZXZlbnREZWZhdWx0ICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX2FjdGl2YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLmFjdGl2ZSAmJiAhdGhpcy5hY3RpdmUuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWlmICggdGhpcy5hY3RpdmUuY2hpbGRyZW4oICJbYXJpYS1oYXNwb3B1cD0ndHJ1ZSddIiApLmxlbmd0aCApIHsKCQkJCXRoaXMuZXhwYW5kKCBldmVudCApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5zZWxlY3QoIGV2ZW50ICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBtZW51cywgaXRlbXMsIG5ld1N1Ym1lbnVzLCBuZXdJdGVtcywgbmV3V3JhcHBlcnMsCgkJCXRoYXQgPSB0aGlzLAoJCQlpY29uID0gdGhpcy5vcHRpb25zLmljb25zLnN1Ym1lbnUsCgkJCXN1Ym1lbnVzID0gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMub3B0aW9ucy5tZW51cyApOwoKCQl0aGlzLl90b2dnbGVDbGFzcyggInVpLW1lbnUtaWNvbnMiLCBudWxsLCAhIXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWljb24iICkubGVuZ3RoICk7CgoJCS8vIEluaXRpYWxpemUgbmVzdGVkIG1lbnVzCgkJbmV3U3VibWVudXMgPSBzdWJtZW51cy5maWx0ZXIoICI6bm90KC51aS1tZW51KSIgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKCB7CgkJCQlyb2xlOiB0aGlzLm9wdGlvbnMucm9sZSwKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIiwKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIgoJCQl9ICkKCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIG1lbnUgPSAkKCB0aGlzICksCgkJCQkJaXRlbSA9IG1lbnUucHJldigpLAoJCQkJCXN1Ym1lbnVDYXJldCA9ICQoICI8c3Bhbj4iICkuZGF0YSggInVpLW1lbnUtc3VibWVudS1jYXJldCIsIHRydWUgKTsKCgkJCQl0aGF0Ll9hZGRDbGFzcyggc3VibWVudUNhcmV0LCAidWktbWVudS1pY29uIiwgInVpLWljb24gIiArIGljb24gKTsKCQkJCWl0ZW0KCQkJCQkuYXR0ciggImFyaWEtaGFzcG9wdXAiLCAidHJ1ZSIgKQoJCQkJCS5wcmVwZW5kKCBzdWJtZW51Q2FyZXQgKTsKCQkJCW1lbnUuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGl0ZW0uYXR0ciggImlkIiApICk7CgkJCX0gKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIG5ld1N1Ym1lbnVzLCAidWktbWVudSIsICJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktZnJvbnQiICk7CgoJCW1lbnVzID0gc3VibWVudXMuYWRkKCB0aGlzLmVsZW1lbnQgKTsKCQlpdGVtcyA9IG1lbnVzLmZpbmQoIHRoaXMub3B0aW9ucy5pdGVtcyApOwoKCQkvLyBJbml0aWFsaXplIG1lbnUtaXRlbXMgY29udGFpbmluZyBzcGFjZXMgYW5kL29yIGRhc2hlcyBvbmx5IGFzIGRpdmlkZXJzCgkJaXRlbXMubm90KCAiLnVpLW1lbnUtaXRlbSIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgkJCWlmICggdGhhdC5faXNEaXZpZGVyKCBpdGVtICkgKSB7CgkJCQl0aGF0Ll9hZGRDbGFzcyggaXRlbSwgInVpLW1lbnUtZGl2aWRlciIsICJ1aS13aWRnZXQtY29udGVudCIgKTsKCQkJfQoJCX0gKTsKCgkJLy8gRG9uJ3QgcmVmcmVzaCBsaXN0IGl0ZW1zIHRoYXQgYXJlIGFscmVhZHkgYWRhcHRlZAoJCW5ld0l0ZW1zID0gaXRlbXMubm90KCAiLnVpLW1lbnUtaXRlbSwgLnVpLW1lbnUtZGl2aWRlciIgKTsKCQluZXdXcmFwcGVycyA9IG5ld0l0ZW1zLmNoaWxkcmVuKCkKCQkJLm5vdCggIi51aS1tZW51IiApCgkJCQkudW5pcXVlSWQoKQoJCQkJLmF0dHIoIHsKCQkJCQl0YWJJbmRleDogLTEsCgkJCQkJcm9sZTogdGhpcy5faXRlbVJvbGUoKQoJCQkJfSApOwoJCXRoaXMuX2FkZENsYXNzKCBuZXdJdGVtcywgInVpLW1lbnUtaXRlbSIgKQoJCQkuX2FkZENsYXNzKCBuZXdXcmFwcGVycywgInVpLW1lbnUtaXRlbS13cmFwcGVyIiApOwoKCQkvLyBBZGQgYXJpYS1kaXNhYmxlZCBhdHRyaWJ1dGUgdG8gYW55IGRpc2FibGVkIG1lbnUgaXRlbQoJCWl0ZW1zLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsICJ0cnVlIiApOwoKCQkvLyBJZiB0aGUgYWN0aXZlIGl0ZW0gaGFzIGJlZW4gcmVtb3ZlZCwgYmx1ciB0aGUgbWVudQoJCWlmICggdGhpcy5hY3RpdmUgJiYgISQuY29udGFpbnMoIHRoaXMuZWxlbWVudFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgkJCXRoaXMuYmx1cigpOwoJCX0KCX0sCgoJX2l0ZW1Sb2xlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gewoJCQltZW51OiAibWVudWl0ZW0iLAoJCQlsaXN0Ym94OiAib3B0aW9uIgoJCX1bIHRoaXMub3B0aW9ucy5yb2xlIF07Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiaWNvbnMiICkgewoJCQl2YXIgaWNvbnMgPSB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1tZW51LWljb24iICk7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBpY29ucywgbnVsbCwgdGhpcy5vcHRpb25zLmljb25zLnN1Ym1lbnUgKQoJCQkJLl9hZGRDbGFzcyggaWNvbnMsIG51bGwsIHZhbHVlLnN1Ym1lbnUgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCX0sCgoJX3NldE9wdGlvbkRpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7CgoJCXRoaXMuZWxlbWVudC5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIFN0cmluZyggdmFsdWUgKSApOwoJCXRoaXMuX3RvZ2dsZUNsYXNzKCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICk7Cgl9LAoKCWZvY3VzOiBmdW5jdGlvbiggZXZlbnQsIGl0ZW0gKSB7CgkJdmFyIG5lc3RlZCwgZm9jdXNlZCwgYWN0aXZlUGFyZW50OwoJCXRoaXMuYmx1ciggZXZlbnQsIGV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJmb2N1cyIgKTsKCgkJdGhpcy5fc2Nyb2xsSW50b1ZpZXcoIGl0ZW0gKTsKCgkJdGhpcy5hY3RpdmUgPSBpdGVtLmZpcnN0KCk7CgoJCWZvY3VzZWQgPSB0aGlzLmFjdGl2ZS5jaGlsZHJlbiggIi51aS1tZW51LWl0ZW0td3JhcHBlciIgKTsKCQl0aGlzLl9hZGRDbGFzcyggZm9jdXNlZCwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCgkJLy8gT25seSB1cGRhdGUgYXJpYS1hY3RpdmVkZXNjZW5kYW50IGlmIHRoZXJlJ3MgYSByb2xlCgkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBmb2N1cyBpcyBtYW5hZ2VkIGVsc2V3aGVyZQoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwgZm9jdXNlZC5hdHRyKCAiaWQiICkgKTsKCQl9CgoJCS8vIEhpZ2hsaWdodCBhY3RpdmUgcGFyZW50IG1lbnUgaXRlbSwgaWYgYW55CgkJYWN0aXZlUGFyZW50ID0gdGhpcy5hY3RpdmUKCQkJLnBhcmVudCgpCgkJCQkuY2xvc2VzdCggIi51aS1tZW51LWl0ZW0iICkKCQkJCQkuY2hpbGRyZW4oICIudWktbWVudS1pdGVtLXdyYXBwZXIiICk7CgkJdGhpcy5fYWRkQ2xhc3MoIGFjdGl2ZVBhcmVudCwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCgkJaWYgKCBldmVudCAmJiBldmVudC50eXBlID09PSAia2V5ZG93biIgKSB7CgkJCXRoaXMuX2Nsb3NlKCk7CgkJfSBlbHNlIHsKCQkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2Nsb3NlKCk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9CgoJCW5lc3RlZCA9IGl0ZW0uY2hpbGRyZW4oICIudWktbWVudSIgKTsKCQlpZiAoIG5lc3RlZC5sZW5ndGggJiYgZXZlbnQgJiYgKCAvXm1vdXNlLy50ZXN0KCBldmVudC50eXBlICkgKSApIHsKCQkJdGhpcy5fc3RhcnRPcGVuaW5nKCBuZXN0ZWQgKTsKCQl9CgkJdGhpcy5hY3RpdmVNZW51ID0gaXRlbS5wYXJlbnQoKTsKCgkJdGhpcy5fdHJpZ2dlciggImZvY3VzIiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICk7Cgl9LAoKCV9zY3JvbGxJbnRvVmlldzogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJdmFyIGJvcmRlclRvcCwgcGFkZGluZ1RvcCwgb2Zmc2V0LCBzY3JvbGwsIGVsZW1lbnRIZWlnaHQsIGl0ZW1IZWlnaHQ7CgkJaWYgKCB0aGlzLl9oYXNTY3JvbGwoKSApIHsKCQkJYm9yZGVyVG9wID0gcGFyc2VGbG9hdCggJC5jc3MoIHRoaXMuYWN0aXZlTWVudVsgMCBdLCAiYm9yZGVyVG9wV2lkdGgiICkgKSB8fCAwOwoJCQlwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggJC5jc3MoIHRoaXMuYWN0aXZlTWVudVsgMCBdLCAicGFkZGluZ1RvcCIgKSApIHx8IDA7CgkJCW9mZnNldCA9IGl0ZW0ub2Zmc2V0KCkudG9wIC0gdGhpcy5hY3RpdmVNZW51Lm9mZnNldCgpLnRvcCAtIGJvcmRlclRvcCAtIHBhZGRpbmdUb3A7CgkJCXNjcm9sbCA9IHRoaXMuYWN0aXZlTWVudS5zY3JvbGxUb3AoKTsKCQkJZWxlbWVudEhlaWdodCA9IHRoaXMuYWN0aXZlTWVudS5oZWlnaHQoKTsKCQkJaXRlbUhlaWdodCA9IGl0ZW0ub3V0ZXJIZWlnaHQoKTsKCgkJCWlmICggb2Zmc2V0IDwgMCApIHsKCQkJCXRoaXMuYWN0aXZlTWVudS5zY3JvbGxUb3AoIHNjcm9sbCArIG9mZnNldCApOwoJCQl9IGVsc2UgaWYgKCBvZmZzZXQgKyBpdGVtSGVpZ2h0ID4gZWxlbWVudEhlaWdodCApIHsKCQkJCXRoaXMuYWN0aXZlTWVudS5zY3JvbGxUb3AoIHNjcm9sbCArIG9mZnNldCAtIGVsZW1lbnRIZWlnaHQgKyBpdGVtSGVpZ2h0ICk7CgkJCX0KCQl9Cgl9LAoKCWJsdXI6IGZ1bmN0aW9uKCBldmVudCwgZnJvbUZvY3VzICkgewoJCWlmICggIWZyb21Gb2N1cyApIHsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJfQoKCQlpZiAoICF0aGlzLmFjdGl2ZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuYWN0aXZlLmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbS13cmFwcGVyIiApLAoJCQludWxsLCAidWktc3RhdGUtYWN0aXZlIiApOwoKCQl0aGlzLl90cmlnZ2VyKCAiYmx1ciIsIGV2ZW50LCB7IGl0ZW06IHRoaXMuYWN0aXZlIH0gKTsKCQl0aGlzLmFjdGl2ZSA9IG51bGw7Cgl9LAoKCV9zdGFydE9wZW5pbmc6IGZ1bmN0aW9uKCBzdWJtZW51ICkgewoJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOwoKCQkvLyBEb24ndCBvcGVuIGlmIGFscmVhZHkgb3BlbiBmaXhlcyBhIEZpcmVmb3ggYnVnIHRoYXQgY2F1c2VkIGEgLjUgcGl4ZWwKCQkvLyBzaGlmdCBpbiB0aGUgc3VibWVudSBwb3NpdGlvbiB3aGVuIG1vdXNpbmcgb3ZlciB0aGUgY2FyZXQgaWNvbgoJCWlmICggc3VibWVudS5hdHRyKCAiYXJpYS1oaWRkZW4iICkgIT09ICJ0cnVlIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJdGhpcy5fY2xvc2UoKTsKCQkJdGhpcy5fb3Blbiggc3VibWVudSApOwoJCX0sIHRoaXMuZGVsYXkgKTsKCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBzdWJtZW51ICkgewoJCXZhciBwb3NpdGlvbiA9ICQuZXh0ZW5kKCB7CgkJCW9mOiB0aGlzLmFjdGl2ZQoJCX0sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApOwoKCQljbGVhclRpbWVvdXQoIHRoaXMudGltZXIgKTsKCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1tZW51IiApLm5vdCggc3VibWVudS5wYXJlbnRzKCAiLnVpLW1lbnUiICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKCAiYXJpYS1oaWRkZW4iLCAidHJ1ZSIgKTsKCgkJc3VibWVudQoJCQkuc2hvdygpCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgInRydWUiICkKCQkJLnBvc2l0aW9uKCBwb3NpdGlvbiApOwoJfSwKCgljb2xsYXBzZUFsbDogZnVuY3Rpb24oIGV2ZW50LCBhbGwgKSB7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLnRpbWVyICk7CgkJdGhpcy50aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCgkJCS8vIElmIHdlIHdlcmUgcGFzc2VkIGFuIGV2ZW50LCBsb29rIGZvciB0aGUgc3VibWVudSB0aGF0IGNvbnRhaW5zIHRoZSBldmVudAoJCQl2YXIgY3VycmVudE1lbnUgPSBhbGwgPyB0aGlzLmVsZW1lbnQgOgoJCQkJJCggZXZlbnQgJiYgZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggdGhpcy5lbGVtZW50LmZpbmQoICIudWktbWVudSIgKSApOwoKCQkJLy8gSWYgd2UgZm91bmQgbm8gdmFsaWQgc3VibWVudSBhbmNlc3RvciwgdXNlIHRoZSBtYWluIG1lbnUgdG8gY2xvc2UgYWxsCgkJCS8vIHN1YiBtZW51cyBhbnl3YXkKCQkJaWYgKCAhY3VycmVudE1lbnUubGVuZ3RoICkgewoJCQkJY3VycmVudE1lbnUgPSB0aGlzLmVsZW1lbnQ7CgkJCX0KCgkJCXRoaXMuX2Nsb3NlKCBjdXJyZW50TWVudSApOwoKCQkJdGhpcy5ibHVyKCBldmVudCApOwoKCQkJLy8gV29yayBhcm91bmQgYWN0aXZlIGl0ZW0gc3RheWluZyBhY3RpdmUgYWZ0ZXIgbWVudSBpcyBibHVycmVkCgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBjdXJyZW50TWVudS5maW5kKCAiLnVpLXN0YXRlLWFjdGl2ZSIgKSwgbnVsbCwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCgkJCXRoaXMuYWN0aXZlTWVudSA9IGN1cnJlbnRNZW51OwoJCX0sIHRoaXMuZGVsYXkgKTsKCX0sCgoJLy8gV2l0aCBubyBhcmd1bWVudHMsIGNsb3NlcyB0aGUgY3VycmVudGx5IGFjdGl2ZSBtZW51IC0gaWYgbm90aGluZyBpcyBhY3RpdmUKCS8vIGl0IGNsb3NlcyBhbGwgbWVudXMuICBJZiBwYXNzZWQgYW4gYXJndW1lbnQsIGl0IHdpbGwgc2VhcmNoIGZvciBtZW51cyBCRUxPVwoJX2Nsb3NlOiBmdW5jdGlvbiggc3RhcnRNZW51ICkgewoJCWlmICggIXN0YXJ0TWVudSApIHsKCQkJc3RhcnRNZW51ID0gdGhpcy5hY3RpdmUgPyB0aGlzLmFjdGl2ZS5wYXJlbnQoKSA6IHRoaXMuZWxlbWVudDsKCQl9CgoJCXN0YXJ0TWVudS5maW5kKCAiLnVpLW1lbnUiICkKCQkJLmhpZGUoKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgInRydWUiICkKCQkJLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgImZhbHNlIiApOwoJfSwKCglfY2xvc2VPbkRvY3VtZW50Q2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlyZXR1cm4gISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktbWVudSIgKS5sZW5ndGg7Cgl9LAoKCV9pc0RpdmlkZXI6IGZ1bmN0aW9uKCBpdGVtICkgewoKCQkvLyBNYXRjaCBoeXBoZW4sIGVtIGRhc2gsIGVuIGRhc2gKCQlyZXR1cm4gIS9bXlwtXHUyMDE0XHUyMDEzXHNdLy50ZXN0KCBpdGVtLnRleHQoKSApOwoJfSwKCgljb2xsYXBzZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBuZXdJdGVtID0gdGhpcy5hY3RpdmUgJiYKCQkJdGhpcy5hY3RpdmUucGFyZW50KCkuY2xvc2VzdCggIi51aS1tZW51LWl0ZW0iLCB0aGlzLmVsZW1lbnQgKTsKCQlpZiAoIG5ld0l0ZW0gJiYgbmV3SXRlbS5sZW5ndGggKSB7CgkJCXRoaXMuX2Nsb3NlKCk7CgkJCXRoaXMuZm9jdXMoIGV2ZW50LCBuZXdJdGVtICk7CgkJfQoJfSwKCglleHBhbmQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgbmV3SXRlbSA9IHRoaXMuYWN0aXZlICYmCgkJCXRoaXMuYWN0aXZlCgkJCQkuY2hpbGRyZW4oICIudWktbWVudSAiICkKCQkJCQkuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkKCQkJCQkJLmZpcnN0KCk7CgoJCWlmICggbmV3SXRlbSAmJiBuZXdJdGVtLmxlbmd0aCApIHsKCQkJdGhpcy5fb3BlbiggbmV3SXRlbS5wYXJlbnQoKSApOwoKCQkJLy8gRGVsYXkgc28gRmlyZWZveCB3aWxsIG5vdCBoaWRlIGFjdGl2ZWRlc2NlbmRhbnQgY2hhbmdlIGluIGV4cGFuZGluZyBzdWJtZW51IGZyb20gQVQKCQkJdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5mb2N1cyggZXZlbnQsIG5ld0l0ZW0gKTsKCQkJfSApOwoJCX0KCX0sCgoJbmV4dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX21vdmUoICJuZXh0IiwgImZpcnN0IiwgZXZlbnQgKTsKCX0sCgoJcHJldmlvdXM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9tb3ZlKCAicHJldiIsICJsYXN0IiwgZXZlbnQgKTsKCX0sCgoJaXNGaXJzdEl0ZW06IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmFjdGl2ZSAmJiAhdGhpcy5hY3RpdmUucHJldkFsbCggIi51aS1tZW51LWl0ZW0iICkubGVuZ3RoOwoJfSwKCglpc0xhc3RJdGVtOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5hY3RpdmUgJiYgIXRoaXMuYWN0aXZlLm5leHRBbGwoICIudWktbWVudS1pdGVtIiApLmxlbmd0aDsKCX0sCgoJX21vdmU6IGZ1bmN0aW9uKCBkaXJlY3Rpb24sIGZpbHRlciwgZXZlbnQgKSB7CgkJdmFyIG5leHQ7CgkJaWYgKCB0aGlzLmFjdGl2ZSApIHsKCQkJaWYgKCBkaXJlY3Rpb24gPT09ICJmaXJzdCIgfHwgZGlyZWN0aW9uID09PSAibGFzdCIgKSB7CgkJCQluZXh0ID0gdGhpcy5hY3RpdmUKCQkJCQlbIGRpcmVjdGlvbiA9PT0gImZpcnN0IiA\/ICJwcmV2QWxsIiA6ICJuZXh0QWxsIiBdKCAiLnVpLW1lbnUtaXRlbSIgKQoJCQkJCS5lcSggLTEgKTsKCQkJfSBlbHNlIHsKCQkJCW5leHQgPSB0aGlzLmFjdGl2ZQoJCQkJCVsgZGlyZWN0aW9uICsgIkFsbCIgXSggIi51aS1tZW51LWl0ZW0iICkKCQkJCQkuZXEoIDAgKTsKCQkJfQoJCX0KCQlpZiAoICFuZXh0IHx8ICFuZXh0Lmxlbmd0aCB8fCAhdGhpcy5hY3RpdmUgKSB7CgkJCW5leHQgPSB0aGlzLmFjdGl2ZU1lbnUuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zIClbIGZpbHRlciBdKCk7CgkJfQoKCQl0aGlzLmZvY3VzKCBldmVudCwgbmV4dCApOwoJfSwKCgluZXh0UGFnZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpdGVtLCBiYXNlLCBoZWlnaHQ7CgoJCWlmICggIXRoaXMuYWN0aXZlICkgewoJCQl0aGlzLm5leHQoIGV2ZW50ICk7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLmlzTGFzdEl0ZW0oKSApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuX2hhc1Njcm9sbCgpICkgewoJCQliYXNlID0gdGhpcy5hY3RpdmUub2Zmc2V0KCkudG9wOwoJCQloZWlnaHQgPSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgkJCXRoaXMuYWN0aXZlLm5leHRBbGwoICIudWktbWVudS1pdGVtIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJaXRlbSA9ICQoIHRoaXMgKTsKCQkJCXJldHVybiBpdGVtLm9mZnNldCgpLnRvcCAtIGJhc2UgLSBoZWlnaHQgPCAwOwoJCQl9ICk7CgoJCQl0aGlzLmZvY3VzKCBldmVudCwgaXRlbSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0aGlzLmFjdGl2ZU1lbnUuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkKCQkJCVsgIXRoaXMuYWN0aXZlID8gImZpcnN0IiA6ICJsYXN0IiBdKCkgKTsKCQl9Cgl9LAoKCXByZXZpb3VzUGFnZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpdGVtLCBiYXNlLCBoZWlnaHQ7CgkJaWYgKCAhdGhpcy5hY3RpdmUgKSB7CgkJCXRoaXMubmV4dCggZXZlbnQgKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaXNGaXJzdEl0ZW0oKSApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuX2hhc1Njcm9sbCgpICkgewoJCQliYXNlID0gdGhpcy5hY3RpdmUub2Zmc2V0KCkudG9wOwoJCQloZWlnaHQgPSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgkJCXRoaXMuYWN0aXZlLnByZXZBbGwoICIudWktbWVudS1pdGVtIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJaXRlbSA9ICQoIHRoaXMgKTsKCQkJCXJldHVybiBpdGVtLm9mZnNldCgpLnRvcCAtIGJhc2UgKyBoZWlnaHQgPiAwOwoJCQl9ICk7CgoJCQl0aGlzLmZvY3VzKCBldmVudCwgaXRlbSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuZm9jdXMoIGV2ZW50LCB0aGlzLmFjdGl2ZU1lbnUuZmluZCggdGhpcy5vcHRpb25zLml0ZW1zICkuZmlyc3QoKSApOwoJCX0KCX0sCgoJX2hhc1Njcm9sbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIDwgdGhpcy5lbGVtZW50LnByb3AoICJzY3JvbGxIZWlnaHQiICk7Cgl9LAoKCXNlbGVjdDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkvLyBUT0RPOiBJdCBzaG91bGQgbmV2ZXIgYmUgcG9zc2libGUgdG8gbm90IGhhdmUgYW4gYWN0aXZlIGl0ZW0gYXQgdGhpcwoJCS8vIHBvaW50LCBidXQgdGhlIHRlc3RzIGRvbid0IHRyaWdnZXIgbW91c2VlbnRlciBiZWZvcmUgY2xpY2suCgkJdGhpcy5hY3RpdmUgPSB0aGlzLmFjdGl2ZSB8fCAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLW1lbnUtaXRlbSIgKTsKCQl2YXIgdWkgPSB7IGl0ZW06IHRoaXMuYWN0aXZlIH07CgkJaWYgKCAhdGhpcy5hY3RpdmUuaGFzKCAiLnVpLW1lbnUiICkubGVuZ3RoICkgewoJCQl0aGlzLmNvbGxhcHNlQWxsKCBldmVudCwgdHJ1ZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAic2VsZWN0IiwgZXZlbnQsIHVpICk7Cgl9LAoKCV9maWx0ZXJNZW51SXRlbXM6IGZ1bmN0aW9uKCBjaGFyYWN0ZXIgKSB7CgkJdmFyIGVzY2FwZWRDaGFyYWN0ZXIgPSBjaGFyYWN0ZXIucmVwbGFjZSggL1tcLVxbXF17fSgpKis\/LixcXFxeJHwjXHNdL2csICJcXCQmIiApLAoJCQlyZWdleCA9IG5ldyBSZWdFeHAoICJeIiArIGVzY2FwZWRDaGFyYWN0ZXIsICJpIiApOwoKCQlyZXR1cm4gdGhpcy5hY3RpdmVNZW51CgkJCS5maW5kKCB0aGlzLm9wdGlvbnMuaXRlbXMgKQoKCQkJCS8vIE9ubHkgbWF0Y2ggb24gaXRlbXMsIG5vdCBkaXZpZGVycyBvciBvdGhlciBjb250ZW50ICgjMTA1NzEpCgkJCQkuZmlsdGVyKCAiLnVpLW1lbnUtaXRlbSIgKQoJCQkJCS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gcmVnZXgudGVzdCgKCQkJCQkJCSQudHJpbSggJCggdGhpcyApLmNoaWxkcmVuKCAiLnVpLW1lbnUtaXRlbS13cmFwcGVyIiApLnRleHQoKSApICk7CgkJCQkJfSApOwoJfQp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBBdXRvY29tcGxldGUgMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBBdXRvY29tcGxldGUKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogTGlzdHMgc3VnZ2VzdGVkIHdvcmRzIGFzIHRoZSB1c2VyIGlzIHR5cGluZy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2F1dG9jb21wbGV0ZS8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2F1dG9jb21wbGV0ZS8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9hdXRvY29tcGxldGUuY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCgokLndpZGdldCggInVpLmF1dG9jb21wbGV0ZSIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8aW5wdXQ+IiwKCW9wdGlvbnM6IHsKCQlhcHBlbmRUbzogbnVsbCwKCQlhdXRvRm9jdXM6IGZhbHNlLAoJCWRlbGF5OiAzMDAsCgkJbWluTGVuZ3RoOiAxLAoJCXBvc2l0aW9uOiB7CgkJCW15OiAibGVmdCB0b3AiLAoJCQlhdDogImxlZnQgYm90dG9tIiwKCQkJY29sbGlzaW9uOiAibm9uZSIKCQl9LAoJCXNvdXJjZTogbnVsbCwKCgkJLy8gQ2FsbGJhY2tzCgkJY2hhbmdlOiBudWxsLAoJCWNsb3NlOiBudWxsLAoJCWZvY3VzOiBudWxsLAoJCW9wZW46IG51bGwsCgkJcmVzcG9uc2U6IG51bGwsCgkJc2VhcmNoOiBudWxsLAoJCXNlbGVjdDogbnVsbAoJfSwKCglyZXF1ZXN0SW5kZXg6IDAsCglwZW5kaW5nOiAwLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBTb21lIGJyb3dzZXJzIG9ubHkgcmVwZWF0IGtleWRvd24gZXZlbnRzLCBub3Qga2V5cHJlc3MgZXZlbnRzLAoJCS8vIHNvIHdlIHVzZSB0aGUgc3VwcHJlc3NLZXlQcmVzcyBmbGFnIHRvIGRldGVybWluZSBpZiB3ZSd2ZSBhbHJlYWR5CgkJLy8gaGFuZGxlZCB0aGUga2V5ZG93biBldmVudC4gIzcyNjkKCQkvLyBVbmZvcnR1bmF0ZWx5IHRoZSBjb2RlIGZvciAmIGluIGtleXByZXNzIGlzIHRoZSBzYW1lIGFzIHRoZSB1cCBhcnJvdywKCQkvLyBzbyB3ZSB1c2UgdGhlIHN1cHByZXNzS2V5UHJlc3NSZXBlYXQgZmxhZyB0byBhdm9pZCBoYW5kbGluZyBrZXlwcmVzcwoJCS8vIGV2ZW50cyB3aGVuIHdlIGtub3cgdGhlIGtleWRvd24gZXZlbnQgd2FzIHVzZWQgdG8gbW9kaWZ5IHRoZQoJCS8vIHNlYXJjaCB0ZXJtLiAjNzc5OQoJCXZhciBzdXBwcmVzc0tleVByZXNzLCBzdXBwcmVzc0tleVByZXNzUmVwZWF0LCBzdXBwcmVzc0lucHV0LAoJCQlub2RlTmFtZSA9IHRoaXMuZWxlbWVudFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzVGV4dGFyZWEgPSBub2RlTmFtZSA9PT0gInRleHRhcmVhIiwKCQkJaXNJbnB1dCA9IG5vZGVOYW1lID09PSAiaW5wdXQiOwoKCQkvLyBUZXh0YXJlYXMgYXJlIGFsd2F5cyBtdWx0aS1saW5lCgkJLy8gSW5wdXRzIGFyZSBhbHdheXMgc2luZ2xlLWxpbmUsIGV2ZW4gaWYgaW5zaWRlIGEgY29udGVudEVkaXRhYmxlIGVsZW1lbnQKCQkvLyBJRSBhbHNvIHRyZWF0cyBpbnB1dHMgYXMgY29udGVudEVkaXRhYmxlCgkJLy8gQWxsIG90aGVyIGVsZW1lbnQgdHlwZXMgYXJlIGRldGVybWluZWQgYnkgd2hldGhlciBvciBub3QgdGhleSdyZSBjb250ZW50RWRpdGFibGUKCQl0aGlzLmlzTXVsdGlMaW5lID0gaXNUZXh0YXJlYSB8fCAhaXNJbnB1dCAmJiB0aGlzLl9pc0NvbnRlbnRFZGl0YWJsZSggdGhpcy5lbGVtZW50ICk7CgoJCXRoaXMudmFsdWVNZXRob2QgPSB0aGlzLmVsZW1lbnRbIGlzVGV4dGFyZWEgfHwgaXNJbnB1dCA\/ICJ2YWwiIDogInRleHQiIF07CgkJdGhpcy5pc05ld01lbnUgPSB0cnVlOwoKCQl0aGlzLl9hZGRDbGFzcyggInVpLWF1dG9jb21wbGV0ZS1pbnB1dCIgKTsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgoJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQsIHsKCQkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCB0aGlzLmVsZW1lbnQucHJvcCggInJlYWRPbmx5IiApICkgewoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOwoJCQkJCXN1cHByZXNzSW5wdXQgPSB0cnVlOwoJCQkJCXN1cHByZXNzS2V5UHJlc3NSZXBlYXQgPSB0cnVlOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlzdXBwcmVzc0tleVByZXNzID0gZmFsc2U7CgkJCQlzdXBwcmVzc0lucHV0ID0gZmFsc2U7CgkJCQlzdXBwcmVzc0tleVByZXNzUmVwZWF0ID0gZmFsc2U7CgkJCQl2YXIga2V5Q29kZSA9ICQudWkua2V5Q29kZTsKCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQljYXNlIGtleUNvZGUuUEFHRV9VUDoKCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQl0aGlzLl9tb3ZlKCAicHJldmlvdXNQYWdlIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5QQUdFX0RPV046CgkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IHRydWU7CgkJCQkJdGhpcy5fbW92ZSggIm5leHRQYWdlIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5VUDoKCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQl0aGlzLl9rZXlFdmVudCggInByZXZpb3VzIiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCWNhc2Uga2V5Q29kZS5ET1dOOgoJCQkJCXN1cHByZXNzS2V5UHJlc3MgPSB0cnVlOwoJCQkJCXRoaXMuX2tleUV2ZW50KCAibmV4dCIsIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuRU5URVI6CgoJCQkJCS8vIHdoZW4gbWVudSBpcyBvcGVuIGFuZCBoYXMgZm9jdXMKCQkJCQlpZiAoIHRoaXMubWVudS5hY3RpdmUgKSB7CgoJCQkJCQkvLyAjNjA1NSAtIE9wZXJhIHN0aWxsIGFsbG93cyB0aGUga2V5cHJlc3MgdG8gb2NjdXIKCQkJCQkJLy8gd2hpY2ggY2F1c2VzIGZvcm1zIHRvIHN1Ym1pdAoJCQkJCQlzdXBwcmVzc0tleVByZXNzID0gdHJ1ZTsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJdGhpcy5tZW51LnNlbGVjdCggZXZlbnQgKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuVEFCOgoJCQkJCWlmICggdGhpcy5tZW51LmFjdGl2ZSApIHsKCQkJCQkJdGhpcy5tZW51LnNlbGVjdCggZXZlbnQgKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQljYXNlIGtleUNvZGUuRVNDQVBFOgoJCQkJCWlmICggdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJCQkJaWYgKCAhdGhpcy5pc011bHRpTGluZSApIHsKCQkJCQkJCXRoaXMuX3ZhbHVlKCB0aGlzLnRlcm0gKTsKCQkJCQkJfQoJCQkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoKCQkJCQkJLy8gRGlmZmVyZW50IGJyb3dzZXJzIGhhdmUgZGlmZmVyZW50IGRlZmF1bHQgYmVoYXZpb3IgZm9yIGVzY2FwZQoJCQkJCQkvLyBTaW5nbGUgcHJlc3MgY2FuIG1lYW4gdW5kbyBvciBjbGVhcgoJCQkJCQkvLyBEb3VibGUgcHJlc3MgaW4gSUUgbWVhbnMgY2xlYXIgdGhlIHdob2xlIGZvcm0KCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQlkZWZhdWx0OgoJCQkJCXN1cHByZXNzS2V5UHJlc3NSZXBlYXQgPSB0cnVlOwoKCQkJCQkvLyBzZWFyY2ggdGltZW91dCBzaG91bGQgYmUgdHJpZ2dlcmVkIGJlZm9yZSB0aGUgaW5wdXQgdmFsdWUgaXMgY2hhbmdlZAoJCQkJCXRoaXMuX3NlYXJjaFRpbWVvdXQoIGV2ZW50ICk7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0sCgkJCWtleXByZXNzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIHN1cHByZXNzS2V5UHJlc3MgKSB7CgkJCQkJc3VwcHJlc3NLZXlQcmVzcyA9IGZhbHNlOwoJCQkJCWlmICggIXRoaXMuaXNNdWx0aUxpbmUgfHwgdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCBzdXBwcmVzc0tleVByZXNzUmVwZWF0ICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBSZXBsaWNhdGUgc29tZSBrZXkgaGFuZGxlcnMgdG8gYWxsb3cgdGhlbSB0byByZXBlYXQgaW4gRmlyZWZveCBhbmQgT3BlcmEKCQkJCXZhciBrZXlDb2RlID0gJC51aS5rZXlDb2RlOwoJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCWNhc2Uga2V5Q29kZS5QQUdFX1VQOgoJCQkJCXRoaXMuX21vdmUoICJwcmV2aW91c1BhZ2UiLCBldmVudCApOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSBrZXlDb2RlLlBBR0VfRE9XTjoKCQkJCQl0aGlzLl9tb3ZlKCAibmV4dFBhZ2UiLCBldmVudCApOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSBrZXlDb2RlLlVQOgoJCQkJCXRoaXMuX2tleUV2ZW50KCAicHJldmlvdXMiLCBldmVudCApOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSBrZXlDb2RlLkRPV046CgkJCQkJdGhpcy5fa2V5RXZlbnQoICJuZXh0IiwgZXZlbnQgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfSwKCQkJaW5wdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggc3VwcHJlc3NJbnB1dCApIHsKCQkJCQlzdXBwcmVzc0lucHV0ID0gZmFsc2U7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQl0aGlzLl9zZWFyY2hUaW1lb3V0KCBldmVudCApOwoJCQl9LAoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLnNlbGVjdGVkSXRlbSA9IG51bGw7CgkJCQl0aGlzLnByZXZpb3VzID0gdGhpcy5fdmFsdWUoKTsKCQkJfSwKCQkJYmx1cjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCB0aGlzLmNhbmNlbEJsdXIgKSB7CgkJCQkJZGVsZXRlIHRoaXMuY2FuY2VsQmx1cjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLnNlYXJjaGluZyApOwoJCQkJdGhpcy5jbG9zZSggZXZlbnQgKTsKCQkJCXRoaXMuX2NoYW5nZSggZXZlbnQgKTsKCQkJfQoJCX0gKTsKCgkJdGhpcy5faW5pdFNvdXJjZSgpOwoJCXRoaXMubWVudSA9ICQoICI8dWw+IiApCgkJCS5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApCgkJCS5tZW51KCB7CgoJCQkJLy8gZGlzYWJsZSBBUklBIHN1cHBvcnQsIHRoZSBsaXZlIHJlZ2lvbiB0YWtlcyBjYXJlIG9mIHRoYXQKCQkJCXJvbGU6IG51bGwKCQkJfSApCgkJCS5oaWRlKCkKCQkJLm1lbnUoICJpbnN0YW5jZSIgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubWVudS5lbGVtZW50LCAidWktYXV0b2NvbXBsZXRlIiwgInVpLWZyb250IiApOwoJCXRoaXMuX29uKCB0aGlzLm1lbnUuZWxlbWVudCwgewoJCQltb3VzZWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkvLyBwcmV2ZW50IG1vdmluZyBmb2N1cyBvdXQgb2YgdGhlIHRleHQgZmllbGQKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJLy8gSUUgZG9lc24ndCBwcmV2ZW50IG1vdmluZyBmb2N1cyBldmVuIHdpdGggZXZlbnQucHJldmVudERlZmF1bHQoKQoJCQkJLy8gc28gd2Ugc2V0IGEgZmxhZyB0byBrbm93IHdoZW4gd2Ugc2hvdWxkIGlnbm9yZSB0aGUgYmx1ciBldmVudAoJCQkJdGhpcy5jYW5jZWxCbHVyID0gdHJ1ZTsKCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCQlkZWxldGUgdGhpcy5jYW5jZWxCbHVyOwoKCQkJCQkvLyBTdXBwb3J0OiBJRSA4IG9ubHkKCQkJCQkvLyBSaWdodCBjbGlja2luZyBhIG1lbnUgaXRlbSBvciBzZWxlY3RpbmcgdGV4dCBmcm9tIHRoZSBtZW51IGl0ZW1zIHdpbGwKCQkJCQkvLyByZXN1bHQgaW4gZm9jdXMgbW92aW5nIG91dCBvZiB0aGUgaW5wdXQuIEhvd2V2ZXIsIHdlJ3ZlIGFscmVhZHkgcmVjZWl2ZWQKCQkJCQkvLyBhbmQgaWdub3JlZCB0aGUgYmx1ciBldmVudCBiZWNhdXNlIG9mIHRoZSBjYW5jZWxCbHVyIGZsYWcgc2V0IGFib3ZlLiBTbwoJCQkJCS8vIHdlIHJlc3RvcmUgZm9jdXMgdG8gZW5zdXJlIHRoYXQgdGhlIG1lbnUgY2xvc2VzIHByb3Blcmx5IGJhc2VkIG9uIHRoZSB1c2VyJ3MKCQkJCQkvLyBuZXh0IGFjdGlvbnMuCgkJCQkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXSAhPT0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgKSB7CgkJCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiZm9jdXMiICk7CgkJCQkJfQoJCQkJfSApOwoJCQl9LAoJCQltZW51Zm9jdXM6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQl2YXIgbGFiZWwsIGl0ZW07CgoJCQkJLy8gc3VwcG9ydDogRmlyZWZveAoJCQkJLy8gUHJldmVudCBhY2NpZGVudGFsIGFjdGl2YXRpb24gb2YgbWVudSBpdGVtcyBpbiBGaXJlZm94ICgjNzAyNCAjOTExOCkKCQkJCWlmICggdGhpcy5pc05ld01lbnUgKSB7CgkJCQkJdGhpcy5pc05ld01lbnUgPSBmYWxzZTsKCQkJCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQgJiYgL15tb3VzZS8udGVzdCggZXZlbnQub3JpZ2luYWxFdmVudC50eXBlICkgKSB7CgkJCQkJCXRoaXMubWVudS5ibHVyKCk7CgoJCQkJCQl0aGlzLmRvY3VtZW50Lm9uZSggIm1vdXNlbW92ZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggZXZlbnQudGFyZ2V0ICkudHJpZ2dlciggZXZlbnQub3JpZ2luYWxFdmVudCApOwoJCQkJCQl9ICk7CgoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoKCQkJCWl0ZW0gPSB1aS5pdGVtLmRhdGEoICJ1aS1hdXRvY29tcGxldGUtaXRlbSIgKTsKCQkJCWlmICggZmFsc2UgIT09IHRoaXMuX3RyaWdnZXIoICJmb2N1cyIsIGV2ZW50LCB7IGl0ZW06IGl0ZW0gfSApICkgewoKCQkJCQkvLyB1c2UgdmFsdWUgdG8gbWF0Y2ggd2hhdCB3aWxsIGVuZCB1cCBpbiB0aGUgaW5wdXQsIGlmIGl0IHdhcyBhIGtleSBldmVudAoJCQkJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudCAmJiAvXmtleS8udGVzdCggZXZlbnQub3JpZ2luYWxFdmVudC50eXBlICkgKSB7CgkJCQkJCXRoaXMuX3ZhbHVlKCBpdGVtLnZhbHVlICk7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIEFubm91bmNlIHRoZSB2YWx1ZSBpbiB0aGUgbGl2ZVJlZ2lvbgoJCQkJbGFiZWwgPSB1aS5pdGVtLmF0dHIoICJhcmlhLWxhYmVsIiApIHx8IGl0ZW0udmFsdWU7CgkJCQlpZiAoIGxhYmVsICYmICQudHJpbSggbGFiZWwgKS5sZW5ndGggKSB7CgkJCQkJdGhpcy5saXZlUmVnaW9uLmNoaWxkcmVuKCkuaGlkZSgpOwoJCQkJCSQoICI8ZGl2PiIgKS50ZXh0KCBsYWJlbCApLmFwcGVuZFRvKCB0aGlzLmxpdmVSZWdpb24gKTsKCQkJCX0KCQkJfSwKCQkJbWVudXNlbGVjdDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCXZhciBpdGVtID0gdWkuaXRlbS5kYXRhKCAidWktYXV0b2NvbXBsZXRlLWl0ZW0iICksCgkJCQkJcHJldmlvdXMgPSB0aGlzLnByZXZpb3VzOwoKCQkJCS8vIE9ubHkgdHJpZ2dlciB3aGVuIGZvY3VzIHdhcyBsb3N0IChjbGljayBvbiBtZW51KQoJCQkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXSAhPT0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgKSB7CgkJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJCQl0aGlzLnByZXZpb3VzID0gcHJldmlvdXM7CgoJCQkJCS8vICM2MTA5IC0gSUUgdHJpZ2dlcnMgdHdvIGZvY3VzIGV2ZW50cyBhbmQgdGhlIHNlY29uZAoJCQkJCS8vIGlzIGFzeW5jaHJvbm91cywgc28gd2UgbmVlZCB0byByZXNldCB0aGUgcHJldmlvdXMKCQkJCQkvLyB0ZXJtIHN5bmNocm9ub3VzbHkgYW5kIGFzeW5jaHJvbm91c2x5IDotKAoJCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCQkJdGhpcy5wcmV2aW91cyA9IHByZXZpb3VzOwoJCQkJCQl0aGlzLnNlbGVjdGVkSXRlbSA9IGl0ZW07CgkJCQkJfSApOwoJCQkJfQoKCQkJCWlmICggZmFsc2UgIT09IHRoaXMuX3RyaWdnZXIoICJzZWxlY3QiLCBldmVudCwgeyBpdGVtOiBpdGVtIH0gKSApIHsKCQkJCQl0aGlzLl92YWx1ZSggaXRlbS52YWx1ZSApOwoJCQkJfQoKCQkJCS8vIHJlc2V0IHRoZSB0ZXJtIGFmdGVyIHRoZSBzZWxlY3QgZXZlbnQKCQkJCS8vIHRoaXMgYWxsb3dzIGN1c3RvbSBzZWxlY3QgaGFuZGxpbmcgdG8gd29yayBwcm9wZXJseQoJCQkJdGhpcy50ZXJtID0gdGhpcy5fdmFsdWUoKTsKCgkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoJCQkJdGhpcy5zZWxlY3RlZEl0ZW0gPSBpdGVtOwoJCQl9CgkJfSApOwoKCQl0aGlzLmxpdmVSZWdpb24gPSAkKCAiPGRpdj4iLCB7CgkJCXJvbGU6ICJzdGF0dXMiLAoJCQkiYXJpYS1saXZlIjogImFzc2VydGl2ZSIsCgkJCSJhcmlhLXJlbGV2YW50IjogImFkZGl0aW9ucyIKCQl9ICkKCQkJLmFwcGVuZFRvKCB0aGlzLmRvY3VtZW50WyAwIF0uYm9keSApOwoKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5saXZlUmVnaW9uLCBudWxsLCAidWktaGVscGVyLWhpZGRlbi1hY2Nlc3NpYmxlIiApOwoKCQkvLyBUdXJuaW5nIG9mZiBhdXRvY29tcGxldGUgcHJldmVudHMgdGhlIGJyb3dzZXIgZnJvbSByZW1lbWJlcmluZyB0aGUKCQkvLyB2YWx1ZSB3aGVuIG5hdmlnYXRpbmcgdGhyb3VnaCBoaXN0b3J5LCBzbyB3ZSByZS1lbmFibGUgYXV0b2NvbXBsZXRlCgkJLy8gaWYgdGhlIHBhZ2UgaXMgdW5sb2FkZWQgYmVmb3JlIHRoZSB3aWRnZXQgaXMgZGVzdHJveWVkLiAjNzc5MAoJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQliZWZvcmV1bmxvYWQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJhdXRvY29tcGxldGUiICk7CgkJCX0KCQl9ICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQljbGVhclRpbWVvdXQoIHRoaXMuc2VhcmNoaW5nICk7CgkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJhdXRvY29tcGxldGUiICk7CgkJdGhpcy5tZW51LmVsZW1lbnQucmVtb3ZlKCk7CgkJdGhpcy5saXZlUmVnaW9uLnJlbW92ZSgpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJCWlmICgga2V5ID09PSAic291cmNlIiApIHsKCQkJdGhpcy5faW5pdFNvdXJjZSgpOwoJCX0KCQlpZiAoIGtleSA9PT0gImFwcGVuZFRvIiApIHsKCQkJdGhpcy5tZW51LmVsZW1lbnQuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCkgKTsKCQl9CgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgJiYgdmFsdWUgJiYgdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoJfSwKCglfaXNFdmVudFRhcmdldEluV2lkZ2V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIG1lbnVFbGVtZW50ID0gdGhpcy5tZW51LmVsZW1lbnRbIDAgXTsKCgkJcmV0dXJuIGV2ZW50LnRhcmdldCA9PT0gdGhpcy5lbGVtZW50WyAwIF0gfHwKCQkJZXZlbnQudGFyZ2V0ID09PSBtZW51RWxlbWVudCB8fAoJCQkkLmNvbnRhaW5zKCBtZW51RWxlbWVudCwgZXZlbnQudGFyZ2V0ICk7Cgl9LAoKCV9jbG9zZU9uQ2xpY2tPdXRzaWRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5faXNFdmVudFRhcmdldEluV2lkZ2V0KCBldmVudCApICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJfSwKCglfYXBwZW5kVG86IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gdGhpcy5vcHRpb25zLmFwcGVuZFRvOwoKCQlpZiAoIGVsZW1lbnQgKSB7CgkJCWVsZW1lbnQgPSBlbGVtZW50LmpxdWVyeSB8fCBlbGVtZW50Lm5vZGVUeXBlID8KCQkJCSQoIGVsZW1lbnQgKSA6CgkJCQl0aGlzLmRvY3VtZW50LmZpbmQoIGVsZW1lbnQgKS5lcSggMCApOwoJCX0KCgkJaWYgKCAhZWxlbWVudCB8fCAhZWxlbWVudFsgMCBdICkgewoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktZnJvbnQsIGRpYWxvZyIgKTsKCQl9CgoJCWlmICggIWVsZW1lbnQubGVuZ3RoICkgewoJCQllbGVtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHk7CgkJfQoKCQlyZXR1cm4gZWxlbWVudDsKCX0sCgoJX2luaXRTb3VyY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBhcnJheSwgdXJsLAoJCQl0aGF0ID0gdGhpczsKCQlpZiAoICQuaXNBcnJheSggdGhpcy5vcHRpb25zLnNvdXJjZSApICkgewoJCQlhcnJheSA9IHRoaXMub3B0aW9ucy5zb3VyY2U7CgkJCXRoaXMuc291cmNlID0gZnVuY3Rpb24oIHJlcXVlc3QsIHJlc3BvbnNlICkgewoJCQkJcmVzcG9uc2UoICQudWkuYXV0b2NvbXBsZXRlLmZpbHRlciggYXJyYXksIHJlcXVlc3QudGVybSApICk7CgkJCX07CgkJfSBlbHNlIGlmICggdHlwZW9mIHRoaXMub3B0aW9ucy5zb3VyY2UgPT09ICJzdHJpbmciICkgewoJCQl1cmwgPSB0aGlzLm9wdGlvbnMuc291cmNlOwoJCQl0aGlzLnNvdXJjZSA9IGZ1bmN0aW9uKCByZXF1ZXN0LCByZXNwb25zZSApIHsKCQkJCWlmICggdGhhdC54aHIgKSB7CgkJCQkJdGhhdC54aHIuYWJvcnQoKTsKCQkJCX0KCQkJCXRoYXQueGhyID0gJC5hamF4KCB7CgkJCQkJdXJsOiB1cmwsCgkJCQkJZGF0YTogcmVxdWVzdCwKCQkJCQlkYXRhVHlwZTogImpzb24iLAoJCQkJCXN1Y2Nlc3M6IGZ1bmN0aW9uKCBkYXRhICkgewoJCQkJCQlyZXNwb25zZSggZGF0YSApOwoJCQkJCX0sCgkJCQkJZXJyb3I6IGZ1bmN0aW9uKCkgewoJCQkJCQlyZXNwb25zZSggW10gKTsKCQkJCQl9CgkJCQl9ICk7CgkJCX07CgkJfSBlbHNlIHsKCQkJdGhpcy5zb3VyY2UgPSB0aGlzLm9wdGlvbnMuc291cmNlOwoJCX0KCX0sCgoJX3NlYXJjaFRpbWVvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQljbGVhclRpbWVvdXQoIHRoaXMuc2VhcmNoaW5nICk7CgkJdGhpcy5zZWFyY2hpbmcgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgoJCQkvLyBTZWFyY2ggaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkLCBvciBpZiB0aGUgdXNlciByZXR5cGVzIHRoZSBzYW1lIHZhbHVlIChzZWUgIzc0MzQpCgkJCXZhciBlcXVhbFZhbHVlcyA9IHRoaXMudGVybSA9PT0gdGhpcy5fdmFsdWUoKSwKCQkJCW1lbnVWaXNpYmxlID0gdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSwKCQkJCW1vZGlmaWVyS2V5ID0gZXZlbnQuYWx0S2V5IHx8IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC5zaGlmdEtleTsKCgkJCWlmICggIWVxdWFsVmFsdWVzIHx8ICggZXF1YWxWYWx1ZXMgJiYgIW1lbnVWaXNpYmxlICYmICFtb2RpZmllcktleSApICkgewoJCQkJdGhpcy5zZWxlY3RlZEl0ZW0gPSBudWxsOwoJCQkJdGhpcy5zZWFyY2goIG51bGwsIGV2ZW50ICk7CgkJCX0KCQl9LCB0aGlzLm9wdGlvbnMuZGVsYXkgKTsKCX0sCgoJc2VhcmNoOiBmdW5jdGlvbiggdmFsdWUsIGV2ZW50ICkgewoJCXZhbHVlID0gdmFsdWUgIT0gbnVsbCA\/IHZhbHVlIDogdGhpcy5fdmFsdWUoKTsKCgkJLy8gQWx3YXlzIHNhdmUgdGhlIGFjdHVhbCB2YWx1ZSwgbm90IHRoZSBvbmUgcGFzc2VkIGFzIGFuIGFyZ3VtZW50CgkJdGhpcy50ZXJtID0gdGhpcy5fdmFsdWUoKTsKCgkJaWYgKCB2YWx1ZS5sZW5ndGggPCB0aGlzLm9wdGlvbnMubWluTGVuZ3RoICkgewoJCQlyZXR1cm4gdGhpcy5jbG9zZSggZXZlbnQgKTsKCQl9CgoJCWlmICggdGhpcy5fdHJpZ2dlciggInNlYXJjaCIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlyZXR1cm4gdGhpcy5fc2VhcmNoKCB2YWx1ZSApOwoJfSwKCglfc2VhcmNoOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5wZW5kaW5nKys7CgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1hdXRvY29tcGxldGUtbG9hZGluZyIgKTsKCQl0aGlzLmNhbmNlbFNlYXJjaCA9IGZhbHNlOwoKCQl0aGlzLnNvdXJjZSggeyB0ZXJtOiB2YWx1ZSB9LCB0aGlzLl9yZXNwb25zZSgpICk7Cgl9LAoKCV9yZXNwb25zZTogZnVuY3Rpb24oKSB7CgkJdmFyIGluZGV4ID0gKyt0aGlzLnJlcXVlc3RJbmRleDsKCgkJcmV0dXJuICQucHJveHkoIGZ1bmN0aW9uKCBjb250ZW50ICkgewoJCQlpZiAoIGluZGV4ID09PSB0aGlzLnJlcXVlc3RJbmRleCApIHsKCQkJCXRoaXMuX19yZXNwb25zZSggY29udGVudCApOwoJCQl9CgoJCQl0aGlzLnBlbmRpbmctLTsKCQkJaWYgKCAhdGhpcy5wZW5kaW5nICkgewoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1hdXRvY29tcGxldGUtbG9hZGluZyIgKTsKCQkJfQoJCX0sIHRoaXMgKTsKCX0sCgoJX19yZXNwb25zZTogZnVuY3Rpb24oIGNvbnRlbnQgKSB7CgkJaWYgKCBjb250ZW50ICkgewoJCQljb250ZW50ID0gdGhpcy5fbm9ybWFsaXplKCBjb250ZW50ICk7CgkJfQoJCXRoaXMuX3RyaWdnZXIoICJyZXNwb25zZSIsIG51bGwsIHsgY29udGVudDogY29udGVudCB9ICk7CgkJaWYgKCAhdGhpcy5vcHRpb25zLmRpc2FibGVkICYmIGNvbnRlbnQgJiYgY29udGVudC5sZW5ndGggJiYgIXRoaXMuY2FuY2VsU2VhcmNoICkgewoJCQl0aGlzLl9zdWdnZXN0KCBjb250ZW50ICk7CgkJCXRoaXMuX3RyaWdnZXIoICJvcGVuIiApOwoJCX0gZWxzZSB7CgoJCQkvLyB1c2UgLl9jbG9zZSgpIGluc3RlYWQgb2YgLmNsb3NlKCkgc28gd2UgZG9uJ3QgY2FuY2VsIGZ1dHVyZSBzZWFyY2hlcwoJCQl0aGlzLl9jbG9zZSgpOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLmNhbmNlbFNlYXJjaCA9IHRydWU7CgkJdGhpcy5fY2xvc2UoIGV2ZW50ICk7Cgl9LAoKCV9jbG9zZTogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkvLyBSZW1vdmUgdGhlIGhhbmRsZXIgdGhhdCBjbG9zZXMgdGhlIG1lbnUgb24gb3V0c2lkZSBjbGlja3MKCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQsICJtb3VzZWRvd24iICk7CgoJCWlmICggdGhpcy5tZW51LmVsZW1lbnQuaXMoICI6dmlzaWJsZSIgKSApIHsKCQkJdGhpcy5tZW51LmVsZW1lbnQuaGlkZSgpOwoJCQl0aGlzLm1lbnUuYmx1cigpOwoJCQl0aGlzLmlzTmV3TWVudSA9IHRydWU7CgkJCXRoaXMuX3RyaWdnZXIoICJjbG9zZSIsIGV2ZW50ICk7CgkJfQoJfSwKCglfY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLnByZXZpb3VzICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiwgZXZlbnQsIHsgaXRlbTogdGhpcy5zZWxlY3RlZEl0ZW0gfSApOwoJCX0KCX0sCgoJX25vcm1hbGl6ZTogZnVuY3Rpb24oIGl0ZW1zICkgewoKCQkvLyBhc3N1bWUgYWxsIGl0ZW1zIGhhdmUgdGhlIHJpZ2h0IGZvcm1hdCB3aGVuIHRoZSBmaXJzdCBpdGVtIGlzIGNvbXBsZXRlCgkJaWYgKCBpdGVtcy5sZW5ndGggJiYgaXRlbXNbIDAgXS5sYWJlbCAmJiBpdGVtc1sgMCBdLnZhbHVlICkgewoJCQlyZXR1cm4gaXRlbXM7CgkJfQoJCXJldHVybiAkLm1hcCggaXRlbXMsIGZ1bmN0aW9uKCBpdGVtICkgewoJCQlpZiAoIHR5cGVvZiBpdGVtID09PSAic3RyaW5nIiApIHsKCQkJCXJldHVybiB7CgkJCQkJbGFiZWw6IGl0ZW0sCgkJCQkJdmFsdWU6IGl0ZW0KCQkJCX07CgkJCX0KCQkJcmV0dXJuICQuZXh0ZW5kKCB7fSwgaXRlbSwgewoJCQkJbGFiZWw6IGl0ZW0ubGFiZWwgfHwgaXRlbS52YWx1ZSwKCQkJCXZhbHVlOiBpdGVtLnZhbHVlIHx8IGl0ZW0ubGFiZWwKCQkJfSApOwoJCX0gKTsKCX0sCgoJX3N1Z2dlc3Q6IGZ1bmN0aW9uKCBpdGVtcyApIHsKCQl2YXIgdWwgPSB0aGlzLm1lbnUuZWxlbWVudC5lbXB0eSgpOwoJCXRoaXMuX3JlbmRlck1lbnUoIHVsLCBpdGVtcyApOwoJCXRoaXMuaXNOZXdNZW51ID0gdHJ1ZTsKCQl0aGlzLm1lbnUucmVmcmVzaCgpOwoKCQkvLyBTaXplIGFuZCBwb3NpdGlvbiBtZW51CgkJdWwuc2hvdygpOwoJCXRoaXMuX3Jlc2l6ZU1lbnUoKTsKCQl1bC5wb3NpdGlvbiggJC5leHRlbmQoIHsKCQkJb2Y6IHRoaXMuZWxlbWVudAoJCX0sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApICk7CgoJCWlmICggdGhpcy5vcHRpb25zLmF1dG9Gb2N1cyApIHsKCQkJdGhpcy5tZW51Lm5leHQoKTsKCQl9CgoJCS8vIExpc3RlbiBmb3IgaW50ZXJhY3Rpb25zIG91dHNpZGUgb2YgdGhlIHdpZGdldCAoIzY2NDIpCgkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJbW91c2Vkb3duOiAiX2Nsb3NlT25DbGlja091dHNpZGUiCgkJfSApOwoJfSwKCglfcmVzaXplTWVudTogZnVuY3Rpb24oKSB7CgkJdmFyIHVsID0gdGhpcy5tZW51LmVsZW1lbnQ7CgkJdWwub3V0ZXJXaWR0aCggTWF0aC5tYXgoCgoJCQkvLyBGaXJlZm94IHdyYXBzIGxvbmcgdGV4dCAocG9zc2libHkgYSByb3VuZGluZyBidWcpCgkJCS8vIHNvIHdlIGFkZCAxcHggdG8gYXZvaWQgdGhlIHdyYXBwaW5nICgjNzUxMykKCQkJdWwud2lkdGgoICIiICkub3V0ZXJXaWR0aCgpICsgMSwKCQkJdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKQoJCSkgKTsKCX0sCgoJX3JlbmRlck1lbnU6IGZ1bmN0aW9uKCB1bCwgaXRlbXMgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCSQuZWFjaCggaXRlbXMsIGZ1bmN0aW9uKCBpbmRleCwgaXRlbSApIHsKCQkJdGhhdC5fcmVuZGVySXRlbURhdGEoIHVsLCBpdGVtICk7CgkJfSApOwoJfSwKCglfcmVuZGVySXRlbURhdGE6IGZ1bmN0aW9uKCB1bCwgaXRlbSApIHsKCQlyZXR1cm4gdGhpcy5fcmVuZGVySXRlbSggdWwsIGl0ZW0gKS5kYXRhKCAidWktYXV0b2NvbXBsZXRlLWl0ZW0iLCBpdGVtICk7Cgl9LAoKCV9yZW5kZXJJdGVtOiBmdW5jdGlvbiggdWwsIGl0ZW0gKSB7CgkJcmV0dXJuICQoICI8bGk+IiApCgkJCS5hcHBlbmQoICQoICI8ZGl2PiIgKS50ZXh0KCBpdGVtLmxhYmVsICkgKQoJCQkuYXBwZW5kVG8oIHVsICk7Cgl9LAoKCV9tb3ZlOiBmdW5jdGlvbiggZGlyZWN0aW9uLCBldmVudCApIHsKCQlpZiAoICF0aGlzLm1lbnUuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoJCQl0aGlzLnNlYXJjaCggbnVsbCwgZXZlbnQgKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMubWVudS5pc0ZpcnN0SXRlbSgpICYmIC9ecHJldmlvdXMvLnRlc3QoIGRpcmVjdGlvbiApIHx8CgkJCQl0aGlzLm1lbnUuaXNMYXN0SXRlbSgpICYmIC9ebmV4dC8udGVzdCggZGlyZWN0aW9uICkgKSB7CgoJCQlpZiAoICF0aGlzLmlzTXVsdGlMaW5lICkgewoJCQkJdGhpcy5fdmFsdWUoIHRoaXMudGVybSApOwoJCQl9CgoJCQl0aGlzLm1lbnUuYmx1cigpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMubWVudVsgZGlyZWN0aW9uIF0oIGV2ZW50ICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWVudS5lbGVtZW50OwoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnZhbHVlTWV0aG9kLmFwcGx5KCB0aGlzLmVsZW1lbnQsIGFyZ3VtZW50cyApOwoJfSwKCglfa2V5RXZlbnQ6IGZ1bmN0aW9uKCBrZXlFdmVudCwgZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5pc011bHRpTGluZSB8fCB0aGlzLm1lbnUuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoJCQl0aGlzLl9tb3ZlKCBrZXlFdmVudCwgZXZlbnQgKTsKCgkJCS8vIFByZXZlbnRzIG1vdmluZyBjdXJzb3IgdG8gYmVnaW5uaW5nL2VuZCBvZiB0aGUgdGV4dCBmaWVsZCBpbiBzb21lIGJyb3dzZXJzCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCgkvLyBTdXBwb3J0OiBDaHJvbWUgPD01MAoJLy8gV2Ugc2hvdWxkIGJlIGFibGUgdG8ganVzdCB1c2UgdGhpcy5lbGVtZW50LnByb3AoICJpc0NvbnRlbnRFZGl0YWJsZSIgKQoJLy8gYnV0IGhpZGRlbiBlbGVtZW50cyBhbHdheXMgcmVwb3J0IGZhbHNlIGluIENocm9tZS4KCS8vIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0zMTMwODIKCV9pc0NvbnRlbnRFZGl0YWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJaWYgKCAhZWxlbWVudC5sZW5ndGggKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXZhciBlZGl0YWJsZSA9IGVsZW1lbnQucHJvcCggImNvbnRlbnRFZGl0YWJsZSIgKTsKCgkJaWYgKCBlZGl0YWJsZSA9PT0gImluaGVyaXQiICkgewoJCSAgcmV0dXJuIHRoaXMuX2lzQ29udGVudEVkaXRhYmxlKCBlbGVtZW50LnBhcmVudCgpICk7CgkJfQoKCQlyZXR1cm4gZWRpdGFibGUgPT09ICJ0cnVlIjsKCX0KfSApOwoKJC5leHRlbmQoICQudWkuYXV0b2NvbXBsZXRlLCB7Cgllc2NhcGVSZWdleDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXJldHVybiB2YWx1ZS5yZXBsYWNlKCAvW1wtXFtcXXt9KCkqKz8uLFxcXF4kfCNcc10vZywgIlxcJCYiICk7Cgl9LAoJZmlsdGVyOiBmdW5jdGlvbiggYXJyYXksIHRlcm0gKSB7CgkJdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKCAkLnVpLmF1dG9jb21wbGV0ZS5lc2NhcGVSZWdleCggdGVybSApLCAiaSIgKTsKCQlyZXR1cm4gJC5ncmVwKCBhcnJheSwgZnVuY3Rpb24oIHZhbHVlICkgewoJCQlyZXR1cm4gbWF0Y2hlci50ZXN0KCB2YWx1ZS5sYWJlbCB8fCB2YWx1ZS52YWx1ZSB8fCB2YWx1ZSApOwoJCX0gKTsKCX0KfSApOwoKLy8gTGl2ZSByZWdpb24gZXh0ZW5zaW9uLCBhZGRpbmcgYSBgbWVzc2FnZXNgIG9wdGlvbgovLyBOT1RFOiBUaGlzIGlzIGFuIGV4cGVyaW1lbnRhbCBBUEkuIFdlIGFyZSBzdGlsbCBpbnZlc3RpZ2F0aW5nCi8vIGEgZnVsbCBzb2x1dGlvbiBmb3Igc3RyaW5nIG1hbmlwdWxhdGlvbiBhbmQgaW50ZXJuYXRpb25hbGl6YXRpb24uCiQud2lkZ2V0KCAidWkuYXV0b2NvbXBsZXRlIiwgJC51aS5hdXRvY29tcGxldGUsIHsKCW9wdGlvbnM6IHsKCQltZXNzYWdlczogewoJCQlub1Jlc3VsdHM6ICJObyBzZWFyY2ggcmVzdWx0cy4iLAoJCQlyZXN1bHRzOiBmdW5jdGlvbiggYW1vdW50ICkgewoJCQkJcmV0dXJuIGFtb3VudCArICggYW1vdW50ID4gMSA\/ICIgcmVzdWx0cyBhcmUiIDogIiByZXN1bHQgaXMiICkgKwoJCQkJCSIgYXZhaWxhYmxlLCB1c2UgdXAgYW5kIGRvd24gYXJyb3cga2V5cyB0byBuYXZpZ2F0ZS4iOwoJCQl9CgkJfQoJfSwKCglfX3Jlc3BvbnNlOiBmdW5jdGlvbiggY29udGVudCApIHsKCQl2YXIgbWVzc2FnZTsKCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmNhbmNlbFNlYXJjaCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIGNvbnRlbnQgJiYgY29udGVudC5sZW5ndGggKSB7CgkJCW1lc3NhZ2UgPSB0aGlzLm9wdGlvbnMubWVzc2FnZXMucmVzdWx0cyggY29udGVudC5sZW5ndGggKTsKCQl9IGVsc2UgewoJCQltZXNzYWdlID0gdGhpcy5vcHRpb25zLm1lc3NhZ2VzLm5vUmVzdWx0czsKCQl9CgkJdGhpcy5saXZlUmVnaW9uLmNoaWxkcmVuKCkuaGlkZSgpOwoJCSQoICI8ZGl2PiIgKS50ZXh0KCBtZXNzYWdlICkuYXBwZW5kVG8oIHRoaXMubGl2ZVJlZ2lvbiApOwoJfQp9ICk7Cgp2YXIgd2lkZ2V0c0F1dG9jb21wbGV0ZSA9ICQudWkuYXV0b2NvbXBsZXRlOwoKCi8qIQogKiBqUXVlcnkgVUkgQ29udHJvbGdyb3VwIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogQ29udHJvbGdyb3VwCi8vPj5ncm91cDogV2lkZ2V0cwovLz4+ZGVzY3JpcHRpb246IFZpc3VhbGx5IGdyb3VwcyBmb3JtIGNvbnRyb2wgd2lkZ2V0cwovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY29udHJvbGdyb3VwLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vY29udHJvbGdyb3VwLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvbnRyb2xncm91cC5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKdmFyIGNvbnRyb2xncm91cENvcm5lclJlZ2V4ID0gL3VpLWNvcm5lci0oW2Etel0pezIsNn0vZzsKCnZhciB3aWRnZXRzQ29udHJvbGdyb3VwID0gJC53aWRnZXQoICJ1aS5jb250cm9sZ3JvdXAiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpcmVjdGlvbjogImhvcml6b250YWwiLAoJCWRpc2FibGVkOiBudWxsLAoJCW9ubHlWaXNpYmxlOiB0cnVlLAoJCWl0ZW1zOiB7CgkJCSJidXR0b24iOiAiaW5wdXRbdHlwZT1idXR0b25dLCBpbnB1dFt0eXBlPXN1Ym1pdF0sIGlucHV0W3R5cGU9cmVzZXRdLCBidXR0b24sIGEiLAoJCQkiY29udHJvbGdyb3VwTGFiZWwiOiAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIsCgkJCSJjaGVja2JveHJhZGlvIjogImlucHV0W3R5cGU9J2NoZWNrYm94J10sIGlucHV0W3R5cGU9J3JhZGlvJ10iLAoJCQkic2VsZWN0bWVudSI6ICJzZWxlY3QiLAoJCQkic3Bpbm5lciI6ICIudWktc3Bpbm5lci1pbnB1dCIKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2VuaGFuY2UoKTsKCX0sCgoJLy8gVG8gc3VwcG9ydCB0aGUgZW5oYW5jZWQgb3B0aW9uIGluIGpRdWVyeSBNb2JpbGUsIHdlIGlzb2xhdGUgRE9NIG1hbmlwdWxhdGlvbgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAicm9sZSIsICJ0b29sYmFyIiApOwoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fY2FsbENoaWxkTWV0aG9kKCAiZGVzdHJveSIgKTsKCQl0aGlzLmNoaWxkV2lkZ2V0cy5yZW1vdmVEYXRhKCAidWktY29udHJvbGdyb3VwLWRhdGEiICk7CgkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJyb2xlIiApOwoJCWlmICggdGhpcy5vcHRpb25zLml0ZW1zLmNvbnRyb2xncm91cExhYmVsICkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5maW5kKCB0aGlzLm9wdGlvbnMuaXRlbXMuY29udHJvbGdyb3VwTGFiZWwgKQoJCQkJLmZpbmQoICIudWktY29udHJvbGdyb3VwLWxhYmVsLWNvbnRlbnRzIiApCgkJCQkuY29udGVudHMoKS51bndyYXAoKTsKCQl9Cgl9LAoKCV9pbml0V2lkZ2V0czogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQljaGlsZFdpZGdldHMgPSBbXTsKCgkJLy8gRmlyc3Qgd2UgaXRlcmF0ZSBvdmVyIGVhY2ggb2YgdGhlIGl0ZW1zIG9wdGlvbnMKCQkkLmVhY2goIHRoaXMub3B0aW9ucy5pdGVtcywgZnVuY3Rpb24oIHdpZGdldCwgc2VsZWN0b3IgKSB7CgkJCXZhciBsYWJlbHM7CgkJCXZhciBvcHRpb25zID0ge307CgoJCQkvLyBNYWtlIHN1cmUgdGhlIHdpZGdldCBoYXMgYSBzZWxlY3RvciBzZXQKCQkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggd2lkZ2V0ID09PSAiY29udHJvbGdyb3VwTGFiZWwiICkgewoJCQkJbGFiZWxzID0gdGhhdC5lbGVtZW50LmZpbmQoIHNlbGVjdG9yICk7CgkJCQlsYWJlbHMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICk7CgoJCQkJCWlmICggZWxlbWVudC5jaGlsZHJlbiggIi51aS1jb250cm9sZ3JvdXAtbGFiZWwtY29udGVudHMiICkubGVuZ3RoICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCWVsZW1lbnQuY29udGVudHMoKQoJCQkJCQkud3JhcEFsbCggIjxzcGFuIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwtY29udGVudHMnPjwvc3Bhbj4iICk7CgkJCQl9ICk7CgkJCQl0aGF0Ll9hZGRDbGFzcyggbGFiZWxzLCBudWxsLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLXN0YXRlLWRlZmF1bHQiICk7CgkJCQljaGlsZFdpZGdldHMgPSBjaGlsZFdpZGdldHMuY29uY2F0KCBsYWJlbHMuZ2V0KCkgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSB3aWRnZXQgYWN0dWFsbHkgZXhpc3RzCgkJCWlmICggISQuZm5bIHdpZGdldCBdICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBXZSBhc3N1bWUgZXZlcnl0aGluZyBpcyBpbiB0aGUgbWlkZGxlIHRvIHN0YXJ0IGJlY2F1c2Ugd2UgY2FuJ3QgZGV0ZXJtaW5lCgkJCS8vIGZpcnN0IC8gbGFzdCBlbGVtZW50cyB1bnRpbCBhbGwgZW5oYW5jbWVudHMgYXJlIGRvbmUuCgkJCWlmICggdGhhdFsgIl8iICsgd2lkZ2V0ICsgIk9wdGlvbnMiIF0gKSB7CgkJCQlvcHRpb25zID0gdGhhdFsgIl8iICsgd2lkZ2V0ICsgIk9wdGlvbnMiIF0oICJtaWRkbGUiICk7CgkJCX0gZWxzZSB7CgkJCQlvcHRpb25zID0geyBjbGFzc2VzOiB7fSB9OwoJCQl9CgoJCQkvLyBGaW5kIGluc3RhbmNlcyBvZiB0aGlzIHdpZGdldCBpbnNpZGUgY29udHJvbGdyb3VwIGFuZCBpbml0IHRoZW0KCQkJdGhhdC5lbGVtZW50CgkJCQkuZmluZCggc2VsZWN0b3IgKQoJCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtZW50ID0gJCggdGhpcyApOwoJCQkJCXZhciBpbnN0YW5jZSA9IGVsZW1lbnRbIHdpZGdldCBdKCAiaW5zdGFuY2UiICk7CgoJCQkJCS8vIFdlIG5lZWQgdG8gY2xvbmUgdGhlIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhpcyB0eXBlIG9mIHdpZGdldCB0byBhdm9pZAoJCQkJCS8vIHBvbGx1dGluZyB0aGUgdmFyaWFibGUgb3B0aW9ucyB3aGljaCBoYXMgYSB3aWRlciBzY29wZSB0aGFuIGEgc2luZ2xlIHdpZGdldC4KCQkJCQl2YXIgaW5zdGFuY2VPcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKCQkJCQkvLyBJZiB0aGUgYnV0dG9uIGlzIHRoZSBjaGlsZCBvZiBhIHNwaW5uZXIgaWdub3JlIGl0CgkJCQkJLy8gVE9ETzogRmluZCBhIG1vcmUgZ2VuZXJpYyBzb2x1dGlvbgoJCQkJCWlmICggd2lkZ2V0ID09PSAiYnV0dG9uIiAmJiBlbGVtZW50LnBhcmVudCggIi51aS1zcGlubmVyIiApLmxlbmd0aCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gQ3JlYXRlIHRoZSB3aWRnZXQgaWYgaXQgZG9lc24ndCBleGlzdAoJCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCQlpbnN0YW5jZSA9IGVsZW1lbnRbIHdpZGdldCBdKClbIHdpZGdldCBdKCAiaW5zdGFuY2UiICk7CgkJCQkJfQoJCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJCWluc3RhbmNlT3B0aW9ucy5jbGFzc2VzID0KCQkJCQkJCXRoYXQuX3Jlc29sdmVDbGFzc2VzVmFsdWVzKCBpbnN0YW5jZU9wdGlvbnMuY2xhc3NlcywgaW5zdGFuY2UgKTsKCQkJCQl9CgkJCQkJZWxlbWVudFsgd2lkZ2V0IF0oIGluc3RhbmNlT3B0aW9ucyApOwoKCQkJCQkvLyBTdG9yZSBhbiBpbnN0YW5jZSBvZiB0aGUgY29udHJvbGdyb3VwIHRvIGJlIGFibGUgdG8gcmVmZXJlbmNlCgkJCQkJLy8gZnJvbSB0aGUgb3V0ZXJtb3N0IGVsZW1lbnQgZm9yIGNoYW5naW5nIG9wdGlvbnMgYW5kIHJlZnJlc2gKCQkJCQl2YXIgd2lkZ2V0RWxlbWVudCA9IGVsZW1lbnRbIHdpZGdldCBdKCAid2lkZ2V0IiApOwoJCQkJCSQuZGF0YSggd2lkZ2V0RWxlbWVudFsgMCBdLCAidWktY29udHJvbGdyb3VwLWRhdGEiLAoJCQkJCQlpbnN0YW5jZSA\/IGluc3RhbmNlIDogZWxlbWVudFsgd2lkZ2V0IF0oICJpbnN0YW5jZSIgKSApOwoKCQkJCQljaGlsZFdpZGdldHMucHVzaCggd2lkZ2V0RWxlbWVudFsgMCBdICk7CgkJCQl9ICk7CgkJfSApOwoKCQl0aGlzLmNoaWxkV2lkZ2V0cyA9ICQoICQudW5pcXVlKCBjaGlsZFdpZGdldHMgKSApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmNoaWxkV2lkZ2V0cywgInVpLWNvbnRyb2xncm91cC1pdGVtIiApOwoJfSwKCglfY2FsbENoaWxkTWV0aG9kOiBmdW5jdGlvbiggbWV0aG9kICkgewoJCXRoaXMuY2hpbGRXaWRnZXRzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKSwKCQkJCWRhdGEgPSBlbGVtZW50LmRhdGEoICJ1aS1jb250cm9sZ3JvdXAtZGF0YSIgKTsKCQkJaWYgKCBkYXRhICYmIGRhdGFbIG1ldGhvZCBdICkgewoJCQkJZGF0YVsgbWV0aG9kIF0oKTsKCQkJfQoJCX0gKTsKCX0sCgoJX3VwZGF0ZUNvcm5lckNsYXNzOiBmdW5jdGlvbiggZWxlbWVudCwgcG9zaXRpb24gKSB7CgkJdmFyIHJlbW92ZSA9ICJ1aS1jb3JuZXItdG9wIHVpLWNvcm5lci1ib3R0b20gdWktY29ybmVyLWxlZnQgdWktY29ybmVyLXJpZ2h0IHVpLWNvcm5lci1hbGwiOwoJCXZhciBhZGQgPSB0aGlzLl9idWlsZFNpbXBsZU9wdGlvbnMoIHBvc2l0aW9uLCAibGFiZWwiICkuY2xhc3Nlcy5sYWJlbDsKCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGVsZW1lbnQsIG51bGwsIHJlbW92ZSApOwoJCXRoaXMuX2FkZENsYXNzKCBlbGVtZW50LCBudWxsLCBhZGQgKTsKCX0sCgoJX2J1aWxkU2ltcGxlT3B0aW9uczogZnVuY3Rpb24oIHBvc2l0aW9uLCBrZXkgKSB7CgkJdmFyIGRpcmVjdGlvbiA9IHRoaXMub3B0aW9ucy5kaXJlY3Rpb24gPT09ICJ2ZXJ0aWNhbCI7CgkJdmFyIHJlc3VsdCA9IHsKCQkJY2xhc3Nlczoge30KCQl9OwoJCXJlc3VsdC5jbGFzc2VzWyBrZXkgXSA9IHsKCQkJIm1pZGRsZSI6ICIiLAoJCQkiZmlyc3QiOiAidWktY29ybmVyLSIgKyAoIGRpcmVjdGlvbiA\/ICJ0b3AiIDogImxlZnQiICksCgkJCSJsYXN0IjogInVpLWNvcm5lci0iICsgKCBkaXJlY3Rpb24gPyAiYm90dG9tIiA6ICJyaWdodCIgKSwKCQkJIm9ubHkiOiAidWktY29ybmVyLWFsbCIKCQl9WyBwb3NpdGlvbiBdOwoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCglfc3Bpbm5lck9wdGlvbnM6IGZ1bmN0aW9uKCBwb3NpdGlvbiApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMuX2J1aWxkU2ltcGxlT3B0aW9ucyggcG9zaXRpb24sICJ1aS1zcGlubmVyIiApOwoKCQlvcHRpb25zLmNsYXNzZXNbICJ1aS1zcGlubmVyLXVwIiBdID0gIiI7CgkJb3B0aW9ucy5jbGFzc2VzWyAidWktc3Bpbm5lci1kb3duIiBdID0gIiI7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfYnV0dG9uT3B0aW9uczogZnVuY3Rpb24oIHBvc2l0aW9uICkgewoJCXJldHVybiB0aGlzLl9idWlsZFNpbXBsZU9wdGlvbnMoIHBvc2l0aW9uLCAidWktYnV0dG9uIiApOwoJfSwKCglfY2hlY2tib3hyYWRpb09wdGlvbnM6IGZ1bmN0aW9uKCBwb3NpdGlvbiApIHsKCQlyZXR1cm4gdGhpcy5fYnVpbGRTaW1wbGVPcHRpb25zKCBwb3NpdGlvbiwgInVpLWNoZWNrYm94cmFkaW8tbGFiZWwiICk7Cgl9LAoKCV9zZWxlY3RtZW51T3B0aW9uczogZnVuY3Rpb24oIHBvc2l0aW9uICkgewoJCXZhciBkaXJlY3Rpb24gPSB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uID09PSAidmVydGljYWwiOwoJCXJldHVybiB7CgkJCXdpZHRoOiBkaXJlY3Rpb24gPyAiYXV0byIgOiBmYWxzZSwKCQkJY2xhc3NlczogewoJCQkJbWlkZGxlOiB7CgkJCQkJInVpLXNlbGVjdG1lbnUtYnV0dG9uLW9wZW4iOiAiIiwKCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tY2xvc2VkIjogIiIKCQkJCX0sCgkJCQlmaXJzdDogewoJCQkJCSJ1aS1zZWxlY3RtZW51LWJ1dHRvbi1vcGVuIjogInVpLWNvcm5lci0iICsgKCBkaXJlY3Rpb24gPyAidG9wIiA6ICJ0bCIgKSwKCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tY2xvc2VkIjogInVpLWNvcm5lci0iICsgKCBkaXJlY3Rpb24gPyAidG9wIiA6ICJsZWZ0IiApCgkJCQl9LAoJCQkJbGFzdDogewoJCQkJCSJ1aS1zZWxlY3RtZW51LWJ1dHRvbi1vcGVuIjogZGlyZWN0aW9uID8gIiIgOiAidWktY29ybmVyLXRyIiwKCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tY2xvc2VkIjogInVpLWNvcm5lci0iICsgKCBkaXJlY3Rpb24gPyAiYm90dG9tIiA6ICJyaWdodCIgKQoJCQkJfSwKCQkJCW9ubHk6IHsKCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tb3BlbiI6ICJ1aS1jb3JuZXItdG9wIiwKCQkJCQkidWktc2VsZWN0bWVudS1idXR0b24tY2xvc2VkIjogInVpLWNvcm5lci1hbGwiCgkJCQl9CgoJCQl9WyBwb3NpdGlvbiBdCgkJfTsKCX0sCgoJX3Jlc29sdmVDbGFzc2VzVmFsdWVzOiBmdW5jdGlvbiggY2xhc3NlcywgaW5zdGFuY2UgKSB7CgkJdmFyIHJlc3VsdCA9IHt9OwoJCSQuZWFjaCggY2xhc3NlcywgZnVuY3Rpb24oIGtleSApIHsKCQkJdmFyIGN1cnJlbnQgPSBpbnN0YW5jZS5vcHRpb25zLmNsYXNzZXNbIGtleSBdIHx8ICIiOwoJCQljdXJyZW50ID0gJC50cmltKCBjdXJyZW50LnJlcGxhY2UoIGNvbnRyb2xncm91cENvcm5lclJlZ2V4LCAiIiApICk7CgkJCXJlc3VsdFsga2V5IF0gPSAoIGN1cnJlbnQgKyAiICIgKyBjbGFzc2VzWyBrZXkgXSApLnJlcGxhY2UoIC9ccysvZywgIiAiICk7CgkJfSApOwoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiZGlyZWN0aW9uIiApIHsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtIiArIHRoaXMub3B0aW9ucy5kaXJlY3Rpb24gKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMuX2NhbGxDaGlsZE1ldGhvZCggdmFsdWUgPyAiZGlzYWJsZSIgOiAiZW5hYmxlIiApOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGNoaWxkcmVuLAoJCQl0aGF0ID0gdGhpczsKCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAgdWktY29udHJvbGdyb3VwLSIgKyB0aGlzLm9wdGlvbnMuZGlyZWN0aW9uICk7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpcmVjdGlvbiA9PT0gImhvcml6b250YWwiICkgewoJCQl0aGlzLl9hZGRDbGFzcyggbnVsbCwgInVpLWhlbHBlci1jbGVhcmZpeCIgKTsKCQl9CgkJdGhpcy5faW5pdFdpZGdldHMoKTsKCgkJY2hpbGRyZW4gPSB0aGlzLmNoaWxkV2lkZ2V0czsKCgkJLy8gV2UgZmlsdGVyIGhlcmUgYmVjYXVzZSB3ZSBuZWVkIHRvIHRyYWNrIGFsbCBjaGlsZFdpZGdldHMgbm90IGp1c3QgdGhlIHZpc2libGUgb25lcwoJCWlmICggdGhpcy5vcHRpb25zLm9ubHlWaXNpYmxlICkgewoJCQljaGlsZHJlbiA9IGNoaWxkcmVuLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCX0KCgkJaWYgKCBjaGlsZHJlbi5sZW5ndGggKSB7CgoJCQkvLyBXZSBkbyB0aGlzIGxhc3QgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSBhbGwgZW5oYW5jbWVudCBpcyBkb25lCgkJCS8vIGJlZm9yZSBkZXRlcm1pbmluZyBmaXJzdCBhbmQgbGFzdAoJCQkkLmVhY2goIFsgImZpcnN0IiwgImxhc3QiIF0sIGZ1bmN0aW9uKCBpbmRleCwgdmFsdWUgKSB7CgkJCQl2YXIgaW5zdGFuY2UgPSBjaGlsZHJlblsgdmFsdWUgXSgpLmRhdGEoICJ1aS1jb250cm9sZ3JvdXAtZGF0YSIgKTsKCgkJCQlpZiAoIGluc3RhbmNlICYmIHRoYXRbICJfIiArIGluc3RhbmNlLndpZGdldE5hbWUgKyAiT3B0aW9ucyIgXSApIHsKCQkJCQl2YXIgb3B0aW9ucyA9IHRoYXRbICJfIiArIGluc3RhbmNlLndpZGdldE5hbWUgKyAiT3B0aW9ucyIgXSgKCQkJCQkJY2hpbGRyZW4ubGVuZ3RoID09PSAxID8gIm9ubHkiIDogdmFsdWUKCQkJCQkpOwoJCQkJCW9wdGlvbnMuY2xhc3NlcyA9IHRoYXQuX3Jlc29sdmVDbGFzc2VzVmFsdWVzKCBvcHRpb25zLmNsYXNzZXMsIGluc3RhbmNlICk7CgkJCQkJaW5zdGFuY2UuZWxlbWVudFsgaW5zdGFuY2Uud2lkZ2V0TmFtZSBdKCBvcHRpb25zICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoYXQuX3VwZGF0ZUNvcm5lckNsYXNzKCBjaGlsZHJlblsgdmFsdWUgXSgpLCB2YWx1ZSApOwoJCQkJfQoJCQl9ICk7CgoJCQkvLyBGaW5hbGx5IGNhbGwgdGhlIHJlZnJlc2ggbWV0aG9kIG9uIGVhY2ggb2YgdGhlIGNoaWxkIHdpZGdldHMuCgkJCXRoaXMuX2NhbGxDaGlsZE1ldGhvZCggInJlZnJlc2giICk7CgkJfQoJfQp9ICk7CgovKiEKICogalF1ZXJ5IFVJIENoZWNrYm94cmFkaW8gMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBDaGVja2JveHJhZGlvCi8vPj5ncm91cDogV2lkZ2V0cwovLz4+ZGVzY3JpcHRpb246IEVuaGFuY2VzIGEgZm9ybSB3aXRoIG11bHRpcGxlIHRoZW1lYWJsZSBjaGVja2JveGVzIG9yIHJhZGlvIGJ1dHRvbnMuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9jaGVja2JveHJhZGlvLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vY2hlY2tib3hyYWRpby8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9idXR0b24uY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jaGVja2JveHJhZGlvLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKJC53aWRnZXQoICJ1aS5jaGVja2JveHJhZGlvIiwgWyAkLnVpLmZvcm1SZXNldE1peGluLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCW9wdGlvbnM6IHsKCQlkaXNhYmxlZDogbnVsbCwKCQlsYWJlbDogbnVsbCwKCQlpY29uOiB0cnVlLAoJCWNsYXNzZXM6IHsKCQkJInVpLWNoZWNrYm94cmFkaW8tbGFiZWwiOiAidWktY29ybmVyLWFsbCIsCgkJCSJ1aS1jaGVja2JveHJhZGlvLWljb24iOiAidWktY29ybmVyLWFsbCIKCQl9Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlzYWJsZWQsIGxhYmVsczsKCQl2YXIgdGhhdCA9IHRoaXM7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLl9zdXBlcigpIHx8IHt9OwoKCQkvLyBXZSByZWFkIHRoZSB0eXBlIGhlcmUsIGJlY2F1c2UgaXQgbWFrZXMgbW9yZSBzZW5zZSB0byB0aHJvdyBhIGVsZW1lbnQgdHlwZSBlcnJvciBmaXJzdCwKCQkvLyByYXRoZXIgdGhlbiB0aGUgZXJyb3IgZm9yIGxhY2sgb2YgYSBsYWJlbC4gT2Z0ZW4gaWYgaXRzIHRoZSB3cm9uZyB0eXBlLCBpdAoJCS8vIHdvbid0IGhhdmUgYSBsYWJlbCAoZS5nLiBjYWxsaW5nIG9uIGEgZGl2LCBidG4sIGV0YykKCQl0aGlzLl9yZWFkVHlwZSgpOwoKCQlsYWJlbHMgPSB0aGlzLmVsZW1lbnQubGFiZWxzKCk7CgoJCS8vIElmIHRoZXJlIGFyZSBtdWx0aXBsZSBsYWJlbHMsIHVzZSB0aGUgbGFzdCBvbmUKCQl0aGlzLmxhYmVsID0gJCggbGFiZWxzWyBsYWJlbHMubGVuZ3RoIC0gMSBdICk7CgkJaWYgKCAhdGhpcy5sYWJlbC5sZW5ndGggKSB7CgkJCSQuZXJyb3IoICJObyBsYWJlbCBmb3VuZCBmb3IgY2hlY2tib3hyYWRpbyB3aWRnZXQiICk7CgkJfQoKCQl0aGlzLm9yaWdpbmFsTGFiZWwgPSAiIjsKCgkJLy8gV2UgbmVlZCB0byBnZXQgdGhlIGxhYmVsIHRleHQgYnV0IHRoaXMgbWF5IGFsc28gbmVlZCB0byBtYWtlIHN1cmUgaXQgZG9lcyBub3QgY29udGFpbiB0aGUKCQkvLyBpbnB1dCBpdHNlbGYuCgkJdGhpcy5sYWJlbC5jb250ZW50cygpLm5vdCggdGhpcy5lbGVtZW50WyAwIF0gKS5lYWNoKCBmdW5jdGlvbigpIHsKCgkJCS8vIFRoZSBsYWJlbCBjb250ZW50cyBjb3VsZCBiZSB0ZXh0LCBodG1sLCBvciBhIG1peC4gV2UgY29uY2F0IGVhY2ggZWxlbWVudCB0byBnZXQgYQoJCQkvLyBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGxhYmVsLCB3aXRob3V0IHRoZSBpbnB1dCBhcyBwYXJ0IG9mIGl0LgoJCQl0aGF0Lm9yaWdpbmFsTGFiZWwgKz0gdGhpcy5ub2RlVHlwZSA9PT0gMyA\/ICQoIHRoaXMgKS50ZXh0KCkgOiB0aGlzLm91dGVySFRNTDsKCQl9ICk7CgoJCS8vIFNldCB0aGUgbGFiZWwgb3B0aW9uIGlmIHdlIGZvdW5kIGxhYmVsIHRleHQKCQlpZiAoIHRoaXMub3JpZ2luYWxMYWJlbCApIHsKCQkJb3B0aW9ucy5sYWJlbCA9IHRoaXMub3JpZ2luYWxMYWJlbDsKCQl9CgoJCWRpc2FibGVkID0gdGhpcy5lbGVtZW50WyAwIF0uZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCAhPSBudWxsICkgewoJCQlvcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7CgkJfQoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgY2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQ7CgoJCXRoaXMuX2JpbmRGb3JtUmVzZXRIYW5kbGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkID09IG51bGwgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkOwoJCX0KCgkJdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9hZGRDbGFzcyggInVpLWNoZWNrYm94cmFkaW8iLCAidWktaGVscGVyLWhpZGRlbi1hY2Nlc3NpYmxlIiApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmxhYmVsLCAidWktY2hlY2tib3hyYWRpby1sYWJlbCIsICJ1aS1idXR0b24gdWktd2lkZ2V0IiApOwoKCQlpZiAoIHRoaXMudHlwZSA9PT0gInJhZGlvIiApIHsKCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGFiZWwsICJ1aS1jaGVja2JveHJhZGlvLXJhZGlvLWxhYmVsIiApOwoJCX0KCgkJaWYgKCB0aGlzLm9wdGlvbnMubGFiZWwgJiYgdGhpcy5vcHRpb25zLmxhYmVsICE9PSB0aGlzLm9yaWdpbmFsTGFiZWwgKSB7CgkJCXRoaXMuX3VwZGF0ZUxhYmVsKCk7CgkJfSBlbHNlIGlmICggdGhpcy5vcmlnaW5hbExhYmVsICkgewoJCQl0aGlzLm9wdGlvbnMubGFiZWwgPSB0aGlzLm9yaWdpbmFsTGFiZWw7CgkJfQoKCQl0aGlzLl9lbmhhbmNlKCk7CgoJCWlmICggY2hlY2tlZCApIHsKCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMubGFiZWwsICJ1aS1jaGVja2JveHJhZGlvLWNoZWNrZWQiLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQlpZiAoIHRoaXMuaWNvbiApIHsKCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmljb24sIG51bGwsICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0KCgkJdGhpcy5fb24oIHsKCQkJY2hhbmdlOiAiX3RvZ2dsZUNsYXNzZXMiLAoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5sYWJlbCwgbnVsbCwgInVpLXN0YXRlLWZvY3VzIHVpLXZpc3VhbC1mb2N1cyIgKTsKCQkJfSwKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5sYWJlbCwgbnVsbCwgInVpLXN0YXRlLWZvY3VzIHVpLXZpc3VhbC1mb2N1cyIgKTsKCQkJfQoJCX0gKTsKCX0sCgoJX3JlYWRUeXBlOiBmdW5jdGlvbigpIHsKCQl2YXIgbm9kZU5hbWUgPSB0aGlzLmVsZW1lbnRbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCXRoaXMudHlwZSA9IHRoaXMuZWxlbWVudFsgMCBdLnR5cGU7CgkJaWYgKCBub2RlTmFtZSAhPT0gImlucHV0IiB8fCAhL3JhZGlvfGNoZWNrYm94Ly50ZXN0KCB0aGlzLnR5cGUgKSApIHsKCQkJJC5lcnJvciggIkNhbid0IGNyZWF0ZSBjaGVja2JveHJhZGlvIG9uIGVsZW1lbnQubm9kZU5hbWU9IiArIG5vZGVOYW1lICsKCQkJCSIgYW5kIGVsZW1lbnQudHlwZT0iICsgdGhpcy50eXBlICk7CgkJfQoJfSwKCgkvLyBTdXBwb3J0IGpRdWVyeSBNb2JpbGUgZW5oYW5jZWQgb3B0aW9uCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdXBkYXRlSWNvbiggdGhpcy5lbGVtZW50WyAwIF0uY2hlY2tlZCApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsOwoJfSwKCglfZ2V0UmFkaW9Hcm91cDogZnVuY3Rpb24oKSB7CgkJdmFyIGdyb3VwOwoJCXZhciBuYW1lID0gdGhpcy5lbGVtZW50WyAwIF0ubmFtZTsKCQl2YXIgbmFtZVNlbGVjdG9yID0gImlucHV0W25hbWU9JyIgKyAkLnVpLmVzY2FwZVNlbGVjdG9yKCBuYW1lICkgKyAiJ10iOwoKCQlpZiAoICFuYW1lICkgewoJCQlyZXR1cm4gJCggW10gKTsKCQl9CgoJCWlmICggdGhpcy5mb3JtLmxlbmd0aCApIHsKCQkJZ3JvdXAgPSAkKCB0aGlzLmZvcm1bIDAgXS5lbGVtZW50cyApLmZpbHRlciggbmFtZVNlbGVjdG9yICk7CgkJfSBlbHNlIHsKCgkJCS8vIE5vdCBpbnNpZGUgYSBmb3JtLCBjaGVjayBhbGwgaW5wdXRzIHRoYXQgYWxzbyBhcmUgbm90IGluc2lkZSBhIGZvcm0KCQkJZ3JvdXAgPSAkKCBuYW1lU2VsZWN0b3IgKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5mb3JtKCkubGVuZ3RoID09PSAwOwoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gZ3JvdXAubm90KCB0aGlzLmVsZW1lbnQgKTsKCX0sCgoJX3RvZ2dsZUNsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBjaGVja2VkID0gdGhpcy5lbGVtZW50WyAwIF0uY2hlY2tlZDsKCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy5sYWJlbCwgInVpLWNoZWNrYm94cmFkaW8tY2hlY2tlZCIsICJ1aS1zdGF0ZS1hY3RpdmUiLCBjaGVja2VkICk7CgoJCWlmICggdGhpcy5vcHRpb25zLmljb24gJiYgdGhpcy50eXBlID09PSAiY2hlY2tib3giICkgewoJCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy5pY29uLCBudWxsLCAidWktaWNvbi1jaGVjayB1aS1zdGF0ZS1jaGVja2VkIiwgY2hlY2tlZCApCgkJCQkuX3RvZ2dsZUNsYXNzKCB0aGlzLmljb24sIG51bGwsICJ1aS1pY29uLWJsYW5rIiwgIWNoZWNrZWQgKTsKCQl9CgoJCWlmICggdGhpcy50eXBlID09PSAicmFkaW8iICkgewoJCQl0aGlzLl9nZXRSYWRpb0dyb3VwKCkKCQkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgaW5zdGFuY2UgPSAkKCB0aGlzICkuY2hlY2tib3hyYWRpbyggImluc3RhbmNlIiApOwoKCQkJCQlpZiAoIGluc3RhbmNlICkgewoJCQkJCQlpbnN0YW5jZS5fcmVtb3ZlQ2xhc3MoIGluc3RhbmNlLmxhYmVsLAoJCQkJCQkJInVpLWNoZWNrYm94cmFkaW8tY2hlY2tlZCIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQkJfQoJCQkJfSApOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3VuYmluZEZvcm1SZXNldEhhbmRsZXIoKTsKCgkJaWYgKCB0aGlzLmljb24gKSB7CgkJCXRoaXMuaWNvbi5yZW1vdmUoKTsKCQkJdGhpcy5pY29uU3BhY2UucmVtb3ZlKCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCgkJLy8gV2UgZG9uJ3QgYWxsb3cgdGhlIHZhbHVlIHRvIGJlIHNldCB0byBub3RoaW5nCgkJaWYgKCBrZXkgPT09ICJsYWJlbCIgJiYgIXZhbHVlICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy5fdG9nZ2xlQ2xhc3MoIHRoaXMubGFiZWwsIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkID0gdmFsdWU7CgoJCQkvLyBEb24ndCByZWZyZXNoIHdoZW4gc2V0dGluZyBkaXNhYmxlZAoJCQlyZXR1cm47CgkJfQoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfdXBkYXRlSWNvbjogZnVuY3Rpb24oIGNoZWNrZWQgKSB7CgkJdmFyIHRvQWRkID0gInVpLWljb24gdWktaWNvbi1iYWNrZ3JvdW5kICI7CgoJCWlmICggdGhpcy5vcHRpb25zLmljb24gKSB7CgkJCWlmICggIXRoaXMuaWNvbiApIHsKCQkJCXRoaXMuaWNvbiA9ICQoICI8c3Bhbj4iICk7CgkJCQl0aGlzLmljb25TcGFjZSA9ICQoICI8c3Bhbj4gPC9zcGFuPiIgKTsKCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmljb25TcGFjZSwgInVpLWNoZWNrYm94cmFkaW8taWNvbi1zcGFjZSIgKTsKCQkJfQoKCQkJaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCQl0b0FkZCArPSBjaGVja2VkID8gInVpLWljb24tY2hlY2sgdWktc3RhdGUtY2hlY2tlZCIgOiAidWktaWNvbi1ibGFuayI7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5pY29uLCBudWxsLCBjaGVja2VkID8gInVpLWljb24tYmxhbmsiIDogInVpLWljb24tY2hlY2siICk7CgkJCX0gZWxzZSB7CgkJCQl0b0FkZCArPSAidWktaWNvbi1ibGFuayI7CgkJCX0KCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaWNvbiwgInVpLWNoZWNrYm94cmFkaW8taWNvbiIsIHRvQWRkICk7CgkJCWlmICggIWNoZWNrZWQgKSB7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5pY29uLCBudWxsLCAidWktaWNvbi1jaGVjayB1aS1zdGF0ZS1jaGVja2VkIiApOwoJCQl9CgkJCXRoaXMuaWNvbi5wcmVwZW5kVG8oIHRoaXMubGFiZWwgKS5hZnRlciggdGhpcy5pY29uU3BhY2UgKTsKCQl9IGVsc2UgaWYgKCB0aGlzLmljb24gIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5pY29uLnJlbW92ZSgpOwoJCQl0aGlzLmljb25TcGFjZS5yZW1vdmUoKTsKCQkJZGVsZXRlIHRoaXMuaWNvbjsKCQl9Cgl9LAoKCV91cGRhdGVMYWJlbDogZnVuY3Rpb24oKSB7CgoJCS8vIFJlbW92ZSB0aGUgY29udGVudHMgb2YgdGhlIGxhYmVsICggbWludXMgdGhlIGljb24sIGljb24gc3BhY2UsIGFuZCBpbnB1dCApCgkJdmFyIGNvbnRlbnRzID0gdGhpcy5sYWJlbC5jb250ZW50cygpLm5vdCggdGhpcy5lbGVtZW50WyAwIF0gKTsKCQlpZiAoIHRoaXMuaWNvbiApIHsKCQkJY29udGVudHMgPSBjb250ZW50cy5ub3QoIHRoaXMuaWNvblsgMCBdICk7CgkJfQoJCWlmICggdGhpcy5pY29uU3BhY2UgKSB7CgkJCWNvbnRlbnRzID0gY29udGVudHMubm90KCB0aGlzLmljb25TcGFjZVsgMCBdICk7CgkJfQoJCWNvbnRlbnRzLnJlbW92ZSgpOwoKCQl0aGlzLmxhYmVsLmFwcGVuZCggdGhpcy5vcHRpb25zLmxhYmVsICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBjaGVja2VkID0gdGhpcy5lbGVtZW50WyAwIF0uY2hlY2tlZCwKCQkJaXNEaXNhYmxlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkOwoKCQl0aGlzLl91cGRhdGVJY29uKCBjaGVja2VkICk7CgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIHRoaXMubGFiZWwsICJ1aS1jaGVja2JveHJhZGlvLWNoZWNrZWQiLCAidWktc3RhdGUtYWN0aXZlIiwgY2hlY2tlZCApOwoJCWlmICggdGhpcy5vcHRpb25zLmxhYmVsICE9PSBudWxsICkgewoJCQl0aGlzLl91cGRhdGVMYWJlbCgpOwoJCX0KCgkJaWYgKCBpc0Rpc2FibGVkICE9PSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHsgImRpc2FibGVkIjogaXNEaXNhYmxlZCB9ICk7CgkJfQoJfQoKfSBdICk7Cgp2YXIgd2lkZ2V0c0NoZWNrYm94cmFkaW8gPSAkLnVpLmNoZWNrYm94cmFkaW87CgoKLyohCiAqIGpRdWVyeSBVSSBCdXR0b24gMS4xMi4xCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqLwoKLy8+PmxhYmVsOiBCdXR0b24KLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogRW5oYW5jZXMgYSBmb3JtIHdpdGggdGhlbWVhYmxlIGJ1dHRvbnMuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9idXR0b24vCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9idXR0b24vCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvYnV0dG9uLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKJC53aWRnZXQoICJ1aS5idXR0b24iLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCWRlZmF1bHRFbGVtZW50OiAiPGJ1dHRvbj4iLAoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJInVpLWJ1dHRvbiI6ICJ1aS1jb3JuZXItYWxsIgoJCX0sCgkJZGlzYWJsZWQ6IG51bGwsCgkJaWNvbjogbnVsbCwKCQlpY29uUG9zaXRpb246ICJiZWdpbm5pbmciLAoJCWxhYmVsOiBudWxsLAoJCXNob3dMYWJlbDogdHJ1ZQoJfSwKCglfZ2V0Q3JlYXRlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJdmFyIGRpc2FibGVkLAoKCQkJLy8gVGhpcyBpcyB0byBzdXBwb3J0IGNhc2VzIGxpa2UgaW4galF1ZXJ5IE1vYmlsZSB3aGVyZSB0aGUgYmFzZSB3aWRnZXQgZG9lcyBoYXZlCgkJCS8vIGFuIGltcGxlbWVudGF0aW9uIG9mIF9nZXRDcmVhdGVPcHRpb25zCgkJCW9wdGlvbnMgPSB0aGlzLl9zdXBlcigpIHx8IHt9OwoKCQl0aGlzLmlzSW5wdXQgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKTsKCgkJZGlzYWJsZWQgPSB0aGlzLmVsZW1lbnRbIDAgXS5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkICE9IG51bGwgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSBkaXNhYmxlZDsKCQl9CgoJCXRoaXMub3JpZ2luYWxMYWJlbCA9IHRoaXMuaXNJbnB1dCA\/IHRoaXMuZWxlbWVudC52YWwoKSA6IHRoaXMuZWxlbWVudC5odG1sKCk7CgkJaWYgKCB0aGlzLm9yaWdpbmFsTGFiZWwgKSB7CgkJCW9wdGlvbnMubGFiZWwgPSB0aGlzLm9yaWdpbmFsTGFiZWw7CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5vcHRpb24uc2hvd0xhYmVsICYgIXRoaXMub3B0aW9ucy5pY29uICkgewoJCQl0aGlzLm9wdGlvbnMuc2hvd0xhYmVsID0gdHJ1ZTsKCQl9CgoJCS8vIFdlIGhhdmUgdG8gY2hlY2sgdGhlIG9wdGlvbiBhZ2FpbiBoZXJlIGV2ZW4gdGhvdWdoIHdlIGRpZCBpbiBfZ2V0Q3JlYXRlT3B0aW9ucywKCQkvLyBiZWNhdXNlIG51bGwgbWF5IGhhdmUgYmVlbiBwYXNzZWQgb24gaW5pdCB3aGljaCB3b3VsZCBvdmVycmlkZSB3aGF0IHdhcyBzZXQgaW4KCQkvLyBfZ2V0Q3JlYXRlT3B0aW9ucwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkID09IG51bGwgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkIHx8IGZhbHNlOwoJCX0KCgkJdGhpcy5oYXNUaXRsZSA9ICEhdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKTsKCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBsYWJlbCBuZWVkcyB0byBiZSBzZXQgb3IgaWYgaXRzIGFscmVhZHkgY29ycmVjdAoJCWlmICggdGhpcy5vcHRpb25zLmxhYmVsICYmIHRoaXMub3B0aW9ucy5sYWJlbCAhPT0gdGhpcy5vcmlnaW5hbExhYmVsICkgewoJCQlpZiAoIHRoaXMuaXNJbnB1dCApIHsKCQkJCXRoaXMuZWxlbWVudC52YWwoIHRoaXMub3B0aW9ucy5sYWJlbCApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIHRoaXMub3B0aW9ucy5sYWJlbCApOwoJCQl9CgkJfQoJCXRoaXMuX2FkZENsYXNzKCAidWktYnV0dG9uIiwgInVpLXdpZGdldCIgKTsKCQl0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApOwoJCXRoaXMuX2VuaGFuY2UoKTsKCgkJaWYgKCB0aGlzLmVsZW1lbnQuaXMoICJhIiApICkgewoJCQl0aGlzLl9vbiggewoJCQkJImtleXVwIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlNQQUNFICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQkJLy8gU3VwcG9ydDogUGhhbnRvbUpTIDw9IDEuOSwgSUUgOCBPbmx5CgkJCQkJCS8vIElmIGEgbmF0aXZlIGNsaWNrIGlzIGF2YWlsYWJsZSB1c2UgaXQgc28gd2UgYWN0dWFsbHkgY2F1c2UgbmF2aWdhdGlvbgoJCQkJCQkvLyBvdGhlcndpc2UganVzdCB0cmlnZ2VyIGEgY2xpY2sgZXZlbnQKCQkJCQkJaWYgKCB0aGlzLmVsZW1lbnRbIDAgXS5jbGljayApIHsKCQkJCQkJCXRoaXMuZWxlbWVudFsgMCBdLmNsaWNrKCk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNsaWNrIiApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9ICk7CgkJfQoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJaWYgKCAhdGhpcy5lbGVtZW50LmlzKCAiYnV0dG9uIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCAiYnV0dG9uIiApOwoJCX0KCgkJaWYgKCB0aGlzLm9wdGlvbnMuaWNvbiApIHsKCQkJdGhpcy5fdXBkYXRlSWNvbiggImljb24iLCB0aGlzLm9wdGlvbnMuaWNvbiApOwoJCQl0aGlzLl91cGRhdGVUb29sdGlwKCk7CgkJfQoJfSwKCglfdXBkYXRlVG9vbHRpcDogZnVuY3Rpb24oKSB7CgkJdGhpcy50aXRsZSA9IHRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiICk7CgoJCWlmICggIXRoaXMub3B0aW9ucy5zaG93TGFiZWwgJiYgIXRoaXMudGl0bGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGl0bGUiLCB0aGlzLm9wdGlvbnMubGFiZWwgKTsKCQl9Cgl9LAoKCV91cGRhdGVJY29uOiBmdW5jdGlvbiggb3B0aW9uLCB2YWx1ZSApIHsKCQl2YXIgaWNvbiA9IG9wdGlvbiAhPT0gImljb25Qb3NpdGlvbiIsCgkJCXBvc2l0aW9uID0gaWNvbiA\/IHRoaXMub3B0aW9ucy5pY29uUG9zaXRpb24gOiB2YWx1ZSwKCQkJZGlzcGxheUJsb2NrID0gcG9zaXRpb24gPT09ICJ0b3AiIHx8IHBvc2l0aW9uID09PSAiYm90dG9tIjsKCgkJLy8gQ3JlYXRlIGljb24KCQlpZiAoICF0aGlzLmljb24gKSB7CgkJCXRoaXMuaWNvbiA9ICQoICI8c3Bhbj4iICk7CgoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uLCAidWktYnV0dG9uLWljb24iLCAidWktaWNvbiIgKTsKCgkJCWlmICggIXRoaXMub3B0aW9ucy5zaG93TGFiZWwgKSB7CgkJCQl0aGlzLl9hZGRDbGFzcyggInVpLWJ1dHRvbi1pY29uLW9ubHkiICk7CgkJCX0KCQl9IGVsc2UgaWYgKCBpY29uICkgewoKCQkJLy8gSWYgd2UgYXJlIHVwZGF0aW5nIHRoZSBpY29uIHJlbW92ZSB0aGUgb2xkIGljb24gY2xhc3MKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuaWNvbiwgbnVsbCwgdGhpcy5vcHRpb25zLmljb24gKTsKCQl9CgoJCS8vIElmIHdlIGFyZSB1cGRhdGluZyB0aGUgaWNvbiBhZGQgdGhlIG5ldyBpY29uIGNsYXNzCgkJaWYgKCBpY29uICkgewoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uLCBudWxsLCB2YWx1ZSApOwoJCX0KCgkJdGhpcy5fYXR0YWNoSWNvbiggcG9zaXRpb24gKTsKCgkJLy8gSWYgdGhlIGljb24gaXMgb24gdG9wIG9yIGJvdHRvbSB3ZSBuZWVkIHRvIGFkZCB0aGUgdWktd2lkZ2V0LWljb24tYmxvY2sgY2xhc3MgYW5kIHJlbW92ZQoJCS8vIHRoZSBpY29uU3BhY2UgaWYgdGhlcmUgaXMgb25lLgoJCWlmICggZGlzcGxheUJsb2NrICkgewoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5pY29uLCBudWxsLCAidWktd2lkZ2V0LWljb24tYmxvY2siICk7CgkJCWlmICggdGhpcy5pY29uU3BhY2UgKSB7CgkJCQl0aGlzLmljb25TcGFjZS5yZW1vdmUoKTsKCQkJfQoJCX0gZWxzZSB7CgoJCQkvLyBQb3NpdGlvbiBpcyBiZWdpbm5pbmcgb3IgZW5kIHNvIHJlbW92ZSB0aGUgdWktd2lkZ2V0LWljb24tYmxvY2sgY2xhc3MgYW5kIGFkZCB0aGUKCQkJLy8gc3BhY2UgaWYgaXQgZG9lcyBub3QgZXhpc3QKCQkJaWYgKCAhdGhpcy5pY29uU3BhY2UgKSB7CgkJCQl0aGlzLmljb25TcGFjZSA9ICQoICI8c3Bhbj4gPC9zcGFuPiIgKTsKCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmljb25TcGFjZSwgInVpLWJ1dHRvbi1pY29uLXNwYWNlIiApOwoJCQl9CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmljb24sIG51bGwsICJ1aS13aWdldC1pY29uLWJsb2NrIiApOwoJCQl0aGlzLl9hdHRhY2hJY29uU3BhY2UoIHBvc2l0aW9uICk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQlpZiAoIHRoaXMuaWNvbiApIHsKCQkJdGhpcy5pY29uLnJlbW92ZSgpOwoJCX0KCQlpZiAoIHRoaXMuaWNvblNwYWNlICkgewoJCQl0aGlzLmljb25TcGFjZS5yZW1vdmUoKTsKCQl9CgkJaWYgKCAhdGhpcy5oYXNUaXRsZSApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsKCQl9Cgl9LAoKCV9hdHRhY2hJY29uU3BhY2U6IGZ1bmN0aW9uKCBpY29uUG9zaXRpb24gKSB7CgkJdGhpcy5pY29uWyAvXig\/OmVuZHxib3R0b20pLy50ZXN0KCBpY29uUG9zaXRpb24gKSA\/ICJiZWZvcmUiIDogImFmdGVyIiBdKCB0aGlzLmljb25TcGFjZSApOwoJfSwKCglfYXR0YWNoSWNvbjogZnVuY3Rpb24oIGljb25Qb3NpdGlvbiApIHsKCQl0aGlzLmVsZW1lbnRbIC9eKD86ZW5kfGJvdHRvbSkvLnRlc3QoIGljb25Qb3NpdGlvbiApID8gImFwcGVuZCIgOiAicHJlcGVuZCIgXSggdGhpcy5pY29uICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgbmV3U2hvd0xhYmVsID0gb3B0aW9ucy5zaG93TGFiZWwgPT09IHVuZGVmaW5lZCA\/CgkJCQl0aGlzLm9wdGlvbnMuc2hvd0xhYmVsIDoKCQkJCW9wdGlvbnMuc2hvd0xhYmVsLAoJCQluZXdJY29uID0gb3B0aW9ucy5pY29uID09PSB1bmRlZmluZWQgPyB0aGlzLm9wdGlvbnMuaWNvbiA6IG9wdGlvbnMuaWNvbjsKCgkJaWYgKCAhbmV3U2hvd0xhYmVsICYmICFuZXdJY29uICkgewoJCQlvcHRpb25zLnNob3dMYWJlbCA9IHRydWU7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCWlmICgga2V5ID09PSAiaWNvbiIgKSB7CgkJCWlmICggdmFsdWUgKSB7CgkJCQl0aGlzLl91cGRhdGVJY29uKCBrZXksIHZhbHVlICk7CgkJCX0gZWxzZSBpZiAoIHRoaXMuaWNvbiApIHsKCQkJCXRoaXMuaWNvbi5yZW1vdmUoKTsKCQkJCWlmICggdGhpcy5pY29uU3BhY2UgKSB7CgkJCQkJdGhpcy5pY29uU3BhY2UucmVtb3ZlKCk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICgga2V5ID09PSAiaWNvblBvc2l0aW9uIiApIHsKCQkJdGhpcy5fdXBkYXRlSWNvbigga2V5LCB2YWx1ZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGNhbid0IGVuZCB1cCB3aXRoIGEgYnV0dG9uIHRoYXQgaGFzIG5laXRoZXIgdGV4dCBub3IgaWNvbgoJCWlmICgga2V5ID09PSAic2hvd0xhYmVsIiApIHsKCQkJCXRoaXMuX3RvZ2dsZUNsYXNzKCAidWktYnV0dG9uLWljb24tb25seSIsIG51bGwsICF2YWx1ZSApOwoJCQkJdGhpcy5fdXBkYXRlVG9vbHRpcCgpOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJsYWJlbCIgKSB7CgkJCWlmICggdGhpcy5pc0lucHV0ICkgewoJCQkJdGhpcy5lbGVtZW50LnZhbCggdmFsdWUgKTsKCQkJfSBlbHNlIHsKCgkJCQkvLyBJZiB0aGVyZSBpcyBhbiBpY29uLCBhcHBlbmQgaXQsIGVsc2Ugbm90aGluZyB0aGVuIGFwcGVuZCB0aGUgdmFsdWUKCQkJCS8vIHRoaXMgYXZvaWRzIHJlbW92YWwgb2YgdGhlIGljb24gd2hlbiBzZXR0aW5nIGxhYmVsIHRleHQKCQkJCXRoaXMuZWxlbWVudC5odG1sKCB2YWx1ZSApOwoJCQkJaWYgKCB0aGlzLmljb24gKSB7CgkJCQkJdGhpcy5fYXR0YWNoSWNvbiggdGhpcy5vcHRpb25zLmljb25Qb3NpdGlvbiApOwoJCQkJCXRoaXMuX2F0dGFjaEljb25TcGFjZSggdGhpcy5vcHRpb25zLmljb25Qb3NpdGlvbiApOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy5fdG9nZ2xlQ2xhc3MoIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuZWxlbWVudFsgMCBdLmRpc2FibGVkID0gdmFsdWU7CgkJCWlmICggdmFsdWUgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCQl9CgkJfQoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCgkJLy8gTWFrZSBzdXJlIHRvIG9ubHkgY2hlY2sgZGlzYWJsZWQgaWYgaXRzIGFuIGVsZW1lbnQgdGhhdCBzdXBwb3J0cyB0aGlzIG90aGVyd2lzZQoJCS8vIGNoZWNrIGZvciB0aGUgZGlzYWJsZWQgY2xhc3MgdG8gZGV0ZXJtaW5lIHN0YXRlCgkJdmFyIGlzRGlzYWJsZWQgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCwgYnV0dG9uIiApID8KCQkJdGhpcy5lbGVtZW50WyAwIF0uZGlzYWJsZWQgOiB0aGlzLmVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1idXR0b24tZGlzYWJsZWQiICk7CgoJCWlmICggaXNEaXNhYmxlZCAhPT0gdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQl0aGlzLl9zZXRPcHRpb25zKCB7IGRpc2FibGVkOiBpc0Rpc2FibGVkIH0gKTsKCQl9CgoJCXRoaXMuX3VwZGF0ZVRvb2x0aXAoKTsKCX0KfSApOwoKLy8gREVQUkVDQVRFRAppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCgkvLyBUZXh0IGFuZCBJY29ucyBvcHRpb25zCgkkLndpZGdldCggInVpLmJ1dHRvbiIsICQudWkuYnV0dG9uLCB7CgkJb3B0aW9uczogewoJCQl0ZXh0OiB0cnVlLAoJCQlpY29uczogewoJCQkJcHJpbWFyeTogbnVsbCwKCQkJCXNlY29uZGFyeTogbnVsbAoJCQl9CgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLnNob3dMYWJlbCAmJiAhdGhpcy5vcHRpb25zLnRleHQgKSB7CgkJCQl0aGlzLm9wdGlvbnMuc2hvd0xhYmVsID0gdGhpcy5vcHRpb25zLnRleHQ7CgkJCX0KCQkJaWYgKCAhdGhpcy5vcHRpb25zLnNob3dMYWJlbCAmJiB0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCXRoaXMub3B0aW9ucy50ZXh0ID0gdGhpcy5vcHRpb25zLnNob3dMYWJlbDsKCQkJfQoJCQlpZiAoICF0aGlzLm9wdGlvbnMuaWNvbiAmJiAoIHRoaXMub3B0aW9ucy5pY29ucy5wcmltYXJ5IHx8CgkJCQkJdGhpcy5vcHRpb25zLmljb25zLnNlY29uZGFyeSApICkgewoJCQkJaWYgKCB0aGlzLm9wdGlvbnMuaWNvbnMucHJpbWFyeSApIHsKCQkJCQl0aGlzLm9wdGlvbnMuaWNvbiA9IHRoaXMub3B0aW9ucy5pY29ucy5wcmltYXJ5OwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLm9wdGlvbnMuaWNvbiA9IHRoaXMub3B0aW9ucy5pY29ucy5zZWNvbmRhcnk7CgkJCQkJdGhpcy5vcHRpb25zLmljb25Qb3NpdGlvbiA9ICJlbmQiOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCB0aGlzLm9wdGlvbnMuaWNvbiApIHsKCQkJCXRoaXMub3B0aW9ucy5pY29ucy5wcmltYXJ5ID0gdGhpcy5vcHRpb25zLmljb247CgkJCX0KCQkJdGhpcy5fc3VwZXIoKTsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJaWYgKCBrZXkgPT09ICJ0ZXh0IiApIHsKCQkJCXRoaXMuX3N1cGVyKCAic2hvd0xhYmVsIiwgdmFsdWUgKTsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIGtleSA9PT0gInNob3dMYWJlbCIgKSB7CgkJCQl0aGlzLm9wdGlvbnMudGV4dCA9IHZhbHVlOwoJCQl9CgkJCWlmICgga2V5ID09PSAiaWNvbiIgKSB7CgkJCQl0aGlzLm9wdGlvbnMuaWNvbnMucHJpbWFyeSA9IHZhbHVlOwoJCQl9CgkJCWlmICgga2V5ID09PSAiaWNvbnMiICkgewoJCQkJaWYgKCB2YWx1ZS5wcmltYXJ5ICkgewoJCQkJCXRoaXMuX3N1cGVyKCAiaWNvbiIsIHZhbHVlLnByaW1hcnkgKTsKCQkJCQl0aGlzLl9zdXBlciggImljb25Qb3NpdGlvbiIsICJiZWdpbm5pbmciICk7CgkJCQl9IGVsc2UgaWYgKCB2YWx1ZS5zZWNvbmRhcnkgKSB7CgkJCQkJdGhpcy5fc3VwZXIoICJpY29uIiwgdmFsdWUuc2Vjb25kYXJ5ICk7CgkJCQkJdGhpcy5fc3VwZXIoICJpY29uUG9zaXRpb24iLCAiZW5kIiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoJCX0KCX0gKTsKCgkkLmZuLmJ1dHRvbiA9ICggZnVuY3Rpb24oIG9yaWcgKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLmxlbmd0aCB8fCAoIHRoaXMubGVuZ3RoICYmIHRoaXNbIDAgXS50YWdOYW1lICE9PSAiSU5QVVQiICkgfHwKCQkJCQkoIHRoaXMubGVuZ3RoICYmIHRoaXNbIDAgXS50YWdOYW1lID09PSAiSU5QVVQiICYmICgKCQkJCQkJdGhpcy5hdHRyKCAidHlwZSIgKSAhPT0gImNoZWNrYm94IiAmJiB0aGlzLmF0dHIoICJ0eXBlIiApICE9PSAicmFkaW8iCgkJCQkJKSApICkgewoJCQkJcmV0dXJuIG9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9CgkJCWlmICggISQudWkuY2hlY2tib3hyYWRpbyApIHsKCQkJCSQuZXJyb3IoICJDaGVja2JveHJhZGlvIHdpZGdldCBtaXNzaW5nIiApOwoJCQl9CgkJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXJldHVybiB0aGlzLmNoZWNrYm94cmFkaW8oIHsKCQkJCQkiaWNvbiI6IGZhbHNlCgkJCQl9ICk7CgkJCX0KCQkJcmV0dXJuIHRoaXMuY2hlY2tib3hyYWRpby5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJfTsKCX0gKSggJC5mbi5idXR0b24gKTsKCgkkLmZuLmJ1dHRvbnNldCA9IGZ1bmN0aW9uKCkgewoJCWlmICggISQudWkuY29udHJvbGdyb3VwICkgewoJCQkkLmVycm9yKCAiQ29udHJvbGdyb3VwIHdpZGdldCBtaXNzaW5nIiApOwoJCX0KCQlpZiAoIGFyZ3VtZW50c1sgMCBdID09PSAib3B0aW9uIiAmJiBhcmd1bWVudHNbIDEgXSA9PT0gIml0ZW1zIiAmJiBhcmd1bWVudHNbIDIgXSApIHsKCQkJcmV0dXJuIHRoaXMuY29udHJvbGdyb3VwLmFwcGx5KCB0aGlzLAoJCQkJWyBhcmd1bWVudHNbIDAgXSwgIml0ZW1zLmJ1dHRvbiIsIGFyZ3VtZW50c1sgMiBdIF0gKTsKCQl9CgkJaWYgKCBhcmd1bWVudHNbIDAgXSA9PT0gIm9wdGlvbiIgJiYgYXJndW1lbnRzWyAxIF0gPT09ICJpdGVtcyIgKSB7CgkJCXJldHVybiB0aGlzLmNvbnRyb2xncm91cC5hcHBseSggdGhpcywgWyBhcmd1bWVudHNbIDAgXSwgIml0ZW1zLmJ1dHRvbiIgXSApOwoJCX0KCQlpZiAoIHR5cGVvZiBhcmd1bWVudHNbIDAgXSA9PT0gIm9iamVjdCIgJiYgYXJndW1lbnRzWyAwIF0uaXRlbXMgKSB7CgkJCWFyZ3VtZW50c1sgMCBdLml0ZW1zID0gewoJCQkJYnV0dG9uOiBhcmd1bWVudHNbIDAgXS5pdGVtcwoJCQl9OwoJCX0KCQlyZXR1cm4gdGhpcy5jb250cm9sZ3JvdXAuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfTsKfQoKdmFyIHdpZGdldHNCdXR0b24gPSAkLnVpLmJ1dHRvbjsKCgovLyBqc2NzOmRpc2FibGUgbWF4aW11bUxpbmVMZW5ndGgKLyoganNjczpkaXNhYmxlIHJlcXVpcmVDYW1lbENhc2VPclVwcGVyQ2FzZUlkZW50aWZpZXJzICovCi8qIQogKiBqUXVlcnkgVUkgRGF0ZXBpY2tlciAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IERhdGVwaWNrZXIKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogRGlzcGxheXMgYSBjYWxlbmRhciBmcm9tIGFuIGlucHV0IG9yIGlubGluZSBmb3Igc2VsZWN0aW5nIGRhdGVzLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vZGF0ZXBpY2tlci8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2RhdGVwaWNrZXIvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvZGF0ZXBpY2tlci5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCiQuZXh0ZW5kKCAkLnVpLCB7IGRhdGVwaWNrZXI6IHsgdmVyc2lvbjogIjEuMTIuMSIgfSB9ICk7Cgp2YXIgZGF0ZXBpY2tlcl9pbnN0QWN0aXZlOwoKZnVuY3Rpb24gZGF0ZXBpY2tlcl9nZXRaaW5kZXgoIGVsZW0gKSB7Cgl2YXIgcG9zaXRpb24sIHZhbHVlOwoJd2hpbGUgKCBlbGVtLmxlbmd0aCAmJiBlbGVtWyAwIF0gIT09IGRvY3VtZW50ICkgewoKCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkvLyBUaGlzIG1ha2VzIGJlaGF2aW9yIG9mIHRoaXMgZnVuY3Rpb24gY29uc2lzdGVudCBhY3Jvc3MgYnJvd3NlcnMKCQkvLyBXZWJLaXQgYWx3YXlzIHJldHVybnMgYXV0byBpZiB0aGUgZWxlbWVudCBpcyBwb3NpdGlvbmVkCgkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJyZWxhdGl2ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgoJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkvLyBvdGhlciBicm93c2VycyByZXR1cm4gYSBzdHJpbmcKCQkJLy8gd2UgaWdub3JlIHRoZSBjYXNlIG9mIG5lc3RlZCBlbGVtZW50cyB3aXRoIGFuIGV4cGxpY2l0IHZhbHVlIG9mIDAKCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQl2YWx1ZSA9IHBhcnNlSW50KCBlbGVtLmNzcyggInpJbmRleCIgKSwgMTAgKTsKCQkJaWYgKCAhaXNOYU4oIHZhbHVlICkgJiYgdmFsdWUgIT09IDAgKSB7CgkJCQlyZXR1cm4gdmFsdWU7CgkJCX0KCQl9CgkJZWxlbSA9IGVsZW0ucGFyZW50KCk7Cgl9CgoJcmV0dXJuIDA7Cn0KLyogRGF0ZSBwaWNrZXIgbWFuYWdlci4KICAgVXNlIHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcywgJC5kYXRlcGlja2VyLCB0byBpbnRlcmFjdCB3aXRoIHRoZSBkYXRlIHBpY2tlci4KICAgU2V0dGluZ3MgZm9yIChncm91cHMgb2YpIGRhdGUgcGlja2VycyBhcmUgbWFpbnRhaW5lZCBpbiBhbiBpbnN0YW5jZSBvYmplY3QsCiAgIGFsbG93aW5nIG11bHRpcGxlIGRpZmZlcmVudCBzZXR0aW5ncyBvbiB0aGUgc2FtZSBwYWdlLiAqLwoKZnVuY3Rpb24gRGF0ZXBpY2tlcigpIHsKCXRoaXMuX2N1ckluc3QgPSBudWxsOyAvLyBUaGUgY3VycmVudCBpbnN0YW5jZSBpbiB1c2UKCXRoaXMuX2tleUV2ZW50ID0gZmFsc2U7IC8vIElmIHRoZSBsYXN0IGV2ZW50IHdhcyBhIGtleSBldmVudAoJdGhpcy5fZGlzYWJsZWRJbnB1dHMgPSBbXTsgLy8gTGlzdCBvZiBkYXRlIHBpY2tlciBpbnB1dHMgdGhhdCBoYXZlIGJlZW4gZGlzYWJsZWQKCXRoaXMuX2RhdGVwaWNrZXJTaG93aW5nID0gZmFsc2U7IC8vIFRydWUgaWYgdGhlIHBvcHVwIHBpY2tlciBpcyBzaG93aW5nICwgZmFsc2UgaWYgbm90Cgl0aGlzLl9pbkRpYWxvZyA9IGZhbHNlOyAvLyBUcnVlIGlmIHNob3dpbmcgd2l0aGluIGEgImRpYWxvZyIsIGZhbHNlIGlmIG5vdAoJdGhpcy5fbWFpbkRpdklkID0gInVpLWRhdGVwaWNrZXItZGl2IjsgLy8gVGhlIElEIG9mIHRoZSBtYWluIGRhdGVwaWNrZXIgZGl2aXNpb24KCXRoaXMuX2lubGluZUNsYXNzID0gInVpLWRhdGVwaWNrZXItaW5saW5lIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGlubGluZSBtYXJrZXIgY2xhc3MKCXRoaXMuX2FwcGVuZENsYXNzID0gInVpLWRhdGVwaWNrZXItYXBwZW5kIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGFwcGVuZCBtYXJrZXIgY2xhc3MKCXRoaXMuX3RyaWdnZXJDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLXRyaWdnZXIiOyAvLyBUaGUgbmFtZSBvZiB0aGUgdHJpZ2dlciBtYXJrZXIgY2xhc3MKCXRoaXMuX2RpYWxvZ0NsYXNzID0gInVpLWRhdGVwaWNrZXItZGlhbG9nIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGRpYWxvZyBtYXJrZXIgY2xhc3MKCXRoaXMuX2Rpc2FibGVDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWRpc2FibGVkIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGRpc2FibGVkIGNvdmVyaW5nIG1hcmtlciBjbGFzcwoJdGhpcy5fdW5zZWxlY3RhYmxlQ2xhc3MgPSAidWktZGF0ZXBpY2tlci11bnNlbGVjdGFibGUiOyAvLyBUaGUgbmFtZSBvZiB0aGUgdW5zZWxlY3RhYmxlIGNlbGwgbWFya2VyIGNsYXNzCgl0aGlzLl9jdXJyZW50Q2xhc3MgPSAidWktZGF0ZXBpY2tlci1jdXJyZW50LWRheSI7IC8vIFRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IGRheSBtYXJrZXIgY2xhc3MKCXRoaXMuX2RheU92ZXJDbGFzcyA9ICJ1aS1kYXRlcGlja2VyLWRheXMtY2VsbC1vdmVyIjsgLy8gVGhlIG5hbWUgb2YgdGhlIGRheSBob3ZlciBtYXJrZXIgY2xhc3MKCXRoaXMucmVnaW9uYWwgPSBbXTsgLy8gQXZhaWxhYmxlIHJlZ2lvbmFsIHNldHRpbmdzLCBpbmRleGVkIGJ5IGxhbmd1YWdlIGNvZGUKCXRoaXMucmVnaW9uYWxbICIiIF0gPSB7IC8vIERlZmF1bHQgcmVnaW9uYWwgc2V0dGluZ3MKCQljbG9zZVRleHQ6ICJEb25lIiwgLy8gRGlzcGxheSB0ZXh0IGZvciBjbG9zZSBsaW5rCgkJcHJldlRleHQ6ICJQcmV2IiwgLy8gRGlzcGxheSB0ZXh0IGZvciBwcmV2aW91cyBtb250aCBsaW5rCgkJbmV4dFRleHQ6ICJOZXh0IiwgLy8gRGlzcGxheSB0ZXh0IGZvciBuZXh0IG1vbnRoIGxpbmsKCQljdXJyZW50VGV4dDogIlRvZGF5IiwgLy8gRGlzcGxheSB0ZXh0IGZvciBjdXJyZW50IG1vbnRoIGxpbmsKCQltb250aE5hbWVzOiBbICJKYW51YXJ5IiwiRmVicnVhcnkiLCJNYXJjaCIsIkFwcmlsIiwiTWF5IiwiSnVuZSIsCgkJCSJKdWx5IiwiQXVndXN0IiwiU2VwdGVtYmVyIiwiT2N0b2JlciIsIk5vdmVtYmVyIiwiRGVjZW1iZXIiIF0sIC8vIE5hbWVzIG9mIG1vbnRocyBmb3IgZHJvcC1kb3duIGFuZCBmb3JtYXR0aW5nCgkJbW9udGhOYW1lc1Nob3J0OiBbICJKYW4iLCAiRmViIiwgIk1hciIsICJBcHIiLCAiTWF5IiwgIkp1biIsICJKdWwiLCAiQXVnIiwgIlNlcCIsICJPY3QiLCAiTm92IiwgIkRlYyIgXSwgLy8gRm9yIGZvcm1hdHRpbmcKCQlkYXlOYW1lczogWyAiU3VuZGF5IiwgIk1vbmRheSIsICJUdWVzZGF5IiwgIldlZG5lc2RheSIsICJUaHVyc2RheSIsICJGcmlkYXkiLCAiU2F0dXJkYXkiIF0sIC8vIEZvciBmb3JtYXR0aW5nCgkJZGF5TmFtZXNTaG9ydDogWyAiU3VuIiwgIk1vbiIsICJUdWUiLCAiV2VkIiwgIlRodSIsICJGcmkiLCAiU2F0IiBdLCAvLyBGb3IgZm9ybWF0dGluZwoJCWRheU5hbWVzTWluOiBbICJTdSIsIk1vIiwiVHUiLCJXZSIsIlRoIiwiRnIiLCJTYSIgXSwgLy8gQ29sdW1uIGhlYWRpbmdzIGZvciBkYXlzIHN0YXJ0aW5nIGF0IFN1bmRheQoJCXdlZWtIZWFkZXI6ICJXayIsIC8vIENvbHVtbiBoZWFkZXIgZm9yIHdlZWsgb2YgdGhlIHllYXIKCQlkYXRlRm9ybWF0OiAibW0vZGQveXkiLCAvLyBTZWUgZm9ybWF0IG9wdGlvbnMgb24gcGFyc2VEYXRlCgkJZmlyc3REYXk6IDAsIC8vIFRoZSBmaXJzdCBkYXkgb2YgdGhlIHdlZWssIFN1biA9IDAsIE1vbiA9IDEsIC4uLgoJCWlzUlRMOiBmYWxzZSwgLy8gVHJ1ZSBpZiByaWdodC10by1sZWZ0IGxhbmd1YWdlLCBmYWxzZSBpZiBsZWZ0LXRvLXJpZ2h0CgkJc2hvd01vbnRoQWZ0ZXJZZWFyOiBmYWxzZSwgLy8gVHJ1ZSBpZiB0aGUgeWVhciBzZWxlY3QgcHJlY2VkZXMgbW9udGgsIGZhbHNlIGZvciBtb250aCB0aGVuIHllYXIKCQlUYW1waWxUYWh1bjogdHJ1ZSwgLy8gVHJ1ZSBpZiB0aGUgeWVhciBzZWxlY3QgcHJlY2VkZXMgbW9udGgsIGZhbHNlIGZvciBtb250aCB0aGVuIHllYXIKCQl5ZWFyU3VmZml4OiAiIiAvLyBBZGRpdGlvbmFsIHRleHQgdG8gYXBwZW5kIHRvIHRoZSB5ZWFyIGluIHRoZSBtb250aCBoZWFkZXJzCgl9OwoJdGhpcy5fZGVmYXVsdHMgPSB7IC8vIEdsb2JhbCBkZWZhdWx0cyBmb3IgYWxsIHRoZSBkYXRlIHBpY2tlciBpbnN0YW5jZXMKCQlzaG93T246ICJmb2N1cyIsIC8vICJmb2N1cyIgZm9yIHBvcHVwIG9uIGZvY3VzLAoJCQkvLyAiYnV0dG9uIiBmb3IgdHJpZ2dlciBidXR0b24sIG9yICJib3RoIiBmb3IgZWl0aGVyCgkJc2hvd0FuaW06ICJmYWRlSW4iLCAvLyBOYW1lIG9mIGpRdWVyeSBhbmltYXRpb24gZm9yIHBvcHVwCgkJc2hvd09wdGlvbnM6IHt9LCAvLyBPcHRpb25zIGZvciBlbmhhbmNlZCBhbmltYXRpb25zCgkJZGVmYXVsdERhdGU6IG51bGwsIC8vIFVzZWQgd2hlbiBmaWVsZCBpcyBibGFuazogYWN0dWFsIGRhdGUsCgkJCS8vICsvLW51bWJlciBmb3Igb2Zmc2V0IGZyb20gdG9kYXksIG51bGwgZm9yIHRvZGF5CgkJYXBwZW5kVGV4dDogIiIsIC8vIERpc3BsYXkgdGV4dCBmb2xsb3dpbmcgdGhlIGlucHV0IGJveCwgZS5nLiBzaG93aW5nIHRoZSBmb3JtYXQKCQlidXR0b25UZXh0OiAiLi4uIiwgLy8gVGV4dCBmb3IgdHJpZ2dlciBidXR0b24KCQlidXR0b25JbWFnZTogIiIsIC8vIFVSTCBmb3IgdHJpZ2dlciBidXR0b24gaW1hZ2UKCQlidXR0b25JbWFnZU9ubHk6IGZhbHNlLCAvLyBUcnVlIGlmIHRoZSBpbWFnZSBhcHBlYXJzIGFsb25lLCBmYWxzZSBpZiBpdCBhcHBlYXJzIG9uIGEgYnV0dG9uCgkJaGlkZUlmTm9QcmV2TmV4dDogZmFsc2UsIC8vIFRydWUgdG8gaGlkZSBuZXh0L3ByZXZpb3VzIG1vbnRoIGxpbmtzCgkJCS8vIGlmIG5vdCBhcHBsaWNhYmxlLCBmYWxzZSB0byBqdXN0IGRpc2FibGUgdGhlbQoJCW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQ6IGZhbHNlLCAvLyBUcnVlIGlmIGRhdGUgZm9ybWF0dGluZyBhcHBsaWVkIHRvIHByZXYvdG9kYXkvbmV4dCBsaW5rcwoJCWdvdG9DdXJyZW50OiBmYWxzZSwgLy8gVHJ1ZSBpZiB0b2RheSBsaW5rIGdvZXMgYmFjayB0byBjdXJyZW50IHNlbGVjdGlvbiBpbnN0ZWFkCgkJY2hhbmdlTW9udGg6IGZhbHNlLCAvLyBUcnVlIGlmIG1vbnRoIGNhbiBiZSBzZWxlY3RlZCBkaXJlY3RseSwgZmFsc2UgaWYgb25seSBwcmV2L25leHQKCQljaGFuZ2VZZWFyOiBmYWxzZSwgLy8gVHJ1ZSBpZiB5ZWFyIGNhbiBiZSBzZWxlY3RlZCBkaXJlY3RseSwgZmFsc2UgaWYgb25seSBwcmV2L25leHQKCQl5ZWFyUmFuZ2U6ICJjLTEwOmMrMTAiLCAvLyBSYW5nZSBvZiB5ZWFycyB0byBkaXNwbGF5IGluIGRyb3AtZG93biwKCQkJLy8gZWl0aGVyIHJlbGF0aXZlIHRvIHRvZGF5J3MgeWVhciAoLW5uOitubiksIHJlbGF0aXZlIHRvIGN1cnJlbnRseSBkaXNwbGF5ZWQgeWVhcgoJCQkvLyAoYy1ubjpjK25uKSwgYWJzb2x1dGUgKG5ubm46bm5ubiksIG9yIGEgY29tYmluYXRpb24gb2YgdGhlIGFib3ZlIChubm5uOi1uKQoJCXNob3dPdGhlck1vbnRoczogZmFsc2UsIC8vIFRydWUgdG8gc2hvdyBkYXRlcyBpbiBvdGhlciBtb250aHMsIGZhbHNlIHRvIGxlYXZlIGJsYW5rCgkJc2VsZWN0T3RoZXJNb250aHM6IGZhbHNlLCAvLyBUcnVlIHRvIGFsbG93IHNlbGVjdGlvbiBvZiBkYXRlcyBpbiBvdGhlciBtb250aHMsIGZhbHNlIGZvciB1bnNlbGVjdGFibGUKCQlzaG93V2VlazogZmFsc2UsIC8vIFRydWUgdG8gc2hvdyB3ZWVrIG9mIHRoZSB5ZWFyLCBmYWxzZSB0byBub3Qgc2hvdyBpdAoJCWNhbGN1bGF0ZVdlZWs6IHRoaXMuaXNvODYwMVdlZWssIC8vIEhvdyB0byBjYWxjdWxhdGUgdGhlIHdlZWsgb2YgdGhlIHllYXIsCgkJCS8vIHRha2VzIGEgRGF0ZSBhbmQgcmV0dXJucyB0aGUgbnVtYmVyIG9mIHRoZSB3ZWVrIGZvciBpdAoJCXNob3J0WWVhckN1dG9mZjogIisxMCIsIC8vIFNob3J0IHllYXIgdmFsdWVzIDwgdGhpcyBhcmUgaW4gdGhlIGN1cnJlbnQgY2VudHVyeSwKCQkJLy8gPiB0aGlzIGFyZSBpbiB0aGUgcHJldmlvdXMgY2VudHVyeSwKCQkJLy8gc3RyaW5nIHZhbHVlIHN0YXJ0aW5nIHdpdGggIisiIGZvciBjdXJyZW50IHllYXIgKyB2YWx1ZQoJCW1pbkRhdGU6IG51bGwsIC8vIFRoZSBlYXJsaWVzdCBzZWxlY3RhYmxlIGRhdGUsIG9yIG51bGwgZm9yIG5vIGxpbWl0CgkJbWF4RGF0ZTogbnVsbCwgLy8gVGhlIGxhdGVzdCBzZWxlY3RhYmxlIGRhdGUsIG9yIG51bGwgZm9yIG5vIGxpbWl0CgkJZHVyYXRpb246ICJmYXN0IiwgLy8gRHVyYXRpb24gb2YgZGlzcGxheS9jbG9zdXJlCgkJYmVmb3JlU2hvd0RheTogbnVsbCwgLy8gRnVuY3Rpb24gdGhhdCB0YWtlcyBhIGRhdGUgYW5kIHJldHVybnMgYW4gYXJyYXkgd2l0aAoJCQkvLyBbMF0gPSB0cnVlIGlmIHNlbGVjdGFibGUsIGZhbHNlIGlmIG5vdCwgWzFdID0gY3VzdG9tIENTUyBjbGFzcyBuYW1lKHMpIG9yICIiLAoJCQkvLyBbMl0gPSBjZWxsIHRpdGxlIChvcHRpb25hbCksIGUuZy4gJC5kYXRlcGlja2VyLm5vV2Vla2VuZHMKCQliZWZvcmVTaG93OiBudWxsLCAvLyBGdW5jdGlvbiB0aGF0IHRha2VzIGFuIGlucHV0IGZpZWxkIGFuZAoJCQkvLyByZXR1cm5zIGEgc2V0IG9mIGN1c3RvbSBzZXR0aW5ncyBmb3IgdGhlIGRhdGUgcGlja2VyCgkJb25TZWxlY3Q6IG51bGwsIC8vIERlZmluZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gYSBkYXRlIGlzIHNlbGVjdGVkCgkJb25DaGFuZ2VNb250aFllYXI6IG51bGwsIC8vIERlZmluZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gdGhlIG1vbnRoIG9yIHllYXIgaXMgY2hhbmdlZAoJCW9uQ2xvc2U6IG51bGwsIC8vIERlZmluZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gdGhlIGRhdGVwaWNrZXIgaXMgY2xvc2VkCgkJbnVtYmVyT2ZNb250aHM6IDEsIC8vIE51bWJlciBvZiBtb250aHMgdG8gc2hvdyBhdCBhIHRpbWUKCQlzaG93Q3VycmVudEF0UG9zOiAwLCAvLyBUaGUgcG9zaXRpb24gaW4gbXVsdGlwZSBtb250aHMgYXQgd2hpY2ggdG8gc2hvdyB0aGUgY3VycmVudCBtb250aCAoc3RhcnRpbmcgYXQgMCkKCQlzdGVwTW9udGhzOiAxLCAvLyBOdW1iZXIgb2YgbW9udGhzIHRvIHN0ZXAgYmFjay9mb3J3YXJkCgkJc3RlcEJpZ01vbnRoczogMTIsIC8vIE51bWJlciBvZiBtb250aHMgdG8gc3RlcCBiYWNrL2ZvcndhcmQgZm9yIHRoZSBiaWcgbGlua3MKCQlhbHRGaWVsZDogIiIsIC8vIFNlbGVjdG9yIGZvciBhbiBhbHRlcm5hdGUgZmllbGQgdG8gc3RvcmUgc2VsZWN0ZWQgZGF0ZXMgaW50bwoJCWFsdEZvcm1hdDogIiIsIC8vIFRoZSBkYXRlIGZvcm1hdCB0byB1c2UgZm9yIHRoZSBhbHRlcm5hdGUgZmllbGQKCQljb25zdHJhaW5JbnB1dDogdHJ1ZSwgLy8gVGhlIGlucHV0IGlzIGNvbnN0cmFpbmVkIGJ5IHRoZSBjdXJyZW50IGRhdGUgZm9ybWF0CgkJc2hvd0J1dHRvblBhbmVsOiBmYWxzZSwgLy8gVHJ1ZSB0byBzaG93IGJ1dHRvbiBwYW5lbCwgZmFsc2UgdG8gbm90IHNob3cgaXQKCQlhdXRvU2l6ZTogZmFsc2UsIC8vIFRydWUgdG8gc2l6ZSB0aGUgaW5wdXQgZm9yIHRoZSBkYXRlIGZvcm1hdCwgZmFsc2UgdG8gbGVhdmUgYXMgaXMKCQlkaXNhYmxlZDogZmFsc2UgLy8gVGhlIGluaXRpYWwgZGlzYWJsZWQgc3RhdGUKCX07CgkkLmV4dGVuZCggdGhpcy5fZGVmYXVsdHMsIHRoaXMucmVnaW9uYWxbICIiIF0gKTsKCXRoaXMucmVnaW9uYWwuZW4gPSAkLmV4dGVuZCggdHJ1ZSwge30sIHRoaXMucmVnaW9uYWxbICIiIF0gKTsKCXRoaXMucmVnaW9uYWxbICJlbi1VUyIgXSA9ICQuZXh0ZW5kKCB0cnVlLCB7fSwgdGhpcy5yZWdpb25hbC5lbiApOwoJdGhpcy5kcERpdiA9IGRhdGVwaWNrZXJfYmluZEhvdmVyKCAkKCAiPGRpdiBpZD0nIiArIHRoaXMuX21haW5EaXZJZCArICInIGNsYXNzPSd1aS1kYXRlcGlja2VyIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1oZWxwZXItY2xlYXJmaXggdWktY29ybmVyLWFsbCc+PC9kaXY+IiApICk7Cn0KCiQuZXh0ZW5kKCBEYXRlcGlja2VyLnByb3RvdHlwZSwgewoJLyogQ2xhc3MgbmFtZSBhZGRlZCB0byBlbGVtZW50cyB0byBpbmRpY2F0ZSBhbHJlYWR5IGNvbmZpZ3VyZWQgd2l0aCBhIGRhdGUgcGlja2VyLiAqLwoJbWFya2VyQ2xhc3NOYW1lOiAiaGFzRGF0ZXBpY2tlciIsCgoJLy9LZWVwIHRyYWNrIG9mIHRoZSBtYXhpbXVtIG51bWJlciBvZiByb3dzIGRpc3BsYXllZCAoc2VlICM3MDQzKQoJbWF4Um93czogNCwKCgkvLyBUT0RPIHJlbmFtZSB0byAid2lkZ2V0IiB3aGVuIHN3aXRjaGluZyB0byB3aWRnZXQgZmFjdG9yeQoJX3dpZGdldERhdGVwaWNrZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmRwRGl2OwoJfSwKCgkvKiBPdmVycmlkZSB0aGUgZGVmYXVsdCBzZXR0aW5ncyBmb3IgYWxsIGluc3RhbmNlcyBvZiB0aGUgZGF0ZSBwaWNrZXIuCgkgKiBAcGFyYW0gIHNldHRpbmdzICBvYmplY3QgLSB0aGUgbmV3IHNldHRpbmdzIHRvIHVzZSBhcyBkZWZhdWx0cyAoYW5vbnltb3VzIG9iamVjdCkKCSAqIEByZXR1cm4gdGhlIG1hbmFnZXIgb2JqZWN0CgkgKi8KCXNldERlZmF1bHRzOiBmdW5jdGlvbiggc2V0dGluZ3MgKSB7CgkJZGF0ZXBpY2tlcl9leHRlbmRSZW1vdmUoIHRoaXMuX2RlZmF1bHRzLCBzZXR0aW5ncyB8fCB7fSApOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKiBBdHRhY2ggdGhlIGRhdGUgcGlja2VyIHRvIGEgalF1ZXJ5IHNlbGVjdGlvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqIEBwYXJhbSAgc2V0dGluZ3MgIG9iamVjdCAtIHRoZSBuZXcgc2V0dGluZ3MgdG8gdXNlIGZvciB0aGlzIGRhdGUgcGlja2VyIGluc3RhbmNlIChhbm9ueW1vdXMpCgkgKi8KCV9hdHRhY2hEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0LCBzZXR0aW5ncyApIHsKCQl2YXIgbm9kZU5hbWUsIGlubGluZSwgaW5zdDsKCQlub2RlTmFtZSA9IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCWlubGluZSA9ICggbm9kZU5hbWUgPT09ICJkaXYiIHx8IG5vZGVOYW1lID09PSAic3BhbiIgKTsKCQlpZiAoICF0YXJnZXQuaWQgKSB7CgkJCXRoaXMudXVpZCArPSAxOwoJCQl0YXJnZXQuaWQgPSAiZHAiICsgdGhpcy51dWlkOwoJCX0KCQlpbnN0ID0gdGhpcy5fbmV3SW5zdCggJCggdGFyZ2V0ICksIGlubGluZSApOwoJCWluc3Quc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHNldHRpbmdzIHx8IHt9ICk7CgkJaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiApIHsKCQkJdGhpcy5fY29ubmVjdERhdGVwaWNrZXIoIHRhcmdldCwgaW5zdCApOwoJCX0gZWxzZSBpZiAoIGlubGluZSApIHsKCQkJdGhpcy5faW5saW5lRGF0ZXBpY2tlciggdGFyZ2V0LCBpbnN0ICk7CgkJfQoJfSwKCgkvKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2JqZWN0LiAqLwoJX25ld0luc3Q6IGZ1bmN0aW9uKCB0YXJnZXQsIGlubGluZSApIHsKCQl2YXIgaWQgPSB0YXJnZXRbIDAgXS5pZC5yZXBsYWNlKCAvKFteQS1aYS16MC05X1wtXSkvZywgIlxcXFwkMSIgKTsgLy8gZXNjYXBlIGpRdWVyeSBtZXRhIGNoYXJzCgkJcmV0dXJuIHsgaWQ6IGlkLCBpbnB1dDogdGFyZ2V0LCAvLyBhc3NvY2lhdGVkIHRhcmdldAoJCQlzZWxlY3RlZERheTogMCwgc2VsZWN0ZWRNb250aDogMCwgc2VsZWN0ZWRZZWFyOiAwLCAvLyBjdXJyZW50IHNlbGVjdGlvbgoJCQlkcmF3TW9udGg6IDAsIGRyYXdZZWFyOiAwLCAvLyBtb250aCBiZWluZyBkcmF3bgoJCQlpbmxpbmU6IGlubGluZSwgLy8gaXMgZGF0ZXBpY2tlciBpbmxpbmUgb3Igbm90CgkJCWRwRGl2OiAoICFpbmxpbmUgPyB0aGlzLmRwRGl2IDogLy8gcHJlc2VudGF0aW9uIGRpdgoJCQlkYXRlcGlja2VyX2JpbmRIb3ZlciggJCggIjxkaXYgY2xhc3M9JyIgKyB0aGlzLl9pbmxpbmVDbGFzcyArICIgdWktZGF0ZXBpY2tlciB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktaGVscGVyLWNsZWFyZml4IHVpLWNvcm5lci1hbGwnPjwvZGl2PiIgKSApICkgfTsKCX0sCgoJLyogQXR0YWNoIHRoZSBkYXRlIHBpY2tlciB0byBhbiBpbnB1dCBmaWVsZC4gKi8KCV9jb25uZWN0RGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgaW5zdCApIHsKCQl2YXIgaW5wdXQgPSAkKCB0YXJnZXQgKTsKCQlpbnN0LmFwcGVuZCA9ICQoIFtdICk7CgkJaW5zdC50cmlnZ2VyID0gJCggW10gKTsKCQlpZiAoIGlucHV0Lmhhc0NsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApICkgewoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX2F0dGFjaG1lbnRzKCBpbnB1dCwgaW5zdCApOwoJCWlucHV0LmFkZENsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApLm9uKCAia2V5ZG93biIsIHRoaXMuX2RvS2V5RG93biApLgoJCQlvbiggImtleXByZXNzIiwgdGhpcy5fZG9LZXlQcmVzcyApLm9uKCAia2V5dXAiLCB0aGlzLl9kb0tleVVwICk7CgkJdGhpcy5fYXV0b1NpemUoIGluc3QgKTsKCQkkLmRhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiLCBpbnN0ICk7CgoJCS8vSWYgZGlzYWJsZWQgb3B0aW9uIGlzIHRydWUsIGRpc2FibGUgdGhlIGRhdGVwaWNrZXIgb25jZSBpdCBoYXMgYmVlbiBhdHRhY2hlZCB0byB0aGUgaW5wdXQgKHNlZSB0aWNrZXQgIzU2NjUpCgkJaWYgKCBpbnN0LnNldHRpbmdzLmRpc2FibGVkICkgewoJCQl0aGlzLl9kaXNhYmxlRGF0ZXBpY2tlciggdGFyZ2V0ICk7CgkJfQoJfSwKCgkvKiBNYWtlIGF0dGFjaG1lbnRzIGJhc2VkIG9uIHNldHRpbmdzLiAqLwoJX2F0dGFjaG1lbnRzOiBmdW5jdGlvbiggaW5wdXQsIGluc3QgKSB7CgkJdmFyIHNob3dPbiwgYnV0dG9uVGV4dCwgYnV0dG9uSW1hZ2UsCgkJCWFwcGVuZFRleHQgPSB0aGlzLl9nZXQoIGluc3QsICJhcHBlbmRUZXh0IiApLAoJCQlpc1JUTCA9IHRoaXMuX2dldCggaW5zdCwgImlzUlRMIiApOwoKCQlpZiAoIGluc3QuYXBwZW5kICkgewoJCQlpbnN0LmFwcGVuZC5yZW1vdmUoKTsKCQl9CgkJaWYgKCBhcHBlbmRUZXh0ICkgewoJCQlpbnN0LmFwcGVuZCA9ICQoICI8c3BhbiBjbGFzcz0nIiArIHRoaXMuX2FwcGVuZENsYXNzICsgIic+IiArIGFwcGVuZFRleHQgKyAiPC9zcGFuPiIgKTsKCQkJaW5wdXRbIGlzUlRMID8gImJlZm9yZSIgOiAiYWZ0ZXIiIF0oIGluc3QuYXBwZW5kICk7CgkJfQoKCQlpbnB1dC5vZmYoICJmb2N1cyIsIHRoaXMuX3Nob3dEYXRlcGlja2VyICk7CgoJCWlmICggaW5zdC50cmlnZ2VyICkgewoJCQlpbnN0LnRyaWdnZXIucmVtb3ZlKCk7CgkJfQoKCQlzaG93T24gPSB0aGlzLl9nZXQoIGluc3QsICJzaG93T24iICk7CgkJaWYgKCBzaG93T24gPT09ICJmb2N1cyIgfHwgc2hvd09uID09PSAiYm90aCIgKSB7IC8vIHBvcC11cCBkYXRlIHBpY2tlciB3aGVuIGluIHRoZSBtYXJrZWQgZmllbGQKCQkJaW5wdXQub24oICJmb2N1cyIsIHRoaXMuX3Nob3dEYXRlcGlja2VyICk7CgkJfQoJCWlmICggc2hvd09uID09PSAiYnV0dG9uIiB8fCBzaG93T24gPT09ICJib3RoIiApIHsgLy8gcG9wLXVwIGRhdGUgcGlja2VyIHdoZW4gYnV0dG9uIGNsaWNrZWQKCQkJYnV0dG9uVGV4dCA9IHRoaXMuX2dldCggaW5zdCwgImJ1dHRvblRleHQiICk7CgkJCWJ1dHRvbkltYWdlID0gdGhpcy5fZ2V0KCBpbnN0LCAiYnV0dG9uSW1hZ2UiICk7CgkJCWluc3QudHJpZ2dlciA9ICQoIHRoaXMuX2dldCggaW5zdCwgImJ1dHRvbkltYWdlT25seSIgKSA\/CgkJCQkkKCAiPGltZy8+IiApLmFkZENsYXNzKCB0aGlzLl90cmlnZ2VyQ2xhc3MgKS4KCQkJCQlhdHRyKCB7IHNyYzogYnV0dG9uSW1hZ2UsIGFsdDogYnV0dG9uVGV4dCwgdGl0bGU6IGJ1dHRvblRleHQgfSApIDoKCQkJCSQoICI8YnV0dG9uIHR5cGU9J2J1dHRvbic+PC9idXR0b24+IiApLmFkZENsYXNzKCB0aGlzLl90cmlnZ2VyQ2xhc3MgKS4KCQkJCQlodG1sKCAhYnV0dG9uSW1hZ2UgPyBidXR0b25UZXh0IDogJCggIjxpbWcvPiIgKS5hdHRyKAoJCQkJCXsgc3JjOmJ1dHRvbkltYWdlLCBhbHQ6YnV0dG9uVGV4dCwgdGl0bGU6YnV0dG9uVGV4dCB9ICkgKSApOwoJCQlpbnB1dFsgaXNSVEwgPyAiYmVmb3JlIiA6ICJhZnRlciIgXSggaW5zdC50cmlnZ2VyICk7CgkJCWluc3QudHJpZ2dlci5vbiggImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoICQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgJiYgJC5kYXRlcGlja2VyLl9sYXN0SW5wdXQgPT09IGlucHV0WyAwIF0gKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQkJfSBlbHNlIGlmICggJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyAmJiAkLmRhdGVwaWNrZXIuX2xhc3RJbnB1dCAhPT0gaW5wdXRbIDAgXSApIHsKCQkJCQkkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7CgkJCQkJJC5kYXRlcGlja2VyLl9zaG93RGF0ZXBpY2tlciggaW5wdXRbIDAgXSApOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGVwaWNrZXIuX3Nob3dEYXRlcGlja2VyKCBpbnB1dFsgMCBdICk7CgkJCQl9CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gKTsKCQl9Cgl9LAoKCS8qIEFwcGx5IHRoZSBtYXhpbXVtIGxlbmd0aCBmb3IgdGhlIGRhdGUgZm9ybWF0LiAqLwoJX2F1dG9TaXplOiBmdW5jdGlvbiggaW5zdCApIHsKCQlpZiAoIHRoaXMuX2dldCggaW5zdCwgImF1dG9TaXplIiApICYmICFpbnN0LmlubGluZSApIHsKCQkJdmFyIGZpbmRNYXgsIG1heCwgbWF4SSwgaSwKCQkJCWRhdGUgPSBuZXcgRGF0ZSggMjAwOSwgMTIgLSAxLCAyMCApLCAvLyBFbnN1cmUgZG91YmxlIGRpZ2l0cwoJCQkJZGF0ZUZvcm1hdCA9IHRoaXMuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICk7CgoJCQlpZiAoIGRhdGVGb3JtYXQubWF0Y2goIC9bRE1dLyApICkgewoJCQkJZmluZE1heCA9IGZ1bmN0aW9uKCBuYW1lcyApIHsKCQkJCQltYXggPSAwOwoJCQkJCW1heEkgPSAwOwoJCQkJCWZvciAoIGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKysgKSB7CgkJCQkJCWlmICggbmFtZXNbIGkgXS5sZW5ndGggPiBtYXggKSB7CgkJCQkJCQltYXggPSBuYW1lc1sgaSBdLmxlbmd0aDsKCQkJCQkJCW1heEkgPSBpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiBtYXhJOwoJCQkJfTsKCQkJCWRhdGUuc2V0TW9udGgoIGZpbmRNYXgoIHRoaXMuX2dldCggaW5zdCwgKCBkYXRlRm9ybWF0Lm1hdGNoKCAvTU0vICkgPwoJCQkJCSJtb250aE5hbWVzIiA6ICJtb250aE5hbWVzU2hvcnQiICkgKSApICk7CgkJCQlkYXRlLnNldERhdGUoIGZpbmRNYXgoIHRoaXMuX2dldCggaW5zdCwgKCBkYXRlRm9ybWF0Lm1hdGNoKCAvREQvICkgPwoJCQkJCSJkYXlOYW1lcyIgOiAiZGF5TmFtZXNTaG9ydCIgKSApICkgKyAyMCAtIGRhdGUuZ2V0RGF5KCkgKTsKCQkJfQoJCQlpbnN0LmlucHV0LmF0dHIoICJzaXplIiwgdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwgZGF0ZSApLmxlbmd0aCApOwoJCX0KCX0sCgoJLyogQXR0YWNoIGFuIGlubGluZSBkYXRlIHBpY2tlciB0byBhIGRpdi4gKi8KCV9pbmxpbmVEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0LCBpbnN0ICkgewoJCXZhciBkaXZTcGFuID0gJCggdGFyZ2V0ICk7CgkJaWYgKCBkaXZTcGFuLmhhc0NsYXNzKCB0aGlzLm1hcmtlckNsYXNzTmFtZSApICkgewoJCQlyZXR1cm47CgkJfQoJCWRpdlNwYW4uYWRkQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkuYXBwZW5kKCBpbnN0LmRwRGl2ICk7CgkJJC5kYXRhKCB0YXJnZXQsICJkYXRlcGlja2VyIiwgaW5zdCApOwoJCXRoaXMuX3NldERhdGUoIGluc3QsIHRoaXMuX2dldERlZmF1bHREYXRlKCBpbnN0ICksIHRydWUgKTsKCQl0aGlzLl91cGRhdGVEYXRlcGlja2VyKCBpbnN0ICk7CgkJdGhpcy5fdXBkYXRlQWx0ZXJuYXRlKCBpbnN0ICk7CgoJCS8vSWYgZGlzYWJsZWQgb3B0aW9uIGlzIHRydWUsIGRpc2FibGUgdGhlIGRhdGVwaWNrZXIgYmVmb3JlIHNob3dpbmcgaXQgKHNlZSB0aWNrZXQgIzU2NjUpCgkJaWYgKCBpbnN0LnNldHRpbmdzLmRpc2FibGVkICkgewoJCQl0aGlzLl9kaXNhYmxlRGF0ZXBpY2tlciggdGFyZ2V0ICk7CgkJfQoKCQkvLyBTZXQgZGlzcGxheTpibG9jayBpbiBwbGFjZSBvZiBpbnN0LmRwRGl2LnNob3coKSB3aGljaCB3b24ndCB3b3JrIG9uIGRpc2Nvbm5lY3RlZCBlbGVtZW50cwoJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeXVpLmNvbS90aWNrZXQvNzU1MiAtIEEgRGF0ZXBpY2tlciBjcmVhdGVkIG9uIGEgZGV0YWNoZWQgZGl2IGhhcyB6ZXJvIGhlaWdodAoJCWluc3QuZHBEaXYuY3NzKCAiZGlzcGxheSIsICJibG9jayIgKTsKCX0sCgoJLyogUG9wLXVwIHRoZSBkYXRlIHBpY2tlciBpbiBhICJkaWFsb2ciIGJveC4KCSAqIEBwYXJhbSAgaW5wdXQgZWxlbWVudCAtIGlnbm9yZWQKCSAqIEBwYXJhbSAgZGF0ZQlzdHJpbmcgb3IgRGF0ZSAtIHRoZSBpbml0aWFsIGRhdGUgdG8gZGlzcGxheQoJICogQHBhcmFtICBvblNlbGVjdCAgZnVuY3Rpb24gLSB0aGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIGEgZGF0ZSBpcyBzZWxlY3RlZAoJICogQHBhcmFtICBzZXR0aW5ncyAgb2JqZWN0IC0gdXBkYXRlIHRoZSBkaWFsb2cgZGF0ZSBwaWNrZXIgaW5zdGFuY2UncyBzZXR0aW5ncyAoYW5vbnltb3VzIG9iamVjdCkKCSAqIEBwYXJhbSAgcG9zIGludFsyXSAtIGNvb3JkaW5hdGVzIGZvciB0aGUgZGlhbG9nJ3MgcG9zaXRpb24gd2l0aGluIHRoZSBzY3JlZW4gb3IKCSAqCQkJCQlldmVudCAtIHdpdGggeC95IGNvb3JkaW5hdGVzIG9yCgkgKgkJCQkJbGVhdmUgZW1wdHkgZm9yIGRlZmF1bHQgKHNjcmVlbiBjZW50cmUpCgkgKiBAcmV0dXJuIHRoZSBtYW5hZ2VyIG9iamVjdAoJICovCglfZGlhbG9nRGF0ZXBpY2tlcjogZnVuY3Rpb24oIGlucHV0LCBkYXRlLCBvblNlbGVjdCwgc2V0dGluZ3MsIHBvcyApIHsKCQl2YXIgaWQsIGJyb3dzZXJXaWR0aCwgYnJvd3NlckhlaWdodCwgc2Nyb2xsWCwgc2Nyb2xsWSwKCQkJaW5zdCA9IHRoaXMuX2RpYWxvZ0luc3Q7IC8vIGludGVybmFsIGluc3RhbmNlCgoJCWlmICggIWluc3QgKSB7CgkJCXRoaXMudXVpZCArPSAxOwoJCQlpZCA9ICJkcCIgKyB0aGlzLnV1aWQ7CgkJCXRoaXMuX2RpYWxvZ0lucHV0ID0gJCggIjxpbnB1dCB0eXBlPSd0ZXh0JyBpZD0nIiArIGlkICsKCQkJCSInIHN0eWxlPSdwb3NpdGlvbjogYWJzb2x1dGU7IHRvcDogLTEwMHB4OyB3aWR0aDogMHB4OycvPiIgKTsKCQkJdGhpcy5fZGlhbG9nSW5wdXQub24oICJrZXlkb3duIiwgdGhpcy5fZG9LZXlEb3duICk7CgkJCSQoICJib2R5IiApLmFwcGVuZCggdGhpcy5fZGlhbG9nSW5wdXQgKTsKCQkJaW5zdCA9IHRoaXMuX2RpYWxvZ0luc3QgPSB0aGlzLl9uZXdJbnN0KCB0aGlzLl9kaWFsb2dJbnB1dCwgZmFsc2UgKTsKCQkJaW5zdC5zZXR0aW5ncyA9IHt9OwoJCQkkLmRhdGEoIHRoaXMuX2RpYWxvZ0lucHV0WyAwIF0sICJkYXRlcGlja2VyIiwgaW5zdCApOwoJCX0KCQlkYXRlcGlja2VyX2V4dGVuZFJlbW92ZSggaW5zdC5zZXR0aW5ncywgc2V0dGluZ3MgfHwge30gKTsKCQlkYXRlID0gKCBkYXRlICYmIGRhdGUuY29uc3RydWN0b3IgPT09IERhdGUgPyB0aGlzLl9mb3JtYXREYXRlKCBpbnN0LCBkYXRlICkgOiBkYXRlICk7CgkJdGhpcy5fZGlhbG9nSW5wdXQudmFsKCBkYXRlICk7CgoJCXRoaXMuX3BvcyA9ICggcG9zID8gKCBwb3MubGVuZ3RoID8gcG9zIDogWyBwb3MucGFnZVgsIHBvcy5wYWdlWSBdICkgOiBudWxsICk7CgkJaWYgKCAhdGhpcy5fcG9zICkgewoJCQlicm93c2VyV2lkdGggPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7CgkJCWJyb3dzZXJIZWlnaHQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0OwoJCQlzY3JvbGxYID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0OwoJCQlzY3JvbGxZID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDsKCQkJdGhpcy5fcG9zID0gLy8gc2hvdWxkIHVzZSBhY3R1YWwgd2lkdGgvaGVpZ2h0IGJlbG93CgkJCQlbICggYnJvd3NlcldpZHRoIC8gMiApIC0gMTAwICsgc2Nyb2xsWCwgKCBicm93c2VySGVpZ2h0IC8gMiApIC0gMTUwICsgc2Nyb2xsWSBdOwoJCX0KCgkJLy8gTW92ZSBpbnB1dCBvbiBzY3JlZW4gZm9yIGZvY3VzLCBidXQgaGlkZGVuIGJlaGluZCBkaWFsb2cKCQl0aGlzLl9kaWFsb2dJbnB1dC5jc3MoICJsZWZ0IiwgKCB0aGlzLl9wb3NbIDAgXSArIDIwICkgKyAicHgiICkuY3NzKCAidG9wIiwgdGhpcy5fcG9zWyAxIF0gKyAicHgiICk7CgkJaW5zdC5zZXR0aW5ncy5vblNlbGVjdCA9IG9uU2VsZWN0OwoJCXRoaXMuX2luRGlhbG9nID0gdHJ1ZTsKCQl0aGlzLmRwRGl2LmFkZENsYXNzKCB0aGlzLl9kaWFsb2dDbGFzcyApOwoJCXRoaXMuX3Nob3dEYXRlcGlja2VyKCB0aGlzLl9kaWFsb2dJbnB1dFsgMCBdICk7CgkJaWYgKCAkLmJsb2NrVUkgKSB7CgkJCSQuYmxvY2tVSSggdGhpcy5kcERpdiApOwoJCX0KCQkkLmRhdGEoIHRoaXMuX2RpYWxvZ0lucHV0WyAwIF0sICJkYXRlcGlja2VyIiwgaW5zdCApOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKiBEZXRhY2ggYSBkYXRlcGlja2VyIGZyb20gaXRzIGNvbnRyb2wuCgkgKiBAcGFyYW0gIHRhcmdldAllbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKi8KCV9kZXN0cm95RGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgbm9kZU5hbWUsCgkJCSR0YXJnZXQgPSAkKCB0YXJnZXQgKSwKCQkJaW5zdCA9ICQuZGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIgKTsKCgkJaWYgKCAhJHRhcmdldC5oYXNDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbm9kZU5hbWUgPSB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkkLnJlbW92ZURhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiICk7CgkJaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiApIHsKCQkJaW5zdC5hcHBlbmQucmVtb3ZlKCk7CgkJCWluc3QudHJpZ2dlci5yZW1vdmUoKTsKCQkJJHRhcmdldC5yZW1vdmVDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKS4KCQkJCW9mZiggImZvY3VzIiwgdGhpcy5fc2hvd0RhdGVwaWNrZXIgKS4KCQkJCW9mZiggImtleWRvd24iLCB0aGlzLl9kb0tleURvd24gKS4KCQkJCW9mZiggImtleXByZXNzIiwgdGhpcy5fZG9LZXlQcmVzcyApLgoJCQkJb2ZmKCAia2V5dXAiLCB0aGlzLl9kb0tleVVwICk7CgkJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJkaXYiIHx8IG5vZGVOYW1lID09PSAic3BhbiIgKSB7CgkJCSR0YXJnZXQucmVtb3ZlQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkuZW1wdHkoKTsKCQl9CgoJCWlmICggZGF0ZXBpY2tlcl9pbnN0QWN0aXZlID09PSBpbnN0ICkgewoJCQlkYXRlcGlja2VyX2luc3RBY3RpdmUgPSBudWxsOwoJCX0KCX0sCgoJLyogRW5hYmxlIHRoZSBkYXRlIHBpY2tlciB0byBhIGpRdWVyeSBzZWxlY3Rpb24uCgkgKiBAcGFyYW0gIHRhcmdldAllbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKi8KCV9lbmFibGVEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCXZhciBub2RlTmFtZSwgaW5saW5lLAoJCQkkdGFyZ2V0ID0gJCggdGFyZ2V0ICksCgkJCWluc3QgPSAkLmRhdGEoIHRhcmdldCwgImRhdGVwaWNrZXIiICk7CgoJCWlmICggISR0YXJnZXQuaGFzQ2xhc3MoIHRoaXMubWFya2VyQ2xhc3NOYW1lICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW5vZGVOYW1lID0gdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiApIHsKCQkJdGFyZ2V0LmRpc2FibGVkID0gZmFsc2U7CgkJCWluc3QudHJpZ2dlci5maWx0ZXIoICJidXR0b24iICkuCgkJCQllYWNoKCBmdW5jdGlvbigpIHsgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOyB9ICkuZW5kKCkuCgkJCQlmaWx0ZXIoICJpbWciICkuY3NzKCB7IG9wYWNpdHk6ICIxLjAiLCBjdXJzb3I6ICIiIH0gKTsKCQl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImRpdiIgfHwgbm9kZU5hbWUgPT09ICJzcGFuIiApIHsKCQkJaW5saW5lID0gJHRhcmdldC5jaGlsZHJlbiggIi4iICsgdGhpcy5faW5saW5lQ2xhc3MgKTsKCQkJaW5saW5lLmNoaWxkcmVuKCkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCQkJaW5saW5lLmZpbmQoICJzZWxlY3QudWktZGF0ZXBpY2tlci1tb250aCwgc2VsZWN0LnVpLWRhdGVwaWNrZXIteWVhciIgKS4KCQkJCXByb3AoICJkaXNhYmxlZCIsIGZhbHNlICk7CgkJfQoJCXRoaXMuX2Rpc2FibGVkSW5wdXRzID0gJC5tYXAoIHRoaXMuX2Rpc2FibGVkSW5wdXRzLAoJCQlmdW5jdGlvbiggdmFsdWUgKSB7IHJldHVybiAoIHZhbHVlID09PSB0YXJnZXQgPyBudWxsIDogdmFsdWUgKTsgfSApOyAvLyBkZWxldGUgZW50cnkKCX0sCgoJLyogRGlzYWJsZSB0aGUgZGF0ZSBwaWNrZXIgdG8gYSBqUXVlcnkgc2VsZWN0aW9uLgoJICogQHBhcmFtICB0YXJnZXQJZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICovCglfZGlzYWJsZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdmFyIG5vZGVOYW1lLCBpbmxpbmUsCgkJCSR0YXJnZXQgPSAkKCB0YXJnZXQgKSwKCQkJaW5zdCA9ICQuZGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIgKTsKCgkJaWYgKCAhJHRhcmdldC5oYXNDbGFzcyggdGhpcy5tYXJrZXJDbGFzc05hbWUgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbm9kZU5hbWUgPSB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQlpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiICkgewoJCQl0YXJnZXQuZGlzYWJsZWQgPSB0cnVlOwoJCQlpbnN0LnRyaWdnZXIuZmlsdGVyKCAiYnV0dG9uIiApLgoJCQkJZWFjaCggZnVuY3Rpb24oKSB7IHRoaXMuZGlzYWJsZWQgPSB0cnVlOyB9ICkuZW5kKCkuCgkJCQlmaWx0ZXIoICJpbWciICkuY3NzKCB7IG9wYWNpdHk6ICIwLjUiLCBjdXJzb3I6ICJkZWZhdWx0IiB9ICk7CgkJfSBlbHNlIGlmICggbm9kZU5hbWUgPT09ICJkaXYiIHx8IG5vZGVOYW1lID09PSAic3BhbiIgKSB7CgkJCWlubGluZSA9ICR0YXJnZXQuY2hpbGRyZW4oICIuIiArIHRoaXMuX2lubGluZUNsYXNzICk7CgkJCWlubGluZS5jaGlsZHJlbigpLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJCWlubGluZS5maW5kKCAic2VsZWN0LnVpLWRhdGVwaWNrZXItbW9udGgsIHNlbGVjdC51aS1kYXRlcGlja2VyLXllYXIiICkuCgkJCQlwcm9wKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJfQoJCXRoaXMuX2Rpc2FibGVkSW5wdXRzID0gJC5tYXAoIHRoaXMuX2Rpc2FibGVkSW5wdXRzLAoJCQlmdW5jdGlvbiggdmFsdWUgKSB7IHJldHVybiAoIHZhbHVlID09PSB0YXJnZXQgPyBudWxsIDogdmFsdWUgKTsgfSApOyAvLyBkZWxldGUgZW50cnkKCQl0aGlzLl9kaXNhYmxlZElucHV0c1sgdGhpcy5fZGlzYWJsZWRJbnB1dHMubGVuZ3RoIF0gPSB0YXJnZXQ7Cgl9LAoKCS8qIElzIHRoZSBmaXJzdCBmaWVsZCBpbiBhIGpRdWVyeSBjb2xsZWN0aW9uIGRpc2FibGVkIGFzIGEgZGF0ZXBpY2tlcj8KCSAqIEBwYXJhbSAgdGFyZ2V0CWVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqIEByZXR1cm4gYm9vbGVhbiAtIHRydWUgaWYgZGlzYWJsZWQsIGZhbHNlIGlmIGVuYWJsZWQKCSAqLwoJX2lzRGlzYWJsZWREYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCWlmICggIXRhcmdldCApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aGlzLl9kaXNhYmxlZElucHV0cy5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCB0aGlzLl9kaXNhYmxlZElucHV0c1sgaSBdID09PSB0YXJnZXQgKSB7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCS8qIFJldHJpZXZlIHRoZSBpbnN0YW5jZSBkYXRhIGZvciB0aGUgdGFyZ2V0IGNvbnRyb2wuCgkgKiBAcGFyYW0gIHRhcmdldCAgZWxlbWVudCAtIHRoZSB0YXJnZXQgaW5wdXQgZmllbGQgb3IgZGl2aXNpb24gb3Igc3BhbgoJICogQHJldHVybiAgb2JqZWN0IC0gdGhlIGFzc29jaWF0ZWQgaW5zdGFuY2UgZGF0YQoJICogQHRocm93cyAgZXJyb3IgaWYgYSBqUXVlcnkgcHJvYmxlbSBnZXR0aW5nIGRhdGEKCSAqLwoJX2dldEluc3Q6IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkJdHJ5IHsKCQkJcmV0dXJuICQuZGF0YSggdGFyZ2V0LCAiZGF0ZXBpY2tlciIgKTsKCQl9CgkJY2F0Y2ggKCBlcnIgKSB7CgkJCXRocm93ICJNaXNzaW5nIGluc3RhbmNlIGRhdGEgZm9yIHRoaXMgZGF0ZXBpY2tlciI7CgkJfQoJfSwKCgkvKiBVcGRhdGUgb3IgcmV0cmlldmUgdGhlIHNldHRpbmdzIGZvciBhIGRhdGUgcGlja2VyIGF0dGFjaGVkIHRvIGFuIGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uLgoJICogQHBhcmFtICB0YXJnZXQgIGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqIEBwYXJhbSAgbmFtZQlvYmplY3QgLSB0aGUgbmV3IHNldHRpbmdzIHRvIHVwZGF0ZSBvcgoJICoJCQkJc3RyaW5nIC0gdGhlIG5hbWUgb2YgdGhlIHNldHRpbmcgdG8gY2hhbmdlIG9yIHJldHJpZXZlLAoJICoJCQkJd2hlbiByZXRyaWV2aW5nIGFsc28gImFsbCIgZm9yIGFsbCBpbnN0YW5jZSBzZXR0aW5ncyBvcgoJICoJCQkJImRlZmF1bHRzIiBmb3IgYWxsIGdsb2JhbCBkZWZhdWx0cwoJICogQHBhcmFtICB2YWx1ZSAgIGFueSAtIHRoZSBuZXcgdmFsdWUgZm9yIHRoZSBzZXR0aW5nCgkgKgkJCQkob21pdCBpZiBhYm92ZSBpcyBhbiBvYmplY3Qgb3IgdG8gcmV0cmlldmUgYSB2YWx1ZSkKCSAqLwoJX29wdGlvbkRhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQsIG5hbWUsIHZhbHVlICkgewoJCXZhciBzZXR0aW5ncywgZGF0ZSwgbWluRGF0ZSwgbWF4RGF0ZSwKCQkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldCApOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gKCBuYW1lID09PSAiZGVmYXVsdHMiID8gJC5leHRlbmQoIHt9LCAkLmRhdGVwaWNrZXIuX2RlZmF1bHRzICkgOgoJCQkJKCBpbnN0ID8gKCBuYW1lID09PSAiYWxsIiA\/ICQuZXh0ZW5kKCB7fSwgaW5zdC5zZXR0aW5ncyApIDoKCQkJCXRoaXMuX2dldCggaW5zdCwgbmFtZSApICkgOiBudWxsICkgKTsKCQl9CgoJCXNldHRpbmdzID0gbmFtZSB8fCB7fTsKCQlpZiAoIHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiApIHsKCQkJc2V0dGluZ3MgPSB7fTsKCQkJc2V0dGluZ3NbIG5hbWUgXSA9IHZhbHVlOwoJCX0KCgkJaWYgKCBpbnN0ICkgewoJCQlpZiAoIHRoaXMuX2N1ckluc3QgPT09IGluc3QgKSB7CgkJCQl0aGlzLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQl9CgoJCQlkYXRlID0gdGhpcy5fZ2V0RGF0ZURhdGVwaWNrZXIoIHRhcmdldCwgdHJ1ZSApOwoJCQltaW5EYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZSggaW5zdCwgIm1pbiIgKTsKCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtYXgiICk7CgkJCWRhdGVwaWNrZXJfZXh0ZW5kUmVtb3ZlKCBpbnN0LnNldHRpbmdzLCBzZXR0aW5ncyApOwoKCQkJLy8gcmVmb3JtYXQgdGhlIG9sZCBtaW5EYXRlL21heERhdGUgdmFsdWVzIGlmIGRhdGVGb3JtYXQgY2hhbmdlcyBhbmQgYSBuZXcgbWluRGF0ZS9tYXhEYXRlIGlzbid0IHByb3ZpZGVkCgkJCWlmICggbWluRGF0ZSAhPT0gbnVsbCAmJiBzZXR0aW5ncy5kYXRlRm9ybWF0ICE9PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MubWluRGF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJaW5zdC5zZXR0aW5ncy5taW5EYXRlID0gdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwgbWluRGF0ZSApOwoJCQl9CgkJCWlmICggbWF4RGF0ZSAhPT0gbnVsbCAmJiBzZXR0aW5ncy5kYXRlRm9ybWF0ICE9PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MubWF4RGF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJaW5zdC5zZXR0aW5ncy5tYXhEYXRlID0gdGhpcy5fZm9ybWF0RGF0ZSggaW5zdCwgbWF4RGF0ZSApOwoJCQl9CgkJCWlmICggImRpc2FibGVkIiBpbiBzZXR0aW5ncyApIHsKCQkJCWlmICggc2V0dGluZ3MuZGlzYWJsZWQgKSB7CgkJCQkJdGhpcy5fZGlzYWJsZURhdGVwaWNrZXIoIHRhcmdldCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9lbmFibGVEYXRlcGlja2VyKCB0YXJnZXQgKTsKCQkJCX0KCQkJfQoJCQl0aGlzLl9hdHRhY2htZW50cyggJCggdGFyZ2V0ICksIGluc3QgKTsKCQkJdGhpcy5fYXV0b1NpemUoIGluc3QgKTsKCQkJdGhpcy5fc2V0RGF0ZSggaW5zdCwgZGF0ZSApOwoJCQl0aGlzLl91cGRhdGVBbHRlcm5hdGUoIGluc3QgKTsKCQkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOwoJCX0KCX0sCgoJLy8gQ2hhbmdlIG1ldGhvZCBkZXByZWNhdGVkCglfY2hhbmdlRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgbmFtZSwgdmFsdWUgKSB7CgkJdGhpcy5fb3B0aW9uRGF0ZXBpY2tlciggdGFyZ2V0LCBuYW1lLCB2YWx1ZSApOwoJfSwKCgkvKiBSZWRyYXcgdGhlIGRhdGUgcGlja2VyIGF0dGFjaGVkIHRvIGFuIGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uLgoJICogQHBhcmFtICB0YXJnZXQgIGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqLwoJX3JlZnJlc2hEYXRlcGlja2VyOiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCXZhciBpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0ICk7CgkJaWYgKCBpbnN0ICkgewoJCQl0aGlzLl91cGRhdGVEYXRlcGlja2VyKCBpbnN0ICk7CgkJfQoJfSwKCgkvKiBTZXQgdGhlIGRhdGVzIGZvciBhIGpRdWVyeSBzZWxlY3Rpb24uCgkgKiBAcGFyYW0gIHRhcmdldCBlbGVtZW50IC0gdGhlIHRhcmdldCBpbnB1dCBmaWVsZCBvciBkaXZpc2lvbiBvciBzcGFuCgkgKiBAcGFyYW0gIGRhdGUJRGF0ZSAtIHRoZSBuZXcgZGF0ZQoJICovCglfc2V0RGF0ZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCB0YXJnZXQsIGRhdGUgKSB7CgkJdmFyIGluc3QgPSB0aGlzLl9nZXRJbnN0KCB0YXJnZXQgKTsKCQlpZiAoIGluc3QgKSB7CgkJCXRoaXMuX3NldERhdGUoIGluc3QsIGRhdGUgKTsKCQkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOwoJCQl0aGlzLl91cGRhdGVBbHRlcm5hdGUoIGluc3QgKTsKCQl9Cgl9LAoKCS8qIEdldCB0aGUgZGF0ZShzKSBmb3IgdGhlIGZpcnN0IGVudHJ5IGluIGEgalF1ZXJ5IHNlbGVjdGlvbi4KCSAqIEBwYXJhbSAgdGFyZ2V0IGVsZW1lbnQgLSB0aGUgdGFyZ2V0IGlucHV0IGZpZWxkIG9yIGRpdmlzaW9uIG9yIHNwYW4KCSAqIEBwYXJhbSAgbm9EZWZhdWx0IGJvb2xlYW4gLSB0cnVlIGlmIG5vIGRlZmF1bHQgZGF0ZSBpcyB0byBiZSB1c2VkCgkgKiBAcmV0dXJuIERhdGUgLSB0aGUgY3VycmVudCBkYXRlCgkgKi8KCV9nZXREYXRlRGF0ZXBpY2tlcjogZnVuY3Rpb24oIHRhcmdldCwgbm9EZWZhdWx0ICkgewoJCXZhciBpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0ICk7CgkJaWYgKCBpbnN0ICYmICFpbnN0LmlubGluZSApIHsKCQkJdGhpcy5fc2V0RGF0ZUZyb21GaWVsZCggaW5zdCwgbm9EZWZhdWx0ICk7CgkJfQoJCXJldHVybiAoIGluc3QgPyB0aGlzLl9nZXREYXRlKCBpbnN0ICkgOiBudWxsICk7Cgl9LAoKCS8qIEhhbmRsZSBrZXlzdHJva2VzLiAqLwoJX2RvS2V5RG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvblNlbGVjdCwgZGF0ZVN0ciwgc2VsLAoJCQlpbnN0ID0gJC5kYXRlcGlja2VyLl9nZXRJbnN0KCBldmVudC50YXJnZXQgKSwKCQkJaGFuZGxlZCA9IHRydWUsCgkJCWlzUlRMID0gaW5zdC5kcERpdi5pcyggIi51aS1kYXRlcGlja2VyLXJ0bCIgKTsKCgkJaW5zdC5fa2V5RXZlbnQgPSB0cnVlOwoJCWlmICggJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyApIHsKCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCWNhc2UgOTogJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQkJCQloYW5kbGVkID0gZmFsc2U7CgkJCQkJCWJyZWFrOyAvLyBoaWRlIG9uIHRhYiBvdXQKCQkJCWNhc2UgMTM6IHNlbCA9ICQoICJ0ZC4iICsgJC5kYXRlcGlja2VyLl9kYXlPdmVyQ2xhc3MgKyAiOm5vdCguIiArCgkJCQkJCQkJCSQuZGF0ZXBpY2tlci5fY3VycmVudENsYXNzICsgIikiLCBpbnN0LmRwRGl2ICk7CgkJCQkJCWlmICggc2VsWyAwIF0gKSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX3NlbGVjdERheSggZXZlbnQudGFyZ2V0LCBpbnN0LnNlbGVjdGVkTW9udGgsIGluc3Quc2VsZWN0ZWRZZWFyLCBzZWxbIDAgXSApOwoJCQkJCQl9CgoJCQkJCQlvblNlbGVjdCA9ICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAib25TZWxlY3QiICk7CgkJCQkJCWlmICggb25TZWxlY3QgKSB7CgkJCQkJCQlkYXRlU3RyID0gJC5kYXRlcGlja2VyLl9mb3JtYXREYXRlKCBpbnN0ICk7CgoJCQkJCQkJLy8gVHJpZ2dlciBjdXN0b20gY2FsbGJhY2sKCQkJCQkJCW9uU2VsZWN0LmFwcGx5KCAoIGluc3QuaW5wdXQgPyBpbnN0LmlucHV0WyAwIF0gOiBudWxsICksIFsgZGF0ZVN0ciwgaW5zdCBdICk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7CgkJCQkJCX0KCgkJCQkJCXJldHVybiBmYWxzZTsgLy8gZG9uJ3Qgc3VibWl0IHRoZSBmb3JtCgkJCQljYXNlIDI3OiAkLmRhdGVwaWNrZXIuX2hpZGVEYXRlcGlja2VyKCk7CgkJCQkJCWJyZWFrOyAvLyBoaWRlIG9uIGVzY2FwZQoJCQkJY2FzZSAzMzogJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggZXZlbnQuY3RybEtleSA\/CgkJCQkJCQktJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzdGVwQmlnTW9udGhzIiApIDoKCQkJCQkJCS0kLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICkgKSwgIk0iICk7CgkJCQkJCWJyZWFrOyAvLyBwcmV2aW91cyBtb250aC95ZWFyIG9uIHBhZ2UgdXAvKyBjdHJsCgkJCQljYXNlIDM0OiAkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKCBldmVudC5jdHJsS2V5ID8KCQkJCQkJCSskLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBCaWdNb250aHMiICkgOgoJCQkJCQkJKyQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcE1vbnRocyIgKSApLCAiTSIgKTsKCQkJCQkJYnJlYWs7IC8vIG5leHQgbW9udGgveWVhciBvbiBwYWdlIGRvd24vKyBjdHJsCgkJCQljYXNlIDM1OiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fY2xlYXJEYXRlKCBldmVudC50YXJnZXQgKTsKCQkJCQkJfQoJCQkJCQloYW5kbGVkID0gZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5OwoJCQkJCQlicmVhazsgLy8gY2xlYXIgb24gY3RybCBvciBjb21tYW5kICtlbmQKCQkJCWNhc2UgMzY6IGlmICggZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5ICkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9nb3RvVG9kYXkoIGV2ZW50LnRhcmdldCApOwoJCQkJCQl9CgkJCQkJCWhhbmRsZWQgPSBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXk7CgkJCQkJCWJyZWFrOyAvLyBjdXJyZW50IG9uIGN0cmwgb3IgY29tbWFuZCAraG9tZQoJCQkJY2FzZSAzNzogaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgKSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgKCBpc1JUTCA\/ICsxIDogLTEgKSwgIkQiICk7CgkJCQkJCX0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsKCgkJCQkJCS8vIC0xIGRheSBvbiBjdHJsIG9yIGNvbW1hbmQgK2xlZnQKCQkJCQkJaWYgKCBldmVudC5vcmlnaW5hbEV2ZW50LmFsdEtleSApIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZSggZXZlbnQudGFyZ2V0LCAoIGV2ZW50LmN0cmxLZXkgPwoJCQkJCQkJCS0kLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBCaWdNb250aHMiICkgOgoJCQkJCQkJCS0kLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInN0ZXBNb250aHMiICkgKSwgIk0iICk7CgkJCQkJCX0KCgkJCQkJCS8vIG5leHQgbW9udGgveWVhciBvbiBhbHQgK2xlZnQgb24gTWFjCgkJCQkJCWJyZWFrOwoJCQkJY2FzZSAzODogaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgKSB7CgkJCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGV2ZW50LnRhcmdldCwgLTcsICJEIiApOwoJCQkJCQl9CgkJCQkJCWhhbmRsZWQgPSBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXk7CgkJCQkJCWJyZWFrOyAvLyAtMSB3ZWVrIG9uIGN0cmwgb3IgY29tbWFuZCArdXAKCQkJCWNhc2UgMzk6IGlmICggZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5ICkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggaXNSVEwgPyAtMSA6ICsxICksICJEIiApOwoJCQkJCQl9CgkJCQkJCWhhbmRsZWQgPSBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXk7CgoJCQkJCQkvLyArMSBkYXkgb24gY3RybCBvciBjb21tYW5kICtyaWdodAoJCQkJCQlpZiAoIGV2ZW50Lm9yaWdpbmFsRXZlbnQuYWx0S2V5ICkgewoJCQkJCQkJJC5kYXRlcGlja2VyLl9hZGp1c3REYXRlKCBldmVudC50YXJnZXQsICggZXZlbnQuY3RybEtleSA\/CgkJCQkJCQkJKyQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcEJpZ01vbnRocyIgKSA6CgkJCQkJCQkJKyQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic3RlcE1vbnRocyIgKSApLCAiTSIgKTsKCQkJCQkJfQoKCQkJCQkJLy8gbmV4dCBtb250aC95ZWFyIG9uIGFsdCArcmlnaHQKCQkJCQkJYnJlYWs7CgkJCQljYXNlIDQwOiBpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHsKCQkJCQkJCSQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZSggZXZlbnQudGFyZ2V0LCArNywgIkQiICk7CgkJCQkJCX0KCQkJCQkJaGFuZGxlZCA9IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleTsKCQkJCQkJYnJlYWs7IC8vICsxIHdlZWsgb24gY3RybCBvciBjb21tYW5kICtkb3duCgkJCQlkZWZhdWx0OiBoYW5kbGVkID0gZmFsc2U7CgkJCX0KCQl9IGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09PSAzNiAmJiBldmVudC5jdHJsS2V5ICkgeyAvLyBkaXNwbGF5IHRoZSBkYXRlIHBpY2tlciBvbiBjdHJsK2hvbWUKCQkJJC5kYXRlcGlja2VyLl9zaG93RGF0ZXBpY2tlciggdGhpcyApOwoJCX0gZWxzZSB7CgkJCWhhbmRsZWQgPSBmYWxzZTsKCQl9CgoJCWlmICggaGFuZGxlZCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCgkvKiBGaWx0ZXIgZW50ZXJlZCBjaGFyYWN0ZXJzIC0gYmFzZWQgb24gZGF0ZSBmb3JtYXQuICovCglfZG9LZXlQcmVzczogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBjaGFycywgY2hyLAoJCQlpbnN0ID0gJC5kYXRlcGlja2VyLl9nZXRJbnN0KCBldmVudC50YXJnZXQgKTsKCgkJaWYgKCAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgImNvbnN0cmFpbklucHV0IiApICkgewoJCQljaGFycyA9ICQuZGF0ZXBpY2tlci5fcG9zc2libGVDaGFycyggJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApICk7CgkJCWNociA9IFN0cmluZy5mcm9tQ2hhckNvZGUoIGV2ZW50LmNoYXJDb2RlID09IG51bGwgPyBldmVudC5rZXlDb2RlIDogZXZlbnQuY2hhckNvZGUgKTsKCQkJcmV0dXJuIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCAoIGNociA8ICIgIiB8fCAhY2hhcnMgfHwgY2hhcnMuaW5kZXhPZiggY2hyICkgPiAtMSApOwoJCX0KCX0sCgoJLyogU3luY2hyb25pc2UgbWFudWFsIGVudHJ5IGFuZCBmaWVsZC9hbHRlcm5hdGUgZmllbGQuICovCglfZG9LZXlVcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBkYXRlLAoJCQlpbnN0ID0gJC5kYXRlcGlja2VyLl9nZXRJbnN0KCBldmVudC50YXJnZXQgKTsKCgkJaWYgKCBpbnN0LmlucHV0LnZhbCgpICE9PSBpbnN0Lmxhc3RWYWwgKSB7CgkJCXRyeSB7CgkJCQlkYXRlID0gJC5kYXRlcGlja2VyLnBhcnNlRGF0ZSggJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApLAoJCQkJCSggaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQudmFsKCkgOiBudWxsICksCgkJCQkJJC5kYXRlcGlja2VyLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApOwoKCQkJCWlmICggZGF0ZSApIHsgLy8gb25seSBpZiB2YWxpZAoJCQkJCSQuZGF0ZXBpY2tlci5fc2V0RGF0ZUZyb21GaWVsZCggaW5zdCApOwoJCQkJCSQuZGF0ZXBpY2tlci5fdXBkYXRlQWx0ZXJuYXRlKCBpbnN0ICk7CgkJCQkJJC5kYXRlcGlja2VyLl91cGRhdGVEYXRlcGlja2VyKCBpbnN0ICk7CgkJCQl9CgkJCX0KCQkJY2F0Y2ggKCBlcnIgKSB7CgkJCX0KCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qIFBvcC11cCB0aGUgZGF0ZSBwaWNrZXIgZm9yIGEgZ2l2ZW4gaW5wdXQgZmllbGQuCgkgKiBJZiBmYWxzZSByZXR1cm5lZCBmcm9tIGJlZm9yZVNob3cgZXZlbnQgaGFuZGxlciBkbyBub3Qgc2hvdy4KCSAqIEBwYXJhbSAgaW5wdXQgIGVsZW1lbnQgLSB0aGUgaW5wdXQgZmllbGQgYXR0YWNoZWQgdG8gdGhlIGRhdGUgcGlja2VyIG9yCgkgKgkJCQkJZXZlbnQgLSBpZiB0cmlnZ2VyZWQgYnkgZm9jdXMKCSAqLwoJX3Nob3dEYXRlcGlja2VyOiBmdW5jdGlvbiggaW5wdXQgKSB7CgkJaW5wdXQgPSBpbnB1dC50YXJnZXQgfHwgaW5wdXQ7CgkJaWYgKCBpbnB1dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiaW5wdXQiICkgeyAvLyBmaW5kIGZyb20gYnV0dG9uL2ltYWdlIHRyaWdnZXIKCQkJaW5wdXQgPSAkKCAiaW5wdXQiLCBpbnB1dC5wYXJlbnROb2RlIClbIDAgXTsKCQl9CgoJCWlmICggJC5kYXRlcGlja2VyLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggaW5wdXQgKSB8fCAkLmRhdGVwaWNrZXIuX2xhc3RJbnB1dCA9PT0gaW5wdXQgKSB7IC8vIGFscmVhZHkgaGVyZQoJCQlyZXR1cm47CgkJfQoKCQl2YXIgaW5zdCwgYmVmb3JlU2hvdywgYmVmb3JlU2hvd1NldHRpbmdzLCBpc0ZpeGVkLAoJCQlvZmZzZXQsIHNob3dBbmltLCBkdXJhdGlvbjsKCgkJaW5zdCA9ICQuZGF0ZXBpY2tlci5fZ2V0SW5zdCggaW5wdXQgKTsKCQlpZiAoICQuZGF0ZXBpY2tlci5fY3VySW5zdCAmJiAkLmRhdGVwaWNrZXIuX2N1ckluc3QgIT09IGluc3QgKSB7CgkJCSQuZGF0ZXBpY2tlci5fY3VySW5zdC5kcERpdi5zdG9wKCB0cnVlLCB0cnVlICk7CgkJCWlmICggaW5zdCAmJiAkLmRhdGVwaWNrZXIuX2RhdGVwaWNrZXJTaG93aW5nICkgewoJCQkJJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlciggJC5kYXRlcGlja2VyLl9jdXJJbnN0LmlucHV0WyAwIF0gKTsKCQkJfQoJCX0KCgkJYmVmb3JlU2hvdyA9ICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAiYmVmb3JlU2hvdyIgKTsKCQliZWZvcmVTaG93U2V0dGluZ3MgPSBiZWZvcmVTaG93ID8gYmVmb3JlU2hvdy5hcHBseSggaW5wdXQsIFsgaW5wdXQsIGluc3QgXSApIDoge307CgkJaWYgKCBiZWZvcmVTaG93U2V0dGluZ3MgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoJCWRhdGVwaWNrZXJfZXh0ZW5kUmVtb3ZlKCBpbnN0LnNldHRpbmdzLCBiZWZvcmVTaG93U2V0dGluZ3MgKTsKCgkJaW5zdC5sYXN0VmFsID0gbnVsbDsKCQkkLmRhdGVwaWNrZXIuX2xhc3RJbnB1dCA9IGlucHV0OwoJCSQuZGF0ZXBpY2tlci5fc2V0RGF0ZUZyb21GaWVsZCggaW5zdCApOwoKCQlpZiAoICQuZGF0ZXBpY2tlci5faW5EaWFsb2cgKSB7IC8vIGhpZGUgY3Vyc29yCgkJCWlucHV0LnZhbHVlID0gIiI7CgkJfQoJCWlmICggISQuZGF0ZXBpY2tlci5fcG9zICkgeyAvLyBwb3NpdGlvbiBiZWxvdyBpbnB1dAoJCQkkLmRhdGVwaWNrZXIuX3BvcyA9ICQuZGF0ZXBpY2tlci5fZmluZFBvcyggaW5wdXQgKTsKCQkJJC5kYXRlcGlja2VyLl9wb3NbIDEgXSArPSBpbnB1dC5vZmZzZXRIZWlnaHQ7IC8vIGFkZCB0aGUgaGVpZ2h0CgkJfQoKCQlpc0ZpeGVkID0gZmFsc2U7CgkJJCggaW5wdXQgKS5wYXJlbnRzKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWlzRml4ZWQgfD0gJCggdGhpcyApLmNzcyggInBvc2l0aW9uIiApID09PSAiZml4ZWQiOwoJCQlyZXR1cm4gIWlzRml4ZWQ7CgkJfSApOwoKCQlvZmZzZXQgPSB7IGxlZnQ6ICQuZGF0ZXBpY2tlci5fcG9zWyAwIF0sIHRvcDogJC5kYXRlcGlja2VyLl9wb3NbIDEgXSB9OwoJCSQuZGF0ZXBpY2tlci5fcG9zID0gbnVsbDsKCgkJLy90byBhdm9pZCBmbGFzaGVzIG9uIEZpcmVmb3gKCQlpbnN0LmRwRGl2LmVtcHR5KCk7CgoJCS8vIGRldGVybWluZSBzaXppbmcgb2Zmc2NyZWVuCgkJaW5zdC5kcERpdi5jc3MoIHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGRpc3BsYXk6ICJibG9jayIsIHRvcDogIi0xMDAwcHgiIH0gKTsKCQkkLmRhdGVwaWNrZXIuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsKCgkJLy8gZml4IHdpZHRoIGZvciBkeW5hbWljIG51bWJlciBvZiBkYXRlIHBpY2tlcnMKCQkvLyBhbmQgYWRqdXN0IHBvc2l0aW9uIGJlZm9yZSBzaG93aW5nCgkJb2Zmc2V0ID0gJC5kYXRlcGlja2VyLl9jaGVja09mZnNldCggaW5zdCwgb2Zmc2V0LCBpc0ZpeGVkICk7CgkJaW5zdC5kcERpdi5jc3MoIHsgcG9zaXRpb246ICggJC5kYXRlcGlja2VyLl9pbkRpYWxvZyAmJiAkLmJsb2NrVUkgPwoJCQkic3RhdGljIiA6ICggaXNGaXhlZCA\/ICJmaXhlZCIgOiAiYWJzb2x1dGUiICkgKSwgZGlzcGxheTogIm5vbmUiLAoJCQlsZWZ0OiBvZmZzZXQubGVmdCArICJweCIsIHRvcDogb2Zmc2V0LnRvcCArICJweCIgfSApOwoKCQlpZiAoICFpbnN0LmlubGluZSApIHsKCQkJc2hvd0FuaW0gPSAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgInNob3dBbmltIiApOwoJCQlkdXJhdGlvbiA9ICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAiZHVyYXRpb24iICk7CgkJCWluc3QuZHBEaXYuY3NzKCAiei1pbmRleCIsIGRhdGVwaWNrZXJfZ2V0WmluZGV4KCAkKCBpbnB1dCApICkgKyAxICk7CgkJCSQuZGF0ZXBpY2tlci5fZGF0ZXBpY2tlclNob3dpbmcgPSB0cnVlOwoKCQkJaWYgKCAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgc2hvd0FuaW0gXSApIHsKCQkJCWluc3QuZHBEaXYuc2hvdyggc2hvd0FuaW0sICQuZGF0ZXBpY2tlci5fZ2V0KCBpbnN0LCAic2hvd09wdGlvbnMiICksIGR1cmF0aW9uICk7CgkJCX0gZWxzZSB7CgkJCQlpbnN0LmRwRGl2WyBzaG93QW5pbSB8fCAic2hvdyIgXSggc2hvd0FuaW0gPyBkdXJhdGlvbiA6IG51bGwgKTsKCQkJfQoKCQkJaWYgKCAkLmRhdGVwaWNrZXIuX3Nob3VsZEZvY3VzSW5wdXQoIGluc3QgKSApIHsKCQkJCWluc3QuaW5wdXQudHJpZ2dlciggImZvY3VzIiApOwoJCQl9CgoJCQkkLmRhdGVwaWNrZXIuX2N1ckluc3QgPSBpbnN0OwoJCX0KCX0sCgoJLyogR2VuZXJhdGUgdGhlIGRhdGUgcGlja2VyIGNvbnRlbnQuICovCglfdXBkYXRlRGF0ZXBpY2tlcjogZnVuY3Rpb24oIGluc3QgKSB7CgkJdGhpcy5tYXhSb3dzID0gNDsgLy9SZXNldCB0aGUgbWF4IG51bWJlciBvZiByb3dzIGJlaW5nIGRpc3BsYXllZCAoc2VlICM3MDQzKQoJCWRhdGVwaWNrZXJfaW5zdEFjdGl2ZSA9IGluc3Q7IC8vIGZvciBkZWxlZ2F0ZSBob3ZlciBldmVudHMKCQlpbnN0LmRwRGl2LmVtcHR5KCkuYXBwZW5kKCB0aGlzLl9nZW5lcmF0ZUhUTUwoIGluc3QgKSApOwoJCXRoaXMuX2F0dGFjaEhhbmRsZXJzKCBpbnN0ICk7CgoJCXZhciBvcmlneWVhcnNodG1sLAoJCQludW1Nb250aHMgPSB0aGlzLl9nZXROdW1iZXJPZk1vbnRocyggaW5zdCApLAoJCQljb2xzID0gbnVtTW9udGhzWyAxIF0sCgkJCXdpZHRoID0gMTcsCgkJCWFjdGl2ZUNlbGwgPSBpbnN0LmRwRGl2LmZpbmQoICIuIiArIHRoaXMuX2RheU92ZXJDbGFzcyArICIgYSIgKTsKCgkJaWYgKCBhY3RpdmVDZWxsLmxlbmd0aCA+IDAgKSB7CgkJCWRhdGVwaWNrZXJfaGFuZGxlTW91c2VvdmVyLmFwcGx5KCBhY3RpdmVDZWxsLmdldCggMCApICk7CgkJfQoKCQlpbnN0LmRwRGl2LnJlbW92ZUNsYXNzKCAidWktZGF0ZXBpY2tlci1tdWx0aS0yIHVpLWRhdGVwaWNrZXItbXVsdGktMyB1aS1kYXRlcGlja2VyLW11bHRpLTQiICkud2lkdGgoICIiICk7CgkJaWYgKCBjb2xzID4gMSApIHsKCQkJaW5zdC5kcERpdi5hZGRDbGFzcyggInVpLWRhdGVwaWNrZXItbXVsdGktIiArIGNvbHMgKS5jc3MoICJ3aWR0aCIsICggd2lkdGggKiBjb2xzICkgKyAiZW0iICk7CgkJfQoJCWluc3QuZHBEaXZbICggbnVtTW9udGhzWyAwIF0gIT09IDEgfHwgbnVtTW9udGhzWyAxIF0gIT09IDEgPyAiYWRkIiA6ICJyZW1vdmUiICkgKwoJCQkiQ2xhc3MiIF0oICJ1aS1kYXRlcGlja2VyLW11bHRpIiApOwoJCWluc3QuZHBEaXZbICggdGhpcy5fZ2V0KCBpbnN0LCAiaXNSVEwiICkgPyAiYWRkIiA6ICJyZW1vdmUiICkgKwoJCQkiQ2xhc3MiIF0oICJ1aS1kYXRlcGlja2VyLXJ0bCIgKTsKCgkJaWYgKCBpbnN0ID09PSAkLmRhdGVwaWNrZXIuX2N1ckluc3QgJiYgJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyAmJiAkLmRhdGVwaWNrZXIuX3Nob3VsZEZvY3VzSW5wdXQoIGluc3QgKSApIHsKCQkJaW5zdC5pbnB1dC50cmlnZ2VyKCAiZm9jdXMiICk7CgkJfQoKCQkvLyBEZWZmZXJlZCByZW5kZXIgb2YgdGhlIHllYXJzIHNlbGVjdCAodG8gYXZvaWQgZmxhc2hlcyBvbiBGaXJlZm94KQoJCWlmICggaW5zdC55ZWFyc2h0bWwgKSB7CgkJCW9yaWd5ZWFyc2h0bWwgPSBpbnN0LnllYXJzaHRtbDsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgoJCQkJLy9hc3N1cmUgdGhhdCBpbnN0LnllYXJzaHRtbCBkaWRuJ3QgY2hhbmdlLgoJCQkJaWYgKCBvcmlneWVhcnNodG1sID09PSBpbnN0LnllYXJzaHRtbCAmJiBpbnN0LnllYXJzaHRtbCApIHsKCQkJCQlpbnN0LmRwRGl2LmZpbmQoICJzZWxlY3QudWktZGF0ZXBpY2tlci15ZWFyOmZpcnN0IiApLnJlcGxhY2VXaXRoKCBpbnN0LnllYXJzaHRtbCApOwoJCQkJfQoJCQkJb3JpZ3llYXJzaHRtbCA9IGluc3QueWVhcnNodG1sID0gbnVsbDsKCQkJfSwgMCApOwoJCX0KCX0sCgoJLy8gIzY2OTQgLSBkb24ndCBmb2N1cyB0aGUgaW5wdXQgaWYgaXQncyBhbHJlYWR5IGZvY3VzZWQKCS8vIHRoaXMgYnJlYWtzIHRoZSBjaGFuZ2UgZXZlbnQgaW4gSUUKCS8vIFN1cHBvcnQ6IElFIGFuZCBqUXVlcnkgPDEuOQoJX3Nob3VsZEZvY3VzSW5wdXQ6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXJldHVybiBpbnN0LmlucHV0ICYmIGluc3QuaW5wdXQuaXMoICI6dmlzaWJsZSIgKSAmJiAhaW5zdC5pbnB1dC5pcyggIjpkaXNhYmxlZCIgKSAmJiAhaW5zdC5pbnB1dC5pcyggIjpmb2N1cyIgKTsKCX0sCgoJLyogQ2hlY2sgcG9zaXRpb25pbmcgdG8gcmVtYWluIG9uIHNjcmVlbi4gKi8KCV9jaGVja09mZnNldDogZnVuY3Rpb24oIGluc3QsIG9mZnNldCwgaXNGaXhlZCApIHsKCQl2YXIgZHBXaWR0aCA9IGluc3QuZHBEaXYub3V0ZXJXaWR0aCgpLAoJCQlkcEhlaWdodCA9IGluc3QuZHBEaXYub3V0ZXJIZWlnaHQoKSwKCQkJaW5wdXRXaWR0aCA9IGluc3QuaW5wdXQgPyBpbnN0LmlucHV0Lm91dGVyV2lkdGgoKSA6IDAsCgkJCWlucHV0SGVpZ2h0ID0gaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQub3V0ZXJIZWlnaHQoKSA6IDAsCgkJCXZpZXdXaWR0aCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCArICggaXNGaXhlZCA\/IDAgOiAkKCBkb2N1bWVudCApLnNjcm9sbExlZnQoKSApLAoJCQl2aWV3SGVpZ2h0ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCArICggaXNGaXhlZCA\/IDAgOiAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCgpICk7CgoJCW9mZnNldC5sZWZ0IC09ICggdGhpcy5fZ2V0KCBpbnN0LCAiaXNSVEwiICkgPyAoIGRwV2lkdGggLSBpbnB1dFdpZHRoICkgOiAwICk7CgkJb2Zmc2V0LmxlZnQgLT0gKCBpc0ZpeGVkICYmIG9mZnNldC5sZWZ0ID09PSBpbnN0LmlucHV0Lm9mZnNldCgpLmxlZnQgKSA\/ICQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgpIDogMDsKCQlvZmZzZXQudG9wIC09ICggaXNGaXhlZCAmJiBvZmZzZXQudG9wID09PSAoIGluc3QuaW5wdXQub2Zmc2V0KCkudG9wICsgaW5wdXRIZWlnaHQgKSApID8gJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSA6IDA7CgoJCS8vIE5vdyBjaGVjayBpZiBkYXRlcGlja2VyIGlzIHNob3dpbmcgb3V0c2lkZSB3aW5kb3cgdmlld3BvcnQgLSBtb3ZlIHRvIGEgYmV0dGVyIHBsYWNlIGlmIHNvLgoJCW9mZnNldC5sZWZ0IC09IE1hdGgubWluKCBvZmZzZXQubGVmdCwgKCBvZmZzZXQubGVmdCArIGRwV2lkdGggPiB2aWV3V2lkdGggJiYgdmlld1dpZHRoID4gZHBXaWR0aCApID8KCQkJTWF0aC5hYnMoIG9mZnNldC5sZWZ0ICsgZHBXaWR0aCAtIHZpZXdXaWR0aCApIDogMCApOwoJCW9mZnNldC50b3AgLT0gTWF0aC5taW4oIG9mZnNldC50b3AsICggb2Zmc2V0LnRvcCArIGRwSGVpZ2h0ID4gdmlld0hlaWdodCAmJiB2aWV3SGVpZ2h0ID4gZHBIZWlnaHQgKSA\/CgkJCU1hdGguYWJzKCBkcEhlaWdodCArIGlucHV0SGVpZ2h0ICkgOiAwICk7CgoJCXJldHVybiBvZmZzZXQ7Cgl9LAoKCS8qIEZpbmQgYW4gb2JqZWN0J3MgcG9zaXRpb24gb24gdGhlIHNjcmVlbi4gKi8KCV9maW5kUG9zOiBmdW5jdGlvbiggb2JqICkgewoJCXZhciBwb3NpdGlvbiwKCQkJaW5zdCA9IHRoaXMuX2dldEluc3QoIG9iaiApLAoJCQlpc1JUTCA9IHRoaXMuX2dldCggaW5zdCwgImlzUlRMIiApOwoKCQl3aGlsZSAoIG9iaiAmJiAoIG9iai50eXBlID09PSAiaGlkZGVuIiB8fCBvYmoubm9kZVR5cGUgIT09IDEgfHwgJC5leHByLmZpbHRlcnMuaGlkZGVuKCBvYmogKSApICkgewoJCQlvYmogPSBvYmpbIGlzUlRMID8gInByZXZpb3VzU2libGluZyIgOiAibmV4dFNpYmxpbmciIF07CgkJfQoKCQlwb3NpdGlvbiA9ICQoIG9iaiApLm9mZnNldCgpOwoJCXJldHVybiBbIHBvc2l0aW9uLmxlZnQsIHBvc2l0aW9uLnRvcCBdOwoJfSwKCgkvKiBIaWRlIHRoZSBkYXRlIHBpY2tlciBmcm9tIHZpZXcuCgkgKiBAcGFyYW0gIGlucHV0ICBlbGVtZW50IC0gdGhlIGlucHV0IGZpZWxkIGF0dGFjaGVkIHRvIHRoZSBkYXRlIHBpY2tlcgoJICovCglfaGlkZURhdGVwaWNrZXI6IGZ1bmN0aW9uKCBpbnB1dCApIHsKCQl2YXIgc2hvd0FuaW0sIGR1cmF0aW9uLCBwb3N0UHJvY2Vzcywgb25DbG9zZSwKCQkJaW5zdCA9IHRoaXMuX2N1ckluc3Q7CgoJCWlmICggIWluc3QgfHwgKCBpbnB1dCAmJiBpbnN0ICE9PSAkLmRhdGEoIGlucHV0LCAiZGF0ZXBpY2tlciIgKSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuX2RhdGVwaWNrZXJTaG93aW5nICkgewoJCQlzaG93QW5pbSA9IHRoaXMuX2dldCggaW5zdCwgInNob3dBbmltIiApOwoJCQlkdXJhdGlvbiA9IHRoaXMuX2dldCggaW5zdCwgImR1cmF0aW9uIiApOwoJCQlwb3N0UHJvY2VzcyA9IGZ1bmN0aW9uKCkgewoJCQkJJC5kYXRlcGlja2VyLl90aWR5RGlhbG9nKCBpbnN0ICk7CgkJCX07CgoJCQkvLyBERVBSRUNBVEVEOiBhZnRlciBCQyBmb3IgMS44LnggJC5lZmZlY3RzWyBzaG93QW5pbSBdIGlzIG5vdCBuZWVkZWQKCQkJaWYgKCAkLmVmZmVjdHMgJiYgKCAkLmVmZmVjdHMuZWZmZWN0WyBzaG93QW5pbSBdIHx8ICQuZWZmZWN0c1sgc2hvd0FuaW0gXSApICkgewoJCQkJaW5zdC5kcERpdi5oaWRlKCBzaG93QW5pbSwgJC5kYXRlcGlja2VyLl9nZXQoIGluc3QsICJzaG93T3B0aW9ucyIgKSwgZHVyYXRpb24sIHBvc3RQcm9jZXNzICk7CgkJCX0gZWxzZSB7CgkJCQlpbnN0LmRwRGl2WyAoIHNob3dBbmltID09PSAic2xpZGVEb3duIiA\/ICJzbGlkZVVwIiA6CgkJCQkJKCBzaG93QW5pbSA9PT0gImZhZGVJbiIgPyAiZmFkZU91dCIgOiAiaGlkZSIgKSApIF0oICggc2hvd0FuaW0gPyBkdXJhdGlvbiA6IG51bGwgKSwgcG9zdFByb2Nlc3MgKTsKCQkJfQoKCQkJaWYgKCAhc2hvd0FuaW0gKSB7CgkJCQlwb3N0UHJvY2VzcygpOwoJCQl9CgkJCXRoaXMuX2RhdGVwaWNrZXJTaG93aW5nID0gZmFsc2U7CgoJCQlvbkNsb3NlID0gdGhpcy5fZ2V0KCBpbnN0LCAib25DbG9zZSIgKTsKCQkJaWYgKCBvbkNsb3NlICkgewoJCQkJb25DbG9zZS5hcHBseSggKCBpbnN0LmlucHV0ID8gaW5zdC5pbnB1dFsgMCBdIDogbnVsbCApLCBbICggaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQudmFsKCkgOiAiIiApLCBpbnN0IF0gKTsKCQkJfQoKCQkJdGhpcy5fbGFzdElucHV0ID0gbnVsbDsKCQkJaWYgKCB0aGlzLl9pbkRpYWxvZyApIHsKCQkJCXRoaXMuX2RpYWxvZ0lucHV0LmNzcyggeyBwb3NpdGlvbjogImFic29sdXRlIiwgbGVmdDogIjAiLCB0b3A6ICItMTAwcHgiIH0gKTsKCQkJCWlmICggJC5ibG9ja1VJICkgewoJCQkJCSQudW5ibG9ja1VJKCk7CgkJCQkJJCggImJvZHkiICkuYXBwZW5kKCB0aGlzLmRwRGl2ICk7CgkJCQl9CgkJCX0KCQkJdGhpcy5faW5EaWFsb2cgPSBmYWxzZTsKCQl9Cgl9LAoKCS8qIFRpZHkgdXAgYWZ0ZXIgYSBkaWFsb2cgZGlzcGxheS4gKi8KCV90aWR5RGlhbG9nOiBmdW5jdGlvbiggaW5zdCApIHsKCQlpbnN0LmRwRGl2LnJlbW92ZUNsYXNzKCB0aGlzLl9kaWFsb2dDbGFzcyApLm9mZiggIi51aS1kYXRlcGlja2VyLWNhbGVuZGFyIiApOwoJfSwKCgkvKiBDbG9zZSBkYXRlIHBpY2tlciBpZiBjbGlja2VkIGVsc2V3aGVyZS4gKi8KCV9jaGVja0V4dGVybmFsQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoICEkLmRhdGVwaWNrZXIuX2N1ckluc3QgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCWluc3QgPSAkLmRhdGVwaWNrZXIuX2dldEluc3QoICR0YXJnZXRbIDAgXSApOwoKCQlpZiAoICggKCAkdGFyZ2V0WyAwIF0uaWQgIT09ICQuZGF0ZXBpY2tlci5fbWFpbkRpdklkICYmCgkJCQkkdGFyZ2V0LnBhcmVudHMoICIjIiArICQuZGF0ZXBpY2tlci5fbWFpbkRpdklkICkubGVuZ3RoID09PSAwICYmCgkJCQkhJHRhcmdldC5oYXNDbGFzcyggJC5kYXRlcGlja2VyLm1hcmtlckNsYXNzTmFtZSApICYmCgkJCQkhJHRhcmdldC5jbG9zZXN0KCAiLiIgKyAkLmRhdGVwaWNrZXIuX3RyaWdnZXJDbGFzcyApLmxlbmd0aCAmJgoJCQkJJC5kYXRlcGlja2VyLl9kYXRlcGlja2VyU2hvd2luZyAmJiAhKCAkLmRhdGVwaWNrZXIuX2luRGlhbG9nICYmICQuYmxvY2tVSSApICkgKSB8fAoJCQkoICR0YXJnZXQuaGFzQ2xhc3MoICQuZGF0ZXBpY2tlci5tYXJrZXJDbGFzc05hbWUgKSAmJiAkLmRhdGVwaWNrZXIuX2N1ckluc3QgIT09IGluc3QgKSApIHsKCQkJCSQuZGF0ZXBpY2tlci5faGlkZURhdGVwaWNrZXIoKTsKCQl9Cgl9LAoKCS8qIEFkanVzdCBvbmUgb2YgdGhlIGRhdGUgc3ViLWZpZWxkcy4gKi8KCV9hZGp1c3REYXRlOiBmdW5jdGlvbiggaWQsIG9mZnNldCwgcGVyaW9kICkgewoJCXZhciB0YXJnZXQgPSAkKCBpZCApLAoJCQlpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0WyAwIF0gKTsKCgkJaWYgKCB0aGlzLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggdGFyZ2V0WyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9hZGp1c3RJbnN0RGF0ZSggaW5zdCwgb2Zmc2V0ICsKCQkJKCBwZXJpb2QgPT09ICJNIiA\/IHRoaXMuX2dldCggaW5zdCwgInNob3dDdXJyZW50QXRQb3MiICkgOiAwICksIC8vIHVuZG8gcG9zaXRpb25pbmcKCQkJcGVyaW9kICk7CgkJdGhpcy5fdXBkYXRlRGF0ZXBpY2tlciggaW5zdCApOwoJfSwKCgkvKiBBY3Rpb24gZm9yIGN1cnJlbnQgbGluay4gKi8KCV9nb3RvVG9kYXk6IGZ1bmN0aW9uKCBpZCApIHsKCQl2YXIgZGF0ZSwKCQkJdGFyZ2V0ID0gJCggaWQgKSwKCQkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldFsgMCBdICk7CgoJCWlmICggdGhpcy5fZ2V0KCBpbnN0LCAiZ290b0N1cnJlbnQiICkgJiYgaW5zdC5jdXJyZW50RGF5ICkgewoJCQlpbnN0LnNlbGVjdGVkRGF5ID0gaW5zdC5jdXJyZW50RGF5OwoJCQlpbnN0LmRyYXdNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCA9IGluc3QuY3VycmVudE1vbnRoOwoJCQlpbnN0LmRyYXdZZWFyID0gaW5zdC5zZWxlY3RlZFllYXIgPSBpbnN0LmN1cnJlbnRZZWFyOwoJCX0gZWxzZSB7CgkJCWRhdGUgPSBuZXcgRGF0ZSgpOwoJCQlpbnN0LnNlbGVjdGVkRGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJCWluc3QuZHJhd01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoID0gZGF0ZS5nZXRNb250aCgpOwoJCQlpbnN0LmRyYXdZZWFyID0gaW5zdC5zZWxlY3RlZFllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7CgkJfQoJCXRoaXMuX25vdGlmeUNoYW5nZSggaW5zdCApOwoJCXRoaXMuX2FkanVzdERhdGUoIHRhcmdldCApOwoJfSwKCgkvKiBBY3Rpb24gZm9yIHNlbGVjdGluZyBhIG5ldyBtb250aC95ZWFyLiAqLwoJX3NlbGVjdE1vbnRoWWVhcjogZnVuY3Rpb24oIGlkLCBzZWxlY3QsIHBlcmlvZCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggaWQgKSwKCQkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldFsgMCBdICk7CgoJCWluc3RbICJzZWxlY3RlZCIgKyAoIHBlcmlvZCA9PT0gIk0iID8gIk1vbnRoIiA6ICJZZWFyIiApIF0gPQoJCWluc3RbICJkcmF3IiArICggcGVyaW9kID09PSAiTSIgPyAiTW9udGgiIDogIlllYXIiICkgXSA9CgkJCXBhcnNlSW50KCBzZWxlY3Qub3B0aW9uc1sgc2VsZWN0LnNlbGVjdGVkSW5kZXggXS52YWx1ZSwgMTAgKTsKCgkJdGhpcy5fbm90aWZ5Q2hhbmdlKCBpbnN0ICk7CgkJdGhpcy5fYWRqdXN0RGF0ZSggdGFyZ2V0ICk7Cgl9LAoKCS8qIEFjdGlvbiBmb3Igc2VsZWN0aW5nIGEgZGF5LiAqLwoJX3NlbGVjdERheTogZnVuY3Rpb24oIGlkLCBtb250aCwgeWVhciwgdGQgKSB7CgkJdmFyIGluc3QsCgkJCXRhcmdldCA9ICQoIGlkICk7CgoJCWlmICggJCggdGQgKS5oYXNDbGFzcyggdGhpcy5fdW5zZWxlY3RhYmxlQ2xhc3MgKSB8fCB0aGlzLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggdGFyZ2V0WyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaW5zdCA9IHRoaXMuX2dldEluc3QoIHRhcmdldFsgMCBdICk7CgkJaW5zdC5zZWxlY3RlZERheSA9IGluc3QuY3VycmVudERheSA9ICQoICJhIiwgdGQgKS5odG1sKCk7CgkJaW5zdC5zZWxlY3RlZE1vbnRoID0gaW5zdC5jdXJyZW50TW9udGggPSBtb250aDsKCQlpbnN0LnNlbGVjdGVkWWVhciA9IGluc3QuY3VycmVudFllYXIgPSB5ZWFyOwoJCXRoaXMuX3NlbGVjdERhdGUoIGlkLCB0aGlzLl9mb3JtYXREYXRlKCBpbnN0LAoJCQlpbnN0LmN1cnJlbnREYXksIGluc3QuY3VycmVudE1vbnRoLCBpbnN0LmN1cnJlbnRZZWFyICkgKTsKCX0sCgoJLyogRXJhc2UgdGhlIGlucHV0IGZpZWxkIGFuZCBoaWRlIHRoZSBkYXRlIHBpY2tlci4gKi8KCV9jbGVhckRhdGU6IGZ1bmN0aW9uKCBpZCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggaWQgKTsKCQl0aGlzLl9zZWxlY3REYXRlKCB0YXJnZXQsICIiICk7Cgl9LAoKCS8qIFVwZGF0ZSB0aGUgaW5wdXQgZmllbGQgd2l0aCB0aGUgc2VsZWN0ZWQgZGF0ZS4gKi8KCV9zZWxlY3REYXRlOiBmdW5jdGlvbiggaWQsIGRhdGVTdHIgKSB7CgkJdmFyIG9uU2VsZWN0LAoJCQl0YXJnZXQgPSAkKCBpZCApLAoJCQlpbnN0ID0gdGhpcy5fZ2V0SW5zdCggdGFyZ2V0WyAwIF0gKTsKCgkJZGF0ZVN0ciA9ICggZGF0ZVN0ciAhPSBudWxsID8gZGF0ZVN0ciA6IHRoaXMuX2Zvcm1hdERhdGUoIGluc3QgKSApOwoJCWlmICggaW5zdC5pbnB1dCApIHsKCQkJaW5zdC5pbnB1dC52YWwoIGRhdGVTdHIgKTsKCQl9CgkJdGhpcy5fdXBkYXRlQWx0ZXJuYXRlKCBpbnN0ICk7CgoJCW9uU2VsZWN0ID0gdGhpcy5fZ2V0KCBpbnN0LCAib25TZWxlY3QiICk7CgkJaWYgKCBvblNlbGVjdCApIHsKCQkJb25TZWxlY3QuYXBwbHkoICggaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXRbIDAgXSA6IG51bGwgKSwgWyBkYXRlU3RyLCBpbnN0IF0gKTsgIC8vIHRyaWdnZXIgY3VzdG9tIGNhbGxiYWNrCgkJfSBlbHNlIGlmICggaW5zdC5pbnB1dCApIHsKCQkJaW5zdC5pbnB1dC50cmlnZ2VyKCAiY2hhbmdlIiApOyAvLyBmaXJlIHRoZSBjaGFuZ2UgZXZlbnQKCQl9CgoJCWlmICggaW5zdC5pbmxpbmUgKSB7CgkJCXRoaXMuX3VwZGF0ZURhdGVwaWNrZXIoIGluc3QgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQl0aGlzLl9sYXN0SW5wdXQgPSBpbnN0LmlucHV0WyAwIF07CgkJCWlmICggdHlwZW9mKCBpbnN0LmlucHV0WyAwIF0gKSAhPT0gIm9iamVjdCIgKSB7CgkJCQlpbnN0LmlucHV0LnRyaWdnZXIoICJmb2N1cyIgKTsgLy8gcmVzdG9yZSBmb2N1cwoJCQl9CgkJCXRoaXMuX2xhc3RJbnB1dCA9IG51bGw7CgkJfQoJfSwKCgkvKiBVcGRhdGUgYW55IGFsdGVybmF0ZSBmaWVsZCB0byBzeW5jaHJvbmlzZSB3aXRoIHRoZSBtYWluIGZpZWxkLiAqLwoJX3VwZGF0ZUFsdGVybmF0ZTogZnVuY3Rpb24oIGluc3QgKSB7CgkJdmFyIGFsdEZvcm1hdCwgZGF0ZSwgZGF0ZVN0ciwKCQkJYWx0RmllbGQgPSB0aGlzLl9nZXQoIGluc3QsICJhbHRGaWVsZCIgKTsKCgkJaWYgKCBhbHRGaWVsZCApIHsgLy8gdXBkYXRlIGFsdGVybmF0ZSBmaWVsZCB0b28KCQkJYWx0Rm9ybWF0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiYWx0Rm9ybWF0IiApIHx8IHRoaXMuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICk7CgkJCWRhdGUgPSB0aGlzLl9nZXREYXRlKCBpbnN0ICk7CgkJCWRhdGVTdHIgPSB0aGlzLmZvcm1hdERhdGUoIGFsdEZvcm1hdCwgZGF0ZSwgdGhpcy5fZ2V0Rm9ybWF0Q29uZmlnKCBpbnN0ICkgKTsKCQkJJCggYWx0RmllbGQgKS52YWwoIGRhdGVTdHIgKTsKCQl9Cgl9LAoKCS8qIFNldCBhcyBiZWZvcmVTaG93RGF5IGZ1bmN0aW9uIHRvIHByZXZlbnQgc2VsZWN0aW9uIG9mIHdlZWtlbmRzLgoJICogQHBhcmFtICBkYXRlICBEYXRlIC0gdGhlIGRhdGUgdG8gY3VzdG9taXNlCgkgKiBAcmV0dXJuIFtib29sZWFuLCBzdHJpbmddIC0gaXMgdGhpcyBkYXRlIHNlbGVjdGFibGU\/LCB3aGF0IGlzIGl0cyBDU1MgY2xhc3M\/CgkgKi8KCW5vV2Vla2VuZHM6IGZ1bmN0aW9uKCBkYXRlICkgewoJCXZhciBkYXkgPSBkYXRlLmdldERheSgpOwoJCXJldHVybiBbICggZGF5ID4gMCAmJiBkYXkgPCA2ICksICIiIF07Cgl9LAoKCS8qIFNldCBhcyBjYWxjdWxhdGVXZWVrIHRvIGRldGVybWluZSB0aGUgd2VlayBvZiB0aGUgeWVhciBiYXNlZCBvbiB0aGUgSVNPIDg2MDEgZGVmaW5pdGlvbi4KCSAqIEBwYXJhbSAgZGF0ZSAgRGF0ZSAtIHRoZSBkYXRlIHRvIGdldCB0aGUgd2VlayBmb3IKCSAqIEByZXR1cm4gIG51bWJlciAtIHRoZSBudW1iZXIgb2YgdGhlIHdlZWsgd2l0aGluIHRoZSB5ZWFyIHRoYXQgY29udGFpbnMgdGhpcyBkYXRlCgkgKi8KCWlzbzg2MDFXZWVrOiBmdW5jdGlvbiggZGF0ZSApIHsKCQl2YXIgdGltZSwKCQkJY2hlY2tEYXRlID0gbmV3IERhdGUoIGRhdGUuZ2V0VGltZSgpICk7CgoJCS8vIEZpbmQgVGh1cnNkYXkgb2YgdGhpcyB3ZWVrIHN0YXJ0aW5nIG9uIE1vbmRheQoJCWNoZWNrRGF0ZS5zZXREYXRlKCBjaGVja0RhdGUuZ2V0RGF0ZSgpICsgNCAtICggY2hlY2tEYXRlLmdldERheSgpIHx8IDcgKSApOwoKCQl0aW1lID0gY2hlY2tEYXRlLmdldFRpbWUoKTsKCQljaGVja0RhdGUuc2V0TW9udGgoIDAgKTsgLy8gQ29tcGFyZSB3aXRoIEphbiAxCgkJY2hlY2tEYXRlLnNldERhdGUoIDEgKTsKCQlyZXR1cm4gTWF0aC5mbG9vciggTWF0aC5yb3VuZCggKCB0aW1lIC0gY2hlY2tEYXRlICkgLyA4NjQwMDAwMCApIC8gNyApICsgMTsKCX0sCgoJLyogUGFyc2UgYSBzdHJpbmcgdmFsdWUgaW50byBhIGRhdGUgb2JqZWN0LgoJICogU2VlIGZvcm1hdERhdGUgYmVsb3cgZm9yIHRoZSBwb3NzaWJsZSBmb3JtYXRzLgoJICoKCSAqIEBwYXJhbSAgZm9ybWF0IHN0cmluZyAtIHRoZSBleHBlY3RlZCBmb3JtYXQgb2YgdGhlIGRhdGUKCSAqIEBwYXJhbSAgdmFsdWUgc3RyaW5nIC0gdGhlIGRhdGUgaW4gdGhlIGFib3ZlIGZvcm1hdAoJICogQHBhcmFtICBzZXR0aW5ncyBPYmplY3QgLSBhdHRyaWJ1dGVzIGluY2x1ZGU6CgkgKgkJCQkJc2hvcnRZZWFyQ3V0b2ZmICBudW1iZXIgLSB0aGUgY3V0b2ZmIHllYXIgZm9yIGRldGVybWluaW5nIHRoZSBjZW50dXJ5IChvcHRpb25hbCkKCSAqCQkJCQlkYXlOYW1lc1Nob3J0CXN0cmluZ1s3XSAtIGFiYnJldmlhdGVkIG5hbWVzIG9mIHRoZSBkYXlzIGZyb20gU3VuZGF5IChvcHRpb25hbCkKCSAqCQkJCQlkYXlOYW1lcwkJc3RyaW5nWzddIC0gbmFtZXMgb2YgdGhlIGRheXMgZnJvbSBTdW5kYXkgKG9wdGlvbmFsKQoJICoJCQkJCW1vbnRoTmFtZXNTaG9ydCBzdHJpbmdbMTJdIC0gYWJicmV2aWF0ZWQgbmFtZXMgb2YgdGhlIG1vbnRocyAob3B0aW9uYWwpCgkgKgkJCQkJbW9udGhOYW1lcwkJc3RyaW5nWzEyXSAtIG5hbWVzIG9mIHRoZSBtb250aHMgKG9wdGlvbmFsKQoJICogQHJldHVybiAgRGF0ZSAtIHRoZSBleHRyYWN0ZWQgZGF0ZSB2YWx1ZSBvciBudWxsIGlmIHZhbHVlIGlzIGJsYW5rCgkgKi8KCXBhcnNlRGF0ZTogZnVuY3Rpb24oIGZvcm1hdCwgdmFsdWUsIHNldHRpbmdzICkgewoJCWlmICggZm9ybWF0ID09IG51bGwgfHwgdmFsdWUgPT0gbnVsbCApIHsKCQkJdGhyb3cgIkludmFsaWQgYXJndW1lbnRzIjsKCQl9CgoJCXZhbHVlID0gKCB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiID8gdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlICsgIiIgKTsKCQlpZiAoIHZhbHVlID09PSAiIiApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQl2YXIgaUZvcm1hdCwgZGltLCBleHRyYSwKCQkJaVZhbHVlID0gMCwKCQkJc2hvcnRZZWFyQ3V0b2ZmVGVtcCA9ICggc2V0dGluZ3MgPyBzZXR0aW5ncy5zaG9ydFllYXJDdXRvZmYgOiBudWxsICkgfHwgdGhpcy5fZGVmYXVsdHMuc2hvcnRZZWFyQ3V0b2ZmLAoJCQlzaG9ydFllYXJDdXRvZmYgPSAoIHR5cGVvZiBzaG9ydFllYXJDdXRvZmZUZW1wICE9PSAic3RyaW5nIiA\/IHNob3J0WWVhckN1dG9mZlRlbXAgOgoJCQkJbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpICUgMTAwICsgcGFyc2VJbnQoIHNob3J0WWVhckN1dG9mZlRlbXAsIDEwICkgKSwKCQkJZGF5TmFtZXNTaG9ydCA9ICggc2V0dGluZ3MgPyBzZXR0aW5ncy5kYXlOYW1lc1Nob3J0IDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLmRheU5hbWVzU2hvcnQsCgkJCWRheU5hbWVzID0gKCBzZXR0aW5ncyA\/IHNldHRpbmdzLmRheU5hbWVzIDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLmRheU5hbWVzLAoJCQltb250aE5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lc1Nob3J0IDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXNTaG9ydCwKCQkJbW9udGhOYW1lcyA9ICggc2V0dGluZ3MgPyBzZXR0aW5ncy5tb250aE5hbWVzIDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXMsCgkJCXllYXIgPSAtMSwKCQkJbW9udGggPSAtMSwKCQkJZGF5ID0gLTEsCgkJCWRveSA9IC0xLAoJCQlsaXRlcmFsID0gZmFsc2UsCgkJCWRhdGUsCgoJCQkvLyBDaGVjayB3aGV0aGVyIGEgZm9ybWF0IGNoYXJhY3RlciBpcyBkb3VibGVkCgkJCWxvb2tBaGVhZCA9IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJCXZhciBtYXRjaGVzID0gKCBpRm9ybWF0ICsgMSA8IGZvcm1hdC5sZW5ndGggJiYgZm9ybWF0LmNoYXJBdCggaUZvcm1hdCArIDEgKSA9PT0gbWF0Y2ggKTsKCQkJCWlmICggbWF0Y2hlcyApIHsKCQkJCQlpRm9ybWF0Kys7CgkJCQl9CgkJCQlyZXR1cm4gbWF0Y2hlczsKCQkJfSwKCgkJCS8vIEV4dHJhY3QgYSBudW1iZXIgZnJvbSB0aGUgc3RyaW5nIHZhbHVlCgkJCWdldE51bWJlciA9IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJCXZhciBpc0RvdWJsZWQgPSBsb29rQWhlYWQoIG1hdGNoICksCgkJCQkJc2l6ZSA9ICggbWF0Y2ggPT09ICJAIiA\/IDE0IDogKCBtYXRjaCA9PT0gIiEiID8gMjAgOgoJCQkJCSggbWF0Y2ggPT09ICJ5IiAmJiBpc0RvdWJsZWQgPyA0IDogKCBtYXRjaCA9PT0gIm8iID8gMyA6IDIgKSApICkgKSwKCQkJCQltaW5TaXplID0gKCBtYXRjaCA9PT0gInkiID8gc2l6ZSA6IDEgKSwKCQkJCQlkaWdpdHMgPSBuZXcgUmVnRXhwKCAiXlxcZHsiICsgbWluU2l6ZSArICIsIiArIHNpemUgKyAifSIgKSwKCQkJCQludW0gPSB2YWx1ZS5zdWJzdHJpbmcoIGlWYWx1ZSApLm1hdGNoKCBkaWdpdHMgKTsKCQkJCWlmICggIW51bSApIHsKCQkJCQl0aHJvdyAiTWlzc2luZyBudW1iZXIgYXQgcG9zaXRpb24gIiArIGlWYWx1ZTsKCQkJCX0KCQkJCWlWYWx1ZSArPSBudW1bIDAgXS5sZW5ndGg7CgkJCQlyZXR1cm4gcGFyc2VJbnQoIG51bVsgMCBdLCAxMCApOwoJCQl9LAoKCQkJLy8gRXh0cmFjdCBhIG5hbWUgZnJvbSB0aGUgc3RyaW5nIHZhbHVlIGFuZCBjb252ZXJ0IHRvIGFuIGluZGV4CgkJCWdldE5hbWUgPSBmdW5jdGlvbiggbWF0Y2gsIHNob3J0TmFtZXMsIGxvbmdOYW1lcyApIHsKCQkJCXZhciBpbmRleCA9IC0xLAoJCQkJCW5hbWVzID0gJC5tYXAoIGxvb2tBaGVhZCggbWF0Y2ggKSA\/IGxvbmdOYW1lcyA6IHNob3J0TmFtZXMsIGZ1bmN0aW9uKCB2LCBrICkgewoJCQkJCQlyZXR1cm4gWyBbIGssIHYgXSBdOwoJCQkJCX0gKS5zb3J0KCBmdW5jdGlvbiggYSwgYiApIHsKCQkJCQkJcmV0dXJuIC0oIGFbIDEgXS5sZW5ndGggLSBiWyAxIF0ubGVuZ3RoICk7CgkJCQkJfSApOwoKCQkJCSQuZWFjaCggbmFtZXMsIGZ1bmN0aW9uKCBpLCBwYWlyICkgewoJCQkJCXZhciBuYW1lID0gcGFpclsgMSBdOwoJCQkJCWlmICggdmFsdWUuc3Vic3RyKCBpVmFsdWUsIG5hbWUubGVuZ3RoICkudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpICkgewoJCQkJCQlpbmRleCA9IHBhaXJbIDAgXTsKCQkJCQkJaVZhbHVlICs9IG5hbWUubGVuZ3RoOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSApOwoJCQkJaWYgKCBpbmRleCAhPT0gLTEgKSB7CgkJCQkJcmV0dXJuIGluZGV4ICsgMTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhyb3cgIlVua25vd24gbmFtZSBhdCBwb3NpdGlvbiAiICsgaVZhbHVlOwoJCQkJfQoJCQl9LAoKCQkJLy8gQ29uZmlybSB0aGF0IGEgbGl0ZXJhbCBjaGFyYWN0ZXIgbWF0Y2hlcyB0aGUgc3RyaW5nIHZhbHVlCgkJCWNoZWNrTGl0ZXJhbCA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB2YWx1ZS5jaGFyQXQoIGlWYWx1ZSApICE9PSBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgKSB7CgkJCQkJdGhyb3cgIlVuZXhwZWN0ZWQgbGl0ZXJhbCBhdCBwb3NpdGlvbiAiICsgaVZhbHVlOwoJCQkJfQoJCQkJaVZhbHVlKys7CgkJCX07CgoJCWZvciAoIGlGb3JtYXQgPSAwOyBpRm9ybWF0IDwgZm9ybWF0Lmxlbmd0aDsgaUZvcm1hdCsrICkgewoJCQlpZiAoIGxpdGVyYWwgKSB7CgkJCQlpZiAoIGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKSA9PT0gIiciICYmICFsb29rQWhlYWQoICInIiApICkgewoJCQkJCWxpdGVyYWwgPSBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJY2hlY2tMaXRlcmFsKCk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlzd2l0Y2ggKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgKSB7CgkJCQkJY2FzZSAiZCI6CgkJCQkJCWRheSA9IGdldE51bWJlciggImQiICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIkQiOgoJCQkJCQlnZXROYW1lKCAiRCIsIGRheU5hbWVzU2hvcnQsIGRheU5hbWVzICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIm8iOgoJCQkJCQlkb3kgPSBnZXROdW1iZXIoICJvIiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJtIjoKCQkJCQkJbW9udGggPSBnZXROdW1iZXIoICJtIiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJNIjoKCQkJCQkJbW9udGggPSBnZXROYW1lKCAiTSIsIG1vbnRoTmFtZXNTaG9ydCwgbW9udGhOYW1lcyApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICJ5IjoKCQkJCQkJeWVhciA9IGdldE51bWJlciggInkiICk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIkAiOgoJCQkJCQlkYXRlID0gbmV3IERhdGUoIGdldE51bWJlciggIkAiICkgKTsKCQkJCQkJeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTsKCQkJCQkJbW9udGggPSBkYXRlLmdldE1vbnRoKCkgKyAxOwoJCQkJCQlkYXkgPSBkYXRlLmdldERhdGUoKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiISI6CgkJCQkJCWRhdGUgPSBuZXcgRGF0ZSggKCBnZXROdW1iZXIoICIhIiApIC0gdGhpcy5fdGlja3NUbzE5NzAgKSAvIDEwMDAwICk7CgkJCQkJCXllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7CgkJCQkJCW1vbnRoID0gZGF0ZS5nZXRNb250aCgpICsgMTsKCQkJCQkJZGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgIiciOgoJCQkJCQlpZiAoIGxvb2tBaGVhZCggIiciICkgKSB7CgkJCQkJCQljaGVja0xpdGVyYWwoKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWxpdGVyYWwgPSB0cnVlOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWNoZWNrTGl0ZXJhbCgpOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoIGlWYWx1ZSA8IHZhbHVlLmxlbmd0aCApIHsKCQkJZXh0cmEgPSB2YWx1ZS5zdWJzdHIoIGlWYWx1ZSApOwoJCQlpZiAoICEvXlxzKy8udGVzdCggZXh0cmEgKSApIHsKCQkJCXRocm93ICJFeHRyYS91bnBhcnNlZCBjaGFyYWN0ZXJzIGZvdW5kIGluIGRhdGU6ICIgKyBleHRyYTsKCQkJfQoJCX0KCgkJaWYgKCB5ZWFyID09PSAtMSApIHsKCQkJeWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTsKCQl9IGVsc2UgaWYgKCB5ZWFyIDwgMTAwICkgewoJCQl5ZWFyICs9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSAtIG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSAlIDEwMCArCgkJCQkoIHllYXIgPD0gc2hvcnRZZWFyQ3V0b2ZmID8gMCA6IC0xMDAgKTsKCQl9CgoJCWlmICggZG95ID4gLTEgKSB7CgkJCW1vbnRoID0gMTsKCQkJZGF5ID0gZG95OwoJCQlkbyB7CgkJCQlkaW0gPSB0aGlzLl9nZXREYXlzSW5Nb250aCggeWVhciwgbW9udGggLSAxICk7CgkJCQlpZiAoIGRheSA8PSBkaW0gKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCQltb250aCsrOwoJCQkJZGF5IC09IGRpbTsKCQkJfSB3aGlsZSAoIHRydWUgKTsKCQl9CgoJCWRhdGUgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIHllYXIsIG1vbnRoIC0gMSwgZGF5ICkgKTsKCQlpZiAoIGRhdGUuZ2V0RnVsbFllYXIoKSAhPT0geWVhciB8fCBkYXRlLmdldE1vbnRoKCkgKyAxICE9PSBtb250aCB8fCBkYXRlLmdldERhdGUoKSAhPT0gZGF5ICkgewoJCQl0aHJvdyAiSW52YWxpZCBkYXRlIjsgLy8gRS5nLiAzMS8wMi8wMAoJCX0KCQlyZXR1cm4gZGF0ZTsKCX0sCgoJLyogU3RhbmRhcmQgZGF0ZSBmb3JtYXRzLiAqLwoJQVRPTTogInl5LW1tLWRkIiwgLy8gUkZDIDMzMzkgKElTTyA4NjAxKQoJQ09PS0lFOiAiRCwgZGQgTSB5eSIsCglJU09fODYwMTogInl5LW1tLWRkIiwKCVJGQ184MjI6ICJELCBkIE0geSIsCglSRkNfODUwOiAiREQsIGRkLU0teSIsCglSRkNfMTAzNjogIkQsIGQgTSB5IiwKCVJGQ18xMTIzOiAiRCwgZCBNIHl5IiwKCVJGQ18yODIyOiAiRCwgZCBNIHl5IiwKCVJTUzogIkQsIGQgTSB5IiwgLy8gUkZDIDgyMgoJVElDS1M6ICIhIiwKCVRJTUVTVEFNUDogIkAiLAoJVzNDOiAieXktbW0tZGQiLCAvLyBJU08gODYwMQoKCV90aWNrc1RvMTk3MDogKCAoICggMTk3MCAtIDEgKSAqIDM2NSArIE1hdGguZmxvb3IoIDE5NzAgLyA0ICkgLSBNYXRoLmZsb29yKCAxOTcwIC8gMTAwICkgKwoJCU1hdGguZmxvb3IoIDE5NzAgLyA0MDAgKSApICogMjQgKiA2MCAqIDYwICogMTAwMDAwMDAgKSwKCgkvKiBGb3JtYXQgYSBkYXRlIG9iamVjdCBpbnRvIGEgc3RyaW5nIHZhbHVlLgoJICogVGhlIGZvcm1hdCBjYW4gYmUgY29tYmluYXRpb25zIG9mIHRoZSBmb2xsb3dpbmc6CgkgKiBkICAtIGRheSBvZiBtb250aCAobm8gbGVhZGluZyB6ZXJvKQoJICogZGQgLSBkYXkgb2YgbW9udGggKHR3byBkaWdpdCkKCSAqIG8gIC0gZGF5IG9mIHllYXIgKG5vIGxlYWRpbmcgemVyb3MpCgkgKiBvbyAtIGRheSBvZiB5ZWFyICh0aHJlZSBkaWdpdCkKCSAqIEQgIC0gZGF5IG5hbWUgc2hvcnQKCSAqIEREIC0gZGF5IG5hbWUgbG9uZwoJICogbSAgLSBtb250aCBvZiB5ZWFyIChubyBsZWFkaW5nIHplcm8pCgkgKiBtbSAtIG1vbnRoIG9mIHllYXIgKHR3byBkaWdpdCkKCSAqIE0gIC0gbW9udGggbmFtZSBzaG9ydAoJICogTU0gLSBtb250aCBuYW1lIGxvbmcKCSAqIHkgIC0geWVhciAodHdvIGRpZ2l0KQoJICogeXkgLSB5ZWFyIChmb3VyIGRpZ2l0KQoJICogQCAtIFVuaXggdGltZXN0YW1wIChtcyBzaW5jZSAwMS8wMS8xOTcwKQoJICogISAtIFdpbmRvd3MgdGlja3MgKDEwMG5zIHNpbmNlIDAxLzAxLzAwMDEpCgkgKiAiLi4uIiAtIGxpdGVyYWwgdGV4dAoJICogJycgLSBzaW5nbGUgcXVvdGUKCSAqCgkgKiBAcGFyYW0gIGZvcm1hdCBzdHJpbmcgLSB0aGUgZGVzaXJlZCBmb3JtYXQgb2YgdGhlIGRhdGUKCSAqIEBwYXJhbSAgZGF0ZSBEYXRlIC0gdGhlIGRhdGUgdmFsdWUgdG8gZm9ybWF0CgkgKiBAcGFyYW0gIHNldHRpbmdzIE9iamVjdCAtIGF0dHJpYnV0ZXMgaW5jbHVkZToKCSAqCQkJCQlkYXlOYW1lc1Nob3J0CXN0cmluZ1s3XSAtIGFiYnJldmlhdGVkIG5hbWVzIG9mIHRoZSBkYXlzIGZyb20gU3VuZGF5IChvcHRpb25hbCkKCSAqCQkJCQlkYXlOYW1lcwkJc3RyaW5nWzddIC0gbmFtZXMgb2YgdGhlIGRheXMgZnJvbSBTdW5kYXkgKG9wdGlvbmFsKQoJICoJCQkJCW1vbnRoTmFtZXNTaG9ydCBzdHJpbmdbMTJdIC0gYWJicmV2aWF0ZWQgbmFtZXMgb2YgdGhlIG1vbnRocyAob3B0aW9uYWwpCgkgKgkJCQkJbW9udGhOYW1lcwkJc3RyaW5nWzEyXSAtIG5hbWVzIG9mIHRoZSBtb250aHMgKG9wdGlvbmFsKQoJICogQHJldHVybiAgc3RyaW5nIC0gdGhlIGRhdGUgaW4gdGhlIGFib3ZlIGZvcm1hdAoJICovCglmb3JtYXREYXRlOiBmdW5jdGlvbiggZm9ybWF0LCBkYXRlLCBzZXR0aW5ncyApIHsKCQlpZiAoICFkYXRlICkgewoJCQlyZXR1cm4gIiI7CgkJfQoKCQl2YXIgaUZvcm1hdCwKCQkJZGF5TmFtZXNTaG9ydCA9ICggc2V0dGluZ3MgPyBzZXR0aW5ncy5kYXlOYW1lc1Nob3J0IDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLmRheU5hbWVzU2hvcnQsCgkJCWRheU5hbWVzID0gKCBzZXR0aW5ncyA\/IHNldHRpbmdzLmRheU5hbWVzIDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLmRheU5hbWVzLAoJCQltb250aE5hbWVzU2hvcnQgPSAoIHNldHRpbmdzID8gc2V0dGluZ3MubW9udGhOYW1lc1Nob3J0IDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXNTaG9ydCwKCQkJbW9udGhOYW1lcyA9ICggc2V0dGluZ3MgPyBzZXR0aW5ncy5tb250aE5hbWVzIDogbnVsbCApIHx8IHRoaXMuX2RlZmF1bHRzLm1vbnRoTmFtZXMsCgoJCQkvLyBDaGVjayB3aGV0aGVyIGEgZm9ybWF0IGNoYXJhY3RlciBpcyBkb3VibGVkCgkJCWxvb2tBaGVhZCA9IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJCXZhciBtYXRjaGVzID0gKCBpRm9ybWF0ICsgMSA8IGZvcm1hdC5sZW5ndGggJiYgZm9ybWF0LmNoYXJBdCggaUZvcm1hdCArIDEgKSA9PT0gbWF0Y2ggKTsKCQkJCWlmICggbWF0Y2hlcyApIHsKCQkJCQlpRm9ybWF0Kys7CgkJCQl9CgkJCQlyZXR1cm4gbWF0Y2hlczsKCQkJfSwKCgkJCS8vIEZvcm1hdCBhIG51bWJlciwgd2l0aCBsZWFkaW5nIHplcm8gaWYgbmVjZXNzYXJ5CgkJCWZvcm1hdE51bWJlciA9IGZ1bmN0aW9uKCBtYXRjaCwgdmFsdWUsIGxlbiApIHsKCQkJCXZhciBudW0gPSAiIiArIHZhbHVlOwoJCQkJaWYgKCBsb29rQWhlYWQoIG1hdGNoICkgKSB7CgkJCQkJd2hpbGUgKCBudW0ubGVuZ3RoIDwgbGVuICkgewoJCQkJCQludW0gPSAiMCIgKyBudW07CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuIG51bTsKCQkJfSwKCgkJCS8vIEZvcm1hdCBhIG5hbWUsIHNob3J0IG9yIGxvbmcgYXMgcmVxdWVzdGVkCgkJCWZvcm1hdE5hbWUgPSBmdW5jdGlvbiggbWF0Y2gsIHZhbHVlLCBzaG9ydE5hbWVzLCBsb25nTmFtZXMgKSB7CgkJCQlyZXR1cm4gKCBsb29rQWhlYWQoIG1hdGNoICkgPyBsb25nTmFtZXNbIHZhbHVlIF0gOiBzaG9ydE5hbWVzWyB2YWx1ZSBdICk7CgkJCX0sCgkJCW91dHB1dCA9ICIiLAoJCQlsaXRlcmFsID0gZmFsc2U7CgoJCWlmICggZGF0ZSApIHsKCQkJZm9yICggaUZvcm1hdCA9IDA7IGlGb3JtYXQgPCBmb3JtYXQubGVuZ3RoOyBpRm9ybWF0KysgKSB7CgkJCQlpZiAoIGxpdGVyYWwgKSB7CgkJCQkJaWYgKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgPT09ICInIiAmJiAhbG9va0FoZWFkKCAiJyIgKSApIHsKCQkJCQkJbGl0ZXJhbCA9IGZhbHNlOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW91dHB1dCArPSBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlzd2l0Y2ggKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgKSB7CgkJCQkJCWNhc2UgImQiOgoJCQkJCQkJb3V0cHV0ICs9IGZvcm1hdE51bWJlciggImQiLCBkYXRlLmdldERhdGUoKSwgMiApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIkQiOgoJCQkJCQkJb3V0cHV0ICs9IGZvcm1hdE5hbWUoICJEIiwgZGF0ZS5nZXREYXkoKSwgZGF5TmFtZXNTaG9ydCwgZGF5TmFtZXMgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICJvIjoKCQkJCQkJCW91dHB1dCArPSBmb3JtYXROdW1iZXIoICJvIiwKCQkJCQkJCQlNYXRoLnJvdW5kKCAoIG5ldyBEYXRlKCBkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSwgZGF0ZS5nZXREYXRlKCkgKS5nZXRUaW1lKCkgLSBuZXcgRGF0ZSggZGF0ZS5nZXRGdWxsWWVhcigpLCAwLCAwICkuZ2V0VGltZSgpICkgLyA4NjQwMDAwMCApLCAzICk7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAibSI6CgkJCQkJCQlvdXRwdXQgKz0gZm9ybWF0TnVtYmVyKCAibSIsIGRhdGUuZ2V0TW9udGgoKSArIDEsIDIgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICJNIjoKCQkJCQkJCW91dHB1dCArPSBmb3JtYXROYW1lKCAiTSIsIGRhdGUuZ2V0TW9udGgoKSwgbW9udGhOYW1lc1Nob3J0LCBtb250aE5hbWVzICk7CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAieSI6CgkJCQkJCQlvdXRwdXQgKz0gKCBsb29rQWhlYWQoICJ5IiApID8gZGF0ZS5nZXRGdWxsWWVhcigpIDoKCQkJCQkJCQkoIGRhdGUuZ2V0RnVsbFllYXIoKSAlIDEwMCA8IDEwID8gIjAiIDogIiIgKSArIGRhdGUuZ2V0RnVsbFllYXIoKSAlIDEwMCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIkAiOgoJCQkJCQkJb3V0cHV0ICs9IGRhdGUuZ2V0VGltZSgpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgIiEiOgoJCQkJCQkJb3V0cHV0ICs9IGRhdGUuZ2V0VGltZSgpICogMTAwMDAgKyB0aGlzLl90aWNrc1RvMTk3MDsKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICInIjoKCQkJCQkJCWlmICggbG9va0FoZWFkKCAiJyIgKSApIHsKCQkJCQkJCQlvdXRwdXQgKz0gIiciOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlsaXRlcmFsID0gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJb3V0cHV0ICs9IGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIG91dHB1dDsKCX0sCgoJLyogRXh0cmFjdCBhbGwgcG9zc2libGUgY2hhcmFjdGVycyBmcm9tIHRoZSBkYXRlIGZvcm1hdC4gKi8KCV9wb3NzaWJsZUNoYXJzOiBmdW5jdGlvbiggZm9ybWF0ICkgewoJCXZhciBpRm9ybWF0LAoJCQljaGFycyA9ICIiLAoJCQlsaXRlcmFsID0gZmFsc2UsCgoJCQkvLyBDaGVjayB3aGV0aGVyIGEgZm9ybWF0IGNoYXJhY3RlciBpcyBkb3VibGVkCgkJCWxvb2tBaGVhZCA9IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJCXZhciBtYXRjaGVzID0gKCBpRm9ybWF0ICsgMSA8IGZvcm1hdC5sZW5ndGggJiYgZm9ybWF0LmNoYXJBdCggaUZvcm1hdCArIDEgKSA9PT0gbWF0Y2ggKTsKCQkJCWlmICggbWF0Y2hlcyApIHsKCQkJCQlpRm9ybWF0Kys7CgkJCQl9CgkJCQlyZXR1cm4gbWF0Y2hlczsKCQkJfTsKCgkJZm9yICggaUZvcm1hdCA9IDA7IGlGb3JtYXQgPCBmb3JtYXQubGVuZ3RoOyBpRm9ybWF0KysgKSB7CgkJCWlmICggbGl0ZXJhbCApIHsKCQkJCWlmICggZm9ybWF0LmNoYXJBdCggaUZvcm1hdCApID09PSAiJyIgJiYgIWxvb2tBaGVhZCggIiciICkgKSB7CgkJCQkJbGl0ZXJhbCA9IGZhbHNlOwoJCQkJfSBlbHNlIHsKCQkJCQljaGFycyArPSBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlzd2l0Y2ggKCBmb3JtYXQuY2hhckF0KCBpRm9ybWF0ICkgKSB7CgkJCQkJY2FzZSAiZCI6IGNhc2UgIm0iOiBjYXNlICJ5IjogY2FzZSAiQCI6CgkJCQkJCWNoYXJzICs9ICIwMTIzNDU2Nzg5IjsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiRCI6IGNhc2UgIk0iOgoJCQkJCQlyZXR1cm4gbnVsbDsgLy8gQWNjZXB0IGFueXRoaW5nCgkJCQkJY2FzZSAiJyI6CgkJCQkJCWlmICggbG9va0FoZWFkKCAiJyIgKSApIHsKCQkJCQkJCWNoYXJzICs9ICInIjsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWxpdGVyYWwgPSB0cnVlOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCWNoYXJzICs9IGZvcm1hdC5jaGFyQXQoIGlGb3JtYXQgKTsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gY2hhcnM7Cgl9LAoKCS8qIEdldCBhIHNldHRpbmcgdmFsdWUsIGRlZmF1bHRpbmcgaWYgbmVjZXNzYXJ5LiAqLwoJX2dldDogZnVuY3Rpb24oIGluc3QsIG5hbWUgKSB7CgkJcmV0dXJuIGluc3Quc2V0dGluZ3NbIG5hbWUgXSAhPT0gdW5kZWZpbmVkID8KCQkJaW5zdC5zZXR0aW5nc1sgbmFtZSBdIDogdGhpcy5fZGVmYXVsdHNbIG5hbWUgXTsKCX0sCgoJLyogUGFyc2UgZXhpc3RpbmcgZGF0ZSBhbmQgaW5pdGlhbGlzZSBkYXRlIHBpY2tlci4gKi8KCV9zZXREYXRlRnJvbUZpZWxkOiBmdW5jdGlvbiggaW5zdCwgbm9EZWZhdWx0ICkgewoJCWlmICggaW5zdC5pbnB1dC52YWwoKSA9PT0gaW5zdC5sYXN0VmFsICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgZGF0ZUZvcm1hdCA9IHRoaXMuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICksCgkJCWRhdGVzID0gaW5zdC5sYXN0VmFsID0gaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXQudmFsKCkgOiBudWxsLAoJCQlkZWZhdWx0RGF0ZSA9IHRoaXMuX2dldERlZmF1bHREYXRlKCBpbnN0ICksCgkJCWRhdGUgPSBkZWZhdWx0RGF0ZSwKCQkJc2V0dGluZ3MgPSB0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKTsKCgkJdHJ5IHsKCQkJZGF0ZSA9IHRoaXMucGFyc2VEYXRlKCBkYXRlRm9ybWF0LCBkYXRlcywgc2V0dGluZ3MgKSB8fCBkZWZhdWx0RGF0ZTsKCQl9IGNhdGNoICggZXZlbnQgKSB7CgkJCWRhdGVzID0gKCBub0RlZmF1bHQgPyAiIiA6IGRhdGVzICk7CgkJfQoJCWluc3Quc2VsZWN0ZWREYXkgPSBkYXRlLmdldERhdGUoKTsKCQlpbnN0LmRyYXdNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aCA9IGRhdGUuZ2V0TW9udGgoKTsKCQlpbnN0LmRyYXdZZWFyID0gaW5zdC5zZWxlY3RlZFllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7CgkJaW5zdC5jdXJyZW50RGF5ID0gKCBkYXRlcyA\/IGRhdGUuZ2V0RGF0ZSgpIDogMCApOwoJCWluc3QuY3VycmVudE1vbnRoID0gKCBkYXRlcyA\/IGRhdGUuZ2V0TW9udGgoKSA6IDAgKTsKCQlpbnN0LmN1cnJlbnRZZWFyID0gKCBkYXRlcyA\/IGRhdGUuZ2V0RnVsbFllYXIoKSA6IDAgKTsKCQl0aGlzLl9hZGp1c3RJbnN0RGF0ZSggaW5zdCApOwoJfSwKCgkvKiBSZXRyaWV2ZSB0aGUgZGVmYXVsdCBkYXRlIHNob3duIG9uIG9wZW5pbmcuICovCglfZ2V0RGVmYXVsdERhdGU6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXJldHVybiB0aGlzLl9yZXN0cmljdE1pbk1heCggaW5zdCwKCQkJdGhpcy5fZGV0ZXJtaW5lRGF0ZSggaW5zdCwgdGhpcy5fZ2V0KCBpbnN0LCAiZGVmYXVsdERhdGUiICksIG5ldyBEYXRlKCkgKSApOwoJfSwKCgkvKiBBIGRhdGUgbWF5IGJlIHNwZWNpZmllZCBhcyBhbiBleGFjdCB2YWx1ZSBvciBhIHJlbGF0aXZlIG9uZS4gKi8KCV9kZXRlcm1pbmVEYXRlOiBmdW5jdGlvbiggaW5zdCwgZGF0ZSwgZGVmYXVsdERhdGUgKSB7CgkJdmFyIG9mZnNldE51bWVyaWMgPSBmdW5jdGlvbiggb2Zmc2V0ICkgewoJCQkJdmFyIGRhdGUgPSBuZXcgRGF0ZSgpOwoJCQkJZGF0ZS5zZXREYXRlKCBkYXRlLmdldERhdGUoKSArIG9mZnNldCApOwoJCQkJcmV0dXJuIGRhdGU7CgkJCX0sCgkJCW9mZnNldFN0cmluZyA9IGZ1bmN0aW9uKCBvZmZzZXQgKSB7CgkJCQl0cnkgewoJCQkJCXJldHVybiAkLmRhdGVwaWNrZXIucGFyc2VEYXRlKCAkLmRhdGVwaWNrZXIuX2dldCggaW5zdCwgImRhdGVGb3JtYXQiICksCgkJCQkJCW9mZnNldCwgJC5kYXRlcGlja2VyLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApOwoJCQkJfQoJCQkJY2F0Y2ggKCBlICkgewoKCQkJCQkvLyBJZ25vcmUKCQkJCX0KCgkJCQl2YXIgZGF0ZSA9ICggb2Zmc2V0LnRvTG93ZXJDYXNlKCkubWF0Y2goIC9eYy8gKSA\/CgkJCQkJJC5kYXRlcGlja2VyLl9nZXREYXRlKCBpbnN0ICkgOiBudWxsICkgfHwgbmV3IERhdGUoKSwKCQkJCQl5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLAoJCQkJCW1vbnRoID0gZGF0ZS5nZXRNb250aCgpLAoJCQkJCWRheSA9IGRhdGUuZ2V0RGF0ZSgpLAoJCQkJCXBhdHRlcm4gPSAvKFsrXC1dP1swLTldKylccyooZHxEfHd8V3xtfE18eXxZKT8vZywKCQkJCQltYXRjaGVzID0gcGF0dGVybi5leGVjKCBvZmZzZXQgKTsKCgkJCQl3aGlsZSAoIG1hdGNoZXMgKSB7CgkJCQkJc3dpdGNoICggbWF0Y2hlc1sgMiBdIHx8ICJkIiApIHsKCQkJCQkJY2FzZSAiZCIgOiBjYXNlICJEIiA6CgkJCQkJCQlkYXkgKz0gcGFyc2VJbnQoIG1hdGNoZXNbIDEgXSwgMTAgKTsgYnJlYWs7CgkJCQkJCWNhc2UgInciIDogY2FzZSAiVyIgOgoJCQkJCQkJZGF5ICs9IHBhcnNlSW50KCBtYXRjaGVzWyAxIF0sIDEwICkgKiA3OyBicmVhazsKCQkJCQkJY2FzZSAibSIgOiBjYXNlICJNIiA6CgkJCQkJCQltb250aCArPSBwYXJzZUludCggbWF0Y2hlc1sgMSBdLCAxMCApOwoJCQkJCQkJZGF5ID0gTWF0aC5taW4oIGRheSwgJC5kYXRlcGlja2VyLl9nZXREYXlzSW5Nb250aCggeWVhciwgbW9udGggKSApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCWNhc2UgInkiOiBjYXNlICJZIiA6CgkJCQkJCQl5ZWFyICs9IHBhcnNlSW50KCBtYXRjaGVzWyAxIF0sIDEwICk7CgkJCQkJCQlkYXkgPSBNYXRoLm1pbiggZGF5LCAkLmRhdGVwaWNrZXIuX2dldERheXNJbk1vbnRoKCB5ZWFyLCBtb250aCApICk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQkJbWF0Y2hlcyA9IHBhdHRlcm4uZXhlYyggb2Zmc2V0ICk7CgkJCQl9CgkJCQlyZXR1cm4gbmV3IERhdGUoIHllYXIsIG1vbnRoLCBkYXkgKTsKCQkJfSwKCQkJbmV3RGF0ZSA9ICggZGF0ZSA9PSBudWxsIHx8IGRhdGUgPT09ICIiID8gZGVmYXVsdERhdGUgOiAoIHR5cGVvZiBkYXRlID09PSAic3RyaW5nIiA\/IG9mZnNldFN0cmluZyggZGF0ZSApIDoKCQkJCSggdHlwZW9mIGRhdGUgPT09ICJudW1iZXIiID8gKCBpc05hTiggZGF0ZSApID8gZGVmYXVsdERhdGUgOiBvZmZzZXROdW1lcmljKCBkYXRlICkgKSA6IG5ldyBEYXRlKCBkYXRlLmdldFRpbWUoKSApICkgKSApOwoKCQluZXdEYXRlID0gKCBuZXdEYXRlICYmIG5ld0RhdGUudG9TdHJpbmcoKSA9PT0gIkludmFsaWQgRGF0ZSIgPyBkZWZhdWx0RGF0ZSA6IG5ld0RhdGUgKTsKCQlpZiAoIG5ld0RhdGUgKSB7CgkJCW5ld0RhdGUuc2V0SG91cnMoIDAgKTsKCQkJbmV3RGF0ZS5zZXRNaW51dGVzKCAwICk7CgkJCW5ld0RhdGUuc2V0U2Vjb25kcyggMCApOwoJCQluZXdEYXRlLnNldE1pbGxpc2Vjb25kcyggMCApOwoJCX0KCQlyZXR1cm4gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ld0RhdGUgKTsKCX0sCgoJLyogSGFuZGxlIHN3aXRjaCB0by9mcm9tIGRheWxpZ2h0IHNhdmluZy4KCSAqIEhvdXJzIG1heSBiZSBub24temVybyBvbiBkYXlsaWdodCBzYXZpbmcgY3V0LW92ZXI6CgkgKiA+IDEyIHdoZW4gbWlkbmlnaHQgY2hhbmdlb3ZlciwgYnV0IHRoZW4gY2Fubm90IGdlbmVyYXRlCgkgKiBtaWRuaWdodCBkYXRldGltZSwgc28ganVtcCB0byAxQU0sIG90aGVyd2lzZSByZXNldC4KCSAqIEBwYXJhbSAgZGF0ZSAgKERhdGUpIHRoZSBkYXRlIHRvIGNoZWNrCgkgKiBAcmV0dXJuICAoRGF0ZSkgdGhlIGNvcnJlY3RlZCBkYXRlCgkgKi8KCV9kYXlsaWdodFNhdmluZ0FkanVzdDogZnVuY3Rpb24oIGRhdGUgKSB7CgkJaWYgKCAhZGF0ZSApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCWRhdGUuc2V0SG91cnMoIGRhdGUuZ2V0SG91cnMoKSA+IDEyID8gZGF0ZS5nZXRIb3VycygpICsgMiA6IDAgKTsKCQlyZXR1cm4gZGF0ZTsKCX0sCgoJLyogU2V0IHRoZSBkYXRlKHMpIGRpcmVjdGx5LiAqLwoJX3NldERhdGU6IGZ1bmN0aW9uKCBpbnN0LCBkYXRlLCBub0NoYW5nZSApIHsKCQl2YXIgY2xlYXIgPSAhZGF0ZSwKCQkJb3JpZ01vbnRoID0gaW5zdC5zZWxlY3RlZE1vbnRoLAoJCQlvcmlnWWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyLAoJCQluZXdEYXRlID0gdGhpcy5fcmVzdHJpY3RNaW5NYXgoIGluc3QsIHRoaXMuX2RldGVybWluZURhdGUoIGluc3QsIGRhdGUsIG5ldyBEYXRlKCkgKSApOwoKCQlpbnN0LnNlbGVjdGVkRGF5ID0gaW5zdC5jdXJyZW50RGF5ID0gbmV3RGF0ZS5nZXREYXRlKCk7CgkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBpbnN0LmN1cnJlbnRNb250aCA9IG5ld0RhdGUuZ2V0TW9udGgoKTsKCQlpbnN0LmRyYXdZZWFyID0gaW5zdC5zZWxlY3RlZFllYXIgPSBpbnN0LmN1cnJlbnRZZWFyID0gbmV3RGF0ZS5nZXRGdWxsWWVhcigpOwoJCWlmICggKCBvcmlnTW9udGggIT09IGluc3Quc2VsZWN0ZWRNb250aCB8fCBvcmlnWWVhciAhPT0gaW5zdC5zZWxlY3RlZFllYXIgKSAmJiAhbm9DaGFuZ2UgKSB7CgkJCXRoaXMuX25vdGlmeUNoYW5nZSggaW5zdCApOwoJCX0KCQl0aGlzLl9hZGp1c3RJbnN0RGF0ZSggaW5zdCApOwoJCWlmICggaW5zdC5pbnB1dCApIHsKCQkJaW5zdC5pbnB1dC52YWwoIGNsZWFyID8gIiIgOiB0aGlzLl9mb3JtYXREYXRlKCBpbnN0ICkgKTsKCQl9Cgl9LAoKCS8qIFJldHJpZXZlIHRoZSBkYXRlKHMpIGRpcmVjdGx5LiAqLwoJX2dldERhdGU6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXZhciBzdGFydERhdGUgPSAoICFpbnN0LmN1cnJlbnRZZWFyIHx8ICggaW5zdC5pbnB1dCAmJiBpbnN0LmlucHV0LnZhbCgpID09PSAiIiApID8gbnVsbCA6CgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSgKCQkJaW5zdC5jdXJyZW50WWVhciwgaW5zdC5jdXJyZW50TW9udGgsIGluc3QuY3VycmVudERheSApICkgKTsKCQkJcmV0dXJuIHN0YXJ0RGF0ZTsKCX0sCgoJLyogQXR0YWNoIHRoZSBvbnh4eCBoYW5kbGVycy4gIFRoZXNlIGFyZSBkZWNsYXJlZCBzdGF0aWNhbGx5IHNvCgkgKiB0aGV5IHdvcmsgd2l0aCBzdGF0aWMgY29kZSB0cmFuc2Zvcm1lcnMgbGlrZSBDYWphLgoJICovCglfYXR0YWNoSGFuZGxlcnM6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXZhciBzdGVwTW9udGhzID0gdGhpcy5fZ2V0KCBpbnN0LCAic3RlcE1vbnRocyIgKSwKCQkJaWQgPSAiIyIgKyBpbnN0LmlkLnJlcGxhY2UoIC9cXFxcL2csICJcXCIgKTsKCQlpbnN0LmRwRGl2LmZpbmQoICJbZGF0YS1oYW5kbGVyXSIgKS5tYXAoIGZ1bmN0aW9uKCkgewoJCQl2YXIgaGFuZGxlciA9IHsKCQkJCXByZXY6IGZ1bmN0aW9uKCkgewoJCQkJCSQuZGF0ZXBpY2tlci5fYWRqdXN0RGF0ZSggaWQsIC1zdGVwTW9udGhzLCAiTSIgKTsKCQkJCX0sCgkJCQluZXh0OiBmdW5jdGlvbigpIHsKCQkJCQkkLmRhdGVwaWNrZXIuX2FkanVzdERhdGUoIGlkLCArc3RlcE1vbnRocywgIk0iICk7CgkJCQl9LAoJCQkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCQkJJC5kYXRlcGlja2VyLl9oaWRlRGF0ZXBpY2tlcigpOwoJCQkJfSwKCQkJCXRvZGF5OiBmdW5jdGlvbigpIHsKCQkJCQkkLmRhdGVwaWNrZXIuX2dvdG9Ub2RheSggaWQgKTsKCQkJCX0sCgkJCQlzZWxlY3REYXk6IGZ1bmN0aW9uKCkgewoJCQkJCSQuZGF0ZXBpY2tlci5fc2VsZWN0RGF5KCBpZCwgK3RoaXMuZ2V0QXR0cmlidXRlKCAiZGF0YS1tb250aCIgKSwgK3RoaXMuZ2V0QXR0cmlidXRlKCAiZGF0YS15ZWFyIiApLCB0aGlzICk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSwKCQkJCXNlbGVjdE1vbnRoOiBmdW5jdGlvbigpIHsKCQkJCQkkLmRhdGVwaWNrZXIuX3NlbGVjdE1vbnRoWWVhciggaWQsIHRoaXMsICJNIiApOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgkJCQlzZWxlY3RZZWFyOiBmdW5jdGlvbigpIHsKCQkJCQkkLmRhdGVwaWNrZXIuX3NlbGVjdE1vbnRoWWVhciggaWQsIHRoaXMsICJZIiApOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfTsKCQkJJCggdGhpcyApLm9uKCB0aGlzLmdldEF0dHJpYnV0ZSggImRhdGEtZXZlbnQiICksIGhhbmRsZXJbIHRoaXMuZ2V0QXR0cmlidXRlKCAiZGF0YS1oYW5kbGVyIiApIF0gKTsKCQl9ICk7Cgl9LAoKCS8qIEdlbmVyYXRlIHRoZSBIVE1MIGZvciB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgZGF0ZSBwaWNrZXIuICovCglfZ2VuZXJhdGVIVE1MOiBmdW5jdGlvbiggaW5zdCApIHsKCQl2YXIgbWF4RHJhdywgcHJldlRleHQsIHByZXYsIG5leHRUZXh0LCBuZXh0LCBjdXJyZW50VGV4dCwgZ290b0RhdGUsCgkJCWNvbnRyb2xzLCBidXR0b25QYW5lbCwgZmlyc3REYXksIHNob3dXZWVrLCBkYXlOYW1lcywgZGF5TmFtZXNNaW4sCgkJCW1vbnRoTmFtZXMsIG1vbnRoTmFtZXNTaG9ydCwgYmVmb3JlU2hvd0RheSwgc2hvd090aGVyTW9udGhzLAoJCQlzZWxlY3RPdGhlck1vbnRocywgZGVmYXVsdERhdGUsIGh0bWwsIGRvdywgcm93LCBncm91cCwgY29sLCBzZWxlY3RlZERhdGUsCgkJCWNvcm5lckNsYXNzLCBjYWxlbmRlciwgdGhlYWQsIGRheSwgZGF5c0luTW9udGgsIGxlYWREYXlzLCBjdXJSb3dzLCBudW1Sb3dzLAoJCQlwcmludERhdGUsIGRSb3csIHRib2R5LCBkYXlTZXR0aW5ncywgb3RoZXJNb250aCwgdW5zZWxlY3RhYmxlLAoJCQl0ZW1wRGF0ZSA9IG5ldyBEYXRlKCksCgkJCXRvZGF5ID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoCgkJCQluZXcgRGF0ZSggdGVtcERhdGUuZ2V0RnVsbFllYXIoKSwgdGVtcERhdGUuZ2V0TW9udGgoKSwgdGVtcERhdGUuZ2V0RGF0ZSgpICkgKSwgLy8gY2xlYXIgdGltZQoJCQlpc1JUTCA9IHRoaXMuX2dldCggaW5zdCwgImlzUlRMIiApLAoJCQlzaG93QnV0dG9uUGFuZWwgPSB0aGlzLl9nZXQoIGluc3QsICJzaG93QnV0dG9uUGFuZWwiICksCgkJCWhpZGVJZk5vUHJldk5leHQgPSB0aGlzLl9nZXQoIGluc3QsICJoaWRlSWZOb1ByZXZOZXh0IiApLAoJCQluYXZpZ2F0aW9uQXNEYXRlRm9ybWF0ID0gdGhpcy5fZ2V0KCBpbnN0LCAibmF2aWdhdGlvbkFzRGF0ZUZvcm1hdCIgKSwKCQkJbnVtTW9udGhzID0gdGhpcy5fZ2V0TnVtYmVyT2ZNb250aHMoIGluc3QgKSwKCQkJc2hvd0N1cnJlbnRBdFBvcyA9IHRoaXMuX2dldCggaW5zdCwgInNob3dDdXJyZW50QXRQb3MiICksCgkJCXN0ZXBNb250aHMgPSB0aGlzLl9nZXQoIGluc3QsICJzdGVwTW9udGhzIiApLAoJCQlpc011bHRpTW9udGggPSAoIG51bU1vbnRoc1sgMCBdICE9PSAxIHx8IG51bU1vbnRoc1sgMSBdICE9PSAxICksCgkJCWN1cnJlbnREYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoICggIWluc3QuY3VycmVudERheSA\/IG5ldyBEYXRlKCA5OTk5LCA5LCA5ICkgOgoJCQkJbmV3IERhdGUoIGluc3QuY3VycmVudFllYXIsIGluc3QuY3VycmVudE1vbnRoLCBpbnN0LmN1cnJlbnREYXkgKSApICksCgkJCW1pbkRhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKCBpbnN0LCAibWluIiApLAoJCQltYXhEYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZSggaW5zdCwgIm1heCIgKSwKCQkJZHJhd01vbnRoID0gaW5zdC5kcmF3TW9udGggLSBzaG93Q3VycmVudEF0UG9zLAoJCQlkcmF3WWVhciA9IGluc3QuZHJhd1llYXI7CgoJCWlmICggZHJhd01vbnRoIDwgMCApIHsKCQkJZHJhd01vbnRoICs9IDEyOwoJCQlkcmF3WWVhci0tOwoJCX0KCQlpZiAoIG1heERhdGUgKSB7CgkJCW1heERyYXcgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIG1heERhdGUuZ2V0RnVsbFllYXIoKSwKCQkJCW1heERhdGUuZ2V0TW9udGgoKSAtICggbnVtTW9udGhzWyAwIF0gKiBudW1Nb250aHNbIDEgXSApICsgMSwgbWF4RGF0ZS5nZXREYXRlKCkgKSApOwoJCQltYXhEcmF3ID0gKCBtaW5EYXRlICYmIG1heERyYXcgPCBtaW5EYXRlID8gbWluRGF0ZSA6IG1heERyYXcgKTsKCQkJd2hpbGUgKCB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggbmV3IERhdGUoIGRyYXdZZWFyLCBkcmF3TW9udGgsIDEgKSApID4gbWF4RHJhdyApIHsKCQkJCWRyYXdNb250aC0tOwoJCQkJaWYgKCBkcmF3TW9udGggPCAwICkgewoJCQkJCWRyYXdNb250aCA9IDExOwoJCQkJCWRyYXdZZWFyLS07CgkJCQl9CgkJCX0KCQl9CgkJaW5zdC5kcmF3TW9udGggPSBkcmF3TW9udGg7CgkJaW5zdC5kcmF3WWVhciA9IGRyYXdZZWFyOwoKCQlwcmV2VGV4dCA9IHRoaXMuX2dldCggaW5zdCwgInByZXZUZXh0IiApOwoJCXByZXZUZXh0ID0gKCAhbmF2aWdhdGlvbkFzRGF0ZUZvcm1hdCA\/IHByZXZUZXh0IDogdGhpcy5mb3JtYXREYXRlKCBwcmV2VGV4dCwKCQkJdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBkcmF3WWVhciwgZHJhd01vbnRoIC0gc3RlcE1vbnRocywgMSApICksCgkJCXRoaXMuX2dldEZvcm1hdENvbmZpZyggaW5zdCApICkgKTsKCgkJcHJldiA9ICggdGhpcy5fY2FuQWRqdXN0TW9udGgoIGluc3QsIC0xLCBkcmF3WWVhciwgZHJhd01vbnRoICkgPwoJCQkiPGEgY2xhc3M9J3VpLWRhdGVwaWNrZXItcHJldiB1aS1jb3JuZXItYWxsJyBkYXRhLWhhbmRsZXI9J3ByZXYnIGRhdGEtZXZlbnQ9J2NsaWNrJyIgKwoJCQkiIHRpdGxlPSciICsgcHJldlRleHQgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWNpcmNsZS10cmlhbmdsZS0iICsgKCBpc1JUTCA\/ICJlIiA6ICJ3IiApICsgIic+IiArIHByZXZUZXh0ICsgIjwvc3Bhbj48L2E+IiA6CgkJCSggaGlkZUlmTm9QcmV2TmV4dCA\/ICIiIDogIjxhIGNsYXNzPSd1aS1kYXRlcGlja2VyLXByZXYgdWktY29ybmVyLWFsbCB1aS1zdGF0ZS1kaXNhYmxlZCcgdGl0bGU9JyIgKyBwcmV2VGV4dCArICInPjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tY2lyY2xlLXRyaWFuZ2xlLSIgKyAoIGlzUlRMID8gImUiIDogInciICkgKyAiJz4iICsgcHJldlRleHQgKyAiPC9zcGFuPjwvYT4iICkgKTsKCgkJbmV4dFRleHQgPSB0aGlzLl9nZXQoIGluc3QsICJuZXh0VGV4dCIgKTsKCQluZXh0VGV4dCA9ICggIW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQgPyBuZXh0VGV4dCA6IHRoaXMuZm9ybWF0RGF0ZSggbmV4dFRleHQsCgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggZHJhd1llYXIsIGRyYXdNb250aCArIHN0ZXBNb250aHMsIDEgKSApLAoJCQl0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApICk7CgoJCW5leHQgPSAoIHRoaXMuX2NhbkFkanVzdE1vbnRoKCBpbnN0LCArMSwgZHJhd1llYXIsIGRyYXdNb250aCApID8KCQkJIjxhIGNsYXNzPSd1aS1kYXRlcGlja2VyLW5leHQgdWktY29ybmVyLWFsbCcgZGF0YS1oYW5kbGVyPSduZXh0JyBkYXRhLWV2ZW50PSdjbGljayciICsKCQkJIiB0aXRsZT0nIiArIG5leHRUZXh0ICsgIic+PHNwYW4gY2xhc3M9J3VpLWljb24gdWktaWNvbi1jaXJjbGUtdHJpYW5nbGUtIiArICggaXNSVEwgPyAidyIgOiAiZSIgKSArICInPiIgKyBuZXh0VGV4dCArICI8L3NwYW4+PC9hPiIgOgoJCQkoIGhpZGVJZk5vUHJldk5leHQgPyAiIiA6ICI8YSBjbGFzcz0ndWktZGF0ZXBpY2tlci1uZXh0IHVpLWNvcm5lci1hbGwgdWktc3RhdGUtZGlzYWJsZWQnIHRpdGxlPSciICsgbmV4dFRleHQgKyAiJz48c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWNpcmNsZS10cmlhbmdsZS0iICsgKCBpc1JUTCA\/ICJ3IiA6ICJlIiApICsgIic+IiArIG5leHRUZXh0ICsgIjwvc3Bhbj48L2E+IiApICk7CgoJCWN1cnJlbnRUZXh0ID0gdGhpcy5fZ2V0KCBpbnN0LCAiY3VycmVudFRleHQiICk7CgkJZ290b0RhdGUgPSAoIHRoaXMuX2dldCggaW5zdCwgImdvdG9DdXJyZW50IiApICYmIGluc3QuY3VycmVudERheSA\/IGN1cnJlbnREYXRlIDogdG9kYXkgKTsKCQljdXJyZW50VGV4dCA9ICggIW5hdmlnYXRpb25Bc0RhdGVGb3JtYXQgPyBjdXJyZW50VGV4dCA6CgkJCXRoaXMuZm9ybWF0RGF0ZSggY3VycmVudFRleHQsIGdvdG9EYXRlLCB0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApICk7CgoJCWNvbnRyb2xzID0gKCAhaW5zdC5pbmxpbmUgPyAiPGJ1dHRvbiB0eXBlPSdidXR0b24nIGNsYXNzPSd1aS1kYXRlcGlja2VyLWNsb3NlIHVpLXN0YXRlLWRlZmF1bHQgdWktcHJpb3JpdHktcHJpbWFyeSB1aS1jb3JuZXItYWxsJyBkYXRhLWhhbmRsZXI9J2hpZGUnIGRhdGEtZXZlbnQ9J2NsaWNrJz4iICsKCQkJdGhpcy5fZ2V0KCBpbnN0LCAiY2xvc2VUZXh0IiApICsgIjwvYnV0dG9uPiIgOiAiIiApOwoKCQlidXR0b25QYW5lbCA9ICggc2hvd0J1dHRvblBhbmVsICkgPyAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci1idXR0b25wYW5lIHVpLXdpZGdldC1jb250ZW50Jz4iICsgKCBpc1JUTCA\/IGNvbnRyb2xzIDogIiIgKSArCgkJCSggdGhpcy5faXNJblJhbmdlKCBpbnN0LCBnb3RvRGF0ZSApID8gIjxidXR0b24gdHlwZT0nYnV0dG9uJyBjbGFzcz0ndWktZGF0ZXBpY2tlci1jdXJyZW50IHVpLXN0YXRlLWRlZmF1bHQgdWktcHJpb3JpdHktc2Vjb25kYXJ5IHVpLWNvcm5lci1hbGwnIGRhdGEtaGFuZGxlcj0ndG9kYXknIGRhdGEtZXZlbnQ9J2NsaWNrJyIgKwoJCQkiPiIgKyBjdXJyZW50VGV4dCArICI8L2J1dHRvbj4iIDogIiIgKSArICggaXNSVEwgPyAiIiA6IGNvbnRyb2xzICkgKyAiPC9kaXY+IiA6ICIiOwoKCQlmaXJzdERheSA9IHBhcnNlSW50KCB0aGlzLl9nZXQoIGluc3QsICJmaXJzdERheSIgKSwgMTAgKTsKCQlmaXJzdERheSA9ICggaXNOYU4oIGZpcnN0RGF5ICkgPyAwIDogZmlyc3REYXkgKTsKCgkJc2hvd1dlZWsgPSB0aGlzLl9nZXQoIGluc3QsICJzaG93V2VlayIgKTsKCQlkYXlOYW1lcyA9IHRoaXMuX2dldCggaW5zdCwgImRheU5hbWVzIiApOwoJCWRheU5hbWVzTWluID0gdGhpcy5fZ2V0KCBpbnN0LCAiZGF5TmFtZXNNaW4iICk7CgkJbW9udGhOYW1lcyA9IHRoaXMuX2dldCggaW5zdCwgIm1vbnRoTmFtZXMiICk7CgkJbW9udGhOYW1lc1Nob3J0ID0gdGhpcy5fZ2V0KCBpbnN0LCAibW9udGhOYW1lc1Nob3J0IiApOwoJCWJlZm9yZVNob3dEYXkgPSB0aGlzLl9nZXQoIGluc3QsICJiZWZvcmVTaG93RGF5IiApOwoJCXNob3dPdGhlck1vbnRocyA9IHRoaXMuX2dldCggaW5zdCwgInNob3dPdGhlck1vbnRocyIgKTsKCQlzZWxlY3RPdGhlck1vbnRocyA9IHRoaXMuX2dldCggaW5zdCwgInNlbGVjdE90aGVyTW9udGhzIiApOwoJCWRlZmF1bHREYXRlID0gdGhpcy5fZ2V0RGVmYXVsdERhdGUoIGluc3QgKTsKCQlodG1sID0gIiI7CgoJCWZvciAoIHJvdyA9IDA7IHJvdyA8IG51bU1vbnRoc1sgMCBdOyByb3crKyApIHsKCQkJZ3JvdXAgPSAiIjsKCQkJdGhpcy5tYXhSb3dzID0gNDsKCQkJZm9yICggY29sID0gMDsgY29sIDwgbnVtTW9udGhzWyAxIF07IGNvbCsrICkgewoJCQkJc2VsZWN0ZWREYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBkcmF3WWVhciwgZHJhd01vbnRoLCBpbnN0LnNlbGVjdGVkRGF5ICkgKTsKCQkJCWNvcm5lckNsYXNzID0gIiB1aS1jb3JuZXItYWxsIjsKCQkJCWNhbGVuZGVyID0gIiI7CgkJCQlpZiAoIGlzTXVsdGlNb250aCApIHsKCQkJCQljYWxlbmRlciArPSAiPGRpdiBjbGFzcz0ndWktZGF0ZXBpY2tlci1ncm91cCI7CgkJCQkJaWYgKCBudW1Nb250aHNbIDEgXSA+IDEgKSB7CgkJCQkJCXN3aXRjaCAoIGNvbCApIHsKCQkJCQkJCWNhc2UgMDogY2FsZW5kZXIgKz0gIiB1aS1kYXRlcGlja2VyLWdyb3VwLWZpcnN0IjsKCQkJCQkJCQljb3JuZXJDbGFzcyA9ICIgdWktY29ybmVyLSIgKyAoIGlzUlRMID8gInJpZ2h0IiA6ICJsZWZ0IiApOyBicmVhazsKCQkJCQkJCWNhc2UgbnVtTW9udGhzWyAxIF0gLSAxOiBjYWxlbmRlciArPSAiIHVpLWRhdGVwaWNrZXItZ3JvdXAtbGFzdCI7CgkJCQkJCQkJY29ybmVyQ2xhc3MgPSAiIHVpLWNvcm5lci0iICsgKCBpc1JUTCA\/ICJsZWZ0IiA6ICJyaWdodCIgKTsgYnJlYWs7CgkJCQkJCQlkZWZhdWx0OiBjYWxlbmRlciArPSAiIHVpLWRhdGVwaWNrZXItZ3JvdXAtbWlkZGxlIjsgY29ybmVyQ2xhc3MgPSAiIjsgYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJY2FsZW5kZXIgKz0gIic+IjsKCQkJCX0KCQkJCWNhbGVuZGVyICs9ICI8ZGl2IGNsYXNzPSd1aS1kYXRlcGlja2VyLWhlYWRlciB1aS13aWRnZXQtaGVhZGVyIHVpLWhlbHBlci1jbGVhcmZpeCIgKyBjb3JuZXJDbGFzcyArICInPiIgKwoJCQkJCSggL2FsbHxsZWZ0Ly50ZXN0KCBjb3JuZXJDbGFzcyApICYmIHJvdyA9PT0gMCA\/ICggaXNSVEwgPyBuZXh0IDogcHJldiApIDogIiIgKSArCgkJCQkJKCAvYWxsfHJpZ2h0Ly50ZXN0KCBjb3JuZXJDbGFzcyApICYmIHJvdyA9PT0gMCA\/ICggaXNSVEwgPyBwcmV2IDogbmV4dCApIDogIiIgKSArCgkJCQkJdGhpcy5fZ2VuZXJhdGVNb250aFllYXJIZWFkZXIoIGluc3QsIGRyYXdNb250aCwgZHJhd1llYXIsIG1pbkRhdGUsIG1heERhdGUsCgkJCQkJcm93ID4gMCB8fCBjb2wgPiAwLCBtb250aE5hbWVzLCBtb250aE5hbWVzU2hvcnQgKSArIC8vIGRyYXcgbW9udGggaGVhZGVycwoJCQkJCSI8L2Rpdj48dGFibGUgY2xhc3M9J3VpLWRhdGVwaWNrZXItY2FsZW5kYXInPjx0aGVhZD4iICsKCQkJCQkiPHRyPiI7CgkJCQl0aGVhZCA9ICggc2hvd1dlZWsgPyAiPHRoIGNsYXNzPSd1aS1kYXRlcGlja2VyLXdlZWstY29sJz4iICsgdGhpcy5fZ2V0KCBpbnN0LCAid2Vla0hlYWRlciIgKSArICI8L3RoPiIgOiAiIiApOwoJCQkJZm9yICggZG93ID0gMDsgZG93IDwgNzsgZG93KysgKSB7IC8vIGRheXMgb2YgdGhlIHdlZWsKCQkJCQlkYXkgPSAoIGRvdyArIGZpcnN0RGF5ICkgJSA3OwoJCQkJCXRoZWFkICs9ICI8dGggc2NvcGU9J2NvbCciICsgKCAoIGRvdyArIGZpcnN0RGF5ICsgNiApICUgNyA+PSA1ID8gIiBjbGFzcz0ndWktZGF0ZXBpY2tlci13ZWVrLWVuZCciIDogIiIgKSArICI+IiArCgkJCQkJCSI8c3BhbiB0aXRsZT0nIiArIGRheU5hbWVzWyBkYXkgXSArICInPiIgKyBkYXlOYW1lc01pblsgZGF5IF0gKyAiPC9zcGFuPjwvdGg+IjsKCQkJCX0KCQkJCWNhbGVuZGVyICs9IHRoZWFkICsgIjwvdHI+PC90aGVhZD48dGJvZHk+IjsKCQkJCWRheXNJbk1vbnRoID0gdGhpcy5fZ2V0RGF5c0luTW9udGgoIGRyYXdZZWFyLCBkcmF3TW9udGggKTsKCQkJCWlmICggZHJhd1llYXIgPT09IGluc3Quc2VsZWN0ZWRZZWFyICYmIGRyYXdNb250aCA9PT0gaW5zdC5zZWxlY3RlZE1vbnRoICkgewoJCQkJCWluc3Quc2VsZWN0ZWREYXkgPSBNYXRoLm1pbiggaW5zdC5zZWxlY3RlZERheSwgZGF5c0luTW9udGggKTsKCQkJCX0KCQkJCWxlYWREYXlzID0gKCB0aGlzLl9nZXRGaXJzdERheU9mTW9udGgoIGRyYXdZZWFyLCBkcmF3TW9udGggKSAtIGZpcnN0RGF5ICsgNyApICUgNzsKCQkJCWN1clJvd3MgPSBNYXRoLmNlaWwoICggbGVhZERheXMgKyBkYXlzSW5Nb250aCApIC8gNyApOyAvLyBjYWxjdWxhdGUgdGhlIG51bWJlciBvZiByb3dzIHRvIGdlbmVyYXRlCgkJCQludW1Sb3dzID0gKCBpc011bHRpTW9udGggPyB0aGlzLm1heFJvd3MgPiBjdXJSb3dzID8gdGhpcy5tYXhSb3dzIDogY3VyUm93cyA6IGN1clJvd3MgKTsgLy9JZiBtdWx0aXBsZSBtb250aHMsIHVzZSB0aGUgaGlnaGVyIG51bWJlciBvZiByb3dzIChzZWUgIzcwNDMpCgkJCQl0aGlzLm1heFJvd3MgPSBudW1Sb3dzOwoJCQkJcHJpbnREYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBkcmF3WWVhciwgZHJhd01vbnRoLCAxIC0gbGVhZERheXMgKSApOwoJCQkJZm9yICggZFJvdyA9IDA7IGRSb3cgPCBudW1Sb3dzOyBkUm93KysgKSB7IC8vIGNyZWF0ZSBkYXRlIHBpY2tlciByb3dzCgkJCQkJY2FsZW5kZXIgKz0gIjx0cj4iOwoJCQkJCXRib2R5ID0gKCAhc2hvd1dlZWsgPyAiIiA6ICI8dGQgY2xhc3M9J3VpLWRhdGVwaWNrZXItd2Vlay1jb2wnPiIgKwoJCQkJCQl0aGlzLl9nZXQoIGluc3QsICJjYWxjdWxhdGVXZWVrIiApKCBwcmludERhdGUgKSArICI8L3RkPiIgKTsKCQkJCQlmb3IgKCBkb3cgPSAwOyBkb3cgPCA3OyBkb3crKyApIHsgLy8gY3JlYXRlIGRhdGUgcGlja2VyIGRheXMKCQkJCQkJZGF5U2V0dGluZ3MgPSAoIGJlZm9yZVNob3dEYXkgPwoJCQkJCQkJYmVmb3JlU2hvd0RheS5hcHBseSggKCBpbnN0LmlucHV0ID8gaW5zdC5pbnB1dFsgMCBdIDogbnVsbCApLCBbIHByaW50RGF0ZSBdICkgOiBbIHRydWUsICIiIF0gKTsKCQkJCQkJb3RoZXJNb250aCA9ICggcHJpbnREYXRlLmdldE1vbnRoKCkgIT09IGRyYXdNb250aCApOwoJCQkJCQl1bnNlbGVjdGFibGUgPSAoIG90aGVyTW9udGggJiYgIXNlbGVjdE90aGVyTW9udGhzICkgfHwgIWRheVNldHRpbmdzWyAwIF0gfHwKCQkJCQkJCSggbWluRGF0ZSAmJiBwcmludERhdGUgPCBtaW5EYXRlICkgfHwgKCBtYXhEYXRlICYmIHByaW50RGF0ZSA+IG1heERhdGUgKTsKCQkJCQkJdGJvZHkgKz0gIjx0ZCBjbGFzcz0nIiArCgkJCQkJCQkoICggZG93ICsgZmlyc3REYXkgKyA2ICkgJSA3ID49IDUgPyAiIHVpLWRhdGVwaWNrZXItd2Vlay1lbmQiIDogIiIgKSArIC8vIGhpZ2hsaWdodCB3ZWVrZW5kcwoJCQkJCQkJKCBvdGhlck1vbnRoID8gIiB1aS1kYXRlcGlja2VyLW90aGVyLW1vbnRoIiA6ICIiICkgKyAvLyBoaWdobGlnaHQgZGF5cyBmcm9tIG90aGVyIG1vbnRocwoJCQkJCQkJKCAoIHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IHNlbGVjdGVkRGF0ZS5nZXRUaW1lKCkgJiYgZHJhd01vbnRoID09PSBpbnN0LnNlbGVjdGVkTW9udGggJiYgaW5zdC5fa2V5RXZlbnQgKSB8fCAvLyB1c2VyIHByZXNzZWQga2V5CgkJCQkJCQkoIGRlZmF1bHREYXRlLmdldFRpbWUoKSA9PT0gcHJpbnREYXRlLmdldFRpbWUoKSAmJiBkZWZhdWx0RGF0ZS5nZXRUaW1lKCkgPT09IHNlbGVjdGVkRGF0ZS5nZXRUaW1lKCkgKSA\/CgoJCQkJCQkJLy8gb3IgZGVmYXVsdERhdGUgaXMgY3VycmVudCBwcmludGVkRGF0ZSBhbmQgZGVmYXVsdERhdGUgaXMgc2VsZWN0ZWREYXRlCgkJCQkJCQkiICIgKyB0aGlzLl9kYXlPdmVyQ2xhc3MgOiAiIiApICsgLy8gaGlnaGxpZ2h0IHNlbGVjdGVkIGRheQoJCQkJCQkJKCB1bnNlbGVjdGFibGUgPyAiICIgKyB0aGlzLl91bnNlbGVjdGFibGVDbGFzcyArICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArICAvLyBoaWdobGlnaHQgdW5zZWxlY3RhYmxlIGRheXMKCQkJCQkJCSggb3RoZXJNb250aCAmJiAhc2hvd090aGVyTW9udGhzID8gIiIgOiAiICIgKyBkYXlTZXR0aW5nc1sgMSBdICsgLy8gaGlnaGxpZ2h0IGN1c3RvbSBkYXRlcwoJCQkJCQkJKCBwcmludERhdGUuZ2V0VGltZSgpID09PSBjdXJyZW50RGF0ZS5nZXRUaW1lKCkgPyAiICIgKyB0aGlzLl9jdXJyZW50Q2xhc3MgOiAiIiApICsgLy8gaGlnaGxpZ2h0IHNlbGVjdGVkIGRheQoJCQkJCQkJKCBwcmludERhdGUuZ2V0VGltZSgpID09PSB0b2RheS5nZXRUaW1lKCkgPyAiIHVpLWRhdGVwaWNrZXItdG9kYXkiIDogIiIgKSApICsgIiciICsgLy8gaGlnaGxpZ2h0IHRvZGF5IChpZiBkaWZmZXJlbnQpCgkJCQkJCQkoICggIW90aGVyTW9udGggfHwgc2hvd090aGVyTW9udGhzICkgJiYgZGF5U2V0dGluZ3NbIDIgXSA\/ICIgdGl0bGU9JyIgKyBkYXlTZXR0aW5nc1sgMiBdLnJlcGxhY2UoIC8nL2csICImIzM5OyIgKSArICInIiA6ICIiICkgKyAvLyBjZWxsIHRpdGxlCgkJCQkJCQkoIHVuc2VsZWN0YWJsZSA\/ICIiIDogIiBkYXRhLWhhbmRsZXI9J3NlbGVjdERheScgZGF0YS1ldmVudD0nY2xpY2snIGRhdGEtbW9udGg9JyIgKyBwcmludERhdGUuZ2V0TW9udGgoKSArICInIGRhdGEteWVhcj0nIiArIHByaW50RGF0ZS5nZXRGdWxsWWVhcigpICsgIiciICkgKyAiPiIgKyAvLyBhY3Rpb25zCgkJCQkJCQkoIG90aGVyTW9udGggJiYgIXNob3dPdGhlck1vbnRocyA\/ICImI3hhMDsiIDogLy8gZGlzcGxheSBmb3Igb3RoZXIgbW9udGhzCgkJCQkJCQkoIHVuc2VsZWN0YWJsZSA\/ICI8c3BhbiBjbGFzcz0ndWktc3RhdGUtZGVmYXVsdCc+IiArIHByaW50RGF0ZS5nZXREYXRlKCkgKyAiPC9zcGFuPiIgOiAiPGEgY2xhc3M9J3VpLXN0YXRlLWRlZmF1bHQiICsKCQkJCQkJCSggcHJpbnREYXRlLmdldFRpbWUoKSA9PT0gdG9kYXkuZ2V0VGltZSgpID8gIiB1aS1zdGF0ZS1oaWdobGlnaHQiIDogIiIgKSArCgkJCQkJCQkoIHByaW50RGF0ZS5nZXRUaW1lKCkgPT09IGN1cnJlbnREYXRlLmdldFRpbWUoKSA\/ICIgdWktc3RhdGUtYWN0aXZlIiA6ICIiICkgKyAvLyBoaWdobGlnaHQgc2VsZWN0ZWQgZGF5CgkJCQkJCQkoIG90aGVyTW9udGggPyAiIHVpLXByaW9yaXR5LXNlY29uZGFyeSIgOiAiIiApICsgLy8gZGlzdGluZ3Vpc2ggZGF0ZXMgZnJvbSBvdGhlciBtb250aHMKCQkJCQkJCSInIGhyZWY9JyMnPiIgKyBwcmludERhdGUuZ2V0RGF0ZSgpICsgIjwvYT4iICkgKSArICI8L3RkPiI7IC8vIGRpc3BsYXkgc2VsZWN0YWJsZSBkYXRlCgkJCQkJCXByaW50RGF0ZS5zZXREYXRlKCBwcmludERhdGUuZ2V0RGF0ZSgpICsgMSApOwoJCQkJCQlwcmludERhdGUgPSB0aGlzLl9kYXlsaWdodFNhdmluZ0FkanVzdCggcHJpbnREYXRlICk7CgkJCQkJfQoJCQkJCWNhbGVuZGVyICs9IHRib2R5ICsgIjwvdHI+IjsKCQkJCX0KCQkJCWRyYXdNb250aCsrOwoJCQkJaWYgKCBkcmF3TW9udGggPiAxMSApIHsKCQkJCQlkcmF3TW9udGggPSAwOwoJCQkJCWRyYXdZZWFyKys7CgkJCQl9CgkJCQljYWxlbmRlciArPSAiPC90Ym9keT48L3RhYmxlPiIgKyAoIGlzTXVsdGlNb250aCA\/ICI8L2Rpdj4iICsKCQkJCQkJCSggKCBudW1Nb250aHNbIDAgXSA+IDAgJiYgY29sID09PSBudW1Nb250aHNbIDEgXSAtIDEgKSA\/ICI8ZGl2IGNsYXNzPSd1aS1kYXRlcGlja2VyLXJvdy1icmVhayc+PC9kaXY+IiA6ICIiICkgOiAiIiApOwoJCQkJZ3JvdXAgKz0gY2FsZW5kZXI7CgkJCX0KCQkJaHRtbCArPSBncm91cDsKCQl9CgkJaHRtbCArPSBidXR0b25QYW5lbDsKCQlpbnN0Ll9rZXlFdmVudCA9IGZhbHNlOwoJCXJldHVybiBodG1sOwoJfSwKCgkvKiBHZW5lcmF0ZSB0aGUgbW9udGggYW5kIHllYXIgaGVhZGVyLiAqLwoJX2dlbmVyYXRlTW9udGhZZWFySGVhZGVyOiBmdW5jdGlvbiggaW5zdCwgZHJhd01vbnRoLCBkcmF3WWVhciwgbWluRGF0ZSwgbWF4RGF0ZSwKCQkJc2Vjb25kYXJ5LCBtb250aE5hbWVzLCBtb250aE5hbWVzU2hvcnQgKSB7CgoJCXZhciBpbk1pblllYXIsIGluTWF4WWVhciwgbW9udGgsIHllYXJzLCB0aGlzWWVhciwgZGV0ZXJtaW5lWWVhciwgeWVhciwgZW5kWWVhciwKCQkJY2hhbmdlTW9udGggPSB0aGlzLl9nZXQoIGluc3QsICJjaGFuZ2VNb250aCIgKSwKCQkJY2hhbmdlWWVhciA9IHRoaXMuX2dldCggaW5zdCwgImNoYW5nZVllYXIiICksCgkJCVRhbXBpbFRhaHVuID0gdGhpcy5fZ2V0KCBpbnN0LCAiVGFtcGlsVGFodW4iICksCgkJCXNob3dNb250aEFmdGVyWWVhciA9IHRoaXMuX2dldCggaW5zdCwgInNob3dNb250aEFmdGVyWWVhciIgKSwKCQkJaHRtbCA9ICI8ZGl2IGNsYXNzPSd1aS1kYXRlcGlja2VyLXRpdGxlJz4iLAoJCQltb250aEh0bWwgPSAiIjsKCgkJLy8gTW9udGggc2VsZWN0aW9uCgkJaWYgKCBzZWNvbmRhcnkgfHwgIWNoYW5nZU1vbnRoICkgewoJCQltb250aEh0bWwgKz0gIjxzcGFuIGNsYXNzPSd1aS1kYXRlcGlja2VyLW1vbnRoJz4iICsgbW9udGhOYW1lc1sgZHJhd01vbnRoIF0gKyAiPC9zcGFuPiI7CgkJfSBlbHNlIHsKCQkJaW5NaW5ZZWFyID0gKCBtaW5EYXRlICYmIG1pbkRhdGUuZ2V0RnVsbFllYXIoKSA9PT0gZHJhd1llYXIgKTsKCQkJaW5NYXhZZWFyID0gKCBtYXhEYXRlICYmIG1heERhdGUuZ2V0RnVsbFllYXIoKSA9PT0gZHJhd1llYXIgKTsKCQkJbW9udGhIdG1sICs9ICI8c2VsZWN0IGNsYXNzPSd1aS1kYXRlcGlja2VyLW1vbnRoJyBkYXRhLWhhbmRsZXI9J3NlbGVjdE1vbnRoJyBkYXRhLWV2ZW50PSdjaGFuZ2UnPiI7CgkJCWZvciAoIG1vbnRoID0gMDsgbW9udGggPCAxMjsgbW9udGgrKyApIHsKCQkJCWlmICggKCAhaW5NaW5ZZWFyIHx8IG1vbnRoID49IG1pbkRhdGUuZ2V0TW9udGgoKSApICYmICggIWluTWF4WWVhciB8fCBtb250aCA8PSBtYXhEYXRlLmdldE1vbnRoKCkgKSApIHsKCQkJCQltb250aEh0bWwgKz0gIjxvcHRpb24gdmFsdWU9JyIgKyBtb250aCArICInIiArCgkJCQkJCSggbW9udGggPT09IGRyYXdNb250aCA\/ICIgc2VsZWN0ZWQ9J3NlbGVjdGVkJyIgOiAiIiApICsKCQkJCQkJIj4iICsgbW9udGhOYW1lc1Nob3J0WyBtb250aCBdICsgIjwvb3B0aW9uPiI7CgkJCQl9CgkJCX0KCQkJbW9udGhIdG1sICs9ICI8L3NlbGVjdD4iOwoJCX0KCgkJaWYgKCAhc2hvd01vbnRoQWZ0ZXJZZWFyICkgewoJCQlodG1sICs9IG1vbnRoSHRtbCArICggc2Vjb25kYXJ5IHx8ICEoIGNoYW5nZU1vbnRoICYmIGNoYW5nZVllYXIgKSA\/ICImI3hhMDsiIDogIiIgKTsKCQl9CgoJCS8vIFllYXIgc2VsZWN0aW9uCgkJaWYgKCAhaW5zdC55ZWFyc2h0bWwgKSB7CgkJCWluc3QueWVhcnNodG1sID0gIiI7CgkJCWlmICggc2Vjb25kYXJ5IHx8ICFjaGFuZ2VZZWFyKSB7CgkJCQlVbnR1a0RyYXdZZWFyID0gVGFtcGlsVGFodW4gPT0gZmFsc2U\/IiI6ZHJhd1llYXI7CQkJCQoJCQkJaHRtbCArPSAiPHNwYW4gY2xhc3M9J3VpLWRhdGVwaWNrZXIteWVhcic+IiArIFVudHVrRHJhd1llYXIgKyAiPC9zcGFuPiI7CgkJCX1lbHNlIHsKCgkJCQkvLyBkZXRlcm1pbmUgcmFuZ2Ugb2YgeWVhcnMgdG8gZGlzcGxheQoJCQkJeWVhcnMgPSB0aGlzLl9nZXQoIGluc3QsICJ5ZWFyUmFuZ2UiICkuc3BsaXQoICI6IiApOwoJCQkJdGhpc1llYXIgPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7CgkJCQlkZXRlcm1pbmVZZWFyID0gZnVuY3Rpb24oIHZhbHVlICkgewoJCQkJCXZhciB5ZWFyID0gKCB2YWx1ZS5tYXRjaCggL2NbK1wtXS4qLyApID8gZHJhd1llYXIgKyBwYXJzZUludCggdmFsdWUuc3Vic3RyaW5nKCAxICksIDEwICkgOgoJCQkJCQkoIHZhbHVlLm1hdGNoKCAvWytcLV0uKi8gKSA\/IHRoaXNZZWFyICsgcGFyc2VJbnQoIHZhbHVlLCAxMCApIDoKCQkJCQkJcGFyc2VJbnQoIHZhbHVlLCAxMCApICkgKTsKCQkJCQlyZXR1cm4gKCBpc05hTiggeWVhciApID8gdGhpc1llYXIgOiB5ZWFyICk7CgkJCQl9OwoJCQkJeWVhciA9IGRldGVybWluZVllYXIoIHllYXJzWyAwIF0gKTsKCQkJCWVuZFllYXIgPSBNYXRoLm1heCggeWVhciwgZGV0ZXJtaW5lWWVhciggeWVhcnNbIDEgXSB8fCAiIiApICk7CgkJCQl5ZWFyID0gKCBtaW5EYXRlID8gTWF0aC5tYXgoIHllYXIsIG1pbkRhdGUuZ2V0RnVsbFllYXIoKSApIDogeWVhciApOwoJCQkJZW5kWWVhciA9ICggbWF4RGF0ZSA\/IE1hdGgubWluKCBlbmRZZWFyLCBtYXhEYXRlLmdldEZ1bGxZZWFyKCkgKSA6IGVuZFllYXIgKTsKCQkJCWluc3QueWVhcnNodG1sICs9ICI8c2VsZWN0IGNsYXNzPSd1aS1kYXRlcGlja2VyLXllYXInIGRhdGEtaGFuZGxlcj0nc2VsZWN0WWVhcicgZGF0YS1ldmVudD0nY2hhbmdlJz4iOwoJCQkJZm9yICggOyB5ZWFyIDw9IGVuZFllYXI7IHllYXIrKyApIHsKCQkJCQlpbnN0LnllYXJzaHRtbCArPSAiPG9wdGlvbiB2YWx1ZT0nIiArIHllYXIgKyAiJyIgKwoJCQkJCQkoIHllYXIgPT09IGRyYXdZZWFyID8gIiBzZWxlY3RlZD0nc2VsZWN0ZWQnIiA6ICIiICkgKwoJCQkJCQkiPiIgKyB5ZWFyICsgIjwvb3B0aW9uPiI7CgkJCQl9CgkJCQlpbnN0LnllYXJzaHRtbCArPSAiPC9zZWxlY3Q+IjsKCgkJCQlodG1sICs9IGluc3QueWVhcnNodG1sOwoJCQkJaW5zdC55ZWFyc2h0bWwgPSBudWxsOwoJCQl9CgkJfQoKCQlodG1sICs9IHRoaXMuX2dldCggaW5zdCwgInllYXJTdWZmaXgiICk7CgkJaWYgKCBzaG93TW9udGhBZnRlclllYXIgKSB7CgkJCWh0bWwgKz0gKCBzZWNvbmRhcnkgfHwgISggY2hhbmdlTW9udGggJiYgY2hhbmdlWWVhciApID8gIiYjeGEwOyIgOiAiIiApICsgbW9udGhIdG1sOwoJCX0KCQlodG1sICs9ICI8L2Rpdj4iOyAvLyBDbG9zZSBkYXRlcGlja2VyX2hlYWRlcgoJCXJldHVybiBodG1sOwoJfSwKCgkvKiBBZGp1c3Qgb25lIG9mIHRoZSBkYXRlIHN1Yi1maWVsZHMuICovCglfYWRqdXN0SW5zdERhdGU6IGZ1bmN0aW9uKCBpbnN0LCBvZmZzZXQsIHBlcmlvZCApIHsKCQl2YXIgeWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyICsgKCBwZXJpb2QgPT09ICJZIiA\/IG9mZnNldCA6IDAgKSwKCQkJbW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggKyAoIHBlcmlvZCA9PT0gIk0iID8gb2Zmc2V0IDogMCApLAoJCQlkYXkgPSBNYXRoLm1pbiggaW5zdC5zZWxlY3RlZERheSwgdGhpcy5fZ2V0RGF5c0luTW9udGgoIHllYXIsIG1vbnRoICkgKSArICggcGVyaW9kID09PSAiRCIgPyBvZmZzZXQgOiAwICksCgkJCWRhdGUgPSB0aGlzLl9yZXN0cmljdE1pbk1heCggaW5zdCwgdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCB5ZWFyLCBtb250aCwgZGF5ICkgKSApOwoKCQlpbnN0LnNlbGVjdGVkRGF5ID0gZGF0ZS5nZXREYXRlKCk7CgkJaW5zdC5kcmF3TW9udGggPSBpbnN0LnNlbGVjdGVkTW9udGggPSBkYXRlLmdldE1vbnRoKCk7CgkJaW5zdC5kcmF3WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpOwoJCWlmICggcGVyaW9kID09PSAiTSIgfHwgcGVyaW9kID09PSAiWSIgKSB7CgkJCXRoaXMuX25vdGlmeUNoYW5nZSggaW5zdCApOwoJCX0KCX0sCgoJLyogRW5zdXJlIGEgZGF0ZSBpcyB3aXRoaW4gYW55IG1pbi9tYXggYm91bmRzLiAqLwoJX3Jlc3RyaWN0TWluTWF4OiBmdW5jdGlvbiggaW5zdCwgZGF0ZSApIHsKCQl2YXIgbWluRGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtaW4iICksCgkJCW1heERhdGUgPSB0aGlzLl9nZXRNaW5NYXhEYXRlKCBpbnN0LCAibWF4IiApLAoJCQluZXdEYXRlID0gKCBtaW5EYXRlICYmIGRhdGUgPCBtaW5EYXRlID8gbWluRGF0ZSA6IGRhdGUgKTsKCQlyZXR1cm4gKCBtYXhEYXRlICYmIG5ld0RhdGUgPiBtYXhEYXRlID8gbWF4RGF0ZSA6IG5ld0RhdGUgKTsKCX0sCgoJLyogTm90aWZ5IGNoYW5nZSBvZiBtb250aC95ZWFyLiAqLwoJX25vdGlmeUNoYW5nZTogZnVuY3Rpb24oIGluc3QgKSB7CgkJdmFyIG9uQ2hhbmdlID0gdGhpcy5fZ2V0KCBpbnN0LCAib25DaGFuZ2VNb250aFllYXIiICk7CgkJaWYgKCBvbkNoYW5nZSApIHsKCQkJb25DaGFuZ2UuYXBwbHkoICggaW5zdC5pbnB1dCA\/IGluc3QuaW5wdXRbIDAgXSA6IG51bGwgKSwKCQkJCVsgaW5zdC5zZWxlY3RlZFllYXIsIGluc3Quc2VsZWN0ZWRNb250aCArIDEsIGluc3QgXSApOwoJCX0KCX0sCgoJLyogRGV0ZXJtaW5lIHRoZSBudW1iZXIgb2YgbW9udGhzIHRvIHNob3cuICovCglfZ2V0TnVtYmVyT2ZNb250aHM6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXZhciBudW1Nb250aHMgPSB0aGlzLl9nZXQoIGluc3QsICJudW1iZXJPZk1vbnRocyIgKTsKCQlyZXR1cm4gKCBudW1Nb250aHMgPT0gbnVsbCA\/IFsgMSwgMSBdIDogKCB0eXBlb2YgbnVtTW9udGhzID09PSAibnVtYmVyIiA\/IFsgMSwgbnVtTW9udGhzIF0gOiBudW1Nb250aHMgKSApOwoJfSwKCgkvKiBEZXRlcm1pbmUgdGhlIGN1cnJlbnQgbWF4aW11bSBkYXRlIC0gZW5zdXJlIG5vIHRpbWUgY29tcG9uZW50cyBhcmUgc2V0LiAqLwoJX2dldE1pbk1heERhdGU6IGZ1bmN0aW9uKCBpbnN0LCBtaW5NYXggKSB7CgkJcmV0dXJuIHRoaXMuX2RldGVybWluZURhdGUoIGluc3QsIHRoaXMuX2dldCggaW5zdCwgbWluTWF4ICsgIkRhdGUiICksIG51bGwgKTsKCX0sCgoJLyogRmluZCB0aGUgbnVtYmVyIG9mIGRheXMgaW4gYSBnaXZlbiBtb250aC4gKi8KCV9nZXREYXlzSW5Nb250aDogZnVuY3Rpb24oIHllYXIsIG1vbnRoICkgewoJCXJldHVybiAzMiAtIHRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggeWVhciwgbW9udGgsIDMyICkgKS5nZXREYXRlKCk7Cgl9LAoKCS8qIEZpbmQgdGhlIGRheSBvZiB0aGUgd2VlayBvZiB0aGUgZmlyc3Qgb2YgYSBtb250aC4gKi8KCV9nZXRGaXJzdERheU9mTW9udGg6IGZ1bmN0aW9uKCB5ZWFyLCBtb250aCApIHsKCQlyZXR1cm4gbmV3IERhdGUoIHllYXIsIG1vbnRoLCAxICkuZ2V0RGF5KCk7Cgl9LAoKCS8qIERldGVybWluZXMgaWYgd2Ugc2hvdWxkIGFsbG93IGEgIm5leHQvcHJldiIgbW9udGggZGlzcGxheSBjaGFuZ2UuICovCglfY2FuQWRqdXN0TW9udGg6IGZ1bmN0aW9uKCBpbnN0LCBvZmZzZXQsIGN1clllYXIsIGN1ck1vbnRoICkgewoJCXZhciBudW1Nb250aHMgPSB0aGlzLl9nZXROdW1iZXJPZk1vbnRocyggaW5zdCApLAoJCQlkYXRlID0gdGhpcy5fZGF5bGlnaHRTYXZpbmdBZGp1c3QoIG5ldyBEYXRlKCBjdXJZZWFyLAoJCQljdXJNb250aCArICggb2Zmc2V0IDwgMCA\/IG9mZnNldCA6IG51bU1vbnRoc1sgMCBdICogbnVtTW9udGhzWyAxIF0gKSwgMSApICk7CgoJCWlmICggb2Zmc2V0IDwgMCApIHsKCQkJZGF0ZS5zZXREYXRlKCB0aGlzLl9nZXREYXlzSW5Nb250aCggZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCkgKSApOwoJCX0KCQlyZXR1cm4gdGhpcy5faXNJblJhbmdlKCBpbnN0LCBkYXRlICk7Cgl9LAoKCS8qIElzIHRoZSBnaXZlbiBkYXRlIGluIHRoZSBhY2NlcHRlZCByYW5nZT8gKi8KCV9pc0luUmFuZ2U6IGZ1bmN0aW9uKCBpbnN0LCBkYXRlICkgewoJCXZhciB5ZWFyU3BsaXQsIGN1cnJlbnRZZWFyLAoJCQltaW5EYXRlID0gdGhpcy5fZ2V0TWluTWF4RGF0ZSggaW5zdCwgIm1pbiIgKSwKCQkJbWF4RGF0ZSA9IHRoaXMuX2dldE1pbk1heERhdGUoIGluc3QsICJtYXgiICksCgkJCW1pblllYXIgPSBudWxsLAoJCQltYXhZZWFyID0gbnVsbCwKCQkJeWVhcnMgPSB0aGlzLl9nZXQoIGluc3QsICJ5ZWFyUmFuZ2UiICk7CgkJCWlmICggeWVhcnMgKSB7CgkJCQl5ZWFyU3BsaXQgPSB5ZWFycy5zcGxpdCggIjoiICk7CgkJCQljdXJyZW50WWVhciA9IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKTsKCQkJCW1pblllYXIgPSBwYXJzZUludCggeWVhclNwbGl0WyAwIF0sIDEwICk7CgkJCQltYXhZZWFyID0gcGFyc2VJbnQoIHllYXJTcGxpdFsgMSBdLCAxMCApOwoJCQkJaWYgKCB5ZWFyU3BsaXRbIDAgXS5tYXRjaCggL1srXC1dLiovICkgKSB7CgkJCQkJbWluWWVhciArPSBjdXJyZW50WWVhcjsKCQkJCX0KCQkJCWlmICggeWVhclNwbGl0WyAxIF0ubWF0Y2goIC9bK1wtXS4qLyApICkgewoJCQkJCW1heFllYXIgKz0gY3VycmVudFllYXI7CgkJCQl9CgkJCX0KCgkJcmV0dXJuICggKCAhbWluRGF0ZSB8fCBkYXRlLmdldFRpbWUoKSA+PSBtaW5EYXRlLmdldFRpbWUoKSApICYmCgkJCSggIW1heERhdGUgfHwgZGF0ZS5nZXRUaW1lKCkgPD0gbWF4RGF0ZS5nZXRUaW1lKCkgKSAmJgoJCQkoICFtaW5ZZWFyIHx8IGRhdGUuZ2V0RnVsbFllYXIoKSA+PSBtaW5ZZWFyICkgJiYKCQkJKCAhbWF4WWVhciB8fCBkYXRlLmdldEZ1bGxZZWFyKCkgPD0gbWF4WWVhciApICk7Cgl9LAoKCS8qIFByb3ZpZGUgdGhlIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3MgZm9yIGZvcm1hdHRpbmcvcGFyc2luZy4gKi8KCV9nZXRGb3JtYXRDb25maWc6IGZ1bmN0aW9uKCBpbnN0ICkgewoJCXZhciBzaG9ydFllYXJDdXRvZmYgPSB0aGlzLl9nZXQoIGluc3QsICJzaG9ydFllYXJDdXRvZmYiICk7CgkJc2hvcnRZZWFyQ3V0b2ZmID0gKCB0eXBlb2Ygc2hvcnRZZWFyQ3V0b2ZmICE9PSAic3RyaW5nIiA\/IHNob3J0WWVhckN1dG9mZiA6CgkJCW5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSAlIDEwMCArIHBhcnNlSW50KCBzaG9ydFllYXJDdXRvZmYsIDEwICkgKTsKCQlyZXR1cm4geyBzaG9ydFllYXJDdXRvZmY6IHNob3J0WWVhckN1dG9mZiwKCQkJZGF5TmFtZXNTaG9ydDogdGhpcy5fZ2V0KCBpbnN0LCAiZGF5TmFtZXNTaG9ydCIgKSwgZGF5TmFtZXM6IHRoaXMuX2dldCggaW5zdCwgImRheU5hbWVzIiApLAoJCQltb250aE5hbWVzU2hvcnQ6IHRoaXMuX2dldCggaW5zdCwgIm1vbnRoTmFtZXNTaG9ydCIgKSwgbW9udGhOYW1lczogdGhpcy5fZ2V0KCBpbnN0LCAibW9udGhOYW1lcyIgKSB9OwoJfSwKCgkvKiBGb3JtYXQgdGhlIGdpdmVuIGRhdGUgZm9yIGRpc3BsYXkuICovCglfZm9ybWF0RGF0ZTogZnVuY3Rpb24oIGluc3QsIGRheSwgbW9udGgsIHllYXIgKSB7CgkJaWYgKCAhZGF5ICkgewoJCQlpbnN0LmN1cnJlbnREYXkgPSBpbnN0LnNlbGVjdGVkRGF5OwoJCQlpbnN0LmN1cnJlbnRNb250aCA9IGluc3Quc2VsZWN0ZWRNb250aDsKCQkJaW5zdC5jdXJyZW50WWVhciA9IGluc3Quc2VsZWN0ZWRZZWFyOwoJCX0KCQl2YXIgZGF0ZSA9ICggZGF5ID8gKCB0eXBlb2YgZGF5ID09PSAib2JqZWN0IiA\/IGRheSA6CgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggeWVhciwgbW9udGgsIGRheSApICkgKSA6CgkJCXRoaXMuX2RheWxpZ2h0U2F2aW5nQWRqdXN0KCBuZXcgRGF0ZSggaW5zdC5jdXJyZW50WWVhciwgaW5zdC5jdXJyZW50TW9udGgsIGluc3QuY3VycmVudERheSApICkgKTsKCQlyZXR1cm4gdGhpcy5mb3JtYXREYXRlKCB0aGlzLl9nZXQoIGluc3QsICJkYXRlRm9ybWF0IiApLCBkYXRlLCB0aGlzLl9nZXRGb3JtYXRDb25maWcoIGluc3QgKSApOwoJfQp9ICk7CgovKgogKiBCaW5kIGhvdmVyIGV2ZW50cyBmb3IgZGF0ZXBpY2tlciBlbGVtZW50cy4KICogRG9uZSB2aWEgZGVsZWdhdGUgc28gdGhlIGJpbmRpbmcgb25seSBvY2N1cnMgb25jZSBpbiB0aGUgbGlmZXRpbWUgb2YgdGhlIHBhcmVudCBkaXYuCiAqIEdsb2JhbCBkYXRlcGlja2VyX2luc3RBY3RpdmUsIHNldCBieSBfdXBkYXRlRGF0ZXBpY2tlciBhbGxvd3MgdGhlIGhhbmRsZXJzIHRvIGZpbmQgdGhlaXIgd2F5IGJhY2sgdG8gdGhlIGFjdGl2ZSBwaWNrZXIuCiAqLwpmdW5jdGlvbiBkYXRlcGlja2VyX2JpbmRIb3ZlciggZHBEaXYgKSB7Cgl2YXIgc2VsZWN0b3IgPSAiYnV0dG9uLCAudWktZGF0ZXBpY2tlci1wcmV2LCAudWktZGF0ZXBpY2tlci1uZXh0LCAudWktZGF0ZXBpY2tlci1jYWxlbmRhciB0ZCBhIjsKCXJldHVybiBkcERpdi5vbiggIm1vdXNlb3V0Iiwgc2VsZWN0b3IsIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJaWYgKCB0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCAidWktZGF0ZXBpY2tlci1wcmV2IiApICE9PSAtMSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmVDbGFzcyggInVpLWRhdGVwaWNrZXItcHJldi1ob3ZlciIgKTsKCQkJfQoJCQlpZiAoIHRoaXMuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1kYXRlcGlja2VyLW5leHQiICkgIT09IC0xICkgewoJCQkJJCggdGhpcyApLnJlbW92ZUNsYXNzKCAidWktZGF0ZXBpY2tlci1uZXh0LWhvdmVyIiApOwoJCQl9CgkJfSApCgkJLm9uKCAibW91c2VvdmVyIiwgc2VsZWN0b3IsIGRhdGVwaWNrZXJfaGFuZGxlTW91c2VvdmVyICk7Cn0KCmZ1bmN0aW9uIGRhdGVwaWNrZXJfaGFuZGxlTW91c2VvdmVyKCkgewoJaWYgKCAhJC5kYXRlcGlja2VyLl9pc0Rpc2FibGVkRGF0ZXBpY2tlciggZGF0ZXBpY2tlcl9pbnN0QWN0aXZlLmlubGluZSA\/IGRhdGVwaWNrZXJfaW5zdEFjdGl2ZS5kcERpdi5wYXJlbnQoKVsgMCBdIDogZGF0ZXBpY2tlcl9pbnN0QWN0aXZlLmlucHV0WyAwIF0gKSApIHsKCQkkKCB0aGlzICkucGFyZW50cyggIi51aS1kYXRlcGlja2VyLWNhbGVuZGFyIiApLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJJCggdGhpcyApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJaWYgKCB0aGlzLmNsYXNzTmFtZS5pbmRleE9mKCAidWktZGF0ZXBpY2tlci1wcmV2IiApICE9PSAtMSApIHsKCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktZGF0ZXBpY2tlci1wcmV2LWhvdmVyIiApOwoJCX0KCQlpZiAoIHRoaXMuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1kYXRlcGlja2VyLW5leHQiICkgIT09IC0xICkgewoJCQkkKCB0aGlzICkuYWRkQ2xhc3MoICJ1aS1kYXRlcGlja2VyLW5leHQtaG92ZXIiICk7CgkJfQoJfQp9CgovKiBqUXVlcnkgZXh0ZW5kIG5vdyBpZ25vcmVzIG51bGxzISAqLwpmdW5jdGlvbiBkYXRlcGlja2VyX2V4dGVuZFJlbW92ZSggdGFyZ2V0LCBwcm9wcyApIHsKCSQuZXh0ZW5kKCB0YXJnZXQsIHByb3BzICk7Cglmb3IgKCB2YXIgbmFtZSBpbiBwcm9wcyApIHsKCQlpZiAoIHByb3BzWyBuYW1lIF0gPT0gbnVsbCApIHsKCQkJdGFyZ2V0WyBuYW1lIF0gPSBwcm9wc1sgbmFtZSBdOwoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn0KCi8qIEludm9rZSB0aGUgZGF0ZXBpY2tlciBmdW5jdGlvbmFsaXR5LgogICBAcGFyYW0gIG9wdGlvbnMgIHN0cmluZyAtIGEgY29tbWFuZCwgb3B0aW9uYWxseSBmb2xsb3dlZCBieSBhZGRpdGlvbmFsIHBhcmFtZXRlcnMgb3IKCQkJCQlPYmplY3QgLSBzZXR0aW5ncyBmb3IgYXR0YWNoaW5nIG5ldyBkYXRlcGlja2VyIGZ1bmN0aW9uYWxpdHkKICAgQHJldHVybiAgalF1ZXJ5IG9iamVjdCAqLwokLmZuLmRhdGVwaWNrZXIgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCgkvKiBWZXJpZnkgYW4gZW1wdHkgY29sbGVjdGlvbiB3YXNuJ3QgcGFzc2VkIC0gRml4ZXMgIzY5NzYgKi8KCWlmICggIXRoaXMubGVuZ3RoICkgewoJCXJldHVybiB0aGlzOwoJfQoKCS8qIEluaXRpYWxpc2UgdGhlIGRhdGUgcGlja2VyLiAqLwoJaWYgKCAhJC5kYXRlcGlja2VyLmluaXRpYWxpemVkICkgewoJCSQoIGRvY3VtZW50ICkub24oICJtb3VzZWRvd24iLCAkLmRhdGVwaWNrZXIuX2NoZWNrRXh0ZXJuYWxDbGljayApOwoJCSQuZGF0ZXBpY2tlci5pbml0aWFsaXplZCA9IHRydWU7Cgl9CgoJLyogQXBwZW5kIGRhdGVwaWNrZXIgbWFpbiBjb250YWluZXIgdG8gYm9keSBpZiBub3QgZXhpc3QuICovCglpZiAoICQoICIjIiArICQuZGF0ZXBpY2tlci5fbWFpbkRpdklkICkubGVuZ3RoID09PSAwICkgewoJCSQoICJib2R5IiApLmFwcGVuZCggJC5kYXRlcGlja2VyLmRwRGl2ICk7Cgl9CgoJdmFyIG90aGVyQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKTsKCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICYmICggb3B0aW9ucyA9PT0gImlzRGlzYWJsZWQiIHx8IG9wdGlvbnMgPT09ICJnZXREYXRlIiB8fCBvcHRpb25zID09PSAid2lkZ2V0IiApICkgewoJCXJldHVybiAkLmRhdGVwaWNrZXJbICJfIiArIG9wdGlvbnMgKyAiRGF0ZXBpY2tlciIgXS4KCQkJYXBwbHkoICQuZGF0ZXBpY2tlciwgWyB0aGlzWyAwIF0gXS5jb25jYXQoIG90aGVyQXJncyApICk7Cgl9CglpZiAoIG9wdGlvbnMgPT09ICJvcHRpb24iICYmIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgdHlwZW9mIGFyZ3VtZW50c1sgMSBdID09PSAic3RyaW5nIiApIHsKCQlyZXR1cm4gJC5kYXRlcGlja2VyWyAiXyIgKyBvcHRpb25zICsgIkRhdGVwaWNrZXIiIF0uCgkJCWFwcGx5KCAkLmRhdGVwaWNrZXIsIFsgdGhpc1sgMCBdIF0uY29uY2F0KCBvdGhlckFyZ3MgKSApOwoJfQoJcmV0dXJuIHRoaXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciID8KCQkJJC5kYXRlcGlja2VyWyAiXyIgKyBvcHRpb25zICsgIkRhdGVwaWNrZXIiIF0uCgkJCQlhcHBseSggJC5kYXRlcGlja2VyLCBbIHRoaXMgXS5jb25jYXQoIG90aGVyQXJncyApICkgOgoJCQkkLmRhdGVwaWNrZXIuX2F0dGFjaERhdGVwaWNrZXIoIHRoaXMsIG9wdGlvbnMgKTsKCX0gKTsKfTsKCiQuZGF0ZXBpY2tlciA9IG5ldyBEYXRlcGlja2VyKCk7IC8vIHNpbmdsZXRvbiBpbnN0YW5jZQokLmRhdGVwaWNrZXIuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKJC5kYXRlcGlja2VyLnV1aWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKJC5kYXRlcGlja2VyLnZlcnNpb24gPSAiMS4xMi4xIjsKCnZhciB3aWRnZXRzRGF0ZXBpY2tlciA9ICQuZGF0ZXBpY2tlcjsKCgoKCi8vIFRoaXMgZmlsZSBpcyBkZXByZWNhdGVkCnZhciBpZSA9ICQudWkuaWUgPSAhIS9tc2llIFtcdy5dKy8uZXhlYyggbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpICk7CgovKiEKICogalF1ZXJ5IFVJIE1vdXNlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogTW91c2UKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogQWJzdHJhY3RzIG1vdXNlLWJhc2VkIGludGVyYWN0aW9ucyB0byBhc3Npc3QgaW4gY3JlYXRpbmcgY2VydGFpbiB3aWRnZXRzLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vbW91c2UvCgoKCnZhciBtb3VzZUhhbmRsZWQgPSBmYWxzZTsKJCggZG9jdW1lbnQgKS5vbiggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCW1vdXNlSGFuZGxlZCA9IGZhbHNlOwp9ICk7Cgp2YXIgd2lkZ2V0c01vdXNlID0gJC53aWRnZXQoICJ1aS5tb3VzZSIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJb3B0aW9uczogewoJCWNhbmNlbDogImlucHV0LCB0ZXh0YXJlYSwgYnV0dG9uLCBzZWxlY3QsIG9wdGlvbiIsCgkJZGlzdGFuY2U6IDEsCgkJZGVsYXk6IDAKCX0sCglfbW91c2VJbml0OiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXRoaXMuZWxlbWVudAoJCQkub24oICJtb3VzZWRvd24uIiArIHRoaXMud2lkZ2V0TmFtZSwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJcmV0dXJuIHRoYXQuX21vdXNlRG93biggZXZlbnQgKTsKCQkJfSApCgkJCS5vbiggImNsaWNrLiIgKyB0aGlzLndpZGdldE5hbWUsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdHJ1ZSA9PT0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRoYXQud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICkgKSB7CgkJCQkJJC5yZW1vdmVEYXRhKCBldmVudC50YXJnZXQsIHRoYXQud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICk7CgkJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9ICk7CgoJCXRoaXMuc3RhcnRlZCA9IGZhbHNlOwoJfSwKCgkvLyBUT0RPOiBtYWtlIHN1cmUgZGVzdHJveWluZyBvbmUgaW5zdGFuY2Ugb2YgbW91c2UgZG9lc24ndCBtZXNzIHdpdGgKCS8vIG90aGVyIGluc3RhbmNlcyBvZiBtb3VzZQoJX21vdXNlRGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50Lm9mZiggIi4iICsgdGhpcy53aWRnZXROYW1lICk7CgkJaWYgKCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSApIHsKCQkJdGhpcy5kb2N1bWVudAoJCQkJLm9mZiggIm1vdXNlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSApCgkJCQkub2ZmKCAibW91c2V1cC4iICsgdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZVVwRGVsZWdhdGUgKTsKCQl9Cgl9LAoKCV9tb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy8gZG9uJ3QgbGV0IG1vcmUgdGhhbiBvbmUgd2lkZ2V0IGhhbmRsZSBtb3VzZVN0YXJ0CgkJaWYgKCBtb3VzZUhhbmRsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX21vdXNlTW92ZWQgPSBmYWxzZTsKCgkJLy8gV2UgbWF5IGhhdmUgbWlzc2VkIG1vdXNldXAgKG91dCBvZiB3aW5kb3cpCgkJKCB0aGlzLl9tb3VzZVN0YXJ0ZWQgJiYgdGhpcy5fbW91c2VVcCggZXZlbnQgKSApOwoKCQl0aGlzLl9tb3VzZURvd25FdmVudCA9IGV2ZW50OwoKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCWJ0bklzTGVmdCA9ICggZXZlbnQud2hpY2ggPT09IDEgKSwKCgkJCS8vIGV2ZW50LnRhcmdldC5ub2RlTmFtZSB3b3JrcyBhcm91bmQgYSBidWcgaW4gSUUgOCB3aXRoCgkJCS8vIGRpc2FibGVkIGlucHV0cyAoIzc2MjApCgkJCWVsSXNDYW5jZWwgPSAoIHR5cGVvZiB0aGlzLm9wdGlvbnMuY2FuY2VsID09PSAic3RyaW5nIiAmJiBldmVudC50YXJnZXQubm9kZU5hbWUgPwoJCQkJJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggdGhpcy5vcHRpb25zLmNhbmNlbCApLmxlbmd0aCA6IGZhbHNlICk7CgkJaWYgKCAhYnRuSXNMZWZ0IHx8IGVsSXNDYW5jZWwgfHwgIXRoaXMuX21vdXNlQ2FwdHVyZSggZXZlbnQgKSApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQl0aGlzLm1vdXNlRGVsYXlNZXQgPSAhdGhpcy5vcHRpb25zLmRlbGF5OwoJCWlmICggIXRoaXMubW91c2VEZWxheU1ldCApIHsKCQkJdGhpcy5fbW91c2VEZWxheVRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQl0aGF0Lm1vdXNlRGVsYXlNZXQgPSB0cnVlOwoJCQl9LCB0aGlzLm9wdGlvbnMuZGVsYXkgKTsKCQl9CgoJCWlmICggdGhpcy5fbW91c2VEaXN0YW5jZU1ldCggZXZlbnQgKSAmJiB0aGlzLl9tb3VzZURlbGF5TWV0KCBldmVudCApICkgewoJCQl0aGlzLl9tb3VzZVN0YXJ0ZWQgPSAoIHRoaXMuX21vdXNlU3RhcnQoIGV2ZW50ICkgIT09IGZhbHNlICk7CgkJCWlmICggIXRoaXMuX21vdXNlU3RhcnRlZCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gQ2xpY2sgZXZlbnQgbWF5IG5ldmVyIGhhdmUgZmlyZWQgKEdlY2tvICYgT3BlcmEpCgkJaWYgKCB0cnVlID09PSAkLmRhdGEoIGV2ZW50LnRhcmdldCwgdGhpcy53aWRnZXROYW1lICsgIi5wcmV2ZW50Q2xpY2tFdmVudCIgKSApIHsKCQkJJC5yZW1vdmVEYXRhKCBldmVudC50YXJnZXQsIHRoaXMud2lkZ2V0TmFtZSArICIucHJldmVudENsaWNrRXZlbnQiICk7CgkJfQoKCQkvLyBUaGVzZSBkZWxlZ2F0ZXMgYXJlIHJlcXVpcmVkIHRvIGtlZXAgY29udGV4dAoJCXRoaXMuX21vdXNlTW92ZURlbGVnYXRlID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlyZXR1cm4gdGhhdC5fbW91c2VNb3ZlKCBldmVudCApOwoJCX07CgkJdGhpcy5fbW91c2VVcERlbGVnYXRlID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlyZXR1cm4gdGhhdC5fbW91c2VVcCggZXZlbnQgKTsKCQl9OwoKCQl0aGlzLmRvY3VtZW50CgkJCS5vbiggIm1vdXNlbW92ZS4iICsgdGhpcy53aWRnZXROYW1lLCB0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSApCgkJCS5vbiggIm1vdXNldXAuIiArIHRoaXMud2lkZ2V0TmFtZSwgdGhpcy5fbW91c2VVcERlbGVnYXRlICk7CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCW1vdXNlSGFuZGxlZCA9IHRydWU7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZU1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy8gT25seSBjaGVjayBmb3IgbW91c2V1cHMgb3V0c2lkZSB0aGUgZG9jdW1lbnQgaWYgeW91J3ZlIG1vdmVkIGluc2lkZSB0aGUgZG9jdW1lbnQKCQkvLyBhdCBsZWFzdCBvbmNlLiBUaGlzIHByZXZlbnRzIHRoZSBmaXJpbmcgb2YgbW91c2V1cCBpbiB0aGUgY2FzZSBvZiBJRTw5LCB3aGljaCB3aWxsCgkJLy8gZmlyZSBhIG1vdXNlbW92ZSBldmVudCBpZiBjb250ZW50IGlzIHBsYWNlZCB1bmRlciB0aGUgY3Vyc29yLiBTZWUgIzc3NzgKCQkvLyBTdXBwb3J0OiBJRSA8OQoJCWlmICggdGhpcy5fbW91c2VNb3ZlZCApIHsKCgkJCS8vIElFIG1vdXNldXAgY2hlY2sgLSBtb3VzZXVwIGhhcHBlbmVkIHdoZW4gbW91c2Ugd2FzIG91dCBvZiB3aW5kb3cKCQkJaWYgKCAkLnVpLmllICYmICggIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPCA5ICkgJiYKCQkJCQkhZXZlbnQuYnV0dG9uICkgewoJCQkJcmV0dXJuIHRoaXMuX21vdXNlVXAoIGV2ZW50ICk7CgoJCQkvLyBJZnJhbWUgbW91c2V1cCBjaGVjayAtIG1vdXNldXAgb2NjdXJyZWQgaW4gYW5vdGhlciBkb2N1bWVudAoJCQl9IGVsc2UgaWYgKCAhZXZlbnQud2hpY2ggKSB7CgoJCQkJLy8gU3VwcG9ydDogU2FmYXJpIDw9OCAtIDkKCQkJCS8vIFNhZmFyaSBzZXRzIHdoaWNoIHRvIDAgaWYgeW91IHByZXNzIGFueSBvZiB0aGUgZm9sbG93aW5nIGtleXMKCQkJCS8vIGR1cmluZyBhIGRyYWcgKCMxNDQ2MSkKCQkJCWlmICggZXZlbnQub3JpZ2luYWxFdmVudC5hbHRLZXkgfHwgZXZlbnQub3JpZ2luYWxFdmVudC5jdHJsS2V5IHx8CgkJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQubWV0YUtleSB8fCBldmVudC5vcmlnaW5hbEV2ZW50LnNoaWZ0S2V5ICkgewoJCQkJCXRoaXMuaWdub3JlTWlzc2luZ1doaWNoID0gdHJ1ZTsKCQkJCX0gZWxzZSBpZiAoICF0aGlzLmlnbm9yZU1pc3NpbmdXaGljaCApIHsKCQkJCQlyZXR1cm4gdGhpcy5fbW91c2VVcCggZXZlbnQgKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBldmVudC53aGljaCB8fCBldmVudC5idXR0b24gKSB7CgkJCXRoaXMuX21vdXNlTW92ZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCB0aGlzLl9tb3VzZVN0YXJ0ZWQgKSB7CgkJCXRoaXMuX21vdXNlRHJhZyggZXZlbnQgKTsKCQkJcmV0dXJuIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfQoKCQlpZiAoIHRoaXMuX21vdXNlRGlzdGFuY2VNZXQoIGV2ZW50ICkgJiYgdGhpcy5fbW91c2VEZWxheU1ldCggZXZlbnQgKSApIHsKCQkJdGhpcy5fbW91c2VTdGFydGVkID0KCQkJCSggdGhpcy5fbW91c2VTdGFydCggdGhpcy5fbW91c2VEb3duRXZlbnQsIGV2ZW50ICkgIT09IGZhbHNlICk7CgkJCSggdGhpcy5fbW91c2VTdGFydGVkID8gdGhpcy5fbW91c2VEcmFnKCBldmVudCApIDogdGhpcy5fbW91c2VVcCggZXZlbnQgKSApOwoJCX0KCgkJcmV0dXJuICF0aGlzLl9tb3VzZVN0YXJ0ZWQ7Cgl9LAoKCV9tb3VzZVVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5kb2N1bWVudAoJCQkub2ZmKCAibW91c2Vtb3ZlLiIgKyB0aGlzLndpZGdldE5hbWUsIHRoaXMuX21vdXNlTW92ZURlbGVnYXRlICkKCQkJLm9mZiggIm1vdXNldXAuIiArIHRoaXMud2lkZ2V0TmFtZSwgdGhpcy5fbW91c2VVcERlbGVnYXRlICk7CgoJCWlmICggdGhpcy5fbW91c2VTdGFydGVkICkgewoJCQl0aGlzLl9tb3VzZVN0YXJ0ZWQgPSBmYWxzZTsKCgkJCWlmICggZXZlbnQudGFyZ2V0ID09PSB0aGlzLl9tb3VzZURvd25FdmVudC50YXJnZXQgKSB7CgkJCQkkLmRhdGEoIGV2ZW50LnRhcmdldCwgdGhpcy53aWRnZXROYW1lICsgIi5wcmV2ZW50Q2xpY2tFdmVudCIsIHRydWUgKTsKCQkJfQoKCQkJdGhpcy5fbW91c2VTdG9wKCBldmVudCApOwoJCX0KCgkJaWYgKCB0aGlzLl9tb3VzZURlbGF5VGltZXIgKSB7CgkJCWNsZWFyVGltZW91dCggdGhpcy5fbW91c2VEZWxheVRpbWVyICk7CgkJCWRlbGV0ZSB0aGlzLl9tb3VzZURlbGF5VGltZXI7CgkJfQoKCQl0aGlzLmlnbm9yZU1pc3NpbmdXaGljaCA9IGZhbHNlOwoJCW1vdXNlSGFuZGxlZCA9IGZhbHNlOwoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9LAoKCV9tb3VzZURpc3RhbmNlTWV0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJcmV0dXJuICggTWF0aC5tYXgoCgkJCQlNYXRoLmFicyggdGhpcy5fbW91c2VEb3duRXZlbnQucGFnZVggLSBldmVudC5wYWdlWCApLAoJCQkJTWF0aC5hYnMoIHRoaXMuX21vdXNlRG93bkV2ZW50LnBhZ2VZIC0gZXZlbnQucGFnZVkgKQoJCQkpID49IHRoaXMub3B0aW9ucy5kaXN0YW5jZQoJCSk7Cgl9LAoKCV9tb3VzZURlbGF5TWV0OiBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7CgkJcmV0dXJuIHRoaXMubW91c2VEZWxheU1ldDsKCX0sCgoJLy8gVGhlc2UgYXJlIHBsYWNlaG9sZGVyIG1ldGhvZHMsIHRvIGJlIG92ZXJyaWRlbiBieSBleHRlbmRpbmcgcGx1Z2luCglfbW91c2VTdGFydDogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkge30sCglfbW91c2VEcmFnOiBmdW5jdGlvbiggLyogZXZlbnQgKi8gKSB7fSwKCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCAvKiBldmVudCAqLyApIHt9LAoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgeyByZXR1cm4gdHJ1ZTsgfQp9ICk7CgoKCgovLyAkLnVpLnBsdWdpbiBpcyBkZXByZWNhdGVkLiBVc2UgJC53aWRnZXQoKSBleHRlbnNpb25zIGluc3RlYWQuCnZhciBwbHVnaW4gPSAkLnVpLnBsdWdpbiA9IHsKCWFkZDogZnVuY3Rpb24oIG1vZHVsZSwgb3B0aW9uLCBzZXQgKSB7CgkJdmFyIGksCgkJCXByb3RvID0gJC51aVsgbW9kdWxlIF0ucHJvdG90eXBlOwoJCWZvciAoIGkgaW4gc2V0ICkgewoJCQlwcm90by5wbHVnaW5zWyBpIF0gPSBwcm90by5wbHVnaW5zWyBpIF0gfHwgW107CgkJCXByb3RvLnBsdWdpbnNbIGkgXS5wdXNoKCBbIG9wdGlvbiwgc2V0WyBpIF0gXSApOwoJCX0KCX0sCgljYWxsOiBmdW5jdGlvbiggaW5zdGFuY2UsIG5hbWUsIGFyZ3MsIGFsbG93RGlzY29ubmVjdGVkICkgewoJCXZhciBpLAoJCQlzZXQgPSBpbnN0YW5jZS5wbHVnaW5zWyBuYW1lIF07CgoJCWlmICggIXNldCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCAhYWxsb3dEaXNjb25uZWN0ZWQgJiYgKCAhaW5zdGFuY2UuZWxlbWVudFsgMCBdLnBhcmVudE5vZGUgfHwKCQkJCWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07CgoKCnZhciBzYWZlQmx1ciA9ICQudWkuc2FmZUJsdXIgPSBmdW5jdGlvbiggZWxlbWVudCApIHsKCgkvLyBTdXBwb3J0OiBJRTkgLSAxMCBvbmx5CgkvLyBJZiB0aGUgPGJvZHk+IGlzIGJsdXJyZWQsIElFIHdpbGwgc3dpdGNoIHdpbmRvd3MsIHNlZSAjOTQyMAoJaWYgKCBlbGVtZW50ICYmIGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJvZHkiICkgewoJCSQoIGVsZW1lbnQgKS50cmlnZ2VyKCAiYmx1ciIgKTsKCX0KfTsKCgovKiEKICogalF1ZXJ5IFVJIERyYWdnYWJsZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IERyYWdnYWJsZQovLz4+Z3JvdXA6IEludGVyYWN0aW9ucwovLz4+ZGVzY3JpcHRpb246IEVuYWJsZXMgZHJhZ2dpbmcgZnVuY3Rpb25hbGl0eSBmb3IgYW55IGVsZW1lbnQuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9kcmFnZ2FibGUvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9kcmFnZ2FibGUvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9kcmFnZ2FibGUuY3NzCgoKCiQud2lkZ2V0KCAidWkuZHJhZ2dhYmxlIiwgJC51aS5tb3VzZSwgewoJdmVyc2lvbjogIjEuMTIuMSIsCgl3aWRnZXRFdmVudFByZWZpeDogImRyYWciLAoJb3B0aW9uczogewoJCWFkZENsYXNzZXM6IHRydWUsCgkJYXBwZW5kVG86ICJwYXJlbnQiLAoJCWF4aXM6IGZhbHNlLAoJCWNvbm5lY3RUb1NvcnRhYmxlOiBmYWxzZSwKCQljb250YWlubWVudDogZmFsc2UsCgkJY3Vyc29yOiAiYXV0byIsCgkJY3Vyc29yQXQ6IGZhbHNlLAoJCWdyaWQ6IGZhbHNlLAoJCWhhbmRsZTogZmFsc2UsCgkJaGVscGVyOiAib3JpZ2luYWwiLAoJCWlmcmFtZUZpeDogZmFsc2UsCgkJb3BhY2l0eTogZmFsc2UsCgkJcmVmcmVzaFBvc2l0aW9uczogZmFsc2UsCgkJcmV2ZXJ0OiBmYWxzZSwKCQlyZXZlcnREdXJhdGlvbjogNTAwLAoJCXNjb3BlOiAiZGVmYXVsdCIsCgkJc2Nyb2xsOiB0cnVlLAoJCXNjcm9sbFNlbnNpdGl2aXR5OiAyMCwKCQlzY3JvbGxTcGVlZDogMjAsCgkJc25hcDogZmFsc2UsCgkJc25hcE1vZGU6ICJib3RoIiwKCQlzbmFwVG9sZXJhbmNlOiAyMCwKCQlzdGFjazogZmFsc2UsCgkJekluZGV4OiBmYWxzZSwKCgkJLy8gQ2FsbGJhY2tzCgkJZHJhZzogbnVsbCwKCQlzdGFydDogbnVsbCwKCQlzdG9wOiBudWxsCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlbHBlciA9PT0gIm9yaWdpbmFsIiApIHsKCQkJdGhpcy5fc2V0UG9zaXRpb25SZWxhdGl2ZSgpOwoJCX0KCQlpZiAoIHRoaXMub3B0aW9ucy5hZGRDbGFzc2VzICkgewoJCQl0aGlzLl9hZGRDbGFzcyggInVpLWRyYWdnYWJsZSIgKTsKCQl9CgkJdGhpcy5fc2V0SGFuZGxlQ2xhc3NOYW1lKCk7CgoJCXRoaXMuX21vdXNlSW5pdCgpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJCWlmICgga2V5ID09PSAiaGFuZGxlIiApIHsKCQkJdGhpcy5fcmVtb3ZlSGFuZGxlQ2xhc3NOYW1lKCk7CgkJCXRoaXMuX3NldEhhbmRsZUNsYXNzTmFtZSgpOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggKCB0aGlzLmhlbHBlciB8fCB0aGlzLmVsZW1lbnQgKS5pcyggIi51aS1kcmFnZ2FibGUtZHJhZ2dpbmciICkgKSB7CgkJCXRoaXMuZGVzdHJveU9uQ2xlYXIgPSB0cnVlOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX3JlbW92ZUhhbmRsZUNsYXNzTmFtZSgpOwoJCXRoaXMuX21vdXNlRGVzdHJveSgpOwoJfSwKCglfbW91c2VDYXB0dXJlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCS8vIEFtb25nIG90aGVycywgcHJldmVudCBhIGRyYWcgb24gYSByZXNpemFibGUtaGFuZGxlCgkJaWYgKCB0aGlzLmhlbHBlciB8fCBvLmRpc2FibGVkIHx8CgkJCQkkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLXJlc2l6YWJsZS1oYW5kbGUiICkubGVuZ3RoID4gMCApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy9RdWl0IGlmIHdlJ3JlIG5vdCBvbiBhIHZhbGlkIGhhbmRsZQoJCXRoaXMuaGFuZGxlID0gdGhpcy5fZ2V0SGFuZGxlKCBldmVudCApOwoJCWlmICggIXRoaXMuaGFuZGxlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl0aGlzLl9ibHVyQWN0aXZlRWxlbWVudCggZXZlbnQgKTsKCgkJdGhpcy5fYmxvY2tGcmFtZXMoIG8uaWZyYW1lRml4ID09PSB0cnVlID8gImlmcmFtZSIgOiBvLmlmcmFtZUZpeCApOwoKCQlyZXR1cm4gdHJ1ZTsKCgl9LAoKCV9ibG9ja0ZyYW1lczogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXRoaXMuaWZyYW1lQmxvY2tzID0gdGhpcy5kb2N1bWVudC5maW5kKCBzZWxlY3RvciApLm1hcCggZnVuY3Rpb24oKSB7CgkJCXZhciBpZnJhbWUgPSAkKCB0aGlzICk7CgoJCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCQkuY3NzKCAicG9zaXRpb24iLCAiYWJzb2x1dGUiICkKCQkJCS5hcHBlbmRUbyggaWZyYW1lLnBhcmVudCgpICkKCQkJCS5vdXRlcldpZHRoKCBpZnJhbWUub3V0ZXJXaWR0aCgpICkKCQkJCS5vdXRlckhlaWdodCggaWZyYW1lLm91dGVySGVpZ2h0KCkgKQoJCQkJLm9mZnNldCggaWZyYW1lLm9mZnNldCgpIClbIDAgXTsKCQl9ICk7Cgl9LAoKCV91bmJsb2NrRnJhbWVzOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaWZyYW1lQmxvY2tzICkgewoJCQl0aGlzLmlmcmFtZUJsb2Nrcy5yZW1vdmUoKTsKCQkJZGVsZXRlIHRoaXMuaWZyYW1lQmxvY2tzOwoJCX0KCX0sCgoJX2JsdXJBY3RpdmVFbGVtZW50OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGFjdGl2ZUVsZW1lbnQgPSAkLnVpLnNhZmVBY3RpdmVFbGVtZW50KCB0aGlzLmRvY3VtZW50WyAwIF0gKSwKCQkJdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICk7CgoJCS8vIERvbid0IGJsdXIgaWYgdGhlIGV2ZW50IG9jY3VycmVkIG9uIGFuIGVsZW1lbnQgdGhhdCBpcyB3aXRoaW4KCQkvLyB0aGUgY3VycmVudGx5IGZvY3VzZWQgZWxlbWVudAoJCS8vIFNlZSAjMTA1MjcsICMxMjQ3MgoJCWlmICggdGFyZ2V0LmNsb3Nlc3QoIGFjdGl2ZUVsZW1lbnQgKS5sZW5ndGggKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEJsdXIgYW55IGVsZW1lbnQgdGhhdCBjdXJyZW50bHkgaGFzIGZvY3VzLCBzZWUgIzQyNjEKCQkkLnVpLnNhZmVCbHVyKCBhY3RpdmVFbGVtZW50ICk7Cgl9LAoKCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvL0NyZWF0ZSBhbmQgYXBwZW5kIHRoZSB2aXNpYmxlIGhlbHBlcgoJCXRoaXMuaGVscGVyID0gdGhpcy5fY3JlYXRlSGVscGVyKCBldmVudCApOwoKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5oZWxwZXIsICJ1aS1kcmFnZ2FibGUtZHJhZ2dpbmciICk7CgoJCS8vQ2FjaGUgdGhlIGhlbHBlciBzaXplCgkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOwoKCQkvL0lmIGRkbWFuYWdlciBpcyB1c2VkIGZvciBkcm9wcGFibGVzLCBzZXQgdGhlIGdsb2JhbCBkcmFnZ2FibGUKCQlpZiAoICQudWkuZGRtYW5hZ2VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5jdXJyZW50ID0gdGhpczsKCQl9CgoJCS8qCgkJICogLSBQb3NpdGlvbiBnZW5lcmF0aW9uIC0KCQkgKiBUaGlzIGJsb2NrIGdlbmVyYXRlcyBldmVyeXRoaW5nIHBvc2l0aW9uIHJlbGF0ZWQgLSBpdCdzIHRoZSBjb3JlIG9mIGRyYWdnYWJsZXMuCgkJICovCgoJCS8vQ2FjaGUgdGhlIG1hcmdpbnMgb2YgdGhlIG9yaWdpbmFsIGVsZW1lbnQKCQl0aGlzLl9jYWNoZU1hcmdpbnMoKTsKCgkJLy9TdG9yZSB0aGUgaGVscGVyJ3MgY3NzIHBvc2l0aW9uCgkJdGhpcy5jc3NQb3NpdGlvbiA9IHRoaXMuaGVscGVyLmNzcyggInBvc2l0aW9uIiApOwoJCXRoaXMuc2Nyb2xsUGFyZW50ID0gdGhpcy5oZWxwZXIuc2Nyb2xsUGFyZW50KCB0cnVlICk7CgkJdGhpcy5vZmZzZXRQYXJlbnQgPSB0aGlzLmhlbHBlci5vZmZzZXRQYXJlbnQoKTsKCQl0aGlzLmhhc0ZpeGVkQW5jZXN0b3IgPSB0aGlzLmhlbHBlci5wYXJlbnRzKCkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCB0aGlzICkuY3NzKCAicG9zaXRpb24iICkgPT09ICJmaXhlZCI7CgkJCX0gKS5sZW5ndGggPiAwOwoKCQkvL1RoZSBlbGVtZW50J3MgYWJzb2x1dGUgcG9zaXRpb24gb24gdGhlIHBhZ2UgbWludXMgbWFyZ2lucwoJCXRoaXMucG9zaXRpb25BYnMgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgkJdGhpcy5fcmVmcmVzaE9mZnNldHMoIGV2ZW50ICk7CgoJCS8vR2VuZXJhdGUgdGhlIG9yaWdpbmFsIHBvc2l0aW9uCgkJdGhpcy5vcmlnaW5hbFBvc2l0aW9uID0gdGhpcy5wb3NpdGlvbiA9IHRoaXMuX2dlbmVyYXRlUG9zaXRpb24oIGV2ZW50LCBmYWxzZSApOwoJCXRoaXMub3JpZ2luYWxQYWdlWCA9IGV2ZW50LnBhZ2VYOwoJCXRoaXMub3JpZ2luYWxQYWdlWSA9IGV2ZW50LnBhZ2VZOwoKCQkvL0FkanVzdCB0aGUgbW91c2Ugb2Zmc2V0IHJlbGF0aXZlIHRvIHRoZSBoZWxwZXIgaWYgImN1cnNvckF0IiBpcyBzdXBwbGllZAoJCSggby5jdXJzb3JBdCAmJiB0aGlzLl9hZGp1c3RPZmZzZXRGcm9tSGVscGVyKCBvLmN1cnNvckF0ICkgKTsKCgkJLy9TZXQgYSBjb250YWlubWVudCBpZiBnaXZlbiBpbiB0aGUgb3B0aW9ucwoJCXRoaXMuX3NldENvbnRhaW5tZW50KCk7CgoJCS8vVHJpZ2dlciBldmVudCArIGNhbGxiYWNrcwoJCWlmICggdGhpcy5fdHJpZ2dlciggInN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXRoaXMuX2NsZWFyKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vUmVjYWNoZSB0aGUgaGVscGVyIHNpemUKCQl0aGlzLl9jYWNoZUhlbHBlclByb3BvcnRpb25zKCk7CgoJCS8vUHJlcGFyZSB0aGUgZHJvcHBhYmxlIG9mZnNldHMKCQlpZiAoICQudWkuZGRtYW5hZ2VyICYmICFvLmRyb3BCZWhhdmlvdXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCB0aGlzLCBldmVudCApOwoJCX0KCgkJLy8gRXhlY3V0ZSB0aGUgZHJhZyBvbmNlIC0gdGhpcyBjYXVzZXMgdGhlIGhlbHBlciBub3QgdG8gYmUgdmlzaWJsZSBiZWZvcmUgZ2V0dGluZyBpdHMKCQkvLyBjb3JyZWN0IHBvc2l0aW9uCgkJdGhpcy5fbW91c2VEcmFnKCBldmVudCwgdHJ1ZSApOwoKCQkvLyBJZiB0aGUgZGRtYW5hZ2VyIGlzIHVzZWQgZm9yIGRyb3BwYWJsZXMsIGluZm9ybSB0aGUgbWFuYWdlciB0aGF0IGRyYWdnaW5nIGhhcyBzdGFydGVkCgkJLy8gKHNlZSAjNTAwMykKCQlpZiAoICQudWkuZGRtYW5hZ2VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5kcmFnU3RhcnQoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJX3JlZnJlc2hPZmZzZXRzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5vZmZzZXQgPSB7CgkJCXRvcDogdGhpcy5wb3NpdGlvbkFicy50b3AgLSB0aGlzLm1hcmdpbnMudG9wLAoJCQlsZWZ0OiB0aGlzLnBvc2l0aW9uQWJzLmxlZnQgLSB0aGlzLm1hcmdpbnMubGVmdCwKCQkJc2Nyb2xsOiBmYWxzZSwKCQkJcGFyZW50OiB0aGlzLl9nZXRQYXJlbnRPZmZzZXQoKSwKCQkJcmVsYXRpdmU6IHRoaXMuX2dldFJlbGF0aXZlT2Zmc2V0KCkKCQl9OwoKCQl0aGlzLm9mZnNldC5jbGljayA9IHsKCQkJbGVmdDogZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5sZWZ0LAoJCQl0b3A6IGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQudG9wCgkJfTsKCX0sCgoJX21vdXNlRHJhZzogZnVuY3Rpb24oIGV2ZW50LCBub1Byb3BhZ2F0aW9uICkgewoKCQkvLyByZXNldCBhbnkgbmVjZXNzYXJ5IGNhY2hlZCBwcm9wZXJ0aWVzIChzZWUgIzUwMDkpCgkJaWYgKCB0aGlzLmhhc0ZpeGVkQW5jZXN0b3IgKSB7CgkJCXRoaXMub2Zmc2V0LnBhcmVudCA9IHRoaXMuX2dldFBhcmVudE9mZnNldCgpOwoJCX0KCgkJLy9Db21wdXRlIHRoZSBoZWxwZXJzIHBvc2l0aW9uCgkJdGhpcy5wb3NpdGlvbiA9IHRoaXMuX2dlbmVyYXRlUG9zaXRpb24oIGV2ZW50LCB0cnVlICk7CgkJdGhpcy5wb3NpdGlvbkFicyA9IHRoaXMuX2NvbnZlcnRQb3NpdGlvblRvKCAiYWJzb2x1dGUiICk7CgoJCS8vQ2FsbCBwbHVnaW5zIGFuZCBjYWxsYmFja3MgYW5kIHVzZSB0aGUgcmVzdWx0aW5nIHBvc2l0aW9uIGlmIHNvbWV0aGluZyBpcyByZXR1cm5lZAoJCWlmICggIW5vUHJvcGFnYXRpb24gKSB7CgkJCXZhciB1aSA9IHRoaXMuX3VpSGFzaCgpOwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQsIHVpICkgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fbW91c2VVcCggbmV3ICQuRXZlbnQoICJtb3VzZXVwIiwgZXZlbnQgKSApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCXRoaXMucG9zaXRpb24gPSB1aS5wb3NpdGlvbjsKCQl9CgoJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUubGVmdCA9IHRoaXMucG9zaXRpb24ubGVmdCArICJweCI7CgkJdGhpcy5oZWxwZXJbIDAgXS5zdHlsZS50b3AgPSB0aGlzLnBvc2l0aW9uLnRvcCArICJweCI7CgoJCWlmICggJC51aS5kZG1hbmFnZXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLmRyYWcoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9tb3VzZVN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJLy9JZiB3ZSBhcmUgdXNpbmcgZHJvcHBhYmxlcywgaW5mb3JtIHRoZSBtYW5hZ2VyIGFib3V0IHRoZSBkcm9wCgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlkcm9wcGVkID0gZmFsc2U7CgkJaWYgKCAkLnVpLmRkbWFuYWdlciAmJiAhdGhpcy5vcHRpb25zLmRyb3BCZWhhdmlvdXIgKSB7CgkJCWRyb3BwZWQgPSAkLnVpLmRkbWFuYWdlci5kcm9wKCB0aGlzLCBldmVudCApOwoJCX0KCgkJLy9pZiBhIGRyb3AgY29tZXMgZnJvbSBvdXRzaWRlIChhIHNvcnRhYmxlKQoJCWlmICggdGhpcy5kcm9wcGVkICkgewoJCQlkcm9wcGVkID0gdGhpcy5kcm9wcGVkOwoJCQl0aGlzLmRyb3BwZWQgPSBmYWxzZTsKCQl9CgoJCWlmICggKCB0aGlzLm9wdGlvbnMucmV2ZXJ0ID09PSAiaW52YWxpZCIgJiYgIWRyb3BwZWQgKSB8fAoJCQkJKCB0aGlzLm9wdGlvbnMucmV2ZXJ0ID09PSAidmFsaWQiICYmIGRyb3BwZWQgKSB8fAoJCQkJdGhpcy5vcHRpb25zLnJldmVydCA9PT0gdHJ1ZSB8fCAoICQuaXNGdW5jdGlvbiggdGhpcy5vcHRpb25zLnJldmVydCApICYmCgkJCQl0aGlzLm9wdGlvbnMucmV2ZXJ0LmNhbGwoIHRoaXMuZWxlbWVudCwgZHJvcHBlZCApICkKCQkpIHsKCQkJJCggdGhpcy5oZWxwZXIgKS5hbmltYXRlKAoJCQkJdGhpcy5vcmlnaW5hbFBvc2l0aW9uLAoJCQkJcGFyc2VJbnQoIHRoaXMub3B0aW9ucy5yZXZlcnREdXJhdGlvbiwgMTAgKSwKCQkJCWZ1bmN0aW9uKCkgewoJCQkJCWlmICggdGhhdC5fdHJpZ2dlciggInN0b3AiLCBldmVudCApICE9PSBmYWxzZSApIHsKCQkJCQkJdGhhdC5fY2xlYXIoKTsKCQkJCQl9CgkJCQl9CgkJCSk7CgkJfSBlbHNlIHsKCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50ICkgIT09IGZhbHNlICkgewoJCQkJdGhpcy5fY2xlYXIoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfbW91c2VVcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX3VuYmxvY2tGcmFtZXMoKTsKCgkJLy8gSWYgdGhlIGRkbWFuYWdlciBpcyB1c2VkIGZvciBkcm9wcGFibGVzLCBpbmZvcm0gdGhlIG1hbmFnZXIgdGhhdCBkcmFnZ2luZyBoYXMgc3RvcHBlZAoJCS8vIChzZWUgIzUwMDMpCgkJaWYgKCAkLnVpLmRkbWFuYWdlciApIHsKCQkJJC51aS5kZG1hbmFnZXIuZHJhZ1N0b3AoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQkvLyBPbmx5IG5lZWQgdG8gZm9jdXMgaWYgdGhlIGV2ZW50IG9jY3VycmVkIG9uIHRoZSBkcmFnZ2FibGUgaXRzZWxmLCBzZWUgIzEwNTI3CgkJaWYgKCB0aGlzLmhhbmRsZUVsZW1lbnQuaXMoIGV2ZW50LnRhcmdldCApICkgewoKCQkJLy8gVGhlIGludGVyYWN0aW9uIGlzIG92ZXI7IHdoZXRoZXIgb3Igbm90IHRoZSBjbGljayByZXN1bHRlZCBpbiBhIGRyYWcsCgkJCS8vIGZvY3VzIHRoZSBlbGVtZW50CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiZm9jdXMiICk7CgkJfQoKCQlyZXR1cm4gJC51aS5tb3VzZS5wcm90b3R5cGUuX21vdXNlVXAuY2FsbCggdGhpcywgZXZlbnQgKTsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpIHsKCgkJaWYgKCB0aGlzLmhlbHBlci5pcyggIi51aS1kcmFnZ2FibGUtZHJhZ2dpbmciICkgKSB7CgkJCXRoaXMuX21vdXNlVXAoIG5ldyAkLkV2ZW50KCAibW91c2V1cCIsIHsgdGFyZ2V0OiB0aGlzLmVsZW1lbnRbIDAgXSB9ICkgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9jbGVhcigpOwoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCglfZ2V0SGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJcmV0dXJuIHRoaXMub3B0aW9ucy5oYW5kbGUgPwoJCQkhISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIHRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaGFuZGxlICkgKS5sZW5ndGggOgoJCQl0cnVlOwoJfSwKCglfc2V0SGFuZGxlQ2xhc3NOYW1lOiBmdW5jdGlvbigpIHsKCQl0aGlzLmhhbmRsZUVsZW1lbnQgPSB0aGlzLm9wdGlvbnMuaGFuZGxlID8KCQkJdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMub3B0aW9ucy5oYW5kbGUgKSA6IHRoaXMuZWxlbWVudDsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5oYW5kbGVFbGVtZW50LCAidWktZHJhZ2dhYmxlLWhhbmRsZSIgKTsKCX0sCgoJX3JlbW92ZUhhbmRsZUNsYXNzTmFtZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuaGFuZGxlRWxlbWVudCwgInVpLWRyYWdnYWJsZS1oYW5kbGUiICk7Cgl9LAoKCV9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCWhlbHBlcklzRnVuY3Rpb24gPSAkLmlzRnVuY3Rpb24oIG8uaGVscGVyICksCgkJCWhlbHBlciA9IGhlbHBlcklzRnVuY3Rpb24gPwoJCQkJJCggby5oZWxwZXIuYXBwbHkoIHRoaXMuZWxlbWVudFsgMCBdLCBbIGV2ZW50IF0gKSApIDoKCQkJCSggby5oZWxwZXIgPT09ICJjbG9uZSIgPwoJCQkJCXRoaXMuZWxlbWVudC5jbG9uZSgpLnJlbW92ZUF0dHIoICJpZCIgKSA6CgkJCQkJdGhpcy5lbGVtZW50ICk7CgoJCWlmICggIWhlbHBlci5wYXJlbnRzKCAiYm9keSIgKS5sZW5ndGggKSB7CgkJCWhlbHBlci5hcHBlbmRUbyggKCBvLmFwcGVuZFRvID09PSAicGFyZW50IiA\/CgkJCQl0aGlzLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIDoKCQkJCW8uYXBwZW5kVG8gKSApOwoJCX0KCgkJLy8gSHR0cDovL2J1Z3MuanF1ZXJ5dWkuY29tL3RpY2tldC85NDQ2CgkJLy8gYSBoZWxwZXIgZnVuY3Rpb24gY2FuIHJldHVybiB0aGUgb3JpZ2luYWwgZWxlbWVudAoJCS8vIHdoaWNoIHdvdWxkbid0IGhhdmUgYmVlbiBzZXQgdG8gcmVsYXRpdmUgaW4gX2NyZWF0ZQoJCWlmICggaGVscGVySXNGdW5jdGlvbiAmJiBoZWxwZXJbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCXRoaXMuX3NldFBvc2l0aW9uUmVsYXRpdmUoKTsKCQl9CgoJCWlmICggaGVscGVyWyAwIF0gIT09IHRoaXMuZWxlbWVudFsgMCBdICYmCgkJCQkhKCAvKGZpeGVkfGFic29sdXRlKS8gKS50ZXN0KCBoZWxwZXIuY3NzKCAicG9zaXRpb24iICkgKSApIHsKCQkJaGVscGVyLmNzcyggInBvc2l0aW9uIiwgImFic29sdXRlIiApOwoJCX0KCgkJcmV0dXJuIGhlbHBlcjsKCgl9LAoKCV9zZXRQb3NpdGlvblJlbGF0aXZlOiBmdW5jdGlvbigpIHsKCQlpZiAoICEoIC9eKD86cnxhfGYpLyApLnRlc3QoIHRoaXMuZWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSApICkgewoJCQl0aGlzLmVsZW1lbnRbIDAgXS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CgkJfQoJfSwKCglfYWRqdXN0T2Zmc2V0RnJvbUhlbHBlcjogZnVuY3Rpb24oIG9iaiApIHsKCQlpZiAoIHR5cGVvZiBvYmogPT09ICJzdHJpbmciICkgewoJCQlvYmogPSBvYmouc3BsaXQoICIgIiApOwoJCX0KCQlpZiAoICQuaXNBcnJheSggb2JqICkgKSB7CgkJCW9iaiA9IHsgbGVmdDogK29ialsgMCBdLCB0b3A6ICtvYmpbIDEgXSB8fCAwIH07CgkJfQoJCWlmICggImxlZnQiIGluIG9iaiApIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2subGVmdCA9IG9iai5sZWZ0ICsgdGhpcy5tYXJnaW5zLmxlZnQ7CgkJfQoJCWlmICggInJpZ2h0IiBpbiBvYmogKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPSB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gb2JqLnJpZ2h0ICsgdGhpcy5tYXJnaW5zLmxlZnQ7CgkJfQoJCWlmICggInRvcCIgaW4gb2JqICkgewoJCQl0aGlzLm9mZnNldC5jbGljay50b3AgPSBvYmoudG9wICsgdGhpcy5tYXJnaW5zLnRvcDsKCQl9CgkJaWYgKCAiYm90dG9tIiBpbiBvYmogKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCA9IHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gb2JqLmJvdHRvbSArIHRoaXMubWFyZ2lucy50b3A7CgkJfQoJfSwKCglfaXNSb290Tm9kZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuICggLyhodG1sfGJvZHkpL2kgKS50ZXN0KCBlbGVtZW50LnRhZ05hbWUgKSB8fCBlbGVtZW50ID09PSB0aGlzLmRvY3VtZW50WyAwIF07Cgl9LAoKCV9nZXRQYXJlbnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoKCQkvL0dldCB0aGUgb2Zmc2V0UGFyZW50IGFuZCBjYWNoZSBpdHMgcG9zaXRpb24KCQl2YXIgcG8gPSB0aGlzLm9mZnNldFBhcmVudC5vZmZzZXQoKSwKCQkJZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50WyAwIF07CgoJCS8vIFRoaXMgaXMgYSBzcGVjaWFsIGNhc2Ugd2hlcmUgd2UgbmVlZCB0byBtb2RpZnkgYSBvZmZzZXQgY2FsY3VsYXRlZCBvbiBzdGFydCwgc2luY2UgdGhlCgkJLy8gZm9sbG93aW5nIGhhcHBlbmVkOgoJCS8vIDEuIFRoZSBwb3NpdGlvbiBvZiB0aGUgaGVscGVyIGlzIGFic29sdXRlLCBzbyBpdCdzIHBvc2l0aW9uIGlzIGNhbGN1bGF0ZWQgYmFzZWQgb24gdGhlCgkJLy8gbmV4dCBwb3NpdGlvbmVkIHBhcmVudAoJCS8vIDIuIFRoZSBhY3R1YWwgb2Zmc2V0IHBhcmVudCBpcyBhIGNoaWxkIG9mIHRoZSBzY3JvbGwgcGFyZW50LCBhbmQgdGhlIHNjcm9sbCBwYXJlbnQgaXNuJ3QKCQkvLyB0aGUgZG9jdW1lbnQsIHdoaWNoIG1lYW5zIHRoYXQgdGhlIHNjcm9sbCBpcyBpbmNsdWRlZCBpbiB0aGUgaW5pdGlhbCBjYWxjdWxhdGlvbiBvZiB0aGUKCQkvLyBvZmZzZXQgb2YgdGhlIHBhcmVudCwgYW5kIG5ldmVyIHJlY2FsY3VsYXRlZCB1cG9uIGRyYWcKCQlpZiAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgJiYgdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gZG9jdW1lbnQgJiYKCQkJCSQuY29udGFpbnMoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0sIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gKSApIHsKCQkJcG8ubGVmdCArPSB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCk7CgkJCXBvLnRvcCArPSB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKTsKCQl9CgoJCWlmICggdGhpcy5faXNSb290Tm9kZSggdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgewoJCQlwbyA9IHsgdG9wOiAwLCBsZWZ0OiAwIH07CgkJfQoKCQlyZXR1cm4gewoJCQl0b3A6IHBvLnRvcCArICggcGFyc2VJbnQoIHRoaXMub2Zmc2V0UGFyZW50LmNzcyggImJvcmRlclRvcFdpZHRoIiApLCAxMCApIHx8IDAgKSwKCQkJbGVmdDogcG8ubGVmdCArICggcGFyc2VJbnQoIHRoaXMub2Zmc2V0UGFyZW50LmNzcyggImJvcmRlckxlZnRXaWR0aCIgKSwgMTAgKSB8fCAwICkKCQl9OwoKCX0sCgoJX2dldFJlbGF0aXZlT2Zmc2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuY3NzUG9zaXRpb24gIT09ICJyZWxhdGl2ZSIgKSB7CgkJCXJldHVybiB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgkJdmFyIHAgPSB0aGlzLmVsZW1lbnQucG9zaXRpb24oKSwKCQkJc2Nyb2xsSXNSb290Tm9kZSA9IHRoaXMuX2lzUm9vdE5vZGUoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gKTsKCgkJcmV0dXJuIHsKCQkJdG9wOiBwLnRvcCAtICggcGFyc2VJbnQoIHRoaXMuaGVscGVyLmNzcyggInRvcCIgKSwgMTAgKSB8fCAwICkgKwoJCQkJKCAhc2Nyb2xsSXNSb290Tm9kZSA\/IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpIDogMCApLAoJCQlsZWZ0OiBwLmxlZnQgLSAoIHBhcnNlSW50KCB0aGlzLmhlbHBlci5jc3MoICJsZWZ0IiApLCAxMCApIHx8IDAgKSArCgkJCQkoICFzY3JvbGxJc1Jvb3ROb2RlID8gdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCgpIDogMCApCgkJfTsKCgl9LAoKCV9jYWNoZU1hcmdpbnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMubWFyZ2lucyA9IHsKCQkJbGVmdDogKCBwYXJzZUludCggdGhpcy5lbGVtZW50LmNzcyggIm1hcmdpbkxlZnQiICksIDEwICkgfHwgMCApLAoJCQl0b3A6ICggcGFyc2VJbnQoIHRoaXMuZWxlbWVudC5jc3MoICJtYXJnaW5Ub3AiICksIDEwICkgfHwgMCApLAoJCQlyaWdodDogKCBwYXJzZUludCggdGhpcy5lbGVtZW50LmNzcyggIm1hcmdpblJpZ2h0IiApLCAxMCApIHx8IDAgKSwKCQkJYm90dG9tOiAoIHBhcnNlSW50KCB0aGlzLmVsZW1lbnQuY3NzKCAibWFyZ2luQm90dG9tIiApLCAxMCApIHx8IDAgKQoJCX07Cgl9LAoKCV9jYWNoZUhlbHBlclByb3BvcnRpb25zOiBmdW5jdGlvbigpIHsKCQl0aGlzLmhlbHBlclByb3BvcnRpb25zID0gewoJCQl3aWR0aDogdGhpcy5oZWxwZXIub3V0ZXJXaWR0aCgpLAoJCQloZWlnaHQ6IHRoaXMuaGVscGVyLm91dGVySGVpZ2h0KCkKCQl9OwoJfSwKCglfc2V0Q29udGFpbm1lbnQ6IGZ1bmN0aW9uKCkgewoKCQl2YXIgaXNVc2VyU2Nyb2xsYWJsZSwgYywgY2UsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRvY3VtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdOwoKCQl0aGlzLnJlbGF0aXZlQ29udGFpbmVyID0gbnVsbDsKCgkJaWYgKCAhby5jb250YWlubWVudCApIHsKCQkJdGhpcy5jb250YWlubWVudCA9IG51bGw7CgkJCXJldHVybjsKCQl9CgoJCWlmICggby5jb250YWlubWVudCA9PT0gIndpbmRvdyIgKSB7CgkJCXRoaXMuY29udGFpbm1lbnQgPSBbCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxMZWZ0KCkgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQsCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSAtIHRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAtIHRoaXMub2Zmc2V0LnBhcmVudC50b3AsCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxMZWZ0KCkgKyAkKCB3aW5kb3cgKS53aWR0aCgpIC0KCQkJCQl0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gdGhpcy5tYXJnaW5zLmxlZnQsCgkJCQkkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSArCgkJCQkJKCAkKCB3aW5kb3cgKS5oZWlnaHQoKSB8fCBkb2N1bWVudC5ib2R5LnBhcmVudE5vZGUuc2Nyb2xsSGVpZ2h0ICkgLQoJCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcAoJCQldOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIG8uY29udGFpbm1lbnQgPT09ICJkb2N1bWVudCIgKSB7CgkJCXRoaXMuY29udGFpbm1lbnQgPSBbCgkJCQkwLAoJCQkJMCwKCQkJCSQoIGRvY3VtZW50ICkud2lkdGgoKSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLSB0aGlzLm1hcmdpbnMubGVmdCwKCQkJCSggJCggZG9jdW1lbnQgKS5oZWlnaHQoKSB8fCBkb2N1bWVudC5ib2R5LnBhcmVudE5vZGUuc2Nyb2xsSGVpZ2h0ICkgLQoJCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcAoJCQldOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIG8uY29udGFpbm1lbnQuY29uc3RydWN0b3IgPT09IEFycmF5ICkgewoJCQl0aGlzLmNvbnRhaW5tZW50ID0gby5jb250YWlubWVudDsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBvLmNvbnRhaW5tZW50ID09PSAicGFyZW50IiApIHsKCQkJby5jb250YWlubWVudCA9IHRoaXMuaGVscGVyWyAwIF0ucGFyZW50Tm9kZTsKCQl9CgoJCWMgPSAkKCBvLmNvbnRhaW5tZW50ICk7CgkJY2UgPSBjWyAwIF07CgoJCWlmICggIWNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpc1VzZXJTY3JvbGxhYmxlID0gLyhzY3JvbGx8YXV0bykvLnRlc3QoIGMuY3NzKCAib3ZlcmZsb3ciICkgKTsKCgkJdGhpcy5jb250YWlubWVudCA9IFsKCQkJKCBwYXJzZUludCggYy5jc3MoICJib3JkZXJMZWZ0V2lkdGgiICksIDEwICkgfHwgMCApICsKCQkJCSggcGFyc2VJbnQoIGMuY3NzKCAicGFkZGluZ0xlZnQiICksIDEwICkgfHwgMCApLAoJCQkoIHBhcnNlSW50KCBjLmNzcyggImJvcmRlclRvcFdpZHRoIiApLCAxMCApIHx8IDAgKSArCgkJCQkoIHBhcnNlSW50KCBjLmNzcyggInBhZGRpbmdUb3AiICksIDEwICkgfHwgMCApLAoJCQkoIGlzVXNlclNjcm9sbGFibGUgPyBNYXRoLm1heCggY2Uuc2Nyb2xsV2lkdGgsIGNlLm9mZnNldFdpZHRoICkgOiBjZS5vZmZzZXRXaWR0aCApIC0KCQkJCSggcGFyc2VJbnQoIGMuY3NzKCAiYm9yZGVyUmlnaHRXaWR0aCIgKSwgMTAgKSB8fCAwICkgLQoJCQkJKCBwYXJzZUludCggYy5jc3MoICJwYWRkaW5nUmlnaHQiICksIDEwICkgfHwgMCApIC0KCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLQoJCQkJdGhpcy5tYXJnaW5zLmxlZnQgLQoJCQkJdGhpcy5tYXJnaW5zLnJpZ2h0LAoJCQkoIGlzVXNlclNjcm9sbGFibGUgPyBNYXRoLm1heCggY2Uuc2Nyb2xsSGVpZ2h0LCBjZS5vZmZzZXRIZWlnaHQgKSA6IGNlLm9mZnNldEhlaWdodCApIC0KCQkJCSggcGFyc2VJbnQoIGMuY3NzKCAiYm9yZGVyQm90dG9tV2lkdGgiICksIDEwICkgfHwgMCApIC0KCQkJCSggcGFyc2VJbnQoIGMuY3NzKCAicGFkZGluZ0JvdHRvbSIgKSwgMTAgKSB8fCAwICkgLQoJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLQoJCQkJdGhpcy5tYXJnaW5zLnRvcCAtCgkJCQl0aGlzLm1hcmdpbnMuYm90dG9tCgkJXTsKCQl0aGlzLnJlbGF0aXZlQ29udGFpbmVyID0gYzsKCX0sCgoJX2NvbnZlcnRQb3NpdGlvblRvOiBmdW5jdGlvbiggZCwgcG9zICkgewoKCQlpZiAoICFwb3MgKSB7CgkJCXBvcyA9IHRoaXMucG9zaXRpb247CgkJfQoKCQl2YXIgbW9kID0gZCA9PT0gImFic29sdXRlIiA\/IDEgOiAtMSwKCQkJc2Nyb2xsSXNSb290Tm9kZSA9IHRoaXMuX2lzUm9vdE5vZGUoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gKTsKCgkJcmV0dXJuIHsKCQkJdG9wOiAoCgoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQlwb3MudG9wCSsKCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAqIG1vZCArCgoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC50b3AgKiBtb2QgLQoJCQkJKCAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPwoJCQkJCS10aGlzLm9mZnNldC5zY3JvbGwudG9wIDoKCQkJCQkoIHNjcm9sbElzUm9vdE5vZGUgPyAwIDogdGhpcy5vZmZzZXQuc2Nyb2xsLnRvcCApICkgKiBtb2QgKQoJCQkpLAoJCQlsZWZ0OiAoCgoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQlwb3MubGVmdCArCgoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0ICogbW9kICsKCgkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgKiBtb2QJLQoJCQkJKCAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPwoJCQkJCS10aGlzLm9mZnNldC5zY3JvbGwubGVmdCA6CgkJCQkJKCBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHRoaXMub2Zmc2V0LnNjcm9sbC5sZWZ0ICkgKSAqIG1vZCApCgkJCSkKCQl9OwoKCX0sCgoJX2dlbmVyYXRlUG9zaXRpb246IGZ1bmN0aW9uKCBldmVudCwgY29uc3RyYWluUG9zaXRpb24gKSB7CgoJCXZhciBjb250YWlubWVudCwgY28sIHRvcCwgbGVmdCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJc2Nyb2xsSXNSb290Tm9kZSA9IHRoaXMuX2lzUm9vdE5vZGUoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gKSwKCQkJcGFnZVggPSBldmVudC5wYWdlWCwKCQkJcGFnZVkgPSBldmVudC5wYWdlWTsKCgkJLy8gQ2FjaGUgdGhlIHNjcm9sbAoJCWlmICggIXNjcm9sbElzUm9vdE5vZGUgfHwgIXRoaXMub2Zmc2V0LnNjcm9sbCApIHsKCQkJdGhpcy5vZmZzZXQuc2Nyb2xsID0gewoJCQkJdG9wOiB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSwKCQkJCWxlZnQ6IHRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKQoJCQl9OwoJCX0KCgkJLyoKCQkgKiAtIFBvc2l0aW9uIGNvbnN0cmFpbmluZyAtCgkJICogQ29uc3RyYWluIHRoZSBwb3NpdGlvbiB0byBhIG1peCBvZiBncmlkLCBjb250YWlubWVudC4KCQkgKi8KCgkJLy8gSWYgd2UgYXJlIG5vdCBkcmFnZ2luZyB5ZXQsIHdlIHdvbid0IGNoZWNrIGZvciBvcHRpb25zCgkJaWYgKCBjb25zdHJhaW5Qb3NpdGlvbiApIHsKCQkJaWYgKCB0aGlzLmNvbnRhaW5tZW50ICkgewoJCQkJaWYgKCB0aGlzLnJlbGF0aXZlQ29udGFpbmVyICkgewoJCQkJCWNvID0gdGhpcy5yZWxhdGl2ZUNvbnRhaW5lci5vZmZzZXQoKTsKCQkJCQljb250YWlubWVudCA9IFsKCQkJCQkJdGhpcy5jb250YWlubWVudFsgMCBdICsgY28ubGVmdCwKCQkJCQkJdGhpcy5jb250YWlubWVudFsgMSBdICsgY28udG9wLAoJCQkJCQl0aGlzLmNvbnRhaW5tZW50WyAyIF0gKyBjby5sZWZ0LAoJCQkJCQl0aGlzLmNvbnRhaW5tZW50WyAzIF0gKyBjby50b3AKCQkJCQldOwoJCQkJfSBlbHNlIHsKCQkJCQljb250YWlubWVudCA9IHRoaXMuY29udGFpbm1lbnQ7CgkJCQl9CgoJCQkJaWYgKCBldmVudC5wYWdlWCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPCBjb250YWlubWVudFsgMCBdICkgewoJCQkJCXBhZ2VYID0gY29udGFpbm1lbnRbIDAgXSArIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQ7CgkJCQl9CgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wIDwgY29udGFpbm1lbnRbIDEgXSApIHsKCQkJCQlwYWdlWSA9IGNvbnRhaW5tZW50WyAxIF0gKyB0aGlzLm9mZnNldC5jbGljay50b3A7CgkJCQl9CgkJCQlpZiAoIGV2ZW50LnBhZ2VYIC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+IGNvbnRhaW5tZW50WyAyIF0gKSB7CgkJCQkJcGFnZVggPSBjb250YWlubWVudFsgMiBdICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdDsKCQkJCX0KCQkJCWlmICggZXZlbnQucGFnZVkgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPiBjb250YWlubWVudFsgMyBdICkgewoJCQkJCXBhZ2VZID0gY29udGFpbm1lbnRbIDMgXSArIHRoaXMub2Zmc2V0LmNsaWNrLnRvcDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBvLmdyaWQgKSB7CgoJCQkJLy9DaGVjayBmb3IgZ3JpZCBlbGVtZW50cyBzZXQgdG8gMCB0byBwcmV2ZW50IGRpdmlkZSBieSAwIGVycm9yIGNhdXNpbmcgaW52YWxpZAoJCQkJLy8gYXJndW1lbnQgZXJyb3JzIGluIElFIChzZWUgdGlja2V0ICM2OTUwKQoJCQkJdG9wID0gby5ncmlkWyAxIF0gPyB0aGlzLm9yaWdpbmFsUGFnZVkgKyBNYXRoLnJvdW5kKCAoIHBhZ2VZIC0KCQkJCQl0aGlzLm9yaWdpbmFsUGFnZVkgKSAvIG8uZ3JpZFsgMSBdICkgKiBvLmdyaWRbIDEgXSA6IHRoaXMub3JpZ2luYWxQYWdlWTsKCQkJCXBhZ2VZID0gY29udGFpbm1lbnQgPyAoICggdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID49IGNvbnRhaW5tZW50WyAxIF0gfHwKCQkJCQl0b3AgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPiBjb250YWlubWVudFsgMyBdICkgPwoJCQkJCQl0b3AgOgoJCQkJCQkoICggdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID49IGNvbnRhaW5tZW50WyAxIF0gKSA\/CgkJCQkJCQl0b3AgLSBvLmdyaWRbIDEgXSA6IHRvcCArIG8uZ3JpZFsgMSBdICkgKSA6IHRvcDsKCgkJCQlsZWZ0ID0gby5ncmlkWyAwIF0gPyB0aGlzLm9yaWdpbmFsUGFnZVggKwoJCQkJCU1hdGgucm91bmQoICggcGFnZVggLSB0aGlzLm9yaWdpbmFsUGFnZVggKSAvIG8uZ3JpZFsgMCBdICkgKiBvLmdyaWRbIDAgXSA6CgkJCQkJdGhpcy5vcmlnaW5hbFBhZ2VYOwoJCQkJcGFnZVggPSBjb250YWlubWVudCA\/ICggKCBsZWZ0IC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+PSBjb250YWlubWVudFsgMCBdIHx8CgkJCQkJbGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPiBjb250YWlubWVudFsgMiBdICkgPwoJCQkJCQlsZWZ0IDoKCQkJCQkJKCAoIGxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID49IGNvbnRhaW5tZW50WyAwIF0gKSA\/CgkJCQkJCQlsZWZ0IC0gby5ncmlkWyAwIF0gOiBsZWZ0ICsgby5ncmlkWyAwIF0gKSApIDogbGVmdDsKCQkJfQoKCQkJaWYgKCBvLmF4aXMgPT09ICJ5IiApIHsKCQkJCXBhZ2VYID0gdGhpcy5vcmlnaW5hbFBhZ2VYOwoJCQl9CgoJCQlpZiAoIG8uYXhpcyA9PT0gIngiICkgewoJCQkJcGFnZVkgPSB0aGlzLm9yaWdpbmFsUGFnZVk7CgkJCX0KCQl9CgoJCXJldHVybiB7CgkJCXRvcDogKAoKCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbgoJCQkJcGFnZVkgLQoKCQkJCS8vIENsaWNrIG9mZnNldCAocmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQpCgkJCQl0aGlzLm9mZnNldC5jbGljay50b3AgLQoKCQkJCS8vIE9ubHkgZm9yIHJlbGF0aXZlIHBvc2l0aW9uZWQgbm9kZXM6IFJlbGF0aXZlIG9mZnNldCBmcm9tIGVsZW1lbnQgdG8gb2Zmc2V0IHBhcmVudAoJCQkJdGhpcy5vZmZzZXQucmVsYXRpdmUudG9wIC0KCgkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LnRvcCArCgkJCQkoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPwoJCQkJCS10aGlzLm9mZnNldC5zY3JvbGwudG9wIDoKCQkJCQkoIHNjcm9sbElzUm9vdE5vZGUgPyAwIDogdGhpcy5vZmZzZXQuc2Nyb2xsLnRvcCApICkKCQkJKSwKCQkJbGVmdDogKAoKCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbgoJCQkJcGFnZVggLQoKCQkJCS8vIENsaWNrIG9mZnNldCAocmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQpCgkJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0IC0KCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLmxlZnQgLQoKCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQubGVmdCArCgkJCQkoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPwoJCQkJCS10aGlzLm9mZnNldC5zY3JvbGwubGVmdCA6CgkJCQkJKCBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHRoaXMub2Zmc2V0LnNjcm9sbC5sZWZ0ICkgKQoJCQkpCgkJfTsKCgl9LAoKCV9jbGVhcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuaGVscGVyLCAidWktZHJhZ2dhYmxlLWRyYWdnaW5nIiApOwoJCWlmICggdGhpcy5oZWxwZXJbIDAgXSAhPT0gdGhpcy5lbGVtZW50WyAwIF0gJiYgIXRoaXMuY2FuY2VsSGVscGVyUmVtb3ZhbCApIHsKCQkJdGhpcy5oZWxwZXIucmVtb3ZlKCk7CgkJfQoJCXRoaXMuaGVscGVyID0gbnVsbDsKCQl0aGlzLmNhbmNlbEhlbHBlclJlbW92YWwgPSBmYWxzZTsKCQlpZiAoIHRoaXMuZGVzdHJveU9uQ2xlYXIgKSB7CgkJCXRoaXMuZGVzdHJveSgpOwoJCX0KCX0sCgoJLy8gRnJvbSBub3cgb24gYnVsayBzdHVmZiAtIG1haW5seSBoZWxwZXJzCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgdWkgKSB7CgkJdWkgPSB1aSB8fCB0aGlzLl91aUhhc2goKTsKCQkkLnVpLnBsdWdpbi5jYWxsKCB0aGlzLCB0eXBlLCBbIGV2ZW50LCB1aSwgdGhpcyBdLCB0cnVlICk7CgoJCS8vIEFic29sdXRlIHBvc2l0aW9uIGFuZCBvZmZzZXQgKHNlZSAjNjg4NCApIGhhdmUgdG8gYmUgcmVjYWxjdWxhdGVkIGFmdGVyIHBsdWdpbnMKCQlpZiAoIC9eKGRyYWd8c3RhcnR8c3RvcCkvLnRlc3QoIHR5cGUgKSApIHsKCQkJdGhpcy5wb3NpdGlvbkFicyA9IHRoaXMuX2NvbnZlcnRQb3NpdGlvblRvKCAiYWJzb2x1dGUiICk7CgkJCXVpLm9mZnNldCA9IHRoaXMucG9zaXRpb25BYnM7CgkJfQoJCXJldHVybiAkLldpZGdldC5wcm90b3R5cGUuX3RyaWdnZXIuY2FsbCggdGhpcywgdHlwZSwgZXZlbnQsIHVpICk7Cgl9LAoKCXBsdWdpbnM6IHt9LAoKCV91aUhhc2g6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCWhlbHBlcjogdGhpcy5oZWxwZXIsCgkJCXBvc2l0aW9uOiB0aGlzLnBvc2l0aW9uLAoJCQlvcmlnaW5hbFBvc2l0aW9uOiB0aGlzLm9yaWdpbmFsUG9zaXRpb24sCgkJCW9mZnNldDogdGhpcy5wb3NpdGlvbkFicwoJCX07Cgl9Cgp9ICk7CgokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAiY29ubmVjdFRvU29ydGFibGUiLCB7CglzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgZHJhZ2dhYmxlICkgewoJCXZhciB1aVNvcnRhYmxlID0gJC5leHRlbmQoIHt9LCB1aSwgewoJCQlpdGVtOiBkcmFnZ2FibGUuZWxlbWVudAoJCX0gKTsKCgkJZHJhZ2dhYmxlLnNvcnRhYmxlcyA9IFtdOwoJCSQoIGRyYWdnYWJsZS5vcHRpb25zLmNvbm5lY3RUb1NvcnRhYmxlICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBzb3J0YWJsZSA9ICQoIHRoaXMgKS5zb3J0YWJsZSggImluc3RhbmNlIiApOwoKCQkJaWYgKCBzb3J0YWJsZSAmJiAhc29ydGFibGUub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCWRyYWdnYWJsZS5zb3J0YWJsZXMucHVzaCggc29ydGFibGUgKTsKCgkJCQkvLyBSZWZyZXNoUG9zaXRpb25zIGlzIGNhbGxlZCBhdCBkcmFnIHN0YXJ0IHRvIHJlZnJlc2ggdGhlIGNvbnRhaW5lckNhY2hlCgkJCQkvLyB3aGljaCBpcyB1c2VkIGluIGRyYWcuIFRoaXMgZW5zdXJlcyBpdCdzIGluaXRpYWxpemVkIGFuZCBzeW5jaHJvbml6ZWQKCQkJCS8vIHdpdGggYW55IGNoYW5nZXMgdGhhdCBtaWdodCBoYXZlIGhhcHBlbmVkIG9uIHRoZSBwYWdlIHNpbmNlIGluaXRpYWxpemF0aW9uLgoJCQkJc29ydGFibGUucmVmcmVzaFBvc2l0aW9ucygpOwoJCQkJc29ydGFibGUuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCB1aVNvcnRhYmxlICk7CgkJCX0KCQl9ICk7Cgl9LAoJc3RvcDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgZHJhZ2dhYmxlICkgewoJCXZhciB1aVNvcnRhYmxlID0gJC5leHRlbmQoIHt9LCB1aSwgewoJCQlpdGVtOiBkcmFnZ2FibGUuZWxlbWVudAoJCX0gKTsKCgkJZHJhZ2dhYmxlLmNhbmNlbEhlbHBlclJlbW92YWwgPSBmYWxzZTsKCgkJJC5lYWNoKCBkcmFnZ2FibGUuc29ydGFibGVzLCBmdW5jdGlvbigpIHsKCQkJdmFyIHNvcnRhYmxlID0gdGhpczsKCgkJCWlmICggc29ydGFibGUuaXNPdmVyICkgewoJCQkJc29ydGFibGUuaXNPdmVyID0gMDsKCgkJCQkvLyBBbGxvdyB0aGlzIHNvcnRhYmxlIHRvIGhhbmRsZSByZW1vdmluZyB0aGUgaGVscGVyCgkJCQlkcmFnZ2FibGUuY2FuY2VsSGVscGVyUmVtb3ZhbCA9IHRydWU7CgkJCQlzb3J0YWJsZS5jYW5jZWxIZWxwZXJSZW1vdmFsID0gZmFsc2U7CgoJCQkJLy8gVXNlIF9zdG9yZWRDU1MgVG8gcmVzdG9yZSBwcm9wZXJ0aWVzIGluIHRoZSBzb3J0YWJsZSwKCQkJCS8vIGFzIHRoaXMgYWxzbyBoYW5kbGVzIHJldmVydCAoIzk2NzUpIHNpbmNlIHRoZSBkcmFnZ2FibGUKCQkJCS8vIG1heSBoYXZlIG1vZGlmaWVkIHRoZW0gaW4gdW5leHBlY3RlZCB3YXlzICgjODgwOSkKCQkJCXNvcnRhYmxlLl9zdG9yZWRDU1MgPSB7CgkJCQkJcG9zaXRpb246IHNvcnRhYmxlLnBsYWNlaG9sZGVyLmNzcyggInBvc2l0aW9uIiApLAoJCQkJCXRvcDogc29ydGFibGUucGxhY2Vob2xkZXIuY3NzKCAidG9wIiApLAoJCQkJCWxlZnQ6IHNvcnRhYmxlLnBsYWNlaG9sZGVyLmNzcyggImxlZnQiICkKCQkJCX07CgoJCQkJc29ydGFibGUuX21vdXNlU3RvcCggZXZlbnQgKTsKCgkJCQkvLyBPbmNlIGRyYWcgaGFzIGVuZGVkLCB0aGUgc29ydGFibGUgc2hvdWxkIHJldHVybiB0byB1c2luZwoJCQkJLy8gaXRzIG9yaWdpbmFsIGhlbHBlciwgbm90IHRoZSBzaGFyZWQgaGVscGVyIGZyb20gZHJhZ2dhYmxlCgkJCQlzb3J0YWJsZS5vcHRpb25zLmhlbHBlciA9IHNvcnRhYmxlLm9wdGlvbnMuX2hlbHBlcjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBQcmV2ZW50IHRoaXMgU29ydGFibGUgZnJvbSByZW1vdmluZyB0aGUgaGVscGVyLgoJCQkJLy8gSG93ZXZlciwgZG9uJ3Qgc2V0IHRoZSBkcmFnZ2FibGUgdG8gcmVtb3ZlIHRoZSBoZWxwZXIKCQkJCS8vIGVpdGhlciBhcyBhbm90aGVyIGNvbm5lY3RlZCBTb3J0YWJsZSBtYXkgeWV0IGhhbmRsZSB0aGUgcmVtb3ZhbC4KCQkJCXNvcnRhYmxlLmNhbmNlbEhlbHBlclJlbW92YWwgPSB0cnVlOwoKCQkJCXNvcnRhYmxlLl90cmlnZ2VyKCAiZGVhY3RpdmF0ZSIsIGV2ZW50LCB1aVNvcnRhYmxlICk7CgkJCX0KCQl9ICk7Cgl9LAoJZHJhZzogZnVuY3Rpb24oIGV2ZW50LCB1aSwgZHJhZ2dhYmxlICkgewoJCSQuZWFjaCggZHJhZ2dhYmxlLnNvcnRhYmxlcywgZnVuY3Rpb24oKSB7CgkJCXZhciBpbm5lcm1vc3RJbnRlcnNlY3RpbmcgPSBmYWxzZSwKCQkJCXNvcnRhYmxlID0gdGhpczsKCgkJCS8vIENvcHkgb3ZlciB2YXJpYWJsZXMgdGhhdCBzb3J0YWJsZSdzIF9pbnRlcnNlY3RzV2l0aCB1c2VzCgkJCXNvcnRhYmxlLnBvc2l0aW9uQWJzID0gZHJhZ2dhYmxlLnBvc2l0aW9uQWJzOwoJCQlzb3J0YWJsZS5oZWxwZXJQcm9wb3J0aW9ucyA9IGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9uczsKCQkJc29ydGFibGUub2Zmc2V0LmNsaWNrID0gZHJhZ2dhYmxlLm9mZnNldC5jbGljazsKCgkJCWlmICggc29ydGFibGUuX2ludGVyc2VjdHNXaXRoKCBzb3J0YWJsZS5jb250YWluZXJDYWNoZSApICkgewoJCQkJaW5uZXJtb3N0SW50ZXJzZWN0aW5nID0gdHJ1ZTsKCgkJCQkkLmVhY2goIGRyYWdnYWJsZS5zb3J0YWJsZXMsIGZ1bmN0aW9uKCkgewoKCQkJCQkvLyBDb3B5IG92ZXIgdmFyaWFibGVzIHRoYXQgc29ydGFibGUncyBfaW50ZXJzZWN0c1dpdGggdXNlcwoJCQkJCXRoaXMucG9zaXRpb25BYnMgPSBkcmFnZ2FibGUucG9zaXRpb25BYnM7CgkJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucyA9IGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9uczsKCQkJCQl0aGlzLm9mZnNldC5jbGljayA9IGRyYWdnYWJsZS5vZmZzZXQuY2xpY2s7CgoJCQkJCWlmICggdGhpcyAhPT0gc29ydGFibGUgJiYKCQkJCQkJCXRoaXMuX2ludGVyc2VjdHNXaXRoKCB0aGlzLmNvbnRhaW5lckNhY2hlICkgJiYKCQkJCQkJCSQuY29udGFpbnMoIHNvcnRhYmxlLmVsZW1lbnRbIDAgXSwgdGhpcy5lbGVtZW50WyAwIF0gKSApIHsKCQkJCQkJaW5uZXJtb3N0SW50ZXJzZWN0aW5nID0gZmFsc2U7CgkJCQkJfQoKCQkJCQlyZXR1cm4gaW5uZXJtb3N0SW50ZXJzZWN0aW5nOwoJCQkJfSApOwoJCQl9CgoJCQlpZiAoIGlubmVybW9zdEludGVyc2VjdGluZyApIHsKCgkJCQkvLyBJZiBpdCBpbnRlcnNlY3RzLCB3ZSB1c2UgYSBsaXR0bGUgaXNPdmVyIHZhcmlhYmxlIGFuZCBzZXQgaXQgb25jZSwKCQkJCS8vIHNvIHRoYXQgdGhlIG1vdmUtaW4gc3R1ZmYgZ2V0cyBmaXJlZCBvbmx5IG9uY2UuCgkJCQlpZiAoICFzb3J0YWJsZS5pc092ZXIgKSB7CgkJCQkJc29ydGFibGUuaXNPdmVyID0gMTsKCgkJCQkJLy8gU3RvcmUgZHJhZ2dhYmxlJ3MgcGFyZW50IGluIGNhc2Ugd2UgbmVlZCB0byByZWFwcGVuZCB0byBpdCBsYXRlci4KCQkJCQlkcmFnZ2FibGUuX3BhcmVudCA9IHVpLmhlbHBlci5wYXJlbnQoKTsKCgkJCQkJc29ydGFibGUuY3VycmVudEl0ZW0gPSB1aS5oZWxwZXIKCQkJCQkJLmFwcGVuZFRvKCBzb3J0YWJsZS5lbGVtZW50ICkKCQkJCQkJLmRhdGEoICJ1aS1zb3J0YWJsZS1pdGVtIiwgdHJ1ZSApOwoKCQkJCQkvLyBTdG9yZSBoZWxwZXIgb3B0aW9uIHRvIGxhdGVyIHJlc3RvcmUgaXQKCQkJCQlzb3J0YWJsZS5vcHRpb25zLl9oZWxwZXIgPSBzb3J0YWJsZS5vcHRpb25zLmhlbHBlcjsKCgkJCQkJc29ydGFibGUub3B0aW9ucy5oZWxwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIHVpLmhlbHBlclsgMCBdOwoJCQkJCX07CgoJCQkJCS8vIEZpcmUgdGhlIHN0YXJ0IGV2ZW50cyBvZiB0aGUgc29ydGFibGUgd2l0aCBvdXIgcGFzc2VkIGJyb3dzZXIgZXZlbnQsCgkJCQkJLy8gYW5kIG91ciBvd24gaGVscGVyIChzbyBpdCBkb2Vzbid0IGNyZWF0ZSBhIG5ldyBvbmUpCgkJCQkJZXZlbnQudGFyZ2V0ID0gc29ydGFibGUuY3VycmVudEl0ZW1bIDAgXTsKCQkJCQlzb3J0YWJsZS5fbW91c2VDYXB0dXJlKCBldmVudCwgdHJ1ZSApOwoJCQkJCXNvcnRhYmxlLl9tb3VzZVN0YXJ0KCBldmVudCwgdHJ1ZSwgdHJ1ZSApOwoKCQkJCQkvLyBCZWNhdXNlIHRoZSBicm93c2VyIGV2ZW50IGlzIHdheSBvZmYgdGhlIG5ldyBhcHBlbmRlZCBwb3J0bGV0LAoJCQkJCS8vIG1vZGlmeSBuZWNlc3NhcnkgdmFyaWFibGVzIHRvIHJlZmxlY3QgdGhlIGNoYW5nZXMKCQkJCQlzb3J0YWJsZS5vZmZzZXQuY2xpY2sudG9wID0gZHJhZ2dhYmxlLm9mZnNldC5jbGljay50b3A7CgkJCQkJc29ydGFibGUub2Zmc2V0LmNsaWNrLmxlZnQgPSBkcmFnZ2FibGUub2Zmc2V0LmNsaWNrLmxlZnQ7CgkJCQkJc29ydGFibGUub2Zmc2V0LnBhcmVudC5sZWZ0IC09IGRyYWdnYWJsZS5vZmZzZXQucGFyZW50LmxlZnQgLQoJCQkJCQlzb3J0YWJsZS5vZmZzZXQucGFyZW50LmxlZnQ7CgkJCQkJc29ydGFibGUub2Zmc2V0LnBhcmVudC50b3AgLT0gZHJhZ2dhYmxlLm9mZnNldC5wYXJlbnQudG9wIC0KCQkJCQkJc29ydGFibGUub2Zmc2V0LnBhcmVudC50b3A7CgoJCQkJCWRyYWdnYWJsZS5fdHJpZ2dlciggInRvU29ydGFibGUiLCBldmVudCApOwoKCQkJCQkvLyBJbmZvcm0gZHJhZ2dhYmxlIHRoYXQgdGhlIGhlbHBlciBpcyBpbiBhIHZhbGlkIGRyb3Agem9uZSwKCQkJCQkvLyB1c2VkIHNvbGVseSBpbiB0aGUgcmV2ZXJ0IG9wdGlvbiB0byBoYW5kbGUgInZhbGlkL2ludmFsaWQiLgoJCQkJCWRyYWdnYWJsZS5kcm9wcGVkID0gc29ydGFibGUuZWxlbWVudDsKCgkJCQkJLy8gTmVlZCB0byByZWZyZXNoUG9zaXRpb25zIG9mIGFsbCBzb3J0YWJsZXMgaW4gdGhlIGNhc2UgdGhhdAoJCQkJCS8vIGFkZGluZyB0byBvbmUgc29ydGFibGUgY2hhbmdlcyB0aGUgbG9jYXRpb24gb2YgdGhlIG90aGVyIHNvcnRhYmxlcyAoIzk2NzUpCgkJCQkJJC5lYWNoKCBkcmFnZ2FibGUuc29ydGFibGVzLCBmdW5jdGlvbigpIHsKCQkJCQkJdGhpcy5yZWZyZXNoUG9zaXRpb25zKCk7CgkJCQkJfSApOwoKCQkJCQkvLyBIYWNrIHNvIHJlY2VpdmUvdXBkYXRlIGNhbGxiYWNrcyB3b3JrIChtb3N0bHkpCgkJCQkJZHJhZ2dhYmxlLmN1cnJlbnRJdGVtID0gZHJhZ2dhYmxlLmVsZW1lbnQ7CgkJCQkJc29ydGFibGUuZnJvbU91dHNpZGUgPSBkcmFnZ2FibGU7CgkJCQl9CgoJCQkJaWYgKCBzb3J0YWJsZS5jdXJyZW50SXRlbSApIHsKCQkJCQlzb3J0YWJsZS5fbW91c2VEcmFnKCBldmVudCApOwoKCQkJCQkvLyBDb3B5IHRoZSBzb3J0YWJsZSdzIHBvc2l0aW9uIGJlY2F1c2UgdGhlIGRyYWdnYWJsZSdzIGNhbiBwb3RlbnRpYWxseSByZWZsZWN0CgkJCQkJLy8gYSByZWxhdGl2ZSBwb3NpdGlvbiwgd2hpbGUgc29ydGFibGUgaXMgYWx3YXlzIGFic29sdXRlLCB3aGljaCB0aGUgZHJhZ2dlZAoJCQkJCS8vIGVsZW1lbnQgaGFzIG5vdyBiZWNvbWUuICgjODgwOSkKCQkJCQl1aS5wb3NpdGlvbiA9IHNvcnRhYmxlLnBvc2l0aW9uOwoJCQkJfQoJCQl9IGVsc2UgewoKCQkJCS8vIElmIGl0IGRvZXNuJ3QgaW50ZXJzZWN0IHdpdGggdGhlIHNvcnRhYmxlLCBhbmQgaXQgaW50ZXJzZWN0ZWQgYmVmb3JlLAoJCQkJLy8gd2UgZmFrZSB0aGUgZHJhZyBzdG9wIG9mIHRoZSBzb3J0YWJsZSwgYnV0IG1ha2Ugc3VyZSBpdCBkb2Vzbid0IHJlbW92ZQoJCQkJLy8gdGhlIGhlbHBlciBieSB1c2luZyBjYW5jZWxIZWxwZXJSZW1vdmFsLgoJCQkJaWYgKCBzb3J0YWJsZS5pc092ZXIgKSB7CgoJCQkJCXNvcnRhYmxlLmlzT3ZlciA9IDA7CgkJCQkJc29ydGFibGUuY2FuY2VsSGVscGVyUmVtb3ZhbCA9IHRydWU7CgoJCQkJCS8vIENhbGxpbmcgc29ydGFibGUncyBtb3VzZVN0b3Agd291bGQgdHJpZ2dlciBhIHJldmVydCwKCQkJCQkvLyBzbyByZXZlcnQgbXVzdCBiZSB0ZW1wb3JhcmlseSBmYWxzZSB1bnRpbCBhZnRlciBtb3VzZVN0b3AgaXMgY2FsbGVkLgoJCQkJCXNvcnRhYmxlLm9wdGlvbnMuX3JldmVydCA9IHNvcnRhYmxlLm9wdGlvbnMucmV2ZXJ0OwoJCQkJCXNvcnRhYmxlLm9wdGlvbnMucmV2ZXJ0ID0gZmFsc2U7CgoJCQkJCXNvcnRhYmxlLl90cmlnZ2VyKCAib3V0IiwgZXZlbnQsIHNvcnRhYmxlLl91aUhhc2goIHNvcnRhYmxlICkgKTsKCQkJCQlzb3J0YWJsZS5fbW91c2VTdG9wKCBldmVudCwgdHJ1ZSApOwoKCQkJCQkvLyBSZXN0b3JlIHNvcnRhYmxlIGJlaGF2aW9ycyB0aGF0IHdlcmUgbW9kZmllZAoJCQkJCS8vIHdoZW4gdGhlIGRyYWdnYWJsZSBlbnRlcmVkIHRoZSBzb3J0YWJsZSBhcmVhICgjOTQ4MSkKCQkJCQlzb3J0YWJsZS5vcHRpb25zLnJldmVydCA9IHNvcnRhYmxlLm9wdGlvbnMuX3JldmVydDsKCQkJCQlzb3J0YWJsZS5vcHRpb25zLmhlbHBlciA9IHNvcnRhYmxlLm9wdGlvbnMuX2hlbHBlcjsKCgkJCQkJaWYgKCBzb3J0YWJsZS5wbGFjZWhvbGRlciApIHsKCQkJCQkJc29ydGFibGUucGxhY2Vob2xkZXIucmVtb3ZlKCk7CgkJCQkJfQoKCQkJCQkvLyBSZXN0b3JlIGFuZCByZWNhbGN1bGF0ZSB0aGUgZHJhZ2dhYmxlJ3Mgb2Zmc2V0IGNvbnNpZGVyaW5nIHRoZSBzb3J0YWJsZQoJCQkJCS8vIG1heSBoYXZlIG1vZGlmaWVkIHRoZW0gaW4gdW5leHBlY3RlZCB3YXlzLiAoIzg4MDksICMxMDY2OSkKCQkJCQl1aS5oZWxwZXIuYXBwZW5kVG8oIGRyYWdnYWJsZS5fcGFyZW50ICk7CgkJCQkJZHJhZ2dhYmxlLl9yZWZyZXNoT2Zmc2V0cyggZXZlbnQgKTsKCQkJCQl1aS5wb3NpdGlvbiA9IGRyYWdnYWJsZS5fZ2VuZXJhdGVQb3NpdGlvbiggZXZlbnQsIHRydWUgKTsKCgkJCQkJZHJhZ2dhYmxlLl90cmlnZ2VyKCAiZnJvbVNvcnRhYmxlIiwgZXZlbnQgKTsKCgkJCQkJLy8gSW5mb3JtIGRyYWdnYWJsZSB0aGF0IHRoZSBoZWxwZXIgaXMgbm8gbG9uZ2VyIGluIGEgdmFsaWQgZHJvcCB6b25lCgkJCQkJZHJhZ2dhYmxlLmRyb3BwZWQgPSBmYWxzZTsKCgkJCQkJLy8gTmVlZCB0byByZWZyZXNoUG9zaXRpb25zIG9mIGFsbCBzb3J0YWJsZXMganVzdCBpbiBjYXNlIHJlbW92aW5nCgkJCQkJLy8gZnJvbSBvbmUgc29ydGFibGUgY2hhbmdlcyB0aGUgbG9jYXRpb24gb2Ygb3RoZXIgc29ydGFibGVzICgjOTY3NSkKCQkJCQkkLmVhY2goIGRyYWdnYWJsZS5zb3J0YWJsZXMsIGZ1bmN0aW9uKCkgewoJCQkJCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoKTsKCQkJCQl9ICk7CgkJCQl9CgkJCX0KCQl9ICk7Cgl9Cn0gKTsKCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJjdXJzb3IiLCB7CglzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaW5zdGFuY2UgKSB7CgkJdmFyIHQgPSAkKCAiYm9keSIgKSwKCQkJbyA9IGluc3RhbmNlLm9wdGlvbnM7CgoJCWlmICggdC5jc3MoICJjdXJzb3IiICkgKSB7CgkJCW8uX2N1cnNvciA9IHQuY3NzKCAiY3Vyc29yIiApOwoJCX0KCQl0LmNzcyggImN1cnNvciIsIG8uY3Vyc29yICk7Cgl9LAoJc3RvcDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaW5zdGFuY2UgKSB7CgkJdmFyIG8gPSBpbnN0YW5jZS5vcHRpb25zOwoJCWlmICggby5fY3Vyc29yICkgewoJCQkkKCAiYm9keSIgKS5jc3MoICJjdXJzb3IiLCBvLl9jdXJzb3IgKTsKCQl9Cgl9Cn0gKTsKCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJvcGFjaXR5IiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgewoJCXZhciB0ID0gJCggdWkuaGVscGVyICksCgkJCW8gPSBpbnN0YW5jZS5vcHRpb25zOwoJCWlmICggdC5jc3MoICJvcGFjaXR5IiApICkgewoJCQlvLl9vcGFjaXR5ID0gdC5jc3MoICJvcGFjaXR5IiApOwoJCX0KCQl0LmNzcyggIm9wYWNpdHkiLCBvLm9wYWNpdHkgKTsKCX0sCglzdG9wOiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0YW5jZSApIHsKCQl2YXIgbyA9IGluc3RhbmNlLm9wdGlvbnM7CgkJaWYgKCBvLl9vcGFjaXR5ICkgewoJCQkkKCB1aS5oZWxwZXIgKS5jc3MoICJvcGFjaXR5Iiwgby5fb3BhY2l0eSApOwoJCX0KCX0KfSApOwoKJC51aS5wbHVnaW4uYWRkKCAiZHJhZ2dhYmxlIiwgInNjcm9sbCIsIHsKCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpICkgewoJCWlmICggIWkuc2Nyb2xsUGFyZW50Tm90SGlkZGVuICkgewoJCQlpLnNjcm9sbFBhcmVudE5vdEhpZGRlbiA9IGkuaGVscGVyLnNjcm9sbFBhcmVudCggZmFsc2UgKTsKCQl9CgoJCWlmICggaS5zY3JvbGxQYXJlbnROb3RIaWRkZW5bIDAgXSAhPT0gaS5kb2N1bWVudFsgMCBdICYmCgkJCQlpLnNjcm9sbFBhcmVudE5vdEhpZGRlblsgMCBdLnRhZ05hbWUgIT09ICJIVE1MIiApIHsKCQkJaS5vdmVyZmxvd09mZnNldCA9IGkuc2Nyb2xsUGFyZW50Tm90SGlkZGVuLm9mZnNldCgpOwoJCX0KCX0sCglkcmFnOiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpICApIHsKCgkJdmFyIG8gPSBpLm9wdGlvbnMsCgkJCXNjcm9sbGVkID0gZmFsc2UsCgkJCXNjcm9sbFBhcmVudCA9IGkuc2Nyb2xsUGFyZW50Tm90SGlkZGVuWyAwIF0sCgkJCWRvY3VtZW50ID0gaS5kb2N1bWVudFsgMCBdOwoKCQlpZiAoIHNjcm9sbFBhcmVudCAhPT0gZG9jdW1lbnQgJiYgc2Nyb2xsUGFyZW50LnRhZ05hbWUgIT09ICJIVE1MIiApIHsKCQkJaWYgKCAhby5heGlzIHx8IG8uYXhpcyAhPT0gIngiICkgewoJCQkJaWYgKCAoIGkub3ZlcmZsb3dPZmZzZXQudG9wICsgc2Nyb2xsUGFyZW50Lm9mZnNldEhlaWdodCApIC0gZXZlbnQucGFnZVkgPAoJCQkJCQlvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXNjcm9sbFBhcmVudC5zY3JvbGxUb3AgPSBzY3JvbGxlZCA9IHNjcm9sbFBhcmVudC5zY3JvbGxUb3AgKyBvLnNjcm9sbFNwZWVkOwoJCQkJfSBlbHNlIGlmICggZXZlbnQucGFnZVkgLSBpLm92ZXJmbG93T2Zmc2V0LnRvcCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCA9IHNjcm9sbGVkID0gc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCAtIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9CgkJCX0KCgkJCWlmICggIW8uYXhpcyB8fCBvLmF4aXMgIT09ICJ5IiApIHsKCQkJCWlmICggKCBpLm92ZXJmbG93T2Zmc2V0LmxlZnQgKyBzY3JvbGxQYXJlbnQub2Zmc2V0V2lkdGggKSAtIGV2ZW50LnBhZ2VYIDwKCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCA9IHNjcm9sbGVkID0gc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQgKyBvLnNjcm9sbFNwZWVkOwoJCQkJfSBlbHNlIGlmICggZXZlbnQucGFnZVggLSBpLm92ZXJmbG93T2Zmc2V0LmxlZnQgPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0ID0gc2Nyb2xsZWQgPSBzY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCAtIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIHsKCgkJCWlmICggIW8uYXhpcyB8fCBvLmF4aXMgIT09ICJ4IiApIHsKCQkJCWlmICggZXZlbnQucGFnZVkgLSAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCgpIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxlZCA9ICQoIGRvY3VtZW50ICkuc2Nyb2xsVG9wKCAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCgpIC0gby5zY3JvbGxTcGVlZCApOwoJCQkJfSBlbHNlIGlmICggJCggd2luZG93ICkuaGVpZ2h0KCkgLSAoIGV2ZW50LnBhZ2VZIC0gJCggZG9jdW1lbnQgKS5zY3JvbGxUb3AoKSApIDwKCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxlZCA9ICQoIGRvY3VtZW50ICkuc2Nyb2xsVG9wKCAkKCBkb2N1bWVudCApLnNjcm9sbFRvcCgpICsgby5zY3JvbGxTcGVlZCApOwoJCQkJfQoJCQl9CgoJCQlpZiAoICFvLmF4aXMgfHwgby5heGlzICE9PSAieSIgKSB7CgkJCQlpZiAoIGV2ZW50LnBhZ2VYIC0gJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXNjcm9sbGVkID0gJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KAoJCQkJCQkkKCBkb2N1bWVudCApLnNjcm9sbExlZnQoKSAtIG8uc2Nyb2xsU3BlZWQKCQkJCQkpOwoJCQkJfSBlbHNlIGlmICggJCggd2luZG93ICkud2lkdGgoKSAtICggZXZlbnQucGFnZVggLSAkKCBkb2N1bWVudCApLnNjcm9sbExlZnQoKSApIDwKCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxlZCA9ICQoIGRvY3VtZW50ICkuc2Nyb2xsTGVmdCgKCQkJCQkJJCggZG9jdW1lbnQgKS5zY3JvbGxMZWZ0KCkgKyBvLnNjcm9sbFNwZWVkCgkJCQkJKTsKCQkJCX0KCQkJfQoKCQl9CgoJCWlmICggc2Nyb2xsZWQgIT09IGZhbHNlICYmICQudWkuZGRtYW5hZ2VyICYmICFvLmRyb3BCZWhhdmlvdXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBpLCBldmVudCApOwoJCX0KCgl9Cn0gKTsKCiQudWkucGx1Z2luLmFkZCggImRyYWdnYWJsZSIsICJzbmFwIiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWksIGkgKSB7CgoJCXZhciBvID0gaS5vcHRpb25zOwoKCQlpLnNuYXBFbGVtZW50cyA9IFtdOwoKCQkkKCBvLnNuYXAuY29uc3RydWN0b3IgIT09IFN0cmluZyA\/ICggby5zbmFwLml0ZW1zIHx8ICI6ZGF0YSh1aS1kcmFnZ2FibGUpIiApIDogby5zbmFwICkKCQkJLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0ID0gJCggdGhpcyApLAoJCQkJCSRvID0gJHQub2Zmc2V0KCk7CgkJCQlpZiAoIHRoaXMgIT09IGkuZWxlbWVudFsgMCBdICkgewoJCQkJCWkuc25hcEVsZW1lbnRzLnB1c2goIHsKCQkJCQkJaXRlbTogdGhpcywKCQkJCQkJd2lkdGg6ICR0Lm91dGVyV2lkdGgoKSwgaGVpZ2h0OiAkdC5vdXRlckhlaWdodCgpLAoJCQkJCQl0b3A6ICRvLnRvcCwgbGVmdDogJG8ubGVmdAoJCQkJCX0gKTsKCQkJCX0KCQkJfSApOwoKCX0sCglkcmFnOiBmdW5jdGlvbiggZXZlbnQsIHVpLCBpbnN0ICkgewoKCQl2YXIgdHMsIGJzLCBscywgcnMsIGwsIHIsIHQsIGIsIGksIGZpcnN0LAoJCQlvID0gaW5zdC5vcHRpb25zLAoJCQlkID0gby5zbmFwVG9sZXJhbmNlLAoJCQl4MSA9IHVpLm9mZnNldC5sZWZ0LCB4MiA9IHgxICsgaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCwKCQkJeTEgPSB1aS5vZmZzZXQudG9wLCB5MiA9IHkxICsgaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQ7CgoJCWZvciAoIGkgPSBpbnN0LnNuYXBFbGVtZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCgkJCWwgPSBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLmxlZnQgLSBpbnN0Lm1hcmdpbnMubGVmdDsKCQkJciA9IGwgKyBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLndpZHRoOwoJCQl0ID0gaW5zdC5zbmFwRWxlbWVudHNbIGkgXS50b3AgLSBpbnN0Lm1hcmdpbnMudG9wOwoJCQliID0gdCArIGluc3Quc25hcEVsZW1lbnRzWyBpIF0uaGVpZ2h0OwoKCQkJaWYgKCB4MiA8IGwgLSBkIHx8IHgxID4gciArIGQgfHwgeTIgPCB0IC0gZCB8fCB5MSA+IGIgKyBkIHx8CgkJCQkJISQuY29udGFpbnMoIGluc3Quc25hcEVsZW1lbnRzWyBpIF0uaXRlbS5vd25lckRvY3VtZW50LAoJCQkJCWluc3Quc25hcEVsZW1lbnRzWyBpIF0uaXRlbSApICkgewoJCQkJaWYgKCBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLnNuYXBwaW5nICkgewoJCQkJCSggaW5zdC5vcHRpb25zLnNuYXAucmVsZWFzZSAmJgoJCQkJCQlpbnN0Lm9wdGlvbnMuc25hcC5yZWxlYXNlLmNhbGwoCgkJCQkJCQlpbnN0LmVsZW1lbnQsCgkJCQkJCQlldmVudCwKCQkJCQkJCSQuZXh0ZW5kKCBpbnN0Ll91aUhhc2goKSwgeyBzbmFwSXRlbTogaW5zdC5zbmFwRWxlbWVudHNbIGkgXS5pdGVtIH0gKQoJCQkJCQkpICk7CgkJCQl9CgkJCQlpbnN0LnNuYXBFbGVtZW50c1sgaSBdLnNuYXBwaW5nID0gZmFsc2U7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJaWYgKCBvLnNuYXBNb2RlICE9PSAiaW5uZXIiICkgewoJCQkJdHMgPSBNYXRoLmFicyggdCAtIHkyICkgPD0gZDsKCQkJCWJzID0gTWF0aC5hYnMoIGIgLSB5MSApIDw9IGQ7CgkJCQlscyA9IE1hdGguYWJzKCBsIC0geDIgKSA8PSBkOwoJCQkJcnMgPSBNYXRoLmFicyggciAtIHgxICkgPD0gZDsKCQkJCWlmICggdHMgKSB7CgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiB0IC0gaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQsCgkJCQkJCWxlZnQ6IDAKCQkJCQl9ICkudG9wOwoJCQkJfQoJCQkJaWYgKCBicyApIHsKCQkJCQl1aS5wb3NpdGlvbi50b3AgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbyggInJlbGF0aXZlIiwgewoJCQkJCQl0b3A6IGIsCgkJCQkJCWxlZnQ6IDAKCQkJCQl9ICkudG9wOwoJCQkJfQoJCQkJaWYgKCBscyApIHsKCQkJCQl1aS5wb3NpdGlvbi5sZWZ0ID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiAwLAoJCQkJCQlsZWZ0OiBsIC0gaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aAoJCQkJCX0gKS5sZWZ0OwoJCQkJfQoJCQkJaWYgKCBycyApIHsKCQkJCQl1aS5wb3NpdGlvbi5sZWZ0ID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiAwLAoJCQkJCQlsZWZ0OiByCgkJCQkJfSApLmxlZnQ7CgkJCQl9CgkJCX0KCgkJCWZpcnN0ID0gKCB0cyB8fCBicyB8fCBscyB8fCBycyApOwoKCQkJaWYgKCBvLnNuYXBNb2RlICE9PSAib3V0ZXIiICkgewoJCQkJdHMgPSBNYXRoLmFicyggdCAtIHkxICkgPD0gZDsKCQkJCWJzID0gTWF0aC5hYnMoIGIgLSB5MiApIDw9IGQ7CgkJCQlscyA9IE1hdGguYWJzKCBsIC0geDEgKSA8PSBkOwoJCQkJcnMgPSBNYXRoLmFicyggciAtIHgyICkgPD0gZDsKCQkJCWlmICggdHMgKSB7CgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiB0LAoJCQkJCQlsZWZ0OiAwCgkJCQkJfSApLnRvcDsKCQkJCX0KCQkJCWlmICggYnMgKSB7CgkJCQkJdWkucG9zaXRpb24udG9wID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiBiIC0gaW5zdC5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQsCgkJCQkJCWxlZnQ6IDAKCQkJCQl9ICkudG9wOwoJCQkJfQoJCQkJaWYgKCBscyApIHsKCQkJCQl1aS5wb3NpdGlvbi5sZWZ0ID0gaW5zdC5fY29udmVydFBvc2l0aW9uVG8oICJyZWxhdGl2ZSIsIHsKCQkJCQkJdG9wOiAwLAoJCQkJCQlsZWZ0OiBsCgkJCQkJfSApLmxlZnQ7CgkJCQl9CgkJCQlpZiAoIHJzICkgewoJCQkJCXVpLnBvc2l0aW9uLmxlZnQgPSBpbnN0Ll9jb252ZXJ0UG9zaXRpb25UbyggInJlbGF0aXZlIiwgewoJCQkJCQl0b3A6IDAsCgkJCQkJCWxlZnQ6IHIgLSBpbnN0LmhlbHBlclByb3BvcnRpb25zLndpZHRoCgkJCQkJfSApLmxlZnQ7CgkJCQl9CgkJCX0KCgkJCWlmICggIWluc3Quc25hcEVsZW1lbnRzWyBpIF0uc25hcHBpbmcgJiYgKCB0cyB8fCBicyB8fCBscyB8fCBycyB8fCBmaXJzdCApICkgewoJCQkJKCBpbnN0Lm9wdGlvbnMuc25hcC5zbmFwICYmCgkJCQkJaW5zdC5vcHRpb25zLnNuYXAuc25hcC5jYWxsKAoJCQkJCQlpbnN0LmVsZW1lbnQsCgkJCQkJCWV2ZW50LAoJCQkJCQkkLmV4dGVuZCggaW5zdC5fdWlIYXNoKCksIHsKCQkJCQkJCXNuYXBJdGVtOiBpbnN0LnNuYXBFbGVtZW50c1sgaSBdLml0ZW0KCQkJCQkJfSApICkgKTsKCQkJfQoJCQlpbnN0LnNuYXBFbGVtZW50c1sgaSBdLnNuYXBwaW5nID0gKCB0cyB8fCBicyB8fCBscyB8fCBycyB8fCBmaXJzdCApOwoKCQl9CgoJfQp9ICk7CgokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAic3RhY2siLCB7CglzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSwgaW5zdGFuY2UgKSB7CgkJdmFyIG1pbiwKCQkJbyA9IGluc3RhbmNlLm9wdGlvbnMsCgkJCWdyb3VwID0gJC5tYWtlQXJyYXkoICQoIG8uc3RhY2sgKSApLnNvcnQoIGZ1bmN0aW9uKCBhLCBiICkgewoJCQkJcmV0dXJuICggcGFyc2VJbnQoICQoIGEgKS5jc3MoICJ6SW5kZXgiICksIDEwICkgfHwgMCApIC0KCQkJCQkoIHBhcnNlSW50KCAkKCBiICkuY3NzKCAiekluZGV4IiApLCAxMCApIHx8IDAgKTsKCQkJfSApOwoKCQlpZiAoICFncm91cC5sZW5ndGggKSB7IHJldHVybjsgfQoKCQltaW4gPSBwYXJzZUludCggJCggZ3JvdXBbIDAgXSApLmNzcyggInpJbmRleCIgKSwgMTAgKSB8fCAwOwoJCSQoIGdyb3VwICkuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCSQoIHRoaXMgKS5jc3MoICJ6SW5kZXgiLCBtaW4gKyBpICk7CgkJfSApOwoJCXRoaXMuY3NzKCAiekluZGV4IiwgKCBtaW4gKyBncm91cC5sZW5ndGggKSApOwoJfQp9ICk7CgokLnVpLnBsdWdpbi5hZGQoICJkcmFnZ2FibGUiLCAiekluZGV4IiwgewoJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgewoJCXZhciB0ID0gJCggdWkuaGVscGVyICksCgkJCW8gPSBpbnN0YW5jZS5vcHRpb25zOwoKCQlpZiAoIHQuY3NzKCAiekluZGV4IiApICkgewoJCQlvLl96SW5kZXggPSB0LmNzcyggInpJbmRleCIgKTsKCQl9CgkJdC5jc3MoICJ6SW5kZXgiLCBvLnpJbmRleCApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWksIGluc3RhbmNlICkgewoJCXZhciBvID0gaW5zdGFuY2Uub3B0aW9uczsKCgkJaWYgKCBvLl96SW5kZXggKSB7CgkJCSQoIHVpLmhlbHBlciApLmNzcyggInpJbmRleCIsIG8uX3pJbmRleCApOwoJCX0KCX0KfSApOwoKdmFyIHdpZGdldHNEcmFnZ2FibGUgPSAkLnVpLmRyYWdnYWJsZTsKCgovKiEKICogalF1ZXJ5IFVJIFJlc2l6YWJsZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFJlc2l6YWJsZQovLz4+Z3JvdXA6IEludGVyYWN0aW9ucwovLz4+ZGVzY3JpcHRpb246IEVuYWJsZXMgcmVzaXplIGZ1bmN0aW9uYWxpdHkgZm9yIGFueSBlbGVtZW50LgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vcmVzaXphYmxlLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vcmVzaXphYmxlLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3Jlc2l6YWJsZS5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCiQud2lkZ2V0KCAidWkucmVzaXphYmxlIiwgJC51aS5tb3VzZSwgewoJdmVyc2lvbjogIjEuMTIuMSIsCgl3aWRnZXRFdmVudFByZWZpeDogInJlc2l6ZSIsCglvcHRpb25zOiB7CgkJYWxzb1Jlc2l6ZTogZmFsc2UsCgkJYW5pbWF0ZTogZmFsc2UsCgkJYW5pbWF0ZUR1cmF0aW9uOiAic2xvdyIsCgkJYW5pbWF0ZUVhc2luZzogInN3aW5nIiwKCQlhc3BlY3RSYXRpbzogZmFsc2UsCgkJYXV0b0hpZGU6IGZhbHNlLAoJCWNsYXNzZXM6IHsKCQkJInVpLXJlc2l6YWJsZS1zZSI6ICJ1aS1pY29uIHVpLWljb24tZ3JpcHNtYWxsLWRpYWdvbmFsLXNlIgoJCX0sCgkJY29udGFpbm1lbnQ6IGZhbHNlLAoJCWdob3N0OiBmYWxzZSwKCQlncmlkOiBmYWxzZSwKCQloYW5kbGVzOiAiZSxzLHNlIiwKCQloZWxwZXI6IGZhbHNlLAoJCW1heEhlaWdodDogbnVsbCwKCQltYXhXaWR0aDogbnVsbCwKCQltaW5IZWlnaHQ6IDEwLAoJCW1pbldpZHRoOiAxMCwKCgkJLy8gU2VlICM3OTYwCgkJekluZGV4OiA5MCwKCgkJLy8gQ2FsbGJhY2tzCgkJcmVzaXplOiBudWxsLAoJCXN0YXJ0OiBudWxsLAoJCXN0b3A6IG51bGwKCX0sCgoJX251bTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXJldHVybiBwYXJzZUZsb2F0KCB2YWx1ZSApIHx8IDA7Cgl9LAoKCV9pc051bWJlcjogZnVuY3Rpb24oIHZhbHVlICkgewoJCXJldHVybiAhaXNOYU4oIHBhcnNlRmxvYXQoIHZhbHVlICkgKTsKCX0sCgoJX2hhc1Njcm9sbDogZnVuY3Rpb24oIGVsLCBhICkgewoKCQlpZiAoICQoIGVsICkuY3NzKCAib3ZlcmZsb3ciICkgPT09ICJoaWRkZW4iICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl2YXIgc2Nyb2xsID0gKCBhICYmIGEgPT09ICJsZWZ0IiApID8gInNjcm9sbExlZnQiIDogInNjcm9sbFRvcCIsCgkJCWhhcyA9IGZhbHNlOwoKCQlpZiAoIGVsWyBzY3JvbGwgXSA+IDAgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCgkJLy8gVE9ETzogZGV0ZXJtaW5lIHdoaWNoIGNhc2VzIGFjdHVhbGx5IGNhdXNlIHRoaXMgdG8gaGFwcGVuCgkJLy8gaWYgdGhlIGVsZW1lbnQgZG9lc24ndCBoYXZlIHRoZSBzY3JvbGwgc2V0LCBzZWUgaWYgaXQncyBwb3NzaWJsZSB0bwoJCS8vIHNldCB0aGUgc2Nyb2xsCgkJZWxbIHNjcm9sbCBdID0gMTsKCQloYXMgPSAoIGVsWyBzY3JvbGwgXSA+IDAgKTsKCQllbFsgc2Nyb2xsIF0gPSAwOwoJCXJldHVybiBoYXM7Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgbWFyZ2lucywKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhhdCA9IHRoaXM7CgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1yZXNpemFibGUiICk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9hc3BlY3RSYXRpbzogISEoIG8uYXNwZWN0UmF0aW8gKSwKCQkJYXNwZWN0UmF0aW86IG8uYXNwZWN0UmF0aW8sCgkJCW9yaWdpbmFsRWxlbWVudDogdGhpcy5lbGVtZW50LAoJCQlfcHJvcG9ydGlvbmFsbHlSZXNpemVFbGVtZW50czogW10sCgkJCV9oZWxwZXI6IG8uaGVscGVyIHx8IG8uZ2hvc3QgfHwgby5hbmltYXRlID8gby5oZWxwZXIgfHwgInVpLXJlc2l6YWJsZS1oZWxwZXIiIDogbnVsbAoJCX0gKTsKCgkJLy8gV3JhcCB0aGUgZWxlbWVudCBpZiBpdCBjYW5ub3QgaG9sZCBjaGlsZCBub2RlcwoJCWlmICggdGhpcy5lbGVtZW50WyAwIF0ubm9kZU5hbWUubWF0Y2goIC9eKGNhbnZhc3x0ZXh0YXJlYXxpbnB1dHxzZWxlY3R8YnV0dG9ufGltZykkL2kgKSApIHsKCgkJCXRoaXMuZWxlbWVudC53cmFwKAoJCQkJJCggIjxkaXYgY2xhc3M9J3VpLXdyYXBwZXInIHN0eWxlPSdvdmVyZmxvdzogaGlkZGVuOyc+PC9kaXY+IiApLmNzcyggewoJCQkJCXBvc2l0aW9uOiB0aGlzLmVsZW1lbnQuY3NzKCAicG9zaXRpb24iICksCgkJCQkJd2lkdGg6IHRoaXMuZWxlbWVudC5vdXRlcldpZHRoKCksCgkJCQkJaGVpZ2h0OiB0aGlzLmVsZW1lbnQub3V0ZXJIZWlnaHQoKSwKCQkJCQl0b3A6IHRoaXMuZWxlbWVudC5jc3MoICJ0b3AiICksCgkJCQkJbGVmdDogdGhpcy5lbGVtZW50LmNzcyggImxlZnQiICkKCQkJCX0gKQoJCQkpOwoKCQkJdGhpcy5lbGVtZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpLmRhdGEoCgkJCQkidWktcmVzaXphYmxlIiwgdGhpcy5lbGVtZW50LnJlc2l6YWJsZSggImluc3RhbmNlIiApCgkJCSk7CgoJCQl0aGlzLmVsZW1lbnRJc1dyYXBwZXIgPSB0cnVlOwoKCQkJbWFyZ2lucyA9IHsKCQkJCW1hcmdpblRvcDogdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAibWFyZ2luVG9wIiApLAoJCQkJbWFyZ2luUmlnaHQ6IHRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggIm1hcmdpblJpZ2h0IiApLAoJCQkJbWFyZ2luQm90dG9tOiB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoICJtYXJnaW5Cb3R0b20iICksCgkJCQltYXJnaW5MZWZ0OiB0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoICJtYXJnaW5MZWZ0IiApCgkJCX07CgoJCQl0aGlzLmVsZW1lbnQuY3NzKCBtYXJnaW5zICk7CgkJCXRoaXMub3JpZ2luYWxFbGVtZW50LmNzcyggIm1hcmdpbiIsIDAgKTsKCgkJCS8vIHN1cHBvcnQ6IFNhZmFyaQoJCQkvLyBQcmV2ZW50IFNhZmFyaSB0ZXh0YXJlYSByZXNpemUKCQkJdGhpcy5vcmlnaW5hbFJlc2l6ZVN0eWxlID0gdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAicmVzaXplIiApOwoJCQl0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoICJyZXNpemUiLCAibm9uZSIgKTsKCgkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMucHVzaCggdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCB7CgkJCQlwb3NpdGlvbjogInN0YXRpYyIsCgkJCQl6b29tOiAxLAoJCQkJZGlzcGxheTogImJsb2NrIgoJCQl9ICkgKTsKCgkJCS8vIFN1cHBvcnQ6IElFOQoJCQkvLyBhdm9pZCBJRSBqdW1wIChoYXJkIHNldCB0aGUgbWFyZ2luKQoJCQl0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoIG1hcmdpbnMgKTsKCgkJCXRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplKCk7CgkJfQoKCQl0aGlzLl9zZXR1cEhhbmRsZXMoKTsKCgkJaWYgKCBvLmF1dG9IaWRlICkgewoJCQkkKCB0aGlzLmVsZW1lbnQgKQoJCQkJLm9uKCAibW91c2VlbnRlciIsIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggby5kaXNhYmxlZCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggInVpLXJlc2l6YWJsZS1hdXRvaGlkZSIgKTsKCQkJCQl0aGF0Ll9oYW5kbGVzLnNob3coKTsKCQkJCX0gKQoJCQkJLm9uKCAibW91c2VsZWF2ZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggby5kaXNhYmxlZCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQlpZiAoICF0aGF0LnJlc2l6aW5nICkgewoJCQkJCQl0aGF0Ll9hZGRDbGFzcyggInVpLXJlc2l6YWJsZS1hdXRvaGlkZSIgKTsKCQkJCQkJdGhhdC5faGFuZGxlcy5oaWRlKCk7CgkJCQkJfQoJCQkJfSApOwoJCX0KCgkJdGhpcy5fbW91c2VJbml0KCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCgkJdGhpcy5fbW91c2VEZXN0cm95KCk7CgoJCXZhciB3cmFwcGVyLAoJCQlfZGVzdHJveSA9IGZ1bmN0aW9uKCBleHAgKSB7CgkJCQkkKCBleHAgKQoJCQkJCS5yZW1vdmVEYXRhKCAicmVzaXphYmxlIiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS1yZXNpemFibGUiICkKCQkJCQkub2ZmKCAiLnJlc2l6YWJsZSIgKQoJCQkJCS5maW5kKCAiLnVpLXJlc2l6YWJsZS1oYW5kbGUiICkKCQkJCQkJLnJlbW92ZSgpOwoJCQl9OwoKCQkvLyBUT0RPOiBVbndyYXAgYXQgc2FtZSBET00gcG9zaXRpb24KCQlpZiAoIHRoaXMuZWxlbWVudElzV3JhcHBlciApIHsKCQkJX2Rlc3Ryb3koIHRoaXMuZWxlbWVudCApOwoJCQl3cmFwcGVyID0gdGhpcy5lbGVtZW50OwoJCQl0aGlzLm9yaWdpbmFsRWxlbWVudC5jc3MoIHsKCQkJCXBvc2l0aW9uOiB3cmFwcGVyLmNzcyggInBvc2l0aW9uIiApLAoJCQkJd2lkdGg6IHdyYXBwZXIub3V0ZXJXaWR0aCgpLAoJCQkJaGVpZ2h0OiB3cmFwcGVyLm91dGVySGVpZ2h0KCksCgkJCQl0b3A6IHdyYXBwZXIuY3NzKCAidG9wIiApLAoJCQkJbGVmdDogd3JhcHBlci5jc3MoICJsZWZ0IiApCgkJCX0gKS5pbnNlcnRBZnRlciggd3JhcHBlciApOwoJCQl3cmFwcGVyLnJlbW92ZSgpOwoJCX0KCgkJdGhpcy5vcmlnaW5hbEVsZW1lbnQuY3NzKCAicmVzaXplIiwgdGhpcy5vcmlnaW5hbFJlc2l6ZVN0eWxlICk7CgkJX2Rlc3Ryb3koIHRoaXMub3JpZ2luYWxFbGVtZW50ICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlzd2l0Y2ggKCBrZXkgKSB7CgkJY2FzZSAiaGFuZGxlcyI6CgkJCXRoaXMuX3JlbW92ZUhhbmRsZXMoKTsKCQkJdGhpcy5fc2V0dXBIYW5kbGVzKCk7CgkJCWJyZWFrOwoJCWRlZmF1bHQ6CgkJCWJyZWFrOwoJCX0KCX0sCgoJX3NldHVwSGFuZGxlczogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsIGhhbmRsZSwgaSwgbiwgaG5hbWUsIGF4aXMsIHRoYXQgPSB0aGlzOwoJCXRoaXMuaGFuZGxlcyA9IG8uaGFuZGxlcyB8fAoJCQkoICEkKCAiLnVpLXJlc2l6YWJsZS1oYW5kbGUiLCB0aGlzLmVsZW1lbnQgKS5sZW5ndGggPwoJCQkJImUscyxzZSIgOiB7CgkJCQkJbjogIi51aS1yZXNpemFibGUtbiIsCgkJCQkJZTogIi51aS1yZXNpemFibGUtZSIsCgkJCQkJczogIi51aS1yZXNpemFibGUtcyIsCgkJCQkJdzogIi51aS1yZXNpemFibGUtdyIsCgkJCQkJc2U6ICIudWktcmVzaXphYmxlLXNlIiwKCQkJCQlzdzogIi51aS1yZXNpemFibGUtc3ciLAoJCQkJCW5lOiAiLnVpLXJlc2l6YWJsZS1uZSIsCgkJCQkJbnc6ICIudWktcmVzaXphYmxlLW53IgoJCQkJfSApOwoKCQl0aGlzLl9oYW5kbGVzID0gJCgpOwoJCWlmICggdGhpcy5oYW5kbGVzLmNvbnN0cnVjdG9yID09PSBTdHJpbmcgKSB7CgoJCQlpZiAoIHRoaXMuaGFuZGxlcyA9PT0gImFsbCIgKSB7CgkJCQl0aGlzLmhhbmRsZXMgPSAibixlLHMsdyxzZSxzdyxuZSxudyI7CgkJCX0KCgkJCW4gPSB0aGlzLmhhbmRsZXMuc3BsaXQoICIsIiApOwoJCQl0aGlzLmhhbmRsZXMgPSB7fTsKCgkJCWZvciAoIGkgPSAwOyBpIDwgbi5sZW5ndGg7IGkrKyApIHsKCgkJCQloYW5kbGUgPSAkLnRyaW0oIG5bIGkgXSApOwoJCQkJaG5hbWUgPSAidWktcmVzaXphYmxlLSIgKyBoYW5kbGU7CgkJCQlheGlzID0gJCggIjxkaXY+IiApOwoJCQkJdGhpcy5fYWRkQ2xhc3MoIGF4aXMsICJ1aS1yZXNpemFibGUtaGFuZGxlICIgKyBobmFtZSApOwoKCQkJCWF4aXMuY3NzKCB7IHpJbmRleDogby56SW5kZXggfSApOwoKCQkJCXRoaXMuaGFuZGxlc1sgaGFuZGxlIF0gPSAiLnVpLXJlc2l6YWJsZS0iICsgaGFuZGxlOwoJCQkJdGhpcy5lbGVtZW50LmFwcGVuZCggYXhpcyApOwoJCQl9CgoJCX0KCgkJdGhpcy5fcmVuZGVyQXhpcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJCQl2YXIgaSwgYXhpcywgcGFkUG9zLCBwYWRXcmFwcGVyOwoKCQkJdGFyZ2V0ID0gdGFyZ2V0IHx8IHRoaXMuZWxlbWVudDsKCgkJCWZvciAoIGkgaW4gdGhpcy5oYW5kbGVzICkgewoKCQkJCWlmICggdGhpcy5oYW5kbGVzWyBpIF0uY29uc3RydWN0b3IgPT09IFN0cmluZyApIHsKCQkJCQl0aGlzLmhhbmRsZXNbIGkgXSA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggdGhpcy5oYW5kbGVzWyBpIF0gKS5maXJzdCgpLnNob3coKTsKCQkJCX0gZWxzZSBpZiAoIHRoaXMuaGFuZGxlc1sgaSBdLmpxdWVyeSB8fCB0aGlzLmhhbmRsZXNbIGkgXS5ub2RlVHlwZSApIHsKCQkJCQl0aGlzLmhhbmRsZXNbIGkgXSA9ICQoIHRoaXMuaGFuZGxlc1sgaSBdICk7CgkJCQkJdGhpcy5fb24oIHRoaXMuaGFuZGxlc1sgaSBdLCB7ICJtb3VzZWRvd24iOiB0aGF0Ll9tb3VzZURvd24gfSApOwoJCQkJfQoKCQkJCWlmICggdGhpcy5lbGVtZW50SXNXcmFwcGVyICYmCgkJCQkJCXRoaXMub3JpZ2luYWxFbGVtZW50WyAwIF0KCQkJCQkJCS5ub2RlTmFtZQoJCQkJCQkJLm1hdGNoKCAvXih0ZXh0YXJlYXxpbnB1dHxzZWxlY3R8YnV0dG9uKSQvaSApICkgewoJCQkJCWF4aXMgPSAkKCB0aGlzLmhhbmRsZXNbIGkgXSwgdGhpcy5lbGVtZW50ICk7CgoJCQkJCXBhZFdyYXBwZXIgPSAvc3d8bmV8bnd8c2V8bnxzLy50ZXN0KCBpICkgPwoJCQkJCQlheGlzLm91dGVySGVpZ2h0KCkgOgoJCQkJCQlheGlzLm91dGVyV2lkdGgoKTsKCgkJCQkJcGFkUG9zID0gWyAicGFkZGluZyIsCgkJCQkJCS9uZXxud3xuLy50ZXN0KCBpICkgPyAiVG9wIiA6CgkJCQkJCS9zZXxzd3xzLy50ZXN0KCBpICkgPyAiQm90dG9tIiA6CgkJCQkJCS9eZSQvLnRlc3QoIGkgKSA\/ICJSaWdodCIgOiAiTGVmdCIgXS5qb2luKCAiIiApOwoKCQkJCQl0YXJnZXQuY3NzKCBwYWRQb3MsIHBhZFdyYXBwZXIgKTsKCgkJCQkJdGhpcy5fcHJvcG9ydGlvbmFsbHlSZXNpemUoKTsKCQkJCX0KCgkJCQl0aGlzLl9oYW5kbGVzID0gdGhpcy5faGFuZGxlcy5hZGQoIHRoaXMuaGFuZGxlc1sgaSBdICk7CgkJCX0KCQl9OwoKCQkvLyBUT0RPOiBtYWtlIHJlbmRlckF4aXMgYSBwcm90b3R5cGUgZnVuY3Rpb24KCQl0aGlzLl9yZW5kZXJBeGlzKCB0aGlzLmVsZW1lbnQgKTsKCgkJdGhpcy5faGFuZGxlcyA9IHRoaXMuX2hhbmRsZXMuYWRkKCB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1yZXNpemFibGUtaGFuZGxlIiApICk7CgkJdGhpcy5faGFuZGxlcy5kaXNhYmxlU2VsZWN0aW9uKCk7CgoJCXRoaXMuX2hhbmRsZXMub24oICJtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhhdC5yZXNpemluZyApIHsKCQkJCWlmICggdGhpcy5jbGFzc05hbWUgKSB7CgkJCQkJYXhpcyA9IHRoaXMuY2xhc3NOYW1lLm1hdGNoKCAvdWktcmVzaXphYmxlLShzZXxzd3xuZXxud3xufGV8c3x3KS9pICk7CgkJCQl9CgkJCQl0aGF0LmF4aXMgPSBheGlzICYmIGF4aXNbIDEgXSA\/IGF4aXNbIDEgXSA6ICJzZSI7CgkJCX0KCQl9ICk7CgoJCWlmICggby5hdXRvSGlkZSApIHsKCQkJdGhpcy5faGFuZGxlcy5oaWRlKCk7CgkJCXRoaXMuX2FkZENsYXNzKCAidWktcmVzaXphYmxlLWF1dG9oaWRlIiApOwoJCX0KCX0sCgoJX3JlbW92ZUhhbmRsZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZXMucmVtb3ZlKCk7Cgl9LAoKCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaSwgaGFuZGxlLAoJCQljYXB0dXJlID0gZmFsc2U7CgoJCWZvciAoIGkgaW4gdGhpcy5oYW5kbGVzICkgewoJCQloYW5kbGUgPSAkKCB0aGlzLmhhbmRsZXNbIGkgXSApWyAwIF07CgkJCWlmICggaGFuZGxlID09PSBldmVudC50YXJnZXQgfHwgJC5jb250YWlucyggaGFuZGxlLCBldmVudC50YXJnZXQgKSApIHsKCQkJCWNhcHR1cmUgPSB0cnVlOwoJCQl9CgkJfQoKCQlyZXR1cm4gIXRoaXMub3B0aW9ucy5kaXNhYmxlZCAmJiBjYXB0dXJlOwoJfSwKCglfbW91c2VTdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl2YXIgY3VybGVmdCwgY3VydG9wLCBjdXJzb3IsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWVsID0gdGhpcy5lbGVtZW50OwoKCQl0aGlzLnJlc2l6aW5nID0gdHJ1ZTsKCgkJdGhpcy5fcmVuZGVyUHJveHkoKTsKCgkJY3VybGVmdCA9IHRoaXMuX251bSggdGhpcy5oZWxwZXIuY3NzKCAibGVmdCIgKSApOwoJCWN1cnRvcCA9IHRoaXMuX251bSggdGhpcy5oZWxwZXIuY3NzKCAidG9wIiApICk7CgoJCWlmICggby5jb250YWlubWVudCApIHsKCQkJY3VybGVmdCArPSAkKCBvLmNvbnRhaW5tZW50ICkuc2Nyb2xsTGVmdCgpIHx8IDA7CgkJCWN1cnRvcCArPSAkKCBvLmNvbnRhaW5tZW50ICkuc2Nyb2xsVG9wKCkgfHwgMDsKCQl9CgoJCXRoaXMub2Zmc2V0ID0gdGhpcy5oZWxwZXIub2Zmc2V0KCk7CgkJdGhpcy5wb3NpdGlvbiA9IHsgbGVmdDogY3VybGVmdCwgdG9wOiBjdXJ0b3AgfTsKCgkJdGhpcy5zaXplID0gdGhpcy5faGVscGVyID8gewoJCQkJd2lkdGg6IHRoaXMuaGVscGVyLndpZHRoKCksCgkJCQloZWlnaHQ6IHRoaXMuaGVscGVyLmhlaWdodCgpCgkJCX0gOiB7CgkJCQl3aWR0aDogZWwud2lkdGgoKSwKCQkJCWhlaWdodDogZWwuaGVpZ2h0KCkKCQkJfTsKCgkJdGhpcy5vcmlnaW5hbFNpemUgPSB0aGlzLl9oZWxwZXIgPyB7CgkJCQl3aWR0aDogZWwub3V0ZXJXaWR0aCgpLAoJCQkJaGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpCgkJCX0gOiB7CgkJCQl3aWR0aDogZWwud2lkdGgoKSwKCQkJCWhlaWdodDogZWwuaGVpZ2h0KCkKCQkJfTsKCgkJdGhpcy5zaXplRGlmZiA9IHsKCQkJd2lkdGg6IGVsLm91dGVyV2lkdGgoKSAtIGVsLndpZHRoKCksCgkJCWhlaWdodDogZWwub3V0ZXJIZWlnaHQoKSAtIGVsLmhlaWdodCgpCgkJfTsKCgkJdGhpcy5vcmlnaW5hbFBvc2l0aW9uID0geyBsZWZ0OiBjdXJsZWZ0LCB0b3A6IGN1cnRvcCB9OwoJCXRoaXMub3JpZ2luYWxNb3VzZVBvc2l0aW9uID0geyBsZWZ0OiBldmVudC5wYWdlWCwgdG9wOiBldmVudC5wYWdlWSB9OwoKCQl0aGlzLmFzcGVjdFJhdGlvID0gKCB0eXBlb2Ygby5hc3BlY3RSYXRpbyA9PT0gIm51bWJlciIgKSA\/CgkJCW8uYXNwZWN0UmF0aW8gOgoJCQkoICggdGhpcy5vcmlnaW5hbFNpemUud2lkdGggLyB0aGlzLm9yaWdpbmFsU2l6ZS5oZWlnaHQgKSB8fCAxICk7CgoJCWN1cnNvciA9ICQoICIudWktcmVzaXphYmxlLSIgKyB0aGlzLmF4aXMgKS5jc3MoICJjdXJzb3IiICk7CgkJJCggImJvZHkiICkuY3NzKCAiY3Vyc29yIiwgY3Vyc29yID09PSAiYXV0byIgPyB0aGlzLmF4aXMgKyAiLXJlc2l6ZSIgOiBjdXJzb3IgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1yZXNpemFibGUtcmVzaXppbmciICk7CgkJdGhpcy5fcHJvcGFnYXRlKCAic3RhcnQiLCBldmVudCApOwoJCXJldHVybiB0cnVlOwoJfSwKCglfbW91c2VEcmFnOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXZhciBkYXRhLCBwcm9wcywKCQkJc21wID0gdGhpcy5vcmlnaW5hbE1vdXNlUG9zaXRpb24sCgkJCWEgPSB0aGlzLmF4aXMsCgkJCWR4ID0gKCBldmVudC5wYWdlWCAtIHNtcC5sZWZ0ICkgfHwgMCwKCQkJZHkgPSAoIGV2ZW50LnBhZ2VZIC0gc21wLnRvcCApIHx8IDAsCgkJCXRyaWdnZXIgPSB0aGlzLl9jaGFuZ2VbIGEgXTsKCgkJdGhpcy5fdXBkYXRlUHJldlByb3BlcnRpZXMoKTsKCgkJaWYgKCAhdHJpZ2dlciApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJZGF0YSA9IHRyaWdnZXIuYXBwbHkoIHRoaXMsIFsgZXZlbnQsIGR4LCBkeSBdICk7CgoJCXRoaXMuX3VwZGF0ZVZpcnR1YWxCb3VuZGFyaWVzKCBldmVudC5zaGlmdEtleSApOwoJCWlmICggdGhpcy5fYXNwZWN0UmF0aW8gfHwgZXZlbnQuc2hpZnRLZXkgKSB7CgkJCWRhdGEgPSB0aGlzLl91cGRhdGVSYXRpbyggZGF0YSwgZXZlbnQgKTsKCQl9CgoJCWRhdGEgPSB0aGlzLl9yZXNwZWN0U2l6ZSggZGF0YSwgZXZlbnQgKTsKCgkJdGhpcy5fdXBkYXRlQ2FjaGUoIGRhdGEgKTsKCgkJdGhpcy5fcHJvcGFnYXRlKCAicmVzaXplIiwgZXZlbnQgKTsKCgkJcHJvcHMgPSB0aGlzLl9hcHBseUNoYW5nZXMoKTsKCgkJaWYgKCAhdGhpcy5faGVscGVyICYmIHRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOwoJCX0KCgkJaWYgKCAhJC5pc0VtcHR5T2JqZWN0KCBwcm9wcyApICkgewoJCQl0aGlzLl91cGRhdGVQcmV2UHJvcGVydGllcygpOwoJCQl0aGlzLl90cmlnZ2VyKCAicmVzaXplIiwgZXZlbnQsIHRoaXMudWkoKSApOwoJCQl0aGlzLl9hcHBseUNoYW5nZXMoKTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX21vdXNlU3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl0aGlzLnJlc2l6aW5nID0gZmFsc2U7CgkJdmFyIHByLCBpc3RhLCBzb2Zmc2V0aCwgc29mZnNldHcsIHMsIGxlZnQsIHRvcCwKCQkJbyA9IHRoaXMub3B0aW9ucywgdGhhdCA9IHRoaXM7CgoJCWlmICggdGhpcy5faGVscGVyICkgewoKCQkJcHIgPSB0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZUVsZW1lbnRzOwoJCQlpc3RhID0gcHIubGVuZ3RoICYmICggL3RleHRhcmVhL2kgKS50ZXN0KCBwclsgMCBdLm5vZGVOYW1lICk7CgkJCXNvZmZzZXRoID0gaXN0YSAmJiB0aGlzLl9oYXNTY3JvbGwoIHByWyAwIF0sICJsZWZ0IiApID8gMCA6IHRoYXQuc2l6ZURpZmYuaGVpZ2h0OwoJCQlzb2Zmc2V0dyA9IGlzdGEgPyAwIDogdGhhdC5zaXplRGlmZi53aWR0aDsKCgkJCXMgPSB7CgkJCQl3aWR0aDogKCB0aGF0LmhlbHBlci53aWR0aCgpICAtIHNvZmZzZXR3ICksCgkJCQloZWlnaHQ6ICggdGhhdC5oZWxwZXIuaGVpZ2h0KCkgLSBzb2Zmc2V0aCApCgkJCX07CgkJCWxlZnQgPSAoIHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJsZWZ0IiApICkgKwoJCQkJKCB0aGF0LnBvc2l0aW9uLmxlZnQgLSB0aGF0Lm9yaWdpbmFsUG9zaXRpb24ubGVmdCApICkgfHwgbnVsbDsKCQkJdG9wID0gKCBwYXJzZUZsb2F0KCB0aGF0LmVsZW1lbnQuY3NzKCAidG9wIiApICkgKwoJCQkJKCB0aGF0LnBvc2l0aW9uLnRvcCAtIHRoYXQub3JpZ2luYWxQb3NpdGlvbi50b3AgKSApIHx8IG51bGw7CgoJCQlpZiAoICFvLmFuaW1hdGUgKSB7CgkJCQl0aGlzLmVsZW1lbnQuY3NzKCAkLmV4dGVuZCggcywgeyB0b3A6IHRvcCwgbGVmdDogbGVmdCB9ICkgKTsKCQkJfQoKCQkJdGhhdC5oZWxwZXIuaGVpZ2h0KCB0aGF0LnNpemUuaGVpZ2h0ICk7CgkJCXRoYXQuaGVscGVyLndpZHRoKCB0aGF0LnNpemUud2lkdGggKTsKCgkJCWlmICggdGhpcy5faGVscGVyICYmICFvLmFuaW1hdGUgKSB7CgkJCQl0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZSgpOwoJCQl9CgkJfQoKCQkkKCAiYm9keSIgKS5jc3MoICJjdXJzb3IiLCAiYXV0byIgKTsKCgkJdGhpcy5fcmVtb3ZlQ2xhc3MoICJ1aS1yZXNpemFibGUtcmVzaXppbmciICk7CgoJCXRoaXMuX3Byb3BhZ2F0ZSggInN0b3AiLCBldmVudCApOwoKCQlpZiAoIHRoaXMuX2hlbHBlciApIHsKCQkJdGhpcy5oZWxwZXIucmVtb3ZlKCk7CgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfSwKCglfdXBkYXRlUHJldlByb3BlcnRpZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMucHJldlBvc2l0aW9uID0gewoJCQl0b3A6IHRoaXMucG9zaXRpb24udG9wLAoJCQlsZWZ0OiB0aGlzLnBvc2l0aW9uLmxlZnQKCQl9OwoJCXRoaXMucHJldlNpemUgPSB7CgkJCXdpZHRoOiB0aGlzLnNpemUud2lkdGgsCgkJCWhlaWdodDogdGhpcy5zaXplLmhlaWdodAoJCX07Cgl9LAoKCV9hcHBseUNoYW5nZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwcm9wcyA9IHt9OwoKCQlpZiAoIHRoaXMucG9zaXRpb24udG9wICE9PSB0aGlzLnByZXZQb3NpdGlvbi50b3AgKSB7CgkJCXByb3BzLnRvcCA9IHRoaXMucG9zaXRpb24udG9wICsgInB4IjsKCQl9CgkJaWYgKCB0aGlzLnBvc2l0aW9uLmxlZnQgIT09IHRoaXMucHJldlBvc2l0aW9uLmxlZnQgKSB7CgkJCXByb3BzLmxlZnQgPSB0aGlzLnBvc2l0aW9uLmxlZnQgKyAicHgiOwoJCX0KCQlpZiAoIHRoaXMuc2l6ZS53aWR0aCAhPT0gdGhpcy5wcmV2U2l6ZS53aWR0aCApIHsKCQkJcHJvcHMud2lkdGggPSB0aGlzLnNpemUud2lkdGggKyAicHgiOwoJCX0KCQlpZiAoIHRoaXMuc2l6ZS5oZWlnaHQgIT09IHRoaXMucHJldlNpemUuaGVpZ2h0ICkgewoJCQlwcm9wcy5oZWlnaHQgPSB0aGlzLnNpemUuaGVpZ2h0ICsgInB4IjsKCQl9CgoJCXRoaXMuaGVscGVyLmNzcyggcHJvcHMgKTsKCgkJcmV0dXJuIHByb3BzOwoJfSwKCglfdXBkYXRlVmlydHVhbEJvdW5kYXJpZXM6IGZ1bmN0aW9uKCBmb3JjZUFzcGVjdFJhdGlvICkgewoJCXZhciBwTWluV2lkdGgsIHBNYXhXaWR0aCwgcE1pbkhlaWdodCwgcE1heEhlaWdodCwgYiwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJYiA9IHsKCQkJbWluV2lkdGg6IHRoaXMuX2lzTnVtYmVyKCBvLm1pbldpZHRoICkgPyBvLm1pbldpZHRoIDogMCwKCQkJbWF4V2lkdGg6IHRoaXMuX2lzTnVtYmVyKCBvLm1heFdpZHRoICkgPyBvLm1heFdpZHRoIDogSW5maW5pdHksCgkJCW1pbkhlaWdodDogdGhpcy5faXNOdW1iZXIoIG8ubWluSGVpZ2h0ICkgPyBvLm1pbkhlaWdodCA6IDAsCgkJCW1heEhlaWdodDogdGhpcy5faXNOdW1iZXIoIG8ubWF4SGVpZ2h0ICkgPyBvLm1heEhlaWdodCA6IEluZmluaXR5CgkJfTsKCgkJaWYgKCB0aGlzLl9hc3BlY3RSYXRpbyB8fCBmb3JjZUFzcGVjdFJhdGlvICkgewoJCQlwTWluV2lkdGggPSBiLm1pbkhlaWdodCAqIHRoaXMuYXNwZWN0UmF0aW87CgkJCXBNaW5IZWlnaHQgPSBiLm1pbldpZHRoIC8gdGhpcy5hc3BlY3RSYXRpbzsKCQkJcE1heFdpZHRoID0gYi5tYXhIZWlnaHQgKiB0aGlzLmFzcGVjdFJhdGlvOwoJCQlwTWF4SGVpZ2h0ID0gYi5tYXhXaWR0aCAvIHRoaXMuYXNwZWN0UmF0aW87CgoJCQlpZiAoIHBNaW5XaWR0aCA+IGIubWluV2lkdGggKSB7CgkJCQliLm1pbldpZHRoID0gcE1pbldpZHRoOwoJCQl9CgkJCWlmICggcE1pbkhlaWdodCA+IGIubWluSGVpZ2h0ICkgewoJCQkJYi5taW5IZWlnaHQgPSBwTWluSGVpZ2h0OwoJCQl9CgkJCWlmICggcE1heFdpZHRoIDwgYi5tYXhXaWR0aCApIHsKCQkJCWIubWF4V2lkdGggPSBwTWF4V2lkdGg7CgkJCX0KCQkJaWYgKCBwTWF4SGVpZ2h0IDwgYi5tYXhIZWlnaHQgKSB7CgkJCQliLm1heEhlaWdodCA9IHBNYXhIZWlnaHQ7CgkJCX0KCQl9CgkJdGhpcy5fdkJvdW5kYXJpZXMgPSBiOwoJfSwKCglfdXBkYXRlQ2FjaGU6IGZ1bmN0aW9uKCBkYXRhICkgewoJCXRoaXMub2Zmc2V0ID0gdGhpcy5oZWxwZXIub2Zmc2V0KCk7CgkJaWYgKCB0aGlzLl9pc051bWJlciggZGF0YS5sZWZ0ICkgKSB7CgkJCXRoaXMucG9zaXRpb24ubGVmdCA9IGRhdGEubGVmdDsKCQl9CgkJaWYgKCB0aGlzLl9pc051bWJlciggZGF0YS50b3AgKSApIHsKCQkJdGhpcy5wb3NpdGlvbi50b3AgPSBkYXRhLnRvcDsKCQl9CgkJaWYgKCB0aGlzLl9pc051bWJlciggZGF0YS5oZWlnaHQgKSApIHsKCQkJdGhpcy5zaXplLmhlaWdodCA9IGRhdGEuaGVpZ2h0OwoJCX0KCQlpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLndpZHRoICkgKSB7CgkJCXRoaXMuc2l6ZS53aWR0aCA9IGRhdGEud2lkdGg7CgkJfQoJfSwKCglfdXBkYXRlUmF0aW86IGZ1bmN0aW9uKCBkYXRhICkgewoKCQl2YXIgY3BvcyA9IHRoaXMucG9zaXRpb24sCgkJCWNzaXplID0gdGhpcy5zaXplLAoJCQlhID0gdGhpcy5heGlzOwoKCQlpZiAoIHRoaXMuX2lzTnVtYmVyKCBkYXRhLmhlaWdodCApICkgewoJCQlkYXRhLndpZHRoID0gKCBkYXRhLmhlaWdodCAqIHRoaXMuYXNwZWN0UmF0aW8gKTsKCQl9IGVsc2UgaWYgKCB0aGlzLl9pc051bWJlciggZGF0YS53aWR0aCApICkgewoJCQlkYXRhLmhlaWdodCA9ICggZGF0YS53aWR0aCAvIHRoaXMuYXNwZWN0UmF0aW8gKTsKCQl9CgoJCWlmICggYSA9PT0gInN3IiApIHsKCQkJZGF0YS5sZWZ0ID0gY3Bvcy5sZWZ0ICsgKCBjc2l6ZS53aWR0aCAtIGRhdGEud2lkdGggKTsKCQkJZGF0YS50b3AgPSBudWxsOwoJCX0KCQlpZiAoIGEgPT09ICJudyIgKSB7CgkJCWRhdGEudG9wID0gY3Bvcy50b3AgKyAoIGNzaXplLmhlaWdodCAtIGRhdGEuaGVpZ2h0ICk7CgkJCWRhdGEubGVmdCA9IGNwb3MubGVmdCArICggY3NpemUud2lkdGggLSBkYXRhLndpZHRoICk7CgkJfQoKCQlyZXR1cm4gZGF0YTsKCX0sCgoJX3Jlc3BlY3RTaXplOiBmdW5jdGlvbiggZGF0YSApIHsKCgkJdmFyIG8gPSB0aGlzLl92Qm91bmRhcmllcywKCQkJYSA9IHRoaXMuYXhpcywKCQkJaXNtYXh3ID0gdGhpcy5faXNOdW1iZXIoIGRhdGEud2lkdGggKSAmJiBvLm1heFdpZHRoICYmICggby5tYXhXaWR0aCA8IGRhdGEud2lkdGggKSwKCQkJaXNtYXhoID0gdGhpcy5faXNOdW1iZXIoIGRhdGEuaGVpZ2h0ICkgJiYgby5tYXhIZWlnaHQgJiYgKCBvLm1heEhlaWdodCA8IGRhdGEuaGVpZ2h0ICksCgkJCWlzbWludyA9IHRoaXMuX2lzTnVtYmVyKCBkYXRhLndpZHRoICkgJiYgby5taW5XaWR0aCAmJiAoIG8ubWluV2lkdGggPiBkYXRhLndpZHRoICksCgkJCWlzbWluaCA9IHRoaXMuX2lzTnVtYmVyKCBkYXRhLmhlaWdodCApICYmIG8ubWluSGVpZ2h0ICYmICggby5taW5IZWlnaHQgPiBkYXRhLmhlaWdodCApLAoJCQlkdyA9IHRoaXMub3JpZ2luYWxQb3NpdGlvbi5sZWZ0ICsgdGhpcy5vcmlnaW5hbFNpemUud2lkdGgsCgkJCWRoID0gdGhpcy5vcmlnaW5hbFBvc2l0aW9uLnRvcCArIHRoaXMub3JpZ2luYWxTaXplLmhlaWdodCwKCQkJY3cgPSAvc3d8bnd8dy8udGVzdCggYSApLCBjaCA9IC9ud3xuZXxuLy50ZXN0KCBhICk7CgkJaWYgKCBpc21pbncgKSB7CgkJCWRhdGEud2lkdGggPSBvLm1pbldpZHRoOwoJCX0KCQlpZiAoIGlzbWluaCApIHsKCQkJZGF0YS5oZWlnaHQgPSBvLm1pbkhlaWdodDsKCQl9CgkJaWYgKCBpc21heHcgKSB7CgkJCWRhdGEud2lkdGggPSBvLm1heFdpZHRoOwoJCX0KCQlpZiAoIGlzbWF4aCApIHsKCQkJZGF0YS5oZWlnaHQgPSBvLm1heEhlaWdodDsKCQl9CgoJCWlmICggaXNtaW53ICYmIGN3ICkgewoJCQlkYXRhLmxlZnQgPSBkdyAtIG8ubWluV2lkdGg7CgkJfQoJCWlmICggaXNtYXh3ICYmIGN3ICkgewoJCQlkYXRhLmxlZnQgPSBkdyAtIG8ubWF4V2lkdGg7CgkJfQoJCWlmICggaXNtaW5oICYmIGNoICkgewoJCQlkYXRhLnRvcCA9IGRoIC0gby5taW5IZWlnaHQ7CgkJfQoJCWlmICggaXNtYXhoICYmIGNoICkgewoJCQlkYXRhLnRvcCA9IGRoIC0gby5tYXhIZWlnaHQ7CgkJfQoKCQkvLyBGaXhpbmcganVtcCBlcnJvciBvbiB0b3AvbGVmdCAtIGJ1ZyAjMjMzMAoJCWlmICggIWRhdGEud2lkdGggJiYgIWRhdGEuaGVpZ2h0ICYmICFkYXRhLmxlZnQgJiYgZGF0YS50b3AgKSB7CgkJCWRhdGEudG9wID0gbnVsbDsKCQl9IGVsc2UgaWYgKCAhZGF0YS53aWR0aCAmJiAhZGF0YS5oZWlnaHQgJiYgIWRhdGEudG9wICYmIGRhdGEubGVmdCApIHsKCQkJZGF0YS5sZWZ0ID0gbnVsbDsKCQl9CgoJCXJldHVybiBkYXRhOwoJfSwKCglfZ2V0UGFkZGluZ1BsdXNCb3JkZXJEaW1lbnNpb25zOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgaSA9IDAsCgkJCXdpZHRocyA9IFtdLAoJCQlib3JkZXJzID0gWwoJCQkJZWxlbWVudC5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwKCQkJCWVsZW1lbnQuY3NzKCAiYm9yZGVyUmlnaHRXaWR0aCIgKSwKCQkJCWVsZW1lbnQuY3NzKCAiYm9yZGVyQm90dG9tV2lkdGgiICksCgkJCQllbGVtZW50LmNzcyggImJvcmRlckxlZnRXaWR0aCIgKQoJCQldLAoJCQlwYWRkaW5ncyA9IFsKCQkJCWVsZW1lbnQuY3NzKCAicGFkZGluZ1RvcCIgKSwKCQkJCWVsZW1lbnQuY3NzKCAicGFkZGluZ1JpZ2h0IiApLAoJCQkJZWxlbWVudC5jc3MoICJwYWRkaW5nQm90dG9tIiApLAoJCQkJZWxlbWVudC5jc3MoICJwYWRkaW5nTGVmdCIgKQoJCQldOwoKCQlmb3IgKCA7IGkgPCA0OyBpKysgKSB7CgkJCXdpZHRoc1sgaSBdID0gKCBwYXJzZUZsb2F0KCBib3JkZXJzWyBpIF0gKSB8fCAwICk7CgkJCXdpZHRoc1sgaSBdICs9ICggcGFyc2VGbG9hdCggcGFkZGluZ3NbIGkgXSApIHx8IDAgKTsKCQl9CgoJCXJldHVybiB7CgkJCWhlaWdodDogd2lkdGhzWyAwIF0gKyB3aWR0aHNbIDIgXSwKCQkJd2lkdGg6IHdpZHRoc1sgMSBdICsgd2lkdGhzWyAzIF0KCQl9OwoJfSwKCglfcHJvcG9ydGlvbmFsbHlSZXNpemU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoICF0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZUVsZW1lbnRzLmxlbmd0aCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHByZWwsCgkJCWkgPSAwLAoJCQllbGVtZW50ID0gdGhpcy5oZWxwZXIgfHwgdGhpcy5lbGVtZW50OwoKCQlmb3IgKCA7IGkgPCB0aGlzLl9wcm9wb3J0aW9uYWxseVJlc2l6ZUVsZW1lbnRzLmxlbmd0aDsgaSsrICkgewoKCQkJcHJlbCA9IHRoaXMuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHNbIGkgXTsKCgkJCS8vIFRPRE86IFNlZW1zIGxpa2UgYSBidWcgdG8gY2FjaGUgdGhpcy5vdXRlckRpbWVuc2lvbnMKCQkJLy8gY29uc2lkZXJpbmcgdGhhdCB3ZSBhcmUgaW4gYSBsb29wLgoJCQlpZiAoICF0aGlzLm91dGVyRGltZW5zaW9ucyApIHsKCQkJCXRoaXMub3V0ZXJEaW1lbnNpb25zID0gdGhpcy5fZ2V0UGFkZGluZ1BsdXNCb3JkZXJEaW1lbnNpb25zKCBwcmVsICk7CgkJCX0KCgkJCXByZWwuY3NzKCB7CgkJCQloZWlnaHQ6ICggZWxlbWVudC5oZWlnaHQoKSAtIHRoaXMub3V0ZXJEaW1lbnNpb25zLmhlaWdodCApIHx8IDAsCgkJCQl3aWR0aDogKCBlbGVtZW50LndpZHRoKCkgLSB0aGlzLm91dGVyRGltZW5zaW9ucy53aWR0aCApIHx8IDAKCQkJfSApOwoKCQl9CgoJfSwKCglfcmVuZGVyUHJveHk6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWwgPSB0aGlzLmVsZW1lbnQsIG8gPSB0aGlzLm9wdGlvbnM7CgkJdGhpcy5lbGVtZW50T2Zmc2V0ID0gZWwub2Zmc2V0KCk7CgoJCWlmICggdGhpcy5faGVscGVyICkgewoKCQkJdGhpcy5oZWxwZXIgPSB0aGlzLmhlbHBlciB8fCAkKCAiPGRpdiBzdHlsZT0nb3ZlcmZsb3c6aGlkZGVuOyc+PC9kaXY+IiApOwoKCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGVscGVyLCB0aGlzLl9oZWxwZXIgKTsKCQkJdGhpcy5oZWxwZXIuY3NzKCB7CgkJCQl3aWR0aDogdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKSwKCQkJCWhlaWdodDogdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCksCgkJCQlwb3NpdGlvbjogImFic29sdXRlIiwKCQkJCWxlZnQ6IHRoaXMuZWxlbWVudE9mZnNldC5sZWZ0ICsgInB4IiwKCQkJCXRvcDogdGhpcy5lbGVtZW50T2Zmc2V0LnRvcCArICJweCIsCgkJCQl6SW5kZXg6ICsrby56SW5kZXggLy9UT0RPOiBEb24ndCBtb2RpZnkgb3B0aW9uCgkJCX0gKTsKCgkJCXRoaXMuaGVscGVyCgkJCQkuYXBwZW5kVG8oICJib2R5IiApCgkJCQkuZGlzYWJsZVNlbGVjdGlvbigpOwoKCQl9IGVsc2UgewoJCQl0aGlzLmhlbHBlciA9IHRoaXMuZWxlbWVudDsKCQl9CgoJfSwKCglfY2hhbmdlOiB7CgkJZTogZnVuY3Rpb24oIGV2ZW50LCBkeCApIHsKCQkJcmV0dXJuIHsgd2lkdGg6IHRoaXMub3JpZ2luYWxTaXplLndpZHRoICsgZHggfTsKCQl9LAoJCXc6IGZ1bmN0aW9uKCBldmVudCwgZHggKSB7CgkJCXZhciBjcyA9IHRoaXMub3JpZ2luYWxTaXplLCBzcCA9IHRoaXMub3JpZ2luYWxQb3NpdGlvbjsKCQkJcmV0dXJuIHsgbGVmdDogc3AubGVmdCArIGR4LCB3aWR0aDogY3Mud2lkdGggLSBkeCB9OwoJCX0sCgkJbjogZnVuY3Rpb24oIGV2ZW50LCBkeCwgZHkgKSB7CgkJCXZhciBjcyA9IHRoaXMub3JpZ2luYWxTaXplLCBzcCA9IHRoaXMub3JpZ2luYWxQb3NpdGlvbjsKCQkJcmV0dXJuIHsgdG9wOiBzcC50b3AgKyBkeSwgaGVpZ2h0OiBjcy5oZWlnaHQgLSBkeSB9OwoJCX0sCgkJczogZnVuY3Rpb24oIGV2ZW50LCBkeCwgZHkgKSB7CgkJCXJldHVybiB7IGhlaWdodDogdGhpcy5vcmlnaW5hbFNpemUuaGVpZ2h0ICsgZHkgfTsKCQl9LAoJCXNlOiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsKCQkJcmV0dXJuICQuZXh0ZW5kKCB0aGlzLl9jaGFuZ2Uucy5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCQl0aGlzLl9jaGFuZ2UuZS5hcHBseSggdGhpcywgWyBldmVudCwgZHgsIGR5IF0gKSApOwoJCX0sCgkJc3c6IGZ1bmN0aW9uKCBldmVudCwgZHgsIGR5ICkgewoJCQlyZXR1cm4gJC5leHRlbmQoIHRoaXMuX2NoYW5nZS5zLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJCXRoaXMuX2NoYW5nZS53LmFwcGx5KCB0aGlzLCBbIGV2ZW50LCBkeCwgZHkgXSApICk7CgkJfSwKCQluZTogZnVuY3Rpb24oIGV2ZW50LCBkeCwgZHkgKSB7CgkJCXJldHVybiAkLmV4dGVuZCggdGhpcy5fY2hhbmdlLm4uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApLAoJCQkJdGhpcy5fY2hhbmdlLmUuYXBwbHkoIHRoaXMsIFsgZXZlbnQsIGR4LCBkeSBdICkgKTsKCQl9LAoJCW53OiBmdW5jdGlvbiggZXZlbnQsIGR4LCBkeSApIHsKCQkJcmV0dXJuICQuZXh0ZW5kKCB0aGlzLl9jaGFuZ2Uubi5hcHBseSggdGhpcywgYXJndW1lbnRzICksCgkJCQl0aGlzLl9jaGFuZ2Uudy5hcHBseSggdGhpcywgWyBldmVudCwgZHgsIGR5IF0gKSApOwoJCX0KCX0sCgoJX3Byb3BhZ2F0ZTogZnVuY3Rpb24oIG4sIGV2ZW50ICkgewoJCSQudWkucGx1Z2luLmNhbGwoIHRoaXMsIG4sIFsgZXZlbnQsIHRoaXMudWkoKSBdICk7CgkJKCBuICE9PSAicmVzaXplIiAmJiB0aGlzLl90cmlnZ2VyKCBuLCBldmVudCwgdGhpcy51aSgpICkgKTsKCX0sCgoJcGx1Z2luczoge30sCgoJdWk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCW9yaWdpbmFsRWxlbWVudDogdGhpcy5vcmlnaW5hbEVsZW1lbnQsCgkJCWVsZW1lbnQ6IHRoaXMuZWxlbWVudCwKCQkJaGVscGVyOiB0aGlzLmhlbHBlciwKCQkJcG9zaXRpb246IHRoaXMucG9zaXRpb24sCgkJCXNpemU6IHRoaXMuc2l6ZSwKCQkJb3JpZ2luYWxTaXplOiB0aGlzLm9yaWdpbmFsU2l6ZSwKCQkJb3JpZ2luYWxQb3NpdGlvbjogdGhpcy5vcmlnaW5hbFBvc2l0aW9uCgkJfTsKCX0KCn0gKTsKCi8qCiAqIFJlc2l6YWJsZSBFeHRlbnNpb25zCiAqLwoKJC51aS5wbHVnaW4uYWRkKCAicmVzaXphYmxlIiwgImFuaW1hdGUiLCB7CgoJc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciB0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLAoJCQlvID0gdGhhdC5vcHRpb25zLAoJCQlwciA9IHRoYXQuX3Byb3BvcnRpb25hbGx5UmVzaXplRWxlbWVudHMsCgkJCWlzdGEgPSBwci5sZW5ndGggJiYgKCAvdGV4dGFyZWEvaSApLnRlc3QoIHByWyAwIF0ubm9kZU5hbWUgKSwKCQkJc29mZnNldGggPSBpc3RhICYmIHRoYXQuX2hhc1Njcm9sbCggcHJbIDAgXSwgImxlZnQiICkgPyAwIDogdGhhdC5zaXplRGlmZi5oZWlnaHQsCgkJCXNvZmZzZXR3ID0gaXN0YSA\/IDAgOiB0aGF0LnNpemVEaWZmLndpZHRoLAoJCQlzdHlsZSA9IHsKCQkJCXdpZHRoOiAoIHRoYXQuc2l6ZS53aWR0aCAtIHNvZmZzZXR3ICksCgkJCQloZWlnaHQ6ICggdGhhdC5zaXplLmhlaWdodCAtIHNvZmZzZXRoICkKCQkJfSwKCQkJbGVmdCA9ICggcGFyc2VGbG9hdCggdGhhdC5lbGVtZW50LmNzcyggImxlZnQiICkgKSArCgkJCQkoIHRoYXQucG9zaXRpb24ubGVmdCAtIHRoYXQub3JpZ2luYWxQb3NpdGlvbi5sZWZ0ICkgKSB8fCBudWxsLAoJCQl0b3AgPSAoIHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJ0b3AiICkgKSArCgkJCQkoIHRoYXQucG9zaXRpb24udG9wIC0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLnRvcCApICkgfHwgbnVsbDsKCgkJdGhhdC5lbGVtZW50LmFuaW1hdGUoCgkJCSQuZXh0ZW5kKCBzdHlsZSwgdG9wICYmIGxlZnQgPyB7IHRvcDogdG9wLCBsZWZ0OiBsZWZ0IH0gOiB7fSApLCB7CgkJCQlkdXJhdGlvbjogby5hbmltYXRlRHVyYXRpb24sCgkJCQllYXNpbmc6IG8uYW5pbWF0ZUVhc2luZywKCQkJCXN0ZXA6IGZ1bmN0aW9uKCkgewoKCQkJCQl2YXIgZGF0YSA9IHsKCQkJCQkJd2lkdGg6IHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJ3aWR0aCIgKSApLAoJCQkJCQloZWlnaHQ6IHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJoZWlnaHQiICkgKSwKCQkJCQkJdG9wOiBwYXJzZUZsb2F0KCB0aGF0LmVsZW1lbnQuY3NzKCAidG9wIiApICksCgkJCQkJCWxlZnQ6IHBhcnNlRmxvYXQoIHRoYXQuZWxlbWVudC5jc3MoICJsZWZ0IiApICkKCQkJCQl9OwoKCQkJCQlpZiAoIHByICYmIHByLmxlbmd0aCApIHsKCQkJCQkJJCggcHJbIDAgXSApLmNzcyggeyB3aWR0aDogZGF0YS53aWR0aCwgaGVpZ2h0OiBkYXRhLmhlaWdodCB9ICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9wYWdhdGluZyByZXNpemUsIGFuZCB1cGRhdGluZyB2YWx1ZXMgZm9yIGVhY2ggYW5pbWF0aW9uIHN0ZXAKCQkJCQl0aGF0Ll91cGRhdGVDYWNoZSggZGF0YSApOwoJCQkJCXRoYXQuX3Byb3BhZ2F0ZSggInJlc2l6ZSIsIGV2ZW50ICk7CgoJCQkJfQoJCQl9CgkJKTsKCX0KCn0gKTsKCiQudWkucGx1Z2luLmFkZCggInJlc2l6YWJsZSIsICJjb250YWlubWVudCIsIHsKCglzdGFydDogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQsIHAsIGNvLCBjaCwgY3csIHdpZHRoLCBoZWlnaHQsCgkJCXRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksCgkJCW8gPSB0aGF0Lm9wdGlvbnMsCgkJCWVsID0gdGhhdC5lbGVtZW50LAoJCQlvYyA9IG8uY29udGFpbm1lbnQsCgkJCWNlID0gKCBvYyBpbnN0YW5jZW9mICQgKSA\/CgkJCQlvYy5nZXQoIDAgKSA6CgkJCQkoIC9wYXJlbnQvLnRlc3QoIG9jICkgKSA\/IGVsLnBhcmVudCgpLmdldCggMCApIDogb2M7CgoJCWlmICggIWNlICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGF0LmNvbnRhaW5lckVsZW1lbnQgPSAkKCBjZSApOwoKCQlpZiAoIC9kb2N1bWVudC8udGVzdCggb2MgKSB8fCBvYyA9PT0gZG9jdW1lbnQgKSB7CgkJCXRoYXQuY29udGFpbmVyT2Zmc2V0ID0gewoJCQkJbGVmdDogMCwKCQkJCXRvcDogMAoJCQl9OwoJCQl0aGF0LmNvbnRhaW5lclBvc2l0aW9uID0gewoJCQkJbGVmdDogMCwKCQkJCXRvcDogMAoJCQl9OwoKCQkJdGhhdC5wYXJlbnREYXRhID0gewoJCQkJZWxlbWVudDogJCggZG9jdW1lbnQgKSwKCQkJCWxlZnQ6IDAsCgkJCQl0b3A6IDAsCgkJCQl3aWR0aDogJCggZG9jdW1lbnQgKS53aWR0aCgpLAoJCQkJaGVpZ2h0OiAkKCBkb2N1bWVudCApLmhlaWdodCgpIHx8IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5zY3JvbGxIZWlnaHQKCQkJfTsKCQl9IGVsc2UgewoJCQllbGVtZW50ID0gJCggY2UgKTsKCQkJcCA9IFtdOwoJCQkkKCBbICJUb3AiLCAiUmlnaHQiLCAiTGVmdCIsICJCb3R0b20iIF0gKS5lYWNoKCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCQkJCXBbIGkgXSA9IHRoYXQuX251bSggZWxlbWVudC5jc3MoICJwYWRkaW5nIiArIG5hbWUgKSApOwoJCQl9ICk7CgoJCQl0aGF0LmNvbnRhaW5lck9mZnNldCA9IGVsZW1lbnQub2Zmc2V0KCk7CgkJCXRoYXQuY29udGFpbmVyUG9zaXRpb24gPSBlbGVtZW50LnBvc2l0aW9uKCk7CgkJCXRoYXQuY29udGFpbmVyU2l6ZSA9IHsKCQkJCWhlaWdodDogKCBlbGVtZW50LmlubmVySGVpZ2h0KCkgLSBwWyAzIF0gKSwKCQkJCXdpZHRoOiAoIGVsZW1lbnQuaW5uZXJXaWR0aCgpIC0gcFsgMSBdICkKCQkJfTsKCgkJCWNvID0gdGhhdC5jb250YWluZXJPZmZzZXQ7CgkJCWNoID0gdGhhdC5jb250YWluZXJTaXplLmhlaWdodDsKCQkJY3cgPSB0aGF0LmNvbnRhaW5lclNpemUud2lkdGg7CgkJCXdpZHRoID0gKCB0aGF0Ll9oYXNTY3JvbGwgKCBjZSwgImxlZnQiICkgPyBjZS5zY3JvbGxXaWR0aCA6IGN3ICk7CgkJCWhlaWdodCA9ICggdGhhdC5faGFzU2Nyb2xsICggY2UgKSA\/IGNlLnNjcm9sbEhlaWdodCA6IGNoICkgOwoKCQkJdGhhdC5wYXJlbnREYXRhID0gewoJCQkJZWxlbWVudDogY2UsCgkJCQlsZWZ0OiBjby5sZWZ0LAoJCQkJdG9wOiBjby50b3AsCgkJCQl3aWR0aDogd2lkdGgsCgkJCQloZWlnaHQ6IGhlaWdodAoJCQl9OwoJCX0KCX0sCgoJcmVzaXplOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHdvc2V0LCBob3NldCwgaXNQYXJlbnQsIGlzT2Zmc2V0UmVsYXRpdmUsCgkJCXRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICksCgkJCW8gPSB0aGF0Lm9wdGlvbnMsCgkJCWNvID0gdGhhdC5jb250YWluZXJPZmZzZXQsCgkJCWNwID0gdGhhdC5wb3NpdGlvbiwKCQkJcFJhdGlvID0gdGhhdC5fYXNwZWN0UmF0aW8gfHwgZXZlbnQuc2hpZnRLZXksCgkJCWNvcCA9IHsKCQkJCXRvcDogMCwKCQkJCWxlZnQ6IDAKCQkJfSwKCQkJY2UgPSB0aGF0LmNvbnRhaW5lckVsZW1lbnQsCgkJCWNvbnRpbnVlUmVzaXplID0gdHJ1ZTsKCgkJaWYgKCBjZVsgMCBdICE9PSBkb2N1bWVudCAmJiAoIC9zdGF0aWMvICkudGVzdCggY2UuY3NzKCAicG9zaXRpb24iICkgKSApIHsKCQkJY29wID0gY287CgkJfQoKCQlpZiAoIGNwLmxlZnQgPCAoIHRoYXQuX2hlbHBlciA\/IGNvLmxlZnQgOiAwICkgKSB7CgkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQuc2l6ZS53aWR0aCArCgkJCQkoIHRoYXQuX2hlbHBlciA\/CgkJCQkJKCB0aGF0LnBvc2l0aW9uLmxlZnQgLSBjby5sZWZ0ICkgOgoJCQkJCSggdGhhdC5wb3NpdGlvbi5sZWZ0IC0gY29wLmxlZnQgKSApOwoKCQkJaWYgKCBwUmF0aW8gKSB7CgkJCQl0aGF0LnNpemUuaGVpZ2h0ID0gdGhhdC5zaXplLndpZHRoIC8gdGhhdC5hc3BlY3RSYXRpbzsKCQkJCWNvbnRpbnVlUmVzaXplID0gZmFsc2U7CgkJCX0KCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gby5oZWxwZXIgPyBjby5sZWZ0IDogMDsKCQl9CgoJCWlmICggY3AudG9wIDwgKCB0aGF0Ll9oZWxwZXIgPyBjby50b3AgOiAwICkgKSB7CgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSB0aGF0LnNpemUuaGVpZ2h0ICsKCQkJCSggdGhhdC5faGVscGVyID8KCQkJCQkoIHRoYXQucG9zaXRpb24udG9wIC0gY28udG9wICkgOgoJCQkJCXRoYXQucG9zaXRpb24udG9wICk7CgoJCQlpZiAoIHBSYXRpbyApIHsKCQkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQuc2l6ZS5oZWlnaHQgKiB0aGF0LmFzcGVjdFJhdGlvOwoJCQkJY29udGludWVSZXNpemUgPSBmYWxzZTsKCQkJfQoJCQl0aGF0LnBvc2l0aW9uLnRvcCA9IHRoYXQuX2hlbHBlciA\/IGNvLnRvcCA6IDA7CgkJfQoKCQlpc1BhcmVudCA9IHRoYXQuY29udGFpbmVyRWxlbWVudC5nZXQoIDAgKSA9PT0gdGhhdC5lbGVtZW50LnBhcmVudCgpLmdldCggMCApOwoJCWlzT2Zmc2V0UmVsYXRpdmUgPSAvcmVsYXRpdmV8YWJzb2x1dGUvLnRlc3QoIHRoYXQuY29udGFpbmVyRWxlbWVudC5jc3MoICJwb3NpdGlvbiIgKSApOwoKCQlpZiAoIGlzUGFyZW50ICYmIGlzT2Zmc2V0UmVsYXRpdmUgKSB7CgkJCXRoYXQub2Zmc2V0LmxlZnQgPSB0aGF0LnBhcmVudERhdGEubGVmdCArIHRoYXQucG9zaXRpb24ubGVmdDsKCQkJdGhhdC5vZmZzZXQudG9wID0gdGhhdC5wYXJlbnREYXRhLnRvcCArIHRoYXQucG9zaXRpb24udG9wOwoJCX0gZWxzZSB7CgkJCXRoYXQub2Zmc2V0LmxlZnQgPSB0aGF0LmVsZW1lbnQub2Zmc2V0KCkubGVmdDsKCQkJdGhhdC5vZmZzZXQudG9wID0gdGhhdC5lbGVtZW50Lm9mZnNldCgpLnRvcDsKCQl9CgoJCXdvc2V0ID0gTWF0aC5hYnMoIHRoYXQuc2l6ZURpZmYud2lkdGggKwoJCQkoIHRoYXQuX2hlbHBlciA\/CgkJCQl0aGF0Lm9mZnNldC5sZWZ0IC0gY29wLmxlZnQgOgoJCQkJKCB0aGF0Lm9mZnNldC5sZWZ0IC0gY28ubGVmdCApICkgKTsKCgkJaG9zZXQgPSBNYXRoLmFicyggdGhhdC5zaXplRGlmZi5oZWlnaHQgKwoJCQkoIHRoYXQuX2hlbHBlciA\/CgkJCQl0aGF0Lm9mZnNldC50b3AgLSBjb3AudG9wIDoKCQkJCSggdGhhdC5vZmZzZXQudG9wIC0gY28udG9wICkgKSApOwoKCQlpZiAoIHdvc2V0ICsgdGhhdC5zaXplLndpZHRoID49IHRoYXQucGFyZW50RGF0YS53aWR0aCApIHsKCQkJdGhhdC5zaXplLndpZHRoID0gdGhhdC5wYXJlbnREYXRhLndpZHRoIC0gd29zZXQ7CgkJCWlmICggcFJhdGlvICkgewoJCQkJdGhhdC5zaXplLmhlaWdodCA9IHRoYXQuc2l6ZS53aWR0aCAvIHRoYXQuYXNwZWN0UmF0aW87CgkJCQljb250aW51ZVJlc2l6ZSA9IGZhbHNlOwoJCQl9CgkJfQoKCQlpZiAoIGhvc2V0ICsgdGhhdC5zaXplLmhlaWdodCA+PSB0aGF0LnBhcmVudERhdGEuaGVpZ2h0ICkgewoJCQl0aGF0LnNpemUuaGVpZ2h0ID0gdGhhdC5wYXJlbnREYXRhLmhlaWdodCAtIGhvc2V0OwoJCQlpZiAoIHBSYXRpbyApIHsKCQkJCXRoYXQuc2l6ZS53aWR0aCA9IHRoYXQuc2l6ZS5oZWlnaHQgKiB0aGF0LmFzcGVjdFJhdGlvOwoJCQkJY29udGludWVSZXNpemUgPSBmYWxzZTsKCQkJfQoJCX0KCgkJaWYgKCAhY29udGludWVSZXNpemUgKSB7CgkJCXRoYXQucG9zaXRpb24ubGVmdCA9IHRoYXQucHJldlBvc2l0aW9uLmxlZnQ7CgkJCXRoYXQucG9zaXRpb24udG9wID0gdGhhdC5wcmV2UG9zaXRpb24udG9wOwoJCQl0aGF0LnNpemUud2lkdGggPSB0aGF0LnByZXZTaXplLndpZHRoOwoJCQl0aGF0LnNpemUuaGVpZ2h0ID0gdGhhdC5wcmV2U2l6ZS5oZWlnaHQ7CgkJfQoJfSwKCglzdG9wOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKSwKCQkJbyA9IHRoYXQub3B0aW9ucywKCQkJY28gPSB0aGF0LmNvbnRhaW5lck9mZnNldCwKCQkJY29wID0gdGhhdC5jb250YWluZXJQb3NpdGlvbiwKCQkJY2UgPSB0aGF0LmNvbnRhaW5lckVsZW1lbnQsCgkJCWhlbHBlciA9ICQoIHRoYXQuaGVscGVyICksCgkJCWhvID0gaGVscGVyLm9mZnNldCgpLAoJCQl3ID0gaGVscGVyLm91dGVyV2lkdGgoKSAtIHRoYXQuc2l6ZURpZmYud2lkdGgsCgkJCWggPSBoZWxwZXIub3V0ZXJIZWlnaHQoKSAtIHRoYXQuc2l6ZURpZmYuaGVpZ2h0OwoKCQlpZiAoIHRoYXQuX2hlbHBlciAmJiAhby5hbmltYXRlICYmICggL3JlbGF0aXZlLyApLnRlc3QoIGNlLmNzcyggInBvc2l0aW9uIiApICkgKSB7CgkJCSQoIHRoaXMgKS5jc3MoIHsKCQkJCWxlZnQ6IGhvLmxlZnQgLSBjb3AubGVmdCAtIGNvLmxlZnQsCgkJCQl3aWR0aDogdywKCQkJCWhlaWdodDogaAoJCQl9ICk7CgkJfQoKCQlpZiAoIHRoYXQuX2hlbHBlciAmJiAhby5hbmltYXRlICYmICggL3N0YXRpYy8gKS50ZXN0KCBjZS5jc3MoICJwb3NpdGlvbiIgKSApICkgewoJCQkkKCB0aGlzICkuY3NzKCB7CgkJCQlsZWZ0OiBoby5sZWZ0IC0gY29wLmxlZnQgLSBjby5sZWZ0LAoJCQkJd2lkdGg6IHcsCgkJCQloZWlnaHQ6IGgKCQkJfSApOwoJCX0KCX0KfSApOwoKJC51aS5wbHVnaW4uYWRkKCAicmVzaXphYmxlIiwgImFsc29SZXNpemUiLCB7CgoJc3RhcnQ6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLAoJCQlvID0gdGhhdC5vcHRpb25zOwoKCQkkKCBvLmFsc29SZXNpemUgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGVsID0gJCggdGhpcyApOwoJCQllbC5kYXRhKCAidWktcmVzaXphYmxlLWFsc29yZXNpemUiLCB7CgkJCQl3aWR0aDogcGFyc2VGbG9hdCggZWwud2lkdGgoKSApLCBoZWlnaHQ6IHBhcnNlRmxvYXQoIGVsLmhlaWdodCgpICksCgkJCQlsZWZ0OiBwYXJzZUZsb2F0KCBlbC5jc3MoICJsZWZ0IiApICksIHRvcDogcGFyc2VGbG9hdCggZWwuY3NzKCAidG9wIiApICkKCQkJfSApOwoJCX0gKTsKCX0sCgoJcmVzaXplOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCXZhciB0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLAoJCQlvID0gdGhhdC5vcHRpb25zLAoJCQlvcyA9IHRoYXQub3JpZ2luYWxTaXplLAoJCQlvcCA9IHRoYXQub3JpZ2luYWxQb3NpdGlvbiwKCQkJZGVsdGEgPSB7CgkJCQloZWlnaHQ6ICggdGhhdC5zaXplLmhlaWdodCAtIG9zLmhlaWdodCApIHx8IDAsCgkJCQl3aWR0aDogKCB0aGF0LnNpemUud2lkdGggLSBvcy53aWR0aCApIHx8IDAsCgkJCQl0b3A6ICggdGhhdC5wb3NpdGlvbi50b3AgLSBvcC50b3AgKSB8fCAwLAoJCQkJbGVmdDogKCB0aGF0LnBvc2l0aW9uLmxlZnQgLSBvcC5sZWZ0ICkgfHwgMAoJCQl9OwoKCQkJJCggby5hbHNvUmVzaXplICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWwgPSAkKCB0aGlzICksIHN0YXJ0ID0gJCggdGhpcyApLmRhdGEoICJ1aS1yZXNpemFibGUtYWxzb3Jlc2l6ZSIgKSwgc3R5bGUgPSB7fSwKCQkJCQljc3MgPSBlbC5wYXJlbnRzKCB1aS5vcmlnaW5hbEVsZW1lbnRbIDAgXSApLmxlbmd0aCA\/CgkJCQkJCQlbICJ3aWR0aCIsICJoZWlnaHQiIF0gOgoJCQkJCQkJWyAid2lkdGgiLCAiaGVpZ2h0IiwgInRvcCIsICJsZWZ0IiBdOwoKCQkJCSQuZWFjaCggY3NzLCBmdW5jdGlvbiggaSwgcHJvcCApIHsKCQkJCQl2YXIgc3VtID0gKCBzdGFydFsgcHJvcCBdIHx8IDAgKSArICggZGVsdGFbIHByb3AgXSB8fCAwICk7CgkJCQkJaWYgKCBzdW0gJiYgc3VtID49IDAgKSB7CgkJCQkJCXN0eWxlWyBwcm9wIF0gPSBzdW0gfHwgbnVsbDsKCQkJCQl9CgkJCQl9ICk7CgoJCQkJZWwuY3NzKCBzdHlsZSApOwoJCQl9ICk7Cgl9LAoKCXN0b3A6IGZ1bmN0aW9uKCkgewoJCSQoIHRoaXMgKS5yZW1vdmVEYXRhKCAidWktcmVzaXphYmxlLWFsc29yZXNpemUiICk7Cgl9Cn0gKTsKCiQudWkucGx1Z2luLmFkZCggInJlc2l6YWJsZSIsICJnaG9zdCIsIHsKCglzdGFydDogZnVuY3Rpb24oKSB7CgoJCXZhciB0aGF0ID0gJCggdGhpcyApLnJlc2l6YWJsZSggImluc3RhbmNlIiApLCBjcyA9IHRoYXQuc2l6ZTsKCgkJdGhhdC5naG9zdCA9IHRoYXQub3JpZ2luYWxFbGVtZW50LmNsb25lKCk7CgkJdGhhdC5naG9zdC5jc3MoIHsKCQkJb3BhY2l0eTogMC4yNSwKCQkJZGlzcGxheTogImJsb2NrIiwKCQkJcG9zaXRpb246ICJyZWxhdGl2ZSIsCgkJCWhlaWdodDogY3MuaGVpZ2h0LAoJCQl3aWR0aDogY3Mud2lkdGgsCgkJCW1hcmdpbjogMCwKCQkJbGVmdDogMCwKCQkJdG9wOiAwCgkJfSApOwoKCQl0aGF0Ll9hZGRDbGFzcyggdGhhdC5naG9zdCwgInVpLXJlc2l6YWJsZS1naG9zdCIgKTsKCgkJLy8gREVQUkVDQVRFRAoJCS8vIFRPRE86IHJlbW92ZSBhZnRlciAxLjEyCgkJaWYgKCAkLnVpQmFja0NvbXBhdCAhPT0gZmFsc2UgJiYgdHlwZW9mIHRoYXQub3B0aW9ucy5naG9zdCA9PT0gInN0cmluZyIgKSB7CgoJCQkvLyBHaG9zdCBvcHRpb24KCQkJdGhhdC5naG9zdC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmdob3N0ICk7CgkJfQoKCQl0aGF0Lmdob3N0LmFwcGVuZFRvKCB0aGF0LmhlbHBlciApOwoKCX0sCgoJcmVzaXplOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKTsKCQlpZiAoIHRoYXQuZ2hvc3QgKSB7CgkJCXRoYXQuZ2hvc3QuY3NzKCB7CgkJCQlwb3NpdGlvbjogInJlbGF0aXZlIiwKCQkJCWhlaWdodDogdGhhdC5zaXplLmhlaWdodCwKCQkJCXdpZHRoOiB0aGF0LnNpemUud2lkdGgKCQkJfSApOwoJCX0KCX0sCgoJc3RvcDogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSAkKCB0aGlzICkucmVzaXphYmxlKCAiaW5zdGFuY2UiICk7CgkJaWYgKCB0aGF0Lmdob3N0ICYmIHRoYXQuaGVscGVyICkgewoJCQl0aGF0LmhlbHBlci5nZXQoIDAgKS5yZW1vdmVDaGlsZCggdGhhdC5naG9zdC5nZXQoIDAgKSApOwoJCX0KCX0KCn0gKTsKCiQudWkucGx1Z2luLmFkZCggInJlc2l6YWJsZSIsICJncmlkIiwgewoKCXJlc2l6ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG91dGVyRGltZW5zaW9ucywKCQkJdGhhdCA9ICQoIHRoaXMgKS5yZXNpemFibGUoICJpbnN0YW5jZSIgKSwKCQkJbyA9IHRoYXQub3B0aW9ucywKCQkJY3MgPSB0aGF0LnNpemUsCgkJCW9zID0gdGhhdC5vcmlnaW5hbFNpemUsCgkJCW9wID0gdGhhdC5vcmlnaW5hbFBvc2l0aW9uLAoJCQlhID0gdGhhdC5heGlzLAoJCQlncmlkID0gdHlwZW9mIG8uZ3JpZCA9PT0gIm51bWJlciIgPyBbIG8uZ3JpZCwgby5ncmlkIF0gOiBvLmdyaWQsCgkJCWdyaWRYID0gKCBncmlkWyAwIF0gfHwgMSApLAoJCQlncmlkWSA9ICggZ3JpZFsgMSBdIHx8IDEgKSwKCQkJb3ggPSBNYXRoLnJvdW5kKCAoIGNzLndpZHRoIC0gb3Mud2lkdGggKSAvIGdyaWRYICkgKiBncmlkWCwKCQkJb3kgPSBNYXRoLnJvdW5kKCAoIGNzLmhlaWdodCAtIG9zLmhlaWdodCApIC8gZ3JpZFkgKSAqIGdyaWRZLAoJCQluZXdXaWR0aCA9IG9zLndpZHRoICsgb3gsCgkJCW5ld0hlaWdodCA9IG9zLmhlaWdodCArIG95LAoJCQlpc01heFdpZHRoID0gby5tYXhXaWR0aCAmJiAoIG8ubWF4V2lkdGggPCBuZXdXaWR0aCApLAoJCQlpc01heEhlaWdodCA9IG8ubWF4SGVpZ2h0ICYmICggby5tYXhIZWlnaHQgPCBuZXdIZWlnaHQgKSwKCQkJaXNNaW5XaWR0aCA9IG8ubWluV2lkdGggJiYgKCBvLm1pbldpZHRoID4gbmV3V2lkdGggKSwKCQkJaXNNaW5IZWlnaHQgPSBvLm1pbkhlaWdodCAmJiAoIG8ubWluSGVpZ2h0ID4gbmV3SGVpZ2h0ICk7CgoJCW8uZ3JpZCA9IGdyaWQ7CgoJCWlmICggaXNNaW5XaWR0aCApIHsKCQkJbmV3V2lkdGggKz0gZ3JpZFg7CgkJfQoJCWlmICggaXNNaW5IZWlnaHQgKSB7CgkJCW5ld0hlaWdodCArPSBncmlkWTsKCQl9CgkJaWYgKCBpc01heFdpZHRoICkgewoJCQluZXdXaWR0aCAtPSBncmlkWDsKCQl9CgkJaWYgKCBpc01heEhlaWdodCApIHsKCQkJbmV3SGVpZ2h0IC09IGdyaWRZOwoJCX0KCgkJaWYgKCAvXihzZXxzfGUpJC8udGVzdCggYSApICkgewoJCQl0aGF0LnNpemUud2lkdGggPSBuZXdXaWR0aDsKCQkJdGhhdC5zaXplLmhlaWdodCA9IG5ld0hlaWdodDsKCQl9IGVsc2UgaWYgKCAvXihuZSkkLy50ZXN0KCBhICkgKSB7CgkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOwoJCQl0aGF0LnNpemUuaGVpZ2h0ID0gbmV3SGVpZ2h0OwoJCQl0aGF0LnBvc2l0aW9uLnRvcCA9IG9wLnRvcCAtIG95OwoJCX0gZWxzZSBpZiAoIC9eKHN3KSQvLnRlc3QoIGEgKSApIHsKCQkJdGhhdC5zaXplLndpZHRoID0gbmV3V2lkdGg7CgkJCXRoYXQuc2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7CgkJCXRoYXQucG9zaXRpb24ubGVmdCA9IG9wLmxlZnQgLSBveDsKCQl9IGVsc2UgewoJCQlpZiAoIG5ld0hlaWdodCAtIGdyaWRZIDw9IDAgfHwgbmV3V2lkdGggLSBncmlkWCA8PSAwICkgewoJCQkJb3V0ZXJEaW1lbnNpb25zID0gdGhhdC5fZ2V0UGFkZGluZ1BsdXNCb3JkZXJEaW1lbnNpb25zKCB0aGlzICk7CgkJCX0KCgkJCWlmICggbmV3SGVpZ2h0IC0gZ3JpZFkgPiAwICkgewoJCQkJdGhhdC5zaXplLmhlaWdodCA9IG5ld0hlaWdodDsKCQkJCXRoYXQucG9zaXRpb24udG9wID0gb3AudG9wIC0gb3k7CgkJCX0gZWxzZSB7CgkJCQluZXdIZWlnaHQgPSBncmlkWSAtIG91dGVyRGltZW5zaW9ucy5oZWlnaHQ7CgkJCQl0aGF0LnNpemUuaGVpZ2h0ID0gbmV3SGVpZ2h0OwoJCQkJdGhhdC5wb3NpdGlvbi50b3AgPSBvcC50b3AgKyBvcy5oZWlnaHQgLSBuZXdIZWlnaHQ7CgkJCX0KCQkJaWYgKCBuZXdXaWR0aCAtIGdyaWRYID4gMCApIHsKCQkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOwoJCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gb3AubGVmdCAtIG94OwoJCQl9IGVsc2UgewoJCQkJbmV3V2lkdGggPSBncmlkWCAtIG91dGVyRGltZW5zaW9ucy53aWR0aDsKCQkJCXRoYXQuc2l6ZS53aWR0aCA9IG5ld1dpZHRoOwoJCQkJdGhhdC5wb3NpdGlvbi5sZWZ0ID0gb3AubGVmdCArIG9zLndpZHRoIC0gbmV3V2lkdGg7CgkJCX0KCQl9Cgl9Cgp9ICk7Cgp2YXIgd2lkZ2V0c1Jlc2l6YWJsZSA9ICQudWkucmVzaXphYmxlOwoKCi8qIQogKiBqUXVlcnkgVUkgRGlhbG9nIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogRGlhbG9nCi8vPj5ncm91cDogV2lkZ2V0cwovLz4+ZGVzY3JpcHRpb246IERpc3BsYXlzIGN1c3RvbWl6YWJsZSBkaWFsb2cgd2luZG93cy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2RpYWxvZy8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2RpYWxvZy8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9kaWFsb2cuY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCgokLndpZGdldCggInVpLmRpYWxvZyIsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJb3B0aW9uczogewoJCWFwcGVuZFRvOiAiYm9keSIsCgkJYXV0b09wZW46IHRydWUsCgkJYnV0dG9uczogW10sCgkJY2xhc3NlczogewoJCQkidWktZGlhbG9nIjogInVpLWNvcm5lci1hbGwiLAoJCQkidWktZGlhbG9nLXRpdGxlYmFyIjogInVpLWNvcm5lci1hbGwiCgkJfSwKCQljbG9zZU9uRXNjYXBlOiB0cnVlLAoJCWNsb3NlVGV4dDogIkNsb3NlIiwKCQlkcmFnZ2FibGU6IHRydWUsCgkJaGlkZTogbnVsbCwKCQloZWlnaHQ6ICJhdXRvIiwKCQltYXhIZWlnaHQ6IG51bGwsCgkJbWF4V2lkdGg6IG51bGwsCgkJbWluSGVpZ2h0OiAxNTAsCgkJbWluV2lkdGg6IDE1MCwKCQltb2RhbDogZmFsc2UsCgkJcG9zaXRpb246IHsKCQkJbXk6ICJjZW50ZXIiLAoJCQlhdDogImNlbnRlciIsCgkJCW9mOiB3aW5kb3csCgkJCWNvbGxpc2lvbjogImZpdCIsCgoJCQkvLyBFbnN1cmUgdGhlIHRpdGxlYmFyIGlzIGFsd2F5cyB2aXNpYmxlCgkJCXVzaW5nOiBmdW5jdGlvbiggcG9zICkgewoJCQkJdmFyIHRvcE9mZnNldCA9ICQoIHRoaXMgKS5jc3MoIHBvcyApLm9mZnNldCgpLnRvcDsKCQkJCWlmICggdG9wT2Zmc2V0IDwgMCApIHsKCQkJCQkkKCB0aGlzICkuY3NzKCAidG9wIiwgcG9zLnRvcCAtIHRvcE9mZnNldCApOwoJCQkJfQoJCQl9CgkJfSwKCQlyZXNpemFibGU6IHRydWUsCgkJc2hvdzogbnVsbCwKCQl0aXRsZTogbnVsbCwKCQl3aWR0aDogMzAwLAoKCQkvLyBDYWxsYmFja3MKCQliZWZvcmVDbG9zZTogbnVsbCwKCQljbG9zZTogbnVsbCwKCQlkcmFnOiBudWxsLAoJCWRyYWdTdGFydDogbnVsbCwKCQlkcmFnU3RvcDogbnVsbCwKCQlmb2N1czogbnVsbCwKCQlvcGVuOiBudWxsLAoJCXJlc2l6ZTogbnVsbCwKCQlyZXNpemVTdGFydDogbnVsbCwKCQlyZXNpemVTdG9wOiBudWxsCgl9LAoKCXNpemVSZWxhdGVkT3B0aW9uczogewoJCWJ1dHRvbnM6IHRydWUsCgkJaGVpZ2h0OiB0cnVlLAoJCW1heEhlaWdodDogdHJ1ZSwKCQltYXhXaWR0aDogdHJ1ZSwKCQltaW5IZWlnaHQ6IHRydWUsCgkJbWluV2lkdGg6IHRydWUsCgkJd2lkdGg6IHRydWUKCX0sCgoJcmVzaXphYmxlUmVsYXRlZE9wdGlvbnM6IHsKCQltYXhIZWlnaHQ6IHRydWUsCgkJbWF4V2lkdGg6IHRydWUsCgkJbWluSGVpZ2h0OiB0cnVlLAoJCW1pbldpZHRoOiB0cnVlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMub3JpZ2luYWxDc3MgPSB7CgkJCWRpc3BsYXk6IHRoaXMuZWxlbWVudFsgMCBdLnN0eWxlLmRpc3BsYXksCgkJCXdpZHRoOiB0aGlzLmVsZW1lbnRbIDAgXS5zdHlsZS53aWR0aCwKCQkJbWluSGVpZ2h0OiB0aGlzLmVsZW1lbnRbIDAgXS5zdHlsZS5taW5IZWlnaHQsCgkJCW1heEhlaWdodDogdGhpcy5lbGVtZW50WyAwIF0uc3R5bGUubWF4SGVpZ2h0LAoJCQloZWlnaHQ6IHRoaXMuZWxlbWVudFsgMCBdLnN0eWxlLmhlaWdodAoJCX07CgkJdGhpcy5vcmlnaW5hbFBvc2l0aW9uID0gewoJCQlwYXJlbnQ6IHRoaXMuZWxlbWVudC5wYXJlbnQoKSwKCQkJaW5kZXg6IHRoaXMuZWxlbWVudC5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4KCB0aGlzLmVsZW1lbnQgKQoJCX07CgkJdGhpcy5vcmlnaW5hbFRpdGxlID0gdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy50aXRsZSA9PSBudWxsICYmIHRoaXMub3JpZ2luYWxUaXRsZSAhPSBudWxsICkgewoJCQl0aGlzLm9wdGlvbnMudGl0bGUgPSB0aGlzLm9yaWdpbmFsVGl0bGU7CgkJfQoKCQkvLyBEaWFsb2dzIGNhbid0IGJlIGRpc2FibGVkCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGZhbHNlOwoJCX0KCgkJdGhpcy5fY3JlYXRlV3JhcHBlcigpOwoKCQl0aGlzLmVsZW1lbnQKCQkJLnNob3coKQoJCQkucmVtb3ZlQXR0ciggInRpdGxlIiApCgkJCS5hcHBlbmRUbyggdGhpcy51aURpYWxvZyApOwoKCQl0aGlzLl9hZGRDbGFzcyggInVpLWRpYWxvZy1jb250ZW50IiwgInVpLXdpZGdldC1jb250ZW50IiApOwoKCQl0aGlzLl9jcmVhdGVUaXRsZWJhcigpOwoJCXRoaXMuX2NyZWF0ZUJ1dHRvblBhbmUoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZHJhZ2dhYmxlICYmICQuZm4uZHJhZ2dhYmxlICkgewoJCQl0aGlzLl9tYWtlRHJhZ2dhYmxlKCk7CgkJfQoJCWlmICggdGhpcy5vcHRpb25zLnJlc2l6YWJsZSAmJiAkLmZuLnJlc2l6YWJsZSApIHsKCQkJdGhpcy5fbWFrZVJlc2l6YWJsZSgpOwoJCX0KCgkJdGhpcy5faXNPcGVuID0gZmFsc2U7CgoJCXRoaXMuX3RyYWNrRm9jdXMoKTsKCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmF1dG9PcGVuICkgewoJCQl0aGlzLm9wZW4oKTsKCQl9Cgl9LAoKCV9hcHBlbmRUbzogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLm9wdGlvbnMuYXBwZW5kVG87CgkJaWYgKCBlbGVtZW50ICYmICggZWxlbWVudC5qcXVlcnkgfHwgZWxlbWVudC5ub2RlVHlwZSApICkgewoJCQlyZXR1cm4gJCggZWxlbWVudCApOwoJCX0KCQlyZXR1cm4gdGhpcy5kb2N1bWVudC5maW5kKCBlbGVtZW50IHx8ICJib2R5IiApLmVxKCAwICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgbmV4dCwKCQkJb3JpZ2luYWxQb3NpdGlvbiA9IHRoaXMub3JpZ2luYWxQb3NpdGlvbjsKCgkJdGhpcy5fdW50cmFja0luc3RhbmNlKCk7CgkJdGhpcy5fZGVzdHJveU92ZXJsYXkoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVVbmlxdWVJZCgpCgkJCS5jc3MoIHRoaXMub3JpZ2luYWxDc3MgKQoKCQkJLy8gV2l0aG91dCBkZXRhY2hpbmcgZmlyc3QsIHRoZSBmb2xsb3dpbmcgYmVjb21lcyByZWFsbHkgc2xvdwoJCQkuZGV0YWNoKCk7CgoJCXRoaXMudWlEaWFsb2cucmVtb3ZlKCk7CgoJCWlmICggdGhpcy5vcmlnaW5hbFRpdGxlICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5vcmlnaW5hbFRpdGxlICk7CgkJfQoKCQluZXh0ID0gb3JpZ2luYWxQb3NpdGlvbi5wYXJlbnQuY2hpbGRyZW4oKS5lcSggb3JpZ2luYWxQb3NpdGlvbi5pbmRleCApOwoKCQkvLyBEb24ndCB0cnkgdG8gcGxhY2UgdGhlIGRpYWxvZyBuZXh0IHRvIGl0c2VsZiAoIzg2MTMpCgkJaWYgKCBuZXh0Lmxlbmd0aCAmJiBuZXh0WyAwIF0gIT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQluZXh0LmJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJfSBlbHNlIHsKCQkJb3JpZ2luYWxQb3NpdGlvbi5wYXJlbnQuYXBwZW5kKCB0aGlzLmVsZW1lbnQgKTsKCQl9Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudWlEaWFsb2c7Cgl9LAoKCWRpc2FibGU6ICQubm9vcCwKCWVuYWJsZTogJC5ub29wLAoKCWNsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQlpZiAoICF0aGlzLl9pc09wZW4gfHwgdGhpcy5fdHJpZ2dlciggImJlZm9yZUNsb3NlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX2lzT3BlbiA9IGZhbHNlOwoJCXRoaXMuX2ZvY3VzZWRFbGVtZW50ID0gbnVsbDsKCQl0aGlzLl9kZXN0cm95T3ZlcmxheSgpOwoJCXRoaXMuX3VudHJhY2tJbnN0YW5jZSgpOwoKCQlpZiAoICF0aGlzLm9wZW5lci5maWx0ZXIoICI6Zm9jdXNhYmxlIiApLnRyaWdnZXIoICJmb2N1cyIgKS5sZW5ndGggKSB7CgoJCQkvLyBIaWRpbmcgYSBmb2N1c2VkIGVsZW1lbnQgZG9lc24ndCB0cmlnZ2VyIGJsdXIgaW4gV2ViS2l0CgkJCS8vIHNvIGluIGNhc2Ugd2UgaGF2ZSBub3RoaW5nIHRvIGZvY3VzIG9uLCBleHBsaWNpdGx5IGJsdXIgdGhlIGFjdGl2ZSBlbGVtZW50CgkJCS8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD00NzE4MgoJCQkkLnVpLnNhZmVCbHVyKCAkLnVpLnNhZmVBY3RpdmVFbGVtZW50KCB0aGlzLmRvY3VtZW50WyAwIF0gKSApOwoJCX0KCgkJdGhpcy5faGlkZSggdGhpcy51aURpYWxvZywgdGhpcy5vcHRpb25zLmhpZGUsIGZ1bmN0aW9uKCkgewoJCQl0aGF0Ll90cmlnZ2VyKCAiY2xvc2UiLCBldmVudCApOwoJCX0gKTsKCX0sCgoJaXNPcGVuOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5faXNPcGVuOwoJfSwKCgltb3ZlVG9Ub3A6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX21vdmVUb1RvcCgpOwoJfSwKCglfbW92ZVRvVG9wOiBmdW5jdGlvbiggZXZlbnQsIHNpbGVudCApIHsKCQl2YXIgbW92ZWQgPSBmYWxzZSwKCQkJekluZGljZXMgPSB0aGlzLnVpRGlhbG9nLnNpYmxpbmdzKCAiLnVpLWZyb250OnZpc2libGUiICkubWFwKCBmdW5jdGlvbigpIHsKCQkJCXJldHVybiArJCggdGhpcyApLmNzcyggInotaW5kZXgiICk7CgkJCX0gKS5nZXQoKSwKCQkJekluZGV4TWF4ID0gTWF0aC5tYXguYXBwbHkoIG51bGwsIHpJbmRpY2VzICk7CgoJCWlmICggekluZGV4TWF4ID49ICt0aGlzLnVpRGlhbG9nLmNzcyggInotaW5kZXgiICkgKSB7CgkJCXRoaXMudWlEaWFsb2cuY3NzKCAiei1pbmRleCIsIHpJbmRleE1heCArIDEgKTsKCQkJbW92ZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCBtb3ZlZCAmJiAhc2lsZW50ICkgewoJCQl0aGlzLl90cmlnZ2VyKCAiZm9jdXMiLCBldmVudCApOwoJCX0KCQlyZXR1cm4gbW92ZWQ7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJaWYgKCB0aGlzLl9tb3ZlVG9Ub3AoKSApIHsKCQkJCXRoaXMuX2ZvY3VzVGFiYmFibGUoKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9pc09wZW4gPSB0cnVlOwoJCXRoaXMub3BlbmVyID0gJCggJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgKTsKCgkJdGhpcy5fc2l6ZSgpOwoJCXRoaXMuX3Bvc2l0aW9uKCk7CgkJdGhpcy5fY3JlYXRlT3ZlcmxheSgpOwoJCXRoaXMuX21vdmVUb1RvcCggbnVsbCwgdHJ1ZSApOwoKCQkvLyBFbnN1cmUgdGhlIG92ZXJsYXkgaXMgbW92ZWQgdG8gdGhlIHRvcCB3aXRoIHRoZSBkaWFsb2csIGJ1dCBvbmx5IHdoZW4KCQkvLyBvcGVuaW5nLiBUaGUgb3ZlcmxheSBzaG91bGRuJ3QgbW92ZSBhZnRlciB0aGUgZGlhbG9nIGlzIG9wZW4gc28gdGhhdAoJCS8vIG1vZGVsZXNzIGRpYWxvZ3Mgb3BlbmVkIGFmdGVyIHRoZSBtb2RhbCBkaWFsb2cgc3RhY2sgcHJvcGVybHkuCgkJaWYgKCB0aGlzLm92ZXJsYXkgKSB7CgkJCXRoaXMub3ZlcmxheS5jc3MoICJ6LWluZGV4IiwgdGhpcy51aURpYWxvZy5jc3MoICJ6LWluZGV4IiApIC0gMSApOwoJCX0KCgkJdGhpcy5fc2hvdyggdGhpcy51aURpYWxvZywgdGhpcy5vcHRpb25zLnNob3csIGZ1bmN0aW9uKCkgewoJCQl0aGF0Ll9mb2N1c1RhYmJhYmxlKCk7CgkJCXRoYXQuX3RyaWdnZXIoICJmb2N1cyIgKTsKCQl9ICk7CgoJCS8vIFRyYWNrIHRoZSBkaWFsb2cgaW1tZWRpYXRlbHkgdXBvbiBvcGVuZW5pbmcgaW4gY2FzZSBhIGZvY3VzIGV2ZW50CgkJLy8gc29tZWhvdyBvY2N1cnMgb3V0c2lkZSBvZiB0aGUgZGlhbG9nIGJlZm9yZSBhbiBlbGVtZW50IGluc2lkZSB0aGUKCQkvLyBkaWFsb2cgaXMgZm9jdXNlZCAoIzEwMTUyKQoJCXRoaXMuX21ha2VGb2N1c1RhcmdldCgpOwoKCQl0aGlzLl90cmlnZ2VyKCAib3BlbiIgKTsKCX0sCgoJX2ZvY3VzVGFiYmFibGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBTZXQgZm9jdXMgdG8gdGhlIGZpcnN0IG1hdGNoOgoJCS8vIDEuIEFuIGVsZW1lbnQgdGhhdCB3YXMgZm9jdXNlZCBwcmV2aW91c2x5CgkJLy8gMi4gRmlyc3QgZWxlbWVudCBpbnNpZGUgdGhlIGRpYWxvZyBtYXRjaGluZyBbYXV0b2ZvY3VzXQoJCS8vIDMuIFRhYmJhYmxlIGVsZW1lbnQgaW5zaWRlIHRoZSBjb250ZW50IGVsZW1lbnQKCQkvLyA0LiBUYWJiYWJsZSBlbGVtZW50IGluc2lkZSB0aGUgYnV0dG9ucGFuZQoJCS8vIDUuIFRoZSBjbG9zZSBidXR0b24KCQkvLyA2LiBUaGUgZGlhbG9nIGl0c2VsZgoJCXZhciBoYXNGb2N1cyA9IHRoaXMuX2ZvY3VzZWRFbGVtZW50OwoJCWlmICggIWhhc0ZvY3VzICkgewoJCQloYXNGb2N1cyA9IHRoaXMuZWxlbWVudC5maW5kKCAiW2F1dG9mb2N1c10iICk7CgkJfQoJCWlmICggIWhhc0ZvY3VzLmxlbmd0aCApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLmVsZW1lbnQuZmluZCggIjp0YWJiYWJsZSIgKTsKCQl9CgkJaWYgKCAhaGFzRm9jdXMubGVuZ3RoICkgewoJCQloYXNGb2N1cyA9IHRoaXMudWlEaWFsb2dCdXR0b25QYW5lLmZpbmQoICI6dGFiYmFibGUiICk7CgkJfQoJCWlmICggIWhhc0ZvY3VzLmxlbmd0aCApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZS5maWx0ZXIoICI6dGFiYmFibGUiICk7CgkJfQoJCWlmICggIWhhc0ZvY3VzLmxlbmd0aCApIHsKCQkJaGFzRm9jdXMgPSB0aGlzLnVpRGlhbG9nOwoJCX0KCQloYXNGb2N1cy5lcSggMCApLnRyaWdnZXIoICJmb2N1cyIgKTsKCX0sCgoJX2tlZXBGb2N1czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWZ1bmN0aW9uIGNoZWNrRm9jdXMoKSB7CgkJCXZhciBhY3RpdmVFbGVtZW50ID0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICksCgkJCQlpc0FjdGl2ZSA9IHRoaXMudWlEaWFsb2dbIDAgXSA9PT0gYWN0aXZlRWxlbWVudCB8fAoJCQkJCSQuY29udGFpbnMoIHRoaXMudWlEaWFsb2dbIDAgXSwgYWN0aXZlRWxlbWVudCApOwoJCQlpZiAoICFpc0FjdGl2ZSApIHsKCQkJCXRoaXMuX2ZvY3VzVGFiYmFibGUoKTsKCQkJfQoJCX0KCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCWNoZWNrRm9jdXMuY2FsbCggdGhpcyApOwoKCQkvLyBzdXBwb3J0OiBJRQoJCS8vIElFIDw9IDggZG9lc24ndCBwcmV2ZW50IG1vdmluZyBmb2N1cyBldmVuIHdpdGggZXZlbnQucHJldmVudERlZmF1bHQoKQoJCS8vIHNvIHdlIGNoZWNrIGFnYWluIGxhdGVyCgkJdGhpcy5fZGVsYXkoIGNoZWNrRm9jdXMgKTsKCX0sCgoJX2NyZWF0ZVdyYXBwZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMudWlEaWFsb2cgPSAkKCAiPGRpdj4iICkKCQkJLmhpZGUoKQoJCQkuYXR0ciggewoKCQkJCS8vIFNldHRpbmcgdGFiSW5kZXggbWFrZXMgdGhlIGRpdiBmb2N1c2FibGUKCQkJCXRhYkluZGV4OiAtMSwKCQkJCXJvbGU6ICJkaWFsb2ciCgkJCX0gKQoJCQkuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCkgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2csICJ1aS1kaWFsb2ciLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWZyb250IiApOwoJCXRoaXMuX29uKCB0aGlzLnVpRGlhbG9nLCB7CgkJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmNsb3NlT25Fc2NhcGUgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICYmIGV2ZW50LmtleUNvZGUgJiYKCQkJCQkJZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFByZXZlbnQgdGFiYmluZyBvdXQgb2YgZGlhbG9ncwoJCQkJaWYgKCBldmVudC5rZXlDb2RlICE9PSAkLnVpLmtleUNvZGUuVEFCIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXZhciB0YWJiYWJsZXMgPSB0aGlzLnVpRGlhbG9nLmZpbmQoICI6dGFiYmFibGUiICksCgkJCQkJZmlyc3QgPSB0YWJiYWJsZXMuZmlsdGVyKCAiOmZpcnN0IiApLAoJCQkJCWxhc3QgPSB0YWJiYWJsZXMuZmlsdGVyKCAiOmxhc3QiICk7CgoJCQkJaWYgKCAoIGV2ZW50LnRhcmdldCA9PT0gbGFzdFsgMCBdIHx8IGV2ZW50LnRhcmdldCA9PT0gdGhpcy51aURpYWxvZ1sgMCBdICkgJiYKCQkJCQkJIWV2ZW50LnNoaWZ0S2V5ICkgewoJCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCQkJZmlyc3QudHJpZ2dlciggImZvY3VzIiApOwoJCQkJCX0gKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSBlbHNlIGlmICggKCBldmVudC50YXJnZXQgPT09IGZpcnN0WyAwIF0gfHwKCQkJCQkJZXZlbnQudGFyZ2V0ID09PSB0aGlzLnVpRGlhbG9nWyAwIF0gKSAmJiBldmVudC5zaGlmdEtleSApIHsKCQkJCQl0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQkJCWxhc3QudHJpZ2dlciggImZvY3VzIiApOwoJCQkJCX0gKTsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9LAoJCQltb3VzZWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggdGhpcy5fbW92ZVRvVG9wKCBldmVudCApICkgewoJCQkJCXRoaXMuX2ZvY3VzVGFiYmFibGUoKTsKCQkJCX0KCQkJfQoJCX0gKTsKCgkJLy8gV2UgYXNzdW1lIHRoYXQgYW55IGV4aXN0aW5nIGFyaWEtZGVzY3JpYmVkYnkgYXR0cmlidXRlIG1lYW5zCgkJLy8gdGhhdCB0aGUgZGlhbG9nIGNvbnRlbnQgaXMgbWFya2VkIHVwIHByb3Blcmx5CgkJLy8gb3RoZXJ3aXNlIHdlIGJydXRlIGZvcmNlIHRoZSBjb250ZW50IGFzIHRoZSBkZXNjcmlwdGlvbgoJCWlmICggIXRoaXMuZWxlbWVudC5maW5kKCAiW2FyaWEtZGVzY3JpYmVkYnldIiApLmxlbmd0aCApIHsKCQkJdGhpcy51aURpYWxvZy5hdHRyKCB7CgkJCQkiYXJpYS1kZXNjcmliZWRieSI6IHRoaXMuZWxlbWVudC51bmlxdWVJZCgpLmF0dHIoICJpZCIgKQoJCQl9ICk7CgkJfQoJfSwKCglfY3JlYXRlVGl0bGViYXI6IGZ1bmN0aW9uKCkgewoJCXZhciB1aURpYWxvZ1RpdGxlOwoKCQl0aGlzLnVpRGlhbG9nVGl0bGViYXIgPSAkKCAiPGRpdj4iICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2dUaXRsZWJhciwKCQkJInVpLWRpYWxvZy10aXRsZWJhciIsICJ1aS13aWRnZXQtaGVhZGVyIHVpLWhlbHBlci1jbGVhcmZpeCIgKTsKCQl0aGlzLl9vbiggdGhpcy51aURpYWxvZ1RpdGxlYmFyLCB7CgkJCW1vdXNlZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIERvbid0IHByZXZlbnQgY2xpY2sgb24gY2xvc2UgYnV0dG9uICgjODgzOCkKCQkJCS8vIEZvY3VzaW5nIGEgZGlhbG9nIHRoYXQgaXMgcGFydGlhbGx5IHNjcm9sbGVkIG91dCBvZiB2aWV3CgkJCQkvLyBjYXVzZXMgdGhlIGJyb3dzZXIgdG8gc2Nyb2xsIGl0IGludG8gdmlldywgcHJldmVudGluZyB0aGUgY2xpY2sgZXZlbnQKCQkJCWlmICggISQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktZGlhbG9nLXRpdGxlYmFyLWNsb3NlIiApICkgewoKCQkJCQkvLyBEaWFsb2cgaXNuJ3QgZ2V0dGluZyBmb2N1cyB3aGVuIGRyYWdnaW5nICgjODA2MykKCQkJCQl0aGlzLnVpRGlhbG9nLnRyaWdnZXIoICJmb2N1cyIgKTsKCQkJCX0KCQkJfQoJCX0gKTsKCgkJLy8gU3VwcG9ydDogSUUKCQkvLyBVc2UgdHlwZT0iYnV0dG9uIiB0byBwcmV2ZW50IGVudGVyIGtleXByZXNzZXMgaW4gdGV4dGJveGVzIGZyb20gY2xvc2luZyB0aGUKCQkvLyBkaWFsb2cgaW4gSUUgKCM5MzEyKQoJCXRoaXMudWlEaWFsb2dUaXRsZWJhckNsb3NlID0gJCggIjxidXR0b24gdHlwZT0nYnV0dG9uJz48L2J1dHRvbj4iICkKCQkJLmJ1dHRvbiggewoJCQkJbGFiZWw6ICQoICI8YT4iICkudGV4dCggdGhpcy5vcHRpb25zLmNsb3NlVGV4dCApLmh0bWwoKSwKCQkJCWljb246ICJ1aS1pY29uLWNsb3NldGhpY2siLAoJCQkJc2hvd0xhYmVsOiBmYWxzZQoJCQl9ICkKCQkJLmFwcGVuZFRvKCB0aGlzLnVpRGlhbG9nVGl0bGViYXIgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlEaWFsb2dUaXRsZWJhckNsb3NlLCAidWktZGlhbG9nLXRpdGxlYmFyLWNsb3NlIiApOwoJCXRoaXMuX29uKCB0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZSwgewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJCX0KCQl9ICk7CgoJCXVpRGlhbG9nVGl0bGUgPSAkKCAiPHNwYW4+IiApLnVuaXF1ZUlkKCkucHJlcGVuZFRvKCB0aGlzLnVpRGlhbG9nVGl0bGViYXIgKTsKCQl0aGlzLl9hZGRDbGFzcyggdWlEaWFsb2dUaXRsZSwgInVpLWRpYWxvZy10aXRsZSIgKTsKCQl0aGlzLl90aXRsZSggdWlEaWFsb2dUaXRsZSApOwoKCQl0aGlzLnVpRGlhbG9nVGl0bGViYXIucHJlcGVuZFRvKCB0aGlzLnVpRGlhbG9nICk7CgoJCXRoaXMudWlEaWFsb2cuYXR0ciggewoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogdWlEaWFsb2dUaXRsZS5hdHRyKCAiaWQiICkKCQl9ICk7Cgl9LAoKCV90aXRsZTogZnVuY3Rpb24oIHRpdGxlICkgewoJCWlmICggdGhpcy5vcHRpb25zLnRpdGxlICkgewoJCQl0aXRsZS50ZXh0KCB0aGlzLm9wdGlvbnMudGl0bGUgKTsKCQl9IGVsc2UgewoJCQl0aXRsZS5odG1sKCAiJiMxNjA7IiApOwoJCX0KCX0sCgoJX2NyZWF0ZUJ1dHRvblBhbmU6IGZ1bmN0aW9uKCkgewoJCXRoaXMudWlEaWFsb2dCdXR0b25QYW5lID0gJCggIjxkaXY+IiApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpRGlhbG9nQnV0dG9uUGFuZSwgInVpLWRpYWxvZy1idXR0b25wYW5lIiwKCQkJInVpLXdpZGdldC1jb250ZW50IHVpLWhlbHBlci1jbGVhcmZpeCIgKTsKCgkJdGhpcy51aUJ1dHRvblNldCA9ICQoICI8ZGl2PiIgKQoJCQkuYXBwZW5kVG8oIHRoaXMudWlEaWFsb2dCdXR0b25QYW5lICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudWlCdXR0b25TZXQsICJ1aS1kaWFsb2ctYnV0dG9uc2V0IiApOwoKCQl0aGlzLl9jcmVhdGVCdXR0b25zKCk7Cgl9LAoKCV9jcmVhdGVCdXR0b25zOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCWJ1dHRvbnMgPSB0aGlzLm9wdGlvbnMuYnV0dG9uczsKCgkJLy8gSWYgd2UgYWxyZWFkeSBoYXZlIGEgYnV0dG9uIHBhbmUsIHJlbW92ZSBpdAoJCXRoaXMudWlEaWFsb2dCdXR0b25QYW5lLnJlbW92ZSgpOwoJCXRoaXMudWlCdXR0b25TZXQuZW1wdHkoKTsKCgkJaWYgKCAkLmlzRW1wdHlPYmplY3QoIGJ1dHRvbnMgKSB8fCAoICQuaXNBcnJheSggYnV0dG9ucyApICYmICFidXR0b25zLmxlbmd0aCApICkgewoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy51aURpYWxvZywgInVpLWRpYWxvZy1idXR0b25zIiApOwoJCQlyZXR1cm47CgkJfQoKCQkkLmVhY2goIGJ1dHRvbnMsIGZ1bmN0aW9uKCBuYW1lLCBwcm9wcyApIHsKCQkJdmFyIGNsaWNrLCBidXR0b25PcHRpb25zOwoJCQlwcm9wcyA9ICQuaXNGdW5jdGlvbiggcHJvcHMgKSA\/CgkJCQl7IGNsaWNrOiBwcm9wcywgdGV4dDogbmFtZSB9IDoKCQkJCXByb3BzOwoKCQkJLy8gRGVmYXVsdCB0byBhIG5vbi1zdWJtaXR0aW5nIGJ1dHRvbgoJCQlwcm9wcyA9ICQuZXh0ZW5kKCB7IHR5cGU6ICJidXR0b24iIH0sIHByb3BzICk7CgoJCQkvLyBDaGFuZ2UgdGhlIGNvbnRleHQgZm9yIHRoZSBjbGljayBjYWxsYmFjayB0byBiZSB0aGUgbWFpbiBlbGVtZW50CgkJCWNsaWNrID0gcHJvcHMuY2xpY2s7CgkJCWJ1dHRvbk9wdGlvbnMgPSB7CgkJCQlpY29uOiBwcm9wcy5pY29uLAoJCQkJaWNvblBvc2l0aW9uOiBwcm9wcy5pY29uUG9zaXRpb24sCgkJCQlzaG93TGFiZWw6IHByb3BzLnNob3dMYWJlbCwKCgkJCQkvLyBEZXByZWNhdGVkIG9wdGlvbnMKCQkJCWljb25zOiBwcm9wcy5pY29ucywKCQkJCXRleHQ6IHByb3BzLnRleHQKCQkJfTsKCgkJCWRlbGV0ZSBwcm9wcy5jbGljazsKCQkJZGVsZXRlIHByb3BzLmljb247CgkJCWRlbGV0ZSBwcm9wcy5pY29uUG9zaXRpb247CgkJCWRlbGV0ZSBwcm9wcy5zaG93TGFiZWw7CgoJCQkvLyBEZXByZWNhdGVkIG9wdGlvbnMKCQkJZGVsZXRlIHByb3BzLmljb25zOwoJCQlpZiAoIHR5cGVvZiBwcm9wcy50ZXh0ID09PSAiYm9vbGVhbiIgKSB7CgkJCQlkZWxldGUgcHJvcHMudGV4dDsKCQkJfQoKCQkJJCggIjxidXR0b24+PC9idXR0b24+IiwgcHJvcHMgKQoJCQkJLmJ1dHRvbiggYnV0dG9uT3B0aW9ucyApCgkJCQkuYXBwZW5kVG8oIHRoYXQudWlCdXR0b25TZXQgKQoJCQkJLm9uKCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQljbGljay5hcHBseSggdGhhdC5lbGVtZW50WyAwIF0sIGFyZ3VtZW50cyApOwoJCQkJfSApOwoJCX0gKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy51aURpYWxvZywgInVpLWRpYWxvZy1idXR0b25zIiApOwoJCXRoaXMudWlEaWFsb2dCdXR0b25QYW5lLmFwcGVuZFRvKCB0aGlzLnVpRGlhbG9nICk7Cgl9LAoKCV9tYWtlRHJhZ2dhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCWZ1bmN0aW9uIGZpbHRlcmVkVWkoIHVpICkgewoJCQlyZXR1cm4gewoJCQkJcG9zaXRpb246IHVpLnBvc2l0aW9uLAoJCQkJb2Zmc2V0OiB1aS5vZmZzZXQKCQkJfTsKCQl9CgoJCXRoaXMudWlEaWFsb2cuZHJhZ2dhYmxlKCB7CgkJCWNhbmNlbDogIi51aS1kaWFsb2ctY29udGVudCwgLnVpLWRpYWxvZy10aXRsZWJhci1jbG9zZSIsCgkJCWhhbmRsZTogIi51aS1kaWFsb2ctdGl0bGViYXIiLAoJCQljb250YWlubWVudDogImRvY3VtZW50IiwKCQkJc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQl0aGF0Ll9hZGRDbGFzcyggJCggdGhpcyApLCAidWktZGlhbG9nLWRyYWdnaW5nIiApOwoJCQkJdGhhdC5fYmxvY2tGcmFtZXMoKTsKCQkJCXRoYXQuX3RyaWdnZXIoICJkcmFnU3RhcnQiLCBldmVudCwgZmlsdGVyZWRVaSggdWkgKSApOwoJCQl9LAoJCQlkcmFnOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdGhhdC5fdHJpZ2dlciggImRyYWciLCBldmVudCwgZmlsdGVyZWRVaSggdWkgKSApOwoJCQl9LAoJCQlzdG9wOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdmFyIGxlZnQgPSB1aS5vZmZzZXQubGVmdCAtIHRoYXQuZG9jdW1lbnQuc2Nyb2xsTGVmdCgpLAoJCQkJCXRvcCA9IHVpLm9mZnNldC50b3AgLSB0aGF0LmRvY3VtZW50LnNjcm9sbFRvcCgpOwoKCQkJCW9wdGlvbnMucG9zaXRpb24gPSB7CgkJCQkJbXk6ICJsZWZ0IHRvcCIsCgkJCQkJYXQ6ICJsZWZ0IiArICggbGVmdCA+PSAwID8gIisiIDogIiIgKSArIGxlZnQgKyAiICIgKwoJCQkJCQkidG9wIiArICggdG9wID49IDAgPyAiKyIgOiAiIiApICsgdG9wLAoJCQkJCW9mOiB0aGF0LndpbmRvdwoJCQkJfTsKCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCAkKCB0aGlzICksICJ1aS1kaWFsb2ctZHJhZ2dpbmciICk7CgkJCQl0aGF0Ll91bmJsb2NrRnJhbWVzKCk7CgkJCQl0aGF0Ll90cmlnZ2VyKCAiZHJhZ1N0b3AiLCBldmVudCwgZmlsdGVyZWRVaSggdWkgKSApOwoJCQl9CgkJfSApOwoJfSwKCglfbWFrZVJlc2l6YWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQloYW5kbGVzID0gb3B0aW9ucy5yZXNpemFibGUsCgoJCQkvLyAudWktcmVzaXphYmxlIGhhcyBwb3NpdGlvbjogcmVsYXRpdmUgZGVmaW5lZCBpbiB0aGUgc3R5bGVzaGVldAoJCQkvLyBidXQgZGlhbG9ncyBoYXZlIHRvIHVzZSBhYnNvbHV0ZSBvciBmaXhlZCBwb3NpdGlvbmluZwoJCQlwb3NpdGlvbiA9IHRoaXMudWlEaWFsb2cuY3NzKCAicG9zaXRpb24iICksCgkJCXJlc2l6ZUhhbmRsZXMgPSB0eXBlb2YgaGFuZGxlcyA9PT0gInN0cmluZyIgPwoJCQkJaGFuZGxlcyA6CgkJCQkibixlLHMsdyxzZSxzdyxuZSxudyI7CgoJCWZ1bmN0aW9uIGZpbHRlcmVkVWkoIHVpICkgewoJCQlyZXR1cm4gewoJCQkJb3JpZ2luYWxQb3NpdGlvbjogdWkub3JpZ2luYWxQb3NpdGlvbiwKCQkJCW9yaWdpbmFsU2l6ZTogdWkub3JpZ2luYWxTaXplLAoJCQkJcG9zaXRpb246IHVpLnBvc2l0aW9uLAoJCQkJc2l6ZTogdWkuc2l6ZQoJCQl9OwoJCX0KCgkJdGhpcy51aURpYWxvZy5yZXNpemFibGUoIHsKCQkJY2FuY2VsOiAiLnVpLWRpYWxvZy1jb250ZW50IiwKCQkJY29udGFpbm1lbnQ6ICJkb2N1bWVudCIsCgkJCWFsc29SZXNpemU6IHRoaXMuZWxlbWVudCwKCQkJbWF4V2lkdGg6IG9wdGlvbnMubWF4V2lkdGgsCgkJCW1heEhlaWdodDogb3B0aW9ucy5tYXhIZWlnaHQsCgkJCW1pbldpZHRoOiBvcHRpb25zLm1pbldpZHRoLAoJCQltaW5IZWlnaHQ6IHRoaXMuX21pbkhlaWdodCgpLAoJCQloYW5kbGVzOiByZXNpemVIYW5kbGVzLAoJCQlzdGFydDogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCXRoYXQuX2FkZENsYXNzKCAkKCB0aGlzICksICJ1aS1kaWFsb2ctcmVzaXppbmciICk7CgkJCQl0aGF0Ll9ibG9ja0ZyYW1lcygpOwoJCQkJdGhhdC5fdHJpZ2dlciggInJlc2l6ZVN0YXJ0IiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsKCQkJfSwKCQkJcmVzaXplOiBmdW5jdGlvbiggZXZlbnQsIHVpICkgewoJCQkJdGhhdC5fdHJpZ2dlciggInJlc2l6ZSIsIGV2ZW50LCBmaWx0ZXJlZFVpKCB1aSApICk7CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQl2YXIgb2Zmc2V0ID0gdGhhdC51aURpYWxvZy5vZmZzZXQoKSwKCQkJCQlsZWZ0ID0gb2Zmc2V0LmxlZnQgLSB0aGF0LmRvY3VtZW50LnNjcm9sbExlZnQoKSwKCQkJCQl0b3AgPSBvZmZzZXQudG9wIC0gdGhhdC5kb2N1bWVudC5zY3JvbGxUb3AoKTsKCgkJCQlvcHRpb25zLmhlaWdodCA9IHRoYXQudWlEaWFsb2cuaGVpZ2h0KCk7CgkJCQlvcHRpb25zLndpZHRoID0gdGhhdC51aURpYWxvZy53aWR0aCgpOwoJCQkJb3B0aW9ucy5wb3NpdGlvbiA9IHsKCQkJCQlteTogImxlZnQgdG9wIiwKCQkJCQlhdDogImxlZnQiICsgKCBsZWZ0ID49IDAgPyAiKyIgOiAiIiApICsgbGVmdCArICIgIiArCgkJCQkJCSJ0b3AiICsgKCB0b3AgPj0gMCA\/ICIrIiA6ICIiICkgKyB0b3AsCgkJCQkJb2Y6IHRoYXQud2luZG93CgkJCQl9OwoJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoICQoIHRoaXMgKSwgInVpLWRpYWxvZy1yZXNpemluZyIgKTsKCQkJCXRoYXQuX3VuYmxvY2tGcmFtZXMoKTsKCQkJCXRoYXQuX3RyaWdnZXIoICJyZXNpemVTdG9wIiwgZXZlbnQsIGZpbHRlcmVkVWkoIHVpICkgKTsKCQkJfQoJCX0gKQoJCQkuY3NzKCAicG9zaXRpb24iLCBwb3NpdGlvbiApOwoJfSwKCglfdHJhY2tGb2N1czogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHRoaXMud2lkZ2V0KCksIHsKCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5fbWFrZUZvY3VzVGFyZ2V0KCk7CgkJCQl0aGlzLl9mb2N1c2VkRWxlbWVudCA9ICQoIGV2ZW50LnRhcmdldCApOwoJCQl9CgkJfSApOwoJfSwKCglfbWFrZUZvY3VzVGFyZ2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl91bnRyYWNrSW5zdGFuY2UoKTsKCQl0aGlzLl90cmFja2luZ0luc3RhbmNlcygpLnVuc2hpZnQoIHRoaXMgKTsKCX0sCgoJX3VudHJhY2tJbnN0YW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGluc3RhbmNlcyA9IHRoaXMuX3RyYWNraW5nSW5zdGFuY2VzKCksCgkJCWV4aXN0cyA9ICQuaW5BcnJheSggdGhpcywgaW5zdGFuY2VzICk7CgkJaWYgKCBleGlzdHMgIT09IC0xICkgewoJCQlpbnN0YW5jZXMuc3BsaWNlKCBleGlzdHMsIDEgKTsKCQl9Cgl9LAoKCV90cmFja2luZ0luc3RhbmNlczogZnVuY3Rpb24oKSB7CgkJdmFyIGluc3RhbmNlcyA9IHRoaXMuZG9jdW1lbnQuZGF0YSggInVpLWRpYWxvZy1pbnN0YW5jZXMiICk7CgkJaWYgKCAhaW5zdGFuY2VzICkgewoJCQlpbnN0YW5jZXMgPSBbXTsKCQkJdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLWluc3RhbmNlcyIsIGluc3RhbmNlcyApOwoJCX0KCQlyZXR1cm4gaW5zdGFuY2VzOwoJfSwKCglfbWluSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJcmV0dXJuIG9wdGlvbnMuaGVpZ2h0ID09PSAiYXV0byIgPwoJCQlvcHRpb25zLm1pbkhlaWdodCA6CgkJCU1hdGgubWluKCBvcHRpb25zLm1pbkhlaWdodCwgb3B0aW9ucy5oZWlnaHQgKTsKCX0sCgoJX3Bvc2l0aW9uOiBmdW5jdGlvbigpIHsKCgkJLy8gTmVlZCB0byBzaG93IHRoZSBkaWFsb2cgdG8gZ2V0IHRoZSBhY3R1YWwgb2Zmc2V0IGluIHRoZSBwb3NpdGlvbiBwbHVnaW4KCQl2YXIgaXNWaXNpYmxlID0gdGhpcy51aURpYWxvZy5pcyggIjp2aXNpYmxlIiApOwoJCWlmICggIWlzVmlzaWJsZSApIHsKCQkJdGhpcy51aURpYWxvZy5zaG93KCk7CgkJfQoJCXRoaXMudWlEaWFsb2cucG9zaXRpb24oIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApOwoJCWlmICggIWlzVmlzaWJsZSApIHsKCQkJdGhpcy51aURpYWxvZy5oaWRlKCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlyZXNpemUgPSBmYWxzZSwKCQkJcmVzaXphYmxlT3B0aW9ucyA9IHt9OwoKCQkkLmVhY2goIG9wdGlvbnMsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQl0aGF0Ll9zZXRPcHRpb24oIGtleSwgdmFsdWUgKTsKCgkJCWlmICgga2V5IGluIHRoYXQuc2l6ZVJlbGF0ZWRPcHRpb25zICkgewoJCQkJcmVzaXplID0gdHJ1ZTsKCQkJfQoJCQlpZiAoIGtleSBpbiB0aGF0LnJlc2l6YWJsZVJlbGF0ZWRPcHRpb25zICkgewoJCQkJcmVzaXphYmxlT3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0gKTsKCgkJaWYgKCByZXNpemUgKSB7CgkJCXRoaXMuX3NpemUoKTsKCQkJdGhpcy5fcG9zaXRpb24oKTsKCQl9CgkJaWYgKCB0aGlzLnVpRGlhbG9nLmlzKCAiOmRhdGEodWktcmVzaXphYmxlKSIgKSApIHsKCQkJdGhpcy51aURpYWxvZy5yZXNpemFibGUoICJvcHRpb24iLCByZXNpemFibGVPcHRpb25zICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgaXNEcmFnZ2FibGUsIGlzUmVzaXphYmxlLAoJCQl1aURpYWxvZyA9IHRoaXMudWlEaWFsb2c7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gImFwcGVuZFRvIiApIHsKCQkJdGhpcy51aURpYWxvZy5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oKSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJidXR0b25zIiApIHsKCQkJdGhpcy5fY3JlYXRlQnV0dG9ucygpOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJjbG9zZVRleHQiICkgewoJCQl0aGlzLnVpRGlhbG9nVGl0bGViYXJDbG9zZS5idXR0b24oIHsKCgkJCQkvLyBFbnN1cmUgdGhhdCB3ZSBhbHdheXMgcGFzcyBhIHN0cmluZwoJCQkJbGFiZWw6ICQoICI8YT4iICkudGV4dCggIiIgKyB0aGlzLm9wdGlvbnMuY2xvc2VUZXh0ICkuaHRtbCgpCgkJCX0gKTsKCQl9CgoJCWlmICgga2V5ID09PSAiZHJhZ2dhYmxlIiApIHsKCQkJaXNEcmFnZ2FibGUgPSB1aURpYWxvZy5pcyggIjpkYXRhKHVpLWRyYWdnYWJsZSkiICk7CgkJCWlmICggaXNEcmFnZ2FibGUgJiYgIXZhbHVlICkgewoJCQkJdWlEaWFsb2cuZHJhZ2dhYmxlKCAiZGVzdHJveSIgKTsKCQkJfQoKCQkJaWYgKCAhaXNEcmFnZ2FibGUgJiYgdmFsdWUgKSB7CgkJCQl0aGlzLl9tYWtlRHJhZ2dhYmxlKCk7CgkJCX0KCQl9CgoJCWlmICgga2V5ID09PSAicG9zaXRpb24iICkgewoJCQl0aGlzLl9wb3NpdGlvbigpOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJyZXNpemFibGUiICkgewoKCQkJLy8gY3VycmVudGx5IHJlc2l6YWJsZSwgYmVjb21pbmcgbm9uLXJlc2l6YWJsZQoJCQlpc1Jlc2l6YWJsZSA9IHVpRGlhbG9nLmlzKCAiOmRhdGEodWktcmVzaXphYmxlKSIgKTsKCQkJaWYgKCBpc1Jlc2l6YWJsZSAmJiAhdmFsdWUgKSB7CgkJCQl1aURpYWxvZy5yZXNpemFibGUoICJkZXN0cm95IiApOwoJCQl9CgoJCQkvLyBDdXJyZW50bHkgcmVzaXphYmxlLCBjaGFuZ2luZyBoYW5kbGVzCgkJCWlmICggaXNSZXNpemFibGUgJiYgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiApIHsKCQkJCXVpRGlhbG9nLnJlc2l6YWJsZSggIm9wdGlvbiIsICJoYW5kbGVzIiwgdmFsdWUgKTsKCQkJfQoKCQkJLy8gQ3VycmVudGx5IG5vbi1yZXNpemFibGUsIGJlY29taW5nIHJlc2l6YWJsZQoJCQlpZiAoICFpc1Jlc2l6YWJsZSAmJiB2YWx1ZSAhPT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9tYWtlUmVzaXphYmxlKCk7CgkJCX0KCQl9CgoJCWlmICgga2V5ID09PSAidGl0bGUiICkgewoJCQl0aGlzLl90aXRsZSggdGhpcy51aURpYWxvZ1RpdGxlYmFyLmZpbmQoICIudWktZGlhbG9nLXRpdGxlIiApICk7CgkJfQoJfSwKCglfc2l6ZTogZnVuY3Rpb24oKSB7CgoJCS8vIElmIHRoZSB1c2VyIGhhcyByZXNpemVkIHRoZSBkaWFsb2csIHRoZSAudWktZGlhbG9nIGFuZCAudWktZGlhbG9nLWNvbnRlbnQKCQkvLyBkaXZzIHdpbGwgYm90aCBoYXZlIHdpZHRoIGFuZCBoZWlnaHQgc2V0LCBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZW0KCQl2YXIgbm9uQ29udGVudEhlaWdodCwgbWluQ29udGVudEhlaWdodCwgbWF4Q29udGVudEhlaWdodCwKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gUmVzZXQgY29udGVudCBzaXppbmcKCQl0aGlzLmVsZW1lbnQuc2hvdygpLmNzcyggewoJCQl3aWR0aDogImF1dG8iLAoJCQltaW5IZWlnaHQ6IDAsCgkJCW1heEhlaWdodDogIm5vbmUiLAoJCQloZWlnaHQ6IDAKCQl9ICk7CgoJCWlmICggb3B0aW9ucy5taW5XaWR0aCA+IG9wdGlvbnMud2lkdGggKSB7CgkJCW9wdGlvbnMud2lkdGggPSBvcHRpb25zLm1pbldpZHRoOwoJCX0KCgkJLy8gUmVzZXQgd3JhcHBlciBzaXppbmcKCQkvLyBkZXRlcm1pbmUgdGhlIGhlaWdodCBvZiBhbGwgdGhlIG5vbi1jb250ZW50IGVsZW1lbnRzCgkJbm9uQ29udGVudEhlaWdodCA9IHRoaXMudWlEaWFsb2cuY3NzKCB7CgkJCWhlaWdodDogImF1dG8iLAoJCQl3aWR0aDogb3B0aW9ucy53aWR0aAoJCX0gKQoJCQkub3V0ZXJIZWlnaHQoKTsKCQltaW5Db250ZW50SGVpZ2h0ID0gTWF0aC5tYXgoIDAsIG9wdGlvbnMubWluSGVpZ2h0IC0gbm9uQ29udGVudEhlaWdodCApOwoJCW1heENvbnRlbnRIZWlnaHQgPSB0eXBlb2Ygb3B0aW9ucy5tYXhIZWlnaHQgPT09ICJudW1iZXIiID8KCQkJTWF0aC5tYXgoIDAsIG9wdGlvbnMubWF4SGVpZ2h0IC0gbm9uQ29udGVudEhlaWdodCApIDoKCQkJIm5vbmUiOwoKCQlpZiAoIG9wdGlvbnMuaGVpZ2h0ID09PSAiYXV0byIgKSB7CgkJCXRoaXMuZWxlbWVudC5jc3MoIHsKCQkJCW1pbkhlaWdodDogbWluQ29udGVudEhlaWdodCwKCQkJCW1heEhlaWdodDogbWF4Q29udGVudEhlaWdodCwKCQkJCWhlaWdodDogImF1dG8iCgkJCX0gKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVsZW1lbnQuaGVpZ2h0KCBNYXRoLm1heCggMCwgb3B0aW9ucy5oZWlnaHQgLSBub25Db250ZW50SGVpZ2h0ICkgKTsKCQl9CgoJCWlmICggdGhpcy51aURpYWxvZy5pcyggIjpkYXRhKHVpLXJlc2l6YWJsZSkiICkgKSB7CgkJCXRoaXMudWlEaWFsb2cucmVzaXphYmxlKCAib3B0aW9uIiwgIm1pbkhlaWdodCIsIHRoaXMuX21pbkhlaWdodCgpICk7CgkJfQoJfSwKCglfYmxvY2tGcmFtZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaWZyYW1lQmxvY2tzID0gdGhpcy5kb2N1bWVudC5maW5kKCAiaWZyYW1lIiApLm1hcCggZnVuY3Rpb24oKSB7CgkJCXZhciBpZnJhbWUgPSAkKCB0aGlzICk7CgoJCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCQkuY3NzKCB7CgkJCQkJcG9zaXRpb246ICJhYnNvbHV0ZSIsCgkJCQkJd2lkdGg6IGlmcmFtZS5vdXRlcldpZHRoKCksCgkJCQkJaGVpZ2h0OiBpZnJhbWUub3V0ZXJIZWlnaHQoKQoJCQkJfSApCgkJCQkuYXBwZW5kVG8oIGlmcmFtZS5wYXJlbnQoKSApCgkJCQkub2Zmc2V0KCBpZnJhbWUub2Zmc2V0KCkgKVsgMCBdOwoJCX0gKTsKCX0sCgoJX3VuYmxvY2tGcmFtZXM6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pZnJhbWVCbG9ja3MgKSB7CgkJCXRoaXMuaWZyYW1lQmxvY2tzLnJlbW92ZSgpOwoJCQlkZWxldGUgdGhpcy5pZnJhbWVCbG9ja3M7CgkJfQoJfSwKCglfYWxsb3dJbnRlcmFjdGlvbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1kaWFsb2ciICkubGVuZ3RoICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgoJCS8vIFRPRE86IFJlbW92ZSBoYWNrIHdoZW4gZGF0ZXBpY2tlciBpbXBsZW1lbnRzCgkJLy8gdGhlIC51aS1mcm9udCBsb2dpYyAoIzg5ODkpCgkJcmV0dXJuICEhJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1kYXRlcGlja2VyIiApLmxlbmd0aDsKCX0sCgoJX2NyZWF0ZU92ZXJsYXk6IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXMub3B0aW9ucy5tb2RhbCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgdXNlIGEgZGVsYXkgaW4gY2FzZSB0aGUgb3ZlcmxheSBpcyBjcmVhdGVkIGZyb20gYW4KCQkvLyBldmVudCB0aGF0IHdlJ3JlIGdvaW5nIHRvIGJlIGNhbmNlbGxpbmcgKCMyODA0KQoJCXZhciBpc09wZW5pbmcgPSB0cnVlOwoJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJaXNPcGVuaW5nID0gZmFsc2U7CgkJfSApOwoKCQlpZiAoICF0aGlzLmRvY3VtZW50LmRhdGEoICJ1aS1kaWFsb2ctb3ZlcmxheXMiICkgKSB7CgoJCQkvLyBQcmV2ZW50IHVzZSBvZiBhbmNob3JzIGFuZCBpbnB1dHMKCQkJLy8gVXNpbmcgX29uKCkgZm9yIGFuIGV2ZW50IGhhbmRsZXIgc2hhcmVkIGFjcm9zcyBtYW55IGluc3RhbmNlcyBpcwoJCQkvLyBzYWZlIGJlY2F1c2UgdGhlIGRpYWxvZ3Mgc3RhY2sgYW5kIG11c3QgYmUgY2xvc2VkIGluIHJldmVyc2Ugb3JkZXIKCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGlzT3BlbmluZyApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJaWYgKCAhdGhpcy5fYWxsb3dJbnRlcmFjdGlvbiggZXZlbnQgKSApIHsKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJdGhpcy5fdHJhY2tpbmdJbnN0YW5jZXMoKVsgMCBdLl9mb2N1c1RhYmJhYmxlKCk7CgkJCQkJfQoJCQkJfQoJCQl9ICk7CgkJfQoKCQl0aGlzLm92ZXJsYXkgPSAkKCAiPGRpdj4iICkKCQkJLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLm92ZXJsYXksIG51bGwsICJ1aS13aWRnZXQtb3ZlcmxheSB1aS1mcm9udCIgKTsKCQl0aGlzLl9vbiggdGhpcy5vdmVybGF5LCB7CgkJCW1vdXNlZG93bjogIl9rZWVwRm9jdXMiCgkJfSApOwoJCXRoaXMuZG9jdW1lbnQuZGF0YSggInVpLWRpYWxvZy1vdmVybGF5cyIsCgkJCSggdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiApIHx8IDAgKSArIDEgKTsKCX0sCgoJX2Rlc3Ryb3lPdmVybGF5OiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMubW9kYWwgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGhpcy5vdmVybGF5ICkgewoJCQl2YXIgb3ZlcmxheXMgPSB0aGlzLmRvY3VtZW50LmRhdGEoICJ1aS1kaWFsb2ctb3ZlcmxheXMiICkgLSAxOwoKCQkJaWYgKCAhb3ZlcmxheXMgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQsICJmb2N1c2luIiApOwoJCQkJdGhpcy5kb2N1bWVudC5yZW1vdmVEYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb2N1bWVudC5kYXRhKCAidWktZGlhbG9nLW92ZXJsYXlzIiwgb3ZlcmxheXMgKTsKCQkJfQoKCQkJdGhpcy5vdmVybGF5LnJlbW92ZSgpOwoJCQl0aGlzLm92ZXJsYXkgPSBudWxsOwoJCX0KCX0KfSApOwoKLy8gREVQUkVDQVRFRAovLyBUT0RPOiBzd2l0Y2ggcmV0dXJuIGJhY2sgdG8gd2lkZ2V0IGRlY2xhcmF0aW9uIGF0IHRvcCBvZiBmaWxlIHdoZW4gdGhpcyBpcyByZW1vdmVkCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgewoKCS8vIEJhY2tjb21wYXQgZm9yIGRpYWxvZ0NsYXNzIG9wdGlvbgoJJC53aWRnZXQoICJ1aS5kaWFsb2ciLCAkLnVpLmRpYWxvZywgewoJCW9wdGlvbnM6IHsKCQkJZGlhbG9nQ2xhc3M6ICIiCgkJfSwKCQlfY3JlYXRlV3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCXRoaXMudWlEaWFsb2cuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5kaWFsb2dDbGFzcyApOwoJCX0sCgkJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCWlmICgga2V5ID09PSAiZGlhbG9nQ2xhc3MiICkgewoJCQkJdGhpcy51aURpYWxvZwoJCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmRpYWxvZ0NsYXNzICkKCQkJCQkuYWRkQ2xhc3MoIHZhbHVlICk7CgkJCX0KCQkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJfQoJfSApOwp9Cgp2YXIgd2lkZ2V0c0RpYWxvZyA9ICQudWkuZGlhbG9nOwoKCi8qIQogKiBqUXVlcnkgVUkgRHJvcHBhYmxlIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogRHJvcHBhYmxlCi8vPj5ncm91cDogSW50ZXJhY3Rpb25zCi8vPj5kZXNjcmlwdGlvbjogRW5hYmxlcyBkcm9wIHRhcmdldHMgZm9yIGRyYWdnYWJsZSBlbGVtZW50cy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2Ryb3BwYWJsZS8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL2Ryb3BwYWJsZS8KCgoKJC53aWRnZXQoICJ1aS5kcm9wcGFibGUiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCXdpZGdldEV2ZW50UHJlZml4OiAiZHJvcCIsCglvcHRpb25zOiB7CgkJYWNjZXB0OiAiKiIsCgkJYWRkQ2xhc3NlczogdHJ1ZSwKCQlncmVlZHk6IGZhbHNlLAoJCXNjb3BlOiAiZGVmYXVsdCIsCgkJdG9sZXJhbmNlOiAiaW50ZXJzZWN0IiwKCgkJLy8gQ2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJZGVhY3RpdmF0ZTogbnVsbCwKCQlkcm9wOiBudWxsLAoJCW91dDogbnVsbCwKCQlvdmVyOiBudWxsCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBwcm9wb3J0aW9ucywKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJYWNjZXB0ID0gby5hY2NlcHQ7CgoJCXRoaXMuaXNvdmVyID0gZmFsc2U7CgkJdGhpcy5pc291dCA9IHRydWU7CgoJCXRoaXMuYWNjZXB0ID0gJC5pc0Z1bmN0aW9uKCBhY2NlcHQgKSA\/IGFjY2VwdCA6IGZ1bmN0aW9uKCBkICkgewoJCQlyZXR1cm4gZC5pcyggYWNjZXB0ICk7CgkJfTsKCgkJdGhpcy5wcm9wb3J0aW9ucyA9IGZ1bmN0aW9uKCAvKiB2YWx1ZVRvV3JpdGUgKi8gKSB7CgkJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCgkJCQkvLyBTdG9yZSB0aGUgZHJvcHBhYmxlJ3MgcHJvcG9ydGlvbnMKCQkJCXByb3BvcnRpb25zID0gYXJndW1lbnRzWyAwIF07CgkJCX0gZWxzZSB7CgoJCQkJLy8gUmV0cmlldmUgb3IgZGVyaXZlIHRoZSBkcm9wcGFibGUncyBwcm9wb3J0aW9ucwoJCQkJcmV0dXJuIHByb3BvcnRpb25zID8KCQkJCQlwcm9wb3J0aW9ucyA6CgkJCQkJcHJvcG9ydGlvbnMgPSB7CgkJCQkJCXdpZHRoOiB0aGlzLmVsZW1lbnRbIDAgXS5vZmZzZXRXaWR0aCwKCQkJCQkJaGVpZ2h0OiB0aGlzLmVsZW1lbnRbIDAgXS5vZmZzZXRIZWlnaHQKCQkJCQl9OwoJCQl9CgkJfTsKCgkJdGhpcy5fYWRkVG9NYW5hZ2VyKCBvLnNjb3BlICk7CgoJCW8uYWRkQ2xhc3NlcyAmJiB0aGlzLl9hZGRDbGFzcyggInVpLWRyb3BwYWJsZSIgKTsKCgl9LAoKCV9hZGRUb01hbmFnZXI6IGZ1bmN0aW9uKCBzY29wZSApIHsKCgkJLy8gQWRkIHRoZSByZWZlcmVuY2UgYW5kIHBvc2l0aW9ucyB0byB0aGUgbWFuYWdlcgoJCSQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIHNjb3BlIF0gPSAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyBzY29wZSBdIHx8IFtdOwoJCSQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIHNjb3BlIF0ucHVzaCggdGhpcyApOwoJfSwKCglfc3BsaWNlOiBmdW5jdGlvbiggZHJvcCApIHsKCQl2YXIgaSA9IDA7CgkJZm9yICggOyBpIDwgZHJvcC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBkcm9wWyBpIF0gPT09IHRoaXMgKSB7CgkJCQlkcm9wLnNwbGljZSggaSwgMSApOwoJCQl9CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGRyb3AgPSAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyB0aGlzLm9wdGlvbnMuc2NvcGUgXTsKCgkJdGhpcy5fc3BsaWNlKCBkcm9wICk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoKCQlpZiAoIGtleSA9PT0gImFjY2VwdCIgKSB7CgkJCXRoaXMuYWNjZXB0ID0gJC5pc0Z1bmN0aW9uKCB2YWx1ZSApID8gdmFsdWUgOiBmdW5jdGlvbiggZCApIHsKCQkJCXJldHVybiBkLmlzKCB2YWx1ZSApOwoJCQl9OwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInNjb3BlIiApIHsKCQkJdmFyIGRyb3AgPSAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyB0aGlzLm9wdGlvbnMuc2NvcGUgXTsKCgkJCXRoaXMuX3NwbGljZSggZHJvcCApOwoJCQl0aGlzLl9hZGRUb01hbmFnZXIoIHZhbHVlICk7CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZHJhZ2dhYmxlID0gJC51aS5kZG1hbmFnZXIuY3VycmVudDsKCgkJdGhpcy5fYWRkQWN0aXZlQ2xhc3MoKTsKCQlpZiAoIGRyYWdnYWJsZSApIHsKCQkJdGhpcy5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIHRoaXMudWkoIGRyYWdnYWJsZSApICk7CgkJfQoJfSwKCglfZGVhY3RpdmF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBkcmFnZ2FibGUgPSAkLnVpLmRkbWFuYWdlci5jdXJyZW50OwoKCQl0aGlzLl9yZW1vdmVBY3RpdmVDbGFzcygpOwoJCWlmICggZHJhZ2dhYmxlICkgewoJCQl0aGlzLl90cmlnZ2VyKCAiZGVhY3RpdmF0ZSIsIGV2ZW50LCB0aGlzLnVpKCBkcmFnZ2FibGUgKSApOwoJCX0KCX0sCgoJX292ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJdmFyIGRyYWdnYWJsZSA9ICQudWkuZGRtYW5hZ2VyLmN1cnJlbnQ7CgoJCS8vIEJhaWwgaWYgZHJhZ2dhYmxlIGFuZCBkcm9wcGFibGUgYXJlIHNhbWUgZWxlbWVudAoJCWlmICggIWRyYWdnYWJsZSB8fCAoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fAoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmFjY2VwdC5jYWxsKCB0aGlzLmVsZW1lbnRbIDAgXSwgKCBkcmFnZ2FibGUuY3VycmVudEl0ZW0gfHwKCQkJCWRyYWdnYWJsZS5lbGVtZW50ICkgKSApIHsKCQkJdGhpcy5fYWRkSG92ZXJDbGFzcygpOwoJCQl0aGlzLl90cmlnZ2VyKCAib3ZlciIsIGV2ZW50LCB0aGlzLnVpKCBkcmFnZ2FibGUgKSApOwoJCX0KCgl9LAoKCV9vdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJdmFyIGRyYWdnYWJsZSA9ICQudWkuZGRtYW5hZ2VyLmN1cnJlbnQ7CgoJCS8vIEJhaWwgaWYgZHJhZ2dhYmxlIGFuZCBkcm9wcGFibGUgYXJlIHNhbWUgZWxlbWVudAoJCWlmICggIWRyYWdnYWJsZSB8fCAoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fAoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmFjY2VwdC5jYWxsKCB0aGlzLmVsZW1lbnRbIDAgXSwgKCBkcmFnZ2FibGUuY3VycmVudEl0ZW0gfHwKCQkJCWRyYWdnYWJsZS5lbGVtZW50ICkgKSApIHsKCQkJdGhpcy5fcmVtb3ZlSG92ZXJDbGFzcygpOwoJCQl0aGlzLl90cmlnZ2VyKCAib3V0IiwgZXZlbnQsIHRoaXMudWkoIGRyYWdnYWJsZSApICk7CgkJfQoKCX0sCgoJX2Ryb3A6IGZ1bmN0aW9uKCBldmVudCwgY3VzdG9tICkgewoKCQl2YXIgZHJhZ2dhYmxlID0gY3VzdG9tIHx8ICQudWkuZGRtYW5hZ2VyLmN1cnJlbnQsCgkJCWNoaWxkcmVuSW50ZXJzZWN0aW9uID0gZmFsc2U7CgoJCS8vIEJhaWwgaWYgZHJhZ2dhYmxlIGFuZCBkcm9wcGFibGUgYXJlIHNhbWUgZWxlbWVudAoJCWlmICggIWRyYWdnYWJsZSB8fCAoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fAoJCQkJZHJhZ2dhYmxlLmVsZW1lbnQgKVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJdGhpcy5lbGVtZW50CgkJCS5maW5kKCAiOmRhdGEodWktZHJvcHBhYmxlKSIgKQoJCQkubm90KCAiLnVpLWRyYWdnYWJsZS1kcmFnZ2luZyIgKQoJCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgaW5zdCA9ICQoIHRoaXMgKS5kcm9wcGFibGUoICJpbnN0YW5jZSIgKTsKCQkJCWlmICgKCQkJCQlpbnN0Lm9wdGlvbnMuZ3JlZWR5ICYmCgkJCQkJIWluc3Qub3B0aW9ucy5kaXNhYmxlZCAmJgoJCQkJCWluc3Qub3B0aW9ucy5zY29wZSA9PT0gZHJhZ2dhYmxlLm9wdGlvbnMuc2NvcGUgJiYKCQkJCQlpbnN0LmFjY2VwdC5jYWxsKAoJCQkJCQlpbnN0LmVsZW1lbnRbIDAgXSwgKCBkcmFnZ2FibGUuY3VycmVudEl0ZW0gfHwgZHJhZ2dhYmxlLmVsZW1lbnQgKQoJCQkJCSkgJiYKCQkJCQlpbnRlcnNlY3QoCgkJCQkJCWRyYWdnYWJsZSwKCQkJCQkJJC5leHRlbmQoIGluc3QsIHsgb2Zmc2V0OiBpbnN0LmVsZW1lbnQub2Zmc2V0KCkgfSApLAoJCQkJCQlpbnN0Lm9wdGlvbnMudG9sZXJhbmNlLCBldmVudAoJCQkJCSkKCQkJCSkgewoJCQkJCWNoaWxkcmVuSW50ZXJzZWN0aW9uID0gdHJ1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7IH0KCQkJfSApOwoJCWlmICggY2hpbGRyZW5JbnRlcnNlY3Rpb24gKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggdGhpcy5hY2NlcHQuY2FsbCggdGhpcy5lbGVtZW50WyAwIF0sCgkJCQkoIGRyYWdnYWJsZS5jdXJyZW50SXRlbSB8fCBkcmFnZ2FibGUuZWxlbWVudCApICkgKSB7CgkJCXRoaXMuX3JlbW92ZUFjdGl2ZUNsYXNzKCk7CgkJCXRoaXMuX3JlbW92ZUhvdmVyQ2xhc3MoKTsKCgkJCXRoaXMuX3RyaWdnZXIoICJkcm9wIiwgZXZlbnQsIHRoaXMudWkoIGRyYWdnYWJsZSApICk7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfSwKCgl1aTogZnVuY3Rpb24oIGMgKSB7CgkJcmV0dXJuIHsKCQkJZHJhZ2dhYmxlOiAoIGMuY3VycmVudEl0ZW0gfHwgYy5lbGVtZW50ICksCgkJCWhlbHBlcjogYy5oZWxwZXIsCgkJCXBvc2l0aW9uOiBjLnBvc2l0aW9uLAoJCQlvZmZzZXQ6IGMucG9zaXRpb25BYnMKCQl9OwoJfSwKCgkvLyBFeHRlbnNpb24gcG9pbnRzIGp1c3QgdG8gbWFrZSBiYWNrY29tcGF0IHNhbmUgYW5kIGF2b2lkIGR1cGxpY2F0aW5nIGxvZ2ljCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS4xMyBhbG9uZyB3aXRoIGNhbGwgdG8gaXQgYmVsb3cKCV9hZGRIb3ZlckNsYXNzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9hZGRDbGFzcyggInVpLWRyb3BwYWJsZS1ob3ZlciIgKTsKCX0sCgoJX3JlbW92ZUhvdmVyQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlbW92ZUNsYXNzKCAidWktZHJvcHBhYmxlLWhvdmVyIiApOwoJfSwKCglfYWRkQWN0aXZlQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2FkZENsYXNzKCAidWktZHJvcHBhYmxlLWFjdGl2ZSIgKTsKCX0sCgoJX3JlbW92ZUFjdGl2ZUNsYXNzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZW1vdmVDbGFzcyggInVpLWRyb3BwYWJsZS1hY3RpdmUiICk7Cgl9Cn0gKTsKCnZhciBpbnRlcnNlY3QgPSAkLnVpLmludGVyc2VjdCA9ICggZnVuY3Rpb24oKSB7CglmdW5jdGlvbiBpc092ZXJBeGlzKCB4LCByZWZlcmVuY2UsIHNpemUgKSB7CgkJcmV0dXJuICggeCA+PSByZWZlcmVuY2UgKSAmJiAoIHggPCAoIHJlZmVyZW5jZSArIHNpemUgKSApOwoJfQoKCXJldHVybiBmdW5jdGlvbiggZHJhZ2dhYmxlLCBkcm9wcGFibGUsIHRvbGVyYW5jZU1vZGUsIGV2ZW50ICkgewoKCQlpZiAoICFkcm9wcGFibGUub2Zmc2V0ICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl2YXIgeDEgPSAoIGRyYWdnYWJsZS5wb3NpdGlvbkFicyB8fAoJCQkJZHJhZ2dhYmxlLnBvc2l0aW9uLmFic29sdXRlICkubGVmdCArIGRyYWdnYWJsZS5tYXJnaW5zLmxlZnQsCgkJCXkxID0gKCBkcmFnZ2FibGUucG9zaXRpb25BYnMgfHwKCQkJCWRyYWdnYWJsZS5wb3NpdGlvbi5hYnNvbHV0ZSApLnRvcCArIGRyYWdnYWJsZS5tYXJnaW5zLnRvcCwKCQkJeDIgPSB4MSArIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCwKCQkJeTIgPSB5MSArIGRyYWdnYWJsZS5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQsCgkJCWwgPSBkcm9wcGFibGUub2Zmc2V0LmxlZnQsCgkJCXQgPSBkcm9wcGFibGUub2Zmc2V0LnRvcCwKCQkJciA9IGwgKyBkcm9wcGFibGUucHJvcG9ydGlvbnMoKS53aWR0aCwKCQkJYiA9IHQgKyBkcm9wcGFibGUucHJvcG9ydGlvbnMoKS5oZWlnaHQ7CgoJCXN3aXRjaCAoIHRvbGVyYW5jZU1vZGUgKSB7CgkJY2FzZSAiZml0IjoKCQkJcmV0dXJuICggbCA8PSB4MSAmJiB4MiA8PSByICYmIHQgPD0geTEgJiYgeTIgPD0gYiApOwoJCWNhc2UgImludGVyc2VjdCI6CgkJCXJldHVybiAoIGwgPCB4MSArICggZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC8gMiApICYmIC8vIFJpZ2h0IEhhbGYKCQkJCXgyIC0gKCBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLyAyICkgPCByICYmIC8vIExlZnQgSGFsZgoJCQkJdCA8IHkxICsgKCBkcmFnZ2FibGUuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC8gMiApICYmIC8vIEJvdHRvbSBIYWxmCgkJCQl5MiAtICggZHJhZ2dhYmxlLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAvIDIgKSA8IGIgKTsgLy8gVG9wIEhhbGYKCQljYXNlICJwb2ludGVyIjoKCQkJcmV0dXJuIGlzT3ZlckF4aXMoIGV2ZW50LnBhZ2VZLCB0LCBkcm9wcGFibGUucHJvcG9ydGlvbnMoKS5oZWlnaHQgKSAmJgoJCQkJaXNPdmVyQXhpcyggZXZlbnQucGFnZVgsIGwsIGRyb3BwYWJsZS5wcm9wb3J0aW9ucygpLndpZHRoICk7CgkJY2FzZSAidG91Y2giOgoJCQlyZXR1cm4gKAoJCQkJKCB5MSA+PSB0ICYmIHkxIDw9IGIgKSB8fCAvLyBUb3AgZWRnZSB0b3VjaGluZwoJCQkJKCB5MiA+PSB0ICYmIHkyIDw9IGIgKSB8fCAvLyBCb3R0b20gZWRnZSB0b3VjaGluZwoJCQkJKCB5MSA8IHQgJiYgeTIgPiBiICkgLy8gU3Vycm91bmRlZCB2ZXJ0aWNhbGx5CgkJCSkgJiYgKAoJCQkJKCB4MSA+PSBsICYmIHgxIDw9IHIgKSB8fCAvLyBMZWZ0IGVkZ2UgdG91Y2hpbmcKCQkJCSggeDIgPj0gbCAmJiB4MiA8PSByICkgfHwgLy8gUmlnaHQgZWRnZSB0b3VjaGluZwoJCQkJKCB4MSA8IGwgJiYgeDIgPiByICkgLy8gU3Vycm91bmRlZCBob3Jpem9udGFsbHkKCQkJKTsKCQlkZWZhdWx0OgoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfTsKfSApKCk7CgovKgoJVGhpcyBtYW5hZ2VyIHRyYWNrcyBvZmZzZXRzIG9mIGRyYWdnYWJsZXMgYW5kIGRyb3BwYWJsZXMKKi8KJC51aS5kZG1hbmFnZXIgPSB7CgljdXJyZW50OiBudWxsLAoJZHJvcHBhYmxlczogeyAiZGVmYXVsdCI6IFtdIH0sCglwcmVwYXJlT2Zmc2V0czogZnVuY3Rpb24oIHQsIGV2ZW50ICkgewoKCQl2YXIgaSwgaiwKCQkJbSA9ICQudWkuZGRtYW5hZ2VyLmRyb3BwYWJsZXNbIHQub3B0aW9ucy5zY29wZSBdIHx8IFtdLAoJCQl0eXBlID0gZXZlbnQgPyBldmVudC50eXBlIDogbnVsbCwgLy8gd29ya2Fyb3VuZCBmb3IgIzIzMTcKCQkJbGlzdCA9ICggdC5jdXJyZW50SXRlbSB8fCB0LmVsZW1lbnQgKS5maW5kKCAiOmRhdGEodWktZHJvcHBhYmxlKSIgKS5hZGRCYWNrKCk7CgoJCWRyb3BwYWJsZXNMb29wOiBmb3IgKCBpID0gMDsgaSA8IG0ubGVuZ3RoOyBpKysgKSB7CgoJCQkvLyBObyBkaXNhYmxlZCBhbmQgbm9uLWFjY2VwdGVkCgkJCWlmICggbVsgaSBdLm9wdGlvbnMuZGlzYWJsZWQgfHwgKCB0ICYmICFtWyBpIF0uYWNjZXB0LmNhbGwoIG1bIGkgXS5lbGVtZW50WyAwIF0sCgkJCQkJKCB0LmN1cnJlbnRJdGVtIHx8IHQuZWxlbWVudCApICkgKSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvLyBGaWx0ZXIgb3V0IGVsZW1lbnRzIGluIHRoZSBjdXJyZW50IGRyYWdnZWQgaXRlbQoJCQlmb3IgKCBqID0gMDsgaiA8IGxpc3QubGVuZ3RoOyBqKysgKSB7CgkJCQlpZiAoIGxpc3RbIGogXSA9PT0gbVsgaSBdLmVsZW1lbnRbIDAgXSApIHsKCQkJCQltWyBpIF0ucHJvcG9ydGlvbnMoKS5oZWlnaHQgPSAwOwoJCQkJCWNvbnRpbnVlIGRyb3BwYWJsZXNMb29wOwoJCQkJfQoJCQl9CgoJCQltWyBpIF0udmlzaWJsZSA9IG1bIGkgXS5lbGVtZW50LmNzcyggImRpc3BsYXkiICkgIT09ICJub25lIjsKCQkJaWYgKCAhbVsgaSBdLnZpc2libGUgKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJLy8gQWN0aXZhdGUgdGhlIGRyb3BwYWJsZSBpZiB1c2VkIGRpcmVjdGx5IGZyb20gZHJhZ2dhYmxlcwoJCQlpZiAoIHR5cGUgPT09ICJtb3VzZWRvd24iICkgewoJCQkJbVsgaSBdLl9hY3RpdmF0ZS5jYWxsKCBtWyBpIF0sIGV2ZW50ICk7CgkJCX0KCgkJCW1bIGkgXS5vZmZzZXQgPSBtWyBpIF0uZWxlbWVudC5vZmZzZXQoKTsKCQkJbVsgaSBdLnByb3BvcnRpb25zKCB7CgkJCQl3aWR0aDogbVsgaSBdLmVsZW1lbnRbIDAgXS5vZmZzZXRXaWR0aCwKCQkJCWhlaWdodDogbVsgaSBdLmVsZW1lbnRbIDAgXS5vZmZzZXRIZWlnaHQKCQkJfSApOwoKCQl9CgoJfSwKCWRyb3A6IGZ1bmN0aW9uKCBkcmFnZ2FibGUsIGV2ZW50ICkgewoKCQl2YXIgZHJvcHBlZCA9IGZhbHNlOwoKCQkvLyBDcmVhdGUgYSBjb3B5IG9mIHRoZSBkcm9wcGFibGVzIGluIGNhc2UgdGhlIGxpc3QgY2hhbmdlcyBkdXJpbmcgdGhlIGRyb3AgKCM5MTE2KQoJCSQuZWFjaCggKCAkLnVpLmRkbWFuYWdlci5kcm9wcGFibGVzWyBkcmFnZ2FibGUub3B0aW9ucy5zY29wZSBdIHx8IFtdICkuc2xpY2UoKSwgZnVuY3Rpb24oKSB7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAhdGhpcy5vcHRpb25zLmRpc2FibGVkICYmIHRoaXMudmlzaWJsZSAmJgoJCQkJCWludGVyc2VjdCggZHJhZ2dhYmxlLCB0aGlzLCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlLCBldmVudCApICkgewoJCQkJZHJvcHBlZCA9IHRoaXMuX2Ryb3AuY2FsbCggdGhpcywgZXZlbnQgKSB8fCBkcm9wcGVkOwoJCQl9CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZGlzYWJsZWQgJiYgdGhpcy52aXNpYmxlICYmIHRoaXMuYWNjZXB0LmNhbGwoIHRoaXMuZWxlbWVudFsgMCBdLAoJCQkJCSggZHJhZ2dhYmxlLmN1cnJlbnRJdGVtIHx8IGRyYWdnYWJsZS5lbGVtZW50ICkgKSApIHsKCQkJCXRoaXMuaXNvdXQgPSB0cnVlOwoJCQkJdGhpcy5pc292ZXIgPSBmYWxzZTsKCQkJCXRoaXMuX2RlYWN0aXZhdGUuY2FsbCggdGhpcywgZXZlbnQgKTsKCQkJfQoKCQl9ICk7CgkJcmV0dXJuIGRyb3BwZWQ7CgoJfSwKCWRyYWdTdGFydDogZnVuY3Rpb24oIGRyYWdnYWJsZSwgZXZlbnQgKSB7CgoJCS8vIExpc3RlbiBmb3Igc2Nyb2xsaW5nIHNvIHRoYXQgaWYgdGhlIGRyYWdnaW5nIGNhdXNlcyBzY3JvbGxpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZQoJCS8vIGRyb3BwYWJsZXMgY2FuIGJlIHJlY2FsY3VsYXRlZCAoc2VlICM1MDAzKQoJCWRyYWdnYWJsZS5lbGVtZW50LnBhcmVudHNVbnRpbCggImJvZHkiICkub24oICJzY3JvbGwuZHJvcHBhYmxlIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggIWRyYWdnYWJsZS5vcHRpb25zLnJlZnJlc2hQb3NpdGlvbnMgKSB7CgkJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggZHJhZ2dhYmxlLCBldmVudCApOwoJCQl9CgkJfSApOwoJfSwKCWRyYWc6IGZ1bmN0aW9uKCBkcmFnZ2FibGUsIGV2ZW50ICkgewoKCQkvLyBJZiB5b3UgaGF2ZSBhIGhpZ2hseSBkeW5hbWljIHBhZ2UsIHlvdSBtaWdodCB0cnkgdGhpcyBvcHRpb24uIEl0IHJlbmRlcnMgcG9zaXRpb25zCgkJLy8gZXZlcnkgdGltZSB5b3UgbW92ZSB0aGUgbW91c2UuCgkJaWYgKCBkcmFnZ2FibGUub3B0aW9ucy5yZWZyZXNoUG9zaXRpb25zICkgewoJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggZHJhZ2dhYmxlLCBldmVudCApOwoJCX0KCgkJLy8gUnVuIHRocm91Z2ggYWxsIGRyb3BwYWJsZXMgYW5kIGNoZWNrIHRoZWlyIHBvc2l0aW9ucyBiYXNlZCBvbiBzcGVjaWZpYyB0b2xlcmFuY2Ugb3B0aW9ucwoJCSQuZWFjaCggJC51aS5kZG1hbmFnZXIuZHJvcHBhYmxlc1sgZHJhZ2dhYmxlLm9wdGlvbnMuc2NvcGUgXSB8fCBbXSwgZnVuY3Rpb24oKSB7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmdyZWVkeUNoaWxkIHx8ICF0aGlzLnZpc2libGUgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBwYXJlbnRJbnN0YW5jZSwgc2NvcGUsIHBhcmVudCwKCQkJCWludGVyc2VjdHMgPSBpbnRlcnNlY3QoIGRyYWdnYWJsZSwgdGhpcywgdGhpcy5vcHRpb25zLnRvbGVyYW5jZSwgZXZlbnQgKSwKCQkJCWMgPSAhaW50ZXJzZWN0cyAmJiB0aGlzLmlzb3ZlciA\/CgkJCQkJImlzb3V0IiA6CgkJCQkJKCBpbnRlcnNlY3RzICYmICF0aGlzLmlzb3ZlciA\/ICJpc292ZXIiIDogbnVsbCApOwoJCQlpZiAoICFjICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5ncmVlZHkgKSB7CgoJCQkJLy8gZmluZCBkcm9wcGFibGUgcGFyZW50cyB3aXRoIHNhbWUgc2NvcGUKCQkJCXNjb3BlID0gdGhpcy5vcHRpb25zLnNjb3BlOwoJCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudHMoICI6ZGF0YSh1aS1kcm9wcGFibGUpIiApLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICQoIHRoaXMgKS5kcm9wcGFibGUoICJpbnN0YW5jZSIgKS5vcHRpb25zLnNjb3BlID09PSBzY29wZTsKCQkJCX0gKTsKCgkJCQlpZiAoIHBhcmVudC5sZW5ndGggKSB7CgkJCQkJcGFyZW50SW5zdGFuY2UgPSAkKCBwYXJlbnRbIDAgXSApLmRyb3BwYWJsZSggImluc3RhbmNlIiApOwoJCQkJCXBhcmVudEluc3RhbmNlLmdyZWVkeUNoaWxkID0gKCBjID09PSAiaXNvdmVyIiApOwoJCQkJfQoJCQl9CgoJCQkvLyBXZSBqdXN0IG1vdmVkIGludG8gYSBncmVlZHkgY2hpbGQKCQkJaWYgKCBwYXJlbnRJbnN0YW5jZSAmJiBjID09PSAiaXNvdmVyIiApIHsKCQkJCXBhcmVudEluc3RhbmNlLmlzb3ZlciA9IGZhbHNlOwoJCQkJcGFyZW50SW5zdGFuY2UuaXNvdXQgPSB0cnVlOwoJCQkJcGFyZW50SW5zdGFuY2UuX291dC5jYWxsKCBwYXJlbnRJbnN0YW5jZSwgZXZlbnQgKTsKCQkJfQoKCQkJdGhpc1sgYyBdID0gdHJ1ZTsKCQkJdGhpc1sgYyA9PT0gImlzb3V0IiA\/ICJpc292ZXIiIDogImlzb3V0IiBdID0gZmFsc2U7CgkJCXRoaXNbIGMgPT09ICJpc292ZXIiID8gIl9vdmVyIiA6ICJfb3V0IiBdLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgoJCQkvLyBXZSBqdXN0IG1vdmVkIG91dCBvZiBhIGdyZWVkeSBjaGlsZAoJCQlpZiAoIHBhcmVudEluc3RhbmNlICYmIGMgPT09ICJpc291dCIgKSB7CgkJCQlwYXJlbnRJbnN0YW5jZS5pc291dCA9IGZhbHNlOwoJCQkJcGFyZW50SW5zdGFuY2UuaXNvdmVyID0gdHJ1ZTsKCQkJCXBhcmVudEluc3RhbmNlLl9vdmVyLmNhbGwoIHBhcmVudEluc3RhbmNlLCBldmVudCApOwoJCQl9CgkJfSApOwoKCX0sCglkcmFnU3RvcDogZnVuY3Rpb24oIGRyYWdnYWJsZSwgZXZlbnQgKSB7CgkJZHJhZ2dhYmxlLmVsZW1lbnQucGFyZW50c1VudGlsKCAiYm9keSIgKS5vZmYoICJzY3JvbGwuZHJvcHBhYmxlIiApOwoKCQkvLyBDYWxsIHByZXBhcmVPZmZzZXRzIG9uZSBmaW5hbCB0aW1lIHNpbmNlIElFIGRvZXMgbm90IGZpcmUgcmV0dXJuIHNjcm9sbCBldmVudHMgd2hlbgoJCS8vIG92ZXJmbG93IHdhcyBjYXVzZWQgYnkgZHJhZyAoc2VlICM1MDAzKQoJCWlmICggIWRyYWdnYWJsZS5vcHRpb25zLnJlZnJlc2hQb3NpdGlvbnMgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLnByZXBhcmVPZmZzZXRzKCBkcmFnZ2FibGUsIGV2ZW50ICk7CgkJfQoJfQp9OwoKLy8gREVQUkVDQVRFRAovLyBUT0RPOiBzd2l0Y2ggcmV0dXJuIGJhY2sgdG8gd2lkZ2V0IGRlY2xhcmF0aW9uIGF0IHRvcCBvZiBmaWxlIHdoZW4gdGhpcyBpcyByZW1vdmVkCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgewoKCS8vIEJhY2tjb21wYXQgZm9yIGFjdGl2ZUNsYXNzIGFuZCBob3ZlckNsYXNzIG9wdGlvbnMKCSQud2lkZ2V0KCAidWkuZHJvcHBhYmxlIiwgJC51aS5kcm9wcGFibGUsIHsKCQlvcHRpb25zOiB7CgkJCWhvdmVyQ2xhc3M6IGZhbHNlLAoJCQlhY3RpdmVDbGFzczogZmFsc2UKCQl9LAoJCV9hZGRBY3RpdmVDbGFzczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCWlmICggdGhpcy5vcHRpb25zLmFjdGl2ZUNsYXNzICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuYWN0aXZlQ2xhc3MgKTsKCQkJfQoJCX0sCgkJX3JlbW92ZUFjdGl2ZUNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlQ2xhc3MgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIHRoaXMub3B0aW9ucy5hY3RpdmVDbGFzcyApOwoJCQl9CgkJfSwKCQlfYWRkSG92ZXJDbGFzczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCWlmICggdGhpcy5vcHRpb25zLmhvdmVyQ2xhc3MgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5ob3ZlckNsYXNzICk7CgkJCX0KCQl9LAoJCV9yZW1vdmVIb3ZlckNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuaG92ZXJDbGFzcyApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmhvdmVyQ2xhc3MgKTsKCQkJfQoJCX0KCX0gKTsKfQoKdmFyIHdpZGdldHNEcm9wcGFibGUgPSAkLnVpLmRyb3BwYWJsZTsKCgovKiEKICogalF1ZXJ5IFVJIFByb2dyZXNzYmFyIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogUHJvZ3Jlc3NiYXIKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vIGpzY3M6ZGlzYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZGVzY3JpcHRpb246IERpc3BsYXlzIGEgc3RhdHVzIGluZGljYXRvciBmb3IgbG9hZGluZyBzdGF0ZSwgc3RhbmRhcmQgcGVyY2VudGFnZSwgYW5kIG90aGVyIHByb2dyZXNzIGluZGljYXRvcnMuCi8vIGpzY3M6ZW5hYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9wcm9ncmVzc2Jhci8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3Byb2dyZXNzYmFyLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3Byb2dyZXNzYmFyLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKdmFyIHdpZGdldHNQcm9ncmVzc2JhciA9ICQud2lkZ2V0KCAidWkucHJvZ3Jlc3NiYXIiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCSJ1aS1wcm9ncmVzc2JhciI6ICJ1aS1jb3JuZXItYWxsIiwKCQkJInVpLXByb2dyZXNzYmFyLXZhbHVlIjogInVpLWNvcm5lci1sZWZ0IiwKCQkJInVpLXByb2dyZXNzYmFyLWNvbXBsZXRlIjogInVpLWNvcm5lci1yaWdodCIKCQl9LAoJCW1heDogMTAwLAoJCXZhbHVlOiAwLAoKCQljaGFuZ2U6IG51bGwsCgkJY29tcGxldGU6IG51bGwKCX0sCgoJbWluOiAwLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBDb25zdHJhaW4gaW5pdGlhbCB2YWx1ZQoJCXRoaXMub2xkVmFsdWUgPSB0aGlzLm9wdGlvbnMudmFsdWUgPSB0aGlzLl9jb25zdHJhaW5lZFZhbHVlKCk7CgoJCXRoaXMuZWxlbWVudC5hdHRyKCB7CgoJCQkvLyBPbmx5IHNldCBzdGF0aWMgdmFsdWVzOyBhcmlhLXZhbHVlbm93IGFuZCBhcmlhLXZhbHVlbWF4IGFyZQoJCQkvLyBzZXQgaW5zaWRlIF9yZWZyZXNoVmFsdWUoKQoJCQlyb2xlOiAicHJvZ3Jlc3NiYXIiLAoJCQkiYXJpYS12YWx1ZW1pbiI6IHRoaXMubWluCgkJfSApOwoJCXRoaXMuX2FkZENsYXNzKCAidWktcHJvZ3Jlc3NiYXIiLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IiApOwoKCQl0aGlzLnZhbHVlRGl2ID0gJCggIjxkaXY+IiApLmFwcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy52YWx1ZURpdiwgInVpLXByb2dyZXNzYmFyLXZhbHVlIiwgInVpLXdpZGdldC1oZWFkZXIiICk7CgkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQXR0ciggInJvbGUgYXJpYS12YWx1ZW1pbiBhcmlhLXZhbHVlbWF4IGFyaWEtdmFsdWVub3ciICk7CgoJCXRoaXMudmFsdWVEaXYucmVtb3ZlKCk7Cgl9LAoKCXZhbHVlOiBmdW5jdGlvbiggbmV3VmFsdWUgKSB7CgkJaWYgKCBuZXdWYWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdGhpcy5vcHRpb25zLnZhbHVlOwoJCX0KCgkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fY29uc3RyYWluZWRWYWx1ZSggbmV3VmFsdWUgKTsKCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCX0sCgoJX2NvbnN0cmFpbmVkVmFsdWU6IGZ1bmN0aW9uKCBuZXdWYWx1ZSApIHsKCQlpZiAoIG5ld1ZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCW5ld1ZhbHVlID0gdGhpcy5vcHRpb25zLnZhbHVlOwoJCX0KCgkJdGhpcy5pbmRldGVybWluYXRlID0gbmV3VmFsdWUgPT09IGZhbHNlOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWlmICggdHlwZW9mIG5ld1ZhbHVlICE9PSAibnVtYmVyIiApIHsKCQkJbmV3VmFsdWUgPSAwOwoJCX0KCgkJcmV0dXJuIHRoaXMuaW5kZXRlcm1pbmF0ZSA\/IGZhbHNlIDoKCQkJTWF0aC5taW4oIHRoaXMub3B0aW9ucy5tYXgsIE1hdGgubWF4KCB0aGlzLm1pbiwgbmV3VmFsdWUgKSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJCS8vIEVuc3VyZSAidmFsdWUiIG9wdGlvbiBpcyBzZXQgYWZ0ZXIgb3RoZXIgdmFsdWVzIChsaWtlIG1heCkKCQl2YXIgdmFsdWUgPSBvcHRpb25zLnZhbHVlOwoJCWRlbGV0ZSBvcHRpb25zLnZhbHVlOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQl0aGlzLm9wdGlvbnMudmFsdWUgPSB0aGlzLl9jb25zdHJhaW5lZFZhbHVlKCB2YWx1ZSApOwoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gIm1heCIgKSB7CgoJCQkvLyBEb24ndCBhbGxvdyBhIG1heCBsZXNzIHRoYW4gbWluCgkJCXZhbHVlID0gTWF0aC5tYXgoIHRoaXMubWluLCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlciggdmFsdWUgKTsKCgkJdGhpcy5lbGVtZW50LmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLl90b2dnbGVDbGFzcyggbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJfSwKCglfcGVyY2VudGFnZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuaW5kZXRlcm1pbmF0ZSA\/CgkJCTEwMCA6CgkJCTEwMCAqICggdGhpcy5vcHRpb25zLnZhbHVlIC0gdGhpcy5taW4gKSAvICggdGhpcy5vcHRpb25zLm1heCAtIHRoaXMubWluICk7Cgl9LAoKCV9yZWZyZXNoVmFsdWU6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy52YWx1ZSwKCQkJcGVyY2VudGFnZSA9IHRoaXMuX3BlcmNlbnRhZ2UoKTsKCgkJdGhpcy52YWx1ZURpdgoJCQkudG9nZ2xlKCB0aGlzLmluZGV0ZXJtaW5hdGUgfHwgdmFsdWUgPiB0aGlzLm1pbiApCgkJCS53aWR0aCggcGVyY2VudGFnZS50b0ZpeGVkKCAwICkgKyAiJSIgKTsKCgkJdGhpcwoJCQkuX3RvZ2dsZUNsYXNzKCB0aGlzLnZhbHVlRGl2LCAidWktcHJvZ3Jlc3NiYXItY29tcGxldGUiLCBudWxsLAoJCQkJdmFsdWUgPT09IHRoaXMub3B0aW9ucy5tYXggKQoJCQkuX3RvZ2dsZUNsYXNzKCAidWktcHJvZ3Jlc3NiYXItaW5kZXRlcm1pbmF0ZSIsIG51bGwsIHRoaXMuaW5kZXRlcm1pbmF0ZSApOwoKCQlpZiAoIHRoaXMuaW5kZXRlcm1pbmF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJhcmlhLXZhbHVlbm93IiApOwoJCQlpZiAoICF0aGlzLm92ZXJsYXlEaXYgKSB7CgkJCQl0aGlzLm92ZXJsYXlEaXYgPSAkKCAiPGRpdj4iICkuYXBwZW5kVG8oIHRoaXMudmFsdWVEaXYgKTsKCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLm92ZXJsYXlEaXYsICJ1aS1wcm9ncmVzc2Jhci1vdmVybGF5IiApOwoJCQl9CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoIHsKCQkJCSJhcmlhLXZhbHVlbWF4IjogdGhpcy5vcHRpb25zLm1heCwKCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsdWUKCQkJfSApOwoJCQlpZiAoIHRoaXMub3ZlcmxheURpdiApIHsKCQkJCXRoaXMub3ZlcmxheURpdi5yZW1vdmUoKTsKCQkJCXRoaXMub3ZlcmxheURpdiA9IG51bGw7CgkJCX0KCQl9CgoJCWlmICggdGhpcy5vbGRWYWx1ZSAhPT0gdmFsdWUgKSB7CgkJCXRoaXMub2xkVmFsdWUgPSB2YWx1ZTsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIgKTsKCQl9CgkJaWYgKCB2YWx1ZSA9PT0gdGhpcy5vcHRpb25zLm1heCApIHsKCQkJdGhpcy5fdHJpZ2dlciggImNvbXBsZXRlIiApOwoJCX0KCX0KfSApOwoKCi8qIQogKiBqUXVlcnkgVUkgU2VsZWN0YWJsZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNlbGVjdGFibGUKLy8+Pmdyb3VwOiBJbnRlcmFjdGlvbnMKLy8+PmRlc2NyaXB0aW9uOiBBbGxvd3MgZ3JvdXBzIG9mIGVsZW1lbnRzIHRvIGJlIHNlbGVjdGVkIHdpdGggdGhlIG1vdXNlLgovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2VsZWN0YWJsZS8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3NlbGVjdGFibGUvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9zZWxlY3RhYmxlLmNzcwoKCgp2YXIgd2lkZ2V0c1NlbGVjdGFibGUgPSAkLndpZGdldCggInVpLnNlbGVjdGFibGUiLCAkLnVpLm1vdXNlLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCW9wdGlvbnM6IHsKCQlhcHBlbmRUbzogImJvZHkiLAoJCWF1dG9SZWZyZXNoOiB0cnVlLAoJCWRpc3RhbmNlOiAwLAoJCWZpbHRlcjogIioiLAoJCXRvbGVyYW5jZTogInRvdWNoIiwKCgkJLy8gQ2FsbGJhY2tzCgkJc2VsZWN0ZWQ6IG51bGwsCgkJc2VsZWN0aW5nOiBudWxsLAoJCXN0YXJ0OiBudWxsLAoJCXN0b3A6IG51bGwsCgkJdW5zZWxlY3RlZDogbnVsbCwKCQl1bnNlbGVjdGluZzogbnVsbAoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1zZWxlY3RhYmxlIiApOwoKCQl0aGlzLmRyYWdnZWQgPSBmYWxzZTsKCgkJLy8gQ2FjaGUgc2VsZWN0ZWUgY2hpbGRyZW4gYmFzZWQgb24gZmlsdGVyCgkJdGhpcy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7CgkJCXRoYXQuZWxlbWVudFBvcyA9ICQoIHRoYXQuZWxlbWVudFsgMCBdICkub2Zmc2V0KCk7CgkJCXRoYXQuc2VsZWN0ZWVzID0gJCggdGhhdC5vcHRpb25zLmZpbHRlciwgdGhhdC5lbGVtZW50WyAwIF0gKTsKCQkJdGhhdC5fYWRkQ2xhc3MoIHRoYXQuc2VsZWN0ZWVzLCAidWktc2VsZWN0ZWUiICk7CgkJCXRoYXQuc2VsZWN0ZWVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCXNlbGVjdGVlT2Zmc2V0ID0gJHRoaXMub2Zmc2V0KCksCgkJCQkJcG9zID0gewoJCQkJCQlsZWZ0OiBzZWxlY3RlZU9mZnNldC5sZWZ0IC0gdGhhdC5lbGVtZW50UG9zLmxlZnQsCgkJCQkJCXRvcDogc2VsZWN0ZWVPZmZzZXQudG9wIC0gdGhhdC5lbGVtZW50UG9zLnRvcAoJCQkJCX07CgkJCQkkLmRhdGEoIHRoaXMsICJzZWxlY3RhYmxlLWl0ZW0iLCB7CgkJCQkJZWxlbWVudDogdGhpcywKCQkJCQkkZWxlbWVudDogJHRoaXMsCgkJCQkJbGVmdDogcG9zLmxlZnQsCgkJCQkJdG9wOiBwb3MudG9wLAoJCQkJCXJpZ2h0OiBwb3MubGVmdCArICR0aGlzLm91dGVyV2lkdGgoKSwKCQkJCQlib3R0b206IHBvcy50b3AgKyAkdGhpcy5vdXRlckhlaWdodCgpLAoJCQkJCXN0YXJ0c2VsZWN0ZWQ6IGZhbHNlLAoJCQkJCXNlbGVjdGVkOiAkdGhpcy5oYXNDbGFzcyggInVpLXNlbGVjdGVkIiApLAoJCQkJCXNlbGVjdGluZzogJHRoaXMuaGFzQ2xhc3MoICJ1aS1zZWxlY3RpbmciICksCgkJCQkJdW5zZWxlY3Rpbmc6ICR0aGlzLmhhc0NsYXNzKCAidWktdW5zZWxlY3RpbmciICkKCQkJCX0gKTsKCQkJfSApOwoJCX07CgkJdGhpcy5yZWZyZXNoKCk7CgoJCXRoaXMuX21vdXNlSW5pdCgpOwoKCQl0aGlzLmhlbHBlciA9ICQoICI8ZGl2PiIgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5oZWxwZXIsICJ1aS1zZWxlY3RhYmxlLWhlbHBlciIgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2VsZWN0ZWVzLnJlbW92ZURhdGEoICJzZWxlY3RhYmxlLWl0ZW0iICk7CgkJdGhpcy5fbW91c2VEZXN0cm95KCk7Cgl9LAoKCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLm9wb3MgPSBbIGV2ZW50LnBhZ2VYLCBldmVudC5wYWdlWSBdOwoJCXRoaXMuZWxlbWVudFBvcyA9ICQoIHRoaXMuZWxlbWVudFsgMCBdICkub2Zmc2V0KCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLnNlbGVjdGVlcyA9ICQoIG9wdGlvbnMuZmlsdGVyLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiLCBldmVudCApOwoKCQkkKCBvcHRpb25zLmFwcGVuZFRvICkuYXBwZW5kKCB0aGlzLmhlbHBlciApOwoKCQkvLyBwb3NpdGlvbiBoZWxwZXIgKGxhc3NvKQoJCXRoaXMuaGVscGVyLmNzcyggewoJCQkibGVmdCI6IGV2ZW50LnBhZ2VYLAoJCQkidG9wIjogZXZlbnQucGFnZVksCgkJCSJ3aWR0aCI6IDAsCgkJCSJoZWlnaHQiOiAwCgkJfSApOwoKCQlpZiAoIG9wdGlvbnMuYXV0b1JlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJdGhpcy5zZWxlY3RlZXMuZmlsdGVyKCAiLnVpLXNlbGVjdGVkIiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZWN0ZWUgPSAkLmRhdGEoIHRoaXMsICJzZWxlY3RhYmxlLWl0ZW0iICk7CgkJCXNlbGVjdGVlLnN0YXJ0c2VsZWN0ZWQgPSB0cnVlOwoJCQlpZiAoICFldmVudC5tZXRhS2V5ICYmICFldmVudC5jdHJsS2V5ICkgewoJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0ZWQiICk7CgkJCQlzZWxlY3RlZS5zZWxlY3RlZCA9IGZhbHNlOwoJCQkJdGhhdC5fYWRkQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktdW5zZWxlY3RpbmciICk7CgkJCQlzZWxlY3RlZS51bnNlbGVjdGluZyA9IHRydWU7CgoJCQkJLy8gc2VsZWN0YWJsZSBVTlNFTEVDVElORyBjYWxsYmFjawoJCQkJdGhhdC5fdHJpZ2dlciggInVuc2VsZWN0aW5nIiwgZXZlbnQsIHsKCQkJCQl1bnNlbGVjdGluZzogc2VsZWN0ZWUuZWxlbWVudAoJCQkJfSApOwoJCQl9CgkJfSApOwoKCQkkKCBldmVudC50YXJnZXQgKS5wYXJlbnRzKCkuYWRkQmFjaygpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgZG9TZWxlY3QsCgkJCQlzZWxlY3RlZSA9ICQuZGF0YSggdGhpcywgInNlbGVjdGFibGUtaXRlbSIgKTsKCQkJaWYgKCBzZWxlY3RlZSApIHsKCQkJCWRvU2VsZWN0ID0gKCAhZXZlbnQubWV0YUtleSAmJiAhZXZlbnQuY3RybEtleSApIHx8CgkJCQkJIXNlbGVjdGVlLiRlbGVtZW50Lmhhc0NsYXNzKCAidWktc2VsZWN0ZWQiICk7CgkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsIGRvU2VsZWN0ID8gInVpLXVuc2VsZWN0aW5nIiA6ICJ1aS1zZWxlY3RlZCIgKQoJCQkJCS5fYWRkQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCBkb1NlbGVjdCA\/ICJ1aS1zZWxlY3RpbmciIDogInVpLXVuc2VsZWN0aW5nIiApOwoJCQkJc2VsZWN0ZWUudW5zZWxlY3RpbmcgPSAhZG9TZWxlY3Q7CgkJCQlzZWxlY3RlZS5zZWxlY3RpbmcgPSBkb1NlbGVjdDsKCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gZG9TZWxlY3Q7CgoJCQkJLy8gc2VsZWN0YWJsZSAoVU4pU0VMRUNUSU5HIGNhbGxiYWNrCgkJCQlpZiAoIGRvU2VsZWN0ICkgewoJCQkJCXRoYXQuX3RyaWdnZXIoICJzZWxlY3RpbmciLCBldmVudCwgewoJCQkJCQlzZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQKCQkJCQl9ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoYXQuX3RyaWdnZXIoICJ1bnNlbGVjdGluZyIsIGV2ZW50LCB7CgkJCQkJCXVuc2VsZWN0aW5nOiBzZWxlY3RlZS5lbGVtZW50CgkJCQkJfSApOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSApOwoKCX0sCgoJX21vdXNlRHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl0aGlzLmRyYWdnZWQgPSB0cnVlOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHRtcCwKCQkJdGhhdCA9IHRoaXMsCgkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCXgxID0gdGhpcy5vcG9zWyAwIF0sCgkJCXkxID0gdGhpcy5vcG9zWyAxIF0sCgkJCXgyID0gZXZlbnQucGFnZVgsCgkJCXkyID0gZXZlbnQucGFnZVk7CgoJCWlmICggeDEgPiB4MiApIHsgdG1wID0geDI7IHgyID0geDE7IHgxID0gdG1wOyB9CgkJaWYgKCB5MSA+IHkyICkgeyB0bXAgPSB5MjsgeTIgPSB5MTsgeTEgPSB0bXA7IH0KCQl0aGlzLmhlbHBlci5jc3MoIHsgbGVmdDogeDEsIHRvcDogeTEsIHdpZHRoOiB4MiAtIHgxLCBoZWlnaHQ6IHkyIC0geTEgfSApOwoKCQl0aGlzLnNlbGVjdGVlcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGVjdGVlID0gJC5kYXRhKCB0aGlzLCAic2VsZWN0YWJsZS1pdGVtIiApLAoJCQkJaGl0ID0gZmFsc2UsCgkJCQlvZmZzZXQgPSB7fTsKCgkJCS8vcHJldmVudCBoZWxwZXIgZnJvbSBiZWluZyBzZWxlY3RlZCBpZiBhcHBlbmRUbzogc2VsZWN0YWJsZQoJCQlpZiAoICFzZWxlY3RlZSB8fCBzZWxlY3RlZS5lbGVtZW50ID09PSB0aGF0LmVsZW1lbnRbIDAgXSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJb2Zmc2V0LmxlZnQgICA9IHNlbGVjdGVlLmxlZnQgICArIHRoYXQuZWxlbWVudFBvcy5sZWZ0OwoJCQlvZmZzZXQucmlnaHQgID0gc2VsZWN0ZWUucmlnaHQgICsgdGhhdC5lbGVtZW50UG9zLmxlZnQ7CgkJCW9mZnNldC50b3AgICAgPSBzZWxlY3RlZS50b3AgICAgKyB0aGF0LmVsZW1lbnRQb3MudG9wOwoJCQlvZmZzZXQuYm90dG9tID0gc2VsZWN0ZWUuYm90dG9tICsgdGhhdC5lbGVtZW50UG9zLnRvcDsKCgkJCWlmICggb3B0aW9ucy50b2xlcmFuY2UgPT09ICJ0b3VjaCIgKSB7CgkJCQloaXQgPSAoICEoIG9mZnNldC5sZWZ0ID4geDIgfHwgb2Zmc2V0LnJpZ2h0IDwgeDEgfHwgb2Zmc2V0LnRvcCA+IHkyIHx8CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0LmJvdHRvbSA8IHkxICkgKTsKCQkJfSBlbHNlIGlmICggb3B0aW9ucy50b2xlcmFuY2UgPT09ICJmaXQiICkgewoJCQkJaGl0ID0gKCBvZmZzZXQubGVmdCA+IHgxICYmIG9mZnNldC5yaWdodCA8IHgyICYmIG9mZnNldC50b3AgPiB5MSAmJgogICAgICAgICAgICAgICAgICAgIG9mZnNldC5ib3R0b20gPCB5MiApOwoJCQl9CgoJCQlpZiAoIGhpdCApIHsKCgkJCQkvLyBTRUxFQ1QKCQkJCWlmICggc2VsZWN0ZWUuc2VsZWN0ZWQgKSB7CgkJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0ZWQiICk7CgkJCQkJc2VsZWN0ZWUuc2VsZWN0ZWQgPSBmYWxzZTsKCQkJCX0KCQkJCWlmICggc2VsZWN0ZWUudW5zZWxlY3RpbmcgKSB7CgkJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktdW5zZWxlY3RpbmciICk7CgkJCQkJc2VsZWN0ZWUudW5zZWxlY3RpbmcgPSBmYWxzZTsKCQkJCX0KCQkJCWlmICggIXNlbGVjdGVlLnNlbGVjdGluZyApIHsKCQkJCQl0aGF0Ll9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RpbmciICk7CgkJCQkJc2VsZWN0ZWUuc2VsZWN0aW5nID0gdHJ1ZTsKCgkJCQkJLy8gc2VsZWN0YWJsZSBTRUxFQ1RJTkcgY2FsbGJhY2sKCQkJCQl0aGF0Ll90cmlnZ2VyKCAic2VsZWN0aW5nIiwgZXZlbnQsIHsKCQkJCQkJc2VsZWN0aW5nOiBzZWxlY3RlZS5lbGVtZW50CgkJCQkJfSApOwoJCQkJfQoJCQl9IGVsc2UgewoKCQkJCS8vIFVOU0VMRUNUCgkJCQlpZiAoIHNlbGVjdGVlLnNlbGVjdGluZyApIHsKCQkJCQlpZiAoICggZXZlbnQubWV0YUtleSB8fCBldmVudC5jdHJsS2V5ICkgJiYgc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCApIHsKCQkJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0aW5nIiApOwoJCQkJCQlzZWxlY3RlZS5zZWxlY3RpbmcgPSBmYWxzZTsKCQkJCQkJdGhhdC5fYWRkQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0ZWQiICk7CgkJCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gdHJ1ZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RpbmciICk7CgkJCQkJCXNlbGVjdGVlLnNlbGVjdGluZyA9IGZhbHNlOwoJCQkJCQlpZiAoIHNlbGVjdGVlLnN0YXJ0c2VsZWN0ZWQgKSB7CgkJCQkJCQl0aGF0Ll9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS11bnNlbGVjdGluZyIgKTsKCQkJCQkJCXNlbGVjdGVlLnVuc2VsZWN0aW5nID0gdHJ1ZTsKCQkJCQkJfQoKCQkJCQkJLy8gc2VsZWN0YWJsZSBVTlNFTEVDVElORyBjYWxsYmFjawoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAidW5zZWxlY3RpbmciLCBldmVudCwgewoJCQkJCQkJdW5zZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQKCQkJCQkJfSApOwoJCQkJCX0KCQkJCX0KCQkJCWlmICggc2VsZWN0ZWUuc2VsZWN0ZWQgKSB7CgkJCQkJaWYgKCAhZXZlbnQubWV0YUtleSAmJiAhZXZlbnQuY3RybEtleSAmJiAhc2VsZWN0ZWUuc3RhcnRzZWxlY3RlZCApIHsKCQkJCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0ZWQiICk7CgkJCQkJCXNlbGVjdGVlLnNlbGVjdGVkID0gZmFsc2U7CgoJCQkJCQl0aGF0Ll9hZGRDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS11bnNlbGVjdGluZyIgKTsKCQkJCQkJc2VsZWN0ZWUudW5zZWxlY3RpbmcgPSB0cnVlOwoKCQkJCQkJLy8gc2VsZWN0YWJsZSBVTlNFTEVDVElORyBjYWxsYmFjawoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAidW5zZWxlY3RpbmciLCBldmVudCwgewoJCQkJCQkJdW5zZWxlY3Rpbmc6IHNlbGVjdGVlLmVsZW1lbnQKCQkJCQkJfSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0gKTsKCgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfbW91c2VTdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLmRyYWdnZWQgPSBmYWxzZTsKCgkJJCggIi51aS11bnNlbGVjdGluZyIsIHRoaXMuZWxlbWVudFsgMCBdICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxlY3RlZSA9ICQuZGF0YSggdGhpcywgInNlbGVjdGFibGUtaXRlbSIgKTsKCQkJdGhhdC5fcmVtb3ZlQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktdW5zZWxlY3RpbmciICk7CgkJCXNlbGVjdGVlLnVuc2VsZWN0aW5nID0gZmFsc2U7CgkJCXNlbGVjdGVlLnN0YXJ0c2VsZWN0ZWQgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggInVuc2VsZWN0ZWQiLCBldmVudCwgewoJCQkJdW5zZWxlY3RlZDogc2VsZWN0ZWUuZWxlbWVudAoJCQl9ICk7CgkJfSApOwoJCSQoICIudWktc2VsZWN0aW5nIiwgdGhpcy5lbGVtZW50WyAwIF0gKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGVjdGVlID0gJC5kYXRhKCB0aGlzLCAic2VsZWN0YWJsZS1pdGVtIiApOwoJCQl0aGF0Ll9yZW1vdmVDbGFzcyggc2VsZWN0ZWUuJGVsZW1lbnQsICJ1aS1zZWxlY3RpbmciICkKCQkJCS5fYWRkQ2xhc3MoIHNlbGVjdGVlLiRlbGVtZW50LCAidWktc2VsZWN0ZWQiICk7CgkJCXNlbGVjdGVlLnNlbGVjdGluZyA9IGZhbHNlOwoJCQlzZWxlY3RlZS5zZWxlY3RlZCA9IHRydWU7CgkJCXNlbGVjdGVlLnN0YXJ0c2VsZWN0ZWQgPSB0cnVlOwoJCQl0aGF0Ll90cmlnZ2VyKCAic2VsZWN0ZWQiLCBldmVudCwgewoJCQkJc2VsZWN0ZWQ6IHNlbGVjdGVlLmVsZW1lbnQKCQkJfSApOwoJCX0gKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50ICk7CgoJCXRoaXMuaGVscGVyLnJlbW92ZSgpOwoKCQlyZXR1cm4gZmFsc2U7Cgl9Cgp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBTZWxlY3RtZW51IDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogU2VsZWN0bWVudQovLz4+Z3JvdXA6IFdpZGdldHMKLy8ganNjczpkaXNhYmxlIG1heGltdW1MaW5lTGVuZ3RoCi8vPj5kZXNjcmlwdGlvbjogRHVwbGljYXRlcyBhbmQgZXh0ZW5kcyB0aGUgZnVuY3Rpb25hbGl0eSBvZiBhIG5hdGl2ZSBIVE1MIHNlbGVjdCBlbGVtZW50LCBhbGxvd2luZyBpdCB0byBiZSBjdXN0b21pemFibGUgaW4gYmVoYXZpb3IgYW5kIGFwcGVhcmFuY2UgZmFyIGJleW9uZCB0aGUgbGltaXRhdGlvbnMgb2YgYSBuYXRpdmUgc2VsZWN0LgovLyBqc2NzOmVuYWJsZSBtYXhpbXVtTGluZUxlbmd0aAovLz4+ZG9jczogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vc2VsZWN0bWVudS8KLy8+PmRlbW9zOiBodHRwOi8vanF1ZXJ5dWkuY29tL3NlbGVjdG1lbnUvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2Uvc2VsZWN0bWVudS5jc3MsIC4uLy4uL3RoZW1lcy9iYXNlL2J1dHRvbi5jc3MKLy8+PmNzcy50aGVtZTogLi4vLi4vdGhlbWVzL2Jhc2UvdGhlbWUuY3NzCgoKCnZhciB3aWRnZXRzU2VsZWN0bWVudSA9ICQud2lkZ2V0KCAidWkuc2VsZWN0bWVudSIsIFsgJC51aS5mb3JtUmVzZXRNaXhpbiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglkZWZhdWx0RWxlbWVudDogIjxzZWxlY3Q+IiwKCW9wdGlvbnM6IHsKCQlhcHBlbmRUbzogbnVsbCwKCQljbGFzc2VzOiB7CgkJCSJ1aS1zZWxlY3RtZW51LWJ1dHRvbi1vcGVuIjogInVpLWNvcm5lci10b3AiLAoJCQkidWktc2VsZWN0bWVudS1idXR0b24tY2xvc2VkIjogInVpLWNvcm5lci1hbGwiCgkJfSwKCQlkaXNhYmxlZDogbnVsbCwKCQlpY29uczogewoJCQlidXR0b246ICJ1aS1pY29uLXRyaWFuZ2xlLTEtcyIKCQl9LAoJCXBvc2l0aW9uOiB7CgkJCW15OiAibGVmdCB0b3AiLAoJCQlhdDogImxlZnQgYm90dG9tIiwKCQkJY29sbGlzaW9uOiAibm9uZSIKCQl9LAoJCXdpZHRoOiBmYWxzZSwKCgkJLy8gQ2FsbGJhY2tzCgkJY2hhbmdlOiBudWxsLAoJCWNsb3NlOiBudWxsLAoJCWZvY3VzOiBudWxsLAoJCW9wZW46IG51bGwsCgkJc2VsZWN0OiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RtZW51SWQgPSB0aGlzLmVsZW1lbnQudW5pcXVlSWQoKS5hdHRyKCAiaWQiICk7CgkJdGhpcy5pZHMgPSB7CgkJCWVsZW1lbnQ6IHNlbGVjdG1lbnVJZCwKCQkJYnV0dG9uOiBzZWxlY3RtZW51SWQgKyAiLWJ1dHRvbiIsCgkJCW1lbnU6IHNlbGVjdG1lbnVJZCArICItbWVudSIKCQl9OwoKCQl0aGlzLl9kcmF3QnV0dG9uKCk7CgkJdGhpcy5fZHJhd01lbnUoKTsKCQl0aGlzLl9iaW5kRm9ybVJlc2V0SGFuZGxlcigpOwoKCQl0aGlzLl9yZW5kZXJlZCA9IGZhbHNlOwoJCXRoaXMubWVudUl0ZW1zID0gJCgpOwoJfSwKCglfZHJhd0J1dHRvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGljb24sCgkJCXRoYXQgPSB0aGlzLAoJCQlpdGVtID0gdGhpcy5fcGFyc2VPcHRpb24oCgkJCQl0aGlzLmVsZW1lbnQuZmluZCggIm9wdGlvbjpzZWxlY3RlZCIgKSwKCQkJCXRoaXMuZWxlbWVudFsgMCBdLnNlbGVjdGVkSW5kZXgKCQkJKTsKCgkJLy8gQXNzb2NpYXRlIGV4aXN0aW5nIGxhYmVsIHdpdGggdGhlIG5ldyBidXR0b24KCQl0aGlzLmxhYmVscyA9IHRoaXMuZWxlbWVudC5sYWJlbHMoKS5hdHRyKCAiZm9yIiwgdGhpcy5pZHMuYnV0dG9uICk7CgkJdGhpcy5fb24oIHRoaXMubGFiZWxzLCB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLmJ1dHRvbi5mb2N1cygpOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0gKTsKCgkJLy8gSGlkZSBvcmlnaW5hbCBzZWxlY3QgZWxlbWVudAoJCXRoaXMuZWxlbWVudC5oaWRlKCk7CgoJCS8vIENyZWF0ZSBidXR0b24KCQl0aGlzLmJ1dHRvbiA9ICQoICI8c3Bhbj4iLCB7CgkJCXRhYmluZGV4OiB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPyAtMSA6IDAsCgkJCWlkOiB0aGlzLmlkcy5idXR0b24sCgkJCXJvbGU6ICJjb21ib2JveCIsCgkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJImFyaWEtYXV0b2NvbXBsZXRlIjogImxpc3QiLAoJCQkiYXJpYS1vd25zIjogdGhpcy5pZHMubWVudSwKCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgkJCXRpdGxlOiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApCgkJfSApCgkJCS5pbnNlcnRBZnRlciggdGhpcy5lbGVtZW50ICk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmJ1dHRvbiwgInVpLXNlbGVjdG1lbnUtYnV0dG9uIHVpLXNlbGVjdG1lbnUtYnV0dG9uLWNsb3NlZCIsCgkJCSJ1aS1idXR0b24gdWktd2lkZ2V0IiApOwoKCQlpY29uID0gJCggIjxzcGFuPiIgKS5hcHBlbmRUbyggdGhpcy5idXR0b24gKTsKCQl0aGlzLl9hZGRDbGFzcyggaWNvbiwgInVpLXNlbGVjdG1lbnUtaWNvbiIsICJ1aS1pY29uICIgKyB0aGlzLm9wdGlvbnMuaWNvbnMuYnV0dG9uICk7CgkJdGhpcy5idXR0b25JdGVtID0gdGhpcy5fcmVuZGVyQnV0dG9uSXRlbSggaXRlbSApCgkJCS5hcHBlbmRUbyggdGhpcy5idXR0b24gKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMud2lkdGggIT09IGZhbHNlICkgewoJCQl0aGlzLl9yZXNpemVCdXR0b24oKTsKCQl9CgoJCXRoaXMuX29uKCB0aGlzLmJ1dHRvbiwgdGhpcy5fYnV0dG9uRXZlbnRzICk7CgkJdGhpcy5idXR0b24ub25lKCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCkgewoKCQkJLy8gRGVsYXkgcmVuZGVyaW5nIHRoZSBtZW51IGl0ZW1zIHVudGlsIHRoZSBidXR0b24gcmVjZWl2ZXMgZm9jdXMuCgkJCS8vIFRoZSBtZW51IG1heSBoYXZlIGFscmVhZHkgYmVlbiByZW5kZXJlZCB2aWEgYSBwcm9ncmFtbWF0aWMgb3Blbi4KCQkJaWYgKCAhdGhhdC5fcmVuZGVyZWQgKSB7CgkJCQl0aGF0Ll9yZWZyZXNoTWVudSgpOwoJCQl9CgkJfSApOwoJfSwKCglfZHJhd01lbnU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJLy8gQ3JlYXRlIG1lbnUKCQl0aGlzLm1lbnUgPSAkKCAiPHVsPiIsIHsKCQkJImFyaWEtaGlkZGVuIjogInRydWUiLAoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogdGhpcy5pZHMuYnV0dG9uLAoJCQlpZDogdGhpcy5pZHMubWVudQoJCX0gKTsKCgkJLy8gV3JhcCBtZW51CgkJdGhpcy5tZW51V3JhcCA9ICQoICI8ZGl2PiIgKS5hcHBlbmQoIHRoaXMubWVudSApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLm1lbnVXcmFwLCAidWktc2VsZWN0bWVudS1tZW51IiwgInVpLWZyb250IiApOwoJCXRoaXMubWVudVdyYXAuYXBwZW5kVG8oIHRoaXMuX2FwcGVuZFRvKCkgKTsKCgkJLy8gSW5pdGlhbGl6ZSBtZW51IHdpZGdldAoJCXRoaXMubWVudUluc3RhbmNlID0gdGhpcy5tZW51CgkJCS5tZW51KCB7CgkJCQljbGFzc2VzOiB7CgkJCQkJInVpLW1lbnUiOiAidWktY29ybmVyLWJvdHRvbSIKCQkJCX0sCgkJCQlyb2xlOiAibGlzdGJveCIsCgkJCQlzZWxlY3Q6IGZ1bmN0aW9uKCBldmVudCwgdWkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQkJLy8gU3VwcG9ydDogSUU4CgkJCQkJLy8gSWYgdGhlIGl0ZW0gd2FzIHNlbGVjdGVkIHZpYSBhIGNsaWNrLCB0aGUgdGV4dCBzZWxlY3Rpb24KCQkJCQkvLyB3aWxsIGJlIGRlc3Ryb3llZCBpbiBJRQoJCQkJCXRoYXQuX3NldFNlbGVjdGlvbigpOwoKCQkJCQl0aGF0Ll9zZWxlY3QoIHVpLml0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKSwgZXZlbnQgKTsKCQkJCX0sCgkJCQlmb2N1czogZnVuY3Rpb24oIGV2ZW50LCB1aSApIHsKCQkJCQl2YXIgaXRlbSA9IHVpLml0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKTsKCgkJCQkJLy8gUHJldmVudCBpbml0YWwgZm9jdXMgZnJvbSBmaXJpbmcgYW5kIGNoZWNrIGlmIGl0cyBhIG5ld2x5IGZvY3VzZWQgaXRlbQoJCQkJCWlmICggdGhhdC5mb2N1c0luZGV4ICE9IG51bGwgJiYgaXRlbS5pbmRleCAhPT0gdGhhdC5mb2N1c0luZGV4ICkgewoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAiZm9jdXMiLCBldmVudCwgeyBpdGVtOiBpdGVtIH0gKTsKCQkJCQkJaWYgKCAhdGhhdC5pc09wZW4gKSB7CgkJCQkJCQl0aGF0Ll9zZWxlY3QoIGl0ZW0sIGV2ZW50ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJdGhhdC5mb2N1c0luZGV4ID0gaXRlbS5pbmRleDsKCgkJCQkJdGhhdC5idXR0b24uYXR0ciggImFyaWEtYWN0aXZlZGVzY2VuZGFudCIsCgkJCQkJCXRoYXQubWVudUl0ZW1zLmVxKCBpdGVtLmluZGV4ICkuYXR0ciggImlkIiApICk7CgkJCQl9CgkJCX0gKQoJCQkubWVudSggImluc3RhbmNlIiApOwoKCQkvLyBEb24ndCBjbG9zZSB0aGUgbWVudSBvbiBtb3VzZWxlYXZlCgkJdGhpcy5tZW51SW5zdGFuY2UuX29mZiggdGhpcy5tZW51LCAibW91c2VsZWF2ZSIgKTsKCgkJLy8gQ2FuY2VsIHRoZSBtZW51J3MgY29sbGFwc2VBbGwgb24gZG9jdW1lbnQgY2xpY2sKCQl0aGlzLm1lbnVJbnN0YW5jZS5fY2xvc2VPbkRvY3VtZW50Q2xpY2sgPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJCS8vIFNlbGVjdHMgb2Z0ZW4gY29udGFpbiBlbXB0eSBpdGVtcywgYnV0IG5ldmVyIGNvbnRhaW4gZGl2aWRlcnMKCQl0aGlzLm1lbnVJbnN0YW5jZS5faXNEaXZpZGVyID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoTWVudSgpOwoJCXRoaXMuYnV0dG9uSXRlbS5yZXBsYWNlV2l0aCgKCQkJdGhpcy5idXR0b25JdGVtID0gdGhpcy5fcmVuZGVyQnV0dG9uSXRlbSgKCgkJCQkvLyBGYWxsIGJhY2sgdG8gYW4gZW1wdHkgb2JqZWN0IGluIGNhc2UgdGhlcmUgYXJlIG5vIG9wdGlvbnMKCQkJCXRoaXMuX2dldFNlbGVjdGVkSXRlbSgpLmRhdGEoICJ1aS1zZWxlY3RtZW51LWl0ZW0iICkgfHwge30KCQkJKQoJCSk7CgkJaWYgKCB0aGlzLm9wdGlvbnMud2lkdGggPT09IG51bGwgKSB7CgkJCXRoaXMuX3Jlc2l6ZUJ1dHRvbigpOwoJCX0KCX0sCgoJX3JlZnJlc2hNZW51OiBmdW5jdGlvbigpIHsKCQl2YXIgaXRlbSwKCQkJb3B0aW9ucyA9IHRoaXMuZWxlbWVudC5maW5kKCAib3B0aW9uIiApOwoKCQl0aGlzLm1lbnUuZW1wdHkoKTsKCgkJdGhpcy5fcGFyc2VPcHRpb25zKCBvcHRpb25zICk7CgkJdGhpcy5fcmVuZGVyTWVudSggdGhpcy5tZW51LCB0aGlzLml0ZW1zICk7CgoJCXRoaXMubWVudUluc3RhbmNlLnJlZnJlc2goKTsKCQl0aGlzLm1lbnVJdGVtcyA9IHRoaXMubWVudS5maW5kKCAibGkiICkKCQkJLm5vdCggIi51aS1zZWxlY3RtZW51LW9wdGdyb3VwIiApCgkJCQkuZmluZCggIi51aS1tZW51LWl0ZW0td3JhcHBlciIgKTsKCgkJdGhpcy5fcmVuZGVyZWQgPSB0cnVlOwoKCQlpZiAoICFvcHRpb25zLmxlbmd0aCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaXRlbSA9IHRoaXMuX2dldFNlbGVjdGVkSXRlbSgpOwoKCQkvLyBVcGRhdGUgdGhlIG1lbnUgdG8gaGF2ZSB0aGUgY29ycmVjdCBpdGVtIGZvY3VzZWQKCQl0aGlzLm1lbnVJbnN0YW5jZS5mb2N1cyggbnVsbCwgaXRlbSApOwoJCXRoaXMuX3NldEFyaWEoIGl0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKSApOwoKCQkvLyBTZXQgZGlzYWJsZWQgc3RhdGUKCQl0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKTsKCX0sCgoJb3BlbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB0aW1lIHRoZSBtZW51IGlzIGJlaW5nIG9wZW5lZCwgcmVuZGVyIHRoZSBpdGVtcwoJCWlmICggIXRoaXMuX3JlbmRlcmVkICkgewoJCQl0aGlzLl9yZWZyZXNoTWVudSgpOwoJCX0gZWxzZSB7CgoJCQkvLyBNZW51IGNsZWFycyBmb2N1cyBvbiBjbG9zZSwgcmVzZXQgZm9jdXMgdG8gc2VsZWN0ZWQgaXRlbQoJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5tZW51LmZpbmQoICIudWktc3RhdGUtYWN0aXZlIiApLCBudWxsLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQl0aGlzLm1lbnVJbnN0YW5jZS5mb2N1cyggbnVsbCwgdGhpcy5fZ2V0U2VsZWN0ZWRJdGVtKCkgKTsKCQl9CgoJCS8vIElmIHRoZXJlIGFyZSBubyBvcHRpb25zLCBkb24ndCBvcGVuIHRoZSBtZW51CgkJaWYgKCAhdGhpcy5tZW51SXRlbXMubGVuZ3RoICkgewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLmlzT3BlbiA9IHRydWU7CgkJdGhpcy5fdG9nZ2xlQXR0cigpOwoJCXRoaXMuX3Jlc2l6ZU1lbnUoKTsKCQl0aGlzLl9wb3NpdGlvbigpOwoKCQl0aGlzLl9vbiggdGhpcy5kb2N1bWVudCwgdGhpcy5fZG9jdW1lbnRDbGljayApOwoKCQl0aGlzLl90cmlnZ2VyKCAib3BlbiIsIGV2ZW50ICk7Cgl9LAoKCV9wb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5tZW51V3JhcC5wb3NpdGlvbiggJC5leHRlbmQoIHsgb2Y6IHRoaXMuYnV0dG9uIH0sIHRoaXMub3B0aW9ucy5wb3NpdGlvbiApICk7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuaXNPcGVuID0gZmFsc2U7CgkJdGhpcy5fdG9nZ2xlQXR0cigpOwoKCQl0aGlzLnJhbmdlID0gbnVsbDsKCQl0aGlzLl9vZmYoIHRoaXMuZG9jdW1lbnQgKTsKCgkJdGhpcy5fdHJpZ2dlciggImNsb3NlIiwgZXZlbnQgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5idXR0b247Cgl9LAoKCW1lbnVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1lbnU7Cgl9LAoKCV9yZW5kZXJCdXR0b25JdGVtOiBmdW5jdGlvbiggaXRlbSApIHsKCQl2YXIgYnV0dG9uSXRlbSA9ICQoICI8c3Bhbj4iICk7CgoJCXRoaXMuX3NldFRleHQoIGJ1dHRvbkl0ZW0sIGl0ZW0ubGFiZWwgKTsKCQl0aGlzLl9hZGRDbGFzcyggYnV0dG9uSXRlbSwgInVpLXNlbGVjdG1lbnUtdGV4dCIgKTsKCgkJcmV0dXJuIGJ1dHRvbkl0ZW07Cgl9LAoKCV9yZW5kZXJNZW51OiBmdW5jdGlvbiggdWwsIGl0ZW1zICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJY3VycmVudE9wdGdyb3VwID0gIiI7CgoJCSQuZWFjaCggaXRlbXMsIGZ1bmN0aW9uKCBpbmRleCwgaXRlbSApIHsKCQkJdmFyIGxpOwoKCQkJaWYgKCBpdGVtLm9wdGdyb3VwICE9PSBjdXJyZW50T3B0Z3JvdXAgKSB7CgkJCQlsaSA9ICQoICI8bGk+IiwgewoJCQkJCXRleHQ6IGl0ZW0ub3B0Z3JvdXAKCQkJCX0gKTsKCQkJCXRoYXQuX2FkZENsYXNzKCBsaSwgInVpLXNlbGVjdG1lbnUtb3B0Z3JvdXAiLCAidWktbWVudS1kaXZpZGVyIiArCgkJCQkJKCBpdGVtLmVsZW1lbnQucGFyZW50KCAib3B0Z3JvdXAiICkucHJvcCggImRpc2FibGVkIiApID8KCQkJCQkJIiB1aS1zdGF0ZS1kaXNhYmxlZCIgOgoJCQkJCQkiIiApICk7CgoJCQkJbGkuYXBwZW5kVG8oIHVsICk7CgoJCQkJY3VycmVudE9wdGdyb3VwID0gaXRlbS5vcHRncm91cDsKCQkJfQoKCQkJdGhhdC5fcmVuZGVySXRlbURhdGEoIHVsLCBpdGVtICk7CgkJfSApOwoJfSwKCglfcmVuZGVySXRlbURhdGE6IGZ1bmN0aW9uKCB1bCwgaXRlbSApIHsKCQlyZXR1cm4gdGhpcy5fcmVuZGVySXRlbSggdWwsIGl0ZW0gKS5kYXRhKCAidWktc2VsZWN0bWVudS1pdGVtIiwgaXRlbSApOwoJfSwKCglfcmVuZGVySXRlbTogZnVuY3Rpb24oIHVsLCBpdGVtICkgewoJCXZhciBsaSA9ICQoICI8bGk+IiApLAoJCQl3cmFwcGVyID0gJCggIjxkaXY+IiwgewoJCQkJdGl0bGU6IGl0ZW0uZWxlbWVudC5hdHRyKCAidGl0bGUiICkKCQkJfSApOwoKCQlpZiAoIGl0ZW0uZGlzYWJsZWQgKSB7CgkJCXRoaXMuX2FkZENsYXNzKCBsaSwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCX0KCQl0aGlzLl9zZXRUZXh0KCB3cmFwcGVyLCBpdGVtLmxhYmVsICk7CgoJCXJldHVybiBsaS5hcHBlbmQoIHdyYXBwZXIgKS5hcHBlbmRUbyggdWwgKTsKCX0sCgoJX3NldFRleHQ6IGZ1bmN0aW9uKCBlbGVtZW50LCB2YWx1ZSApIHsKCQlpZiAoIHZhbHVlICkgewoJCQllbGVtZW50LnRleHQoIHZhbHVlICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5odG1sKCAiJiMxNjA7IiApOwoJCX0KCX0sCgoJX21vdmU6IGZ1bmN0aW9uKCBkaXJlY3Rpb24sIGV2ZW50ICkgewoJCXZhciBpdGVtLCBuZXh0LAoJCQlmaWx0ZXIgPSAiLnVpLW1lbnUtaXRlbSI7CgoJCWlmICggdGhpcy5pc09wZW4gKSB7CgkJCWl0ZW0gPSB0aGlzLm1lbnVJdGVtcy5lcSggdGhpcy5mb2N1c0luZGV4ICkucGFyZW50KCAibGkiICk7CgkJfSBlbHNlIHsKCQkJaXRlbSA9IHRoaXMubWVudUl0ZW1zLmVxKCB0aGlzLmVsZW1lbnRbIDAgXS5zZWxlY3RlZEluZGV4ICkucGFyZW50KCAibGkiICk7CgkJCWZpbHRlciArPSAiOm5vdCgudWktc3RhdGUtZGlzYWJsZWQpIjsKCQl9CgoJCWlmICggZGlyZWN0aW9uID09PSAiZmlyc3QiIHx8IGRpcmVjdGlvbiA9PT0gImxhc3QiICkgewoJCQluZXh0ID0gaXRlbVsgZGlyZWN0aW9uID09PSAiZmlyc3QiID8gInByZXZBbGwiIDogIm5leHRBbGwiIF0oIGZpbHRlciApLmVxKCAtMSApOwoJCX0gZWxzZSB7CgkJCW5leHQgPSBpdGVtWyBkaXJlY3Rpb24gKyAiQWxsIiBdKCBmaWx0ZXIgKS5lcSggMCApOwoJCX0KCgkJaWYgKCBuZXh0Lmxlbmd0aCApIHsKCQkJdGhpcy5tZW51SW5zdGFuY2UuZm9jdXMoIGV2ZW50LCBuZXh0ICk7CgkJfQoJfSwKCglfZ2V0U2VsZWN0ZWRJdGVtOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tZW51SXRlbXMuZXEoIHRoaXMuZWxlbWVudFsgMCBdLnNlbGVjdGVkSW5kZXggKS5wYXJlbnQoICJsaSIgKTsKCX0sCgoJX3RvZ2dsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXNbIHRoaXMuaXNPcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCBldmVudCApOwoJfSwKCglfc2V0U2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0aW9uOwoKCQlpZiAoICF0aGlzLnJhbmdlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHdpbmRvdy5nZXRTZWxlY3Rpb24gKSB7CgkJCXNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTsKCQkJc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpOwoJCQlzZWxlY3Rpb24uYWRkUmFuZ2UoIHRoaXMucmFuZ2UgKTsKCgkJLy8gU3VwcG9ydDogSUU4CgkJfSBlbHNlIHsKCQkJdGhpcy5yYW5nZS5zZWxlY3QoKTsKCQl9CgoJCS8vIFN1cHBvcnQ6IElFCgkJLy8gU2V0dGluZyB0aGUgdGV4dCBzZWxlY3Rpb24ga2lsbHMgdGhlIGJ1dHRvbiBmb2N1cyBpbiBJRSwgYnV0CgkJLy8gcmVzdG9yaW5nIHRoZSBmb2N1cyBkb2Vzbid0IGtpbGwgdGhlIHNlbGVjdGlvbi4KCQl0aGlzLmJ1dHRvbi5mb2N1cygpOwoJfSwKCglfZG9jdW1lbnRDbGljazogewoJCW1vdXNlZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICF0aGlzLmlzT3BlbiApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCAhJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1zZWxlY3RtZW51LW1lbnUsICMiICsKCQkJCQkkLnVpLmVzY2FwZVNlbGVjdG9yKCB0aGlzLmlkcy5idXR0b24gKSApLmxlbmd0aCApIHsKCQkJCXRoaXMuY2xvc2UoIGV2ZW50ICk7CgkJCX0KCQl9Cgl9LAoKCV9idXR0b25FdmVudHM6IHsKCgkJLy8gUHJldmVudCB0ZXh0IHNlbGVjdGlvbiBmcm9tIGJlaW5nIHJlc2V0IHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgc2VsZWN0bWVudSAoIzEwMTQ0KQoJCW1vdXNlZG93bjogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxlY3Rpb247CgoJCQlpZiAoIHdpbmRvdy5nZXRTZWxlY3Rpb24gKSB7CgkJCQlzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CgkJCQlpZiAoIHNlbGVjdGlvbi5yYW5nZUNvdW50ICkgewoJCQkJCXRoaXMucmFuZ2UgPSBzZWxlY3Rpb24uZ2V0UmFuZ2VBdCggMCApOwoJCQkJfQoKCQkJLy8gU3VwcG9ydDogSUU4CgkJCX0gZWxzZSB7CgkJCQl0aGlzLnJhbmdlID0gZG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCk7CgkJCX0KCQl9LAoKCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zZXRTZWxlY3Rpb24oKTsKCQkJdGhpcy5fdG9nZ2xlKCBldmVudCApOwoJCX0sCgoJCWtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHByZXZlbnREZWZhdWx0ID0gdHJ1ZTsKCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLnVpLmtleUNvZGUuVEFCOgoJCQljYXNlICQudWkua2V5Q29kZS5FU0NBUEU6CgkJCQl0aGlzLmNsb3NlKCBldmVudCApOwoJCQkJcHJldmVudERlZmF1bHQgPSBmYWxzZTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQkJCWlmICggdGhpcy5pc09wZW4gKSB7CgkJCQkJdGhpcy5fc2VsZWN0Rm9jdXNlZEl0ZW0oIGV2ZW50ICk7CgkJCQl9CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCQlpZiAoIGV2ZW50LmFsdEtleSApIHsKCQkJCQl0aGlzLl90b2dnbGUoIGV2ZW50ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuX21vdmUoICJwcmV2IiwgZXZlbnQgKTsKCQkJCX0KCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQkJaWYgKCBldmVudC5hbHRLZXkgKSB7CgkJCQkJdGhpcy5fdG9nZ2xlKCBldmVudCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl9tb3ZlKCAibmV4dCIsIGV2ZW50ICk7CgkJCQl9CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCQlpZiAoIHRoaXMuaXNPcGVuICkgewoJCQkJCXRoaXMuX3NlbGVjdEZvY3VzZWRJdGVtKCBldmVudCApOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl90b2dnbGUoIGV2ZW50ICk7CgkJCQl9CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMuX21vdmUoICJwcmV2IiwgZXZlbnQgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJCXRoaXMuX21vdmUoICJuZXh0IiwgZXZlbnQgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX1VQOgoJCQkJdGhpcy5fbW92ZSggImZpcnN0IiwgZXZlbnQgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCXRoaXMuX21vdmUoICJsYXN0IiwgZXZlbnQgKTsKCQkJCWJyZWFrOwoJCQlkZWZhdWx0OgoJCQkJdGhpcy5tZW51LnRyaWdnZXIoIGV2ZW50ICk7CgkJCQlwcmV2ZW50RGVmYXVsdCA9IGZhbHNlOwoJCQl9CgoJCQlpZiAoIHByZXZlbnREZWZhdWx0ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0KCX0sCgoJX3NlbGVjdEZvY3VzZWRJdGVtOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGl0ZW0gPSB0aGlzLm1lbnVJdGVtcy5lcSggdGhpcy5mb2N1c0luZGV4ICkucGFyZW50KCAibGkiICk7CgkJaWYgKCAhaXRlbS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQl0aGlzLl9zZWxlY3QoIGl0ZW0uZGF0YSggInVpLXNlbGVjdG1lbnUtaXRlbSIgKSwgZXZlbnQgKTsKCQl9Cgl9LAoKCV9zZWxlY3Q6IGZ1bmN0aW9uKCBpdGVtLCBldmVudCApIHsKCQl2YXIgb2xkSW5kZXggPSB0aGlzLmVsZW1lbnRbIDAgXS5zZWxlY3RlZEluZGV4OwoKCQkvLyBDaGFuZ2UgbmF0aXZlIHNlbGVjdCBlbGVtZW50CgkJdGhpcy5lbGVtZW50WyAwIF0uc2VsZWN0ZWRJbmRleCA9IGl0ZW0uaW5kZXg7CgkJdGhpcy5idXR0b25JdGVtLnJlcGxhY2VXaXRoKCB0aGlzLmJ1dHRvbkl0ZW0gPSB0aGlzLl9yZW5kZXJCdXR0b25JdGVtKCBpdGVtICkgKTsKCQl0aGlzLl9zZXRBcmlhKCBpdGVtICk7CgkJdGhpcy5fdHJpZ2dlciggInNlbGVjdCIsIGV2ZW50LCB7IGl0ZW06IGl0ZW0gfSApOwoKCQlpZiAoIGl0ZW0uaW5kZXggIT09IG9sZEluZGV4ICkgewoJCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiwgZXZlbnQsIHsgaXRlbTogaXRlbSB9ICk7CgkJfQoKCQl0aGlzLmNsb3NlKCBldmVudCApOwoJfSwKCglfc2V0QXJpYTogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJdmFyIGlkID0gdGhpcy5tZW51SXRlbXMuZXEoIGl0ZW0uaW5kZXggKS5hdHRyKCAiaWQiICk7CgoJCXRoaXMuYnV0dG9uLmF0dHIoIHsKCQkJImFyaWEtbGFiZWxsZWRieSI6IGlkLAoJCQkiYXJpYS1hY3RpdmVkZXNjZW5kYW50IjogaWQKCQl9ICk7CgkJdGhpcy5tZW51LmF0dHIoICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLCBpZCApOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImljb25zIiApIHsKCQkJdmFyIGljb24gPSB0aGlzLmJ1dHRvbi5maW5kKCAic3Bhbi51aS1pY29uIiApOwoJCQl0aGlzLl9yZW1vdmVDbGFzcyggaWNvbiwgbnVsbCwgdGhpcy5vcHRpb25zLmljb25zLmJ1dHRvbiApCgkJCQkuX2FkZENsYXNzKCBpY29uLCBudWxsLCB2YWx1ZS5idXR0b24gKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCWlmICgga2V5ID09PSAiYXBwZW5kVG8iICkgewoJCQl0aGlzLm1lbnVXcmFwLmFwcGVuZFRvKCB0aGlzLl9hcHBlbmRUbygpICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gIndpZHRoIiApIHsKCQkJdGhpcy5fcmVzaXplQnV0dG9uKCk7CgkJfQoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlciggdmFsdWUgKTsKCgkJdGhpcy5tZW51SW5zdGFuY2Uub3B0aW9uKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCXRoaXMuYnV0dG9uLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLl90b2dnbGVDbGFzcyggdGhpcy5idXR0b24sIG51bGwsICJ1aS1zdGF0ZS1kaXNhYmxlZCIsIHZhbHVlICk7CgoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMuYnV0dG9uLmF0dHIoICJ0YWJpbmRleCIsIC0xICk7CgkJCXRoaXMuY2xvc2UoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmJ1dHRvbi5hdHRyKCAidGFiaW5kZXgiLCAwICk7CgkJfQoJfSwKCglfYXBwZW5kVG86IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gdGhpcy5vcHRpb25zLmFwcGVuZFRvOwoKCQlpZiAoIGVsZW1lbnQgKSB7CgkJCWVsZW1lbnQgPSBlbGVtZW50LmpxdWVyeSB8fCBlbGVtZW50Lm5vZGVUeXBlID8KCQkJCSQoIGVsZW1lbnQgKSA6CgkJCQl0aGlzLmRvY3VtZW50LmZpbmQoIGVsZW1lbnQgKS5lcSggMCApOwoJCX0KCgkJaWYgKCAhZWxlbWVudCB8fCAhZWxlbWVudFsgMCBdICkgewoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktZnJvbnQsIGRpYWxvZyIgKTsKCQl9CgoJCWlmICggIWVsZW1lbnQubGVuZ3RoICkgewoJCQllbGVtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHk7CgkJfQoKCQlyZXR1cm4gZWxlbWVudDsKCX0sCgoJX3RvZ2dsZUF0dHI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuYnV0dG9uLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgdGhpcy5pc09wZW4gKTsKCgkJLy8gV2UgY2FuJ3QgdXNlIHR3byBfdG9nZ2xlQ2xhc3MoKSBjYWxscyBoZXJlLCBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlCgkJLy8gd2UgYWx3YXlzIHJlbW92ZSBjbGFzc2VzIGZpcnN0IGFuZCBhZGQgdGhlbSBzZWNvbmQsIG90aGVyd2lzZSBpZiBib3RoIGNsYXNzZXMgaGF2ZSB0aGUKCQkvLyBzYW1lIHRoZW1lIGNsYXNzLCBpdCB3aWxsIGJlIHJlbW92ZWQgYWZ0ZXIgd2UgYWRkIGl0LgoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmJ1dHRvbiwgInVpLXNlbGVjdG1lbnUtYnV0dG9uLSIgKwoJCQkoIHRoaXMuaXNPcGVuID8gImNsb3NlZCIgOiAib3BlbiIgKSApCgkJCS5fYWRkQ2xhc3MoIHRoaXMuYnV0dG9uLCAidWktc2VsZWN0bWVudS1idXR0b24tIiArCgkJCQkoIHRoaXMuaXNPcGVuID8gIm9wZW4iIDogImNsb3NlZCIgKSApCgkJCS5fdG9nZ2xlQ2xhc3MoIHRoaXMubWVudVdyYXAsICJ1aS1zZWxlY3RtZW51LW9wZW4iLCBudWxsLCB0aGlzLmlzT3BlbiApOwoKCQl0aGlzLm1lbnUuYXR0ciggImFyaWEtaGlkZGVuIiwgIXRoaXMuaXNPcGVuICk7Cgl9LAoKCV9yZXNpemVCdXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciB3aWR0aCA9IHRoaXMub3B0aW9ucy53aWR0aDsKCgkJLy8gRm9yIGB3aWR0aDogZmFsc2VgLCBqdXN0IHJlbW92ZSBpbmxpbmUgc3R5bGUgYW5kIHN0b3AKCQlpZiAoIHdpZHRoID09PSBmYWxzZSApIHsKCQkJdGhpcy5idXR0b24uY3NzKCAid2lkdGgiLCAiIiApOwoJCQlyZXR1cm47CgkJfQoKCQkvLyBGb3IgYHdpZHRoOiBudWxsYCwgbWF0Y2ggdGhlIHdpZHRoIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50CgkJaWYgKCB3aWR0aCA9PT0gbnVsbCApIHsKCQkJd2lkdGggPSB0aGlzLmVsZW1lbnQuc2hvdygpLm91dGVyV2lkdGgoKTsKCQkJdGhpcy5lbGVtZW50LmhpZGUoKTsKCQl9CgoJCXRoaXMuYnV0dG9uLm91dGVyV2lkdGgoIHdpZHRoICk7Cgl9LAoKCV9yZXNpemVNZW51OiBmdW5jdGlvbigpIHsKCQl0aGlzLm1lbnUub3V0ZXJXaWR0aCggTWF0aC5tYXgoCgkJCXRoaXMuYnV0dG9uLm91dGVyV2lkdGgoKSwKCgkJCS8vIFN1cHBvcnQ6IElFMTAKCQkJLy8gSUUxMCB3cmFwcyBsb25nIHRleHQgKHBvc3NpYmx5IGEgcm91bmRpbmcgYnVnKQoJCQkvLyBzbyB3ZSBhZGQgMXB4IHRvIGF2b2lkIHRoZSB3cmFwcGluZwoJCQl0aGlzLm1lbnUud2lkdGgoICIiICkub3V0ZXJXaWR0aCgpICsgMQoJCSkgKTsKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5fc3VwZXIoKTsKCgkJb3B0aW9ucy5kaXNhYmxlZCA9IHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICk7CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfcGFyc2VPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCWRhdGEgPSBbXTsKCQlvcHRpb25zLmVhY2goIGZ1bmN0aW9uKCBpbmRleCwgaXRlbSApIHsKCQkJZGF0YS5wdXNoKCB0aGF0Ll9wYXJzZU9wdGlvbiggJCggaXRlbSApLCBpbmRleCApICk7CgkJfSApOwoJCXRoaXMuaXRlbXMgPSBkYXRhOwoJfSwKCglfcGFyc2VPcHRpb246IGZ1bmN0aW9uKCBvcHRpb24sIGluZGV4ICkgewoJCXZhciBvcHRncm91cCA9IG9wdGlvbi5wYXJlbnQoICJvcHRncm91cCIgKTsKCgkJcmV0dXJuIHsKCQkJZWxlbWVudDogb3B0aW9uLAoJCQlpbmRleDogaW5kZXgsCgkJCXZhbHVlOiBvcHRpb24udmFsKCksCgkJCWxhYmVsOiBvcHRpb24udGV4dCgpLAoJCQlvcHRncm91cDogb3B0Z3JvdXAuYXR0ciggImxhYmVsIiApIHx8ICIiLAoJCQlkaXNhYmxlZDogb3B0Z3JvdXAucHJvcCggImRpc2FibGVkIiApIHx8IG9wdGlvbi5wcm9wKCAiZGlzYWJsZWQiICkKCQl9OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdW5iaW5kRm9ybVJlc2V0SGFuZGxlcigpOwoJCXRoaXMubWVudVdyYXAucmVtb3ZlKCk7CgkJdGhpcy5idXR0b24ucmVtb3ZlKCk7CgkJdGhpcy5lbGVtZW50LnNob3coKTsKCQl0aGlzLmVsZW1lbnQucmVtb3ZlVW5pcXVlSWQoKTsKCQl0aGlzLmxhYmVscy5hdHRyKCAiZm9yIiwgdGhpcy5pZHMuZWxlbWVudCApOwoJfQp9IF0gKTsKCgovKiEKICogalF1ZXJ5IFVJIFNsaWRlciAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNsaWRlcgovLz4+Z3JvdXA6IFdpZGdldHMKLy8+PmRlc2NyaXB0aW9uOiBEaXNwbGF5cyBhIGZsZXhpYmxlIHNsaWRlciB3aXRoIHJhbmdlcyBhbmQgYWNjZXNzaWJpbGl0eSB2aWEga2V5Ym9hcmQuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9zbGlkZXIvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS9zbGlkZXIvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9jb3JlLmNzcwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2Uvc2xpZGVyLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKdmFyIHdpZGdldHNTbGlkZXIgPSAkLndpZGdldCggInVpLnNsaWRlciIsICQudWkubW91c2UsIHsKCXZlcnNpb246ICIxLjEyLjEiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCWFuaW1hdGU6IGZhbHNlLAoJCWNsYXNzZXM6IHsKCQkJInVpLXNsaWRlciI6ICJ1aS1jb3JuZXItYWxsIiwKCQkJInVpLXNsaWRlci1oYW5kbGUiOiAidWktY29ybmVyLWFsbCIsCgoJCQkvLyBOb3RlOiB1aS13aWRnZXQtaGVhZGVyIGlzbid0IHRoZSBtb3N0IGZpdHRpbmdseSBzZW1hbnRpYyBmcmFtZXdvcmsgY2xhc3MgZm9yIHRoaXMKCQkJLy8gZWxlbWVudCwgYnV0IHdvcmtlZCBiZXN0IHZpc3VhbGx5IHdpdGggYSB2YXJpZXR5IG9mIHRoZW1lcwoJCQkidWktc2xpZGVyLXJhbmdlIjogInVpLWNvcm5lci1hbGwgdWktd2lkZ2V0LWhlYWRlciIKCQl9LAoJCWRpc3RhbmNlOiAwLAoJCW1heDogMTAwLAoJCW1pbjogMCwKCQlvcmllbnRhdGlvbjogImhvcml6b250YWwiLAoJCXJhbmdlOiBmYWxzZSwKCQlzdGVwOiAxLAoJCXZhbHVlOiAwLAoJCXZhbHVlczogbnVsbCwKCgkJLy8gQ2FsbGJhY2tzCgkJY2hhbmdlOiBudWxsLAoJCXNsaWRlOiBudWxsLAoJCXN0YXJ0OiBudWxsLAoJCXN0b3A6IG51bGwKCX0sCgoJLy8gTnVtYmVyIG9mIHBhZ2VzIGluIGEgc2xpZGVyCgkvLyAoaG93IG1hbnkgdGltZXMgY2FuIHlvdSBwYWdlIHVwL2Rvd24gdG8gZ28gdGhyb3VnaCB0aGUgd2hvbGUgcmFuZ2UpCgludW1QYWdlczogNSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJdGhpcy5fbW91c2VTbGlkaW5nID0gZmFsc2U7CgkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7CgkJdGhpcy5faGFuZGxlSW5kZXggPSBudWxsOwoJCXRoaXMuX2RldGVjdE9yaWVudGF0aW9uKCk7CgkJdGhpcy5fbW91c2VJbml0KCk7CgkJdGhpcy5fY2FsY3VsYXRlTmV3TWF4KCk7CgoJCXRoaXMuX2FkZENsYXNzKCAidWktc2xpZGVyIHVpLXNsaWRlci0iICsgdGhpcy5vcmllbnRhdGlvbiwKCQkJInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCIgKTsKCgkJdGhpcy5fcmVmcmVzaCgpOwoKCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9jcmVhdGVSYW5nZSgpOwoJCXRoaXMuX2NyZWF0ZUhhbmRsZXMoKTsKCQl0aGlzLl9zZXR1cEV2ZW50cygpOwoJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJfSwKCglfY3JlYXRlSGFuZGxlczogZnVuY3Rpb24oKSB7CgkJdmFyIGksIGhhbmRsZUNvdW50LAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlleGlzdGluZ0hhbmRsZXMgPSB0aGlzLmVsZW1lbnQuZmluZCggIi51aS1zbGlkZXItaGFuZGxlIiApLAoJCQloYW5kbGUgPSAiPHNwYW4gdGFiaW5kZXg9JzAnPjwvc3Bhbj4iLAoJCQloYW5kbGVzID0gW107CgoJCWhhbmRsZUNvdW50ID0gKCBvcHRpb25zLnZhbHVlcyAmJiBvcHRpb25zLnZhbHVlcy5sZW5ndGggKSB8fCAxOwoKCQlpZiAoIGV4aXN0aW5nSGFuZGxlcy5sZW5ndGggPiBoYW5kbGVDb3VudCApIHsKCQkJZXhpc3RpbmdIYW5kbGVzLnNsaWNlKCBoYW5kbGVDb3VudCApLnJlbW92ZSgpOwoJCQlleGlzdGluZ0hhbmRsZXMgPSBleGlzdGluZ0hhbmRsZXMuc2xpY2UoIDAsIGhhbmRsZUNvdW50ICk7CgkJfQoKCQlmb3IgKCBpID0gZXhpc3RpbmdIYW5kbGVzLmxlbmd0aDsgaSA8IGhhbmRsZUNvdW50OyBpKysgKSB7CgkJCWhhbmRsZXMucHVzaCggaGFuZGxlICk7CgkJfQoKCQl0aGlzLmhhbmRsZXMgPSBleGlzdGluZ0hhbmRsZXMuYWRkKCAkKCBoYW5kbGVzLmpvaW4oICIiICkgKS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICkgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuaGFuZGxlcywgInVpLXNsaWRlci1oYW5kbGUiLCAidWktc3RhdGUtZGVmYXVsdCIgKTsKCgkJdGhpcy5oYW5kbGUgPSB0aGlzLmhhbmRsZXMuZXEoIDAgKTsKCgkJdGhpcy5oYW5kbGVzLmVhY2goIGZ1bmN0aW9uKCBpICkgewoJCQkkKCB0aGlzICkKCQkJCS5kYXRhKCAidWktc2xpZGVyLWhhbmRsZS1pbmRleCIsIGkgKQoJCQkJLmF0dHIoICJ0YWJJbmRleCIsIDAgKTsKCQl9ICk7Cgl9LAoKCV9jcmVhdGVSYW5nZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5yYW5nZSApIHsKCQkJaWYgKCBvcHRpb25zLnJhbmdlID09PSB0cnVlICkgewoJCQkJaWYgKCAhb3B0aW9ucy52YWx1ZXMgKSB7CgkJCQkJb3B0aW9ucy52YWx1ZXMgPSBbIHRoaXMuX3ZhbHVlTWluKCksIHRoaXMuX3ZhbHVlTWluKCkgXTsKCQkJCX0gZWxzZSBpZiAoIG9wdGlvbnMudmFsdWVzLmxlbmd0aCAmJiBvcHRpb25zLnZhbHVlcy5sZW5ndGggIT09IDIgKSB7CgkJCQkJb3B0aW9ucy52YWx1ZXMgPSBbIG9wdGlvbnMudmFsdWVzWyAwIF0sIG9wdGlvbnMudmFsdWVzWyAwIF0gXTsKCQkJCX0gZWxzZSBpZiAoICQuaXNBcnJheSggb3B0aW9ucy52YWx1ZXMgKSApIHsKCQkJCQlvcHRpb25zLnZhbHVlcyA9IG9wdGlvbnMudmFsdWVzLnNsaWNlKCAwICk7CgkJCQl9CgkJCX0KCgkJCWlmICggIXRoaXMucmFuZ2UgfHwgIXRoaXMucmFuZ2UubGVuZ3RoICkgewoJCQkJdGhpcy5yYW5nZSA9ICQoICI8ZGl2PiIgKQoJCQkJCS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCQkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMucmFuZ2UsICJ1aS1zbGlkZXItcmFuZ2UiICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5yYW5nZSwgInVpLXNsaWRlci1yYW5nZS1taW4gdWktc2xpZGVyLXJhbmdlLW1heCIgKTsKCgkJCQkvLyBIYW5kbGUgcmFuZ2Ugc3dpdGNoaW5nIGZyb20gdHJ1ZSB0byBtaW4vbWF4CgkJCQl0aGlzLnJhbmdlLmNzcyggewoJCQkJCSJsZWZ0IjogIiIsCgkJCQkJImJvdHRvbSI6ICIiCgkJCQl9ICk7CgkJCX0KCQkJaWYgKCBvcHRpb25zLnJhbmdlID09PSAibWluIiB8fCBvcHRpb25zLnJhbmdlID09PSAibWF4IiApIHsKCQkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnJhbmdlLCAidWktc2xpZGVyLXJhbmdlLSIgKyBvcHRpb25zLnJhbmdlICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHRoaXMucmFuZ2UgKSB7CgkJCQl0aGlzLnJhbmdlLnJlbW92ZSgpOwoJCQl9CgkJCXRoaXMucmFuZ2UgPSBudWxsOwoJCX0KCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vZmYoIHRoaXMuaGFuZGxlcyApOwoJCXRoaXMuX29uKCB0aGlzLmhhbmRsZXMsIHRoaXMuX2hhbmRsZUV2ZW50cyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy5oYW5kbGVzICk7CgkJdGhpcy5fZm9jdXNhYmxlKCB0aGlzLmhhbmRsZXMgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuaGFuZGxlcy5yZW1vdmUoKTsKCQlpZiAoIHRoaXMucmFuZ2UgKSB7CgkJCXRoaXMucmFuZ2UucmVtb3ZlKCk7CgkJfQoKCQl0aGlzLl9tb3VzZURlc3Ryb3koKTsKCX0sCgoJX21vdXNlQ2FwdHVyZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBwb3NpdGlvbiwgbm9ybVZhbHVlLCBkaXN0YW5jZSwgY2xvc2VzdEhhbmRsZSwgaW5kZXgsIGFsbG93ZWQsIG9mZnNldCwgbW91c2VPdmVySGFuZGxlLAoJCQl0aGF0ID0gdGhpcywKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvLmRpc2FibGVkICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl0aGlzLmVsZW1lbnRTaXplID0gewoJCQl3aWR0aDogdGhpcy5lbGVtZW50Lm91dGVyV2lkdGgoKSwKCQkJaGVpZ2h0OiB0aGlzLmVsZW1lbnQub3V0ZXJIZWlnaHQoKQoJCX07CgkJdGhpcy5lbGVtZW50T2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpOwoKCQlwb3NpdGlvbiA9IHsgeDogZXZlbnQucGFnZVgsIHk6IGV2ZW50LnBhZ2VZIH07CgkJbm9ybVZhbHVlID0gdGhpcy5fbm9ybVZhbHVlRnJvbU1vdXNlKCBwb3NpdGlvbiApOwoJCWRpc3RhbmNlID0gdGhpcy5fdmFsdWVNYXgoKSAtIHRoaXMuX3ZhbHVlTWluKCkgKyAxOwoJCXRoaXMuaGFuZGxlcy5lYWNoKCBmdW5jdGlvbiggaSApIHsKCQkJdmFyIHRoaXNEaXN0YW5jZSA9IE1hdGguYWJzKCBub3JtVmFsdWUgLSB0aGF0LnZhbHVlcyggaSApICk7CgkJCWlmICggKCBkaXN0YW5jZSA+IHRoaXNEaXN0YW5jZSApIHx8CgkJCQkoIGRpc3RhbmNlID09PSB0aGlzRGlzdGFuY2UgJiYKCQkJCQkoIGkgPT09IHRoYXQuX2xhc3RDaGFuZ2VkVmFsdWUgfHwgdGhhdC52YWx1ZXMoIGkgKSA9PT0gby5taW4gKSApICkgewoJCQkJZGlzdGFuY2UgPSB0aGlzRGlzdGFuY2U7CgkJCQljbG9zZXN0SGFuZGxlID0gJCggdGhpcyApOwoJCQkJaW5kZXggPSBpOwoJCQl9CgkJfSApOwoKCQlhbGxvd2VkID0gdGhpcy5fc3RhcnQoIGV2ZW50LCBpbmRleCApOwoJCWlmICggYWxsb3dlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5fbW91c2VTbGlkaW5nID0gdHJ1ZTsKCgkJdGhpcy5faGFuZGxlSW5kZXggPSBpbmRleDsKCgkJdGhpcy5fYWRkQ2xhc3MoIGNsb3Nlc3RIYW5kbGUsIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJY2xvc2VzdEhhbmRsZS50cmlnZ2VyKCAiZm9jdXMiICk7CgoJCW9mZnNldCA9IGNsb3Nlc3RIYW5kbGUub2Zmc2V0KCk7CgkJbW91c2VPdmVySGFuZGxlID0gISQoIGV2ZW50LnRhcmdldCApLnBhcmVudHMoKS5hZGRCYWNrKCkuaXMoICIudWktc2xpZGVyLWhhbmRsZSIgKTsKCQl0aGlzLl9jbGlja09mZnNldCA9IG1vdXNlT3ZlckhhbmRsZSA\/IHsgbGVmdDogMCwgdG9wOiAwIH0gOiB7CgkJCWxlZnQ6IGV2ZW50LnBhZ2VYIC0gb2Zmc2V0LmxlZnQgLSAoIGNsb3Nlc3RIYW5kbGUud2lkdGgoKSAvIDIgKSwKCQkJdG9wOiBldmVudC5wYWdlWSAtIG9mZnNldC50b3AgLQoJCQkJKCBjbG9zZXN0SGFuZGxlLmhlaWdodCgpIC8gMiApIC0KCQkJCSggcGFyc2VJbnQoIGNsb3Nlc3RIYW5kbGUuY3NzKCAiYm9yZGVyVG9wV2lkdGgiICksIDEwICkgfHwgMCApIC0KCQkJCSggcGFyc2VJbnQoIGNsb3Nlc3RIYW5kbGUuY3NzKCAiYm9yZGVyQm90dG9tV2lkdGgiICksIDEwICkgfHwgMCApICsKCQkJCSggcGFyc2VJbnQoIGNsb3Nlc3RIYW5kbGUuY3NzKCAibWFyZ2luVG9wIiApLCAxMCApIHx8IDAgKQoJCX07CgoJCWlmICggIXRoaXMuaGFuZGxlcy5oYXNDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApICkgewoJCQl0aGlzLl9zbGlkZSggZXZlbnQsIGluZGV4LCBub3JtVmFsdWUgKTsKCQl9CgkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJX21vdXNlRHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBwb3NpdGlvbiA9IHsgeDogZXZlbnQucGFnZVgsIHk6IGV2ZW50LnBhZ2VZIH0sCgkJCW5vcm1WYWx1ZSA9IHRoaXMuX25vcm1WYWx1ZUZyb21Nb3VzZSggcG9zaXRpb24gKTsKCgkJdGhpcy5fc2xpZGUoIGV2ZW50LCB0aGlzLl9oYW5kbGVJbmRleCwgbm9ybVZhbHVlICk7CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX21vdXNlU3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmhhbmRsZXMsIG51bGwsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJdGhpcy5fbW91c2VTbGlkaW5nID0gZmFsc2U7CgoJCXRoaXMuX3N0b3AoIGV2ZW50LCB0aGlzLl9oYW5kbGVJbmRleCApOwoJCXRoaXMuX2NoYW5nZSggZXZlbnQsIHRoaXMuX2hhbmRsZUluZGV4ICk7CgoJCXRoaXMuX2hhbmRsZUluZGV4ID0gbnVsbDsKCQl0aGlzLl9jbGlja09mZnNldCA9IG51bGw7CgkJdGhpcy5fYW5pbWF0ZU9mZiA9IGZhbHNlOwoKCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCV9kZXRlY3RPcmllbnRhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5vcmllbnRhdGlvbiA9ICggdGhpcy5vcHRpb25zLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgPyAidmVydGljYWwiIDogImhvcml6b250YWwiOwoJfSwKCglfbm9ybVZhbHVlRnJvbU1vdXNlOiBmdW5jdGlvbiggcG9zaXRpb24gKSB7CgkJdmFyIHBpeGVsVG90YWwsCgkJCXBpeGVsTW91c2UsCgkJCXBlcmNlbnRNb3VzZSwKCQkJdmFsdWVUb3RhbCwKCQkJdmFsdWVNb3VzZTsKCgkJaWYgKCB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7CgkJCXBpeGVsVG90YWwgPSB0aGlzLmVsZW1lbnRTaXplLndpZHRoOwoJCQlwaXhlbE1vdXNlID0gcG9zaXRpb24ueCAtIHRoaXMuZWxlbWVudE9mZnNldC5sZWZ0IC0KCQkJCSggdGhpcy5fY2xpY2tPZmZzZXQgPyB0aGlzLl9jbGlja09mZnNldC5sZWZ0IDogMCApOwoJCX0gZWxzZSB7CgkJCXBpeGVsVG90YWwgPSB0aGlzLmVsZW1lbnRTaXplLmhlaWdodDsKCQkJcGl4ZWxNb3VzZSA9IHBvc2l0aW9uLnkgLSB0aGlzLmVsZW1lbnRPZmZzZXQudG9wIC0KCQkJCSggdGhpcy5fY2xpY2tPZmZzZXQgPyB0aGlzLl9jbGlja09mZnNldC50b3AgOiAwICk7CgkJfQoKCQlwZXJjZW50TW91c2UgPSAoIHBpeGVsTW91c2UgLyBwaXhlbFRvdGFsICk7CgkJaWYgKCBwZXJjZW50TW91c2UgPiAxICkgewoJCQlwZXJjZW50TW91c2UgPSAxOwoJCX0KCQlpZiAoIHBlcmNlbnRNb3VzZSA8IDAgKSB7CgkJCXBlcmNlbnRNb3VzZSA9IDA7CgkJfQoJCWlmICggdGhpcy5vcmllbnRhdGlvbiA9PT0gInZlcnRpY2FsIiApIHsKCQkJcGVyY2VudE1vdXNlID0gMSAtIHBlcmNlbnRNb3VzZTsKCQl9CgoJCXZhbHVlVG90YWwgPSB0aGlzLl92YWx1ZU1heCgpIC0gdGhpcy5fdmFsdWVNaW4oKTsKCQl2YWx1ZU1vdXNlID0gdGhpcy5fdmFsdWVNaW4oKSArIHBlcmNlbnRNb3VzZSAqIHZhbHVlVG90YWw7CgoJCXJldHVybiB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsdWVNb3VzZSApOwoJfSwKCglfdWlIYXNoOiBmdW5jdGlvbiggaW5kZXgsIHZhbHVlLCB2YWx1ZXMgKSB7CgkJdmFyIHVpSGFzaCA9IHsKCQkJaGFuZGxlOiB0aGlzLmhhbmRsZXNbIGluZGV4IF0sCgkJCWhhbmRsZUluZGV4OiBpbmRleCwKCQkJdmFsdWU6IHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IHRoaXMudmFsdWUoKQoJCX07CgoJCWlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsKCQkJdWlIYXNoLnZhbHVlID0gdmFsdWUgIT09IHVuZGVmaW5lZCA\/IHZhbHVlIDogdGhpcy52YWx1ZXMoIGluZGV4ICk7CgkJCXVpSGFzaC52YWx1ZXMgPSB2YWx1ZXMgfHwgdGhpcy52YWx1ZXMoKTsKCQl9CgoJCXJldHVybiB1aUhhc2g7Cgl9LAoKCV9oYXNNdWx0aXBsZVZhbHVlczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMub3B0aW9ucy52YWx1ZXMgJiYgdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGg7Cgl9LAoKCV9zdGFydDogZnVuY3Rpb24oIGV2ZW50LCBpbmRleCApIHsKCQlyZXR1cm4gdGhpcy5fdHJpZ2dlciggInN0YXJ0IiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggaW5kZXggKSApOwoJfSwKCglfc2xpZGU6IGZ1bmN0aW9uKCBldmVudCwgaW5kZXgsIG5ld1ZhbCApIHsKCQl2YXIgYWxsb3dlZCwgb3RoZXJWYWwsCgkJCWN1cnJlbnRWYWx1ZSA9IHRoaXMudmFsdWUoKSwKCQkJbmV3VmFsdWVzID0gdGhpcy52YWx1ZXMoKTsKCgkJaWYgKCB0aGlzLl9oYXNNdWx0aXBsZVZhbHVlcygpICkgewoJCQlvdGhlclZhbCA9IHRoaXMudmFsdWVzKCBpbmRleCA\/IDAgOiAxICk7CgkJCWN1cnJlbnRWYWx1ZSA9IHRoaXMudmFsdWVzKCBpbmRleCApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMudmFsdWVzLmxlbmd0aCA9PT0gMiAmJiB0aGlzLm9wdGlvbnMucmFuZ2UgPT09IHRydWUgKSB7CgkJCQluZXdWYWwgPSAgaW5kZXggPT09IDAgPyBNYXRoLm1pbiggb3RoZXJWYWwsIG5ld1ZhbCApIDogTWF0aC5tYXgoIG90aGVyVmFsLCBuZXdWYWwgKTsKCQkJfQoKCQkJbmV3VmFsdWVzWyBpbmRleCBdID0gbmV3VmFsOwoJCX0KCgkJaWYgKCBuZXdWYWwgPT09IGN1cnJlbnRWYWx1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJYWxsb3dlZCA9IHRoaXMuX3RyaWdnZXIoICJzbGlkZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goIGluZGV4LCBuZXdWYWwsIG5ld1ZhbHVlcyApICk7CgoJCS8vIEEgc2xpZGUgY2FuIGJlIGNhbmNlbGVkIGJ5IHJldHVybmluZyBmYWxzZSBmcm9tIHRoZSBzbGlkZSBjYWxsYmFjawoJCWlmICggYWxsb3dlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsKCQkJdGhpcy52YWx1ZXMoIGluZGV4LCBuZXdWYWwgKTsKCQl9IGVsc2UgewoJCQl0aGlzLnZhbHVlKCBuZXdWYWwgKTsKCQl9Cgl9LAoKCV9zdG9wOiBmdW5jdGlvbiggZXZlbnQsIGluZGV4ICkgewoJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggaW5kZXggKSApOwoJfSwKCglfY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQsIGluZGV4ICkgewoJCWlmICggIXRoaXMuX2tleVNsaWRpbmcgJiYgIXRoaXMuX21vdXNlU2xpZGluZyApIHsKCgkJCS8vc3RvcmUgdGhlIGxhc3QgY2hhbmdlZCB2YWx1ZSBpbmRleCBmb3IgcmVmZXJlbmNlIHdoZW4gaGFuZGxlcyBvdmVybGFwCgkJCXRoaXMuX2xhc3RDaGFuZ2VkVmFsdWUgPSBpbmRleDsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goIGluZGV4ICkgKTsKCQl9Cgl9LAoKCXZhbHVlOiBmdW5jdGlvbiggbmV3VmFsdWUgKSB7CgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLm9wdGlvbnMudmFsdWUgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggbmV3VmFsdWUgKTsKCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7CgkJCXRoaXMuX2NoYW5nZSggbnVsbCwgMCApOwoJCQlyZXR1cm47CgkJfQoKCQlyZXR1cm4gdGhpcy5fdmFsdWUoKTsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbiggaW5kZXgsIG5ld1ZhbHVlICkgewoJCXZhciB2YWxzLAoJCQluZXdWYWx1ZXMsCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA+IDEgKSB7CgkJCXRoaXMub3B0aW9ucy52YWx1ZXNbIGluZGV4IF0gPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggbmV3VmFsdWUgKTsKCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7CgkJCXRoaXMuX2NoYW5nZSggbnVsbCwgaW5kZXggKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQlpZiAoICQuaXNBcnJheSggYXJndW1lbnRzWyAwIF0gKSApIHsKCQkJCXZhbHMgPSB0aGlzLm9wdGlvbnMudmFsdWVzOwoJCQkJbmV3VmFsdWVzID0gYXJndW1lbnRzWyAwIF07CgkJCQlmb3IgKCBpID0gMDsgaSA8IHZhbHMubGVuZ3RoOyBpICs9IDEgKSB7CgkJCQkJdmFsc1sgaSBdID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoIG5ld1ZhbHVlc1sgaSBdICk7CgkJCQkJdGhpcy5fY2hhbmdlKCBudWxsLCBpICk7CgkJCQl9CgkJCQl0aGlzLl9yZWZyZXNoVmFsdWUoKTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsKCQkJCQlyZXR1cm4gdGhpcy5fdmFsdWVzKCBpbmRleCApOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXR1cm4gdGhpcy52YWx1ZSgpOwoJCQkJfQoJCQl9CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuX3ZhbHVlcygpOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIGksCgkJCXZhbHNMZW5ndGggPSAwOwoKCQlpZiAoIGtleSA9PT0gInJhbmdlIiAmJiB0aGlzLm9wdGlvbnMucmFuZ2UgPT09IHRydWUgKSB7CgkJCWlmICggdmFsdWUgPT09ICJtaW4iICkgewoJCQkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fdmFsdWVzKCAwICk7CgkJCQl0aGlzLm9wdGlvbnMudmFsdWVzID0gbnVsbDsKCQkJfSBlbHNlIGlmICggdmFsdWUgPT09ICJtYXgiICkgewoJCQkJdGhpcy5vcHRpb25zLnZhbHVlID0gdGhpcy5fdmFsdWVzKCB0aGlzLm9wdGlvbnMudmFsdWVzLmxlbmd0aCAtIDEgKTsKCQkJCXRoaXMub3B0aW9ucy52YWx1ZXMgPSBudWxsOwoJCQl9CgkJfQoKCQlpZiAoICQuaXNBcnJheSggdGhpcy5vcHRpb25zLnZhbHVlcyApICkgewoJCQl2YWxzTGVuZ3RoID0gdGhpcy5vcHRpb25zLnZhbHVlcy5sZW5ndGg7CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlzd2l0Y2ggKCBrZXkgKSB7CgkJCWNhc2UgIm9yaWVudGF0aW9uIjoKCQkJCXRoaXMuX2RldGVjdE9yaWVudGF0aW9uKCk7CgkJCQl0aGlzLl9yZW1vdmVDbGFzcyggInVpLXNsaWRlci1ob3Jpem9udGFsIHVpLXNsaWRlci12ZXJ0aWNhbCIgKQoJCQkJCS5fYWRkQ2xhc3MoICJ1aS1zbGlkZXItIiArIHRoaXMub3JpZW50YXRpb24gKTsKCQkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQkJaWYgKCB0aGlzLm9wdGlvbnMucmFuZ2UgKSB7CgkJCQkJdGhpcy5fcmVmcmVzaFJhbmdlKCB2YWx1ZSApOwoJCQkJfQoKCQkJCS8vIFJlc2V0IHBvc2l0aW9uaW5nIGZyb20gcHJldmlvdXMgb3JpZW50YXRpb24KCQkJCXRoaXMuaGFuZGxlcy5jc3MoIHZhbHVlID09PSAiaG9yaXpvbnRhbCIgPyAiYm90dG9tIiA6ICJsZWZ0IiwgIiIgKTsKCQkJCWJyZWFrOwoJCQljYXNlICJ2YWx1ZSI6CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gdHJ1ZTsKCQkJCXRoaXMuX3JlZnJlc2hWYWx1ZSgpOwoJCQkJdGhpcy5fY2hhbmdlKCBudWxsLCAwICk7CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7CgkJCQlicmVhazsKCQkJY2FzZSAidmFsdWVzIjoKCQkJCXRoaXMuX2FuaW1hdGVPZmYgPSB0cnVlOwoJCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7CgoJCQkJLy8gU3RhcnQgZnJvbSB0aGUgbGFzdCBoYW5kbGUgdG8gcHJldmVudCB1bnJlYWNoYWJsZSBoYW5kbGVzICgjOTA0NikKCQkJCWZvciAoIGkgPSB2YWxzTGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJdGhpcy5fY2hhbmdlKCBudWxsLCBpICk7CgkJCQl9CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7CgkJCQlicmVhazsKCQkJY2FzZSAic3RlcCI6CgkJCWNhc2UgIm1pbiI6CgkJCWNhc2UgIm1heCI6CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gdHJ1ZTsKCQkJCXRoaXMuX2NhbGN1bGF0ZU5ld01heCgpOwoJCQkJdGhpcy5fcmVmcmVzaFZhbHVlKCk7CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7CgkJCQlicmVhazsKCQkJY2FzZSAicmFuZ2UiOgoJCQkJdGhpcy5fYW5pbWF0ZU9mZiA9IHRydWU7CgkJCQl0aGlzLl9yZWZyZXNoKCk7CgkJCQl0aGlzLl9hbmltYXRlT2ZmID0gZmFsc2U7CgkJCQlicmVhazsKCQl9Cgl9LAoKCV9zZXRPcHRpb25EaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuX3N1cGVyKCB2YWx1ZSApOwoKCQl0aGlzLl90b2dnbGVDbGFzcyggbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJfSwKCgkvL2ludGVybmFsIHZhbHVlIGdldHRlcgoJLy8gX3ZhbHVlKCkgcmV0dXJucyB2YWx1ZSB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4LCBhbGlnbmVkIGJ5IHN0ZXAKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHZhbCA9IHRoaXMub3B0aW9ucy52YWx1ZTsKCQl2YWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggdmFsICk7CgoJCXJldHVybiB2YWw7Cgl9LAoKCS8vaW50ZXJuYWwgdmFsdWVzIGdldHRlcgoJLy8gX3ZhbHVlcygpIHJldHVybnMgYXJyYXkgb2YgdmFsdWVzIHRyaW1tZWQgYnkgbWluIGFuZCBtYXgsIGFsaWduZWQgYnkgc3RlcAoJLy8gX3ZhbHVlcyggaW5kZXggKSByZXR1cm5zIHNpbmdsZSB2YWx1ZSB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4LCBhbGlnbmVkIGJ5IHN0ZXAKCV92YWx1ZXM6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgdmFsLAoJCQl2YWxzLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXZhbCA9IHRoaXMub3B0aW9ucy52YWx1ZXNbIGluZGV4IF07CgkJCXZhbCA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCB2YWwgKTsKCgkJCXJldHVybiB2YWw7CgkJfSBlbHNlIGlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsKCgkJCS8vIC5zbGljZSgpIGNyZWF0ZXMgYSBjb3B5IG9mIHRoZSBhcnJheQoJCQkvLyB0aGlzIGNvcHkgZ2V0cyB0cmltbWVkIGJ5IG1pbiBhbmQgbWF4IGFuZCB0aGVuIHJldHVybmVkCgkJCXZhbHMgPSB0aGlzLm9wdGlvbnMudmFsdWVzLnNsaWNlKCk7CgkJCWZvciAoIGkgPSAwOyBpIDwgdmFscy5sZW5ndGg7IGkgKz0gMSApIHsKCQkJCXZhbHNbIGkgXSA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCB2YWxzWyBpIF0gKTsKCQkJfQoKCQkJcmV0dXJuIHZhbHM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIFtdOwoJCX0KCX0sCgoJLy8gUmV0dXJucyB0aGUgc3RlcC1hbGlnbmVkIHZhbHVlIHRoYXQgdmFsIGlzIGNsb3Nlc3QgdG8sIGJldHdlZW4gKGluY2x1c2l2ZSkgbWluIGFuZCBtYXgKCV90cmltQWxpZ25WYWx1ZTogZnVuY3Rpb24oIHZhbCApIHsKCQlpZiAoIHZhbCA8PSB0aGlzLl92YWx1ZU1pbigpICkgewoJCQlyZXR1cm4gdGhpcy5fdmFsdWVNaW4oKTsKCQl9CgkJaWYgKCB2YWwgPj0gdGhpcy5fdmFsdWVNYXgoKSApIHsKCQkJcmV0dXJuIHRoaXMuX3ZhbHVlTWF4KCk7CgkJfQoJCXZhciBzdGVwID0gKCB0aGlzLm9wdGlvbnMuc3RlcCA+IDAgKSA\/IHRoaXMub3B0aW9ucy5zdGVwIDogMSwKCQkJdmFsTW9kU3RlcCA9ICggdmFsIC0gdGhpcy5fdmFsdWVNaW4oKSApICUgc3RlcCwKCQkJYWxpZ25WYWx1ZSA9IHZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgIzQxMjQpCgkJcmV0dXJuIHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCggNSApICk7Cgl9LAoKCV9jYWxjdWxhdGVOZXdNYXg6IGZ1bmN0aW9uKCkgewoJCXZhciBtYXggPSB0aGlzLm9wdGlvbnMubWF4LAoJCQltaW4gPSB0aGlzLl92YWx1ZU1pbigpLAoJCQlzdGVwID0gdGhpcy5vcHRpb25zLnN0ZXAsCgkJCWFib3ZlTWluID0gTWF0aC5yb3VuZCggKCBtYXggLSBtaW4gKSAvIHN0ZXAgKSAqIHN0ZXA7CgkJbWF4ID0gYWJvdmVNaW4gKyBtaW47CgkJaWYgKCBtYXggPiB0aGlzLm9wdGlvbnMubWF4ICkgewoKCQkJLy9JZiBtYXggaXMgbm90IGRpdmlzaWJsZSBieSBzdGVwLCByb3VuZGluZyBvZmYgbWF5IGluY3JlYXNlIGl0cyB2YWx1ZQoJCQltYXggLT0gc3RlcDsKCQl9CgkJdGhpcy5tYXggPSBwYXJzZUZsb2F0KCBtYXgudG9GaXhlZCggdGhpcy5fcHJlY2lzaW9uKCkgKSApOwoJfSwKCglfcHJlY2lzaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgcHJlY2lzaW9uID0gdGhpcy5fcHJlY2lzaW9uT2YoIHRoaXMub3B0aW9ucy5zdGVwICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMubWluICE9PSBudWxsICkgewoJCQlwcmVjaXNpb24gPSBNYXRoLm1heCggcHJlY2lzaW9uLCB0aGlzLl9wcmVjaXNpb25PZiggdGhpcy5vcHRpb25zLm1pbiApICk7CgkJfQoJCXJldHVybiBwcmVjaXNpb247Cgl9LAoKCV9wcmVjaXNpb25PZjogZnVuY3Rpb24oIG51bSApIHsKCQl2YXIgc3RyID0gbnVtLnRvU3RyaW5nKCksCgkJCWRlY2ltYWwgPSBzdHIuaW5kZXhPZiggIi4iICk7CgkJcmV0dXJuIGRlY2ltYWwgPT09IC0xID8gMCA6IHN0ci5sZW5ndGggLSBkZWNpbWFsIC0gMTsKCX0sCgoJX3ZhbHVlTWluOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5vcHRpb25zLm1pbjsKCX0sCgoJX3ZhbHVlTWF4OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5tYXg7Cgl9LAoKCV9yZWZyZXNoUmFuZ2U6IGZ1bmN0aW9uKCBvcmllbnRhdGlvbiApIHsKCQlpZiAoIG9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgewoJCQl0aGlzLnJhbmdlLmNzcyggeyAid2lkdGgiOiAiIiwgImxlZnQiOiAiIiB9ICk7CgkJfQoJCWlmICggb3JpZW50YXRpb24gPT09ICJob3Jpem9udGFsIiApIHsKCQkJdGhpcy5yYW5nZS5jc3MoIHsgImhlaWdodCI6ICIiLCAiYm90dG9tIjogIiIgfSApOwoJCX0KCX0sCgoJX3JlZnJlc2hWYWx1ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGxhc3RWYWxQZXJjZW50LCB2YWxQZXJjZW50LCB2YWx1ZSwgdmFsdWVNaW4sIHZhbHVlTWF4LAoJCQlvUmFuZ2UgPSB0aGlzLm9wdGlvbnMucmFuZ2UsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXRoYXQgPSB0aGlzLAoJCQlhbmltYXRlID0gKCAhdGhpcy5fYW5pbWF0ZU9mZiApID8gby5hbmltYXRlIDogZmFsc2UsCgkJCV9zZXQgPSB7fTsKCgkJaWYgKCB0aGlzLl9oYXNNdWx0aXBsZVZhbHVlcygpICkgewoJCQl0aGlzLmhhbmRsZXMuZWFjaCggZnVuY3Rpb24oIGkgKSB7CgkJCQl2YWxQZXJjZW50ID0gKCB0aGF0LnZhbHVlcyggaSApIC0gdGhhdC5fdmFsdWVNaW4oKSApIC8gKCB0aGF0Ll92YWx1ZU1heCgpIC0KCQkJCQl0aGF0Ll92YWx1ZU1pbigpICkgKiAxMDA7CgkJCQlfc2V0WyB0aGF0Lm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgPyAibGVmdCIgOiAiYm90dG9tIiBdID0gdmFsUGVyY2VudCArICIlIjsKCQkJCSQoIHRoaXMgKS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCBfc2V0LCBvLmFuaW1hdGUgKTsKCQkJCWlmICggdGhhdC5vcHRpb25zLnJhbmdlID09PSB0cnVlICkgewoJCQkJCWlmICggdGhhdC5vcmllbnRhdGlvbiA9PT0gImhvcml6b250YWwiICkgewoJCQkJCQlpZiAoIGkgPT09IDAgKSB7CgkJCQkJCQl0aGF0LnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA\/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsKCQkJCQkJCQlsZWZ0OiB2YWxQZXJjZW50ICsgIiUiCgkJCQkJCQl9LCBvLmFuaW1hdGUgKTsKCQkJCQkJfQoJCQkJCQlpZiAoIGkgPT09IDEgKSB7CgkJCQkJCQl0aGF0LnJhbmdlWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggewoJCQkJCQkJCXdpZHRoOiAoIHZhbFBlcmNlbnQgLSBsYXN0VmFsUGVyY2VudCApICsgIiUiCgkJCQkJCQl9LCB7CgkJCQkJCQkJcXVldWU6IGZhbHNlLAoJCQkJCQkJCWR1cmF0aW9uOiBvLmFuaW1hdGUKCQkJCQkJCX0gKTsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCWlmICggaSA9PT0gMCApIHsKCQkJCQkJCXRoYXQucmFuZ2Uuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggewoJCQkJCQkJCWJvdHRvbTogKCB2YWxQZXJjZW50ICkgKyAiJSIKCQkJCQkJCX0sIG8uYW5pbWF0ZSApOwoJCQkJCQl9CgkJCQkJCWlmICggaSA9PT0gMSApIHsKCQkJCQkJCXRoYXQucmFuZ2VbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7CgkJCQkJCQkJaGVpZ2h0OiAoIHZhbFBlcmNlbnQgLSBsYXN0VmFsUGVyY2VudCApICsgIiUiCgkJCQkJCQl9LCB7CgkJCQkJCQkJcXVldWU6IGZhbHNlLAoJCQkJCQkJCWR1cmF0aW9uOiBvLmFuaW1hdGUKCQkJCQkJCX0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJCWxhc3RWYWxQZXJjZW50ID0gdmFsUGVyY2VudDsKCQkJfSApOwoJCX0gZWxzZSB7CgkJCXZhbHVlID0gdGhpcy52YWx1ZSgpOwoJCQl2YWx1ZU1pbiA9IHRoaXMuX3ZhbHVlTWluKCk7CgkJCXZhbHVlTWF4ID0gdGhpcy5fdmFsdWVNYXgoKTsKCQkJdmFsUGVyY2VudCA9ICggdmFsdWVNYXggIT09IHZhbHVlTWluICkgPwoJCQkJCSggdmFsdWUgLSB2YWx1ZU1pbiApIC8gKCB2YWx1ZU1heCAtIHZhbHVlTWluICkgKiAxMDAgOgoJCQkJCTA7CgkJCV9zZXRbIHRoaXMub3JpZW50YXRpb24gPT09ICJob3Jpem9udGFsIiA\/ICJsZWZ0IiA6ICJib3R0b20iIF0gPSB2YWxQZXJjZW50ICsgIiUiOwoJCQl0aGlzLmhhbmRsZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCBfc2V0LCBvLmFuaW1hdGUgKTsKCgkJCWlmICggb1JhbmdlID09PSAibWluIiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAiaG9yaXpvbnRhbCIgKSB7CgkJCQl0aGlzLnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA\/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsKCQkJCQl3aWR0aDogdmFsUGVyY2VudCArICIlIgoJCQkJfSwgby5hbmltYXRlICk7CgkJCX0KCQkJaWYgKCBvUmFuZ2UgPT09ICJtYXgiICYmIHRoaXMub3JpZW50YXRpb24gPT09ICJob3Jpem9udGFsIiApIHsKCQkJCXRoaXMucmFuZ2Uuc3RvcCggMSwgMSApWyBhbmltYXRlID8gImFuaW1hdGUiIDogImNzcyIgXSggewoJCQkJCXdpZHRoOiAoIDEwMCAtIHZhbFBlcmNlbnQgKSArICIlIgoJCQkJfSwgby5hbmltYXRlICk7CgkJCX0KCQkJaWYgKCBvUmFuZ2UgPT09ICJtaW4iICYmIHRoaXMub3JpZW50YXRpb24gPT09ICJ2ZXJ0aWNhbCIgKSB7CgkJCQl0aGlzLnJhbmdlLnN0b3AoIDEsIDEgKVsgYW5pbWF0ZSA\/ICJhbmltYXRlIiA6ICJjc3MiIF0oIHsKCQkJCQloZWlnaHQ6IHZhbFBlcmNlbnQgKyAiJSIKCQkJCX0sIG8uYW5pbWF0ZSApOwoJCQl9CgkJCWlmICggb1JhbmdlID09PSAibWF4IiAmJiB0aGlzLm9yaWVudGF0aW9uID09PSAidmVydGljYWwiICkgewoJCQkJdGhpcy5yYW5nZS5zdG9wKCAxLCAxIClbIGFuaW1hdGUgPyAiYW5pbWF0ZSIgOiAiY3NzIiBdKCB7CgkJCQkJaGVpZ2h0OiAoIDEwMCAtIHZhbFBlcmNlbnQgKSArICIlIgoJCQkJfSwgby5hbmltYXRlICk7CgkJCX0KCQl9Cgl9LAoKCV9oYW5kbGVFdmVudHM6IHsKCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBhbGxvd2VkLCBjdXJWYWwsIG5ld1ZhbCwgc3RlcCwKCQkJCWluZGV4ID0gJCggZXZlbnQudGFyZ2V0ICkuZGF0YSggInVpLXNsaWRlci1oYW5kbGUtaW5kZXgiICk7CgoJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLlBBR0VfVVA6CgkJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX0RPV046CgkJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQkJdGhpcy5fYWRkQ2xhc3MoICQoIGV2ZW50LnRhcmdldCApLCBudWxsLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJCQlhbGxvd2VkID0gdGhpcy5fc3RhcnQoIGV2ZW50LCBpbmRleCApOwoJCQkJCQlpZiAoIGFsbG93ZWQgPT09IGZhbHNlICkgewoJCQkJCQkJcmV0dXJuOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWJyZWFrOwoJCQl9CgoJCQlzdGVwID0gdGhpcy5vcHRpb25zLnN0ZXA7CgkJCWlmICggdGhpcy5faGFzTXVsdGlwbGVWYWx1ZXMoKSApIHsKCQkJCWN1clZhbCA9IG5ld1ZhbCA9IHRoaXMudmFsdWVzKCBpbmRleCApOwoJCQl9IGVsc2UgewoJCQkJY3VyVmFsID0gbmV3VmFsID0gdGhpcy52YWx1ZSgpOwoJCQl9CgoJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCQluZXdWYWwgPSB0aGlzLl92YWx1ZU1pbigpOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAkLnVpLmtleUNvZGUuRU5EOgoJCQkJCW5ld1ZhbCA9IHRoaXMuX3ZhbHVlTWF4KCk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX1VQOgoJCQkJCW5ld1ZhbCA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKAoJCQkJCQljdXJWYWwgKyAoICggdGhpcy5fdmFsdWVNYXgoKSAtIHRoaXMuX3ZhbHVlTWluKCkgKSAvIHRoaXMubnVtUGFnZXMgKQoJCQkJCSk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICQudWkua2V5Q29kZS5QQUdFX0RPV046CgkJCQkJbmV3VmFsID0gdGhpcy5fdHJpbUFsaWduVmFsdWUoCgkJCQkJCWN1clZhbCAtICggKCB0aGlzLl92YWx1ZU1heCgpIC0gdGhpcy5fdmFsdWVNaW4oKSApIC8gdGhpcy5udW1QYWdlcyApICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJCWNhc2UgJC51aS5rZXlDb2RlLlJJR0hUOgoJCQkJCWlmICggY3VyVmFsID09PSB0aGlzLl92YWx1ZU1heCgpICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJCW5ld1ZhbCA9IHRoaXMuX3RyaW1BbGlnblZhbHVlKCBjdXJWYWwgKyBzdGVwICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCQlpZiAoIGN1clZhbCA9PT0gdGhpcy5fdmFsdWVNaW4oKSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQluZXdWYWwgPSB0aGlzLl90cmltQWxpZ25WYWx1ZSggY3VyVmFsIC0gc3RlcCApOwoJCQkJCWJyZWFrOwoJCQl9CgoJCQl0aGlzLl9zbGlkZSggZXZlbnQsIGluZGV4LCBuZXdWYWwgKTsKCQl9LAoJCWtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBpbmRleCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJ1aS1zbGlkZXItaGFuZGxlLWluZGV4IiApOwoKCQkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJdGhpcy5fa2V5U2xpZGluZyA9IGZhbHNlOwoJCQkJdGhpcy5fc3RvcCggZXZlbnQsIGluZGV4ICk7CgkJCQl0aGlzLl9jaGFuZ2UoIGV2ZW50LCBpbmRleCApOwoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoICQoIGV2ZW50LnRhcmdldCApLCBudWxsLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQl9CgkJfQoJfQp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBTb3J0YWJsZSAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFNvcnRhYmxlCi8vPj5ncm91cDogSW50ZXJhY3Rpb25zCi8vPj5kZXNjcmlwdGlvbjogRW5hYmxlcyBpdGVtcyBpbiBhIGxpc3QgdG8gYmUgc29ydGVkIHVzaW5nIHRoZSBtb3VzZS4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3NvcnRhYmxlLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vc29ydGFibGUvCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9zb3J0YWJsZS5jc3MKCgoKdmFyIHdpZGdldHNTb3J0YWJsZSA9ICQud2lkZ2V0KCAidWkuc29ydGFibGUiLCAkLnVpLm1vdXNlLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCXdpZGdldEV2ZW50UHJlZml4OiAic29ydCIsCglyZWFkeTogZmFsc2UsCglvcHRpb25zOiB7CgkJYXBwZW5kVG86ICJwYXJlbnQiLAoJCWF4aXM6IGZhbHNlLAoJCWNvbm5lY3RXaXRoOiBmYWxzZSwKCQljb250YWlubWVudDogZmFsc2UsCgkJY3Vyc29yOiAiYXV0byIsCgkJY3Vyc29yQXQ6IGZhbHNlLAoJCWRyb3BPbkVtcHR5OiB0cnVlLAoJCWZvcmNlUGxhY2Vob2xkZXJTaXplOiBmYWxzZSwKCQlmb3JjZUhlbHBlclNpemU6IGZhbHNlLAoJCWdyaWQ6IGZhbHNlLAoJCWhhbmRsZTogZmFsc2UsCgkJaGVscGVyOiAib3JpZ2luYWwiLAoJCWl0ZW1zOiAiPiAqIiwKCQlvcGFjaXR5OiBmYWxzZSwKCQlwbGFjZWhvbGRlcjogZmFsc2UsCgkJcmV2ZXJ0OiBmYWxzZSwKCQlzY3JvbGw6IHRydWUsCgkJc2Nyb2xsU2Vuc2l0aXZpdHk6IDIwLAoJCXNjcm9sbFNwZWVkOiAyMCwKCQlzY29wZTogImRlZmF1bHQiLAoJCXRvbGVyYW5jZTogImludGVyc2VjdCIsCgkJekluZGV4OiAxMDAwLAoKCQkvLyBDYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVTdG9wOiBudWxsLAoJCWNoYW5nZTogbnVsbCwKCQlkZWFjdGl2YXRlOiBudWxsLAoJCW91dDogbnVsbCwKCQlvdmVyOiBudWxsLAoJCXJlY2VpdmU6IG51bGwsCgkJcmVtb3ZlOiBudWxsLAoJCXNvcnQ6IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbCwKCQl1cGRhdGU6IG51bGwKCX0sCgoJX2lzT3ZlckF4aXM6IGZ1bmN0aW9uKCB4LCByZWZlcmVuY2UsIHNpemUgKSB7CgkJcmV0dXJuICggeCA+PSByZWZlcmVuY2UgKSAmJiAoIHggPCAoIHJlZmVyZW5jZSArIHNpemUgKSApOwoJfSwKCglfaXNGbG9hdGluZzogZnVuY3Rpb24oIGl0ZW0gKSB7CgkJcmV0dXJuICggL2xlZnR8cmlnaHQvICkudGVzdCggaXRlbS5jc3MoICJmbG9hdCIgKSApIHx8CgkJCSggL2lubGluZXx0YWJsZS1jZWxsLyApLnRlc3QoIGl0ZW0uY3NzKCAiZGlzcGxheSIgKSApOwoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmNvbnRhaW5lckNhY2hlID0ge307CgkJdGhpcy5fYWRkQ2xhc3MoICJ1aS1zb3J0YWJsZSIgKTsKCgkJLy9HZXQgdGhlIGl0ZW1zCgkJdGhpcy5yZWZyZXNoKCk7CgoJCS8vTGV0J3MgZGV0ZXJtaW5lIHRoZSBwYXJlbnQncyBvZmZzZXQKCQl0aGlzLm9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCgkJLy9Jbml0aWFsaXplIG1vdXNlIGV2ZW50cyBmb3IgaW50ZXJhY3Rpb24KCQl0aGlzLl9tb3VzZUluaXQoKTsKCgkJdGhpcy5fc2V0SGFuZGxlQ2xhc3NOYW1lKCk7CgoJCS8vV2UncmUgcmVhZHkgdG8gZ28KCQl0aGlzLnJlYWR5ID0gdHJ1ZTsKCgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlICk7CgoJCWlmICgga2V5ID09PSAiaGFuZGxlIiApIHsKCQkJdGhpcy5fc2V0SGFuZGxlQ2xhc3NOYW1lKCk7CgkJfQoJfSwKCglfc2V0SGFuZGxlQ2xhc3NOYW1lOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXNvcnRhYmxlLWhhbmRsZSIgKSwgInVpLXNvcnRhYmxlLWhhbmRsZSIgKTsKCQkkLmVhY2goIHRoaXMuaXRlbXMsIGZ1bmN0aW9uKCkgewoJCQl0aGF0Ll9hZGRDbGFzcygKCQkJCXRoaXMuaW5zdGFuY2Uub3B0aW9ucy5oYW5kbGUgPwoJCQkJCXRoaXMuaXRlbS5maW5kKCB0aGlzLmluc3RhbmNlLm9wdGlvbnMuaGFuZGxlICkgOgoJCQkJCXRoaXMuaXRlbSwKCQkJCSJ1aS1zb3J0YWJsZS1oYW5kbGUiCgkJCSk7CgkJfSApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fbW91c2VEZXN0cm95KCk7CgoJCWZvciAoIHZhciBpID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJdGhpcy5pdGVtc1sgaSBdLml0ZW0ucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICsgIi1pdGVtIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9tb3VzZUNhcHR1cmU6IGZ1bmN0aW9uKCBldmVudCwgb3ZlcnJpZGVIYW5kbGUgKSB7CgkJdmFyIGN1cnJlbnRJdGVtID0gbnVsbCwKCQkJdmFsaWRIYW5kbGUgPSBmYWxzZSwKCQkJdGhhdCA9IHRoaXM7CgoJCWlmICggdGhpcy5yZXZlcnRpbmcgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8IHRoaXMub3B0aW9ucy50eXBlID09PSAic3RhdGljIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy9XZSBoYXZlIHRvIHJlZnJlc2ggdGhlIGl0ZW1zIGRhdGEgb25jZSBmaXJzdAoJCXRoaXMuX3JlZnJlc2hJdGVtcyggZXZlbnQgKTsKCgkJLy9GaW5kIG91dCBpZiB0aGUgY2xpY2tlZCBub2RlIChvciBvbmUgb2YgaXRzIHBhcmVudHMpIGlzIGEgYWN0dWFsIGl0ZW0gaW4gdGhpcy5pdGVtcwoJCSQoIGV2ZW50LnRhcmdldCApLnBhcmVudHMoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJaWYgKCAkLmRhdGEoIHRoaXMsIHRoYXQud2lkZ2V0TmFtZSArICItaXRlbSIgKSA9PT0gdGhhdCApIHsKCQkJCWN1cnJlbnRJdGVtID0gJCggdGhpcyApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSApOwoJCWlmICggJC5kYXRhKCBldmVudC50YXJnZXQsIHRoYXQud2lkZ2V0TmFtZSArICItaXRlbSIgKSA9PT0gdGhhdCApIHsKCQkJY3VycmVudEl0ZW0gPSAkKCBldmVudC50YXJnZXQgKTsKCQl9CgoJCWlmICggIWN1cnJlbnRJdGVtICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggdGhpcy5vcHRpb25zLmhhbmRsZSAmJiAhb3ZlcnJpZGVIYW5kbGUgKSB7CgkJCSQoIHRoaXMub3B0aW9ucy5oYW5kbGUsIGN1cnJlbnRJdGVtICkuZmluZCggIioiICkuYWRkQmFjaygpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzID09PSBldmVudC50YXJnZXQgKSB7CgkJCQkJdmFsaWRIYW5kbGUgPSB0cnVlOwoJCQkJfQoJCQl9ICk7CgkJCWlmICggIXZhbGlkSGFuZGxlICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfQoKCQl0aGlzLmN1cnJlbnRJdGVtID0gY3VycmVudEl0ZW07CgkJdGhpcy5fcmVtb3ZlQ3VycmVudHNGcm9tSXRlbXMoKTsKCQlyZXR1cm4gdHJ1ZTsKCgl9LAoKCV9tb3VzZVN0YXJ0OiBmdW5jdGlvbiggZXZlbnQsIG92ZXJyaWRlSGFuZGxlLCBub0FjdGl2YXRpb24gKSB7CgoJCXZhciBpLCBib2R5LAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLmN1cnJlbnRDb250YWluZXIgPSB0aGlzOwoKCQkvL1dlIG9ubHkgbmVlZCB0byBjYWxsIHJlZnJlc2hQb3NpdGlvbnMsIGJlY2F1c2UgdGhlIHJlZnJlc2hJdGVtcyBjYWxsIGhhcyBiZWVuIG1vdmVkIHRvCgkJLy8gbW91c2VDYXB0dXJlCgkJdGhpcy5yZWZyZXNoUG9zaXRpb25zKCk7CgoJCS8vQ3JlYXRlIGFuZCBhcHBlbmQgdGhlIHZpc2libGUgaGVscGVyCgkJdGhpcy5oZWxwZXIgPSB0aGlzLl9jcmVhdGVIZWxwZXIoIGV2ZW50ICk7CgoJCS8vQ2FjaGUgdGhlIGhlbHBlciBzaXplCgkJdGhpcy5fY2FjaGVIZWxwZXJQcm9wb3J0aW9ucygpOwoKCQkvKgoJCSAqIC0gUG9zaXRpb24gZ2VuZXJhdGlvbiAtCgkJICogVGhpcyBibG9jayBnZW5lcmF0ZXMgZXZlcnl0aGluZyBwb3NpdGlvbiByZWxhdGVkIC0gaXQncyB0aGUgY29yZSBvZiBkcmFnZ2FibGVzLgoJCSAqLwoKCQkvL0NhY2hlIHRoZSBtYXJnaW5zIG9mIHRoZSBvcmlnaW5hbCBlbGVtZW50CgkJdGhpcy5fY2FjaGVNYXJnaW5zKCk7CgoJCS8vR2V0IHRoZSBuZXh0IHNjcm9sbGluZyBwYXJlbnQKCQl0aGlzLnNjcm9sbFBhcmVudCA9IHRoaXMuaGVscGVyLnNjcm9sbFBhcmVudCgpOwoKCQkvL1RoZSBlbGVtZW50J3MgYWJzb2x1dGUgcG9zaXRpb24gb24gdGhlIHBhZ2UgbWludXMgbWFyZ2lucwoJCXRoaXMub2Zmc2V0ID0gdGhpcy5jdXJyZW50SXRlbS5vZmZzZXQoKTsKCQl0aGlzLm9mZnNldCA9IHsKCQkJdG9wOiB0aGlzLm9mZnNldC50b3AgLSB0aGlzLm1hcmdpbnMudG9wLAoJCQlsZWZ0OiB0aGlzLm9mZnNldC5sZWZ0IC0gdGhpcy5tYXJnaW5zLmxlZnQKCQl9OwoKCQkkLmV4dGVuZCggdGhpcy5vZmZzZXQsIHsKCQkJY2xpY2s6IHsgLy9XaGVyZSB0aGUgY2xpY2sgaGFwcGVuZWQsIHJlbGF0aXZlIHRvIHRoZSBlbGVtZW50CgkJCQlsZWZ0OiBldmVudC5wYWdlWCAtIHRoaXMub2Zmc2V0LmxlZnQsCgkJCQl0b3A6IGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQudG9wCgkJCX0sCgkJCXBhcmVudDogdGhpcy5fZ2V0UGFyZW50T2Zmc2V0KCksCgoJCQkvLyBUaGlzIGlzIGEgcmVsYXRpdmUgdG8gYWJzb2x1dGUgcG9zaXRpb24gbWludXMgdGhlIGFjdHVhbCBwb3NpdGlvbiBjYWxjdWxhdGlvbiAtCgkJCS8vIG9ubHkgdXNlZCBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBoZWxwZXIKCQkJcmVsYXRpdmU6IHRoaXMuX2dldFJlbGF0aXZlT2Zmc2V0KCkKCQl9ICk7CgoJCS8vIE9ubHkgYWZ0ZXIgd2UgZ290IHRoZSBvZmZzZXQsIHdlIGNhbiBjaGFuZ2UgdGhlIGhlbHBlcidzIHBvc2l0aW9uIHRvIGFic29sdXRlCgkJLy8gVE9ETzogU3RpbGwgbmVlZCB0byBmaWd1cmUgb3V0IGEgd2F5IHRvIG1ha2UgcmVsYXRpdmUgc29ydGluZyBwb3NzaWJsZQoJCXRoaXMuaGVscGVyLmNzcyggInBvc2l0aW9uIiwgImFic29sdXRlIiApOwoJCXRoaXMuY3NzUG9zaXRpb24gPSB0aGlzLmhlbHBlci5jc3MoICJwb3NpdGlvbiIgKTsKCgkJLy9HZW5lcmF0ZSB0aGUgb3JpZ2luYWwgcG9zaXRpb24KCQl0aGlzLm9yaWdpbmFsUG9zaXRpb24gPSB0aGlzLl9nZW5lcmF0ZVBvc2l0aW9uKCBldmVudCApOwoJCXRoaXMub3JpZ2luYWxQYWdlWCA9IGV2ZW50LnBhZ2VYOwoJCXRoaXMub3JpZ2luYWxQYWdlWSA9IGV2ZW50LnBhZ2VZOwoKCQkvL0FkanVzdCB0aGUgbW91c2Ugb2Zmc2V0IHJlbGF0aXZlIHRvIHRoZSBoZWxwZXIgaWYgImN1cnNvckF0IiBpcyBzdXBwbGllZAoJCSggby5jdXJzb3JBdCAmJiB0aGlzLl9hZGp1c3RPZmZzZXRGcm9tSGVscGVyKCBvLmN1cnNvckF0ICkgKTsKCgkJLy9DYWNoZSB0aGUgZm9ybWVyIERPTSBwb3NpdGlvbgoJCXRoaXMuZG9tUG9zaXRpb24gPSB7CgkJCXByZXY6IHRoaXMuY3VycmVudEl0ZW0ucHJldigpWyAwIF0sCgkJCXBhcmVudDogdGhpcy5jdXJyZW50SXRlbS5wYXJlbnQoKVsgMCBdCgkJfTsKCgkJLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgdGhlIG9yaWdpbmFsLCBoaWRlIHRoZSBvcmlnaW5hbCBzbyBpdCdzIG5vdCBwbGF5aW5nIGFueSByb2xlIGR1cmluZwoJCS8vIHRoZSBkcmFnLCB3b24ndCBjYXVzZSBhbnl0aGluZyBiYWQgdGhpcyB3YXkKCQlpZiAoIHRoaXMuaGVscGVyWyAwIF0gIT09IHRoaXMuY3VycmVudEl0ZW1bIDAgXSApIHsKCQkJdGhpcy5jdXJyZW50SXRlbS5oaWRlKCk7CgkJfQoKCQkvL0NyZWF0ZSB0aGUgcGxhY2Vob2xkZXIKCQl0aGlzLl9jcmVhdGVQbGFjZWhvbGRlcigpOwoKCQkvL1NldCBhIGNvbnRhaW5tZW50IGlmIGdpdmVuIGluIHRoZSBvcHRpb25zCgkJaWYgKCBvLmNvbnRhaW5tZW50ICkgewoJCQl0aGlzLl9zZXRDb250YWlubWVudCgpOwoJCX0KCgkJaWYgKCBvLmN1cnNvciAmJiBvLmN1cnNvciAhPT0gImF1dG8iICkgeyAvLyBjdXJzb3Igb3B0aW9uCgkJCWJvZHkgPSB0aGlzLmRvY3VtZW50LmZpbmQoICJib2R5IiApOwoKCQkJLy8gU3VwcG9ydDogSUUKCQkJdGhpcy5zdG9yZWRDdXJzb3IgPSBib2R5LmNzcyggImN1cnNvciIgKTsKCQkJYm9keS5jc3MoICJjdXJzb3IiLCBvLmN1cnNvciApOwoKCQkJdGhpcy5zdG9yZWRTdHlsZXNoZWV0ID0KCQkJCSQoICI8c3R5bGU+KnsgY3Vyc29yOiAiICsgby5jdXJzb3IgKyAiICFpbXBvcnRhbnQ7IH08L3N0eWxlPiIgKS5hcHBlbmRUbyggYm9keSApOwoJCX0KCgkJaWYgKCBvLm9wYWNpdHkgKSB7IC8vIG9wYWNpdHkgb3B0aW9uCgkJCWlmICggdGhpcy5oZWxwZXIuY3NzKCAib3BhY2l0eSIgKSApIHsKCQkJCXRoaXMuX3N0b3JlZE9wYWNpdHkgPSB0aGlzLmhlbHBlci5jc3MoICJvcGFjaXR5IiApOwoJCQl9CgkJCXRoaXMuaGVscGVyLmNzcyggIm9wYWNpdHkiLCBvLm9wYWNpdHkgKTsKCQl9CgoJCWlmICggby56SW5kZXggKSB7IC8vIHpJbmRleCBvcHRpb24KCQkJaWYgKCB0aGlzLmhlbHBlci5jc3MoICJ6SW5kZXgiICkgKSB7CgkJCQl0aGlzLl9zdG9yZWRaSW5kZXggPSB0aGlzLmhlbHBlci5jc3MoICJ6SW5kZXgiICk7CgkJCX0KCQkJdGhpcy5oZWxwZXIuY3NzKCAiekluZGV4Iiwgby56SW5kZXggKTsKCQl9CgoJCS8vUHJlcGFyZSBzY3JvbGxpbmcKCQlpZiAoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IHRoaXMuZG9jdW1lbnRbIDAgXSAmJgoJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS50YWdOYW1lICE9PSAiSFRNTCIgKSB7CgkJCXRoaXMub3ZlcmZsb3dPZmZzZXQgPSB0aGlzLnNjcm9sbFBhcmVudC5vZmZzZXQoKTsKCQl9CgoJCS8vQ2FsbCBjYWxsYmFja3MKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsKCgkJLy9SZWNhY2hlIHRoZSBoZWxwZXIgc2l6ZQoJCWlmICggIXRoaXMuX3ByZXNlcnZlSGVscGVyUHJvcG9ydGlvbnMgKSB7CgkJCXRoaXMuX2NhY2hlSGVscGVyUHJvcG9ydGlvbnMoKTsKCQl9CgoJCS8vUG9zdCAiYWN0aXZhdGUiIGV2ZW50cyB0byBwb3NzaWJsZSBjb250YWluZXJzCgkJaWYgKCAhbm9BY3RpdmF0aW9uICkgewoJCQlmb3IgKCBpID0gdGhpcy5jb250YWluZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goIHRoaXMgKSApOwoJCQl9CgkJfQoKCQkvL1ByZXBhcmUgcG9zc2libGUgZHJvcHBhYmxlcwoJCWlmICggJC51aS5kZG1hbmFnZXIgKSB7CgkJCSQudWkuZGRtYW5hZ2VyLmN1cnJlbnQgPSB0aGlzOwoJCX0KCgkJaWYgKCAkLnVpLmRkbWFuYWdlciAmJiAhby5kcm9wQmVoYXZpb3VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggdGhpcywgZXZlbnQgKTsKCQl9CgoJCXRoaXMuZHJhZ2dpbmcgPSB0cnVlOwoKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5oZWxwZXIsICJ1aS1zb3J0YWJsZS1oZWxwZXIiICk7CgoJCS8vIEV4ZWN1dGUgdGhlIGRyYWcgb25jZSAtIHRoaXMgY2F1c2VzIHRoZSBoZWxwZXIgbm90IHRvIGJlIHZpc2libGViZWZvcmUgZ2V0dGluZyBpdHMKCQkvLyBjb3JyZWN0IHBvc2l0aW9uCgkJdGhpcy5fbW91c2VEcmFnKCBldmVudCApOwoJCXJldHVybiB0cnVlOwoKCX0sCgoJX21vdXNlRHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpLCBpdGVtLCBpdGVtRWxlbWVudCwgaW50ZXJzZWN0aW9uLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlzY3JvbGxlZCA9IGZhbHNlOwoKCQkvL0NvbXB1dGUgdGhlIGhlbHBlcnMgcG9zaXRpb24KCQl0aGlzLnBvc2l0aW9uID0gdGhpcy5fZ2VuZXJhdGVQb3NpdGlvbiggZXZlbnQgKTsKCQl0aGlzLnBvc2l0aW9uQWJzID0gdGhpcy5fY29udmVydFBvc2l0aW9uVG8oICJhYnNvbHV0ZSIgKTsKCgkJaWYgKCAhdGhpcy5sYXN0UG9zaXRpb25BYnMgKSB7CgkJCXRoaXMubGFzdFBvc2l0aW9uQWJzID0gdGhpcy5wb3NpdGlvbkFiczsKCQl9CgoJCS8vRG8gc2Nyb2xsaW5nCgkJaWYgKCB0aGlzLm9wdGlvbnMuc2Nyb2xsICkgewoJCQlpZiAoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IHRoaXMuZG9jdW1lbnRbIDAgXSAmJgoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WyAwIF0udGFnTmFtZSAhPT0gIkhUTUwiICkgewoKCQkJCWlmICggKCB0aGlzLm92ZXJmbG93T2Zmc2V0LnRvcCArIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0ub2Zmc2V0SGVpZ2h0ICkgLQoJCQkJCQlldmVudC5wYWdlWSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxUb3AgPQoJCQkJCQlzY3JvbGxlZCA9IHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0uc2Nyb2xsVG9wICsgby5zY3JvbGxTcGVlZDsKCQkJCX0gZWxzZSBpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5vdmVyZmxvd09mZnNldC50b3AgPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WyAwIF0uc2Nyb2xsVG9wID0KCQkJCQkJc2Nyb2xsZWQgPSB0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbFRvcCAtIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9CgoJCQkJaWYgKCAoIHRoaXMub3ZlcmZsb3dPZmZzZXQubGVmdCArIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0ub2Zmc2V0V2lkdGggKSAtCgkJCQkJCWV2ZW50LnBhZ2VYIDwgby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbExlZnQgPSBzY3JvbGxlZCA9CgkJCQkJCXRoaXMuc2Nyb2xsUGFyZW50WyAwIF0uc2Nyb2xsTGVmdCArIG8uc2Nyb2xsU3BlZWQ7CgkJCQl9IGVsc2UgaWYgKCBldmVudC5wYWdlWCAtIHRoaXMub3ZlcmZsb3dPZmZzZXQubGVmdCA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXS5zY3JvbGxMZWZ0ID0gc2Nyb2xsZWQgPQoJCQkJCQl0aGlzLnNjcm9sbFBhcmVudFsgMCBdLnNjcm9sbExlZnQgLSBvLnNjcm9sbFNwZWVkOwoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoKSA8IG8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsZWQgPSB0aGlzLmRvY3VtZW50LnNjcm9sbFRvcCggdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoKSAtIG8uc2Nyb2xsU3BlZWQgKTsKCQkJCX0gZWxzZSBpZiAoIHRoaXMud2luZG93LmhlaWdodCgpIC0gKCBldmVudC5wYWdlWSAtIHRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKCkgKSA8CgkJCQkJCW8uc2Nyb2xsU2Vuc2l0aXZpdHkgKSB7CgkJCQkJc2Nyb2xsZWQgPSB0aGlzLmRvY3VtZW50LnNjcm9sbFRvcCggdGhpcy5kb2N1bWVudC5zY3JvbGxUb3AoKSArIG8uc2Nyb2xsU3BlZWQgKTsKCQkJCX0KCgkJCQlpZiAoIGV2ZW50LnBhZ2VYIC0gdGhpcy5kb2N1bWVudC5zY3JvbGxMZWZ0KCkgPCBvLnNjcm9sbFNlbnNpdGl2aXR5ICkgewoJCQkJCXNjcm9sbGVkID0gdGhpcy5kb2N1bWVudC5zY3JvbGxMZWZ0KAoJCQkJCQl0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoKSAtIG8uc2Nyb2xsU3BlZWQKCQkJCQkpOwoJCQkJfSBlbHNlIGlmICggdGhpcy53aW5kb3cud2lkdGgoKSAtICggZXZlbnQucGFnZVggLSB0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoKSApIDwKCQkJCQkJby5zY3JvbGxTZW5zaXRpdml0eSApIHsKCQkJCQlzY3JvbGxlZCA9IHRoaXMuZG9jdW1lbnQuc2Nyb2xsTGVmdCgKCQkJCQkJdGhpcy5kb2N1bWVudC5zY3JvbGxMZWZ0KCkgKyBvLnNjcm9sbFNwZWVkCgkJCQkJKTsKCQkJCX0KCgkJCX0KCgkJCWlmICggc2Nyb2xsZWQgIT09IGZhbHNlICYmICQudWkuZGRtYW5hZ2VyICYmICFvLmRyb3BCZWhhdmlvdXIgKSB7CgkJCQkkLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyggdGhpcywgZXZlbnQgKTsKCQkJfQoJCX0KCgkJLy9SZWdlbmVyYXRlIHRoZSBhYnNvbHV0ZSBwb3NpdGlvbiB1c2VkIGZvciBwb3NpdGlvbiBjaGVja3MKCQl0aGlzLnBvc2l0aW9uQWJzID0gdGhpcy5fY29udmVydFBvc2l0aW9uVG8oICJhYnNvbHV0ZSIgKTsKCgkJLy9TZXQgdGhlIGhlbHBlciBwb3NpdGlvbgoJCWlmICggIXRoaXMub3B0aW9ucy5heGlzIHx8IHRoaXMub3B0aW9ucy5heGlzICE9PSAieSIgKSB7CgkJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUubGVmdCA9IHRoaXMucG9zaXRpb24ubGVmdCArICJweCI7CgkJfQoJCWlmICggIXRoaXMub3B0aW9ucy5heGlzIHx8IHRoaXMub3B0aW9ucy5heGlzICE9PSAieCIgKSB7CgkJCXRoaXMuaGVscGVyWyAwIF0uc3R5bGUudG9wID0gdGhpcy5wb3NpdGlvbi50b3AgKyAicHgiOwoJCX0KCgkJLy9SZWFycmFuZ2UKCQlmb3IgKCBpID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCgkJCS8vQ2FjaGUgdmFyaWFibGVzIGFuZCBpbnRlcnNlY3Rpb24sIGNvbnRpbnVlIGlmIG5vIGludGVyc2VjdGlvbgoJCQlpdGVtID0gdGhpcy5pdGVtc1sgaSBdOwoJCQlpdGVtRWxlbWVudCA9IGl0ZW0uaXRlbVsgMCBdOwoJCQlpbnRlcnNlY3Rpb24gPSB0aGlzLl9pbnRlcnNlY3RzV2l0aFBvaW50ZXIoIGl0ZW0gKTsKCQkJaWYgKCAhaW50ZXJzZWN0aW9uICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCS8vIE9ubHkgcHV0IHRoZSBwbGFjZWhvbGRlciBpbnNpZGUgdGhlIGN1cnJlbnQgQ29udGFpbmVyLCBza2lwIGFsbAoJCQkvLyBpdGVtcyBmcm9tIG90aGVyIGNvbnRhaW5lcnMuIFRoaXMgd29ya3MgYmVjYXVzZSB3aGVuIG1vdmluZwoJCQkvLyBhbiBpdGVtIGZyb20gb25lIGNvbnRhaW5lciB0byBhbm90aGVyIHRoZQoJCQkvLyBjdXJyZW50Q29udGFpbmVyIGlzIHN3aXRjaGVkIGJlZm9yZSB0aGUgcGxhY2Vob2xkZXIgaXMgbW92ZWQuCgkJCS8vCgkJCS8vIFdpdGhvdXQgdGhpcywgbW92aW5nIGl0ZW1zIGluICJzdWItc29ydGFibGVzIiBjYW4gY2F1c2UKCQkJLy8gdGhlIHBsYWNlaG9sZGVyIHRvIGppdHRlciBiZXR3ZWVuIHRoZSBvdXRlciBhbmQgaW5uZXIgY29udGFpbmVyLgoJCQlpZiAoIGl0ZW0uaW5zdGFuY2UgIT09IHRoaXMuY3VycmVudENvbnRhaW5lciApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvLyBDYW5ub3QgaW50ZXJzZWN0IHdpdGggaXRzZWxmCgkJCS8vIG5vIHVzZWxlc3MgYWN0aW9ucyB0aGF0IGhhdmUgYmVlbiBkb25lIGJlZm9yZQoJCQkvLyBubyBhY3Rpb24gaWYgdGhlIGl0ZW0gbW92ZWQgaXMgdGhlIHBhcmVudCBvZiB0aGUgaXRlbSBjaGVja2VkCgkJCWlmICggaXRlbUVsZW1lbnQgIT09IHRoaXMuY3VycmVudEl0ZW1bIDAgXSAmJgoJCQkJdGhpcy5wbGFjZWhvbGRlclsgaW50ZXJzZWN0aW9uID09PSAxID8gIm5leHQiIDogInByZXYiIF0oKVsgMCBdICE9PSBpdGVtRWxlbWVudCAmJgoJCQkJISQuY29udGFpbnMoIHRoaXMucGxhY2Vob2xkZXJbIDAgXSwgaXRlbUVsZW1lbnQgKSAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHlwZSA9PT0gInNlbWktZHluYW1pYyIgPwoJCQkJCSEkLmNvbnRhaW5zKCB0aGlzLmVsZW1lbnRbIDAgXSwgaXRlbUVsZW1lbnQgKSA6CgkJCQkJdHJ1ZQoJCQkJKQoJCQkpIHsKCgkJCQl0aGlzLmRpcmVjdGlvbiA9IGludGVyc2VjdGlvbiA9PT0gMSA\/ICJkb3duIiA6ICJ1cCI7CgoJCQkJaWYgKCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlID09PSAicG9pbnRlciIgfHwgdGhpcy5faW50ZXJzZWN0c1dpdGhTaWRlcyggaXRlbSApICkgewoJCQkJCXRoaXMuX3JlYXJyYW5nZSggZXZlbnQsIGl0ZW0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCS8vUG9zdCBldmVudHMgdG8gY29udGFpbmVycwoJCXRoaXMuX2NvbnRhY3RDb250YWluZXJzKCBldmVudCApOwoKCQkvL0ludGVyY29ubmVjdCB3aXRoIGRyb3BwYWJsZXMKCQlpZiAoICQudWkuZGRtYW5hZ2VyICkgewoJCQkkLnVpLmRkbWFuYWdlci5kcmFnKCB0aGlzLCBldmVudCApOwoJCX0KCgkJLy9DYWxsIGNhbGxiYWNrcwoJCXRoaXMuX3RyaWdnZXIoICJzb3J0IiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpICk7CgoJCXRoaXMubGFzdFBvc2l0aW9uQWJzID0gdGhpcy5wb3NpdGlvbkFiczsKCQlyZXR1cm4gZmFsc2U7CgoJfSwKCglfbW91c2VTdG9wOiBmdW5jdGlvbiggZXZlbnQsIG5vUHJvcGFnYXRpb24gKSB7CgoJCWlmICggIWV2ZW50ICkgewoJCQlyZXR1cm47CgkJfQoKCQkvL0lmIHdlIGFyZSB1c2luZyBkcm9wcGFibGVzLCBpbmZvcm0gdGhlIG1hbmFnZXIgYWJvdXQgdGhlIGRyb3AKCQlpZiAoICQudWkuZGRtYW5hZ2VyICYmICF0aGlzLm9wdGlvbnMuZHJvcEJlaGF2aW91ciApIHsKCQkJJC51aS5kZG1hbmFnZXIuZHJvcCggdGhpcywgZXZlbnQgKTsKCQl9CgoJCWlmICggdGhpcy5vcHRpb25zLnJldmVydCApIHsKCQkJdmFyIHRoYXQgPSB0aGlzLAoJCQkJY3VyID0gdGhpcy5wbGFjZWhvbGRlci5vZmZzZXQoKSwKCQkJCWF4aXMgPSB0aGlzLm9wdGlvbnMuYXhpcywKCQkJCWFuaW1hdGlvbiA9IHt9OwoKCQkJaWYgKCAhYXhpcyB8fCBheGlzID09PSAieCIgKSB7CgkJCQlhbmltYXRpb24ubGVmdCA9IGN1ci5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgLSB0aGlzLm1hcmdpbnMubGVmdCArCgkJCQkJKCB0aGlzLm9mZnNldFBhcmVudFsgMCBdID09PSB0aGlzLmRvY3VtZW50WyAwIF0uYm9keSA\/CgkJCQkJCTAgOgoJCQkJCQl0aGlzLm9mZnNldFBhcmVudFsgMCBdLnNjcm9sbExlZnQKCQkJCQkpOwoJCQl9CgkJCWlmICggIWF4aXMgfHwgYXhpcyA9PT0gInkiICkgewoJCQkJYW5pbWF0aW9uLnRvcCA9IGN1ci50b3AgLSB0aGlzLm9mZnNldC5wYXJlbnQudG9wIC0gdGhpcy5tYXJnaW5zLnRvcCArCgkJCQkJKCB0aGlzLm9mZnNldFBhcmVudFsgMCBdID09PSB0aGlzLmRvY3VtZW50WyAwIF0uYm9keSA\/CgkJCQkJCTAgOgoJCQkJCQl0aGlzLm9mZnNldFBhcmVudFsgMCBdLnNjcm9sbFRvcAoJCQkJCSk7CgkJCX0KCQkJdGhpcy5yZXZlcnRpbmcgPSB0cnVlOwoJCQkkKCB0aGlzLmhlbHBlciApLmFuaW1hdGUoCgkJCQlhbmltYXRpb24sCgkJCQlwYXJzZUludCggdGhpcy5vcHRpb25zLnJldmVydCwgMTAgKSB8fCA1MDAsCgkJCQlmdW5jdGlvbigpIHsKCQkJCQl0aGF0Ll9jbGVhciggZXZlbnQgKTsKCQkJCX0KCQkJKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9jbGVhciggZXZlbnQsIG5vUHJvcGFnYXRpb24gKTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCgkJCXRoaXMuX21vdXNlVXAoIG5ldyAkLkV2ZW50KCAibW91c2V1cCIsIHsgdGFyZ2V0OiBudWxsIH0gKSApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMuaGVscGVyID09PSAib3JpZ2luYWwiICkgewoJCQkJdGhpcy5jdXJyZW50SXRlbS5jc3MoIHRoaXMuX3N0b3JlZENTUyApOwoJCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIHRoaXMuY3VycmVudEl0ZW0sICJ1aS1zb3J0YWJsZS1oZWxwZXIiICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmN1cnJlbnRJdGVtLnNob3coKTsKCQkJfQoKCQkJLy9Qb3N0IGRlYWN0aXZhdGluZyBldmVudHMgdG8gY29udGFpbmVycwoJCQlmb3IgKCB2YXIgaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLl90cmlnZ2VyKCAiZGVhY3RpdmF0ZSIsIG51bGwsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCQlpZiAoIHRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7CgkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uX3RyaWdnZXIoICJvdXQiLCBudWxsLCB0aGlzLl91aUhhc2goIHRoaXMgKSApOwoJCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAwOwoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKCB0aGlzLnBsYWNlaG9sZGVyICkgewoKCQkJLy8kKHRoaXMucGxhY2Vob2xkZXJbMF0pLnJlbW92ZSgpOyB3b3VsZCBoYXZlIGJlZW4gdGhlIGpRdWVyeSB3YXkgLSB1bmZvcnR1bmF0ZWx5LAoJCQkvLyBpdCB1bmJpbmRzIEFMTCBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgbm9kZSEKCQkJaWYgKCB0aGlzLnBsYWNlaG9sZGVyWyAwIF0ucGFyZW50Tm9kZSApIHsKCQkJCXRoaXMucGxhY2Vob2xkZXJbIDAgXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCB0aGlzLnBsYWNlaG9sZGVyWyAwIF0gKTsKCQkJfQoJCQlpZiAoIHRoaXMub3B0aW9ucy5oZWxwZXIgIT09ICJvcmlnaW5hbCIgJiYgdGhpcy5oZWxwZXIgJiYKCQkJCQl0aGlzLmhlbHBlclsgMCBdLnBhcmVudE5vZGUgKSB7CgkJCQl0aGlzLmhlbHBlci5yZW1vdmUoKTsKCQkJfQoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCWhlbHBlcjogbnVsbCwKCQkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJCXJldmVydGluZzogZmFsc2UsCgkJCQlfbm9GaW5hbFNvcnQ6IG51bGwKCQkJfSApOwoKCQkJaWYgKCB0aGlzLmRvbVBvc2l0aW9uLnByZXYgKSB7CgkJCQkkKCB0aGlzLmRvbVBvc2l0aW9uLnByZXYgKS5hZnRlciggdGhpcy5jdXJyZW50SXRlbSApOwoJCQl9IGVsc2UgewoJCQkJJCggdGhpcy5kb21Qb3NpdGlvbi5wYXJlbnQgKS5wcmVwZW5kKCB0aGlzLmN1cnJlbnRJdGVtICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJc2VyaWFsaXplOiBmdW5jdGlvbiggbyApIHsKCgkJdmFyIGl0ZW1zID0gdGhpcy5fZ2V0SXRlbXNBc2pRdWVyeSggbyAmJiBvLmNvbm5lY3RlZCApLAoJCQlzdHIgPSBbXTsKCQlvID0gbyB8fCB7fTsKCgkJJCggaXRlbXMgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIHJlcyA9ICggJCggby5pdGVtIHx8IHRoaXMgKS5hdHRyKCBvLmF0dHJpYnV0ZSB8fCAiaWQiICkgfHwgIiIgKQoJCQkJLm1hdGNoKCBvLmV4cHJlc3Npb24gfHwgKCAvKC4rKVtcLT1fXSguKykvICkgKTsKCQkJaWYgKCByZXMgKSB7CgkJCQlzdHIucHVzaCgKCQkJCQkoIG8ua2V5IHx8IHJlc1sgMSBdICsgIltdIiApICsKCQkJCQkiPSIgKyAoIG8ua2V5ICYmIG8uZXhwcmVzc2lvbiA\/IHJlc1sgMSBdIDogcmVzWyAyIF0gKSApOwoJCQl9CgkJfSApOwoKCQlpZiAoICFzdHIubGVuZ3RoICYmIG8ua2V5ICkgewoJCQlzdHIucHVzaCggby5rZXkgKyAiPSIgKTsKCQl9CgoJCXJldHVybiBzdHIuam9pbiggIiYiICk7CgoJfSwKCgl0b0FycmF5OiBmdW5jdGlvbiggbyApIHsKCgkJdmFyIGl0ZW1zID0gdGhpcy5fZ2V0SXRlbXNBc2pRdWVyeSggbyAmJiBvLmNvbm5lY3RlZCApLAoJCQlyZXQgPSBbXTsKCgkJbyA9IG8gfHwge307CgoJCWl0ZW1zLmVhY2goIGZ1bmN0aW9uKCkgewoJCQlyZXQucHVzaCggJCggby5pdGVtIHx8IHRoaXMgKS5hdHRyKCBvLmF0dHJpYnV0ZSB8fCAiaWQiICkgfHwgIiIgKTsKCQl9ICk7CgkJcmV0dXJuIHJldDsKCgl9LAoKCS8qIEJlIGNhcmVmdWwgd2l0aCB0aGUgZm9sbG93aW5nIGNvcmUgZnVuY3Rpb25zICovCglfaW50ZXJzZWN0c1dpdGg6IGZ1bmN0aW9uKCBpdGVtICkgewoKCQl2YXIgeDEgPSB0aGlzLnBvc2l0aW9uQWJzLmxlZnQsCgkJCXgyID0geDEgKyB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoLAoJCQl5MSA9IHRoaXMucG9zaXRpb25BYnMudG9wLAoJCQl5MiA9IHkxICsgdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQsCgkJCWwgPSBpdGVtLmxlZnQsCgkJCXIgPSBsICsgaXRlbS53aWR0aCwKCQkJdCA9IGl0ZW0udG9wLAoJCQliID0gdCArIGl0ZW0uaGVpZ2h0LAoJCQlkeUNsaWNrID0gdGhpcy5vZmZzZXQuY2xpY2sudG9wLAoJCQlkeENsaWNrID0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCwKCQkJaXNPdmVyRWxlbWVudEhlaWdodCA9ICggdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ4IiApIHx8ICggKCB5MSArIGR5Q2xpY2sgKSA+IHQgJiYKCQkJCSggeTEgKyBkeUNsaWNrICkgPCBiICksCgkJCWlzT3ZlckVsZW1lbnRXaWR0aCA9ICggdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ5IiApIHx8ICggKCB4MSArIGR4Q2xpY2sgKSA+IGwgJiYKCQkJCSggeDEgKyBkeENsaWNrICkgPCByICksCgkJCWlzT3ZlckVsZW1lbnQgPSBpc092ZXJFbGVtZW50SGVpZ2h0ICYmIGlzT3ZlckVsZW1lbnRXaWR0aDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlID09PSAicG9pbnRlciIgfHwKCQkJdGhpcy5vcHRpb25zLmZvcmNlUG9pbnRlckZvckNvbnRhaW5lcnMgfHwKCQkJKCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlICE9PSAicG9pbnRlciIgJiYKCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnNbIHRoaXMuZmxvYXRpbmcgPyAid2lkdGgiIDogImhlaWdodCIgXSA+CgkJCQlpdGVtWyB0aGlzLmZsb2F0aW5nID8gIndpZHRoIiA6ICJoZWlnaHQiIF0gKQoJCSkgewoJCQlyZXR1cm4gaXNPdmVyRWxlbWVudDsKCQl9IGVsc2UgewoKCQkJcmV0dXJuICggbCA8IHgxICsgKCB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC8gMiApICYmIC8vIFJpZ2h0IEhhbGYKCQkJCXgyIC0gKCB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC8gMiApIDwgciAmJiAvLyBMZWZ0IEhhbGYKCQkJCXQgPCB5MSArICggdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQgLyAyICkgJiYgLy8gQm90dG9tIEhhbGYKCQkJCXkyIC0gKCB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAvIDIgKSA8IGIgKTsgLy8gVG9wIEhhbGYKCgkJfQoJfSwKCglfaW50ZXJzZWN0c1dpdGhQb2ludGVyOiBmdW5jdGlvbiggaXRlbSApIHsKCQl2YXIgdmVydGljYWxEaXJlY3Rpb24sIGhvcml6b250YWxEaXJlY3Rpb24sCgkJCWlzT3ZlckVsZW1lbnRIZWlnaHQgPSAoIHRoaXMub3B0aW9ucy5heGlzID09PSAieCIgKSB8fAoJCQkJdGhpcy5faXNPdmVyQXhpcygKCQkJCQl0aGlzLnBvc2l0aW9uQWJzLnRvcCArIHRoaXMub2Zmc2V0LmNsaWNrLnRvcCwgaXRlbS50b3AsIGl0ZW0uaGVpZ2h0ICksCgkJCWlzT3ZlckVsZW1lbnRXaWR0aCA9ICggdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ5IiApIHx8CgkJCQl0aGlzLl9pc092ZXJBeGlzKAoJCQkJCXRoaXMucG9zaXRpb25BYnMubGVmdCArIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQsIGl0ZW0ubGVmdCwgaXRlbS53aWR0aCApLAoJCQlpc092ZXJFbGVtZW50ID0gaXNPdmVyRWxlbWVudEhlaWdodCAmJiBpc092ZXJFbGVtZW50V2lkdGg7CgoJCWlmICggIWlzT3ZlckVsZW1lbnQgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXZlcnRpY2FsRGlyZWN0aW9uID0gdGhpcy5fZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uKCk7CgkJaG9yaXpvbnRhbERpcmVjdGlvbiA9IHRoaXMuX2dldERyYWdIb3Jpem9udGFsRGlyZWN0aW9uKCk7CgoJCXJldHVybiB0aGlzLmZsb2F0aW5nID8KCQkJKCAoIGhvcml6b250YWxEaXJlY3Rpb24gPT09ICJyaWdodCIgfHwgdmVydGljYWxEaXJlY3Rpb24gPT09ICJkb3duIiApID8gMiA6IDEgKQoJCQk6ICggdmVydGljYWxEaXJlY3Rpb24gJiYgKCB2ZXJ0aWNhbERpcmVjdGlvbiA9PT0gImRvd24iID8gMiA6IDEgKSApOwoKCX0sCgoJX2ludGVyc2VjdHNXaXRoU2lkZXM6IGZ1bmN0aW9uKCBpdGVtICkgewoKCQl2YXIgaXNPdmVyQm90dG9tSGFsZiA9IHRoaXMuX2lzT3ZlckF4aXMoIHRoaXMucG9zaXRpb25BYnMudG9wICsKCQkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCwgaXRlbS50b3AgKyAoIGl0ZW0uaGVpZ2h0IC8gMiApLCBpdGVtLmhlaWdodCApLAoJCQlpc092ZXJSaWdodEhhbGYgPSB0aGlzLl9pc092ZXJBeGlzKCB0aGlzLnBvc2l0aW9uQWJzLmxlZnQgKwoJCQkJdGhpcy5vZmZzZXQuY2xpY2subGVmdCwgaXRlbS5sZWZ0ICsgKCBpdGVtLndpZHRoIC8gMiApLCBpdGVtLndpZHRoICksCgkJCXZlcnRpY2FsRGlyZWN0aW9uID0gdGhpcy5fZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uKCksCgkJCWhvcml6b250YWxEaXJlY3Rpb24gPSB0aGlzLl9nZXREcmFnSG9yaXpvbnRhbERpcmVjdGlvbigpOwoKCQlpZiAoIHRoaXMuZmxvYXRpbmcgJiYgaG9yaXpvbnRhbERpcmVjdGlvbiApIHsKCQkJcmV0dXJuICggKCBob3Jpem9udGFsRGlyZWN0aW9uID09PSAicmlnaHQiICYmIGlzT3ZlclJpZ2h0SGFsZiApIHx8CgkJCQkoIGhvcml6b250YWxEaXJlY3Rpb24gPT09ICJsZWZ0IiAmJiAhaXNPdmVyUmlnaHRIYWxmICkgKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdmVydGljYWxEaXJlY3Rpb24gJiYgKCAoIHZlcnRpY2FsRGlyZWN0aW9uID09PSAiZG93biIgJiYgaXNPdmVyQm90dG9tSGFsZiApIHx8CgkJCQkoIHZlcnRpY2FsRGlyZWN0aW9uID09PSAidXAiICYmICFpc092ZXJCb3R0b21IYWxmICkgKTsKCQl9CgoJfSwKCglfZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgZGVsdGEgPSB0aGlzLnBvc2l0aW9uQWJzLnRvcCAtIHRoaXMubGFzdFBvc2l0aW9uQWJzLnRvcDsKCQlyZXR1cm4gZGVsdGEgIT09IDAgJiYgKCBkZWx0YSA+IDAgPyAiZG93biIgOiAidXAiICk7Cgl9LAoKCV9nZXREcmFnSG9yaXpvbnRhbERpcmVjdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGRlbHRhID0gdGhpcy5wb3NpdGlvbkFicy5sZWZ0IC0gdGhpcy5sYXN0UG9zaXRpb25BYnMubGVmdDsKCQlyZXR1cm4gZGVsdGEgIT09IDAgJiYgKCBkZWx0YSA+IDAgPyAicmlnaHQiIDogImxlZnQiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl0aGlzLl9yZWZyZXNoSXRlbXMoIGV2ZW50ICk7CgkJdGhpcy5fc2V0SGFuZGxlQ2xhc3NOYW1lKCk7CgkJdGhpcy5yZWZyZXNoUG9zaXRpb25zKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jb25uZWN0V2l0aDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgkJcmV0dXJuIG9wdGlvbnMuY29ubmVjdFdpdGguY29uc3RydWN0b3IgPT09IFN0cmluZyA\/CgkJCVsgb3B0aW9ucy5jb25uZWN0V2l0aCBdIDoKCQkJb3B0aW9ucy5jb25uZWN0V2l0aDsKCX0sCgoJX2dldEl0ZW1zQXNqUXVlcnk6IGZ1bmN0aW9uKCBjb25uZWN0ZWQgKSB7CgoJCXZhciBpLCBqLCBjdXIsIGluc3QsCgkJCWl0ZW1zID0gW10sCgkJCXF1ZXJpZXMgPSBbXSwKCQkJY29ubmVjdFdpdGggPSB0aGlzLl9jb25uZWN0V2l0aCgpOwoKCQlpZiAoIGNvbm5lY3RXaXRoICYmIGNvbm5lY3RlZCApIHsKCQkJZm9yICggaSA9IGNvbm5lY3RXaXRoLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tICkgewoJCQkJY3VyID0gJCggY29ubmVjdFdpdGhbIGkgXSwgdGhpcy5kb2N1bWVudFsgMCBdICk7CgkJCQlmb3IgKCBqID0gY3VyLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tICkgewoJCQkJCWluc3QgPSAkLmRhdGEoIGN1clsgaiBdLCB0aGlzLndpZGdldEZ1bGxOYW1lICk7CgkJCQkJaWYgKCBpbnN0ICYmIGluc3QgIT09IHRoaXMgJiYgIWluc3Qub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQkJcXVlcmllcy5wdXNoKCBbICQuaXNGdW5jdGlvbiggaW5zdC5vcHRpb25zLml0ZW1zICkgPwoJCQkJCQkJaW5zdC5vcHRpb25zLml0ZW1zLmNhbGwoIGluc3QuZWxlbWVudCApIDoKCQkJCQkJCSQoIGluc3Qub3B0aW9ucy5pdGVtcywgaW5zdC5lbGVtZW50ICkKCQkJCQkJCQkubm90KCAiLnVpLXNvcnRhYmxlLWhlbHBlciIgKQoJCQkJCQkJCS5ub3QoICIudWktc29ydGFibGUtcGxhY2Vob2xkZXIiICksIGluc3QgXSApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcXVlcmllcy5wdXNoKCBbICQuaXNGdW5jdGlvbiggdGhpcy5vcHRpb25zLml0ZW1zICkgPwoJCQl0aGlzLm9wdGlvbnMuaXRlbXMKCQkJCS5jYWxsKCB0aGlzLmVsZW1lbnQsIG51bGwsIHsgb3B0aW9uczogdGhpcy5vcHRpb25zLCBpdGVtOiB0aGlzLmN1cnJlbnRJdGVtIH0gKSA6CgkJCSQoIHRoaXMub3B0aW9ucy5pdGVtcywgdGhpcy5lbGVtZW50ICkKCQkJCS5ub3QoICIudWktc29ydGFibGUtaGVscGVyIiApCgkJCQkubm90KCAiLnVpLXNvcnRhYmxlLXBsYWNlaG9sZGVyIiApLCB0aGlzIF0gKTsKCgkJZnVuY3Rpb24gYWRkSXRlbXMoKSB7CgkJCWl0ZW1zLnB1c2goIHRoaXMgKTsKCQl9CgkJZm9yICggaSA9IHF1ZXJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCXF1ZXJpZXNbIGkgXVsgMCBdLmVhY2goIGFkZEl0ZW1zICk7CgkJfQoKCQlyZXR1cm4gJCggaXRlbXMgKTsKCgl9LAoKCV9yZW1vdmVDdXJyZW50c0Zyb21JdGVtczogZnVuY3Rpb24oKSB7CgoJCXZhciBsaXN0ID0gdGhpcy5jdXJyZW50SXRlbS5maW5kKCAiOmRhdGEoIiArIHRoaXMud2lkZ2V0TmFtZSArICItaXRlbSkiICk7CgoJCXRoaXMuaXRlbXMgPSAkLmdyZXAoIHRoaXMuaXRlbXMsIGZ1bmN0aW9uKCBpdGVtICkgewoJCQlmb3IgKCB2YXIgaiA9IDA7IGogPCBsaXN0Lmxlbmd0aDsgaisrICkgewoJCQkJaWYgKCBsaXN0WyBqIF0gPT09IGl0ZW0uaXRlbVsgMCBdICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9ICk7CgoJfSwKCglfcmVmcmVzaEl0ZW1zOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCXRoaXMuaXRlbXMgPSBbXTsKCQl0aGlzLmNvbnRhaW5lcnMgPSBbIHRoaXMgXTsKCgkJdmFyIGksIGosIGN1ciwgaW5zdCwgdGFyZ2V0RGF0YSwgX3F1ZXJpZXMsIGl0ZW0sIHF1ZXJpZXNMZW5ndGgsCgkJCWl0ZW1zID0gdGhpcy5pdGVtcywKCQkJcXVlcmllcyA9IFsgWyAkLmlzRnVuY3Rpb24oIHRoaXMub3B0aW9ucy5pdGVtcyApID8KCQkJCXRoaXMub3B0aW9ucy5pdGVtcy5jYWxsKCB0aGlzLmVsZW1lbnRbIDAgXSwgZXZlbnQsIHsgaXRlbTogdGhpcy5jdXJyZW50SXRlbSB9ICkgOgoJCQkJJCggdGhpcy5vcHRpb25zLml0ZW1zLCB0aGlzLmVsZW1lbnQgKSwgdGhpcyBdIF0sCgkJCWNvbm5lY3RXaXRoID0gdGhpcy5fY29ubmVjdFdpdGgoKTsKCgkJLy9TaG91bGRuJ3QgYmUgcnVuIHRoZSBmaXJzdCB0aW1lIHRocm91Z2ggZHVlIHRvIG1hc3NpdmUgc2xvdy1kb3duCgkJaWYgKCBjb25uZWN0V2l0aCAmJiB0aGlzLnJlYWR5ICkgewoJCQlmb3IgKCBpID0gY29ubmVjdFdpdGgubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQljdXIgPSAkKCBjb25uZWN0V2l0aFsgaSBdLCB0aGlzLmRvY3VtZW50WyAwIF0gKTsKCQkJCWZvciAoIGogPSBjdXIubGVuZ3RoIC0gMTsgaiA+PSAwOyBqLS0gKSB7CgkJCQkJaW5zdCA9ICQuZGF0YSggY3VyWyBqIF0sIHRoaXMud2lkZ2V0RnVsbE5hbWUgKTsKCQkJCQlpZiAoIGluc3QgJiYgaW5zdCAhPT0gdGhpcyAmJiAhaW5zdC5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJCQlxdWVyaWVzLnB1c2goIFsgJC5pc0Z1bmN0aW9uKCBpbnN0Lm9wdGlvbnMuaXRlbXMgKSA\/CgkJCQkJCQlpbnN0Lm9wdGlvbnMuaXRlbXMKCQkJCQkJCQkuY2FsbCggaW5zdC5lbGVtZW50WyAwIF0sIGV2ZW50LCB7IGl0ZW06IHRoaXMuY3VycmVudEl0ZW0gfSApIDoKCQkJCQkJCSQoIGluc3Qub3B0aW9ucy5pdGVtcywgaW5zdC5lbGVtZW50ICksIGluc3QgXSApOwoJCQkJCQl0aGlzLmNvbnRhaW5lcnMucHVzaCggaW5zdCApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJZm9yICggaSA9IHF1ZXJpZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCXRhcmdldERhdGEgPSBxdWVyaWVzWyBpIF1bIDEgXTsKCQkJX3F1ZXJpZXMgPSBxdWVyaWVzWyBpIF1bIDAgXTsKCgkJCWZvciAoIGogPSAwLCBxdWVyaWVzTGVuZ3RoID0gX3F1ZXJpZXMubGVuZ3RoOyBqIDwgcXVlcmllc0xlbmd0aDsgaisrICkgewoJCQkJaXRlbSA9ICQoIF9xdWVyaWVzWyBqIF0gKTsKCgkJCQkvLyBEYXRhIGZvciB0YXJnZXQgY2hlY2tpbmcgKG1vdXNlIG1hbmFnZXIpCgkJCQlpdGVtLmRhdGEoIHRoaXMud2lkZ2V0TmFtZSArICItaXRlbSIsIHRhcmdldERhdGEgKTsKCgkJCQlpdGVtcy5wdXNoKCB7CgkJCQkJaXRlbTogaXRlbSwKCQkJCQlpbnN0YW5jZTogdGFyZ2V0RGF0YSwKCQkJCQl3aWR0aDogMCwgaGVpZ2h0OiAwLAoJCQkJCWxlZnQ6IDAsIHRvcDogMAoJCQkJfSApOwoJCQl9CgkJfQoKCX0sCgoJcmVmcmVzaFBvc2l0aW9uczogZnVuY3Rpb24oIGZhc3QgKSB7CgoJCS8vIERldGVybWluZSB3aGV0aGVyIGl0ZW1zIGFyZSBiZWluZyBkaXNwbGF5ZWQgaG9yaXpvbnRhbGx5CgkJdGhpcy5mbG9hdGluZyA9IHRoaXMuaXRlbXMubGVuZ3RoID8KCQkJdGhpcy5vcHRpb25zLmF4aXMgPT09ICJ4IiB8fCB0aGlzLl9pc0Zsb2F0aW5nKCB0aGlzLml0ZW1zWyAwIF0uaXRlbSApIDoKCQkJZmFsc2U7CgoJCS8vVGhpcyBoYXMgdG8gYmUgcmVkb25lIGJlY2F1c2UgZHVlIHRvIHRoZSBpdGVtIGJlaW5nIG1vdmVkIG91dC9pbnRvIHRoZSBvZmZzZXRQYXJlbnQsCgkJLy8gdGhlIG9mZnNldFBhcmVudCdzIHBvc2l0aW9uIHdpbGwgY2hhbmdlCgkJaWYgKCB0aGlzLm9mZnNldFBhcmVudCAmJiB0aGlzLmhlbHBlciApIHsKCQkJdGhpcy5vZmZzZXQucGFyZW50ID0gdGhpcy5fZ2V0UGFyZW50T2Zmc2V0KCk7CgkJfQoKCQl2YXIgaSwgaXRlbSwgdCwgcDsKCgkJZm9yICggaSA9IHRoaXMuaXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCWl0ZW0gPSB0aGlzLml0ZW1zWyBpIF07CgoJCQkvL1dlIGlnbm9yZSBjYWxjdWxhdGluZyBwb3NpdGlvbnMgb2YgYWxsIGNvbm5lY3RlZCBjb250YWluZXJzIHdoZW4gd2UncmUgbm90IG92ZXIgdGhlbQoJCQlpZiAoIGl0ZW0uaW5zdGFuY2UgIT09IHRoaXMuY3VycmVudENvbnRhaW5lciAmJiB0aGlzLmN1cnJlbnRDb250YWluZXIgJiYKCQkJCQlpdGVtLml0ZW1bIDAgXSAhPT0gdGhpcy5jdXJyZW50SXRlbVsgMCBdICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCXQgPSB0aGlzLm9wdGlvbnMudG9sZXJhbmNlRWxlbWVudCA\/CgkJCQkkKCB0aGlzLm9wdGlvbnMudG9sZXJhbmNlRWxlbWVudCwgaXRlbS5pdGVtICkgOgoJCQkJaXRlbS5pdGVtOwoKCQkJaWYgKCAhZmFzdCApIHsKCQkJCWl0ZW0ud2lkdGggPSB0Lm91dGVyV2lkdGgoKTsKCQkJCWl0ZW0uaGVpZ2h0ID0gdC5vdXRlckhlaWdodCgpOwoJCQl9CgoJCQlwID0gdC5vZmZzZXQoKTsKCQkJaXRlbS5sZWZ0ID0gcC5sZWZ0OwoJCQlpdGVtLnRvcCA9IHAudG9wOwoJCX0KCgkJaWYgKCB0aGlzLm9wdGlvbnMuY3VzdG9tICYmIHRoaXMub3B0aW9ucy5jdXN0b20ucmVmcmVzaENvbnRhaW5lcnMgKSB7CgkJCXRoaXMub3B0aW9ucy5jdXN0b20ucmVmcmVzaENvbnRhaW5lcnMuY2FsbCggdGhpcyApOwoJCX0gZWxzZSB7CgkJCWZvciAoIGkgPSB0aGlzLmNvbnRhaW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQlwID0gdGhpcy5jb250YWluZXJzWyBpIF0uZWxlbWVudC5vZmZzZXQoKTsKCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLmxlZnQgPSBwLmxlZnQ7CgkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5jb250YWluZXJDYWNoZS50b3AgPSBwLnRvcDsKCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLndpZHRoID0KCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5lbGVtZW50Lm91dGVyV2lkdGgoKTsKCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLmhlaWdodCA9CgkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uZWxlbWVudC5vdXRlckhlaWdodCgpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX2NyZWF0ZVBsYWNlaG9sZGVyOiBmdW5jdGlvbiggdGhhdCApIHsKCQl0aGF0ID0gdGhhdCB8fCB0aGlzOwoJCXZhciBjbGFzc05hbWUsCgkJCW8gPSB0aGF0Lm9wdGlvbnM7CgoJCWlmICggIW8ucGxhY2Vob2xkZXIgfHwgby5wbGFjZWhvbGRlci5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nICkgewoJCQljbGFzc05hbWUgPSBvLnBsYWNlaG9sZGVyOwoJCQlvLnBsYWNlaG9sZGVyID0gewoJCQkJZWxlbWVudDogZnVuY3Rpb24oKSB7CgoJCQkJCXZhciBub2RlTmFtZSA9IHRoYXQuY3VycmVudEl0ZW1bIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQkJCQllbGVtZW50ID0gJCggIjwiICsgbm9kZU5hbWUgKyAiPiIsIHRoYXQuZG9jdW1lbnRbIDAgXSApOwoKCQkJCQkJdGhhdC5fYWRkQ2xhc3MoIGVsZW1lbnQsICJ1aS1zb3J0YWJsZS1wbGFjZWhvbGRlciIsCgkJCQkJCQkJY2xhc3NOYW1lIHx8IHRoYXQuY3VycmVudEl0ZW1bIDAgXS5jbGFzc05hbWUgKQoJCQkJCQkJLl9yZW1vdmVDbGFzcyggZWxlbWVudCwgInVpLXNvcnRhYmxlLWhlbHBlciIgKTsKCgkJCQkJaWYgKCBub2RlTmFtZSA9PT0gInRib2R5IiApIHsKCQkJCQkJdGhhdC5fY3JlYXRlVHJQbGFjZWhvbGRlcigKCQkJCQkJCXRoYXQuY3VycmVudEl0ZW0uZmluZCggInRyIiApLmVxKCAwICksCgkJCQkJCQkkKCAiPHRyPiIsIHRoYXQuZG9jdW1lbnRbIDAgXSApLmFwcGVuZFRvKCBlbGVtZW50ICkKCQkJCQkJKTsKCQkJCQl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gInRyIiApIHsKCQkJCQkJdGhhdC5fY3JlYXRlVHJQbGFjZWhvbGRlciggdGhhdC5jdXJyZW50SXRlbSwgZWxlbWVudCApOwoJCQkJCX0gZWxzZSBpZiAoIG5vZGVOYW1lID09PSAiaW1nIiApIHsKCQkJCQkJZWxlbWVudC5hdHRyKCAic3JjIiwgdGhhdC5jdXJyZW50SXRlbS5hdHRyKCAic3JjIiApICk7CgkJCQkJfQoKCQkJCQlpZiAoICFjbGFzc05hbWUgKSB7CgkJCQkJCWVsZW1lbnQuY3NzKCAidmlzaWJpbGl0eSIsICJoaWRkZW4iICk7CgkJCQkJfQoKCQkJCQlyZXR1cm4gZWxlbWVudDsKCQkJCX0sCgkJCQl1cGRhdGU6IGZ1bmN0aW9uKCBjb250YWluZXIsIHAgKSB7CgoJCQkJCS8vIDEuIElmIGEgY2xhc3NOYW1lIGlzIHNldCBhcyAncGxhY2Vob2xkZXIgb3B0aW9uLCB3ZSBkb24ndCBmb3JjZSBzaXplcyAtCgkJCQkJLy8gdGhlIGNsYXNzIGlzIHJlc3BvbnNpYmxlIGZvciB0aGF0CgkJCQkJLy8gMi4gVGhlIG9wdGlvbiAnZm9yY2VQbGFjZWhvbGRlclNpemUgY2FuIGJlIGVuYWJsZWQgdG8gZm9yY2UgaXQgZXZlbiBpZiBhCgkJCQkJLy8gY2xhc3MgbmFtZSBpcyBzcGVjaWZpZWQKCQkJCQlpZiAoIGNsYXNzTmFtZSAmJiAhby5mb3JjZVBsYWNlaG9sZGVyU2l6ZSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy9JZiB0aGUgZWxlbWVudCBkb2Vzbid0IGhhdmUgYSBhY3R1YWwgaGVpZ2h0IGJ5IGl0c2VsZiAod2l0aG91dCBzdHlsZXMgY29taW5nCgkJCQkJLy8gZnJvbSBhIHN0eWxlc2hlZXQpLCBpdCByZWNlaXZlcyB0aGUgaW5saW5lIGhlaWdodCBmcm9tIHRoZSBkcmFnZ2VkIGl0ZW0KCQkJCQlpZiAoICFwLmhlaWdodCgpICkgewoJCQkJCQlwLmhlaWdodCgKCQkJCQkJCXRoYXQuY3VycmVudEl0ZW0uaW5uZXJIZWlnaHQoKSAtCgkJCQkJCQlwYXJzZUludCggdGhhdC5jdXJyZW50SXRlbS5jc3MoICJwYWRkaW5nVG9wIiApIHx8IDAsIDEwICkgLQoJCQkJCQkJcGFyc2VJbnQoIHRoYXQuY3VycmVudEl0ZW0uY3NzKCAicGFkZGluZ0JvdHRvbSIgKSB8fCAwLCAxMCApICk7CgkJCQkJfQoJCQkJCWlmICggIXAud2lkdGgoKSApIHsKCQkJCQkJcC53aWR0aCgKCQkJCQkJCXRoYXQuY3VycmVudEl0ZW0uaW5uZXJXaWR0aCgpIC0KCQkJCQkJCXBhcnNlSW50KCB0aGF0LmN1cnJlbnRJdGVtLmNzcyggInBhZGRpbmdMZWZ0IiApIHx8IDAsIDEwICkgLQoJCQkJCQkJcGFyc2VJbnQoIHRoYXQuY3VycmVudEl0ZW0uY3NzKCAicGFkZGluZ1JpZ2h0IiApIHx8IDAsIDEwICkgKTsKCQkJCQl9CgkJCQl9CgkJCX07CgkJfQoKCQkvL0NyZWF0ZSB0aGUgcGxhY2Vob2xkZXIKCQl0aGF0LnBsYWNlaG9sZGVyID0gJCggby5wbGFjZWhvbGRlci5lbGVtZW50LmNhbGwoIHRoYXQuZWxlbWVudCwgdGhhdC5jdXJyZW50SXRlbSApICk7CgoJCS8vQXBwZW5kIGl0IGFmdGVyIHRoZSBhY3R1YWwgY3VycmVudCBpdGVtCgkJdGhhdC5jdXJyZW50SXRlbS5hZnRlciggdGhhdC5wbGFjZWhvbGRlciApOwoKCQkvL1VwZGF0ZSB0aGUgc2l6ZSBvZiB0aGUgcGxhY2Vob2xkZXIgKFRPRE86IExvZ2ljIHRvIGZ1enp5LCBzZWUgbGluZSAzMTYvMzE3KQoJCW8ucGxhY2Vob2xkZXIudXBkYXRlKCB0aGF0LCB0aGF0LnBsYWNlaG9sZGVyICk7CgoJfSwKCglfY3JlYXRlVHJQbGFjZWhvbGRlcjogZnVuY3Rpb24oIHNvdXJjZVRyLCB0YXJnZXRUciApIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCXNvdXJjZVRyLmNoaWxkcmVuKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoICI8dGQ+JiMxNjA7PC90ZD4iLCB0aGF0LmRvY3VtZW50WyAwIF0gKQoJCQkJLmF0dHIoICJjb2xzcGFuIiwgJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApIHx8IDEgKQoJCQkJLmFwcGVuZFRvKCB0YXJnZXRUciApOwoJCX0gKTsKCX0sCgoJX2NvbnRhY3RDb250YWluZXJzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGksIGosIGRpc3QsIGl0ZW1XaXRoTGVhc3REaXN0YW5jZSwgcG9zUHJvcGVydHksIHNpemVQcm9wZXJ0eSwgY3VyLCBuZWFyQm90dG9tLAoJCQlmbG9hdGluZywgYXhpcywKCQkJaW5uZXJtb3N0Q29udGFpbmVyID0gbnVsbCwKCQkJaW5uZXJtb3N0SW5kZXggPSBudWxsOwoKCQkvLyBHZXQgaW5uZXJtb3N0IGNvbnRhaW5lciB0aGF0IGludGVyc2VjdHMgd2l0aCBpdGVtCgkJZm9yICggaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCgkJCS8vIE5ldmVyIGNvbnNpZGVyIGEgY29udGFpbmVyIHRoYXQncyBsb2NhdGVkIHdpdGhpbiB0aGUgaXRlbSBpdHNlbGYKCQkJaWYgKCAkLmNvbnRhaW5zKCB0aGlzLmN1cnJlbnRJdGVtWyAwIF0sIHRoaXMuY29udGFpbmVyc1sgaSBdLmVsZW1lbnRbIDAgXSApICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCWlmICggdGhpcy5faW50ZXJzZWN0c1dpdGgoIHRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlICkgKSB7CgoJCQkJLy8gSWYgd2UndmUgYWxyZWFkeSBmb3VuZCBhIGNvbnRhaW5lciBhbmQgaXQncyBtb3JlICJpbm5lciIgdGhhbiB0aGlzLCB0aGVuIGNvbnRpbnVlCgkJCQlpZiAoIGlubmVybW9zdENvbnRhaW5lciAmJgoJCQkJCQkkLmNvbnRhaW5zKAoJCQkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uZWxlbWVudFsgMCBdLAoJCQkJCQkJaW5uZXJtb3N0Q29udGFpbmVyLmVsZW1lbnRbIDAgXSApICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCWlubmVybW9zdENvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyc1sgaSBdOwoJCQkJaW5uZXJtb3N0SW5kZXggPSBpOwoKCQkJfSBlbHNlIHsKCgkJCQkvLyBjb250YWluZXIgZG9lc24ndCBpbnRlcnNlY3QuIHRyaWdnZXIgIm91dCIgZXZlbnQgaWYgbmVjZXNzYXJ5CgkJCQlpZiAoIHRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7CgkJCQkJdGhpcy5jb250YWluZXJzWyBpIF0uX3RyaWdnZXIoICJvdXQiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsKCQkJCQl0aGlzLmNvbnRhaW5lcnNbIGkgXS5jb250YWluZXJDYWNoZS5vdmVyID0gMDsKCQkJCX0KCQkJfQoKCQl9CgoJCS8vIElmIG5vIGludGVyc2VjdGluZyBjb250YWluZXJzIGZvdW5kLCByZXR1cm4KCQlpZiAoICFpbm5lcm1vc3RDb250YWluZXIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE1vdmUgdGhlIGl0ZW0gaW50byB0aGUgY29udGFpbmVyIGlmIGl0J3Mgbm90IHRoZXJlIGFscmVhZHkKCQlpZiAoIHRoaXMuY29udGFpbmVycy5sZW5ndGggPT09IDEgKSB7CgkJCWlmICggIXRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXS5jb250YWluZXJDYWNoZS5vdmVyICkgewoJCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLl90cmlnZ2VyKCAib3ZlciIsIGV2ZW50LCB0aGlzLl91aUhhc2goIHRoaXMgKSApOwoJCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAxOwoJCQl9CgkJfSBlbHNlIHsKCgkJCS8vIFdoZW4gZW50ZXJpbmcgYSBuZXcgY29udGFpbmVyLCB3ZSB3aWxsIGZpbmQgdGhlIGl0ZW0gd2l0aCB0aGUgbGVhc3QgZGlzdGFuY2UgYW5kCgkJCS8vIGFwcGVuZCBvdXIgaXRlbSBuZWFyIGl0CgkJCWRpc3QgPSAxMDAwMDsKCQkJaXRlbVdpdGhMZWFzdERpc3RhbmNlID0gbnVsbDsKCQkJZmxvYXRpbmcgPSBpbm5lcm1vc3RDb250YWluZXIuZmxvYXRpbmcgfHwgdGhpcy5faXNGbG9hdGluZyggdGhpcy5jdXJyZW50SXRlbSApOwoJCQlwb3NQcm9wZXJ0eSA9IGZsb2F0aW5nID8gImxlZnQiIDogInRvcCI7CgkJCXNpemVQcm9wZXJ0eSA9IGZsb2F0aW5nID8gIndpZHRoIiA6ICJoZWlnaHQiOwoJCQlheGlzID0gZmxvYXRpbmcgPyAicGFnZVgiIDogInBhZ2VZIjsKCgkJCWZvciAoIGogPSB0aGlzLml0ZW1zLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tICkgewoJCQkJaWYgKCAhJC5jb250YWlucygKCQkJCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLmVsZW1lbnRbIDAgXSwgdGhpcy5pdGVtc1sgaiBdLml0ZW1bIDAgXSApCgkJCQkpIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCWlmICggdGhpcy5pdGVtc1sgaiBdLml0ZW1bIDAgXSA9PT0gdGhpcy5jdXJyZW50SXRlbVsgMCBdICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCWN1ciA9IHRoaXMuaXRlbXNbIGogXS5pdGVtLm9mZnNldCgpWyBwb3NQcm9wZXJ0eSBdOwoJCQkJbmVhckJvdHRvbSA9IGZhbHNlOwoJCQkJaWYgKCBldmVudFsgYXhpcyBdIC0gY3VyID4gdGhpcy5pdGVtc1sgaiBdWyBzaXplUHJvcGVydHkgXSAvIDIgKSB7CgkJCQkJbmVhckJvdHRvbSA9IHRydWU7CgkJCQl9CgoJCQkJaWYgKCBNYXRoLmFicyggZXZlbnRbIGF4aXMgXSAtIGN1ciApIDwgZGlzdCApIHsKCQkJCQlkaXN0ID0gTWF0aC5hYnMoIGV2ZW50WyBheGlzIF0gLSBjdXIgKTsKCQkJCQlpdGVtV2l0aExlYXN0RGlzdGFuY2UgPSB0aGlzLml0ZW1zWyBqIF07CgkJCQkJdGhpcy5kaXJlY3Rpb24gPSBuZWFyQm90dG9tID8gInVwIiA6ICJkb3duIjsKCQkJCX0KCQkJfQoKCQkJLy9DaGVjayBpZiBkcm9wT25FbXB0eSBpcyBlbmFibGVkCgkJCWlmICggIWl0ZW1XaXRoTGVhc3REaXN0YW5jZSAmJiAhdGhpcy5vcHRpb25zLmRyb3BPbkVtcHR5ICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIHRoaXMuY3VycmVudENvbnRhaW5lciA9PT0gdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdICkgewoJCQkJaWYgKCAhdGhpcy5jdXJyZW50Q29udGFpbmVyLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7CgkJCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLl90cmlnZ2VyKCAib3ZlciIsIGV2ZW50LCB0aGlzLl91aUhhc2goKSApOwoJCQkJCXRoaXMuY3VycmVudENvbnRhaW5lci5jb250YWluZXJDYWNoZS5vdmVyID0gMTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJaXRlbVdpdGhMZWFzdERpc3RhbmNlID8KCQkJCXRoaXMuX3JlYXJyYW5nZSggZXZlbnQsIGl0ZW1XaXRoTGVhc3REaXN0YW5jZSwgbnVsbCwgdHJ1ZSApIDoKCQkJCXRoaXMuX3JlYXJyYW5nZSggZXZlbnQsIG51bGwsIHRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXS5lbGVtZW50LCB0cnVlICk7CgkJCXRoaXMuX3RyaWdnZXIoICJjaGFuZ2UiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsKCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLl90cmlnZ2VyKCAiY2hhbmdlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCXRoaXMuY3VycmVudENvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXTsKCgkJCS8vVXBkYXRlIHRoZSBwbGFjZWhvbGRlcgoJCQl0aGlzLm9wdGlvbnMucGxhY2Vob2xkZXIudXBkYXRlKCB0aGlzLmN1cnJlbnRDb250YWluZXIsIHRoaXMucGxhY2Vob2xkZXIgKTsKCgkJCXRoaXMuY29udGFpbmVyc1sgaW5uZXJtb3N0SW5kZXggXS5fdHJpZ2dlciggIm92ZXIiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzICkgKTsKCQkJdGhpcy5jb250YWluZXJzWyBpbm5lcm1vc3RJbmRleCBdLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAxOwoJCX0KCgl9LAoKCV9jcmVhdGVIZWxwZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCWhlbHBlciA9ICQuaXNGdW5jdGlvbiggby5oZWxwZXIgKSA\/CgkJCQkkKCBvLmhlbHBlci5hcHBseSggdGhpcy5lbGVtZW50WyAwIF0sIFsgZXZlbnQsIHRoaXMuY3VycmVudEl0ZW0gXSApICkgOgoJCQkJKCBvLmhlbHBlciA9PT0gImNsb25lIiA\/IHRoaXMuY3VycmVudEl0ZW0uY2xvbmUoKSA6IHRoaXMuY3VycmVudEl0ZW0gKTsKCgkJLy9BZGQgdGhlIGhlbHBlciB0byB0aGUgRE9NIGlmIHRoYXQgZGlkbid0IGhhcHBlbiBhbHJlYWR5CgkJaWYgKCAhaGVscGVyLnBhcmVudHMoICJib2R5IiApLmxlbmd0aCApIHsKCQkJJCggby5hcHBlbmRUbyAhPT0gInBhcmVudCIgPwoJCQkJby5hcHBlbmRUbyA6CgkJCQl0aGlzLmN1cnJlbnRJdGVtWyAwIF0ucGFyZW50Tm9kZSApWyAwIF0uYXBwZW5kQ2hpbGQoIGhlbHBlclsgMCBdICk7CgkJfQoKCQlpZiAoIGhlbHBlclsgMCBdID09PSB0aGlzLmN1cnJlbnRJdGVtWyAwIF0gKSB7CgkJCXRoaXMuX3N0b3JlZENTUyA9IHsKCQkJCXdpZHRoOiB0aGlzLmN1cnJlbnRJdGVtWyAwIF0uc3R5bGUud2lkdGgsCgkJCQloZWlnaHQ6IHRoaXMuY3VycmVudEl0ZW1bIDAgXS5zdHlsZS5oZWlnaHQsCgkJCQlwb3NpdGlvbjogdGhpcy5jdXJyZW50SXRlbS5jc3MoICJwb3NpdGlvbiIgKSwKCQkJCXRvcDogdGhpcy5jdXJyZW50SXRlbS5jc3MoICJ0b3AiICksCgkJCQlsZWZ0OiB0aGlzLmN1cnJlbnRJdGVtLmNzcyggImxlZnQiICkKCQkJfTsKCQl9CgoJCWlmICggIWhlbHBlclsgMCBdLnN0eWxlLndpZHRoIHx8IG8uZm9yY2VIZWxwZXJTaXplICkgewoJCQloZWxwZXIud2lkdGgoIHRoaXMuY3VycmVudEl0ZW0ud2lkdGgoKSApOwoJCX0KCQlpZiAoICFoZWxwZXJbIDAgXS5zdHlsZS5oZWlnaHQgfHwgby5mb3JjZUhlbHBlclNpemUgKSB7CgkJCWhlbHBlci5oZWlnaHQoIHRoaXMuY3VycmVudEl0ZW0uaGVpZ2h0KCkgKTsKCQl9CgoJCXJldHVybiBoZWxwZXI7CgoJfSwKCglfYWRqdXN0T2Zmc2V0RnJvbUhlbHBlcjogZnVuY3Rpb24oIG9iaiApIHsKCQlpZiAoIHR5cGVvZiBvYmogPT09ICJzdHJpbmciICkgewoJCQlvYmogPSBvYmouc3BsaXQoICIgIiApOwoJCX0KCQlpZiAoICQuaXNBcnJheSggb2JqICkgKSB7CgkJCW9iaiA9IHsgbGVmdDogK29ialsgMCBdLCB0b3A6ICtvYmpbIDEgXSB8fCAwIH07CgkJfQoJCWlmICggImxlZnQiIGluIG9iaiApIHsKCQkJdGhpcy5vZmZzZXQuY2xpY2subGVmdCA9IG9iai5sZWZ0ICsgdGhpcy5tYXJnaW5zLmxlZnQ7CgkJfQoJCWlmICggInJpZ2h0IiBpbiBvYmogKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPSB0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoIC0gb2JqLnJpZ2h0ICsgdGhpcy5tYXJnaW5zLmxlZnQ7CgkJfQoJCWlmICggInRvcCIgaW4gb2JqICkgewoJCQl0aGlzLm9mZnNldC5jbGljay50b3AgPSBvYmoudG9wICsgdGhpcy5tYXJnaW5zLnRvcDsKCQl9CgkJaWYgKCAiYm90dG9tIiBpbiBvYmogKSB7CgkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCA9IHRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gb2JqLmJvdHRvbSArIHRoaXMubWFyZ2lucy50b3A7CgkJfQoJfSwKCglfZ2V0UGFyZW50T2Zmc2V0OiBmdW5jdGlvbigpIHsKCgkJLy9HZXQgdGhlIG9mZnNldFBhcmVudCBhbmQgY2FjaGUgaXRzIHBvc2l0aW9uCgkJdGhpcy5vZmZzZXRQYXJlbnQgPSB0aGlzLmhlbHBlci5vZmZzZXRQYXJlbnQoKTsKCQl2YXIgcG8gPSB0aGlzLm9mZnNldFBhcmVudC5vZmZzZXQoKTsKCgkJLy8gVGhpcyBpcyBhIHNwZWNpYWwgY2FzZSB3aGVyZSB3ZSBuZWVkIHRvIG1vZGlmeSBhIG9mZnNldCBjYWxjdWxhdGVkIG9uIHN0YXJ0LCBzaW5jZSB0aGUKCQkvLyBmb2xsb3dpbmcgaGFwcGVuZWQ6CgkJLy8gMS4gVGhlIHBvc2l0aW9uIG9mIHRoZSBoZWxwZXIgaXMgYWJzb2x1dGUsIHNvIGl0J3MgcG9zaXRpb24gaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiB0aGUKCQkvLyBuZXh0IHBvc2l0aW9uZWQgcGFyZW50CgkJLy8gMi4gVGhlIGFjdHVhbCBvZmZzZXQgcGFyZW50IGlzIGEgY2hpbGQgb2YgdGhlIHNjcm9sbCBwYXJlbnQsIGFuZCB0aGUgc2Nyb2xsIHBhcmVudCBpc24ndAoJCS8vIHRoZSBkb2N1bWVudCwgd2hpY2ggbWVhbnMgdGhhdCB0aGUgc2Nyb2xsIGlzIGluY2x1ZGVkIGluIHRoZSBpbml0aWFsIGNhbGN1bGF0aW9uIG9mIHRoZQoJCS8vIG9mZnNldCBvZiB0aGUgcGFyZW50LCBhbmQgbmV2ZXIgcmVjYWxjdWxhdGVkIHVwb24gZHJhZwoJCWlmICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImFic29sdXRlIiAmJiB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICE9PSB0aGlzLmRvY3VtZW50WyAwIF0gJiYKCQkJCSQuY29udGFpbnMoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0sIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gKSApIHsKCQkJcG8ubGVmdCArPSB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCk7CgkJCXBvLnRvcCArPSB0aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKTsKCQl9CgoJCS8vIFRoaXMgbmVlZHMgdG8gYmUgYWN0dWFsbHkgZG9uZSBmb3IgYWxsIGJyb3dzZXJzLCBzaW5jZSBwYWdlWC9wYWdlWSBpbmNsdWRlcyB0aGlzCgkJLy8gaW5mb3JtYXRpb24gd2l0aCBhbiB1Z2x5IElFIGZpeAoJCWlmICggdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSA9PT0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHkgfHwKCQkJCSggdGhpcy5vZmZzZXRQYXJlbnRbIDAgXS50YWdOYW1lICYmCgkJCQl0aGlzLm9mZnNldFBhcmVudFsgMCBdLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gImh0bWwiICYmICQudWkuaWUgKSApIHsKCQkJcG8gPSB7IHRvcDogMCwgbGVmdDogMCB9OwoJCX0KCgkJcmV0dXJuIHsKCQkJdG9wOiBwby50b3AgKyAoIHBhcnNlSW50KCB0aGlzLm9mZnNldFBhcmVudC5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICksCgkJCWxlZnQ6IHBvLmxlZnQgKyAoIHBhcnNlSW50KCB0aGlzLm9mZnNldFBhcmVudC5jc3MoICJib3JkZXJMZWZ0V2lkdGgiICksIDEwICkgfHwgMCApCgkJfTsKCgl9LAoKCV9nZXRSZWxhdGl2ZU9mZnNldDogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gInJlbGF0aXZlIiApIHsKCQkJdmFyIHAgPSB0aGlzLmN1cnJlbnRJdGVtLnBvc2l0aW9uKCk7CgkJCXJldHVybiB7CgkJCQl0b3A6IHAudG9wIC0gKCBwYXJzZUludCggdGhpcy5oZWxwZXIuY3NzKCAidG9wIiApLCAxMCApIHx8IDAgKSArCgkJCQkJdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCksCgkJCQlsZWZ0OiBwLmxlZnQgLSAoIHBhcnNlSW50KCB0aGlzLmhlbHBlci5jc3MoICJsZWZ0IiApLCAxMCApIHx8IDAgKSArCgkJCQkJdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCgpCgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHsgdG9wOiAwLCBsZWZ0OiAwIH07CgkJfQoKCX0sCgoJX2NhY2hlTWFyZ2luczogZnVuY3Rpb24oKSB7CgkJdGhpcy5tYXJnaW5zID0gewoJCQlsZWZ0OiAoIHBhcnNlSW50KCB0aGlzLmN1cnJlbnRJdGVtLmNzcyggIm1hcmdpbkxlZnQiICksIDEwICkgfHwgMCApLAoJCQl0b3A6ICggcGFyc2VJbnQoIHRoaXMuY3VycmVudEl0ZW0uY3NzKCAibWFyZ2luVG9wIiApLCAxMCApIHx8IDAgKQoJCX07Cgl9LAoKCV9jYWNoZUhlbHBlclByb3BvcnRpb25zOiBmdW5jdGlvbigpIHsKCQl0aGlzLmhlbHBlclByb3BvcnRpb25zID0gewoJCQl3aWR0aDogdGhpcy5oZWxwZXIub3V0ZXJXaWR0aCgpLAoJCQloZWlnaHQ6IHRoaXMuaGVscGVyLm91dGVySGVpZ2h0KCkKCQl9OwoJfSwKCglfc2V0Q29udGFpbm1lbnQ6IGZ1bmN0aW9uKCkgewoKCQl2YXIgY2UsIGNvLCBvdmVyLAoJCQlvID0gdGhpcy5vcHRpb25zOwoJCWlmICggby5jb250YWlubWVudCA9PT0gInBhcmVudCIgKSB7CgkJCW8uY29udGFpbm1lbnQgPSB0aGlzLmhlbHBlclsgMCBdLnBhcmVudE5vZGU7CgkJfQoJCWlmICggby5jb250YWlubWVudCA9PT0gImRvY3VtZW50IiB8fCBvLmNvbnRhaW5tZW50ID09PSAid2luZG93IiApIHsKCQkJdGhpcy5jb250YWlubWVudCA9IFsKCQkJCTAgLSB0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0IC0gdGhpcy5vZmZzZXQucGFyZW50LmxlZnQsCgkJCQkwIC0gdGhpcy5vZmZzZXQucmVsYXRpdmUudG9wIC0gdGhpcy5vZmZzZXQucGFyZW50LnRvcCwKCQkJCW8uY29udGFpbm1lbnQgPT09ICJkb2N1bWVudCIgPwoJCQkJCXRoaXMuZG9jdW1lbnQud2lkdGgoKSA6CgkJCQkJdGhpcy53aW5kb3cud2lkdGgoKSAtIHRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGggLSB0aGlzLm1hcmdpbnMubGVmdCwKCQkJCSggby5jb250YWlubWVudCA9PT0gImRvY3VtZW50IiA\/CgkJCQkJKCB0aGlzLmRvY3VtZW50LmhlaWdodCgpIHx8IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5zY3JvbGxIZWlnaHQgKSA6CgkJCQkJdGhpcy53aW5kb3cuaGVpZ2h0KCkgfHwgdGhpcy5kb2N1bWVudFsgMCBdLmJvZHkucGFyZW50Tm9kZS5zY3JvbGxIZWlnaHQKCQkJCSkgLSB0aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodCAtIHRoaXMubWFyZ2lucy50b3AKCQkJXTsKCQl9CgoJCWlmICggISggL14oZG9jdW1lbnR8d2luZG93fHBhcmVudCkkLyApLnRlc3QoIG8uY29udGFpbm1lbnQgKSApIHsKCQkJY2UgPSAkKCBvLmNvbnRhaW5tZW50IClbIDAgXTsKCQkJY28gPSAkKCBvLmNvbnRhaW5tZW50ICkub2Zmc2V0KCk7CgkJCW92ZXIgPSAoICQoIGNlICkuY3NzKCAib3ZlcmZsb3ciICkgIT09ICJoaWRkZW4iICk7CgoJCQl0aGlzLmNvbnRhaW5tZW50ID0gWwoJCQkJY28ubGVmdCArICggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAiYm9yZGVyTGVmdFdpZHRoIiApLCAxMCApIHx8IDAgKSArCgkJCQkJKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJwYWRkaW5nTGVmdCIgKSwgMTAgKSB8fCAwICkgLSB0aGlzLm1hcmdpbnMubGVmdCwKCQkJCWNvLnRvcCArICggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAiYm9yZGVyVG9wV2lkdGgiICksIDEwICkgfHwgMCApICsKCQkJCQkoIHBhcnNlSW50KCAkKCBjZSApLmNzcyggInBhZGRpbmdUb3AiICksIDEwICkgfHwgMCApIC0gdGhpcy5tYXJnaW5zLnRvcCwKCQkJCWNvLmxlZnQgKyAoIG92ZXIgPyBNYXRoLm1heCggY2Uuc2Nyb2xsV2lkdGgsIGNlLm9mZnNldFdpZHRoICkgOiBjZS5vZmZzZXRXaWR0aCApIC0KCQkJCQkoIHBhcnNlSW50KCAkKCBjZSApLmNzcyggImJvcmRlckxlZnRXaWR0aCIgKSwgMTAgKSB8fCAwICkgLQoJCQkJCSggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAicGFkZGluZ1JpZ2h0IiApLCAxMCApIHx8IDAgKSAtCgkJCQkJdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aCAtIHRoaXMubWFyZ2lucy5sZWZ0LAoJCQkJY28udG9wICsgKCBvdmVyID8gTWF0aC5tYXgoIGNlLnNjcm9sbEhlaWdodCwgY2Uub2Zmc2V0SGVpZ2h0ICkgOiBjZS5vZmZzZXRIZWlnaHQgKSAtCgkJCQkJKCBwYXJzZUludCggJCggY2UgKS5jc3MoICJib3JkZXJUb3BXaWR0aCIgKSwgMTAgKSB8fCAwICkgLQoJCQkJCSggcGFyc2VJbnQoICQoIGNlICkuY3NzKCAicGFkZGluZ0JvdHRvbSIgKSwgMTAgKSB8fCAwICkgLQoJCQkJCXRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0IC0gdGhpcy5tYXJnaW5zLnRvcAoJCQldOwoJCX0KCgl9LAoKCV9jb252ZXJ0UG9zaXRpb25UbzogZnVuY3Rpb24oIGQsIHBvcyApIHsKCgkJaWYgKCAhcG9zICkgewoJCQlwb3MgPSB0aGlzLnBvc2l0aW9uOwoJCX0KCQl2YXIgbW9kID0gZCA9PT0gImFic29sdXRlIiA\/IDEgOiAtMSwKCQkJc2Nyb2xsID0gdGhpcy5jc3NQb3NpdGlvbiA9PT0gImFic29sdXRlIiAmJgoJCQkJISggdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5kb2N1bWVudFsgMCBdICYmCgkJCQkkLmNvbnRhaW5zKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdLCB0aGlzLm9mZnNldFBhcmVudFsgMCBdICkgKSA\/CgkJCQkJdGhpcy5vZmZzZXRQYXJlbnQgOgoJCQkJCXRoaXMuc2Nyb2xsUGFyZW50LAoJCQlzY3JvbGxJc1Jvb3ROb2RlID0gKCAvKGh0bWx8Ym9keSkvaSApLnRlc3QoIHNjcm9sbFsgMCBdLnRhZ05hbWUgKTsKCgkJcmV0dXJuIHsKCQkJdG9wOiAoCgoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQlwb3MudG9wCSsKCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCAqIG1vZCArCgoJCQkJLy8gVGhlIG9mZnNldFBhcmVudCdzIG9mZnNldCB3aXRob3V0IGJvcmRlcnMgKG9mZnNldCArIGJvcmRlcikKCQkJCXRoaXMub2Zmc2V0LnBhcmVudC50b3AgKiBtb2QgLQoJCQkJKCAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPwoJCQkJCS10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxUb3AoKSA6CgkJCQkJKCBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6IHNjcm9sbC5zY3JvbGxUb3AoKSApICkgKiBtb2QgKQoJCQkpLAoJCQlsZWZ0OiAoCgoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQlwb3MubGVmdCArCgoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS5sZWZ0ICogbW9kICsKCgkJCQkvLyBUaGUgb2Zmc2V0UGFyZW50J3Mgb2Zmc2V0IHdpdGhvdXQgYm9yZGVycyAob2Zmc2V0ICsgYm9yZGVyKQoJCQkJdGhpcy5vZmZzZXQucGFyZW50LmxlZnQgKiBtb2QJLQoJCQkJKCAoIHRoaXMuY3NzUG9zaXRpb24gPT09ICJmaXhlZCIgPwoJCQkJCS10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCkgOiBzY3JvbGxJc1Jvb3ROb2RlID8gMCA6CgkJCQkJc2Nyb2xsLnNjcm9sbExlZnQoKSApICogbW9kICkKCQkJKQoJCX07CgoJfSwKCglfZ2VuZXJhdGVQb3NpdGlvbjogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQl2YXIgdG9wLCBsZWZ0LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlwYWdlWCA9IGV2ZW50LnBhZ2VYLAoJCQlwYWdlWSA9IGV2ZW50LnBhZ2VZLAoJCQlzY3JvbGwgPSB0aGlzLmNzc1Bvc2l0aW9uID09PSAiYWJzb2x1dGUiICYmCgkJCQkhKCB0aGlzLnNjcm9sbFBhcmVudFsgMCBdICE9PSB0aGlzLmRvY3VtZW50WyAwIF0gJiYKCQkJCSQuY29udGFpbnMoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0sIHRoaXMub2Zmc2V0UGFyZW50WyAwIF0gKSApID8KCQkJCQl0aGlzLm9mZnNldFBhcmVudCA6CgkJCQkJdGhpcy5zY3JvbGxQYXJlbnQsCgkJCQlzY3JvbGxJc1Jvb3ROb2RlID0gKCAvKGh0bWx8Ym9keSkvaSApLnRlc3QoIHNjcm9sbFsgMCBdLnRhZ05hbWUgKTsKCgkJLy8gVGhpcyBpcyBhbm90aGVyIHZlcnkgd2VpcmQgc3BlY2lhbCBjYXNlIHRoYXQgb25seSBoYXBwZW5zIGZvciByZWxhdGl2ZSBlbGVtZW50czoKCQkvLyAxLiBJZiB0aGUgY3NzIHBvc2l0aW9uIGlzIHJlbGF0aXZlCgkJLy8gMi4gYW5kIHRoZSBzY3JvbGwgcGFyZW50IGlzIHRoZSBkb2N1bWVudCBvciBzaW1pbGFyIHRvIHRoZSBvZmZzZXQgcGFyZW50CgkJLy8gd2UgaGF2ZSB0byByZWZyZXNoIHRoZSByZWxhdGl2ZSBvZmZzZXQgZHVyaW5nIHRoZSBzY3JvbGwgc28gdGhlcmUgYXJlIG5vIGp1bXBzCgkJaWYgKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAicmVsYXRpdmUiICYmICEoIHRoaXMuc2Nyb2xsUGFyZW50WyAwIF0gIT09IHRoaXMuZG9jdW1lbnRbIDAgXSAmJgoJCQkJdGhpcy5zY3JvbGxQYXJlbnRbIDAgXSAhPT0gdGhpcy5vZmZzZXRQYXJlbnRbIDAgXSApICkgewoJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZSA9IHRoaXMuX2dldFJlbGF0aXZlT2Zmc2V0KCk7CgkJfQoKCQkvKgoJCSAqIC0gUG9zaXRpb24gY29uc3RyYWluaW5nIC0KCQkgKiBDb25zdHJhaW4gdGhlIHBvc2l0aW9uIHRvIGEgbWl4IG9mIGdyaWQsIGNvbnRhaW5tZW50LgoJCSAqLwoKCQlpZiAoIHRoaXMub3JpZ2luYWxQb3NpdGlvbiApIHsgLy9JZiB3ZSBhcmUgbm90IGRyYWdnaW5nIHlldCwgd2Ugd29uJ3QgY2hlY2sgZm9yIG9wdGlvbnMKCgkJCWlmICggdGhpcy5jb250YWlubWVudCApIHsKCQkJCWlmICggZXZlbnQucGFnZVggLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0IDwgdGhpcy5jb250YWlubWVudFsgMCBdICkgewoJCQkJCXBhZ2VYID0gdGhpcy5jb250YWlubWVudFsgMCBdICsgdGhpcy5vZmZzZXQuY2xpY2subGVmdDsKCQkJCX0KCQkJCWlmICggZXZlbnQucGFnZVkgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPCB0aGlzLmNvbnRhaW5tZW50WyAxIF0gKSB7CgkJCQkJcGFnZVkgPSB0aGlzLmNvbnRhaW5tZW50WyAxIF0gKyB0aGlzLm9mZnNldC5jbGljay50b3A7CgkJCQl9CgkJCQlpZiAoIGV2ZW50LnBhZ2VYIC0gdGhpcy5vZmZzZXQuY2xpY2subGVmdCA+IHRoaXMuY29udGFpbm1lbnRbIDIgXSApIHsKCQkJCQlwYWdlWCA9IHRoaXMuY29udGFpbm1lbnRbIDIgXSArIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQ7CgkJCQl9CgkJCQlpZiAoIGV2ZW50LnBhZ2VZIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID4gdGhpcy5jb250YWlubWVudFsgMyBdICkgewoJCQkJCXBhZ2VZID0gdGhpcy5jb250YWlubWVudFsgMyBdICsgdGhpcy5vZmZzZXQuY2xpY2sudG9wOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG8uZ3JpZCApIHsKCQkJCXRvcCA9IHRoaXMub3JpZ2luYWxQYWdlWSArIE1hdGgucm91bmQoICggcGFnZVkgLSB0aGlzLm9yaWdpbmFsUGFnZVkgKSAvCgkJCQkJby5ncmlkWyAxIF0gKSAqIG8uZ3JpZFsgMSBdOwoJCQkJcGFnZVkgPSB0aGlzLmNvbnRhaW5tZW50ID8KCQkJCQkoICggdG9wIC0gdGhpcy5vZmZzZXQuY2xpY2sudG9wID49IHRoaXMuY29udGFpbm1lbnRbIDEgXSAmJgoJCQkJCQl0b3AgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPD0gdGhpcy5jb250YWlubWVudFsgMyBdICkgPwoJCQkJCQkJdG9wIDoKCQkJCQkJCSggKCB0b3AgLSB0aGlzLm9mZnNldC5jbGljay50b3AgPj0gdGhpcy5jb250YWlubWVudFsgMSBdICkgPwoJCQkJCQkJCXRvcCAtIG8uZ3JpZFsgMSBdIDogdG9wICsgby5ncmlkWyAxIF0gKSApIDoKCQkJCQkJCQl0b3A7CgoJCQkJbGVmdCA9IHRoaXMub3JpZ2luYWxQYWdlWCArIE1hdGgucm91bmQoICggcGFnZVggLSB0aGlzLm9yaWdpbmFsUGFnZVggKSAvCgkJCQkJby5ncmlkWyAwIF0gKSAqIG8uZ3JpZFsgMCBdOwoJCQkJcGFnZVggPSB0aGlzLmNvbnRhaW5tZW50ID8KCQkJCQkoICggbGVmdCAtIHRoaXMub2Zmc2V0LmNsaWNrLmxlZnQgPj0gdGhpcy5jb250YWlubWVudFsgMCBdICYmCgkJCQkJCWxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0IDw9IHRoaXMuY29udGFpbm1lbnRbIDIgXSApID8KCQkJCQkJCWxlZnQgOgoJCQkJCQkJKCAoIGxlZnQgLSB0aGlzLm9mZnNldC5jbGljay5sZWZ0ID49IHRoaXMuY29udGFpbm1lbnRbIDAgXSApID8KCQkJCQkJCQlsZWZ0IC0gby5ncmlkWyAwIF0gOiBsZWZ0ICsgby5ncmlkWyAwIF0gKSApIDoKCQkJCQkJCQlsZWZ0OwoJCQl9CgoJCX0KCgkJcmV0dXJuIHsKCQkJdG9wOiAoCgoJCQkJLy8gVGhlIGFic29sdXRlIG1vdXNlIHBvc2l0aW9uCgkJCQlwYWdlWSAtCgoJCQkJLy8gQ2xpY2sgb2Zmc2V0IChyZWxhdGl2ZSB0byB0aGUgZWxlbWVudCkKCQkJCXRoaXMub2Zmc2V0LmNsaWNrLnRvcCAtCgoJCQkJLy8gT25seSBmb3IgcmVsYXRpdmUgcG9zaXRpb25lZCBub2RlczogUmVsYXRpdmUgb2Zmc2V0IGZyb20gZWxlbWVudCB0byBvZmZzZXQgcGFyZW50CgkJCQl0aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AgLQoKCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQudG9wICsKCQkJCSggKCB0aGlzLmNzc1Bvc2l0aW9uID09PSAiZml4ZWQiID8KCQkJCQktdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCkgOgoJCQkJCSggc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiBzY3JvbGwuc2Nyb2xsVG9wKCkgKSApICkKCQkJKSwKCQkJbGVmdDogKAoKCQkJCS8vIFRoZSBhYnNvbHV0ZSBtb3VzZSBwb3NpdGlvbgoJCQkJcGFnZVggLQoKCQkJCS8vIENsaWNrIG9mZnNldCAocmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQpCgkJCQl0aGlzLm9mZnNldC5jbGljay5sZWZ0IC0KCgkJCQkvLyBPbmx5IGZvciByZWxhdGl2ZSBwb3NpdGlvbmVkIG5vZGVzOiBSZWxhdGl2ZSBvZmZzZXQgZnJvbSBlbGVtZW50IHRvIG9mZnNldCBwYXJlbnQKCQkJCXRoaXMub2Zmc2V0LnJlbGF0aXZlLmxlZnQgLQoKCQkJCS8vIFRoZSBvZmZzZXRQYXJlbnQncyBvZmZzZXQgd2l0aG91dCBib3JkZXJzIChvZmZzZXQgKyBib3JkZXIpCgkJCQl0aGlzLm9mZnNldC5wYXJlbnQubGVmdCArCgkJCQkoICggdGhpcy5jc3NQb3NpdGlvbiA9PT0gImZpeGVkIiA\/CgkJCQkJLXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKSA6CgkJCQkJc2Nyb2xsSXNSb290Tm9kZSA\/IDAgOiBzY3JvbGwuc2Nyb2xsTGVmdCgpICkgKQoJCQkpCgkJfTsKCgl9LAoKCV9yZWFycmFuZ2U6IGZ1bmN0aW9uKCBldmVudCwgaSwgYSwgaGFyZFJlZnJlc2ggKSB7CgoJCWEgPyBhWyAwIF0uYXBwZW5kQ2hpbGQoIHRoaXMucGxhY2Vob2xkZXJbIDAgXSApIDoKCQkJaS5pdGVtWyAwIF0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIHRoaXMucGxhY2Vob2xkZXJbIDAgXSwKCQkJCSggdGhpcy5kaXJlY3Rpb24gPT09ICJkb3duIiA\/IGkuaXRlbVsgMCBdIDogaS5pdGVtWyAwIF0ubmV4dFNpYmxpbmcgKSApOwoKCQkvL1ZhcmlvdXMgdGhpbmdzIGRvbmUgaGVyZSB0byBpbXByb3ZlIHRoZSBwZXJmb3JtYW5jZToKCQkvLyAxLiB3ZSBjcmVhdGUgYSBzZXRUaW1lb3V0LCB0aGF0IGNhbGxzIHJlZnJlc2hQb3NpdGlvbnMKCQkvLyAyLiBvbiB0aGUgaW5zdGFuY2UsIHdlIGhhdmUgYSBjb3VudGVyIHZhcmlhYmxlLCB0aGF0IGdldCdzIGhpZ2hlciBhZnRlciBldmVyeSBhcHBlbmQKCQkvLyAzLiBvbiB0aGUgbG9jYWwgc2NvcGUsIHdlIGNvcHkgdGhlIGNvdW50ZXIgdmFyaWFibGUsIGFuZCBjaGVjayBpbiB0aGUgdGltZW91dCwKCQkvLyBpZiBpdCdzIHN0aWxsIHRoZSBzYW1lCgkJLy8gNC4gdGhpcyBsZXRzIG9ubHkgdGhlIGxhc3QgYWRkaXRpb24gdG8gdGhlIHRpbWVvdXQgc3RhY2sgdGhyb3VnaAoJCXRoaXMuY291bnRlciA9IHRoaXMuY291bnRlciA\/ICsrdGhpcy5jb3VudGVyIDogMTsKCQl2YXIgY291bnRlciA9IHRoaXMuY291bnRlcjsKCgkJdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQlpZiAoIGNvdW50ZXIgPT09IHRoaXMuY291bnRlciApIHsKCgkJCQkvL1ByZWNvbXB1dGUgYWZ0ZXIgZWFjaCBET00gaW5zZXJ0aW9uLCBOT1Qgb24gbW91c2Vtb3ZlCgkJCQl0aGlzLnJlZnJlc2hQb3NpdGlvbnMoICFoYXJkUmVmcmVzaCApOwoJCQl9CgkJfSApOwoKCX0sCgoJX2NsZWFyOiBmdW5jdGlvbiggZXZlbnQsIG5vUHJvcGFnYXRpb24gKSB7CgoJCXRoaXMucmV2ZXJ0aW5nID0gZmFsc2U7CgoJCS8vIFdlIGRlbGF5IGFsbCBldmVudHMgdGhhdCBoYXZlIHRvIGJlIHRyaWdnZXJlZCB0byBhZnRlciB0aGUgcG9pbnQgd2hlcmUgdGhlIHBsYWNlaG9sZGVyCgkJLy8gaGFzIGJlZW4gcmVtb3ZlZCBhbmQgZXZlcnl0aGluZyBlbHNlIG5vcm1hbGl6ZWQgYWdhaW4KCQl2YXIgaSwKCQkJZGVsYXllZFRyaWdnZXJzID0gW107CgoJCS8vIFdlIGZpcnN0IGhhdmUgdG8gdXBkYXRlIHRoZSBkb20gcG9zaXRpb24gb2YgdGhlIGFjdHVhbCBjdXJyZW50SXRlbQoJCS8vIE5vdGU6IGRvbid0IGRvIGl0IGlmIHRoZSBjdXJyZW50IGl0ZW0gaXMgYWxyZWFkeSByZW1vdmVkIChieSBhIHVzZXIpLCBvciBpdCBnZXRzCgkJLy8gcmVhcHBlbmRlZCAoc2VlICM0MDg4KQoJCWlmICggIXRoaXMuX25vRmluYWxTb3J0ICYmIHRoaXMuY3VycmVudEl0ZW0ucGFyZW50KCkubGVuZ3RoICkgewoJCQl0aGlzLnBsYWNlaG9sZGVyLmJlZm9yZSggdGhpcy5jdXJyZW50SXRlbSApOwoJCX0KCQl0aGlzLl9ub0ZpbmFsU29ydCA9IG51bGw7CgoJCWlmICggdGhpcy5oZWxwZXJbIDAgXSA9PT0gdGhpcy5jdXJyZW50SXRlbVsgMCBdICkgewoJCQlmb3IgKCBpIGluIHRoaXMuX3N0b3JlZENTUyApIHsKCQkJCWlmICggdGhpcy5fc3RvcmVkQ1NTWyBpIF0gPT09ICJhdXRvIiB8fCB0aGlzLl9zdG9yZWRDU1NbIGkgXSA9PT0gInN0YXRpYyIgKSB7CgkJCQkJdGhpcy5fc3RvcmVkQ1NTWyBpIF0gPSAiIjsKCQkJCX0KCQkJfQoJCQl0aGlzLmN1cnJlbnRJdGVtLmNzcyggdGhpcy5fc3RvcmVkQ1NTICk7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCB0aGlzLmN1cnJlbnRJdGVtLCAidWktc29ydGFibGUtaGVscGVyIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuY3VycmVudEl0ZW0uc2hvdygpOwoJCX0KCgkJaWYgKCB0aGlzLmZyb21PdXRzaWRlICYmICFub1Byb3BhZ2F0aW9uICkgewoJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5fdHJpZ2dlciggInJlY2VpdmUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCB0aGlzLmZyb21PdXRzaWRlICkgKTsKCQkJfSApOwoJCX0KCQlpZiAoICggdGhpcy5mcm9tT3V0c2lkZSB8fAoJCQkJdGhpcy5kb21Qb3NpdGlvbi5wcmV2ICE9PQoJCQkJdGhpcy5jdXJyZW50SXRlbS5wcmV2KCkubm90KCAiLnVpLXNvcnRhYmxlLWhlbHBlciIgKVsgMCBdIHx8CgkJCQl0aGlzLmRvbVBvc2l0aW9uLnBhcmVudCAhPT0gdGhpcy5jdXJyZW50SXRlbS5wYXJlbnQoKVsgMCBdICkgJiYgIW5vUHJvcGFnYXRpb24gKSB7CgoJCQkvLyBUcmlnZ2VyIHVwZGF0ZSBjYWxsYmFjayBpZiB0aGUgRE9NIHBvc2l0aW9uIGhhcyBjaGFuZ2VkCgkJCWRlbGF5ZWRUcmlnZ2Vycy5wdXNoKCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCAidXBkYXRlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpICk7CgkJCX0gKTsKCQl9CgoJCS8vIENoZWNrIGlmIHRoZSBpdGVtcyBDb250YWluZXIgaGFzIENoYW5nZWQgYW5kIHRyaWdnZXIgYXBwcm9wcmlhdGUKCQkvLyBldmVudHMuCgkJaWYgKCB0aGlzICE9PSB0aGlzLmN1cnJlbnRDb250YWluZXIgKSB7CgkJCWlmICggIW5vUHJvcGFnYXRpb24gKSB7CgkJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXRoaXMuX3RyaWdnZXIoICJyZW1vdmUiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsKCQkJCX0gKTsKCQkJCWRlbGF5ZWRUcmlnZ2Vycy5wdXNoKCAoIGZ1bmN0aW9uKCBjICkgewoJCQkJCXJldHVybiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJCWMuX3RyaWdnZXIoICJyZWNlaXZlIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCggdGhpcyApICk7CgkJCQkJfTsKCQkJCX0gKS5jYWxsKCB0aGlzLCB0aGlzLmN1cnJlbnRDb250YWluZXIgKSApOwoJCQkJZGVsYXllZFRyaWdnZXJzLnB1c2goICggZnVuY3Rpb24oIGMgKSB7CgkJCQkJcmV0dXJuIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJYy5fdHJpZ2dlciggInVwZGF0ZSIsIGV2ZW50LCB0aGlzLl91aUhhc2goIHRoaXMgKSApOwoJCQkJCX07CgkJCQl9ICkuY2FsbCggdGhpcywgdGhpcy5jdXJyZW50Q29udGFpbmVyICkgKTsKCQkJfQoJCX0KCgkJLy9Qb3N0IGV2ZW50cyB0byBjb250YWluZXJzCgkJZnVuY3Rpb24gZGVsYXlFdmVudCggdHlwZSwgaW5zdGFuY2UsIGNvbnRhaW5lciApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWNvbnRhaW5lci5fdHJpZ2dlciggdHlwZSwgZXZlbnQsIGluc3RhbmNlLl91aUhhc2goIGluc3RhbmNlICkgKTsKCQkJfTsKCQl9CgkJZm9yICggaSA9IHRoaXMuY29udGFpbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJaWYgKCAhbm9Qcm9wYWdhdGlvbiApIHsKCQkJCWRlbGF5ZWRUcmlnZ2Vycy5wdXNoKCBkZWxheUV2ZW50KCAiZGVhY3RpdmF0ZSIsIHRoaXMsIHRoaXMuY29udGFpbmVyc1sgaSBdICkgKTsKCQkJfQoJCQlpZiAoIHRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgKSB7CgkJCQlkZWxheWVkVHJpZ2dlcnMucHVzaCggZGVsYXlFdmVudCggIm91dCIsIHRoaXMsIHRoaXMuY29udGFpbmVyc1sgaSBdICkgKTsKCQkJCXRoaXMuY29udGFpbmVyc1sgaSBdLmNvbnRhaW5lckNhY2hlLm92ZXIgPSAwOwoJCQl9CgkJfQoKCQkvL0RvIHdoYXQgd2FzIG9yaWdpbmFsbHkgaW4gcGx1Z2lucwoJCWlmICggdGhpcy5zdG9yZWRDdXJzb3IgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggImJvZHkiICkuY3NzKCAiY3Vyc29yIiwgdGhpcy5zdG9yZWRDdXJzb3IgKTsKCQkJdGhpcy5zdG9yZWRTdHlsZXNoZWV0LnJlbW92ZSgpOwoJCX0KCQlpZiAoIHRoaXMuX3N0b3JlZE9wYWNpdHkgKSB7CgkJCXRoaXMuaGVscGVyLmNzcyggIm9wYWNpdHkiLCB0aGlzLl9zdG9yZWRPcGFjaXR5ICk7CgkJfQoJCWlmICggdGhpcy5fc3RvcmVkWkluZGV4ICkgewoJCQl0aGlzLmhlbHBlci5jc3MoICJ6SW5kZXgiLCB0aGlzLl9zdG9yZWRaSW5kZXggPT09ICJhdXRvIiA\/ICIiIDogdGhpcy5fc3RvcmVkWkluZGV4ICk7CgkJfQoKCQl0aGlzLmRyYWdnaW5nID0gZmFsc2U7CgoJCWlmICggIW5vUHJvcGFnYXRpb24gKSB7CgkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVTdG9wIiwgZXZlbnQsIHRoaXMuX3VpSGFzaCgpICk7CgkJfQoKCQkvLyQodGhpcy5wbGFjZWhvbGRlclswXSkucmVtb3ZlKCk7IHdvdWxkIGhhdmUgYmVlbiB0aGUgalF1ZXJ5IHdheSAtIHVuZm9ydHVuYXRlbHksCgkJLy8gaXQgdW5iaW5kcyBBTEwgZXZlbnRzIGZyb20gdGhlIG9yaWdpbmFsIG5vZGUhCgkJdGhpcy5wbGFjZWhvbGRlclsgMCBdLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHRoaXMucGxhY2Vob2xkZXJbIDAgXSApOwoKCQlpZiAoICF0aGlzLmNhbmNlbEhlbHBlclJlbW92YWwgKSB7CgkJCWlmICggdGhpcy5oZWxwZXJbIDAgXSAhPT0gdGhpcy5jdXJyZW50SXRlbVsgMCBdICkgewoJCQkJdGhpcy5oZWxwZXIucmVtb3ZlKCk7CgkJCX0KCQkJdGhpcy5oZWxwZXIgPSBudWxsOwoJCX0KCgkJaWYgKCAhbm9Qcm9wYWdhdGlvbiApIHsKCQkJZm9yICggaSA9IDA7IGkgPCBkZWxheWVkVHJpZ2dlcnMubGVuZ3RoOyBpKysgKSB7CgoJCQkJLy8gVHJpZ2dlciBhbGwgZGVsYXllZCBldmVudHMKCQkJCWRlbGF5ZWRUcmlnZ2Vyc1sgaSBdLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgkJCX0KCQkJdGhpcy5fdHJpZ2dlciggInN0b3AiLCBldmVudCwgdGhpcy5fdWlIYXNoKCkgKTsKCQl9CgoJCXRoaXMuZnJvbU91dHNpZGUgPSBmYWxzZTsKCQlyZXR1cm4gIXRoaXMuY2FuY2VsSGVscGVyUmVtb3ZhbDsKCgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQlpZiAoICQuV2lkZ2V0LnByb3RvdHlwZS5fdHJpZ2dlci5hcHBseSggdGhpcywgYXJndW1lbnRzICkgPT09IGZhbHNlICkgewoJCQl0aGlzLmNhbmNlbCgpOwoJCX0KCX0sCgoJX3VpSGFzaDogZnVuY3Rpb24oIF9pbnN0ICkgewoJCXZhciBpbnN0ID0gX2luc3QgfHwgdGhpczsKCQlyZXR1cm4gewoJCQloZWxwZXI6IGluc3QuaGVscGVyLAoJCQlwbGFjZWhvbGRlcjogaW5zdC5wbGFjZWhvbGRlciB8fCAkKCBbXSApLAoJCQlwb3NpdGlvbjogaW5zdC5wb3NpdGlvbiwKCQkJb3JpZ2luYWxQb3NpdGlvbjogaW5zdC5vcmlnaW5hbFBvc2l0aW9uLAoJCQlvZmZzZXQ6IGluc3QucG9zaXRpb25BYnMsCgkJCWl0ZW06IGluc3QuY3VycmVudEl0ZW0sCgkJCXNlbmRlcjogX2luc3QgPyBfaW5zdC5lbGVtZW50IDogbnVsbAoJCX07Cgl9Cgp9ICk7CgoKLyohCiAqIGpRdWVyeSBVSSBTcGlubmVyIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogU3Bpbm5lcgovLz4+Z3JvdXA6IFdpZGdldHMKLy8+PmRlc2NyaXB0aW9uOiBEaXNwbGF5cyBidXR0b25zIHRvIGVhc2lseSBpbnB1dCBudW1iZXJzIHZpYSB0aGUga2V5Ym9hcmQgb3IgbW91c2UuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9zcGlubmVyLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vc3Bpbm5lci8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS9zcGlubmVyLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKZnVuY3Rpb24gc3Bpbm5lck1vZGlmZXIoIGZuICkgewoJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCXZhciBwcmV2aW91cyA9IHRoaXMuZWxlbWVudC52YWwoKTsKCQlmbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJCWlmICggcHJldmlvdXMgIT09IHRoaXMuZWxlbWVudC52YWwoKSApIHsKCQkJdGhpcy5fdHJpZ2dlciggImNoYW5nZSIgKTsKCQl9Cgl9Owp9CgokLndpZGdldCggInVpLnNwaW5uZXIiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCWRlZmF1bHRFbGVtZW50OiAiPGlucHV0PiIsCgl3aWRnZXRFdmVudFByZWZpeDogInNwaW4iLAoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJInVpLXNwaW5uZXIiOiAidWktY29ybmVyLWFsbCIsCgkJCSJ1aS1zcGlubmVyLWRvd24iOiAidWktY29ybmVyLWJyIiwKCQkJInVpLXNwaW5uZXItdXAiOiAidWktY29ybmVyLXRyIgoJCX0sCgkJY3VsdHVyZTogbnVsbCwKCQlpY29uczogewoJCQlkb3duOiAidWktaWNvbi10cmlhbmdsZS0xLXMiLAoJCQl1cDogInVpLWljb24tdHJpYW5nbGUtMS1uIgoJCX0sCgkJaW5jcmVtZW50YWw6IHRydWUsCgkJbWF4OiBudWxsLAoJCW1pbjogbnVsbCwKCQludW1iZXJGb3JtYXQ6IG51bGwsCgkJcGFnZTogMTAsCgkJc3RlcDogMSwKCgkJY2hhbmdlOiBudWxsLAoJCXNwaW46IG51bGwsCgkJc3RhcnQ6IG51bGwsCgkJc3RvcDogbnVsbAoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gaGFuZGxlIHN0cmluZyB2YWx1ZXMgdGhhdCBuZWVkIHRvIGJlIHBhcnNlZAoJCXRoaXMuX3NldE9wdGlvbiggIm1heCIsIHRoaXMub3B0aW9ucy5tYXggKTsKCQl0aGlzLl9zZXRPcHRpb24oICJtaW4iLCB0aGlzLm9wdGlvbnMubWluICk7CgkJdGhpcy5fc2V0T3B0aW9uKCAic3RlcCIsIHRoaXMub3B0aW9ucy5zdGVwICk7CgoJCS8vIE9ubHkgZm9ybWF0IGlmIHRoZXJlIGlzIGEgdmFsdWUsIHByZXZlbnRzIHRoZSBmaWVsZCBmcm9tIGJlaW5nIG1hcmtlZAoJCS8vIGFzIGludmFsaWQgaW4gRmlyZWZveCwgc2VlICM5NTczLgoJCWlmICggdGhpcy52YWx1ZSgpICE9PSAiIiApIHsKCgkJCS8vIEZvcm1hdCB0aGUgdmFsdWUsIGJ1dCBkb24ndCBjb25zdHJhaW4uCgkJCXRoaXMuX3ZhbHVlKCB0aGlzLmVsZW1lbnQudmFsKCksIHRydWUgKTsKCQl9CgoJCXRoaXMuX2RyYXcoKTsKCQl0aGlzLl9vbiggdGhpcy5fZXZlbnRzICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoKCQkvLyBUdXJuaW5nIG9mZiBhdXRvY29tcGxldGUgcHJldmVudHMgdGhlIGJyb3dzZXIgZnJvbSByZW1lbWJlcmluZyB0aGUKCQkvLyB2YWx1ZSB3aGVuIG5hdmlnYXRpbmcgdGhyb3VnaCBoaXN0b3J5LCBzbyB3ZSByZS1lbmFibGUgYXV0b2NvbXBsZXRlCgkJLy8gaWYgdGhlIHBhZ2UgaXMgdW5sb2FkZWQgYmVmb3JlIHRoZSB3aWRnZXQgaXMgZGVzdHJveWVkLiAjNzc5MAoJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQliZWZvcmV1bmxvYWQ6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJhdXRvY29tcGxldGUiICk7CgkJCX0KCQl9ICk7Cgl9LAoKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMuX3N1cGVyKCk7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgoJCSQuZWFjaCggWyAibWluIiwgIm1heCIsICJzdGVwIiBdLCBmdW5jdGlvbiggaSwgb3B0aW9uICkgewoJCQl2YXIgdmFsdWUgPSBlbGVtZW50LmF0dHIoIG9wdGlvbiApOwoJCQlpZiAoIHZhbHVlICE9IG51bGwgJiYgdmFsdWUubGVuZ3RoICkgewoJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJfQoJCX0gKTsKCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCV9ldmVudHM6IHsKCQlrZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggdGhpcy5fc3RhcnQoIGV2ZW50ICkgJiYgdGhpcy5fa2V5ZG93biggZXZlbnQgKSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9LAoJCWtleXVwOiAiX3N0b3AiLAoJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5wcmV2aW91cyA9IHRoaXMuZWxlbWVudC52YWwoKTsKCQl9LAoJCWJsdXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCB0aGlzLmNhbmNlbEJsdXIgKSB7CgkJCQlkZWxldGUgdGhpcy5jYW5jZWxCbHVyOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0aGlzLl9zdG9wKCk7CgkJCXRoaXMuX3JlZnJlc2goKTsKCQkJaWYgKCB0aGlzLnByZXZpb3VzICE9PSB0aGlzLmVsZW1lbnQudmFsKCkgKSB7CgkJCQl0aGlzLl90cmlnZ2VyKCAiY2hhbmdlIiwgZXZlbnQgKTsKCQkJfQoJCX0sCgkJbW91c2V3aGVlbDogZnVuY3Rpb24oIGV2ZW50LCBkZWx0YSApIHsKCQkJaWYgKCAhZGVsdGEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAhdGhpcy5zcGlubmluZyAmJiAhdGhpcy5fc3RhcnQoIGV2ZW50ICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXRoaXMuX3NwaW4oICggZGVsdGEgPiAwID8gMSA6IC0xICkgKiB0aGlzLm9wdGlvbnMuc3RlcCwgZXZlbnQgKTsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLm1vdXNld2hlZWxUaW1lciApOwoJCQl0aGlzLm1vdXNld2hlZWxUaW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5zcGlubmluZyApIHsKCQkJCQl0aGlzLl9zdG9wKCBldmVudCApOwoJCQkJfQoJCQl9LCAxMDAgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9LAoJCSJtb3VzZWRvd24gLnVpLXNwaW5uZXItYnV0dG9uIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgcHJldmlvdXM7CgoJCQkvLyBXZSBuZXZlciB3YW50IHRoZSBidXR0b25zIHRvIGhhdmUgZm9jdXM7IHdoZW5ldmVyIHRoZSB1c2VyIGlzCgkJCS8vIGludGVyYWN0aW5nIHdpdGggdGhlIHNwaW5uZXIsIHRoZSBmb2N1cyBzaG91bGQgYmUgb24gdGhlIGlucHV0LgoJCQkvLyBJZiB0aGUgaW5wdXQgaXMgZm9jdXNlZCB0aGVuIHRoaXMucHJldmlvdXMgaXMgcHJvcGVybHkgc2V0IGZyb20KCQkJLy8gd2hlbiB0aGUgaW5wdXQgZmlyc3QgcmVjZWl2ZWQgZm9jdXMuIElmIHRoZSBpbnB1dCBpcyBub3QgZm9jdXNlZAoJCQkvLyB0aGVuIHdlIG5lZWQgdG8gc2V0IHRoaXMucHJldmlvdXMgYmFzZWQgb24gdGhlIHZhbHVlIGJlZm9yZSBzcGlubmluZy4KCQkJcHJldmlvdXMgPSB0aGlzLmVsZW1lbnRbIDAgXSA9PT0gJC51aS5zYWZlQWN0aXZlRWxlbWVudCggdGhpcy5kb2N1bWVudFsgMCBdICkgPwoJCQkJdGhpcy5wcmV2aW91cyA6IHRoaXMuZWxlbWVudC52YWwoKTsKCQkJZnVuY3Rpb24gY2hlY2tGb2N1cygpIHsKCQkJCXZhciBpc0FjdGl2ZSA9IHRoaXMuZWxlbWVudFsgMCBdID09PSAkLnVpLnNhZmVBY3RpdmVFbGVtZW50KCB0aGlzLmRvY3VtZW50WyAwIF0gKTsKCQkJCWlmICggIWlzQWN0aXZlICkgewoJCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiZm9jdXMiICk7CgkJCQkJdGhpcy5wcmV2aW91cyA9IHByZXZpb3VzOwoKCQkJCQkvLyBzdXBwb3J0OiBJRQoJCQkJCS8vIElFIHNldHMgZm9jdXMgYXN5bmNocm9ub3VzbHksIHNvIHdlIG5lZWQgdG8gY2hlY2sgaWYgZm9jdXMKCQkJCQkvLyBtb3ZlZCBvZmYgb2YgdGhlIGlucHV0IGJlY2F1c2UgdGhlIHVzZXIgY2xpY2tlZCBvbiB0aGUgYnV0dG9uLgoJCQkJCXRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCQkJdGhpcy5wcmV2aW91cyA9IHByZXZpb3VzOwoJCQkJCX0gKTsKCQkJCX0KCQkJfQoKCQkJLy8gRW5zdXJlIGZvY3VzIGlzIG9uIChvciBzdGF5cyBvbikgdGhlIHRleHQgZmllbGQKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJY2hlY2tGb2N1cy5jYWxsKCB0aGlzICk7CgoJCQkvLyBTdXBwb3J0OiBJRQoJCQkvLyBJRSBkb2Vzbid0IHByZXZlbnQgbW92aW5nIGZvY3VzIGV2ZW4gd2l0aCBldmVudC5wcmV2ZW50RGVmYXVsdCgpCgkJCS8vIHNvIHdlIHNldCBhIGZsYWcgdG8ga25vdyB3aGVuIHdlIHNob3VsZCBpZ25vcmUgdGhlIGJsdXIgZXZlbnQKCQkJLy8gYW5kIGNoZWNrIChhZ2FpbikgaWYgZm9jdXMgbW92ZWQgb2ZmIG9mIHRoZSBpbnB1dC4KCQkJdGhpcy5jYW5jZWxCbHVyID0gdHJ1ZTsKCQkJdGhpcy5fZGVsYXkoIGZ1bmN0aW9uKCkgewoJCQkJZGVsZXRlIHRoaXMuY2FuY2VsQmx1cjsKCQkJCWNoZWNrRm9jdXMuY2FsbCggdGhpcyApOwoJCQl9ICk7CgoJCQlpZiAoIHRoaXMuX3N0YXJ0KCBldmVudCApID09PSBmYWxzZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdGhpcy5fcmVwZWF0KCBudWxsLCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkKCQkJCS5oYXNDbGFzcyggInVpLXNwaW5uZXItdXAiICkgPyAxIDogLTEsIGV2ZW50ICk7CgkJfSwKCQkibW91c2V1cCAudWktc3Bpbm5lci1idXR0b24iOiAiX3N0b3AiLAoJCSJtb3VzZWVudGVyIC51aS1zcGlubmVyLWJ1dHRvbiI6IGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCS8vIGJ1dHRvbiB3aWxsIGFkZCB1aS1zdGF0ZS1hY3RpdmUgaWYgbW91c2Ugd2FzIGRvd24gd2hpbGUgbW91c2VsZWF2ZSBhbmQga2VwdCBkb3duCgkJCWlmICggISQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5oYXNDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCB0aGlzLl9zdGFydCggZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJdGhpcy5fcmVwZWF0KCBudWxsLCAkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkKCQkJCS5oYXNDbGFzcyggInVpLXNwaW5uZXItdXAiICkgPyAxIDogLTEsIGV2ZW50ICk7CgkJfSwKCgkJLy8gVE9ETzogZG8gd2UgcmVhbGx5IHdhbnQgdG8gY29uc2lkZXIgdGhpcyBhIHN0b3A\/CgkJLy8gc2hvdWxkbid0IHdlIGp1c3Qgc3RvcCB0aGUgcmVwZWF0ZXIgYW5kIHdhaXQgdW50aWwgbW91c2V1cCBiZWZvcmUKCQkvLyB3ZSB0cmlnZ2VyIHRoZSBzdG9wIGV2ZW50PwoJCSJtb3VzZWxlYXZlIC51aS1zcGlubmVyLWJ1dHRvbiI6ICJfc3RvcCIKCX0sCgoJLy8gU3VwcG9ydCBtb2JpbGUgZW5oYW5jZWQgb3B0aW9uIGFuZCBtYWtlIGJhY2tjb21wYXQgbW9yZSBzYW5lCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy51aVNwaW5uZXIgPSB0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJhdXRvY29tcGxldGUiLCAib2ZmIiApCgkJCS53cmFwKCAiPHNwYW4+IiApCgkJCS5wYXJlbnQoKQoKCQkJCS8vIEFkZCBidXR0b25zCgkJCQkuYXBwZW5kKAoJCQkJCSI8YT48L2E+PGE+PC9hPiIKCQkJCSk7Cgl9LAoKCV9kcmF3OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9lbmhhbmNlKCk7CgoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnVpU3Bpbm5lciwgInVpLXNwaW5uZXIiLCAidWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IiApOwoJCXRoaXMuX2FkZENsYXNzKCAidWktc3Bpbm5lci1pbnB1dCIgKTsKCgkJdGhpcy5lbGVtZW50LmF0dHIoICJyb2xlIiwgInNwaW5idXR0b24iICk7CgoJCS8vIEJ1dHRvbiBiaW5kaW5ncwoJCXRoaXMuYnV0dG9ucyA9IHRoaXMudWlTcGlubmVyLmNoaWxkcmVuKCAiYSIgKQoJCQkuYXR0ciggInRhYkluZGV4IiwgLTEgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgdHJ1ZSApCgkJCS5idXR0b24oIHsKCQkJCWNsYXNzZXM6IHsKCQkJCQkidWktYnV0dG9uIjogIiIKCQkJCX0KCQkJfSApOwoKCQkvLyBUT0RPOiBSaWdodCBub3cgYnV0dG9uIGRvZXMgbm90IHN1cHBvcnQgY2xhc3NlcyB0aGlzIGlzIGFscmVhZHkgdXBkYXRlZCBpbiBidXR0b24gUFIKCQl0aGlzLl9yZW1vdmVDbGFzcyggdGhpcy5idXR0b25zLCAidWktY29ybmVyLWFsbCIgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMuYnV0dG9ucy5maXJzdCgpLCAidWktc3Bpbm5lci1idXR0b24gdWktc3Bpbm5lci11cCIgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5idXR0b25zLmxhc3QoKSwgInVpLXNwaW5uZXItYnV0dG9uIHVpLXNwaW5uZXItZG93biIgKTsKCQl0aGlzLmJ1dHRvbnMuZmlyc3QoKS5idXR0b24oIHsKCQkJImljb24iOiB0aGlzLm9wdGlvbnMuaWNvbnMudXAsCgkJCSJzaG93TGFiZWwiOiBmYWxzZQoJCX0gKTsKCQl0aGlzLmJ1dHRvbnMubGFzdCgpLmJ1dHRvbiggewoJCQkiaWNvbiI6IHRoaXMub3B0aW9ucy5pY29ucy5kb3duLAoJCQkic2hvd0xhYmVsIjogZmFsc2UKCQl9ICk7CgoJCS8vIElFIDYgZG9lc24ndCB1bmRlcnN0YW5kIGhlaWdodDogNTAlIGZvciB0aGUgYnV0dG9ucwoJCS8vIHVubGVzcyB0aGUgd3JhcHBlciBoYXMgYW4gZXhwbGljaXQgaGVpZ2h0CgkJaWYgKCB0aGlzLmJ1dHRvbnMuaGVpZ2h0KCkgPiBNYXRoLmNlaWwoIHRoaXMudWlTcGlubmVyLmhlaWdodCgpICogMC41ICkgJiYKCQkJCXRoaXMudWlTcGlubmVyLmhlaWdodCgpID4gMCApIHsKCQkJdGhpcy51aVNwaW5uZXIuaGVpZ2h0KCB0aGlzLnVpU3Bpbm5lci5oZWlnaHQoKSApOwoJCX0KCX0sCgoJX2tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJa2V5Q29kZSA9ICQudWkua2V5Q29kZTsKCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQljYXNlIGtleUNvZGUuVVA6CgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgMSwgZXZlbnQgKTsKCQkJcmV0dXJuIHRydWU7CgkJY2FzZSBrZXlDb2RlLkRPV046CgkJCXRoaXMuX3JlcGVhdCggbnVsbCwgLTEsIGV2ZW50ICk7CgkJCXJldHVybiB0cnVlOwoJCWNhc2Uga2V5Q29kZS5QQUdFX1VQOgoJCQl0aGlzLl9yZXBlYXQoIG51bGwsIG9wdGlvbnMucGFnZSwgZXZlbnQgKTsKCQkJcmV0dXJuIHRydWU7CgkJY2FzZSBrZXlDb2RlLlBBR0VfRE9XTjoKCQkJdGhpcy5fcmVwZWF0KCBudWxsLCAtb3B0aW9ucy5wYWdlLCBldmVudCApOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3N0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCAhdGhpcy5zcGlubmluZyAmJiB0aGlzLl90cmlnZ2VyKCAic3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCAhdGhpcy5jb3VudGVyICkgewoJCQl0aGlzLmNvdW50ZXIgPSAxOwoJCX0KCQl0aGlzLnNwaW5uaW5nID0gdHJ1ZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJX3JlcGVhdDogZnVuY3Rpb24oIGksIHN0ZXBzLCBldmVudCApIHsKCQlpID0gaSB8fCA1MDA7CgoJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOwoJCXRoaXMudGltZXIgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3JlcGVhdCggNDAsIHN0ZXBzLCBldmVudCApOwoJCX0sIGkgKTsKCgkJdGhpcy5fc3Bpbiggc3RlcHMgKiB0aGlzLm9wdGlvbnMuc3RlcCwgZXZlbnQgKTsKCX0sCgoJX3NwaW46IGZ1bmN0aW9uKCBzdGVwLCBldmVudCApIHsKCQl2YXIgdmFsdWUgPSB0aGlzLnZhbHVlKCkgfHwgMDsKCgkJaWYgKCAhdGhpcy5jb3VudGVyICkgewoJCQl0aGlzLmNvdW50ZXIgPSAxOwoJCX0KCgkJdmFsdWUgPSB0aGlzLl9hZGp1c3RWYWx1ZSggdmFsdWUgKyBzdGVwICogdGhpcy5faW5jcmVtZW50KCB0aGlzLmNvdW50ZXIgKSApOwoKCQlpZiAoICF0aGlzLnNwaW5uaW5nIHx8IHRoaXMuX3RyaWdnZXIoICJzcGluIiwgZXZlbnQsIHsgdmFsdWU6IHZhbHVlIH0gKSAhPT0gZmFsc2UgKSB7CgkJCXRoaXMuX3ZhbHVlKCB2YWx1ZSApOwoJCQl0aGlzLmNvdW50ZXIrKzsKCQl9Cgl9LAoKCV9pbmNyZW1lbnQ6IGZ1bmN0aW9uKCBpICkgewoJCXZhciBpbmNyZW1lbnRhbCA9IHRoaXMub3B0aW9ucy5pbmNyZW1lbnRhbDsKCgkJaWYgKCBpbmNyZW1lbnRhbCApIHsKCQkJcmV0dXJuICQuaXNGdW5jdGlvbiggaW5jcmVtZW50YWwgKSA\/CgkJCQlpbmNyZW1lbnRhbCggaSApIDoKCQkJCU1hdGguZmxvb3IoIGkgKiBpICogaSAvIDUwMDAwIC0gaSAqIGkgLyA1MDAgKyAxNyAqIGkgLyAyMDAgKyAxICk7CgkJfQoKCQlyZXR1cm4gMTsKCX0sCgoJX3ByZWNpc2lvbjogZnVuY3Rpb24oKSB7CgkJdmFyIHByZWNpc2lvbiA9IHRoaXMuX3ByZWNpc2lvbk9mKCB0aGlzLm9wdGlvbnMuc3RlcCApOwoJCWlmICggdGhpcy5vcHRpb25zLm1pbiAhPT0gbnVsbCApIHsKCQkJcHJlY2lzaW9uID0gTWF0aC5tYXgoIHByZWNpc2lvbiwgdGhpcy5fcHJlY2lzaW9uT2YoIHRoaXMub3B0aW9ucy5taW4gKSApOwoJCX0KCQlyZXR1cm4gcHJlY2lzaW9uOwoJfSwKCglfcHJlY2lzaW9uT2Y6IGZ1bmN0aW9uKCBudW0gKSB7CgkJdmFyIHN0ciA9IG51bS50b1N0cmluZygpLAoJCQlkZWNpbWFsID0gc3RyLmluZGV4T2YoICIuIiApOwoJCXJldHVybiBkZWNpbWFsID09PSAtMSA\/IDAgOiBzdHIubGVuZ3RoIC0gZGVjaW1hbCAtIDE7Cgl9LAoKCV9hZGp1c3RWYWx1ZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBiYXNlLCBhYm92ZU1pbiwKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJLy8gTWFrZSBzdXJlIHdlJ3JlIGF0IGEgdmFsaWQgc3RlcAoJCS8vIC0gZmluZCBvdXQgd2hlcmUgd2UgYXJlIHJlbGF0aXZlIHRvIHRoZSBiYXNlIChtaW4gb3IgMCkKCQliYXNlID0gb3B0aW9ucy5taW4gIT09IG51bGwgPyBvcHRpb25zLm1pbiA6IDA7CgkJYWJvdmVNaW4gPSB2YWx1ZSAtIGJhc2U7CgoJCS8vIC0gcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCWFib3ZlTWluID0gTWF0aC5yb3VuZCggYWJvdmVNaW4gLyBvcHRpb25zLnN0ZXAgKSAqIG9wdGlvbnMuc3RlcDsKCgkJLy8gLSByb3VuZGluZyBpcyBiYXNlZCBvbiAwLCBzbyBhZGp1c3QgYmFjayB0byBvdXIgYmFzZQoJCXZhbHVlID0gYmFzZSArIGFib3ZlTWluOwoKCQkvLyBGaXggcHJlY2lzaW9uIGZyb20gYmFkIEpTIGZsb2F0aW5nIHBvaW50IG1hdGgKCQl2YWx1ZSA9IHBhcnNlRmxvYXQoIHZhbHVlLnRvRml4ZWQoIHRoaXMuX3ByZWNpc2lvbigpICkgKTsKCgkJLy8gQ2xhbXAgdGhlIHZhbHVlCgkJaWYgKCBvcHRpb25zLm1heCAhPT0gbnVsbCAmJiB2YWx1ZSA+IG9wdGlvbnMubWF4ICkgewoJCQlyZXR1cm4gb3B0aW9ucy5tYXg7CgkJfQoJCWlmICggb3B0aW9ucy5taW4gIT09IG51bGwgJiYgdmFsdWUgPCBvcHRpb25zLm1pbiApIHsKCQkJcmV0dXJuIG9wdGlvbnMubWluOwoJCX0KCgkJcmV0dXJuIHZhbHVlOwoJfSwKCglfc3RvcDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIXRoaXMuc3Bpbm5pbmcgKSB7CgkJCXJldHVybjsKCQl9CgoJCWNsZWFyVGltZW91dCggdGhpcy50aW1lciApOwoJCWNsZWFyVGltZW91dCggdGhpcy5tb3VzZXdoZWVsVGltZXIgKTsKCQl0aGlzLmNvdW50ZXIgPSAwOwoJCXRoaXMuc3Bpbm5pbmcgPSBmYWxzZTsKCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIsIGV2ZW50ICk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBwcmV2VmFsdWUsIGZpcnN0LCBsYXN0OwoKCQlpZiAoIGtleSA9PT0gImN1bHR1cmUiIHx8IGtleSA9PT0gIm51bWJlckZvcm1hdCIgKSB7CgkJCXByZXZWYWx1ZSA9IHRoaXMuX3BhcnNlKCB0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl0aGlzLmVsZW1lbnQudmFsKCB0aGlzLl9mb3JtYXQoIHByZXZWYWx1ZSApICk7CgkJCXJldHVybjsKCQl9CgoJCWlmICgga2V5ID09PSAibWF4IiB8fCBrZXkgPT09ICJtaW4iIHx8IGtleSA9PT0gInN0ZXAiICkgewoJCQlpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgKSB7CgkJCQl2YWx1ZSA9IHRoaXMuX3BhcnNlKCB2YWx1ZSApOwoJCQl9CgkJfQoJCWlmICgga2V5ID09PSAiaWNvbnMiICkgewoJCQlmaXJzdCA9IHRoaXMuYnV0dG9ucy5maXJzdCgpLmZpbmQoICIudWktaWNvbiIgKTsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGZpcnN0LCBudWxsLCB0aGlzLm9wdGlvbnMuaWNvbnMudXAgKTsKCQkJdGhpcy5fYWRkQ2xhc3MoIGZpcnN0LCBudWxsLCB2YWx1ZS51cCApOwoJCQlsYXN0ID0gdGhpcy5idXR0b25zLmxhc3QoKS5maW5kKCAiLnVpLWljb24iICk7CgkJCXRoaXMuX3JlbW92ZUNsYXNzKCBsYXN0LCBudWxsLCB0aGlzLm9wdGlvbnMuaWNvbnMuZG93biApOwoJCQl0aGlzLl9hZGRDbGFzcyggbGFzdCwgbnVsbCwgdmFsdWUuZG93biApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCX0sCgoJX3NldE9wdGlvbkRpc2FibGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5fc3VwZXIoIHZhbHVlICk7CgoJCXRoaXMuX3RvZ2dsZUNsYXNzKCB0aGlzLnVpU3Bpbm5lciwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCAhIXZhbHVlICk7CgkJdGhpcy5idXR0b25zLmJ1dHRvbiggdmFsdWUgPyAiZGlzYWJsZSIgOiAiZW5hYmxlIiApOwoJfSwKCglfc2V0T3B0aW9uczogc3Bpbm5lck1vZGlmZXIoIGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9ICksCgoJX3BhcnNlOiBmdW5jdGlvbiggdmFsICkgewoJCWlmICggdHlwZW9mIHZhbCA9PT0gInN0cmluZyIgJiYgdmFsICE9PSAiIiApIHsKCQkJdmFsID0gd2luZG93Lkdsb2JhbGl6ZSAmJiB0aGlzLm9wdGlvbnMubnVtYmVyRm9ybWF0ID8KCQkJCUdsb2JhbGl6ZS5wYXJzZUZsb2F0KCB2YWwsIDEwLCB0aGlzLm9wdGlvbnMuY3VsdHVyZSApIDogK3ZhbDsKCQl9CgkJcmV0dXJuIHZhbCA9PT0gIiIgfHwgaXNOYU4oIHZhbCApID8gbnVsbCA6IHZhbDsKCX0sCgoJX2Zvcm1hdDogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdmFsdWUgPT09ICIiICkgewoJCQlyZXR1cm4gIiI7CgkJfQoJCXJldHVybiB3aW5kb3cuR2xvYmFsaXplICYmIHRoaXMub3B0aW9ucy5udW1iZXJGb3JtYXQgPwoJCQlHbG9iYWxpemUuZm9ybWF0KCB2YWx1ZSwgdGhpcy5vcHRpb25zLm51bWJlckZvcm1hdCwgdGhpcy5vcHRpb25zLmN1bHR1cmUgKSA6CgkJCXZhbHVlOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmF0dHIoIHsKCQkJImFyaWEtdmFsdWVtaW4iOiB0aGlzLm9wdGlvbnMubWluLAoJCQkiYXJpYS12YWx1ZW1heCI6IHRoaXMub3B0aW9ucy5tYXgsCgoJCQkvLyBUT0RPOiB3aGF0IHNob3VsZCB3ZSBkbyB3aXRoIHZhbHVlcyB0aGF0IGNhbid0IGJlIHBhcnNlZD8KCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl9wYXJzZSggdGhpcy5lbGVtZW50LnZhbCgpICkKCQl9ICk7Cgl9LAoKCWlzVmFsaWQ6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZSA9IHRoaXMudmFsdWUoKTsKCgkJLy8gTnVsbCBpcyBpbnZhbGlkCgkJaWYgKCB2YWx1ZSA9PT0gbnVsbCApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gSWYgdmFsdWUgZ2V0cyBhZGp1c3RlZCwgaXQncyBpbnZhbGlkCgkJcmV0dXJuIHZhbHVlID09PSB0aGlzLl9hZGp1c3RWYWx1ZSggdmFsdWUgKTsKCX0sCgoJLy8gVXBkYXRlIHRoZSB2YWx1ZSB3aXRob3V0IHRyaWdnZXJpbmcgY2hhbmdlCglfdmFsdWU6IGZ1bmN0aW9uKCB2YWx1ZSwgYWxsb3dBbnkgKSB7CgkJdmFyIHBhcnNlZDsKCQlpZiAoIHZhbHVlICE9PSAiIiApIHsKCQkJcGFyc2VkID0gdGhpcy5fcGFyc2UoIHZhbHVlICk7CgkJCWlmICggcGFyc2VkICE9PSBudWxsICkgewoJCQkJaWYgKCAhYWxsb3dBbnkgKSB7CgkJCQkJcGFyc2VkID0gdGhpcy5fYWRqdXN0VmFsdWUoIHBhcnNlZCApOwoJCQkJfQoJCQkJdmFsdWUgPSB0aGlzLl9mb3JtYXQoIHBhcnNlZCApOwoJCQl9CgkJfQoJCXRoaXMuZWxlbWVudC52YWwoIHZhbHVlICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50CgkJCS5wcm9wKCAiZGlzYWJsZWQiLCBmYWxzZSApCgkJCS5yZW1vdmVBdHRyKCAiYXV0b2NvbXBsZXRlIHJvbGUgYXJpYS12YWx1ZW1pbiBhcmlhLXZhbHVlbWF4IGFyaWEtdmFsdWVub3ciICk7CgoJCXRoaXMudWlTcGlubmVyLnJlcGxhY2VXaXRoKCB0aGlzLmVsZW1lbnQgKTsKCX0sCgoJc3RlcFVwOiBzcGlubmVyTW9kaWZlciggZnVuY3Rpb24oIHN0ZXBzICkgewoJCXRoaXMuX3N0ZXBVcCggc3RlcHMgKTsKCX0gKSwKCV9zdGVwVXA6IGZ1bmN0aW9uKCBzdGVwcyApIHsKCQlpZiAoIHRoaXMuX3N0YXJ0KCkgKSB7CgkJCXRoaXMuX3NwaW4oICggc3RlcHMgfHwgMSApICogdGhpcy5vcHRpb25zLnN0ZXAgKTsKCQkJdGhpcy5fc3RvcCgpOwoJCX0KCX0sCgoJc3RlcERvd246IHNwaW5uZXJNb2RpZmVyKCBmdW5jdGlvbiggc3RlcHMgKSB7CgkJdGhpcy5fc3RlcERvd24oIHN0ZXBzICk7Cgl9ICksCglfc3RlcERvd246IGZ1bmN0aW9uKCBzdGVwcyApIHsKCQlpZiAoIHRoaXMuX3N0YXJ0KCkgKSB7CgkJCXRoaXMuX3NwaW4oICggc3RlcHMgfHwgMSApICogLXRoaXMub3B0aW9ucy5zdGVwICk7CgkJCXRoaXMuX3N0b3AoKTsKCQl9Cgl9LAoKCXBhZ2VVcDogc3Bpbm5lck1vZGlmZXIoIGZ1bmN0aW9uKCBwYWdlcyApIHsKCQl0aGlzLl9zdGVwVXAoICggcGFnZXMgfHwgMSApICogdGhpcy5vcHRpb25zLnBhZ2UgKTsKCX0gKSwKCglwYWdlRG93bjogc3Bpbm5lck1vZGlmZXIoIGZ1bmN0aW9uKCBwYWdlcyApIHsKCQl0aGlzLl9zdGVwRG93biggKCBwYWdlcyB8fCAxICkgKiB0aGlzLm9wdGlvbnMucGFnZSApOwoJfSApLAoKCXZhbHVlOiBmdW5jdGlvbiggbmV3VmFsICkgewoJCWlmICggIWFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXJldHVybiB0aGlzLl9wYXJzZSggdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfQoJCXNwaW5uZXJNb2RpZmVyKCB0aGlzLl92YWx1ZSApLmNhbGwoIHRoaXMsIG5ld1ZhbCApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnVpU3Bpbm5lcjsKCX0KfSApOwoKLy8gREVQUkVDQVRFRAovLyBUT0RPOiBzd2l0Y2ggcmV0dXJuIGJhY2sgdG8gd2lkZ2V0IGRlY2xhcmF0aW9uIGF0IHRvcCBvZiBmaWxlIHdoZW4gdGhpcyBpcyByZW1vdmVkCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgewoKCS8vIEJhY2tjb21wYXQgZm9yIHNwaW5uZXIgaHRtbCBleHRlbnNpb24gcG9pbnRzCgkkLndpZGdldCggInVpLnNwaW5uZXIiLCAkLnVpLnNwaW5uZXIsIHsKCQlfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMudWlTcGlubmVyID0gdGhpcy5lbGVtZW50CgkJCQkuYXR0ciggImF1dG9jb21wbGV0ZSIsICJvZmYiICkKCQkJCS53cmFwKCB0aGlzLl91aVNwaW5uZXJIdG1sKCkgKQoJCQkJLnBhcmVudCgpCgoJCQkJCS8vIEFkZCBidXR0b25zCgkJCQkJLmFwcGVuZCggdGhpcy5fYnV0dG9uSHRtbCgpICk7CgkJfSwKCQlfdWlTcGlubmVySHRtbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiPHNwYW4+IjsKCQl9LAoKCQlfYnV0dG9uSHRtbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAiPGE+PC9hPjxhPjwvYT4iOwoJCX0KCX0gKTsKfQoKdmFyIHdpZGdldHNTcGlubmVyID0gJC51aS5zcGlubmVyOwoKCi8qIQogKiBqUXVlcnkgVUkgVGFicyAxLjEyLjEKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICovCgovLz4+bGFiZWw6IFRhYnMKLy8+Pmdyb3VwOiBXaWRnZXRzCi8vPj5kZXNjcmlwdGlvbjogVHJhbnNmb3JtcyBhIHNldCBvZiBjb250YWluZXIgZWxlbWVudHMgaW50byBhIHRhYiBzdHJ1Y3R1cmUuCi8vPj5kb2NzOiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS90YWJzLwovLz4+ZGVtb3M6IGh0dHA6Ly9qcXVlcnl1aS5jb20vdGFicy8KLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL2NvcmUuY3NzCi8vPj5jc3Muc3RydWN0dXJlOiAuLi8uLi90aGVtZXMvYmFzZS90YWJzLmNzcwovLz4+Y3NzLnRoZW1lOiAuLi8uLi90aGVtZXMvYmFzZS90aGVtZS5jc3MKCgoKJC53aWRnZXQoICJ1aS50YWJzIiwgewoJdmVyc2lvbjogIjEuMTIuMSIsCglkZWxheTogMzAwLAoJb3B0aW9uczogewoJCWFjdGl2ZTogbnVsbCwKCQljbGFzc2VzOiB7CgkJCSJ1aS10YWJzIjogInVpLWNvcm5lci1hbGwiLAoJCQkidWktdGFicy1uYXYiOiAidWktY29ybmVyLWFsbCIsCgkJCSJ1aS10YWJzLXBhbmVsIjogInVpLWNvcm5lci1ib3R0b20iLAoJCQkidWktdGFicy10YWIiOiAidWktY29ybmVyLXRvcCIKCQl9LAoJCWNvbGxhcHNpYmxlOiBmYWxzZSwKCQlldmVudDogImNsaWNrIiwKCQloZWlnaHRTdHlsZTogImNvbnRlbnQiLAoJCWhpZGU6IG51bGwsCgkJc2hvdzogbnVsbCwKCgkJLy8gQ2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlQWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlTG9hZDogbnVsbCwKCQlsb2FkOiBudWxsCgl9LAoKCV9pc0xvY2FsOiAoIGZ1bmN0aW9uKCkgewoJCXZhciByaGFzaCA9IC8jLiokLzsKCgkJcmV0dXJuIGZ1bmN0aW9uKCBhbmNob3IgKSB7CgkJCXZhciBhbmNob3JVcmwsIGxvY2F0aW9uVXJsOwoKCQkJYW5jaG9yVXJsID0gYW5jaG9yLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICk7CgkJCWxvY2F0aW9uVXJsID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKTsKCgkJCS8vIERlY29kaW5nIG1heSB0aHJvdyBhbiBlcnJvciBpZiB0aGUgVVJMIGlzbid0IFVURi04ICgjOTUxOCkKCQkJdHJ5IHsKCQkJCWFuY2hvclVybCA9IGRlY29kZVVSSUNvbXBvbmVudCggYW5jaG9yVXJsICk7CgkJCX0gY2F0Y2ggKCBlcnJvciApIHt9CgkJCXRyeSB7CgkJCQlsb2NhdGlvblVybCA9IGRlY29kZVVSSUNvbXBvbmVudCggbG9jYXRpb25VcmwgKTsKCQkJfSBjYXRjaCAoIGVycm9yICkge30KCgkJCXJldHVybiBhbmNob3IuaGFzaC5sZW5ndGggPiAxICYmIGFuY2hvclVybCA9PT0gbG9jYXRpb25Vcmw7CgkJfTsKCX0gKSgpLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgoJCXRoaXMuX2FkZENsYXNzKCAidWktdGFicyIsICJ1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQiICk7CgkJdGhpcy5fdG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgbnVsbCwgb3B0aW9ucy5jb2xsYXBzaWJsZSApOwoKCQl0aGlzLl9wcm9jZXNzVGFicygpOwoJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy5faW5pdGlhbEFjdGl2ZSgpOwoKCQkvLyBUYWtlIGRpc2FibGluZyB0YWJzIHZpYSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gaW50byBhY2NvdW50IGFuZCB1cGRhdGUgb3B0aW9uIHByb3Blcmx5LgoJCWlmICggJC5pc0FycmF5KCBvcHRpb25zLmRpc2FibGVkICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLnVuaXF1ZSggb3B0aW9ucy5kaXNhYmxlZC5jb25jYXQoCgkJCQkkLm1hcCggdGhpcy50YWJzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIGxpICkgewoJCQkJCXJldHVybiB0aGF0LnRhYnMuaW5kZXgoIGxpICk7CgkJCQl9ICkKCQkJKSApLnNvcnQoKTsKCQl9CgoJCS8vIENoZWNrIGZvciBsZW5ndGggYXZvaWRzIGVycm9yIHdoZW4gaW5pdGlhbGl6aW5nIGVtcHR5IGxpc3QKCQlpZiAoIHRoaXMub3B0aW9ucy5hY3RpdmUgIT09IGZhbHNlICYmIHRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCXRoaXMuYWN0aXZlID0gdGhpcy5fZmluZEFjdGl2ZSggb3B0aW9ucy5hY3RpdmUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2goKTsKCgkJaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggKSB7CgkJCXRoaXMubG9hZCggb3B0aW9ucy5hY3RpdmUgKTsKCQl9Cgl9LAoKCV9pbml0aWFsQWN0aXZlOiBmdW5jdGlvbigpIHsKCQl2YXIgYWN0aXZlID0gdGhpcy5vcHRpb25zLmFjdGl2ZSwKCQkJY29sbGFwc2libGUgPSB0aGlzLm9wdGlvbnMuY29sbGFwc2libGUsCgkJCWxvY2F0aW9uSGFzaCA9IGxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKCAxICk7CgoJCWlmICggYWN0aXZlID09PSBudWxsICkgewoKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKCBmdW5jdGlvbiggaSwgdGFiICkgewoJCQkJCWlmICggJCggdGFiICkuYXR0ciggImFyaWEtY29udHJvbHMiICkgPT09IGxvY2F0aW9uSGFzaCApIHsKCQkJCQkJYWN0aXZlID0gaTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoKCQkJLy8gQ2hlY2sgZm9yIGEgdGFiIG1hcmtlZCBhY3RpdmUgdmlhIGEgY2xhc3MKCQkJaWYgKCBhY3RpdmUgPT09IG51bGwgKSB7CgkJCQlhY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMudGFicy5maWx0ZXIoICIudWktdGFicy1hY3RpdmUiICkgKTsKCQkJfQoKCQkJLy8gTm8gYWN0aXZlIHRhYiwgc2V0IHRvIGZhbHNlCgkJCWlmICggYWN0aXZlID09PSBudWxsIHx8IGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSB0aGlzLnRhYnMubGVuZ3RoID8gMCA6IGZhbHNlOwoJCQl9CgkJfQoKCQkvLyBIYW5kbGUgbnVtYmVyczogbmVnYXRpdmUsIG91dCBvZiByYW5nZQoJCWlmICggYWN0aXZlICE9PSBmYWxzZSApIHsKCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZXEoIGFjdGl2ZSApICk7CgkJCWlmICggYWN0aXZlID09PSAtMSApIHsKCQkJCWFjdGl2ZSA9IGNvbGxhcHNpYmxlID8gZmFsc2UgOiAwOwoJCQl9CgkJfQoKCQkvLyBEb24ndCBhbGxvdyBjb2xsYXBzaWJsZTogZmFsc2UgYW5kIGFjdGl2ZTogZmFsc2UKCQlpZiAoICFjb2xsYXBzaWJsZSAmJiBhY3RpdmUgPT09IGZhbHNlICYmIHRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IDA7CgkJfQoKCQlyZXR1cm4gYWN0aXZlOwoJfSwKCglfZ2V0Q3JlYXRlRXZlbnREYXRhOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gewoJCQl0YWI6IHRoaXMuYWN0aXZlLAoJCQlwYW5lbDogIXRoaXMuYWN0aXZlLmxlbmd0aCA\/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJfTsKCX0sCgoJX3RhYktleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZm9jdXNlZFRhYiA9ICQoICQudWkuc2FmZUFjdGl2ZUVsZW1lbnQoIHRoaXMuZG9jdW1lbnRbIDAgXSApICkuY2xvc2VzdCggImxpIiApLAoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy50YWJzLmluZGV4KCBmb2N1c2VkVGFiICksCgkJCWdvaW5nRm9yd2FyZCA9IHRydWU7CgoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQljYXNlICQudWkua2V5Q29kZS5ET1dOOgoJCQlzZWxlY3RlZEluZGV4Kys7CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLlVQOgoJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCWdvaW5nRm9yd2FyZCA9IGZhbHNlOwoJCQlzZWxlY3RlZEluZGV4LS07CgkJCWJyZWFrOwoJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJc2VsZWN0ZWRJbmRleCA9IHRoaXMuYW5jaG9ycy5sZW5ndGggLSAxOwoJCQlicmVhazsKCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQlzZWxlY3RlZEluZGV4ID0gMDsKCQkJYnJlYWs7CgkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgoJCQkvLyBBY3RpdmF0ZSBvbmx5LCBubyBjb2xsYXBzaW5nCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ICk7CgkJCXJldHVybjsKCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCgkJCS8vIFRvZ2dsZSAoY2FuY2VsIGRlbGF5ZWQgYWN0aXZhdGlvbiwgYWxsb3cgY29sbGFwc2luZykKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCgkJCS8vIERldGVybWluZSBpZiB3ZSBzaG91bGQgY29sbGFwc2Ugb3IgYWN0aXZhdGUKCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggPT09IHRoaXMub3B0aW9ucy5hY3RpdmUgPyBmYWxzZSA6IHNlbGVjdGVkSW5kZXggKTsKCQkJcmV0dXJuOwoJCWRlZmF1bHQ6CgkJCXJldHVybjsKCQl9CgoJCS8vIEZvY3VzIHRoZSBhcHByb3ByaWF0ZSB0YWIsIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5fZm9jdXNOZXh0VGFiKCBzZWxlY3RlZEluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wvY29tbWFuZCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uCgkJaWYgKCAhZXZlbnQuY3RybEtleSAmJiAhZXZlbnQubWV0YUtleSApIHsKCgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLgoJCQkvLyBPdGhlcndpc2UgQVQgbWF5IGNvbmZ1c2UgdGhlIHVzZXIgYnkgc3RhdGluZyB0aGF0IHRoZXkgbmVlZCB0byBhY3RpdmF0ZSB0aGUgdGFiLAoJCQkvLyBidXQgdGhlIHRhYiB3aWxsIGFscmVhZHkgYmUgYWN0aXZhdGVkIGJ5IHRoZSB0aW1lIHRoZSBhbm5vdW5jZW1lbnQgZmluaXNoZXMuCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJCXRoaXMudGFicy5lcSggc2VsZWN0ZWRJbmRleCApLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgInRydWUiICk7CgoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheSggZnVuY3Rpb24oKSB7CgkJCQl0aGlzLm9wdGlvbiggImFjdGl2ZSIsIHNlbGVjdGVkSW5kZXggKTsKCQkJfSwgdGhpcy5kZWxheSApOwoJCX0KCX0sCgoJX3BhbmVsS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ3RybCt1cCBtb3ZlcyBmb2N1cyB0byB0aGUgY3VycmVudCB0YWIKCQlpZiAoIGV2ZW50LmN0cmxLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlVQICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl0aGlzLmFjdGl2ZS50cmlnZ2VyKCAiZm9jdXMiICk7CgkJfQoJfSwKCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykKCV9oYW5kbGVQYWdlTmF2OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfVVAgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlICsgMSwgdHJ1ZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0sCgoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQl2YXIgbGFzdFRhYkluZGV4ID0gdGhpcy50YWJzLmxlbmd0aCAtIDE7CgoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsKCQkJaWYgKCBpbmRleCA+IGxhc3RUYWJJbmRleCApIHsKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCWluZGV4ID0gbGFzdFRhYkluZGV4OwoJCQl9CgkJCXJldHVybiBpbmRleDsKCQl9CgoJCXdoaWxlICggJC5pbkFycmF5KCBjb25zdHJhaW4oKSwgdGhpcy5vcHRpb25zLmRpc2FibGVkICkgIT09IC0xICkgewoJCQlpbmRleCA9IGdvaW5nRm9yd2FyZCA\/IGluZGV4ICsgMSA6IGluZGV4IC0gMTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2ZvY3VzTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOwoJCXRoaXMudGFicy5lcSggaW5kZXggKS50cmlnZ2VyKCAiZm9jdXMiICk7CgkJcmV0dXJuIGluZGV4OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fc3VwZXIoIGtleSwgdmFsdWUgKTsKCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7CgkJCXRoaXMuX3RvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG51bGwsIHZhbHVlICk7CgoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQkJaWYgKCAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImhlaWdodFN0eWxlIiApIHsKCQkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdmFsdWUgKTsKCQl9Cgl9LAoKCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQlyZXR1cm4gaGFzaCA\/IGhhc2gucmVwbGFjZSggL1shIiQlJicoKSorLC5cLzo7PD0+P0BcW1xdXF5ge3x9fl0vZywgIlxcJCYiICkgOiAiIjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7CgoJCS8vIEdldCBkaXNhYmxlZCB0YWJzIGZyb20gY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQoJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLm1hcCggbGlzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIHRhYiApIHsKCQkJcmV0dXJuIGxpcy5pbmRleCggdGFiICk7CgkJfSApOwoKCQl0aGlzLl9wcm9jZXNzVGFicygpOwoKCQkvLyBXYXMgY29sbGFwc2VkIG9yIG5vIHRhYnMKCQlpZiAoIG9wdGlvbnMuYWN0aXZlID09PSBmYWxzZSB8fCAhdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJb3B0aW9ucy5hY3RpdmUgPSBmYWxzZTsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMudGFibGlzdFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkCgkJCWlmICggdGhpcy50YWJzLmxlbmd0aCA9PT0gb3B0aW9ucy5kaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgoJCQkvLyBhY3RpdmF0ZSBwcmV2aW91cyB0YWIKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9maW5kTmV4dFRhYiggTWF0aC5tYXgoIDAsIG9wdGlvbnMuYWN0aXZlIC0gMSApLCBmYWxzZSApICk7CgkJCX0KCgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHRhYiBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0T3B0aW9uRGlzYWJsZWQoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApOwoJCXRoaXMuX3NldHVwRXZlbnRzKCB0aGlzLm9wdGlvbnMuZXZlbnQgKTsKCQl0aGlzLl9zZXR1cEhlaWdodFN0eWxlKCB0aGlzLm9wdGlvbnMuaGVpZ2h0U3R5bGUgKTsKCgkJdGhpcy50YWJzLm5vdCggdGhpcy5hY3RpdmUgKS5hdHRyKCB7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQl0YWJJbmRleDogLTEKCQl9ICk7CgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApCgkJCS5oaWRlKCkKCQkJLmF0dHIoIHsKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQl9ICk7CgoJCS8vIE1ha2Ugc3VyZSBvbmUgdGFiIGlzIGluIHRoZSB0YWIgb3JkZXIKCQlpZiAoICF0aGlzLmFjdGl2ZS5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5lcSggMCApLmF0dHIoICJ0YWJJbmRleCIsIDAgKTsKCQl9IGVsc2UgewoJCQl0aGlzLmFjdGl2ZQoJCQkJLmF0dHIoIHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSApOwoJCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5hY3RpdmUsICJ1aS10YWJzLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJCQkuc2hvdygpCgkJCQkuYXR0ciggewoJCQkJCSJhcmlhLWhpZGRlbiI6ICJmYWxzZSIKCQkJCX0gKTsKCQl9Cgl9LAoKCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlwcmV2VGFicyA9IHRoaXMudGFicywKCQkJcHJldkFuY2hvcnMgPSB0aGlzLmFuY2hvcnMsCgkJCXByZXZQYW5lbHMgPSB0aGlzLnBhbmVsczsKCgkJdGhpcy50YWJsaXN0ID0gdGhpcy5fZ2V0TGlzdCgpLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMudGFibGlzdCwgInVpLXRhYnMtbmF2IiwKCQkJInVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciIgKTsKCgkJLy8gUHJldmVudCB1c2VycyBmcm9tIGZvY3VzaW5nIGRpc2FibGVkIHRhYnMgdmlhIGNsaWNrCgkJdGhpcy50YWJsaXN0CgkJCS5vbiggIm1vdXNlZG93biIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCAiPiBsaSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0gKQoKCQkJLy8gU3VwcG9ydDogSUUgPDkKCQkJLy8gUHJldmVudGluZyB0aGUgZGVmYXVsdCBhY3Rpb24gaW4gbW91c2Vkb3duIGRvZXNuJ3QgcHJldmVudCBJRQoJCQkvLyBmcm9tIGZvY3VzaW5nIHRoZSBlbGVtZW50LCBzbyBpZiB0aGUgYW5jaG9yIGdldHMgZm9jdXNlZCwgYmx1ci4KCQkJLy8gV2UgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBmb2N1c2luZyB0aGUgcHJldmlvdXNseSBmb2N1c2VkCgkJCS8vIGVsZW1lbnQgc2luY2UgY2xpY2tpbmcgb24gYSBub24tZm9jdXNhYmxlIGVsZW1lbnQgc2hvdWxkIGZvY3VzCgkJCS8vIHRoZSBib2R5IGFueXdheS4KCQkJLm9uKCAiZm9jdXMiICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgIi51aS10YWJzLWFuY2hvciIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCXRoaXMuYmx1cigpOwoJCQkJfQoJCQl9ICk7CgoJCXRoaXMudGFicyA9IHRoaXMudGFibGlzdC5maW5kKCAiPiBsaTpoYXMoYVtocmVmXSkiICkKCQkJLmF0dHIoIHsKCQkJCXJvbGU6ICJ0YWIiLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0gKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy50YWJzLCAidWktdGFicy10YWIiLCAidWktc3RhdGUtZGVmYXVsdCIgKTsKCgkJdGhpcy5hbmNob3JzID0gdGhpcy50YWJzLm1hcCggZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOwoJCX0gKQoJCQkuYXR0ciggewoJCQkJcm9sZTogInByZXNlbnRhdGlvbiIsCgkJCQl0YWJJbmRleDogLTEKCQkJfSApOwoJCXRoaXMuX2FkZENsYXNzKCB0aGlzLmFuY2hvcnMsICJ1aS10YWJzLWFuY2hvciIgKTsKCgkJdGhpcy5wYW5lbHMgPSAkKCk7CgoJCXRoaXMuYW5jaG9ycy5lYWNoKCBmdW5jdGlvbiggaSwgYW5jaG9yICkgewoJCQl2YXIgc2VsZWN0b3IsIHBhbmVsLCBwYW5lbElkLAoJCQkJYW5jaG9ySWQgPSAkKCBhbmNob3IgKS51bmlxdWVJZCgpLmF0dHIoICJpZCIgKSwKCQkJCXRhYiA9ICQoIGFuY2hvciApLmNsb3Nlc3QoICJsaSIgKSwKCQkJCW9yaWdpbmFsQXJpYUNvbnRyb2xzID0gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoKCQkJLy8gSW5saW5lIHRhYgoJCQlpZiAoIHRoYXQuX2lzTG9jYWwoIGFuY2hvciApICkgewoJCQkJc2VsZWN0b3IgPSBhbmNob3IuaGFzaDsKCQkJCXBhbmVsSWQgPSBzZWxlY3Rvci5zdWJzdHJpbmcoIDEgKTsKCQkJCXBhbmVsID0gdGhhdC5lbGVtZW50LmZpbmQoIHRoYXQuX3Nhbml0aXplU2VsZWN0b3IoIHNlbGVjdG9yICkgKTsKCgkJCS8vIHJlbW90ZSB0YWIKCQkJfSBlbHNlIHsKCgkJCQkvLyBJZiB0aGUgdGFiIGRvZXNuJ3QgYWxyZWFkeSBoYXZlIGFyaWEtY29udHJvbHMsCgkJCQkvLyBnZW5lcmF0ZSBhbiBpZCBieSB1c2luZyBhIHRocm93LWF3YXkgZWxlbWVudAoJCQkJcGFuZWxJZCA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAkKCB7fSApLnVuaXF1ZUlkKClbIDAgXS5pZDsKCQkJCXNlbGVjdG9yID0gIiMiICsgcGFuZWxJZDsKCQkJCXBhbmVsID0gdGhhdC5lbGVtZW50LmZpbmQoIHNlbGVjdG9yICk7CgkJCQlpZiAoICFwYW5lbC5sZW5ndGggKSB7CgkJCQkJcGFuZWwgPSB0aGF0Ll9jcmVhdGVQYW5lbCggcGFuZWxJZCApOwoJCQkJCXBhbmVsLmluc2VydEFmdGVyKCB0aGF0LnBhbmVsc1sgaSAtIDEgXSB8fCB0aGF0LnRhYmxpc3QgKTsKCQkJCX0KCQkJCXBhbmVsLmF0dHIoICJhcmlhLWxpdmUiLCAicG9saXRlIiApOwoJCQl9CgoJCQlpZiAoIHBhbmVsLmxlbmd0aCApIHsKCQkJCXRoYXQucGFuZWxzID0gdGhhdC5wYW5lbHMuYWRkKCBwYW5lbCApOwoJCQl9CgkJCWlmICggb3JpZ2luYWxBcmlhQ29udHJvbHMgKSB7CgkJCQl0YWIuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIsIG9yaWdpbmFsQXJpYUNvbnRyb2xzICk7CgkJCX0KCQkJdGFiLmF0dHIoIHsKCQkJCSJhcmlhLWNvbnRyb2xzIjogcGFuZWxJZCwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZAoJCQl9ICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBhbmNob3JJZCApOwoJCX0gKTsKCgkJdGhpcy5wYW5lbHMuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRoaXMucGFuZWxzLCAidWktdGFicy1wYW5lbCIsICJ1aS13aWRnZXQtY29udGVudCIgKTsKCgkJLy8gQXZvaWQgbWVtb3J5IGxlYWtzICgjMTAwNTYpCgkJaWYgKCBwcmV2VGFicyApIHsKCQkJdGhpcy5fb2ZmKCBwcmV2VGFicy5ub3QoIHRoaXMudGFicyApICk7CgkJCXRoaXMuX29mZiggcHJldkFuY2hvcnMubm90KCB0aGlzLmFuY2hvcnMgKSApOwoJCQl0aGlzLl9vZmYoIHByZXZQYW5lbHMubm90KCB0aGlzLnBhbmVscyApICk7CgkJfQoJfSwKCgkvLyBBbGxvdyBvdmVycmlkaW5nIGhvdyB0byBmaW5kIHRoZSBsaXN0IGZvciByYXJlIHVzYWdlIHNjZW5hcmlvcyAoIzc3MTUpCglfZ2V0TGlzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMudGFibGlzdCB8fCB0aGlzLmVsZW1lbnQuZmluZCggIm9sLCB1bCIgKS5lcSggMCApOwoJfSwKCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsKCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCS5hdHRyKCAiaWQiLCBpZCApCgkJCS5kYXRhKCAidWktdGFicy1kZXN0cm95IiwgdHJ1ZSApOwoJfSwKCglfc2V0T3B0aW9uRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsKCQl2YXIgY3VycmVudEl0ZW0sIGxpLCBpOwoKCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJaWYgKCAhZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBEaXNhYmxlIHRhYnMKCQlmb3IgKCBpID0gMDsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsKCQkJY3VycmVudEl0ZW0gPSAkKCBsaSApOwoJCQlpZiAoIGRpc2FibGVkID09PSB0cnVlIHx8ICQuaW5BcnJheSggaSwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQljdXJyZW50SXRlbS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsICJ0cnVlIiApOwoJCQkJdGhpcy5fYWRkQ2xhc3MoIGN1cnJlbnRJdGVtLCBudWxsLCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJCX0gZWxzZSB7CgkJCQljdXJyZW50SXRlbS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCQkJCXRoaXMuX3JlbW92ZUNsYXNzKCBjdXJyZW50SXRlbSwgbnVsbCwgInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCQl9CgkJfQoKCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSBkaXNhYmxlZDsKCgkJdGhpcy5fdG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0KCksIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIiwgbnVsbCwKCQkJZGlzYWJsZWQgPT09IHRydWUgKTsKCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGV2ZW50cyA9IHt9OwoJCWlmICggZXZlbnQgKSB7CgkJCSQuZWFjaCggZXZlbnQuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaW5kZXgsIGV2ZW50TmFtZSApIHsKCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7CgkJCX0gKTsKCQl9CgoJCXRoaXMuX29mZiggdGhpcy5hbmNob3JzLmFkZCggdGhpcy50YWJzICkuYWRkKCB0aGlzLnBhbmVscyApICk7CgoJCS8vIEFsd2F5cyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFjdGlvbiwgZXZlbiB3aGVuIGRpc2FibGVkCgkJdGhpcy5fb24oIHRydWUsIHRoaXMuYW5jaG9ycywgewoJCQljbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0gKTsKCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy50YWJzLCB7IGtleWRvd246ICJfdGFiS2V5ZG93biIgfSApOwoJCXRoaXMuX29uKCB0aGlzLnBhbmVscywgeyBrZXlkb3duOiAiX3BhbmVsS2V5ZG93biIgfSApOwoKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMudGFicyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy50YWJzICk7Cgl9LAoKCV9zZXR1cEhlaWdodFN0eWxlOiBmdW5jdGlvbiggaGVpZ2h0U3R5bGUgKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJbWF4SGVpZ2h0IC09IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgZWxlbSA9ICQoIHRoaXMgKSwKCQkJCQlwb3NpdGlvbiA9IGVsZW0uY3NzKCAicG9zaXRpb24iICk7CgoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQltYXhIZWlnaHQgLT0gZWxlbS5vdXRlckhlaWdodCggdHJ1ZSApOwoJCQl9ICk7CgoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5ub3QoIHRoaXMucGFuZWxzICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0gKTsKCgkJCXRoaXMucGFuZWxzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmhlaWdodCggTWF0aC5tYXgoIDAsIG1heEhlaWdodCAtCgkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQl9ICkKCQkJCS5jc3MoICJvdmVyZmxvdyIsICJhdXRvIiApOwoJCX0gZWxzZSBpZiAoIGhlaWdodFN0eWxlID09PSAiYXV0byIgKSB7CgkJCW1heEhlaWdodCA9IDA7CgkJCXRoaXMucGFuZWxzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmhlaWdodCggIiIgKS5oZWlnaHQoKSApOwoJCQl9ICkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWFuY2hvciA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJdGFiID0gYW5jaG9yLmNsb3Nlc3QoICJsaSIgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRUYWI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdUYWI6IGNvbGxhcHNpbmcgPyAkKCkgOiB0YWIsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICggdGFiLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCgkJCQkvLyB0YWIgaXMgYWxyZWFkeSBsb2FkaW5nCgkJCQl0YWIuaGFzQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICkgfHwKCgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24KCQkJCXRoaXMucnVubmluZyB8fAoKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCgkJCQkvLyBhbGxvdyBjYW5jZWxpbmcgYWN0aXZhdGlvbgoJCQkJKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlQWN0aXZhdGUiLCBldmVudCwgZXZlbnREYXRhICkgPT09IGZhbHNlICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCW9wdGlvbnMuYWN0aXZlID0gY29sbGFwc2luZyA\/IGZhbHNlIDogdGhpcy50YWJzLmluZGV4KCB0YWIgKTsKCgkJdGhpcy5hY3RpdmUgPSBjbGlja2VkSXNBY3RpdmUgPyAkKCkgOiB0YWI7CgkJaWYgKCB0aGlzLnhociApIHsKCQkJdGhpcy54aHIuYWJvcnQoKTsKCQl9CgoJCWlmICggIXRvSGlkZS5sZW5ndGggJiYgIXRvU2hvdy5sZW5ndGggKSB7CgkJCSQuZXJyb3IoICJqUXVlcnkgVUkgVGFiczogTWlzbWF0Y2hpbmcgZnJhZ21lbnQgaWRlbnRpZmllci4iICk7CgkJfQoKCQlpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMubG9hZCggdGhpcy50YWJzLmluZGV4KCB0YWIgKSwgZXZlbnQgKTsKCQl9CgkJdGhpcy5fdG9nZ2xlKCBldmVudCwgZXZlbnREYXRhICk7Cgl9LAoKCS8vIEhhbmRsZXMgc2hvdy9oaWRlIGZvciBzZWxlY3RpbmcgdGFicwoJX3RvZ2dsZTogZnVuY3Rpb24oIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0b1Nob3cgPSBldmVudERhdGEubmV3UGFuZWwsCgkJCXRvSGlkZSA9IGV2ZW50RGF0YS5vbGRQYW5lbDsKCgkJdGhpcy5ydW5uaW5nID0gdHJ1ZTsKCgkJZnVuY3Rpb24gY29tcGxldGUoKSB7CgkJCXRoYXQucnVubmluZyA9IGZhbHNlOwoJCQl0aGF0Ll90cmlnZ2VyKCAiYWN0aXZhdGUiLCBldmVudCwgZXZlbnREYXRhICk7CgkJfQoKCQlmdW5jdGlvbiBzaG93KCkgewoJCQl0aGF0Ll9hZGRDbGFzcyggZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICksICJ1aS10YWJzLWFjdGl2ZSIsICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdGhhdC5vcHRpb25zLnNob3cgKSB7CgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJdG9TaG93LnNob3coKTsKCQkJCWNvbXBsZXRlKCk7CgkJCX0KCQl9CgoJCS8vIFN0YXJ0IG91dCBieSBoaWRpbmcsIHRoZW4gc2hvd2luZywgdGhlbiBjb21wbGV0aW5nCgkJaWYgKCB0b0hpZGUubGVuZ3RoICYmIHRoaXMub3B0aW9ucy5oaWRlICkgewoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJCXRoYXQuX3JlbW92ZUNsYXNzKCBldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkidWktdGFicy1hY3RpdmUiLCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJc2hvdygpOwoJCQl9ICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fcmVtb3ZlQ2xhc3MoIGV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLAoJCQkJInVpLXRhYnMtYWN0aXZlIiwgInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJc2hvdygpOwoJCX0KCgkJdG9IaWRlLmF0dHIoICJhcmlhLWhpZGRlbiIsICJ0cnVlIiApOwoJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIgoJCX0gKTsKCgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIGNvbGxhcHNpbmcsIHRoZW4ga2VlcCB0aGUgY29sbGFwc2luZyB0YWIgaW4gdGhlIHRhYiBvcmRlci4KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0gKQoJCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cuYXR0ciggImFyaWEtaGlkZGVuIiwgImZhbHNlIiApOwoJCWV2ZW50RGF0YS5uZXdUYWIuYXR0ciggewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCXRhYkluZGV4OiAwCgkJfSApOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYW5jaG9yLAoJCQlhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApOwoKCQkvLyBUcnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmVbIDAgXSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gVHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50IGFjdGl2ZSBoZWFkZXIKCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgewoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZTsKCQl9CgoJCWFuY2hvciA9IGFjdGl2ZS5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApWyAwIF07CgkJdGhpcy5fZXZlbnRIYW5kbGVyKCB7CgkJCXRhcmdldDogYW5jaG9yLAoJCQljdXJyZW50VGFyZ2V0OiBhbmNob3IsCgkJCXByZXZlbnREZWZhdWx0OiAkLm5vb3AKCQl9ICk7Cgl9LAoKCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJcmV0dXJuIGluZGV4ID09PSBmYWxzZSA\/ICQoKSA6IHRoaXMudGFicy5lcSggaW5kZXggKTsKCX0sCgoJX2dldEluZGV4OiBmdW5jdGlvbiggaW5kZXggKSB7CgoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguCgkJaWYgKCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICkgewoJCQlpbmRleCA9IHRoaXMuYW5jaG9ycy5pbmRleCggdGhpcy5hbmNob3JzLmZpbHRlciggIltocmVmJD0nIiArCgkJCQkkLnVpLmVzY2FwZVNlbGVjdG9yKCBpbmRleCApICsgIiddIiApICk7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJdGhpcy50YWJsaXN0CgkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKQoJCQkub2ZmKCB0aGlzLmV2ZW50TmFtZXNwYWNlICk7CgoJCXRoaXMuYW5jaG9ycwoJCQkucmVtb3ZlQXR0ciggInJvbGUgdGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMudGFicy5hZGQoIHRoaXMucGFuZWxzICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCWlmICggJC5kYXRhKCB0aGlzLCAidWktdGFicy1kZXN0cm95IiApICkgewoJCQkJJCggdGhpcyApLnJlbW92ZSgpOwoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLnJlbW92ZUF0dHIoICJyb2xlIHRhYkluZGV4ICIgKwoJCQkJCSJhcmlhLWxpdmUgYXJpYS1idXN5IGFyaWEtc2VsZWN0ZWQgYXJpYS1sYWJlbGxlZGJ5IGFyaWEtaGlkZGVuIGFyaWEtZXhwYW5kZWQiICk7CgkJCX0KCQl9ICk7CgoJCXRoaXMudGFicy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gJCggdGhpcyApLAoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCWlmICggcHJldiApIHsKCQkJCWxpCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCX0gZWxzZSB7CgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQkJfQoJCX0gKTsKCgkJdGhpcy5wYW5lbHMuc2hvdygpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQl0aGlzLnBhbmVscy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCBkaXNhYmxlZCwgZnVuY3Rpb24oIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA\/IG51bSA6IG51bGw7CgkJCQl9ICk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCB0aGlzLnRhYnMsIGZ1bmN0aW9uKCBsaSwgbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0gKTsKCQkJfQoJCX0KCQl0aGlzLl9zZXRPcHRpb25EaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gdHJ1ZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaW5BcnJheSggaW5kZXgsIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSBbIGluZGV4IF07CgkJCX0KCQl9CgkJdGhpcy5fc2V0T3B0aW9uRGlzYWJsZWQoIGRpc2FibGVkICk7Cgl9LAoKCWxvYWQ6IGZ1bmN0aW9uKCBpbmRleCwgZXZlbnQgKSB7CgkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRhYiA9IHRoaXMudGFicy5lcSggaW5kZXggKSwKCQkJYW5jaG9yID0gdGFiLmZpbmQoICIudWktdGFicy1hbmNob3IiICksCgkJCXBhbmVsID0gdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRhYiApLAoJCQlldmVudERhdGEgPSB7CgkJCQl0YWI6IHRhYiwKCQkJCXBhbmVsOiBwYW5lbAoJCQl9LAoJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQkJaWYgKCBzdGF0dXMgPT09ICJhYm9ydCIgKSB7CgkJCQkJdGhhdC5wYW5lbHMuc3RvcCggZmFsc2UsIHRydWUgKTsKCQkJCX0KCgkJCQl0aGF0Ll9yZW1vdmVDbGFzcyggdGFiLCAidWktdGFicy1sb2FkaW5nIiApOwoJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsKCgkJCQlpZiAoIGpxWEhSID09PSB0aGF0LnhociApIHsKCQkJCQlkZWxldGUgdGhhdC54aHI7CgkJCQl9CgkJCX07CgoJCS8vIE5vdCByZW1vdGUKCQlpZiAoIHRoaXMuX2lzTG9jYWwoIGFuY2hvclsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7CgoJCS8vIFN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLAoJCS8vIGJ1dCBhcyBvZiAxLjgsICQuYWpheCgpIGFsd2F5cyByZXR1cm5zIGEganFYSFIgb2JqZWN0LgoJCWlmICggdGhpcy54aHIgJiYgdGhpcy54aHIuc3RhdHVzVGV4dCAhPT0gImNhbmNlbGVkIiApIHsKCQkJdGhpcy5fYWRkQ2xhc3MoIHRhYiwgInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJcGFuZWwuYXR0ciggImFyaWEtYnVzeSIsICJ0cnVlIiApOwoKCQkJdGhpcy54aHIKCQkJCS5kb25lKCBmdW5jdGlvbiggcmVzcG9uc2UsIHN0YXR1cywganFYSFIgKSB7CgoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJcGFuZWwuaHRtbCggcmVzcG9uc2UgKTsKCQkJCQkJdGhhdC5fdHJpZ2dlciggImxvYWQiLCBldmVudCwgZXZlbnREYXRhICk7CgoJCQkJCQljb21wbGV0ZSgganFYSFIsIHN0YXR1cyApOwoJCQkJCX0sIDEgKTsKCQkJCX0gKQoJCQkJLmZhaWwoIGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoKCQkJCQkvLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAoJCQkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzExNzc4CgkJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCWNvbXBsZXRlKCBqcVhIUiwgc3RhdHVzICk7CgkJCQkJfSwgMSApOwoJCQkJfSApOwoJCX0KCX0sCgoJX2FqYXhTZXR0aW5nczogZnVuY3Rpb24oIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgkJcmV0dXJuIHsKCgkJCS8vIFN1cHBvcnQ6IElFIDwxMSBvbmx5CgkJCS8vIFN0cmlwIGFueSBoYXNoIHRoYXQgZXhpc3RzIHRvIHByZXZlbnQgZXJyb3JzIHdpdGggdGhlIEFqYXggcmVxdWVzdAoJCQl1cmw6IGFuY2hvci5hdHRyKCAiaHJlZiIgKS5yZXBsYWNlKCAvIy4qJC8sICIiICksCgkJCWJlZm9yZVNlbmQ6IGZ1bmN0aW9uKCBqcVhIUiwgc2V0dGluZ3MgKSB7CgkJCQlyZXR1cm4gdGhhdC5fdHJpZ2dlciggImJlZm9yZUxvYWQiLCBldmVudCwKCQkJCQkkLmV4dGVuZCggeyBqcVhIUjoganFYSFIsIGFqYXhTZXR0aW5nczogc2V0dGluZ3MgfSwgZXZlbnREYXRhICkgKTsKCQkJfQoJCX07Cgl9LAoKCV9nZXRQYW5lbEZvclRhYjogZnVuY3Rpb24oIHRhYiApIHsKCQl2YXIgaWQgPSAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsKCX0KfSApOwoKLy8gREVQUkVDQVRFRAovLyBUT0RPOiBTd2l0Y2ggcmV0dXJuIGJhY2sgdG8gd2lkZ2V0IGRlY2xhcmF0aW9uIGF0IHRvcCBvZiBmaWxlIHdoZW4gdGhpcyBpcyByZW1vdmVkCmlmICggJC51aUJhY2tDb21wYXQgIT09IGZhbHNlICkgewoKCS8vIEJhY2tjb21wYXQgZm9yIHVpLXRhYiBjbGFzcyAobm93IHVpLXRhYnMtdGFiKQoJJC53aWRnZXQoICJ1aS50YWJzIiwgJC51aS50YWJzLCB7CgkJX3Byb2Nlc3NUYWJzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJCXRoaXMuX2FkZENsYXNzKCB0aGlzLnRhYnMsICJ1aS10YWIiICk7CgkJfQoJfSApOwp9Cgp2YXIgd2lkZ2V0c1RhYnMgPSAkLnVpLnRhYnM7CgoKLyohCiAqIGpRdWVyeSBVSSBUb29sdGlwIDEuMTIuMQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KCi8vPj5sYWJlbDogVG9vbHRpcAovLz4+Z3JvdXA6IFdpZGdldHMKLy8+PmRlc2NyaXB0aW9uOiBTaG93cyBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIGZvciBhbnkgZWxlbWVudCBvbiBob3ZlciBvciBmb2N1cy4KLy8+PmRvY3M6IGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3Rvb2x0aXAvCi8vPj5kZW1vczogaHR0cDovL2pxdWVyeXVpLmNvbS90b29sdGlwLwovLz4+Y3NzLnN0cnVjdHVyZTogLi4vLi4vdGhlbWVzL2Jhc2UvY29yZS5jc3MKLy8+PmNzcy5zdHJ1Y3R1cmU6IC4uLy4uL3RoZW1lcy9iYXNlL3Rvb2x0aXAuY3NzCi8vPj5jc3MudGhlbWU6IC4uLy4uL3RoZW1lcy9iYXNlL3RoZW1lLmNzcwoKCgokLndpZGdldCggInVpLnRvb2x0aXAiLCB7Cgl2ZXJzaW9uOiAiMS4xMi4xIiwKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCSJ1aS10b29sdGlwIjogInVpLWNvcm5lci1hbGwgdWktd2lkZ2V0LXNoYWRvdyIKCQl9LAoJCWNvbnRlbnQ6IGZ1bmN0aW9uKCkgewoKCQkJLy8gc3VwcG9ydDogSUU8OSwgT3BlcmEgaW4galF1ZXJ5IDwxLjcKCQkJLy8gLnRleHQoKSBjYW4ndCBhY2NlcHQgdW5kZWZpbmVkLCBzbyBjb2VyY2UgdG8gYSBzdHJpbmcKCQkJdmFyIHRpdGxlID0gJCggdGhpcyApLmF0dHIoICJ0aXRsZSIgKSB8fCAiIjsKCgkJCS8vIEVzY2FwZSB0aXRsZSwgc2luY2Ugd2UncmUgZ29pbmcgZnJvbSBhbiBhdHRyaWJ1dGUgdG8gcmF3IEhUTUwKCQkJcmV0dXJuICQoICI8YT4iICkudGV4dCggdGl0bGUgKS5odG1sKCk7CgkJfSwKCQloaWRlOiB0cnVlLAoKCQkvLyBEaXNhYmxlZCBlbGVtZW50cyBoYXZlIGluY29uc2lzdGVudCBiZWhhdmlvciBhY3Jvc3MgYnJvd3NlcnMgKCM4NjYxKQoJCWl0ZW1zOiAiW3RpdGxlXTpub3QoW2Rpc2FibGVkXSkiLAoJCXBvc2l0aW9uOiB7CgkJCW15OiAibGVmdCB0b3ArMTUiLAoJCQlhdDogImxlZnQgYm90dG9tIiwKCQkJY29sbGlzaW9uOiAiZmxpcGZpdCBmbGlwIgoJCX0sCgkJc2hvdzogdHJ1ZSwKCQl0cmFjazogZmFsc2UsCgoJCS8vIENhbGxiYWNrcwoJCWNsb3NlOiBudWxsLAoJCW9wZW46IG51bGwKCX0sCgoJX2FkZERlc2NyaWJlZEJ5OiBmdW5jdGlvbiggZWxlbSwgaWQgKSB7CgkJdmFyIGRlc2NyaWJlZGJ5ID0gKCBlbGVtLmF0dHIoICJhcmlhLWRlc2NyaWJlZGJ5IiApIHx8ICIiICkuc3BsaXQoIC9ccysvICk7CgkJZGVzY3JpYmVkYnkucHVzaCggaWQgKTsKCQllbGVtCgkJCS5kYXRhKCAidWktdG9vbHRpcC1pZCIsIGlkICkKCQkJLmF0dHIoICJhcmlhLWRlc2NyaWJlZGJ5IiwgJC50cmltKCBkZXNjcmliZWRieS5qb2luKCAiICIgKSApICk7Cgl9LAoKCV9yZW1vdmVEZXNjcmliZWRCeTogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIGlkID0gZWxlbS5kYXRhKCAidWktdG9vbHRpcC1pZCIgKSwKCQkJZGVzY3JpYmVkYnkgPSAoIGVsZW0uYXR0ciggImFyaWEtZGVzY3JpYmVkYnkiICkgfHwgIiIgKS5zcGxpdCggL1xzKy8gKSwKCQkJaW5kZXggPSAkLmluQXJyYXkoIGlkLCBkZXNjcmliZWRieSApOwoKCQlpZiAoIGluZGV4ICE9PSAtMSApIHsKCQkJZGVzY3JpYmVkYnkuc3BsaWNlKCBpbmRleCwgMSApOwoJCX0KCgkJZWxlbS5yZW1vdmVEYXRhKCAidWktdG9vbHRpcC1pZCIgKTsKCQlkZXNjcmliZWRieSA9ICQudHJpbSggZGVzY3JpYmVkYnkuam9pbiggIiAiICkgKTsKCQlpZiAoIGRlc2NyaWJlZGJ5ICkgewoJCQllbGVtLmF0dHIoICJhcmlhLWRlc2NyaWJlZGJ5IiwgZGVzY3JpYmVkYnkgKTsKCQl9IGVsc2UgewoJCQllbGVtLnJlbW92ZUF0dHIoICJhcmlhLWRlc2NyaWJlZGJ5IiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHsKCQkJbW91c2VvdmVyOiAib3BlbiIsCgkJCWZvY3VzaW46ICJvcGVuIgoJCX0gKTsKCgkJLy8gSURzIG9mIGdlbmVyYXRlZCB0b29sdGlwcywgbmVlZGVkIGZvciBkZXN0cm95CgkJdGhpcy50b29sdGlwcyA9IHt9OwoKCQkvLyBJRHMgb2YgcGFyZW50IHRvb2x0aXBzIHdoZXJlIHdlIHJlbW92ZWQgdGhlIHRpdGxlIGF0dHJpYnV0ZQoJCXRoaXMucGFyZW50cyA9IHt9OwoKCQkvLyBBcHBlbmQgdGhlIGFyaWEtbGl2ZSByZWdpb24gc28gdG9vbHRpcHMgYW5ub3VuY2UgY29ycmVjdGx5CgkJdGhpcy5saXZlUmVnaW9uID0gJCggIjxkaXY+IiApCgkJCS5hdHRyKCB7CgkJCQlyb2xlOiAibG9nIiwKCQkJCSJhcmlhLWxpdmUiOiAiYXNzZXJ0aXZlIiwKCQkJCSJhcmlhLXJlbGV2YW50IjogImFkZGl0aW9ucyIKCQkJfSApCgkJCS5hcHBlbmRUbyggdGhpcy5kb2N1bWVudFsgMCBdLmJvZHkgKTsKCQl0aGlzLl9hZGRDbGFzcyggdGhpcy5saXZlUmVnaW9uLCBudWxsLCAidWktaGVscGVyLWhpZGRlbi1hY2Nlc3NpYmxlIiApOwoKCQl0aGlzLmRpc2FibGVkVGl0bGVzID0gJCggW10gKTsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gImNvbnRlbnQiICkgewoJCQkkLmVhY2goIHRoaXMudG9vbHRpcHMsIGZ1bmN0aW9uKCBpZCwgdG9vbHRpcERhdGEgKSB7CgkJCQl0aGF0Ll91cGRhdGVDb250ZW50KCB0b29sdGlwRGF0YS5lbGVtZW50ICk7CgkJCX0gKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25EaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXNbIHZhbHVlID8gIl9kaXNhYmxlIiA6ICJfZW5hYmxlIiBdKCk7Cgl9LAoKCV9kaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGhhdCA9IHRoaXM7CgoJCS8vIENsb3NlIG9wZW4gdG9vbHRpcHMKCQkkLmVhY2goIHRoaXMudG9vbHRpcHMsIGZ1bmN0aW9uKCBpZCwgdG9vbHRpcERhdGEgKSB7CgkJCXZhciBldmVudCA9ICQuRXZlbnQoICJibHVyIiApOwoJCQlldmVudC50YXJnZXQgPSBldmVudC5jdXJyZW50VGFyZ2V0ID0gdG9vbHRpcERhdGEuZWxlbWVudFsgMCBdOwoJCQl0aGF0LmNsb3NlKCBldmVudCwgdHJ1ZSApOwoJCX0gKTsKCgkJLy8gUmVtb3ZlIHRpdGxlIGF0dHJpYnV0ZXMgdG8gcHJldmVudCBuYXRpdmUgdG9vbHRpcHMKCQl0aGlzLmRpc2FibGVkVGl0bGVzID0gdGhpcy5kaXNhYmxlZFRpdGxlcy5hZGQoCgkJCXRoaXMuZWxlbWVudC5maW5kKCB0aGlzLm9wdGlvbnMuaXRlbXMgKS5hZGRCYWNrKCkKCQkJCS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtZW50ID0gJCggdGhpcyApOwoJCQkJCWlmICggZWxlbWVudC5pcyggIlt0aXRsZV0iICkgKSB7CgkJCQkJCXJldHVybiBlbGVtZW50CgkJCQkJCQkuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiLCBlbGVtZW50LmF0dHIoICJ0aXRsZSIgKSApCgkJCQkJCQkucmVtb3ZlQXR0ciggInRpdGxlIiApOwoJCQkJCX0KCQkJCX0gKQoJCSk7Cgl9LAoKCV9lbmFibGU6IGZ1bmN0aW9uKCkgewoKCQkvLyByZXN0b3JlIHRpdGxlIGF0dHJpYnV0ZXMKCQl0aGlzLmRpc2FibGVkVGl0bGVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgZWxlbWVudCA9ICQoIHRoaXMgKTsKCQkJaWYgKCBlbGVtZW50LmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiApICkgewoJCQkJZWxlbWVudC5hdHRyKCAidGl0bGUiLCBlbGVtZW50LmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiApICk7CgkJCX0KCQl9ICk7CgkJdGhpcy5kaXNhYmxlZFRpdGxlcyA9ICQoIFtdICk7Cgl9LAoKCW9wZW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRhcmdldCA9ICQoIGV2ZW50ID8gZXZlbnQudGFyZ2V0IDogdGhpcy5lbGVtZW50ICkKCgkJCQkvLyB3ZSBuZWVkIGNsb3Nlc3QgaGVyZSBkdWUgdG8gbW91c2VvdmVyIGJ1YmJsaW5nLAoJCQkJLy8gYnV0IGFsd2F5cyBwb2ludGluZyBhdCB0aGUgc2FtZSBldmVudCB0YXJnZXQKCQkJCS5jbG9zZXN0KCB0aGlzLm9wdGlvbnMuaXRlbXMgKTsKCgkJLy8gTm8gZWxlbWVudCB0byBzaG93IGEgdG9vbHRpcCBmb3Igb3IgdGhlIHRvb2x0aXAgaXMgYWxyZWFkeSBvcGVuCgkJaWYgKCAhdGFyZ2V0Lmxlbmd0aCB8fCB0YXJnZXQuZGF0YSggInVpLXRvb2x0aXAtaWQiICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggdGFyZ2V0LmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLXRpdGxlIiwgdGFyZ2V0LmF0dHIoICJ0aXRsZSIgKSApOwoJCX0KCgkJdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLW9wZW4iLCB0cnVlICk7CgoJCS8vIEtpbGwgcGFyZW50IHRvb2x0aXBzLCBjdXN0b20gb3IgbmF0aXZlLCBmb3IgaG92ZXIKCQlpZiAoIGV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW92ZXIiICkgewoJCQl0YXJnZXQucGFyZW50cygpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHBhcmVudCA9ICQoIHRoaXMgKSwKCQkJCQlibHVyRXZlbnQ7CgkJCQlpZiAoIHBhcmVudC5kYXRhKCAidWktdG9vbHRpcC1vcGVuIiApICkgewoJCQkJCWJsdXJFdmVudCA9ICQuRXZlbnQoICJibHVyIiApOwoJCQkJCWJsdXJFdmVudC50YXJnZXQgPSBibHVyRXZlbnQuY3VycmVudFRhcmdldCA9IHRoaXM7CgkJCQkJdGhhdC5jbG9zZSggYmx1ckV2ZW50LCB0cnVlICk7CgkJCQl9CgkJCQlpZiAoIHBhcmVudC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCQkJcGFyZW50LnVuaXF1ZUlkKCk7CgkJCQkJdGhhdC5wYXJlbnRzWyB0aGlzLmlkIF0gPSB7CgkJCQkJCWVsZW1lbnQ6IHRoaXMsCgkJCQkJCXRpdGxlOiBwYXJlbnQuYXR0ciggInRpdGxlIiApCgkJCQkJfTsKCQkJCQlwYXJlbnQuYXR0ciggInRpdGxlIiwgIiIgKTsKCQkJCX0KCQkJfSApOwoJCX0KCgkJdGhpcy5fcmVnaXN0ZXJDbG9zZUhhbmRsZXJzKCBldmVudCwgdGFyZ2V0ICk7CgkJdGhpcy5fdXBkYXRlQ29udGVudCggdGFyZ2V0LCBldmVudCApOwoJfSwKCglfdXBkYXRlQ29udGVudDogZnVuY3Rpb24oIHRhcmdldCwgZXZlbnQgKSB7CgkJdmFyIGNvbnRlbnQsCgkJCWNvbnRlbnRPcHRpb24gPSB0aGlzLm9wdGlvbnMuY29udGVudCwKCQkJdGhhdCA9IHRoaXMsCgkJCWV2ZW50VHlwZSA9IGV2ZW50ID8gZXZlbnQudHlwZSA6IG51bGw7CgoJCWlmICggdHlwZW9mIGNvbnRlbnRPcHRpb24gPT09ICJzdHJpbmciIHx8IGNvbnRlbnRPcHRpb24ubm9kZVR5cGUgfHwKCQkJCWNvbnRlbnRPcHRpb24uanF1ZXJ5ICkgewoJCQlyZXR1cm4gdGhpcy5fb3BlbiggZXZlbnQsIHRhcmdldCwgY29udGVudE9wdGlvbiApOwoJCX0KCgkJY29udGVudCA9IGNvbnRlbnRPcHRpb24uY2FsbCggdGFyZ2V0WyAwIF0sIGZ1bmN0aW9uKCByZXNwb25zZSApIHsKCgkJCS8vIElFIG1heSBpbnN0YW50bHkgc2VydmUgYSBjYWNoZWQgcmVzcG9uc2UgZm9yIGFqYXggcmVxdWVzdHMKCQkJLy8gZGVsYXkgdGhpcyBjYWxsIHRvIF9vcGVuIHNvIHRoZSBvdGhlciBjYWxsIHRvIF9vcGVuIHJ1bnMgZmlyc3QKCQkJdGhhdC5fZGVsYXkoIGZ1bmN0aW9uKCkgewoKCQkJCS8vIElnbm9yZSBhc3luYyByZXNwb25zZSBpZiB0b29sdGlwIHdhcyBjbG9zZWQgYWxyZWFkeQoJCQkJaWYgKCAhdGFyZ2V0LmRhdGEoICJ1aS10b29sdGlwLW9wZW4iICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIEpRdWVyeSBjcmVhdGVzIGEgc3BlY2lhbCBldmVudCBmb3IgZm9jdXNpbiB3aGVuIGl0IGRvZXNuJ3QKCQkJCS8vIGV4aXN0IG5hdGl2ZWx5LiBUbyBpbXByb3ZlIHBlcmZvcm1hbmNlLCB0aGUgbmF0aXZlIGV2ZW50CgkJCQkvLyBvYmplY3QgaXMgcmV1c2VkIGFuZCB0aGUgdHlwZSBpcyBjaGFuZ2VkLiBUaGVyZWZvcmUsIHdlIGNhbid0CgkJCQkvLyByZWx5IG9uIHRoZSB0eXBlIGJlaW5nIGNvcnJlY3QgYWZ0ZXIgdGhlIGV2ZW50IGZpbmlzaGVkCgkJCQkvLyBidWJibGluZywgc28gd2Ugc2V0IGl0IGJhY2sgdG8gdGhlIHByZXZpb3VzIHZhbHVlLiAoIzg3NDApCgkJCQlpZiAoIGV2ZW50ICkgewoJCQkJCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkJCQl9CgkJCQl0aGlzLl9vcGVuKCBldmVudCwgdGFyZ2V0LCByZXNwb25zZSApOwoJCQl9ICk7CgkJfSApOwoJCWlmICggY29udGVudCApIHsKCQkJdGhpcy5fb3BlbiggZXZlbnQsIHRhcmdldCwgY29udGVudCApOwoJCX0KCX0sCgoJX29wZW46IGZ1bmN0aW9uKCBldmVudCwgdGFyZ2V0LCBjb250ZW50ICkgewoJCXZhciB0b29sdGlwRGF0YSwgdG9vbHRpcCwgZGVsYXllZFNob3csIGExMXlDb250ZW50LAoJCQlwb3NpdGlvbk9wdGlvbiA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLnBvc2l0aW9uICk7CgoJCWlmICggIWNvbnRlbnQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIENvbnRlbnQgY2FuIGJlIHVwZGF0ZWQgbXVsdGlwbGUgdGltZXMuIElmIHRoZSB0b29sdGlwIGFscmVhZHkKCQkvLyBleGlzdHMsIHRoZW4ganVzdCB1cGRhdGUgdGhlIGNvbnRlbnQgYW5kIGJhaWwuCgkJdG9vbHRpcERhdGEgPSB0aGlzLl9maW5kKCB0YXJnZXQgKTsKCQlpZiAoIHRvb2x0aXBEYXRhICkgewoJCQl0b29sdGlwRGF0YS50b29sdGlwLmZpbmQoICIudWktdG9vbHRpcC1jb250ZW50IiApLmh0bWwoIGNvbnRlbnQgKTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgd2UgaGF2ZSBhIHRpdGxlLCBjbGVhciBpdCB0byBwcmV2ZW50IHRoZSBuYXRpdmUgdG9vbHRpcAoJCS8vIHdlIGhhdmUgdG8gY2hlY2sgZmlyc3QgdG8gYXZvaWQgZGVmaW5pbmcgYSB0aXRsZSBpZiBub25lIGV4aXN0cwoJCS8vICh3ZSBkb24ndCB3YW50IHRvIGNhdXNlIGFuIGVsZW1lbnQgdG8gc3RhcnQgbWF0Y2hpbmcgW3RpdGxlXSkKCQkvLwoJCS8vIFdlIHVzZSByZW1vdmVBdHRyIG9ubHkgZm9yIGtleSBldmVudHMsIHRvIGFsbG93IElFIHRvIGV4cG9ydCB0aGUgY29ycmVjdAoJCS8vIGFjY2Vzc2libGUgYXR0cmlidXRlcy4gRm9yIG1vdXNlIGV2ZW50cywgc2V0IHRvIGVtcHR5IHN0cmluZyB0byBhdm9pZAoJCS8vIG5hdGl2ZSB0b29sdGlwIHNob3dpbmcgdXAgKGhhcHBlbnMgb25seSB3aGVuIHJlbW92aW5nIGluc2lkZSBtb3VzZW92ZXIpLgoJCWlmICggdGFyZ2V0LmlzKCAiW3RpdGxlXSIgKSApIHsKCQkJaWYgKCBldmVudCAmJiBldmVudC50eXBlID09PSAibW91c2VvdmVyIiApIHsKCQkJCXRhcmdldC5hdHRyKCAidGl0bGUiLCAiIiApOwoJCQl9IGVsc2UgewoJCQkJdGFyZ2V0LnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsKCQkJfQoJCX0KCgkJdG9vbHRpcERhdGEgPSB0aGlzLl90b29sdGlwKCB0YXJnZXQgKTsKCQl0b29sdGlwID0gdG9vbHRpcERhdGEudG9vbHRpcDsKCQl0aGlzLl9hZGREZXNjcmliZWRCeSggdGFyZ2V0LCB0b29sdGlwLmF0dHIoICJpZCIgKSApOwoJCXRvb2x0aXAuZmluZCggIi51aS10b29sdGlwLWNvbnRlbnQiICkuaHRtbCggY29udGVudCApOwoKCQkvLyBTdXBwb3J0OiBWb2ljZW92ZXIgb24gT1MgWCwgSkFXUyBvbiBJRSA8PSA5CgkJLy8gSkFXUyBhbm5vdW5jZXMgZGVsZXRpb25zIGV2ZW4gd2hlbiBhcmlhLXJlbGV2YW50PSJhZGRpdGlvbnMiCgkJLy8gVm9pY2VvdmVyIHdpbGwgc29tZXRpbWVzIHJlLXJlYWQgdGhlIGVudGlyZSBsb2cgcmVnaW9uJ3MgY29udGVudHMgZnJvbSB0aGUgYmVnaW5uaW5nCgkJdGhpcy5saXZlUmVnaW9uLmNoaWxkcmVuKCkuaGlkZSgpOwoJCWExMXlDb250ZW50ID0gJCggIjxkaXY+IiApLmh0bWwoIHRvb2x0aXAuZmluZCggIi51aS10b29sdGlwLWNvbnRlbnQiICkuaHRtbCgpICk7CgkJYTExeUNvbnRlbnQucmVtb3ZlQXR0ciggIm5hbWUiICkuZmluZCggIltuYW1lXSIgKS5yZW1vdmVBdHRyKCAibmFtZSIgKTsKCQlhMTF5Q29udGVudC5yZW1vdmVBdHRyKCAiaWQiICkuZmluZCggIltpZF0iICkucmVtb3ZlQXR0ciggImlkIiApOwoJCWExMXlDb250ZW50LmFwcGVuZFRvKCB0aGlzLmxpdmVSZWdpb24gKTsKCgkJZnVuY3Rpb24gcG9zaXRpb24oIGV2ZW50ICkgewoJCQlwb3NpdGlvbk9wdGlvbi5vZiA9IGV2ZW50OwoJCQlpZiAoIHRvb2x0aXAuaXMoICI6aGlkZGVuIiApICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCXRvb2x0aXAucG9zaXRpb24oIHBvc2l0aW9uT3B0aW9uICk7CgkJfQoJCWlmICggdGhpcy5vcHRpb25zLnRyYWNrICYmIGV2ZW50ICYmIC9ebW91c2UvLnRlc3QoIGV2ZW50LnR5cGUgKSApIHsKCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCW1vdXNlbW92ZTogcG9zaXRpb24KCQkJfSApOwoKCQkJLy8gdHJpZ2dlciBvbmNlIHRvIG92ZXJyaWRlIGVsZW1lbnQtcmVsYXRpdmUgcG9zaXRpb25pbmcKCQkJcG9zaXRpb24oIGV2ZW50ICk7CgkJfSBlbHNlIHsKCQkJdG9vbHRpcC5wb3NpdGlvbiggJC5leHRlbmQoIHsKCQkJCW9mOiB0YXJnZXQKCQkJfSwgdGhpcy5vcHRpb25zLnBvc2l0aW9uICkgKTsKCQl9CgoJCXRvb2x0aXAuaGlkZSgpOwoKCQl0aGlzLl9zaG93KCB0b29sdGlwLCB0aGlzLm9wdGlvbnMuc2hvdyApOwoKCQkvLyBIYW5kbGUgdHJhY2tpbmcgdG9vbHRpcHMgdGhhdCBhcmUgc2hvd24gd2l0aCBhIGRlbGF5ICgjODY0NCkuIEFzIHNvb24KCQkvLyBhcyB0aGUgdG9vbHRpcCBpcyB2aXNpYmxlLCBwb3NpdGlvbiB0aGUgdG9vbHRpcCB1c2luZyB0aGUgbW9zdCByZWNlbnQKCQkvLyBldmVudC4KCQkvLyBBZGRzIHRoZSBjaGVjayB0byBhZGQgdGhlIHRpbWVycyBvbmx5IHdoZW4gYm90aCBkZWxheSBhbmQgdHJhY2sgb3B0aW9ucyBhcmUgc2V0ICgjMTQ2ODIpCgkJaWYgKCB0aGlzLm9wdGlvbnMudHJhY2sgJiYgdGhpcy5vcHRpb25zLnNob3cgJiYgdGhpcy5vcHRpb25zLnNob3cuZGVsYXkgKSB7CgkJCWRlbGF5ZWRTaG93ID0gdGhpcy5kZWxheWVkU2hvdyA9IHNldEludGVydmFsKCBmdW5jdGlvbigpIHsKCQkJCWlmICggdG9vbHRpcC5pcyggIjp2aXNpYmxlIiApICkgewoJCQkJCXBvc2l0aW9uKCBwb3NpdGlvbk9wdGlvbi5vZiApOwoJCQkJCWNsZWFySW50ZXJ2YWwoIGRlbGF5ZWRTaG93ICk7CgkJCQl9CgkJCX0sICQuZnguaW50ZXJ2YWwgKTsKCQl9CgoJCXRoaXMuX3RyaWdnZXIoICJvcGVuIiwgZXZlbnQsIHsgdG9vbHRpcDogdG9vbHRpcCB9ICk7Cgl9LAoKCV9yZWdpc3RlckNsb3NlSGFuZGxlcnM6IGZ1bmN0aW9uKCBldmVudCwgdGFyZ2V0ICkgewoJCXZhciBldmVudHMgPSB7CgkJCWtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5FU0NBUEUgKSB7CgkJCQkJdmFyIGZha2VFdmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJCQkJZmFrZUV2ZW50LmN1cnJlbnRUYXJnZXQgPSB0YXJnZXRbIDAgXTsKCQkJCQl0aGlzLmNsb3NlKCBmYWtlRXZlbnQsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX07CgoJCS8vIE9ubHkgYmluZCByZW1vdmUgaGFuZGxlciBmb3IgZGVsZWdhdGVkIHRhcmdldHMuIE5vbi1kZWxlZ2F0ZWQKCQkvLyB0b29sdGlwcyB3aWxsIGhhbmRsZSB0aGlzIGluIGRlc3Ryb3kuCgkJaWYgKCB0YXJnZXRbIDAgXSAhPT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCWV2ZW50cy5yZW1vdmUgPSBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3JlbW92ZVRvb2x0aXAoIHRoaXMuX2ZpbmQoIHRhcmdldCApLnRvb2x0aXAgKTsKCQkJfTsKCQl9CgoJCWlmICggIWV2ZW50IHx8IGV2ZW50LnR5cGUgPT09ICJtb3VzZW92ZXIiICkgewoJCQlldmVudHMubW91c2VsZWF2ZSA9ICJjbG9zZSI7CgkJfQoJCWlmICggIWV2ZW50IHx8IGV2ZW50LnR5cGUgPT09ICJmb2N1c2luIiApIHsKCQkJZXZlbnRzLmZvY3Vzb3V0ID0gImNsb3NlIjsKCQl9CgkJdGhpcy5fb24oIHRydWUsIHRhcmdldCwgZXZlbnRzICk7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRvb2x0aXAsCgkJCXRoYXQgPSB0aGlzLAoJCQl0YXJnZXQgPSAkKCBldmVudCA\/IGV2ZW50LmN1cnJlbnRUYXJnZXQgOiB0aGlzLmVsZW1lbnQgKSwKCQkJdG9vbHRpcERhdGEgPSB0aGlzLl9maW5kKCB0YXJnZXQgKTsKCgkJLy8gVGhlIHRvb2x0aXAgbWF5IGFscmVhZHkgYmUgY2xvc2VkCgkJaWYgKCAhdG9vbHRpcERhdGEgKSB7CgoJCQkvLyBXZSBzZXQgdWktdG9vbHRpcC1vcGVuIGltbWVkaWF0ZWx5IHVwb24gb3BlbiAoaW4gb3BlbigpKSwgYnV0IG9ubHkgc2V0IHRoZQoJCQkvLyBhZGRpdGlvbmFsIGRhdGEgb25jZSB0aGVyZSdzIGFjdHVhbGx5IGNvbnRlbnQgdG8gc2hvdyAoaW4gX29wZW4oKSkuIFNvIGV2ZW4gaWYgdGhlCgkJCS8vIHRvb2x0aXAgZG9lc24ndCBoYXZlIGZ1bGwgZGF0YSwgd2UgYWx3YXlzIHJlbW92ZSB1aS10b29sdGlwLW9wZW4gaW4gY2FzZSB3ZSdyZSBpbgoJCQkvLyB0aGUgcGVyaW9kIGJldHdlZW4gb3BlbigpIGFuZCBfb3BlbigpLgoJCQl0YXJnZXQucmVtb3ZlRGF0YSggInVpLXRvb2x0aXAtb3BlbiIgKTsKCQkJcmV0dXJuOwoJCX0KCgkJdG9vbHRpcCA9IHRvb2x0aXBEYXRhLnRvb2x0aXA7CgoJCS8vIERpc2FibGluZyBjbG9zZXMgdGhlIHRvb2x0aXAsIHNvIHdlIG5lZWQgdG8gdHJhY2sgd2hlbiB3ZSdyZSBjbG9zaW5nCgkJLy8gdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCBpbiBjYXNlIHRoZSB0b29sdGlwIGJlY29tZXMgZGlzYWJsZWQgb24gY2xvc2UKCQlpZiAoIHRvb2x0aXBEYXRhLmNsb3NpbmcgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIENsZWFyIHRoZSBpbnRlcnZhbCBmb3IgZGVsYXllZCB0cmFja2luZyB0b29sdGlwcwoJCWNsZWFySW50ZXJ2YWwoIHRoaXMuZGVsYXllZFNob3cgKTsKCgkJLy8gT25seSBzZXQgdGl0bGUgaWYgd2UgaGFkIG9uZSBiZWZvcmUgKHNlZSBjb21tZW50IGluIF9vcGVuKCkpCgkJLy8gSWYgdGhlIHRpdGxlIGF0dHJpYnV0ZSBoYXMgY2hhbmdlZCBzaW5jZSBvcGVuKCksIGRvbid0IHJlc3RvcmUKCQlpZiAoIHRhcmdldC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSAmJiAhdGFyZ2V0LmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJdGFyZ2V0LmF0dHIoICJ0aXRsZSIsIHRhcmdldC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOwoJCX0KCgkJdGhpcy5fcmVtb3ZlRGVzY3JpYmVkQnkoIHRhcmdldCApOwoKCQl0b29sdGlwRGF0YS5oaWRpbmcgPSB0cnVlOwoJCXRvb2x0aXAuc3RvcCggdHJ1ZSApOwoJCXRoaXMuX2hpZGUoIHRvb2x0aXAsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJdGhhdC5fcmVtb3ZlVG9vbHRpcCggJCggdGhpcyApICk7CgkJfSApOwoKCQl0YXJnZXQucmVtb3ZlRGF0YSggInVpLXRvb2x0aXAtb3BlbiIgKTsKCQl0aGlzLl9vZmYoIHRhcmdldCwgIm1vdXNlbGVhdmUgZm9jdXNvdXQga2V5dXAiICk7CgoJCS8vIFJlbW92ZSAncmVtb3ZlJyBiaW5kaW5nIG9ubHkgb24gZGVsZWdhdGVkIHRhcmdldHMKCQlpZiAoIHRhcmdldFsgMCBdICE9PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJdGhpcy5fb2ZmKCB0YXJnZXQsICJyZW1vdmUiICk7CgkJfQoJCXRoaXMuX29mZiggdGhpcy5kb2N1bWVudCwgIm1vdXNlbW92ZSIgKTsKCgkJaWYgKCBldmVudCAmJiBldmVudC50eXBlID09PSAibW91c2VsZWF2ZSIgKSB7CgkJCSQuZWFjaCggdGhpcy5wYXJlbnRzLCBmdW5jdGlvbiggaWQsIHBhcmVudCApIHsKCQkJCSQoIHBhcmVudC5lbGVtZW50ICkuYXR0ciggInRpdGxlIiwgcGFyZW50LnRpdGxlICk7CgkJCQlkZWxldGUgdGhhdC5wYXJlbnRzWyBpZCBdOwoJCQl9ICk7CgkJfQoKCQl0b29sdGlwRGF0YS5jbG9zaW5nID0gdHJ1ZTsKCQl0aGlzLl90cmlnZ2VyKCAiY2xvc2UiLCBldmVudCwgeyB0b29sdGlwOiB0b29sdGlwIH0gKTsKCQlpZiAoICF0b29sdGlwRGF0YS5oaWRpbmcgKSB7CgkJCXRvb2x0aXBEYXRhLmNsb3NpbmcgPSBmYWxzZTsKCQl9Cgl9LAoKCV90b29sdGlwOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdG9vbHRpcCA9ICQoICI8ZGl2PiIgKS5hdHRyKCAicm9sZSIsICJ0b29sdGlwIiApLAoJCQljb250ZW50ID0gJCggIjxkaXY+IiApLmFwcGVuZFRvKCB0b29sdGlwICksCgkJCWlkID0gdG9vbHRpcC51bmlxdWVJZCgpLmF0dHIoICJpZCIgKTsKCgkJdGhpcy5fYWRkQ2xhc3MoIGNvbnRlbnQsICJ1aS10b29sdGlwLWNvbnRlbnQiICk7CgkJdGhpcy5fYWRkQ2xhc3MoIHRvb2x0aXAsICJ1aS10b29sdGlwIiwgInVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCIgKTsKCgkJdG9vbHRpcC5hcHBlbmRUbyggdGhpcy5fYXBwZW5kVG8oIGVsZW1lbnQgKSApOwoKCQlyZXR1cm4gdGhpcy50b29sdGlwc1sgaWQgXSA9IHsKCQkJZWxlbWVudDogZWxlbWVudCwKCQkJdG9vbHRpcDogdG9vbHRpcAoJCX07Cgl9LAoKCV9maW5kOiBmdW5jdGlvbiggdGFyZ2V0ICkgewoJCXZhciBpZCA9IHRhcmdldC5kYXRhKCAidWktdG9vbHRpcC1pZCIgKTsKCQlyZXR1cm4gaWQgPyB0aGlzLnRvb2x0aXBzWyBpZCBdIDogbnVsbDsKCX0sCgoJX3JlbW92ZVRvb2x0aXA6IGZ1bmN0aW9uKCB0b29sdGlwICkgewoJCXRvb2x0aXAucmVtb3ZlKCk7CgkJZGVsZXRlIHRoaXMudG9vbHRpcHNbIHRvb2x0aXAuYXR0ciggImlkIiApIF07Cgl9LAoKCV9hcHBlbmRUbzogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgZWxlbWVudCA9IHRhcmdldC5jbG9zZXN0KCAiLnVpLWZyb250LCBkaWFsb2ciICk7CgoJCWlmICggIWVsZW1lbnQubGVuZ3RoICkgewoJCQllbGVtZW50ID0gdGhpcy5kb2N1bWVudFsgMCBdLmJvZHk7CgkJfQoKCQlyZXR1cm4gZWxlbWVudDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJLy8gQ2xvc2Ugb3BlbiB0b29sdGlwcwoJCSQuZWFjaCggdGhpcy50b29sdGlwcywgZnVuY3Rpb24oIGlkLCB0b29sdGlwRGF0YSApIHsKCgkJCS8vIERlbGVnYXRlIHRvIGNsb3NlIG1ldGhvZCB0byBoYW5kbGUgY29tbW9uIGNsZWFudXAKCQkJdmFyIGV2ZW50ID0gJC5FdmVudCggImJsdXIiICksCgkJCQllbGVtZW50ID0gdG9vbHRpcERhdGEuZWxlbWVudDsKCQkJZXZlbnQudGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldCA9IGVsZW1lbnRbIDAgXTsKCQkJdGhhdC5jbG9zZSggZXZlbnQsIHRydWUgKTsKCgkJCS8vIFJlbW92ZSBpbW1lZGlhdGVseTsgZGVzdHJveWluZyBhbiBvcGVuIHRvb2x0aXAgZG9lc24ndCB1c2UgdGhlCgkJCS8vIGhpZGUgYW5pbWF0aW9uCgkJCSQoICIjIiArIGlkICkucmVtb3ZlKCk7CgoJCQkvLyBSZXN0b3JlIHRoZSB0aXRsZQoJCQlpZiAoIGVsZW1lbnQuZGF0YSggInVpLXRvb2x0aXAtdGl0bGUiICkgKSB7CgoJCQkJLy8gSWYgdGhlIHRpdGxlIGF0dHJpYnV0ZSBoYXMgY2hhbmdlZCBzaW5jZSBvcGVuKCksIGRvbid0IHJlc3RvcmUKCQkJCWlmICggIWVsZW1lbnQuYXR0ciggInRpdGxlIiApICkgewoJCQkJCWVsZW1lbnQuYXR0ciggInRpdGxlIiwgZWxlbWVudC5kYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKSApOwoJCQkJfQoJCQkJZWxlbWVudC5yZW1vdmVEYXRhKCAidWktdG9vbHRpcC10aXRsZSIgKTsKCQkJfQoJCX0gKTsKCQl0aGlzLmxpdmVSZWdpb24ucmVtb3ZlKCk7Cgl9Cn0gKTsKCi8vIERFUFJFQ0FURUQKLy8gVE9ETzogU3dpdGNoIHJldHVybiBiYWNrIHRvIHdpZGdldCBkZWNsYXJhdGlvbiBhdCB0b3Agb2YgZmlsZSB3aGVuIHRoaXMgaXMgcmVtb3ZlZAppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCgkvLyBCYWNrY29tcGF0IGZvciB0b29sdGlwQ2xhc3Mgb3B0aW9uCgkkLndpZGdldCggInVpLnRvb2x0aXAiLCAkLnVpLnRvb2x0aXAsIHsKCQlvcHRpb25zOiB7CgkJCXRvb2x0aXBDbGFzczogbnVsbAoJCX0sCgkJX3Rvb2x0aXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdG9vbHRpcERhdGEgPSB0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudG9vbHRpcENsYXNzICkgewoJCQkJdG9vbHRpcERhdGEudG9vbHRpcC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLnRvb2x0aXBDbGFzcyApOwoJCQl9CgkJCXJldHVybiB0b29sdGlwRGF0YTsKCQl9Cgl9ICk7Cn0KCnZhciB3aWRnZXRzVG9vbHRpcCA9ICQudWkudG9vbHRpcDsKCgoKCn0pKTs=",
    "size": "520916"
}