{
    "namaFile": "pages\/admin\/menu\/js\/sweetalert2.js",
    "lastUpdate": "2018-03-22+14:09:03.41",
    "contentFile": "LyohCiAqIHN3ZWV0YWxlcnQyIHY1LjMuNQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuCiAqLwooZnVuY3Rpb24oZ2xvYmFsLCBmYWN0b3J5KSB7CiAgICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6CiAgICAgICAgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDoKICAgICAgICAoZ2xvYmFsLlN3ZWV0YWxlcnQyID0gZmFjdG9yeSgpKTsKfSh0aGlzLCBmdW5jdGlvbigpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgc3dhbFByZWZpeCA9ICdzd2FsMi0nCgogICAgdmFyIHByZWZpeCA9IGZ1bmN0aW9uKGl0ZW1zKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHt9CiAgICAgICAgZm9yICh2YXIgaSBpbiBpdGVtcykgewogICAgICAgICAgICByZXN1bHRbaXRlbXNbaV1dID0gc3dhbFByZWZpeCArIGl0ZW1zW2ldCiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQKICAgIH0KCiAgICB2YXIgc3dhbENsYXNzZXMgPSBwcmVmaXgoWwogICAgICAgICdjb250YWluZXInLAogICAgICAgICdpbicsCiAgICAgICAgJ2lvc2ZpeCcsCiAgICAgICAgJ21vZGFsJywKICAgICAgICAnb3ZlcmxheScsCiAgICAgICAgJ2ZhZGUnLAogICAgICAgICdzaG93JywKICAgICAgICAnaGlkZScsCiAgICAgICAgJ25vYW5pbWF0aW9uJywKICAgICAgICAnY2xvc2UnLAogICAgICAgICdjb250ZW50JywKICAgICAgICAnc3BhY2VyJywKICAgICAgICAnY29uZmlybScsCiAgICAgICAgJ2NhbmNlbCcsCiAgICAgICAgJ2ljb24nLAogICAgICAgICdpbWFnZScsCiAgICAgICAgJ2lucHV0JywKICAgICAgICAnZmlsZScsCiAgICAgICAgJ3JhbmdlJywKICAgICAgICAnc2VsZWN0JywKICAgICAgICAncmFkaW8nLAogICAgICAgICdjaGVja2JveCcsCiAgICAgICAgJ3RleHRhcmVhJywKICAgICAgICAnaW5wdXRlcnJvcicsCiAgICAgICAgJ3ZhbGlkYXRpb25lcnJvcicsCiAgICAgICAgJ3Byb2dyZXNzc3RlcHMnLAogICAgICAgICdhY3RpdmVwcm9ncmVzc3N0ZXAnLAogICAgICAgICdwcm9ncmVzc2NpcmNsZScsCiAgICAgICAgJ3Byb2dyZXNzbGluZScsCiAgICAgICAgJ2xvYWRpbmcnLAogICAgICAgICdzdHlsZWQnCiAgICBdKQoKICAgIHZhciBpY29uVHlwZXMgPSBwcmVmaXgoWwogICAgICAgICdzdWNjZXNzJywKICAgICAgICAnd2FybmluZycsCiAgICAgICAgJ2luZm8nLAogICAgICAgICdxdWVzdGlvbicsCiAgICAgICAgJ2Vycm9yJwogICAgXSkKCiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgICB0aXRsZTogJycsCiAgICAgICAgdGV4dDogJycsCiAgICAgICAgaHRtbDogJycsCiAgICAgICAgdHlwZTogbnVsbCwKICAgICAgICBjdXN0b21DbGFzczogJycsCiAgICAgICAgYW5pbWF0aW9uOiB0cnVlLAogICAgICAgIGFsbG93T3V0c2lkZUNsaWNrOiB0cnVlLAogICAgICAgIGFsbG93RXNjYXBlS2V5OiB0cnVlLAogICAgICAgIHNob3dDb25maXJtQnV0dG9uOiB0cnVlLAogICAgICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLAogICAgICAgIHByZUNvbmZpcm06IG51bGwsCiAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6ICdPSycsCiAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiAnIzMwODVkNicsCiAgICAgICAgY29uZmlybUJ1dHRvbkNsYXNzOiBudWxsLAogICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6ICdDYW5jZWwnLAogICAgICAgIGNhbmNlbEJ1dHRvbkNvbG9yOiAnI2FhYScsCiAgICAgICAgY2FuY2VsQnV0dG9uQ2xhc3M6IG51bGwsCiAgICAgICAgYnV0dG9uc1N0eWxpbmc6IHRydWUsCiAgICAgICAgcmV2ZXJzZUJ1dHRvbnM6IGZhbHNlLAogICAgICAgIGZvY3VzQ2FuY2VsOiBmYWxzZSwKICAgICAgICBzaG93Q2xvc2VCdXR0b246IGZhbHNlLAogICAgICAgIHNob3dMb2FkZXJPbkNvbmZpcm06IGZhbHNlLAogICAgICAgIGltYWdlVXJsOiBudWxsLAogICAgICAgIGltYWdlV2lkdGg6IG51bGwsCiAgICAgICAgaW1hZ2VIZWlnaHQ6IG51bGwsCiAgICAgICAgaW1hZ2VDbGFzczogbnVsbCwKICAgICAgICB0aW1lcjogbnVsbCwKICAgICAgICB3aWR0aDogNTAwLAogICAgICAgIHBhZGRpbmc6IDIwLAogICAgICAgIGJhY2tncm91bmQ6ICcjZmZmJywKICAgICAgICBpbnB1dDogbnVsbCwKICAgICAgICBpbnB1dFBsYWNlaG9sZGVyOiAnJywKICAgICAgICBpbnB1dFZhbHVlOiAnJywKICAgICAgICBpbnB1dE9wdGlvbnM6IHt9LAogICAgICAgIGlucHV0QXV0b1RyaW06IHRydWUsCiAgICAgICAgaW5wdXRDbGFzczogbnVsbCwKICAgICAgICBpbnB1dEF0dHJpYnV0ZXM6IHt9LAogICAgICAgIGlucHV0VmFsaWRhdG9yOiBudWxsLAogICAgICAgIHByb2dyZXNzU3RlcHM6IFtdLAogICAgICAgIGN1cnJlbnRQcm9ncmVzc1N0ZXA6IG51bGwsCiAgICAgICAgcHJvZ3Jlc3NTdGVwc0Rpc3RhbmNlOiAnNDBweCcsCiAgICAgICAgb25PcGVuOiBudWxsLAogICAgICAgIG9uQ2xvc2U6IG51bGwKICAgIH0KCiAgICB2YXIgc3dlZXRIVE1MID0gJzxkaXYgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5tb2RhbCArICciIHN0eWxlPSJkaXNwbGF5OiBub25lIiB0YWJJbmRleD0iLTEiPicgKwogICAgICAgICc8dWwgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5wcm9ncmVzc3N0ZXBzICsgJyI+PC91bD4nICsKICAgICAgICAnPGRpdiBjbGFzcz0iJyArIHN3YWxDbGFzc2VzLmljb24gKyAnICcgKyBpY29uVHlwZXMuZXJyb3IgKyAnIj4nICsKICAgICAgICAnPHNwYW4gY2xhc3M9IngtbWFyayI+PHNwYW4gY2xhc3M9ImxpbmUgbGVmdCI+PC9zcGFuPjxzcGFuIGNsYXNzPSJsaW5lIHJpZ2h0Ij48L3NwYW4+PC9zcGFuPicgKwogICAgICAgICc8L2Rpdj4nICsKICAgICAgICAnPGRpdiBjbGFzcz0iJyArIHN3YWxDbGFzc2VzLmljb24gKyAnICcgKyBpY29uVHlwZXMucXVlc3Rpb24gKyAnIj4\/PC9kaXY+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5pY29uICsgJyAnICsgaWNvblR5cGVzLndhcm5pbmcgKyAnIj4hPC9kaXY+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5pY29uICsgJyAnICsgaWNvblR5cGVzLmluZm8gKyAnIj5pPC9kaXY+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5pY29uICsgJyAnICsgaWNvblR5cGVzLnN1Y2Nlc3MgKyAnIj4nICsKICAgICAgICAnPHNwYW4gY2xhc3M9ImxpbmUgdGlwIj48L3NwYW4+IDxzcGFuIGNsYXNzPSJsaW5lIGxvbmciPjwvc3Bhbj4nICsKICAgICAgICAnPGRpdiBjbGFzcz0icGxhY2Vob2xkZXIiPjwvZGl2PiA8ZGl2IGNsYXNzPSJmaXgiPjwvZGl2PicgKwogICAgICAgICc8L2Rpdj4nICsKICAgICAgICAnPGltZyBjbGFzcz0iJyArIHN3YWxDbGFzc2VzLmltYWdlICsgJyI+JyArCiAgICAgICAgJzxoMj48L2gyPicgKwogICAgICAgICc8ZGl2IGNsYXNzPSInICsgc3dhbENsYXNzZXMuY29udGVudCArICciPjwvZGl2PicgKwogICAgICAgICc8aW5wdXQgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5pbnB1dCArICciPicgKwogICAgICAgICc8aW5wdXQgdHlwZT0iZmlsZSIgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5maWxlICsgJyI+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5yYW5nZSArICciPicgKwogICAgICAgICc8b3V0cHV0Pjwvb3V0cHV0PicgKwogICAgICAgICc8aW5wdXQgdHlwZT0icmFuZ2UiPicgKwogICAgICAgICc8L2Rpdj4nICsKICAgICAgICAnPHNlbGVjdCBjbGFzcz0iJyArIHN3YWxDbGFzc2VzLnNlbGVjdCArICciPjwvc2VsZWN0PicgKwogICAgICAgICc8ZGl2IGNsYXNzPSInICsgc3dhbENsYXNzZXMucmFkaW8gKyAnIj48L2Rpdj4nICsKICAgICAgICAnPGxhYmVsIGZvcj0iJyArIHN3YWxDbGFzc2VzLmNoZWNrYm94ICsgJyIgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5jaGVja2JveCArICciPicgKwogICAgICAgICc8aW5wdXQgdHlwZT0iY2hlY2tib3giPicgKwogICAgICAgICc8L2xhYmVsPicgKwogICAgICAgICc8dGV4dGFyZWEgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy50ZXh0YXJlYSArICciPjwvdGV4dGFyZWE+JyArCiAgICAgICAgJzxkaXYgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy52YWxpZGF0aW9uZXJyb3IgKyAnIj48L2Rpdj4nICsKICAgICAgICAnPGhyIGNsYXNzPSInICsgc3dhbENsYXNzZXMuc3BhY2VyICsgJyI+JyArCiAgICAgICAgJzxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iJyArIHN3YWxDbGFzc2VzLmNvbmZpcm0gKyAnIj5PSzwvYnV0dG9uPicgKwogICAgICAgICc8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5jYW5jZWwgKyAnIj5DYW5jZWw8L2J1dHRvbj4nICsKICAgICAgICAnPHNwYW4gY2xhc3M9IicgKyBzd2FsQ2xhc3Nlcy5jbG9zZSArICciPiZ0aW1lczs8L3NwYW4+JyArCiAgICAgICAgJzwvZGl2PicKCiAgICB2YXIgc3dlZXRDb250YWluZXIKCiAgICB2YXIgZXhpc3RpbmdTd2VldENvbnRhaW5lcnMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKHN3YWxDbGFzc2VzLmNvbnRhaW5lcikKCiAgICBpZiAoZXhpc3RpbmdTd2VldENvbnRhaW5lcnMubGVuZ3RoKSB7CiAgICAgICAgc3dlZXRDb250YWluZXIgPSBleGlzdGluZ1N3ZWV0Q29udGFpbmVyc1swXQogICAgfSBlbHNlIHsKICAgICAgICBzd2VldENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICAgICAgc3dlZXRDb250YWluZXIuY2xhc3NOYW1lID0gc3dhbENsYXNzZXMuY29udGFpbmVyCiAgICAgICAgc3dlZXRDb250YWluZXIuaW5uZXJIVE1MID0gc3dlZXRIVE1MCiAgICB9CgogICAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYikgewogICAgICAgICAgICBpZiAoYi5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICBhW2tleV0gPSBiW2tleV0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGEKICAgIH0KCiAgICAvKgogICAgICogU2V0IGhvdmVyLCBhY3RpdmUgYW5kIGZvY3VzLXN0YXRlcyBmb3IgYnV0dG9ucyAoc291cmNlOiBodHRwOi8vd3d3LnNpdGVwb2ludC5jb20vamF2YXNjcmlwdC1nZW5lcmF0ZS1saWdodGVyLWRhcmtlci1jb2xvcikKICAgICAqLwogICAgdmFyIGNvbG9yTHVtaW5hbmNlID0gZnVuY3Rpb24oaGV4LCBsdW0pIHsKICAgICAgICAvLyBWYWxpZGF0ZSBoZXggc3RyaW5nCiAgICAgICAgaGV4ID0gU3RyaW5nKGhleCkucmVwbGFjZSgvW14wLTlhLWZdL2dpLCAnJykKICAgICAgICBpZiAoaGV4Lmxlbmd0aCA8IDYpIHsKICAgICAgICAgICAgaGV4ID0gaGV4WzBdICsgaGV4WzBdICsgaGV4WzFdICsgaGV4WzFdICsgaGV4WzJdICsgaGV4WzJdCiAgICAgICAgfQogICAgICAgIGx1bSA9IGx1bSB8fCAwCgogICAgICAgIC8vIENvbnZlcnQgdG8gZGVjaW1hbCBhbmQgY2hhbmdlIGx1bWlub3NpdHkKICAgICAgICB2YXIgcmdiID0gJyMnCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgICAgICAgdmFyIGMgPSBwYXJzZUludChoZXguc3Vic3RyKGkgKiAyLCAyKSwgMTYpCiAgICAgICAgICAgIGMgPSBNYXRoLnJvdW5kKE1hdGgubWluKE1hdGgubWF4KDAsIGMgKyAoYyAqIGx1bSkpLCAyNTUpKS50b1N0cmluZygxNikKICAgICAgICAgICAgcmdiICs9ICgnMDAnICsgYykuc3Vic3RyKGMubGVuZ3RoKQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJnYgogICAgfQoKICAgIC8vIFJlbWVtYmVyIHN0YXRlIGluIGNhc2VzIHdoZXJlIG9wZW5pbmcgYW5kIGhhbmRsaW5nIGEgbW9kYWwgd2lsbCBmaWRkbGUgd2l0aCBpdC4KICAgIHZhciBzdGF0ZXMgPSB7CiAgICAgICAgcHJldmlvdXNXaW5kb3dLZXlEb3duOiBudWxsLAogICAgICAgIHByZXZpb3VzQWN0aXZlRWxlbWVudDogbnVsbCwKICAgICAgICBwcmV2aW91c0JvZHlQYWRkaW5nOiBudWxsCiAgICB9CgogICAgLyoKICAgICAqIEFkZCBtb2RhbCArIG92ZXJsYXkgdG8gRE9NCiAgICAgKi8KICAgIHZhciBpbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcignU3dlZXRBbGVydDIgcmVxdWlyZXMgZG9jdW1lbnQgdG8gaW5pdGlhbGl6ZScpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShzd2FsQ2xhc3Nlcy5jb250YWluZXIpLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CgogICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc3dlZXRDb250YWluZXIpCgogICAgICAgIHZhciBtb2RhbCA9IGdldE1vZGFsKCkKICAgICAgICB2YXIgaW5wdXQgPSBnZXRDaGlsZEJ5Q2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLmlucHV0KQogICAgICAgIHZhciBmaWxlID0gZ2V0Q2hpbGRCeUNsYXNzKG1vZGFsLCBzd2FsQ2xhc3Nlcy5maWxlKQogICAgICAgIHZhciByYW5nZSA9IG1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy4nICsgc3dhbENsYXNzZXMucmFuZ2UgKyAnIGlucHV0JykKICAgICAgICB2YXIgc2VsZWN0ID0gZ2V0Q2hpbGRCeUNsYXNzKG1vZGFsLCBzd2FsQ2xhc3Nlcy5zZWxlY3QpCiAgICAgICAgdmFyIGNoZWNrYm94ID0gbW9kYWwucXVlcnlTZWxlY3RvcignLicgKyBzd2FsQ2xhc3Nlcy5jaGVja2JveCArICcgaW5wdXQnKQogICAgICAgIHZhciB0ZXh0YXJlYSA9IGdldENoaWxkQnlDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMudGV4dGFyZWEpCgogICAgICAgIGlucHV0Lm9uaW5wdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3dlZXRBbGVydC5yZXNldFZhbGlkYXRpb25FcnJvcigpCiAgICAgICAgfQoKICAgICAgICBpbnB1dC5vbmtleXVwID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCkKICAgICAgICAgICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgICAgICBzd2VldEFsZXJ0LmNsaWNrQ29uZmlybSgpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZpbGUub25jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3dlZXRBbGVydC5yZXNldFZhbGlkYXRpb25FcnJvcigpCiAgICAgICAgfQoKICAgICAgICByYW5nZS5vbmlucHV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHN3ZWV0QWxlcnQucmVzZXRWYWxpZGF0aW9uRXJyb3IoKQogICAgICAgICAgICByYW5nZS5wcmV2aW91c1NpYmxpbmcudmFsdWUgPSByYW5nZS52YWx1ZQogICAgICAgIH0KCiAgICAgICAgcmFuZ2Uub25jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3dlZXRBbGVydC5yZXNldFZhbGlkYXRpb25FcnJvcigpCiAgICAgICAgICAgIHJhbmdlLnByZXZpb3VzU2libGluZy52YWx1ZSA9IHJhbmdlLnZhbHVlCiAgICAgICAgfQoKICAgICAgICBzZWxlY3Qub25jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3dlZXRBbGVydC5yZXNldFZhbGlkYXRpb25FcnJvcigpCiAgICAgICAgfQoKICAgICAgICBjaGVja2JveC5vbmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzd2VldEFsZXJ0LnJlc2V0VmFsaWRhdGlvbkVycm9yKCkKICAgICAgICB9CgogICAgICAgIHRleHRhcmVhLm9uaW5wdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc3dlZXRBbGVydC5yZXNldFZhbGlkYXRpb25FcnJvcigpCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbW9kYWwKICAgIH0KCiAgICAvKgogICAgICogTWFuaXB1bGF0ZSBET00KICAgICAqLwogICAgdmFyIGVsZW1lbnRCeUNsYXNzID0gZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgcmV0dXJuIHN3ZWV0Q29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoJy4nICsgY2xhc3NOYW1lKQogICAgfQoKICAgIHZhciBnZXRNb2RhbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoJy4nICsgc3dhbENsYXNzZXMubW9kYWwpIHx8IGluaXQoKQogICAgfQoKICAgIHZhciBnZXRJY29ucyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBtb2RhbCA9IGdldE1vZGFsKCkKICAgICAgICByZXR1cm4gbW9kYWwucXVlcnlTZWxlY3RvckFsbCgnLicgKyBzd2FsQ2xhc3Nlcy5pY29uKQogICAgfQoKICAgIHZhciBnZXRTcGFjZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZWxlbWVudEJ5Q2xhc3Moc3dhbENsYXNzZXMuc3BhY2VyKQogICAgfQoKICAgIHZhciBnZXRQcm9ncmVzc1N0ZXBzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRCeUNsYXNzKHN3YWxDbGFzc2VzLnByb2dyZXNzc3RlcHMpCiAgICB9CgogICAgdmFyIGdldFZhbGlkYXRpb25FcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBlbGVtZW50QnlDbGFzcyhzd2FsQ2xhc3Nlcy52YWxpZGF0aW9uZXJyb3IpCiAgICB9CgogICAgdmFyIGdldENvbmZpcm1CdXR0b24gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZWxlbWVudEJ5Q2xhc3Moc3dhbENsYXNzZXMuY29uZmlybSkKICAgIH0KCiAgICB2YXIgZ2V0Q2FuY2VsQnV0dG9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRCeUNsYXNzKHN3YWxDbGFzc2VzLmNhbmNlbCkKICAgIH0KCiAgICB2YXIgZ2V0Q2xvc2VCdXR0b24gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZWxlbWVudEJ5Q2xhc3Moc3dhbENsYXNzZXMuY2xvc2UpCiAgICB9CgogICAgdmFyIGdldEZvY3VzYWJsZUVsZW1lbnRzID0gZnVuY3Rpb24oZm9jdXNDYW5jZWwpIHsKICAgICAgICB2YXIgYnV0dG9ucyA9IFtnZXRDb25maXJtQnV0dG9uKCksIGdldENhbmNlbEJ1dHRvbigpXQogICAgICAgIGlmIChmb2N1c0NhbmNlbCkgewogICAgICAgICAgICBidXR0b25zLnJldmVyc2UoKQogICAgICAgIH0KICAgICAgICByZXR1cm4gYnV0dG9ucy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoCiAgICAgICAgICAgIGdldE1vZGFsKCkucXVlcnlTZWxlY3RvckFsbCgnYnV0dG9uOm5vdChbY2xhc3NePScgKyBzd2FsUHJlZml4ICsgJ10pLCBpbnB1dDpub3QoW3R5cGU9aGlkZGVuXSksIHRleHRhcmVhLCBzZWxlY3QnKQogICAgICAgICkpCiAgICB9CgogICAgdmFyIGhhc0NsYXNzID0gZnVuY3Rpb24oZWxlbSwgY2xhc3NOYW1lKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSkKICAgIH0KCiAgICB2YXIgZm9jdXNJbnB1dCA9IGZ1bmN0aW9uKGlucHV0KSB7CiAgICAgICAgaW5wdXQuZm9jdXMoKQoKICAgICAgICAvLyBwbGFjZSBjdXJzb3IgYXQgZW5kIG9mIHRleHQgaW4gdGV4dCBpbnB1dAogICAgICAgIGlmIChpbnB1dC50eXBlICE9PSAnZmlsZScpIHsKICAgICAgICAgICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjM0NTkxNS8xMzMxNDI1CiAgICAgICAgICAgIHZhciB2YWwgPSBpbnB1dC52YWx1ZQogICAgICAgICAgICBpbnB1dC52YWx1ZSA9ICcnCiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gdmFsCiAgICAgICAgfQogICAgfQoKICAgIHZhciBhZGRDbGFzcyA9IGZ1bmN0aW9uKGVsZW0sIGNsYXNzTmFtZSkgewogICAgICAgIGlmICghZWxlbSB8fCAhY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICB2YXIgY2xhc3NlcyA9IGNsYXNzTmFtZS5zcGxpdCgvXHMrLykKICAgICAgICBjbGFzc2VzLmZvckVhY2goZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIGVsZW0uY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpCiAgICAgICAgfSkKICAgIH0KCiAgICB2YXIgcmVtb3ZlQ2xhc3MgPSBmdW5jdGlvbihlbGVtLCBjbGFzc05hbWUpIHsKICAgICAgICBpZiAoIWVsZW0gfHwgIWNsYXNzTmFtZSkgewogICAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgdmFyIGNsYXNzZXMgPSBjbGFzc05hbWUuc3BsaXQoL1xzKy8pCiAgICAgICAgY2xhc3Nlcy5mb3JFYWNoKGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICBlbGVtLmNsYXNzTGlzdC5yZW1vdmUoY2xhc3NOYW1lKQogICAgICAgIH0pCiAgICB9CgogICAgdmFyIGdldENoaWxkQnlDbGFzcyA9IGZ1bmN0aW9uKGVsZW0sIGNsYXNzTmFtZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChoYXNDbGFzcyhlbGVtLmNoaWxkTm9kZXNbaV0sIGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmNoaWxkTm9kZXNbaV0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB2YXIgc2hvdyA9IGZ1bmN0aW9uKGVsZW0sIGRpc3BsYXkpIHsKICAgICAgICBpZiAoIWRpc3BsYXkpIHsKICAgICAgICAgICAgZGlzcGxheSA9ICdibG9jaycKICAgICAgICB9CiAgICAgICAgZWxlbS5zdHlsZS5vcGFjaXR5ID0gJycKICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5CiAgICB9CgogICAgdmFyIGhpZGUgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgZWxlbS5zdHlsZS5vcGFjaXR5ID0gJycKICAgICAgICBlbGVtLnN0eWxlLmRpc3BsYXkgPSAnbm9uZScKICAgIH0KCiAgICB2YXIgZW1wdHkgPSBmdW5jdGlvbihlbGVtKSB7CiAgICAgICAgd2hpbGUgKGVsZW0uZmlyc3RDaGlsZCkgewogICAgICAgICAgICBlbGVtLnJlbW92ZUNoaWxkKGVsZW0uZmlyc3RDaGlsZCkKICAgICAgICB9CiAgICB9CgogICAgLy8gYm9ycm93ZWQgZnJvbSBqcWV1cnkgJChlbGVtKS5pcygnOnZpc2libGUnKSBpbXBsZW1lbnRhdGlvbgogICAgdmFyIGlzVmlzaWJsZSA9IGZ1bmN0aW9uKGVsZW0pIHsKICAgICAgICByZXR1cm4gZWxlbS5vZmZzZXRXaWR0aCB8fCBlbGVtLm9mZnNldEhlaWdodCB8fCBlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoCiAgICB9CgogICAgdmFyIHJlbW92ZVN0eWxlUHJvcGVydHkgPSBmdW5jdGlvbihlbGVtLCBwcm9wZXJ0eSkgewogICAgICAgIGlmIChlbGVtLnN0eWxlLnJlbW92ZVByb3BlcnR5KSB7CiAgICAgICAgICAgIGVsZW0uc3R5bGUucmVtb3ZlUHJvcGVydHkocHJvcGVydHkpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbS5zdHlsZS5yZW1vdmVBdHRyaWJ1dGUocHJvcGVydHkpCiAgICAgICAgfQogICAgfQoKICAgIHZhciBmaXJlQ2xpY2sgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gVGFrZW4gZnJvbSBodHRwOi8vd3d3Lm5vbm9idHJ1c2l2ZS5jb20vMjAxMS8xMS8yOS9wcm9ncmFtYXRpY2FsbHktZmlyZS1jcm9zc2Jyb3dzZXItY2xpY2stZXZlbnQtd2l0aC1qYXZhc2NyaXB0LwogICAgICAgIC8vIFRoZW4gZml4ZWQgZm9yIHRvZGF5J3MgQ2hyb21lIGJyb3dzZXIuCiAgICAgICAgaWYgKHR5cGVvZiBNb3VzZUV2ZW50ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIC8vIFVwLXRvLWRhdGUgYXBwcm9hY2gKICAgICAgICAgICAgdmFyIG1ldnQgPSBuZXcgTW91c2VFdmVudCgnY2xpY2snLCB7CiAgICAgICAgICAgICAgICB2aWV3OiB3aW5kb3csCiAgICAgICAgICAgICAgICBidWJibGVzOiBmYWxzZSwKICAgICAgICAgICAgICAgIGNhbmNlbGFibGU6IHRydWUKICAgICAgICAgICAgfSkKICAgICAgICAgICAgbm9kZS5kaXNwYXRjaEV2ZW50KG1ldnQpCiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5jcmVhdGVFdmVudCkgewogICAgICAgICAgICAvLyBGYWxsYmFjawogICAgICAgICAgICB2YXIgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ01vdXNlRXZlbnRzJykKICAgICAgICAgICAgZXZ0LmluaXRFdmVudCgnY2xpY2snLCBmYWxzZSwgZmFsc2UpCiAgICAgICAgICAgIG5vZGUuZGlzcGF0Y2hFdmVudChldnQpCiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5jcmVhdGVFdmVudE9iamVjdCkgewogICAgICAgICAgICBub2RlLmZpcmVFdmVudCgnb25jbGljaycpCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygbm9kZS5vbmNsaWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIG5vZGUub25jbGljaygpCiAgICAgICAgfQogICAgfQoKICAgIHZhciBzdG9wRXZlbnRQcm9wYWdhdGlvbiA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAvLyBJbiBwYXJ0aWN1bGFyLCBtYWtlIHN1cmUgdGhlIHNwYWNlIGJhciBkb2Vzbid0IHNjcm9sbCB0aGUgbWFpbiB3aW5kb3cuCiAgICAgICAgaWYgKHR5cGVvZiBlLnN0b3BQcm9wYWdhdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpCiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKQogICAgICAgIH0gZWxzZSBpZiAod2luZG93LmV2ZW50ICYmIHdpbmRvdy5ldmVudC5oYXNPd25Qcm9wZXJ0eSgnY2FuY2VsQnViYmxlJykpIHsKICAgICAgICAgICAgd2luZG93LmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWUKICAgICAgICB9CiAgICB9CgogICAgdmFyIGFuaW1hdGlvbkVuZEV2ZW50ID0gKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0ZXN0RWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKQogICAgICAgIHZhciB0cmFuc0VuZEV2ZW50TmFtZXMgPSB7CiAgICAgICAgICAgICdXZWJraXRBbmltYXRpb24nOiAnd2Via2l0QW5pbWF0aW9uRW5kJywKICAgICAgICAgICAgJ09BbmltYXRpb24nOiAnb0FuaW1hdGlvbkVuZCBvYW5pbWF0aW9uZW5kJywKICAgICAgICAgICAgJ21zQW5pbWF0aW9uJzogJ01TQW5pbWF0aW9uRW5kJywKICAgICAgICAgICAgJ2FuaW1hdGlvbic6ICdhbmltYXRpb25lbmQnCiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgaW4gdHJhbnNFbmRFdmVudE5hbWVzKSB7CiAgICAgICAgICAgIGlmICh0cmFuc0VuZEV2ZW50TmFtZXMuaGFzT3duUHJvcGVydHkoaSkgJiYKICAgICAgICAgICAgICAgIHRlc3RFbC5zdHlsZVtpXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJhbnNFbmRFdmVudE5hbWVzW2ldCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZQogICAgfSkoKQoKICAgIC8vIFJlc2V0IHRoZSBwYWdlIHRvIGl0cyBwcmV2aW91cyBzdGF0ZQogICAgdmFyIHJlc2V0UHJldlN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG1vZGFsID0gZ2V0TW9kYWwoKQogICAgICAgIHdpbmRvdy5vbmtleWRvd24gPSBzdGF0ZXMucHJldmlvdXNXaW5kb3dLZXlEb3duCiAgICAgICAgaWYgKHN0YXRlcy5wcmV2aW91c0FjdGl2ZUVsZW1lbnQgJiYgc3RhdGVzLnByZXZpb3VzQWN0aXZlRWxlbWVudC5mb2N1cykgewogICAgICAgICAgICBzdGF0ZXMucHJldmlvdXNBY3RpdmVFbGVtZW50LmZvY3VzKCkKICAgICAgICB9CiAgICAgICAgY2xlYXJUaW1lb3V0KG1vZGFsLnRpbWVvdXQpCiAgICB9CgogICAgLy8gTWVhc3VyZSB3aWR0aCBvZiBzY3JvbGxiYXIKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9qcy9tb2RhbC5qcyNMMjc5LUwyODYKICAgIHZhciBtZWFzdXJlU2Nyb2xsYmFyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNjcm9sbERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICAgICAgc2Nyb2xsRGl2LnN0eWxlLndpZHRoID0gJzUwcHgnCiAgICAgICAgc2Nyb2xsRGl2LnN0eWxlLmhlaWdodCA9ICc1MHB4JwogICAgICAgIHNjcm9sbERpdi5zdHlsZS5vdmVyZmxvdyA9ICdzY3JvbGwnCiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JvbGxEaXYpCiAgICAgICAgdmFyIHNjcm9sbGJhcldpZHRoID0gc2Nyb2xsRGl2Lm9mZnNldFdpZHRoIC0gc2Nyb2xsRGl2LmNsaWVudFdpZHRoCiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JvbGxEaXYpCiAgICAgICAgcmV0dXJuIHNjcm9sbGJhcldpZHRoCiAgICB9CgogICAgLy8gSmF2YVNjcmlwdCBEZWJvdW5jZSBGdW5jdGlvbgogICAgLy8gaHR0cHM6Ly9kYXZpZHdhbHNoLm5hbWUvamF2YXNjcmlwdC1kZWJvdW5jZS1mdW5jdGlvbgogICAgdmFyIGRlYm91bmNlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICAgICAgdmFyIHRpbWVvdXQKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdGhpcwogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cwogICAgICAgICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsCiAgICAgICAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkgZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCkKICAgICAgICAgICAgaWYgKGNhbGxOb3cpIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncykKICAgICAgICB9CiAgICB9CgogICAgdmFyIG1vZGFsUGFyYW1zID0gZXh0ZW5kKHt9LCBkZWZhdWx0UGFyYW1zKQogICAgdmFyIHF1ZXVlID0gW10KICAgIHZhciBzd2FsMk9ic2VydmVyCgogICAgLyoKICAgICAqIFNldCB0eXBlLCB0ZXh0IGFuZCBhY3Rpb25zIG9uIG1vZGFsCiAgICAgKi8KICAgIHZhciBzZXRQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgdmFyIG1vZGFsID0gZ2V0TW9kYWwoKQoKICAgICAgICBmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpIHsKICAgICAgICAgICAgaWYgKCFkZWZhdWx0UGFyYW1zLmhhc093blByb3BlcnR5KHBhcmFtKSAmJiBwYXJhbSAhPT0gJ2V4dHJhUGFyYW1zJykgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdTd2VldEFsZXJ0MjogVW5rbm93biBwYXJhbWV0ZXIgIicgKyBwYXJhbSArICciJykKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gc2V0IG1vZGFsIHdpZHRoIGFuZCBtYXJnaW4tbGVmdAogICAgICAgIG1vZGFsLnN0eWxlLndpZHRoID0gKHR5cGVvZiBwYXJhbXMud2lkdGggPT09ICdudW1iZXInKSA\/IHBhcmFtcy53aWR0aCArICdweCcgOiBwYXJhbXMud2lkdGgKCiAgICAgICAgbW9kYWwuc3R5bGUucGFkZGluZyA9IHBhcmFtcy5wYWRkaW5nICsgJ3B4JwogICAgICAgIG1vZGFsLnN0eWxlLmJhY2tncm91bmQgPSBwYXJhbXMuYmFja2dyb3VuZAoKICAgICAgICB2YXIgJHRpdGxlID0gbW9kYWwucXVlcnlTZWxlY3RvcignaDInKQogICAgICAgIHZhciAkY29udGVudCA9IG1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy4nICsgc3dhbENsYXNzZXMuY29udGVudCkKICAgICAgICB2YXIgJGNvbmZpcm1CdG4gPSBnZXRDb25maXJtQnV0dG9uKCkKICAgICAgICB2YXIgJGNhbmNlbEJ0biA9IGdldENhbmNlbEJ1dHRvbigpCiAgICAgICAgdmFyICRjbG9zZUJ1dHRvbiA9IG1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy4nICsgc3dhbENsYXNzZXMuY2xvc2UpCgogICAgICAgIC8vIFRpdGxlCiAgICAgICAgJHRpdGxlLmlubmVySFRNTCA9IHBhcmFtcy50aXRsZS5zcGxpdCgnXG4nKS5qb2luKCc8YnI+JykKCiAgICAgICAgLy8gQ29udGVudAogICAgICAgIHZhciBpCiAgICAgICAgaWYgKHBhcmFtcy50ZXh0IHx8IHBhcmFtcy5odG1sKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmh0bWwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAkY29udGVudC5pbm5lckhUTUwgPSAnJwogICAgICAgICAgICAgICAgaWYgKDAgaW4gcGFyYW1zLmh0bWwpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIGluIHBhcmFtcy5odG1sOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGNvbnRlbnQuYXBwZW5kQ2hpbGQocGFyYW1zLmh0bWxbaV0uY2xvbmVOb2RlKHRydWUpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJGNvbnRlbnQuYXBwZW5kQ2hpbGQocGFyYW1zLmh0bWwuY2xvbmVOb2RlKHRydWUpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJGNvbnRlbnQuaW5uZXJIVE1MID0gcGFyYW1zLmh0bWwgfHwgKHBhcmFtcy50ZXh0LnNwbGl0KCdcbicpLmpvaW4oJzxicj4nKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBzaG93KCRjb250ZW50KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhpZGUoJGNvbnRlbnQpCiAgICAgICAgfQoKICAgICAgICAvLyBDbG9zZSBidXR0b24KICAgICAgICBpZiAocGFyYW1zLnNob3dDbG9zZUJ1dHRvbikgewogICAgICAgICAgICBzaG93KCRjbG9zZUJ1dHRvbikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoaWRlKCRjbG9zZUJ1dHRvbikKICAgICAgICB9CgogICAgICAgIC8vIEN1c3RvbSBDbGFzcwogICAgICAgIG1vZGFsLmNsYXNzTmFtZSA9IHN3YWxDbGFzc2VzLm1vZGFsCiAgICAgICAgaWYgKHBhcmFtcy5jdXN0b21DbGFzcykgewogICAgICAgICAgICBhZGRDbGFzcyhtb2RhbCwgcGFyYW1zLmN1c3RvbUNsYXNzKQogICAgICAgIH0KCiAgICAgICAgLy8gUHJvZ3Jlc3Mgc3RlcHMKICAgICAgICB2YXIgcHJvZ3Jlc3NTdGVwc0NvbnRhaW5lciA9IGdldFByb2dyZXNzU3RlcHMoKQogICAgICAgIHZhciBjdXJyZW50UHJvZ3Jlc3NTdGVwID0gcGFyc2VJbnQocGFyYW1zLmN1cnJlbnRQcm9ncmVzc1N0ZXAgPT09IG51bGwgPyBzd2VldEFsZXJ0LmdldFF1ZXVlU3RlcCgpIDogcGFyYW1zLmN1cnJlbnRQcm9ncmVzc1N0ZXAsIDEwKQogICAgICAgIGlmIChwYXJhbXMucHJvZ3Jlc3NTdGVwcy5sZW5ndGgpIHsKICAgICAgICAgICAgc2hvdyhwcm9ncmVzc1N0ZXBzQ29udGFpbmVyKQogICAgICAgICAgICBlbXB0eShwcm9ncmVzc1N0ZXBzQ29udGFpbmVyKQogICAgICAgICAgICBpZiAoY3VycmVudFByb2dyZXNzU3RlcCA+PSBwYXJhbXMucHJvZ3Jlc3NTdGVwcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAgICAgICAgICAgICAnU3dlZXRBbGVydDI6IEludmFsaWQgY3VycmVudFByb2dyZXNzU3RlcCBwYXJhbWV0ZXIsIGl0IHNob3VsZCBiZSBsZXNzIHRoYW4gcHJvZ3Jlc3NTdGVwcy5sZW5ndGggJyArCiAgICAgICAgICAgICAgICAgICAgJyhjdXJyZW50UHJvZ3Jlc3NTdGVwIGxpa2UgSlMgYXJyYXlzIHN0YXJ0cyBmcm9tIDApJwogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmFtcy5wcm9ncmVzc1N0ZXBzLmZvckVhY2goZnVuY3Rpb24oc3RlcCwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIHZhciBjaXJjbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpCiAgICAgICAgICAgICAgICBhZGRDbGFzcyhjaXJjbGUsIHN3YWxDbGFzc2VzLnByb2dyZXNzY2lyY2xlKQogICAgICAgICAgICAgICAgY2lyY2xlLmlubmVySFRNTCA9IHN0ZXAKICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gY3VycmVudFByb2dyZXNzU3RlcCkgewogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKGNpcmNsZSwgc3dhbENsYXNzZXMuYWN0aXZlcHJvZ3Jlc3NzdGVwKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJvZ3Jlc3NTdGVwc0NvbnRhaW5lci5hcHBlbmRDaGlsZChjaXJjbGUpCiAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IHBhcmFtcy5wcm9ncmVzc1N0ZXBzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGluZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJykKICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyhsaW5lLCBzd2FsQ2xhc3Nlcy5wcm9ncmVzc2xpbmUpCiAgICAgICAgICAgICAgICAgICAgbGluZS5zdHlsZS53aWR0aCA9IHBhcmFtcy5wcm9ncmVzc1N0ZXBzRGlzdGFuY2UKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc1N0ZXBzQ29udGFpbmVyLmFwcGVuZENoaWxkKGxpbmUpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGlkZShwcm9ncmVzc1N0ZXBzQ29udGFpbmVyKQogICAgICAgIH0KCiAgICAgICAgLy8gSWNvbgogICAgICAgIHZhciBpY29ucyA9IGdldEljb25zKCkKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaWNvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaGlkZShpY29uc1tpXSkKICAgICAgICB9CiAgICAgICAgaWYgKHBhcmFtcy50eXBlKSB7CiAgICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBmYWxzZQogICAgICAgICAgICBmb3IgKHZhciBpY29uVHlwZSBpbiBpY29uVHlwZXMpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJhbXMudHlwZSA9PT0gaWNvblR5cGUpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZFR5cGUgPSB0cnVlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignU3dlZXRBbGVydDI6IFVua25vd24gYWxlcnQgdHlwZTogJyArIHBhcmFtcy50eXBlKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyICRpY29uID0gbW9kYWwucXVlcnlTZWxlY3RvcignLicgKyBzd2FsQ2xhc3Nlcy5pY29uICsgJy4nICsgaWNvblR5cGVzW3BhcmFtcy50eXBlXSkKICAgICAgICAgICAgc2hvdygkaWNvbikKCiAgICAgICAgICAgIC8vIEFuaW1hdGUgaWNvbgogICAgICAgICAgICBzd2l0Y2ggKHBhcmFtcy50eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdzdWNjZXNzJzoKICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcygkaWNvbiwgJ2FuaW1hdGUnKQogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKCRpY29uLnF1ZXJ5U2VsZWN0b3IoJy50aXAnKSwgJ2FuaW1hdGUtc3VjY2Vzcy10aXAnKQogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKCRpY29uLnF1ZXJ5U2VsZWN0b3IoJy5sb25nJyksICdhbmltYXRlLXN1Y2Nlc3MtbG9uZycpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcygkaWNvbiwgJ2FuaW1hdGUtZXJyb3ItaWNvbicpCiAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MoJGljb24ucXVlcnlTZWxlY3RvcignLngtbWFyaycpLCAnYW5pbWF0ZS14LW1hcmsnKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBjYXNlICd3YXJuaW5nJzoKICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcygkaWNvbiwgJ3B1bHNlLXdhcm5pbmcnKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEN1c3RvbSBpbWFnZQogICAgICAgIHZhciAkY3VzdG9tSW1hZ2UgPSBtb2RhbC5xdWVyeVNlbGVjdG9yKCcuJyArIHN3YWxDbGFzc2VzLmltYWdlKQogICAgICAgIGlmIChwYXJhbXMuaW1hZ2VVcmwpIHsKICAgICAgICAgICAgJGN1c3RvbUltYWdlLnNldEF0dHJpYnV0ZSgnc3JjJywgcGFyYW1zLmltYWdlVXJsKQogICAgICAgICAgICBzaG93KCRjdXN0b21JbWFnZSkKCiAgICAgICAgICAgIGlmIChwYXJhbXMuaW1hZ2VXaWR0aCkgewogICAgICAgICAgICAgICAgJGN1c3RvbUltYWdlLnNldEF0dHJpYnV0ZSgnd2lkdGgnLCBwYXJhbXMuaW1hZ2VXaWR0aCkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRjdXN0b21JbWFnZS5yZW1vdmVBdHRyaWJ1dGUoJ3dpZHRoJykKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBhcmFtcy5pbWFnZUhlaWdodCkgewogICAgICAgICAgICAgICAgJGN1c3RvbUltYWdlLnNldEF0dHJpYnV0ZSgnaGVpZ2h0JywgcGFyYW1zLmltYWdlSGVpZ2h0KQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJGN1c3RvbUltYWdlLnJlbW92ZUF0dHJpYnV0ZSgnaGVpZ2h0JykKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGN1c3RvbUltYWdlLmNsYXNzTmFtZSA9IHN3YWxDbGFzc2VzLmltYWdlCiAgICAgICAgICAgIGlmIChwYXJhbXMuaW1hZ2VDbGFzcykgewogICAgICAgICAgICAgICAgYWRkQ2xhc3MoJGN1c3RvbUltYWdlLCBwYXJhbXMuaW1hZ2VDbGFzcykKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhpZGUoJGN1c3RvbUltYWdlKQogICAgICAgIH0KCiAgICAgICAgLy8gQ2FuY2VsIGJ1dHRvbgogICAgICAgIGlmIChwYXJhbXMuc2hvd0NhbmNlbEJ1dHRvbikgewogICAgICAgICAgICAkY2FuY2VsQnRuLnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lLWJsb2NrJwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhpZGUoJGNhbmNlbEJ0bikKICAgICAgICB9CgogICAgICAgIC8vIENvbmZpcm0gYnV0dG9uCiAgICAgICAgaWYgKHBhcmFtcy5zaG93Q29uZmlybUJ1dHRvbikgewogICAgICAgICAgICByZW1vdmVTdHlsZVByb3BlcnR5KCRjb25maXJtQnRuLCAnZGlzcGxheScpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGlkZSgkY29uZmlybUJ0bikKICAgICAgICB9CgogICAgICAgIC8vIEJ1dHRvbnMgc3BhY2VyCiAgICAgICAgdmFyIHNwYWNlciA9IGdldFNwYWNlcigpCiAgICAgICAgaWYgKCFwYXJhbXMuc2hvd0NvbmZpcm1CdXR0b24gJiYgIXBhcmFtcy5zaG93Q2FuY2VsQnV0dG9uKSB7CiAgICAgICAgICAgIGhpZGUoc3BhY2VyKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNob3coc3BhY2VyKQogICAgICAgIH0KCiAgICAgICAgLy8gRWRpdCB0ZXh0IG9uIGNhbmNlbCBhbmQgY29uZmlybSBidXR0b25zCiAgICAgICAgJGNvbmZpcm1CdG4uaW5uZXJIVE1MID0gcGFyYW1zLmNvbmZpcm1CdXR0b25UZXh0CiAgICAgICAgJGNhbmNlbEJ0bi5pbm5lckhUTUwgPSBwYXJhbXMuY2FuY2VsQnV0dG9uVGV4dAoKICAgICAgICAvLyBTZXQgYnV0dG9ucyB0byBzZWxlY3RlZCBiYWNrZ3JvdW5kIGNvbG9ycwogICAgICAgIGlmIChwYXJhbXMuYnV0dG9uc1N0eWxpbmcpIHsKICAgICAgICAgICAgJGNvbmZpcm1CdG4uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gcGFyYW1zLmNvbmZpcm1CdXR0b25Db2xvcgogICAgICAgICAgICAkY2FuY2VsQnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHBhcmFtcy5jYW5jZWxCdXR0b25Db2xvcgogICAgICAgIH0KCiAgICAgICAgLy8gQWRkIGJ1dHRvbnMgY3VzdG9tIGNsYXNzZXMKICAgICAgICAkY29uZmlybUJ0bi5jbGFzc05hbWUgPSBzd2FsQ2xhc3Nlcy5jb25maXJtCiAgICAgICAgYWRkQ2xhc3MoJGNvbmZpcm1CdG4sIHBhcmFtcy5jb25maXJtQnV0dG9uQ2xhc3MpCiAgICAgICAgJGNhbmNlbEJ0bi5jbGFzc05hbWUgPSBzd2FsQ2xhc3Nlcy5jYW5jZWwKICAgICAgICBhZGRDbGFzcygkY2FuY2VsQnRuLCBwYXJhbXMuY2FuY2VsQnV0dG9uQ2xhc3MpCgogICAgICAgIC8vIEJ1dHRvbnMgc3R5bGluZwogICAgICAgIGlmIChwYXJhbXMuYnV0dG9uc1N0eWxpbmcpIHsKICAgICAgICAgICAgYWRkQ2xhc3MoJGNvbmZpcm1CdG4sIHN3YWxDbGFzc2VzLnN0eWxlZCkKICAgICAgICAgICAgYWRkQ2xhc3MoJGNhbmNlbEJ0biwgc3dhbENsYXNzZXMuc3R5bGVkKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbW92ZUNsYXNzKCRjb25maXJtQnRuLCBzd2FsQ2xhc3Nlcy5zdHlsZWQpCiAgICAgICAgICAgIHJlbW92ZUNsYXNzKCRjYW5jZWxCdG4sIHN3YWxDbGFzc2VzLnN0eWxlZCkKCiAgICAgICAgICAgICRjb25maXJtQnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICRjb25maXJtQnRuLnN0eWxlLmJvcmRlckxlZnRDb2xvciA9ICRjb25maXJtQnRuLnN0eWxlLmJvcmRlclJpZ2h0Q29sb3IgPSAnJwogICAgICAgICAgICAkY2FuY2VsQnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICRjYW5jZWxCdG4uc3R5bGUuYm9yZGVyTGVmdENvbG9yID0gJGNhbmNlbEJ0bi5zdHlsZS5ib3JkZXJSaWdodENvbG9yID0gJycKICAgICAgICB9CgogICAgICAgIC8vIENTUyBhbmltYXRpb24KICAgICAgICBpZiAocGFyYW1zLmFuaW1hdGlvbiA9PT0gdHJ1ZSkgewogICAgICAgICAgICByZW1vdmVDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMubm9hbmltYXRpb24pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYWRkQ2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLm5vYW5pbWF0aW9uKQogICAgICAgIH0KICAgIH0KCiAgICAvKgogICAgICogQW5pbWF0aW9ucwogICAgICovCiAgICB2YXIgb3Blbk1vZGFsID0gZnVuY3Rpb24oYW5pbWF0aW9uLCBvbkNvbXBsZXRlKSB7CiAgICAgICAgdmFyIG1vZGFsID0gZ2V0TW9kYWwoKQogICAgICAgIGlmIChhbmltYXRpb24pIHsKICAgICAgICAgICAgYWRkQ2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLnNob3cpCiAgICAgICAgICAgIGFkZENsYXNzKHN3ZWV0Q29udGFpbmVyLCBzd2FsQ2xhc3Nlcy5mYWRlKQogICAgICAgICAgICByZW1vdmVDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMuaGlkZSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZW1vdmVDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMuZmFkZSkKICAgICAgICB9CiAgICAgICAgc2hvdyhtb2RhbCkKCiAgICAgICAgLy8gc2Nyb2xsaW5nIGlzICdoaWRkZW4nIHVudGlsIGFuaW1hdGlvbiBpcyBkb25lLCBhZnRlciB0aGF0ICdhdXRvJwogICAgICAgIHN3ZWV0Q29udGFpbmVyLnN0eWxlLm92ZXJmbG93WSA9ICdoaWRkZW4nCiAgICAgICAgaWYgKGFuaW1hdGlvbkVuZEV2ZW50ICYmICFoYXNDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMubm9hbmltYXRpb24pKSB7CiAgICAgICAgICAgIG1vZGFsLmFkZEV2ZW50TGlzdGVuZXIoYW5pbWF0aW9uRW5kRXZlbnQsIGZ1bmN0aW9uIHN3YWxDbG9zZUV2ZW50RmluaXNoZWQoKSB7CiAgICAgICAgICAgICAgICBtb2RhbC5yZW1vdmVFdmVudExpc3RlbmVyKGFuaW1hdGlvbkVuZEV2ZW50LCBzd2FsQ2xvc2VFdmVudEZpbmlzaGVkKQogICAgICAgICAgICAgICAgc3dlZXRDb250YWluZXIuc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nCiAgICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dlZXRDb250YWluZXIuc3R5bGUub3ZlcmZsb3dZID0gJ2F1dG8nCiAgICAgICAgfQoKICAgICAgICBhZGRDbGFzcyhzd2VldENvbnRhaW5lciwgc3dhbENsYXNzZXMuaW4pCiAgICAgICAgYWRkQ2xhc3MoZG9jdW1lbnQuYm9keSwgc3dhbENsYXNzZXMuaW4pCiAgICAgICAgZml4U2Nyb2xsYmFyKCkKICAgICAgICBpT1NmaXgoKQogICAgICAgIHN0YXRlcy5wcmV2aW91c0FjdGl2ZUVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50CiAgICAgICAgaWYgKG9uQ29tcGxldGUgIT09IG51bGwgJiYgdHlwZW9mIG9uQ29tcGxldGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgb25Db21wbGV0ZS5jYWxsKHRoaXMsIG1vZGFsKQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBmaXhTY3JvbGxiYXIoKSB7CiAgICAgICAgLy8gZm9yIHF1ZXVlcywgZG8gbm90IGRvIHRoaXMgbW9yZSB0aGFuIG9uY2UKICAgICAgICBpZiAoc3RhdGVzLnByZXZpb3VzQm9keVBhZGRpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIC8vIGlmIHRoZSBib2R5IGhhcyBvdmVyZmxvdwogICAgICAgIGlmIChkb2N1bWVudC5ib2R5LnNjcm9sbEhlaWdodCA+IHdpbmRvdy5pbm5lckhlaWdodCkgewogICAgICAgICAgICAvLyBhZGQgcGFkZGluZyBzbyB0aGUgY29udGVudCBkb2Vzbid0IHNoaWZ0IGFmdGVyIHJlbW92YWwgb2Ygc2Nyb2xsYmFyCiAgICAgICAgICAgIHN0YXRlcy5wcmV2aW91c0JvZHlQYWRkaW5nID0gZG9jdW1lbnQuYm9keS5zdHlsZS5wYWRkaW5nUmlnaHQKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5wYWRkaW5nUmlnaHQgPSBtZWFzdXJlU2Nyb2xsYmFyKCkgKyAncHgnCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHVuZG9TY3JvbGxiYXIoKSB7CiAgICAgICAgaWYgKHN0YXRlcy5wcmV2aW91c0JvZHlQYWRkaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUucGFkZGluZ1JpZ2h0ID0gc3RhdGVzLnByZXZpb3VzQm9keVBhZGRpbmcKICAgICAgICAgICAgc3RhdGVzLnByZXZpb3VzQm9keVBhZGRpbmcgPSBudWxsCiAgICAgICAgfQogICAgfQoKICAgIC8vIEZpeCBpT1Mgc2Nyb2xsaW5nIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xLzM5NjI2MzAyLzEzMzE0MjUKICAgIGZ1bmN0aW9uIGlPU2ZpeCgpIHsKICAgICAgICB2YXIgaU9TID0gL2lQYWR8aVBob25lfGlQb2QvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkgJiYgIXdpbmRvdy5NU1N0cmVhbQogICAgICAgIGlmIChpT1MgJiYgIWhhc0NsYXNzKGRvY3VtZW50LmJvZHksIHN3YWxDbGFzc2VzLmlvc2ZpeCkpIHsKICAgICAgICAgICAgdmFyIG9mZnNldCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wCiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUudG9wID0gKG9mZnNldCAqIC0xKSArICdweCcKICAgICAgICAgICAgYWRkQ2xhc3MoZG9jdW1lbnQuYm9keSwgc3dhbENsYXNzZXMuaW9zZml4KQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiB1bmRvSU9TZml4KCkgewogICAgICAgIGlmIChoYXNDbGFzcyhkb2N1bWVudC5ib2R5LCBzd2FsQ2xhc3Nlcy5pb3NmaXgpKSB7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSBwYXJzZUludChkb2N1bWVudC5ib2R5LnN0eWxlLnRvcCwgMTApCiAgICAgICAgICAgIHJlbW92ZUNsYXNzKGRvY3VtZW50LmJvZHksIHN3YWxDbGFzc2VzLmlvc2ZpeCkKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgPSAob2Zmc2V0ICogLTEpCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1vZGFsRGVwZW5kYW50KCkgewogICAgICAgIGlmIChhcmd1bWVudHNbMF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCdTd2VldEFsZXJ0MiBleHBlY3RzIGF0IGxlYXN0IDEgYXR0cmlidXRlIScpCiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KCiAgICAgICAgdmFyIHBhcmFtcyA9IGV4dGVuZCh7fSwgbW9kYWxQYXJhbXMpCgogICAgICAgIHN3aXRjaCAodHlwZW9mIGFyZ3VtZW50c1swXSkgewoKICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgIHBhcmFtcy50aXRsZSA9IGFyZ3VtZW50c1swXQogICAgICAgICAgICAgICAgcGFyYW1zLnRleHQgPSBhcmd1bWVudHNbMV0gfHwgJycKICAgICAgICAgICAgICAgIHBhcmFtcy50eXBlID0gYXJndW1lbnRzWzJdIHx8ICcnCgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6CiAgICAgICAgICAgICAgICBleHRlbmQocGFyYW1zLCBhcmd1bWVudHNbMF0pCiAgICAgICAgICAgICAgICBwYXJhbXMuZXh0cmFQYXJhbXMgPSBhcmd1bWVudHNbMF0uZXh0cmFQYXJhbXMKCiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmlucHV0ID09PSAnZW1haWwnICYmIHBhcmFtcy5pbnB1dFZhbGlkYXRvciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBhcmFtcy5pbnB1dFZhbGlkYXRvciA9IGZ1bmN0aW9uKGVtYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbWFpbFJlZ2V4ID0gL15bYS16QS1aMC05Ll8tXStAW2EtekEtWjAtOS4tXStcLlthLXpBLVpdezIsNn0kLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVtYWlsUmVnZXgudGVzdChlbWFpbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCdJbnZhbGlkIGVtYWlsIGFkZHJlc3MnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1N3ZWV0QWxlcnQyOiBVbmV4cGVjdGVkIHR5cGUgb2YgYXJndW1lbnQhIEV4cGVjdGVkICJzdHJpbmciIG9yICJvYmplY3QiLCBnb3QgJyArIHR5cGVvZiBhcmd1bWVudHNbMF0pCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CgogICAgICAgIHNldFBhcmFtZXRlcnMocGFyYW1zKQoKICAgICAgICAvLyBNb2RhbCBpbnRlcmFjdGlvbnMKICAgICAgICB2YXIgbW9kYWwgPSBnZXRNb2RhbCgpCgogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgLy8gQ2xvc2Ugb24gdGltZXIKICAgICAgICAgICAgaWYgKHBhcmFtcy50aW1lcikgewogICAgICAgICAgICAgICAgbW9kYWwudGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgc3dlZXRBbGVydC5jbG9zZU1vZGFsKHBhcmFtcy5vbkNsb3NlKQogICAgICAgICAgICAgICAgICAgIHJlamVjdCgndGltZXInKQogICAgICAgICAgICAgICAgfSwgcGFyYW1zLnRpbWVyKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHZXQgaW5wdXQgZWxlbWVudCBieSBzcGVjaWZpZWQgdHlwZSBvciwgaWYgdHlwZSBpc24ndCBzcGVjaWZpZWQsIGJ5IHBhcmFtcy5pbnB1dAogICAgICAgICAgICB2YXIgZ2V0SW5wdXQgPSBmdW5jdGlvbihpbnB1dFR5cGUpIHsKICAgICAgICAgICAgICAgIGlucHV0VHlwZSA9IGlucHV0VHlwZSB8fCBwYXJhbXMuaW5wdXQKICAgICAgICAgICAgICAgIHN3aXRjaCAoaW5wdXRUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKICAgICAgICAgICAgICAgICAgICBjYXNlICd0ZXh0YXJlYSc6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmlsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDaGlsZEJ5Q2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzW2lucHV0VHlwZV0pCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbW9kYWwucXVlcnlTZWxlY3RvcignLicgKyBzd2FsQ2xhc3Nlcy5jaGVja2JveCArICcgaW5wdXQnKQogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JhZGlvJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy4nICsgc3dhbENsYXNzZXMucmFkaW8gKyAnIGlucHV0OmNoZWNrZWQnKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwucXVlcnlTZWxlY3RvcignLicgKyBzd2FsQ2xhc3Nlcy5yYWRpbyArICcgaW5wdXQ6Zmlyc3QtY2hpbGQnKQogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JhbmdlJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1vZGFsLnF1ZXJ5U2VsZWN0b3IoJy4nICsgc3dhbENsYXNzZXMucmFuZ2UgKyAnIGlucHV0JykKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q2hpbGRCeUNsYXNzKG1vZGFsLCBzd2FsQ2xhc3Nlcy5pbnB1dCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2V0IHRoZSB2YWx1ZSBvZiB0aGUgbW9kYWwgaW5wdXQKICAgICAgICAgICAgdmFyIGdldElucHV0VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGdldElucHV0KCkKICAgICAgICAgICAgICAgIGlmICghaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3dpdGNoIChwYXJhbXMuaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdjaGVja2JveCc6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnB1dC5jaGVja2VkID8gMSA6IDAKICAgICAgICAgICAgICAgICAgICBjYXNlICdyYWRpbyc6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnB1dC5jaGVja2VkID8gaW5wdXQudmFsdWUgOiBudWxsCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmlsZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnB1dC5maWxlcy5sZW5ndGggPyBpbnB1dC5maWxlc1swXSA6IG51bGwKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyYW1zLmlucHV0QXV0b1RyaW0gPyBpbnB1dC52YWx1ZS50cmltKCkgOiBpbnB1dC52YWx1ZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpbnB1dCBhdXRvZm9jdXMKICAgICAgICAgICAgaWYgKHBhcmFtcy5pbnB1dCkgewogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSBnZXRJbnB1dCgpCiAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzSW5wdXQoaW5wdXQpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGNvbmZpcm0gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5zaG93TG9hZGVyT25Db25maXJtKSB7CiAgICAgICAgICAgICAgICAgICAgc3dlZXRBbGVydC5zaG93TG9hZGluZygpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5wcmVDb25maXJtKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLnByZUNvbmZpcm0odmFsdWUsIHBhcmFtcy5leHRyYVBhcmFtcykudGhlbigKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24ocHJlQ29uZmlybVZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2VldEFsZXJ0LmNsb3NlTW9kYWwocGFyYW1zLm9uQ2xvc2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHByZUNvbmZpcm1WYWx1ZSB8fCB2YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3ZWV0QWxlcnQuaGlkZUxvYWRpbmcoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dlZXRBbGVydC5zaG93VmFsaWRhdGlvbkVycm9yKGVycm9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzd2VldEFsZXJ0LmNsb3NlTW9kYWwocGFyYW1zLm9uQ2xvc2UpCiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh2YWx1ZSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTW91c2UgaW50ZXJhY3Rpb25zCiAgICAgICAgICAgIHZhciBvbkJ1dHRvbkV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBlID0gZXZlbnQgfHwgd2luZG93LmV2ZW50CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQgfHwgZS5zcmNFbGVtZW50CiAgICAgICAgICAgICAgICB2YXIgY29uZmlybUJ0biA9IGdldENvbmZpcm1CdXR0b24oKQogICAgICAgICAgICAgICAgdmFyIGNhbmNlbEJ0biA9IGdldENhbmNlbEJ1dHRvbigpCiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ZWRDb25maXJtID0gY29uZmlybUJ0biA9PT0gdGFyZ2V0IHx8IGNvbmZpcm1CdG4uY29udGFpbnModGFyZ2V0KQogICAgICAgICAgICAgICAgdmFyIHRhcmdldGVkQ2FuY2VsID0gY2FuY2VsQnRuID09PSB0YXJnZXQgfHwgY2FuY2VsQnRuLmNvbnRhaW5zKHRhcmdldCkKCiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUudHlwZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ21vdXNlb3Zlcic6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbW91c2V1cCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuYnV0dG9uc1N0eWxpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRlZENvbmZpcm0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maXJtQnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yTHVtaW5hbmNlKHBhcmFtcy5jb25maXJtQnV0dG9uQ29sb3IsIC0wLjEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldGVkQ2FuY2VsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsQnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yTHVtaW5hbmNlKHBhcmFtcy5jYW5jZWxCdXR0b25Db2xvciwgLTAuMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNhc2UgJ21vdXNlb3V0JzoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5idXR0b25zU3R5bGluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldGVkQ29uZmlybSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm1CdG4uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gcGFyYW1zLmNvbmZpcm1CdXR0b25Db2xvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRlZENhbmNlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbmNlbEJ0bi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBwYXJhbXMuY2FuY2VsQnV0dG9uQ29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNhc2UgJ21vdXNlZG93bic6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuYnV0dG9uc1N0eWxpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRlZENvbmZpcm0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maXJtQnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yTHVtaW5hbmNlKHBhcmFtcy5jb25maXJtQnV0dG9uQ29sb3IsIC0wLjIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldGVkQ2FuY2VsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsQnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yTHVtaW5hbmNlKHBhcmFtcy5jYW5jZWxCdXR0b25Db2xvciwgLTAuMikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NsaWNrJzoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2xpY2tlZCAnY29uZmlybScKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldGVkQ29uZmlybSAmJiBzd2VldEFsZXJ0LmlzVmlzaWJsZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmlucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0VmFsdWUgPSBnZXRJbnB1dFZhbHVlKCkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5pbnB1dFZhbGlkYXRvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2VldEFsZXJ0LmRpc2FibGVJbnB1dCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcy5pbnB1dFZhbGlkYXRvcihpbnB1dFZhbHVlLCBwYXJhbXMuZXh0cmFQYXJhbXMpLnRoZW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2VldEFsZXJ0LmVuYWJsZUlucHV0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maXJtKGlucHV0VmFsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2VldEFsZXJ0LmVuYWJsZUlucHV0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dlZXRBbGVydC5zaG93VmFsaWRhdGlvbkVycm9yKGVycm9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm0oaW5wdXRWYWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm0odHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDbGlja2VkICdjYW5jZWwnCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0ZWRDYW5jZWwgJiYgc3dlZXRBbGVydC5pc1Zpc2libGUoKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dlZXRBbGVydC5jbG9zZU1vZGFsKHBhcmFtcy5vbkNsb3NlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCdjYW5jZWwnKQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciAkYnV0dG9ucyA9IG1vZGFsLnF1ZXJ5U2VsZWN0b3JBbGwoJ2J1dHRvbicpCiAgICAgICAgICAgIHZhciBpCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCAkYnV0dG9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgJGJ1dHRvbnNbaV0ub25jbGljayA9IG9uQnV0dG9uRXZlbnQKICAgICAgICAgICAgICAgICRidXR0b25zW2ldLm9ubW91c2VvdmVyID0gb25CdXR0b25FdmVudAogICAgICAgICAgICAgICAgJGJ1dHRvbnNbaV0ub25tb3VzZW91dCA9IG9uQnV0dG9uRXZlbnQKICAgICAgICAgICAgICAgICRidXR0b25zW2ldLm9ubW91c2Vkb3duID0gb25CdXR0b25FdmVudAogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbG9zaW5nIG1vZGFsIGJ5IGNsb3NlIGJ1dHRvbgogICAgICAgICAgICBnZXRDbG9zZUJ1dHRvbigpLm9uY2xpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHN3ZWV0QWxlcnQuY2xvc2VNb2RhbChwYXJhbXMub25DbG9zZSkKICAgICAgICAgICAgICAgIHJlamVjdCgnY2xvc2UnKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDbG9zaW5nIG1vZGFsIGJ5IG92ZXJsYXkgY2xpY2sKICAgICAgICAgICAgc3dlZXRDb250YWluZXIub25jbGljayA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldCAhPT0gc3dlZXRDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuYWxsb3dPdXRzaWRlQ2xpY2spIHsKICAgICAgICAgICAgICAgICAgICBzd2VldEFsZXJ0LmNsb3NlTW9kYWwocGFyYW1zLm9uQ2xvc2UpCiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCdvdmVybGF5JykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyICRjb25maXJtQnV0dG9uID0gZ2V0Q29uZmlybUJ1dHRvbigpCiAgICAgICAgICAgIHZhciAkY2FuY2VsQnV0dG9uID0gZ2V0Q2FuY2VsQnV0dG9uKCkKCiAgICAgICAgICAgIC8vIFJldmVyc2UgYnV0dG9ucyBpZiBuZWVkZSBkCiAgICAgICAgICAgIGlmIChwYXJhbXMucmV2ZXJzZUJ1dHRvbnMpIHsKICAgICAgICAgICAgICAgICRjb25maXJtQnV0dG9uLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCRjYW5jZWxCdXR0b24sICRjb25maXJtQnV0dG9uKQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJGNvbmZpcm1CdXR0b24ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoJGNvbmZpcm1CdXR0b24sICRjYW5jZWxCdXR0b24pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEZvY3VzIGhhbmRsaW5nCiAgICAgICAgICAgIGZ1bmN0aW9uIHNldEZvY3VzKGluZGV4LCBpbmNyZW1lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBmb2N1c2FibGVFbGVtZW50cyA9IGdldEZvY3VzYWJsZUVsZW1lbnRzKHBhcmFtcy5mb2N1c0NhbmNlbCkKICAgICAgICAgICAgICAgIC8vIHNlYXJjaCBmb3IgdmlzaWJsZSBlbGVtZW50cyBhbmQgc2VsZWN0IHRoZSBuZXh0IHBvc3NpYmxlIG1hdGNoCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZvY3VzYWJsZUVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBpbmRleCArIGluY3JlbWVudAoKICAgICAgICAgICAgICAgICAgICAvLyByb2xsb3ZlciB0byBmaXJzdCBpdGVtCiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSBmb2N1c2FibGVFbGVtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSAwCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBnbyB0byBsYXN0IGl0ZW0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IGZvY3VzYWJsZUVsZW1lbnRzLmxlbmd0aCAtIDEKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiBlbGVtZW50IGlzIHZpc2libGUKICAgICAgICAgICAgICAgICAgICB2YXIgZWwgPSBmb2N1c2FibGVFbGVtZW50c1tpbmRleF0KICAgICAgICAgICAgICAgICAgICBpZiAoaXNWaXNpYmxlKGVsKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuZm9jdXMoKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlS2V5RG93bihldmVudCkgewogICAgICAgICAgICAgICAgdmFyIGUgPSBldmVudCB8fCB3aW5kb3cuZXZlbnQKICAgICAgICAgICAgICAgIHZhciBrZXlDb2RlID0gZS5rZXlDb2RlIHx8IGUud2hpY2gKCiAgICAgICAgICAgICAgICBpZiAoWzksIDEzLCAzMiwgMjddLmluZGV4T2Yoa2V5Q29kZSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgZG8gd29yayBvbiBrZXlzIHdlIGRvbid0IGNhcmUgYWJvdXQuCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyICR0YXJnZXRFbGVtZW50ID0gZS50YXJnZXQgfHwgZS5zcmNFbGVtZW50CgogICAgICAgICAgICAgICAgdmFyIGZvY3VzYWJsZUVsZW1lbnRzID0gZ2V0Rm9jdXNhYmxlRWxlbWVudHMocGFyYW1zLmZvY3VzQ2FuY2VsKQogICAgICAgICAgICAgICAgdmFyIGJ0bkluZGV4ID0gLTEgLy8gRmluZCB0aGUgYnV0dG9uIC0gbm90ZSwgdGhpcyBpcyBhIG5vZGVsaXN0LCBub3QgYW4gYXJyYXkuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZvY3VzYWJsZUVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCR0YXJnZXRFbGVtZW50ID09PSBmb2N1c2FibGVFbGVtZW50c1tpXSkgewogICAgICAgICAgICAgICAgICAgICAgICBidG5JbmRleCA9IGkKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gVEFCCiAgICAgICAgICAgICAgICBpZiAoa2V5Q29kZSA9PT0gOSkgewogICAgICAgICAgICAgICAgICAgIGlmICghZS5zaGlmdEtleSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDeWNsZSB0byB0aGUgbmV4dCBidXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgc2V0Rm9jdXMoYnRuSW5kZXgsIDEpCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3ljbGUgdG8gdGhlIHByZXYgYnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIHNldEZvY3VzKGJ0bkluZGV4LCAtMSkKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHN0b3BFdmVudFByb3BhZ2F0aW9uKGUpCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChrZXlDb2RlID09PSAxMyB8fCBrZXlDb2RlID09PSAzMikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnRuSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFTlRFUi9TUEFDRSBjbGlja2VkIG91dHNpZGUgb2YgYSBidXR0b24uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmZvY3VzQ2FuY2VsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUNsaWNrKCRjYW5jZWxCdXR0b24sIGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcmVDbGljaygkY29uZmlybUJ1dHRvbiwgZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5Q29kZSA9PT0gMjcgJiYgcGFyYW1zLmFsbG93RXNjYXBlS2V5ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3ZWV0QWxlcnQuY2xvc2VNb2RhbChwYXJhbXMub25DbG9zZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCdlc2MnKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3RhdGVzLnByZXZpb3VzV2luZG93S2V5RG93biA9IHdpbmRvdy5vbmtleWRvd24KICAgICAgICAgICAgd2luZG93Lm9ua2V5ZG93biA9IGhhbmRsZUtleURvd24KCiAgICAgICAgICAgIC8vIExvYWRpbmcgc3RhdGUKICAgICAgICAgICAgaWYgKHBhcmFtcy5idXR0b25zU3R5bGluZykgewogICAgICAgICAgICAgICAgJGNvbmZpcm1CdXR0b24uc3R5bGUuYm9yZGVyTGVmdENvbG9yID0gcGFyYW1zLmNvbmZpcm1CdXR0b25Db2xvcgogICAgICAgICAgICAgICAgJGNvbmZpcm1CdXR0b24uc3R5bGUuYm9yZGVyUmlnaHRDb2xvciA9IHBhcmFtcy5jb25maXJtQnV0dG9uQ29sb3IKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFNob3cgc3Bpbm5lciBpbnN0ZWFkIG9mIENvbmZpcm0gYnV0dG9uIGFuZCBkaXNhYmxlIENhbmNlbCBidXR0b24KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuc2hvd0xvYWRpbmcgPSBzd2VldEFsZXJ0LmVuYWJsZUxvYWRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNob3coZ2V0U3BhY2VyKCkpCiAgICAgICAgICAgICAgICBzaG93KCRjb25maXJtQnV0dG9uLCAnaW5saW5lLWJsb2NrJykKICAgICAgICAgICAgICAgIGFkZENsYXNzKCRjb25maXJtQnV0dG9uLCBzd2FsQ2xhc3Nlcy5sb2FkaW5nKQogICAgICAgICAgICAgICAgYWRkQ2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLmxvYWRpbmcpCiAgICAgICAgICAgICAgICAkY29uZmlybUJ1dHRvbi5kaXNhYmxlZCA9IHRydWUKICAgICAgICAgICAgICAgICRjYW5jZWxCdXR0b24uZGlzYWJsZWQgPSB0cnVlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBTaG93IHNwaW5uZXIgaW5zdGVhZCBvZiBDb25maXJtIGJ1dHRvbiBhbmQgZGlzYWJsZSBDYW5jZWwgYnV0dG9uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzd2VldEFsZXJ0LmhpZGVMb2FkaW5nID0gc3dlZXRBbGVydC5kaXNhYmxlTG9hZGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCFwYXJhbXMuc2hvd0NvbmZpcm1CdXR0b24pIHsKICAgICAgICAgICAgICAgICAgICBoaWRlKCRjb25maXJtQnV0dG9uKQogICAgICAgICAgICAgICAgICAgIGlmICghcGFyYW1zLnNob3dDYW5jZWxCdXR0b24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGlkZShnZXRTcGFjZXIoKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcygkY29uZmlybUJ1dHRvbiwgc3dhbENsYXNzZXMubG9hZGluZykKICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKG1vZGFsLCBzd2FsQ2xhc3Nlcy5sb2FkaW5nKQogICAgICAgICAgICAgICAgJGNvbmZpcm1CdXR0b24uZGlzYWJsZWQgPSBmYWxzZQogICAgICAgICAgICAgICAgJGNhbmNlbEJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuZW5hYmxlQnV0dG9ucyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGNvbmZpcm1CdXR0b24uZGlzYWJsZWQgPSBmYWxzZQogICAgICAgICAgICAgICAgJGNhbmNlbEJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuZGlzYWJsZUJ1dHRvbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRjb25maXJtQnV0dG9uLmRpc2FibGVkID0gdHJ1ZQogICAgICAgICAgICAgICAgJGNhbmNlbEJ1dHRvbi5kaXNhYmxlZCA9IHRydWUKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dlZXRBbGVydC5lbmFibGVDb25maXJtQnV0dG9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkY29uZmlybUJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuZGlzYWJsZUNvbmZpcm1CdXR0b24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRjb25maXJtQnV0dG9uLmRpc2FibGVkID0gdHJ1ZQogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2VldEFsZXJ0LmVuYWJsZUlucHV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSBnZXRJbnB1dCgpCiAgICAgICAgICAgICAgICBpZiAoIWlucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5wdXQudHlwZSA9PT0gJ3JhZGlvJykgewogICAgICAgICAgICAgICAgICAgIHZhciByYWRpb3NDb250YWluZXIgPSBpbnB1dC5wYXJlbnROb2RlLnBhcmVudE5vZGUKICAgICAgICAgICAgICAgICAgICB2YXIgcmFkaW9zID0gcmFkaW9zQ29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0JykKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJhZGlvcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICByYWRpb3NbaV0uZGlzYWJsZWQgPSBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQuZGlzYWJsZWQgPSBmYWxzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2VldEFsZXJ0LmRpc2FibGVJbnB1dCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZ2V0SW5wdXQoKQogICAgICAgICAgICAgICAgaWYgKCFpbnB1dCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGlucHV0ICYmIGlucHV0LnR5cGUgPT09ICdyYWRpbycpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmFkaW9zQ29udGFpbmVyID0gaW5wdXQucGFyZW50Tm9kZS5wYXJlbnROb2RlCiAgICAgICAgICAgICAgICAgICAgdmFyIHJhZGlvcyA9IHJhZGlvc0NvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dCcpCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYWRpb3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW9zW2ldLmRpc2FibGVkID0gdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXQuZGlzYWJsZWQgPSB0cnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNldCBtb2RhbCBtaW4taGVpZ2h0IHRvIGRpc2FibGUgc2Nyb2xsaW5nIGluc2lkZSB0aGUgbW9kYWwKICAgICAgICAgICAgc3dlZXRBbGVydC5yZWNhbGN1bGF0ZUhlaWdodCA9IGRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIG1vZGFsID0gZ2V0TW9kYWwoKQogICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IG1vZGFsLnN0eWxlLmRpc3BsYXkKICAgICAgICAgICAgICAgIG1vZGFsLnN0eWxlLm1pbkhlaWdodCA9ICcnCiAgICAgICAgICAgICAgICBzaG93KG1vZGFsKQogICAgICAgICAgICAgICAgbW9kYWwuc3R5bGUubWluSGVpZ2h0ID0gKG1vZGFsLnNjcm9sbEhlaWdodCArIDEpICsgJ3B4JwogICAgICAgICAgICAgICAgbW9kYWwuc3R5bGUuZGlzcGxheSA9IHByZXZTdGF0ZQogICAgICAgICAgICB9LCA1MCkKCiAgICAgICAgICAgIC8vIFNob3cgYmxvY2sgd2l0aCB2YWxpZGF0aW9uIGVycm9yCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuc2hvd1ZhbGlkYXRpb25FcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdGlvbkVycm9yID0gZ2V0VmFsaWRhdGlvbkVycm9yKCkKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25FcnJvci5pbm5lckhUTUwgPSBlcnJvcgogICAgICAgICAgICAgICAgc2hvdyh2YWxpZGF0aW9uRXJyb3IpCgogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZ2V0SW5wdXQoKQogICAgICAgICAgICAgICAgZm9jdXNJbnB1dChpbnB1dCkKICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0LCBzd2FsQ2xhc3Nlcy5pbnB1dGVycm9yKQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIaWRlIGJsb2NrIHdpdGggdmFsaWRhdGlvbiBlcnJvcgogICAgICAgICAgICBzd2VldEFsZXJ0LnJlc2V0VmFsaWRhdGlvbkVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsaWRhdGlvbkVycm9yID0gZ2V0VmFsaWRhdGlvbkVycm9yKCkKICAgICAgICAgICAgICAgIGhpZGUodmFsaWRhdGlvbkVycm9yKQogICAgICAgICAgICAgICAgc3dlZXRBbGVydC5yZWNhbGN1bGF0ZUhlaWdodCgpCgogICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gZ2V0SW5wdXQoKQogICAgICAgICAgICAgICAgaWYgKGlucHV0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoaW5wdXQsIHN3YWxDbGFzc2VzLmlucHV0ZXJyb3IpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuZ2V0UHJvZ3Jlc3NTdGVwcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmFtcy5wcm9ncmVzc1N0ZXBzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuc2V0UHJvZ3Jlc3NTdGVwcyA9IGZ1bmN0aW9uKHByb2dyZXNzU3RlcHMpIHsKICAgICAgICAgICAgICAgIHBhcmFtcy5wcm9ncmVzc1N0ZXBzID0gcHJvZ3Jlc3NTdGVwcwogICAgICAgICAgICAgICAgc2V0UGFyYW1ldGVycyhwYXJhbXMpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3ZWV0QWxlcnQuc2hvd1Byb2dyZXNzU3RlcHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNob3coZ2V0UHJvZ3Jlc3NTdGVwcygpKQogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2VldEFsZXJ0LmhpZGVQcm9ncmVzc1N0ZXBzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBoaWRlKGdldFByb2dyZXNzU3RlcHMoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dlZXRBbGVydC5lbmFibGVCdXR0b25zKCkKICAgICAgICAgICAgc3dlZXRBbGVydC5oaWRlTG9hZGluZygpCiAgICAgICAgICAgIHN3ZWV0QWxlcnQucmVzZXRWYWxpZGF0aW9uRXJyb3IoKQoKICAgICAgICAgICAgLy8gaW5wdXRzCiAgICAgICAgICAgIHZhciBpbnB1dFR5cGVzID0gWydpbnB1dCcsICdmaWxlJywgJ3JhbmdlJywgJ3NlbGVjdCcsICdyYWRpbycsICdjaGVja2JveCcsICd0ZXh0YXJlYSddCiAgICAgICAgICAgIHZhciBpbnB1dAogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaW5wdXRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGlucHV0Q2xhc3MgPSBzd2FsQ2xhc3Nlc1tpbnB1dFR5cGVzW2ldXQogICAgICAgICAgICAgICAgdmFyIGlucHV0Q29udGFpbmVyID0gZ2V0Q2hpbGRCeUNsYXNzKG1vZGFsLCBpbnB1dENsYXNzKQogICAgICAgICAgICAgICAgaW5wdXQgPSBnZXRJbnB1dChpbnB1dFR5cGVzW2ldKQoKICAgICAgICAgICAgICAgIC8vIHNldCBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICBpZiAoaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqIGluIGlucHV0LmF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LmF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoaikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IGlucHV0LmF0dHJpYnV0ZXNbal0ubmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJOYW1lICE9PSAndHlwZScgJiYgYXR0ck5hbWUgIT09ICd2YWx1ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYXR0ciBpbiBwYXJhbXMuaW5wdXRBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZShhdHRyLCBwYXJhbXMuaW5wdXRBdHRyaWJ1dGVzW2F0dHJdKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzZXQgY2xhc3MKICAgICAgICAgICAgICAgIGlucHV0Q29udGFpbmVyLmNsYXNzTmFtZSA9IGlucHV0Q2xhc3MKICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuaW5wdXRDbGFzcykgewogICAgICAgICAgICAgICAgICAgIGFkZENsYXNzKGlucHV0Q29udGFpbmVyLCBwYXJhbXMuaW5wdXRDbGFzcykKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBoaWRlKGlucHV0Q29udGFpbmVyKQogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcG9wdWxhdGVJbnB1dE9wdGlvbnMKICAgICAgICAgICAgc3dpdGNoIChwYXJhbXMuaW5wdXQpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOgogICAgICAgICAgICAgICAgY2FzZSAnZW1haWwnOgogICAgICAgICAgICAgICAgY2FzZSAncGFzc3dvcmQnOgogICAgICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICAgICAgICAgIGNhc2UgJ3RlbCc6CiAgICAgICAgICAgICAgICAgICAgaW5wdXQgPSBnZXRDaGlsZEJ5Q2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLmlucHV0KQogICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcGFyYW1zLmlucHV0VmFsdWUKICAgICAgICAgICAgICAgICAgICBpbnB1dC5wbGFjZWhvbGRlciA9IHBhcmFtcy5pbnB1dFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9IHBhcmFtcy5pbnB1dAogICAgICAgICAgICAgICAgICAgIHNob3coaW5wdXQpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNhc2UgJ2ZpbGUnOgogICAgICAgICAgICAgICAgICAgIGlucHV0ID0gZ2V0Q2hpbGRCeUNsYXNzKG1vZGFsLCBzd2FsQ2xhc3Nlcy5maWxlKQogICAgICAgICAgICAgICAgICAgIGlucHV0LnBsYWNlaG9sZGVyID0gcGFyYW1zLmlucHV0UGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gcGFyYW1zLmlucHV0CiAgICAgICAgICAgICAgICAgICAgc2hvdyhpbnB1dCkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY2FzZSAncmFuZ2UnOgogICAgICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IGdldENoaWxkQnlDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMucmFuZ2UpCiAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlSW5wdXQgPSByYW5nZS5xdWVyeVNlbGVjdG9yKCdpbnB1dCcpCiAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlT3V0cHV0ID0gcmFuZ2UucXVlcnlTZWxlY3Rvcignb3V0cHV0JykKICAgICAgICAgICAgICAgICAgICByYW5nZUlucHV0LnZhbHVlID0gcGFyYW1zLmlucHV0VmFsdWUKICAgICAgICAgICAgICAgICAgICByYW5nZUlucHV0LnR5cGUgPSBwYXJhbXMuaW5wdXQKICAgICAgICAgICAgICAgICAgICByYW5nZU91dHB1dC52YWx1ZSA9IHBhcmFtcy5pbnB1dFZhbHVlCiAgICAgICAgICAgICAgICAgICAgc2hvdyhyYW5nZSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ID0gZ2V0Q2hpbGRCeUNsYXNzKG1vZGFsLCBzd2FsQ2xhc3Nlcy5zZWxlY3QpCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0LmlubmVySFRNTCA9ICcnCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5pbnB1dFBsYWNlaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLmlubmVySFRNTCA9IHBhcmFtcy5pbnB1dFBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLnZhbHVlID0gJycKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIuZGlzYWJsZWQgPSB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLnNlbGVjdGVkID0gdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QuYXBwZW5kQ2hpbGQocGxhY2Vob2xkZXIpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBvcHVsYXRlSW5wdXRPcHRpb25zID0gZnVuY3Rpb24oaW5wdXRPcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG9wdGlvblZhbHVlIGluIGlucHV0T3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24udmFsdWUgPSBvcHRpb25WYWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uLmlubmVySFRNTCA9IGlucHV0T3B0aW9uc1tvcHRpb25WYWx1ZV0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuaW5wdXRWYWx1ZSA9PT0gb3B0aW9uVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QuYXBwZW5kQ2hpbGQob3B0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3coc2VsZWN0KQogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QuZm9jdXMoKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY2FzZSAncmFkaW8nOgogICAgICAgICAgICAgICAgICAgIHZhciByYWRpbyA9IGdldENoaWxkQnlDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMucmFkaW8pCiAgICAgICAgICAgICAgICAgICAgcmFkaW8uaW5uZXJIVE1MID0gJycKICAgICAgICAgICAgICAgICAgICBwb3B1bGF0ZUlucHV0T3B0aW9ucyA9IGZ1bmN0aW9uKGlucHV0T3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciByYWRpb1ZhbHVlIGluIGlucHV0T3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJhZGlvSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmFkaW9MYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xhYmVsJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByYWRpb0xhYmVsU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW9JbnB1dC50eXBlID0gJ3JhZGlvJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW9JbnB1dC5uYW1lID0gc3dhbENsYXNzZXMucmFkaW8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlvSW5wdXQudmFsdWUgPSByYWRpb1ZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWRpb0lucHV0LmlkID0gc3dhbENsYXNzZXMucmFkaW8gKyAnLScgKyAoaWQrKykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuaW5wdXRWYWx1ZSA9PT0gcmFkaW9WYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlvSW5wdXQuY2hlY2tlZCA9IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlvTGFiZWxTcGFuLmlubmVySFRNTCA9IGlucHV0T3B0aW9uc1tyYWRpb1ZhbHVlXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW9MYWJlbC5hcHBlbmRDaGlsZChyYWRpb0lucHV0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW9MYWJlbC5hcHBlbmRDaGlsZChyYWRpb0xhYmVsU3BhbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlvTGFiZWwuZm9yID0gcmFkaW9JbnB1dC5pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW8uYXBwZW5kQ2hpbGQocmFkaW9MYWJlbCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBzaG93KHJhZGlvKQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmFkaW9zID0gcmFkaW8ucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQnKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmFkaW9zLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFkaW9zWzBdLmZvY3VzKCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOgogICAgICAgICAgICAgICAgICAgIHZhciBjaGVja2JveCA9IGdldENoaWxkQnlDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMuY2hlY2tib3gpCiAgICAgICAgICAgICAgICAgICAgdmFyIGNoZWNrYm94SW5wdXQgPSBnZXRJbnB1dCgnY2hlY2tib3gnKQogICAgICAgICAgICAgICAgICAgIGNoZWNrYm94SW5wdXQudHlwZSA9ICdjaGVja2JveCcKICAgICAgICAgICAgICAgICAgICBjaGVja2JveElucHV0LnZhbHVlID0gMQogICAgICAgICAgICAgICAgICAgIGNoZWNrYm94SW5wdXQuaWQgPSBzd2FsQ2xhc3Nlcy5jaGVja2JveAogICAgICAgICAgICAgICAgICAgIGNoZWNrYm94SW5wdXQuY2hlY2tlZCA9IEJvb2xlYW4ocGFyYW1zLmlucHV0VmFsdWUpCiAgICAgICAgICAgICAgICAgICAgdmFyIGxhYmVsID0gY2hlY2tib3guZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NwYW4nKQogICAgICAgICAgICAgICAgICAgIGlmIChsYWJlbC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tib3gucmVtb3ZlQ2hpbGQobGFiZWxbMF0pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpCiAgICAgICAgICAgICAgICAgICAgbGFiZWwuaW5uZXJIVE1MID0gcGFyYW1zLmlucHV0UGxhY2Vob2xkZXIKICAgICAgICAgICAgICAgICAgICBjaGVja2JveC5hcHBlbmRDaGlsZChsYWJlbCkKICAgICAgICAgICAgICAgICAgICBzaG93KGNoZWNrYm94KQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBjYXNlICd0ZXh0YXJlYSc6CiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHRhcmVhID0gZ2V0Q2hpbGRCeUNsYXNzKG1vZGFsLCBzd2FsQ2xhc3Nlcy50ZXh0YXJlYSkKICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYS52YWx1ZSA9IHBhcmFtcy5pbnB1dFZhbHVlCiAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWEucGxhY2Vob2xkZXIgPSBwYXJhbXMuaW5wdXRQbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgICAgIHNob3codGV4dGFyZWEpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNhc2UgbnVsbDoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdTd2VldEFsZXJ0MjogVW5leHBlY3RlZCB0eXBlIG9mIGlucHV0ISBFeHBlY3RlZCAidGV4dCIgb3IgImVtYWlsIiBvciAicGFzc3dvcmQiLCAic2VsZWN0IiwgImNoZWNrYm94IiwgInRleHRhcmVhIiBvciAiZmlsZSIsIGdvdCAiJyArIHBhcmFtcy5pbnB1dCArICciJykKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGFyYW1zLmlucHV0ID09PSAnc2VsZWN0JyB8fCBwYXJhbXMuaW5wdXQgPT09ICdyYWRpbycpIHsKICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuaW5wdXRPcHRpb25zIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICAgICAgICAgIHN3ZWV0QWxlcnQuc2hvd0xvYWRpbmcoKQogICAgICAgICAgICAgICAgICAgIHBhcmFtcy5pbnB1dE9wdGlvbnMudGhlbihmdW5jdGlvbihpbnB1dE9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dlZXRBbGVydC5oaWRlTG9hZGluZygpCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVsYXRlSW5wdXRPcHRpb25zKGlucHV0T3B0aW9ucykKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFyYW1zLmlucHV0T3B0aW9ucyA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICBwb3B1bGF0ZUlucHV0T3B0aW9ucyhwYXJhbXMuaW5wdXRPcHRpb25zKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdTd2VldEFsZXJ0MjogVW5leHBlY3RlZCB0eXBlIG9mIGlucHV0T3B0aW9ucyEgRXhwZWN0ZWQgb2JqZWN0IG9yIFByb21pc2UsIGdvdCAnICsgdHlwZW9mIHBhcmFtcy5pbnB1dE9wdGlvbnMpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9wZW5Nb2RhbChwYXJhbXMuYW5pbWF0aW9uLCBwYXJhbXMub25PcGVuKQoKICAgICAgICAgICAgLy8gRm9jdXMgdGhlIGZpcnN0IGVsZW1lbnQgKGlucHV0IG9yIGJ1dHRvbikKICAgICAgICAgICAgc2V0Rm9jdXMoLTEsIDEpCgogICAgICAgICAgICAvLyBmaXggc2Nyb2xsCiAgICAgICAgICAgIHN3ZWV0Q29udGFpbmVyLnNjcm9sbFRvcCA9IDAKCiAgICAgICAgICAgIC8vIE9ic2VydmUgY2hhbmdlcyBpbnNpZGUgdGhlIG1vZGFsIGFuZCBhZGp1c3QgaGVpZ2h0CiAgICAgICAgICAgIGlmICh0eXBlb2YgTXV0YXRpb25PYnNlcnZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgIXN3YWwyT2JzZXJ2ZXIpIHsKICAgICAgICAgICAgICAgIHN3YWwyT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihzd2VldEFsZXJ0LnJlY2FsY3VsYXRlSGVpZ2h0KQogICAgICAgICAgICAgICAgc3dhbDJPYnNlcnZlci5vYnNlcnZlKG1vZGFsLCB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgc3VidHJlZTogdHJ1ZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0pCiAgICB9CgogICAgLy8gU3dlZXRBbGVydCBmdW5jdGlvbgogICAgZnVuY3Rpb24gc3dlZXRBbGVydCgpIHsKICAgICAgICAvLyBDb3B5IGFyZ3VtZW50cyB0byB0aGUgbG9jYWwgYXJncyB2YXJpYWJsZQogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzCgogICAgICAgIGlmIChzd2VldEFsZXJ0LmlzVmlzaWJsZSgpKSB7CiAgICAgICAgICAgIHN3ZWV0QWxlcnQuY2xvc2UoKQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1vZGFsRGVwZW5kYW50LmFwcGx5KHRoaXMsIGFyZ3MpCiAgICB9CgogICAgLyoKICAgICAqIEdsb2JhbCBmdW5jdGlvbiB0byBkZXRlcm1pbmUgaWYgc3dhbDIgbW9kYWwgaXMgdmlzaWJsZQogICAgICovCiAgICBzd2VldEFsZXJ0LmlzVmlzaWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBtb2RhbCA9IGdldE1vZGFsKCkKICAgICAgICByZXR1cm4gaXNWaXNpYmxlKG1vZGFsKQogICAgfQoKICAgIC8qCiAgICAgKiBHbG9iYWwgZnVuY3Rpb24gZm9yIGNoYWluaW5nIHN3ZWV0QWxlcnQgbW9kYWxzCiAgICAgKi8KICAgIHN3ZWV0QWxlcnQucXVldWUgPSBmdW5jdGlvbihzdGVwcykgewogICAgICAgIHF1ZXVlID0gc3RlcHMKICAgICAgICB2YXIgbW9kYWwgPSBnZXRNb2RhbCgpCiAgICAgICAgdmFyIHJlc2V0UXVldWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcXVldWUgPSBbXQogICAgICAgICAgICBtb2RhbC5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtcXVldWUtc3RlcCcpCiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgKGZ1bmN0aW9uIHN0ZXAoaSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGlmIChpIDwgcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kYWwuc2V0QXR0cmlidXRlKCdkYXRhLXF1ZXVlLXN0ZXAnLCBpKQoKICAgICAgICAgICAgICAgICAgICBzd2VldEFsZXJ0KHF1ZXVlW2ldKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGVwKGkgKyAxLCBjYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihkaXNtaXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0UXVldWUoKQogICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZGlzbWlzcykKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXNldFF1ZXVlKCkKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkoMCkKICAgICAgICB9KQogICAgfQoKICAgIC8qCiAgICAgKiBHbG9iYWwgZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIGluZGV4IG9mIGN1cnJlbnQgbW9kYWwgaW4gcXVldWUKICAgICAqLwogICAgc3dlZXRBbGVydC5nZXRRdWV1ZVN0ZXAgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0TW9kYWwoKS5nZXRBdHRyaWJ1dGUoJ2RhdGEtcXVldWUtc3RlcCcpCiAgICB9CgogICAgLyoKICAgICAqIEdsb2JhbCBmdW5jdGlvbiBmb3IgaW5zZXJ0aW5nIGEgbW9kYWwgdG8gdGhlIHF1ZXVlCiAgICAgKi8KICAgIHN3ZWV0QWxlcnQuaW5zZXJ0UXVldWVTdGVwID0gZnVuY3Rpb24oc3RlcCwgaW5kZXgpIHsKICAgICAgICBpZiAoaW5kZXggJiYgaW5kZXggPCBxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHF1ZXVlLnNwbGljZShpbmRleCwgMCwgc3RlcCkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHF1ZXVlLnB1c2goc3RlcCkKICAgIH0KCiAgICAvKgogICAgICogR2xvYmFsIGZ1bmN0aW9uIGZvciBkZWxldGluZyBhIG1vZGFsIGZyb20gdGhlIHF1ZXVlCiAgICAgKi8KICAgIHN3ZWV0QWxlcnQuZGVsZXRlUXVldWVTdGVwID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICBpZiAodHlwZW9mIHF1ZXVlW2luZGV4XSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcXVldWUuc3BsaWNlKGluZGV4LCAxKQogICAgICAgIH0KICAgIH0KCiAgICAvKgogICAgICogR2xvYmFsIGZ1bmN0aW9uIHRvIGNsb3NlIHN3ZWV0QWxlcnQKICAgICAqLwogICAgc3dlZXRBbGVydC5jbG9zZSA9IHN3ZWV0QWxlcnQuY2xvc2VNb2RhbCA9IGZ1bmN0aW9uKG9uQ29tcGxldGUpIHsKICAgICAgICB2YXIgbW9kYWwgPSBnZXRNb2RhbCgpCiAgICAgICAgcmVtb3ZlQ2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLnNob3cpCiAgICAgICAgYWRkQ2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLmhpZGUpCgogICAgICAgIC8vIFJlc2V0IGljb24gYW5pbWF0aW9ucwogICAgICAgIHZhciAkc3VjY2Vzc0ljb24gPSBtb2RhbC5xdWVyeVNlbGVjdG9yKCcuJyArIHN3YWxDbGFzc2VzLmljb24gKyAnLicgKyBpY29uVHlwZXMuc3VjY2VzcykKICAgICAgICByZW1vdmVDbGFzcygkc3VjY2Vzc0ljb24sICdhbmltYXRlJykKICAgICAgICByZW1vdmVDbGFzcygkc3VjY2Vzc0ljb24ucXVlcnlTZWxlY3RvcignLnRpcCcpLCAnYW5pbWF0ZS1zdWNjZXNzLXRpcCcpCiAgICAgICAgcmVtb3ZlQ2xhc3MoJHN1Y2Nlc3NJY29uLnF1ZXJ5U2VsZWN0b3IoJy5sb25nJyksICdhbmltYXRlLXN1Y2Nlc3MtbG9uZycpCgogICAgICAgIHZhciAkZXJyb3JJY29uID0gbW9kYWwucXVlcnlTZWxlY3RvcignLicgKyBzd2FsQ2xhc3Nlcy5pY29uICsgJy4nICsgaWNvblR5cGVzLmVycm9yKQogICAgICAgIHJlbW92ZUNsYXNzKCRlcnJvckljb24sICdhbmltYXRlLWVycm9yLWljb24nKQogICAgICAgIHJlbW92ZUNsYXNzKCRlcnJvckljb24ucXVlcnlTZWxlY3RvcignLngtbWFyaycpLCAnYW5pbWF0ZS14LW1hcmsnKQoKICAgICAgICB2YXIgJHdhcm5pbmdJY29uID0gbW9kYWwucXVlcnlTZWxlY3RvcignLicgKyBzd2FsQ2xhc3Nlcy5pY29uICsgJy4nICsgaWNvblR5cGVzLndhcm5pbmcpCiAgICAgICAgcmVtb3ZlQ2xhc3MoJHdhcm5pbmdJY29uLCAncHVsc2Utd2FybmluZycpCgogICAgICAgIHJlc2V0UHJldlN0YXRlKCkKCiAgICAgICAgdmFyIGhpZGVNb2RhbEFuZFJlc2V0U3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaGlkZShtb2RhbCkKICAgICAgICAgICAgbW9kYWwuc3R5bGUubWluSGVpZ2h0ID0gJycKICAgICAgICAgICAgcmVtb3ZlQ2xhc3Moc3dlZXRDb250YWluZXIsIHN3YWxDbGFzc2VzLmluKQogICAgICAgICAgICByZW1vdmVDbGFzcyhkb2N1bWVudC5ib2R5LCBzd2FsQ2xhc3Nlcy5pbikKICAgICAgICAgICAgdW5kb1Njcm9sbGJhcigpCiAgICAgICAgICAgIHVuZG9JT1NmaXgoKQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgYW5pbWF0aW9uIGlzIHN1cHBvcnRlZCwgYW5pbWF0ZQogICAgICAgIGlmIChhbmltYXRpb25FbmRFdmVudCAmJiAhaGFzQ2xhc3MobW9kYWwsIHN3YWxDbGFzc2VzLm5vYW5pbWF0aW9uKSkgewogICAgICAgICAgICBtb2RhbC5hZGRFdmVudExpc3RlbmVyKGFuaW1hdGlvbkVuZEV2ZW50LCBmdW5jdGlvbiBzd2FsQ2xvc2VFdmVudEZpbmlzaGVkKCkgewogICAgICAgICAgICAgICAgbW9kYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihhbmltYXRpb25FbmRFdmVudCwgc3dhbENsb3NlRXZlbnRGaW5pc2hlZCkKICAgICAgICAgICAgICAgIGlmIChoYXNDbGFzcyhtb2RhbCwgc3dhbENsYXNzZXMuaGlkZSkpIHsKICAgICAgICAgICAgICAgICAgICBoaWRlTW9kYWxBbmRSZXNldFN0YXRlKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBPdGhlcndpc2UsIGhpZGUgaW1tZWRpYXRlbHkKICAgICAgICAgICAgaGlkZU1vZGFsQW5kUmVzZXRTdGF0ZSgpCiAgICAgICAgfQogICAgICAgIGlmIChvbkNvbXBsZXRlICE9PSBudWxsICYmIHR5cGVvZiBvbkNvbXBsZXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIG9uQ29tcGxldGUuY2FsbCh0aGlzLCBtb2RhbCkKICAgICAgICB9CiAgICB9CgogICAgLyoKICAgICAqIEdsb2JhbCBmdW5jdGlvbiB0byBjbGljayAnQ29uZmlybScgYnV0dG9uCiAgICAgKi8KICAgIHN3ZWV0QWxlcnQuY2xpY2tDb25maXJtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZ2V0Q29uZmlybUJ1dHRvbigpLmNsaWNrKCkKICAgIH0KCiAgICAvKgogICAgICogR2xvYmFsIGZ1bmN0aW9uIHRvIGNsaWNrICdDYW5jZWwnIGJ1dHRvbgogICAgICovCiAgICBzd2VldEFsZXJ0LmNsaWNrQ2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZ2V0Q2FuY2VsQnV0dG9uKCkuY2xpY2soKQogICAgfQoKICAgIC8qKgogICAgICogU2V0IGRlZmF1bHQgcGFyYW1zIGZvciBlYWNoIHBvcHVwCiAgICAgKiBAcGFyYW0ge09iamVjdH0gdXNlclBhcmFtcwogICAgICovCiAgICBzd2VldEFsZXJ0LnNldERlZmF1bHRzID0gZnVuY3Rpb24odXNlclBhcmFtcykgewogICAgICAgIGlmICghdXNlclBhcmFtcykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3VzZXJQYXJhbXMgaXMgcmVxdWlyZWQnKQogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHVzZXJQYXJhbXMgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndXNlclBhcmFtcyBoYXMgdG8gYmUgYSBvYmplY3QnKQogICAgICAgIH0KCiAgICAgICAgZXh0ZW5kKG1vZGFsUGFyYW1zLCB1c2VyUGFyYW1zKQogICAgfQoKICAgIC8qKgogICAgICogUmVzZXQgZGVmYXVsdCBwYXJhbXMgZm9yIGVhY2ggcG9wdXAKICAgICAqLwogICAgc3dlZXRBbGVydC5yZXNldERlZmF1bHRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbW9kYWxQYXJhbXMgPSBleHRlbmQoe30sIGRlZmF1bHRQYXJhbXMpCiAgICB9CgogICAgc3dlZXRBbGVydC5ub29wID0gZnVuY3Rpb24oKSB7fQoKICAgIHN3ZWV0QWxlcnQudmVyc2lvbiA9ICc1LjMuNScKCiAgICBpZiAodHlwZW9mIFByb21pc2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBQcm9taXNlLnByb3RvdHlwZS5kb25lID0gUHJvbWlzZS5wcm90b3R5cGUuZG9uZSB8fCBmdW5jdGlvbigpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZQogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vIENhdGNoIHByb21pc2UgcmVqZWN0aW9ucyBzaWxlbnRseS4KICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9saW1vbnRlL3N3ZWV0YWxlcnQyL2lzc3Vlcy8xNzcKICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUud2FybignU3dlZXRBbGVydDI6IFBsZWFzZSBpbmx1ZGUgUHJvbWlzZSBwb2x5ZmlsbCBCRUZPUkUgaW5jbHVkaW5nIHN3ZWV0YWxlcnQyLmpzIGlmIElFMTArIHN1cHBvcnQgbmVlZGVkLicpCiAgICB9CgogICAgcmV0dXJuIHN3ZWV0QWxlcnQ7Cgp9KSk7CmlmICh3aW5kb3cuU3dlZXRhbGVydDIpIHdpbmRvdy5zd2VldEFsZXJ0ID0gd2luZG93LnN3YWwgPSB3aW5kb3cuU3dlZXRhbGVydDI7",
    "size": "56499"
}