{
    "namaFile": "pages\/admin\/menu\/assets\/js\/libs\/summernote\/summernote.js",
    "lastUpdate": "2018-03-22+14:24:01.21",
    "contentFile": "LyoqCiAqIFN1cGVyIHNpbXBsZSB3eXNpd3lnIGVkaXRvciBvbiBCb290c3RyYXAgdjAuNi4wCiAqIGh0dHA6Ly9oYWNrZXJ3aW5zLmdpdGh1Yi5pby9zdW1tZXJub3RlLwogKgogKiBzdW1tZXJub3RlLmpzCiAqIENvcHlyaWdodCAyMDEzLTIwMTQgQWxhbiBIb25nLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIHN1bW1lcm5vdGUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuLwogKgogKiBEYXRlOiAyMDE0LTEyLTIzVDIwOjEwWgogKi8KKGZ1bmN0aW9uIChmYWN0b3J5KSB7CiAgLyogZ2xvYmFsIGRlZmluZSAqLwogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KICAgIGRlZmluZShbJ2pxdWVyeSddLCBmYWN0b3J5KTsKICB9IGVsc2UgewogICAgLy8gQnJvd3NlciBnbG9iYWxzOiBqUXVlcnkKICAgIGZhY3Rvcnkod2luZG93LmpRdWVyeSk7CiAgfQp9KGZ1bmN0aW9uICgkKSB7CiAgCgoKICBpZiAoJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIEFycmF5LnByb3RvdHlwZS5yZWR1Y2UpIHsKICAgIC8qKgogICAgICogQXJyYXkucHJvdG90eXBlLnJlZHVjZSBmYWxsYmFjawogICAgICoKICAgICAqIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L1JlZHVjZQogICAgICovCiAgICBBcnJheS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24gKGNhbGxiYWNrLCBvcHRJbml0aWFsVmFsdWUpIHsKICAgICAgdmFyIGlkeCwgdmFsdWUsIGxlbmd0aCA9IHRoaXMubGVuZ3RoID4+PiAwLCBpc1ZhbHVlU2V0ID0gZmFsc2U7CiAgICAgIGlmICgxIDwgYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHZhbHVlID0gb3B0SW5pdGlhbFZhbHVlOwogICAgICAgIGlzVmFsdWVTZXQgPSB0cnVlOwogICAgICB9CiAgICAgIGZvciAoaWR4ID0gMDsgbGVuZ3RoID4gaWR4OyArK2lkeCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KGlkeCkpIHsKICAgICAgICAgIGlmIChpc1ZhbHVlU2V0KSB7CiAgICAgICAgICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUsIHRoaXNbaWR4XSwgaWR4LCB0aGlzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gdGhpc1tpZHhdOwogICAgICAgICAgICBpc1ZhbHVlU2V0ID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFpc1ZhbHVlU2V0KSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH07CiAgfQoKICBpZiAoJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIEFycmF5LnByb3RvdHlwZS5maWx0ZXIpIHsKICAgIEFycmF5LnByb3RvdHlwZS5maWx0ZXIgPSBmdW5jdGlvbiAoZnVuLyosIHRoaXNBcmcqLykgewogICAgICBpZiAodGhpcyA9PT0gdm9pZCAwIHx8IHRoaXMgPT09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIH0KICAKICAgICAgdmFyIHQgPSBPYmplY3QodGhpcyk7CiAgICAgIHZhciBsZW4gPSB0Lmxlbmd0aCA+Pj4gMDsKICAgICAgaWYgKHR5cGVvZiBmdW4gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIH0KICAKICAgICAgdmFyIHJlcyA9IFtdOwogICAgICB2YXIgdGhpc0FyZyA9IGFyZ3VtZW50cy5sZW5ndGggPj0gMiA\/IGFyZ3VtZW50c1sxXSA6IHZvaWQgMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChpIGluIHQpIHsKICAgICAgICAgIHZhciB2YWwgPSB0W2ldOwogICAgICAgICAgaWYgKGZ1bi5jYWxsKHRoaXNBcmcsIHZhbCwgaSwgdCkpIHsKICAgICAgICAgICAgcmVzLnB1c2godmFsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJlczsKICAgIH07CiAgfQoKICB2YXIgaXNTdXBwb3J0QW1kID0gdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kOwoKICAvKioKICAgKiByZXR1cm5zIHdoZXRoZXIgZm9udCBpcyBpbnN0YWxsZWQgb3Igbm90LgogICAqIEBwYXJhbSB7U3RyaW5nfSBmb250TmFtZQogICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICovCiAgdmFyIGlzRm9udEluc3RhbGxlZCA9IGZ1bmN0aW9uIChmb250TmFtZSkgewogICAgdmFyIHRlc3RGb250TmFtZSA9IGZvbnROYW1lID09PSAnQ29taWMgU2FucyBNUycgPyAnQ291cmllciBOZXcnIDogJ0NvbWljIFNhbnMgTVMnOwogICAgdmFyICR0ZXN0ZXIgPSAkKCc8ZGl2PicpLmNzcyh7CiAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICBsZWZ0OiAnLTk5OTlweCcsCiAgICAgIHRvcDogJy05OTk5cHgnLAogICAgICBmb250U2l6ZTogJzIwMHB4JwogICAgfSkudGV4dCgnbW1tbW1tbW1td3d3d3d3dycpLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpOwoKICAgIHZhciBvcmlnaW5hbFdpZHRoID0gJHRlc3Rlci5jc3MoJ2ZvbnRGYW1pbHknLCB0ZXN0Rm9udE5hbWUpLndpZHRoKCk7CiAgICB2YXIgd2lkdGggPSAkdGVzdGVyLmNzcygnZm9udEZhbWlseScsIGZvbnROYW1lICsgJywnICsgdGVzdEZvbnROYW1lKS53aWR0aCgpOwoKICAgICR0ZXN0ZXIucmVtb3ZlKCk7CgogICAgcmV0dXJuIG9yaWdpbmFsV2lkdGggIT09IHdpZHRoOwogIH07CgogIC8qKgogICAqIE9iamVjdCB3aGljaCBjaGVjayBwbGF0Zm9ybSBhbmQgYWdlbnQKICAgKi8KICB2YXIgYWdlbnQgPSB7CiAgICBpc01hYzogbmF2aWdhdG9yLmFwcFZlcnNpb24uaW5kZXhPZignTWFjJykgPiAtMSwKICAgIGlzTVNJRTogbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdNU0lFJykgPiAtMSB8fCBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ1RyaWRlbnQnKSA+IC0xLAogICAgaXNGRjogbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdGaXJlZm94JykgPiAtMSwKICAgIGpxdWVyeVZlcnNpb246IHBhcnNlRmxvYXQoJC5mbi5qcXVlcnkpLAogICAgaXNTdXBwb3J0QW1kOiBpc1N1cHBvcnRBbWQsCiAgICBoYXNDb2RlTWlycm9yOiBpc1N1cHBvcnRBbWQgPyByZXF1aXJlLnNwZWNpZmllZCgnQ29kZU1pcnJvcicpIDogISF3aW5kb3cuQ29kZU1pcnJvciwKICAgIGlzRm9udEluc3RhbGxlZDogaXNGb250SW5zdGFsbGVkLAogICAgaXNXM0NSYW5nZVN1cHBvcnQ6ICEhZG9jdW1lbnQuY3JlYXRlUmFuZ2UKICB9OwoKICAvKioKICAgKiBmdW5jIHV0aWxzIChmb3IgaGlnaC1vcmRlciBmdW5jJ3MgYXJnKQogICAqLwogIHZhciBmdW5jID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBlcSA9IGZ1bmN0aW9uIChpdGVtQSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGl0ZW1CKSB7CiAgICAgICAgcmV0dXJuIGl0ZW1BID09PSBpdGVtQjsKICAgICAgfTsKICAgIH07CgogICAgdmFyIGVxMiA9IGZ1bmN0aW9uIChpdGVtQSwgaXRlbUIpIHsKICAgICAgcmV0dXJuIGl0ZW1BID09PSBpdGVtQjsKICAgIH07CgogICAgdmFyIHBlcTIgPSBmdW5jdGlvbiAocHJvcE5hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChpdGVtQSwgaXRlbUIpIHsKICAgICAgICByZXR1cm4gaXRlbUFbcHJvcE5hbWVdID09PSBpdGVtQltwcm9wTmFtZV07CiAgICAgIH07CiAgICB9OwoKICAgIHZhciBvayA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwoKICAgIHZhciBmYWlsID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIHZhciBub3QgPSBmdW5jdGlvbiAoZikgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAhZi5hcHBseShmLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfTsKCiAgICB2YXIgYW5kID0gZnVuY3Rpb24gKGZBLCBmQikgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICByZXR1cm4gZkEoaXRlbSkgJiYgZkIoaXRlbSk7CiAgICAgIH07CiAgICB9OwoKICAgIHZhciBzZWxmID0gZnVuY3Rpb24gKGEpIHsKICAgICAgcmV0dXJuIGE7CiAgICB9OwoKICAgIHZhciBpZENvdW50ZXIgPSAwOwoKICAgIC8qKgogICAgICogZ2VuZXJhdGUgYSBnbG9iYWxseS11bmlxdWUgaWQKICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gW3ByZWZpeF0KICAgICAqLwogICAgdmFyIHVuaXF1ZUlkID0gZnVuY3Rpb24gKHByZWZpeCkgewogICAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwogICAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIGJuZCAoYm91bmRzKSBmcm9tIHJlY3QKICAgICAqCiAgICAgKiAtIElFIENvbXBhdGFiaWxpdHkgSXNzdWU6IGh0dHA6Ly9nb28uZ2wvc1JMT0FvCiAgICAgKiAtIFNjcm9sbCBJc3N1ZTogaHR0cDovL2dvby5nbC9zTmpVYwogICAgICoKICAgICAqIEBwYXJhbSB7UmVjdH0gcmVjdAogICAgICogQHJldHVybiB7T2JqZWN0fSBib3VuZHMKICAgICAqIEByZXR1cm4ge051bWJlcn0gYm91bmRzLnRvcAogICAgICogQHJldHVybiB7TnVtYmVyfSBib3VuZHMubGVmdAogICAgICogQHJldHVybiB7TnVtYmVyfSBib3VuZHMud2lkdGgKICAgICAqIEByZXR1cm4ge051bWJlcn0gYm91bmRzLmhlaWdodAogICAgICovCiAgICB2YXIgcmVjdDJibmQgPSBmdW5jdGlvbiAocmVjdCkgewogICAgICB2YXIgJGRvY3VtZW50ID0gJChkb2N1bWVudCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdG9wOiByZWN0LnRvcCArICRkb2N1bWVudC5zY3JvbGxUb3AoKSwKICAgICAgICBsZWZ0OiByZWN0LmxlZnQgKyAkZG9jdW1lbnQuc2Nyb2xsTGVmdCgpLAogICAgICAgIHdpZHRoOiByZWN0LnJpZ2h0IC0gcmVjdC5sZWZ0LAogICAgICAgIGhlaWdodDogcmVjdC5ib3R0b20gLSByZWN0LnRvcAogICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2hlcmUgdGhlIGtleXMgaGF2ZSBiZWNvbWUgdGhlIHZhbHVlcyBhbmQgdGhlIHZhbHVlcyB0aGUga2V5cy4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmoKICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAqLwogICAgdmFyIGludmVydE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgdmFyIGludmVydGVkID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIGludmVydGVkW29ialtrZXldXSA9IGtleTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGludmVydGVkOwogICAgfTsKCiAgICByZXR1cm4gewogICAgICBlcTogZXEsCiAgICAgIGVxMjogZXEyLAogICAgICBwZXEyOiBwZXEyLAogICAgICBvazogb2ssCiAgICAgIGZhaWw6IGZhaWwsCiAgICAgIHNlbGY6IHNlbGYsCiAgICAgIG5vdDogbm90LAogICAgICBhbmQ6IGFuZCwKICAgICAgdW5pcXVlSWQ6IHVuaXF1ZUlkLAogICAgICByZWN0MmJuZDogcmVjdDJibmQsCiAgICAgIGludmVydE9iamVjdDogaW52ZXJ0T2JqZWN0CiAgICB9OwogIH0pKCk7CgogIC8qKgogICAqIGxpc3QgdXRpbHMKICAgKi8KICB2YXIgbGlzdCA9IChmdW5jdGlvbiAoKSB7CiAgICAvKioKICAgICAqIHJldHVybnMgdGhlIGZpcnN0IGl0ZW0gb2YgYW4gYXJyYXkuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkKICAgICAqLwogICAgdmFyIGhlYWQgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgICAgcmV0dXJuIGFycmF5WzBdOwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgdGhlIGxhc3QgaXRlbSBvZiBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheQogICAgICovCiAgICB2YXIgbGFzdCA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgICByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyBldmVyeXRoaW5nIGJ1dCB0aGUgbGFzdCBlbnRyeSBvZiB0aGUgYXJyYXkuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkKICAgICAqLwogICAgdmFyIGluaXRpYWwgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgICAgcmV0dXJuIGFycmF5LnNsaWNlKDAsIGFycmF5Lmxlbmd0aCAtIDEpOwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgdGhlIHJlc3Qgb2YgdGhlIGl0ZW1zIGluIGFuIGFycmF5LgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5CiAgICAgKi8KICAgIHZhciB0YWlsID0gZnVuY3Rpb24gKGFycmF5KSB7CiAgICAgIHJldHVybiBhcnJheS5zbGljZSgxKTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIGl0ZW0gb2YgYXJyYXkKICAgICAqLwogICAgdmFyIGZpbmQgPSBmdW5jdGlvbiAoYXJyYXksIHByZWQpIHsKICAgICAgZm9yICh2YXIgaWR4ID0gMCwgbGVuID0gYXJyYXkubGVuZ3RoOyBpZHggPCBsZW47IGlkeCArKykgewogICAgICAgIHZhciBpdGVtID0gYXJyYXlbaWR4XTsKICAgICAgICBpZiAocHJlZChpdGVtKSkgewogICAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyB0cnVlIGlmIGFsbCBvZiB0aGUgdmFsdWVzIGluIHRoZSBhcnJheSBwYXNzIHRoZSBwcmVkaWNhdGUgdHJ1dGggdGVzdC4KICAgICAqLwogICAgdmFyIGFsbCA9IGZ1bmN0aW9uIChhcnJheSwgcHJlZCkgewogICAgICBmb3IgKHZhciBpZHggPSAwLCBsZW4gPSBhcnJheS5sZW5ndGg7IGlkeCA8IGxlbjsgaWR4ICsrKSB7CiAgICAgICAgaWYgKCFwcmVkKGFycmF5W2lkeF0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgdHJ1ZSBpZiB0aGUgdmFsdWUgaXMgcHJlc2VudCBpbiB0aGUgbGlzdC4KICAgICAqLwogICAgdmFyIGNvbnRhaW5zID0gZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CiAgICAgIHJldHVybiAkLmluQXJyYXkoaXRlbSwgYXJyYXkpICE9PSAtMTsKICAgIH07CgogICAgLyoqCiAgICAgKiBnZXQgc3VtIGZyb20gYSBsaXN0CiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgLSBhcnJheQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gLSBpdGVyYXRvcgogICAgICovCiAgICB2YXIgc3VtID0gZnVuY3Rpb24gKGFycmF5LCBmbikgewogICAgICBmbiA9IGZuIHx8IGZ1bmMuc2VsZjsKICAgICAgcmV0dXJuIGFycmF5LnJlZHVjZShmdW5jdGlvbiAobWVtbywgdikgewogICAgICAgIHJldHVybiBtZW1vICsgZm4odik7CiAgICAgIH0sIDApOwogICAgfTsKICAKICAgIC8qKgogICAgICogcmV0dXJucyBhIGNvcHkgb2YgdGhlIGNvbGxlY3Rpb24gd2l0aCBhcnJheSB0eXBlLgogICAgICogQHBhcmFtIHtDb2xsZWN0aW9ufSBjb2xsZWN0aW9uIC0gY29sbGVjdGlvbiBlZykgbm9kZS5jaGlsZE5vZGVzLCAuLi4KICAgICAqLwogICAgdmFyIGZyb20gPSBmdW5jdGlvbiAoY29sbGVjdGlvbikgewogICAgICB2YXIgcmVzdWx0ID0gW10sIGlkeCA9IC0xLCBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKICAgICAgd2hpbGUgKCsraWR4IDwgbGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0W2lkeF0gPSBjb2xsZWN0aW9uW2lkeF07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgCiAgICAvKioKICAgICAqIGNsdXN0ZXIgZWxlbWVudHMgYnkgcHJlZGljYXRlIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IC0gYXJyYXkKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIC0gcHJlZGljYXRlIGZ1bmN0aW9uIGZvciBjbHVzdGVyIHJ1bGUKICAgICAqIEBwYXJhbSB7QXJyYXlbXX0KICAgICAqLwogICAgdmFyIGNsdXN0ZXJCeSA9IGZ1bmN0aW9uIChhcnJheSwgZm4pIHsKICAgICAgaWYgKCFhcnJheS5sZW5ndGgpIHsgcmV0dXJuIFtdOyB9CiAgICAgIHZhciBhVGFpbCA9IHRhaWwoYXJyYXkpOwogICAgICByZXR1cm4gYVRhaWwucmVkdWNlKGZ1bmN0aW9uIChtZW1vLCB2KSB7CiAgICAgICAgdmFyIGFMYXN0ID0gbGFzdChtZW1vKTsKICAgICAgICBpZiAoZm4obGFzdChhTGFzdCksIHYpKSB7CiAgICAgICAgICBhTGFzdFthTGFzdC5sZW5ndGhdID0gdjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWVtb1ttZW1vLmxlbmd0aF0gPSBbdl07CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZW1vOwogICAgICB9LCBbW2hlYWQoYXJyYXkpXV0pOwogICAgfTsKICAKICAgIC8qKgogICAgICogcmV0dXJucyBhIGNvcHkgb2YgdGhlIGFycmF5IHdpdGggYWxsIGZhbHN5IHZhbHVlcyByZW1vdmVkCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgLSBhcnJheQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gLSBwcmVkaWNhdGUgZnVuY3Rpb24gZm9yIGNsdXN0ZXIgcnVsZQogICAgICovCiAgICB2YXIgY29tcGFjdCA9IGZ1bmN0aW9uIChhcnJheSkgewogICAgICB2YXIgYVJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpZHggPSAwLCBsZW4gPSBhcnJheS5sZW5ndGg7IGlkeCA8IGxlbjsgaWR4ICsrKSB7CiAgICAgICAgaWYgKGFycmF5W2lkeF0pIHsgYVJlc3VsdC5wdXNoKGFycmF5W2lkeF0pOyB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFSZXN1bHQ7CiAgICB9OwoKICAgIC8qKgogICAgICogcHJvZHVjZXMgYSBkdXBsaWNhdGUtZnJlZSB2ZXJzaW9uIG9mIHRoZSBhcnJheQogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5CiAgICAgKi8KICAgIHZhciB1bmlxdWUgPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKCiAgICAgIGZvciAodmFyIGlkeCA9IDAsIGxlbiA9IGFycmF5Lmxlbmd0aDsgaWR4IDwgbGVuOyBpZHggKyspIHsKICAgICAgICBpZiAoIWNvbnRhaW5zKHJlc3VsdHMsIGFycmF5W2lkeF0pKSB7CiAgICAgICAgICByZXN1bHRzLnB1c2goYXJyYXlbaWR4XSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0czsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIG5leHQgaXRlbS4KICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5CiAgICAgKi8KICAgIHZhciBuZXh0ID0gZnVuY3Rpb24gKGFycmF5LCBpdGVtKSB7CiAgICAgIHZhciBpZHggPSBhcnJheS5pbmRleE9mKGl0ZW0pOwogICAgICBpZiAoaWR4ID09PSAtMSkgeyByZXR1cm4gbnVsbDsgfQoKICAgICAgcmV0dXJuIGFycmF5W2lkeCArIDFdOwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgcHJldiBpdGVtLgogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkKICAgICAqLwogICAgdmFyIHByZXYgPSBmdW5jdGlvbiAoYXJyYXksIGl0ZW0pIHsKICAgICAgdmFyIGlkeCA9IGFycmF5LmluZGV4T2YoaXRlbSk7CiAgICAgIGlmIChpZHggPT09IC0xKSB7IHJldHVybiBudWxsOyB9CgogICAgICByZXR1cm4gYXJyYXlbaWR4IC0gMV07CiAgICB9OwoKICAKICAgIHJldHVybiB7IGhlYWQ6IGhlYWQsIGxhc3Q6IGxhc3QsIGluaXRpYWw6IGluaXRpYWwsIHRhaWw6IHRhaWwsCiAgICAgICAgICAgICBwcmV2OiBwcmV2LCBuZXh0OiBuZXh0LCBmaW5kOiBmaW5kLCBjb250YWluczogY29udGFpbnMsCiAgICAgICAgICAgICBhbGw6IGFsbCwgc3VtOiBzdW0sIGZyb206IGZyb20sCiAgICAgICAgICAgICBjbHVzdGVyQnk6IGNsdXN0ZXJCeSwgY29tcGFjdDogY29tcGFjdCwgdW5pcXVlOiB1bmlxdWUgfTsKICB9KSgpOwoKCiAgdmFyIE5CU1BfQ0hBUiA9IFN0cmluZy5mcm9tQ2hhckNvZGUoMTYwKTsKICB2YXIgWkVST19XSURUSF9OQlNQX0NIQVIgPSAnXHVmZWZmJzsKCiAgLyoqCiAgICogRG9tIGZ1bmN0aW9ucwogICAqLwogIHZhciBkb20gPSAoZnVuY3Rpb24gKCkgewogICAgLyoqCiAgICAgKiByZXR1cm5zIHdoZXRoZXIgbm9kZSBpcyBgbm90ZS1lZGl0YWJsZWAgb3Igbm90LgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdmFyIGlzRWRpdGFibGUgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICByZXR1cm4gbm9kZSAmJiAkKG5vZGUpLmhhc0NsYXNzKCdub3RlLWVkaXRhYmxlJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyB3aGV0aGVyIG5vZGUgaXMgYG5vdGUtY29udHJvbC1zaXppbmdgIG9yIG5vdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIHZhciBpc0NvbnRyb2xTaXppbmcgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICByZXR1cm4gbm9kZSAmJiAkKG5vZGUpLmhhc0NsYXNzKCdub3RlLWNvbnRyb2wtc2l6aW5nJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogYnVpbGQgbGF5b3V0SW5mbyBmcm9tICRlZGl0b3IoLm5vdGUtZWRpdG9yKQogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZWRpdG9yCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgKi8KICAgIHZhciBidWlsZExheW91dEluZm8gPSBmdW5jdGlvbiAoJGVkaXRvcikgewogICAgICB2YXIgbWFrZUZpbmRlcjsKCiAgICAgIC8vIGFpciBtb2RlCiAgICAgIGlmICgkZWRpdG9yLmhhc0NsYXNzKCdub3RlLWFpci1lZGl0b3InKSkgewogICAgICAgIHZhciBpZCA9IGxpc3QubGFzdCgkZWRpdG9yLmF0dHIoJ2lkJykuc3BsaXQoJy0nKSk7CiAgICAgICAgbWFrZUZpbmRlciA9IGZ1bmN0aW9uIChzSWRQcmVmaXgpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7IHJldHVybiAkKHNJZFByZWZpeCArIGlkKTsgfTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgZWRpdG9yOiBmdW5jdGlvbiAoKSB7IHJldHVybiAkZWRpdG9yOyB9LAogICAgICAgICAgZWRpdGFibGU6IGZ1bmN0aW9uICgpIHsgcmV0dXJuICRlZGl0b3I7IH0sCiAgICAgICAgICBwb3BvdmVyOiBtYWtlRmluZGVyKCcjbm90ZS1wb3BvdmVyLScpLAogICAgICAgICAgaGFuZGxlOiBtYWtlRmluZGVyKCcjbm90ZS1oYW5kbGUtJyksCiAgICAgICAgICBkaWFsb2c6IG1ha2VGaW5kZXIoJyNub3RlLWRpYWxvZy0nKQogICAgICAgIH07CgogICAgICAgIC8vIGZyYW1lIG1vZGUKICAgICAgfSBlbHNlIHsKICAgICAgICBtYWtlRmluZGVyID0gZnVuY3Rpb24gKHNDbGFzc05hbWUpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7IHJldHVybiAkZWRpdG9yLmZpbmQoc0NsYXNzTmFtZSk7IH07CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZWRpdG9yOiBmdW5jdGlvbiAoKSB7IHJldHVybiAkZWRpdG9yOyB9LAogICAgICAgICAgZHJvcHpvbmU6IG1ha2VGaW5kZXIoJy5ub3RlLWRyb3B6b25lJyksCiAgICAgICAgICB0b29sYmFyOiBtYWtlRmluZGVyKCcubm90ZS10b29sYmFyJyksCiAgICAgICAgICBlZGl0YWJsZTogbWFrZUZpbmRlcignLm5vdGUtZWRpdGFibGUnKSwKICAgICAgICAgIGNvZGFibGU6IG1ha2VGaW5kZXIoJy5ub3RlLWNvZGFibGUnKSwKICAgICAgICAgIHN0YXR1c2JhcjogbWFrZUZpbmRlcignLm5vdGUtc3RhdHVzYmFyJyksCiAgICAgICAgICBwb3BvdmVyOiBtYWtlRmluZGVyKCcubm90ZS1wb3BvdmVyJyksCiAgICAgICAgICBoYW5kbGU6IG1ha2VGaW5kZXIoJy5ub3RlLWhhbmRsZScpLAogICAgICAgICAgZGlhbG9nOiBtYWtlRmluZGVyKCcubm90ZS1kaWFsb2cnKQogICAgICAgIH07CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIHByZWRpY2F0ZSB3aGljaCBqdWRnZSB3aGV0aGVyIG5vZGVOYW1lIGlzIHNhbWUKICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbm9kZU5hbWUKICAgICAqIEByZXR1cm4ge1N0cmluZ30KICAgICAqLwogICAgdmFyIG1ha2VQcmVkQnlOb2RlTmFtZSA9IGZ1bmN0aW9uIChub2RlTmFtZSkgewogICAgICBub2RlTmFtZSA9IG5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7CiAgICAgIHJldHVybiBmdW5jdGlvbiAobm9kZSkgewogICAgICAgIHJldHVybiBub2RlICYmIG5vZGUubm9kZU5hbWUudG9VcHBlckNhc2UoKSA9PT0gbm9kZU5hbWU7CiAgICAgIH07CiAgICB9OwoKICAgIHZhciBpc1RleHQgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm5vZGVUeXBlID09PSAzOwogICAgfTsKCiAgICAvKioKICAgICAqIGV4KSBiciwgY29sLCBlbWJlZCwgaHIsIGltZywgaW5wdXQsIC4uLgogICAgICogQHNlZSBodHRwOi8vd3d3LnczLm9yZy9odG1sL3dnL2RyYWZ0cy9odG1sL21hc3Rlci9zeW50YXguaHRtbCN2b2lkLWVsZW1lbnRzCiAgICAgKi8KICAgIHZhciBpc1ZvaWQgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICByZXR1cm4gbm9kZSAmJiAvXkJSfF5JTUd8XkhSLy50ZXN0KG5vZGUubm9kZU5hbWUudG9VcHBlckNhc2UoKSk7CiAgICB9OwoKICAgIHZhciBpc1BhcmEgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICBpZiAoaXNFZGl0YWJsZShub2RlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gQ2hyb21lKHYzMS4wKSwgRkYodjI1LjAuMSkgdXNlIERJViBmb3IgcGFyYWdyYXBoCiAgICAgIHJldHVybiBub2RlICYmIC9eRElWfF5QfF5MSXxeSFsxLTddLy50ZXN0KG5vZGUubm9kZU5hbWUudG9VcHBlckNhc2UoKSk7CiAgICB9OwoKICAgIHZhciBpc0xpID0gbWFrZVByZWRCeU5vZGVOYW1lKCdMSScpOwoKICAgIHZhciBpc1B1cmVQYXJhID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgcmV0dXJuIGlzUGFyYShub2RlKSAmJiAhaXNMaShub2RlKTsKICAgIH07CgogICAgdmFyIGlzSW5saW5lID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgcmV0dXJuICFpc0JvZHlDb250YWluZXIobm9kZSkgJiYgIWlzTGlzdChub2RlKSAmJiAhaXNQYXJhKG5vZGUpOwogICAgfTsKCiAgICB2YXIgaXNMaXN0ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUgJiYgL15VTHxeT0wvLnRlc3Qobm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpKTsKICAgIH07CgogICAgdmFyIGlzQ2VsbCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHJldHVybiBub2RlICYmIC9eVER8XlRILy50ZXN0KG5vZGUubm9kZU5hbWUudG9VcHBlckNhc2UoKSk7CiAgICB9OwoKICAgIHZhciBpc0Jsb2NrcXVvdGUgPSBtYWtlUHJlZEJ5Tm9kZU5hbWUoJ0JMT0NLUVVPVEUnKTsKCiAgICB2YXIgaXNCb2R5Q29udGFpbmVyID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgcmV0dXJuIGlzQ2VsbChub2RlKSB8fCBpc0Jsb2NrcXVvdGUobm9kZSkgfHwgaXNFZGl0YWJsZShub2RlKTsKICAgIH07CgogICAgdmFyIGlzQW5jaG9yID0gbWFrZVByZWRCeU5vZGVOYW1lKCdBJyk7CgogICAgdmFyIGlzUGFyYUlubGluZSA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHJldHVybiBpc0lubGluZShub2RlKSAmJiAhIWFuY2VzdG9yKG5vZGUsIGlzUGFyYSk7CiAgICB9OwoKICAgIHZhciBpc0JvZHlJbmxpbmUgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICByZXR1cm4gaXNJbmxpbmUobm9kZSkgJiYgIWFuY2VzdG9yKG5vZGUsIGlzUGFyYSk7CiAgICB9OwoKICAgIHZhciBpc0JvZHkgPSBtYWtlUHJlZEJ5Tm9kZU5hbWUoJ0JPRFknKTsKCiAgICAvKioKICAgICAqIGJsYW5rIEhUTUwgZm9yIGN1cnNvciBwb3NpdGlvbgogICAgICovCiAgICB2YXIgYmxhbmtIVE1MID0gYWdlbnQuaXNNU0lFID8gJyZuYnNwOycgOiAnPGJyPic7CgogICAgLyoqCiAgICAgKiByZXR1cm5zICN0ZXh0J3MgdGV4dCBzaXplIG9yIGVsZW1lbnQncyBjaGlsZE5vZGVzIHNpemUKICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqLwogICAgdmFyIG5vZGVMZW5ndGggPSBmdW5jdGlvbiAobm9kZSkgewogICAgICBpZiAoaXNUZXh0KG5vZGUpKSB7CiAgICAgICAgcmV0dXJuIG5vZGUubm9kZVZhbHVlLmxlbmd0aDsKICAgICAgfQoKICAgICAgcmV0dXJuIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGg7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyB3aGV0aGVyIG5vZGUgaXMgZW1wdHkgb3Igbm90LgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdmFyIGlzRW1wdHkgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICB2YXIgbGVuID0gbm9kZUxlbmd0aChub2RlKTsKCiAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICghZG9tLmlzVGV4dChub2RlKSAmJiBsZW4gPT09IDEgJiYgbm9kZS5pbm5lckhUTUwgPT09IGJsYW5rSFRNTCkgewogICAgICAgIC8vIGV4KSA8cD48YnI+PC9wPiwgPHNwYW4+PGJyPjwvc3Bhbj4KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgICAvKioKICAgICAqIHBhZGRpbmcgYmxhbmtIVE1MIGlmIG5vZGUgaXMgZW1wdHkgKGZvciBjdXJzb3IgcG9zaXRpb24pCiAgICAgKi8KICAgIHZhciBwYWRkaW5nQmxhbmtIVE1MID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgaWYgKCFpc1ZvaWQobm9kZSkgJiYgIW5vZGVMZW5ndGgobm9kZSkpIHsKICAgICAgICBub2RlLmlubmVySFRNTCA9IGJsYW5rSFRNTDsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIGZpbmQgbmVhcmVzdCBhbmNlc3RvciBwcmVkaWNhdGUgaGl0CiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcmVkIC0gcHJlZGljYXRlIGZ1bmN0aW9uCiAgICAgKi8KICAgIHZhciBhbmNlc3RvciA9IGZ1bmN0aW9uIChub2RlLCBwcmVkKSB7CiAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgaWYgKHByZWQobm9kZSkpIHsgcmV0dXJuIG5vZGU7IH0KICAgICAgICBpZiAoaXNFZGl0YWJsZShub2RlKSkgeyBicmVhazsgfQoKICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgbmV3IGFycmF5IG9mIGFuY2VzdG9yIG5vZGVzICh1bnRpbCBwcmVkaWNhdGUgaGl0KS4KICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtvcHRpb25hbF0gcHJlZCAtIHByZWRpY2F0ZSBmdW5jdGlvbgogICAgICovCiAgICB2YXIgbGlzdEFuY2VzdG9yID0gZnVuY3Rpb24gKG5vZGUsIHByZWQpIHsKICAgICAgcHJlZCA9IHByZWQgfHwgZnVuYy5mYWlsOwoKICAgICAgdmFyIGFuY2VzdG9ycyA9IFtdOwogICAgICBhbmNlc3Rvcihub2RlLCBmdW5jdGlvbiAoZWwpIHsKICAgICAgICBpZiAoIWlzRWRpdGFibGUoZWwpKSB7CiAgICAgICAgICBhbmNlc3RvcnMucHVzaChlbCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcHJlZChlbCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gYW5jZXN0b3JzOwogICAgfTsKCiAgICAvKioKICAgICAqIGZpbmQgZmFydGhlc3QgYW5jZXN0b3IgcHJlZGljYXRlIGhpdAogICAgICovCiAgICB2YXIgbGFzdEFuY2VzdG9yID0gZnVuY3Rpb24gKG5vZGUsIHByZWQpIHsKICAgICAgdmFyIGFuY2VzdG9ycyA9IGxpc3RBbmNlc3Rvcihub2RlKTsKICAgICAgcmV0dXJuIGxpc3QubGFzdChhbmNlc3RvcnMuZmlsdGVyKHByZWQpKTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIGNvbW1vbiBhbmNlc3RvciBub2RlIGJldHdlZW4gdHdvIG5vZGVzLgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZUEKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZUIKICAgICAqLwogICAgdmFyIGNvbW1vbkFuY2VzdG9yID0gZnVuY3Rpb24gKG5vZGVBLCBub2RlQikgewogICAgICB2YXIgYW5jZXN0b3JzID0gbGlzdEFuY2VzdG9yKG5vZGVBKTsKICAgICAgZm9yICh2YXIgbiA9IG5vZGVCOyBuOyBuID0gbi5wYXJlbnROb2RlKSB7CiAgICAgICAgaWYgKCQuaW5BcnJheShuLCBhbmNlc3RvcnMpID4gLTEpIHsgcmV0dXJuIG47IH0KICAgICAgfQogICAgICByZXR1cm4gbnVsbDsgLy8gZGlmZmVyZW5jZSBkb2N1bWVudCBhcmVhCiAgICB9OwoKICAgIC8qKgogICAgICogbGlzdGluZyBhbGwgcHJldmlvdXMgc2libGluZ3MgKHVudGlsIHByZWRpY2F0ZSBoaXQpLgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW29wdGlvbmFsXSBwcmVkIC0gcHJlZGljYXRlIGZ1bmN0aW9uCiAgICAgKi8KICAgIHZhciBsaXN0UHJldiA9IGZ1bmN0aW9uIChub2RlLCBwcmVkKSB7CiAgICAgIHByZWQgPSBwcmVkIHx8IGZ1bmMuZmFpbDsKCiAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICB3aGlsZSAobm9kZSkgewogICAgICAgIGlmIChwcmVkKG5vZGUpKSB7IGJyZWFrOyB9CiAgICAgICAgbm9kZXMucHVzaChub2RlKTsKICAgICAgICBub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgIH0KICAgICAgcmV0dXJuIG5vZGVzOwogICAgfTsKCiAgICAvKioKICAgICAqIGxpc3RpbmcgbmV4dCBzaWJsaW5ncyAodW50aWwgcHJlZGljYXRlIGhpdCkuCiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcHJlZF0gLSBwcmVkaWNhdGUgZnVuY3Rpb24KICAgICAqLwogICAgdmFyIGxpc3ROZXh0ID0gZnVuY3Rpb24gKG5vZGUsIHByZWQpIHsKICAgICAgcHJlZCA9IHByZWQgfHwgZnVuYy5mYWlsOwoKICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgaWYgKHByZWQobm9kZSkpIHsgYnJlYWs7IH0KICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICB9CiAgICAgIHJldHVybiBub2RlczsKICAgIH07CgogICAgLyoqCiAgICAgKiBsaXN0aW5nIGRlc2NlbmRhbnQgbm9kZXMKICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtwcmVkXSAtIHByZWRpY2F0ZSBmdW5jdGlvbgogICAgICovCiAgICB2YXIgbGlzdERlc2NlbmRhbnQgPSBmdW5jdGlvbiAobm9kZSwgcHJlZCkgewogICAgICB2YXIgZGVzY2VuZGVudHMgPSBbXTsKICAgICAgcHJlZCA9IHByZWQgfHwgZnVuYy5vazsKCiAgICAgIC8vIHN0YXJ0IERGUyhkZXB0aCBmaXJzdCBzZWFyY2gpIHdpdGggbm9kZQogICAgICAoZnVuY3Rpb24gZm5XYWxrKGN1cnJlbnQpIHsKICAgICAgICBpZiAobm9kZSAhPT0gY3VycmVudCAmJiBwcmVkKGN1cnJlbnQpKSB7CiAgICAgICAgICBkZXNjZW5kZW50cy5wdXNoKGN1cnJlbnQpOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpZHggPSAwLCBsZW4gPSBjdXJyZW50LmNoaWxkTm9kZXMubGVuZ3RoOyBpZHggPCBsZW47IGlkeCsrKSB7CiAgICAgICAgICBmbldhbGsoY3VycmVudC5jaGlsZE5vZGVzW2lkeF0pOwogICAgICAgIH0KICAgICAgfSkobm9kZSk7CgogICAgICByZXR1cm4gZGVzY2VuZGVudHM7CiAgICB9OwoKICAgIC8qKgogICAgICogd3JhcCBub2RlIHdpdGggbmV3IHRhZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7Tm9kZX0gdGFnTmFtZSBvZiB3cmFwcGVyCiAgICAgKiBAcmV0dXJuIHtOb2RlfSAtIHdyYXBwZXIKICAgICAqLwogICAgdmFyIHdyYXAgPSBmdW5jdGlvbiAobm9kZSwgd3JhcHBlck5hbWUpIHsKICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgdmFyIHdyYXBwZXIgPSAkKCc8JyArIHdyYXBwZXJOYW1lICsgJz4nKVswXTsKCiAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUod3JhcHBlciwgbm9kZSk7CiAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQobm9kZSk7CgogICAgICByZXR1cm4gd3JhcHBlcjsKICAgIH07CgogICAgLyoqCiAgICAgKiBpbnNlcnQgbm9kZSBhZnRlciBwcmVjZWRpbmcKICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7Tm9kZX0gcHJlY2VkaW5nIC0gcHJlZGljYXRlIGZ1bmN0aW9uCiAgICAgKi8KICAgIHZhciBpbnNlcnRBZnRlciA9IGZ1bmN0aW9uIChub2RlLCBwcmVjZWRpbmcpIHsKICAgICAgdmFyIG5leHQgPSBwcmVjZWRpbmcubmV4dFNpYmxpbmcsIHBhcmVudCA9IHByZWNlZGluZy5wYXJlbnROb2RlOwogICAgICBpZiAobmV4dCkgewogICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgbmV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyZW50LmFwcGVuZENoaWxkKG5vZGUpOwogICAgICB9CiAgICAgIHJldHVybiBub2RlOwogICAgfTsKCiAgICAvKioKICAgICAqIGFwcGVuZCBlbGVtZW50cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7Q29sbGVjdGlvbn0gYUNoaWxkCiAgICAgKi8KICAgIHZhciBhcHBlbmRDaGlsZE5vZGVzID0gZnVuY3Rpb24gKG5vZGUsIGFDaGlsZCkgewogICAgICAkLmVhY2goYUNoaWxkLCBmdW5jdGlvbiAoaWR4LCBjaGlsZCkgewogICAgICAgIG5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICB9KTsKICAgICAgcmV0dXJuIG5vZGU7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyB3aGV0aGVyIGJvdW5kYXJ5UG9pbnQgaXMgbGVmdCBlZGdlIG9yIG5vdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0JvdW5kYXJ5UG9pbnR9IHBvaW50CiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB2YXIgaXNMZWZ0RWRnZVBvaW50ID0gZnVuY3Rpb24gKHBvaW50KSB7CiAgICAgIHJldHVybiBwb2ludC5vZmZzZXQgPT09IDA7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyB3aGV0aGVyIGJvdW5kYXJ5UG9pbnQgaXMgcmlnaHQgZWRnZSBvciBub3QuCiAgICAgKgogICAgICogQHBhcmFtIHtCb3VuZGFyeVBvaW50fSBwb2ludAogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdmFyIGlzUmlnaHRFZGdlUG9pbnQgPSBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgcmV0dXJuIHBvaW50Lm9mZnNldCA9PT0gbm9kZUxlbmd0aChwb2ludC5ub2RlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIHdoZXRoZXIgYm91bmRhcnlQb2ludCBpcyBlZGdlIG9yIG5vdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0JvdW5kYXJ5UG9pbnR9IHBvaW50CiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB2YXIgaXNFZGdlUG9pbnQgPSBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgcmV0dXJuIGlzTGVmdEVkZ2VQb2ludChwb2ludCkgfHwgaXNSaWdodEVkZ2VQb2ludChwb2ludCk7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyB3aGV0ZXIgbm9kZSBpcyBsZWZ0IGVkZ2Ugb2YgYW5jZXN0b3Igb3Igbm90LgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICogQHBhcmFtIHtOb2RlfSBhbmNlc3RvcgogICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAqLwogICAgdmFyIGlzTGVmdEVkZ2VPZiA9IGZ1bmN0aW9uIChub2RlLCBhbmNlc3RvcikgewogICAgICB3aGlsZSAobm9kZSAmJiBub2RlICE9PSBhbmNlc3RvcikgewogICAgICAgIGlmIChwb3NpdGlvbihub2RlKSAhPT0gMCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIHdoZXRoZXIgbm9kZSBpcyByaWdodCBlZGdlIG9mIGFuY2VzdG9yIG9yIG5vdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7Tm9kZX0gYW5jZXN0b3IKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIHZhciBpc1JpZ2h0RWRnZU9mID0gZnVuY3Rpb24gKG5vZGUsIGFuY2VzdG9yKSB7CiAgICAgIHdoaWxlIChub2RlICYmIG5vZGUgIT09IGFuY2VzdG9yKSB7CiAgICAgICAgaWYgKHBvc2l0aW9uKG5vZGUpICE9PSBub2RlTGVuZ3RoKG5vZGUucGFyZW50Tm9kZSkgLSAxKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgb2Zmc2V0IGZyb20gcGFyZW50LgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICovCiAgICB2YXIgcG9zaXRpb24gPSBmdW5jdGlvbiAobm9kZSkgewogICAgICB2YXIgb2Zmc2V0ID0gMDsKICAgICAgd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSB7CiAgICAgICAgb2Zmc2V0ICs9IDE7CiAgICAgIH0KICAgICAgcmV0dXJuIG9mZnNldDsKICAgIH07CgogICAgdmFyIGhhc0NoaWxkcmVuID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgcmV0dXJuICEhKG5vZGUgJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGgpOwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgcHJldmlvdXMgYm91bmRhcnlQb2ludAogICAgICoKICAgICAqIEBwYXJhbSB7Qm91bmRhcnlQb2ludH0gcG9pbnQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNTa2lwSW5uZXJPZmZzZXQKICAgICAqIEByZXR1cm4ge0JvdW5kYXJ5UG9pbnR9CiAgICAgKi8KICAgIHZhciBwcmV2UG9pbnQgPSBmdW5jdGlvbiAocG9pbnQsIGlzU2tpcElubmVyT2Zmc2V0KSB7CiAgICAgIHZhciBub2RlLCBvZmZzZXQ7CgogICAgICBpZiAocG9pbnQub2Zmc2V0ID09PSAwKSB7CiAgICAgICAgaWYgKGlzRWRpdGFibGUocG9pbnQubm9kZSkpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgbm9kZSA9IHBvaW50Lm5vZGUucGFyZW50Tm9kZTsKICAgICAgICBvZmZzZXQgPSBwb3NpdGlvbihwb2ludC5ub2RlKTsKICAgICAgfSBlbHNlIGlmIChoYXNDaGlsZHJlbihwb2ludC5ub2RlKSkgewogICAgICAgIG5vZGUgPSBwb2ludC5ub2RlLmNoaWxkTm9kZXNbcG9pbnQub2Zmc2V0IC0gMV07CiAgICAgICAgb2Zmc2V0ID0gbm9kZUxlbmd0aChub2RlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBub2RlID0gcG9pbnQubm9kZTsKICAgICAgICBvZmZzZXQgPSBpc1NraXBJbm5lck9mZnNldCA\/IDAgOiBwb2ludC5vZmZzZXQgLSAxOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgb2Zmc2V0OiBvZmZzZXQKICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIG5leHQgYm91bmRhcnlQb2ludAogICAgICoKICAgICAqIEBwYXJhbSB7Qm91bmRhcnlQb2ludH0gcG9pbnQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNTa2lwSW5uZXJPZmZzZXQKICAgICAqIEByZXR1cm4ge0JvdW5kYXJ5UG9pbnR9CiAgICAgKi8KICAgIHZhciBuZXh0UG9pbnQgPSBmdW5jdGlvbiAocG9pbnQsIGlzU2tpcElubmVyT2Zmc2V0KSB7CiAgICAgIHZhciBub2RlLCBvZmZzZXQ7CgogICAgICBpZiAobm9kZUxlbmd0aChwb2ludC5ub2RlKSA9PT0gcG9pbnQub2Zmc2V0KSB7CiAgICAgICAgaWYgKGlzRWRpdGFibGUocG9pbnQubm9kZSkpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgbm9kZSA9IHBvaW50Lm5vZGUucGFyZW50Tm9kZTsKICAgICAgICBvZmZzZXQgPSBwb3NpdGlvbihwb2ludC5ub2RlKSArIDE7CiAgICAgIH0gZWxzZSBpZiAoaGFzQ2hpbGRyZW4ocG9pbnQubm9kZSkpIHsKICAgICAgICBub2RlID0gcG9pbnQubm9kZS5jaGlsZE5vZGVzW3BvaW50Lm9mZnNldF07CiAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBub2RlID0gcG9pbnQubm9kZTsKICAgICAgICBvZmZzZXQgPSBpc1NraXBJbm5lck9mZnNldCA\/IG5vZGVMZW5ndGgocG9pbnQubm9kZSkgOiBwb2ludC5vZmZzZXQgKyAxOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgb2Zmc2V0OiBvZmZzZXQKICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZXR1cm5zIHdoZXRoZXIgcG9pbnRBIGFuZCBwb2ludEIgaXMgc2FtZSBvciBub3QuCiAgICAgKgogICAgICogQHBhcmFtIHtCb3VuZGFyeVBvaW50fSBwb2ludEEKICAgICAqIEBwYXJhbSB7Qm91bmRhcnlQb2ludH0gcG9pbnRCCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB2YXIgaXNTYW1lUG9pbnQgPSBmdW5jdGlvbiAocG9pbnRBLCBwb2ludEIpIHsKICAgICAgcmV0dXJuIHBvaW50QS5ub2RlID09PSBwb2ludEIubm9kZSAmJiBwb2ludEEub2Zmc2V0ID09PSBwb2ludEIub2Zmc2V0OwogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgd2hldGhlciBwb2ludCBpcyB2aXNpYmxlIChjYW4gc2V0IGN1cnNvcikgb3Igbm90LgogICAgICogCiAgICAgKiBAcGFyYW0ge0JvdW5kYXJ5UG9pbnR9IHBvaW50CiAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICovCiAgICB2YXIgaXNWaXNpYmxlUG9pbnQgPSBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgaWYgKGlzVGV4dChwb2ludC5ub2RlKSB8fCAhaGFzQ2hpbGRyZW4ocG9pbnQubm9kZSkgfHwgaXNFbXB0eShwb2ludC5ub2RlKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICB2YXIgbGVmdE5vZGUgPSBwb2ludC5ub2RlLmNoaWxkTm9kZXNbcG9pbnQub2Zmc2V0IC0gMV07CiAgICAgIHZhciByaWdodE5vZGUgPSBwb2ludC5ub2RlLmNoaWxkTm9kZXNbcG9pbnQub2Zmc2V0XTsKICAgICAgaWYgKCghbGVmdE5vZGUgfHwgaXNWb2lkKGxlZnROb2RlKSkgJiYgKCFyaWdodE5vZGUgfHwgaXNWb2lkKHJpZ2h0Tm9kZSkpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0JvdW5kYXJ5UG9pbnR9IHBvaW50CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcmVkCiAgICAgKiBAcmV0dXJuIHtCb3VuZGFyeVBvaW50fQogICAgICovCiAgICB2YXIgcHJldlBvaW50VW50aWwgPSBmdW5jdGlvbiAocG9pbnQsIHByZWQpIHsKICAgICAgd2hpbGUgKHBvaW50KSB7CiAgICAgICAgaWYgKHByZWQocG9pbnQpKSB7CiAgICAgICAgICByZXR1cm4gcG9pbnQ7CiAgICAgICAgfQoKICAgICAgICBwb2ludCA9IHByZXZQb2ludChwb2ludCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfTsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Qm91bmRhcnlQb2ludH0gcG9pbnQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByZWQKICAgICAqIEByZXR1cm4ge0JvdW5kYXJ5UG9pbnR9CiAgICAgKi8KICAgIHZhciBuZXh0UG9pbnRVbnRpbCA9IGZ1bmN0aW9uIChwb2ludCwgcHJlZCkgewogICAgICB3aGlsZSAocG9pbnQpIHsKICAgICAgICBpZiAocHJlZChwb2ludCkpIHsKICAgICAgICAgIHJldHVybiBwb2ludDsKICAgICAgICB9CgogICAgICAgIHBvaW50ID0gbmV4dFBvaW50KHBvaW50KTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9OwoKICAgIC8qKgogICAgICogQHBhcmFtIHtCb3VuZGFyeVBvaW50fSBzdGFydFBvaW50CiAgICAgKiBAcGFyYW0ge0JvdW5kYXJ5UG9pbnR9IGVuZFBvaW50CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBoYW5kbGVyCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGlzU2tpcElubmVyT2Zmc2V0CiAgICAgKi8KICAgIHZhciB3YWxrUG9pbnQgPSBmdW5jdGlvbiAoc3RhcnRQb2ludCwgZW5kUG9pbnQsIGhhbmRsZXIsIGlzU2tpcElubmVyT2Zmc2V0KSB7CiAgICAgIHZhciBwb2ludCA9IHN0YXJ0UG9pbnQ7CgogICAgICB3aGlsZSAocG9pbnQpIHsKICAgICAgICBoYW5kbGVyKHBvaW50KTsKCiAgICAgICAgaWYgKGlzU2FtZVBvaW50KHBvaW50LCBlbmRQb2ludCkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgdmFyIGlzU2tpcE9mZnNldCA9IGlzU2tpcElubmVyT2Zmc2V0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0UG9pbnQubm9kZSAhPT0gcG9pbnQubm9kZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRQb2ludC5ub2RlICE9PSBwb2ludC5ub2RlOwogICAgICAgIHBvaW50ID0gbmV4dFBvaW50KHBvaW50LCBpc1NraXBPZmZzZXQpOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJuIG9mZnNldFBhdGgoYXJyYXkgb2Ygb2Zmc2V0KSBmcm9tIGFuY2VzdG9yCiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlfSBhbmNlc3RvciAtIGFuY2VzdG9yIG5vZGUKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICovCiAgICB2YXIgbWFrZU9mZnNldFBhdGggPSBmdW5jdGlvbiAoYW5jZXN0b3IsIG5vZGUpIHsKICAgICAgdmFyIGFuY2VzdG9ycyA9IGxpc3RBbmNlc3Rvcihub2RlLCBmdW5jLmVxKGFuY2VzdG9yKSk7CiAgICAgIHJldHVybiAkLm1hcChhbmNlc3RvcnMsIHBvc2l0aW9uKS5yZXZlcnNlKCk7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJuIGVsZW1lbnQgZnJvbSBvZmZzZXRQYXRoKGFycmF5IG9mIG9mZnNldCkKICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IGFuY2VzdG9yIC0gYW5jZXN0b3Igbm9kZQogICAgICogQHBhcmFtIHthcnJheX0gYU9mZnNldCAtIG9mZnNldFBhdGgKICAgICAqLwogICAgdmFyIGZyb21PZmZzZXRQYXRoID0gZnVuY3Rpb24gKGFuY2VzdG9yLCBhT2Zmc2V0KSB7CiAgICAgIHZhciBjdXJyZW50ID0gYW5jZXN0b3I7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhT2Zmc2V0Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgaWYgKGN1cnJlbnQuY2hpbGROb2Rlcy5sZW5ndGggPD0gYU9mZnNldFtpXSkgewogICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuY2hpbGROb2Rlc1tjdXJyZW50LmNoaWxkTm9kZXMubGVuZ3RoIC0gMV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LmNoaWxkTm9kZXNbYU9mZnNldFtpXV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjdXJyZW50OwogICAgfTsKCiAgICAvKioKICAgICAqIHNwbGl0IGVsZW1lbnQgb3IgI3RleHQKICAgICAqCiAgICAgKiBAcGFyYW0ge0JvdW5kYXJ5UG9pbnR9IHBvaW50CiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtpc1NraXBQYWRkaW5nQmxhbmtIVE1MXQogICAgICogQHJldHVybiB7Tm9kZX0gcmlnaHQgbm9kZSBvZiBib3VuZGFyeVBvaW50CiAgICAgKi8KICAgIHZhciBzcGxpdE5vZGUgPSBmdW5jdGlvbiAocG9pbnQsIGlzU2tpcFBhZGRpbmdCbGFua0hUTUwpIHsKICAgICAgLy8gc3BsaXQgI3RleHQKICAgICAgaWYgKGlzVGV4dChwb2ludC5ub2RlKSkgewogICAgICAgIC8vIGVkZ2UgY2FzZQogICAgICAgIGlmIChpc0xlZnRFZGdlUG9pbnQocG9pbnQpKSB7CiAgICAgICAgICByZXR1cm4gcG9pbnQubm9kZTsKICAgICAgICB9IGVsc2UgaWYgKGlzUmlnaHRFZGdlUG9pbnQocG9pbnQpKSB7CiAgICAgICAgICByZXR1cm4gcG9pbnQubm9kZS5uZXh0U2libGluZzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBwb2ludC5ub2RlLnNwbGl0VGV4dChwb2ludC5vZmZzZXQpOwogICAgICB9CgogICAgICAvLyBzcGxpdCBlbGVtZW50CiAgICAgIHZhciBjaGlsZE5vZGUgPSBwb2ludC5ub2RlLmNoaWxkTm9kZXNbcG9pbnQub2Zmc2V0XTsKICAgICAgdmFyIGNsb25lID0gaW5zZXJ0QWZ0ZXIocG9pbnQubm9kZS5jbG9uZU5vZGUoZmFsc2UpLCBwb2ludC5ub2RlKTsKICAgICAgYXBwZW5kQ2hpbGROb2RlcyhjbG9uZSwgbGlzdE5leHQoY2hpbGROb2RlKSk7CgogICAgICBpZiAoIWlzU2tpcFBhZGRpbmdCbGFua0hUTUwpIHsKICAgICAgICBwYWRkaW5nQmxhbmtIVE1MKHBvaW50Lm5vZGUpOwogICAgICAgIHBhZGRpbmdCbGFua0hUTUwoY2xvbmUpOwogICAgICB9CgogICAgICByZXR1cm4gY2xvbmU7CiAgICB9OwoKICAgIC8qKgogICAgICogc3BsaXQgdHJlZSBieSBwb2ludAogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gcm9vdCAtIHNwbGl0IHJvb3QKICAgICAqIEBwYXJhbSB7Qm91bmRhcnlQb2ludH0gcG9pbnQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW2lzU2tpcFBhZGRpbmdCbGFua0hUTUxdCiAgICAgKiBAcmV0dXJuIHtOb2RlfSByaWdodCBub2RlIG9mIGJvdW5kYXJ5UG9pbnQKICAgICAqLwogICAgdmFyIHNwbGl0VHJlZSA9IGZ1bmN0aW9uIChyb290LCBwb2ludCwgaXNTa2lwUGFkZGluZ0JsYW5rSFRNTCkgewogICAgICAvLyBleCkgWyN0ZXh0LCA8c3Bhbj4sIDxwPl0KICAgICAgdmFyIGFuY2VzdG9ycyA9IGxpc3RBbmNlc3Rvcihwb2ludC5ub2RlLCBmdW5jLmVxKHJvb3QpKTsKCiAgICAgIGlmICghYW5jZXN0b3JzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgaWYgKGFuY2VzdG9ycy5sZW5ndGggPT09IDEpIHsKICAgICAgICByZXR1cm4gc3BsaXROb2RlKHBvaW50LCBpc1NraXBQYWRkaW5nQmxhbmtIVE1MKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGFuY2VzdG9ycy5yZWR1Y2UoZnVuY3Rpb24gKG5vZGUsIHBhcmVudCkgewogICAgICAgIHZhciBjbG9uZSA9IGluc2VydEFmdGVyKHBhcmVudC5jbG9uZU5vZGUoZmFsc2UpLCBwYXJlbnQpOwoKICAgICAgICBpZiAobm9kZSA9PT0gcG9pbnQubm9kZSkgewogICAgICAgICAgbm9kZSA9IHNwbGl0Tm9kZShwb2ludCwgaXNTa2lwUGFkZGluZ0JsYW5rSFRNTCk7CiAgICAgICAgfQoKICAgICAgICBhcHBlbmRDaGlsZE5vZGVzKGNsb25lLCBsaXN0TmV4dChub2RlKSk7CgogICAgICAgIGlmICghaXNTa2lwUGFkZGluZ0JsYW5rSFRNTCkgewogICAgICAgICAgcGFkZGluZ0JsYW5rSFRNTChwYXJlbnQpOwogICAgICAgICAgcGFkZGluZ0JsYW5rSFRNTChjbG9uZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBjcmVhdGUgPSBmdW5jdGlvbiAobm9kZU5hbWUpIHsKICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpOwogICAgfTsKCiAgICB2YXIgY3JlYXRlVGV4dCA9IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZW1vdmUgbm9kZSwgKGlzUmVtb3ZlQ2hpbGQ6IHJlbW92ZSBjaGlsZCBvciBub3QpCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNSZW1vdmVDaGlsZAogICAgICovCiAgICB2YXIgcmVtb3ZlID0gZnVuY3Rpb24gKG5vZGUsIGlzUmVtb3ZlQ2hpbGQpIHsKICAgICAgaWYgKCFub2RlIHx8ICFub2RlLnBhcmVudE5vZGUpIHsgcmV0dXJuOyB9CiAgICAgIGlmIChub2RlLnJlbW92ZU5vZGUpIHsgcmV0dXJuIG5vZGUucmVtb3ZlTm9kZShpc1JlbW92ZUNoaWxkKTsgfQoKICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgaWYgKCFpc1JlbW92ZUNoaWxkKSB7CiAgICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgICAgdmFyIGksIGxlbjsKICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBub2RlLmNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIG5vZGVzLnB1c2gobm9kZS5jaGlsZE5vZGVzW2ldKTsKICAgICAgICB9CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IG5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGVzW2ldLCBub2RlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHBhcmVudC5yZW1vdmVDaGlsZChub2RlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByZWQKICAgICAqLwogICAgdmFyIHJlbW92ZVdoaWxlID0gZnVuY3Rpb24gKG5vZGUsIHByZWQpIHsKICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICBpZiAoaXNFZGl0YWJsZShub2RlKSB8fCAhcHJlZChub2RlKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICB2YXIgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgIHJlbW92ZShub2RlKTsKICAgICAgICBub2RlID0gcGFyZW50OwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogcmVwbGFjZSBub2RlIHdpdGggcHJvdmlkZWQgbm9kZU5hbWUKICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBub2RlTmFtZQogICAgICogQHJldHVybiB7Tm9kZX0gLSBuZXcgbm9kZQogICAgICovCiAgICB2YXIgcmVwbGFjZSA9IGZ1bmN0aW9uIChub2RlLCBub2RlTmFtZSkgewogICAgICBpZiAobm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSBub2RlTmFtZS50b1VwcGVyQ2FzZSgpKSB7CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgIH0KCiAgICAgIHZhciBuZXdOb2RlID0gY3JlYXRlKG5vZGVOYW1lKTsKCiAgICAgIGlmIChub2RlLnN0eWxlLmNzc1RleHQpIHsKICAgICAgICBuZXdOb2RlLnN0eWxlLmNzc1RleHQgPSBub2RlLnN0eWxlLmNzc1RleHQ7CiAgICAgIH0KCiAgICAgIGFwcGVuZENoaWxkTm9kZXMobmV3Tm9kZSwgbGlzdC5mcm9tKG5vZGUuY2hpbGROb2RlcykpOwogICAgICBpbnNlcnRBZnRlcihuZXdOb2RlLCBub2RlKTsKICAgICAgcmVtb3ZlKG5vZGUpOwoKICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICB9OwoKICAgIHZhciBpc1RleHRhcmVhID0gbWFrZVByZWRCeU5vZGVOYW1lKCdURVhUQVJFQScpOwoKICAgIC8qKgogICAgICogZ2V0IHRoZSBIVE1MIGNvbnRlbnRzIG9mIG5vZGUgCiAgICAgKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRub2RlCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtpc05ld2xpbmVPbkJsb2NrXQogICAgICovCiAgICB2YXIgaHRtbCA9IGZ1bmN0aW9uICgkbm9kZSwgaXNOZXdsaW5lT25CbG9jaykgewogICAgICB2YXIgbWFya3VwID0gaXNUZXh0YXJlYSgkbm9kZVswXSkgPyAkbm9kZS52YWwoKSA6ICRub2RlLmh0bWwoKTsKCiAgICAgIGlmIChpc05ld2xpbmVPbkJsb2NrKSB7CiAgICAgICAgdmFyIHJlZ2V4VGFnID0gLzwoXC8\/KShcYig\/ISEpW14+XHNdKikoLio\/KShccypcLz8+KS9nOwogICAgICAgIG1hcmt1cCA9IG1hcmt1cC5yZXBsYWNlKHJlZ2V4VGFnLCBmdW5jdGlvbiAobWF0Y2gsIGVuZFNsYXNoLCBuYW1lKSB7CiAgICAgICAgICBuYW1lID0gbmFtZS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgdmFyIGlzRW5kT2ZJbmxpbmVDb250YWluZXIgPSAvXkRJVnxeVER8XlRIfF5QfF5MSXxeSFsxLTddLy50ZXN0KG5hbWUpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICEhZW5kU2xhc2g7CiAgICAgICAgICB2YXIgaXNCbG9ja05vZGUgPSAvXkJMT0NLUVVPVEV8XlRBQkxFfF5UQk9EWXxeVFJ8XkhSfF5VTHxeT0wvLnRlc3QobmFtZSk7CgogICAgICAgICAgcmV0dXJuIG1hdGNoICsgKChpc0VuZE9mSW5saW5lQ29udGFpbmVyIHx8IGlzQmxvY2tOb2RlKSA\/ICdcbicgOiAnJyk7CiAgICAgICAgfSk7CiAgICAgICAgbWFya3VwID0gJC50cmltKG1hcmt1cCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBtYXJrdXA7CiAgICB9OwoKICAgIHZhciB2YWx1ZSA9IGZ1bmN0aW9uICgkdGV4dGFyZWEpIHsKICAgICAgdmFyIHZhbCA9ICR0ZXh0YXJlYS52YWwoKTsKICAgICAgLy8gc3RyaXAgbGluZSBicmVha3MKICAgICAgcmV0dXJuIHZhbC5yZXBsYWNlKC9bXG5ccl0vZywgJycpOwogICAgfTsKCiAgICByZXR1cm4gewogICAgICBOQlNQX0NIQVI6IE5CU1BfQ0hBUiwKICAgICAgWkVST19XSURUSF9OQlNQX0NIQVI6IFpFUk9fV0lEVEhfTkJTUF9DSEFSLAogICAgICBibGFuazogYmxhbmtIVE1MLAogICAgICBlbXB0eVBhcmE6ICc8cD4nICsgYmxhbmtIVE1MICsgJzwvcD4nLAogICAgICBpc0VkaXRhYmxlOiBpc0VkaXRhYmxlLAogICAgICBpc0NvbnRyb2xTaXppbmc6IGlzQ29udHJvbFNpemluZywKICAgICAgYnVpbGRMYXlvdXRJbmZvOiBidWlsZExheW91dEluZm8sCiAgICAgIGlzVGV4dDogaXNUZXh0LAogICAgICBpc1BhcmE6IGlzUGFyYSwKICAgICAgaXNQdXJlUGFyYTogaXNQdXJlUGFyYSwKICAgICAgaXNJbmxpbmU6IGlzSW5saW5lLAogICAgICBpc0JvZHlJbmxpbmU6IGlzQm9keUlubGluZSwKICAgICAgaXNCb2R5OiBpc0JvZHksCiAgICAgIGlzUGFyYUlubGluZTogaXNQYXJhSW5saW5lLAogICAgICBpc0xpc3Q6IGlzTGlzdCwKICAgICAgaXNUYWJsZTogbWFrZVByZWRCeU5vZGVOYW1lKCdUQUJMRScpLAogICAgICBpc0NlbGw6IGlzQ2VsbCwKICAgICAgaXNCbG9ja3F1b3RlOiBpc0Jsb2NrcXVvdGUsCiAgICAgIGlzQm9keUNvbnRhaW5lcjogaXNCb2R5Q29udGFpbmVyLAogICAgICBpc0FuY2hvcjogaXNBbmNob3IsCiAgICAgIGlzRGl2OiBtYWtlUHJlZEJ5Tm9kZU5hbWUoJ0RJVicpLAogICAgICBpc0xpOiBpc0xpLAogICAgICBpc1NwYW46IG1ha2VQcmVkQnlOb2RlTmFtZSgnU1BBTicpLAogICAgICBpc0I6IG1ha2VQcmVkQnlOb2RlTmFtZSgnQicpLAogICAgICBpc1U6IG1ha2VQcmVkQnlOb2RlTmFtZSgnVScpLAogICAgICBpc1M6IG1ha2VQcmVkQnlOb2RlTmFtZSgnUycpLAogICAgICBpc0k6IG1ha2VQcmVkQnlOb2RlTmFtZSgnSScpLAogICAgICBpc0ltZzogbWFrZVByZWRCeU5vZGVOYW1lKCdJTUcnKSwKICAgICAgaXNUZXh0YXJlYTogaXNUZXh0YXJlYSwKICAgICAgaXNFbXB0eTogaXNFbXB0eSwKICAgICAgaXNFbXB0eUFuY2hvcjogZnVuYy5hbmQoaXNBbmNob3IsIGlzRW1wdHkpLAogICAgICBub2RlTGVuZ3RoOiBub2RlTGVuZ3RoLAogICAgICBpc0xlZnRFZGdlUG9pbnQ6IGlzTGVmdEVkZ2VQb2ludCwKICAgICAgaXNSaWdodEVkZ2VQb2ludDogaXNSaWdodEVkZ2VQb2ludCwKICAgICAgaXNFZGdlUG9pbnQ6IGlzRWRnZVBvaW50LAogICAgICBpc0xlZnRFZGdlT2Y6IGlzTGVmdEVkZ2VPZiwKICAgICAgaXNSaWdodEVkZ2VPZjogaXNSaWdodEVkZ2VPZiwKICAgICAgcHJldlBvaW50OiBwcmV2UG9pbnQsCiAgICAgIG5leHRQb2ludDogbmV4dFBvaW50LAogICAgICBpc1NhbWVQb2ludDogaXNTYW1lUG9pbnQsCiAgICAgIGlzVmlzaWJsZVBvaW50OiBpc1Zpc2libGVQb2ludCwKICAgICAgcHJldlBvaW50VW50aWw6IHByZXZQb2ludFVudGlsLAogICAgICBuZXh0UG9pbnRVbnRpbDogbmV4dFBvaW50VW50aWwsCiAgICAgIHdhbGtQb2ludDogd2Fsa1BvaW50LAogICAgICBhbmNlc3RvcjogYW5jZXN0b3IsCiAgICAgIGxpc3RBbmNlc3RvcjogbGlzdEFuY2VzdG9yLAogICAgICBsYXN0QW5jZXN0b3I6IGxhc3RBbmNlc3RvciwKICAgICAgbGlzdE5leHQ6IGxpc3ROZXh0LAogICAgICBsaXN0UHJldjogbGlzdFByZXYsCiAgICAgIGxpc3REZXNjZW5kYW50OiBsaXN0RGVzY2VuZGFudCwKICAgICAgY29tbW9uQW5jZXN0b3I6IGNvbW1vbkFuY2VzdG9yLAogICAgICB3cmFwOiB3cmFwLAogICAgICBpbnNlcnRBZnRlcjogaW5zZXJ0QWZ0ZXIsCiAgICAgIGFwcGVuZENoaWxkTm9kZXM6IGFwcGVuZENoaWxkTm9kZXMsCiAgICAgIHBvc2l0aW9uOiBwb3NpdGlvbiwKICAgICAgaGFzQ2hpbGRyZW46IGhhc0NoaWxkcmVuLAogICAgICBtYWtlT2Zmc2V0UGF0aDogbWFrZU9mZnNldFBhdGgsCiAgICAgIGZyb21PZmZzZXRQYXRoOiBmcm9tT2Zmc2V0UGF0aCwKICAgICAgc3BsaXRUcmVlOiBzcGxpdFRyZWUsCiAgICAgIGNyZWF0ZTogY3JlYXRlLAogICAgICBjcmVhdGVUZXh0OiBjcmVhdGVUZXh0LAogICAgICByZW1vdmU6IHJlbW92ZSwKICAgICAgcmVtb3ZlV2hpbGU6IHJlbW92ZVdoaWxlLAogICAgICByZXBsYWNlOiByZXBsYWNlLAogICAgICBodG1sOiBodG1sLAogICAgICB2YWx1ZTogdmFsdWUKICAgIH07CiAgfSkoKTsKCgogIC8qKgogICAqIERhdGEgc3RydWN0dXJlCiAgICogIC0ge0JvdW5kYXJ5UG9pbnR9OiBhIHBvaW50IG9mIGRvbSB0cmVlCiAgICogIC0ge0JvdW5kYXJ5UG9pbnRzfTogdHdvIGJvdW5kYXJ5UG9pbnRzIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHN0YXJ0IGFuZCB0aGUgZW5kIG9mIHRoZSBSYW5nZQogICAqCiAgICogIEBzZWUgaHR0cDovL3d3dy53My5vcmcvVFIvRE9NLUxldmVsLTItVHJhdmVyc2FsLVJhbmdlL3Jhbmdlcy5odG1sI0xldmVsLTItUmFuZ2UtUG9zaXRpb24KICAgKi8KICB2YXIgcmFuZ2UgPSAoZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgICogcmV0dXJuIGJvdW5kYXJ5UG9pbnQgZnJvbSBUZXh0UmFuZ2UsIGluc3BpcmVkIGJ5IEFuZHkgTmEncyBIdXNreVJhbmdlLmpzCiAgICAgKgogICAgICogQHBhcmFtIHtUZXh0UmFuZ2V9IHRleHRSYW5nZQogICAgICogQHBhcmFtIHtCb29sZWFufSBpc1N0YXJ0CiAgICAgKiBAcmV0dXJuIHtCb3VuZGFyeVBvaW50fQogICAgICoKICAgICAqIEBzZWUgaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL21zNTM1ODcyKHY9dnMuODUpLmFzcHgKICAgICAqLwogICAgdmFyIHRleHRSYW5nZVRvUG9pbnQgPSBmdW5jdGlvbiAodGV4dFJhbmdlLCBpc1N0YXJ0KSB7CiAgICAgIHZhciBjb250YWluZXIgPSB0ZXh0UmFuZ2UucGFyZW50RWxlbWVudCgpLCBvZmZzZXQ7CiAgCiAgICAgIHZhciB0ZXN0ZXIgPSBkb2N1bWVudC5ib2R5LmNyZWF0ZVRleHRSYW5nZSgpLCBwcmV2Q29udGFpbmVyOwogICAgICB2YXIgY2hpbGROb2RlcyA9IGxpc3QuZnJvbShjb250YWluZXIuY2hpbGROb2Rlcyk7CiAgICAgIGZvciAob2Zmc2V0ID0gMDsgb2Zmc2V0IDwgY2hpbGROb2Rlcy5sZW5ndGg7IG9mZnNldCsrKSB7CiAgICAgICAgaWYgKGRvbS5pc1RleHQoY2hpbGROb2Rlc1tvZmZzZXRdKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHRlc3Rlci5tb3ZlVG9FbGVtZW50VGV4dChjaGlsZE5vZGVzW29mZnNldF0pOwogICAgICAgIGlmICh0ZXN0ZXIuY29tcGFyZUVuZFBvaW50cygnU3RhcnRUb1N0YXJ0JywgdGV4dFJhbmdlKSA+PSAwKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcHJldkNvbnRhaW5lciA9IGNoaWxkTm9kZXNbb2Zmc2V0XTsKICAgICAgfQogIAogICAgICBpZiAob2Zmc2V0ICE9PSAwICYmIGRvbS5pc1RleHQoY2hpbGROb2Rlc1tvZmZzZXQgLSAxXSkpIHsKICAgICAgICB2YXIgdGV4dFJhbmdlU3RhcnQgPSBkb2N1bWVudC5ib2R5LmNyZWF0ZVRleHRSYW5nZSgpLCBjdXJUZXh0Tm9kZSA9IG51bGw7CiAgICAgICAgdGV4dFJhbmdlU3RhcnQubW92ZVRvRWxlbWVudFRleHQocHJldkNvbnRhaW5lciB8fCBjb250YWluZXIpOwogICAgICAgIHRleHRSYW5nZVN0YXJ0LmNvbGxhcHNlKCFwcmV2Q29udGFpbmVyKTsKICAgICAgICBjdXJUZXh0Tm9kZSA9IHByZXZDb250YWluZXIgPyBwcmV2Q29udGFpbmVyLm5leHRTaWJsaW5nIDogY29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgCiAgICAgICAgdmFyIHBvaW50VGVzdGVyID0gdGV4dFJhbmdlLmR1cGxpY2F0ZSgpOwogICAgICAgIHBvaW50VGVzdGVyLnNldEVuZFBvaW50KCdTdGFydFRvU3RhcnQnLCB0ZXh0UmFuZ2VTdGFydCk7CiAgICAgICAgdmFyIHRleHRDb3VudCA9IHBvaW50VGVzdGVyLnRleHQucmVwbGFjZSgvW1xyXG5dL2csICcnKS5sZW5ndGg7CiAgCiAgICAgICAgd2hpbGUgKHRleHRDb3VudCA+IGN1clRleHROb2RlLm5vZGVWYWx1ZS5sZW5ndGggJiYgY3VyVGV4dE5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgIHRleHRDb3VudCAtPSBjdXJUZXh0Tm9kZS5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgICAgY3VyVGV4dE5vZGUgPSBjdXJUZXh0Tm9kZS5uZXh0U2libGluZzsKICAgICAgICB9CiAgCiAgICAgICAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqLwogICAgICAgIHZhciBkdW1teSA9IGN1clRleHROb2RlLm5vZGVWYWx1ZTsgLy8gZW5mb3JjZSBJRSB0byByZS1yZWZlcmVuY2UgY3VyVGV4dE5vZGUsIGhhY2sKICAgICAgICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqLwogIAogICAgICAgIGlmIChpc1N0YXJ0ICYmIGN1clRleHROb2RlLm5leHRTaWJsaW5nICYmIGRvbS5pc1RleHQoY3VyVGV4dE5vZGUubmV4dFNpYmxpbmcpICYmCiAgICAgICAgICAgIHRleHRDb3VudCA9PT0gY3VyVGV4dE5vZGUubm9kZVZhbHVlLmxlbmd0aCkgewogICAgICAgICAgdGV4dENvdW50IC09IGN1clRleHROb2RlLm5vZGVWYWx1ZS5sZW5ndGg7CiAgICAgICAgICBjdXJUZXh0Tm9kZSA9IGN1clRleHROb2RlLm5leHRTaWJsaW5nOwogICAgICAgIH0KICAKICAgICAgICBjb250YWluZXIgPSBjdXJUZXh0Tm9kZTsKICAgICAgICBvZmZzZXQgPSB0ZXh0Q291bnQ7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHsKICAgICAgICBjb250OiBjb250YWluZXIsCiAgICAgICAgb2Zmc2V0OiBvZmZzZXQKICAgICAgfTsKICAgIH07CiAgICAKICAgIC8qKgogICAgICogcmV0dXJuIFRleHRSYW5nZSBmcm9tIGJvdW5kYXJ5IHBvaW50IChpbnNwaXJlZCBieSBnb29nbGUgY2xvc3VyZS1saWJyYXJ5KQogICAgICogQHBhcmFtIHtCb3VuZGFyeVBvaW50fSBwb2ludAogICAgICogQHJldHVybiB7VGV4dFJhbmdlfQogICAgICovCiAgICB2YXIgcG9pbnRUb1RleHRSYW5nZSA9IGZ1bmN0aW9uIChwb2ludCkgewogICAgICB2YXIgdGV4dFJhbmdlSW5mbyA9IGZ1bmN0aW9uIChjb250YWluZXIsIG9mZnNldCkgewogICAgICAgIHZhciBub2RlLCBpc0NvbGxhcHNlVG9TdGFydDsKICAKICAgICAgICBpZiAoZG9tLmlzVGV4dChjb250YWluZXIpKSB7CiAgICAgICAgICB2YXIgcHJldlRleHROb2RlcyA9IGRvbS5saXN0UHJldihjb250YWluZXIsIGZ1bmMubm90KGRvbS5pc1RleHQpKTsKICAgICAgICAgIHZhciBwcmV2Q29udGFpbmVyID0gbGlzdC5sYXN0KHByZXZUZXh0Tm9kZXMpLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIG5vZGUgPSAgcHJldkNvbnRhaW5lciB8fCBjb250YWluZXIucGFyZW50Tm9kZTsKICAgICAgICAgIG9mZnNldCArPSBsaXN0LnN1bShsaXN0LnRhaWwocHJldlRleHROb2RlcyksIGRvbS5ub2RlTGVuZ3RoKTsKICAgICAgICAgIGlzQ29sbGFwc2VUb1N0YXJ0ID0gIXByZXZDb250YWluZXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vZGUgPSBjb250YWluZXIuY2hpbGROb2Rlc1tvZmZzZXRdIHx8IGNvbnRhaW5lcjsKICAgICAgICAgIGlmIChkb20uaXNUZXh0KG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB0ZXh0UmFuZ2VJbmZvKG5vZGUsIDApOwogICAgICAgICAgfQogIAogICAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICAgIGlzQ29sbGFwc2VUb1N0YXJ0ID0gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICBub2RlOiBub2RlLAogICAgICAgICAgY29sbGFwc2VUb1N0YXJ0OiBpc0NvbGxhcHNlVG9TdGFydCwKICAgICAgICAgIG9mZnNldDogb2Zmc2V0CiAgICAgICAgfTsKICAgICAgfTsKICAKICAgICAgdmFyIHRleHRSYW5nZSA9IGRvY3VtZW50LmJvZHkuY3JlYXRlVGV4dFJhbmdlKCk7CiAgICAgIHZhciBpbmZvID0gdGV4dFJhbmdlSW5mbyhwb2ludC5ub2RlLCBwb2ludC5vZmZzZXQpOwogIAogICAgICB0ZXh0UmFuZ2UubW92ZVRvRWxlbWVudFRleHQoaW5mby5ub2RlKTsKICAgICAgdGV4dFJhbmdlLmNvbGxhcHNlKGluZm8uY29sbGFwc2VUb1N0YXJ0KTsKICAgICAgdGV4dFJhbmdlLm1vdmVTdGFydCgnY2hhcmFjdGVyJywgaW5mby5vZmZzZXQpOwogICAgICByZXR1cm4gdGV4dFJhbmdlOwogICAgfTsKICAgIAogICAgLyoqCiAgICAgKiBXcmFwcGVkIFJhbmdlCiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlfSBzYyAtIHN0YXJ0IGNvbnRhaW5lcgogICAgICogQHBhcmFtIHtOdW1iZXJ9IHNvIC0gc3RhcnQgb2Zmc2V0CiAgICAgKiBAcGFyYW0ge05vZGV9IGVjIC0gZW5kIGNvbnRhaW5lcgogICAgICogQHBhcmFtIHtOdW1iZXJ9IGVvIC0gZW5kIG9mZnNldAogICAgICovCiAgICB2YXIgV3JhcHBlZFJhbmdlID0gZnVuY3Rpb24gKHNjLCBzbywgZWMsIGVvKSB7CiAgICAgIHRoaXMuc2MgPSBzYzsKICAgICAgdGhpcy5zbyA9IHNvOwogICAgICB0aGlzLmVjID0gZWM7CiAgICAgIHRoaXMuZW8gPSBlbzsKICAKICAgICAgLy8gbmF0aXZlUmFuZ2U6IGdldCBuYXRpdmVSYW5nZSBmcm9tIHNjLCBzbywgZWMsIGVvCiAgICAgIHZhciBuYXRpdmVSYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoYWdlbnQuaXNXM0NSYW5nZVN1cHBvcnQpIHsKICAgICAgICAgIHZhciB3M2NSYW5nZSA9IGRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICB3M2NSYW5nZS5zZXRTdGFydChzYywgc28pOwogICAgICAgICAgdzNjUmFuZ2Uuc2V0RW5kKGVjLCBlbyk7CgogICAgICAgICAgcmV0dXJuIHczY1JhbmdlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgdGV4dFJhbmdlID0gcG9pbnRUb1RleHRSYW5nZSh7CiAgICAgICAgICAgIG5vZGU6IHNjLAogICAgICAgICAgICBvZmZzZXQ6IHNvCiAgICAgICAgICB9KTsKCiAgICAgICAgICB0ZXh0UmFuZ2Uuc2V0RW5kUG9pbnQoJ0VuZFRvRW5kJywgcG9pbnRUb1RleHRSYW5nZSh7CiAgICAgICAgICAgIG5vZGU6IGVjLAogICAgICAgICAgICBvZmZzZXQ6IGVvCiAgICAgICAgICB9KSk7CgogICAgICAgICAgcmV0dXJuIHRleHRSYW5nZTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB0aGlzLmdldFBvaW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgc2M6IHNjLAogICAgICAgICAgc286IHNvLAogICAgICAgICAgZWM6IGVjLAogICAgICAgICAgZW86IGVvCiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHRoaXMuZ2V0U3RhcnRQb2ludCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbm9kZTogc2MsCiAgICAgICAgICBvZmZzZXQ6IHNvCiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHRoaXMuZ2V0RW5kUG9pbnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG5vZGU6IGVjLAogICAgICAgICAgb2Zmc2V0OiBlbwogICAgICAgIH07CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogc2VsZWN0IHVwZGF0ZSB2aXNpYmxlIHJhbmdlCiAgICAgICAqLwogICAgICB0aGlzLnNlbGVjdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmF0aXZlUm5nID0gbmF0aXZlUmFuZ2UoKTsKICAgICAgICBpZiAoYWdlbnQuaXNXM0NSYW5nZVN1cHBvcnQpIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCA+IDApIHsKICAgICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgfQogICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKG5hdGl2ZVJuZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5hdGl2ZVJuZy5zZWxlY3QoKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogQHJldHVybiB7V3JhcHBlZFJhbmdlfQogICAgICAgKi8KICAgICAgdGhpcy5ub3JtYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGdldFZpc2libGVQb2ludCA9IGZ1bmN0aW9uIChwb2ludCkgewogICAgICAgICAgaWYgKCFkb20uaXNWaXNpYmxlUG9pbnQocG9pbnQpKSB7CiAgICAgICAgICAgIGlmIChkb20uaXNMZWZ0RWRnZVBvaW50KHBvaW50KSkgewogICAgICAgICAgICAgIHBvaW50ID0gZG9tLm5leHRQb2ludFVudGlsKHBvaW50LCBkb20uaXNWaXNpYmxlUG9pbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvbS5pc1JpZ2h0RWRnZVBvaW50KHBvaW50KSkgewogICAgICAgICAgICAgIHBvaW50ID0gZG9tLnByZXZQb2ludFVudGlsKHBvaW50LCBkb20uaXNWaXNpYmxlUG9pbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcG9pbnQ7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIHN0YXJ0UG9pbnQgPSBnZXRWaXNpYmxlUG9pbnQodGhpcy5nZXRTdGFydFBvaW50KCkpOwogICAgICAgIHZhciBlbmRQb2ludCA9IGdldFZpc2libGVQb2ludCh0aGlzLmdldFN0YXJ0UG9pbnQoKSk7CgogICAgICAgIHJldHVybiBuZXcgV3JhcHBlZFJhbmdlKAogICAgICAgICAgc3RhcnRQb2ludC5ub2RlLAogICAgICAgICAgc3RhcnRQb2ludC5vZmZzZXQsCiAgICAgICAgICBlbmRQb2ludC5ub2RlLAogICAgICAgICAgZW5kUG9pbnQub2Zmc2V0CiAgICAgICAgKTsKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiByZXR1cm5zIG1hdGNoZWQgbm9kZXMgb24gcmFuZ2UKICAgICAgICoKICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3ByZWRdIC0gcHJlZGljYXRlIGZ1bmN0aW9uCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5pbmNsdWRlQW5jZXN0b3JdCiAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuZnVsbHlDb250YWluc10KICAgICAgICogQHJldHVybiB7Tm9kZVtdfQogICAgICAgKi8KICAgICAgdGhpcy5ub2RlcyA9IGZ1bmN0aW9uIChwcmVkLCBvcHRpb25zKSB7CiAgICAgICAgcHJlZCA9IHByZWQgfHwgZnVuYy5vazsKCiAgICAgICAgdmFyIGluY2x1ZGVBbmNlc3RvciA9IG9wdGlvbnMgJiYgb3B0aW9ucy5pbmNsdWRlQW5jZXN0b3I7CiAgICAgICAgdmFyIGZ1bGx5Q29udGFpbnMgPSBvcHRpb25zICYmIG9wdGlvbnMuZnVsbHlDb250YWluczsKCiAgICAgICAgLy8gVE9ETyBjb21wYXJlIHBvaW50cyBhbmQgc29ydAogICAgICAgIHZhciBzdGFydFBvaW50ID0gdGhpcy5nZXRTdGFydFBvaW50KCk7CiAgICAgICAgdmFyIGVuZFBvaW50ID0gdGhpcy5nZXRFbmRQb2ludCgpOwoKICAgICAgICB2YXIgbm9kZXMgPSBbXTsKICAgICAgICB2YXIgbGVmdEVkZ2VOb2RlcyA9IFtdOwoKICAgICAgICBkb20ud2Fsa1BvaW50KHN0YXJ0UG9pbnQsIGVuZFBvaW50LCBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgICAgIGlmIChkb20uaXNFZGl0YWJsZShwb2ludC5ub2RlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG5vZGU7CiAgICAgICAgICBpZiAoZnVsbHlDb250YWlucykgewogICAgICAgICAgICBpZiAoZG9tLmlzTGVmdEVkZ2VQb2ludChwb2ludCkpIHsKICAgICAgICAgICAgICBsZWZ0RWRnZU5vZGVzLnB1c2gocG9pbnQubm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRvbS5pc1JpZ2h0RWRnZVBvaW50KHBvaW50KSAmJiBsaXN0LmNvbnRhaW5zKGxlZnRFZGdlTm9kZXMsIHBvaW50Lm5vZGUpKSB7CiAgICAgICAgICAgICAgbm9kZSA9IHBvaW50Lm5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaW5jbHVkZUFuY2VzdG9yKSB7CiAgICAgICAgICAgIG5vZGUgPSBkb20uYW5jZXN0b3IocG9pbnQubm9kZSwgcHJlZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBub2RlID0gcG9pbnQubm9kZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAobm9kZSAmJiBwcmVkKG5vZGUpKSB7CiAgICAgICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIHJldHVybiBsaXN0LnVuaXF1ZShub2Rlcyk7CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogcmV0dXJucyBjb21tb25BbmNlc3RvciBvZiByYW5nZQogICAgICAgKiBAcmV0dXJuIHtFbGVtZW50fSAtIGNvbW1vbkFuY2VzdG9yCiAgICAgICAqLwogICAgICB0aGlzLmNvbW1vbkFuY2VzdG9yID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBkb20uY29tbW9uQW5jZXN0b3Ioc2MsIGVjKTsKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiByZXR1cm5zIGV4cGFuZGVkIHJhbmdlIGJ5IHByZWQKICAgICAgICoKICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZCAtIHByZWRpY2F0ZSBmdW5jdGlvbgogICAgICAgKiBAcmV0dXJuIHtXcmFwcGVkUmFuZ2V9CiAgICAgICAqLwogICAgICB0aGlzLmV4cGFuZCA9IGZ1bmN0aW9uIChwcmVkKSB7CiAgICAgICAgdmFyIHN0YXJ0QW5jZXN0b3IgPSBkb20uYW5jZXN0b3Ioc2MsIHByZWQpOwogICAgICAgIHZhciBlbmRBbmNlc3RvciA9IGRvbS5hbmNlc3RvcihlYywgcHJlZCk7CgogICAgICAgIGlmICghc3RhcnRBbmNlc3RvciAmJiAhZW5kQW5jZXN0b3IpIHsKICAgICAgICAgIHJldHVybiBuZXcgV3JhcHBlZFJhbmdlKHNjLCBzbywgZWMsIGVvKTsKICAgICAgICB9CgogICAgICAgIHZhciBib3VuZGFyeVBvaW50cyA9IHRoaXMuZ2V0UG9pbnRzKCk7CgogICAgICAgIGlmIChzdGFydEFuY2VzdG9yKSB7CiAgICAgICAgICBib3VuZGFyeVBvaW50cy5zYyA9IHN0YXJ0QW5jZXN0b3I7CiAgICAgICAgICBib3VuZGFyeVBvaW50cy5zbyA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoZW5kQW5jZXN0b3IpIHsKICAgICAgICAgIGJvdW5kYXJ5UG9pbnRzLmVjID0gZW5kQW5jZXN0b3I7CiAgICAgICAgICBib3VuZGFyeVBvaW50cy5lbyA9IGRvbS5ub2RlTGVuZ3RoKGVuZEFuY2VzdG9yKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBuZXcgV3JhcHBlZFJhbmdlKAogICAgICAgICAgYm91bmRhcnlQb2ludHMuc2MsCiAgICAgICAgICBib3VuZGFyeVBvaW50cy5zbywKICAgICAgICAgIGJvdW5kYXJ5UG9pbnRzLmVjLAogICAgICAgICAgYm91bmRhcnlQb2ludHMuZW8KICAgICAgICApOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNDb2xsYXBzZVRvU3RhcnQKICAgICAgICogQHJldHVybiB7V3JhcHBlZFJhbmdlfQogICAgICAgKi8KICAgICAgdGhpcy5jb2xsYXBzZSA9IGZ1bmN0aW9uIChpc0NvbGxhcHNlVG9TdGFydCkgewogICAgICAgIGlmIChpc0NvbGxhcHNlVG9TdGFydCkgewogICAgICAgICAgcmV0dXJuIG5ldyBXcmFwcGVkUmFuZ2Uoc2MsIHNvLCBzYywgc28pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IFdyYXBwZWRSYW5nZShlYywgZW8sIGVjLCBlbyk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIHNwbGl0VGV4dCBvbiByYW5nZQogICAgICAgKi8KICAgICAgdGhpcy5zcGxpdFRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGlzU2FtZUNvbnRhaW5lciA9IHNjID09PSBlYzsKICAgICAgICB2YXIgYm91bmRhcnlQb2ludHMgPSB0aGlzLmdldFBvaW50cygpOwoKICAgICAgICBpZiAoZG9tLmlzVGV4dChlYykgJiYgIWRvbS5pc0VkZ2VQb2ludCh0aGlzLmdldEVuZFBvaW50KCkpKSB7CiAgICAgICAgICBlYy5zcGxpdFRleHQoZW8pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRvbS5pc1RleHQoc2MpICYmICFkb20uaXNFZGdlUG9pbnQodGhpcy5nZXRTdGFydFBvaW50KCkpKSB7CiAgICAgICAgICBib3VuZGFyeVBvaW50cy5zYyA9IHNjLnNwbGl0VGV4dChzbyk7CiAgICAgICAgICBib3VuZGFyeVBvaW50cy5zbyA9IDA7CgogICAgICAgICAgaWYgKGlzU2FtZUNvbnRhaW5lcikgewogICAgICAgICAgICBib3VuZGFyeVBvaW50cy5lYyA9IGJvdW5kYXJ5UG9pbnRzLnNjOwogICAgICAgICAgICBib3VuZGFyeVBvaW50cy5lbyA9IGVvIC0gc287CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IFdyYXBwZWRSYW5nZSgKICAgICAgICAgIGJvdW5kYXJ5UG9pbnRzLnNjLAogICAgICAgICAgYm91bmRhcnlQb2ludHMuc28sCiAgICAgICAgICBib3VuZGFyeVBvaW50cy5lYywKICAgICAgICAgIGJvdW5kYXJ5UG9pbnRzLmVvCiAgICAgICAgKTsKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiBkZWxldGUgY29udGVudHMgb24gcmFuZ2UKICAgICAgICogQHJldHVybiB7V3JhcHBlZFJhbmdlfQogICAgICAgKi8KICAgICAgdGhpcy5kZWxldGVDb250ZW50cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodGhpcy5pc0NvbGxhcHNlZCgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIHZhciBybmcgPSB0aGlzLnNwbGl0VGV4dCgpOwogICAgICAgIHZhciBub2RlcyA9IHJuZy5ub2RlcyhudWxsLCB7CiAgICAgICAgICBmdWxseUNvbnRhaW5zOiB0cnVlCiAgICAgICAgfSk7CgogICAgICAgIHZhciBwb2ludCA9IGRvbS5wcmV2UG9pbnRVbnRpbChybmcuZ2V0U3RhcnRQb2ludCgpLCBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgICAgIHJldHVybiAhbGlzdC5jb250YWlucyhub2RlcywgcG9pbnQubm9kZSk7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBlbXB0eVBhcmVudHMgPSBbXTsKICAgICAgICAkLmVhY2gobm9kZXMsIGZ1bmN0aW9uIChpZHgsIG5vZGUpIHsKICAgICAgICAgIC8vIGZpbmQgZW1wdHkgcGFyZW50cwogICAgICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChwb2ludC5ub2RlICE9PSBwYXJlbnQgJiYgZG9tLm5vZGVMZW5ndGgocGFyZW50KSA9PT0gMSkgewogICAgICAgICAgICBlbXB0eVBhcmVudHMucHVzaChwYXJlbnQpOwogICAgICAgICAgfQogICAgICAgICAgZG9tLnJlbW92ZShub2RlLCBmYWxzZSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIHJlbW92ZSBlbXB0eSBwYXJlbnRzCiAgICAgICAgJC5lYWNoKGVtcHR5UGFyZW50cywgZnVuY3Rpb24gKGlkeCwgbm9kZSkgewogICAgICAgICAgZG9tLnJlbW92ZShub2RlLCBmYWxzZSk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBuZXcgV3JhcHBlZFJhbmdlKAogICAgICAgICAgcG9pbnQubm9kZSwKICAgICAgICAgIHBvaW50Lm9mZnNldCwKICAgICAgICAgIHBvaW50Lm5vZGUsCiAgICAgICAgICBwb2ludC5vZmZzZXQKICAgICAgICApOwogICAgICB9OwogICAgICAKICAgICAgLyoqCiAgICAgICAqIG1ha2VJc09uOiByZXR1cm4gaXNPbihwcmVkKSBmdW5jdGlvbgogICAgICAgKi8KICAgICAgdmFyIG1ha2VJc09uID0gZnVuY3Rpb24gKHByZWQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGFuY2VzdG9yID0gZG9tLmFuY2VzdG9yKHNjLCBwcmVkKTsKICAgICAgICAgIHJldHVybiAhIWFuY2VzdG9yICYmIChhbmNlc3RvciA9PT0gZG9tLmFuY2VzdG9yKGVjLCBwcmVkKSk7CiAgICAgICAgfTsKICAgICAgfTsKICAKICAgICAgLy8gaXNPbkVkaXRhYmxlOiBqdWRnZSB3aGV0aGVyIHJhbmdlIGlzIG9uIGVkaXRhYmxlIG9yIG5vdAogICAgICB0aGlzLmlzT25FZGl0YWJsZSA9IG1ha2VJc09uKGRvbS5pc0VkaXRhYmxlKTsKICAgICAgLy8gaXNPbkxpc3Q6IGp1ZGdlIHdoZXRoZXIgcmFuZ2UgaXMgb24gbGlzdCBub2RlIG9yIG5vdAogICAgICB0aGlzLmlzT25MaXN0ID0gbWFrZUlzT24oZG9tLmlzTGlzdCk7CiAgICAgIC8vIGlzT25BbmNob3I6IGp1ZGdlIHdoZXRoZXIgcmFuZ2UgaXMgb24gYW5jaG9yIG5vZGUgb3Igbm90CiAgICAgIHRoaXMuaXNPbkFuY2hvciA9IG1ha2VJc09uKGRvbS5pc0FuY2hvcik7CiAgICAgIC8vIGlzT25BbmNob3I6IGp1ZGdlIHdoZXRoZXIgcmFuZ2UgaXMgb24gY2VsbCBub2RlIG9yIG5vdAogICAgICB0aGlzLmlzT25DZWxsID0gbWFrZUlzT24oZG9tLmlzQ2VsbCk7CgogICAgICAvKioKICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJlZAogICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgKi8KICAgICAgdGhpcy5pc0xlZnRFZGdlT2YgPSBmdW5jdGlvbiAocHJlZCkgewogICAgICAgIGlmICghZG9tLmlzTGVmdEVkZ2VQb2ludCh0aGlzLmdldFN0YXJ0UG9pbnQoKSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBub2RlID0gZG9tLmFuY2VzdG9yKHRoaXMuc2MsIHByZWQpOwogICAgICAgIHJldHVybiBub2RlICYmIGRvbS5pc0xlZnRFZGdlT2YodGhpcy5zYywgbm9kZSk7CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogcmV0dXJucyB3aGV0aGVyIHJhbmdlIHdhcyBjb2xsYXBzZWQgb3Igbm90CiAgICAgICAqLwogICAgICB0aGlzLmlzQ29sbGFwc2VkID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBzYyA9PT0gZWMgJiYgc28gPT09IGVvOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIHdyYXAgaW5saW5lIG5vZGVzIHdoaWNoIGNoaWxkcmVuIG9mIGJvZHkgd2l0aCBwYXJhZ3JhcGgKICAgICAgICoKICAgICAgICogQHJldHVybiB7V3JhcHBlZFJhbmdlfQogICAgICAgKi8KICAgICAgdGhpcy53cmFwQm9keUlubGluZVdpdGhQYXJhID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChkb20uaXNCb2R5Q29udGFpbmVyKHNjKSAmJiBkb20uaXNFbXB0eShzYykpIHsKICAgICAgICAgIHNjLmlubmVySFRNTCA9IGRvbS5lbXB0eVBhcmE7CiAgICAgICAgICByZXR1cm4gbmV3IFdyYXBwZWRSYW5nZShzYy5maXJzdENoaWxkLCAwKTsKICAgICAgICB9CgogICAgICAgIGlmIChkb20uaXNQYXJhSW5saW5lKHNjKSB8fCBkb20uaXNQYXJhKHNjKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBmaW5kIGlubGluZSB0b3AgYW5jZXN0b3IKICAgICAgICB2YXIgdG9wQW5jZXN0b3I7CiAgICAgICAgaWYgKGRvbS5pc0lubGluZShzYykpIHsKICAgICAgICAgIHZhciBhbmNlc3RvcnMgPSBkb20ubGlzdEFuY2VzdG9yKHNjLCBmdW5jLm5vdChkb20uaXNJbmxpbmUpKTsKICAgICAgICAgIHRvcEFuY2VzdG9yID0gbGlzdC5sYXN0KGFuY2VzdG9ycyk7CiAgICAgICAgICBpZiAoIWRvbS5pc0lubGluZSh0b3BBbmNlc3RvcikpIHsKICAgICAgICAgICAgdG9wQW5jZXN0b3IgPSBhbmNlc3RvcnNbYW5jZXN0b3JzLmxlbmd0aCAtIDJdIHx8IHNjLmNoaWxkTm9kZXNbc29dOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0b3BBbmNlc3RvciA9IHNjLmNoaWxkTm9kZXNbc28gLSAxXTsKICAgICAgICB9CgogICAgICAgIC8vIHNpYmxpbmdzIG5vdCBpbiBwYXJhZ3JhcGgKICAgICAgICB2YXIgaW5saW5lU2libGluZ3MgPSBkb20ubGlzdFByZXYodG9wQW5jZXN0b3IsIGRvbS5pc1BhcmFJbmxpbmUpLnJldmVyc2UoKTsKICAgICAgICBpbmxpbmVTaWJsaW5ncyA9IGlubGluZVNpYmxpbmdzLmNvbmNhdChkb20ubGlzdE5leHQodG9wQW5jZXN0b3IubmV4dFNpYmxpbmcsIGRvbS5pc1BhcmFJbmxpbmUpKTsKCiAgICAgICAgLy8gd3JhcCB3aXRoIHBhcmFncmFwaAogICAgICAgIGlmIChpbmxpbmVTaWJsaW5ncy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBwYXJhID0gZG9tLndyYXAobGlzdC5oZWFkKGlubGluZVNpYmxpbmdzKSwgJ3AnKTsKICAgICAgICAgIGRvbS5hcHBlbmRDaGlsZE5vZGVzKHBhcmEsIGxpc3QudGFpbChpbmxpbmVTaWJsaW5ncykpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCk7CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogaW5zZXJ0IG5vZGUgYXQgY3VycmVudCBjdXJzb3IKICAgICAgICoKICAgICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW2lzSW5saW5lXQogICAgICAgKiBAcmV0dXJuIHtOb2RlfQogICAgICAgKi8KICAgICAgdGhpcy5pbnNlcnROb2RlID0gZnVuY3Rpb24gKG5vZGUsIGlzSW5saW5lKSB7CiAgICAgICAgdmFyIHJuZyA9IHRoaXMud3JhcEJvZHlJbmxpbmVXaXRoUGFyYSgpOwogICAgICAgIHZhciBwb2ludCA9IHJuZy5nZXRTdGFydFBvaW50KCk7CgogICAgICAgIHZhciBzcGxpdFJvb3QsIGNvbnRhaW5lciwgcGl2b3Q7CiAgICAgICAgaWYgKGlzSW5saW5lKSB7CiAgICAgICAgICBjb250YWluZXIgPSBkb20uaXNQYXJhKHBvaW50Lm5vZGUpID8gcG9pbnQubm9kZSA6IHBvaW50Lm5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChkb20uaXNQYXJhKHBvaW50Lm5vZGUpKSB7CiAgICAgICAgICAgIHBpdm90ID0gcG9pbnQubm9kZS5jaGlsZE5vZGVzW3BvaW50Lm9mZnNldF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwaXZvdCA9IGRvbS5zcGxpdFRyZWUocG9pbnQubm9kZSwgcG9pbnQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBzcGxpdFJvb3Qgd2lsbCBiZSBjaGlsZE5vZGUgb2YgY29udGFpbmVyCiAgICAgICAgICB2YXIgYW5jZXN0b3JzID0gZG9tLmxpc3RBbmNlc3Rvcihwb2ludC5ub2RlLCBkb20uaXNCb2R5Q29udGFpbmVyKTsKICAgICAgICAgIHZhciB0b3BBbmNlc3RvciA9IGxpc3QubGFzdChhbmNlc3RvcnMpIHx8IHBvaW50Lm5vZGU7CgogICAgICAgICAgaWYgKGRvbS5pc0JvZHlDb250YWluZXIodG9wQW5jZXN0b3IpKSB7CiAgICAgICAgICAgIHNwbGl0Um9vdCA9IGFuY2VzdG9yc1thbmNlc3RvcnMubGVuZ3RoIC0gMl07CiAgICAgICAgICAgIGNvbnRhaW5lciA9IHRvcEFuY2VzdG9yOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3BsaXRSb290ID0gdG9wQW5jZXN0b3I7CiAgICAgICAgICAgIGNvbnRhaW5lciA9IHNwbGl0Um9vdC5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgcGl2b3QgPSBzcGxpdFJvb3QgJiYgZG9tLnNwbGl0VHJlZShzcGxpdFJvb3QsIHBvaW50KTsKICAgICAgICB9CgogICAgICAgIGlmIChwaXZvdCkgewogICAgICAgICAgcGl2b3QucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgcGl2b3QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQobm9kZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgfTsKICAKICAgICAgdGhpcy50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmF0aXZlUm5nID0gbmF0aXZlUmFuZ2UoKTsKICAgICAgICByZXR1cm4gYWdlbnQuaXNXM0NSYW5nZVN1cHBvcnQgPyBuYXRpdmVSbmcudG9TdHJpbmcoKSA6IG5hdGl2ZVJuZy50ZXh0OwogICAgICB9OwogIAogICAgICAvKioKICAgICAgICogY3JlYXRlIG9mZnNldFBhdGggYm9va21hcmsKICAgICAgICogQHBhcmFtIHtOb2RlfSBlZGl0YWJsZQogICAgICAgKi8KICAgICAgdGhpcy5ib29rbWFyayA9IGZ1bmN0aW9uIChlZGl0YWJsZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBzOiB7CiAgICAgICAgICAgIHBhdGg6IGRvbS5tYWtlT2Zmc2V0UGF0aChlZGl0YWJsZSwgc2MpLAogICAgICAgICAgICBvZmZzZXQ6IHNvCiAgICAgICAgICB9LAogICAgICAgICAgZTogewogICAgICAgICAgICBwYXRoOiBkb20ubWFrZU9mZnNldFBhdGgoZWRpdGFibGUsIGVjKSwKICAgICAgICAgICAgb2Zmc2V0OiBlbwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogZ2V0Q2xpZW50UmVjdHMKICAgICAgICogQHJldHVybiB7UmVjdFtdfQogICAgICAgKi8KICAgICAgdGhpcy5nZXRDbGllbnRSZWN0cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmF0aXZlUm5nID0gbmF0aXZlUmFuZ2UoKTsKICAgICAgICByZXR1cm4gbmF0aXZlUm5nLmdldENsaWVudFJlY3RzKCk7CiAgICAgIH07CiAgICB9OwogIAogICAgcmV0dXJuIHsKICAgICAgLyoqCiAgICAgICAqIGNyZWF0ZSBSYW5nZSBPYmplY3QgRnJvbSBhcmd1bWVudHMgb3IgQnJvd3NlciBTZWxlY3Rpb24KICAgICAgICoKICAgICAgICogQHBhcmFtIHtOb2RlfSBzYyAtIHN0YXJ0IGNvbnRhaW5lcgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gc28gLSBzdGFydCBvZmZzZXQKICAgICAgICogQHBhcmFtIHtOb2RlfSBlYyAtIGVuZCBjb250YWluZXIKICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGVvIC0gZW5kIG9mZnNldAogICAgICAgKi8KICAgICAgY3JlYXRlIDogZnVuY3Rpb24gKHNjLCBzbywgZWMsIGVvKSB7CiAgICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGZyb20gQnJvd3NlciBTZWxlY3Rpb24KICAgICAgICAgIGlmIChhZ2VudC5pc1czQ1JhbmdlU3VwcG9ydCkgewogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvbS5pc0JvZHkoc2VsZWN0aW9uLmFuY2hvck5vZGUpKSB7CiAgICAgICAgICAgICAgLy8gRmlyZWZveDogcmV0dXJucyBlbnRpcmUgYm9keSBhcyByYW5nZSBvbiBpbml0aWFsaXphdGlvbi4gV2Ugd29uJ3QgbmV2ZXIgbmVlZCBpdC4KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICB2YXIgbmF0aXZlUm5nID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7CiAgICAgICAgICAgIHNjID0gbmF0aXZlUm5nLnN0YXJ0Q29udGFpbmVyOwogICAgICAgICAgICBzbyA9IG5hdGl2ZVJuZy5zdGFydE9mZnNldDsKICAgICAgICAgICAgZWMgPSBuYXRpdmVSbmcuZW5kQ29udGFpbmVyOwogICAgICAgICAgICBlbyA9IG5hdGl2ZVJuZy5lbmRPZmZzZXQ7CiAgICAgICAgICB9IGVsc2UgeyAvLyBJRTg6IFRleHRSYW5nZQogICAgICAgICAgICB2YXIgdGV4dFJhbmdlID0gZG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgIHZhciB0ZXh0UmFuZ2VFbmQgPSB0ZXh0UmFuZ2UuZHVwbGljYXRlKCk7CiAgICAgICAgICAgIHRleHRSYW5nZUVuZC5jb2xsYXBzZShmYWxzZSk7CiAgICAgICAgICAgIHZhciB0ZXh0UmFuZ2VTdGFydCA9IHRleHRSYW5nZTsKICAgICAgICAgICAgdGV4dFJhbmdlU3RhcnQuY29sbGFwc2UodHJ1ZSk7CiAgCiAgICAgICAgICAgIHZhciBzdGFydFBvaW50ID0gdGV4dFJhbmdlVG9Qb2ludCh0ZXh0UmFuZ2VTdGFydCwgdHJ1ZSksCiAgICAgICAgICAgIGVuZFBvaW50ID0gdGV4dFJhbmdlVG9Qb2ludCh0ZXh0UmFuZ2VFbmQsIGZhbHNlKTsKCiAgICAgICAgICAgIC8vIHNhbWUgdmlzaWJsZSBwb2ludCBjYXNlOiByYW5nZSB3YXMgY29sbGFwc2VkLgogICAgICAgICAgICBpZiAoZG9tLmlzVGV4dChzdGFydFBvaW50Lm5vZGUpICYmIGRvbS5pc0xlZnRFZGdlUG9pbnQoc3RhcnRQb2ludCkgJiYKICAgICAgICAgICAgICAgIGRvbS5pc1RleHROb2RlKGVuZFBvaW50Lm5vZGUpICYmIGRvbS5pc1JpZ2h0RWRnZVBvaW50KGVuZFBvaW50KSAmJgogICAgICAgICAgICAgICAgZW5kUG9pbnQubm9kZS5uZXh0U2libGluZyA9PT0gc3RhcnRQb2ludC5ub2RlKSB7CiAgICAgICAgICAgICAgc3RhcnRQb2ludCA9IGVuZFBvaW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBzYyA9IHN0YXJ0UG9pbnQuY29udDsKICAgICAgICAgICAgc28gPSBzdGFydFBvaW50Lm9mZnNldDsKICAgICAgICAgICAgZWMgPSBlbmRQb2ludC5jb250OwogICAgICAgICAgICBlbyA9IGVuZFBvaW50Lm9mZnNldDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsgLy9jb2xsYXBzZWQKICAgICAgICAgIGVjID0gc2M7CiAgICAgICAgICBlbyA9IHNvOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFdyYXBwZWRSYW5nZShzYywgc28sIGVjLCBlbyk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogY3JlYXRlIFdyYXBwZWRSYW5nZSBmcm9tIG5vZGUKICAgICAgICoKICAgICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgICAqIEByZXR1cm4ge1dyYXBwZWRSYW5nZX0KICAgICAgICovCiAgICAgIGNyZWF0ZUZyb21Ob2RlOiBmdW5jdGlvbiAobm9kZSkgewogICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZShub2RlLCAwLCBub2RlLCAxKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBjcmVhdGUgV3JhcHBlZFJhbmdlIGZyb20gQm9va21hcmsKICAgICAgICoKICAgICAgICogQHBhcmFtIHtOb2RlfSBlZGl0YWJsZQogICAgICAgKiBAcGFyYW0ge09ia2VjdH0gYm9va21hcmsKICAgICAgICogQHJldHVybiB7V3JhcHBlZFJhbmdlfQogICAgICAgKi8KICAgICAgY3JlYXRlRnJvbUJvb2ttYXJrIDogZnVuY3Rpb24gKGVkaXRhYmxlLCBib29rbWFyaykgewogICAgICAgIHZhciBzYyA9IGRvbS5mcm9tT2Zmc2V0UGF0aChlZGl0YWJsZSwgYm9va21hcmsucy5wYXRoKTsKICAgICAgICB2YXIgc28gPSBib29rbWFyay5zLm9mZnNldDsKICAgICAgICB2YXIgZWMgPSBkb20uZnJvbU9mZnNldFBhdGgoZWRpdGFibGUsIGJvb2ttYXJrLmUucGF0aCk7CiAgICAgICAgdmFyIGVvID0gYm9va21hcmsuZS5vZmZzZXQ7CiAgICAgICAgcmV0dXJuIG5ldyBXcmFwcGVkUmFuZ2Uoc2MsIHNvLCBlYywgZW8pOwogICAgICB9CiAgICB9OwogIH0pKCk7CgogIHZhciBzZXR0aW5ncyA9IHsKICAgIC8vIHZlcnNpb24KICAgIHZlcnNpb246ICcwLjYuMCcsCgogICAgLyoqCiAgICAgKiBvcHRpb25zCiAgICAgKi8KICAgIG9wdGlvbnM6IHsKICAgICAgd2lkdGg6IG51bGwsICAgICAgICAgICAgICAgICAgLy8gc2V0IGVkaXRvciB3aWR0aAogICAgICBoZWlnaHQ6IG51bGwsICAgICAgICAgICAgICAgICAvLyBzZXQgZWRpdG9yIGhlaWdodCwgZXgpIDMwMAoKICAgICAgbWluSGVpZ2h0OiBudWxsLCAgICAgICAgICAgICAgLy8gc2V0IG1pbmltdW0gaGVpZ2h0IG9mIGVkaXRvcgogICAgICBtYXhIZWlnaHQ6IG51bGwsICAgICAgICAgICAgICAvLyBzZXQgbWF4aW11bSBoZWlnaHQgb2YgZWRpdG9yCgogICAgICBmb2N1czogZmFsc2UsICAgICAgICAgICAgICAgICAvLyBzZXQgZm9jdXMgdG8gZWRpdGFibGUgYXJlYSBhZnRlciBpbml0aWFsaXppbmcgc3VtbWVybm90ZQoKICAgICAgdGFic2l6ZTogNCwgICAgICAgICAgICAgICAgICAgLy8gc2l6ZSBvZiB0YWIgZXgpIDIgb3IgNAogICAgICBzdHlsZVdpdGhTcGFuOiB0cnVlLCAgICAgICAgICAvLyBzdHlsZSB3aXRoIHNwYW4gKENocm9tZSBhbmQgRkYgb25seSkKCiAgICAgIGRpc2FibGVMaW5rVGFyZ2V0OiBmYWxzZSwgICAgIC8vIGhpZGUgbGluayBUYXJnZXQgQ2hlY2tib3gKICAgICAgZGlzYWJsZURyYWdBbmREcm9wOiBmYWxzZSwgICAgLy8gZGlzYWJsZSBkcmFnIGFuZCBkcm9wIGV2ZW50CiAgICAgIGRpc2FibGVSZXNpemVFZGl0b3I6IGZhbHNlLCAgIC8vIGRpc2FibGUgcmVzaXppbmcgZWRpdG9yCgogICAgICBzaG9ydGN1dHM6IHRydWUsICAgICAgICAgICAgICAvLyBlbmFibGUga2V5Ym9hcmQgc2hvcnRjdXRzCgogICAgICBwbGFjZWhvbGRlcjogZmFsc2UsICAgICAgICAgICAvLyBlbmFibGUgcGxhY2Vob2xkZXIgdGV4dAoKICAgICAgY29kZW1pcnJvcjogeyAgICAgICAgICAgICAgICAgLy8gY29kZW1pcnJvciBvcHRpb25zCiAgICAgICAgbW9kZTogJ3RleHQvaHRtbCcsCiAgICAgICAgaHRtbE1vZGU6IHRydWUsCiAgICAgICAgbGluZU51bWJlcnM6IHRydWUKICAgICAgfSwKCiAgICAgIC8vIGxhbmd1YWdlCiAgICAgIGxhbmc6ICdlbi1VUycsICAgICAgICAgICAgICAgIC8vIGxhbmd1YWdlICdlbi1VUycsICdrby1LUicsIC4uLgogICAgICBkaXJlY3Rpb246IG51bGwsICAgICAgICAgICAgICAvLyB0ZXh0IGRpcmVjdGlvbiwgZXgpICdydGwnCgogICAgICAvLyB0b29sYmFyCiAgICAgIHRvb2xiYXI6IFsKICAgICAgICBbJ3N0eWxlJywgWydzdHlsZSddXSwKICAgICAgICBbJ2ZvbnQnLCBbJ2JvbGQnLCAnaXRhbGljJywgJ3VuZGVybGluZScsICdjbGVhciddXSwKICAgICAgICBbJ2ZvbnRuYW1lJywgWydmb250bmFtZSddXSwKICAgICAgICBbJ2NvbG9yJywgWydjb2xvciddXSwKICAgICAgICBbJ3BhcmEnLCBbJ3VsJywgJ29sJywgJ3BhcmFncmFwaCddXSwKICAgICAgICBbJ2hlaWdodCcsIFsnaGVpZ2h0J11dLAogICAgICAgIFsndGFibGUnLCBbJ3RhYmxlJ11dLAogICAgICAgIFsnaW5zZXJ0JywgWydsaW5rJywgJ3BpY3R1cmUnLCAnaHInXV0sCiAgICAgICAgWyd2aWV3JywgWydmdWxsc2NyZWVuJywgJ2NvZGV2aWV3J11dLAogICAgICAgIFsnaGVscCcsIFsnaGVscCddXQogICAgICBdLAoKICAgICAgLy8gYWlyIG1vZGU6IGlubGluZSBlZGl0b3IKICAgICAgYWlyTW9kZTogZmFsc2UsCiAgICAgIC8vIGFpclBvcG92ZXI6IFsKICAgICAgLy8gICBbJ3N0eWxlJywgWydzdHlsZSddXSwKICAgICAgLy8gICBbJ2ZvbnQnLCBbJ2JvbGQnLCAnaXRhbGljJywgJ3VuZGVybGluZScsICdjbGVhciddXSwKICAgICAgLy8gICBbJ2ZvbnRuYW1lJywgWydmb250bmFtZSddXSwKICAgICAgLy8gICBbJ2NvbG9yJywgWydjb2xvciddXSwKICAgICAgLy8gICBbJ3BhcmEnLCBbJ3VsJywgJ29sJywgJ3BhcmFncmFwaCddXSwKICAgICAgLy8gICBbJ2hlaWdodCcsIFsnaGVpZ2h0J11dLAogICAgICAvLyAgIFsndGFibGUnLCBbJ3RhYmxlJ11dLAogICAgICAvLyAgIFsnaW5zZXJ0JywgWydsaW5rJywgJ3BpY3R1cmUnXV0sCiAgICAgIC8vICAgWydoZWxwJywgWydoZWxwJ11dCiAgICAgIC8vIF0sCiAgICAgIGFpclBvcG92ZXI6IFsKICAgICAgICBbJ2NvbG9yJywgWydjb2xvciddXSwKICAgICAgICBbJ2ZvbnQnLCBbJ2JvbGQnLCAndW5kZXJsaW5lJywgJ2NsZWFyJ11dLAogICAgICAgIFsncGFyYScsIFsndWwnLCAncGFyYWdyYXBoJ11dLAogICAgICAgIFsndGFibGUnLCBbJ3RhYmxlJ11dLAogICAgICAgIFsnaW5zZXJ0JywgWydsaW5rJywgJ3BpY3R1cmUnXV0KICAgICAgXSwKCiAgICAgIC8vIHN0eWxlIHRhZwogICAgICBzdHlsZVRhZ3M6IFsncCcsICdibG9ja3F1b3RlJywgJ3ByZScsICdoMScsICdoMicsICdoMycsICdoNCcsICdoNScsICdoNiddLAoKICAgICAgLy8gZGVmYXVsdCBmb250TmFtZQogICAgICBkZWZhdWx0Rm9udE5hbWU6ICdIZWx2ZXRpY2EgTmV1ZScsCgogICAgICAvLyBmb250TmFtZQogICAgICBmb250TmFtZXM6IFsKICAgICAgICAnQXJpYWwnLCAnQXJpYWwgQmxhY2snLCAnQ29taWMgU2FucyBNUycsICdDb3VyaWVyIE5ldycsCiAgICAgICAgJ0hlbHZldGljYSBOZXVlJywgJ0ltcGFjdCcsICdMdWNpZGEgR3JhbmRlJywKICAgICAgICAnVGFob21hJywgJ1RpbWVzIE5ldyBSb21hbicsICdWZXJkYW5hJwogICAgICBdLAoKICAgICAgLy8gcGFsbGV0ZSBjb2xvcnMobiB4IG4pCiAgICAgIGNvbG9yczogWwogICAgICAgIFsnIzAwMDAwMCcsICcjNDI0MjQyJywgJyM2MzYzNjMnLCAnIzlDOUM5NCcsICcjQ0VDNkNFJywgJyNFRkVGRUYnLCAnI0Y3RjdGNycsICcjRkZGRkZGJ10sCiAgICAgICAgWycjRkYwMDAwJywgJyNGRjlDMDAnLCAnI0ZGRkYwMCcsICcjMDBGRjAwJywgJyMwMEZGRkYnLCAnIzAwMDBGRicsICcjOUMwMEZGJywgJyNGRjAwRkYnXSwKICAgICAgICBbJyNGN0M2Q0UnLCAnI0ZGRTdDRScsICcjRkZFRkM2JywgJyNENkVGRDYnLCAnI0NFREVFNycsICcjQ0VFN0Y3JywgJyNENkQ2RTcnLCAnI0U3RDZERSddLAogICAgICAgIFsnI0U3OUM5QycsICcjRkZDNjlDJywgJyNGRkU3OUMnLCAnI0I1RDZBNScsICcjQTVDNkNFJywgJyM5Q0M2RUYnLCAnI0I1QTVENicsICcjRDZBNUJEJ10sCiAgICAgICAgWycjRTc2MzYzJywgJyNGN0FENkInLCAnI0ZGRDY2MycsICcjOTRCRDdCJywgJyM3M0E1QUQnLCAnIzZCQURERScsICcjOEM3QkM2JywgJyNDNjdCQTUnXSwKICAgICAgICBbJyNDRTAwMDAnLCAnI0U3OTQzOScsICcjRUZDNjMxJywgJyM2QkE1NEEnLCAnIzRBN0I4QycsICcjMzk4NEM2JywgJyM2MzRBQTUnLCAnI0E1NEE3QiddLAogICAgICAgIFsnIzlDMDAwMCcsICcjQjU2MzA4JywgJyNCRDk0MDAnLCAnIzM5N0IyMScsICcjMTA0QTVBJywgJyMwODUyOTQnLCAnIzMxMTg3MycsICcjNzMxODQyJ10sCiAgICAgICAgWycjNjMwMDAwJywgJyM3QjM5MDAnLCAnIzg0NjMwMCcsICcjMjk1MjE4JywgJyMwODMxMzknLCAnIzAwMzE2MycsICcjMjExMDRBJywgJyM0QTEwMzEnXQogICAgICBdLAoKICAgICAgLy8gbGluZUhlaWdodAogICAgICBsaW5lSGVpZ2h0czogWycxLjAnLCAnMS4yJywgJzEuNCcsICcxLjUnLCAnMS42JywgJzEuOCcsICcyLjAnLCAnMy4wJ10sCgogICAgICAvLyBpbnNlcnRUYWJsZSBtYXggc2l6ZQogICAgICBpbnNlcnRUYWJsZU1heFNpemU6IHsKICAgICAgICBjb2w6IDEwLAogICAgICAgIHJvdzogMTAKICAgICAgfSwKCiAgICAgIC8vIGltYWdlCiAgICAgIG1heGltdW1JbWFnZUZpbGVTaXplOiBudWxsLCAvLyBzaXplIGluIGJ5dGVzLCBudWxsID0gbm8gbGltaXQKCiAgICAgIC8vIGNhbGxiYWNrcwogICAgICBvbmluaXQ6IG51bGwsICAgICAgICAgICAgIC8vIGluaXRpYWxpemUKICAgICAgb25mb2N1czogbnVsbCwgICAgICAgICAgICAvLyBlZGl0YWJsZSBoYXMgZm9jdXMKICAgICAgb25ibHVyOiBudWxsLCAgICAgICAgICAgICAvLyBlZGl0YWJsZSBvdXQgb2YgZm9jdXMKICAgICAgb25lbnRlcjogbnVsbCwgICAgICAgICAgICAvLyBlbnRlciBrZXkgcHJlc3NlZAogICAgICBvbmtleXVwOiBudWxsLCAgICAgICAgICAgIC8vIGtleXVwCiAgICAgIG9ua2V5ZG93bjogbnVsbCwgICAgICAgICAgLy8ga2V5ZG93bgogICAgICBvbkltYWdlVXBsb2FkOiBudWxsLCAgICAgIC8vIGltYWdlVXBsb2FkCiAgICAgIG9uSW1hZ2VVcGxvYWRFcnJvcjogbnVsbCwgLy8gaW1hZ2VVcGxvYWRFcnJvcgogICAgICBvblRvb2xiYXJDbGljazogbnVsbCwKICAgICAgb25zdWJtaXQ6IG51bGwsCgogICAgICAvKioKICAgICAgICogbWFuaXB1bGF0ZSBsaW5rIGFkZHJlc3Mgd2hlbiB1c2VyIGNyZWF0ZSBsaW5rCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzTGlua1VybAogICAgICAgKiBAcmV0dXJuIHtTdHJpbmd9CiAgICAgICAqLwogICAgICBvbkNyZWF0ZUxpbms6IGZ1bmN0aW9uIChzTGlua1VybCkgewogICAgICAgIGlmIChzTGlua1VybC5pbmRleE9mKCdAJykgIT09IC0xICYmIHNMaW5rVXJsLmluZGV4T2YoJzonKSA9PT0gLTEpIHsKICAgICAgICAgIHNMaW5rVXJsID0gICdtYWlsdG86JyArIHNMaW5rVXJsOwogICAgICAgIH0gZWxzZSBpZiAoc0xpbmtVcmwuaW5kZXhPZignOi8vJykgPT09IC0xKSB7CiAgICAgICAgICBzTGlua1VybCA9ICdodHRwOi8vJyArIHNMaW5rVXJsOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNMaW5rVXJsOwogICAgICB9LAoKICAgICAga2V5TWFwOiB7CiAgICAgICAgcGM6IHsKICAgICAgICAgICdFTlRFUic6ICdpbnNlcnRQYXJhZ3JhcGgnLAogICAgICAgICAgJ0NUUkwrWic6ICd1bmRvJywKICAgICAgICAgICdDVFJMK1knOiAncmVkbycsCiAgICAgICAgICAnVEFCJzogJ3RhYicsCiAgICAgICAgICAnU0hJRlQrVEFCJzogJ3VudGFiJywKICAgICAgICAgICdDVFJMK0InOiAnYm9sZCcsCiAgICAgICAgICAnQ1RSTCtJJzogJ2l0YWxpYycsCiAgICAgICAgICAnQ1RSTCtVJzogJ3VuZGVybGluZScsCiAgICAgICAgICAnQ1RSTCtTSElGVCtTJzogJ3N0cmlrZXRocm91Z2gnLAogICAgICAgICAgJ0NUUkwrQkFDS1NMQVNIJzogJ3JlbW92ZUZvcm1hdCcsCiAgICAgICAgICAnQ1RSTCtTSElGVCtMJzogJ2p1c3RpZnlMZWZ0JywKICAgICAgICAgICdDVFJMK1NISUZUK0UnOiAnanVzdGlmeUNlbnRlcicsCiAgICAgICAgICAnQ1RSTCtTSElGVCtSJzogJ2p1c3RpZnlSaWdodCcsCiAgICAgICAgICAnQ1RSTCtTSElGVCtKJzogJ2p1c3RpZnlGdWxsJywKICAgICAgICAgICdDVFJMK1NISUZUK05VTTcnOiAnaW5zZXJ0VW5vcmRlcmVkTGlzdCcsCiAgICAgICAgICAnQ1RSTCtTSElGVCtOVU04JzogJ2luc2VydE9yZGVyZWRMaXN0JywKICAgICAgICAgICdDVFJMK0xFRlRCUkFDS0VUJzogJ291dGRlbnQnLAogICAgICAgICAgJ0NUUkwrUklHSFRCUkFDS0VUJzogJ2luZGVudCcsCiAgICAgICAgICAnQ1RSTCtOVU0wJzogJ2Zvcm1hdFBhcmEnLAogICAgICAgICAgJ0NUUkwrTlVNMSc6ICdmb3JtYXRIMScsCiAgICAgICAgICAnQ1RSTCtOVU0yJzogJ2Zvcm1hdEgyJywKICAgICAgICAgICdDVFJMK05VTTMnOiAnZm9ybWF0SDMnLAogICAgICAgICAgJ0NUUkwrTlVNNCc6ICdmb3JtYXRINCcsCiAgICAgICAgICAnQ1RSTCtOVU01JzogJ2Zvcm1hdEg1JywKICAgICAgICAgICdDVFJMK05VTTYnOiAnZm9ybWF0SDYnLAogICAgICAgICAgJ0NUUkwrRU5URVInOiAnaW5zZXJ0SG9yaXpvbnRhbFJ1bGUnLAogICAgICAgICAgJ0NUUkwrSyc6ICdzaG93TGlua0RpYWxvZycKICAgICAgICB9LAoKICAgICAgICBtYWM6IHsKICAgICAgICAgICdFTlRFUic6ICdpbnNlcnRQYXJhZ3JhcGgnLAogICAgICAgICAgJ0NNRCtaJzogJ3VuZG8nLAogICAgICAgICAgJ0NNRCtTSElGVCtaJzogJ3JlZG8nLAogICAgICAgICAgJ1RBQic6ICd0YWInLAogICAgICAgICAgJ1NISUZUK1RBQic6ICd1bnRhYicsCiAgICAgICAgICAnQ01EK0InOiAnYm9sZCcsCiAgICAgICAgICAnQ01EK0knOiAnaXRhbGljJywKICAgICAgICAgICdDTUQrVSc6ICd1bmRlcmxpbmUnLAogICAgICAgICAgJ0NNRCtTSElGVCtTJzogJ3N0cmlrZXRocm91Z2gnLAogICAgICAgICAgJ0NNRCtCQUNLU0xBU0gnOiAncmVtb3ZlRm9ybWF0JywKICAgICAgICAgICdDTUQrU0hJRlQrTCc6ICdqdXN0aWZ5TGVmdCcsCiAgICAgICAgICAnQ01EK1NISUZUK0UnOiAnanVzdGlmeUNlbnRlcicsCiAgICAgICAgICAnQ01EK1NISUZUK1InOiAnanVzdGlmeVJpZ2h0JywKICAgICAgICAgICdDTUQrU0hJRlQrSic6ICdqdXN0aWZ5RnVsbCcsCiAgICAgICAgICAnQ01EK1NISUZUK05VTTcnOiAnaW5zZXJ0VW5vcmRlcmVkTGlzdCcsCiAgICAgICAgICAnQ01EK1NISUZUK05VTTgnOiAnaW5zZXJ0T3JkZXJlZExpc3QnLAogICAgICAgICAgJ0NNRCtMRUZUQlJBQ0tFVCc6ICdvdXRkZW50JywKICAgICAgICAgICdDTUQrUklHSFRCUkFDS0VUJzogJ2luZGVudCcsCiAgICAgICAgICAnQ01EK05VTTAnOiAnZm9ybWF0UGFyYScsCiAgICAgICAgICAnQ01EK05VTTEnOiAnZm9ybWF0SDEnLAogICAgICAgICAgJ0NNRCtOVU0yJzogJ2Zvcm1hdEgyJywKICAgICAgICAgICdDTUQrTlVNMyc6ICdmb3JtYXRIMycsCiAgICAgICAgICAnQ01EK05VTTQnOiAnZm9ybWF0SDQnLAogICAgICAgICAgJ0NNRCtOVU01JzogJ2Zvcm1hdEg1JywKICAgICAgICAgICdDTUQrTlVNNic6ICdmb3JtYXRINicsCiAgICAgICAgICAnQ01EK0VOVEVSJzogJ2luc2VydEhvcml6b250YWxSdWxlJywKICAgICAgICAgICdDTUQrSyc6ICdzaG93TGlua0RpYWxvZycKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gZGVmYXVsdCBsYW5ndWFnZTogZW4tVVMKICAgIGxhbmc6IHsKICAgICAgJ2VuLVVTJzogewogICAgICAgIGZvbnQ6IHsKICAgICAgICAgIGJvbGQ6ICdCb2xkJywKICAgICAgICAgIGl0YWxpYzogJ0l0YWxpYycsCiAgICAgICAgICB1bmRlcmxpbmU6ICdVbmRlcmxpbmUnLAogICAgICAgICAgY2xlYXI6ICdSZW1vdmUgRm9udCBTdHlsZScsCiAgICAgICAgICBoZWlnaHQ6ICdMaW5lIEhlaWdodCcsCiAgICAgICAgICBuYW1lOiAnRm9udCBGYW1pbHknCiAgICAgICAgfSwKICAgICAgICBpbWFnZTogewogICAgICAgICAgaW1hZ2U6ICdQaWN0dXJlJywKICAgICAgICAgIGluc2VydDogJ0luc2VydCBJbWFnZScsCiAgICAgICAgICByZXNpemVGdWxsOiAnUmVzaXplIEZ1bGwnLAogICAgICAgICAgcmVzaXplSGFsZjogJ1Jlc2l6ZSBIYWxmJywKICAgICAgICAgIHJlc2l6ZVF1YXJ0ZXI6ICdSZXNpemUgUXVhcnRlcicsCiAgICAgICAgICBmbG9hdExlZnQ6ICdGbG9hdCBMZWZ0JywKICAgICAgICAgIGZsb2F0UmlnaHQ6ICdGbG9hdCBSaWdodCcsCiAgICAgICAgICBmbG9hdE5vbmU6ICdGbG9hdCBOb25lJywKICAgICAgICAgIHNoYXBlUm91bmRlZDogJ1NoYXBlOiBSb3VuZGVkJywKICAgICAgICAgIHNoYXBlQ2lyY2xlOiAnU2hhcGU6IENpcmNsZScsCiAgICAgICAgICBzaGFwZVRodW1ibmFpbDogJ1NoYXBlOiBUaHVtYm5haWwnLAogICAgICAgICAgc2hhcGVOb25lOiAnU2hhcGU6IE5vbmUnLAogICAgICAgICAgZHJhZ0ltYWdlSGVyZTogJ0RyYWcgaW1hZ2Ugb3IgdGV4dCBoZXJlJywKICAgICAgICAgIGRyb3BJbWFnZTogJ0Ryb3AgaW1hZ2Ugb3IgVGV4dCcsCiAgICAgICAgICBzZWxlY3RGcm9tRmlsZXM6ICdTZWxlY3QgZnJvbSBmaWxlcycsCiAgICAgICAgICBtYXhpbXVtRmlsZVNpemU6ICdNYXhpbXVtIGZpbGUgc2l6ZScsCiAgICAgICAgICBtYXhpbXVtRmlsZVNpemVFcnJvcjogJ01heGltdW0gZmlsZSBzaXplIGV4Y2VlZGVkLicsCiAgICAgICAgICB1cmw6ICdJbWFnZSBVUkwnLAogICAgICAgICAgcmVtb3ZlOiAnUmVtb3ZlIEltYWdlJwogICAgICAgIH0sCiAgICAgICAgbGluazogewogICAgICAgICAgbGluazogJ0xpbmsnLAogICAgICAgICAgaW5zZXJ0OiAnSW5zZXJ0IExpbmsnLAogICAgICAgICAgdW5saW5rOiAnVW5saW5rJywKICAgICAgICAgIGVkaXQ6ICdFZGl0JywKICAgICAgICAgIHRleHRUb0Rpc3BsYXk6ICdUZXh0IHRvIGRpc3BsYXknLAogICAgICAgICAgdXJsOiAnVG8gd2hhdCBVUkwgc2hvdWxkIHRoaXMgbGluayBnbz8nLAogICAgICAgICAgb3BlbkluTmV3V2luZG93OiAnT3BlbiBpbiBuZXcgd2luZG93JwogICAgICAgIH0sCiAgICAgICAgdGFibGU6IHsKICAgICAgICAgIHRhYmxlOiAnVGFibGUnCiAgICAgICAgfSwKICAgICAgICBocjogewogICAgICAgICAgaW5zZXJ0OiAnSW5zZXJ0IEhvcml6b250YWwgUnVsZScKICAgICAgICB9LAogICAgICAgIHN0eWxlOiB7CiAgICAgICAgICBzdHlsZTogJ1N0eWxlJywKICAgICAgICAgIG5vcm1hbDogJ05vcm1hbCcsCiAgICAgICAgICBibG9ja3F1b3RlOiAnUXVvdGUnLAogICAgICAgICAgcHJlOiAnQ29kZScsCiAgICAgICAgICBoMTogJ0hlYWRlciAxJywKICAgICAgICAgIGgyOiAnSGVhZGVyIDInLAogICAgICAgICAgaDM6ICdIZWFkZXIgMycsCiAgICAgICAgICBoNDogJ0hlYWRlciA0JywKICAgICAgICAgIGg1OiAnSGVhZGVyIDUnLAogICAgICAgICAgaDY6ICdIZWFkZXIgNicKICAgICAgICB9LAogICAgICAgIGxpc3RzOiB7CiAgICAgICAgICB1bm9yZGVyZWQ6ICdVbm9yZGVyZWQgbGlzdCcsCiAgICAgICAgICBvcmRlcmVkOiAnT3JkZXJlZCBsaXN0JwogICAgICAgIH0sCiAgICAgICAgb3B0aW9uczogewogICAgICAgICAgaGVscDogJ0hlbHAnLAogICAgICAgICAgZnVsbHNjcmVlbjogJ0Z1bGwgU2NyZWVuJywKICAgICAgICAgIGNvZGV2aWV3OiAnQ29kZSBWaWV3JwogICAgICAgIH0sCiAgICAgICAgcGFyYWdyYXBoOiB7CiAgICAgICAgICBwYXJhZ3JhcGg6ICdQYXJhZ3JhcGgnLAogICAgICAgICAgb3V0ZGVudDogJ091dGRlbnQnLAogICAgICAgICAgaW5kZW50OiAnSW5kZW50JywKICAgICAgICAgIGxlZnQ6ICdBbGlnbiBsZWZ0JywKICAgICAgICAgIGNlbnRlcjogJ0FsaWduIGNlbnRlcicsCiAgICAgICAgICByaWdodDogJ0FsaWduIHJpZ2h0JywKICAgICAgICAgIGp1c3RpZnk6ICdKdXN0aWZ5IGZ1bGwnCiAgICAgICAgfSwKICAgICAgICBjb2xvcjogewogICAgICAgICAgcmVjZW50OiAnUmVjZW50IENvbG9yJywKICAgICAgICAgIG1vcmU6ICdNb3JlIENvbG9yJywKICAgICAgICAgIGJhY2tncm91bmQ6ICdCYWNrZ3JvdW5kIENvbG9yJywKICAgICAgICAgIGZvcmVncm91bmQ6ICdGb3JlZ3JvdW5kIENvbG9yJywKICAgICAgICAgIHRyYW5zcGFyZW50OiAnVHJhbnNwYXJlbnQnLAogICAgICAgICAgc2V0VHJhbnNwYXJlbnQ6ICdTZXQgdHJhbnNwYXJlbnQnLAogICAgICAgICAgcmVzZXQ6ICdSZXNldCcsCiAgICAgICAgICByZXNldFRvRGVmYXVsdDogJ1Jlc2V0IHRvIGRlZmF1bHQnCiAgICAgICAgfSwKICAgICAgICBzaG9ydGN1dDogewogICAgICAgICAgc2hvcnRjdXRzOiAnS2V5Ym9hcmQgc2hvcnRjdXRzJywKICAgICAgICAgIGNsb3NlOiAnQ2xvc2UnLAogICAgICAgICAgdGV4dEZvcm1hdHRpbmc6ICdUZXh0IGZvcm1hdHRpbmcnLAogICAgICAgICAgYWN0aW9uOiAnQWN0aW9uJywKICAgICAgICAgIHBhcmFncmFwaEZvcm1hdHRpbmc6ICdQYXJhZ3JhcGggZm9ybWF0dGluZycsCiAgICAgICAgICBkb2N1bWVudFN0eWxlOiAnRG9jdW1lbnQgU3R5bGUnLAogICAgICAgICAgZXh0cmFLZXlzOiAnRXh0cmEga2V5cycKICAgICAgICB9LAogICAgICAgIGhpc3Rvcnk6IHsKICAgICAgICAgIHVuZG86ICdVbmRvJywKICAgICAgICAgIHJlZG86ICdSZWRvJwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIEFzeW5jIGZ1bmN0aW9ucyB3aGljaCByZXR1cm5zIGBQcm9taXNlYAogICAqLwogIHZhciBhc3luYyA9IChmdW5jdGlvbiAoKSB7CiAgICAvKioKICAgICAqIHJlYWQgY29udGVudHMgb2YgZmlsZSBhcyByZXByZXNlbnRpbmcgVVJMCiAgICAgKgogICAgICogQHBhcmFtIHtGaWxlfSBmaWxlCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAtIHRoZW46IHNEYXRhVXJsCiAgICAgKi8KICAgIHZhciByZWFkRmlsZUFzRGF0YVVSTCA9IGZ1bmN0aW9uIChmaWxlKSB7CiAgICAgIHJldHVybiAkLkRlZmVycmVkKGZ1bmN0aW9uIChkZWZlcnJlZCkgewogICAgICAgICQuZXh0ZW5kKG5ldyBGaWxlUmVhZGVyKCksIHsKICAgICAgICAgIG9ubG9hZDogZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgdmFyIHNEYXRhVVJMID0gZS50YXJnZXQucmVzdWx0OwogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHNEYXRhVVJMKTsKICAgICAgICAgIH0sCiAgICAgICAgICBvbmVycm9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9KS5yZWFkQXNEYXRhVVJMKGZpbGUpOwogICAgICB9KS5wcm9taXNlKCk7CiAgICB9OwogIAogICAgLyoqCiAgICAgKiBjcmVhdGUgYDxpbWFnZT5gIGZyb20gdXJsIHN0cmluZwogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzVXJsCiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAtIHRoZW46ICRpbWFnZQogICAgICovCiAgICB2YXIgY3JlYXRlSW1hZ2UgPSBmdW5jdGlvbiAoc1VybCwgZmlsZW5hbWUpIHsKICAgICAgcmV0dXJuICQuRGVmZXJyZWQoZnVuY3Rpb24gKGRlZmVycmVkKSB7CiAgICAgICAgJCgnPGltZz4nKS5vbmUoJ2xvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCQodGhpcykpOwogICAgICAgIH0pLm9uZSgnZXJyb3IgYWJvcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJCh0aGlzKS5kZXRhY2goKSk7CiAgICAgICAgfSkuY3NzKHsKICAgICAgICAgIGRpc3BsYXk6ICdub25lJwogICAgICAgIH0pLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpCiAgICAgICAgICAuYXR0cignc3JjJywgc1VybCkKICAgICAgICAgIC5hdHRyKCdkYXRhLWZpbGVuYW1lJywgZmlsZW5hbWUpOwogICAgICB9KS5wcm9taXNlKCk7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlYWRGaWxlQXNEYXRhVVJMOiByZWFkRmlsZUFzRGF0YVVSTCwKICAgICAgY3JlYXRlSW1hZ2U6IGNyZWF0ZUltYWdlCiAgICB9OwogIH0pKCk7CgogIC8qKgogICAqIE9iamVjdCBmb3Iga2V5Y29kZXMuCiAgICovCiAgdmFyIGtleSA9IHsKICAgIGlzRWRpdDogZnVuY3Rpb24gKGtleUNvZGUpIHsKICAgICAgcmV0dXJuIGxpc3QuY29udGFpbnMoWzgsIDksIDEzLCAzMl0sIGtleUNvZGUpOwogICAgfSwKICAgIG5hbWVGcm9tQ29kZTogewogICAgICAnOCc6ICdCQUNLU1BBQ0UnLAogICAgICAnOSc6ICdUQUInLAogICAgICAnMTMnOiAnRU5URVInLAogICAgICAnMzInOiAnU1BBQ0UnLAoKICAgICAgLy8gTnVtYmVyOiAwLTkKICAgICAgJzQ4JzogJ05VTTAnLAogICAgICAnNDknOiAnTlVNMScsCiAgICAgICc1MCc6ICdOVU0yJywKICAgICAgJzUxJzogJ05VTTMnLAogICAgICAnNTInOiAnTlVNNCcsCiAgICAgICc1Myc6ICdOVU01JywKICAgICAgJzU0JzogJ05VTTYnLAogICAgICAnNTUnOiAnTlVNNycsCiAgICAgICc1Nic6ICdOVU04JywKCiAgICAgIC8vIEFscGhhYmV0OiBhLXoKICAgICAgJzY2JzogJ0InLAogICAgICAnNjknOiAnRScsCiAgICAgICc3Myc6ICdJJywKICAgICAgJzc0JzogJ0onLAogICAgICAnNzUnOiAnSycsCiAgICAgICc3Nic6ICdMJywKICAgICAgJzgyJzogJ1InLAogICAgICAnODMnOiAnUycsCiAgICAgICc4NSc6ICdVJywKICAgICAgJzg5JzogJ1knLAogICAgICAnOTAnOiAnWicsCgogICAgICAnMTkxJzogJ1NMQVNIJywKICAgICAgJzIxOSc6ICdMRUZUQlJBQ0tFVCcsCiAgICAgICcyMjAnOiAnQkFDS1NMQVNIJywKICAgICAgJzIyMSc6ICdSSUdIVEJSQUNLRVQnCiAgICB9CiAgfTsKCiAgLyoqCiAgICogU3R5bGUKICAgKiBAY2xhc3MKICAgKi8KICB2YXIgU3R5bGUgPSBmdW5jdGlvbiAoKSB7CiAgICAvKioKICAgICAqIHBhc3NpbmcgYW4gYXJyYXkgb2Ygc3R5bGUgcHJvcGVydGllcyB0byAuY3NzKCkKICAgICAqIHdpbGwgcmVzdWx0IGluIGFuIG9iamVjdCBvZiBwcm9wZXJ0eS12YWx1ZSBwYWlycy4KICAgICAqIChjb21wYWJpbGl0eSB3aXRoIHZlcnNpb24gPCAxLjkpCiAgICAgKgogICAgICogQHBhcmFtICB7alF1ZXJ5fSAkb2JqCiAgICAgKiBAcGFyYW0gIHtBcnJheX0gcHJvcGVydHlOYW1lcyAtIEFuIGFycmF5IG9mIG9uZSBvciBtb3JlIENTUyBwcm9wZXJ0aWVzLgogICAgICogQHJldHVybnMge09iamVjdH0KICAgICAqLwogICAgdmFyIGpRdWVyeUNTUyA9IGZ1bmN0aW9uICgkb2JqLCBwcm9wZXJ0eU5hbWVzKSB7CiAgICAgIGlmIChhZ2VudC5qcXVlcnlWZXJzaW9uIDwgMS45KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICQuZWFjaChwcm9wZXJ0eU5hbWVzLCBmdW5jdGlvbiAoaWR4LCBwcm9wZXJ0eU5hbWUpIHsKICAgICAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gJG9iai5jc3MocHJvcGVydHlOYW1lKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJldHVybiAkb2JqLmNzcy5jYWxsKCRvYmosIHByb3BlcnR5TmFtZXMpOwogICAgfTsKCiAgICAvKioKICAgICAqIHBhcmFncmFwaCBsZXZlbCBzdHlsZQogICAgICoKICAgICAqIEBwYXJhbSB7V3JhcHBlZFJhbmdlfSBybmcKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzdHlsZUluZm8KICAgICAqLwogICAgdGhpcy5zdHlsZVBhcmEgPSBmdW5jdGlvbiAocm5nLCBzdHlsZUluZm8pIHsKICAgICAgJC5lYWNoKHJuZy5ub2Rlcyhkb20uaXNQYXJhLCB7CiAgICAgICAgaW5jbHVkZUFuY2VzdG9yOiB0cnVlCiAgICAgIH0pLCBmdW5jdGlvbiAoaWR4LCBwYXJhKSB7CiAgICAgICAgJChwYXJhKS5jc3Moc3R5bGVJbmZvKTsKICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogZ2V0IGN1cnJlbnQgc3R5bGUgb24gY3Vyc29yCiAgICAgKgogICAgICogQHBhcmFtIHtXcmFwcGVkUmFuZ2V9IHJuZwogICAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQgLSB0YXJnZXQgZWxlbWVudCBvbiBldmVudAogICAgICogQHJldHVybiB7T2JqZWN0fSAtIG9iamVjdCBjb250YWlucyBzdHlsZSBwcm9wZXJ0aWVzLgogICAgICovCiAgICB0aGlzLmN1cnJlbnQgPSBmdW5jdGlvbiAocm5nLCB0YXJnZXQpIHsKICAgICAgdmFyICRjb250ID0gJChkb20uaXNUZXh0KHJuZy5zYykgPyBybmcuc2MucGFyZW50Tm9kZSA6IHJuZy5zYyk7CiAgICAgIHZhciBwcm9wZXJ0aWVzID0gWydmb250LWZhbWlseScsICdmb250LXNpemUnLCAndGV4dC1hbGlnbicsICdsaXN0LXN0eWxlLXR5cGUnLCAnbGluZS1oZWlnaHQnXTsKICAgICAgdmFyIHN0eWxlSW5mbyA9IGpRdWVyeUNTUygkY29udCwgcHJvcGVydGllcykgfHwge307CgogICAgICBzdHlsZUluZm9bJ2ZvbnQtc2l6ZSddID0gcGFyc2VJbnQoc3R5bGVJbmZvWydmb250LXNpemUnXSwgMTApOwoKICAgICAgLy8gZG9jdW1lbnQucXVlcnlDb21tYW5kU3RhdGUgZm9yIHRvZ2dsZSBzdGF0ZQogICAgICBzdHlsZUluZm9bJ2ZvbnQtYm9sZCddID0gZG9jdW1lbnQucXVlcnlDb21tYW5kU3RhdGUoJ2JvbGQnKSA\/ICdib2xkJyA6ICdub3JtYWwnOwogICAgICBzdHlsZUluZm9bJ2ZvbnQtaXRhbGljJ10gPSBkb2N1bWVudC5xdWVyeUNvbW1hbmRTdGF0ZSgnaXRhbGljJykgPyAnaXRhbGljJyA6ICdub3JtYWwnOwogICAgICBzdHlsZUluZm9bJ2ZvbnQtdW5kZXJsaW5lJ10gPSBkb2N1bWVudC5xdWVyeUNvbW1hbmRTdGF0ZSgndW5kZXJsaW5lJykgPyAndW5kZXJsaW5lJyA6ICdub3JtYWwnOwogICAgICBzdHlsZUluZm9bJ2ZvbnQtc3RyaWtldGhyb3VnaCddID0gZG9jdW1lbnQucXVlcnlDb21tYW5kU3RhdGUoJ3N0cmlrZVRocm91Z2gnKSA\/ICdzdHJpa2V0aHJvdWdoJyA6ICdub3JtYWwnOwogICAgICBzdHlsZUluZm9bJ2ZvbnQtc3VwZXJzY3JpcHQnXSA9IGRvY3VtZW50LnF1ZXJ5Q29tbWFuZFN0YXRlKCdzdXBlcnNjcmlwdCcpID8gJ3N1cGVyc2NyaXB0JyA6ICdub3JtYWwnOwogICAgICBzdHlsZUluZm9bJ2ZvbnQtc3Vic2NyaXB0J10gPSBkb2N1bWVudC5xdWVyeUNvbW1hbmRTdGF0ZSgnc3Vic2NyaXB0JykgPyAnc3Vic2NyaXB0JyA6ICdub3JtYWwnOwoKICAgICAgLy8gbGlzdC1zdHlsZS10eXBlIHRvIGxpc3Qtc3R5bGUodW5vcmRlcmVkLCBvcmRlcmVkKQogICAgICBpZiAoIXJuZy5pc09uTGlzdCgpKSB7CiAgICAgICAgc3R5bGVJbmZvWydsaXN0LXN0eWxlJ10gPSAnbm9uZSc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGFPcmRlcmVkVHlwZSA9IFsnY2lyY2xlJywgJ2Rpc2MnLCAnZGlzYy1sZWFkaW5nLXplcm8nLCAnc3F1YXJlJ107CiAgICAgICAgdmFyIGlzVW5vcmRlcmVkID0gJC5pbkFycmF5KHN0eWxlSW5mb1snbGlzdC1zdHlsZS10eXBlJ10sIGFPcmRlcmVkVHlwZSkgPiAtMTsKICAgICAgICBzdHlsZUluZm9bJ2xpc3Qtc3R5bGUnXSA9IGlzVW5vcmRlcmVkID8gJ3Vub3JkZXJlZCcgOiAnb3JkZXJlZCc7CiAgICAgIH0KCiAgICAgIHZhciBwYXJhID0gZG9tLmFuY2VzdG9yKHJuZy5zYywgZG9tLmlzUGFyYSk7CiAgICAgIGlmIChwYXJhICYmIHBhcmEuc3R5bGVbJ2xpbmUtaGVpZ2h0J10pIHsKICAgICAgICBzdHlsZUluZm9bJ2xpbmUtaGVpZ2h0J10gPSBwYXJhLnN0eWxlLmxpbmVIZWlnaHQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGxpbmVIZWlnaHQgPSBwYXJzZUludChzdHlsZUluZm9bJ2xpbmUtaGVpZ2h0J10sIDEwKSAvIHBhcnNlSW50KHN0eWxlSW5mb1snZm9udC1zaXplJ10sIDEwKTsKICAgICAgICBzdHlsZUluZm9bJ2xpbmUtaGVpZ2h0J10gPSBsaW5lSGVpZ2h0LnRvRml4ZWQoMSk7CiAgICAgIH0KCiAgICAgIHN0eWxlSW5mby5pbWFnZSA9IGRvbS5pc0ltZyh0YXJnZXQpICYmIHRhcmdldDsKICAgICAgc3R5bGVJbmZvLmFuY2hvciA9IHJuZy5pc09uQW5jaG9yKCkgJiYgZG9tLmFuY2VzdG9yKHJuZy5zYywgZG9tLmlzQW5jaG9yKTsKICAgICAgc3R5bGVJbmZvLmFuY2VzdG9ycyA9IGRvbS5saXN0QW5jZXN0b3Iocm5nLnNjLCBkb20uaXNFZGl0YWJsZSk7CiAgICAgIHN0eWxlSW5mby5yYW5nZSA9IHJuZzsKCiAgICAgIHJldHVybiBzdHlsZUluZm87CiAgICB9OwogIH07CgoKICB2YXIgVHlwaW5nID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZSAKICAgICAqIEBwYXJhbSB7V3JhcHBlZFJhbmdlfSBybmcKICAgICAqIEBwYXJhbSB7TnVtYmVyfSB0YWJzaXplCiAgICAgKi8KICAgIHRoaXMuaW5zZXJ0VGFiID0gZnVuY3Rpb24gKCRlZGl0YWJsZSwgcm5nLCB0YWJzaXplKSB7CiAgICAgIHZhciB0YWIgPSBkb20uY3JlYXRlVGV4dChuZXcgQXJyYXkodGFic2l6ZSArIDEpLmpvaW4oZG9tLk5CU1BfQ0hBUikpOwogICAgICBybmcgPSBybmcuZGVsZXRlQ29udGVudHMoKTsKICAgICAgcm5nLmluc2VydE5vZGUodGFiLCB0cnVlKTsKCiAgICAgIHJuZyA9IHJhbmdlLmNyZWF0ZSh0YWIsIHRhYnNpemUpOwogICAgICBybmcuc2VsZWN0KCk7CiAgICB9OwoKICAgIC8qKgogICAgICogaW5zZXJ0IHBhcmFncmFwaAogICAgICovCiAgICB0aGlzLmluc2VydFBhcmFncmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHJuZyA9IHJhbmdlLmNyZWF0ZSgpOwoKICAgICAgLy8gZGVsZXRlQ29udGVudHMgb24gcmFuZ2UuCiAgICAgIHJuZyA9IHJuZy5kZWxldGVDb250ZW50cygpOwoKICAgICAgLy8gV3JhcCByYW5nZSBpZiBpdCBuZWVkcyB0byBiZSB3cmFwcGVkIGJ5IHBhcmFncmFwaAogICAgICBybmcgPSBybmcud3JhcEJvZHlJbmxpbmVXaXRoUGFyYSgpOwoKICAgICAgLy8gZmluZGluZyBwYXJhZ3JhcGgKICAgICAgdmFyIHNwbGl0Um9vdCA9IGRvbS5hbmNlc3Rvcihybmcuc2MsIGRvbS5pc1BhcmEpOwoKICAgICAgdmFyIG5leHRQYXJhOwogICAgICAvLyBvbiBwYXJhZ3JhcGg6IHNwbGl0IHBhcmFncmFwaAogICAgICBpZiAoc3BsaXRSb290KSB7CiAgICAgICAgbmV4dFBhcmEgPSBkb20uc3BsaXRUcmVlKHNwbGl0Um9vdCwgcm5nLmdldFN0YXJ0UG9pbnQoKSk7CgogICAgICAgIHZhciBlbXB0eUFuY2hvcnMgPSBkb20ubGlzdERlc2NlbmRhbnQoc3BsaXRSb290LCBkb20uaXNFbXB0eUFuY2hvcik7CiAgICAgICAgZW1wdHlBbmNob3JzID0gZW1wdHlBbmNob3JzLmNvbmNhdChkb20ubGlzdERlc2NlbmRhbnQobmV4dFBhcmEsIGRvbS5pc0VtcHR5QW5jaG9yKSk7CgogICAgICAgICQuZWFjaChlbXB0eUFuY2hvcnMsIGZ1bmN0aW9uIChpZHgsIGFuY2hvcikgewogICAgICAgICAgZG9tLnJlbW92ZShhbmNob3IpOwogICAgICAgIH0pOwogICAgICAvLyBubyBwYXJhZ3JhcGg6IGluc2VydCBlbXB0eSBwYXJhZ3JhcGgKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgbmV4dCA9IHJuZy5zYy5jaGlsZE5vZGVzW3JuZy5zb107CiAgICAgICAgbmV4dFBhcmEgPSAkKGRvbS5lbXB0eVBhcmEpWzBdOwogICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICBybmcuc2MuaW5zZXJ0QmVmb3JlKG5leHRQYXJhLCBuZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm5nLnNjLmFwcGVuZENoaWxkKG5leHRQYXJhKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJhbmdlLmNyZWF0ZShuZXh0UGFyYSwgMCkubm9ybWFsaXplKCkuc2VsZWN0KCk7CiAgICB9OwoKICB9OwoKICAvKioKICAgKiBUYWJsZQogICAqIEBjbGFzcwogICAqLwogIHZhciBUYWJsZSA9IGZ1bmN0aW9uICgpIHsKICAgIC8qKgogICAgICogaGFuZGxlIHRhYiBrZXkKICAgICAqCiAgICAgKiBAcGFyYW0ge1dyYXBwZWRSYW5nZX0gcm5nCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGlzU2hpZnQKICAgICAqLwogICAgdGhpcy50YWIgPSBmdW5jdGlvbiAocm5nLCBpc1NoaWZ0KSB7CiAgICAgIHZhciBjZWxsID0gZG9tLmFuY2VzdG9yKHJuZy5jb21tb25BbmNlc3RvcigpLCBkb20uaXNDZWxsKTsKICAgICAgdmFyIHRhYmxlID0gZG9tLmFuY2VzdG9yKGNlbGwsIGRvbS5pc1RhYmxlKTsKICAgICAgdmFyIGNlbGxzID0gZG9tLmxpc3REZXNjZW5kYW50KHRhYmxlLCBkb20uaXNDZWxsKTsKCiAgICAgIHZhciBuZXh0Q2VsbCA9IGxpc3RbaXNTaGlmdCA\/ICdwcmV2JyA6ICduZXh0J10oY2VsbHMsIGNlbGwpOwogICAgICBpZiAobmV4dENlbGwpIHsKICAgICAgICByYW5nZS5jcmVhdGUobmV4dENlbGwsIDApLnNlbGVjdCgpOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogY3JlYXRlIGVtcHR5IHRhYmxlIGVsZW1lbnQKICAgICAqCiAgICAgKiBAcGFyYW0ge051bWJlcn0gcm93Q291bnQKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBjb2xDb3VudAogICAgICogQHJldHVybiB7Tm9kZX0KICAgICAqLwogICAgdGhpcy5jcmVhdGVUYWJsZSA9IGZ1bmN0aW9uIChjb2xDb3VudCwgcm93Q291bnQpIHsKICAgICAgdmFyIHRkcyA9IFtdLCB0ZEhUTUw7CiAgICAgIGZvciAodmFyIGlkeENvbCA9IDA7IGlkeENvbCA8IGNvbENvdW50OyBpZHhDb2wrKykgewogICAgICAgIHRkcy5wdXNoKCc8dGQ+JyArIGRvbS5ibGFuayArICc8L3RkPicpOwogICAgICB9CiAgICAgIHRkSFRNTCA9IHRkcy5qb2luKCcnKTsKCiAgICAgIHZhciB0cnMgPSBbXSwgdHJIVE1MOwogICAgICBmb3IgKHZhciBpZHhSb3cgPSAwOyBpZHhSb3cgPCByb3dDb3VudDsgaWR4Um93KyspIHsKICAgICAgICB0cnMucHVzaCgnPHRyPicgKyB0ZEhUTUwgKyAnPC90cj4nKTsKICAgICAgfQogICAgICB0ckhUTUwgPSB0cnMuam9pbignJyk7CiAgICAgIHJldHVybiAkKCc8dGFibGUgY2xhc3M9InRhYmxlIHRhYmxlLWJvcmRlcmVkIj4nICsgdHJIVE1MICsgJzwvdGFibGU+JylbMF07CiAgICB9OwogIH07CgoKICB2YXIgQnVsbGV0ID0gZnVuY3Rpb24gKCkgewogICAgLyoqCiAgICAgKiB0b2dnbGUgb3JkZXJlZCBsaXN0CiAgICAgKiBAdHlwZSBjb21tYW5kCiAgICAgKi8KICAgIHRoaXMuaW5zZXJ0T3JkZXJlZExpc3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudG9nZ2xlTGlzdCgnT0wnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiB0b2dnbGUgdW5vcmRlcmVkIGxpc3QKICAgICAqIEB0eXBlIGNvbW1hbmQKICAgICAqLwogICAgdGhpcy5pbnNlcnRVbm9yZGVyZWRMaXN0ID0gZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnRvZ2dsZUxpc3QoJ1VMJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogaW5kZW50CiAgICAgKiBAdHlwZSBjb21tYW5kCiAgICAgKi8KICAgIHRoaXMuaW5kZW50ID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBybmcgPSByYW5nZS5jcmVhdGUoKS53cmFwQm9keUlubGluZVdpdGhQYXJhKCk7CgogICAgICB2YXIgcGFyYXMgPSBybmcubm9kZXMoZG9tLmlzUGFyYSwgeyBpbmNsdWRlQW5jZXN0b3I6IHRydWUgfSk7CiAgICAgIHZhciBjbHVzdGVyZWRzID0gbGlzdC5jbHVzdGVyQnkocGFyYXMsIGZ1bmMucGVxMigncGFyZW50Tm9kZScpKTsKCiAgICAgICQuZWFjaChjbHVzdGVyZWRzLCBmdW5jdGlvbiAoaWR4LCBwYXJhcykgewogICAgICAgIHZhciBoZWFkID0gbGlzdC5oZWFkKHBhcmFzKTsKICAgICAgICBpZiAoZG9tLmlzTGkoaGVhZCkpIHsKICAgICAgICAgIHNlbGYud3JhcExpc3QocGFyYXMsIGhlYWQucGFyZW50Tm9kZS5ub2RlTmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICQuZWFjaChwYXJhcywgZnVuY3Rpb24gKGlkeCwgcGFyYSkgewogICAgICAgICAgICAkKHBhcmEpLmNzcygnbWFyZ2luTGVmdCcsIGZ1bmN0aW9uIChpZHgsIHZhbCkgewogICAgICAgICAgICAgIHJldHVybiAocGFyc2VJbnQodmFsLCAxMCkgfHwgMCkgKyAyNTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcm5nLnNlbGVjdCgpOwogICAgfTsKCiAgICAvKioKICAgICAqIG91dGRlbnQKICAgICAqIEB0eXBlIGNvbW1hbmQKICAgICAqLwogICAgdGhpcy5vdXRkZW50ID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBybmcgPSByYW5nZS5jcmVhdGUoKS53cmFwQm9keUlubGluZVdpdGhQYXJhKCk7CgogICAgICB2YXIgcGFyYXMgPSBybmcubm9kZXMoZG9tLmlzUGFyYSwgeyBpbmNsdWRlQW5jZXN0b3I6IHRydWUgfSk7CiAgICAgIHZhciBjbHVzdGVyZWRzID0gbGlzdC5jbHVzdGVyQnkocGFyYXMsIGZ1bmMucGVxMigncGFyZW50Tm9kZScpKTsKCiAgICAgICQuZWFjaChjbHVzdGVyZWRzLCBmdW5jdGlvbiAoaWR4LCBwYXJhcykgewogICAgICAgIHZhciBoZWFkID0gbGlzdC5oZWFkKHBhcmFzKTsKICAgICAgICBpZiAoZG9tLmlzTGkoaGVhZCkpIHsKICAgICAgICAgIHNlbGYucmVsZWFzZUxpc3QoW3BhcmFzXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICQuZWFjaChwYXJhcywgZnVuY3Rpb24gKGlkeCwgcGFyYSkgewogICAgICAgICAgICAkKHBhcmEpLmNzcygnbWFyZ2luTGVmdCcsIGZ1bmN0aW9uIChpZHgsIHZhbCkgewogICAgICAgICAgICAgIHZhbCA9IChwYXJzZUludCh2YWwsIDEwKSB8fCAwKTsKICAgICAgICAgICAgICByZXR1cm4gdmFsID4gMjUgPyB2YWwgLSAyNSA6ICcnOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBybmcuc2VsZWN0KCk7CiAgICB9OwoKICAgIC8qKgogICAgICogdG9nZ2xlIGxpc3QKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBsaXN0TmFtZSAtIE9MIG9yIFVMCiAgICAgKi8KICAgIHRoaXMudG9nZ2xlTGlzdCA9IGZ1bmN0aW9uIChsaXN0TmFtZSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBybmcgPSByYW5nZS5jcmVhdGUoKS53cmFwQm9keUlubGluZVdpdGhQYXJhKCk7CgogICAgICB2YXIgcGFyYXMgPSBybmcubm9kZXMoZG9tLmlzUGFyYSwgeyBpbmNsdWRlQW5jZXN0b3I6IHRydWUgfSk7CiAgICAgIHZhciBjbHVzdGVyZWRzID0gbGlzdC5jbHVzdGVyQnkocGFyYXMsIGZ1bmMucGVxMigncGFyZW50Tm9kZScpKTsKCiAgICAgIC8vIHBhcmFncmFwaCB0byBsaXN0CiAgICAgIGlmIChsaXN0LmZpbmQocGFyYXMsIGRvbS5pc1B1cmVQYXJhKSkgewogICAgICAgICQuZWFjaChjbHVzdGVyZWRzLCBmdW5jdGlvbiAoaWR4LCBwYXJhcykgewogICAgICAgICAgc2VsZi53cmFwTGlzdChwYXJhcywgbGlzdE5hbWUpOwogICAgICAgIH0pOwogICAgICAvLyBsaXN0IHRvIHBhcmFncmFwaCBvciBjaGFuZ2UgbGlzdCBzdHlsZQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBkaWZmTGlzdHMgPSBybmcubm9kZXMoZG9tLmlzTGlzdCwgewogICAgICAgICAgaW5jbHVkZUFuY2VzdG9yOiB0cnVlCiAgICAgICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChsaXN0Tm9kZSkgewogICAgICAgICAgcmV0dXJuICEkLm5vZGVOYW1lKGxpc3ROb2RlLCBsaXN0TmFtZSk7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChkaWZmTGlzdHMubGVuZ3RoKSB7CiAgICAgICAgICAkLmVhY2goZGlmZkxpc3RzLCBmdW5jdGlvbiAoaWR4LCBsaXN0Tm9kZSkgewogICAgICAgICAgICBkb20ucmVwbGFjZShsaXN0Tm9kZSwgbGlzdE5hbWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucmVsZWFzZUxpc3QoY2x1c3RlcmVkcywgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBybmcuc2VsZWN0KCk7CiAgICB9OwoKICAgIC8qKgogICAgICogQHBhcmFtIHtOb2RlW119IHBhcmFzCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbGlzdE5hbWUKICAgICAqLwogICAgdGhpcy53cmFwTGlzdCA9IGZ1bmN0aW9uIChwYXJhcywgbGlzdE5hbWUpIHsKICAgICAgdmFyIGhlYWQgPSBsaXN0LmhlYWQocGFyYXMpOwogICAgICB2YXIgbGFzdCA9IGxpc3QubGFzdChwYXJhcyk7CgogICAgICB2YXIgcHJldkxpc3QgPSBkb20uaXNMaXN0KGhlYWQucHJldmlvdXNTaWJsaW5nKSAmJiBoZWFkLnByZXZpb3VzU2libGluZzsKICAgICAgdmFyIG5leHRMaXN0ID0gZG9tLmlzTGlzdChsYXN0Lm5leHRTaWJsaW5nKSAmJiBsYXN0Lm5leHRTaWJsaW5nOwoKICAgICAgdmFyIGxpc3ROb2RlID0gcHJldkxpc3QgfHwgZG9tLmluc2VydEFmdGVyKGRvbS5jcmVhdGUobGlzdE5hbWUgfHwgJ1VMJyksIGxhc3QpOwoKICAgICAgLy8gUCB0byBMSQogICAgICBwYXJhcyA9ICQubWFwKHBhcmFzLCBmdW5jdGlvbiAocGFyYSkgewogICAgICAgIHJldHVybiBkb20uaXNQdXJlUGFyYShwYXJhKSA\/IGRvbS5yZXBsYWNlKHBhcmEsICdMSScpIDogcGFyYTsKICAgICAgfSk7CgogICAgICAvLyBhcHBlbmQgdG8gbGlzdCg8dWw+LCA8b2w+KQogICAgICBkb20uYXBwZW5kQ2hpbGROb2RlcyhsaXN0Tm9kZSwgcGFyYXMpOwoKICAgICAgaWYgKG5leHRMaXN0KSB7CiAgICAgICAgZG9tLmFwcGVuZENoaWxkTm9kZXMobGlzdE5vZGUsIGxpc3QuZnJvbShuZXh0TGlzdC5jaGlsZE5vZGVzKSk7CiAgICAgICAgZG9tLnJlbW92ZShuZXh0TGlzdCk7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge0FycmF5W119IGNsdXN0ZXJlZHMKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNFc2NhcHNlVG9Cb2R5CiAgICAgKiBAcmV0dXJuIHtOb2RlW119CiAgICAgKi8KICAgIHRoaXMucmVsZWFzZUxpc3QgPSBmdW5jdGlvbiAoY2x1c3RlcmVkcywgaXNFc2NhcHNlVG9Cb2R5KSB7CiAgICAgIHZhciByZWxlYXNlZFBhcmFzID0gW107CgogICAgICAkLmVhY2goY2x1c3RlcmVkcywgZnVuY3Rpb24gKGlkeCwgcGFyYXMpIHsKICAgICAgICB2YXIgaGVhZCA9IGxpc3QuaGVhZChwYXJhcyk7CiAgICAgICAgdmFyIGxhc3QgPSBsaXN0Lmxhc3QocGFyYXMpOwoKICAgICAgICB2YXIgaGVhZExpc3QgPSBpc0VzY2Fwc2VUb0JvZHkgPyBkb20ubGFzdEFuY2VzdG9yKGhlYWQsIGRvbS5pc0xpc3QpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkLnBhcmVudE5vZGU7CiAgICAgICAgdmFyIGxhc3RMaXN0ID0gaGVhZExpc3QuY2hpbGROb2Rlcy5sZW5ndGggPiAxID8gZG9tLnNwbGl0VHJlZShoZWFkTGlzdCwgewogICAgICAgICAgbm9kZTogbGFzdC5wYXJlbnROb2RlLAogICAgICAgICAgb2Zmc2V0OiBkb20ucG9zaXRpb24obGFzdCkgKyAxCiAgICAgICAgfSwgdHJ1ZSkgOiBudWxsOwoKICAgICAgICB2YXIgbWlkZGxlTGlzdCA9IGRvbS5zcGxpdFRyZWUoaGVhZExpc3QsIHsKICAgICAgICAgIG5vZGU6IGhlYWQucGFyZW50Tm9kZSwKICAgICAgICAgIG9mZnNldDogZG9tLnBvc2l0aW9uKGhlYWQpCiAgICAgICAgfSwgdHJ1ZSk7CgogICAgICAgIHBhcmFzID0gaXNFc2NhcHNlVG9Cb2R5ID8gZG9tLmxpc3REZXNjZW5kYW50KG1pZGRsZUxpc3QsIGRvbS5pc0xpKSA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0LmZyb20obWlkZGxlTGlzdC5jaGlsZE5vZGVzKS5maWx0ZXIoZG9tLmlzTGkpOwoKICAgICAgICAvLyBMSSB0byBQCiAgICAgICAgaWYgKGlzRXNjYXBzZVRvQm9keSB8fCAhZG9tLmlzTGlzdChoZWFkTGlzdC5wYXJlbnROb2RlKSkgewogICAgICAgICAgcGFyYXMgPSAkLm1hcChwYXJhcywgZnVuY3Rpb24gKHBhcmEpIHsKICAgICAgICAgICAgcmV0dXJuIGRvbS5yZXBsYWNlKHBhcmEsICdQJyk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgICQuZWFjaChsaXN0LmZyb20ocGFyYXMpLnJldmVyc2UoKSwgZnVuY3Rpb24gKGlkeCwgcGFyYSkgewogICAgICAgICAgZG9tLmluc2VydEFmdGVyKHBhcmEsIGhlYWRMaXN0KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gcmVtb3ZlIGVtcHR5IGxpc3RzCiAgICAgICAgdmFyIHJvb3RMaXN0cyA9IGxpc3QuY29tcGFjdChbaGVhZExpc3QsIG1pZGRsZUxpc3QsIGxhc3RMaXN0XSk7CiAgICAgICAgJC5lYWNoKHJvb3RMaXN0cywgZnVuY3Rpb24gKGlkeCwgcm9vdExpc3QpIHsKICAgICAgICAgIHZhciBsaXN0Tm9kZXMgPSBbcm9vdExpc3RdLmNvbmNhdChkb20ubGlzdERlc2NlbmRhbnQocm9vdExpc3QsIGRvbS5pc0xpc3QpKTsKICAgICAgICAgICQuZWFjaChsaXN0Tm9kZXMucmV2ZXJzZSgpLCBmdW5jdGlvbiAoaWR4LCBsaXN0Tm9kZSkgewogICAgICAgICAgICBpZiAoIWRvbS5ub2RlTGVuZ3RoKGxpc3ROb2RlKSkgewogICAgICAgICAgICAgIGRvbS5yZW1vdmUobGlzdE5vZGUsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgcmVsZWFzZWRQYXJhcyA9IHJlbGVhc2VkUGFyYXMuY29uY2F0KHBhcmFzKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gcmVsZWFzZWRQYXJhczsKICAgIH07CiAgfTsKCiAgLyoqCiAgICogRWRpdG9yCiAgICogQGNsYXNzCiAgICovCiAgdmFyIEVkaXRvciA9IGZ1bmN0aW9uICgpIHsKCiAgICB2YXIgc3R5bGUgPSBuZXcgU3R5bGUoKTsKICAgIHZhciB0YWJsZSA9IG5ldyBUYWJsZSgpOwogICAgdmFyIHR5cGluZyA9IG5ldyBUeXBpbmcoKTsKICAgIHZhciBidWxsZXQgPSBuZXcgQnVsbGV0KCk7CgogICAgLyoqCiAgICAgKiBjcmVhdGUgcmFuZ2UKICAgICAqLwogICAgdGhpcy5jcmVhdGVSYW5nZSA9IGZ1bmN0aW9uICgkZWRpdGFibGUpIHsKICAgICAgJGVkaXRhYmxlLmZvY3VzKCk7CiAgICAgIHJldHVybiByYW5nZS5jcmVhdGUoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBzYXZlIGN1cnJlbnQgcmFuZ2UKICAgICAqCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGVkaXRhYmxlCiAgICAgKi8KICAgIHRoaXMuc2F2ZVJhbmdlID0gZnVuY3Rpb24gKCRlZGl0YWJsZSwgdGhlbkNvbGxhcHNlKSB7CiAgICAgICRlZGl0YWJsZS5mb2N1cygpOwogICAgICAkZWRpdGFibGUuZGF0YSgncmFuZ2UnLCByYW5nZS5jcmVhdGUoKSk7CiAgICAgIGlmICh0aGVuQ29sbGFwc2UpIHsKICAgICAgICByYW5nZS5jcmVhdGUoKS5jb2xsYXBzZSgpLnNlbGVjdCgpOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuc2F2ZU5vZGUgPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgIC8vIGNvcHkgY2hpbGQgbm9kZSByZWZlcmVuY2UKICAgICAgdmFyIGNvcHkgPSBbXTsKICAgICAgZm9yICh2YXIga2V5ICA9IDAsIGxlbiA9ICRlZGl0YWJsZVswXS5jaGlsZE5vZGVzLmxlbmd0aDsga2V5IDwgbGVuOyBrZXkrKykgewogICAgICAgIGNvcHkucHVzaCgkZWRpdGFibGVbMF0uY2hpbGROb2Rlc1trZXldKTsKICAgICAgfQogICAgICAkZWRpdGFibGUuZGF0YSgnY2hpbGROb2RlcycsIGNvcHkpOwogICAgfTsKCiAgICAvKioKICAgICAqIHJlc3RvcmUgbGF0ZWx5IHJhbmdlCiAgICAgKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZQogICAgICovCiAgICB0aGlzLnJlc3RvcmVSYW5nZSA9IGZ1bmN0aW9uICgkZWRpdGFibGUpIHsKICAgICAgdmFyIHJuZyA9ICRlZGl0YWJsZS5kYXRhKCdyYW5nZScpOwogICAgICBpZiAocm5nKSB7CiAgICAgICAgcm5nLnNlbGVjdCgpOwogICAgICAgICRlZGl0YWJsZS5mb2N1cygpOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMucmVzdG9yZU5vZGUgPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgICRlZGl0YWJsZS5odG1sKCcnKTsKICAgICAgdmFyIGNoaWxkID0gJGVkaXRhYmxlLmRhdGEoJ2NoaWxkTm9kZXMnKTsKICAgICAgZm9yICh2YXIgaW5kZXggPSAwLCBsZW4gPSBjaGlsZC5sZW5ndGg7IGluZGV4IDwgbGVuOyBpbmRleCsrKSB7CiAgICAgICAgJGVkaXRhYmxlWzBdLmFwcGVuZENoaWxkKGNoaWxkW2luZGV4XSk7CiAgICAgIH0KICAgIH07CiAgICAvKioKICAgICAqIGN1cnJlbnQgc3R5bGUKICAgICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICAgKi8KICAgIHRoaXMuY3VycmVudFN0eWxlID0gZnVuY3Rpb24gKHRhcmdldCkgewogICAgICB2YXIgcm5nID0gcmFuZ2UuY3JlYXRlKCk7CiAgICAgIHJldHVybiBybmcgPyBybmcuaXNPbkVkaXRhYmxlKCkgJiYgc3R5bGUuY3VycmVudChybmcsIHRhcmdldCkgOiBmYWxzZTsKICAgIH07CgogICAgdmFyIHRyaWdnZXJPbkNoYW5nZSA9IHRoaXMudHJpZ2dlck9uQ2hhbmdlID0gZnVuY3Rpb24gKCRlZGl0YWJsZSkgewogICAgICB2YXIgb25DaGFuZ2UgPSAkZWRpdGFibGUuZGF0YSgnY2FsbGJhY2tzJykub25DaGFuZ2U7CiAgICAgIGlmIChvbkNoYW5nZSkgewogICAgICAgIG9uQ2hhbmdlKCRlZGl0YWJsZS5odG1sKCksICRlZGl0YWJsZSk7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiB1bmRvCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGVkaXRhYmxlCiAgICAgKi8KICAgIHRoaXMudW5kbyA9IGZ1bmN0aW9uICgkZWRpdGFibGUpIHsKICAgICAgJGVkaXRhYmxlLmRhdGEoJ05vdGVIaXN0b3J5JykudW5kbygpOwogICAgICB0cmlnZ2VyT25DaGFuZ2UoJGVkaXRhYmxlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiByZWRvCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGVkaXRhYmxlCiAgICAgKi8KICAgIHRoaXMucmVkbyA9IGZ1bmN0aW9uICgkZWRpdGFibGUpIHsKICAgICAgJGVkaXRhYmxlLmRhdGEoJ05vdGVIaXN0b3J5JykucmVkbygpOwogICAgICB0cmlnZ2VyT25DaGFuZ2UoJGVkaXRhYmxlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBhZnRlciBjb21tYW5kCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGVkaXRhYmxlCiAgICAgKi8KICAgIHZhciBhZnRlckNvbW1hbmQgPSB0aGlzLmFmdGVyQ29tbWFuZCA9IGZ1bmN0aW9uICgkZWRpdGFibGUpIHsKICAgICAgJGVkaXRhYmxlLmRhdGEoJ05vdGVIaXN0b3J5JykucmVjb3JkVW5kbygpOwogICAgICB0cmlnZ2VyT25DaGFuZ2UoJGVkaXRhYmxlKTsKICAgIH07CgogICAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqLwogICAgLy8gbmF0aXZlIGNvbW1hbmRzKHdpdGggZXhlY0NvbW1hbmQpLCBnZW5lcmF0ZSBmdW5jdGlvbiBmb3IgZXhlY0NvbW1hbmQKICAgIHZhciBjb21tYW5kcyA9IFsnYm9sZCcsICdpdGFsaWMnLCAndW5kZXJsaW5lJywgJ3N0cmlrZXRocm91Z2gnLCAnc3VwZXJzY3JpcHQnLCAnc3Vic2NyaXB0JywKICAgICAgICAgICAgICAgICAgICAnanVzdGlmeUxlZnQnLCAnanVzdGlmeUNlbnRlcicsICdqdXN0aWZ5UmlnaHQnLCAnanVzdGlmeUZ1bGwnLAogICAgICAgICAgICAgICAgICAgICdmb3JtYXRCbG9jaycsICdyZW1vdmVGb3JtYXQnLAogICAgICAgICAgICAgICAgICAgICdiYWNrQ29sb3InLCAnZm9yZUNvbG9yJywgJ2luc2VydEhvcml6b250YWxSdWxlJywgJ2ZvbnROYW1lJ107CgogICAgZm9yICh2YXIgaWR4ID0gMCwgbGVuID0gY29tbWFuZHMubGVuZ3RoOyBpZHggPCBsZW47IGlkeCArKykgewogICAgICB0aGlzW2NvbW1hbmRzW2lkeF1dID0gKGZ1bmN0aW9uIChzQ21kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgkZWRpdGFibGUsIHZhbHVlKSB7CiAgICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZChzQ21kLCBmYWxzZSwgdmFsdWUpOwoKICAgICAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgICAgIH07CiAgICAgIH0pKGNvbW1hbmRzW2lkeF0pOwogICAgfQogICAgLyoganNoaW50IGlnbm9yZTplbmQgKi8KCiAgICAvKioKICAgICAqIGhhbmRsZSB0YWIga2V5CiAgICAgKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgdGhpcy50YWIgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCBvcHRpb25zKSB7CiAgICAgIHZhciBybmcgPSByYW5nZS5jcmVhdGUoKTsKICAgICAgaWYgKHJuZy5pc0NvbGxhcHNlZCgpICYmIHJuZy5pc09uQ2VsbCgpKSB7CiAgICAgICAgdGFibGUudGFiKHJuZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHlwaW5nLmluc2VydFRhYigkZWRpdGFibGUsIHJuZywgb3B0aW9ucy50YWJzaXplKTsKICAgICAgICBhZnRlckNvbW1hbmQoJGVkaXRhYmxlKTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIGhhbmRsZSBzaGlmdCt0YWIga2V5CiAgICAgKi8KICAgIHRoaXMudW50YWIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBybmcgPSByYW5nZS5jcmVhdGUoKTsKICAgICAgaWYgKHJuZy5pc0NvbGxhcHNlZCgpICYmIHJuZy5pc09uQ2VsbCgpKSB7CiAgICAgICAgdGFibGUudGFiKHJuZywgdHJ1ZSk7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBpbnNlcnQgcGFyYWdyYXBoCiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlfSAkZWRpdGFibGUKICAgICAqLwogICAgdGhpcy5pbnNlcnRQYXJhZ3JhcGggPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgIHR5cGluZy5pbnNlcnRQYXJhZ3JhcGgoJGVkaXRhYmxlKTsKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZQogICAgICovCiAgICB0aGlzLmluc2VydE9yZGVyZWRMaXN0ID0gZnVuY3Rpb24gKCRlZGl0YWJsZSkgewogICAgICBidWxsZXQuaW5zZXJ0T3JkZXJlZExpc3QoJGVkaXRhYmxlKTsKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZQogICAgICovCiAgICB0aGlzLmluc2VydFVub3JkZXJlZExpc3QgPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgIGJ1bGxldC5pbnNlcnRVbm9yZGVyZWRMaXN0KCRlZGl0YWJsZSk7CiAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZWRpdGFibGUKICAgICAqLwogICAgdGhpcy5pbmRlbnQgPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgIGJ1bGxldC5pbmRlbnQoJGVkaXRhYmxlKTsKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZQogICAgICovCiAgICB0aGlzLm91dGRlbnQgPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgIGJ1bGxldC5vdXRkZW50KCRlZGl0YWJsZSk7CiAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgfTsKCiAgICAvKioKICAgICAqIGluc2VydCBpbWFnZQogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZWRpdGFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzVXJsCiAgICAgKi8KICAgIHRoaXMuaW5zZXJ0SW1hZ2UgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCBzVXJsLCBmaWxlbmFtZSkgewogICAgICBhc3luYy5jcmVhdGVJbWFnZShzVXJsLCBmaWxlbmFtZSkudGhlbihmdW5jdGlvbiAoJGltYWdlKSB7CiAgICAgICAgJGltYWdlLmNzcyh7CiAgICAgICAgICBkaXNwbGF5OiAnJywKICAgICAgICAgIHdpZHRoOiBNYXRoLm1pbigkZWRpdGFibGUud2lkdGgoKSwgJGltYWdlLndpZHRoKCkpCiAgICAgICAgfSk7CiAgICAgICAgcmFuZ2UuY3JlYXRlKCkuaW5zZXJ0Tm9kZSgkaW1hZ2VbMF0pOwogICAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgICB9KS5mYWlsKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY2FsbGJhY2tzID0gJGVkaXRhYmxlLmRhdGEoJ2NhbGxiYWNrcycpOwogICAgICAgIGlmIChjYWxsYmFja3Mub25JbWFnZVVwbG9hZEVycm9yKSB7CiAgICAgICAgICBjYWxsYmFja3Mub25JbWFnZVVwbG9hZEVycm9yKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBpbnNlcnQgbm9kZQogICAgICogQHBhcmFtIHtOb2RlfSAkZWRpdGFibGUKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICogQHBhcmFtIHtCb29sZWFufSBbaXNJbmxpbmVdCiAgICAgKi8KICAgIHRoaXMuaW5zZXJ0Tm9kZSA9IGZ1bmN0aW9uICgkZWRpdGFibGUsIG5vZGUsIGlzSW5saW5lKSB7CiAgICAgIHJhbmdlLmNyZWF0ZSgpLmluc2VydE5vZGUobm9kZSwgaXNJbmxpbmUpOwogICAgICBhZnRlckNvbW1hbmQoJGVkaXRhYmxlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBpbnNlcnQgdGV4dAogICAgICogQHBhcmFtIHtOb2RlfSAkZWRpdGFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0ZXh0CiAgICAgKi8KICAgIHRoaXMuaW5zZXJ0VGV4dCA9IGZ1bmN0aW9uICgkZWRpdGFibGUsIHRleHQpIHsKICAgICAgdmFyIHRleHROb2RlID0gdGhpcy5jcmVhdGVSYW5nZSgkZWRpdGFibGUpLmluc2VydE5vZGUoZG9tLmNyZWF0ZVRleHQodGV4dCksIHRydWUpOwogICAgICByYW5nZS5jcmVhdGUodGV4dE5vZGUsIGRvbS5ub2RlTGVuZ3RoKHRleHROb2RlKSkuc2VsZWN0KCk7CiAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgfTsKCiAgICAvKioKICAgICAqIGZvcm1hdEJsb2NrCiAgICAgKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHRhZ05hbWUKICAgICAqLwogICAgdGhpcy5mb3JtYXRCbG9jayA9IGZ1bmN0aW9uICgkZWRpdGFibGUsIHRhZ05hbWUpIHsKICAgICAgdGFnTmFtZSA9IGFnZW50LmlzTVNJRSA\/ICc8JyArIHRhZ05hbWUgKyAnPicgOiB0YWdOYW1lOwogICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgnRm9ybWF0QmxvY2snLCBmYWxzZSwgdGFnTmFtZSk7CiAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgfTsKCiAgICB0aGlzLmZvcm1hdFBhcmEgPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgIHRoaXMuZm9ybWF0QmxvY2soJGVkaXRhYmxlLCAnUCcpOwogICAgICBhZnRlckNvbW1hbmQoJGVkaXRhYmxlKTsKICAgIH07CgogICAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqLwogICAgZm9yICh2YXIgaWR4ID0gMTsgaWR4IDw9IDY7IGlkeCArKykgewogICAgICB0aGlzWydmb3JtYXRIJyArIGlkeF0gPSBmdW5jdGlvbiAoaWR4KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgkZWRpdGFibGUpIHsKICAgICAgICAgIHRoaXMuZm9ybWF0QmxvY2soJGVkaXRhYmxlLCAnSCcgKyBpZHgpOwogICAgICAgIH07CiAgICAgIH0oaWR4KTsKICAgIH07CiAgICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqLwoKICAgIC8qKgogICAgICogZm9udHNpemUKICAgICAqIEZJWE1FOiBTdGlsbCBidWdneQogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZWRpdGFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSAtIHB4CiAgICAgKi8KICAgIHRoaXMuZm9udFNpemUgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCB2YWx1ZSkgewogICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgnZm9udFNpemUnLCBmYWxzZSwgMyk7CiAgICAgIGlmIChhZ2VudC5pc0ZGKSB7CiAgICAgICAgLy8gZmlyZWZveDogPGZvbnQgc2l6ZT0iMyI+IHRvIDxzcGFuIHN0eWxlPSdmb250LXNpemU9e3ZhbHVlfXB4Oyc+LCBidWdneQogICAgICAgICRlZGl0YWJsZS5maW5kKCdmb250W3NpemU9M10nKS5yZW1vdmVBdHRyKCdzaXplJykuY3NzKCdmb250LXNpemUnLCB2YWx1ZSArICdweCcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGNocm9tZTogPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZTogbWVkaXVtIj4gdG8gPHNwYW4gc3R5bGU9J2ZvbnQtc2l6ZT17dmFsdWV9cHg7Jz4KICAgICAgICAkZWRpdGFibGUuZmluZCgnc3BhbicpLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zdHlsZS5mb250U2l6ZSA9PT0gJ21lZGl1bSc7CiAgICAgICAgfSkuY3NzKCdmb250LXNpemUnLCB2YWx1ZSArICdweCcpOwogICAgICB9CgogICAgICBhZnRlckNvbW1hbmQoJGVkaXRhYmxlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBsaW5lSGVpZ2h0CiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGVkaXRhYmxlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUKICAgICAqLwogICAgdGhpcy5saW5lSGVpZ2h0ID0gZnVuY3Rpb24gKCRlZGl0YWJsZSwgdmFsdWUpIHsKICAgICAgc3R5bGUuc3R5bGVQYXJhKHJhbmdlLmNyZWF0ZSgpLCB7CiAgICAgICAgbGluZUhlaWdodDogdmFsdWUKICAgICAgfSk7CiAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgfTsKCiAgICAvKioKICAgICAqIHVubGluawogICAgICoKICAgICAqIEB0eXBlIGNvbW1hbmQKICAgICAqCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGVkaXRhYmxlCiAgICAgKi8KICAgIHRoaXMudW5saW5rID0gZnVuY3Rpb24gKCRlZGl0YWJsZSkgewogICAgICB2YXIgcm5nID0gcmFuZ2UuY3JlYXRlKCk7CiAgICAgIGlmIChybmcuaXNPbkFuY2hvcigpKSB7CiAgICAgICAgdmFyIGFuY2hvciA9IGRvbS5hbmNlc3Rvcihybmcuc2MsIGRvbS5pc0FuY2hvcik7CiAgICAgICAgcm5nID0gcmFuZ2UuY3JlYXRlRnJvbU5vZGUoYW5jaG9yKTsKICAgICAgICBybmcuc2VsZWN0KCk7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ3VubGluaycpOwoKICAgICAgICBhZnRlckNvbW1hbmQoJGVkaXRhYmxlKTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIGNyZWF0ZSBsaW5rCiAgICAgKgogICAgICogQHR5cGUgY29tbWFuZAogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZWRpdGFibGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsaW5rSW5mbwogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgdGhpcy5jcmVhdGVMaW5rID0gZnVuY3Rpb24gKCRlZGl0YWJsZSwgbGlua0luZm8sIG9wdGlvbnMpIHsKICAgICAgdmFyIGxpbmtVcmwgPSBsaW5rSW5mby51cmw7CiAgICAgIHZhciBsaW5rVGV4dCA9IGxpbmtJbmZvLnRleHQ7CiAgICAgIHZhciBpc05ld1dpbmRvdyA9IGxpbmtJbmZvLm5ld1dpbmRvdzsKICAgICAgdmFyIHJuZyA9IGxpbmtJbmZvLnJhbmdlOwoKICAgICAgaWYgKG9wdGlvbnMub25DcmVhdGVMaW5rKSB7CiAgICAgICAgbGlua1VybCA9IG9wdGlvbnMub25DcmVhdGVMaW5rKGxpbmtVcmwpOwogICAgICB9CgogICAgICBybmcgPSBybmcuZGVsZXRlQ29udGVudHMoKTsKCiAgICAgIC8vIENyZWF0ZSBhIG5ldyBsaW5rIHdoZW4gdGhlcmUgaXMgbm8gYW5jaG9yIG9uIHJhbmdlLgogICAgICB2YXIgYW5jaG9yID0gcm5nLmluc2VydE5vZGUoJCgnPEE+JyArIGxpbmtUZXh0ICsgJzwvQT4nKVswXSwgdHJ1ZSk7CiAgICAgICQoYW5jaG9yKS5hdHRyKHsKICAgICAgICBocmVmOiBsaW5rVXJsLAogICAgICAgIHRhcmdldDogaXNOZXdXaW5kb3cgPyAnX2JsYW5rJyA6ICcnCiAgICAgIH0pOwoKICAgICAgcmFuZ2UuY3JlYXRlRnJvbU5vZGUoYW5jaG9yKS5zZWxlY3QoKTsKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyBsaW5rIGluZm8KICAgICAqCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgKi8KICAgIHRoaXMuZ2V0TGlua0luZm8gPSBmdW5jdGlvbiAoJGVkaXRhYmxlKSB7CiAgICAgICRlZGl0YWJsZS5mb2N1cygpOwoKICAgICAgdmFyIHJuZyA9IHJhbmdlLmNyZWF0ZSgpLmV4cGFuZChkb20uaXNBbmNob3IpOwoKICAgICAgLy8gR2V0IHRoZSBmaXJzdCBhbmNob3Igb24gcmFuZ2UoZm9yIGVkaXQpLgogICAgICB2YXIgJGFuY2hvciA9ICQobGlzdC5oZWFkKHJuZy5ub2Rlcyhkb20uaXNBbmNob3IpKSk7CgogICAgICByZXR1cm4gewogICAgICAgIHJhbmdlOiBybmcsCiAgICAgICAgdGV4dDogcm5nLnRvU3RyaW5nKCksCiAgICAgICAgaXNOZXdXaW5kb3c6ICRhbmNob3IubGVuZ3RoID8gJGFuY2hvci5hdHRyKCd0YXJnZXQnKSA9PT0gJ19ibGFuaycgOiB0cnVlLAogICAgICAgIHVybDogJGFuY2hvci5sZW5ndGggPyAkYW5jaG9yLmF0dHIoJ2hyZWYnKSA6ICcnCiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMuY29sb3IgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCBzT2JqQ29sb3IpIHsKICAgICAgdmFyIG9Db2xvciA9IEpTT04ucGFyc2Uoc09iakNvbG9yKTsKICAgICAgdmFyIGZvcmVDb2xvciA9IG9Db2xvci5mb3JlQ29sb3IsIGJhY2tDb2xvciA9IG9Db2xvci5iYWNrQ29sb3I7CgogICAgICBpZiAoZm9yZUNvbG9yKSB7IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdmb3JlQ29sb3InLCBmYWxzZSwgZm9yZUNvbG9yKTsgfQogICAgICBpZiAoYmFja0NvbG9yKSB7IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdiYWNrQ29sb3InLCBmYWxzZSwgYmFja0NvbG9yKTsgfQoKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwoKICAgIHRoaXMuaW5zZXJ0VGFibGUgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCBzRGltKSB7CiAgICAgIHZhciBkaW1lbnNpb24gPSBzRGltLnNwbGl0KCd4Jyk7CiAgICAgIHZhciBybmcgPSByYW5nZS5jcmVhdGUoKTsKICAgICAgcm5nID0gcm5nLmRlbGV0ZUNvbnRlbnRzKCk7CiAgICAgIHJuZy5pbnNlcnROb2RlKHRhYmxlLmNyZWF0ZVRhYmxlKGRpbWVuc2lvblswXSwgZGltZW5zaW9uWzFdKSk7CiAgICAgIGFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZWRpdGFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZQogICAgICogQHBhcmFtIHtqUXVlcnl9ICR0YXJnZXQKICAgICAqLwogICAgdGhpcy5mbG9hdE1lID0gZnVuY3Rpb24gKCRlZGl0YWJsZSwgdmFsdWUsICR0YXJnZXQpIHsKICAgICAgJHRhcmdldC5jc3MoJ2Zsb2F0JywgdmFsdWUpOwogICAgICBhZnRlckNvbW1hbmQoJGVkaXRhYmxlKTsKICAgIH07CgogICAgdGhpcy5pbWFnZVNoYXBlID0gZnVuY3Rpb24gKCRlZGl0YWJsZSwgdmFsdWUsICR0YXJnZXQpIHsKICAgICAgJHRhcmdldC5yZW1vdmVDbGFzcygnaW1nLXJvdW5kZWQgaW1nLWNpcmNsZSBpbWctdGh1bWJuYWlsJyk7CgogICAgICBpZiAodmFsdWUpIHsKICAgICAgICAkdGFyZ2V0LmFkZENsYXNzKHZhbHVlKTsKICAgICAgfQoKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogcmVzaXplIG92ZXJsYXkgZWxlbWVudAogICAgICogQHBhcmFtIHtqUXVlcnl9ICRlZGl0YWJsZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHZhbHVlCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJHRhcmdldCAtIHRhcmdldCBlbGVtZW50CiAgICAgKi8KICAgIHRoaXMucmVzaXplID0gZnVuY3Rpb24gKCRlZGl0YWJsZSwgdmFsdWUsICR0YXJnZXQpIHsKICAgICAgJHRhcmdldC5jc3MoewogICAgICAgIHdpZHRoOiB2YWx1ZSAqIDEwMCArICclJywKICAgICAgICBoZWlnaHQ6ICcnCiAgICAgIH0pOwoKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQHBhcmFtIHtQb3NpdGlvbn0gcG9zCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJHRhcmdldCAtIHRhcmdldCBlbGVtZW50CiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtiS2VlcFJhdGlvXSAtIGtlZXAgcmF0aW8KICAgICAqLwogICAgdGhpcy5yZXNpemVUbyA9IGZ1bmN0aW9uIChwb3MsICR0YXJnZXQsIGJLZWVwUmF0aW8pIHsKICAgICAgdmFyIGltYWdlU2l6ZTsKICAgICAgaWYgKGJLZWVwUmF0aW8pIHsKICAgICAgICB2YXIgbmV3UmF0aW8gPSBwb3MueSAvIHBvcy54OwogICAgICAgIHZhciByYXRpbyA9ICR0YXJnZXQuZGF0YSgncmF0aW8nKTsKICAgICAgICBpbWFnZVNpemUgPSB7CiAgICAgICAgICB3aWR0aDogcmF0aW8gPiBuZXdSYXRpbyA\/IHBvcy54IDogcG9zLnkgLyByYXRpbywKICAgICAgICAgIGhlaWdodDogcmF0aW8gPiBuZXdSYXRpbyA\/IHBvcy54ICogcmF0aW8gOiBwb3MueQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW1hZ2VTaXplID0gewogICAgICAgICAgd2lkdGg6IHBvcy54LAogICAgICAgICAgaGVpZ2h0OiBwb3MueQogICAgICAgIH07CiAgICAgIH0KCiAgICAgICR0YXJnZXQuY3NzKGltYWdlU2l6ZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogcmVtb3ZlIG1lZGlhIG9iamVjdAogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZWRpdGFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSAtIGR1bW15IGFyZ3VtZW50IChmb3Iga2VlcCBpbnRlcmZhY2UpCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJHRhcmdldCAtIHRhcmdldCBlbGVtZW50CiAgICAgKi8KICAgIHRoaXMucmVtb3ZlTWVkaWEgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCB2YWx1ZSwgJHRhcmdldCkgewogICAgICAkdGFyZ2V0LmRldGFjaCgpOwoKICAgICAgYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIEhpc3RvcnkKICAgKiBAY2xhc3MKICAgKi8KICB2YXIgSGlzdG9yeSA9IGZ1bmN0aW9uICgkZWRpdGFibGUpIHsKICAgIHZhciBzdGFjayA9IFtdLCBzdGFja09mZnNldCA9IC0xOwogICAgdmFyIGVkaXRhYmxlID0gJGVkaXRhYmxlWzBdOwoKICAgIHZhciBtYWtlU25hcHNob3QgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBybmcgPSByYW5nZS5jcmVhdGUoKTsKICAgICAgdmFyIGVtcHR5Qm9va21hcmsgPSB7czoge3BhdGg6IFswXSwgb2Zmc2V0OiAwfSwgZToge3BhdGg6IFswXSwgb2Zmc2V0OiAwfX07CgogICAgICByZXR1cm4gewogICAgICAgIGNvbnRlbnRzOiAkZWRpdGFibGUuaHRtbCgpLAogICAgICAgIGJvb2ttYXJrOiAocm5nID8gcm5nLmJvb2ttYXJrKGVkaXRhYmxlKSA6IGVtcHR5Qm9va21hcmspCiAgICAgIH07CiAgICB9OwoKICAgIHZhciBhcHBseVNuYXBzaG90ID0gZnVuY3Rpb24gKHNuYXBzaG90KSB7CiAgICAgIGlmIChzbmFwc2hvdC5jb250ZW50cyAhPT0gbnVsbCkgewogICAgICAgICRlZGl0YWJsZS5odG1sKHNuYXBzaG90LmNvbnRlbnRzKTsKICAgICAgfQogICAgICBpZiAoc25hcHNob3QuYm9va21hcmsgIT09IG51bGwpIHsKICAgICAgICByYW5nZS5jcmVhdGVGcm9tQm9va21hcmsoZWRpdGFibGUsIHNuYXBzaG90LmJvb2ttYXJrKS5zZWxlY3QoKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnVuZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICgwIDwgc3RhY2tPZmZzZXQpIHsKICAgICAgICBzdGFja09mZnNldC0tOwogICAgICAgIGFwcGx5U25hcHNob3Qoc3RhY2tbc3RhY2tPZmZzZXRdKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnJlZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChzdGFjay5sZW5ndGggLSAxID4gc3RhY2tPZmZzZXQpIHsKICAgICAgICBzdGFja09mZnNldCsrOwogICAgICAgIGFwcGx5U25hcHNob3Qoc3RhY2tbc3RhY2tPZmZzZXRdKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnJlY29yZFVuZG8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHN0YWNrT2Zmc2V0Kys7CgogICAgICAvLyBXYXNoIG91dCBzdGFjayBhZnRlciBzdGFja09mZnNldAogICAgICBpZiAoc3RhY2subGVuZ3RoID4gc3RhY2tPZmZzZXQpIHsKICAgICAgICBzdGFjayA9IHN0YWNrLnNsaWNlKDAsIHN0YWNrT2Zmc2V0KTsKICAgICAgfQoKICAgICAgLy8gQ3JlYXRlIG5ldyBzbmFwc2hvdCBhbmQgcHVzaCBpdCB0byB0aGUgZW5kCiAgICAgIHN0YWNrLnB1c2gobWFrZVNuYXBzaG90KCkpOwogICAgfTsKCiAgICAvLyBDcmVhdGUgZmlyc3QgdW5kbyBzdGFjawogICAgdGhpcy5yZWNvcmRVbmRvKCk7CiAgfTsKCiAgLyoqCiAgICogQnV0dG9uCiAgICovCiAgdmFyIEJ1dHRvbiA9IGZ1bmN0aW9uICgpIHsKICAgIC8qKgogICAgICogdXBkYXRlIGJ1dHRvbiBzdGF0dXMKICAgICAqCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGNvbnRhaW5lcgogICAgICogQHBhcmFtIHtPYmplY3R9IHN0eWxlSW5mbwogICAgICovCiAgICB0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uICgkY29udGFpbmVyLCBzdHlsZUluZm8pIHsKICAgICAgLyoqCiAgICAgICAqIGhhbmRsZSBkcm9wZG93bidzIGNoZWNrIG1hcmsgKGZvciBmb250bmFtZSwgZm9udHNpemUsIGxpbmVIZWlnaHQpLgogICAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGJ0bgogICAgICAgKiBAcGFyYW0ge051bWJlcn0gdmFsdWUKICAgICAgICovCiAgICAgIHZhciBjaGVja0Ryb3Bkb3duTWVudSA9IGZ1bmN0aW9uICgkYnRuLCB2YWx1ZSkgewogICAgICAgICRidG4uZmluZCgnLmRyb3Bkb3duLW1lbnUgbGkgYScpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gYWx3YXlzIGNvbXBhcmUgc3RyaW5nIHRvIGF2b2lkIGNyZWF0aW5nIGFub3RoZXIgZnVuYy4KICAgICAgICAgIHZhciBpc0NoZWNrZWQgPSAoJCh0aGlzKS5kYXRhKCd2YWx1ZScpICsgJycpID09PSAodmFsdWUgKyAnJyk7CiAgICAgICAgICB0aGlzLmNsYXNzTmFtZSA9IGlzQ2hlY2tlZCA\/ICdjaGVja2VkJyA6ICcnOwogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIHVwZGF0ZSBidXR0b24gc3RhdGUoYWN0aXZlIG9yIG5vdCkuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvcgogICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcmVkCiAgICAgICAqLwogICAgICB2YXIgYnRuU3RhdGUgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHByZWQpIHsKICAgICAgICB2YXIgJGJ0biA9ICRjb250YWluZXIuZmluZChzZWxlY3Rvcik7CiAgICAgICAgJGJ0bi50b2dnbGVDbGFzcygnYWN0aXZlJywgcHJlZCgpKTsKICAgICAgfTsKCiAgICAgIC8vIGZvbnRuYW1lCiAgICAgIHZhciAkZm9udG5hbWUgPSAkY29udGFpbmVyLmZpbmQoJy5ub3RlLWZvbnRuYW1lJyk7CiAgICAgIGlmICgkZm9udG5hbWUubGVuZ3RoKSB7CiAgICAgICAgdmFyIHNlbGVjdGVkRm9udCA9IHN0eWxlSW5mb1snZm9udC1mYW1pbHknXTsKICAgICAgICBpZiAoISFzZWxlY3RlZEZvbnQpIHsKICAgICAgICAgIHNlbGVjdGVkRm9udCA9IGxpc3QuaGVhZChzZWxlY3RlZEZvbnQuc3BsaXQoJywnKSk7CiAgICAgICAgICBzZWxlY3RlZEZvbnQgPSBzZWxlY3RlZEZvbnQucmVwbGFjZSgvXCcvZywgJycpOwogICAgICAgICAgJGZvbnRuYW1lLmZpbmQoJy5ub3RlLWN1cnJlbnQtZm9udG5hbWUnKS50ZXh0KHNlbGVjdGVkRm9udCk7CiAgICAgICAgICBjaGVja0Ryb3Bkb3duTWVudSgkZm9udG5hbWUsIHNlbGVjdGVkRm9udCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBmb250c2l6ZQogICAgICB2YXIgJGZvbnRzaXplID0gJGNvbnRhaW5lci5maW5kKCcubm90ZS1mb250c2l6ZScpOwogICAgICAkZm9udHNpemUuZmluZCgnLm5vdGUtY3VycmVudC1mb250c2l6ZScpLnRleHQoc3R5bGVJbmZvWydmb250LXNpemUnXSk7CiAgICAgIGNoZWNrRHJvcGRvd25NZW51KCRmb250c2l6ZSwgcGFyc2VGbG9hdChzdHlsZUluZm9bJ2ZvbnQtc2l6ZSddKSk7CgogICAgICAvLyBsaW5laGVpZ2h0CiAgICAgIHZhciAkbGluZUhlaWdodCA9ICRjb250YWluZXIuZmluZCgnLm5vdGUtaGVpZ2h0Jyk7CiAgICAgIGNoZWNrRHJvcGRvd25NZW51KCRsaW5lSGVpZ2h0LCBwYXJzZUZsb2F0KHN0eWxlSW5mb1snbGluZS1oZWlnaHQnXSkpOwoKICAgICAgYnRuU3RhdGUoJ2J1dHRvbltkYXRhLWV2ZW50PSJib2xkIl0nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHN0eWxlSW5mb1snZm9udC1ib2xkJ10gPT09ICdib2xkJzsKICAgICAgfSk7CiAgICAgIGJ0blN0YXRlKCdidXR0b25bZGF0YS1ldmVudD0iaXRhbGljIl0nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHN0eWxlSW5mb1snZm9udC1pdGFsaWMnXSA9PT0gJ2l0YWxpYyc7CiAgICAgIH0pOwogICAgICBidG5TdGF0ZSgnYnV0dG9uW2RhdGEtZXZlbnQ9InVuZGVybGluZSJdJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBzdHlsZUluZm9bJ2ZvbnQtdW5kZXJsaW5lJ10gPT09ICd1bmRlcmxpbmUnOwogICAgICB9KTsKICAgICAgYnRuU3RhdGUoJ2J1dHRvbltkYXRhLWV2ZW50PSJzdHJpa2V0aHJvdWdoIl0nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHN0eWxlSW5mb1snZm9udC1zdHJpa2V0aHJvdWdoJ10gPT09ICdzdHJpa2V0aHJvdWdoJzsKICAgICAgfSk7CiAgICAgIGJ0blN0YXRlKCdidXR0b25bZGF0YS1ldmVudD0ic3VwZXJzY3JpcHQiXScsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gc3R5bGVJbmZvWydmb250LXN1cGVyc2NyaXB0J10gPT09ICdzdXBlcnNjcmlwdCc7CiAgICAgIH0pOwogICAgICBidG5TdGF0ZSgnYnV0dG9uW2RhdGEtZXZlbnQ9InN1YnNjcmlwdCJdJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBzdHlsZUluZm9bJ2ZvbnQtc3Vic2NyaXB0J10gPT09ICdzdWJzY3JpcHQnOwogICAgICB9KTsKICAgICAgYnRuU3RhdGUoJ2J1dHRvbltkYXRhLWV2ZW50PSJqdXN0aWZ5TGVmdCJdJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBzdHlsZUluZm9bJ3RleHQtYWxpZ24nXSA9PT0gJ2xlZnQnIHx8IHN0eWxlSW5mb1sndGV4dC1hbGlnbiddID09PSAnc3RhcnQnOwogICAgICB9KTsKICAgICAgYnRuU3RhdGUoJ2J1dHRvbltkYXRhLWV2ZW50PSJqdXN0aWZ5Q2VudGVyIl0nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHN0eWxlSW5mb1sndGV4dC1hbGlnbiddID09PSAnY2VudGVyJzsKICAgICAgfSk7CiAgICAgIGJ0blN0YXRlKCdidXR0b25bZGF0YS1ldmVudD0ianVzdGlmeVJpZ2h0Il0nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHN0eWxlSW5mb1sndGV4dC1hbGlnbiddID09PSAncmlnaHQnOwogICAgICB9KTsKICAgICAgYnRuU3RhdGUoJ2J1dHRvbltkYXRhLWV2ZW50PSJqdXN0aWZ5RnVsbCJdJywgZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBzdHlsZUluZm9bJ3RleHQtYWxpZ24nXSA9PT0gJ2p1c3RpZnknOwogICAgICB9KTsKICAgICAgYnRuU3RhdGUoJ2J1dHRvbltkYXRhLWV2ZW50PSJpbnNlcnRVbm9yZGVyZWRMaXN0Il0nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHN0eWxlSW5mb1snbGlzdC1zdHlsZSddID09PSAndW5vcmRlcmVkJzsKICAgICAgfSk7CiAgICAgIGJ0blN0YXRlKCdidXR0b25bZGF0YS1ldmVudD0iaW5zZXJ0T3JkZXJlZExpc3QiXScsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gc3R5bGVJbmZvWydsaXN0LXN0eWxlJ10gPT09ICdvcmRlcmVkJzsKICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogdXBkYXRlIHJlY2VudCBjb2xvcgogICAgICoKICAgICAqIEBwYXJhbSB7Tm9kZX0gYnV0dG9uCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lCiAgICAgKiBAcGFyYW0ge3ZhbHVlfSB2YWx1ZQogICAgICovCiAgICB0aGlzLnVwZGF0ZVJlY2VudENvbG9yID0gZnVuY3Rpb24gKGJ1dHRvbiwgZXZlbnROYW1lLCB2YWx1ZSkgewogICAgICB2YXIgJGNvbG9yID0gJChidXR0b24pLmNsb3Nlc3QoJy5ub3RlLWNvbG9yJyk7CiAgICAgIHZhciAkcmVjZW50Q29sb3IgPSAkY29sb3IuZmluZCgnLm5vdGUtcmVjZW50LWNvbG9yJyk7CiAgICAgIHZhciBjb2xvckluZm8gPSBKU09OLnBhcnNlKCRyZWNlbnRDb2xvci5hdHRyKCdkYXRhLXZhbHVlJykpOwogICAgICBjb2xvckluZm9bZXZlbnROYW1lXSA9IHZhbHVlOwogICAgICAkcmVjZW50Q29sb3IuYXR0cignZGF0YS12YWx1ZScsIEpTT04uc3RyaW5naWZ5KGNvbG9ySW5mbykpOwogICAgICB2YXIgc0tleSA9IGV2ZW50TmFtZSA9PT0gJ2JhY2tDb2xvcicgPyAnYmFja2dyb3VuZC1jb2xvcicgOiAnY29sb3InOwogICAgICAkcmVjZW50Q29sb3IuZmluZCgnaScpLmNzcyhzS2V5LCB2YWx1ZSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIFRvb2xiYXIKICAgKi8KICB2YXIgVG9vbGJhciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXR0b24gPSBuZXcgQnV0dG9uKCk7CgogICAgdGhpcy51cGRhdGUgPSBmdW5jdGlvbiAoJHRvb2xiYXIsIHN0eWxlSW5mbykgewogICAgICBidXR0b24udXBkYXRlKCR0b29sYmFyLCBzdHlsZUluZm8pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7Tm9kZX0gYnV0dG9uCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUKICAgICAqLwogICAgdGhpcy51cGRhdGVSZWNlbnRDb2xvciA9IGZ1bmN0aW9uIChidXR0b25Ob2RlLCBldmVudE5hbWUsIHZhbHVlKSB7CiAgICAgIGJ1dHRvbi51cGRhdGVSZWNlbnRDb2xvcihidXR0b25Ob2RlLCBldmVudE5hbWUsIHZhbHVlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBhY3RpdmF0ZSBidXR0b25zIGV4Y2x1ZGUgY29kZXZpZXcKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkdG9vbGJhcgogICAgICovCiAgICB0aGlzLmFjdGl2YXRlID0gZnVuY3Rpb24gKCR0b29sYmFyKSB7CiAgICAgICR0b29sYmFyLmZpbmQoJ2J1dHRvbicpCiAgICAgICAgICAgICAgLm5vdCgnYnV0dG9uW2RhdGEtZXZlbnQ9ImNvZGV2aWV3Il0nKQogICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBkZWFjdGl2YXRlIGJ1dHRvbnMgZXhjbHVkZSBjb2RldmlldwogICAgICogQHBhcmFtIHtqUXVlcnl9ICR0b29sYmFyCiAgICAgKi8KICAgIHRoaXMuZGVhY3RpdmF0ZSA9IGZ1bmN0aW9uICgkdG9vbGJhcikgewogICAgICAkdG9vbGJhci5maW5kKCdidXR0b24nKQogICAgICAgICAgICAgIC5ub3QoJ2J1dHRvbltkYXRhLWV2ZW50PSJjb2RldmlldyJdJykKICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7CiAgICB9OwoKICAgIHRoaXMudXBkYXRlRnVsbHNjcmVlbiA9IGZ1bmN0aW9uICgkY29udGFpbmVyLCBiRnVsbHNjcmVlbikgewogICAgICB2YXIgJGJ0biA9ICRjb250YWluZXIuZmluZCgnYnV0dG9uW2RhdGEtZXZlbnQ9ImZ1bGxzY3JlZW4iXScpOwogICAgICAkYnRuLnRvZ2dsZUNsYXNzKCdhY3RpdmUnLCBiRnVsbHNjcmVlbik7CiAgICB9OwoKICAgIHRoaXMudXBkYXRlQ29kZXZpZXcgPSBmdW5jdGlvbiAoJGNvbnRhaW5lciwgaXNDb2RldmlldykgewogICAgICB2YXIgJGJ0biA9ICRjb250YWluZXIuZmluZCgnYnV0dG9uW2RhdGEtZXZlbnQ9ImNvZGV2aWV3Il0nKTsKICAgICAgJGJ0bi50b2dnbGVDbGFzcygnYWN0aXZlJywgaXNDb2Rldmlldyk7CiAgICB9OwogIH07CgogIC8qKgogICAqIFBvcG92ZXIgKGh0dHA6Ly9nZXRib290c3RyYXAuY29tL2phdmFzY3JpcHQvI3BvcG92ZXJzKQogICAqLwogIHZhciBQb3BvdmVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJ1dHRvbiA9IG5ldyBCdXR0b24oKTsKCiAgICAvKioKICAgICAqIHJldHVybnMgcG9zaXRpb24gZnJvbSBwbGFjZWhvbGRlcgogICAgICogQHBhcmFtIHtOb2RlfSBwbGFjZWhvbGRlcgogICAgICogQHBhcmFtIHtCb29sZWFufSBpc0Fpck1vZGUKICAgICAqLwogICAgdmFyIHBvc0Zyb21QbGFjZWhvbGRlciA9IGZ1bmN0aW9uIChwbGFjZWhvbGRlciwgaXNBaXJNb2RlKSB7CiAgICAgIHZhciAkcGxhY2Vob2xkZXIgPSAkKHBsYWNlaG9sZGVyKTsKICAgICAgdmFyIHBvcyA9IGlzQWlyTW9kZSA\/ICRwbGFjZWhvbGRlci5vZmZzZXQoKSA6ICRwbGFjZWhvbGRlci5wb3NpdGlvbigpOwogICAgICB2YXIgaGVpZ2h0ID0gJHBsYWNlaG9sZGVyLm91dGVySGVpZ2h0KHRydWUpOyAvLyBpbmNsdWRlIG1hcmdpbgoKICAgICAgLy8gcG9wb3ZlciBiZWxvdyBwbGFjZWhvbGRlci4KICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBwb3MubGVmdCwKICAgICAgICB0b3A6IHBvcy50b3AgKyBoZWlnaHQKICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBzaG93IHBvcG92ZXIKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSBwb3BvdmVyCiAgICAgKiBAcGFyYW0ge1Bvc2l0aW9ufSBwb3MKICAgICAqLwogICAgdmFyIHNob3dQb3BvdmVyID0gZnVuY3Rpb24gKCRwb3BvdmVyLCBwb3MpIHsKICAgICAgJHBvcG92ZXIuY3NzKHsKICAgICAgICBkaXNwbGF5OiAnYmxvY2snLAogICAgICAgIGxlZnQ6IHBvcy5sZWZ0LAogICAgICAgIHRvcDogcG9zLnRvcAogICAgICB9KTsKICAgIH07CgogICAgdmFyIFBYX1BPUE9WRVJfQVJST1dfT0ZGU0VUX1ggPSAyMDsKCiAgICAvKioKICAgICAqIHVwZGF0ZSBjdXJyZW50IHN0YXRlCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJHBvcG92ZXIgLSBwb3BvdmVyIGNvbnRhaW5lcgogICAgICogQHBhcmFtIHtPYmplY3R9IHN0eWxlSW5mbyAtIHN0eWxlIG9iamVjdAogICAgICogQHBhcmFtIHtCb29sZWFufSBpc0Fpck1vZGUKICAgICAqLwogICAgdGhpcy51cGRhdGUgPSBmdW5jdGlvbiAoJHBvcG92ZXIsIHN0eWxlSW5mbywgaXNBaXJNb2RlKSB7CiAgICAgIGJ1dHRvbi51cGRhdGUoJHBvcG92ZXIsIHN0eWxlSW5mbyk7CgogICAgICB2YXIgJGxpbmtQb3BvdmVyID0gJHBvcG92ZXIuZmluZCgnLm5vdGUtbGluay1wb3BvdmVyJyk7CiAgICAgIGlmIChzdHlsZUluZm8uYW5jaG9yKSB7CiAgICAgICAgdmFyICRhbmNob3IgPSAkbGlua1BvcG92ZXIuZmluZCgnYScpOwogICAgICAgIHZhciBocmVmID0gJChzdHlsZUluZm8uYW5jaG9yKS5hdHRyKCdocmVmJyk7CiAgICAgICAgJGFuY2hvci5hdHRyKCdocmVmJywgaHJlZikuaHRtbChocmVmKTsKICAgICAgICBzaG93UG9wb3ZlcigkbGlua1BvcG92ZXIsIHBvc0Zyb21QbGFjZWhvbGRlcihzdHlsZUluZm8uYW5jaG9yLCBpc0Fpck1vZGUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAkbGlua1BvcG92ZXIuaGlkZSgpOwogICAgICB9CgogICAgICB2YXIgJGltYWdlUG9wb3ZlciA9ICRwb3BvdmVyLmZpbmQoJy5ub3RlLWltYWdlLXBvcG92ZXInKTsKICAgICAgaWYgKHN0eWxlSW5mby5pbWFnZSkgewogICAgICAgIHNob3dQb3BvdmVyKCRpbWFnZVBvcG92ZXIsIHBvc0Zyb21QbGFjZWhvbGRlcihzdHlsZUluZm8uaW1hZ2UsIGlzQWlyTW9kZSkpOwogICAgICB9IGVsc2UgewogICAgICAgICRpbWFnZVBvcG92ZXIuaGlkZSgpOwogICAgICB9CgogICAgICB2YXIgJGFpclBvcG92ZXIgPSAkcG9wb3Zlci5maW5kKCcubm90ZS1haXItcG9wb3ZlcicpOwogICAgICBpZiAoaXNBaXJNb2RlICYmICFzdHlsZUluZm8ucmFuZ2UuaXNDb2xsYXBzZWQoKSkgewogICAgICAgIHZhciBibmQgPSBmdW5jLnJlY3QyYm5kKGxpc3QubGFzdChzdHlsZUluZm8ucmFuZ2UuZ2V0Q2xpZW50UmVjdHMoKSkpOwogICAgICAgIHNob3dQb3BvdmVyKCRhaXJQb3BvdmVyLCB7CiAgICAgICAgICBsZWZ0OiBNYXRoLm1heChibmQubGVmdCArIGJuZC53aWR0aCAvIDIgLSBQWF9QT1BPVkVSX0FSUk9XX09GRlNFVF9YLCAwKSwKICAgICAgICAgIHRvcDogYm5kLnRvcCArIGJuZC5oZWlnaHQKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAkYWlyUG9wb3Zlci5oaWRlKCk7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge05vZGV9IGJ1dHRvbgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHZhbHVlCiAgICAgKi8KICAgIHRoaXMudXBkYXRlUmVjZW50Q29sb3IgPSBmdW5jdGlvbiAoYnV0dG9uLCBldmVudE5hbWUsIHZhbHVlKSB7CiAgICAgIGJ1dHRvbi51cGRhdGVSZWNlbnRDb2xvcihidXR0b24sIGV2ZW50TmFtZSwgdmFsdWUpOwogICAgfTsKCiAgICAvKioKICAgICAqIGhpZGUgYWxsIHBvcG92ZXJzCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJHBvcG92ZXIgLSBwb3BvdmVyIGNvbnRhaW5lcgogICAgICovCiAgICB0aGlzLmhpZGUgPSBmdW5jdGlvbiAoJHBvcG92ZXIpIHsKICAgICAgJHBvcG92ZXIuY2hpbGRyZW4oKS5oaWRlKCk7CiAgICB9OwogIH07CgogIC8qKgogICAqIEhhbmRsZQogICAqLwogIHZhciBIYW5kbGUgPSBmdW5jdGlvbiAoKSB7CiAgICAvKioKICAgICAqIHVwZGF0ZSBoYW5kbGUKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkaGFuZGxlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc3R5bGVJbmZvCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGlzQWlyTW9kZQogICAgICovCiAgICB0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uICgkaGFuZGxlLCBzdHlsZUluZm8sIGlzQWlyTW9kZSkgewogICAgICB2YXIgJHNlbGVjdGlvbiA9ICRoYW5kbGUuZmluZCgnLm5vdGUtY29udHJvbC1zZWxlY3Rpb24nKTsKICAgICAgaWYgKHN0eWxlSW5mby5pbWFnZSkgewogICAgICAgIHZhciAkaW1hZ2UgPSAkKHN0eWxlSW5mby5pbWFnZSk7CiAgICAgICAgdmFyIHBvcyA9IGlzQWlyTW9kZSA\/ICRpbWFnZS5vZmZzZXQoKSA6ICRpbWFnZS5wb3NpdGlvbigpOwoKICAgICAgICAvLyBpbmNsdWRlIG1hcmdpbgogICAgICAgIHZhciBpbWFnZVNpemUgPSB7CiAgICAgICAgICB3OiAkaW1hZ2Uub3V0ZXJXaWR0aCh0cnVlKSwKICAgICAgICAgIGg6ICRpbWFnZS5vdXRlckhlaWdodCh0cnVlKQogICAgICAgIH07CgogICAgICAgICRzZWxlY3Rpb24uY3NzKHsKICAgICAgICAgIGRpc3BsYXk6ICdibG9jaycsCiAgICAgICAgICBsZWZ0OiBwb3MubGVmdCwKICAgICAgICAgIHRvcDogcG9zLnRvcCwKICAgICAgICAgIHdpZHRoOiBpbWFnZVNpemUudywKICAgICAgICAgIGhlaWdodDogaW1hZ2VTaXplLmgKICAgICAgICB9KS5kYXRhKCd0YXJnZXQnLCBzdHlsZUluZm8uaW1hZ2UpOyAvLyBzYXZlIGN1cnJlbnQgaW1hZ2UgZWxlbWVudC4KICAgICAgICB2YXIgc2l6aW5nVGV4dCA9IGltYWdlU2l6ZS53ICsgJ3gnICsgaW1hZ2VTaXplLmg7CiAgICAgICAgJHNlbGVjdGlvbi5maW5kKCcubm90ZS1jb250cm9sLXNlbGVjdGlvbi1pbmZvJykudGV4dChzaXppbmdUZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAkc2VsZWN0aW9uLmhpZGUoKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLmhpZGUgPSBmdW5jdGlvbiAoJGhhbmRsZSkgewogICAgICAkaGFuZGxlLmNoaWxkcmVuKCkuaGlkZSgpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBEaWFsb2cgCiAgICoKICAgKiBAY2xhc3MKICAgKi8KICB2YXIgRGlhbG9nID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgICogdG9nZ2xlIGJ1dHRvbiBzdGF0dXMKICAgICAqCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGJ0bgogICAgICogQHBhcmFtIHtCb29sZWFufSBpc0VuYWJsZQogICAgICovCiAgICB2YXIgdG9nZ2xlQnRuID0gZnVuY3Rpb24gKCRidG4sIGlzRW5hYmxlKSB7CiAgICAgICRidG4udG9nZ2xlQ2xhc3MoJ2Rpc2FibGVkJywgIWlzRW5hYmxlKTsKICAgICAgJGJ0bi5hdHRyKCdkaXNhYmxlZCcsICFpc0VuYWJsZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogc2hvdyBpbWFnZSBkaWFsb2cKICAgICAqCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGVkaXRhYmxlCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGRpYWxvZwogICAgICogQHJldHVybiB7UHJvbWlzZX0KICAgICAqLwogICAgdGhpcy5zaG93SW1hZ2VEaWFsb2cgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCAkZGlhbG9nKSB7CiAgICAgIHJldHVybiAkLkRlZmVycmVkKGZ1bmN0aW9uIChkZWZlcnJlZCkgewogICAgICAgIHZhciAkaW1hZ2VEaWFsb2cgPSAkZGlhbG9nLmZpbmQoJy5ub3RlLWltYWdlLWRpYWxvZycpOwoKICAgICAgICB2YXIgJGltYWdlSW5wdXQgPSAkZGlhbG9nLmZpbmQoJy5ub3RlLWltYWdlLWlucHV0JyksCiAgICAgICAgICAgICRpbWFnZVVybCA9ICRkaWFsb2cuZmluZCgnLm5vdGUtaW1hZ2UtdXJsJyksCiAgICAgICAgICAgICRpbWFnZUJ0biA9ICRkaWFsb2cuZmluZCgnLm5vdGUtaW1hZ2UtYnRuJyk7CgogICAgICAgICRpbWFnZURpYWxvZy5vbmUoJ3Nob3duLmJzLm1vZGFsJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gQ2xvbmluZyBpbWFnZUlucHV0IHRvIGNsZWFyIGVsZW1lbnQuCiAgICAgICAgICAkaW1hZ2VJbnB1dC5yZXBsYWNlV2l0aCgkaW1hZ2VJbnB1dC5jbG9uZSgpCiAgICAgICAgICAgIC5vbignY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUodGhpcy5maWxlcyB8fCB0aGlzLnZhbHVlKTsKICAgICAgICAgICAgICAkaW1hZ2VEaWFsb2cubW9kYWwoJ2hpZGUnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnZhbCgnJykKICAgICAgICAgICk7CgogICAgICAgICAgJGltYWdlQnRuLmNsaWNrKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgkaW1hZ2VVcmwudmFsKCkpOwogICAgICAgICAgICAkaW1hZ2VEaWFsb2cubW9kYWwoJ2hpZGUnKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICRpbWFnZVVybC5vbigna2V5dXAgcGFzdGUnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgdmFyIHVybDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAncGFzdGUnKSB7CiAgICAgICAgICAgICAgdXJsID0gZXZlbnQub3JpZ2luYWxFdmVudC5jbGlwYm9hcmREYXRhLmdldERhdGEoJ3RleHQnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cmwgPSAkaW1hZ2VVcmwudmFsKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRvZ2dsZUJ0bigkaW1hZ2VCdG4sIHVybCk7CiAgICAgICAgICB9KS52YWwoJycpLnRyaWdnZXIoJ2ZvY3VzJyk7CiAgICAgICAgfSkub25lKCdoaWRkZW4uYnMubW9kYWwnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAkaW1hZ2VJbnB1dC5vZmYoJ2NoYW5nZScpOwogICAgICAgICAgJGltYWdlVXJsLm9mZigna2V5dXAgcGFzdGUnKTsKICAgICAgICAgICRpbWFnZUJ0bi5vZmYoJ2NsaWNrJyk7CgogICAgICAgICAgaWYgKGRlZmVycmVkLnN0YXRlKCkgPT09ICdwZW5kaW5nJykgewogICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoKTsKICAgICAgICAgIH0KICAgICAgICB9KS5tb2RhbCgnc2hvdycpOwogICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTaG93IGxpbmsgZGlhbG9nIGFuZCBzZXQgZXZlbnQgaGFuZGxlcnMgb24gZGlhbG9nIGNvbnRyb2xzLgogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkZGlhbG9nCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbGlua0luZm8KICAgICAqIEByZXR1cm4ge1Byb21pc2V9CiAgICAgKi8KICAgIHRoaXMuc2hvd0xpbmtEaWFsb2cgPSBmdW5jdGlvbiAoJGVkaXRhYmxlLCAkZGlhbG9nLCBsaW5rSW5mbykgewogICAgICByZXR1cm4gJC5EZWZlcnJlZChmdW5jdGlvbiAoZGVmZXJyZWQpIHsKICAgICAgICB2YXIgJGxpbmtEaWFsb2cgPSAkZGlhbG9nLmZpbmQoJy5ub3RlLWxpbmstZGlhbG9nJyk7CgogICAgICAgIHZhciAkbGlua1RleHQgPSAkbGlua0RpYWxvZy5maW5kKCcubm90ZS1saW5rLXRleHQnKSwKICAgICAgICAkbGlua1VybCA9ICRsaW5rRGlhbG9nLmZpbmQoJy5ub3RlLWxpbmstdXJsJyksCiAgICAgICAgJGxpbmtCdG4gPSAkbGlua0RpYWxvZy5maW5kKCcubm90ZS1saW5rLWJ0bicpLAogICAgICAgICRvcGVuSW5OZXdXaW5kb3cgPSAkbGlua0RpYWxvZy5maW5kKCdpbnB1dFt0eXBlPWNoZWNrYm94XScpOwoKICAgICAgICAkbGlua0RpYWxvZy5vbmUoJ3Nob3duLmJzLm1vZGFsJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgJGxpbmtUZXh0LnZhbChsaW5rSW5mby50ZXh0KTsKCiAgICAgICAgICAkbGlua1RleHQub24oJ2lucHV0JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBpZiBsaW5rdGV4dCB3YXMgbW9kaWZpZWQgYnkga2V5dXAsCiAgICAgICAgICAgIC8vIHN0b3AgY2xvbmluZyB0ZXh0IGZyb20gbGlua1VybAogICAgICAgICAgICBsaW5rSW5mby50ZXh0ID0gJGxpbmtUZXh0LnZhbCgpOwogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gaWYgbm8gdXJsIHdhcyBnaXZlbiwgY29weSB0ZXh0IHRvIHVybAogICAgICAgICAgaWYgKCFsaW5rSW5mby51cmwpIHsKICAgICAgICAgICAgbGlua0luZm8udXJsID0gbGlua0luZm8udGV4dDsKICAgICAgICAgICAgdG9nZ2xlQnRuKCRsaW5rQnRuLCBsaW5rSW5mby50ZXh0KTsKICAgICAgICAgIH0KCiAgICAgICAgICAkbGlua1VybC5vbignaW5wdXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRvZ2dsZUJ0bigkbGlua0J0biwgJGxpbmtVcmwudmFsKCkpOwogICAgICAgICAgICAvLyBkaXNwbGF5IHNhbWUgbGluayBvbiBgVGV4dCB0byBkaXNwbGF5YCBpbnB1dAogICAgICAgICAgICAvLyB3aGVuIGNyZWF0ZSBhIG5ldyBsaW5rCiAgICAgICAgICAgIGlmICghbGlua0luZm8udGV4dCkgewogICAgICAgICAgICAgICRsaW5rVGV4dC52YWwoJGxpbmtVcmwudmFsKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KS52YWwobGlua0luZm8udXJsKS50cmlnZ2VyKCdmb2N1cycpLnRyaWdnZXIoJ3NlbGVjdCcpOwoKICAgICAgICAgICRvcGVuSW5OZXdXaW5kb3cucHJvcCgnY2hlY2tlZCcsIGxpbmtJbmZvLm5ld1dpbmRvdyk7CgogICAgICAgICAgJGxpbmtCdG4ub25lKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh7CiAgICAgICAgICAgICAgcmFuZ2U6IGxpbmtJbmZvLnJhbmdlLAogICAgICAgICAgICAgIHVybDogJGxpbmtVcmwudmFsKCksCiAgICAgICAgICAgICAgdGV4dDogJGxpbmtUZXh0LnZhbCgpLAogICAgICAgICAgICAgIG5ld1dpbmRvdzogJG9wZW5Jbk5ld1dpbmRvdy5pcygnOmNoZWNrZWQnKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJGxpbmtEaWFsb2cubW9kYWwoJ2hpZGUnKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pLm9uZSgnaGlkZGVuLmJzLm1vZGFsJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gZGV0YWNoIGV2ZW50cwogICAgICAgICAgJGxpbmtUZXh0Lm9mZignaW5wdXQnKTsKICAgICAgICAgICRsaW5rVXJsLm9mZignaW5wdXQnKTsKICAgICAgICAgICRsaW5rQnRuLm9mZignY2xpY2snKTsKCiAgICAgICAgICBpZiAoZGVmZXJyZWQuc3RhdGUoKSA9PT0gJ3BlbmRpbmcnKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgpOwogICAgICAgICAgfQogICAgICAgIH0pLm1vZGFsKCdzaG93Jyk7CiAgICAgIH0pLnByb21pc2UoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBzaG93IGhlbHAgZGlhbG9nCiAgICAgKgogICAgICogQHBhcmFtIHtqUXVlcnl9ICRkaWFsb2cKICAgICAqLwogICAgdGhpcy5zaG93SGVscERpYWxvZyA9IGZ1bmN0aW9uICgkZWRpdGFibGUsICRkaWFsb2cpIHsKICAgICAgcmV0dXJuICQuRGVmZXJyZWQoZnVuY3Rpb24gKGRlZmVycmVkKSB7CiAgICAgICAgdmFyICRoZWxwRGlhbG9nID0gJGRpYWxvZy5maW5kKCcubm90ZS1oZWxwLWRpYWxvZycpOwoKICAgICAgICAkaGVscERpYWxvZy5vbmUoJ2hpZGRlbi5icy5tb2RhbCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoKTsKICAgICAgICB9KS5tb2RhbCgnc2hvdycpOwogICAgICB9KS5wcm9taXNlKCk7CiAgICB9OwogIH07CgoKICB2YXIgQ29kZU1pcnJvcjsKICBpZiAoYWdlbnQuaGFzQ29kZU1pcnJvcikgewogICAgaWYgKGFnZW50LmlzU3VwcG9ydEFtZCkgewogICAgICByZXF1aXJlKFsnQ29kZU1pcnJvciddLCBmdW5jdGlvbiAoY20pIHsKICAgICAgICBDb2RlTWlycm9yID0gY207CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgQ29kZU1pcnJvciA9IHdpbmRvdy5Db2RlTWlycm9yOwogICAgfQogIH0KCiAgLyoqCiAgICogRXZlbnRIYW5kbGVyCiAgICovCiAgdmFyIEV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciAkd2luZG93ID0gJCh3aW5kb3cpOwogICAgdmFyICRkb2N1bWVudCA9ICQoZG9jdW1lbnQpOwogICAgdmFyICRzY3JvbGxiYXIgPSAkKCdodG1sLCBib2R5Jyk7CgogICAgdmFyIGVkaXRvciA9IG5ldyBFZGl0b3IoKTsKICAgIHZhciB0b29sYmFyID0gbmV3IFRvb2xiYXIoKSwgcG9wb3ZlciA9IG5ldyBQb3BvdmVyKCk7CiAgICB2YXIgaGFuZGxlID0gbmV3IEhhbmRsZSgpLCBkaWFsb2cgPSBuZXcgRGlhbG9nKCk7CgogICAgdGhpcy5nZXRFZGl0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBlZGl0b3I7CiAgICB9OwoKICAgIC8qKgogICAgICogcmV0dXJucyBtYWtlTGF5b3V0SW5mbyBmcm9tIGVkaXRvcidzIGRlc2NlbmRhbnQgbm9kZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge05vZGV9IGRlc2NlbmRhbnQKICAgICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICAgKi8KICAgIHZhciBtYWtlTGF5b3V0SW5mbyA9IGZ1bmN0aW9uIChkZXNjZW5kYW50KSB7CiAgICAgIHZhciAkdGFyZ2V0ID0gJChkZXNjZW5kYW50KS5jbG9zZXN0KCcubm90ZS1lZGl0b3IsIC5ub3RlLWFpci1lZGl0b3IsIC5ub3RlLWFpci1sYXlvdXQnKTsKCiAgICAgIGlmICghJHRhcmdldC5sZW5ndGgpIHsgcmV0dXJuIG51bGw7IH0KCiAgICAgIHZhciAkZWRpdG9yOwogICAgICBpZiAoJHRhcmdldC5pcygnLm5vdGUtZWRpdG9yLCAubm90ZS1haXItZWRpdG9yJykpIHsKICAgICAgICAkZWRpdG9yID0gJHRhcmdldDsKICAgICAgfSBlbHNlIHsKICAgICAgICAkZWRpdG9yID0gJCgnI25vdGUtZWRpdG9yLScgKyBsaXN0Lmxhc3QoJHRhcmdldC5hdHRyKCdpZCcpLnNwbGl0KCctJykpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGRvbS5idWlsZExheW91dEluZm8oJGVkaXRvcik7CiAgICB9OwoKICAgIC8qKgogICAgICogaW5zZXJ0IEltYWdlcyBmcm9tIGZpbGUgYXJyYXkuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGxheW91dEluZm8KICAgICAqIEBwYXJhbSB7RmlsZVtdfSBmaWxlcwogICAgICovCiAgICB2YXIgaW5zZXJ0SW1hZ2VzID0gZnVuY3Rpb24gKGxheW91dEluZm8sIGZpbGVzKSB7CiAgICAgIHZhciAkZWRpdG9yID0gbGF5b3V0SW5mby5lZGl0b3IoKSwKICAgICAgICAgICRlZGl0YWJsZSA9IGxheW91dEluZm8uZWRpdGFibGUoKTsKCiAgICAgIHZhciBjYWxsYmFja3MgPSAkZWRpdGFibGUuZGF0YSgnY2FsbGJhY2tzJyk7CiAgICAgIHZhciBvcHRpb25zID0gJGVkaXRvci5kYXRhKCdvcHRpb25zJyk7CgogICAgICAvLyBJZiBvbkltYWdlVXBsb2FkIG9wdGlvbnMgc2V0dGVkCiAgICAgIGlmIChjYWxsYmFja3Mub25JbWFnZVVwbG9hZCkgewogICAgICAgIGNhbGxiYWNrcy5vbkltYWdlVXBsb2FkKGZpbGVzLCBlZGl0b3IsICRlZGl0YWJsZSk7CiAgICAgIC8vIGVsc2UgaW5zZXJ0IEltYWdlIGFzIGRhdGFVUkwKICAgICAgfSBlbHNlIHsKICAgICAgICAkLmVhY2goZmlsZXMsIGZ1bmN0aW9uIChpZHgsIGZpbGUpIHsKICAgICAgICAgIHZhciBmaWxlbmFtZSA9IGZpbGUubmFtZTsKICAgICAgICAgIGlmIChvcHRpb25zLm1heGltdW1JbWFnZUZpbGVTaXplICYmIG9wdGlvbnMubWF4aW11bUltYWdlRmlsZVNpemUgPCBmaWxlLnNpemUpIHsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5vbkltYWdlVXBsb2FkRXJyb3IpIHsKICAgICAgICAgICAgICBjYWxsYmFja3Mub25JbWFnZVVwbG9hZEVycm9yKG9wdGlvbnMubGFuZ0luZm8uaW1hZ2UubWF4aW11bUZpbGVTaXplRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFsZXJ0KG9wdGlvbnMubGFuZ0luZm8uaW1hZ2UubWF4aW11bUZpbGVTaXplRXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3luYy5yZWFkRmlsZUFzRGF0YVVSTChmaWxlKS50aGVuKGZ1bmN0aW9uIChzRGF0YVVSTCkgewogICAgICAgICAgICAgIGVkaXRvci5pbnNlcnRJbWFnZSgkZWRpdGFibGUsIHNEYXRhVVJMLCBmaWxlbmFtZSk7CiAgICAgICAgICAgIH0pLmZhaWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGlmIChjYWxsYmFja3Mub25JbWFnZVVwbG9hZEVycm9yKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25JbWFnZVVwbG9hZEVycm9yKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgY29tbWFuZHMgPSB7CiAgICAgIC8qKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gbGF5b3V0SW5mbwogICAgICAgKi8KICAgICAgc2hvd0xpbmtEaWFsb2c6IGZ1bmN0aW9uIChsYXlvdXRJbmZvKSB7CiAgICAgICAgdmFyICRlZGl0b3IgPSBsYXlvdXRJbmZvLmVkaXRvcigpLAogICAgICAgICAgICAkZGlhbG9nID0gbGF5b3V0SW5mby5kaWFsb2coKSwKICAgICAgICAgICAgJGVkaXRhYmxlID0gbGF5b3V0SW5mby5lZGl0YWJsZSgpLAogICAgICAgICAgICBsaW5rSW5mbyA9IGVkaXRvci5nZXRMaW5rSW5mbygkZWRpdGFibGUpOwoKICAgICAgICB2YXIgb3B0aW9ucyA9ICRlZGl0b3IuZGF0YSgnb3B0aW9ucycpOwoKICAgICAgICBlZGl0b3Iuc2F2ZVJhbmdlKCRlZGl0YWJsZSk7CiAgICAgICAgZGlhbG9nLnNob3dMaW5rRGlhbG9nKCRlZGl0YWJsZSwgJGRpYWxvZywgbGlua0luZm8pLnRoZW4oZnVuY3Rpb24gKGxpbmtJbmZvKSB7CiAgICAgICAgICBlZGl0b3IucmVzdG9yZVJhbmdlKCRlZGl0YWJsZSk7CiAgICAgICAgICBlZGl0b3IuY3JlYXRlTGluaygkZWRpdGFibGUsIGxpbmtJbmZvLCBvcHRpb25zKTsKICAgICAgICAgIC8vIGhpZGUgcG9wb3ZlciBhZnRlciBjcmVhdGluZyBsaW5rCiAgICAgICAgICBwb3BvdmVyLmhpZGUobGF5b3V0SW5mby5wb3BvdmVyKCkpOwogICAgICAgIH0pLmZhaWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgZWRpdG9yLnJlc3RvcmVSYW5nZSgkZWRpdGFibGUpOwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsYXlvdXRJbmZvCiAgICAgICAqLwogICAgICBzaG93SW1hZ2VEaWFsb2c6IGZ1bmN0aW9uIChsYXlvdXRJbmZvKSB7CiAgICAgICAgdmFyICRkaWFsb2cgPSBsYXlvdXRJbmZvLmRpYWxvZygpLAogICAgICAgICAgICAkZWRpdGFibGUgPSBsYXlvdXRJbmZvLmVkaXRhYmxlKCk7CgogICAgICAgIGVkaXRvci5zYXZlUmFuZ2UoJGVkaXRhYmxlKTsKICAgICAgICBkaWFsb2cuc2hvd0ltYWdlRGlhbG9nKCRlZGl0YWJsZSwgJGRpYWxvZykudGhlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgZWRpdG9yLnJlc3RvcmVSYW5nZSgkZWRpdGFibGUpOwoKICAgICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgLy8gaW1hZ2UgdXJsCiAgICAgICAgICAgIGVkaXRvci5pbnNlcnRJbWFnZSgkZWRpdGFibGUsIGRhdGEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gYXJyYXkgb2YgZmlsZXMKICAgICAgICAgICAgaW5zZXJ0SW1hZ2VzKGxheW91dEluZm8sIGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pLmZhaWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgZWRpdG9yLnJlc3RvcmVSYW5nZSgkZWRpdGFibGUpOwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsYXlvdXRJbmZvCiAgICAgICAqLwogICAgICBzaG93SGVscERpYWxvZzogZnVuY3Rpb24gKGxheW91dEluZm8pIHsKICAgICAgICB2YXIgJGRpYWxvZyA9IGxheW91dEluZm8uZGlhbG9nKCksCiAgICAgICAgICAgICRlZGl0YWJsZSA9IGxheW91dEluZm8uZWRpdGFibGUoKTsKCiAgICAgICAgZWRpdG9yLnNhdmVSYW5nZSgkZWRpdGFibGUsIHRydWUpOwogICAgICAgIGRpYWxvZy5zaG93SGVscERpYWxvZygkZWRpdGFibGUsICRkaWFsb2cpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgZWRpdG9yLnJlc3RvcmVSYW5nZSgkZWRpdGFibGUpOwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgZnVsbHNjcmVlbjogZnVuY3Rpb24gKGxheW91dEluZm8pIHsKICAgICAgICB2YXIgJGVkaXRvciA9IGxheW91dEluZm8uZWRpdG9yKCksCiAgICAgICAgJHRvb2xiYXIgPSBsYXlvdXRJbmZvLnRvb2xiYXIoKSwKICAgICAgICAkZWRpdGFibGUgPSBsYXlvdXRJbmZvLmVkaXRhYmxlKCksCiAgICAgICAgJGNvZGFibGUgPSBsYXlvdXRJbmZvLmNvZGFibGUoKTsKCiAgICAgICAgdmFyIHJlc2l6ZSA9IGZ1bmN0aW9uIChzaXplKSB7CiAgICAgICAgICAkZWRpdGFibGUuY3NzKCdoZWlnaHQnLCBzaXplLmgpOwogICAgICAgICAgJGNvZGFibGUuY3NzKCdoZWlnaHQnLCBzaXplLmgpOwogICAgICAgICAgaWYgKCRjb2RhYmxlLmRhdGEoJ2NtZWRpdG9yJykpIHsKICAgICAgICAgICAgJGNvZGFibGUuZGF0YSgnY21lZGl0b3InKS5zZXRzaXplKG51bGwsIHNpemUuaCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgJGVkaXRvci50b2dnbGVDbGFzcygnZnVsbHNjcmVlbicpOwogICAgICAgIHZhciBpc0Z1bGxzY3JlZW4gPSAkZWRpdG9yLmhhc0NsYXNzKCdmdWxsc2NyZWVuJyk7CiAgICAgICAgaWYgKGlzRnVsbHNjcmVlbikgewogICAgICAgICAgJGVkaXRhYmxlLmRhdGEoJ29yZ2hlaWdodCcsICRlZGl0YWJsZS5jc3MoJ2hlaWdodCcpKTsKCiAgICAgICAgICAkd2luZG93Lm9uKCdyZXNpemUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJlc2l6ZSh7CiAgICAgICAgICAgICAgaDogJHdpbmRvdy5oZWlnaHQoKSAtICR0b29sYmFyLm91dGVySGVpZ2h0KCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KS50cmlnZ2VyKCdyZXNpemUnKTsKCiAgICAgICAgICAkc2Nyb2xsYmFyLmNzcygnb3ZlcmZsb3cnLCAnaGlkZGVuJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICR3aW5kb3cub2ZmKCdyZXNpemUnKTsKICAgICAgICAgIHJlc2l6ZSh7CiAgICAgICAgICAgIGg6ICRlZGl0YWJsZS5kYXRhKCdvcmdoZWlnaHQnKQogICAgICAgICAgfSk7CiAgICAgICAgICAkc2Nyb2xsYmFyLmNzcygnb3ZlcmZsb3cnLCAndmlzaWJsZScpOwogICAgICAgIH0KCiAgICAgICAgdG9vbGJhci51cGRhdGVGdWxsc2NyZWVuKCR0b29sYmFyLCBpc0Z1bGxzY3JlZW4pOwogICAgICB9LAoKICAgICAgY29kZXZpZXc6IGZ1bmN0aW9uIChsYXlvdXRJbmZvKSB7CiAgICAgICAgdmFyICRlZGl0b3IgPSBsYXlvdXRJbmZvLmVkaXRvcigpLAogICAgICAgICR0b29sYmFyID0gbGF5b3V0SW5mby50b29sYmFyKCksCiAgICAgICAgJGVkaXRhYmxlID0gbGF5b3V0SW5mby5lZGl0YWJsZSgpLAogICAgICAgICRjb2RhYmxlID0gbGF5b3V0SW5mby5jb2RhYmxlKCksCiAgICAgICAgJHBvcG92ZXIgPSBsYXlvdXRJbmZvLnBvcG92ZXIoKSwKICAgICAgICAkaGFuZGxlID0gbGF5b3V0SW5mby5oYW5kbGUoKTsKCiAgICAgICAgdmFyIG9wdGlvbnMgPSAkZWRpdG9yLmRhdGEoJ29wdGlvbnMnKTsKCiAgICAgICAgdmFyIGNtRWRpdG9yLCBzZXJ2ZXI7CgogICAgICAgICRlZGl0b3IudG9nZ2xlQ2xhc3MoJ2NvZGV2aWV3Jyk7CgogICAgICAgIHZhciBpc0NvZGV2aWV3ID0gJGVkaXRvci5oYXNDbGFzcygnY29kZXZpZXcnKTsKICAgICAgICBpZiAoaXNDb2RldmlldykgewogICAgICAgICAgJGNvZGFibGUudmFsKGRvbS5odG1sKCRlZGl0YWJsZSwgdHJ1ZSkpOwogICAgICAgICAgJGNvZGFibGUuaGVpZ2h0KCRlZGl0YWJsZS5oZWlnaHQoKSk7CiAgICAgICAgICB0b29sYmFyLmRlYWN0aXZhdGUoJHRvb2xiYXIpOwogICAgICAgICAgcG9wb3Zlci5oaWRlKCRwb3BvdmVyKTsKICAgICAgICAgIGhhbmRsZS5oaWRlKCRoYW5kbGUpOwogICAgICAgICAgJGNvZGFibGUuZm9jdXMoKTsKCiAgICAgICAgICAvLyBhY3RpdmF0ZSBDb2RlTWlycm9yIGFzIGNvZGFibGUKICAgICAgICAgIGlmIChhZ2VudC5oYXNDb2RlTWlycm9yKSB7CiAgICAgICAgICAgIGNtRWRpdG9yID0gQ29kZU1pcnJvci5mcm9tVGV4dEFyZWEoJGNvZGFibGVbMF0sIG9wdGlvbnMuY29kZW1pcnJvcik7CgogICAgICAgICAgICAvLyBDb2RlTWlycm9yIFRlcm5TZXJ2ZXIKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29kZW1pcnJvci50ZXJuKSB7CiAgICAgICAgICAgICAgc2VydmVyID0gbmV3IENvZGVNaXJyb3IuVGVyblNlcnZlcihvcHRpb25zLmNvZGVtaXJyb3IudGVybik7CiAgICAgICAgICAgICAgY21FZGl0b3IudGVyblNlcnZlciA9IHNlcnZlcjsKICAgICAgICAgICAgICBjbUVkaXRvci5vbignY3Vyc29yQWN0aXZpdHknLCBmdW5jdGlvbiAoY20pIHsKICAgICAgICAgICAgICAgIHNlcnZlci51cGRhdGVBcmdIaW50cyhjbSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENvZGVNaXJyb3IgaGFzbid0IFBhZGRpbmcuCiAgICAgICAgICAgIGNtRWRpdG9yLnNldFNpemUobnVsbCwgJGVkaXRhYmxlLm91dGVySGVpZ2h0KCkpOwogICAgICAgICAgICAkY29kYWJsZS5kYXRhKCdjbUVkaXRvcicsIGNtRWRpdG9yKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gZGVhY3RpdmF0ZSBDb2RlTWlycm9yIGFzIGNvZGFibGUKICAgICAgICAgIGlmIChhZ2VudC5oYXNDb2RlTWlycm9yKSB7CiAgICAgICAgICAgIGNtRWRpdG9yID0gJGNvZGFibGUuZGF0YSgnY21FZGl0b3InKTsKICAgICAgICAgICAgJGNvZGFibGUudmFsKGNtRWRpdG9yLmdldFZhbHVlKCkpOwogICAgICAgICAgICBjbUVkaXRvci50b1RleHRBcmVhKCk7CiAgICAgICAgICB9CgogICAgICAgICAgJGVkaXRhYmxlLmh0bWwoZG9tLnZhbHVlKCRjb2RhYmxlKSB8fCBkb20uZW1wdHlQYXJhKTsKICAgICAgICAgICRlZGl0YWJsZS5oZWlnaHQob3B0aW9ucy5oZWlnaHQgPyAkY29kYWJsZS5oZWlnaHQoKSA6ICdhdXRvJyk7CgogICAgICAgICAgdG9vbGJhci5hY3RpdmF0ZSgkdG9vbGJhcik7CiAgICAgICAgICAkZWRpdGFibGUuZm9jdXMoKTsKICAgICAgICB9CgogICAgICAgIHRvb2xiYXIudXBkYXRlQ29kZXZpZXcobGF5b3V0SW5mby50b29sYmFyKCksIGlzQ29kZXZpZXcpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBoTW91c2Vkb3duID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIC8vcHJldmVudERlZmF1bHQgU2VsZWN0aW9uIGZvciBGRiwgSUU4KwogICAgICBpZiAoZG9tLmlzSW1nKGV2ZW50LnRhcmdldCkpIHsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBoVG9vbGJhckFuZFBvcG92ZXJVcGRhdGUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgLy8gZGVsYXkgZm9yIHJhbmdlIGFmdGVyIG1vdXNldXAKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGxheW91dEluZm8gPSBtYWtlTGF5b3V0SW5mbyhldmVudC5jdXJyZW50VGFyZ2V0IHx8IGV2ZW50LnRhcmdldCk7CiAgICAgICAgdmFyIHN0eWxlSW5mbyA9IGVkaXRvci5jdXJyZW50U3R5bGUoZXZlbnQudGFyZ2V0KTsKICAgICAgICBpZiAoIXN0eWxlSW5mbykgeyByZXR1cm47IH0KCiAgICAgICAgdmFyIGlzQWlyTW9kZSA9IGxheW91dEluZm8uZWRpdG9yKCkuZGF0YSgnb3B0aW9ucycpLmFpck1vZGU7CiAgICAgICAgaWYgKCFpc0Fpck1vZGUpIHsKICAgICAgICAgIHRvb2xiYXIudXBkYXRlKGxheW91dEluZm8udG9vbGJhcigpLCBzdHlsZUluZm8pOwogICAgICAgIH0KCiAgICAgICAgcG9wb3Zlci51cGRhdGUobGF5b3V0SW5mby5wb3BvdmVyKCksIHN0eWxlSW5mbywgaXNBaXJNb2RlKTsKICAgICAgICBoYW5kbGUudXBkYXRlKGxheW91dEluZm8uaGFuZGxlKCksIHN0eWxlSW5mbywgaXNBaXJNb2RlKTsKICAgICAgfSwgMCk7CiAgICB9OwoKICAgIHZhciBoU2Nyb2xsID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBsYXlvdXRJbmZvID0gbWFrZUxheW91dEluZm8oZXZlbnQuY3VycmVudFRhcmdldCB8fCBldmVudC50YXJnZXQpOwogICAgICAvL2hpZGUgcG9wb3ZlciBhbmQgaGFuZGxlIHdoZW4gc2Nyb2xsZWQKICAgICAgcG9wb3Zlci5oaWRlKGxheW91dEluZm8ucG9wb3ZlcigpKTsKICAgICAgaGFuZGxlLmhpZGUobGF5b3V0SW5mby5oYW5kbGUoKSk7CiAgICB9OwoKICAgIC8qKgogICAgICogcGFzdGUgY2xpcGJvYXJkIGltYWdlCiAgICAgKgogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQKICAgICAqLwogICAgdmFyIGhQYXN0ZUNsaXBib2FyZEltYWdlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBjbGlwYm9hcmREYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC5jbGlwYm9hcmREYXRhOwogICAgICB2YXIgbGF5b3V0SW5mbyA9IG1ha2VMYXlvdXRJbmZvKGV2ZW50LmN1cnJlbnRUYXJnZXQgfHwgZXZlbnQudGFyZ2V0KTsKICAgICAgdmFyICRlZGl0YWJsZSA9IGxheW91dEluZm8uZWRpdGFibGUoKTsKCiAgICAgIGlmICghY2xpcGJvYXJkRGF0YSB8fCAhY2xpcGJvYXJkRGF0YS5pdGVtcyB8fCAhY2xpcGJvYXJkRGF0YS5pdGVtcy5sZW5ndGgpIHsKICAgICAgICB2YXIgY2FsbGJhY2tzID0gJGVkaXRhYmxlLmRhdGEoJ2NhbGxiYWNrcycpOwogICAgICAgIC8vIG9ubHkgY2FuIHJ1biBpZiBpdCBoYXMgb25JbWFnZVVwbG9hZCBtZXRob2QKICAgICAgICBpZiAoIWNhbGxiYWNrcy5vbkltYWdlVXBsb2FkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBzYXZlIGN1cnNvcgogICAgICAgIGVkaXRvci5zYXZlTm9kZSgkZWRpdGFibGUpOwogICAgICAgIGVkaXRvci5zYXZlUmFuZ2UoJGVkaXRhYmxlKTsKCiAgICAgICAgJGVkaXRhYmxlLmh0bWwoJycpOwoKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciAkaW1nID0gJGVkaXRhYmxlLmZpbmQoJ2ltZycpOwogICAgICAgICAgdmFyIGRhdGF1cmkgPSAkaW1nWzBdLnNyYzsKCiAgICAgICAgICB2YXIgZGF0YSA9IGF0b2IoZGF0YXVyaS5zcGxpdCgnLCcpWzFdKTsKICAgICAgICAgIHZhciBhcnJheSA9IG5ldyBVaW50OEFycmF5KGRhdGEubGVuZ3RoKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhcnJheVtpXSA9IGRhdGEuY2hhckNvZGVBdChpKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYmxvYiA9IG5ldyBCbG9iKFthcnJheV0sIHsgdHlwZSA6ICdpbWFnZS9wbmcnfSk7CiAgICAgICAgICBibG9iLm5hbWUgPSAnY2xpcGJvYXJkLnBuZyc7CgogICAgICAgICAgZWRpdG9yLnJlc3RvcmVOb2RlKCRlZGl0YWJsZSk7CiAgICAgICAgICBlZGl0b3IucmVzdG9yZVJhbmdlKCRlZGl0YWJsZSk7CiAgICAgICAgICBpbnNlcnRJbWFnZXMobGF5b3V0SW5mbywgW2Jsb2JdKTsKCiAgICAgICAgICBlZGl0b3IuYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICAgICAgfSwgMCk7CgogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGl0ZW0gPSBsaXN0LmhlYWQoY2xpcGJvYXJkRGF0YS5pdGVtcyk7CiAgICAgIHZhciBpc0NsaXBib2FyZEltYWdlID0gaXRlbS5raW5kID09PSAnZmlsZScgJiYgaXRlbS50eXBlLmluZGV4T2YoJ2ltYWdlLycpICE9PSAtMTsKCiAgICAgIGlmIChpc0NsaXBib2FyZEltYWdlKSB7CiAgICAgICAgaW5zZXJ0SW1hZ2VzKGxheW91dEluZm8sIFtpdGVtLmdldEFzRmlsZSgpXSk7CiAgICAgIH0KCiAgICAgIGVkaXRvci5hZnRlckNvbW1hbmQoJGVkaXRhYmxlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBgbW91c2Vkb3duYCBldmVudCBoYW5kbGVyIG9uICRoYW5kbGUKICAgICAqICAtIGNvbnRyb2xTaXppbmc6IHJlc2l6ZSBpbWFnZQogICAgICoKICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQKICAgICAqLwogICAgdmFyIGhIYW5kbGVNb3VzZWRvd24gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgaWYgKGRvbS5pc0NvbnRyb2xTaXppbmcoZXZlbnQudGFyZ2V0KSkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgIHZhciBsYXlvdXRJbmZvID0gbWFrZUxheW91dEluZm8oZXZlbnQudGFyZ2V0KSwKICAgICAgICAgICAgJGhhbmRsZSA9IGxheW91dEluZm8uaGFuZGxlKCksICRwb3BvdmVyID0gbGF5b3V0SW5mby5wb3BvdmVyKCksCiAgICAgICAgICAgICRlZGl0YWJsZSA9IGxheW91dEluZm8uZWRpdGFibGUoKSwKICAgICAgICAgICAgJGVkaXRvciA9IGxheW91dEluZm8uZWRpdG9yKCk7CgogICAgICAgIHZhciB0YXJnZXQgPSAkaGFuZGxlLmZpbmQoJy5ub3RlLWNvbnRyb2wtc2VsZWN0aW9uJykuZGF0YSgndGFyZ2V0JyksCiAgICAgICAgICAgICR0YXJnZXQgPSAkKHRhcmdldCksIHBvc1N0YXJ0ID0gJHRhcmdldC5vZmZzZXQoKSwKICAgICAgICAgICAgc2Nyb2xsVG9wID0gJGRvY3VtZW50LnNjcm9sbFRvcCgpOwoKICAgICAgICB2YXIgaXNBaXJNb2RlID0gJGVkaXRvci5kYXRhKCdvcHRpb25zJykuYWlyTW9kZTsKCiAgICAgICAgJGRvY3VtZW50Lm9uKCdtb3VzZW1vdmUnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIGVkaXRvci5yZXNpemVUbyh7CiAgICAgICAgICAgIHg6IGV2ZW50LmNsaWVudFggLSBwb3NTdGFydC5sZWZ0LAogICAgICAgICAgICB5OiBldmVudC5jbGllbnRZIC0gKHBvc1N0YXJ0LnRvcCAtIHNjcm9sbFRvcCkKICAgICAgICAgIH0sICR0YXJnZXQsICFldmVudC5zaGlmdEtleSk7CgogICAgICAgICAgaGFuZGxlLnVwZGF0ZSgkaGFuZGxlLCB7aW1hZ2U6IHRhcmdldH0sIGlzQWlyTW9kZSk7CiAgICAgICAgICBwb3BvdmVyLnVwZGF0ZSgkcG9wb3Zlciwge2ltYWdlOiB0YXJnZXR9LCBpc0Fpck1vZGUpOwogICAgICAgIH0pLm9uZSgnbW91c2V1cCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICRkb2N1bWVudC5vZmYoJ21vdXNlbW92ZScpOwogICAgICAgICAgZWRpdG9yLmFmdGVyQ29tbWFuZCgkZWRpdGFibGUpOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoISR0YXJnZXQuZGF0YSgncmF0aW8nKSkgeyAvLyBvcmlnaW5hbCByYXRpby4KICAgICAgICAgICR0YXJnZXQuZGF0YSgncmF0aW8nLCAkdGFyZ2V0LmhlaWdodCgpIC8gJHRhcmdldC53aWR0aCgpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgdmFyIGhUb29sYmFyQW5kUG9wb3Zlck1vdXNlZG93biA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAvLyBwcmV2ZW50IGRlZmF1bHQgZXZlbnQgd2hlbiBpbnNlcnRUYWJsZSAoRkYsIFdlYmtpdCkKICAgICAgdmFyICRidG4gPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnW2RhdGEtZXZlbnRdJyk7CiAgICAgIGlmICgkYnRuLmxlbmd0aCkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIGhUb29sYmFyQW5kUG9wb3ZlckNsaWNrID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciAkYnRuID0gJChldmVudC50YXJnZXQpLmNsb3Nlc3QoJ1tkYXRhLWV2ZW50XScpOwoKICAgICAgaWYgKCRidG4ubGVuZ3RoKSB7CiAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICRidG4uYXR0cignZGF0YS1ldmVudCcpLAogICAgICAgICAgICB2YWx1ZSA9ICRidG4uYXR0cignZGF0YS12YWx1ZScpLAogICAgICAgICAgICBoaWRlID0gJGJ0bi5hdHRyKCdkYXRhLWhpZGUnKTsKCiAgICAgICAgdmFyIGxheW91dEluZm8gPSBtYWtlTGF5b3V0SW5mbyhldmVudC50YXJnZXQpOwoKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAvLyBiZWZvcmUgY29tbWFuZDogZGV0ZWN0IGNvbnRyb2wgc2VsZWN0aW9uIGVsZW1lbnQoJHRhcmdldCkKICAgICAgICB2YXIgJHRhcmdldDsKICAgICAgICBpZiAoJC5pbkFycmF5KGV2ZW50TmFtZSwgWydyZXNpemUnLCAnZmxvYXRNZScsICdyZW1vdmVNZWRpYScsICdpbWFnZVNoYXBlJ10pICE9PSAtMSkgewogICAgICAgICAgdmFyICRzZWxlY3Rpb24gPSBsYXlvdXRJbmZvLmhhbmRsZSgpLmZpbmQoJy5ub3RlLWNvbnRyb2wtc2VsZWN0aW9uJyk7CiAgICAgICAgICAkdGFyZ2V0ID0gJCgkc2VsZWN0aW9uLmRhdGEoJ3RhcmdldCcpKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHJlcXVlc3RlZCwgaGlkZSB0aGUgcG9wb3ZlciB3aGVuIHRoZSBidXR0b24gaXMgY2xpY2tlZC4KICAgICAgICAvLyBVc2VmdWwgZm9yIHRoaW5ncyBsaWtlIHNob3dIZWxwRGlhbG9nLgogICAgICAgIGlmIChoaWRlKSB7CiAgICAgICAgICAkYnRuLnBhcmVudHMoJy5wb3BvdmVyJykuaGlkZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVkaXRvcltldmVudE5hbWVdKSB7IC8vIG9uIGNvbW1hbmQKICAgICAgICAgIHZhciAkZWRpdGFibGUgPSBsYXlvdXRJbmZvLmVkaXRhYmxlKCk7CiAgICAgICAgICAkZWRpdGFibGUudHJpZ2dlcignZm9jdXMnKTsKICAgICAgICAgIGVkaXRvcltldmVudE5hbWVdKCRlZGl0YWJsZSwgdmFsdWUsICR0YXJnZXQpOwogICAgICAgIH0gZWxzZSBpZiAoY29tbWFuZHNbZXZlbnROYW1lXSkgewogICAgICAgICAgY29tbWFuZHNbZXZlbnROYW1lXS5jYWxsKHRoaXMsIGxheW91dEluZm8pOwogICAgICAgIH0gZWxzZSBpZiAoJC5pc0Z1bmN0aW9uKCQuc3VtbWVybm90ZS5wbHVnaW5FdmVudHNbZXZlbnROYW1lXSkpIHsKICAgICAgICAgICQuc3VtbWVybm90ZS5wbHVnaW5FdmVudHNbZXZlbnROYW1lXShsYXlvdXRJbmZvLCB2YWx1ZSwgJHRhcmdldCk7CiAgICAgICAgfQoKICAgICAgICAvLyBhZnRlciBjb21tYW5kCiAgICAgICAgaWYgKCQuaW5BcnJheShldmVudE5hbWUsIFsnYmFja0NvbG9yJywgJ2ZvcmVDb2xvciddKSAhPT0gLTEpIHsKICAgICAgICAgIHZhciBvcHRpb25zID0gbGF5b3V0SW5mby5lZGl0b3IoKS5kYXRhKCdvcHRpb25zJywgb3B0aW9ucyk7CiAgICAgICAgICB2YXIgbW9kdWxlID0gb3B0aW9ucy5haXJNb2RlID8gcG9wb3ZlciA6IHRvb2xiYXI7CiAgICAgICAgICBtb2R1bGUudXBkYXRlUmVjZW50Q29sb3IobGlzdC5oZWFkKCRidG4pLCBldmVudE5hbWUsIHZhbHVlKTsKICAgICAgICB9CgogICAgICAgIGhUb29sYmFyQW5kUG9wb3ZlclVwZGF0ZShldmVudCk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIEVESVRBQkxFX1BBRERJTkcgPSAyNDsKICAgIC8qKgogICAgICogYG1vdXNlZG93bmAgZXZlbnQgaGFuZGxlciBvbiBzdGF0dXNiYXIKICAgICAqCiAgICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50CiAgICAgKi8KICAgIHZhciBoU3RhdHVzYmFyTW91c2Vkb3duID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoKICAgICAgdmFyICRlZGl0YWJsZSA9IG1ha2VMYXlvdXRJbmZvKGV2ZW50LnRhcmdldCkuZWRpdGFibGUoKTsKICAgICAgdmFyIG5FZGl0YWJsZVRvcCA9ICRlZGl0YWJsZS5vZmZzZXQoKS50b3AgLSAkZG9jdW1lbnQuc2Nyb2xsVG9wKCk7CgogICAgICB2YXIgbGF5b3V0SW5mbyA9IG1ha2VMYXlvdXRJbmZvKGV2ZW50LmN1cnJlbnRUYXJnZXQgfHwgZXZlbnQudGFyZ2V0KTsKICAgICAgdmFyIG9wdGlvbnMgPSBsYXlvdXRJbmZvLmVkaXRvcigpLmRhdGEoJ29wdGlvbnMnKTsKCiAgICAgICRkb2N1bWVudC5vbignbW91c2Vtb3ZlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIG5IZWlnaHQgPSBldmVudC5jbGllbnRZIC0gKG5FZGl0YWJsZVRvcCArIEVESVRBQkxFX1BBRERJTkcpOwoKICAgICAgICBuSGVpZ2h0ID0gKG9wdGlvbnMubWluSGVpZ2h0ID4gMCkgPyBNYXRoLm1heChuSGVpZ2h0LCBvcHRpb25zLm1pbkhlaWdodCkgOiBuSGVpZ2h0OwogICAgICAgIG5IZWlnaHQgPSAob3B0aW9ucy5tYXhIZWlnaHQgPiAwKSA\/IE1hdGgubWluKG5IZWlnaHQsIG9wdGlvbnMubWF4SGVpZ2h0KSA6IG5IZWlnaHQ7CgogICAgICAgICRlZGl0YWJsZS5oZWlnaHQobkhlaWdodCk7CiAgICAgIH0pLm9uZSgnbW91c2V1cCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAkZG9jdW1lbnQub2ZmKCdtb3VzZW1vdmUnKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBQWF9QRVJfRU0gPSAxODsKICAgIHZhciBoRGltZW5zaW9uUGlja2VyTW92ZSA9IGZ1bmN0aW9uIChldmVudCwgb3B0aW9ucykgewogICAgICB2YXIgJHBpY2tlciA9ICQoZXZlbnQudGFyZ2V0LnBhcmVudE5vZGUpOyAvLyB0YXJnZXQgaXMgbW91c2VjYXRjaGVyCiAgICAgIHZhciAkZGltZW5zaW9uRGlzcGxheSA9ICRwaWNrZXIubmV4dCgpOwogICAgICB2YXIgJGNhdGNoZXIgPSAkcGlja2VyLmZpbmQoJy5ub3RlLWRpbWVuc2lvbi1waWNrZXItbW91c2VjYXRjaGVyJyk7CiAgICAgIHZhciAkaGlnaGxpZ2h0ZWQgPSAkcGlja2VyLmZpbmQoJy5ub3RlLWRpbWVuc2lvbi1waWNrZXItaGlnaGxpZ2h0ZWQnKTsKICAgICAgdmFyICR1bmhpZ2hsaWdodGVkID0gJHBpY2tlci5maW5kKCcubm90ZS1kaW1lbnNpb24tcGlja2VyLXVuaGlnaGxpZ2h0ZWQnKTsKCiAgICAgIHZhciBwb3NPZmZzZXQ7CiAgICAgIC8vIEhUTUw1IHdpdGggalF1ZXJ5IC0gZS5vZmZzZXRYIGlzIHVuZGVmaW5lZCBpbiBGaXJlZm94CiAgICAgIGlmIChldmVudC5vZmZzZXRYID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgcG9zQ2F0Y2hlciA9ICQoZXZlbnQudGFyZ2V0KS5vZmZzZXQoKTsKICAgICAgICBwb3NPZmZzZXQgPSB7CiAgICAgICAgICB4OiBldmVudC5wYWdlWCAtIHBvc0NhdGNoZXIubGVmdCwKICAgICAgICAgIHk6IGV2ZW50LnBhZ2VZIC0gcG9zQ2F0Y2hlci50b3AKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHBvc09mZnNldCA9IHsKICAgICAgICAgIHg6IGV2ZW50Lm9mZnNldFgsCiAgICAgICAgICB5OiBldmVudC5vZmZzZXRZCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdmFyIGRpbSA9IHsKICAgICAgICBjOiBNYXRoLmNlaWwocG9zT2Zmc2V0LnggLyBQWF9QRVJfRU0pIHx8IDEsCiAgICAgICAgcjogTWF0aC5jZWlsKHBvc09mZnNldC55IC8gUFhfUEVSX0VNKSB8fCAxCiAgICAgIH07CgogICAgICAkaGlnaGxpZ2h0ZWQuY3NzKHsgd2lkdGg6IGRpbS5jICsgJ2VtJywgaGVpZ2h0OiBkaW0uciArICdlbScgfSk7CiAgICAgICRjYXRjaGVyLmF0dHIoJ2RhdGEtdmFsdWUnLCBkaW0uYyArICd4JyArIGRpbS5yKTsKCiAgICAgIGlmICgzIDwgZGltLmMgJiYgZGltLmMgPCBvcHRpb25zLmluc2VydFRhYmxlTWF4U2l6ZS5jb2wpIHsKICAgICAgICAkdW5oaWdobGlnaHRlZC5jc3MoeyB3aWR0aDogZGltLmMgKyAxICsgJ2VtJ30pOwogICAgICB9CgogICAgICBpZiAoMyA8IGRpbS5yICYmIGRpbS5yIDwgb3B0aW9ucy5pbnNlcnRUYWJsZU1heFNpemUucm93KSB7CiAgICAgICAgJHVuaGlnaGxpZ2h0ZWQuY3NzKHsgaGVpZ2h0OiBkaW0uciArIDEgKyAnZW0nfSk7CiAgICAgIH0KCiAgICAgICRkaW1lbnNpb25EaXNwbGF5Lmh0bWwoZGltLmMgKyAnIHggJyArIGRpbS5yKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBEcmFnIGFuZCBEcm9wIEV2ZW50cwogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsYXlvdXRJbmZvIC0gbGF5b3V0IEluZm9ybWF0aW9ucwogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgdmFyIGhhbmRsZURyYWdBbmREcm9wRXZlbnQgPSBmdW5jdGlvbiAobGF5b3V0SW5mbywgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucy5kaXNhYmxlRHJhZ0FuZERyb3ApIHsKICAgICAgICAvLyBwcmV2ZW50IGRlZmF1bHQgZHJvcCBldmVudAogICAgICAgICRkb2N1bWVudC5vbignZHJvcCcsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXR0YWNoRHJhZ0FuZERyb3BFdmVudChsYXlvdXRJbmZvLCBvcHRpb25zKTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIGF0dGFjaCBEcmFnIGFuZCBEcm9wIEV2ZW50cwogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsYXlvdXRJbmZvIC0gbGF5b3V0IEluZm9ybWF0aW9ucwogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgdmFyIGF0dGFjaERyYWdBbmREcm9wRXZlbnQgPSBmdW5jdGlvbiAobGF5b3V0SW5mbywgb3B0aW9ucykgewogICAgICB2YXIgY29sbGVjdGlvbiA9ICQoKSwKICAgICAgICAgICRkcm9wem9uZSA9IGxheW91dEluZm8uZHJvcHpvbmUsCiAgICAgICAgICAkZHJvcHpvbmVNZXNzYWdlID0gbGF5b3V0SW5mby5kcm9wem9uZS5maW5kKCcubm90ZS1kcm9wem9uZS1tZXNzYWdlJyk7CgogICAgICAvLyBzaG93IGRyb3B6b25lIG9uIGRyYWdlbnRlciB3aGVuIGRyYWdnaW5nIGEgb2JqZWN0IHRvIGRvY3VtZW50LgogICAgICAkZG9jdW1lbnQub24oJ2RyYWdlbnRlcicsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIGlzQ29kZXZpZXcgPSBsYXlvdXRJbmZvLmVkaXRvci5oYXNDbGFzcygnY29kZXZpZXcnKTsKICAgICAgICBpZiAoIWlzQ29kZXZpZXcgJiYgIWNvbGxlY3Rpb24ubGVuZ3RoKSB7CiAgICAgICAgICBsYXlvdXRJbmZvLmVkaXRvci5hZGRDbGFzcygnZHJhZ292ZXInKTsKICAgICAgICAgICRkcm9wem9uZS53aWR0aChsYXlvdXRJbmZvLmVkaXRvci53aWR0aCgpKTsKICAgICAgICAgICRkcm9wem9uZS5oZWlnaHQobGF5b3V0SW5mby5lZGl0b3IuaGVpZ2h0KCkpOwogICAgICAgICAgJGRyb3B6b25lTWVzc2FnZS50ZXh0KG9wdGlvbnMubGFuZ0luZm8uaW1hZ2UuZHJhZ0ltYWdlSGVyZSk7CiAgICAgICAgfQogICAgICAgIGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmFkZChlLnRhcmdldCk7CiAgICAgIH0pLm9uKCdkcmFnbGVhdmUnLCBmdW5jdGlvbiAoZSkgewogICAgICAgIGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLm5vdChlLnRhcmdldCk7CiAgICAgICAgaWYgKCFjb2xsZWN0aW9uLmxlbmd0aCkgewogICAgICAgICAgbGF5b3V0SW5mby5lZGl0b3IucmVtb3ZlQ2xhc3MoJ2RyYWdvdmVyJyk7CiAgICAgICAgfQogICAgICB9KS5vbignZHJvcCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBjb2xsZWN0aW9uID0gJCgpOwogICAgICAgIGxheW91dEluZm8uZWRpdG9yLnJlbW92ZUNsYXNzKCdkcmFnb3ZlcicpOwogICAgICB9KTsKCiAgICAgIC8vIGNoYW5nZSBkcm9wem9uZSdzIG1lc3NhZ2Ugb24gaG92ZXIuCiAgICAgICRkcm9wem9uZS5vbignZHJhZ2VudGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgICRkcm9wem9uZS5hZGRDbGFzcygnaG92ZXInKTsKICAgICAgICAkZHJvcHpvbmVNZXNzYWdlLnRleHQob3B0aW9ucy5sYW5nSW5mby5pbWFnZS5kcm9wSW1hZ2UpOwogICAgICB9KS5vbignZHJhZ2xlYXZlJywgZnVuY3Rpb24gKCkgewogICAgICAgICRkcm9wem9uZS5yZW1vdmVDbGFzcygnaG92ZXInKTsKICAgICAgICAkZHJvcHpvbmVNZXNzYWdlLnRleHQob3B0aW9ucy5sYW5nSW5mby5pbWFnZS5kcmFnSW1hZ2VIZXJlKTsKICAgICAgfSk7CgogICAgICAvLyBhdHRhY2ggZHJvcEltYWdlCiAgICAgICRkcm9wem9uZS5vbignZHJvcCcsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgIHZhciBkYXRhVHJhbnNmZXIgPSBldmVudC5vcmlnaW5hbEV2ZW50LmRhdGFUcmFuc2ZlcjsKICAgICAgICB2YXIgdGV4dCA9IGRhdGFUcmFuc2Zlci5nZXREYXRhKCd0ZXh0L3BsYWluJyk7CiAgICAgICAgdmFyIGxheW91dEluZm8gPSBtYWtlTGF5b3V0SW5mbyhldmVudC5jdXJyZW50VGFyZ2V0IHx8IGV2ZW50LnRhcmdldCk7CiAgICAgICAgbGF5b3V0SW5mby5lZGl0YWJsZSgpLmZvY3VzKCk7CiAgICAgICAgaWYgKGRhdGFUcmFuc2ZlciAmJiBkYXRhVHJhbnNmZXIuZmlsZXMgJiYgZGF0YVRyYW5zZmVyLmZpbGVzLmxlbmd0aCkgewogICAgICAgICAgaW5zZXJ0SW1hZ2VzKGxheW91dEluZm8sIGRhdGFUcmFuc2Zlci5maWxlcyk7CiAgICAgICAgfSBlbHNlIGlmICh0ZXh0KSB7CiAgICAgICAgICBlZGl0b3IuaW5zZXJ0VGV4dChsYXlvdXRJbmZvLmVkaXRhYmxlKCksIHRleHQpOwogICAgICAgIH0KICAgICAgfSkub24oJ2RyYWdvdmVyJywgZmFsc2UpOyAvLyBwcmV2ZW50IGRlZmF1bHQgZHJhZ292ZXIgZXZlbnQKICAgIH07CgoKICAgIC8qKgogICAgICogYmluZCBLZXlNYXAgb24ga2V5ZG93bgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsYXlvdXRJbmZvCiAgICAgKiBAcGFyYW0ge09iamVjdH0ga2V5TWFwCiAgICAgKi8KICAgIHRoaXMuYmluZEtleU1hcCA9IGZ1bmN0aW9uIChsYXlvdXRJbmZvLCBrZXlNYXApIHsKICAgICAgdmFyICRlZGl0b3IgPSBsYXlvdXRJbmZvLmVkaXRvcjsKICAgICAgdmFyICRlZGl0YWJsZSA9IGxheW91dEluZm8uZWRpdGFibGU7CgogICAgICBsYXlvdXRJbmZvID0gbWFrZUxheW91dEluZm8oJGVkaXRhYmxlKTsKCiAgICAgICRlZGl0YWJsZS5vbigna2V5ZG93bicsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHZhciBhS2V5ID0gW107CgogICAgICAgIC8vIG1vZGlmaWVyCiAgICAgICAgaWYgKGV2ZW50Lm1ldGFLZXkpIHsgYUtleS5wdXNoKCdDTUQnKTsgfQogICAgICAgIGlmIChldmVudC5jdHJsS2V5ICYmICFldmVudC5hbHRLZXkpIHsgYUtleS5wdXNoKCdDVFJMJyk7IH0KICAgICAgICBpZiAoZXZlbnQuc2hpZnRLZXkpIHsgYUtleS5wdXNoKCdTSElGVCcpOyB9CgogICAgICAgIC8vIGtleWNvZGUKICAgICAgICB2YXIga2V5TmFtZSA9IGtleS5uYW1lRnJvbUNvZGVbZXZlbnQua2V5Q29kZV07CiAgICAgICAgaWYgKGtleU5hbWUpIHsgYUtleS5wdXNoKGtleU5hbWUpOyB9CgogICAgICAgIHZhciBldmVudE5hbWUgPSBrZXlNYXBbYUtleS5qb2luKCcrJyldOwogICAgICAgIGlmIChldmVudE5hbWUpIHsKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgaWYgKGVkaXRvcltldmVudE5hbWVdKSB7CiAgICAgICAgICAgIGVkaXRvcltldmVudE5hbWVdKCRlZGl0YWJsZSwgJGVkaXRvci5kYXRhKCdvcHRpb25zJykpOwogICAgICAgICAgfSBlbHNlIGlmIChjb21tYW5kc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIGNvbW1hbmRzW2V2ZW50TmFtZV0uY2FsbCh0aGlzLCBsYXlvdXRJbmZvKTsKICAgICAgICAgIH0gZWxzZSBpZiAoJC5zdW1tZXJub3RlLnBsdWdpbnNbZXZlbnROYW1lXSkgewogICAgICAgICAgICB2YXIgcGx1Z2luID0gJC5zdW1tZXJub3RlLnBsdWdpbnNbZXZlbnROYW1lXTsKICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihwbHVnaW4uZXZlbnQpKSB7CiAgICAgICAgICAgICAgcGx1Z2luLmV2ZW50KGV2ZW50LCBlZGl0b3IsIGxheW91dEluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChrZXkuaXNFZGl0KGV2ZW50LmtleUNvZGUpKSB7CiAgICAgICAgICBlZGl0b3IuYWZ0ZXJDb21tYW5kKCRlZGl0YWJsZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBhdHRhY2ggZXZlbnRoYW5kbGVyCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGxheW91dEluZm8gLSBsYXlvdXQgSW5mb3JtYXRpb25zCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIHVzZXIgb3B0aW9ucyBpbmNsdWRlIGN1c3RvbSBldmVudCBoYW5kbGVycwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb3B0aW9ucy5lbnRlciAtIGVudGVyIGtleSBoYW5kbGVyCiAgICAgKi8KICAgIHRoaXMuYXR0YWNoID0gZnVuY3Rpb24gKGxheW91dEluZm8sIG9wdGlvbnMpIHsKICAgICAgLy8gaGFuZGxlcnMgZm9yIGVkaXRhYmxlCiAgICAgIGlmIChvcHRpb25zLnNob3J0Y3V0cykgewogICAgICAgIHRoaXMuYmluZEtleU1hcChsYXlvdXRJbmZvLCBvcHRpb25zLmtleU1hcFthZ2VudC5pc01hYyA\/ICdtYWMnIDogJ3BjJ10pOwogICAgICB9CiAgICAgIGxheW91dEluZm8uZWRpdGFibGUub24oJ21vdXNlZG93bicsIGhNb3VzZWRvd24pOwogICAgICBsYXlvdXRJbmZvLmVkaXRhYmxlLm9uKCdrZXl1cCBtb3VzZXVwJywgaFRvb2xiYXJBbmRQb3BvdmVyVXBkYXRlKTsKICAgICAgbGF5b3V0SW5mby5lZGl0YWJsZS5vbignc2Nyb2xsJywgaFNjcm9sbCk7CiAgICAgIGxheW91dEluZm8uZWRpdGFibGUub24oJ3Bhc3RlJywgaFBhc3RlQ2xpcGJvYXJkSW1hZ2UpOwoKICAgICAgLy8gaGFuZGxlciBmb3IgaGFuZGxlIGFuZCBwb3BvdmVyCiAgICAgIGxheW91dEluZm8uaGFuZGxlLm9uKCdtb3VzZWRvd24nLCBoSGFuZGxlTW91c2Vkb3duKTsKICAgICAgbGF5b3V0SW5mby5wb3BvdmVyLm9uKCdjbGljaycsIGhUb29sYmFyQW5kUG9wb3ZlckNsaWNrKTsKICAgICAgbGF5b3V0SW5mby5wb3BvdmVyLm9uKCdtb3VzZWRvd24nLCBoVG9vbGJhckFuZFBvcG92ZXJNb3VzZWRvd24pOwoKICAgICAgLy8gaGFuZGxlcnMgZm9yIGZyYW1lIG1vZGUgKHRvb2xiYXIsIHN0YXR1c2JhcikKICAgICAgaWYgKCFvcHRpb25zLmFpck1vZGUpIHsKICAgICAgICAvLyBoYW5kbGVyIGZvciBkcmFnIGFuZCBkcm9wCiAgICAgICAgaGFuZGxlRHJhZ0FuZERyb3BFdmVudChsYXlvdXRJbmZvLCBvcHRpb25zKTsKCiAgICAgICAgLy8gaGFuZGxlciBmb3IgdG9vbGJhcgogICAgICAgIGxheW91dEluZm8udG9vbGJhci5vbignY2xpY2snLCBoVG9vbGJhckFuZFBvcG92ZXJDbGljayk7CiAgICAgICAgbGF5b3V0SW5mby50b29sYmFyLm9uKCdtb3VzZWRvd24nLCBoVG9vbGJhckFuZFBvcG92ZXJNb3VzZWRvd24pOwoKICAgICAgICAvLyBoYW5kbGVyIGZvciBzdGF0dXNiYXIKICAgICAgICBpZiAoIW9wdGlvbnMuZGlzYWJsZVJlc2l6ZUVkaXRvcikgewogICAgICAgICAgbGF5b3V0SW5mby5zdGF0dXNiYXIub24oJ21vdXNlZG93bicsIGhTdGF0dXNiYXJNb3VzZWRvd24pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gaGFuZGxlciBmb3IgdGFibGUgZGltZW5zaW9uCiAgICAgIHZhciAkY2F0Y2hlckNvbnRhaW5lciA9IG9wdGlvbnMuYWlyTW9kZSA\/IGxheW91dEluZm8ucG9wb3ZlciA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxheW91dEluZm8udG9vbGJhcjsKICAgICAgdmFyICRjYXRjaGVyID0gJGNhdGNoZXJDb250YWluZXIuZmluZCgnLm5vdGUtZGltZW5zaW9uLXBpY2tlci1tb3VzZWNhdGNoZXInKTsKICAgICAgJGNhdGNoZXIuY3NzKHsKICAgICAgICB3aWR0aDogb3B0aW9ucy5pbnNlcnRUYWJsZU1heFNpemUuY29sICsgJ2VtJywKICAgICAgICBoZWlnaHQ6IG9wdGlvbnMuaW5zZXJ0VGFibGVNYXhTaXplLnJvdyArICdlbScKICAgICAgfSkub24oJ21vdXNlbW92ZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGhEaW1lbnNpb25QaWNrZXJNb3ZlKGV2ZW50LCBvcHRpb25zKTsKICAgICAgfSk7CgogICAgICAvLyBzYXZlIG9wdGlvbnMgb24gZWRpdG9yCiAgICAgIGxheW91dEluZm8uZWRpdG9yLmRhdGEoJ29wdGlvbnMnLCBvcHRpb25zKTsKCiAgICAgIC8vIHJldCBzdHlsZVdpdGhDU1MgZm9yIGJhY2tDb2xvciAvIGZvcmVDb2xvciBjbGVhcmluZyB3aXRoICdpbmhlcml0Jy4KICAgICAgaWYgKCFhZ2VudC5pc01TSUUpIHsKICAgICAgICAvLyBwcm90ZWN0IEZGIEVycm9yOiBOU19FUlJPUl9GQUlMVVJFOiBGYWlsdXJlCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgnc3R5bGVXaXRoQ1NTJywgMCwgb3B0aW9ucy5zdHlsZVdpdGhTcGFuKTsKICAgICAgICB9LCAwKTsKICAgICAgfQoKICAgICAgLy8gSGlzdG9yeQogICAgICB2YXIgaGlzdG9yeSA9IG5ldyBIaXN0b3J5KGxheW91dEluZm8uZWRpdGFibGUpOwogICAgICBsYXlvdXRJbmZvLmVkaXRhYmxlLmRhdGEoJ05vdGVIaXN0b3J5JywgaGlzdG9yeSk7CgogICAgICAvLyBiYXNpYyBldmVudCBjYWxsYmFja3MgKGxvd2VyY2FzZSkKICAgICAgLy8gZW50ZXIsIGZvY3VzLCBibHVyLCBrZXl1cCwga2V5ZG93bgogICAgICBpZiAob3B0aW9ucy5vbmVudGVyKSB7CiAgICAgICAgbGF5b3V0SW5mby5lZGl0YWJsZS5rZXlwcmVzcyhmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSBrZXkuRU5URVIpIHsgb3B0aW9ucy5vbmVudGVyKGV2ZW50KTsgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5vbmZvY3VzKSB7IGxheW91dEluZm8uZWRpdGFibGUuZm9jdXMob3B0aW9ucy5vbmZvY3VzKTsgfQogICAgICBpZiAob3B0aW9ucy5vbmJsdXIpIHsgbGF5b3V0SW5mby5lZGl0YWJsZS5ibHVyKG9wdGlvbnMub25ibHVyKTsgfQogICAgICBpZiAob3B0aW9ucy5vbmtleXVwKSB7IGxheW91dEluZm8uZWRpdGFibGUua2V5dXAob3B0aW9ucy5vbmtleXVwKTsgfQogICAgICBpZiAob3B0aW9ucy5vbmtleWRvd24pIHsgbGF5b3V0SW5mby5lZGl0YWJsZS5rZXlkb3duKG9wdGlvbnMub25rZXlkb3duKTsgfQogICAgICBpZiAob3B0aW9ucy5vbnBhc3RlKSB7IGxheW91dEluZm8uZWRpdGFibGUub24oJ3Bhc3RlJywgb3B0aW9ucy5vbnBhc3RlKTsgfQoKICAgICAgLy8gY2FsbGJhY2tzIGZvciBhZHZhbmNlZCBmZWF0dXJlcyAoY2FtZWwpCiAgICAgIGlmIChvcHRpb25zLm9uVG9vbGJhckNsaWNrKSB7IGxheW91dEluZm8udG9vbGJhci5jbGljayhvcHRpb25zLm9uVG9vbGJhckNsaWNrKTsgfQogICAgICBpZiAob3B0aW9ucy5vbkNoYW5nZSkgewogICAgICAgIHZhciBoQ2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZWRpdG9yLnRyaWdnZXJPbkNoYW5nZShsYXlvdXRJbmZvLmVkaXRhYmxlKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoYWdlbnQuaXNNU0lFKSB7CiAgICAgICAgICB2YXIgc0RvbUV2ZW50cyA9ICdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQgRE9NU3VidHJlZU1vZGlmaWVkIERPTU5vZGVJbnNlcnRlZCc7CiAgICAgICAgICBsYXlvdXRJbmZvLmVkaXRhYmxlLm9uKHNEb21FdmVudHMsIGhDaGFuZ2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsYXlvdXRJbmZvLmVkaXRhYmxlLm9uKCdpbnB1dCcsIGhDaGFuZ2UpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQWxsIGVkaXRvciBzdGF0dXMgd2lsbCBiZSBzYXZlZCBvbiBlZGl0YWJsZSB3aXRoIGpxdWVyeSdzIGRhdGEKICAgICAgLy8gZm9yIHN1cHBvcnQgbXVsdGlwbGUgZWRpdG9yIHdpdGggc2luZ2xldG9uIG9iamVjdC4KICAgICAgbGF5b3V0SW5mby5lZGl0YWJsZS5kYXRhKCdjYWxsYmFja3MnLCB7CiAgICAgICAgb25DaGFuZ2U6IG9wdGlvbnMub25DaGFuZ2UsCiAgICAgICAgb25BdXRvU2F2ZTogb3B0aW9ucy5vbkF1dG9TYXZlLAogICAgICAgIG9uSW1hZ2VVcGxvYWQ6IG9wdGlvbnMub25JbWFnZVVwbG9hZCwKICAgICAgICBvbkltYWdlVXBsb2FkRXJyb3I6IG9wdGlvbnMub25JbWFnZVVwbG9hZEVycm9yLAogICAgICAgIG9uRmlsZVVwbG9hZDogb3B0aW9ucy5vbkZpbGVVcGxvYWQsCiAgICAgICAgb25GaWxlVXBsb2FkRXJyb3I6IG9wdGlvbnMub25GaWxlVXBsb2FkCiAgICAgIH0pOwogICAgfTsKCiAgICB0aGlzLmRldGFjaCA9IGZ1bmN0aW9uIChsYXlvdXRJbmZvLCBvcHRpb25zKSB7CiAgICAgIGxheW91dEluZm8uZWRpdGFibGUub2ZmKCk7CgogICAgICBsYXlvdXRJbmZvLnBvcG92ZXIub2ZmKCk7CiAgICAgIGxheW91dEluZm8uaGFuZGxlLm9mZigpOwogICAgICBsYXlvdXRJbmZvLmRpYWxvZy5vZmYoKTsKCiAgICAgIGlmICghb3B0aW9ucy5haXJNb2RlKSB7CiAgICAgICAgbGF5b3V0SW5mby5kcm9wem9uZS5vZmYoKTsKICAgICAgICBsYXlvdXRJbmZvLnRvb2xiYXIub2ZmKCk7CiAgICAgICAgbGF5b3V0SW5mby5zdGF0dXNiYXIub2ZmKCk7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgLyoqCiAgICogcmVuZGVyZXIKICAgKgogICAqIHJlbmRlcmluZyB0b29sYmFyIGFuZCBlZGl0YWJsZQogICAqLwogIHZhciBSZW5kZXJlciA9IGZ1bmN0aW9uICgpIHsKCiAgICAvKioKICAgICAqIGJvb3RzdHJhcCBidXR0b24gdGVtcGxhdGUKICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbGFiZWwKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5ldmVudF0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy52YWx1ZV0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy50aXRsZV0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5kcm9wZG93bl0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5oaWRlXQogICAgICovCiAgICB2YXIgdHBsQnV0dG9uID0gZnVuY3Rpb24gKGxhYmVsLCBvcHRpb25zKSB7CiAgICAgIHZhciBldmVudCA9IG9wdGlvbnMuZXZlbnQ7CiAgICAgIHZhciB2YWx1ZSA9IG9wdGlvbnMudmFsdWU7CiAgICAgIHZhciB0aXRsZSA9IG9wdGlvbnMudGl0bGU7CiAgICAgIHZhciBjbGFzc05hbWUgPSBvcHRpb25zLmNsYXNzTmFtZTsKICAgICAgdmFyIGRyb3Bkb3duID0gb3B0aW9ucy5kcm9wZG93bjsKICAgICAgdmFyIGhpZGUgPSBvcHRpb25zLmhpZGU7CgogICAgICByZXR1cm4gJzxidXR0b24gdHlwZT0iYnV0dG9uIicgKwogICAgICAgICAgICAgICAgICcgY2xhc3M9ImJ0biBidG4tZGVmYXVsdCBidG4tc20gYnRuLXNtYWxsJyArCiAgICAgICAgICAgICAgICAgICAoY2xhc3NOYW1lID8gJyAnICsgY2xhc3NOYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgIChkcm9wZG93biA\/ICcgZHJvcGRvd24tdG9nZ2xlJyA6ICcnKSArCiAgICAgICAgICAgICAgICAgJyInICsKICAgICAgICAgICAgICAgICAoZHJvcGRvd24gPyAnIGRhdGEtdG9nZ2xlPSJkcm9wZG93biInIDogJycpICsKICAgICAgICAgICAgICAgICAodGl0bGUgPyAnIHRpdGxlPSInICsgdGl0bGUgKyAnIicgOiAnJykgKwogICAgICAgICAgICAgICAgIChldmVudCA\/ICcgZGF0YS1ldmVudD0iJyArIGV2ZW50ICsgJyInIDogJycpICsKICAgICAgICAgICAgICAgICAodmFsdWUgPyAnIGRhdGEtdmFsdWU9XCcnICsgdmFsdWUgKyAnXCcnIDogJycpICsKICAgICAgICAgICAgICAgICAoaGlkZSA\/ICcgZGF0YS1oaWRlPVwnJyArIGhpZGUgKyAnXCcnIDogJycpICsKICAgICAgICAgICAgICAgICAnIHRhYmluZGV4PSItMSI+JyArCiAgICAgICAgICAgICAgIGxhYmVsICsKICAgICAgICAgICAgICAgKGRyb3Bkb3duID8gJyA8c3BhbiBjbGFzcz0iY2FyZXQiPjwvc3Bhbj4nIDogJycpICsKICAgICAgICAgICAgICc8L2J1dHRvbj4nICsKICAgICAgICAgICAgIChkcm9wZG93biB8fCAnJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogYm9vdHN0cmFwIGljb24gYnV0dG9uIHRlbXBsYXRlCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGljb25DbGFzc05hbWUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5ldmVudF0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy52YWx1ZV0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy50aXRsZV0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5kcm9wZG93bl0KICAgICAqLwogICAgdmFyIHRwbEljb25CdXR0b24gPSBmdW5jdGlvbiAoaWNvbkNsYXNzTmFtZSwgb3B0aW9ucykgewogICAgICB2YXIgbGFiZWwgPSAnPGkgY2xhc3M9IicgKyBpY29uQ2xhc3NOYW1lICsgJyI+PC9pPic7CiAgICAgIHJldHVybiB0cGxCdXR0b24obGFiZWwsIG9wdGlvbnMpOwogICAgfTsKCiAgICAvKioKICAgICAqIGJvb3RzdHJhcCBwb3BvdmVyIHRlbXBsYXRlCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGNsYXNzTmFtZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGNvbnRlbnQKICAgICAqLwogICAgdmFyIHRwbFBvcG92ZXIgPSBmdW5jdGlvbiAoY2xhc3NOYW1lLCBjb250ZW50KSB7CiAgICAgIHJldHVybiAnPGRpdiBjbGFzcz0iJyArIGNsYXNzTmFtZSArICcgcG9wb3ZlciBib3R0b20gaW4iIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+JyArCiAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJhcnJvdyI+PC9kaXY+JyArCiAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJwb3BvdmVyLWNvbnRlbnQiPicgKwogICAgICAgICAgICAgICAgIGNvbnRlbnQgKwogICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAnPC9kaXY+JzsKICAgIH07CgogICAgLyoqCiAgICAgKiBib290c3RyYXAgZGlhbG9nIHRlbXBsYXRlCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGNsYXNzTmFtZQogICAgICogQHBhcmFtIHtTdHJpbmd9IFt0aXRsZV0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBib2R5CiAgICAgKiBAcGFyYW0ge1N0cmluZ30gW2Zvb3Rlcl0KICAgICAqLwogICAgdmFyIHRwbERpYWxvZyA9IGZ1bmN0aW9uIChjbGFzc05hbWUsIHRpdGxlLCBib2R5LCBmb290ZXIpIHsKICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPSInICsgY2xhc3NOYW1lICsgJyBtb2RhbCIgYXJpYS1oaWRkZW49ImZhbHNlIj4nICsKICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im1vZGFsLWRpYWxvZyI+JyArCiAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im1vZGFsLWNvbnRlbnQiPicgKwogICAgICAgICAgICAgICAgICAgKHRpdGxlID8KICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJtb2RhbC1oZWFkZXIiPicgKwogICAgICAgICAgICAgICAgICAgICAnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJjbG9zZSIgYXJpYS1oaWRkZW49InRydWUiIHRhYmluZGV4PSItMSI+JnRpbWVzOzwvYnV0dG9uPicgKwogICAgICAgICAgICAgICAgICAgICAnPGg0IGNsYXNzPSJtb2RhbC10aXRsZSI+JyArIHRpdGxlICsgJzwvaDQ+JyArCiAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyA6ICcnCiAgICAgICAgICAgICAgICAgICApICsKICAgICAgICAgICAgICAgICAgICc8Zm9ybSBjbGFzcz0ibm90ZS1tb2RhbC1mb3JtIj4nICsKICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im1vZGFsLWJvZHkiPicgKyBib2R5ICsgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAoZm9vdGVyID8KICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im1vZGFsLWZvb3RlciI+JyArIGZvb3RlciArICc8L2Rpdj4nIDogJycKICAgICAgICAgICAgICAgICAgICAgKSArCiAgICAgICAgICAgICAgICAgICAnPC9mb3JtPicgKwogICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgJzwvZGl2Pic7CiAgICB9OwoKICAgIHZhciB0cGxCdXR0b25JbmZvID0gewogICAgICBwaWN0dXJlOiBmdW5jdGlvbiAobGFuZykgewogICAgICAgIHJldHVybiB0cGxJY29uQnV0dG9uKCdmYSBmYS1waWN0dXJlLW8nLCB7CiAgICAgICAgICBldmVudDogJ3Nob3dJbWFnZURpYWxvZycsCiAgICAgICAgICB0aXRsZTogbGFuZy5pbWFnZS5pbWFnZSwKICAgICAgICAgIGhpZGU6IHRydWUKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgbGluazogZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICByZXR1cm4gdHBsSWNvbkJ1dHRvbignZmEgZmEtbGluaycsIHsKICAgICAgICAgIGV2ZW50OiAnc2hvd0xpbmtEaWFsb2cnLAogICAgICAgICAgdGl0bGU6IGxhbmcubGluay5saW5rLAogICAgICAgICAgaGlkZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9LAogICAgICB0YWJsZTogZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICB2YXIgZHJvcGRvd24gPSAnPHVsIGNsYXNzPSJub3RlLXRhYmxlIGRyb3Bkb3duLW1lbnUiPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtZGltZW5zaW9uLXBpY2tlciI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLWRpbWVuc2lvbi1waWNrZXItbW91c2VjYXRjaGVyIiBkYXRhLWV2ZW50PSJpbnNlcnRUYWJsZSIgZGF0YS12YWx1ZT0iMXgxIj48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtZGltZW5zaW9uLXBpY2tlci1oaWdobGlnaHRlZCI+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLWRpbWVuc2lvbi1waWNrZXItdW5oaWdobGlnaHRlZCI+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1kaW1lbnNpb24tZGlzcGxheSI+IDEgeCAxIDwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICc8L3VsPic7CiAgICAgICAgcmV0dXJuIHRwbEljb25CdXR0b24oJ2ZhIGZhLXRhYmxlJywgewogICAgICAgICAgdGl0bGU6IGxhbmcudGFibGUudGFibGUsCiAgICAgICAgICBkcm9wZG93bjogZHJvcGRvd24KICAgICAgICB9KTsKICAgICAgfSwKICAgICAgc3R5bGU6IGZ1bmN0aW9uIChsYW5nLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gb3B0aW9ucy5zdHlsZVRhZ3MucmVkdWNlKGZ1bmN0aW9uIChtZW1vLCB2KSB7CiAgICAgICAgICB2YXIgbGFiZWwgPSBsYW5nLnN0eWxlW3YgPT09ICdwJyA\/ICdub3JtYWwnIDogdl07CiAgICAgICAgICByZXR1cm4gbWVtbyArICc8bGk+PGEgZGF0YS1ldmVudD0iZm9ybWF0QmxvY2siIGhyZWY9IiMiIGRhdGEtdmFsdWU9IicgKyB2ICsgJyI+JyArCiAgICAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgICh2ID09PSAncCcgfHwgdiA9PT0gJ3ByZScpID8gbGFiZWwgOgogICAgICAgICAgICAgICAgICAgICAnPCcgKyB2ICsgJz4nICsgbGFiZWwgKyAnPC8nICsgdiArICc+JwogICAgICAgICAgICAgICAgICAgKSArCiAgICAgICAgICAgICAgICAgJzwvYT48L2xpPic7CiAgICAgICAgfSwgJycpOwoKICAgICAgICByZXR1cm4gdHBsSWNvbkJ1dHRvbignZmEgZmEtbWFnaWMnLCB7CiAgICAgICAgICB0aXRsZTogbGFuZy5zdHlsZS5zdHlsZSwKICAgICAgICAgIGRyb3Bkb3duOiAnPHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij4nICsgaXRlbXMgKyAnPC91bD4nCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGZvbnRuYW1lOiBmdW5jdGlvbiAobGFuZywgb3B0aW9ucykgewogICAgICAgIHZhciBpdGVtcyA9IG9wdGlvbnMuZm9udE5hbWVzLnJlZHVjZShmdW5jdGlvbiAobWVtbywgdikgewogICAgICAgICAgaWYgKCFhZ2VudC5pc0ZvbnRJbnN0YWxsZWQodikpIHsgcmV0dXJuIG1lbW87IH0KICAgICAgICAgIHJldHVybiBtZW1vICsgJzxsaT48YSBkYXRhLWV2ZW50PSJmb250TmFtZSIgaHJlZj0iIyIgZGF0YS12YWx1ZT0iJyArIHYgKyAnIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAnPGkgY2xhc3M9ImZhIGZhLWNoZWNrIj48L2k+ICcgKyB2ICsKICAgICAgICAgICAgICAgICAgICAgICAgJzwvYT48L2xpPic7CiAgICAgICAgfSwgJycpOwogICAgICAgIHZhciBsYWJlbCA9ICc8c3BhbiBjbGFzcz0ibm90ZS1jdXJyZW50LWZvbnRuYW1lIj4nICsKICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmRlZmF1bHRGb250TmFtZSArCiAgICAgICAgICAgICAgICAgICAgICc8L3NwYW4+JzsKICAgICAgICByZXR1cm4gdHBsQnV0dG9uKGxhYmVsLCB7CiAgICAgICAgICB0aXRsZTogbGFuZy5mb250Lm5hbWUsCiAgICAgICAgICBkcm9wZG93bjogJzx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+JyArIGl0ZW1zICsgJzwvdWw+JwogICAgICAgIH0pOwogICAgICB9LAogICAgICBjb2xvcjogZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICB2YXIgY29sb3JCdXR0b25MYWJlbCA9ICc8aSBjbGFzcz0iZmEgZmEtZm9udCIgc3R5bGU9ImNvbG9yOmJsYWNrO2JhY2tncm91bmQtY29sb3I6eWVsbG93OyI+PC9pPic7CiAgICAgICAgdmFyIGNvbG9yQnV0dG9uID0gdHBsQnV0dG9uKGNvbG9yQnV0dG9uTGFiZWwsIHsKICAgICAgICAgIGNsYXNzTmFtZTogJ25vdGUtcmVjZW50LWNvbG9yJywKICAgICAgICAgIHRpdGxlOiBsYW5nLmNvbG9yLnJlY2VudCwKICAgICAgICAgIGV2ZW50OiAnY29sb3InLAogICAgICAgICAgdmFsdWU6ICd7ImJhY2tDb2xvciI6InllbGxvdyJ9JwogICAgICAgIH0pOwoKICAgICAgICB2YXIgZHJvcGRvd24gPSAnPHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICc8bGk+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLXBhbGV0dGUtdGl0bGUiPicgKyBsYW5nLmNvbG9yLmJhY2tncm91bmQgKyAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtY29sb3ItcmVzZXQiIGRhdGEtZXZlbnQ9ImJhY2tDb2xvciInICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgZGF0YS12YWx1ZT0iaW5oZXJpdCIgdGl0bGU9IicgKyBsYW5nLmNvbG9yLnRyYW5zcGFyZW50ICsgJyI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYW5nLmNvbG9yLnNldFRyYW5zcGFyZW50ICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtY29sb3ItcGFsZXR0ZSIgZGF0YS10YXJnZXQtZXZlbnQ9ImJhY2tDb2xvciI+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtcGFsZXR0ZS10aXRsZSI+JyArIGxhbmcuY29sb3IuZm9yZWdyb3VuZCArICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1jb2xvci1yZXNldCIgZGF0YS1ldmVudD0iZm9yZUNvbG9yIiBkYXRhLXZhbHVlPSJpbmhlcml0IiB0aXRsZT0iJyArIGxhbmcuY29sb3IucmVzZXQgKyAnIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhbmcuY29sb3IucmVzZXRUb0RlZmF1bHQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1jb2xvci1wYWxldHRlIiBkYXRhLXRhcmdldC1ldmVudD0iZm9yZUNvbG9yIj48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgICAgICAgJzwvbGk+JyArCiAgICAgICAgICAgICAgICAgICAgICAgJzwvdWw+JzsKCiAgICAgICAgdmFyIG1vcmVCdXR0b24gPSB0cGxCdXR0b24oJycsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmNvbG9yLm1vcmUsCiAgICAgICAgICBkcm9wZG93bjogZHJvcGRvd24KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIGNvbG9yQnV0dG9uICsgbW9yZUJ1dHRvbjsKICAgICAgfSwKICAgICAgYm9sZDogZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICByZXR1cm4gdHBsSWNvbkJ1dHRvbignZmEgZmEtYm9sZCcsIHsKICAgICAgICAgIGV2ZW50OiAnYm9sZCcsCiAgICAgICAgICB0aXRsZTogbGFuZy5mb250LmJvbGQKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgaXRhbGljOiBmdW5jdGlvbiAobGFuZykgewogICAgICAgIHJldHVybiB0cGxJY29uQnV0dG9uKCdmYSBmYS1pdGFsaWMnLCB7CiAgICAgICAgICBldmVudDogJ2l0YWxpYycsCiAgICAgICAgICB0aXRsZTogbGFuZy5mb250Lml0YWxpYwogICAgICAgIH0pOwogICAgICB9LAogICAgICB1bmRlcmxpbmU6IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgICAgcmV0dXJuIHRwbEljb25CdXR0b24oJ2ZhIGZhLXVuZGVybGluZScsIHsKICAgICAgICAgIGV2ZW50OiAndW5kZXJsaW5lJywKICAgICAgICAgIHRpdGxlOiBsYW5nLmZvbnQudW5kZXJsaW5lCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbiAobGFuZykgewogICAgICAgIHJldHVybiB0cGxJY29uQnV0dG9uKCdmYSBmYS1lcmFzZXInLCB7CiAgICAgICAgICBldmVudDogJ3JlbW92ZUZvcm1hdCcsCiAgICAgICAgICB0aXRsZTogbGFuZy5mb250LmNsZWFyCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHVsOiBmdW5jdGlvbiAobGFuZykgewogICAgICAgIHJldHVybiB0cGxJY29uQnV0dG9uKCdmYSBmYS1saXN0LXVsJywgewogICAgICAgICAgZXZlbnQ6ICdpbnNlcnRVbm9yZGVyZWRMaXN0JywKICAgICAgICAgIHRpdGxlOiBsYW5nLmxpc3RzLnVub3JkZXJlZAogICAgICAgIH0pOwogICAgICB9LAogICAgICBvbDogZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgICByZXR1cm4gdHBsSWNvbkJ1dHRvbignZmEgZmEtbGlzdC1vbCcsIHsKICAgICAgICAgIGV2ZW50OiAnaW5zZXJ0T3JkZXJlZExpc3QnLAogICAgICAgICAgdGl0bGU6IGxhbmcubGlzdHMub3JkZXJlZAogICAgICAgIH0pOwogICAgICB9LAogICAgICBwYXJhZ3JhcGg6IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgICAgdmFyIGxlZnRCdXR0b24gPSB0cGxJY29uQnV0dG9uKCdmYSBmYS1hbGlnbi1sZWZ0JywgewogICAgICAgICAgdGl0bGU6IGxhbmcucGFyYWdyYXBoLmxlZnQsCiAgICAgICAgICBldmVudDogJ2p1c3RpZnlMZWZ0JwogICAgICAgIH0pOwogICAgICAgIHZhciBjZW50ZXJCdXR0b24gPSB0cGxJY29uQnV0dG9uKCdmYSBmYS1hbGlnbi1jZW50ZXInLCB7CiAgICAgICAgICB0aXRsZTogbGFuZy5wYXJhZ3JhcGguY2VudGVyLAogICAgICAgICAgZXZlbnQ6ICdqdXN0aWZ5Q2VudGVyJwogICAgICAgIH0pOwogICAgICAgIHZhciByaWdodEJ1dHRvbiA9IHRwbEljb25CdXR0b24oJ2ZhIGZhLWFsaWduLXJpZ2h0JywgewogICAgICAgICAgdGl0bGU6IGxhbmcucGFyYWdyYXBoLnJpZ2h0LAogICAgICAgICAgZXZlbnQ6ICdqdXN0aWZ5UmlnaHQnCiAgICAgICAgfSk7CiAgICAgICAgdmFyIGp1c3RpZnlCdXR0b24gPSB0cGxJY29uQnV0dG9uKCdmYSBmYS1hbGlnbi1qdXN0aWZ5JywgewogICAgICAgICAgdGl0bGU6IGxhbmcucGFyYWdyYXBoLmp1c3RpZnksCiAgICAgICAgICBldmVudDogJ2p1c3RpZnlGdWxsJwogICAgICAgIH0pOwoKICAgICAgICB2YXIgb3V0ZGVudEJ1dHRvbiA9IHRwbEljb25CdXR0b24oJ2ZhIGZhLW91dGRlbnQnLCB7CiAgICAgICAgICB0aXRsZTogbGFuZy5wYXJhZ3JhcGgub3V0ZGVudCwKICAgICAgICAgIGV2ZW50OiAnb3V0ZGVudCcKICAgICAgICB9KTsKICAgICAgICB2YXIgaW5kZW50QnV0dG9uID0gdHBsSWNvbkJ1dHRvbignZmEgZmEtaW5kZW50JywgewogICAgICAgICAgdGl0bGU6IGxhbmcucGFyYWdyYXBoLmluZGVudCwKICAgICAgICAgIGV2ZW50OiAnaW5kZW50JwogICAgICAgIH0pOwoKICAgICAgICB2YXIgZHJvcGRvd24gPSAnPGRpdiBjbGFzcz0iZHJvcGRvd24tbWVudSI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1hbGlnbiBidG4tZ3JvdXAiPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0QnV0dG9uICsgY2VudGVyQnV0dG9uICsgcmlnaHRCdXR0b24gKyBqdXN0aWZ5QnV0dG9uICsKICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLWxpc3QgYnRuLWdyb3VwIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZW50QnV0dG9uICsgb3V0ZGVudEJ1dHRvbiArCiAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2Pic7CgogICAgICAgIHJldHVybiB0cGxJY29uQnV0dG9uKCdmYSBmYS1hbGlnbi1sZWZ0JywgewogICAgICAgICAgdGl0bGU6IGxhbmcucGFyYWdyYXBoLnBhcmFncmFwaCwKICAgICAgICAgIGRyb3Bkb3duOiBkcm9wZG93bgogICAgICAgIH0pOwogICAgICB9LAogICAgICBoZWlnaHQ6IGZ1bmN0aW9uIChsYW5nLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gb3B0aW9ucy5saW5lSGVpZ2h0cy5yZWR1Y2UoZnVuY3Rpb24gKG1lbW8sIHYpIHsKICAgICAgICAgIHJldHVybiBtZW1vICsgJzxsaT48YSBkYXRhLWV2ZW50PSJsaW5lSGVpZ2h0IiBocmVmPSIjIiBkYXRhLXZhbHVlPSInICsgcGFyc2VGbG9hdCh2KSArICciPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz0iZmEgZmEtY2hlY2siPjwvaT4gJyArIHYgKwogICAgICAgICAgICAgICAgICAgICAgICAnPC9hPjwvbGk+JzsKICAgICAgICB9LCAnJyk7CgogICAgICAgIHJldHVybiB0cGxJY29uQnV0dG9uKCdmYSBmYS10ZXh0LWhlaWdodCcsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmZvbnQuaGVpZ2h0LAogICAgICAgICAgZHJvcGRvd246ICc8dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPicgKyBpdGVtcyArICc8L3VsPicKICAgICAgICB9KTsKCiAgICAgIH0sCiAgICAgIGhlbHA6IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgICAgcmV0dXJuIHRwbEljb25CdXR0b24oJ2ZhIGZhLXF1ZXN0aW9uJywgewogICAgICAgICAgZXZlbnQ6ICdzaG93SGVscERpYWxvZycsCiAgICAgICAgICB0aXRsZTogbGFuZy5vcHRpb25zLmhlbHAsCiAgICAgICAgICBoaWRlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGZ1bGxzY3JlZW46IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgICAgcmV0dXJuIHRwbEljb25CdXR0b24oJ2ZhIGZhLWFycm93cy1hbHQnLCB7CiAgICAgICAgICBldmVudDogJ2Z1bGxzY3JlZW4nLAogICAgICAgICAgdGl0bGU6IGxhbmcub3B0aW9ucy5mdWxsc2NyZWVuCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGNvZGV2aWV3OiBmdW5jdGlvbiAobGFuZykgewogICAgICAgIHJldHVybiB0cGxJY29uQnV0dG9uKCdmYSBmYS1jb2RlJywgewogICAgICAgICAgZXZlbnQ6ICdjb2RldmlldycsCiAgICAgICAgICB0aXRsZTogbGFuZy5vcHRpb25zLmNvZGV2aWV3CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHVuZG86IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgICAgcmV0dXJuIHRwbEljb25CdXR0b24oJ2ZhIGZhLXVuZG8nLCB7CiAgICAgICAgICBldmVudDogJ3VuZG8nLAogICAgICAgICAgdGl0bGU6IGxhbmcuaGlzdG9yeS51bmRvCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHJlZG86IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgICAgcmV0dXJuIHRwbEljb25CdXR0b24oJ2ZhIGZhLXJlcGVhdCcsIHsKICAgICAgICAgIGV2ZW50OiAncmVkbycsCiAgICAgICAgICB0aXRsZTogbGFuZy5oaXN0b3J5LnJlZG8KICAgICAgICB9KTsKICAgICAgfSwKICAgICAgaHI6IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgICAgcmV0dXJuIHRwbEljb25CdXR0b24oJ2ZhIGZhLW1pbnVzJywgewogICAgICAgICAgZXZlbnQ6ICdpbnNlcnRIb3Jpem9udGFsUnVsZScsCiAgICAgICAgICB0aXRsZTogbGFuZy5oci5pbnNlcnQKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgdHBsUG9wb3ZlcnMgPSBmdW5jdGlvbiAobGFuZywgb3B0aW9ucykgewogICAgICB2YXIgdHBsTGlua1BvcG92ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGxpbmtCdXR0b24gPSB0cGxJY29uQnV0dG9uKCdmYSBmYS1lZGl0JywgewogICAgICAgICAgdGl0bGU6IGxhbmcubGluay5lZGl0LAogICAgICAgICAgZXZlbnQ6ICdzaG93TGlua0RpYWxvZycsCiAgICAgICAgICBoaWRlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgdmFyIHVubGlua0J1dHRvbiA9IHRwbEljb25CdXR0b24oJ2ZhIGZhLXVubGluaycsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmxpbmsudW5saW5rLAogICAgICAgICAgZXZlbnQ6ICd1bmxpbmsnCiAgICAgICAgfSk7CiAgICAgICAgdmFyIGNvbnRlbnQgPSAnPGEgaHJlZj0iaHR0cDovL3d3dy5nb29nbGUuY29tIiB0YXJnZXQ9Il9ibGFuayI+d3d3Lmdvb2dsZS5jb208L2E+Jm5ic3A7Jm5ic3A7JyArCiAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1pbnNlcnQgYnRuLWdyb3VwIj4nICsKICAgICAgICAgICAgICAgICAgICAgICAgbGlua0J1dHRvbiArIHVubGlua0J1dHRvbiArCiAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JzsKICAgICAgICByZXR1cm4gdHBsUG9wb3Zlcignbm90ZS1saW5rLXBvcG92ZXInLCBjb250ZW50KTsKICAgICAgfTsKCiAgICAgIHZhciB0cGxJbWFnZVBvcG92ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGZ1bGxCdXR0b24gPSB0cGxCdXR0b24oJzxzcGFuIGNsYXNzPSJub3RlLWZvbnRzaXplLTEwIj4xMDAlPC9zcGFuPicsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmltYWdlLnJlc2l6ZUZ1bGwsCiAgICAgICAgICBldmVudDogJ3Jlc2l6ZScsCiAgICAgICAgICB2YWx1ZTogJzEnCiAgICAgICAgfSk7CiAgICAgICAgdmFyIGhhbGZCdXR0b24gPSB0cGxCdXR0b24oJzxzcGFuIGNsYXNzPSJub3RlLWZvbnRzaXplLTEwIj41MCU8L3NwYW4+JywgewogICAgICAgICAgdGl0bGU6IGxhbmcuaW1hZ2UucmVzaXplSGFsZiwKICAgICAgICAgIGV2ZW50OiAncmVzaXplJywKICAgICAgICAgIHZhbHVlOiAnMC41JwogICAgICAgIH0pOwogICAgICAgIHZhciBxdWFydGVyQnV0dG9uID0gdHBsQnV0dG9uKCc8c3BhbiBjbGFzcz0ibm90ZS1mb250c2l6ZS0xMCI+MjUlPC9zcGFuPicsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmltYWdlLnJlc2l6ZVF1YXJ0ZXIsCiAgICAgICAgICBldmVudDogJ3Jlc2l6ZScsCiAgICAgICAgICB2YWx1ZTogJzAuMjUnCiAgICAgICAgfSk7CgogICAgICAgIHZhciBsZWZ0QnV0dG9uID0gdHBsSWNvbkJ1dHRvbignZmEgZmEtYWxpZ24tbGVmdCcsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmltYWdlLmZsb2F0TGVmdCwKICAgICAgICAgIGV2ZW50OiAnZmxvYXRNZScsCiAgICAgICAgICB2YWx1ZTogJ2xlZnQnCiAgICAgICAgfSk7CiAgICAgICAgdmFyIHJpZ2h0QnV0dG9uID0gdHBsSWNvbkJ1dHRvbignZmEgZmEtYWxpZ24tcmlnaHQnLCB7CiAgICAgICAgICB0aXRsZTogbGFuZy5pbWFnZS5mbG9hdFJpZ2h0LAogICAgICAgICAgZXZlbnQ6ICdmbG9hdE1lJywKICAgICAgICAgIHZhbHVlOiAncmlnaHQnCiAgICAgICAgfSk7CiAgICAgICAgdmFyIGp1c3RpZnlCdXR0b24gPSB0cGxJY29uQnV0dG9uKCdmYSBmYS1hbGlnbi1qdXN0aWZ5JywgewogICAgICAgICAgdGl0bGU6IGxhbmcuaW1hZ2UuZmxvYXROb25lLAogICAgICAgICAgZXZlbnQ6ICdmbG9hdE1lJywKICAgICAgICAgIHZhbHVlOiAnbm9uZScKICAgICAgICB9KTsKCiAgICAgICAgdmFyIHJvdW5kZWRCdXR0b24gPSB0cGxJY29uQnV0dG9uKCdmYSBmYS1zcXVhcmUnLCB7CiAgICAgICAgICB0aXRsZTogbGFuZy5pbWFnZS5zaGFwZVJvdW5kZWQsCiAgICAgICAgICBldmVudDogJ2ltYWdlU2hhcGUnLAogICAgICAgICAgdmFsdWU6ICdpbWctcm91bmRlZCcKICAgICAgICB9KTsKICAgICAgICB2YXIgY2lyY2xlQnV0dG9uID0gdHBsSWNvbkJ1dHRvbignZmEgZmEtY2lyY2xlLW8nLCB7CiAgICAgICAgICB0aXRsZTogbGFuZy5pbWFnZS5zaGFwZUNpcmNsZSwKICAgICAgICAgIGV2ZW50OiAnaW1hZ2VTaGFwZScsCiAgICAgICAgICB2YWx1ZTogJ2ltZy1jaXJjbGUnCiAgICAgICAgfSk7CiAgICAgICAgdmFyIHRodW1ibmFpbEJ1dHRvbiA9IHRwbEljb25CdXR0b24oJ2ZhIGZhLXBpY3R1cmUtbycsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmltYWdlLnNoYXBlVGh1bWJuYWlsLAogICAgICAgICAgZXZlbnQ6ICdpbWFnZVNoYXBlJywKICAgICAgICAgIHZhbHVlOiAnaW1nLXRodW1ibmFpbCcKICAgICAgICB9KTsKICAgICAgICB2YXIgbm9uZUJ1dHRvbiA9IHRwbEljb25CdXR0b24oJ2ZhIGZhLXRpbWVzJywgewogICAgICAgICAgdGl0bGU6IGxhbmcuaW1hZ2Uuc2hhcGVOb25lLAogICAgICAgICAgZXZlbnQ6ICdpbWFnZVNoYXBlJywKICAgICAgICAgIHZhbHVlOiAnJwogICAgICAgIH0pOwoKICAgICAgICB2YXIgcmVtb3ZlQnV0dG9uID0gdHBsSWNvbkJ1dHRvbignZmEgZmEtdHJhc2gtbycsIHsKICAgICAgICAgIHRpdGxlOiBsYW5nLmltYWdlLnJlbW92ZSwKICAgICAgICAgIGV2ZW50OiAncmVtb3ZlTWVkaWEnLAogICAgICAgICAgdmFsdWU6ICdub25lJwogICAgICAgIH0pOwoKICAgICAgICB2YXIgY29udGVudCA9ICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPicgKyBmdWxsQnV0dG9uICsgaGFsZkJ1dHRvbiArIHF1YXJ0ZXJCdXR0b24gKyAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYnRuLWdyb3VwIj4nICsgbGVmdEJ1dHRvbiArIHJpZ2h0QnV0dG9uICsganVzdGlmeUJ1dHRvbiArICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPicgKyByb3VuZGVkQnV0dG9uICsgY2lyY2xlQnV0dG9uICsgdGh1bWJuYWlsQnV0dG9uICsgbm9uZUJ1dHRvbiArICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPicgKyByZW1vdmVCdXR0b24gKyAnPC9kaXY+JzsKICAgICAgICByZXR1cm4gdHBsUG9wb3Zlcignbm90ZS1pbWFnZS1wb3BvdmVyJywgY29udGVudCk7CiAgICAgIH07CgogICAgICB2YXIgdHBsQWlyUG9wb3ZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY29udGVudCA9ICcnOwogICAgICAgIGZvciAodmFyIGlkeCA9IDAsIGxlbiA9IG9wdGlvbnMuYWlyUG9wb3Zlci5sZW5ndGg7IGlkeCA8IGxlbjsgaWR4ICsrKSB7CiAgICAgICAgICB2YXIgZ3JvdXAgPSBvcHRpb25zLmFpclBvcG92ZXJbaWR4XTsKICAgICAgICAgIGNvbnRlbnQgKz0gJzxkaXYgY2xhc3M9Im5vdGUtJyArIGdyb3VwWzBdICsgJyBidG4tZ3JvdXAiPic7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuR3JvdXAgPSBncm91cFsxXS5sZW5ndGg7IGkgPCBsZW5Hcm91cDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnRlbnQgKz0gdHBsQnV0dG9uSW5mb1tncm91cFsxXVtpXV0obGFuZywgb3B0aW9ucyk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZW50ICs9ICc8L2Rpdj4nOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRwbFBvcG92ZXIoJ25vdGUtYWlyLXBvcG92ZXInLCBjb250ZW50KTsKICAgICAgfTsKCiAgICAgIHJldHVybiAnPGRpdiBjbGFzcz0ibm90ZS1wb3BvdmVyIj4nICsKICAgICAgICAgICAgICAgdHBsTGlua1BvcG92ZXIoKSArCiAgICAgICAgICAgICAgIHRwbEltYWdlUG9wb3ZlcigpICsKICAgICAgICAgICAgICAgKG9wdGlvbnMuYWlyTW9kZSA\/ICB0cGxBaXJQb3BvdmVyKCkgOiAnJykgKwogICAgICAgICAgICAgJzwvZGl2Pic7CiAgICB9OwoKICAgIHZhciB0cGxIYW5kbGVzID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gJzxkaXYgY2xhc3M9Im5vdGUtaGFuZGxlIj4nICsKICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtY29udHJvbC1zZWxlY3Rpb24iPicgKwogICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLWNvbnRyb2wtc2VsZWN0aW9uLWJnIj48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1jb250cm9sLWhvbGRlciBub3RlLWNvbnRyb2wtbnciPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLWNvbnRyb2wtaG9sZGVyIG5vdGUtY29udHJvbC1uZSI+PC9kaXY+JyArCiAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtY29udHJvbC1ob2xkZXIgbm90ZS1jb250cm9sLXN3Ij48L2Rpdj4nICsKICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1jb250cm9sLXNpemluZyBub3RlLWNvbnRyb2wtc2UiPjwvZGl2PicgKwogICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLWNvbnRyb2wtc2VsZWN0aW9uLWluZm8iPjwvZGl2PicgKwogICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAnPC9kaXY+JzsKICAgIH07CgogICAgLyoqCiAgICAgKiBzaG9ydGN1dCB0YWJsZSB0ZW1wbGF0ZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHRpdGxlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gYm9keQogICAgICovCiAgICB2YXIgdHBsU2hvcnRjdXQgPSBmdW5jdGlvbiAodGl0bGUsIGtleXMpIHsKICAgICAgdmFyIGtleUNsYXNzID0gJ25vdGUtc2hvcnRjdXQtY29sIGNvbC14cy02IG5vdGUtc2hvcnRjdXQtJzsKICAgICAgdmFyIGJvZHkgPSBbXTsKCiAgICAgIGZvciAodmFyIGkgaW4ga2V5cykgewogICAgICAgIGJvZHkucHVzaCgKICAgICAgICAgICc8ZGl2IGNsYXNzPSInICsga2V5Q2xhc3MgKyAna2V5Ij4nICsga2V5c1tpXS5rYmQgKyAnPC9kaXY+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iJyArIGtleUNsYXNzICsgJ25hbWUiPicgKyBrZXlzW2ldLnRleHQgKyAnPC9kaXY+JwogICAgICAgICAgKTsKICAgICAgfQoKICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPSJub3RlLXNob3J0Y3V0LXJvdyByb3ciPjxkaXYgY2xhc3M9IicgKyBrZXlDbGFzcyArICd0aXRsZSBjb2wteHMtb2Zmc2V0LTYiPicgKyB0aXRsZSArICc8L2Rpdj48L2Rpdj4nICsKICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLXNob3J0Y3V0LXJvdyByb3ciPicgKyBib2R5LmpvaW4oJzwvZGl2PjxkaXYgY2xhc3M9Im5vdGUtc2hvcnRjdXQtcm93IHJvdyI+JykgKyAnPC9kaXY+JzsKICAgIH07CgogICAgdmFyIHRwbFNob3J0Y3V0VGV4dCA9IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgIHZhciBrZXlzID0gWwogICAgICAgIHsga2JkOiAn4oyYICsgQicsIHRleHQ6IGxhbmcuZm9udC5ib2xkIH0sCiAgICAgICAgeyBrYmQ6ICfijJggKyBJJywgdGV4dDogbGFuZy5mb250Lml0YWxpYyB9LAogICAgICAgIHsga2JkOiAn4oyYICsgVScsIHRleHQ6IGxhbmcuZm9udC51bmRlcmxpbmUgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIFxcJywgdGV4dDogbGFuZy5mb250LmNsZWFyIH0KICAgICAgXTsKCiAgICAgIHJldHVybiB0cGxTaG9ydGN1dChsYW5nLnNob3J0Y3V0LnRleHRGb3JtYXR0aW5nLCBrZXlzKTsKICAgIH07CgogICAgdmFyIHRwbFNob3J0Y3V0QWN0aW9uID0gZnVuY3Rpb24gKGxhbmcpIHsKICAgICAgdmFyIGtleXMgPSBbCiAgICAgICAgeyBrYmQ6ICfijJggKyBaJywgdGV4dDogbGFuZy5oaXN0b3J5LnVuZG8gfSwKICAgICAgICB7IGtiZDogJ+KMmCArIOKHpyArIFonLCB0ZXh0OiBsYW5nLmhpc3RvcnkucmVkbyB9LAogICAgICAgIHsga2JkOiAn4oyYICsgXScsIHRleHQ6IGxhbmcucGFyYWdyYXBoLmluZGVudCB9LAogICAgICAgIHsga2JkOiAn4oyYICsgWycsIHRleHQ6IGxhbmcucGFyYWdyYXBoLm91dGRlbnQgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIEVOVEVSJywgdGV4dDogbGFuZy5oci5pbnNlcnQgfQogICAgICBdOwoKICAgICAgcmV0dXJuIHRwbFNob3J0Y3V0KGxhbmcuc2hvcnRjdXQuYWN0aW9uLCBrZXlzKTsKICAgIH07CgogICAgdmFyIHRwbFNob3J0Y3V0UGFyYSA9IGZ1bmN0aW9uIChsYW5nKSB7CiAgICAgIHZhciBrZXlzID0gWwogICAgICAgIHsga2JkOiAn4oyYICsg4oenICsgTCcsIHRleHQ6IGxhbmcucGFyYWdyYXBoLmxlZnQgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIOKHpyArIEUnLCB0ZXh0OiBsYW5nLnBhcmFncmFwaC5jZW50ZXIgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIOKHpyArIFInLCB0ZXh0OiBsYW5nLnBhcmFncmFwaC5yaWdodCB9LAogICAgICAgIHsga2JkOiAn4oyYICsg4oenICsgSicsIHRleHQ6IGxhbmcucGFyYWdyYXBoLmp1c3RpZnkgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIOKHpyArIE5VTTcnLCB0ZXh0OiBsYW5nLmxpc3RzLm9yZGVyZWQgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIOKHpyArIE5VTTgnLCB0ZXh0OiBsYW5nLmxpc3RzLnVub3JkZXJlZCB9CiAgICAgIF07CgogICAgICByZXR1cm4gdHBsU2hvcnRjdXQobGFuZy5zaG9ydGN1dC5wYXJhZ3JhcGhGb3JtYXR0aW5nLCBrZXlzKTsKICAgIH07CgogICAgdmFyIHRwbFNob3J0Y3V0U3R5bGUgPSBmdW5jdGlvbiAobGFuZykgewogICAgICB2YXIga2V5cyA9IFsKICAgICAgICB7IGtiZDogJ+KMmCArIE5VTTAnLCB0ZXh0OiBsYW5nLnN0eWxlLm5vcm1hbCB9LAogICAgICAgIHsga2JkOiAn4oyYICsgTlVNMScsIHRleHQ6IGxhbmcuc3R5bGUuaDEgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIE5VTTInLCB0ZXh0OiBsYW5nLnN0eWxlLmgyIH0sCiAgICAgICAgeyBrYmQ6ICfijJggKyBOVU0zJywgdGV4dDogbGFuZy5zdHlsZS5oMyB9LAogICAgICAgIHsga2JkOiAn4oyYICsgTlVNNCcsIHRleHQ6IGxhbmcuc3R5bGUuaDQgfSwKICAgICAgICB7IGtiZDogJ+KMmCArIE5VTTUnLCB0ZXh0OiBsYW5nLnN0eWxlLmg1IH0sCiAgICAgICAgeyBrYmQ6ICfijJggKyBOVU02JywgdGV4dDogbGFuZy5zdHlsZS5oNiB9CiAgICAgIF07CgogICAgICByZXR1cm4gdHBsU2hvcnRjdXQobGFuZy5zaG9ydGN1dC5kb2N1bWVudFN0eWxlLCBrZXlzKTsKICAgIH07CgogICAgdmFyIHRwbEV4dHJhU2hvcnRjdXRzID0gZnVuY3Rpb24gKGxhbmcsIG9wdGlvbnMpIHsKICAgICAgdmFyIGV4dHJhS2V5cyA9IG9wdGlvbnMuZXh0cmFLZXlzOwogICAgICB2YXIga2V5cyA9IFtdOwoKICAgICAgZm9yICh2YXIga2V5IGluIGV4dHJhS2V5cykgewogICAgICAgIGlmIChleHRyYUtleXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAga2V5cy5wdXNoKHsga2JkOiBrZXksIHRleHQ6IGV4dHJhS2V5c1trZXldIH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRwbFNob3J0Y3V0KGxhbmcuc2hvcnRjdXQuZXh0cmFLZXlzLCBrZXlzKTsKICAgIH07CgogICAgdmFyIHRwbFNob3J0Y3V0VGFibGUgPSBmdW5jdGlvbiAobGFuZywgb3B0aW9ucykgewogICAgICB2YXIgY29sQ2xhc3MgPSAnY2xhc3M9Im5vdGUtc2hvcnRjdXQgbm90ZS1zaG9ydGN1dC1jb2wgY29sLXNtLTYgY29sLXhzLTEyIic7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IFsKICAgICAgICAnPGRpdiAnICsgY29sQ2xhc3MgKyAnPicgKyB0cGxTaG9ydGN1dEFjdGlvbihsYW5nLCBvcHRpb25zKSArICc8L2Rpdj4nICsKICAgICAgICAnPGRpdiAnICsgY29sQ2xhc3MgKyAnPicgKyB0cGxTaG9ydGN1dFRleHQobGFuZywgb3B0aW9ucykgKyAnPC9kaXY+JywKICAgICAgICAnPGRpdiAnICsgY29sQ2xhc3MgKyAnPicgKyB0cGxTaG9ydGN1dFN0eWxlKGxhbmcsIG9wdGlvbnMpICsgJzwvZGl2PicgKwogICAgICAgICc8ZGl2ICcgKyBjb2xDbGFzcyArICc+JyArIHRwbFNob3J0Y3V0UGFyYShsYW5nLCBvcHRpb25zKSArICc8L2Rpdj4nCiAgICAgIF07CgogICAgICBpZiAob3B0aW9ucy5leHRyYUtleXMpIHsKICAgICAgICB0ZW1wbGF0ZS5wdXNoKCc8ZGl2ICcgKyBjb2xDbGFzcyArICc+JyArIHRwbEV4dHJhU2hvcnRjdXRzKGxhbmcsIG9wdGlvbnMpICsgJzwvZGl2PicpOwogICAgICB9CgogICAgICByZXR1cm4gJzxkaXYgY2xhc3M9Im5vdGUtc2hvcnRjdXQtcm93IHJvdyI+JyArCiAgICAgICAgICAgICAgIHRlbXBsYXRlLmpvaW4oJzwvZGl2PjxkaXYgY2xhc3M9Im5vdGUtc2hvcnRjdXQtcm93IHJvdyI+JykgKwogICAgICAgICAgICAgJzwvZGl2Pic7CiAgICB9OwoKICAgIHZhciByZXBsYWNlTWFjS2V5cyA9IGZ1bmN0aW9uIChzSHRtbCkgewogICAgICByZXR1cm4gc0h0bWwucmVwbGFjZSgv4oyYL2csICdDdHJsJykucmVwbGFjZSgv4oenL2csICdTaGlmdCcpOwogICAgfTsKCiAgICB2YXIgdHBsRGlhbG9nSW5mbyA9IHsKICAgICAgaW1hZ2U6IGZ1bmN0aW9uIChsYW5nLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGltYWdlTGltaXRhdGlvbiA9ICcnOwogICAgICAgIGlmIChvcHRpb25zLm1heGltdW1JbWFnZUZpbGVTaXplKSB7CiAgICAgICAgICB2YXIgdW5pdCA9IE1hdGguZmxvb3IoTWF0aC5sb2cob3B0aW9ucy5tYXhpbXVtSW1hZ2VGaWxlU2l6ZSkgLyBNYXRoLmxvZygxMDI0KSk7CiAgICAgICAgICB2YXIgcmVhZGFibGVTaXplID0gKG9wdGlvbnMubWF4aW11bUltYWdlRmlsZVNpemUgLyBNYXRoLnBvdygxMDI0LCB1bml0KSkudG9GaXhlZCgyKSAqIDEgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgJyArICcgS01HVFAnW3VuaXRdICsgJ0InOwogICAgICAgICAgaW1hZ2VMaW1pdGF0aW9uID0gJzxzbWFsbD4nICsgbGFuZy5pbWFnZS5tYXhpbXVtRmlsZVNpemUgKyAnIDogJyArIHJlYWRhYmxlU2l6ZSArICc8L3NtYWxsPic7CiAgICAgICAgfQoKICAgICAgICB2YXIgYm9keSA9ICc8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIHJvdy1mbHVpZCBub3RlLWdyb3VwLXNlbGVjdC1mcm9tLWZpbGVzIj4nICsKICAgICAgICAgICAgICAgICAgICAgJzxsYWJlbD4nICsgbGFuZy5pbWFnZS5zZWxlY3RGcm9tRmlsZXMgKyAnPC9sYWJlbD4nICsKICAgICAgICAgICAgICAgICAgICAgJzxpbnB1dCBjbGFzcz0ibm90ZS1pbWFnZS1pbnB1dCIgdHlwZT0iZmlsZSIgbmFtZT0iZmlsZXMiIGFjY2VwdD0iaW1hZ2UvKiIgbXVsdGlwbGU9Im11bHRpcGxlIiAvPicgKwogICAgICAgICAgICAgICAgICAgICBpbWFnZUxpbWl0YXRpb24gKwogICAgICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAgcm93LWZsdWlkIj4nICsKICAgICAgICAgICAgICAgICAgICAgJzxsYWJlbD4nICsgbGFuZy5pbWFnZS51cmwgKyAnPC9sYWJlbD4nICsKICAgICAgICAgICAgICAgICAgICAgJzxpbnB1dCBjbGFzcz0ibm90ZS1pbWFnZS11cmwgZm9ybS1jb250cm9sIHNwYW4xMiIgdHlwZT0idGV4dCIgLz4nICsKICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nOwogICAgICAgIHZhciBmb290ZXIgPSAnPGJ1dHRvbiBocmVmPSIjIiBjbGFzcz0iYnRuIGJ0bi1wcmltYXJ5IG5vdGUtaW1hZ2UtYnRuIGRpc2FibGVkIiBkaXNhYmxlZD4nICsgbGFuZy5pbWFnZS5pbnNlcnQgKyAnPC9idXR0b24+JzsKICAgICAgICByZXR1cm4gdHBsRGlhbG9nKCdub3RlLWltYWdlLWRpYWxvZycsIGxhbmcuaW1hZ2UuaW5zZXJ0LCBib2R5LCBmb290ZXIpOwogICAgICB9LAoKICAgICAgbGluazogZnVuY3Rpb24gKGxhbmcsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgYm9keSA9ICc8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIHJvdy1mbHVpZCI+JyArCiAgICAgICAgICAgICAgICAgICAgICc8bGFiZWw+JyArIGxhbmcubGluay50ZXh0VG9EaXNwbGF5ICsgJzwvbGFiZWw+JyArCiAgICAgICAgICAgICAgICAgICAgICc8aW5wdXQgY2xhc3M9Im5vdGUtbGluay10ZXh0IGZvcm0tY29udHJvbCBzcGFuMTIiIHR5cGU9InRleHQiIC8+JyArCiAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZm9ybS1ncm91cCByb3ctZmx1aWQiPicgKwogICAgICAgICAgICAgICAgICAgICAnPGxhYmVsPicgKyBsYW5nLmxpbmsudXJsICsgJzwvbGFiZWw+JyArCiAgICAgICAgICAgICAgICAgICAgICc8aW5wdXQgY2xhc3M9Im5vdGUtbGluay11cmwgZm9ybS1jb250cm9sIHNwYW4xMiIgdHlwZT0idGV4dCIgLz4nICsKICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgICAgICAgICghb3B0aW9ucy5kaXNhYmxlTGlua1RhcmdldCA\/CiAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJjaGVja2JveCI+JyArCiAgICAgICAgICAgICAgICAgICAgICAgJzxsYWJlbD4nICsgJzxpbnB1dCB0eXBlPSJjaGVja2JveCIgY2hlY2tlZD4gJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBsYW5nLmxpbmsub3BlbkluTmV3V2luZG93ICsKICAgICAgICAgICAgICAgICAgICAgICAnPC9sYWJlbD4nICsKICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgOiAnJwogICAgICAgICAgICAgICAgICAgKTsKICAgICAgICB2YXIgZm9vdGVyID0gJzxidXR0b24gaHJlZj0iIyIgY2xhc3M9ImJ0biBidG4tcHJpbWFyeSBub3RlLWxpbmstYnRuIGRpc2FibGVkIiBkaXNhYmxlZD4nICsgbGFuZy5saW5rLmluc2VydCArICc8L2J1dHRvbj4nOwogICAgICAgIHJldHVybiB0cGxEaWFsb2coJ25vdGUtbGluay1kaWFsb2cnLCBsYW5nLmxpbmsuaW5zZXJ0LCBib2R5LCBmb290ZXIpOwogICAgICB9LAoKICAgICAgaGVscDogZnVuY3Rpb24gKGxhbmcsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgYm9keSA9ICc8YSBjbGFzcz0ibW9kYWwtY2xvc2UgcHVsbC1yaWdodCIgYXJpYS1oaWRkZW49InRydWUiIHRhYmluZGV4PSItMSI+JyArIGxhbmcuc2hvcnRjdXQuY2xvc2UgKyAnPC9hPicgKwogICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9InRpdGxlIj4nICsgbGFuZy5zaG9ydGN1dC5zaG9ydGN1dHMgKyAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAgICAoYWdlbnQuaXNNYWMgPyB0cGxTaG9ydGN1dFRhYmxlKGxhbmcsIG9wdGlvbnMpIDogcmVwbGFjZU1hY0tleXModHBsU2hvcnRjdXRUYWJsZShsYW5nLCBvcHRpb25zKSkpICsKICAgICAgICAgICAgICAgICAgICc8cCBjbGFzcz0idGV4dC1jZW50ZXIiPicgKwogICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj0iLy9oYWNrZXJ3aW5zLmdpdGh1Yi5pby9zdW1tZXJub3RlLyIgdGFyZ2V0PSJfYmxhbmsiPlN1bW1lcm5vdGUgMC42LjA8L2E+IMK3ICcgKwogICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj0iLy9naXRodWIuY29tL0hhY2tlcldpbnMvc3VtbWVybm90ZSIgdGFyZ2V0PSJfYmxhbmsiPlByb2plY3Q8L2E+IMK3ICcgKwogICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj0iLy9naXRodWIuY29tL0hhY2tlcldpbnMvc3VtbWVybm90ZS9pc3N1ZXMiIHRhcmdldD0iX2JsYW5rIj5Jc3N1ZXM8L2E+JyArCiAgICAgICAgICAgICAgICAgICAnPC9wPic7CiAgICAgICAgcmV0dXJuIHRwbERpYWxvZygnbm90ZS1oZWxwLWRpYWxvZycsICcnLCBib2R5LCAnJyk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIHRwbERpYWxvZ3MgPSBmdW5jdGlvbiAobGFuZywgb3B0aW9ucykgewogICAgICB2YXIgZGlhbG9ncyA9ICcnOwoKICAgICAgJC5lYWNoKHRwbERpYWxvZ0luZm8sIGZ1bmN0aW9uIChpZHgsIHRwbERpYWxvZykgewogICAgICAgIGRpYWxvZ3MgKz0gdHBsRGlhbG9nKGxhbmcsIG9wdGlvbnMpOwogICAgICB9KTsKCiAgICAgIHJldHVybiAnPGRpdiBjbGFzcz0ibm90ZS1kaWFsb2ciPicgKyBkaWFsb2dzICsgJzwvZGl2Pic7CiAgICB9OwoKICAgIHZhciB0cGxTdGF0dXNiYXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiAnPGRpdiBjbGFzcz0ibm90ZS1yZXNpemViYXIiPicgKwogICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibm90ZS1pY29uLWJhciI+PC9kaXY+JyArCiAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJub3RlLWljb24tYmFyIj48L2Rpdj4nICsKICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9Im5vdGUtaWNvbi1iYXIiPjwvZGl2PicgKwogICAgICAgICAgICAgJzwvZGl2Pic7CiAgICB9OwoKICAgIHZhciByZXByZXNlbnRTaG9ydGN1dCA9IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgaWYgKGFnZW50LmlzTWFjKSB7CiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoJ0NNRCcsICfijJgnKS5yZXBsYWNlKCdTSElGVCcsICfih6cnKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKCdCQUNLU0xBU0gnLCAnXFwnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoJ1NMQVNIJywgJy8nKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoJ0xFRlRCUkFDS0VUJywgJ1snKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoJ1JJR0hUQlJBQ0tFVCcsICddJyk7CiAgICB9OwoKICAgIC8qKgogICAgICogY3JlYXRlVG9vbHRpcAogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkY29udGFpbmVyCiAgICAgKiBAcGFyYW0ge09iamVjdH0ga2V5TWFwCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gW3NQbGFjZW1lbnRdCiAgICAgKi8KICAgIHZhciBjcmVhdGVUb29sdGlwID0gZnVuY3Rpb24gKCRjb250YWluZXIsIGtleU1hcCwgc1BsYWNlbWVudCkgewogICAgICB2YXIgaW52ZXJ0ZWRLZXlNYXAgPSBmdW5jLmludmVydE9iamVjdChrZXlNYXApOwogICAgICB2YXIgJGJ1dHRvbnMgPSAkY29udGFpbmVyLmZpbmQoJ2J1dHRvbicpOwoKICAgICAgJGJ1dHRvbnMuZWFjaChmdW5jdGlvbiAoaSwgZWxCdG4pIHsKICAgICAgICB2YXIgJGJ0biA9ICQoZWxCdG4pOwogICAgICAgIHZhciBzU2hvcnRjdXQgPSBpbnZlcnRlZEtleU1hcFskYnRuLmRhdGEoJ2V2ZW50JyldOwogICAgICAgIGlmIChzU2hvcnRjdXQpIHsKICAgICAgICAgICRidG4uYXR0cigndGl0bGUnLCBmdW5jdGlvbiAoaSwgdikgewogICAgICAgICAgICByZXR1cm4gdiArICcgKCcgKyByZXByZXNlbnRTaG9ydGN1dChzU2hvcnRjdXQpICsgJyknOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAvLyBib290c3RyYXAgdG9vbHRpcCBvbiBidG4tZ3JvdXAgYnVnCiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9pc3N1ZXMvNTY4NwogICAgICB9KS50b29sdGlwKHsKICAgICAgICBjb250YWluZXI6ICdib2R5JywKICAgICAgICB0cmlnZ2VyOiAnaG92ZXInLAogICAgICAgIHBsYWNlbWVudDogc1BsYWNlbWVudCB8fCAndG9wJwogICAgICB9KS5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgJCh0aGlzKS50b29sdGlwKCdoaWRlJyk7CiAgICAgIH0pOwogICAgfTsKCiAgICAvLyBjcmVhdGVQYWxldHRlCiAgICB2YXIgY3JlYXRlUGFsZXR0ZSA9IGZ1bmN0aW9uICgkY29udGFpbmVyLCBvcHRpb25zKSB7CiAgICAgIHZhciBjb2xvckluZm8gPSBvcHRpb25zLmNvbG9yczsKICAgICAgJGNvbnRhaW5lci5maW5kKCcubm90ZS1jb2xvci1wYWxldHRlJykuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyICRwYWxldHRlID0gJCh0aGlzKSwgZXZlbnROYW1lID0gJHBhbGV0dGUuYXR0cignZGF0YS10YXJnZXQtZXZlbnQnKTsKICAgICAgICB2YXIgcGFsZXR0ZUNvbnRlbnRzID0gW107CiAgICAgICAgZm9yICh2YXIgcm93ID0gMCwgbGVuUm93ID0gY29sb3JJbmZvLmxlbmd0aDsgcm93IDwgbGVuUm93OyByb3crKykgewogICAgICAgICAgdmFyIGNvbG9ycyA9IGNvbG9ySW5mb1tyb3ddOwogICAgICAgICAgdmFyIGJ1dHRvbnMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGNvbCA9IDAsIGxlbkNvbCA9IGNvbG9ycy5sZW5ndGg7IGNvbCA8IGxlbkNvbDsgY29sKyspIHsKICAgICAgICAgICAgdmFyIGNvbG9yID0gY29sb3JzW2NvbF07CiAgICAgICAgICAgIGJ1dHRvbnMucHVzaChbJzxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0ibm90ZS1jb2xvci1idG4iIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOicsIGNvbG9yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAnOyIgZGF0YS1ldmVudD0iJywgZXZlbnROYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAnIiBkYXRhLXZhbHVlPSInLCBjb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgJyIgdGl0bGU9IicsIGNvbG9yLAogICAgICAgICAgICAgICAgICAgICAgICAgICAnIiBkYXRhLXRvZ2dsZT0iYnV0dG9uIiB0YWJpbmRleD0iLTEiPjwvYnV0dG9uPiddLmpvaW4oJycpKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhbGV0dGVDb250ZW50cy5wdXNoKCc8ZGl2IGNsYXNzPSJub3RlLWNvbG9yLXJvdyI+JyArIGJ1dHRvbnMuam9pbignJykgKyAnPC9kaXY+Jyk7CiAgICAgICAgfQogICAgICAgICRwYWxldHRlLmh0bWwocGFsZXR0ZUNvbnRlbnRzLmpvaW4oJycpKTsKICAgICAgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogY3JlYXRlIHN1bW1lcm5vdGUgbGF5b3V0IChhaXIgbW9kZSkKICAgICAqCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGhvbGRlcgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgdGhpcy5jcmVhdGVMYXlvdXRCeUFpck1vZGUgPSBmdW5jdGlvbiAoJGhvbGRlciwgb3B0aW9ucykgewogICAgICB2YXIgbGFuZ0luZm8gPSBvcHRpb25zLmxhbmdJbmZvOwogICAgICB2YXIga2V5TWFwID0gb3B0aW9ucy5rZXlNYXBbYWdlbnQuaXNNYWMgPyAnbWFjJyA6ICdwYyddOwogICAgICB2YXIgaWQgPSBmdW5jLnVuaXF1ZUlkKCk7CgogICAgICAkaG9sZGVyLmFkZENsYXNzKCdub3RlLWFpci1lZGl0b3Igbm90ZS1lZGl0YWJsZScpOwogICAgICAkaG9sZGVyLmF0dHIoewogICAgICAgICdpZCc6ICdub3RlLWVkaXRvci0nICsgaWQsCiAgICAgICAgJ2NvbnRlbnRFZGl0YWJsZSc6IHRydWUKICAgICAgfSk7CgogICAgICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHk7CgogICAgICAvLyBjcmVhdGUgUG9wb3ZlcgogICAgICB2YXIgJHBvcG92ZXIgPSAkKHRwbFBvcG92ZXJzKGxhbmdJbmZvLCBvcHRpb25zKSk7CiAgICAgICRwb3BvdmVyLmFkZENsYXNzKCdub3RlLWFpci1sYXlvdXQnKTsKICAgICAgJHBvcG92ZXIuYXR0cignaWQnLCAnbm90ZS1wb3BvdmVyLScgKyBpZCk7CiAgICAgICRwb3BvdmVyLmFwcGVuZFRvKGJvZHkpOwogICAgICBjcmVhdGVUb29sdGlwKCRwb3BvdmVyLCBrZXlNYXApOwogICAgICBjcmVhdGVQYWxldHRlKCRwb3BvdmVyLCBvcHRpb25zKTsKCiAgICAgIC8vIGNyZWF0ZSBIYW5kbGUKICAgICAgdmFyICRoYW5kbGUgPSAkKHRwbEhhbmRsZXMoKSk7CiAgICAgICRoYW5kbGUuYWRkQ2xhc3MoJ25vdGUtYWlyLWxheW91dCcpOwogICAgICAkaGFuZGxlLmF0dHIoJ2lkJywgJ25vdGUtaGFuZGxlLScgKyBpZCk7CiAgICAgICRoYW5kbGUuYXBwZW5kVG8oYm9keSk7CgogICAgICAvLyBjcmVhdGUgRGlhbG9nCiAgICAgIHZhciAkZGlhbG9nID0gJCh0cGxEaWFsb2dzKGxhbmdJbmZvLCBvcHRpb25zKSk7CiAgICAgICRkaWFsb2cuYWRkQ2xhc3MoJ25vdGUtYWlyLWxheW91dCcpOwogICAgICAkZGlhbG9nLmF0dHIoJ2lkJywgJ25vdGUtZGlhbG9nLScgKyBpZCk7CiAgICAgICRkaWFsb2cuZmluZCgnYnV0dG9uLmNsb3NlLCBhLm1vZGFsLWNsb3NlJykuY2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgICQodGhpcykuY2xvc2VzdCgnLm1vZGFsJykubW9kYWwoJ2hpZGUnKTsKICAgICAgfSk7CiAgICAgICRkaWFsb2cuYXBwZW5kVG8oYm9keSk7CiAgICB9OwoKICAgIC8qKgogICAgICogY3JlYXRlIHN1bW1lcm5vdGUgbGF5b3V0IChub3JtYWwgbW9kZSkKICAgICAqCiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJGhvbGRlcgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqLwogICAgdGhpcy5jcmVhdGVMYXlvdXRCeUZyYW1lID0gZnVuY3Rpb24gKCRob2xkZXIsIG9wdGlvbnMpIHsKICAgICAgdmFyIGxhbmdJbmZvID0gb3B0aW9ucy5sYW5nSW5mbzsKCiAgICAgIC8vMDEuIGNyZWF0ZSBFZGl0b3IKICAgICAgdmFyICRlZGl0b3IgPSAkKCc8ZGl2IGNsYXNzPSJub3RlLWVkaXRvciI+PC9kaXY+Jyk7CiAgICAgIGlmIChvcHRpb25zLndpZHRoKSB7CiAgICAgICAgJGVkaXRvci53aWR0aChvcHRpb25zLndpZHRoKTsKICAgICAgfQoKICAgICAgLy8wMi4gc3RhdHVzYmFyIChyZXNpemViYXIpCiAgICAgIGlmIChvcHRpb25zLmhlaWdodCA+IDApIHsKICAgICAgICAkKCc8ZGl2IGNsYXNzPSJub3RlLXN0YXR1c2JhciI+JyArIChvcHRpb25zLmRpc2FibGVSZXNpemVFZGl0b3IgPyAnJyA6IHRwbFN0YXR1c2JhcigpKSArICc8L2Rpdj4nKS5wcmVwZW5kVG8oJGVkaXRvcik7CiAgICAgIH0KCiAgICAgIC8vMDMuIGNyZWF0ZSBFZGl0YWJsZQogICAgICB2YXIgaXNDb250ZW50RWRpdGFibGUgPSAhJGhvbGRlci5pcygnOmRpc2FibGVkJyk7CiAgICAgIHZhciAkZWRpdGFibGUgPSAkKCc8ZGl2IGNsYXNzPSJub3RlLWVkaXRhYmxlIiBjb250ZW50RWRpdGFibGU9IicgKyBpc0NvbnRlbnRFZGl0YWJsZSArICciPjwvZGl2PicpCiAgICAgICAgICAucHJlcGVuZFRvKCRlZGl0b3IpOwogICAgICBpZiAob3B0aW9ucy5oZWlnaHQpIHsKICAgICAgICAkZWRpdGFibGUuaGVpZ2h0KG9wdGlvbnMuaGVpZ2h0KTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5kaXJlY3Rpb24pIHsKICAgICAgICAkZWRpdGFibGUuYXR0cignZGlyJywgb3B0aW9ucy5kaXJlY3Rpb24pOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnBsYWNlaG9sZGVyKSB7CiAgICAgICAgJGVkaXRhYmxlLmF0dHIoJ2RhdGEtcGxhY2Vob2xkZXInLCBvcHRpb25zLnBsYWNlaG9sZGVyKTsKICAgICAgfQoKICAgICAgJGVkaXRhYmxlLmh0bWwoZG9tLmh0bWwoJGhvbGRlcikpOwoKICAgICAgLy8wMzEuIGNyZWF0ZSBjb2RhYmxlCiAgICAgICQoJzx0ZXh0YXJlYSBjbGFzcz0ibm90ZS1jb2RhYmxlIj48L3RleHRhcmVhPicpLnByZXBlbmRUbygkZWRpdG9yKTsKCiAgICAgIC8vMDQuIGNyZWF0ZSBUb29sYmFyCiAgICAgIHZhciB0b29sYmFySFRNTCA9ICcnOwogICAgICBmb3IgKHZhciBpZHggPSAwLCBsZW4gPSBvcHRpb25zLnRvb2xiYXIubGVuZ3RoOyBpZHggPCBsZW47IGlkeCArKykgewogICAgICAgIHZhciBncm91cE5hbWUgPSBvcHRpb25zLnRvb2xiYXJbaWR4XVswXTsKICAgICAgICB2YXIgZ3JvdXBCdXR0b25zID0gb3B0aW9ucy50b29sYmFyW2lkeF1bMV07CgogICAgICAgIHRvb2xiYXJIVE1MICs9ICc8ZGl2IGNsYXNzPSJub3RlLScgKyBncm91cE5hbWUgKyAnIGJ0bi1ncm91cCI+JzsKICAgICAgICBmb3IgKHZhciBpID0gMCwgYnRuTGVuZ3RoID0gZ3JvdXBCdXR0b25zLmxlbmd0aDsgaSA8IGJ0bkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgYnV0dG9uSW5mbyA9IHRwbEJ1dHRvbkluZm9bZ3JvdXBCdXR0b25zW2ldXTsKICAgICAgICAgIC8vIGNvbnRpbnVlIGNyZWF0aW5nIHRvb2xiYXIgZXZlbiBpZiBhIGJ1dHRvbiBkb2Vzbid0IGV4aXN0CiAgICAgICAgICBpZiAoISQuaXNGdW5jdGlvbihidXR0b25JbmZvKSkgeyBjb250aW51ZTsgfQogICAgICAgICAgdG9vbGJhckhUTUwgKz0gYnV0dG9uSW5mbyhsYW5nSW5mbywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRvb2xiYXJIVE1MICs9ICc8L2Rpdj4nOwogICAgICB9CgogICAgICB0b29sYmFySFRNTCA9ICc8ZGl2IGNsYXNzPSJub3RlLXRvb2xiYXIgYnRuLXRvb2xiYXIiPicgKyB0b29sYmFySFRNTCArICc8L2Rpdj4nOwoKICAgICAgdmFyICR0b29sYmFyID0gJCh0b29sYmFySFRNTCkucHJlcGVuZFRvKCRlZGl0b3IpOwogICAgICB2YXIga2V5TWFwID0gb3B0aW9ucy5rZXlNYXBbYWdlbnQuaXNNYWMgPyAnbWFjJyA6ICdwYyddOwogICAgICBjcmVhdGVQYWxldHRlKCR0b29sYmFyLCBvcHRpb25zKTsKICAgICAgY3JlYXRlVG9vbHRpcCgkdG9vbGJhciwga2V5TWFwLCAnYm90dG9tJyk7CgogICAgICAvLzA1LiBjcmVhdGUgUG9wb3ZlcgogICAgICB2YXIgJHBvcG92ZXIgPSAkKHRwbFBvcG92ZXJzKGxhbmdJbmZvLCBvcHRpb25zKSkucHJlcGVuZFRvKCRlZGl0b3IpOwogICAgICBjcmVhdGVQYWxldHRlKCRwb3BvdmVyLCBvcHRpb25zKTsKICAgICAgY3JlYXRlVG9vbHRpcCgkcG9wb3Zlciwga2V5TWFwKTsKCiAgICAgIC8vMDYuIGhhbmRsZShjb250cm9sIHNlbGVjdGlvbiwgLi4uKQogICAgICAkKHRwbEhhbmRsZXMoKSkucHJlcGVuZFRvKCRlZGl0b3IpOwoKICAgICAgLy8wNy4gY3JlYXRlIERpYWxvZwogICAgICB2YXIgJGRpYWxvZyA9ICQodHBsRGlhbG9ncyhsYW5nSW5mbywgb3B0aW9ucykpLnByZXBlbmRUbygkZWRpdG9yKTsKICAgICAgJGRpYWxvZy5maW5kKCdidXR0b24uY2xvc2UsIGEubW9kYWwtY2xvc2UnKS5jbGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgJCh0aGlzKS5jbG9zZXN0KCcubW9kYWwnKS5tb2RhbCgnaGlkZScpOwogICAgICB9KTsKCiAgICAgIC8vMDguIGNyZWF0ZSBEcm9wem9uZQogICAgICAkKCc8ZGl2IGNsYXNzPSJub3RlLWRyb3B6b25lIj48ZGl2IGNsYXNzPSJub3RlLWRyb3B6b25lLW1lc3NhZ2UiPjwvZGl2PjwvZGl2PicpLnByZXBlbmRUbygkZWRpdG9yKTsKCiAgICAgIC8vMDkuIEVkaXRvci9Ib2xkZXIgc3dpdGNoCiAgICAgICRlZGl0b3IuaW5zZXJ0QWZ0ZXIoJGhvbGRlcik7CiAgICAgICRob2xkZXIuaGlkZSgpOwogICAgfTsKCiAgICB0aGlzLm5vdGVFZGl0b3JGcm9tSG9sZGVyID0gZnVuY3Rpb24gKCRob2xkZXIpIHsKICAgICAgaWYgKCRob2xkZXIuaGFzQ2xhc3MoJ25vdGUtYWlyLWVkaXRvcicpKSB7CiAgICAgICAgcmV0dXJuICRob2xkZXI7CiAgICAgIH0gZWxzZSBpZiAoJGhvbGRlci5uZXh0KCkuaGFzQ2xhc3MoJ25vdGUtZWRpdG9yJykpIHsKICAgICAgICByZXR1cm4gJGhvbGRlci5uZXh0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICQoKTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIGNyZWF0ZSBzdW1tZXJub3RlIGxheW91dAogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkaG9sZGVyCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICovCiAgICB0aGlzLmNyZWF0ZUxheW91dCA9IGZ1bmN0aW9uICgkaG9sZGVyLCBvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm5vdGVFZGl0b3JGcm9tSG9sZGVyKCRob2xkZXIpLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMuYWlyTW9kZSkgewogICAgICAgIHRoaXMuY3JlYXRlTGF5b3V0QnlBaXJNb2RlKCRob2xkZXIsIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY3JlYXRlTGF5b3V0QnlGcmFtZSgkaG9sZGVyLCBvcHRpb25zKTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIHJldHVybnMgbGF5b3V0SW5mbyBmcm9tIGhvbGRlcgogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkaG9sZGVyIC0gcGxhY2Vob2xkZXIKICAgICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICAgKi8KICAgIHRoaXMubGF5b3V0SW5mb0Zyb21Ib2xkZXIgPSBmdW5jdGlvbiAoJGhvbGRlcikgewogICAgICB2YXIgJGVkaXRvciA9IHRoaXMubm90ZUVkaXRvckZyb21Ib2xkZXIoJGhvbGRlcik7CiAgICAgIGlmICghJGVkaXRvci5sZW5ndGgpIHsgcmV0dXJuOyB9CgogICAgICB2YXIgbGF5b3V0SW5mbyA9IGRvbS5idWlsZExheW91dEluZm8oJGVkaXRvcik7CiAgICAgIC8vIGNhY2hlIGFsbCBwcm9wZXJ0aWVzLgogICAgICBmb3IgKHZhciBrZXkgaW4gbGF5b3V0SW5mbykgewogICAgICAgIGlmIChsYXlvdXRJbmZvLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgIGxheW91dEluZm9ba2V5XSA9IGxheW91dEluZm9ba2V5XS5jYWxsKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBsYXlvdXRJbmZvOwogICAgfTsKCiAgICAvKioKICAgICAqIHJlbW92ZUxheW91dAogICAgICoKICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkaG9sZGVyIC0gcGxhY2Vob2xkZXIKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBsYXlvdXRJbmZvCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICoKICAgICAqLwogICAgdGhpcy5yZW1vdmVMYXlvdXQgPSBmdW5jdGlvbiAoJGhvbGRlciwgbGF5b3V0SW5mbywgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucy5haXJNb2RlKSB7CiAgICAgICAgJGhvbGRlci5yZW1vdmVDbGFzcygnbm90ZS1haXItZWRpdG9yIG5vdGUtZWRpdGFibGUnKQogICAgICAgICAgICAgICAucmVtb3ZlQXR0cignaWQgY29udGVudEVkaXRhYmxlJyk7CgogICAgICAgIGxheW91dEluZm8ucG9wb3Zlci5yZW1vdmUoKTsKICAgICAgICBsYXlvdXRJbmZvLmhhbmRsZS5yZW1vdmUoKTsKICAgICAgICBsYXlvdXRJbmZvLmRpYWxvZy5yZW1vdmUoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAkaG9sZGVyLmh0bWwobGF5b3V0SW5mby5lZGl0YWJsZS5odG1sKCkpOwoKICAgICAgICBsYXlvdXRJbmZvLmVkaXRvci5yZW1vdmUoKTsKICAgICAgICAkaG9sZGVyLnNob3coKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLmdldFRlbXBsYXRlID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gewogICAgICAgIGJ1dHRvbjogdHBsQnV0dG9uLAogICAgICAgIGljb25CdXR0b246IHRwbEljb25CdXR0b24sCiAgICAgICAgZGlhbG9nOiB0cGxEaWFsb2cKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5hZGRCdXR0b25JbmZvID0gZnVuY3Rpb24gKG5hbWUsIGJ1dHRvbkluZm8pIHsKICAgICAgdHBsQnV0dG9uSW5mb1tuYW1lXSA9IGJ1dHRvbkluZm87CiAgICB9OwoKICAgIHRoaXMuYWRkRGlhbG9nSW5mbyA9IGZ1bmN0aW9uIChuYW1lLCBkaWFsb2dJbmZvKSB7CiAgICAgIHRwbERpYWxvZ0luZm9bbmFtZV0gPSBkaWFsb2dJbmZvOwogICAgfTsKICB9OwoKICAvLyBqUXVlcnkgbmFtZXNwYWNlIGZvciBzdW1tZXJub3RlCiAgJC5zdW1tZXJub3RlID0gJC5zdW1tZXJub3RlIHx8IHt9OwoKICAvLyBleHRlbmRzIGRlZmF1bHQgYHNldHRpbmdzYAogICQuZXh0ZW5kKCQuc3VtbWVybm90ZSwgc2V0dGluZ3MpOwoKICB2YXIgcmVuZGVyZXIgPSBuZXcgUmVuZGVyZXIoKTsKICB2YXIgZXZlbnRIYW5kbGVyID0gbmV3IEV2ZW50SGFuZGxlcigpOwoKICAkLmV4dGVuZCgkLnN1bW1lcm5vdGUsIHsKICAgIHJlbmRlcmVyOiByZW5kZXJlciwKICAgIGV2ZW50SGFuZGxlcjogZXZlbnRIYW5kbGVyLAogICAgY29yZTogewogICAgICBhZ2VudDogYWdlbnQsCiAgICAgIGRvbTogZG9tLAogICAgICByYW5nZTogcmFuZ2UKICAgIH0sCiAgICBwbHVnaW5FdmVudHM6IHt9CiAgfSk7CgogIC8qKgogICAqIGFkZFBsdWdpbgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IHBsdWdpbgogICAqLwogICQuc3VtbWVybm90ZS5hZGRQbHVnaW4gPSBmdW5jdGlvbiAocGx1Z2luKSB7CiAgICBpZiAocGx1Z2luLmJ1dHRvbnMpIHsKICAgICAgJC5lYWNoKHBsdWdpbi5idXR0b25zLCBmdW5jdGlvbiAobmFtZSwgYnV0dG9uKSB7CiAgICAgICAgcmVuZGVyZXIuYWRkQnV0dG9uSW5mbyhuYW1lLCBidXR0b24pOwogICAgICB9KTsKICAgIH0KCiAgICBpZiAocGx1Z2luLmRpYWxvZ3MpIHsKICAgICAgJC5lYWNoKHBsdWdpbi5kaWFsb2dzLCBmdW5jdGlvbiAobmFtZSwgZGlhbG9nKSB7CiAgICAgICAgcmVuZGVyZXIuYWRkRGlhbG9nSW5mbyhuYW1lLCBkaWFsb2cpOwogICAgICB9KTsKICAgIH0KCiAgICBpZiAocGx1Z2luLmV2ZW50cykgewogICAgICAkLmVhY2gocGx1Z2luLmV2ZW50cywgZnVuY3Rpb24gKG5hbWUsIGV2ZW50KSB7CiAgICAgICAgJC5zdW1tZXJub3RlLnBsdWdpbkV2ZW50c1tuYW1lXSA9IGV2ZW50OwogICAgICB9KTsKICAgIH0KCiAgICBpZiAocGx1Z2luLmxhbmdzKSB7CiAgICAgICQuZWFjaChwbHVnaW4ubGFuZ3MsIGZ1bmN0aW9uIChsb2NhbGUsIGxhbmcpIHsKICAgICAgICBpZiAoJC5zdW1tZXJub3RlLmxhbmdbbG9jYWxlXSkgewogICAgICAgICAgJC5leHRlbmQoJC5zdW1tZXJub3RlLmxhbmdbbG9jYWxlXSwgbGFuZyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAocGx1Z2luLm9wdGlvbnMpIHsKICAgICAgJC5leHRlbmQoJC5zdW1tZXJub3RlLm9wdGlvbnMsIHBsdWdpbi5vcHRpb25zKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBleHRlbmQganF1ZXJ5IGZuCiAgICovCiAgJC5mbi5leHRlbmQoewogICAgLyoqCiAgICAgKiBpbml0aWFsaXplIHN1bW1lcm5vdGUKICAgICAqICAtIGNyZWF0ZSBlZGl0b3IgbGF5b3V0IGFuZCBhdHRhY2ggTW91c2UgYW5kIGtleWJvYXJkIGV2ZW50cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucwogICAgICogQHJldHVybnMge3RoaXN9CiAgICAgKi8KICAgIHN1bW1lcm5vdGU6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgIC8vIGV4dGVuZCBkZWZhdWx0IG9wdGlvbnMKICAgICAgb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCAkLnN1bW1lcm5vdGUub3B0aW9ucywgb3B0aW9ucyk7CgogICAgICAvLyBJbmNsdWRlIGxhbmdJbmZvIGluIG9wdGlvbnMgZm9yIGxhdGVyIHVzZSwgZS5nLiBmb3IgaW1hZ2UgZHJhZy1uLWRyb3AKICAgICAgLy8gU2V0dXAgbGFuZ3VhZ2UgaW5mbyB3aXRoIGVuLVVTIGFzIGRlZmF1bHQKICAgICAgb3B0aW9ucy5sYW5nSW5mbyA9ICQuZXh0ZW5kKHRydWUsIHt9LCAkLnN1bW1lcm5vdGUubGFuZ1snZW4tVVMnXSwgJC5zdW1tZXJub3RlLmxhbmdbb3B0aW9ucy5sYW5nXSk7CgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKGlkeCwgaG9sZGVyKSB7CiAgICAgICAgdmFyICRob2xkZXIgPSAkKGhvbGRlcik7CgogICAgICAgIC8vIGNyZWF0ZUxheW91dCB3aXRoIG9wdGlvbnMKICAgICAgICByZW5kZXJlci5jcmVhdGVMYXlvdXQoJGhvbGRlciwgb3B0aW9ucyk7CgogICAgICAgIHZhciBpbmZvID0gcmVuZGVyZXIubGF5b3V0SW5mb0Zyb21Ib2xkZXIoJGhvbGRlcik7CiAgICAgICAgZXZlbnRIYW5kbGVyLmF0dGFjaChpbmZvLCBvcHRpb25zKTsKCiAgICAgICAgLy8gVGV4dGFyZWE6IGF1dG8gZmlsbGluZyB0aGUgY29kZSBiZWZvcmUgZm9ybSBzdWJtaXQuCiAgICAgICAgaWYgKGRvbS5pc1RleHRhcmVhKCRob2xkZXJbMF0pKSB7CiAgICAgICAgICAkaG9sZGVyLmNsb3Nlc3QoJ2Zvcm0nKS5zdWJtaXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY29udGVudHMgPSAkaG9sZGVyLmNvZGUoKTsKICAgICAgICAgICAgJGhvbGRlci52YWwoY29udGVudHMpOwoKICAgICAgICAgICAgLy8gY2FsbGJhY2sgb24gc3VibWl0CiAgICAgICAgICAgIGlmIChvcHRpb25zLm9uc3VibWl0KSB7CiAgICAgICAgICAgICAgb3B0aW9ucy5vbnN1Ym1pdChjb250ZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyBmb2N1cyBvbiBmaXJzdCBlZGl0YWJsZSBlbGVtZW50CiAgICAgIGlmICh0aGlzLmZpcnN0KCkubGVuZ3RoICYmIG9wdGlvbnMuZm9jdXMpIHsKICAgICAgICB2YXIgaW5mbyA9IHJlbmRlcmVyLmxheW91dEluZm9Gcm9tSG9sZGVyKHRoaXMuZmlyc3QoKSk7CiAgICAgICAgaW5mby5lZGl0YWJsZS5mb2N1cygpOwogICAgICB9CgogICAgICAvLyBjYWxsYmFjayBvbiBpbml0CiAgICAgIGlmICh0aGlzLmxlbmd0aCAmJiBvcHRpb25zLm9uaW5pdCkgewogICAgICAgIG9wdGlvbnMub25pbml0KCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIC8vCgogICAgLyoqCiAgICAgKiBnZXQgdGhlIEhUTUwgY29udGVudHMgb2Ygbm90ZSBvciBzZXQgdGhlIEhUTUwgY29udGVudHMgb2Ygbm90ZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gW3NIVE1MXSAtIEhUTUwgY29udGVudHMob3B0aW9uYWwsIHNldCkKICAgICAqIEByZXR1cm5zIHt0aGlzfFN0cmluZ30gLSBjb250ZXh0KHNldCkgb3IgSFRNTCBjb250ZW50cyBvZiBub3RlKGdldCkuCiAgICAgKi8KICAgIGNvZGU6IGZ1bmN0aW9uIChzSFRNTCkgewogICAgICAvLyBnZXQgdGhlIEhUTUwgY29udGVudHMgb2Ygbm90ZQogICAgICBpZiAoc0hUTUwgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciAkaG9sZGVyID0gdGhpcy5maXJzdCgpOwogICAgICAgIGlmICghJGhvbGRlci5sZW5ndGgpIHsgcmV0dXJuOyB9CiAgICAgICAgdmFyIGluZm8gPSByZW5kZXJlci5sYXlvdXRJbmZvRnJvbUhvbGRlcigkaG9sZGVyKTsKICAgICAgICBpZiAoISEoaW5mbyAmJiBpbmZvLmVkaXRhYmxlKSkgewogICAgICAgICAgdmFyIGlzQ29kZXZpZXcgPSBpbmZvLmVkaXRvci5oYXNDbGFzcygnY29kZXZpZXcnKTsKICAgICAgICAgIGlmIChpc0NvZGV2aWV3ICYmIGFnZW50Lmhhc0NvZGVNaXJyb3IpIHsKICAgICAgICAgICAgaW5mby5jb2RhYmxlLmRhdGEoJ2NtRWRpdG9yJykuc2F2ZSgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlzQ29kZXZpZXcgPyBpbmZvLmNvZGFibGUudmFsKCkgOiBpbmZvLmVkaXRhYmxlLmh0bWwoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRvbS5pc1RleHRhcmVhKCRob2xkZXJbMF0pID8gJGhvbGRlci52YWwoKSA6ICRob2xkZXIuaHRtbCgpOwogICAgICB9CgogICAgICAvLyBzZXQgdGhlIEhUTUwgY29udGVudHMgb2Ygbm90ZQogICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKGksIGhvbGRlcikgewogICAgICAgIHZhciBpbmZvID0gcmVuZGVyZXIubGF5b3V0SW5mb0Zyb21Ib2xkZXIoJChob2xkZXIpKTsKICAgICAgICBpZiAoaW5mbyAmJiBpbmZvLmVkaXRhYmxlKSB7IGluZm8uZWRpdGFibGUuaHRtbChzSFRNTCk7IH0KICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgKiBkZXN0cm95IEVkaXRvciBMYXlvdXQgYW5kIGRldGFjaCBLZXkgYW5kIE1vdXNlIEV2ZW50CiAgICAgKgogICAgICogQHJldHVybnMge3RoaXN9CiAgICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uIChpZHgsIGhvbGRlcikgewogICAgICAgIHZhciAkaG9sZGVyID0gJChob2xkZXIpOwoKICAgICAgICB2YXIgaW5mbyA9IHJlbmRlcmVyLmxheW91dEluZm9Gcm9tSG9sZGVyKCRob2xkZXIpOwogICAgICAgIGlmICghaW5mbyB8fCAhaW5mby5lZGl0YWJsZSkgeyByZXR1cm47IH0KCiAgICAgICAgdmFyIG9wdGlvbnMgPSBpbmZvLmVkaXRvci5kYXRhKCdvcHRpb25zJyk7CgogICAgICAgIGV2ZW50SGFuZGxlci5kZXRhY2goaW5mbywgb3B0aW9ucyk7CiAgICAgICAgcmVuZGVyZXIucmVtb3ZlTGF5b3V0KCRob2xkZXIsIGluZm8sIG9wdGlvbnMpOwogICAgICB9KTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwp9KSk7",
    "size": "161499"
}