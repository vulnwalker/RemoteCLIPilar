{
    "namaFile": "pages\/admin\/menu\/assets\/js\/libs\/select2\/select2.js",
    "lastUpdate": "2018-03-22+14:23:54.04",
    "contentFile": "LyoKQ29weXJpZ2h0IDIwMTIgSWdvciBWYXluYmVyZwoKVmVyc2lvbjogMy41LjIgVGltZXN0YW1wOiBTYXQgTm92ICAxIDE0OjQzOjM2IEVEVCAyMDE0CgpUaGlzIHNvZnR3YXJlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiQXBhY2hlIExpY2Vuc2UiKSBvciB0aGUgR05VCkdlbmVyYWwgUHVibGljIExpY2Vuc2UgdmVyc2lvbiAyICh0aGUgIkdQTCBMaWNlbnNlIikuIFlvdSBtYXkgY2hvb3NlIGVpdGhlciBsaWNlbnNlIHRvIGdvdmVybiB5b3VyCnVzZSBvZiB0aGlzIHNvZnR3YXJlIG9ubHkgdXBvbiB0aGUgY29uZGl0aW9uIHRoYXQgeW91IGFjY2VwdCBhbGwgb2YgdGhlIHRlcm1zIG9mIGVpdGhlciB0aGUgQXBhY2hlCkxpY2Vuc2Ugb3IgdGhlIEdQTCBMaWNlbnNlLgoKWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBBcGFjaGUgTGljZW5zZSBhbmQgdGhlIEdQTCBMaWNlbnNlIGF0OgoKICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogICAgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2dwbC0yLjAuaHRtbAoKVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUKQXBhY2hlIExpY2Vuc2Ugb3IgdGhlIEdQTCBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUgpDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIEFwYWNoZSBMaWNlbnNlIGFuZCB0aGUgR1BMIExpY2Vuc2UgZm9yCnRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSBhbmQgdGhlIEdQTCBMaWNlbnNlLgoqLwooZnVuY3Rpb24gKCQpIHsKICAgIGlmKHR5cGVvZiAkLmZuLmVhY2gyID09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgJC5leHRlbmQoJC5mbiwgewogICAgICAgICAgICAvKgogICAgICAgICAgICAqIDQtMTAgdGltZXMgZmFzdGVyIC5lYWNoIHJlcGxhY2VtZW50CiAgICAgICAgICAgICogdXNlIGl0IGNhcmVmdWxseSwgYXMgaXQgb3ZlcnJpZGVzIGpRdWVyeSBjb250ZXh0IG9mIGVsZW1lbnQgb24gZWFjaCBpdGVyYXRpb24KICAgICAgICAgICAgKi8KICAgICAgICAgICAgZWFjaDIgOiBmdW5jdGlvbiAoYykgewogICAgICAgICAgICAgICAgdmFyIGogPSAkKFswXSksIGkgPSAtMSwgbCA9IHRoaXMubGVuZ3RoOwogICAgICAgICAgICAgICAgd2hpbGUgKAogICAgICAgICAgICAgICAgICAgICsraSA8IGwKICAgICAgICAgICAgICAgICAgICAmJiAoai5jb250ZXh0ID0galswXSA9IHRoaXNbaV0pCiAgICAgICAgICAgICAgICAgICAgJiYgYy5jYWxsKGpbMF0sIGksIGopICE9PSBmYWxzZSAvLyJ0aGlzIj1ET00sIGk9aW5kZXgsIGo9alF1ZXJ5IG9iamVjdAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9Cn0pKGpRdWVyeSk7CgooZnVuY3Rpb24gKCQsIHVuZGVmaW5lZCkgewogICAgInVzZSBzdHJpY3QiOwogICAgLypnbG9iYWwgZG9jdW1lbnQsIHdpbmRvdywgalF1ZXJ5LCBjb25zb2xlICovCgogICAgaWYgKHdpbmRvdy5TZWxlY3QyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIEFic3RyYWN0U2VsZWN0MiwgU2luZ2xlU2VsZWN0MiwgTXVsdGlTZWxlY3QyLCBuZXh0VWlkLCBzaXplciwKICAgICAgICBsYXN0TW91c2VQb3NpdGlvbj17eDowLHk6MH0sICRkb2N1bWVudCwgc2Nyb2xsQmFyRGltZW5zaW9ucywKCiAgICBLRVkgPSB7CiAgICAgICAgVEFCOiA5LAogICAgICAgIEVOVEVSOiAxMywKICAgICAgICBFU0M6IDI3LAogICAgICAgIFNQQUNFOiAzMiwKICAgICAgICBMRUZUOiAzNywKICAgICAgICBVUDogMzgsCiAgICAgICAgUklHSFQ6IDM5LAogICAgICAgIERPV046IDQwLAogICAgICAgIFNISUZUOiAxNiwKICAgICAgICBDVFJMOiAxNywKICAgICAgICBBTFQ6IDE4LAogICAgICAgIFBBR0VfVVA6IDMzLAogICAgICAgIFBBR0VfRE9XTjogMzQsCiAgICAgICAgSE9NRTogMzYsCiAgICAgICAgRU5EOiAzNSwKICAgICAgICBCQUNLU1BBQ0U6IDgsCiAgICAgICAgREVMRVRFOiA0NiwKICAgICAgICBpc0Fycm93OiBmdW5jdGlvbiAoaykgewogICAgICAgICAgICBrID0gay53aGljaCA\/IGsud2hpY2ggOiBrOwogICAgICAgICAgICBzd2l0Y2ggKGspIHsKICAgICAgICAgICAgY2FzZSBLRVkuTEVGVDoKICAgICAgICAgICAgY2FzZSBLRVkuUklHSFQ6CiAgICAgICAgICAgIGNhc2UgS0VZLlVQOgogICAgICAgICAgICBjYXNlIEtFWS5ET1dOOgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgaXNDb250cm9sOiBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICB2YXIgayA9IGUud2hpY2g7CiAgICAgICAgICAgIHN3aXRjaCAoaykgewogICAgICAgICAgICBjYXNlIEtFWS5TSElGVDoKICAgICAgICAgICAgY2FzZSBLRVkuQ1RSTDoKICAgICAgICAgICAgY2FzZSBLRVkuQUxUOgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChlLm1ldGFLZXkpIHJldHVybiB0cnVlOwoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgaXNGdW5jdGlvbktleTogZnVuY3Rpb24gKGspIHsKICAgICAgICAgICAgayA9IGsud2hpY2ggPyBrLndoaWNoIDogazsKICAgICAgICAgICAgcmV0dXJuIGsgPj0gMTEyICYmIGsgPD0gMTIzOwogICAgICAgIH0KICAgIH0sCiAgICBNRUFTVVJFX1NDUk9MTEJBUl9URU1QTEFURSA9ICI8ZGl2IGNsYXNzPSdzZWxlY3QyLW1lYXN1cmUtc2Nyb2xsYmFyJz48L2Rpdj4iLAoKICAgIERJQUNSSVRJQ1MgPSB7Ilx1MjRCNiI6IkEiLCJcdUZGMjEiOiJBIiwiXHUwMEMwIjoiQSIsIlx1MDBDMSI6IkEiLCJcdTAwQzIiOiJBIiwiXHUxRUE2IjoiQSIsIlx1MUVBNCI6IkEiLCJcdTFFQUEiOiJBIiwiXHUxRUE4IjoiQSIsIlx1MDBDMyI6IkEiLCJcdTAxMDAiOiJBIiwiXHUwMTAyIjoiQSIsIlx1MUVCMCI6IkEiLCJcdTFFQUUiOiJBIiwiXHUxRUI0IjoiQSIsIlx1MUVCMiI6IkEiLCJcdTAyMjYiOiJBIiwiXHUwMUUwIjoiQSIsIlx1MDBDNCI6IkEiLCJcdTAxREUiOiJBIiwiXHUxRUEyIjoiQSIsIlx1MDBDNSI6IkEiLCJcdTAxRkEiOiJBIiwiXHUwMUNEIjoiQSIsIlx1MDIwMCI6IkEiLCJcdTAyMDIiOiJBIiwiXHUxRUEwIjoiQSIsIlx1MUVBQyI6IkEiLCJcdTFFQjYiOiJBIiwiXHUxRTAwIjoiQSIsIlx1MDEwNCI6IkEiLCJcdTAyM0EiOiJBIiwiXHUyQzZGIjoiQSIsIlx1QTczMiI6IkFBIiwiXHUwMEM2IjoiQUUiLCJcdTAxRkMiOiJBRSIsIlx1MDFFMiI6IkFFIiwiXHVBNzM0IjoiQU8iLCJcdUE3MzYiOiJBVSIsIlx1QTczOCI6IkFWIiwiXHVBNzNBIjoiQVYiLCJcdUE3M0MiOiJBWSIsIlx1MjRCNyI6IkIiLCJcdUZGMjIiOiJCIiwiXHUxRTAyIjoiQiIsIlx1MUUwNCI6IkIiLCJcdTFFMDYiOiJCIiwiXHUwMjQzIjoiQiIsIlx1MDE4MiI6IkIiLCJcdTAxODEiOiJCIiwiXHUyNEI4IjoiQyIsIlx1RkYyMyI6IkMiLCJcdTAxMDYiOiJDIiwiXHUwMTA4IjoiQyIsIlx1MDEwQSI6IkMiLCJcdTAxMEMiOiJDIiwiXHUwMEM3IjoiQyIsIlx1MUUwOCI6IkMiLCJcdTAxODciOiJDIiwiXHUwMjNCIjoiQyIsIlx1QTczRSI6IkMiLCJcdTI0QjkiOiJEIiwiXHVGRjI0IjoiRCIsIlx1MUUwQSI6IkQiLCJcdTAxMEUiOiJEIiwiXHUxRTBDIjoiRCIsIlx1MUUxMCI6IkQiLCJcdTFFMTIiOiJEIiwiXHUxRTBFIjoiRCIsIlx1MDExMCI6IkQiLCJcdTAxOEIiOiJEIiwiXHUwMThBIjoiRCIsIlx1MDE4OSI6IkQiLCJcdUE3NzkiOiJEIiwiXHUwMUYxIjoiRFoiLCJcdTAxQzQiOiJEWiIsIlx1MDFGMiI6IkR6IiwiXHUwMUM1IjoiRHoiLCJcdTI0QkEiOiJFIiwiXHVGRjI1IjoiRSIsIlx1MDBDOCI6IkUiLCJcdTAwQzkiOiJFIiwiXHUwMENBIjoiRSIsIlx1MUVDMCI6IkUiLCJcdTFFQkUiOiJFIiwiXHUxRUM0IjoiRSIsIlx1MUVDMiI6IkUiLCJcdTFFQkMiOiJFIiwiXHUwMTEyIjoiRSIsIlx1MUUxNCI6IkUiLCJcdTFFMTYiOiJFIiwiXHUwMTE0IjoiRSIsIlx1MDExNiI6IkUiLCJcdTAwQ0IiOiJFIiwiXHUxRUJBIjoiRSIsIlx1MDExQSI6IkUiLCJcdTAyMDQiOiJFIiwiXHUwMjA2IjoiRSIsIlx1MUVCOCI6IkUiLCJcdTFFQzYiOiJFIiwiXHUwMjI4IjoiRSIsIlx1MUUxQyI6IkUiLCJcdTAxMTgiOiJFIiwiXHUxRTE4IjoiRSIsIlx1MUUxQSI6IkUiLCJcdTAxOTAiOiJFIiwiXHUwMThFIjoiRSIsIlx1MjRCQiI6IkYiLCJcdUZGMjYiOiJGIiwiXHUxRTFFIjoiRiIsIlx1MDE5MSI6IkYiLCJcdUE3N0IiOiJGIiwiXHUyNEJDIjoiRyIsIlx1RkYyNyI6IkciLCJcdTAxRjQiOiJHIiwiXHUwMTFDIjoiRyIsIlx1MUUyMCI6IkciLCJcdTAxMUUiOiJHIiwiXHUwMTIwIjoiRyIsIlx1MDFFNiI6IkciLCJcdTAxMjIiOiJHIiwiXHUwMUU0IjoiRyIsIlx1MDE5MyI6IkciLCJcdUE3QTAiOiJHIiwiXHVBNzdEIjoiRyIsIlx1QTc3RSI6IkciLCJcdTI0QkQiOiJIIiwiXHVGRjI4IjoiSCIsIlx1MDEyNCI6IkgiLCJcdTFFMjIiOiJIIiwiXHUxRTI2IjoiSCIsIlx1MDIxRSI6IkgiLCJcdTFFMjQiOiJIIiwiXHUxRTI4IjoiSCIsIlx1MUUyQSI6IkgiLCJcdTAxMjYiOiJIIiwiXHUyQzY3IjoiSCIsIlx1MkM3NSI6IkgiLCJcdUE3OEQiOiJIIiwiXHUyNEJFIjoiSSIsIlx1RkYyOSI6IkkiLCJcdTAwQ0MiOiJJIiwiXHUwMENEIjoiSSIsIlx1MDBDRSI6IkkiLCJcdTAxMjgiOiJJIiwiXHUwMTJBIjoiSSIsIlx1MDEyQyI6IkkiLCJcdTAxMzAiOiJJIiwiXHUwMENGIjoiSSIsIlx1MUUyRSI6IkkiLCJcdTFFQzgiOiJJIiwiXHUwMUNGIjoiSSIsIlx1MDIwOCI6IkkiLCJcdTAyMEEiOiJJIiwiXHUxRUNBIjoiSSIsIlx1MDEyRSI6IkkiLCJcdTFFMkMiOiJJIiwiXHUwMTk3IjoiSSIsIlx1MjRCRiI6IkoiLCJcdUZGMkEiOiJKIiwiXHUwMTM0IjoiSiIsIlx1MDI0OCI6IkoiLCJcdTI0QzAiOiJLIiwiXHVGRjJCIjoiSyIsIlx1MUUzMCI6IksiLCJcdTAxRTgiOiJLIiwiXHUxRTMyIjoiSyIsIlx1MDEzNiI6IksiLCJcdTFFMzQiOiJLIiwiXHUwMTk4IjoiSyIsIlx1MkM2OSI6IksiLCJcdUE3NDAiOiJLIiwiXHVBNzQyIjoiSyIsIlx1QTc0NCI6IksiLCJcdUE3QTIiOiJLIiwiXHUyNEMxIjoiTCIsIlx1RkYyQyI6IkwiLCJcdTAxM0YiOiJMIiwiXHUwMTM5IjoiTCIsIlx1MDEzRCI6IkwiLCJcdTFFMzYiOiJMIiwiXHUxRTM4IjoiTCIsIlx1MDEzQiI6IkwiLCJcdTFFM0MiOiJMIiwiXHUxRTNBIjoiTCIsIlx1MDE0MSI6IkwiLCJcdTAyM0QiOiJMIiwiXHUyQzYyIjoiTCIsIlx1MkM2MCI6IkwiLCJcdUE3NDgiOiJMIiwiXHVBNzQ2IjoiTCIsIlx1QTc4MCI6IkwiLCJcdTAxQzciOiJMSiIsIlx1MDFDOCI6IkxqIiwiXHUyNEMyIjoiTSIsIlx1RkYyRCI6Ik0iLCJcdTFFM0UiOiJNIiwiXHUxRTQwIjoiTSIsIlx1MUU0MiI6Ik0iLCJcdTJDNkUiOiJNIiwiXHUwMTlDIjoiTSIsIlx1MjRDMyI6Ik4iLCJcdUZGMkUiOiJOIiwiXHUwMUY4IjoiTiIsIlx1MDE0MyI6Ik4iLCJcdTAwRDEiOiJOIiwiXHUxRTQ0IjoiTiIsIlx1MDE0NyI6Ik4iLCJcdTFFNDYiOiJOIiwiXHUwMTQ1IjoiTiIsIlx1MUU0QSI6Ik4iLCJcdTFFNDgiOiJOIiwiXHUwMjIwIjoiTiIsIlx1MDE5RCI6Ik4iLCJcdUE3OTAiOiJOIiwiXHVBN0E0IjoiTiIsIlx1MDFDQSI6Ik5KIiwiXHUwMUNCIjoiTmoiLCJcdTI0QzQiOiJPIiwiXHVGRjJGIjoiTyIsIlx1MDBEMiI6Ik8iLCJcdTAwRDMiOiJPIiwiXHUwMEQ0IjoiTyIsIlx1MUVEMiI6Ik8iLCJcdTFFRDAiOiJPIiwiXHUxRUQ2IjoiTyIsIlx1MUVENCI6Ik8iLCJcdTAwRDUiOiJPIiwiXHUxRTRDIjoiTyIsIlx1MDIyQyI6Ik8iLCJcdTFFNEUiOiJPIiwiXHUwMTRDIjoiTyIsIlx1MUU1MCI6Ik8iLCJcdTFFNTIiOiJPIiwiXHUwMTRFIjoiTyIsIlx1MDIyRSI6Ik8iLCJcdTAyMzAiOiJPIiwiXHUwMEQ2IjoiTyIsIlx1MDIyQSI6Ik8iLCJcdTFFQ0UiOiJPIiwiXHUwMTUwIjoiTyIsIlx1MDFEMSI6Ik8iLCJcdTAyMEMiOiJPIiwiXHUwMjBFIjoiTyIsIlx1MDFBMCI6Ik8iLCJcdTFFREMiOiJPIiwiXHUxRURBIjoiTyIsIlx1MUVFMCI6Ik8iLCJcdTFFREUiOiJPIiwiXHUxRUUyIjoiTyIsIlx1MUVDQyI6Ik8iLCJcdTFFRDgiOiJPIiwiXHUwMUVBIjoiTyIsIlx1MDFFQyI6Ik8iLCJcdTAwRDgiOiJPIiwiXHUwMUZFIjoiTyIsIlx1MDE4NiI6Ik8iLCJcdTAxOUYiOiJPIiwiXHVBNzRBIjoiTyIsIlx1QTc0QyI6Ik8iLCJcdTAxQTIiOiJPSSIsIlx1QTc0RSI6Ik9PIiwiXHUwMjIyIjoiT1UiLCJcdTI0QzUiOiJQIiwiXHVGRjMwIjoiUCIsIlx1MUU1NCI6IlAiLCJcdTFFNTYiOiJQIiwiXHUwMUE0IjoiUCIsIlx1MkM2MyI6IlAiLCJcdUE3NTAiOiJQIiwiXHVBNzUyIjoiUCIsIlx1QTc1NCI6IlAiLCJcdTI0QzYiOiJRIiwiXHVGRjMxIjoiUSIsIlx1QTc1NiI6IlEiLCJcdUE3NTgiOiJRIiwiXHUwMjRBIjoiUSIsIlx1MjRDNyI6IlIiLCJcdUZGMzIiOiJSIiwiXHUwMTU0IjoiUiIsIlx1MUU1OCI6IlIiLCJcdTAxNTgiOiJSIiwiXHUwMjEwIjoiUiIsIlx1MDIxMiI6IlIiLCJcdTFFNUEiOiJSIiwiXHUxRTVDIjoiUiIsIlx1MDE1NiI6IlIiLCJcdTFFNUUiOiJSIiwiXHUwMjRDIjoiUiIsIlx1MkM2NCI6IlIiLCJcdUE3NUEiOiJSIiwiXHVBN0E2IjoiUiIsIlx1QTc4MiI6IlIiLCJcdTI0QzgiOiJTIiwiXHVGRjMzIjoiUyIsIlx1MUU5RSI6IlMiLCJcdTAxNUEiOiJTIiwiXHUxRTY0IjoiUyIsIlx1MDE1QyI6IlMiLCJcdTFFNjAiOiJTIiwiXHUwMTYwIjoiUyIsIlx1MUU2NiI6IlMiLCJcdTFFNjIiOiJTIiwiXHUxRTY4IjoiUyIsIlx1MDIxOCI6IlMiLCJcdTAxNUUiOiJTIiwiXHUyQzdFIjoiUyIsIlx1QTdBOCI6IlMiLCJcdUE3ODQiOiJTIiwiXHUyNEM5IjoiVCIsIlx1RkYzNCI6IlQiLCJcdTFFNkEiOiJUIiwiXHUwMTY0IjoiVCIsIlx1MUU2QyI6IlQiLCJcdTAyMUEiOiJUIiwiXHUwMTYyIjoiVCIsIlx1MUU3MCI6IlQiLCJcdTFFNkUiOiJUIiwiXHUwMTY2IjoiVCIsIlx1MDFBQyI6IlQiLCJcdTAxQUUiOiJUIiwiXHUwMjNFIjoiVCIsIlx1QTc4NiI6IlQiLCJcdUE3MjgiOiJUWiIsIlx1MjRDQSI6IlUiLCJcdUZGMzUiOiJVIiwiXHUwMEQ5IjoiVSIsIlx1MDBEQSI6IlUiLCJcdTAwREIiOiJVIiwiXHUwMTY4IjoiVSIsIlx1MUU3OCI6IlUiLCJcdTAxNkEiOiJVIiwiXHUxRTdBIjoiVSIsIlx1MDE2QyI6IlUiLCJcdTAwREMiOiJVIiwiXHUwMURCIjoiVSIsIlx1MDFENyI6IlUiLCJcdTAxRDUiOiJVIiwiXHUwMUQ5IjoiVSIsIlx1MUVFNiI6IlUiLCJcdTAxNkUiOiJVIiwiXHUwMTcwIjoiVSIsIlx1MDFEMyI6IlUiLCJcdTAyMTQiOiJVIiwiXHUwMjE2IjoiVSIsIlx1MDFBRiI6IlUiLCJcdTFFRUEiOiJVIiwiXHUxRUU4IjoiVSIsIlx1MUVFRSI6IlUiLCJcdTFFRUMiOiJVIiwiXHUxRUYwIjoiVSIsIlx1MUVFNCI6IlUiLCJcdTFFNzIiOiJVIiwiXHUwMTcyIjoiVSIsIlx1MUU3NiI6IlUiLCJcdTFFNzQiOiJVIiwiXHUwMjQ0IjoiVSIsIlx1MjRDQiI6IlYiLCJcdUZGMzYiOiJWIiwiXHUxRTdDIjoiViIsIlx1MUU3RSI6IlYiLCJcdTAxQjIiOiJWIiwiXHVBNzVFIjoiViIsIlx1MDI0NSI6IlYiLCJcdUE3NjAiOiJWWSIsIlx1MjRDQyI6IlciLCJcdUZGMzciOiJXIiwiXHUxRTgwIjoiVyIsIlx1MUU4MiI6IlciLCJcdTAxNzQiOiJXIiwiXHUxRTg2IjoiVyIsIlx1MUU4NCI6IlciLCJcdTFFODgiOiJXIiwiXHUyQzcyIjoiVyIsIlx1MjRDRCI6IlgiLCJcdUZGMzgiOiJYIiwiXHUxRThBIjoiWCIsIlx1MUU4QyI6IlgiLCJcdTI0Q0UiOiJZIiwiXHVGRjM5IjoiWSIsIlx1MUVGMiI6IlkiLCJcdTAwREQiOiJZIiwiXHUwMTc2IjoiWSIsIlx1MUVGOCI6IlkiLCJcdTAyMzIiOiJZIiwiXHUxRThFIjoiWSIsIlx1MDE3OCI6IlkiLCJcdTFFRjYiOiJZIiwiXHUxRUY0IjoiWSIsIlx1MDFCMyI6IlkiLCJcdTAyNEUiOiJZIiwiXHUxRUZFIjoiWSIsIlx1MjRDRiI6IloiLCJcdUZGM0EiOiJaIiwiXHUwMTc5IjoiWiIsIlx1MUU5MCI6IloiLCJcdTAxN0IiOiJaIiwiXHUwMTdEIjoiWiIsIlx1MUU5MiI6IloiLCJcdTFFOTQiOiJaIiwiXHUwMUI1IjoiWiIsIlx1MDIyNCI6IloiLCJcdTJDN0YiOiJaIiwiXHUyQzZCIjoiWiIsIlx1QTc2MiI6IloiLCJcdTI0RDAiOiJhIiwiXHVGRjQxIjoiYSIsIlx1MUU5QSI6ImEiLCJcdTAwRTAiOiJhIiwiXHUwMEUxIjoiYSIsIlx1MDBFMiI6ImEiLCJcdTFFQTciOiJhIiwiXHUxRUE1IjoiYSIsIlx1MUVBQiI6ImEiLCJcdTFFQTkiOiJhIiwiXHUwMEUzIjoiYSIsIlx1MDEwMSI6ImEiLCJcdTAxMDMiOiJhIiwiXHUxRUIxIjoiYSIsIlx1MUVBRiI6ImEiLCJcdTFFQjUiOiJhIiwiXHUxRUIzIjoiYSIsIlx1MDIyNyI6ImEiLCJcdTAxRTEiOiJhIiwiXHUwMEU0IjoiYSIsIlx1MDFERiI6ImEiLCJcdTFFQTMiOiJhIiwiXHUwMEU1IjoiYSIsIlx1MDFGQiI6ImEiLCJcdTAxQ0UiOiJhIiwiXHUwMjAxIjoiYSIsIlx1MDIwMyI6ImEiLCJcdTFFQTEiOiJhIiwiXHUxRUFEIjoiYSIsIlx1MUVCNyI6ImEiLCJcdTFFMDEiOiJhIiwiXHUwMTA1IjoiYSIsIlx1MkM2NSI6ImEiLCJcdTAyNTAiOiJhIiwiXHVBNzMzIjoiYWEiLCJcdTAwRTYiOiJhZSIsIlx1MDFGRCI6ImFlIiwiXHUwMUUzIjoiYWUiLCJcdUE3MzUiOiJhbyIsIlx1QTczNyI6ImF1IiwiXHVBNzM5IjoiYXYiLCJcdUE3M0IiOiJhdiIsIlx1QTczRCI6ImF5IiwiXHUyNEQxIjoiYiIsIlx1RkY0MiI6ImIiLCJcdTFFMDMiOiJiIiwiXHUxRTA1IjoiYiIsIlx1MUUwNyI6ImIiLCJcdTAxODAiOiJiIiwiXHUwMTgzIjoiYiIsIlx1MDI1MyI6ImIiLCJcdTI0RDIiOiJjIiwiXHVGRjQzIjoiYyIsIlx1MDEwNyI6ImMiLCJcdTAxMDkiOiJjIiwiXHUwMTBCIjoiYyIsIlx1MDEwRCI6ImMiLCJcdTAwRTciOiJjIiwiXHUxRTA5IjoiYyIsIlx1MDE4OCI6ImMiLCJcdTAyM0MiOiJjIiwiXHVBNzNGIjoiYyIsIlx1MjE4NCI6ImMiLCJcdTI0RDMiOiJkIiwiXHVGRjQ0IjoiZCIsIlx1MUUwQiI6ImQiLCJcdTAxMEYiOiJkIiwiXHUxRTBEIjoiZCIsIlx1MUUxMSI6ImQiLCJcdTFFMTMiOiJkIiwiXHUxRTBGIjoiZCIsIlx1MDExMSI6ImQiLCJcdTAxOEMiOiJkIiwiXHUwMjU2IjoiZCIsIlx1MDI1NyI6ImQiLCJcdUE3N0EiOiJkIiwiXHUwMUYzIjoiZHoiLCJcdTAxQzYiOiJkeiIsIlx1MjRENCI6ImUiLCJcdUZGNDUiOiJlIiwiXHUwMEU4IjoiZSIsIlx1MDBFOSI6ImUiLCJcdTAwRUEiOiJlIiwiXHUxRUMxIjoiZSIsIlx1MUVCRiI6ImUiLCJcdTFFQzUiOiJlIiwiXHUxRUMzIjoiZSIsIlx1MUVCRCI6ImUiLCJcdTAxMTMiOiJlIiwiXHUxRTE1IjoiZSIsIlx1MUUxNyI6ImUiLCJcdTAxMTUiOiJlIiwiXHUwMTE3IjoiZSIsIlx1MDBFQiI6ImUiLCJcdTFFQkIiOiJlIiwiXHUwMTFCIjoiZSIsIlx1MDIwNSI6ImUiLCJcdTAyMDciOiJlIiwiXHUxRUI5IjoiZSIsIlx1MUVDNyI6ImUiLCJcdTAyMjkiOiJlIiwiXHUxRTFEIjoiZSIsIlx1MDExOSI6ImUiLCJcdTFFMTkiOiJlIiwiXHUxRTFCIjoiZSIsIlx1MDI0NyI6ImUiLCJcdTAyNUIiOiJlIiwiXHUwMUREIjoiZSIsIlx1MjRENSI6ImYiLCJcdUZGNDYiOiJmIiwiXHUxRTFGIjoiZiIsIlx1MDE5MiI6ImYiLCJcdUE3N0MiOiJmIiwiXHUyNEQ2IjoiZyIsIlx1RkY0NyI6ImciLCJcdTAxRjUiOiJnIiwiXHUwMTFEIjoiZyIsIlx1MUUyMSI6ImciLCJcdTAxMUYiOiJnIiwiXHUwMTIxIjoiZyIsIlx1MDFFNyI6ImciLCJcdTAxMjMiOiJnIiwiXHUwMUU1IjoiZyIsIlx1MDI2MCI6ImciLCJcdUE3QTEiOiJnIiwiXHUxRDc5IjoiZyIsIlx1QTc3RiI6ImciLCJcdTI0RDciOiJoIiwiXHVGRjQ4IjoiaCIsIlx1MDEyNSI6ImgiLCJcdTFFMjMiOiJoIiwiXHUxRTI3IjoiaCIsIlx1MDIxRiI6ImgiLCJcdTFFMjUiOiJoIiwiXHUxRTI5IjoiaCIsIlx1MUUyQiI6ImgiLCJcdTFFOTYiOiJoIiwiXHUwMTI3IjoiaCIsIlx1MkM2OCI6ImgiLCJcdTJDNzYiOiJoIiwiXHUwMjY1IjoiaCIsIlx1MDE5NSI6Imh2IiwiXHUyNEQ4IjoiaSIsIlx1RkY0OSI6ImkiLCJcdTAwRUMiOiJpIiwiXHUwMEVEIjoiaSIsIlx1MDBFRSI6ImkiLCJcdTAxMjkiOiJpIiwiXHUwMTJCIjoiaSIsIlx1MDEyRCI6ImkiLCJcdTAwRUYiOiJpIiwiXHUxRTJGIjoiaSIsIlx1MUVDOSI6ImkiLCJcdTAxRDAiOiJpIiwiXHUwMjA5IjoiaSIsIlx1MDIwQiI6ImkiLCJcdTFFQ0IiOiJpIiwiXHUwMTJGIjoiaSIsIlx1MUUyRCI6ImkiLCJcdTAyNjgiOiJpIiwiXHUwMTMxIjoiaSIsIlx1MjREOSI6ImoiLCJcdUZGNEEiOiJqIiwiXHUwMTM1IjoiaiIsIlx1MDFGMCI6ImoiLCJcdTAyNDkiOiJqIiwiXHUyNERBIjoiayIsIlx1RkY0QiI6ImsiLCJcdTFFMzEiOiJrIiwiXHUwMUU5IjoiayIsIlx1MUUzMyI6ImsiLCJcdTAxMzciOiJrIiwiXHUxRTM1IjoiayIsIlx1MDE5OSI6ImsiLCJcdTJDNkEiOiJrIiwiXHVBNzQxIjoiayIsIlx1QTc0MyI6ImsiLCJcdUE3NDUiOiJrIiwiXHVBN0EzIjoiayIsIlx1MjREQiI6ImwiLCJcdUZGNEMiOiJsIiwiXHUwMTQwIjoibCIsIlx1MDEzQSI6ImwiLCJcdTAxM0UiOiJsIiwiXHUxRTM3IjoibCIsIlx1MUUzOSI6ImwiLCJcdTAxM0MiOiJsIiwiXHUxRTNEIjoibCIsIlx1MUUzQiI6ImwiLCJcdTAxN0YiOiJsIiwiXHUwMTQyIjoibCIsIlx1MDE5QSI6ImwiLCJcdTAyNkIiOiJsIiwiXHUyQzYxIjoibCIsIlx1QTc0OSI6ImwiLCJcdUE3ODEiOiJsIiwiXHVBNzQ3IjoibCIsIlx1MDFDOSI6ImxqIiwiXHUyNERDIjoibSIsIlx1RkY0RCI6Im0iLCJcdTFFM0YiOiJtIiwiXHUxRTQxIjoibSIsIlx1MUU0MyI6Im0iLCJcdTAyNzEiOiJtIiwiXHUwMjZGIjoibSIsIlx1MjRERCI6Im4iLCJcdUZGNEUiOiJuIiwiXHUwMUY5IjoibiIsIlx1MDE0NCI6Im4iLCJcdTAwRjEiOiJuIiwiXHUxRTQ1IjoibiIsIlx1MDE0OCI6Im4iLCJcdTFFNDciOiJuIiwiXHUwMTQ2IjoibiIsIlx1MUU0QiI6Im4iLCJcdTFFNDkiOiJuIiwiXHUwMTlFIjoibiIsIlx1MDI3MiI6Im4iLCJcdTAxNDkiOiJuIiwiXHVBNzkxIjoibiIsIlx1QTdBNSI6Im4iLCJcdTAxQ0MiOiJuaiIsIlx1MjRERSI6Im8iLCJcdUZGNEYiOiJvIiwiXHUwMEYyIjoibyIsIlx1MDBGMyI6Im8iLCJcdTAwRjQiOiJvIiwiXHUxRUQzIjoibyIsIlx1MUVEMSI6Im8iLCJcdTFFRDciOiJvIiwiXHUxRUQ1IjoibyIsIlx1MDBGNSI6Im8iLCJcdTFFNEQiOiJvIiwiXHUwMjJEIjoibyIsIlx1MUU0RiI6Im8iLCJcdTAxNEQiOiJvIiwiXHUxRTUxIjoibyIsIlx1MUU1MyI6Im8iLCJcdTAxNEYiOiJvIiwiXHUwMjJGIjoibyIsIlx1MDIzMSI6Im8iLCJcdTAwRjYiOiJvIiwiXHUwMjJCIjoibyIsIlx1MUVDRiI6Im8iLCJcdTAxNTEiOiJvIiwiXHUwMUQyIjoibyIsIlx1MDIwRCI6Im8iLCJcdTAyMEYiOiJvIiwiXHUwMUExIjoibyIsIlx1MUVERCI6Im8iLCJcdTFFREIiOiJvIiwiXHUxRUUxIjoibyIsIlx1MUVERiI6Im8iLCJcdTFFRTMiOiJvIiwiXHUxRUNEIjoibyIsIlx1MUVEOSI6Im8iLCJcdTAxRUIiOiJvIiwiXHUwMUVEIjoibyIsIlx1MDBGOCI6Im8iLCJcdTAxRkYiOiJvIiwiXHUwMjU0IjoibyIsIlx1QTc0QiI6Im8iLCJcdUE3NEQiOiJvIiwiXHUwMjc1IjoibyIsIlx1MDFBMyI6Im9pIiwiXHUwMjIzIjoib3UiLCJcdUE3NEYiOiJvbyIsIlx1MjRERiI6InAiLCJcdUZGNTAiOiJwIiwiXHUxRTU1IjoicCIsIlx1MUU1NyI6InAiLCJcdTAxQTUiOiJwIiwiXHUxRDdEIjoicCIsIlx1QTc1MSI6InAiLCJcdUE3NTMiOiJwIiwiXHVBNzU1IjoicCIsIlx1MjRFMCI6InEiLCJcdUZGNTEiOiJxIiwiXHUwMjRCIjoicSIsIlx1QTc1NyI6InEiLCJcdUE3NTkiOiJxIiwiXHUyNEUxIjoiciIsIlx1RkY1MiI6InIiLCJcdTAxNTUiOiJyIiwiXHUxRTU5IjoiciIsIlx1MDE1OSI6InIiLCJcdTAyMTEiOiJyIiwiXHUwMjEzIjoiciIsIlx1MUU1QiI6InIiLCJcdTFFNUQiOiJyIiwiXHUwMTU3IjoiciIsIlx1MUU1RiI6InIiLCJcdTAyNEQiOiJyIiwiXHUwMjdEIjoiciIsIlx1QTc1QiI6InIiLCJcdUE3QTciOiJyIiwiXHVBNzgzIjoiciIsIlx1MjRFMiI6InMiLCJcdUZGNTMiOiJzIiwiXHUwMERGIjoicyIsIlx1MDE1QiI6InMiLCJcdTFFNjUiOiJzIiwiXHUwMTVEIjoicyIsIlx1MUU2MSI6InMiLCJcdTAxNjEiOiJzIiwiXHUxRTY3IjoicyIsIlx1MUU2MyI6InMiLCJcdTFFNjkiOiJzIiwiXHUwMjE5IjoicyIsIlx1MDE1RiI6InMiLCJcdTAyM0YiOiJzIiwiXHVBN0E5IjoicyIsIlx1QTc4NSI6InMiLCJcdTFFOUIiOiJzIiwiXHUyNEUzIjoidCIsIlx1RkY1NCI6InQiLCJcdTFFNkIiOiJ0IiwiXHUxRTk3IjoidCIsIlx1MDE2NSI6InQiLCJcdTFFNkQiOiJ0IiwiXHUwMjFCIjoidCIsIlx1MDE2MyI6InQiLCJcdTFFNzEiOiJ0IiwiXHUxRTZGIjoidCIsIlx1MDE2NyI6InQiLCJcdTAxQUQiOiJ0IiwiXHUwMjg4IjoidCIsIlx1MkM2NiI6InQiLCJcdUE3ODciOiJ0IiwiXHVBNzI5IjoidHoiLCJcdTI0RTQiOiJ1IiwiXHVGRjU1IjoidSIsIlx1MDBGOSI6InUiLCJcdTAwRkEiOiJ1IiwiXHUwMEZCIjoidSIsIlx1MDE2OSI6InUiLCJcdTFFNzkiOiJ1IiwiXHUwMTZCIjoidSIsIlx1MUU3QiI6InUiLCJcdTAxNkQiOiJ1IiwiXHUwMEZDIjoidSIsIlx1MDFEQyI6InUiLCJcdTAxRDgiOiJ1IiwiXHUwMUQ2IjoidSIsIlx1MDFEQSI6InUiLCJcdTFFRTciOiJ1IiwiXHUwMTZGIjoidSIsIlx1MDE3MSI6InUiLCJcdTAxRDQiOiJ1IiwiXHUwMjE1IjoidSIsIlx1MDIxNyI6InUiLCJcdTAxQjAiOiJ1IiwiXHUxRUVCIjoidSIsIlx1MUVFOSI6InUiLCJcdTFFRUYiOiJ1IiwiXHUxRUVEIjoidSIsIlx1MUVGMSI6InUiLCJcdTFFRTUiOiJ1IiwiXHUxRTczIjoidSIsIlx1MDE3MyI6InUiLCJcdTFFNzciOiJ1IiwiXHUxRTc1IjoidSIsIlx1MDI4OSI6InUiLCJcdTI0RTUiOiJ2IiwiXHVGRjU2IjoidiIsIlx1MUU3RCI6InYiLCJcdTFFN0YiOiJ2IiwiXHUwMjhCIjoidiIsIlx1QTc1RiI6InYiLCJcdTAyOEMiOiJ2IiwiXHVBNzYxIjoidnkiLCJcdTI0RTYiOiJ3IiwiXHVGRjU3IjoidyIsIlx1MUU4MSI6InciLCJcdTFFODMiOiJ3IiwiXHUwMTc1IjoidyIsIlx1MUU4NyI6InciLCJcdTFFODUiOiJ3IiwiXHUxRTk4IjoidyIsIlx1MUU4OSI6InciLCJcdTJDNzMiOiJ3IiwiXHUyNEU3IjoieCIsIlx1RkY1OCI6IngiLCJcdTFFOEIiOiJ4IiwiXHUxRThEIjoieCIsIlx1MjRFOCI6InkiLCJcdUZGNTkiOiJ5IiwiXHUxRUYzIjoieSIsIlx1MDBGRCI6InkiLCJcdTAxNzciOiJ5IiwiXHUxRUY5IjoieSIsIlx1MDIzMyI6InkiLCJcdTFFOEYiOiJ5IiwiXHUwMEZGIjoieSIsIlx1MUVGNyI6InkiLCJcdTFFOTkiOiJ5IiwiXHUxRUY1IjoieSIsIlx1MDFCNCI6InkiLCJcdTAyNEYiOiJ5IiwiXHUxRUZGIjoieSIsIlx1MjRFOSI6InoiLCJcdUZGNUEiOiJ6IiwiXHUwMTdBIjoieiIsIlx1MUU5MSI6InoiLCJcdTAxN0MiOiJ6IiwiXHUwMTdFIjoieiIsIlx1MUU5MyI6InoiLCJcdTFFOTUiOiJ6IiwiXHUwMUI2IjoieiIsIlx1MDIyNSI6InoiLCJcdTAyNDAiOiJ6IiwiXHUyQzZDIjoieiIsIlx1QTc2MyI6InoiLCJcdTAzODYiOiJcdTAzOTEiLCJcdTAzODgiOiJcdTAzOTUiLCJcdTAzODkiOiJcdTAzOTciLCJcdTAzOEEiOiJcdTAzOTkiLCJcdTAzQUEiOiJcdTAzOTkiLCJcdTAzOEMiOiJcdTAzOUYiLCJcdTAzOEUiOiJcdTAzQTUiLCJcdTAzQUIiOiJcdTAzQTUiLCJcdTAzOEYiOiJcdTAzQTkiLCJcdTAzQUMiOiJcdTAzQjEiLCJcdTAzQUQiOiJcdTAzQjUiLCJcdTAzQUUiOiJcdTAzQjciLCJcdTAzQUYiOiJcdTAzQjkiLCJcdTAzQ0EiOiJcdTAzQjkiLCJcdTAzOTAiOiJcdTAzQjkiLCJcdTAzQ0MiOiJcdTAzQkYiLCJcdTAzQ0QiOiJcdTAzQzUiLCJcdTAzQ0IiOiJcdTAzQzUiLCJcdTAzQjAiOiJcdTAzQzUiLCJcdTAzQzkiOiJcdTAzQzkiLCJcdTAzQzIiOiJcdTAzQzMifTsKCiAgICAkZG9jdW1lbnQgPSAkKGRvY3VtZW50KTsKCiAgICBuZXh0VWlkPShmdW5jdGlvbigpIHsgdmFyIGNvdW50ZXI9MTsgcmV0dXJuIGZ1bmN0aW9uKCkgeyByZXR1cm4gY291bnRlcisrOyB9OyB9KCkpOwoKCiAgICBmdW5jdGlvbiByZWluc2VydEVsZW1lbnQoZWxlbWVudCkgewogICAgICAgIHZhciBwbGFjZWhvbGRlciA9ICQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpKTsKCiAgICAgICAgZWxlbWVudC5iZWZvcmUocGxhY2Vob2xkZXIpOwogICAgICAgIHBsYWNlaG9sZGVyLmJlZm9yZShlbGVtZW50KTsKICAgICAgICBwbGFjZWhvbGRlci5yZW1vdmUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzdHJpcERpYWNyaXRpY3Moc3RyKSB7CiAgICAgICAgLy8gVXNlZCAndW5pIHJhbmdlICsgbmFtZWQgZnVuY3Rpb24nIGZyb20gaHR0cDovL2pzcGVyZi5jb20vZGlhY3JpdGljcy8xOAogICAgICAgIGZ1bmN0aW9uIG1hdGNoKGEpIHsKICAgICAgICAgICAgcmV0dXJuIERJQUNSSVRJQ1NbYV0gfHwgYTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvW15cdTAwMDAtXHUwMDdFXS9nLCBtYXRjaCk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5kZXhPZih2YWx1ZSwgYXJyYXkpIHsKICAgICAgICB2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7CiAgICAgICAgZm9yICg7IGkgPCBsOyBpID0gaSArIDEpIHsKICAgICAgICAgICAgaWYgKGVxdWFsKHZhbHVlLCBhcnJheVtpXSkpIHJldHVybiBpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgZnVuY3Rpb24gbWVhc3VyZVNjcm9sbGJhciAoKSB7CiAgICAgICAgdmFyICR0ZW1wbGF0ZSA9ICQoIE1FQVNVUkVfU0NST0xMQkFSX1RFTVBMQVRFICk7CiAgICAgICAgJHRlbXBsYXRlLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpOwoKICAgICAgICB2YXIgZGltID0gewogICAgICAgICAgICB3aWR0aDogJHRlbXBsYXRlLndpZHRoKCkgLSAkdGVtcGxhdGVbMF0uY2xpZW50V2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogJHRlbXBsYXRlLmhlaWdodCgpIC0gJHRlbXBsYXRlWzBdLmNsaWVudEhlaWdodAogICAgICAgIH07CiAgICAgICAgJHRlbXBsYXRlLnJlbW92ZSgpOwoKICAgICAgICByZXR1cm4gZGltOwogICAgfQoKICAgIC8qKgogICAgICogQ29tcGFyZXMgZXF1YWxpdHkgb2YgYSBhbmQgYgogICAgICogQHBhcmFtIGEKICAgICAqIEBwYXJhbSBiCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVxdWFsKGEsIGIpIHsKICAgICAgICBpZiAoYSA9PT0gYikgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKGEgPT09IHVuZGVmaW5lZCB8fCBiID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAgICAgLy8gQ2hlY2sgd2hldGhlciAnYScgb3IgJ2InIGlzIGEgc3RyaW5nIChwcmltaXRpdmUgb3Igb2JqZWN0KS4KICAgICAgICAvLyBUaGUgY29uY2F0ZW5hdGlvbiBvZiBhbiBlbXB0eSBzdHJpbmcgKCsnJykgY29udmVydHMgaXRzIGFyZ3VtZW50IHRvIGEgc3RyaW5nJ3MgcHJpbWl0aXZlLgogICAgICAgIGlmIChhLmNvbnN0cnVjdG9yID09PSBTdHJpbmcpIHJldHVybiBhKycnID09PSBiKycnOyAvLyBhKycnIC0gaW4gY2FzZSAnYScgaXMgYSBTdHJpbmcgb2JqZWN0CiAgICAgICAgaWYgKGIuY29uc3RydWN0b3IgPT09IFN0cmluZykgcmV0dXJuIGIrJycgPT09IGErJyc7IC8vIGIrJycgLSBpbiBjYXNlICdiJyBpcyBhIFN0cmluZyBvYmplY3QKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBTcGxpdHMgdGhlIHN0cmluZyBpbnRvIGFuIGFycmF5IG9mIHZhbHVlcywgdHJhbnNmb3JtaW5nIGVhY2ggdmFsdWUuIEFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkIGZvciBudWxscyBvciBlbXB0eQogICAgICogc3RyaW5ncwogICAgICogQHBhcmFtIHN0cmluZwogICAgICogQHBhcmFtIHNlcGFyYXRvcgogICAgICovCiAgICBmdW5jdGlvbiBzcGxpdFZhbChzdHJpbmcsIHNlcGFyYXRvciwgdHJhbnNmb3JtKSB7CiAgICAgICAgdmFyIHZhbCwgaSwgbDsKICAgICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHN0cmluZy5sZW5ndGggPCAxKSByZXR1cm4gW107CiAgICAgICAgdmFsID0gc3RyaW5nLnNwbGl0KHNlcGFyYXRvcik7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHZhbC5sZW5ndGg7IGkgPCBsOyBpID0gaSArIDEpIHZhbFtpXSA9IHRyYW5zZm9ybSh2YWxbaV0pOwogICAgICAgIHJldHVybiB2YWw7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0U2lkZUJvcmRlclBhZGRpbmcoZWxlbWVudCkgewogICAgICAgIHJldHVybiBlbGVtZW50Lm91dGVyV2lkdGgoZmFsc2UpIC0gZWxlbWVudC53aWR0aCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGluc3RhbGxLZXlVcENoYW5nZUV2ZW50KGVsZW1lbnQpIHsKICAgICAgICB2YXIga2V5PSJrZXl1cC1jaGFuZ2UtdmFsdWUiOwogICAgICAgIGVsZW1lbnQub24oImtleWRvd24iLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICgkLmRhdGEoZWxlbWVudCwga2V5KSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAkLmRhdGEoZWxlbWVudCwga2V5LCBlbGVtZW50LnZhbCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGVsZW1lbnQub24oImtleXVwIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdmFsPSAkLmRhdGEoZWxlbWVudCwga2V5KTsKICAgICAgICAgICAgaWYgKHZhbCAhPT0gdW5kZWZpbmVkICYmIGVsZW1lbnQudmFsKCkgIT09IHZhbCkgewogICAgICAgICAgICAgICAgJC5yZW1vdmVEYXRhKGVsZW1lbnQsIGtleSk7CiAgICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXIoImtleXVwLWNoYW5nZSIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgoKICAgIC8qKgogICAgICogZmlsdGVycyBtb3VzZSBldmVudHMgc28gYW4gZXZlbnQgaXMgZmlyZWQgb25seSBpZiB0aGUgbW91c2UgbW92ZWQuCiAgICAgKgogICAgICogZmlsdGVycyBvdXQgbW91c2UgZXZlbnRzIHRoYXQgb2NjdXIgd2hlbiBtb3VzZSBpcyBzdGF0aW9uYXJ5IGJ1dAogICAgICogdGhlIGVsZW1lbnRzIHVuZGVyIHRoZSBwb2ludGVyIGFyZSBzY3JvbGxlZC4KICAgICAqLwogICAgZnVuY3Rpb24gaW5zdGFsbEZpbHRlcmVkTW91c2VNb3ZlKGVsZW1lbnQpIHsKICAgICAgICBlbGVtZW50Lm9uKCJtb3VzZW1vdmUiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICB2YXIgbGFzdHBvcyA9IGxhc3RNb3VzZVBvc2l0aW9uOwogICAgICAgICAgICBpZiAobGFzdHBvcyA9PT0gdW5kZWZpbmVkIHx8IGxhc3Rwb3MueCAhPT0gZS5wYWdlWCB8fCBsYXN0cG9zLnkgIT09IGUucGFnZVkpIHsKICAgICAgICAgICAgICAgICQoZS50YXJnZXQpLnRyaWdnZXIoIm1vdXNlbW92ZS1maWx0ZXJlZCIsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBEZWJvdW5jZXMgYSBmdW5jdGlvbi4gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgY2FsbHMgdGhlIG9yaWdpbmFsIGZuIGZ1bmN0aW9uIG9ubHkgaWYgbm8gaW52b2NhdGlvbnMgaGF2ZSBiZWVuIG1hZGUKICAgICAqIHdpdGhpbiB0aGUgbGFzdCBxdWlldE1pbGxpcyBtaWxsaXNlY29uZHMuCiAgICAgKgogICAgICogQHBhcmFtIHF1aWV0TWlsbGlzIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCBiZWZvcmUgaW52b2tpbmcgZm4KICAgICAqIEBwYXJhbSBmbiBmdW5jdGlvbiB0byBiZSBkZWJvdW5jZWQKICAgICAqIEBwYXJhbSBjdHggb2JqZWN0IHRvIGJlIHVzZWQgYXMgdGhpcyByZWZlcmVuY2Ugd2l0aGluIGZuCiAgICAgKiBAcmV0dXJuIGRlYm91bmNlZCB2ZXJzaW9uIG9mIGZuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlYm91bmNlKHF1aWV0TWlsbGlzLCBmbiwgY3R4KSB7CiAgICAgICAgY3R4ID0gY3R4IHx8IHVuZGVmaW5lZDsKICAgICAgICB2YXIgdGltZW91dDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgdGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZm4uYXBwbHkoY3R4LCBhcmdzKTsKICAgICAgICAgICAgfSwgcXVpZXRNaWxsaXMpOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gaW5zdGFsbERlYm91bmNlZFNjcm9sbCh0aHJlc2hvbGQsIGVsZW1lbnQpIHsKICAgICAgICB2YXIgbm90aWZ5ID0gZGVib3VuY2UodGhyZXNob2xkLCBmdW5jdGlvbiAoZSkgeyBlbGVtZW50LnRyaWdnZXIoInNjcm9sbC1kZWJvdW5jZWQiLCBlKTt9KTsKICAgICAgICBlbGVtZW50Lm9uKCJzY3JvbGwiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICBpZiAoaW5kZXhPZihlLnRhcmdldCwgZWxlbWVudC5nZXQoKSkgPj0gMCkgbm90aWZ5KGUpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGZvY3VzKCRlbCkgewogICAgICAgIGlmICgkZWxbMF0gPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHJldHVybjsKCiAgICAgICAgLyogc2V0IHRoZSBmb2N1cyBpbiBhIDAgdGltZW91dCAtIHRoYXQgd2F5IHRoZSBmb2N1cyBpcyBzZXQgYWZ0ZXIgdGhlIHByb2Nlc3NpbmcKICAgICAgICAgICAgb2YgdGhlIGN1cnJlbnQgZXZlbnQgaGFzIGZpbmlzaGVkIC0gd2hpY2ggc2VlbXMgbGlrZSB0aGUgb25seSByZWxpYWJsZSB3YXkKICAgICAgICAgICAgdG8gc2V0IGZvY3VzICovCiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBlbD0kZWxbMF0sIHBvcz0kZWwudmFsKCkubGVuZ3RoLCByYW5nZTsKCiAgICAgICAgICAgICRlbC5mb2N1cygpOwoKICAgICAgICAgICAgLyogbWFrZSBzdXJlIGVsIHJlY2VpdmVkIGZvY3VzIHNvIHdlIGRvIG5vdCBlcnJvciBvdXQgd2hlbiB0cnlpbmcgdG8gbWFuaXB1bGF0ZSB0aGUgY2FyZXQuCiAgICAgICAgICAgICAgICBzb21ldGltZXMgbW9kYWxzIG9yIG90aGVycyBsaXN0ZW5lcnMgbWF5IHN0ZWFsIGl0IGFmdGVyIGl0cyBzZXQgKi8KICAgICAgICAgICAgdmFyIGlzVmlzaWJsZSA9IChlbC5vZmZzZXRXaWR0aCA+IDAgfHwgZWwub2Zmc2V0SGVpZ2h0ID4gMCk7CiAgICAgICAgICAgIGlmIChpc1Zpc2libGUgJiYgZWwgPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCiAgICAgICAgICAgICAgICAvKiBhZnRlciB0aGUgZm9jdXMgaXMgc2V0IG1vdmUgdGhlIGNhcmV0IHRvIHRoZSBlbmQsIG5lY2Vzc2FyeSB3aGVuIHdlIHZhbCgpCiAgICAgICAgICAgICAgICAgICAganVzdCBiZWZvcmUgc2V0dGluZyBmb2N1cyAqLwogICAgICAgICAgICAgICAgaWYoZWwuc2V0U2VsZWN0aW9uUmFuZ2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZWwuc2V0U2VsZWN0aW9uUmFuZ2UocG9zLCBwb3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoZWwuY3JlYXRlVGV4dFJhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBlbC5jcmVhdGVUZXh0UmFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICByYW5nZS5jb2xsYXBzZShmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2VsZWN0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LCAwKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDdXJzb3JJbmZvKGVsKSB7CiAgICAgICAgZWwgPSAkKGVsKVswXTsKICAgICAgICB2YXIgb2Zmc2V0ID0gMDsKICAgICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgICBpZiAoJ3NlbGVjdGlvblN0YXJ0JyBpbiBlbCkgewogICAgICAgICAgICBvZmZzZXQgPSBlbC5zZWxlY3Rpb25TdGFydDsKICAgICAgICAgICAgbGVuZ3RoID0gZWwuc2VsZWN0aW9uRW5kIC0gb2Zmc2V0OwogICAgICAgIH0gZWxzZSBpZiAoJ3NlbGVjdGlvbicgaW4gZG9jdW1lbnQpIHsKICAgICAgICAgICAgZWwuZm9jdXMoKTsKICAgICAgICAgICAgdmFyIHNlbCA9IGRvY3VtZW50LnNlbGVjdGlvbi5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICBsZW5ndGggPSBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKS50ZXh0Lmxlbmd0aDsKICAgICAgICAgICAgc2VsLm1vdmVTdGFydCgnY2hhcmFjdGVyJywgLWVsLnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgIG9mZnNldCA9IHNlbC50ZXh0Lmxlbmd0aCAtIGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsgb2Zmc2V0OiBvZmZzZXQsIGxlbmd0aDogbGVuZ3RoIH07CiAgICB9CgogICAgZnVuY3Rpb24ga2lsbEV2ZW50KGV2ZW50KSB7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0KICAgIGZ1bmN0aW9uIGtpbGxFdmVudEltbWVkaWF0ZWx5KGV2ZW50KSB7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgIH0KCiAgICBmdW5jdGlvbiBtZWFzdXJlVGV4dFdpZHRoKGUpIHsKICAgICAgICBpZiAoIXNpemVyKXsKICAgICAgICAgICAgdmFyIHN0eWxlID0gZVswXS5jdXJyZW50U3R5bGUgfHwgd2luZG93LmdldENvbXB1dGVkU3R5bGUoZVswXSwgbnVsbCk7CiAgICAgICAgICAgIHNpemVyID0gJChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSkuY3NzKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgbGVmdDogIi0xMDAwMHB4IiwKICAgICAgICAgICAgICAgIHRvcDogIi0xMDAwMHB4IiwKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJub25lIiwKICAgICAgICAgICAgICAgIGZvbnRTaXplOiBzdHlsZS5mb250U2l6ZSwKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6IHN0eWxlLmZvbnRGYW1pbHksCiAgICAgICAgICAgICAgICBmb250U3R5bGU6IHN0eWxlLmZvbnRTdHlsZSwKICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IHN0eWxlLmZvbnRXZWlnaHQsCiAgICAgICAgICAgICAgICBsZXR0ZXJTcGFjaW5nOiBzdHlsZS5sZXR0ZXJTcGFjaW5nLAogICAgICAgICAgICAgICAgdGV4dFRyYW5zZm9ybTogc3R5bGUudGV4dFRyYW5zZm9ybSwKICAgICAgICAgICAgICAgIHdoaXRlU3BhY2U6ICJub3dyYXAiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzaXplci5hdHRyKCJjbGFzcyIsInNlbGVjdDItc2l6ZXIiKTsKICAgICAgICAgICAgJChkb2N1bWVudC5ib2R5KS5hcHBlbmQoc2l6ZXIpOwogICAgICAgIH0KICAgICAgICBzaXplci50ZXh0KGUudmFsKCkpOwogICAgICAgIHJldHVybiBzaXplci53aWR0aCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN5bmNDc3NDbGFzc2VzKGRlc3QsIHNyYywgYWRhcHRlcikgewogICAgICAgIHZhciBjbGFzc2VzLCByZXBsYWNlbWVudHMgPSBbXSwgYWRhcHRlZDsKCiAgICAgICAgY2xhc3NlcyA9ICQudHJpbShkZXN0LmF0dHIoImNsYXNzIikpOwoKICAgICAgICBpZiAoY2xhc3NlcykgewogICAgICAgICAgICBjbGFzc2VzID0gJycgKyBjbGFzc2VzOyAvLyBmb3IgSUUgd2hpY2ggcmV0dXJucyBvYmplY3QKCiAgICAgICAgICAgICQoY2xhc3Nlcy5zcGxpdCgvXHMrLykpLmVhY2gyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5kZXhPZigic2VsZWN0Mi0iKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50cy5wdXNoKHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGNsYXNzZXMgPSAkLnRyaW0oc3JjLmF0dHIoImNsYXNzIikpOwoKICAgICAgICBpZiAoY2xhc3NlcykgewogICAgICAgICAgICBjbGFzc2VzID0gJycgKyBjbGFzc2VzOyAvLyBmb3IgSUUgd2hpY2ggcmV0dXJucyBvYmplY3QKCiAgICAgICAgICAgICQoY2xhc3Nlcy5zcGxpdCgvXHMrLykpLmVhY2gyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5kZXhPZigic2VsZWN0Mi0iKSAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGFkYXB0ZWQgPSBhZGFwdGVyKHRoaXMpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoYWRhcHRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlbWVudHMucHVzaChhZGFwdGVkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZGVzdC5hdHRyKCJjbGFzcyIsIHJlcGxhY2VtZW50cy5qb2luKCIgIikpOwogICAgfQoKCiAgICBmdW5jdGlvbiBtYXJrTWF0Y2godGV4dCwgdGVybSwgbWFya3VwLCBlc2NhcGVNYXJrdXApIHsKICAgICAgICB2YXIgbWF0Y2g9c3RyaXBEaWFjcml0aWNzKHRleHQudG9VcHBlckNhc2UoKSkuaW5kZXhPZihzdHJpcERpYWNyaXRpY3ModGVybS50b1VwcGVyQ2FzZSgpKSksCiAgICAgICAgICAgIHRsPXRlcm0ubGVuZ3RoOwoKICAgICAgICBpZiAobWF0Y2g8MCkgewogICAgICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dCkpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dC5zdWJzdHJpbmcoMCwgbWF0Y2gpKSk7CiAgICAgICAgbWFya3VwLnB1c2goIjxzcGFuIGNsYXNzPSdzZWxlY3QyLW1hdGNoJz4iKTsKICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dC5zdWJzdHJpbmcobWF0Y2gsIG1hdGNoICsgdGwpKSk7CiAgICAgICAgbWFya3VwLnB1c2goIjwvc3Bhbj4iKTsKICAgICAgICBtYXJrdXAucHVzaChlc2NhcGVNYXJrdXAodGV4dC5zdWJzdHJpbmcobWF0Y2ggKyB0bCwgdGV4dC5sZW5ndGgpKSk7CiAgICB9CgogICAgZnVuY3Rpb24gZGVmYXVsdEVzY2FwZU1hcmt1cChtYXJrdXApIHsKICAgICAgICB2YXIgcmVwbGFjZV9tYXAgPSB7CiAgICAgICAgICAgICdcXCc6ICcmIzkyOycsCiAgICAgICAgICAgICcmJzogJyZhbXA7JywKICAgICAgICAgICAgJzwnOiAnJmx0OycsCiAgICAgICAgICAgICc+JzogJyZndDsnLAogICAgICAgICAgICAnIic6ICcmcXVvdDsnLAogICAgICAgICAgICAiJyI6ICcmIzM5OycsCiAgICAgICAgICAgICIvIjogJyYjNDc7JwogICAgICAgIH07CgogICAgICAgIHJldHVybiBTdHJpbmcobWFya3VwKS5yZXBsYWNlKC9bJjw+IidcL1xcXS9nLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIHJlcGxhY2VfbWFwW21hdGNoXTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFByb2R1Y2VzIGFuIGFqYXgtYmFzZWQgcXVlcnkgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucyBvYmplY3QgY29udGFpbmluZyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMKICAgICAqIEBwYXJhbSBvcHRpb25zLnBhcmFtcyBwYXJhbWV0ZXIgbWFwIGZvciB0aGUgdHJhbnNwb3J0IGFqYXggY2FsbCwgY2FuIGNvbnRhaW4gc3VjaCBvcHRpb25zIGFzIGNhY2hlLCBqc29ucENhbGxiYWNrLCBldGMuIHNlZSAkLmFqYXgKICAgICAqIEBwYXJhbSBvcHRpb25zLnRyYW5zcG9ydCBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgdXNlZCB0byBleGVjdXRlIHRoZSBhamF4IHJlcXVlc3QuIG11c3QgYmUgY29tcGF0aWJsZSB3aXRoIHBhcmFtZXRlcnMgc3VwcG9ydGVkIGJ5ICQuYWpheAogICAgICogQHBhcmFtIG9wdGlvbnMudXJsIHVybCBmb3IgdGhlIGRhdGEKICAgICAqIEBwYXJhbSBvcHRpb25zLmRhdGEgYSBmdW5jdGlvbihzZWFyY2hUZXJtLCBwYWdlTnVtYmVyLCBjb250ZXh0KSB0aGF0IHNob3VsZCByZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgcXVlcnkgc3RyaW5nIHBhcmFtZXRlcnMgZm9yIHRoZSBhYm92ZSB1cmwuCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5kYXRhVHlwZSByZXF1ZXN0IGRhdGEgdHlwZTogYWpheCwganNvbnAsIG90aGVyIGRhdGF0eXBlcyBzdXBwb3J0ZWQgYnkgalF1ZXJ5J3MgJC5hamF4IGZ1bmN0aW9uIG9yIHRoZSB0cmFuc3BvcnQgZnVuY3Rpb24gaWYgc3BlY2lmaWVkCiAgICAgKiBAcGFyYW0gb3B0aW9ucy5xdWlldE1pbGxpcyAob3B0aW9uYWwpIG1pbGxpc2Vjb25kcyB0byB3YWl0IGJlZm9yZSBtYWtpbmcgdGhlIGFqYXhSZXF1ZXN0LCBoZWxwcyBkZWJvdW5jZSB0aGUgYWpheCBmdW5jdGlvbiBpZiBpbnZva2VkIHRvbyBvZnRlbgogICAgICogQHBhcmFtIG9wdGlvbnMucmVzdWx0cyBhIGZ1bmN0aW9uKHJlbW90ZURhdGEsIHBhZ2VOdW1iZXIsIHF1ZXJ5KSB0aGF0IGNvbnZlcnRzIGRhdGEgcmV0dXJuZWQgZm9ybSB0aGUgcmVtb3RlIHJlcXVlc3QgdG8gdGhlIGZvcm1hdCBleHBlY3RlZCBieSBTZWxlY3QyLgogICAgICogICAgICBUaGUgZXhwZWN0ZWQgZm9ybWF0IGlzIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcga2V5czoKICAgICAqICAgICAgcmVzdWx0cyBhcnJheSBvZiBvYmplY3RzIHRoYXQgd2lsbCBiZSB1c2VkIGFzIGNob2ljZXMKICAgICAqICAgICAgbW9yZSAob3B0aW9uYWwpIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZXJlIGFyZSBtb3JlIHJlc3VsdHMgYXZhaWxhYmxlCiAgICAgKiAgICAgIEV4YW1wbGU6IHtyZXN1bHRzOlt7aWQ6MSwgdGV4dDonUmVkJ30se2lkOjIsIHRleHQ6J0JsdWUnfV0sIG1vcmU6dHJ1ZX0KICAgICAqLwogICAgZnVuY3Rpb24gYWpheChvcHRpb25zKSB7CiAgICAgICAgdmFyIHRpbWVvdXQsIC8vIGN1cnJlbnQgc2NoZWR1bGVkIGJ1dCBub3QgeWV0IGV4ZWN1dGVkIHJlcXVlc3QKICAgICAgICAgICAgaGFuZGxlciA9IG51bGwsCiAgICAgICAgICAgIHF1aWV0TWlsbGlzID0gb3B0aW9ucy5xdWlldE1pbGxpcyB8fCAxMDAsCiAgICAgICAgICAgIGFqYXhVcmwgPSBvcHRpb25zLnVybCwKICAgICAgICAgICAgc2VsZiA9IHRoaXM7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAocXVlcnkpIHsKICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgdGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gb3B0aW9ucy5kYXRhLCAvLyBhamF4IGRhdGEgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICB1cmwgPSBhamF4VXJsLCAvLyBhamF4IHVybCBzdHJpbmcgb3IgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICB0cmFuc3BvcnQgPSBvcHRpb25zLnRyYW5zcG9ydCB8fCAkLmZuLnNlbGVjdDIuYWpheERlZmF1bHRzLnRyYW5zcG9ydCwKICAgICAgICAgICAgICAgICAgICAvLyBkZXByZWNhdGVkIC0gdG8gYmUgcmVtb3ZlZCBpbiA0LjAgIC0gdXNlIHBhcmFtcyBpbnN0ZWFkCiAgICAgICAgICAgICAgICAgICAgZGVwcmVjYXRlZCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogb3B0aW9ucy50eXBlIHx8ICdHRVQnLCAvLyBzZXQgdHlwZSBvZiByZXF1ZXN0IChHRVQgb3IgUE9TVCkKICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGU6IG9wdGlvbnMuY2FjaGUgfHwgZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGpzb25wQ2FsbGJhY2s6IG9wdGlvbnMuanNvbnBDYWxsYmFja3x8dW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogb3B0aW9ucy5kYXRhVHlwZXx8Impzb24iCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSAkLmV4dGVuZCh7fSwgJC5mbi5zZWxlY3QyLmFqYXhEZWZhdWx0cy5wYXJhbXMsIGRlcHJlY2F0ZWQpOwoKICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhID8gZGF0YS5jYWxsKHNlbGYsIHF1ZXJ5LnRlcm0sIHF1ZXJ5LnBhZ2UsIHF1ZXJ5LmNvbnRleHQpIDogbnVsbDsKICAgICAgICAgICAgICAgIHVybCA9ICh0eXBlb2YgdXJsID09PSAnZnVuY3Rpb24nKSA\/IHVybC5jYWxsKHNlbGYsIHF1ZXJ5LnRlcm0sIHF1ZXJ5LnBhZ2UsIHF1ZXJ5LmNvbnRleHQpIDogdXJsOwoKICAgICAgICAgICAgICAgIGlmIChoYW5kbGVyICYmIHR5cGVvZiBoYW5kbGVyLmFib3J0ID09PSAiZnVuY3Rpb24iKSB7IGhhbmRsZXIuYWJvcnQoKTsgfQoKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmICgkLmlzRnVuY3Rpb24ob3B0aW9ucy5wYXJhbXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQuZXh0ZW5kKHBhcmFtcywgb3B0aW9ucy5wYXJhbXMuY2FsbChzZWxmKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJC5leHRlbmQocGFyYW1zLCBvcHRpb25zLnBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICQuZXh0ZW5kKHBhcmFtcywgewogICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiBvcHRpb25zLmRhdGFUeXBlLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyAtIHJlcGxhY2UgcXVlcnkucGFnZSB3aXRoIHF1ZXJ5IHNvIHVzZXJzIGhhdmUgYWNjZXNzIHRvIHRlcm0sIHBhZ2UsIGV0Yy4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkZWQgcXVlcnkgYXMgdGhpcmQgcGFyYW10ZXIgdG8ga2VlcCBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0cyA9IG9wdGlvbnMucmVzdWx0cyhkYXRhLCBxdWVyeS5wYWdlLCBxdWVyeSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5LmNhbGxiYWNrKHJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bil7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHRzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzRXJyb3I6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcVhIUjoganFYSFIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0U3RhdHVzOiB0ZXh0U3RhdHVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JUaHJvd246IGVycm9yVGhyb3duCiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBxdWVyeS5jYWxsYmFjayhyZXN1bHRzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGhhbmRsZXIgPSB0cmFuc3BvcnQuY2FsbChzZWxmLCBwYXJhbXMpOwogICAgICAgICAgICB9LCBxdWlldE1pbGxpcyk7CiAgICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIFByb2R1Y2VzIGEgcXVlcnkgZnVuY3Rpb24gdGhhdCB3b3JrcyB3aXRoIGEgbG9jYWwgYXJyYXkKICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucyBvYmplY3QgY29udGFpbmluZyBjb25maWd1cmF0aW9uIHBhcmFtZXRlcnMuIFRoZSBvcHRpb25zIHBhcmFtZXRlciBjYW4gZWl0aGVyIGJlIGFuIGFycmF5IG9yIGFuCiAgICAgKiBvYmplY3QuCiAgICAgKgogICAgICogSWYgdGhlIGFycmF5IGZvcm0gaXMgdXNlZCBpdCBpcyBhc3N1bWVkIHRoYXQgaXQgY29udGFpbnMgb2JqZWN0cyB3aXRoICdpZCcgYW5kICd0ZXh0JyBrZXlzLgogICAgICoKICAgICAqIElmIHRoZSBvYmplY3QgZm9ybSBpcyB1c2VkIGl0IGlzIGFzc3VtZWQgdGhhdCBpdCBjb250YWlucyAnZGF0YScgYW5kICd0ZXh0JyBrZXlzLiBUaGUgJ2RhdGEnIGtleSBzaG91bGQgY29udGFpbgogICAgICogYW4gYXJyYXkgb2Ygb2JqZWN0cyB0aGF0IHdpbGwgYmUgdXNlZCBhcyBjaG9pY2VzLiBUaGVzZSBvYmplY3RzIG11c3QgY29udGFpbiBhdCBsZWFzdCBhbiAnaWQnIGtleS4gVGhlICd0ZXh0JwogICAgICoga2V5IGNhbiBlaXRoZXIgYmUgYSBTdHJpbmcgaW4gd2hpY2ggY2FzZSBpdCBpcyBleHBlY3RlZCB0aGF0IGVhY2ggZWxlbWVudCBpbiB0aGUgJ2RhdGEnIGFycmF5IGhhcyBhIGtleSB3aXRoIHRoZQogICAgICogdmFsdWUgb2YgJ3RleHQnIHdoaWNoIHdpbGwgYmUgdXNlZCB0byBtYXRjaCBjaG9pY2VzLiBBbHRlcm5hdGl2ZWx5LCB0ZXh0IGNhbiBiZSBhIGZ1bmN0aW9uKGl0ZW0pIHRoYXQgY2FuIGV4dHJhY3QKICAgICAqIHRoZSB0ZXh0LgogICAgICovCiAgICBmdW5jdGlvbiBsb2NhbChvcHRpb25zKSB7CiAgICAgICAgdmFyIGRhdGEgPSBvcHRpb25zLCAvLyBkYXRhIGVsZW1lbnRzCiAgICAgICAgICAgIGRhdGFUZXh0LAogICAgICAgICAgICB0bXAsCiAgICAgICAgICAgIHRleHQgPSBmdW5jdGlvbiAoaXRlbSkgeyByZXR1cm4gIiIraXRlbS50ZXh0OyB9OyAvLyBmdW5jdGlvbiB1c2VkIHRvIHJldHJpZXZlIHRoZSB0ZXh0IHBvcnRpb24gb2YgYSBkYXRhIGl0ZW0gdGhhdCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIHNlYXJjaAoKICAgICAgICAgaWYgKCQuaXNBcnJheShkYXRhKSkgewogICAgICAgICAgICB0bXAgPSBkYXRhOwogICAgICAgICAgICBkYXRhID0geyByZXN1bHRzOiB0bXAgfTsKICAgICAgICB9CgogICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKGRhdGEpID09PSBmYWxzZSkgewogICAgICAgICAgICB0bXAgPSBkYXRhOwogICAgICAgICAgICBkYXRhID0gZnVuY3Rpb24oKSB7IHJldHVybiB0bXA7IH07CiAgICAgICAgfQoKICAgICAgICB2YXIgZGF0YUl0ZW0gPSBkYXRhKCk7CiAgICAgICAgaWYgKGRhdGFJdGVtLnRleHQpIHsKICAgICAgICAgICAgdGV4dCA9IGRhdGFJdGVtLnRleHQ7CiAgICAgICAgICAgIC8vIGlmIHRleHQgaXMgbm90IGEgZnVuY3Rpb24gd2UgYXNzdW1lIGl0IHRvIGJlIGEga2V5IG5hbWUKICAgICAgICAgICAgaWYgKCEkLmlzRnVuY3Rpb24odGV4dCkpIHsKICAgICAgICAgICAgICAgIGRhdGFUZXh0ID0gZGF0YUl0ZW0udGV4dDsgLy8gd2UgbmVlZCB0byBzdG9yZSB0aGlzIGluIGEgc2VwYXJhdGUgdmFyaWFibGUgYmVjYXVzZSBpbiB0aGUgbmV4dCBzdGVwIGRhdGEgZ2V0cyByZXNldCBhbmQgZGF0YS50ZXh0IGlzIG5vIGxvbmdlciBhdmFpbGFibGUKICAgICAgICAgICAgICAgIHRleHQgPSBmdW5jdGlvbiAoaXRlbSkgeyByZXR1cm4gaXRlbVtkYXRhVGV4dF07IH07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAocXVlcnkpIHsKICAgICAgICAgICAgdmFyIHQgPSBxdWVyeS50ZXJtLCBmaWx0ZXJlZCA9IHsgcmVzdWx0czogW10gfSwgcHJvY2VzczsKICAgICAgICAgICAgaWYgKHQgPT09ICIiKSB7CiAgICAgICAgICAgICAgICBxdWVyeS5jYWxsYmFjayhkYXRhKCkpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwcm9jZXNzID0gZnVuY3Rpb24oZGF0dW0sIGNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgIHZhciBncm91cCwgYXR0cjsKICAgICAgICAgICAgICAgIGRhdHVtID0gZGF0dW1bMF07CiAgICAgICAgICAgICAgICBpZiAoZGF0dW0uY2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgICBncm91cCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGZvciAoYXR0ciBpbiBkYXR1bSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0dW0uaGFzT3duUHJvcGVydHkoYXR0cikpIGdyb3VwW2F0dHJdPWRhdHVtW2F0dHJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBncm91cC5jaGlsZHJlbj1bXTsKICAgICAgICAgICAgICAgICAgICAkKGRhdHVtLmNoaWxkcmVuKS5lYWNoMihmdW5jdGlvbihpLCBjaGlsZERhdHVtKSB7IHByb2Nlc3MoY2hpbGREYXR1bSwgZ3JvdXAuY2hpbGRyZW4pOyB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZ3JvdXAuY2hpbGRyZW4ubGVuZ3RoIHx8IHF1ZXJ5Lm1hdGNoZXIodCwgdGV4dChncm91cCksIGRhdHVtKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uLnB1c2goZ3JvdXApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXJ5Lm1hdGNoZXIodCwgdGV4dChkYXR1bSksIGRhdHVtKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uLnB1c2goZGF0dW0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICQoZGF0YSgpLnJlc3VsdHMpLmVhY2gyKGZ1bmN0aW9uKGksIGRhdHVtKSB7IHByb2Nlc3MoZGF0dW0sIGZpbHRlcmVkLnJlc3VsdHMpOyB9KTsKICAgICAgICAgICAgcXVlcnkuY2FsbGJhY2soZmlsdGVyZWQpOwogICAgICAgIH07CiAgICB9CgogICAgLy8gVE9ETyBqYXZhZG9jCiAgICBmdW5jdGlvbiB0YWdzKGRhdGEpIHsKICAgICAgICB2YXIgaXNGdW5jID0gJC5pc0Z1bmN0aW9uKGRhdGEpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAocXVlcnkpIHsKICAgICAgICAgICAgdmFyIHQgPSBxdWVyeS50ZXJtLCBmaWx0ZXJlZCA9IHtyZXN1bHRzOiBbXX07CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBpc0Z1bmMgPyBkYXRhKHF1ZXJ5KSA6IGRhdGE7CiAgICAgICAgICAgIGlmICgkLmlzQXJyYXkocmVzdWx0KSkgewogICAgICAgICAgICAgICAgJChyZXN1bHQpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpc09iamVjdCA9IHRoaXMudGV4dCAhPT0gdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gaXNPYmplY3QgPyB0aGlzLnRleHQgOiB0aGlzOwogICAgICAgICAgICAgICAgICAgIGlmICh0ID09PSAiIiB8fCBxdWVyeS5tYXRjaGVyKHQsIHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnJlc3VsdHMucHVzaChpc09iamVjdCA\/IHRoaXMgOiB7aWQ6IHRoaXMsIHRleHQ6IHRoaXN9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHF1ZXJ5LmNhbGxiYWNrKGZpbHRlcmVkKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIGZvcm1hdHRlciBmdW5jdGlvbiBzaG91bGQgYmUgdXNlZC4KICAgICAqCiAgICAgKiBUaHJvd3MgYW4gZXJyb3IgaWYgaXQgaXMgbm90IGEgZnVuY3Rpb24uIFJldHVybnMgdHJ1ZSBpZiBpdCBzaG91bGQgYmUgdXNlZCwKICAgICAqIGZhbHNlIGlmIG5vIGZvcm1hdHRpbmcgc2hvdWxkIGJlIHBlcmZvcm1lZC4KICAgICAqCiAgICAgKiBAcGFyYW0gZm9ybWF0dGVyCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNoZWNrRm9ybWF0dGVyKGZvcm1hdHRlciwgZm9ybWF0dGVyTmFtZSkgewogICAgICAgIGlmICgkLmlzRnVuY3Rpb24oZm9ybWF0dGVyKSkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKCFmb3JtYXR0ZXIpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAodHlwZW9mKGZvcm1hdHRlcikgPT09ICdzdHJpbmcnKSByZXR1cm4gdHJ1ZTsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZm9ybWF0dGVyTmFtZSArIiBtdXN0IGJlIGEgc3RyaW5nLCBmdW5jdGlvbiwgb3IgZmFsc3kgdmFsdWUiKTsKICAgIH0KCiAgLyoqCiAgICogUmV0dXJucyBhIGdpdmVuIHZhbHVlCiAgICogSWYgZ2l2ZW4gYSBmdW5jdGlvbiwgcmV0dXJucyBpdHMgb3V0cHV0CiAgICoKICAgKiBAcGFyYW0gdmFsIHN0cmluZ3xmdW5jdGlvbgogICAqIEBwYXJhbSBjb250ZXh0IHZhbHVlIG9mICJ0aGlzIiB0byBiZSBwYXNzZWQgdG8gZnVuY3Rpb24KICAgKiBAcmV0dXJucyB7Kn0KICAgKi8KICAgIGZ1bmN0aW9uIGV2YWx1YXRlKHZhbCwgY29udGV4dCkgewogICAgICAgIGlmICgkLmlzRnVuY3Rpb24odmFsKSkgewogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgICAgIHJldHVybiB2YWwuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWw7CiAgICB9CgogICAgZnVuY3Rpb24gY291bnRSZXN1bHRzKHJlc3VsdHMpIHsKICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICQuZWFjaChyZXN1bHRzLCBmdW5jdGlvbihpLCBpdGVtKSB7CiAgICAgICAgICAgIGlmIChpdGVtLmNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICBjb3VudCArPSBjb3VudFJlc3VsdHMoaXRlbS5jaGlsZHJlbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNvdW50OwogICAgfQoKICAgIC8qKgogICAgICogRGVmYXVsdCB0b2tlbml6ZXIuIFRoaXMgZnVuY3Rpb24gdXNlcyBicmVha3MgdGhlIGlucHV0IG9uIHN1YnN0cmluZyBtYXRjaCBvZiBhbnkgc3RyaW5nIGZyb20gdGhlCiAgICAgKiBvcHRzLnRva2VuU2VwYXJhdG9ycyBhcnJheSBhbmQgdXNlcyBvcHRzLmNyZWF0ZVNlYXJjaENob2ljZSB0byBjcmVhdGUgdGhlIGNob2ljZSBvYmplY3QuIEJvdGggb2YgdGhvc2UKICAgICAqIHR3byBvcHRpb25zIGhhdmUgdG8gYmUgZGVmaW5lZCBpbiBvcmRlciBmb3IgdGhlIHRva2VuaXplciB0byB3b3JrLgogICAgICoKICAgICAqIEBwYXJhbSBpbnB1dCB0ZXh0IHVzZXIgaGFzIHR5cGVkIHNvIGZhciBvciBwYXN0ZWQgaW50byB0aGUgc2VhcmNoIGZpZWxkCiAgICAgKiBAcGFyYW0gc2VsZWN0aW9uIGN1cnJlbnRseSBzZWxlY3RlZCBjaG9pY2VzCiAgICAgKiBAcGFyYW0gc2VsZWN0Q2FsbGJhY2sgZnVuY3Rpb24oY2hvaWNlKSBjYWxsYmFjayB0aG8gYWRkIHRoZSBjaG9pY2UgdG8gc2VsZWN0aW9uCiAgICAgKiBAcGFyYW0gb3B0cyBzZWxlY3QyJ3Mgb3B0cwogICAgICogQHJldHVybiB1bmRlZmluZWQvbnVsbCB0byBsZWF2ZSB0aGUgY3VycmVudCBpbnB1dCB1bmNoYW5nZWQsIG9yIGEgc3RyaW5nIHRvIGNoYW5nZSB0aGUgaW5wdXQgdG8gdGhlIHJldHVybmVkIHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlZmF1bHRUb2tlbml6ZXIoaW5wdXQsIHNlbGVjdGlvbiwgc2VsZWN0Q2FsbGJhY2ssIG9wdHMpIHsKICAgICAgICB2YXIgb3JpZ2luYWwgPSBpbnB1dCwgLy8gc3RvcmUgdGhlIG9yaWdpbmFsIHNvIHdlIGNhbiBjb21wYXJlIGFuZCBrbm93IGlmIHdlIG5lZWQgdG8gdGVsbCB0aGUgc2VhcmNoIHRvIHVwZGF0ZSBpdHMgdGV4dAogICAgICAgICAgICBkdXBlID0gZmFsc2UsIC8vIGNoZWNrIGZvciB3aGV0aGVyIGEgdG9rZW4gd2UgZXh0cmFjdGVkIHJlcHJlc2VudHMgYSBkdXBsaWNhdGUgc2VsZWN0ZWQgY2hvaWNlCiAgICAgICAgICAgIHRva2VuLCAvLyB0b2tlbgogICAgICAgICAgICBpbmRleCwgLy8gcG9zaXRpb24gYXQgd2hpY2ggdGhlIHNlcGFyYXRvciB3YXMgZm91bmQKICAgICAgICAgICAgaSwgbCwgLy8gbG9vcGluZyB2YXJpYWJsZXMKICAgICAgICAgICAgc2VwYXJhdG9yOyAvLyB0aGUgbWF0Y2hlZCBzZXBhcmF0b3IKCiAgICAgICAgaWYgKCFvcHRzLmNyZWF0ZVNlYXJjaENob2ljZSB8fCAhb3B0cy50b2tlblNlcGFyYXRvcnMgfHwgb3B0cy50b2tlblNlcGFyYXRvcnMubGVuZ3RoIDwgMSkgcmV0dXJuIHVuZGVmaW5lZDsKCiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgaW5kZXggPSAtMTsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcHRzLnRva2VuU2VwYXJhdG9ycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIHNlcGFyYXRvciA9IG9wdHMudG9rZW5TZXBhcmF0b3JzW2ldOwogICAgICAgICAgICAgICAgaW5kZXggPSBpbnB1dC5pbmRleE9mKHNlcGFyYXRvcik7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpbmRleCA8IDApIGJyZWFrOyAvLyBkaWQgbm90IGZpbmQgYW55IHRva2VuIHNlcGFyYXRvciBpbiB0aGUgaW5wdXQgc3RyaW5nLCBiYWlsCgogICAgICAgICAgICB0b2tlbiA9IGlucHV0LnN1YnN0cmluZygwLCBpbmRleCk7CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQuc3Vic3RyaW5nKGluZGV4ICsgc2VwYXJhdG9yLmxlbmd0aCk7CgogICAgICAgICAgICBpZiAodG9rZW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdG9rZW4gPSBvcHRzLmNyZWF0ZVNlYXJjaENob2ljZS5jYWxsKHRoaXMsIHRva2VuLCBzZWxlY3Rpb24pOwogICAgICAgICAgICAgICAgaWYgKHRva2VuICE9PSB1bmRlZmluZWQgJiYgdG9rZW4gIT09IG51bGwgJiYgb3B0cy5pZCh0b2tlbikgIT09IHVuZGVmaW5lZCAmJiBvcHRzLmlkKHRva2VuKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGR1cGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gc2VsZWN0aW9uLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXF1YWwob3B0cy5pZCh0b2tlbiksIG9wdHMuaWQoc2VsZWN0aW9uW2ldKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cGUgPSB0cnVlOyBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKCFkdXBlKSBzZWxlY3RDYWxsYmFjayh0b2tlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChvcmlnaW5hbCE9PWlucHV0KSByZXR1cm4gaW5wdXQ7CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYW51cEpRdWVyeUVsZW1lbnRzKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgJC5lYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24gKGksIGVsZW1lbnQpIHsKICAgICAgICAgICAgc2VsZltlbGVtZW50XS5yZW1vdmUoKTsKICAgICAgICAgICAgc2VsZltlbGVtZW50XSA9IG51bGw7CiAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNsYXNzCiAgICAgKgogICAgICogQHBhcmFtIHN1cGVyQ2xhc3MKICAgICAqIEBwYXJhbSBtZXRob2RzCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsYXp6KFN1cGVyQ2xhc3MsIG1ldGhvZHMpIHsKICAgICAgICB2YXIgY29uc3RydWN0b3IgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBuZXcgU3VwZXJDbGFzczsKICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUucGFyZW50ID0gU3VwZXJDbGFzcy5wcm90b3R5cGU7CiAgICAgICAgY29uc3RydWN0b3IucHJvdG90eXBlID0gJC5leHRlbmQoY29uc3RydWN0b3IucHJvdG90eXBlLCBtZXRob2RzKTsKICAgICAgICByZXR1cm4gY29uc3RydWN0b3I7CiAgICB9CgogICAgQWJzdHJhY3RTZWxlY3QyID0gY2xhenooT2JqZWN0LCB7CgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgYmluZDogZnVuY3Rpb24gKGZ1bmMpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZnVuYy5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgaW5pdDogZnVuY3Rpb24gKG9wdHMpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdHMsIHNlYXJjaCwgcmVzdWx0c1NlbGVjdG9yID0gIi5zZWxlY3QyLXJlc3VsdHMiOwoKICAgICAgICAgICAgLy8gcHJlcGFyZSBvcHRpb25zCiAgICAgICAgICAgIHRoaXMub3B0cyA9IG9wdHMgPSB0aGlzLnByZXBhcmVPcHRzKG9wdHMpOwoKICAgICAgICAgICAgdGhpcy5pZD1vcHRzLmlkOwoKICAgICAgICAgICAgLy8gZGVzdHJveSBpZiBjYWxsZWQgb24gYW4gZXhpc3RpbmcgY29tcG9uZW50CiAgICAgICAgICAgIGlmIChvcHRzLmVsZW1lbnQuZGF0YSgic2VsZWN0MiIpICE9PSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAgIG9wdHMuZWxlbWVudC5kYXRhKCJzZWxlY3QyIikgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG9wdHMuZWxlbWVudC5kYXRhKCJzZWxlY3QyIikuZGVzdHJveSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IHRoaXMuY3JlYXRlQ29udGFpbmVyKCk7CgogICAgICAgICAgICB0aGlzLmxpdmVSZWdpb24gPSAkKCcuc2VsZWN0Mi1oaWRkZW4tYWNjZXNzaWJsZScpOwogICAgICAgICAgICBpZiAodGhpcy5saXZlUmVnaW9uLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxpdmVSZWdpb24gPSAkKCI8c3Bhbj4iLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvbGU6ICJzdGF0dXMiLAogICAgICAgICAgICAgICAgICAgICAgICAiYXJpYS1saXZlIjogInBvbGl0ZSIKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygic2VsZWN0Mi1oaWRkZW4tYWNjZXNzaWJsZSIpCiAgICAgICAgICAgICAgICAgICAgLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lcklkPSJzMmlkXyIrKG9wdHMuZWxlbWVudC5hdHRyKCJpZCIpIHx8ICJhdXRvZ2VuIituZXh0VWlkKCkpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lckV2ZW50TmFtZT0gdGhpcy5jb250YWluZXJJZAogICAgICAgICAgICAgICAgLnJlcGxhY2UoLyhbLl0pL2csICdfJykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oWzsmLFwtXC5cK1wqXH4nOiJcIVxeIyQlQFxbXF1cKFwpPT5cfF0pL2csICdcXCQxJyk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmF0dHIoImlkIiwgdGhpcy5jb250YWluZXJJZCk7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hdHRyKCJ0aXRsZSIsIG9wdHMuZWxlbWVudC5hdHRyKCJ0aXRsZSIpKTsKCiAgICAgICAgICAgIHRoaXMuYm9keSA9ICQoZG9jdW1lbnQuYm9keSk7CgogICAgICAgICAgICBzeW5jQ3NzQ2xhc3Nlcyh0aGlzLmNvbnRhaW5lciwgdGhpcy5vcHRzLmVsZW1lbnQsIHRoaXMub3B0cy5hZGFwdENvbnRhaW5lckNzc0NsYXNzKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmF0dHIoInN0eWxlIiwgb3B0cy5lbGVtZW50LmF0dHIoInN0eWxlIikpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jc3MoZXZhbHVhdGUob3B0cy5jb250YWluZXJDc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKGV2YWx1YXRlKG9wdHMuY29udGFpbmVyQ3NzQ2xhc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CgogICAgICAgICAgICB0aGlzLmVsZW1lbnRUYWJJbmRleCA9IHRoaXMub3B0cy5lbGVtZW50LmF0dHIoInRhYmluZGV4Iik7CgogICAgICAgICAgICAvLyBzd2FwIGNvbnRhaW5lciBmb3IgdGhlIGVsZW1lbnQKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQKICAgICAgICAgICAgICAgIC5kYXRhKCJzZWxlY3QyIiwgdGhpcykKICAgICAgICAgICAgICAgIC5hdHRyKCJ0YWJpbmRleCIsICItMSIpCiAgICAgICAgICAgICAgICAuYmVmb3JlKHRoaXMuY29udGFpbmVyKQogICAgICAgICAgICAgICAgLm9uKCJjbGljay5zZWxlY3QyIiwga2lsbEV2ZW50KTsgLy8gZG8gbm90IGxlYWsgY2xpY2sgZXZlbnRzCgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5kYXRhKCJzZWxlY3QyIiwgdGhpcyk7CgogICAgICAgICAgICB0aGlzLmRyb3Bkb3duID0gdGhpcy5jb250YWluZXIuZmluZCgiLnNlbGVjdDItZHJvcCIpOwoKICAgICAgICAgICAgc3luY0Nzc0NsYXNzZXModGhpcy5kcm9wZG93biwgdGhpcy5vcHRzLmVsZW1lbnQsIHRoaXMub3B0cy5hZGFwdERyb3Bkb3duQ3NzQ2xhc3MpOwoKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5hZGRDbGFzcyhldmFsdWF0ZShvcHRzLmRyb3Bkb3duQ3NzQ2xhc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uZGF0YSgic2VsZWN0MiIsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCJjbGljayIsIGtpbGxFdmVudCk7CgogICAgICAgICAgICB0aGlzLnJlc3VsdHMgPSByZXN1bHRzID0gdGhpcy5jb250YWluZXIuZmluZChyZXN1bHRzU2VsZWN0b3IpOwogICAgICAgICAgICB0aGlzLnNlYXJjaCA9IHNlYXJjaCA9IHRoaXMuY29udGFpbmVyLmZpbmQoImlucHV0LnNlbGVjdDItaW5wdXQiKTsKCiAgICAgICAgICAgIHRoaXMucXVlcnlDb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMucmVzdWx0c1BhZ2UgPSAwOwogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwoKICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSB0aGUgY29udGFpbmVyCiAgICAgICAgICAgIHRoaXMuaW5pdENvbnRhaW5lcigpOwoKICAgICAgICAgICAgdGhpcy5jb250YWluZXIub24oImNsaWNrIiwga2lsbEV2ZW50KTsKCiAgICAgICAgICAgIGluc3RhbGxGaWx0ZXJlZE1vdXNlTW92ZSh0aGlzLnJlc3VsdHMpOwoKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vbigibW91c2Vtb3ZlLWZpbHRlcmVkIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQodGhpcy5oaWdobGlnaHRVbmRlckV2ZW50KSk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ub24oInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLl90b3VjaEV2ZW50ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0VW5kZXJFdmVudChldmVudCk7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vbigidG91Y2htb3ZlIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQodGhpcy50b3VjaE1vdmVkKSk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ub24oInRvdWNoc3RhcnQgdG91Y2hlbmQiLCByZXN1bHRzU2VsZWN0b3IsIHRoaXMuYmluZCh0aGlzLmNsZWFyVG91Y2hNb3ZlZCkpOwoKICAgICAgICAgICAgLy8gV2FpdGluZyBmb3IgYSBjbGljayBldmVudCBvbiB0b3VjaCBkZXZpY2VzIHRvIHNlbGVjdCBvcHRpb24gYW5kIGhpZGUgZHJvcGRvd24KICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIGNsaWNrIHdpbGwgYmUgdHJpZ2dlcmVkIG9uIGFuIHVuZGVybHlpbmcgZWxlbWVudAogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCdjbGljaycsIHRoaXMuYmluZChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl90b3VjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG91Y2hFdmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0SGlnaGxpZ2h0ZWQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgaW5zdGFsbERlYm91bmNlZFNjcm9sbCg4MCwgdGhpcy5yZXN1bHRzKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5vbigic2Nyb2xsLWRlYm91bmNlZCIsIHJlc3VsdHNTZWxlY3RvciwgdGhpcy5iaW5kKHRoaXMubG9hZE1vcmVJZk5lZWRlZCkpOwoKICAgICAgICAgICAgLy8gZG8gbm90IHByb3BhZ2F0ZSBjaGFuZ2UgZXZlbnQgZnJvbSB0aGUgc2VhcmNoIGZpZWxkIG91dCBvZiB0aGUgY29tcG9uZW50CiAgICAgICAgICAgICQodGhpcy5jb250YWluZXIpLm9uKCJjaGFuZ2UiLCAiLnNlbGVjdDItaW5wdXQiLCBmdW5jdGlvbihlKSB7ZS5zdG9wUHJvcGFnYXRpb24oKTt9KTsKICAgICAgICAgICAgJCh0aGlzLmRyb3Bkb3duKS5vbigiY2hhbmdlIiwgIi5zZWxlY3QyLWlucHV0IiwgZnVuY3Rpb24oZSkge2Uuc3RvcFByb3BhZ2F0aW9uKCk7fSk7CgogICAgICAgICAgICAvLyBpZiBqcXVlcnkubW91c2V3aGVlbCBwbHVnaW4gaXMgaW5zdGFsbGVkIHdlIGNhbiBwcmV2ZW50IG91dC1vZi1ib3VuZHMgc2Nyb2xsaW5nIG9mIHJlc3VsdHMgdmlhIG1vdXNld2hlZWwKICAgICAgICAgICAgaWYgKCQuZm4ubW91c2V3aGVlbCkgewogICAgICAgICAgICAgICAgcmVzdWx0cy5tb3VzZXdoZWVsKGZ1bmN0aW9uIChlLCBkZWx0YSwgZGVsdGFYLCBkZWx0YVkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9wID0gcmVzdWx0cy5zY3JvbGxUb3AoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVsdGFZID4gMCAmJiB0b3AgLSBkZWx0YVkgPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnNjcm9sbFRvcCgwKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVsdGFZIDwgMCAmJiByZXN1bHRzLmdldCgwKS5zY3JvbGxIZWlnaHQgLSByZXN1bHRzLnNjcm9sbFRvcCgpICsgZGVsdGFZIDw9IHJlc3VsdHMuaGVpZ2h0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5zY3JvbGxUb3AocmVzdWx0cy5nZXQoMCkuc2Nyb2xsSGVpZ2h0IC0gcmVzdWx0cy5oZWlnaHQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW5zdGFsbEtleVVwQ2hhbmdlRXZlbnQoc2VhcmNoKTsKICAgICAgICAgICAgc2VhcmNoLm9uKCJrZXl1cC1jaGFuZ2UgaW5wdXQgcGFzdGUiLCB0aGlzLmJpbmQodGhpcy51cGRhdGVSZXN1bHRzKSk7CiAgICAgICAgICAgIHNlYXJjaC5vbigiZm9jdXMiLCBmdW5jdGlvbiAoKSB7IHNlYXJjaC5hZGRDbGFzcygic2VsZWN0Mi1mb2N1c2VkIik7IH0pOwogICAgICAgICAgICBzZWFyY2gub24oImJsdXIiLCBmdW5jdGlvbiAoKSB7IHNlYXJjaC5yZW1vdmVDbGFzcygic2VsZWN0Mi1mb2N1c2VkIik7fSk7CgogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCJtb3VzZXVwIiwgcmVzdWx0c1NlbGVjdG9yLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5jbG9zZXN0KCIuc2VsZWN0Mi1yZXN1bHQtc2VsZWN0YWJsZSIpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZ2hsaWdodFVuZGVyRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RIaWdobGlnaHRlZChlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgLy8gdHJhcCBhbGwgbW91c2UgZXZlbnRzIGZyb20gbGVhdmluZyB0aGUgZHJvcGRvd24uIHNvbWV0aW1lcyB0aGVyZSBtYXkgYmUgYSBtb2RhbCB0aGF0IGlzIGxpc3RlbmluZwogICAgICAgICAgICAvLyBmb3IgbW91c2UgZXZlbnRzIG91dHNpZGUgb2YgaXRzZWxmIHNvIGl0IGNhbiBjbG9zZSBpdHNlbGYuIHNpbmNlIHRoZSBkcm9wZG93biBpcyBub3cgb3V0c2lkZSB0aGUgc2VsZWN0MidzCiAgICAgICAgICAgIC8vIGRvbSBpdCB3aWxsIHRyaWdnZXIgdGhlIHBvcHVwIGNsb3NlLCB3aGljaCBpcyBub3Qgd2hhdCB3ZSB3YW50CiAgICAgICAgICAgIC8vIGZvY3VzaW4gY2FuIGNhdXNlIGZvY3VzIHdhcnMgYmV0d2VlbiBtb2RhbHMgYW5kIHNlbGVjdDIgc2luY2UgdGhlIGRyb3Bkb3duIGlzIG91dHNpZGUgdGhlIG1vZGFsLgogICAgICAgICAgICB0aGlzLmRyb3Bkb3duLm9uKCJjbGljayBtb3VzZXVwIG1vdXNlZG93biB0b3VjaHN0YXJ0IHRvdWNoZW5kIGZvY3VzaW4iLCBmdW5jdGlvbiAoZSkgeyBlLnN0b3BQcm9wYWdhdGlvbigpOyB9KTsKCiAgICAgICAgICAgIHRoaXMubmV4dFNlYXJjaFRlcm0gPSB1bmRlZmluZWQ7CgogICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKHRoaXMub3B0cy5pbml0U2VsZWN0aW9uKSkgewogICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSBzZWxlY3Rpb24gYmFzZWQgb24gdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIHNvdXJjZSBlbGVtZW50CiAgICAgICAgICAgICAgICB0aGlzLmluaXRTZWxlY3Rpb24oKTsKCiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgdXNlciBoYXMgcHJvdmlkZWQgYSBmdW5jdGlvbiB0aGF0IGNhbiBzZXQgc2VsZWN0aW9uIGJhc2VkIG9uIHRoZSB2YWx1ZSBvZiB0aGUgc291cmNlIGVsZW1lbnQKICAgICAgICAgICAgICAgIC8vIHdlIG1vbml0b3IgdGhlIGNoYW5nZSBldmVudCBvbiB0aGUgZWxlbWVudCBhbmQgdHJpZ2dlciBpdCwgYWxsb3dpbmcgZm9yIHR3byB3YXkgc3luY2hyb25pemF0aW9uCiAgICAgICAgICAgICAgICB0aGlzLm1vbml0b3JTb3VyY2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdHMubWF4aW11bUlucHV0TGVuZ3RoICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC5hdHRyKCJtYXhsZW5ndGgiLCBvcHRzLm1heGltdW1JbnB1dExlbmd0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkaXNhYmxlZCA9IG9wdHMuZWxlbWVudC5wcm9wKCJkaXNhYmxlZCIpOwogICAgICAgICAgICBpZiAoZGlzYWJsZWQgPT09IHVuZGVmaW5lZCkgZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbmFibGUoIWRpc2FibGVkKTsKCiAgICAgICAgICAgIHZhciByZWFkb25seSA9IG9wdHMuZWxlbWVudC5wcm9wKCJyZWFkb25seSIpOwogICAgICAgICAgICBpZiAocmVhZG9ubHkgPT09IHVuZGVmaW5lZCkgcmVhZG9ubHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5yZWFkb25seShyZWFkb25seSk7CgogICAgICAgICAgICAvLyBDYWxjdWxhdGUgc2l6ZSBvZiBzY3JvbGxiYXIKICAgICAgICAgICAgc2Nyb2xsQmFyRGltZW5zaW9ucyA9IHNjcm9sbEJhckRpbWVuc2lvbnMgfHwgbWVhc3VyZVNjcm9sbGJhcigpOwoKICAgICAgICAgICAgdGhpcy5hdXRvZm9jdXMgPSBvcHRzLmVsZW1lbnQucHJvcCgiYXV0b2ZvY3VzIik7CiAgICAgICAgICAgIG9wdHMuZWxlbWVudC5wcm9wKCJhdXRvZm9jdXMiLCBmYWxzZSk7CiAgICAgICAgICAgIGlmICh0aGlzLmF1dG9mb2N1cykgdGhpcy5mb2N1cygpOwoKICAgICAgICAgICAgdGhpcy5zZWFyY2guYXR0cigicGxhY2Vob2xkZXIiLCBvcHRzLnNlYXJjaElucHV0UGxhY2Vob2xkZXIpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWxlbWVudD10aGlzLm9wdHMuZWxlbWVudCwgc2VsZWN0MiA9IGVsZW1lbnQuZGF0YSgic2VsZWN0MiIpLCBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKCiAgICAgICAgICAgIGlmIChlbGVtZW50Lmxlbmd0aCAmJiBlbGVtZW50WzBdLmRldGFjaEV2ZW50ICYmIHNlbGYuX3N5bmMpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuX3N5bmMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIHNlbGYuX3N5bmMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnByb3BlcnR5T2JzZXJ2ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydHlPYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5T2JzZXJ2ZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3N5bmMgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHNlbGVjdDIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgc2VsZWN0Mi5jb250YWluZXIucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICBzZWxlY3QyLmxpdmVSZWdpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICBzZWxlY3QyLmRyb3Bkb3duLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIC5zaG93KCkKICAgICAgICAgICAgICAgICAgICAucmVtb3ZlRGF0YSgic2VsZWN0MiIpCiAgICAgICAgICAgICAgICAgICAgLm9mZigiLnNlbGVjdDIiKQogICAgICAgICAgICAgICAgICAgIC5wcm9wKCJhdXRvZm9jdXMiLCB0aGlzLmF1dG9mb2N1cyB8fCBmYWxzZSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50VGFiSW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmF0dHIoe3RhYmluZGV4OiB0aGlzLmVsZW1lbnRUYWJJbmRleH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHIoInRhYmluZGV4Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGVtZW50LnNob3coKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2xlYW51cEpRdWVyeUVsZW1lbnRzLmNhbGwodGhpcywKICAgICAgICAgICAgICAgICJjb250YWluZXIiLAogICAgICAgICAgICAgICAgImxpdmVSZWdpb24iLAogICAgICAgICAgICAgICAgImRyb3Bkb3duIiwKICAgICAgICAgICAgICAgICJyZXN1bHRzIiwKICAgICAgICAgICAgICAgICJzZWFyY2giCiAgICAgICAgICAgICk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBvcHRpb25Ub0RhdGE6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQuaXMoIm9wdGlvbiIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGlkOmVsZW1lbnQucHJvcCgidmFsdWUiKSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OmVsZW1lbnQudGV4dCgpLAogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQuZ2V0KCksCiAgICAgICAgICAgICAgICAgICAgY3NzOiBlbGVtZW50LmF0dHIoImNsYXNzIiksCiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ6IGVsZW1lbnQucHJvcCgiZGlzYWJsZWQiKSwKICAgICAgICAgICAgICAgICAgICBsb2NrZWQ6IGVxdWFsKGVsZW1lbnQuYXR0cigibG9ja2VkIiksICJsb2NrZWQiKSB8fCBlcXVhbChlbGVtZW50LmRhdGEoImxvY2tlZCIpLCB0cnVlKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmlzKCJvcHRncm91cCIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHRleHQ6ZWxlbWVudC5hdHRyKCJsYWJlbCIpLAogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOltdLAogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQuZ2V0KCksCiAgICAgICAgICAgICAgICAgICAgY3NzOiBlbGVtZW50LmF0dHIoImNsYXNzIikKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIHByZXBhcmVPcHRzOiBmdW5jdGlvbiAob3B0cykgewogICAgICAgICAgICB2YXIgZWxlbWVudCwgc2VsZWN0LCBpZEtleSwgYWpheFVybCwgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICBlbGVtZW50ID0gb3B0cy5lbGVtZW50OwoKICAgICAgICAgICAgaWYgKGVsZW1lbnQuZ2V0KDApLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ID0gc2VsZWN0ID0gb3B0cy5lbGVtZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VsZWN0KSB7CiAgICAgICAgICAgICAgICAvLyB0aGVzZSBvcHRpb25zIGFyZSBub3QgYWxsb3dlZCB3aGVuIGF0dGFjaGVkIHRvIGEgc2VsZWN0IGJlY2F1c2UgdGhleSBhcmUgcGlja2VkIHVwIG9mZiB0aGUgZWxlbWVudCBpdHNlbGYKICAgICAgICAgICAgICAgICQuZWFjaChbImlkIiwgIm11bHRpcGxlIiwgImFqYXgiLCAicXVlcnkiLCAiY3JlYXRlU2VhcmNoQ2hvaWNlIiwgImluaXRTZWxlY3Rpb24iLCAiZGF0YSIsICJ0YWdzIl0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcyBpbiBvcHRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT3B0aW9uICciICsgdGhpcyArICInIGlzIG5vdCBhbGxvd2VkIGZvciBTZWxlY3QyIHdoZW4gYXR0YWNoZWQgdG8gYSA8c2VsZWN0PiBlbGVtZW50LiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHRzID0gJC5leHRlbmQoe30sIHsKICAgICAgICAgICAgICAgIHBvcHVsYXRlUmVzdWx0czogZnVuY3Rpb24oY29udGFpbmVyLCByZXN1bHRzLCBxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwb3B1bGF0ZSwgaWQ9dGhpcy5vcHRzLmlkLCBsaXZlUmVnaW9uPXRoaXMubGl2ZVJlZ2lvbjsKCiAgICAgICAgICAgICAgICAgICAgcG9wdWxhdGU9ZnVuY3Rpb24ocmVzdWx0cywgY29udGFpbmVyLCBkZXB0aCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGksIGwsIHJlc3VsdCwgc2VsZWN0YWJsZSwgZGlzYWJsZWQsIGNvbXBvdW5kLCBub2RlLCBsYWJlbCwgaW5uZXJDb250YWluZXIsIGZvcm1hdHRlZDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBvcHRzLnNvcnRSZXN1bHRzKHJlc3VsdHMsIGNvbnRhaW5lciwgcXVlcnkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29sbGVjdCB0aGUgY3JlYXRlZCBub2RlcyBmb3IgYnVsayBhcHBlbmQKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSByZXN1bHRzLmxlbmd0aDsgaSA8IGw7IGkgPSBpICsgMSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdD1yZXN1bHRzW2ldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkID0gKHJlc3VsdC5kaXNhYmxlZCA9PT0gdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlID0gKCFkaXNhYmxlZCkgJiYgKGlkKHJlc3VsdCkgIT09IHVuZGVmaW5lZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG91bmQ9cmVzdWx0LmNoaWxkcmVuICYmIHJlc3VsdC5jaGlsZHJlbi5sZW5ndGggPiAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU9JCgiPGxpPjwvbGk+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFkZENsYXNzKCJzZWxlY3QyLXJlc3VsdHMtZGVwdC0iK2RlcHRoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuYWRkQ2xhc3MoInNlbGVjdDItcmVzdWx0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFkZENsYXNzKHNlbGVjdGFibGUgPyAic2VsZWN0Mi1yZXN1bHQtc2VsZWN0YWJsZSIgOiAic2VsZWN0Mi1yZXN1bHQtdW5zZWxlY3RhYmxlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzYWJsZWQpIHsgbm9kZS5hZGRDbGFzcygic2VsZWN0Mi1kaXNhYmxlZCIpOyB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcG91bmQpIHsgbm9kZS5hZGRDbGFzcygic2VsZWN0Mi1yZXN1bHQtd2l0aC1jaGlsZHJlbiIpOyB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFkZENsYXNzKHNlbGYub3B0cy5mb3JtYXRSZXN1bHRDc3NDbGFzcyhyZXN1bHQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuYXR0cigicm9sZSIsICJwcmVzZW50YXRpb24iKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbD0kKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsLmFkZENsYXNzKCJzZWxlY3QyLXJlc3VsdC1sYWJlbCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwuYXR0cigiaWQiLCAic2VsZWN0Mi1yZXN1bHQtbGFiZWwtIiArIG5leHRVaWQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbC5hdHRyKCJyb2xlIiwgIm9wdGlvbiIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZD1vcHRzLmZvcm1hdFJlc3VsdChyZXN1bHQsIGxhYmVsLCBxdWVyeSwgc2VsZi5vcHRzLmVzY2FwZU1hcmt1cCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVkIT09dW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwuaHRtbChmb3JtYXR0ZWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuYXBwZW5kKGxhYmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvdW5kKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlubmVyQ29udGFpbmVyPSQoIjx1bD48L3VsPiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlubmVyQ29udGFpbmVyLmFkZENsYXNzKCJzZWxlY3QyLXJlc3VsdC1zdWIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3B1bGF0ZShyZXN1bHQuY2hpbGRyZW4sIGlubmVyQ29udGFpbmVyLCBkZXB0aCsxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFwcGVuZChpbm5lckNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5kYXRhKCJzZWxlY3QyLWRhdGEiLCByZXN1bHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXMucHVzaChub2RlWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnVsayBhcHBlbmQgdGhlIGNyZWF0ZWQgbm9kZXMKICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZChub2Rlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpdmVSZWdpb24udGV4dChvcHRzLmZvcm1hdE1hdGNoZXMocmVzdWx0cy5sZW5ndGgpKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBwb3B1bGF0ZShyZXN1bHRzLCBjb250YWluZXIsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAkLmZuLnNlbGVjdDIuZGVmYXVsdHMsIG9wdHMpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZihvcHRzLmlkKSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaWRLZXkgPSBvcHRzLmlkOwogICAgICAgICAgICAgICAgb3B0cy5pZCA9IGZ1bmN0aW9uIChlKSB7IHJldHVybiBlW2lkS2V5XTsgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCQuaXNBcnJheShvcHRzLmVsZW1lbnQuZGF0YSgic2VsZWN0MlRhZ3MiKSkpIHsKICAgICAgICAgICAgICAgIGlmICgidGFncyIgaW4gb3B0cykgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJ0YWdzIHNwZWNpZmllZCBhcyBib3RoIGFuIGF0dHJpYnV0ZSAnZGF0YS1zZWxlY3QyLXRhZ3MnIGFuZCBpbiBvcHRpb25zIG9mIFNlbGVjdDIgIiArIG9wdHMuZWxlbWVudC5hdHRyKCJpZCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb3B0cy50YWdzPW9wdHMuZWxlbWVudC5kYXRhKCJzZWxlY3QyVGFncyIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VsZWN0KSB7CiAgICAgICAgICAgICAgICBvcHRzLnF1ZXJ5ID0gdGhpcy5iaW5kKGZ1bmN0aW9uIChxdWVyeSkgewogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0geyByZXN1bHRzOiBbXSwgbW9yZTogZmFsc2UgfSwKICAgICAgICAgICAgICAgICAgICAgICAgdGVybSA9IHF1ZXJ5LnRlcm0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLCBwbGFjZWhvbGRlck9wdGlvbiwgcHJvY2VzczsKCiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcz1mdW5jdGlvbihlbGVtZW50LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncm91cDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuaXMoIm9wdGlvbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocXVlcnkubWF0Y2hlcih0ZXJtLCBlbGVtZW50LnRleHQoKSwgZWxlbWVudCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0aW9uLnB1c2goc2VsZi5vcHRpb25Ub0RhdGEoZWxlbWVudCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaXMoIm9wdGdyb3VwIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwPXNlbGYub3B0aW9uVG9EYXRhKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGlsZHJlbigpLmVhY2gyKGZ1bmN0aW9uKGksIGVsbSkgeyBwcm9jZXNzKGVsbSwgZ3JvdXAuY2hpbGRyZW4pOyB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChncm91cC5jaGlsZHJlbi5sZW5ndGg+MCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24ucHVzaChncm91cCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbj1lbGVtZW50LmNoaWxkcmVuKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSB0aGUgcGxhY2Vob2xkZXIgb3B0aW9uIGlmIHRoZXJlIGlzIG9uZQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldFBsYWNlaG9sZGVyKCkgIT09IHVuZGVmaW5lZCAmJiBjaGlsZHJlbi5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyT3B0aW9uID0gdGhpcy5nZXRQbGFjZWhvbGRlck9wdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGxhY2Vob2xkZXJPcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuPWNoaWxkcmVuLm5vdChwbGFjZWhvbGRlck9wdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuLmVhY2gyKGZ1bmN0aW9uKGksIGVsbSkgeyBwcm9jZXNzKGVsbSwgZGF0YS5yZXN1bHRzKTsgfSk7CgogICAgICAgICAgICAgICAgICAgIHF1ZXJ5LmNhbGxiYWNrKGRhdGEpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIG5lZWRlZCBiZWNhdXNlIGluc2lkZSB2YWwoKSB3ZSBjb25zdHJ1Y3QgY2hvaWNlcyBmcm9tIG9wdGlvbnMgYW5kIHRoZWlyIGlkIGlzIGhhcmRjb2RlZAogICAgICAgICAgICAgICAgb3B0cy5pZD1mdW5jdGlvbihlKSB7IHJldHVybiBlLmlkOyB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCEoInF1ZXJ5IiBpbiBvcHRzKSkgewoKICAgICAgICAgICAgICAgICAgICBpZiAoImFqYXgiIGluIG9wdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWpheFVybCA9IG9wdHMuZWxlbWVudC5kYXRhKCJhamF4LXVybCIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWpheFVybCAmJiBhamF4VXJsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdHMuYWpheC51cmwgPSBhamF4VXJsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdHMucXVlcnkgPSBhamF4LmNhbGwob3B0cy5lbGVtZW50LCBvcHRzLmFqYXgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoImRhdGEiIGluIG9wdHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5xdWVyeSA9IGxvY2FsKG9wdHMuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgidGFncyIgaW4gb3B0cykgewogICAgICAgICAgICAgICAgICAgICAgICBvcHRzLnF1ZXJ5ID0gdGFncyhvcHRzLnRhZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0cy5jcmVhdGVTZWFyY2hDaG9pY2UgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5jcmVhdGVTZWFyY2hDaG9pY2UgPSBmdW5jdGlvbiAodGVybSkgeyByZXR1cm4ge2lkOiAkLnRyaW0odGVybSksIHRleHQ6ICQudHJpbSh0ZXJtKX07IH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMuaW5pdFNlbGVjdGlvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRzLmluaXRTZWxlY3Rpb24gPSBmdW5jdGlvbiAoZWxlbWVudCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoc3BsaXRWYWwoZWxlbWVudC52YWwoKSwgb3B0cy5zZXBhcmF0b3IsIG9wdHMudHJhbnNmb3JtVmFsKSkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSB7IGlkOiB0aGlzLCB0ZXh0OiB0aGlzIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdzID0gb3B0cy50YWdzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKHRhZ3MpKSB0YWdzPXRhZ3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0YWdzKS5lYWNoKGZ1bmN0aW9uKCkgeyBpZiAoZXF1YWwodGhpcy5pZCwgb2JqLmlkKSkgeyBvYmogPSB0aGlzOyByZXR1cm4gZmFsc2U7IH0gfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChvYmopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZihvcHRzLnF1ZXJ5KSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgInF1ZXJ5IGZ1bmN0aW9uIG5vdCBkZWZpbmVkIGZvciBTZWxlY3QyICIgKyBvcHRzLmVsZW1lbnQuYXR0cigiaWQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlUG9zaXRpb24gPT09ICd0b3AnKSB7CiAgICAgICAgICAgICAgICBvcHRzLmNyZWF0ZVNlYXJjaENob2ljZVBvc2l0aW9uID0gZnVuY3Rpb24obGlzdCwgaXRlbSkgeyBsaXN0LnVuc2hpZnQoaXRlbSk7IH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAob3B0cy5jcmVhdGVTZWFyY2hDaG9pY2VQb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHsKICAgICAgICAgICAgICAgIG9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlUG9zaXRpb24gPSBmdW5jdGlvbihsaXN0LCBpdGVtKSB7IGxpc3QucHVzaChpdGVtKTsgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0eXBlb2Yob3B0cy5jcmVhdGVTZWFyY2hDaG9pY2VQb3NpdGlvbikgIT09ICJmdW5jdGlvbiIpICB7CiAgICAgICAgICAgICAgICB0aHJvdyAiaW52YWxpZCBjcmVhdGVTZWFyY2hDaG9pY2VQb3NpdGlvbiBvcHRpb24gbXVzdCBiZSAndG9wJywgJ2JvdHRvbScgb3IgYSBjdXN0b20gZnVuY3Rpb24iOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3B0czsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBNb25pdG9yIHRoZSBvcmlnaW5hbCBlbGVtZW50IGZvciBjaGFuZ2VzIGFuZCB1cGRhdGUgc2VsZWN0MiBhY2NvcmRpbmdseQogICAgICAgICAqLwogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgbW9uaXRvclNvdXJjZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWwgPSB0aGlzLm9wdHMuZWxlbWVudCwgb2JzZXJ2ZXIsIHNlbGYgPSB0aGlzOwoKICAgICAgICAgICAgZWwub24oImNoYW5nZS5zZWxlY3QyIiwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLmVsZW1lbnQuZGF0YSgic2VsZWN0Mi1jaGFuZ2UtdHJpZ2dlcmVkIikgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRTZWxlY3Rpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGhpcy5fc3luYyA9IHRoaXMuYmluZChmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgLy8gc3luYyBlbmFibGVkIHN0YXRlCiAgICAgICAgICAgICAgICB2YXIgZGlzYWJsZWQgPSBlbC5wcm9wKCJkaXNhYmxlZCIpOwogICAgICAgICAgICAgICAgaWYgKGRpc2FibGVkID09PSB1bmRlZmluZWQpIGRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZSghZGlzYWJsZWQpOwoKICAgICAgICAgICAgICAgIHZhciByZWFkb25seSA9IGVsLnByb3AoInJlYWRvbmx5Iik7CiAgICAgICAgICAgICAgICBpZiAocmVhZG9ubHkgPT09IHVuZGVmaW5lZCkgcmVhZG9ubHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucmVhZG9ubHkocmVhZG9ubHkpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHN5bmNDc3NDbGFzc2VzKHRoaXMuY29udGFpbmVyLCB0aGlzLm9wdHMuZWxlbWVudCwgdGhpcy5vcHRzLmFkYXB0Q29udGFpbmVyQ3NzQ2xhc3MpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKGV2YWx1YXRlKHRoaXMub3B0cy5jb250YWluZXJDc3NDbGFzcywgdGhpcy5vcHRzLmVsZW1lbnQpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5kcm9wZG93bikgewogICAgICAgICAgICAgICAgICAgIHN5bmNDc3NDbGFzc2VzKHRoaXMuZHJvcGRvd24sIHRoaXMub3B0cy5lbGVtZW50LCB0aGlzLm9wdHMuYWRhcHREcm9wZG93bkNzc0NsYXNzKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmFkZENsYXNzKGV2YWx1YXRlKHRoaXMub3B0cy5kcm9wZG93bkNzc0NsYXNzLCB0aGlzLm9wdHMuZWxlbWVudCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBJRTgtMTAgKElFOS8xMCB3b24ndCBmaXJlIHByb3BlcnR5Q2hhbmdlIHZpYSBhdHRhY2hFdmVudExpc3RlbmVyKQogICAgICAgICAgICBpZiAoZWwubGVuZ3RoICYmIGVsWzBdLmF0dGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICBlbC5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBzZWxmLl9zeW5jKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzYWZhcmksIGNocm9tZSwgZmlyZWZveCwgSUUxMQogICAgICAgICAgICBvYnNlcnZlciA9IHdpbmRvdy5NdXRhdGlvbk9ic2VydmVyIHx8IHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyfHwgd2luZG93Lk1vek11dGF0aW9uT2JzZXJ2ZXI7CiAgICAgICAgICAgIGlmIChvYnNlcnZlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wcm9wZXJ0eU9ic2VydmVyKSB7IGRlbGV0ZSB0aGlzLnByb3BlcnR5T2JzZXJ2ZXI7IHRoaXMucHJvcGVydHlPYnNlcnZlciA9IG51bGw7IH0KICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydHlPYnNlcnZlciA9IG5ldyBvYnNlcnZlcihmdW5jdGlvbiAobXV0YXRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgJC5lYWNoKG11dGF0aW9ucywgc2VsZi5fc3luYyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydHlPYnNlcnZlci5vYnNlcnZlKGVsLmdldCgwKSwgeyBhdHRyaWJ1dGVzOnRydWUsIHN1YnRyZWU6ZmFsc2UgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIHRyaWdnZXJTZWxlY3Q6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgdmFyIGV2dCA9ICQuRXZlbnQoInNlbGVjdDItc2VsZWN0aW5nIiwgeyB2YWw6IHRoaXMuaWQoZGF0YSksIG9iamVjdDogZGF0YSwgY2hvaWNlOiBkYXRhIH0pOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKGV2dCk7CiAgICAgICAgICAgIHJldHVybiAhZXZ0LmlzRGVmYXVsdFByZXZlbnRlZCgpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRyaWdnZXJzIHRoZSBjaGFuZ2UgZXZlbnQgb24gdGhlIHNvdXJjZSBlbGVtZW50CiAgICAgICAgICovCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICB0cmlnZ2VyQ2hhbmdlOiBmdW5jdGlvbiAoZGV0YWlscykgewoKICAgICAgICAgICAgZGV0YWlscyA9IGRldGFpbHMgfHwge307CiAgICAgICAgICAgIGRldGFpbHM9ICQuZXh0ZW5kKHt9LCBkZXRhaWxzLCB7IHR5cGU6ICJjaGFuZ2UiLCB2YWw6IHRoaXMudmFsKCkgfSk7CiAgICAgICAgICAgIC8vIHByZXZlbnRzIHJlY3Vyc2l2ZSB0cmlnZ2VyaW5nCiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LmRhdGEoInNlbGVjdDItY2hhbmdlLXRyaWdnZXJlZCIsIHRydWUpOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKGRldGFpbHMpOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC5kYXRhKCJzZWxlY3QyLWNoYW5nZS10cmlnZ2VyZWQiLCBmYWxzZSk7CgogICAgICAgICAgICAvLyBzb21lIHZhbGlkYXRpb24gZnJhbWV3b3JrcyBpZ25vcmUgdGhlIGNoYW5nZSBldmVudCBhbmQgbGlzdGVuIGluc3RlYWQgdG8ga2V5dXAsIGNsaWNrIGZvciBzZWxlY3RzCiAgICAgICAgICAgIC8vIHNvIGhlcmUgd2UgdHJpZ2dlciB0aGUgY2xpY2sgZXZlbnQgbWFudWFsbHkKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuY2xpY2soKTsKCiAgICAgICAgICAgIC8vIFZhbGlkYXRpb25FbmdpbmUgaWdub3JlcyB0aGUgY2hhbmdlIGV2ZW50IGFuZCBsaXN0ZW5zIGluc3RlYWQgdG8gYmx1cgogICAgICAgICAgICAvLyBzbyBoZXJlIHdlIHRyaWdnZXIgdGhlIGJsdXIgZXZlbnQgbWFudWFsbHkgaWYgc28gZGVzaXJlZAogICAgICAgICAgICBpZiAodGhpcy5vcHRzLmJsdXJPbkNoYW5nZSkKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LmJsdXIoKTsKICAgICAgICB9LAoKICAgICAgICAvL2Fic3RyYWN0CiAgICAgICAgaXNJbnRlcmZhY2VFbmFibGVkOiBmdW5jdGlvbigpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lbmFibGVkSW50ZXJmYWNlID09PSB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZW5hYmxlSW50ZXJmYWNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGVuYWJsZWQgPSB0aGlzLl9lbmFibGVkICYmICF0aGlzLl9yZWFkb25seSwKICAgICAgICAgICAgICAgIGRpc2FibGVkID0gIWVuYWJsZWQ7CgogICAgICAgICAgICBpZiAoZW5hYmxlZCA9PT0gdGhpcy5lbmFibGVkSW50ZXJmYWNlKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci50b2dnbGVDbGFzcygic2VsZWN0Mi1jb250YWluZXItZGlzYWJsZWQiLCBkaXNhYmxlZCk7CiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgdGhpcy5lbmFibGVkSW50ZXJmYWNlID0gZW5hYmxlZDsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZW5hYmxlOiBmdW5jdGlvbihlbmFibGVkKSB7CiAgICAgICAgICAgIGlmIChlbmFibGVkID09PSB1bmRlZmluZWQpIGVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICBpZiAodGhpcy5fZW5hYmxlZCA9PT0gZW5hYmxlZCkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLl9lbmFibGVkID0gZW5hYmxlZDsKCiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnByb3AoImRpc2FibGVkIiwgIWVuYWJsZWQpOwogICAgICAgICAgICB0aGlzLmVuYWJsZUludGVyZmFjZSgpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlKGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIHJlYWRvbmx5OiBmdW5jdGlvbihlbmFibGVkKSB7CiAgICAgICAgICAgIGlmIChlbmFibGVkID09PSB1bmRlZmluZWQpIGVuYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXMuX3JlYWRvbmx5ID09PSBlbmFibGVkKSByZXR1cm47CiAgICAgICAgICAgIHRoaXMuX3JlYWRvbmx5ID0gZW5hYmxlZDsKCiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnByb3AoInJlYWRvbmx5IiwgZW5hYmxlZCk7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlSW50ZXJmYWNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBvcGVuZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLmNvbnRhaW5lcikgPyB0aGlzLmNvbnRhaW5lci5oYXNDbGFzcygic2VsZWN0Mi1kcm9wZG93bi1vcGVuIikgOiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIHBvc2l0aW9uRHJvcGRvd246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgJGRyb3Bkb3duID0gdGhpcy5kcm9wZG93biwKICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyLAogICAgICAgICAgICAgICAgb2Zmc2V0ID0gY29udGFpbmVyLm9mZnNldCgpLAogICAgICAgICAgICAgICAgaGVpZ2h0ID0gY29udGFpbmVyLm91dGVySGVpZ2h0KGZhbHNlKSwKICAgICAgICAgICAgICAgIHdpZHRoID0gY29udGFpbmVyLm91dGVyV2lkdGgoZmFsc2UpLAogICAgICAgICAgICAgICAgZHJvcEhlaWdodCA9ICRkcm9wZG93bi5vdXRlckhlaWdodChmYWxzZSksCiAgICAgICAgICAgICAgICAkd2luZG93ID0gJCh3aW5kb3cpLAogICAgICAgICAgICAgICAgd2luZG93V2lkdGggPSAkd2luZG93LndpZHRoKCksCiAgICAgICAgICAgICAgICB3aW5kb3dIZWlnaHQgPSAkd2luZG93LmhlaWdodCgpLAogICAgICAgICAgICAgICAgdmlld1BvcnRSaWdodCA9ICR3aW5kb3cuc2Nyb2xsTGVmdCgpICsgd2luZG93V2lkdGgsCiAgICAgICAgICAgICAgICB2aWV3cG9ydEJvdHRvbSA9ICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyB3aW5kb3dIZWlnaHQsCiAgICAgICAgICAgICAgICBkcm9wVG9wID0gb2Zmc2V0LnRvcCArIGhlaWdodCwKICAgICAgICAgICAgICAgIGRyb3BMZWZ0ID0gb2Zmc2V0LmxlZnQsCiAgICAgICAgICAgICAgICBlbm91Z2hSb29tQmVsb3cgPSBkcm9wVG9wICsgZHJvcEhlaWdodCA8PSB2aWV3cG9ydEJvdHRvbSwKICAgICAgICAgICAgICAgIGVub3VnaFJvb21BYm92ZSA9IChvZmZzZXQudG9wIC0gZHJvcEhlaWdodCkgPj0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKICAgICAgICAgICAgICAgIGRyb3BXaWR0aCA9ICRkcm9wZG93bi5vdXRlcldpZHRoKGZhbHNlKSwKICAgICAgICAgICAgICAgIGVub3VnaFJvb21PblJpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRyb3BMZWZ0ICsgZHJvcFdpZHRoIDw9IHZpZXdQb3J0UmlnaHQ7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZW5vdWdoUm9vbU9uTGVmdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvZmZzZXQubGVmdCArIHZpZXdQb3J0UmlnaHQgKyBjb250YWluZXIub3V0ZXJXaWR0aChmYWxzZSkgID4gZHJvcFdpZHRoOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGFib3ZlTm93ID0gJGRyb3Bkb3duLmhhc0NsYXNzKCJzZWxlY3QyLWRyb3AtYWJvdmUiKSwKICAgICAgICAgICAgICAgIGJvZHlPZmZzZXQsCiAgICAgICAgICAgICAgICBhYm92ZSwKICAgICAgICAgICAgICAgIGNoYW5nZURpcmVjdGlvbiwKICAgICAgICAgICAgICAgIGNzcywKICAgICAgICAgICAgICAgIHJlc3VsdHNMaXN0Tm9kZTsKCiAgICAgICAgICAgIC8vIGFsd2F5cyBwcmVmZXIgdGhlIGN1cnJlbnQgYWJvdmUvYmVsb3cgYWxpZ25tZW50LCB1bmxlc3MgdGhlcmUgaXMgbm90IGVub3VnaCByb29tCiAgICAgICAgICAgIGlmIChhYm92ZU5vdykgewogICAgICAgICAgICAgICAgYWJvdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKCFlbm91Z2hSb29tQWJvdmUgJiYgZW5vdWdoUm9vbUJlbG93KSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGlyZWN0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBhYm92ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWJvdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICghZW5vdWdoUm9vbUJlbG93ICYmIGVub3VnaFJvb21BYm92ZSkgewogICAgICAgICAgICAgICAgICAgIGNoYW5nZURpcmVjdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYWJvdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvL2lmIHdlIGFyZSBjaGFuZ2luZyBkaXJlY3Rpb24gd2UgbmVlZCB0byBnZXQgcG9zaXRpb25zIHdoZW4gZHJvcGRvd24gaXMgaGlkZGVuOwogICAgICAgICAgICBpZiAoY2hhbmdlRGlyZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAkZHJvcGRvd24uaGlkZSgpOwogICAgICAgICAgICAgICAgb2Zmc2V0ID0gdGhpcy5jb250YWluZXIub2Zmc2V0KCk7CiAgICAgICAgICAgICAgICBoZWlnaHQgPSB0aGlzLmNvbnRhaW5lci5vdXRlckhlaWdodChmYWxzZSk7CiAgICAgICAgICAgICAgICB3aWR0aCA9IHRoaXMuY29udGFpbmVyLm91dGVyV2lkdGgoZmFsc2UpOwogICAgICAgICAgICAgICAgZHJvcEhlaWdodCA9ICRkcm9wZG93bi5vdXRlckhlaWdodChmYWxzZSk7CiAgICAgICAgICAgICAgICB2aWV3UG9ydFJpZ2h0ID0gJHdpbmRvdy5zY3JvbGxMZWZ0KCkgKyB3aW5kb3dXaWR0aDsKICAgICAgICAgICAgICAgIHZpZXdwb3J0Qm90dG9tID0gJHdpbmRvdy5zY3JvbGxUb3AoKSArIHdpbmRvd0hlaWdodDsKICAgICAgICAgICAgICAgIGRyb3BUb3AgPSBvZmZzZXQudG9wICsgaGVpZ2h0OwogICAgICAgICAgICAgICAgZHJvcExlZnQgPSBvZmZzZXQubGVmdDsKICAgICAgICAgICAgICAgIGRyb3BXaWR0aCA9ICRkcm9wZG93bi5vdXRlcldpZHRoKGZhbHNlKTsKICAgICAgICAgICAgICAgICRkcm9wZG93bi5zaG93KCk7CgogICAgICAgICAgICAgICAgLy8gZml4IHNvIHRoZSBjdXJzb3IgZG9lcyBub3QgbW92ZSB0byB0aGUgbGVmdCB3aXRoaW4gdGhlIHNlYXJjaC10ZXh0Ym94IGluIElFCiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzU2VhcmNoKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuZHJvcGRvd25BdXRvV2lkdGgpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHNMaXN0Tm9kZSA9ICQoJy5zZWxlY3QyLXJlc3VsdHMnLCAkZHJvcGRvd24pWzBdOwogICAgICAgICAgICAgICAgJGRyb3Bkb3duLmFkZENsYXNzKCdzZWxlY3QyLWRyb3AtYXV0by13aWR0aCcpOwogICAgICAgICAgICAgICAgJGRyb3Bkb3duLmNzcygnd2lkdGgnLCAnJyk7CiAgICAgICAgICAgICAgICAvLyBBZGQgc2Nyb2xsYmFyIHdpZHRoIHRvIGRyb3Bkb3duIGlmIHZlcnRpY2FsIHNjcm9sbGJhciBpcyBwcmVzZW50CiAgICAgICAgICAgICAgICBkcm9wV2lkdGggPSAkZHJvcGRvd24ub3V0ZXJXaWR0aChmYWxzZSkgKyAocmVzdWx0c0xpc3ROb2RlLnNjcm9sbEhlaWdodCA9PT0gcmVzdWx0c0xpc3ROb2RlLmNsaWVudEhlaWdodCA\/IDAgOiBzY3JvbGxCYXJEaW1lbnNpb25zLndpZHRoKTsKICAgICAgICAgICAgICAgIGRyb3BXaWR0aCA+IHdpZHRoID8gd2lkdGggPSBkcm9wV2lkdGggOiBkcm9wV2lkdGggPSB3aWR0aDsKICAgICAgICAgICAgICAgIGRyb3BIZWlnaHQgPSAkZHJvcGRvd24ub3V0ZXJIZWlnaHQoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlQ2xhc3MoJ3NlbGVjdDItZHJvcC1hdXRvLXdpZHRoJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vY29uc29sZS5sb2coImJlbG93LyBkcm9wdG9wOiIsIGRyb3BUb3AsICJkcm9wSGVpZ2h0IiwgZHJvcEhlaWdodCwgInN1bSIsIChkcm9wVG9wK2Ryb3BIZWlnaHQpKyIgdmlld3BvcnQgYm90dG9tIiwgdmlld3BvcnRCb3R0b20sICJlbm91Z2g\/IiwgZW5vdWdoUm9vbUJlbG93KTsKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygiYWJvdmUvIG9mZnNldC50b3AiLCBvZmZzZXQudG9wLCAiZHJvcEhlaWdodCIsIGRyb3BIZWlnaHQsICJ0b3AiLCAob2Zmc2V0LnRvcC1kcm9wSGVpZ2h0KSwgInNjcm9sbFRvcCIsIHRoaXMuYm9keS5zY3JvbGxUb3AoKSwgImVub3VnaD8iLCBlbm91Z2hSb29tQWJvdmUpOwoKICAgICAgICAgICAgLy8gZml4IHBvc2l0aW9uaW5nIHdoZW4gYm9keSBoYXMgYW4gb2Zmc2V0IGFuZCBpcyBub3QgcG9zaXRpb246IHN0YXRpYwogICAgICAgICAgICBpZiAodGhpcy5ib2R5LmNzcygncG9zaXRpb24nKSAhPT0gJ3N0YXRpYycpIHsKICAgICAgICAgICAgICAgIGJvZHlPZmZzZXQgPSB0aGlzLmJvZHkub2Zmc2V0KCk7CiAgICAgICAgICAgICAgICBkcm9wVG9wIC09IGJvZHlPZmZzZXQudG9wOwogICAgICAgICAgICAgICAgZHJvcExlZnQgLT0gYm9keU9mZnNldC5sZWZ0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWVub3VnaFJvb21PblJpZ2h0KCkgJiYgZW5vdWdoUm9vbU9uTGVmdCgpKSB7CiAgICAgICAgICAgICAgICBkcm9wTGVmdCA9IG9mZnNldC5sZWZ0ICsgdGhpcy5jb250YWluZXIub3V0ZXJXaWR0aChmYWxzZSkgLSBkcm9wV2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNzcyA9ICB7CiAgICAgICAgICAgICAgICBsZWZ0OiBkcm9wTGVmdCwKICAgICAgICAgICAgICAgIHdpZHRoOiB3aWR0aAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGFib3ZlKSB7CiAgICAgICAgICAgICAgICBjc3MudG9wID0gb2Zmc2V0LnRvcCAtIGRyb3BIZWlnaHQ7CiAgICAgICAgICAgICAgICBjc3MuYm90dG9tID0gJ2F1dG8nOwogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuYWRkQ2xhc3MoInNlbGVjdDItZHJvcC1hYm92ZSIpOwogICAgICAgICAgICAgICAgJGRyb3Bkb3duLmFkZENsYXNzKCJzZWxlY3QyLWRyb3AtYWJvdmUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNzcy50b3AgPSBkcm9wVG9wOwogICAgICAgICAgICAgICAgY3NzLmJvdHRvbSA9ICdhdXRvJzsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWRyb3AtYWJvdmUiKTsKICAgICAgICAgICAgICAgICRkcm9wZG93bi5yZW1vdmVDbGFzcygic2VsZWN0Mi1kcm9wLWFib3ZlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3NzID0gJC5leHRlbmQoY3NzLCBldmFsdWF0ZSh0aGlzLm9wdHMuZHJvcGRvd25Dc3MsIHRoaXMub3B0cy5lbGVtZW50KSk7CgogICAgICAgICAgICAkZHJvcGRvd24uY3NzKGNzcyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBzaG91bGRPcGVuOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGV2ZW50OwoKICAgICAgICAgICAgaWYgKHRoaXMub3BlbmVkKCkpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9lbmFibGVkID09PSBmYWxzZSB8fCB0aGlzLl9yZWFkb25seSA9PT0gdHJ1ZSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgZXZlbnQgPSAkLkV2ZW50KCJzZWxlY3QyLW9wZW5pbmciKTsKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcihldmVudCk7CiAgICAgICAgICAgIHJldHVybiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBjbGVhckRyb3Bkb3duQWxpZ25tZW50UHJlZmVyZW5jZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIGNsZWFyIHRoZSBjbGFzc2VzIHVzZWQgdG8gZmlndXJlIG91dCB0aGUgcHJlZmVyZW5jZSBvZiB3aGVyZSB0aGUgZHJvcGRvd24gc2hvdWxkIGJlIG9wZW5lZAogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1kcm9wLWFib3ZlIik7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ucmVtb3ZlQ2xhc3MoInNlbGVjdDItZHJvcC1hYm92ZSIpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIE9wZW5zIHRoZSBkcm9wZG93bgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0gd2hldGhlciBvciBub3QgZHJvcGRvd24gd2FzIG9wZW5lZC4gVGhpcyBtZXRob2Qgd2lsbCByZXR1cm4gZmFsc2UgaWYsIGZvciBleGFtcGxlLAogICAgICAgICAqIHRoZSBkcm9wZG93biBpcyBhbHJlYWR5IG9wZW4sIG9yIGlmIHRoZSAnb3BlbicgZXZlbnQgbGlzdGVuZXIgb24gdGhlIGVsZW1lbnQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCkuCiAgICAgICAgICovCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBvcGVuOiBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICBpZiAoIXRoaXMuc2hvdWxkT3BlbigpKSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICB0aGlzLm9wZW5pbmcoKTsKCiAgICAgICAgICAgIC8vIE9ubHkgYmluZCB0aGUgZG9jdW1lbnQgbW91c2Vtb3ZlIHdoZW4gdGhlIGRyb3Bkb3duIGlzIHZpc2libGUKICAgICAgICAgICAgJGRvY3VtZW50Lm9uKCJtb3VzZW1vdmUuc2VsZWN0MkV2ZW50IiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGxhc3RNb3VzZVBvc2l0aW9uLnggPSBlLnBhZ2VYOwogICAgICAgICAgICAgICAgbGFzdE1vdXNlUG9zaXRpb24ueSA9IGUucGFnZVk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUGVyZm9ybXMgdGhlIG9wZW5pbmcgb2YgdGhlIGRyb3Bkb3duCiAgICAgICAgICovCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBvcGVuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNpZCA9IHRoaXMuY29udGFpbmVyRXZlbnROYW1lLAogICAgICAgICAgICAgICAgc2Nyb2xsID0gInNjcm9sbC4iICsgY2lkLAogICAgICAgICAgICAgICAgcmVzaXplID0gInJlc2l6ZS4iK2NpZCwKICAgICAgICAgICAgICAgIG9yaWVudCA9ICJvcmllbnRhdGlvbmNoYW5nZS4iK2NpZCwKICAgICAgICAgICAgICAgIG1hc2s7CgogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygic2VsZWN0Mi1kcm9wZG93bi1vcGVuIikuYWRkQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpOwoKICAgICAgICAgICAgdGhpcy5jbGVhckRyb3Bkb3duQWxpZ25tZW50UHJlZmVyZW5jZSgpOwoKICAgICAgICAgICAgaWYodGhpcy5kcm9wZG93blswXSAhPT0gdGhpcy5ib2R5LmNoaWxkcmVuKCkubGFzdCgpWzBdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmRldGFjaCgpLmFwcGVuZFRvKHRoaXMuYm9keSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgZHJvcGRvd24gbWFzayBpZiBkb2Vzbid0IGFscmVhZHkgZXhpc3QKICAgICAgICAgICAgbWFzayA9ICQoIiNzZWxlY3QyLWRyb3AtbWFzayIpOwogICAgICAgICAgICBpZiAobWFzay5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIG1hc2sgPSAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKICAgICAgICAgICAgICAgIG1hc2suYXR0cigiaWQiLCJzZWxlY3QyLWRyb3AtbWFzayIpLmF0dHIoImNsYXNzIiwic2VsZWN0Mi1kcm9wLW1hc2siKTsKICAgICAgICAgICAgICAgIG1hc2suaGlkZSgpOwogICAgICAgICAgICAgICAgbWFzay5hcHBlbmRUbyh0aGlzLmJvZHkpOwogICAgICAgICAgICAgICAgbWFzay5vbigibW91c2Vkb3duIHRvdWNoc3RhcnQgY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgSUUgZnJvbSBnZW5lcmF0aW5nIGEgY2xpY2sgZXZlbnQgb24gdGhlIGJvZHkKICAgICAgICAgICAgICAgICAgICByZWluc2VydEVsZW1lbnQobWFzayk7CgogICAgICAgICAgICAgICAgICAgIHZhciBkcm9wZG93biA9ICQoIiNzZWxlY3QyLWRyb3AiKSwgc2VsZjsKICAgICAgICAgICAgICAgICAgICBpZiAoZHJvcGRvd24ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmPWRyb3Bkb3duLmRhdGEoInNlbGVjdDIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYub3B0cy5zZWxlY3RPbkJsdXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2VsZWN0SGlnaGxpZ2h0ZWQoe25vRm9jdXM6IHRydWV9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZW5zdXJlIHRoZSBtYXNrIGlzIGFsd2F5cyByaWdodCBiZWZvcmUgdGhlIGRyb3Bkb3duCiAgICAgICAgICAgIGlmICh0aGlzLmRyb3Bkb3duLnByZXYoKVswXSAhPT0gbWFza1swXSkgewogICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5iZWZvcmUobWFzayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG1vdmUgdGhlIGdsb2JhbCBpZCB0byB0aGUgY29ycmVjdCBkcm9wZG93bgogICAgICAgICAgICAkKCIjc2VsZWN0Mi1kcm9wIikucmVtb3ZlQXR0cigiaWQiKTsKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5hdHRyKCJpZCIsICJzZWxlY3QyLWRyb3AiKTsKCiAgICAgICAgICAgIC8vIHNob3cgdGhlIGVsZW1lbnRzCiAgICAgICAgICAgIG1hc2suc2hvdygpOwoKICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkRyb3Bkb3duKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uc2hvdygpOwogICAgICAgICAgICB0aGlzLnBvc2l0aW9uRHJvcGRvd24oKTsKCiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uYWRkQ2xhc3MoInNlbGVjdDItZHJvcC1hY3RpdmUiKTsKCiAgICAgICAgICAgIC8vIGF0dGFjaCBsaXN0ZW5lcnMgdG8gZXZlbnRzIHRoYXQgY2FuIGNoYW5nZSB0aGUgcG9zaXRpb24gb2YgdGhlIGNvbnRhaW5lciBhbmQgdGh1cyByZXF1aXJlCiAgICAgICAgICAgIC8vIHRoZSBwb3NpdGlvbiBvZiB0aGUgZHJvcGRvd24gdG8gYmUgdXBkYXRlZCBhcyB3ZWxsIHNvIGl0IGRvZXMgbm90IGNvbWUgdW5nbHVlZCBmcm9tIHRoZSBjb250YWluZXIKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5wYXJlbnRzKCkuYWRkKHdpbmRvdykuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAkKHRoaXMpLm9uKHJlc2l6ZSsiICIrc2Nyb2xsKyIgIitvcmllbnQsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQub3BlbmVkKCkpIHRoYXQucG9zaXRpb25Ecm9wZG93bigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKCiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBjbG9zZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXRoaXMub3BlbmVkKCkpIHJldHVybjsKCiAgICAgICAgICAgIHZhciBjaWQgPSB0aGlzLmNvbnRhaW5lckV2ZW50TmFtZSwKICAgICAgICAgICAgICAgIHNjcm9sbCA9ICJzY3JvbGwuIiArIGNpZCwKICAgICAgICAgICAgICAgIHJlc2l6ZSA9ICJyZXNpemUuIitjaWQsCiAgICAgICAgICAgICAgICBvcmllbnQgPSAib3JpZW50YXRpb25jaGFuZ2UuIitjaWQ7CgogICAgICAgICAgICAvLyB1bmJpbmQgZXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnBhcmVudHMoKS5hZGQod2luZG93KS5lYWNoKGZ1bmN0aW9uICgpIHsgJCh0aGlzKS5vZmYoc2Nyb2xsKS5vZmYocmVzaXplKS5vZmYob3JpZW50KTsgfSk7CgogICAgICAgICAgICB0aGlzLmNsZWFyRHJvcGRvd25BbGlnbm1lbnRQcmVmZXJlbmNlKCk7CgogICAgICAgICAgICAkKCIjc2VsZWN0Mi1kcm9wLW1hc2siKS5oaWRlKCk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24ucmVtb3ZlQXR0cigiaWQiKTsgLy8gb25seSB0aGUgYWN0aXZlIGRyb3Bkb3duIGhhcyB0aGUgc2VsZWN0Mi1kcm9wIGlkCiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uaGlkZSgpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1kcm9wZG93bi1vcGVuIikucmVtb3ZlQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpOwogICAgICAgICAgICB0aGlzLnJlc3VsdHMuZW1wdHkoKTsKCiAgICAgICAgICAgIC8vIE5vdyB0aGF0IHRoZSBkcm9wZG93biBpcyBjbG9zZWQsIHVuYmluZCB0aGUgZ2xvYmFsIGRvY3VtZW50IG1vdXNlbW92ZSBldmVudAogICAgICAgICAgICAkZG9jdW1lbnQub2ZmKCJtb3VzZW1vdmUuc2VsZWN0MkV2ZW50Iik7CgogICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgIHRoaXMuc2VhcmNoLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWFjdGl2ZSIpOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCQuRXZlbnQoInNlbGVjdDItY2xvc2UiKSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogT3BlbnMgY29udHJvbCwgc2V0cyBpbnB1dCB2YWx1ZSwgYW5kIHVwZGF0ZXMgcmVzdWx0cy4KICAgICAgICAgKi8KICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGV4dGVybmFsU2VhcmNoOiBmdW5jdGlvbiAodGVybSkgewogICAgICAgICAgICB0aGlzLm9wZW4oKTsKICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHRlcm0pOwogICAgICAgICAgICB0aGlzLnVwZGF0ZVJlc3VsdHMoZmFsc2UpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgY2xlYXJTZWFyY2g6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgfSwKCiAgICAgICAgLy9hYnN0cmFjdAogICAgICAgIGdldE1heGltdW1TZWxlY3Rpb25TaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGV2YWx1YXRlKHRoaXMub3B0cy5tYXhpbXVtU2VsZWN0aW9uU2l6ZSwgdGhpcy5vcHRzLmVsZW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZW5zdXJlSGlnaGxpZ2h0VmlzaWJsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcmVzdWx0cyA9IHRoaXMucmVzdWx0cywgY2hpbGRyZW4sIGluZGV4LCBjaGlsZCwgaGIsIHJiLCB5LCBtb3JlLCB0b3BPZmZzZXQ7CgogICAgICAgICAgICBpbmRleCA9IHRoaXMuaGlnaGxpZ2h0KCk7CgogICAgICAgICAgICBpZiAoaW5kZXggPCAwKSByZXR1cm47CgogICAgICAgICAgICBpZiAoaW5kZXggPT0gMCkgewoKICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBmaXJzdCBlbGVtZW50IGlzIGhpZ2hsaWdodGVkIHNjcm9sbCBhbGwgdGhlIHdheSB0byB0aGUgdG9wLAogICAgICAgICAgICAgICAgLy8gdGhhdCB3YXkgYW55IHVuc2VsZWN0YWJsZSBoZWFkZXJzIGFib3ZlIGl0IHdpbGwgYWxzbyBiZSBzY3JvbGxlZAogICAgICAgICAgICAgICAgLy8gaW50byB2aWV3CgogICAgICAgICAgICAgICAgcmVzdWx0cy5zY3JvbGxUb3AoMCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkcmVuID0gdGhpcy5maW5kSGlnaGxpZ2h0YWJsZUNob2ljZXMoKS5maW5kKCcuc2VsZWN0Mi1yZXN1bHQtbGFiZWwnKTsKCiAgICAgICAgICAgIGNoaWxkID0gJChjaGlsZHJlbltpbmRleF0pOwoKICAgICAgICAgICAgdG9wT2Zmc2V0ID0gKGNoaWxkLm9mZnNldCgpIHx8IHt9KS50b3AgfHwgMDsKCiAgICAgICAgICAgIGhiID0gdG9wT2Zmc2V0ICsgY2hpbGQub3V0ZXJIZWlnaHQodHJ1ZSk7CgogICAgICAgICAgICAvLyBpZiB0aGlzIGlzIHRoZSBsYXN0IGNoaWxkIGxldHMgYWxzbyBtYWtlIHN1cmUgc2VsZWN0Mi1tb3JlLXJlc3VsdHMgaXMgdmlzaWJsZQogICAgICAgICAgICBpZiAoaW5kZXggPT09IGNoaWxkcmVuLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgIG1vcmUgPSByZXN1bHRzLmZpbmQoImxpLnNlbGVjdDItbW9yZS1yZXN1bHRzIik7CiAgICAgICAgICAgICAgICBpZiAobW9yZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaGIgPSBtb3JlLm9mZnNldCgpLnRvcCArIG1vcmUub3V0ZXJIZWlnaHQodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJiID0gcmVzdWx0cy5vZmZzZXQoKS50b3AgKyByZXN1bHRzLm91dGVySGVpZ2h0KGZhbHNlKTsKICAgICAgICAgICAgaWYgKGhiID4gcmIpIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMuc2Nyb2xsVG9wKHJlc3VsdHMuc2Nyb2xsVG9wKCkgKyAoaGIgLSByYikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHkgPSB0b3BPZmZzZXQgLSByZXN1bHRzLm9mZnNldCgpLnRvcDsKCiAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgdG9wIG9mIHRoZSBlbGVtZW50IGlzIHZpc2libGUKICAgICAgICAgICAgaWYgKHkgPCAwICYmIGNoaWxkLmNzcygnZGlzcGxheScpICE9ICdub25lJyApIHsKICAgICAgICAgICAgICAgIHJlc3VsdHMuc2Nyb2xsVG9wKHJlc3VsdHMuc2Nyb2xsVG9wKCkgKyB5KTsgLy8geSBpcyBuZWdhdGl2ZQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBmaW5kSGlnaGxpZ2h0YWJsZUNob2ljZXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN1bHRzLmZpbmQoIi5zZWxlY3QyLXJlc3VsdC1zZWxlY3RhYmxlOm5vdCguc2VsZWN0Mi1kaXNhYmxlZCk6bm90KC5zZWxlY3QyLXNlbGVjdGVkKSIpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgbW92ZUhpZ2hsaWdodDogZnVuY3Rpb24gKGRlbHRhKSB7CiAgICAgICAgICAgIHZhciBjaG9pY2VzID0gdGhpcy5maW5kSGlnaGxpZ2h0YWJsZUNob2ljZXMoKSwKICAgICAgICAgICAgICAgIGluZGV4ID0gdGhpcy5oaWdobGlnaHQoKTsKCiAgICAgICAgICAgIHdoaWxlIChpbmRleCA+IC0xICYmIGluZGV4IDwgY2hvaWNlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGluZGV4ICs9IGRlbHRhOwogICAgICAgICAgICAgICAgdmFyIGNob2ljZSA9ICQoY2hvaWNlc1tpbmRleF0pOwogICAgICAgICAgICAgICAgaWYgKGNob2ljZS5oYXNDbGFzcygic2VsZWN0Mi1yZXN1bHQtc2VsZWN0YWJsZSIpICYmICFjaG9pY2UuaGFzQ2xhc3MoInNlbGVjdDItZGlzYWJsZWQiKSAmJiAhY2hvaWNlLmhhc0NsYXNzKCJzZWxlY3QyLXNlbGVjdGVkIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZ2hsaWdodChpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGhpZ2hsaWdodDogZnVuY3Rpb24gKGluZGV4KSB7CiAgICAgICAgICAgIHZhciBjaG9pY2VzID0gdGhpcy5maW5kSGlnaGxpZ2h0YWJsZUNob2ljZXMoKSwKICAgICAgICAgICAgICAgIGNob2ljZSwKICAgICAgICAgICAgICAgIGRhdGE7CgogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4T2YoY2hvaWNlcy5maWx0ZXIoIi5zZWxlY3QyLWhpZ2hsaWdodGVkIilbMF0sIGNob2ljZXMuZ2V0KCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaW5kZXggPj0gY2hvaWNlcy5sZW5ndGgpIGluZGV4ID0gY2hvaWNlcy5sZW5ndGggLSAxOwogICAgICAgICAgICBpZiAoaW5kZXggPCAwKSBpbmRleCA9IDA7CgogICAgICAgICAgICB0aGlzLnJlbW92ZUhpZ2hsaWdodCgpOwoKICAgICAgICAgICAgY2hvaWNlID0gJChjaG9pY2VzW2luZGV4XSk7CiAgICAgICAgICAgIGNob2ljZS5hZGRDbGFzcygic2VsZWN0Mi1oaWdobGlnaHRlZCIpOwoKICAgICAgICAgICAgLy8gZW5zdXJlIGFzc2lzdGl2ZSB0ZWNobm9sb2d5IGNhbiBkZXRlcm1pbmUgdGhlIGFjdGl2ZSBjaG9pY2UKICAgICAgICAgICAgdGhpcy5zZWFyY2guYXR0cigiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwgY2hvaWNlLmZpbmQoIi5zZWxlY3QyLXJlc3VsdC1sYWJlbCIpLmF0dHIoImlkIikpOwoKICAgICAgICAgICAgdGhpcy5lbnN1cmVIaWdobGlnaHRWaXNpYmxlKCk7CgogICAgICAgICAgICB0aGlzLmxpdmVSZWdpb24udGV4dChjaG9pY2UudGV4dCgpKTsKCiAgICAgICAgICAgIGRhdGEgPSBjaG9pY2UuZGF0YSgic2VsZWN0Mi1kYXRhIik7CiAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKHsgdHlwZTogInNlbGVjdDItaGlnaGxpZ2h0IiwgdmFsOiB0aGlzLmlkKGRhdGEpLCBjaG9pY2U6IGRhdGEgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByZW1vdmVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnJlc3VsdHMuZmluZCgiLnNlbGVjdDItaGlnaGxpZ2h0ZWQiKS5yZW1vdmVDbGFzcygic2VsZWN0Mi1oaWdobGlnaHRlZCIpOwogICAgICAgIH0sCgogICAgICAgIHRvdWNoTW92ZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLl90b3VjaE1vdmVkID0gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICBjbGVhclRvdWNoTW92ZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5fdG91Y2hNb3ZlZCA9IGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgY291bnRTZWxlY3RhYmxlUmVzdWx0czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbmRIaWdobGlnaHRhYmxlQ2hvaWNlcygpLmxlbmd0aDsKICAgICAgICB9LAoKICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGhpZ2hsaWdodFVuZGVyRXZlbnQ6IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICB2YXIgZWwgPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgiLnNlbGVjdDItcmVzdWx0LXNlbGVjdGFibGUiKTsKICAgICAgICAgICAgaWYgKGVsLmxlbmd0aCA+IDAgJiYgIWVsLmlzKCIuc2VsZWN0Mi1oaWdobGlnaHRlZCIpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hvaWNlcyA9IHRoaXMuZmluZEhpZ2hsaWdodGFibGVDaG9pY2VzKCk7CiAgICAgICAgICAgICAgICB0aGlzLmhpZ2hsaWdodChjaG9pY2VzLmluZGV4KGVsKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWwubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgIC8vIGlmIHdlIGFyZSBvdmVyIGFuIHVuc2VsZWN0YWJsZSBpdGVtIHJlbW92ZSBhbGwgaGlnaGxpZ2h0cwogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVIaWdobGlnaHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgbG9hZE1vcmVJZk5lZWRlZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcmVzdWx0cyA9IHRoaXMucmVzdWx0cywKICAgICAgICAgICAgICAgIG1vcmUgPSByZXN1bHRzLmZpbmQoImxpLnNlbGVjdDItbW9yZS1yZXN1bHRzIiksCiAgICAgICAgICAgICAgICBiZWxvdywgLy8gcGl4ZWxzIHRoZSBlbGVtZW50IGlzIGJlbG93IHRoZSBzY3JvbGwgZm9sZCwgYmVsb3c9PTAgaXMgd2hlbiB0aGUgZWxlbWVudCBpcyBzdGFydGluZyB0byBiZSB2aXNpYmxlCiAgICAgICAgICAgICAgICBwYWdlID0gdGhpcy5yZXN1bHRzUGFnZSArIDEsCiAgICAgICAgICAgICAgICBzZWxmPXRoaXMsCiAgICAgICAgICAgICAgICB0ZXJtPXRoaXMuc2VhcmNoLnZhbCgpLAogICAgICAgICAgICAgICAgY29udGV4dD10aGlzLmNvbnRleHQ7CgogICAgICAgICAgICBpZiAobW9yZS5sZW5ndGggPT09IDApIHJldHVybjsKICAgICAgICAgICAgYmVsb3cgPSBtb3JlLm9mZnNldCgpLnRvcCAtIHJlc3VsdHMub2Zmc2V0KCkudG9wIC0gcmVzdWx0cy5oZWlnaHQoKTsKCiAgICAgICAgICAgIGlmIChiZWxvdyA8PSB0aGlzLm9wdHMubG9hZE1vcmVQYWRkaW5nKSB7CiAgICAgICAgICAgICAgICBtb3JlLmFkZENsYXNzKCJzZWxlY3QyLWFjdGl2ZSIpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRzLnF1ZXJ5KHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogdGhpcy5vcHRzLmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRlcm06IHRlcm0sCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2U6IHBhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXI6IHRoaXMub3B0cy5tYXRjaGVyLAogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdGhpcy5iaW5kKGZ1bmN0aW9uIChkYXRhKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZSBhIHJlc3BvbnNlIGlmIHRoZSBzZWxlY3QyIGhhcyBiZWVuIGNsb3NlZCBiZWZvcmUgaXQgd2FzIHJlY2VpdmVkCiAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWxmLm9wZW5lZCgpKSByZXR1cm47CgoKICAgICAgICAgICAgICAgICAgICBzZWxmLm9wdHMucG9wdWxhdGVSZXN1bHRzLmNhbGwodGhpcywgcmVzdWx0cywgZGF0YS5yZXN1bHRzLCB7dGVybTogdGVybSwgcGFnZTogcGFnZSwgY29udGV4dDpjb250ZXh0fSk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wb3N0cHJvY2Vzc1Jlc3VsdHMoZGF0YSwgZmFsc2UsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubW9yZT09PXRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbW9yZS5kZXRhY2goKS5hcHBlbmRUbyhyZXN1bHRzKS5odG1sKHNlbGYub3B0cy5lc2NhcGVNYXJrdXAoZXZhbHVhdGUoc2VsZi5vcHRzLmZvcm1hdExvYWRNb3JlLCBzZWxmLm9wdHMuZWxlbWVudCwgcGFnZSsxKSkpOwogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgc2VsZi5sb2FkTW9yZUlmTmVlZGVkKCk7IH0sIDEwKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtb3JlLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZWxmLnBvc2l0aW9uRHJvcGRvd24oKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlc3VsdHNQYWdlID0gcGFnZTsKICAgICAgICAgICAgICAgICAgICBzZWxmLmNvbnRleHQgPSBkYXRhLmNvbnRleHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcih7IHR5cGU6ICJzZWxlY3QyLWxvYWRlZCIsIGl0ZW1zOiBkYXRhIH0pOwogICAgICAgICAgICAgICAgfSl9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIERlZmF1bHQgdG9rZW5pemVyIGZ1bmN0aW9uIHdoaWNoIGRvZXMgbm90aGluZwogICAgICAgICAqLwogICAgICAgIHRva2VuaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQHBhcmFtIGluaXRpYWwgd2hldGhlciBvciBub3QgdGhpcyBpcyB0aGUgY2FsbCB0byB0aGlzIG1ldGhvZCByaWdodCBhZnRlciB0aGUgZHJvcGRvd24gaGFzIGJlZW4gb3BlbmVkCiAgICAgICAgICovCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICB1cGRhdGVSZXN1bHRzOiBmdW5jdGlvbiAoaW5pdGlhbCkgewogICAgICAgICAgICB2YXIgc2VhcmNoID0gdGhpcy5zZWFyY2gsCiAgICAgICAgICAgICAgICByZXN1bHRzID0gdGhpcy5yZXN1bHRzLAogICAgICAgICAgICAgICAgb3B0cyA9IHRoaXMub3B0cywKICAgICAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgICAgICBzZWxmID0gdGhpcywKICAgICAgICAgICAgICAgIGlucHV0LAogICAgICAgICAgICAgICAgdGVybSA9IHNlYXJjaC52YWwoKSwKICAgICAgICAgICAgICAgIGxhc3RUZXJtID0gJC5kYXRhKHRoaXMuY29udGFpbmVyLCAic2VsZWN0Mi1sYXN0LXRlcm0iKSwKICAgICAgICAgICAgICAgIC8vIHNlcXVlbmNlIG51bWJlciB1c2VkIHRvIGRyb3Agb3V0LW9mLW9yZGVyIHJlc3BvbnNlcwogICAgICAgICAgICAgICAgcXVlcnlOdW1iZXI7CgogICAgICAgICAgICAvLyBwcmV2ZW50IGR1cGxpY2F0ZSBxdWVyaWVzIGFnYWluc3QgdGhlIHNhbWUgdGVybQogICAgICAgICAgICBpZiAoaW5pdGlhbCAhPT0gdHJ1ZSAmJiBsYXN0VGVybSAmJiBlcXVhbCh0ZXJtLCBsYXN0VGVybSkpIHJldHVybjsKCiAgICAgICAgICAgICQuZGF0YSh0aGlzLmNvbnRhaW5lciwgInNlbGVjdDItbGFzdC10ZXJtIiwgdGVybSk7CgogICAgICAgICAgICAvLyBpZiB0aGUgc2VhcmNoIGlzIGN1cnJlbnRseSBoaWRkZW4gd2UgZG8gbm90IGFsdGVyIHRoZSByZXN1bHRzCiAgICAgICAgICAgIGlmIChpbml0aWFsICE9PSB0cnVlICYmICh0aGlzLnNob3dTZWFyY2hJbnB1dCA9PT0gZmFsc2UgfHwgIXRoaXMub3BlbmVkKCkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHBvc3RSZW5kZXIoKSB7CiAgICAgICAgICAgICAgICBzZWFyY2gucmVtb3ZlQ2xhc3MoInNlbGVjdDItYWN0aXZlIik7CiAgICAgICAgICAgICAgICBzZWxmLnBvc2l0aW9uRHJvcGRvd24oKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHRzLmZpbmQoJy5zZWxlY3QyLW5vLXJlc3VsdHMsLnNlbGVjdDItc2VsZWN0aW9uLWxpbWl0LC5zZWxlY3QyLXNlYXJjaGluZycpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHNlbGYubGl2ZVJlZ2lvbi50ZXh0KHJlc3VsdHMudGV4dCgpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNlbGYubGl2ZVJlZ2lvbi50ZXh0KHNlbGYub3B0cy5mb3JtYXRNYXRjaGVzKHJlc3VsdHMuZmluZCgnLnNlbGVjdDItcmVzdWx0LXNlbGVjdGFibGU6bm90KCIuc2VsZWN0Mi1zZWxlY3RlZCIpJykubGVuZ3RoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbmRlcihodG1sKSB7CiAgICAgICAgICAgICAgICByZXN1bHRzLmh0bWwoaHRtbCk7CiAgICAgICAgICAgICAgICBwb3N0UmVuZGVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHF1ZXJ5TnVtYmVyID0gKyt0aGlzLnF1ZXJ5Q291bnQ7CgogICAgICAgICAgICB2YXIgbWF4U2VsU2l6ZSA9IHRoaXMuZ2V0TWF4aW11bVNlbGVjdGlvblNpemUoKTsKICAgICAgICAgICAgaWYgKG1heFNlbFNpemUgPj0xKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5kYXRhKCk7CiAgICAgICAgICAgICAgICBpZiAoJC5pc0FycmF5KGRhdGEpICYmIGRhdGEubGVuZ3RoID49IG1heFNlbFNpemUgJiYgY2hlY2tGb3JtYXR0ZXIob3B0cy5mb3JtYXRTZWxlY3Rpb25Ub29CaWcsICJmb3JtYXRTZWxlY3Rpb25Ub29CaWciKSkgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcigiPGxpIGNsYXNzPSdzZWxlY3QyLXNlbGVjdGlvbi1saW1pdCc+IiArIGV2YWx1YXRlKG9wdHMuZm9ybWF0U2VsZWN0aW9uVG9vQmlnLCBvcHRzLmVsZW1lbnQsIG1heFNlbFNpemUpICsgIjwvbGk+Iik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VhcmNoLnZhbCgpLmxlbmd0aCA8IG9wdHMubWluaW11bUlucHV0TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAoY2hlY2tGb3JtYXR0ZXIob3B0cy5mb3JtYXRJbnB1dFRvb1Nob3J0LCAiZm9ybWF0SW5wdXRUb29TaG9ydCIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyKCI8bGkgY2xhc3M9J3NlbGVjdDItbm8tcmVzdWx0cyc+IiArIGV2YWx1YXRlKG9wdHMuZm9ybWF0SW5wdXRUb29TaG9ydCwgb3B0cy5lbGVtZW50LCBzZWFyY2gudmFsKCksIG9wdHMubWluaW11bUlucHV0TGVuZ3RoKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXIoIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluaXRpYWwgJiYgdGhpcy5zaG93U2VhcmNoKSB0aGlzLnNob3dTZWFyY2godHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRzLm1heGltdW1JbnB1dExlbmd0aCAmJiBzZWFyY2gudmFsKCkubGVuZ3RoID4gb3B0cy5tYXhpbXVtSW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChjaGVja0Zvcm1hdHRlcihvcHRzLmZvcm1hdElucHV0VG9vTG9uZywgImZvcm1hdElucHV0VG9vTG9uZyIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyKCI8bGkgY2xhc3M9J3NlbGVjdDItbm8tcmVzdWx0cyc+IiArIGV2YWx1YXRlKG9wdHMuZm9ybWF0SW5wdXRUb29Mb25nLCBvcHRzLmVsZW1lbnQsIHNlYXJjaC52YWwoKSwgb3B0cy5tYXhpbXVtSW5wdXRMZW5ndGgpICsgIjwvbGk+Iik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlbmRlcigiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRzLmZvcm1hdFNlYXJjaGluZyAmJiB0aGlzLmZpbmRIaWdobGlnaHRhYmxlQ2hvaWNlcygpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmVuZGVyKCI8bGkgY2xhc3M9J3NlbGVjdDItc2VhcmNoaW5nJz4iICsgZXZhbHVhdGUob3B0cy5mb3JtYXRTZWFyY2hpbmcsIG9wdHMuZWxlbWVudCkgKyAiPC9saT4iKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VhcmNoLmFkZENsYXNzKCJzZWxlY3QyLWFjdGl2ZSIpOwoKICAgICAgICAgICAgdGhpcy5yZW1vdmVIaWdobGlnaHQoKTsKCiAgICAgICAgICAgIC8vIGdpdmUgdGhlIHRva2VuaXplciBhIGNoYW5jZSB0byBwcmUtcHJvY2VzcyB0aGUgaW5wdXQKICAgICAgICAgICAgaW5wdXQgPSB0aGlzLnRva2VuaXplKCk7CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSB1bmRlZmluZWQgJiYgaW5wdXQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2VhcmNoLnZhbChpbnB1dCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMucmVzdWx0c1BhZ2UgPSAxOwoKICAgICAgICAgICAgb3B0cy5xdWVyeSh7CiAgICAgICAgICAgICAgICBlbGVtZW50OiBvcHRzLmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgdGVybTogc2VhcmNoLnZhbCgpLAogICAgICAgICAgICAgICAgICAgIHBhZ2U6IHRoaXMucmVzdWx0c1BhZ2UsCiAgICAgICAgICAgICAgICAgICAgY29udGV4dDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBtYXRjaGVyOiBvcHRzLm1hdGNoZXIsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHRoaXMuYmluZChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGRlZjsgLy8gZGVmYXVsdCBjaG9pY2UKCiAgICAgICAgICAgICAgICAvLyBpZ25vcmUgb2xkIHJlc3BvbnNlcwogICAgICAgICAgICAgICAgaWYgKHF1ZXJ5TnVtYmVyICE9IHRoaXMucXVlcnlDb3VudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gaWdub3JlIGEgcmVzcG9uc2UgaWYgdGhlIHNlbGVjdDIgaGFzIGJlZW4gY2xvc2VkIGJlZm9yZSBpdCB3YXMgcmVjZWl2ZWQKICAgICAgICAgICAgICAgIGlmICghdGhpcy5vcGVuZWQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWFjdGl2ZSIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBoYW5kbGUgYWpheCBlcnJvcgogICAgICAgICAgICAgICAgaWYoZGF0YS5oYXNFcnJvciAhPT0gdW5kZWZpbmVkICYmIGNoZWNrRm9ybWF0dGVyKG9wdHMuZm9ybWF0QWpheEVycm9yLCAiZm9ybWF0QWpheEVycm9yIikpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXIoIjxsaSBjbGFzcz0nc2VsZWN0Mi1hamF4LWVycm9yJz4iICsgZXZhbHVhdGUob3B0cy5mb3JtYXRBamF4RXJyb3IsIG9wdHMuZWxlbWVudCwgZGF0YS5qcVhIUiwgZGF0YS50ZXh0U3RhdHVzLCBkYXRhLmVycm9yVGhyb3duKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzYXZlIGNvbnRleHQsIGlmIGFueQogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gKGRhdGEuY29udGV4dD09PXVuZGVmaW5lZCkgPyBudWxsIDogZGF0YS5jb250ZXh0OwogICAgICAgICAgICAgICAgLy8gY3JlYXRlIGEgZGVmYXVsdCBjaG9pY2UgYW5kIHByZXBlbmQgaXQgdG8gdGhlIGxpc3QKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlICYmIHNlYXJjaC52YWwoKSAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICBkZWYgPSB0aGlzLm9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlLmNhbGwoc2VsZiwgc2VhcmNoLnZhbCgpLCBkYXRhLnJlc3VsdHMpOwogICAgICAgICAgICAgICAgICAgIGlmIChkZWYgIT09IHVuZGVmaW5lZCAmJiBkZWYgIT09IG51bGwgJiYgc2VsZi5pZChkZWYpICE9PSB1bmRlZmluZWQgJiYgc2VsZi5pZChkZWYpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKGRhdGEucmVzdWx0cykuZmlsdGVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlcXVhbChzZWxmLmlkKHRoaXMpLCBzZWxmLmlkKGRlZikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuY3JlYXRlU2VhcmNoQ2hvaWNlUG9zaXRpb24oZGF0YS5yZXN1bHRzLCBkZWYpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkYXRhLnJlc3VsdHMubGVuZ3RoID09PSAwICYmIGNoZWNrRm9ybWF0dGVyKG9wdHMuZm9ybWF0Tm9NYXRjaGVzLCAiZm9ybWF0Tm9NYXRjaGVzIikpIHsKICAgICAgICAgICAgICAgICAgICByZW5kZXIoIjxsaSBjbGFzcz0nc2VsZWN0Mi1uby1yZXN1bHRzJz4iICsgZXZhbHVhdGUob3B0cy5mb3JtYXROb01hdGNoZXMsIG9wdHMuZWxlbWVudCwgc2VhcmNoLnZhbCgpKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXN1bHRzLmVtcHR5KCk7CiAgICAgICAgICAgICAgICBzZWxmLm9wdHMucG9wdWxhdGVSZXN1bHRzLmNhbGwodGhpcywgcmVzdWx0cywgZGF0YS5yZXN1bHRzLCB7dGVybTogc2VhcmNoLnZhbCgpLCBwYWdlOiB0aGlzLnJlc3VsdHNQYWdlLCBjb250ZXh0Om51bGx9KTsKCiAgICAgICAgICAgICAgICBpZiAoZGF0YS5tb3JlID09PSB0cnVlICYmIGNoZWNrRm9ybWF0dGVyKG9wdHMuZm9ybWF0TG9hZE1vcmUsICJmb3JtYXRMb2FkTW9yZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoIjxsaSBjbGFzcz0nc2VsZWN0Mi1tb3JlLXJlc3VsdHMnPiIgKyBvcHRzLmVzY2FwZU1hcmt1cChldmFsdWF0ZShvcHRzLmZvcm1hdExvYWRNb3JlLCBvcHRzLmVsZW1lbnQsIHRoaXMucmVzdWx0c1BhZ2UpKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBzZWxmLmxvYWRNb3JlSWZOZWVkZWQoKTsgfSwgMTApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucG9zdHByb2Nlc3NSZXN1bHRzKGRhdGEsIGluaXRpYWwpOwoKICAgICAgICAgICAgICAgIHBvc3RSZW5kZXIoKTsKCiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKHsgdHlwZTogInNlbGVjdDItbG9hZGVkIiwgaXRlbXM6IGRhdGEgfSk7CiAgICAgICAgICAgIH0pfSk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgYmx1cjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBpZiBzZWxlY3RPbkJsdXIgPT0gdHJ1ZSwgc2VsZWN0IHRoZSBjdXJyZW50bHkgaGlnaGxpZ2h0ZWQgb3B0aW9uCiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuc2VsZWN0T25CbHVyKQogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RIaWdobGlnaHRlZCh7bm9Gb2N1czogdHJ1ZX0pOwoKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgIC8vIHN5bm9ueW1vdXMgdG8gLmlzKCc6Zm9jdXMnKSwgd2hpY2ggaXMgYXZhaWxhYmxlIGluIGpxdWVyeSA+PSAxLjYKICAgICAgICAgICAgaWYgKHRoaXMuc2VhcmNoWzBdID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7IHRoaXMuc2VhcmNoLmJsdXIoKTsgfQogICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UtZm9jdXMiKS5yZW1vdmVDbGFzcygic2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWZvY3VzIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBmb2N1c1NlYXJjaDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmb2N1cyh0aGlzLnNlYXJjaCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYWJzdHJhY3QKICAgICAgICBzZWxlY3RIaWdobGlnaHRlZDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3RvdWNoTW92ZWQpIHsKICAgICAgICAgICAgICB0aGlzLmNsZWFyVG91Y2hNb3ZlZCgpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5kZXg9dGhpcy5oaWdobGlnaHQoKSwKICAgICAgICAgICAgICAgIGhpZ2hsaWdodGVkPXRoaXMucmVzdWx0cy5maW5kKCIuc2VsZWN0Mi1oaWdobGlnaHRlZCIpLAogICAgICAgICAgICAgICAgZGF0YSA9IGhpZ2hsaWdodGVkLmNsb3Nlc3QoJy5zZWxlY3QyLXJlc3VsdCcpLmRhdGEoInNlbGVjdDItZGF0YSIpOwoKICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0KGluZGV4KTsKICAgICAgICAgICAgICAgIHRoaXMub25TZWxlY3QoZGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm5vRm9jdXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZ2V0UGxhY2Vob2xkZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBsYWNlaG9sZGVyT3B0aW9uOwogICAgICAgICAgICByZXR1cm4gdGhpcy5vcHRzLmVsZW1lbnQuYXR0cigicGxhY2Vob2xkZXIiKSB8fAogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuYXR0cigiZGF0YS1wbGFjZWhvbGRlciIpIHx8IC8vIGpxdWVyeSAxLjQgY29tcGF0CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC5kYXRhKCJwbGFjZWhvbGRlciIpIHx8CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMucGxhY2Vob2xkZXIgfHwKICAgICAgICAgICAgICAgICgocGxhY2Vob2xkZXJPcHRpb24gPSB0aGlzLmdldFBsYWNlaG9sZGVyT3B0aW9uKCkpICE9PSB1bmRlZmluZWQgPyBwbGFjZWhvbGRlck9wdGlvbi50ZXh0KCkgOiB1bmRlZmluZWQpOwogICAgICAgIH0sCgogICAgICAgIC8vIGFic3RyYWN0CiAgICAgICAgZ2V0UGxhY2Vob2xkZXJPcHRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHsKICAgICAgICAgICAgICAgIHZhciBmaXJzdE9wdGlvbiA9IHRoaXMuc2VsZWN0LmNoaWxkcmVuKCdvcHRpb24nKS5maXJzdCgpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5wbGFjZWhvbGRlck9wdGlvbiAhPT0gdW5kZWZpbmVkICkgewogICAgICAgICAgICAgICAgICAgIC8vRGV0ZXJtaW5lIHRoZSBwbGFjZWhvbGRlciBvcHRpb24gYmFzZWQgb24gdGhlIHNwZWNpZmllZCBwbGFjZWhvbGRlck9wdGlvbiBzZXR0aW5nCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLm9wdHMucGxhY2Vob2xkZXJPcHRpb24gPT09ICJmaXJzdCIgJiYgZmlyc3RPcHRpb24pIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlb2YgdGhpcy5vcHRzLnBsYWNlaG9sZGVyT3B0aW9uID09PSAiZnVuY3Rpb24iICYmIHRoaXMub3B0cy5wbGFjZWhvbGRlck9wdGlvbih0aGlzLnNlbGVjdCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkLnRyaW0oZmlyc3RPcHRpb24udGV4dCgpKSA9PT0gIiIgJiYgZmlyc3RPcHRpb24udmFsKCkgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgLy9ObyBleHBsaWNpdCBwbGFjZWhvbGRlciBvcHRpb24gc3BlY2lmaWVkLCB1c2UgdGhlIGZpcnN0IGlmIGl0J3MgYmxhbmsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3RPcHRpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBHZXQgdGhlIGRlc2lyZWQgd2lkdGggZm9yIHRoZSBjb250YWluZXIgZWxlbWVudC4gIFRoaXMgaXMKICAgICAgICAgKiBkZXJpdmVkIGZpcnN0IGZyb20gb3B0aW9uIGB3aWR0aGAgcGFzc2VkIHRvIHNlbGVjdDIsIHRoZW4KICAgICAgICAgKiB0aGUgaW5saW5lICdzdHlsZScgb24gdGhlIG9yaWdpbmFsIGVsZW1lbnQsIGFuZCBmaW5hbGx5CiAgICAgICAgICogZmFsbHMgYmFjayB0byB0aGUgalF1ZXJ5IGNhbGN1bGF0ZWQgZWxlbWVudCB3aWR0aC4KICAgICAgICAgKi8KICAgICAgICAvLyBhYnN0cmFjdAogICAgICAgIGluaXRDb250YWluZXJXaWR0aDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlQ29udGFpbmVyV2lkdGgoKSB7CiAgICAgICAgICAgICAgICB2YXIgc3R5bGUsIGF0dHJzLCBtYXRjaGVzLCBpLCBsLCBhdHRyOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMud2lkdGggPT09ICJvZmYiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy53aWR0aCA9PT0gImVsZW1lbnQiKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vcHRzLmVsZW1lbnQub3V0ZXJXaWR0aChmYWxzZSkgPT09IDAgPyAnYXV0bycgOiB0aGlzLm9wdHMuZWxlbWVudC5vdXRlcldpZHRoKGZhbHNlKSArICdweCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMub3B0cy53aWR0aCA9PT0gImNvcHkiIHx8IHRoaXMub3B0cy53aWR0aCA9PT0gInJlc29sdmUiKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgaW5saW5lIHN0eWxlIG9uIHRoZSBlbGVtZW50IHRoYXQgY29udGFpbnMgd2lkdGgKICAgICAgICAgICAgICAgICAgICBzdHlsZSA9IHRoaXMub3B0cy5lbGVtZW50LmF0dHIoJ3N0eWxlJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnMgPSBzdHlsZS5zcGxpdCgnOycpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gYXR0cnMubGVuZ3RoOyBpIDwgbDsgaSA9IGkgKyAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyID0gYXR0cnNbaV0ucmVwbGFjZSgvXHMvZywgJycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcyA9IGF0dHIubWF0Y2goL153aWR0aDooKFstK10\/KFswLTldKlwuKT9bMC05XSspKHB4fGVtfGV4fCV8aW58Y218bW18cHR8cGMpKS9pKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaGVzICE9PSBudWxsICYmIG1hdGNoZXMubGVuZ3RoID49IDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdHMud2lkdGggPT09ICJyZXNvbHZlIikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBuZXh0IGNoZWNrIGlmIGNzcygnd2lkdGgnKSBjYW4gcmVzb2x2ZSBhIHdpZHRoIHRoYXQgaXMgcGVyY2VudCBiYXNlZCwgdGhpcyBpcyBzb21ldGltZXMgcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBhdHRhY2hlZCB0byBpbnB1dCB0eXBlPWhpZGRlbiBvciBlbGVtZW50cyBoaWRkZW4gdmlhIGNzcwogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZSA9IHRoaXMub3B0cy5lbGVtZW50LmNzcygnd2lkdGgnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlLmluZGV4T2YoIiUiKSA+IDApIHJldHVybiBzdHlsZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpbmFsbHksIGZhbGxiYWNrIG9uIHRoZSBjYWxjdWxhdGVkIHdpZHRoIG9mIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5vcHRzLmVsZW1lbnQub3V0ZXJXaWR0aChmYWxzZSkgPT09IDAgPyAnYXV0bycgOiB0aGlzLm9wdHMuZWxlbWVudC5vdXRlcldpZHRoKGZhbHNlKSArICdweCcpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQuaXNGdW5jdGlvbih0aGlzLm9wdHMud2lkdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub3B0cy53aWR0aCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vcHRzLndpZHRoOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgd2lkdGggPSByZXNvbHZlQ29udGFpbmVyV2lkdGguY2FsbCh0aGlzKTsKICAgICAgICAgICAgaWYgKHdpZHRoICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jc3MoIndpZHRoIiwgd2lkdGgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgU2luZ2xlU2VsZWN0MiA9IGNsYXp6KEFic3RyYWN0U2VsZWN0MiwgewoKICAgICAgICAvLyBzaW5nbGUKCiAgICAgICAgY3JlYXRlQ29udGFpbmVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKS5hdHRyKHsKICAgICAgICAgICAgICAgICJjbGFzcyI6ICJzZWxlY3QyLWNvbnRhaW5lciIKICAgICAgICAgICAgfSkuaHRtbChbCiAgICAgICAgICAgICAgICAiPGEgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApJyBjbGFzcz0nc2VsZWN0Mi1jaG9pY2UnIHRhYmluZGV4PSctMSc+IiwKICAgICAgICAgICAgICAgICIgICA8c3BhbiBjbGFzcz0nc2VsZWN0Mi1jaG9zZW4nPiYjMTYwOzwvc3Bhbj48YWJiciBjbGFzcz0nc2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWNsb3NlJz48L2FiYnI+IiwKICAgICAgICAgICAgICAgICIgICA8c3BhbiBjbGFzcz0nc2VsZWN0Mi1hcnJvdycgcm9sZT0ncHJlc2VudGF0aW9uJz48YiByb2xlPSdwcmVzZW50YXRpb24nPjwvYj48L3NwYW4+IiwKICAgICAgICAgICAgICAgICI8L2E+IiwKICAgICAgICAgICAgICAgICI8bGFiZWwgZm9yPScnIGNsYXNzPSdzZWxlY3QyLW9mZnNjcmVlbic+PC9sYWJlbD4iLAogICAgICAgICAgICAgICAgIjxpbnB1dCBjbGFzcz0nc2VsZWN0Mi1mb2N1c3NlciBzZWxlY3QyLW9mZnNjcmVlbicgdHlwZT0ndGV4dCcgYXJpYS1oYXNwb3B1cD0ndHJ1ZScgcm9sZT0nYnV0dG9uJyAvPiIsCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz0nc2VsZWN0Mi1kcm9wIHNlbGVjdDItZGlzcGxheS1ub25lJz4iLAogICAgICAgICAgICAgICAgIiAgIDxkaXYgY2xhc3M9J3NlbGVjdDItc2VhcmNoJz4iLAogICAgICAgICAgICAgICAgIiAgICAgICA8bGFiZWwgZm9yPScnIGNsYXNzPSdzZWxlY3QyLW9mZnNjcmVlbic+PC9sYWJlbD4iLAogICAgICAgICAgICAgICAgIiAgICAgICA8aW5wdXQgdHlwZT0ndGV4dCcgYXV0b2NvbXBsZXRlPSdvZmYnIGF1dG9jb3JyZWN0PSdvZmYnIGF1dG9jYXBpdGFsaXplPSdvZmYnIHNwZWxsY2hlY2s9J2ZhbHNlJyBjbGFzcz0nc2VsZWN0Mi1pbnB1dCcgcm9sZT0nY29tYm9ib3gnIGFyaWEtZXhwYW5kZWQ9J3RydWUnIiwKICAgICAgICAgICAgICAgICIgICAgICAgYXJpYS1hdXRvY29tcGxldGU9J2xpc3QnIC8+IiwKICAgICAgICAgICAgICAgICIgICA8L2Rpdj4iLAogICAgICAgICAgICAgICAgIiAgIDx1bCBjbGFzcz0nc2VsZWN0Mi1yZXN1bHRzJyByb2xlPSdsaXN0Ym94Jz4iLAogICAgICAgICAgICAgICAgIiAgIDwvdWw+IiwKICAgICAgICAgICAgICAgICI8L2Rpdj4iXS5qb2luKCIiKSk7CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgZW5hYmxlSW50ZXJmYWNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50LmVuYWJsZUludGVyZmFjZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgb3BlbmluZzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWwsIHJhbmdlLCBsZW47CgogICAgICAgICAgICBpZiAodGhpcy5vcHRzLm1pbmltdW1SZXN1bHRzRm9yU2VhcmNoID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlYXJjaCh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wYXJlbnQub3BlbmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd1NlYXJjaElucHV0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgLy8gSUUgYXBwZW5kcyBmb2N1c3Nlci52YWwoKSBhdCB0aGUgZW5kIG9mIGZpZWxkIDovIHNvIHdlIG1hbnVhbGx5IGluc2VydCBpdCBhdCB0aGUgYmVnaW5uaW5nIHVzaW5nIGEgcmFuZ2UKICAgICAgICAgICAgICAgIC8vIGFsbCBvdGhlciBicm93c2VycyBoYW5kbGUgdGhpcyBqdXN0IGZpbmUKCiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC52YWwodGhpcy5mb2N1c3Nlci52YWwoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5zaG91bGRGb2N1c0lucHV0KHRoaXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC5mb2N1cygpOwogICAgICAgICAgICAgICAgLy8gbW92ZSB0aGUgY3Vyc29yIHRvIHRoZSBlbmQgYWZ0ZXIgZm9jdXNzaW5nLCBvdGhlcndpc2UgaXQgd2lsbCBiZSBhdCB0aGUgYmVnaW5uaW5nIGFuZAogICAgICAgICAgICAgICAgLy8gbmV3IHRleHQgd2lsbCBhcHBlYXIgKmJlZm9yZSogZm9jdXNzZXIudmFsKCkKICAgICAgICAgICAgICAgIGVsID0gdGhpcy5zZWFyY2guZ2V0KDApOwogICAgICAgICAgICAgICAgaWYgKGVsLmNyZWF0ZVRleHRSYW5nZSkgewogICAgICAgICAgICAgICAgICAgIHJhbmdlID0gZWwuY3JlYXRlVGV4dFJhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UuY29sbGFwc2UoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbC5zZXRTZWxlY3Rpb25SYW5nZSkgewogICAgICAgICAgICAgICAgICAgIGxlbiA9IHRoaXMuc2VhcmNoLnZhbCgpLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBlbC5zZXRTZWxlY3Rpb25SYW5nZShsZW4sIGxlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGluaXRpYWxpemVzIHNlYXJjaCdzIHZhbHVlIHdpdGggbmV4dFNlYXJjaFRlcm0gKGlmIGRlZmluZWQgYnkgdXNlcikKICAgICAgICAgICAgLy8gaWdub3JlIG5leHRTZWFyY2hUZXJtIGlmIHRoZSBkcm9wZG93biBpcyBvcGVuZWQgYnkgdGhlIHVzZXIgcHJlc3NpbmcgYSBsZXR0ZXIKICAgICAgICAgICAgaWYodGhpcy5zZWFyY2gudmFsKCkgPT09ICIiKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5leHRTZWFyY2hUZXJtICE9IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHRoaXMubmV4dFNlYXJjaFRlcm0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgdHJ1ZSkudmFsKCIiKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVSZXN1bHRzKHRydWUpOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCQuRXZlbnQoInNlbGVjdDItb3BlbiIpKTsKICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBjbG9zZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXRoaXMub3BlbmVkKCkpIHJldHVybjsKICAgICAgICAgICAgdGhpcy5wYXJlbnQuY2xvc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIucHJvcCgiZGlzYWJsZWQiLCBmYWxzZSk7CgogICAgICAgICAgICBpZiAodGhpcy5vcHRzLnNob3VsZEZvY3VzSW5wdXQodGhpcykpIHsKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIuZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIGZvY3VzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9wZW5lZCgpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5zaG91bGRGb2N1c0lucHV0KHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5mb2N1cygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgaXNGb2N1c2VkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lci5oYXNDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMucGFyZW50LmNhbmNlbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByb3AoImRpc2FibGVkIiwgZmFsc2UpOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5zaG91bGRGb2N1c0lucHV0KHRoaXMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLmZvY3VzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJCgibGFiZWxbZm9yPSciICsgdGhpcy5mb2N1c3Nlci5hdHRyKCdpZCcpICsgIiddIikKICAgICAgICAgICAgICAgIC5hdHRyKCdmb3InLCB0aGlzLm9wdHMuZWxlbWVudC5hdHRyKCJpZCIpKTsKICAgICAgICAgICAgdGhpcy5wYXJlbnQuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgY2xlYW51cEpRdWVyeUVsZW1lbnRzLmNhbGwodGhpcywKICAgICAgICAgICAgICAgICJzZWxlY3Rpb24iLAogICAgICAgICAgICAgICAgImZvY3Vzc2VyIgogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIGluaXRDb250YWluZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIHZhciBzZWxlY3Rpb24sCiAgICAgICAgICAgICAgICBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lciwKICAgICAgICAgICAgICAgIGRyb3Bkb3duID0gdGhpcy5kcm9wZG93biwKICAgICAgICAgICAgICAgIGlkU3VmZml4ID0gbmV4dFVpZCgpLAogICAgICAgICAgICAgICAgZWxlbWVudExhYmVsOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5taW5pbXVtUmVzdWx0c0ZvclNlYXJjaCA8IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlYXJjaChmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dTZWFyY2godHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uID0gc2VsZWN0aW9uID0gY29udGFpbmVyLmZpbmQoIi5zZWxlY3QyLWNob2ljZSIpOwoKICAgICAgICAgICAgdGhpcy5mb2N1c3NlciA9IGNvbnRhaW5lci5maW5kKCIuc2VsZWN0Mi1mb2N1c3NlciIpOwoKICAgICAgICAgICAgLy8gYWRkIGFyaWEgYXNzb2NpYXRpb25zCiAgICAgICAgICAgIHNlbGVjdGlvbi5maW5kKCIuc2VsZWN0Mi1jaG9zZW4iKS5hdHRyKCJpZCIsICJzZWxlY3QyLWNob3Nlbi0iK2lkU3VmZml4KTsKICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5hdHRyKCJhcmlhLWxhYmVsbGVkYnkiLCAic2VsZWN0Mi1jaG9zZW4tIitpZFN1ZmZpeCk7CiAgICAgICAgICAgIHRoaXMucmVzdWx0cy5hdHRyKCJpZCIsICJzZWxlY3QyLXJlc3VsdHMtIitpZFN1ZmZpeCk7CiAgICAgICAgICAgIHRoaXMuc2VhcmNoLmF0dHIoImFyaWEtb3ducyIsICJzZWxlY3QyLXJlc3VsdHMtIitpZFN1ZmZpeCk7CgogICAgICAgICAgICAvLyByZXdyaXRlIGxhYmVscyBmcm9tIG9yaWdpbmFsIGVsZW1lbnQgdG8gZm9jdXNzZXIKICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5hdHRyKCJpZCIsICJzMmlkX2F1dG9nZW4iK2lkU3VmZml4KTsKCiAgICAgICAgICAgIGVsZW1lbnRMYWJlbCA9ICQoImxhYmVsW2Zvcj0nIiArIHRoaXMub3B0cy5lbGVtZW50LmF0dHIoImlkIikgKyAiJ10iKTsKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuZm9jdXModGhpcy5iaW5kKGZ1bmN0aW9uICgpIHsgdGhpcy5mb2N1cygpOyB9KSk7CgogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLnByZXYoKQogICAgICAgICAgICAgICAgLnRleHQoZWxlbWVudExhYmVsLnRleHQoKSkKICAgICAgICAgICAgICAgIC5hdHRyKCdmb3InLCB0aGlzLmZvY3Vzc2VyLmF0dHIoJ2lkJykpOwoKICAgICAgICAgICAgLy8gRW5zdXJlIHRoZSBvcmlnaW5hbCBlbGVtZW50IHJldGFpbnMgYW4gYWNjZXNzaWJsZSBuYW1lCiAgICAgICAgICAgIHZhciBvcmlnaW5hbFRpdGxlID0gdGhpcy5vcHRzLmVsZW1lbnQuYXR0cigidGl0bGUiKTsKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQuYXR0cigidGl0bGUiLCAob3JpZ2luYWxUaXRsZSB8fCBlbGVtZW50TGFiZWwudGV4dCgpKSk7CgogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLmF0dHIoInRhYmluZGV4IiwgdGhpcy5lbGVtZW50VGFiSW5kZXgpOwoKICAgICAgICAgICAgLy8gd3JpdGUgbGFiZWwgZm9yIHNlYXJjaCBmaWVsZCB1c2luZyB0aGUgbGFiZWwgZnJvbSB0aGUgZm9jdXNzZXIgZWxlbWVudAogICAgICAgICAgICB0aGlzLnNlYXJjaC5hdHRyKCJpZCIsIHRoaXMuZm9jdXNzZXIuYXR0cignaWQnKSArICdfc2VhcmNoJyk7CgogICAgICAgICAgICB0aGlzLnNlYXJjaC5wcmV2KCkKICAgICAgICAgICAgICAgIC50ZXh0KCQoImxhYmVsW2Zvcj0nIiArIHRoaXMuZm9jdXNzZXIuYXR0cignaWQnKSArICInXSIpLnRleHQoKSkKICAgICAgICAgICAgICAgIC5hdHRyKCdmb3InLCB0aGlzLnNlYXJjaC5hdHRyKCdpZCcpKTsKCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLm9uKCJrZXlkb3duIiwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpIHJldHVybjsKCiAgICAgICAgICAgICAgICAvLyBmaWx0ZXIgMjI5IGtleUNvZGVzIChpbnB1dCBtZXRob2QgZWRpdG9yIGlzIHByb2Nlc3Npbmcga2V5IGlucHV0KQogICAgICAgICAgICAgICAgaWYgKDIyOSA9PSBlLmtleUNvZGUpIHJldHVybjsKCiAgICAgICAgICAgICAgICBpZiAoZS53aGljaCA9PT0gS0VZLlBBR0VfVVAgfHwgZS53aGljaCA9PT0gS0VZLlBBR0VfRE9XTikgewogICAgICAgICAgICAgICAgICAgIC8vIHByZXZlbnQgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcKICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHN3aXRjaCAoZS53aGljaCkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgS0VZLlVQOgogICAgICAgICAgICAgICAgICAgIGNhc2UgS0VZLkRPV046CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW92ZUhpZ2hsaWdodCgoZS53aGljaCA9PT0gS0VZLlVQKSA\/IC0xIDogMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNhc2UgS0VZLkVOVEVSOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEhpZ2hsaWdodGVkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGNhc2UgS0VZLlRBQjoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RIaWdobGlnaHRlZCh7bm9Gb2N1czogdHJ1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgY2FzZSBLRVkuRVNDOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbChlKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLm9uKCJibHVyIiwgdGhpcy5iaW5kKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIC8vIGEgd29ya2Fyb3VuZCBmb3IgY2hyb21lIHRvIGtlZXAgdGhlIHNlYXJjaCBmaWVsZCBmb2N1c3NlZCB3aGVuIHRoZSBzY3JvbGwgYmFyIGlzIHVzZWQgdG8gc2Nyb2xsIHRoZSBkcm9wZG93bi4KICAgICAgICAgICAgICAgIC8vIHdpdGhvdXQgdGhpcyB0aGUgc2VhcmNoIGZpZWxkIGxvc2VzIGZvY3VzIHdoaWNoIGlzIGFubm95aW5nCiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gdGhpcy5ib2R5LmdldCgwKSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KHRoaXMuYmluZChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3BlbmVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIub24oImtleWRvd24iLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09PSBLRVkuVEFCIHx8IEtFWS5pc0NvbnRyb2woZSkgfHwgS0VZLmlzRnVuY3Rpb25LZXkoZSkgfHwgZS53aGljaCA9PT0gS0VZLkVTQykgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLm9wZW5PbkVudGVyID09PSBmYWxzZSAmJiBlLndoaWNoID09PSBLRVkuRU5URVIpIHsKICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09IEtFWS5ET1dOIHx8IGUud2hpY2ggPT0gS0VZLlVQCiAgICAgICAgICAgICAgICAgICAgfHwgKGUud2hpY2ggPT0gS0VZLkVOVEVSICYmIHRoaXMub3B0cy5vcGVuT25FbnRlcikpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGUuYWx0S2V5IHx8IGUuY3RybEtleSB8fCBlLnNoaWZ0S2V5IHx8IGUubWV0YUtleSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW4oKTsKICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09IEtFWS5ERUxFVEUgfHwgZS53aGljaCA9PSBLRVkuQkFDS1NQQUNFKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5hbGxvd0NsZWFyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKCiAgICAgICAgICAgIGluc3RhbGxLZXlVcENoYW5nZUV2ZW50KHRoaXMuZm9jdXNzZXIpOwogICAgICAgICAgICB0aGlzLmZvY3Vzc2VyLm9uKCJrZXl1cC1jaGFuZ2UgaW5wdXQiLCB0aGlzLmJpbmQoZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5taW5pbXVtUmVzdWx0c0ZvclNlYXJjaCA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcGVuZWQoKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3BlbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICBzZWxlY3Rpb24ub24oIm1vdXNlZG93biB0b3VjaHN0YXJ0IiwgImFiYnIiLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICBraWxsRXZlbnRJbW1lZGlhdGVseShlKTsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGlvbi5mb2N1cygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICBzZWxlY3Rpb24ub24oIm1vdXNlZG93biB0b3VjaHN0YXJ0IiwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IElFIGZyb20gZ2VuZXJhdGluZyBhIGNsaWNrIGV2ZW50IG9uIHRoZSBib2R5CiAgICAgICAgICAgICAgICByZWluc2VydEVsZW1lbnQoc2VsZWN0aW9uKTsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyLmhhc0NsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1mb2N1cyIpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcGVuZWQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3BlbigpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgZHJvcGRvd24ub24oIm1vdXNlZG93biB0b3VjaHN0YXJ0IiwgdGhpcy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5zaG91bGRGb2N1c0lucHV0KHRoaXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2guZm9jdXMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgc2VsZWN0aW9uLm9uKCJmb2N1cyIsIHRoaXMuYmluZChmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIub24oImZvY3VzIiwgdGhpcy5iaW5kKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyLmhhc0NsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1mb2N1cyIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKTsKICAgICAgICAgICAgfSkpLm9uKCJibHVyIiwgdGhpcy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wZW5lZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1ibHVyIikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIHRoaXMuc2VhcmNoLm9uKCJmb2N1cyIsIHRoaXMuYmluZChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRhaW5lci5oYXNDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCQuRXZlbnQoInNlbGVjdDItZm9jdXMiKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygic2VsZWN0Mi1jb250YWluZXItYWN0aXZlIik7CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRoaXMuaW5pdENvbnRhaW5lcldpZHRoKCk7CiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LmhpZGUoKTsKICAgICAgICAgICAgdGhpcy5zZXRQbGFjZWhvbGRlcigpOwoKICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBjbGVhcjogZnVuY3Rpb24odHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICB2YXIgZGF0YT10aGlzLnNlbGVjdGlvbi5kYXRhKCJzZWxlY3QyLWRhdGEiKTsKICAgICAgICAgICAgaWYgKGRhdGEpIHsgLy8gZ3VhcmQgYWdhaW5zdCBxdWV1ZWQgcXVpY2sgY29uc2VjdXRpdmUgY2xpY2tzCiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gJC5FdmVudCgic2VsZWN0Mi1jbGVhcmluZyIpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcihldnQpOwogICAgICAgICAgICAgICAgaWYgKGV2dC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlck9wdGlvbiA9IHRoaXMuZ2V0UGxhY2Vob2xkZXJPcHRpb24oKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnZhbChwbGFjZWhvbGRlck9wdGlvbiA\/IHBsYWNlaG9sZGVyT3B0aW9uLnZhbCgpIDogIiIpOwogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24uZmluZCgiLnNlbGVjdDItY2hvc2VuIikuZW1wdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLnJlbW92ZURhdGEoInNlbGVjdDItZGF0YSIpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRQbGFjZWhvbGRlcigpOwoKICAgICAgICAgICAgICAgIGlmICh0cmlnZ2VyQ2hhbmdlICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcih7IHR5cGU6ICJzZWxlY3QyLXJlbW92ZWQiLCB2YWw6IHRoaXMuaWQoZGF0YSksIGNob2ljZTogZGF0YSB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2Uoe3JlbW92ZWQ6ZGF0YX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU2V0cyBzZWxlY3Rpb24gYmFzZWQgb24gc291cmNlIGVsZW1lbnQncyB2YWx1ZQogICAgICAgICAqLwogICAgICAgIC8vIHNpbmdsZQogICAgICAgIGluaXRTZWxlY3Rpb246IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkOwogICAgICAgICAgICBpZiAodGhpcy5pc1BsYWNlaG9sZGVyT3B0aW9uU2VsZWN0ZWQoKSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3Rpb24obnVsbCk7CiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNldFBsYWNlaG9sZGVyKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuaW5pdFNlbGVjdGlvbi5jYWxsKG51bGwsIHRoaXMub3B0cy5lbGVtZW50LCBmdW5jdGlvbihzZWxlY3RlZCl7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkICE9PSB1bmRlZmluZWQgJiYgc2VsZWN0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi51cGRhdGVTZWxlY3Rpb24oc2VsZWN0ZWQpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0UGxhY2Vob2xkZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5uZXh0U2VhcmNoVGVybSA9IHNlbGYub3B0cy5uZXh0U2VhcmNoVGVybShzZWxlY3RlZCwgc2VsZi5zZWFyY2gudmFsKCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgaXNQbGFjZWhvbGRlck9wdGlvblNlbGVjdGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHBsYWNlaG9sZGVyT3B0aW9uOwogICAgICAgICAgICBpZiAodGhpcy5nZXRQbGFjZWhvbGRlcigpID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsgLy8gbm8gcGxhY2Vob2xkZXIgc3BlY2lmaWVkIHNvIG5vIG9wdGlvbiBzaG91bGQgYmUgY29uc2lkZXJlZAogICAgICAgICAgICByZXR1cm4gKChwbGFjZWhvbGRlck9wdGlvbiA9IHRoaXMuZ2V0UGxhY2Vob2xkZXJPcHRpb24oKSkgIT09IHVuZGVmaW5lZCAmJiBwbGFjZWhvbGRlck9wdGlvbi5wcm9wKCJzZWxlY3RlZCIpKQogICAgICAgICAgICAgICAgfHwgKHRoaXMub3B0cy5lbGVtZW50LnZhbCgpID09PSAiIikKICAgICAgICAgICAgICAgIHx8ICh0aGlzLm9wdHMuZWxlbWVudC52YWwoKSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgfHwgKHRoaXMub3B0cy5lbGVtZW50LnZhbCgpID09PSBudWxsKTsKICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBwcmVwYXJlT3B0czogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgb3B0cyA9IHRoaXMucGFyZW50LnByZXBhcmVPcHRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICBzZWxmPXRoaXM7CgogICAgICAgICAgICBpZiAob3B0cy5lbGVtZW50LmdldCgwKS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICAvLyBpbnN0YWxsIHRoZSBzZWxlY3Rpb24gaW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgIG9wdHMuaW5pdFNlbGVjdGlvbiA9IGZ1bmN0aW9uIChlbGVtZW50LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IGVsZW1lbnQuZmluZCgib3B0aW9uIikuZmlsdGVyKGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5zZWxlY3RlZCAmJiAhdGhpcy5kaXNhYmxlZCB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBhIHNpbmdsZSBzZWxlY3QgYm94IGFsd2F5cyBoYXMgYSB2YWx1ZSwgbm8gbmVlZCB0byBudWxsIGNoZWNrICdzZWxlY3RlZCcKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhzZWxmLm9wdGlvblRvRGF0YShzZWxlY3RlZCkpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmICgiZGF0YSIgaW4gb3B0cykgewogICAgICAgICAgICAgICAgLy8gaW5zdGFsbCBkZWZhdWx0IGluaXRTZWxlY3Rpb24gd2hlbiBhcHBsaWVkIHRvIGhpZGRlbiBpbnB1dCBhbmQgZGF0YSBpcyBsb2NhbAogICAgICAgICAgICAgICAgb3B0cy5pbml0U2VsZWN0aW9uID0gb3B0cy5pbml0U2VsZWN0aW9uIHx8IGZ1bmN0aW9uIChlbGVtZW50LCBjYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IGVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgLy9zZWFyY2ggaW4gZGF0YSBieSBpZCwgc3RvcmluZyB0aGUgYWN0dWFsIG1hdGNoaW5nIGl0ZW0KICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBudWxsOwogICAgICAgICAgICAgICAgICAgIG9wdHMucXVlcnkoewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVyOiBmdW5jdGlvbih0ZXJtLCB0ZXh0LCBlbCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNfbWF0Y2ggPSBlcXVhbChpZCwgb3B0cy5pZChlbCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzX21hdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBlbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc19tYXRjaDsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6ICEkLmlzRnVuY3Rpb24oY2FsbGJhY2spID8gJC5ub29wIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhtYXRjaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvcHRzOwogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIGdldFBsYWNlaG9sZGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gaWYgYSBwbGFjZWhvbGRlciBpcyBzcGVjaWZpZWQgb24gYSBzaW5nbGUgc2VsZWN0IHdpdGhvdXQgYSB2YWxpZCBwbGFjZWhvbGRlciBvcHRpb24gaWdub3JlIGl0CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0UGxhY2Vob2xkZXJPcHRpb24oKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50LmdldFBsYWNlaG9sZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgc2V0UGxhY2Vob2xkZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5nZXRQbGFjZWhvbGRlcigpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaXNQbGFjZWhvbGRlck9wdGlvblNlbGVjdGVkKCkgJiYgcGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCkgewoKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBhIHBsYWNlaG9sZGVyIG9wdGlvbiBpZiBhdHRhY2hlZCB0byBhIHNlbGVjdAogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0ICYmIHRoaXMuZ2V0UGxhY2Vob2xkZXJPcHRpb24oKSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CgogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24uZmluZCgiLnNlbGVjdDItY2hvc2VuIikuaHRtbCh0aGlzLm9wdHMuZXNjYXBlTWFya3VwKHBsYWNlaG9sZGVyKSk7CgogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24uYWRkQ2xhc3MoInNlbGVjdDItZGVmYXVsdCIpOwoKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWFsbG93Y2xlYXIiKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIHBvc3Rwcm9jZXNzUmVzdWx0czogZnVuY3Rpb24gKGRhdGEsIGluaXRpYWwsIG5vSGlnaGxpZ2h0VXBkYXRlKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IDAsIHNlbGYgPSB0aGlzLCBzaG93U2VhcmNoSW5wdXQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gZmluZCB0aGUgc2VsZWN0ZWQgZWxlbWVudCBpbiB0aGUgcmVzdWx0IGxpc3QKCiAgICAgICAgICAgIHRoaXMuZmluZEhpZ2hsaWdodGFibGVDaG9pY2VzKCkuZWFjaDIoZnVuY3Rpb24gKGksIGVsbSkgewogICAgICAgICAgICAgICAgaWYgKGVxdWFsKHNlbGYuaWQoZWxtLmRhdGEoInNlbGVjdDItZGF0YSIpKSwgc2VsZi5vcHRzLmVsZW1lbnQudmFsKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBhbmQgaGlnaGxpZ2h0IGl0CiAgICAgICAgICAgIGlmIChub0hpZ2hsaWdodFVwZGF0ZSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGlmIChpbml0aWFsID09PSB0cnVlICYmIHNlbGVjdGVkID49IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZ2hsaWdodChzZWxlY3RlZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0KDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBoaWRlIHRoZSBzZWFyY2ggYm94IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHdlIGdvdCB0aGUgcmVzdWx0cyBhbmQgdGhlcmUgYXJlIGVub3VnaCBvZiB0aGVtIGZvciBzZWFyY2gKCiAgICAgICAgICAgIGlmIChpbml0aWFsID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgbWluID0gdGhpcy5vcHRzLm1pbmltdW1SZXN1bHRzRm9yU2VhcmNoOwogICAgICAgICAgICAgICAgaWYgKG1pbiA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93U2VhcmNoKGNvdW50UmVzdWx0cyhkYXRhLnJlc3VsdHMpID49IG1pbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBzaG93U2VhcmNoOiBmdW5jdGlvbihzaG93U2VhcmNoSW5wdXQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2hvd1NlYXJjaElucHV0ID09PSBzaG93U2VhcmNoSW5wdXQpIHJldHVybjsKCiAgICAgICAgICAgIHRoaXMuc2hvd1NlYXJjaElucHV0ID0gc2hvd1NlYXJjaElucHV0OwoKICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5maW5kKCIuc2VsZWN0Mi1zZWFyY2giKS50b2dnbGVDbGFzcygic2VsZWN0Mi1zZWFyY2gtaGlkZGVuIiwgIXNob3dTZWFyY2hJbnB1dCk7CiAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uZmluZCgiLnNlbGVjdDItc2VhcmNoIikudG9nZ2xlQ2xhc3MoInNlbGVjdDItb2Zmc2NyZWVuIiwgIXNob3dTZWFyY2hJbnB1dCk7CiAgICAgICAgICAgIC8vYWRkICJzZWxlY3QyLXdpdGgtc2VhcmNoYm94IiB0byB0aGUgY29udGFpbmVyIGlmIHNlYXJjaCBib3ggaXMgc2hvd24KICAgICAgICAgICAgJCh0aGlzLmRyb3Bkb3duLCB0aGlzLmNvbnRhaW5lcikudG9nZ2xlQ2xhc3MoInNlbGVjdDItd2l0aC1zZWFyY2hib3giLCBzaG93U2VhcmNoSW5wdXQpOwogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIG9uU2VsZWN0OiBmdW5jdGlvbiAoZGF0YSwgb3B0aW9ucykgewoKICAgICAgICAgICAgaWYgKCF0aGlzLnRyaWdnZXJTZWxlY3QoZGF0YSkpIHsgcmV0dXJuOyB9CgogICAgICAgICAgICB2YXIgb2xkID0gdGhpcy5vcHRzLmVsZW1lbnQudmFsKCksCiAgICAgICAgICAgICAgICBvbGREYXRhID0gdGhpcy5kYXRhKCk7CgogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC52YWwodGhpcy5pZChkYXRhKSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0aW9uKGRhdGEpOwoKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcih7IHR5cGU6ICJzZWxlY3QyLXNlbGVjdGVkIiwgdmFsOiB0aGlzLmlkKGRhdGEpLCBjaG9pY2U6IGRhdGEgfSk7CgogICAgICAgICAgICB0aGlzLm5leHRTZWFyY2hUZXJtID0gdGhpcy5vcHRzLm5leHRTZWFyY2hUZXJtKGRhdGEsIHRoaXMuc2VhcmNoLnZhbCgpKTsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwoKICAgICAgICAgICAgaWYgKCghb3B0aW9ucyB8fCAhb3B0aW9ucy5ub0ZvY3VzKSAmJiB0aGlzLm9wdHMuc2hvdWxkRm9jdXNJbnB1dCh0aGlzKSkgewogICAgICAgICAgICAgICAgdGhpcy5mb2N1c3Nlci5mb2N1cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWVxdWFsKG9sZCwgdGhpcy5pZChkYXRhKSkpIHsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckNoYW5nZSh7IGFkZGVkOiBkYXRhLCByZW1vdmVkOiBvbGREYXRhIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gc2luZ2xlCiAgICAgICAgdXBkYXRlU2VsZWN0aW9uOiBmdW5jdGlvbiAoZGF0YSkgewoKICAgICAgICAgICAgdmFyIGNvbnRhaW5lcj10aGlzLnNlbGVjdGlvbi5maW5kKCIuc2VsZWN0Mi1jaG9zZW4iKSwgZm9ybWF0dGVkLCBjc3NDbGFzczsKCiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmRhdGEoInNlbGVjdDItZGF0YSIsIGRhdGEpOwoKICAgICAgICAgICAgY29udGFpbmVyLmVtcHR5KCk7CiAgICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQ9dGhpcy5vcHRzLmZvcm1hdFNlbGVjdGlvbihkYXRhLCBjb250YWluZXIsIHRoaXMub3B0cy5lc2NhcGVNYXJrdXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3JtYXR0ZWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZChmb3JtYXR0ZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNzc0NsYXNzPXRoaXMub3B0cy5mb3JtYXRTZWxlY3Rpb25Dc3NDbGFzcyhkYXRhLCBjb250YWluZXIpOwogICAgICAgICAgICBpZiAoY3NzQ2xhc3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKGNzc0NsYXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24ucmVtb3ZlQ2xhc3MoInNlbGVjdDItZGVmYXVsdCIpOwoKICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5hbGxvd0NsZWFyICYmIHRoaXMuZ2V0UGxhY2Vob2xkZXIoKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygic2VsZWN0Mi1hbGxvd2NsZWFyIik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICB2YWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbCwKICAgICAgICAgICAgICAgIHRyaWdnZXJDaGFuZ2UgPSBmYWxzZSwKICAgICAgICAgICAgICAgIGRhdGEgPSBudWxsLAogICAgICAgICAgICAgICAgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICBvbGREYXRhID0gdGhpcy5kYXRhKCk7CgogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub3B0cy5lbGVtZW50LnZhbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YWwgPSBhcmd1bWVudHNbMF07CgogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJDaGFuZ2UgPSBhcmd1bWVudHNbMV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QKICAgICAgICAgICAgICAgICAgICAudmFsKHZhbCkKICAgICAgICAgICAgICAgICAgICAuZmluZCgib3B0aW9uIikuZmlsdGVyKGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5zZWxlY3RlZCB9KS5lYWNoMihmdW5jdGlvbiAoaSwgZWxtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBzZWxmLm9wdGlvblRvRGF0YShlbG0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGlvbihkYXRhKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0UGxhY2Vob2xkZXIoKTsKICAgICAgICAgICAgICAgIGlmICh0cmlnZ2VyQ2hhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyQ2hhbmdlKHthZGRlZDogZGF0YSwgcmVtb3ZlZDpvbGREYXRhfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyB2YWwgaXMgYW4gaWQuICF2YWwgaXMgdHJ1ZSBmb3IgW3VuZGVmaW5lZCxudWxsLCcnLDBdIC0gMCBpcyBsZWdhbAogICAgICAgICAgICAgICAgaWYgKCF2YWwgJiYgdmFsICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhcih0cmlnZ2VyQ2hhbmdlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLmluaXRTZWxlY3Rpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IGNhbGwgdmFsKCkgaWYgaW5pdFNlbGVjdGlvbigpIGlzIG5vdCBkZWZpbmVkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC52YWwodmFsKTsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5pbml0U2VsZWN0aW9uKHRoaXMub3B0cy5lbGVtZW50LCBmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgICAgICAgICBzZWxmLm9wdHMuZWxlbWVudC52YWwoIWRhdGEgPyAiIiA6IHNlbGYuaWQoZGF0YSkpOwogICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlU2VsZWN0aW9uKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0UGxhY2Vob2xkZXIoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyaWdnZXJDaGFuZ2Uoe2FkZGVkOiBkYXRhLCByZW1vdmVkOm9sZERhdGF9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIHNpbmdsZQogICAgICAgIGNsZWFyU2VhcmNoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuc2VhcmNoLnZhbCgiIik7CiAgICAgICAgICAgIHRoaXMuZm9jdXNzZXIudmFsKCIiKTsKICAgICAgICB9LAoKICAgICAgICAvLyBzaW5nbGUKICAgICAgICBkYXRhOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB2YXIgZGF0YSwKICAgICAgICAgICAgICAgIHRyaWdnZXJDaGFuZ2UgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5zZWxlY3Rpb24uZGF0YSgic2VsZWN0Mi1kYXRhIik7CiAgICAgICAgICAgICAgICBpZiAoZGF0YSA9PSB1bmRlZmluZWQpIGRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyQ2hhbmdlID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXIodHJpZ2dlckNoYW5nZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLmRhdGEoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC52YWwoIXZhbHVlID8gIiIgOiB0aGlzLmlkKHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTZWxlY3Rpb24odmFsdWUpOwogICAgICAgICAgICAgICAgICAgIGlmICh0cmlnZ2VyQ2hhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckNoYW5nZSh7YWRkZWQ6IHZhbHVlLCByZW1vdmVkOmRhdGF9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICBNdWx0aVNlbGVjdDIgPSBjbGF6eihBYnN0cmFjdFNlbGVjdDIsIHsKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBjcmVhdGVDb250YWluZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9ICQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpLmF0dHIoewogICAgICAgICAgICAgICAgImNsYXNzIjogInNlbGVjdDItY29udGFpbmVyIHNlbGVjdDItY29udGFpbmVyLW11bHRpIgogICAgICAgICAgICB9KS5odG1sKFsKICAgICAgICAgICAgICAgICI8dWwgY2xhc3M9J3NlbGVjdDItY2hvaWNlcyc+IiwKICAgICAgICAgICAgICAgICIgIDxsaSBjbGFzcz0nc2VsZWN0Mi1zZWFyY2gtZmllbGQnPiIsCiAgICAgICAgICAgICAgICAiICAgIDxsYWJlbCBmb3I9JycgY2xhc3M9J3NlbGVjdDItb2Zmc2NyZWVuJz48L2xhYmVsPiIsCiAgICAgICAgICAgICAgICAiICAgIDxpbnB1dCB0eXBlPSd0ZXh0JyBhdXRvY29tcGxldGU9J29mZicgYXV0b2NvcnJlY3Q9J29mZicgYXV0b2NhcGl0YWxpemU9J29mZicgc3BlbGxjaGVjaz0nZmFsc2UnIGNsYXNzPSdzZWxlY3QyLWlucHV0Jz4iLAogICAgICAgICAgICAgICAgIiAgPC9saT4iLAogICAgICAgICAgICAgICAgIjwvdWw+IiwKICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPSdzZWxlY3QyLWRyb3Agc2VsZWN0Mi1kcm9wLW11bHRpIHNlbGVjdDItZGlzcGxheS1ub25lJz4iLAogICAgICAgICAgICAgICAgIiAgIDx1bCBjbGFzcz0nc2VsZWN0Mi1yZXN1bHRzJz4iLAogICAgICAgICAgICAgICAgIiAgIDwvdWw+IiwKICAgICAgICAgICAgICAgICI8L2Rpdj4iXS5qb2luKCIiKSk7CiAgICAgICAgICAgIHJldHVybiBjb250YWluZXI7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBwcmVwYXJlT3B0czogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgb3B0cyA9IHRoaXMucGFyZW50LnByZXBhcmVPcHRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICBzZWxmPXRoaXM7CgogICAgICAgICAgICAvLyBUT0RPIHZhbGlkYXRlIHBsYWNlaG9sZGVyIGlzIGEgc3RyaW5nIGlmIHNwZWNpZmllZAogICAgICAgICAgICBpZiAob3B0cy5lbGVtZW50LmdldCgwKS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICAvLyBpbnN0YWxsIHRoZSBzZWxlY3Rpb24gaW5pdGlhbGl6ZXIKICAgICAgICAgICAgICAgIG9wdHMuaW5pdFNlbGVjdGlvbiA9IGZ1bmN0aW9uIChlbGVtZW50LCBjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IFtdOwoKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoIm9wdGlvbiIpLmZpbHRlcihmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuc2VsZWN0ZWQgJiYgIXRoaXMuZGlzYWJsZWQgfSkuZWFjaDIoZnVuY3Rpb24gKGksIGVsbSkgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goc2VsZi5vcHRpb25Ub0RhdGEoZWxtKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgaWYgKCJkYXRhIiBpbiBvcHRzKSB7CiAgICAgICAgICAgICAgICAvLyBpbnN0YWxsIGRlZmF1bHQgaW5pdFNlbGVjdGlvbiB3aGVuIGFwcGxpZWQgdG8gaGlkZGVuIGlucHV0IGFuZCBkYXRhIGlzIGxvY2FsCiAgICAgICAgICAgICAgICBvcHRzLmluaXRTZWxlY3Rpb24gPSBvcHRzLmluaXRTZWxlY3Rpb24gfHwgZnVuY3Rpb24gKGVsZW1lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlkcyA9IHNwbGl0VmFsKGVsZW1lbnQudmFsKCksIG9wdHMuc2VwYXJhdG9yLCBvcHRzLnRyYW5zZm9ybVZhbCk7CiAgICAgICAgICAgICAgICAgICAgLy9zZWFyY2ggaW4gZGF0YSBieSBhcnJheSBvZiBpZHMsIHN0b3JpbmcgbWF0Y2hpbmcgaXRlbXMgaW4gYSBsaXN0CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBvcHRzLnF1ZXJ5KHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcjogZnVuY3Rpb24odGVybSwgdGV4dCwgZWwpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlzX21hdGNoID0gJC5ncmVwKGlkcywgZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXF1YWwoaWQsIG9wdHMuaWQoZWwpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc19tYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaChlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNfbWF0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiAhJC5pc0Z1bmN0aW9uKGNhbGxiYWNrKSA\/ICQubm9vcCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVvcmRlciBtYXRjaGVzIGJhc2VkIG9uIHRoZSBvcmRlciB0aGV5IGFwcGVhciBpbiB0aGUgaWRzIGFycmF5IGJlY2F1c2UgcmlnaHQgbm93CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGV5IGFyZSBpbiB0aGUgb3JkZXIgaW4gd2hpY2ggdGhleSBhcHBlYXIgaW4gZGF0YSBhcnJheQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9yZGVyZWQgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gaWRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbWF0Y2hlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBtYXRjaGVzW2pdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXF1YWwoaWQsIG9wdHMuaWQobWF0Y2gpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JkZXJlZC5wdXNoKG1hdGNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMuc3BsaWNlKGosIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhvcmRlcmVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG9wdHM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBzZWxlY3RDaG9pY2U6IGZ1bmN0aW9uIChjaG9pY2UpIHsKCiAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHRoaXMuY29udGFpbmVyLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UtZm9jdXMiKTsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkLmxlbmd0aCAmJiBjaG9pY2UgJiYgY2hvaWNlWzBdID09IHNlbGVjdGVkWzBdKSB7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoImNob2ljZS1kZXNlbGVjdGVkIiwgc2VsZWN0ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZWN0ZWQucmVtb3ZlQ2xhc3MoInNlbGVjdDItc2VhcmNoLWNob2ljZS1mb2N1cyIpOwogICAgICAgICAgICAgICAgaWYgKGNob2ljZSAmJiBjaG9pY2UubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgIGNob2ljZS5hZGRDbGFzcygic2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWZvY3VzIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcigiY2hvaWNlLXNlbGVjdGVkIiwgY2hvaWNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQoImxhYmVsW2Zvcj0nIiArIHRoaXMuc2VhcmNoLmF0dHIoJ2lkJykgKyAiJ10iKQogICAgICAgICAgICAgICAgLmF0dHIoJ2ZvcicsIHRoaXMub3B0cy5lbGVtZW50LmF0dHIoImlkIikpOwogICAgICAgICAgICB0aGlzLnBhcmVudC5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgICAgICBjbGVhbnVwSlF1ZXJ5RWxlbWVudHMuY2FsbCh0aGlzLAogICAgICAgICAgICAgICAgInNlYXJjaENvbnRhaW5lciIsCiAgICAgICAgICAgICAgICAic2VsZWN0aW9uIgogICAgICAgICAgICApOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgaW5pdENvbnRhaW5lcjogZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgdmFyIHNlbGVjdG9yID0gIi5zZWxlY3QyLWNob2ljZXMiLCBzZWxlY3Rpb247CgogICAgICAgICAgICB0aGlzLnNlYXJjaENvbnRhaW5lciA9IHRoaXMuY29udGFpbmVyLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1maWVsZCIpOwogICAgICAgICAgICB0aGlzLnNlbGVjdGlvbiA9IHNlbGVjdGlvbiA9IHRoaXMuY29udGFpbmVyLmZpbmQoc2VsZWN0b3IpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24ub24oImNsaWNrIiwgIi5zZWxlY3QyLWNvbnRhaW5lcjpub3QoLnNlbGVjdDItY29udGFpbmVyLWRpc2FibGVkKSAuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlOm5vdCguc2VsZWN0Mi1sb2NrZWQpIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIF90aGlzLnNlYXJjaFswXS5mb2N1cygpOwogICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0Q2hvaWNlKCQodGhpcykpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIHJld3JpdGUgbGFiZWxzIGZyb20gb3JpZ2luYWwgZWxlbWVudCB0byBmb2N1c3NlcgogICAgICAgICAgICB0aGlzLnNlYXJjaC5hdHRyKCJpZCIsICJzMmlkX2F1dG9nZW4iK25leHRVaWQoKSk7CgogICAgICAgICAgICB0aGlzLnNlYXJjaC5wcmV2KCkKICAgICAgICAgICAgICAgIC50ZXh0KCQoImxhYmVsW2Zvcj0nIiArIHRoaXMub3B0cy5lbGVtZW50LmF0dHIoImlkIikgKyAiJ10iKS50ZXh0KCkpCiAgICAgICAgICAgICAgICAuYXR0cignZm9yJywgdGhpcy5zZWFyY2guYXR0cignaWQnKSk7CiAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LmZvY3VzKHRoaXMuYmluZChmdW5jdGlvbiAoKSB7IHRoaXMuZm9jdXMoKTsgfSkpOwoKICAgICAgICAgICAgdGhpcy5zZWFyY2gub24oImlucHV0IHBhc3RlIiwgdGhpcy5iaW5kKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VhcmNoLmF0dHIoJ3BsYWNlaG9sZGVyJykgJiYgdGhpcy5zZWFyY2gudmFsKCkubGVuZ3RoID09IDApIHJldHVybjsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wZW5lZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLmF0dHIoInRhYmluZGV4IiwgdGhpcy5lbGVtZW50VGFiSW5kZXgpOwoKICAgICAgICAgICAgdGhpcy5rZXlkb3ducyA9IDA7CiAgICAgICAgICAgIHRoaXMuc2VhcmNoLm9uKCJrZXlkb3duIiwgdGhpcy5iaW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpIHJldHVybjsKCiAgICAgICAgICAgICAgICArK3RoaXMua2V5ZG93bnM7CiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSBzZWxlY3Rpb24uZmluZCgiLnNlbGVjdDItc2VhcmNoLWNob2ljZS1mb2N1cyIpOwogICAgICAgICAgICAgICAgdmFyIHByZXYgPSBzZWxlY3RlZC5wcmV2KCIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlOm5vdCguc2VsZWN0Mi1sb2NrZWQpIik7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHNlbGVjdGVkLm5leHQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2U6bm90KC5zZWxlY3QyLWxvY2tlZCkiKTsKICAgICAgICAgICAgICAgIHZhciBwb3MgPSBnZXRDdXJzb3JJbmZvKHRoaXMuc2VhcmNoKTsKCiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWQubGVuZ3RoICYmCiAgICAgICAgICAgICAgICAgICAgKGUud2hpY2ggPT0gS0VZLkxFRlQgfHwgZS53aGljaCA9PSBLRVkuUklHSFQgfHwgZS53aGljaCA9PSBLRVkuQkFDS1NQQUNFIHx8IGUud2hpY2ggPT0gS0VZLkRFTEVURSB8fCBlLndoaWNoID09IEtFWS5FTlRFUikpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWRDaG9pY2UgPSBzZWxlY3RlZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZS53aGljaCA9PSBLRVkuTEVGVCAmJiBwcmV2Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZENob2ljZSA9IHByZXY7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGUud2hpY2ggPT0gS0VZLlJJR0hUKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkQ2hvaWNlID0gbmV4dC5sZW5ndGggPyBuZXh0IDogbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZS53aGljaCA9PT0gS0VZLkJBQ0tTUEFDRSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy51bnNlbGVjdChzZWxlY3RlZC5maXJzdCgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgoMTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRDaG9pY2UgPSBwcmV2Lmxlbmd0aCA\/IHByZXYgOiBuZXh0OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLndoaWNoID09IEtFWS5ERUxFVEUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudW5zZWxlY3Qoc2VsZWN0ZWQuZmlyc3QoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLndpZHRoKDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkQ2hvaWNlID0gbmV4dC5sZW5ndGggPyBuZXh0IDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZS53aGljaCA9PSBLRVkuRU5URVIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRDaG9pY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RDaG9pY2Uoc2VsZWN0ZWRDaG9pY2UpOwogICAgICAgICAgICAgICAgICAgIGtpbGxFdmVudChlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGVjdGVkQ2hvaWNlIHx8ICFzZWxlY3RlZENob2ljZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKChlLndoaWNoID09PSBLRVkuQkFDS1NQQUNFICYmIHRoaXMua2V5ZG93bnMgPT0gMSkKICAgICAgICAgICAgICAgICAgICB8fCBlLndoaWNoID09IEtFWS5MRUZUKSAmJiAocG9zLm9mZnNldCA9PSAwICYmICFwb3MubGVuZ3RoKSkgewoKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdENob2ljZShzZWxlY3Rpb24uZmluZCgiLnNlbGVjdDItc2VhcmNoLWNob2ljZTpub3QoLnNlbGVjdDItbG9ja2VkKSIpLmxhc3QoKSk7CiAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RDaG9pY2UobnVsbCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMub3BlbmVkKCkpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGUud2hpY2gpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIEtFWS5VUDoKICAgICAgICAgICAgICAgICAgICBjYXNlIEtFWS5ET1dOOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdmVIaWdobGlnaHQoKGUud2hpY2ggPT09IEtFWS5VUCkgPyAtMSA6IDEpOwogICAgICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjYXNlIEtFWS5FTlRFUjoKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RIaWdobGlnaHRlZCgpOwogICAgICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjYXNlIEtFWS5UQUI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0SGlnaGxpZ2h0ZWQoe25vRm9jdXM6dHJ1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBjYXNlIEtFWS5FU0M6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsKGUpOwogICAgICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT09IEtFWS5UQUIgfHwgS0VZLmlzQ29udHJvbChlKSB8fCBLRVkuaXNGdW5jdGlvbktleShlKQogICAgICAgICAgICAgICAgIHx8IGUud2hpY2ggPT09IEtFWS5CQUNLU1BBQ0UgfHwgZS53aGljaCA9PT0gS0VZLkVTQykgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZS53aGljaCA9PT0gS0VZLkVOVEVSKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0cy5vcGVuT25FbnRlciA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZS5hbHRLZXkgfHwgZS5jdHJsS2V5IHx8IGUuc2hpZnRLZXkgfHwgZS5tZXRhS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CgogICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT09IEtFWS5QQUdFX1VQIHx8IGUud2hpY2ggPT09IEtFWS5QQUdFX0RPV04pIHsKICAgICAgICAgICAgICAgICAgICAvLyBwcmV2ZW50IHRoZSBwYWdlIGZyb20gc2Nyb2xsaW5nCiAgICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChlLndoaWNoID09PSBLRVkuRU5URVIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBwcmV2ZW50IGZvcm0gZnJvbSBiZWluZyBzdWJtaXR0ZWQKICAgICAgICAgICAgICAgICAgICBraWxsRXZlbnQoZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0aGlzLnNlYXJjaC5vbigia2V5dXAiLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIHRoaXMua2V5ZG93bnMgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5yZXNpemVTZWFyY2goKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIHRoaXMuc2VhcmNoLm9uKCJibHVyIiwgdGhpcy5iaW5kKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnJlbW92ZUNsYXNzKCJzZWxlY3QyLWZvY3VzZWQiKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Q2hvaWNlKG51bGwpOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLm9wZW5lZCgpKSB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcigkLkV2ZW50KCJzZWxlY3QyLWJsdXIiKSk7CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLm9uKCJjbGljayIsIHNlbGVjdG9yLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0ludGVyZmFjZUVuYWJsZWQoKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKCQoZS50YXJnZXQpLmNsb3Nlc3QoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UiKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY2xpY2tlZCBpbnNpZGUgYSBzZWxlY3QyIHNlYXJjaCBjaG9pY2UsIGRvIG5vdCBvcGVuCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RDaG9pY2UobnVsbCk7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyUGxhY2Vob2xkZXIoKTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5jb250YWluZXIuaGFzQ2xhc3MoInNlbGVjdDItY29udGFpbmVyLWFjdGl2ZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcigkLkV2ZW50KCJzZWxlY3QyLWZvY3VzIikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzU2VhcmNoKCk7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLm9uKCJmb2N1cyIsIHNlbGVjdG9yLCB0aGlzLmJpbmQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzSW50ZXJmYWNlRW5hYmxlZCgpKSByZXR1cm47CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29udGFpbmVyLmhhc0NsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnRyaWdnZXIoJC5FdmVudCgic2VsZWN0Mi1mb2N1cyIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKTsKICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd24uYWRkQ2xhc3MoInNlbGVjdDItZHJvcC1hY3RpdmUiKTsKICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJQbGFjZWhvbGRlcigpOwogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0aGlzLmluaXRDb250YWluZXJXaWR0aCgpOwogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC5oaWRlKCk7CgogICAgICAgICAgICAvLyBzZXQgdGhlIHBsYWNlaG9sZGVyIGlmIG5lY2Vzc2FyeQogICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBlbmFibGVJbnRlcmZhY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5wYXJlbnQuZW5hYmxlSW50ZXJmYWNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnByb3AoImRpc2FibGVkIiwgIXRoaXMuaXNJbnRlcmZhY2VFbmFibGVkKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBpbml0U2VsZWN0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBkYXRhOwogICAgICAgICAgICBpZiAodGhpcy5vcHRzLmVsZW1lbnQudmFsKCkgPT09ICIiICYmIHRoaXMub3B0cy5lbGVtZW50LnRleHQoKSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0aW9uKFtdKTsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgcGxhY2Vob2xkZXIgaWYgbmVjZXNzYXJ5CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0IHx8IHRoaXMub3B0cy5lbGVtZW50LnZhbCgpICE9PSAiIikgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICAgICAgdGhpcy5vcHRzLmluaXRTZWxlY3Rpb24uY2FsbChudWxsLCB0aGlzLm9wdHMuZWxlbWVudCwgZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCAmJiBkYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlU2VsZWN0aW9uKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgcGxhY2Vob2xkZXIgaWYgbmVjZXNzYXJ5CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYXJTZWFyY2goKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgY2xlYXJTZWFyY2g6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5nZXRQbGFjZWhvbGRlcigpLAogICAgICAgICAgICAgICAgbWF4V2lkdGggPSB0aGlzLmdldE1heFNlYXJjaFdpZHRoKCk7CgogICAgICAgICAgICBpZiAocGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCAgJiYgdGhpcy5nZXRWYWwoKS5sZW5ndGggPT09IDAgJiYgdGhpcy5zZWFyY2guaGFzQ2xhc3MoInNlbGVjdDItZm9jdXNlZCIpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHBsYWNlaG9sZGVyKS5hZGRDbGFzcygic2VsZWN0Mi1kZWZhdWx0Iik7CiAgICAgICAgICAgICAgICAvLyBzdHJldGNoIHRoZSBzZWFyY2ggYm94IHRvIGZ1bGwgd2lkdGggb2YgdGhlIGNvbnRhaW5lciBzbyBhcyBtdWNoIG9mIHRoZSBwbGFjZWhvbGRlciBpcyB2aXNpYmxlIGFzIHBvc3NpYmxlCiAgICAgICAgICAgICAgICAvLyB3ZSBjb3VsZCBjYWxsIHRoaXMucmVzaXplU2VhcmNoKCksIGJ1dCB3ZSBkbyBub3QgYmVjYXVzZSB0aGF0IHJlcXVpcmVzIGEgc2l6ZXIgYW5kIHdlIGRvIG5vdCB3YW50IHRvIGNyZWF0ZSBvbmUgc28gZWFybHkgYmVjYXVzZSBvZiBhIGZpcmVmb3ggYnVnLCBzZWUgIzk0NAogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgobWF4V2lkdGggPiAwID8gbWF4V2lkdGggOiB0aGlzLmNvbnRhaW5lci5jc3MoIndpZHRoIikpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKCIiKS53aWR0aCgxMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGNsZWFyUGxhY2Vob2xkZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VhcmNoLmhhc0NsYXNzKCJzZWxlY3QyLWRlZmF1bHQiKSkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKCIiKS5yZW1vdmVDbGFzcygic2VsZWN0Mi1kZWZhdWx0Iik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIG9wZW5pbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jbGVhclBsYWNlaG9sZGVyKCk7IC8vIHNob3VsZCBiZSBkb25lIGJlZm9yZSBzdXBlciBzbyBwbGFjZWhvbGRlciBpcyBub3QgdXNlZCB0byBzZWFyY2gKICAgICAgICAgICAgdGhpcy5yZXNpemVTZWFyY2goKTsKCiAgICAgICAgICAgIHRoaXMucGFyZW50Lm9wZW5pbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgICAgIHRoaXMuZm9jdXNTZWFyY2goKTsKCiAgICAgICAgICAgIC8vIGluaXRpYWxpemVzIHNlYXJjaCdzIHZhbHVlIHdpdGggbmV4dFNlYXJjaFRlcm0gKGlmIGRlZmluZWQgYnkgdXNlcikKICAgICAgICAgICAgLy8gaWdub3JlIG5leHRTZWFyY2hUZXJtIGlmIHRoZSBkcm9wZG93biBpcyBvcGVuZWQgYnkgdGhlIHVzZXIgcHJlc3NpbmcgYSBsZXR0ZXIKICAgICAgICAgICAgaWYodGhpcy5zZWFyY2gudmFsKCkgPT09ICIiKSB7CiAgICAgICAgICAgICAgICBpZih0aGlzLm5leHRTZWFyY2hUZXJtICE9IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHRoaXMubmV4dFNlYXJjaFRlcm0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnVwZGF0ZVJlc3VsdHModHJ1ZSk7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuc2hvdWxkRm9jdXNJbnB1dCh0aGlzKSkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2guZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKCQuRXZlbnQoInNlbGVjdDItb3BlbiIpKTsKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGNsb3NlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5vcGVuZWQoKSkgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnBhcmVudC5jbG9zZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgZm9jdXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICB0aGlzLnNlYXJjaC5mb2N1cygpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgaXNGb2N1c2VkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNlYXJjaC5oYXNDbGFzcygic2VsZWN0Mi1mb2N1c2VkIik7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICB1cGRhdGVTZWxlY3Rpb246IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIHZhciBpZHMgPSBbXSwgZmlsdGVyZWQgPSBbXSwgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICAvLyBmaWx0ZXIgb3V0IGR1cGxpY2F0ZXMKICAgICAgICAgICAgJChkYXRhKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChpbmRleE9mKHNlbGYuaWQodGhpcyksIGlkcykgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2goc2VsZi5pZCh0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRhdGEgPSBmaWx0ZXJlZDsKCiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UiKS5yZW1vdmUoKTsKICAgICAgICAgICAgJChkYXRhKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYuYWRkU2VsZWN0ZWRDaG9pY2UodGhpcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxmLnBvc3Rwcm9jZXNzUmVzdWx0cygpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgdG9rZW5pemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaW5wdXQgPSB0aGlzLnNlYXJjaC52YWwoKTsKICAgICAgICAgICAgaW5wdXQgPSB0aGlzLm9wdHMudG9rZW5pemVyLmNhbGwodGhpcywgaW5wdXQsIHRoaXMuZGF0YSgpLCB0aGlzLmJpbmQodGhpcy5vblNlbGVjdCksIHRoaXMub3B0cyk7CiAgICAgICAgICAgIGlmIChpbnB1dCAhPSBudWxsICYmIGlucHV0ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKGlucHV0KTsKICAgICAgICAgICAgICAgIGlmIChpbnB1dC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBvblNlbGVjdDogZnVuY3Rpb24gKGRhdGEsIG9wdGlvbnMpIHsKCiAgICAgICAgICAgIGlmICghdGhpcy50cmlnZ2VyU2VsZWN0KGRhdGEpIHx8IGRhdGEudGV4dCA9PT0gIiIpIHsgcmV0dXJuOyB9CgogICAgICAgICAgICB0aGlzLmFkZFNlbGVjdGVkQ2hvaWNlKGRhdGEpOwoKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcih7IHR5cGU6ICJzZWxlY3RlZCIsIHZhbDogdGhpcy5pZChkYXRhKSwgY2hvaWNlOiBkYXRhIH0pOwoKICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB0aGUgc2VhcmNoJ3MgdmFsdWUgYmVmb3JlIGl0IGdldHMgY2xlYXJlZAogICAgICAgICAgICB0aGlzLm5leHRTZWFyY2hUZXJtID0gdGhpcy5vcHRzLm5leHRTZWFyY2hUZXJtKGRhdGEsIHRoaXMuc2VhcmNoLnZhbCgpKTsKCiAgICAgICAgICAgIHRoaXMuY2xlYXJTZWFyY2goKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVSZXN1bHRzKCk7CgogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QgfHwgIXRoaXMub3B0cy5jbG9zZU9uU2VsZWN0KSB0aGlzLnBvc3Rwcm9jZXNzUmVzdWx0cyhkYXRhLCBmYWxzZSwgdGhpcy5vcHRzLmNsb3NlT25TZWxlY3Q9PT10cnVlKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuY2xvc2VPblNlbGVjdCkgewogICAgICAgICAgICAgICAgdGhpcy5jbG9zZSgpOwogICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gud2lkdGgoMTApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuY291bnRTZWxlY3RhYmxlUmVzdWx0cygpPjApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC53aWR0aCgxMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNpemVTZWFyY2goKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRNYXhpbXVtU2VsZWN0aW9uU2l6ZSgpID4gMCAmJiB0aGlzLnZhbCgpLmxlbmd0aCA+PSB0aGlzLmdldE1heGltdW1TZWxlY3Rpb25TaXplKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgd2UgcmVhY2hlZCBtYXggc2VsZWN0aW9uIHNpemUgcmVwYWludCB0aGUgcmVzdWx0cyBzbyBjaG9pY2VzCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFyZSByZXBsYWNlZCB3aXRoIHRoZSBtYXggc2VsZWN0aW9uIHJlYWNoZWQgbWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVJlc3VsdHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZXMgc2VhcmNoJ3MgdmFsdWUgd2l0aCBuZXh0U2VhcmNoVGVybSBhbmQgdXBkYXRlIHNlYXJjaCByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5uZXh0U2VhcmNoVGVybSAhPSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWFyY2gudmFsKHRoaXMubmV4dFNlYXJjaFRlcm0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVSZXN1bHRzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC5zZWxlY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uRHJvcGRvd24oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgbm90aGluZyBsZWZ0IHRvIHNlbGVjdCBjbG9zZQogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaC53aWR0aCgxMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNpbmNlIGl0cyBub3QgcG9zc2libGUgdG8gc2VsZWN0IGFuIGVsZW1lbnQgdGhhdCBoYXMgYWxyZWFkeSBiZWVuCiAgICAgICAgICAgIC8vIGFkZGVkIHdlIGRvIG5vdCBuZWVkIHRvIGNoZWNrIGlmIHRoaXMgaXMgYSBuZXcgZWxlbWVudCBiZWZvcmUgZmlyaW5nIGNoYW5nZQogICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2UoeyBhZGRlZDogZGF0YSB9KTsKCiAgICAgICAgICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5ub0ZvY3VzKQogICAgICAgICAgICAgICAgdGhpcy5mb2N1c1NlYXJjaCgpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgdGhpcy5mb2N1c1NlYXJjaCgpOwogICAgICAgIH0sCgogICAgICAgIGFkZFNlbGVjdGVkQ2hvaWNlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICB2YXIgZW5hYmxlQ2hvaWNlID0gIWRhdGEubG9ja2VkLAogICAgICAgICAgICAgICAgZW5hYmxlZEl0ZW0gPSAkKAogICAgICAgICAgICAgICAgICAgICI8bGkgY2xhc3M9J3NlbGVjdDItc2VhcmNoLWNob2ljZSc+IiArCiAgICAgICAgICAgICAgICAgICAgIiAgICA8ZGl2PjwvZGl2PiIgKwogICAgICAgICAgICAgICAgICAgICIgICAgPGEgaHJlZj0nIycgY2xhc3M9J3NlbGVjdDItc2VhcmNoLWNob2ljZS1jbG9zZScgdGFiaW5kZXg9Jy0xJz48L2E+IiArCiAgICAgICAgICAgICAgICAgICAgIjwvbGk+IiksCiAgICAgICAgICAgICAgICBkaXNhYmxlZEl0ZW0gPSAkKAogICAgICAgICAgICAgICAgICAgICI8bGkgY2xhc3M9J3NlbGVjdDItc2VhcmNoLWNob2ljZSBzZWxlY3QyLWxvY2tlZCc+IiArCiAgICAgICAgICAgICAgICAgICAgIjxkaXY+PC9kaXY+IiArCiAgICAgICAgICAgICAgICAgICAgIjwvbGk+Iik7CiAgICAgICAgICAgIHZhciBjaG9pY2UgPSBlbmFibGVDaG9pY2UgPyBlbmFibGVkSXRlbSA6IGRpc2FibGVkSXRlbSwKICAgICAgICAgICAgICAgIGlkID0gdGhpcy5pZChkYXRhKSwKICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZ2V0VmFsKCksCiAgICAgICAgICAgICAgICBmb3JtYXR0ZWQsCiAgICAgICAgICAgICAgICBjc3NDbGFzczsKCiAgICAgICAgICAgIGZvcm1hdHRlZD10aGlzLm9wdHMuZm9ybWF0U2VsZWN0aW9uKGRhdGEsIGNob2ljZS5maW5kKCJkaXYiKSwgdGhpcy5vcHRzLmVzY2FwZU1hcmt1cCk7CiAgICAgICAgICAgIGlmIChmb3JtYXR0ZWQgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjaG9pY2UuZmluZCgiZGl2IikucmVwbGFjZVdpdGgoJCgiPGRpdj48L2Rpdj4iKS5odG1sKGZvcm1hdHRlZCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNzc0NsYXNzPXRoaXMub3B0cy5mb3JtYXRTZWxlY3Rpb25Dc3NDbGFzcyhkYXRhLCBjaG9pY2UuZmluZCgiZGl2IikpOwogICAgICAgICAgICBpZiAoY3NzQ2xhc3MgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjaG9pY2UuYWRkQ2xhc3MoY3NzQ2xhc3MpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihlbmFibGVDaG9pY2UpewogICAgICAgICAgICAgIGNob2ljZS5maW5kKCIuc2VsZWN0Mi1zZWFyY2gtY2hvaWNlLWNsb3NlIikKICAgICAgICAgICAgICAgICAgLm9uKCJtb3VzZWRvd24iLCBraWxsRXZlbnQpCiAgICAgICAgICAgICAgICAgIC5vbigiY2xpY2sgZGJsY2xpY2siLCB0aGlzLmJpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzSW50ZXJmYWNlRW5hYmxlZCgpKSByZXR1cm47CgogICAgICAgICAgICAgICAgICB0aGlzLnVuc2VsZWN0KCQoZS50YXJnZXQpKTsKICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24uZmluZCgiLnNlbGVjdDItc2VhcmNoLWNob2ljZS1mb2N1cyIpLnJlbW92ZUNsYXNzKCJzZWxlY3QyLXNlYXJjaC1jaG9pY2UtZm9jdXMiKTsKICAgICAgICAgICAgICAgICAga2lsbEV2ZW50KGUpOwogICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNTZWFyY2goKTsKICAgICAgICAgICAgICB9KSkub24oImZvY3VzIiwgdGhpcy5iaW5kKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzSW50ZXJmYWNlRW5hYmxlZCgpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKCJzZWxlY3QyLWNvbnRhaW5lci1hY3RpdmUiKTsKICAgICAgICAgICAgICAgICAgdGhpcy5kcm9wZG93bi5hZGRDbGFzcygic2VsZWN0Mi1kcm9wLWFjdGl2ZSIpOwogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2hvaWNlLmRhdGEoInNlbGVjdDItZGF0YSIsIGRhdGEpOwogICAgICAgICAgICBjaG9pY2UuaW5zZXJ0QmVmb3JlKHRoaXMuc2VhcmNoQ29udGFpbmVyKTsKCiAgICAgICAgICAgIHZhbC5wdXNoKGlkKTsKICAgICAgICAgICAgdGhpcy5zZXRWYWwodmFsKTsKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIHVuc2VsZWN0OiBmdW5jdGlvbiAoc2VsZWN0ZWQpIHsKICAgICAgICAgICAgdmFyIHZhbCA9IHRoaXMuZ2V0VmFsKCksCiAgICAgICAgICAgICAgICBkYXRhLAogICAgICAgICAgICAgICAgaW5kZXg7CiAgICAgICAgICAgIHNlbGVjdGVkID0gc2VsZWN0ZWQuY2xvc2VzdCgiLnNlbGVjdDItc2VhcmNoLWNob2ljZSIpOwoKICAgICAgICAgICAgaWYgKHNlbGVjdGVkLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgYXJndW1lbnQ6ICIgKyBzZWxlY3RlZCArICIuIE11c3QgYmUgLnNlbGVjdDItc2VhcmNoLWNob2ljZSI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRhdGEgPSBzZWxlY3RlZC5kYXRhKCJzZWxlY3QyLWRhdGEiKTsKCiAgICAgICAgICAgIGlmICghZGF0YSkgewogICAgICAgICAgICAgICAgLy8gcHJldmVudCBhIHJhY2UgY29uZGl0aW9uIHdoZW4gdGhlICd4JyBpcyBjbGlja2VkIHJlYWxseSBmYXN0IHJlcGVhdGVkbHkgdGhlIGV2ZW50IGNhbiBiZSBxdWV1ZWQKICAgICAgICAgICAgICAgIC8vIGFuZCBpbnZva2VkIG9uIGFuIGVsZW1lbnQgYWxyZWFkeSByZW1vdmVkCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBldnQgPSAkLkV2ZW50KCJzZWxlY3QyLXJlbW92aW5nIik7CiAgICAgICAgICAgIGV2dC52YWwgPSB0aGlzLmlkKGRhdGEpOwogICAgICAgICAgICBldnQuY2hvaWNlID0gZGF0YTsKICAgICAgICAgICAgdGhpcy5vcHRzLmVsZW1lbnQudHJpZ2dlcihldnQpOwoKICAgICAgICAgICAgaWYgKGV2dC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlsZSgoaW5kZXggPSBpbmRleE9mKHRoaXMuaWQoZGF0YSksIHZhbCkpID49IDApIHsKICAgICAgICAgICAgICAgIHZhbC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRWYWwodmFsKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdCkgdGhpcy5wb3N0cHJvY2Vzc1Jlc3VsdHMoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VsZWN0ZWQucmVtb3ZlKCk7CgogICAgICAgICAgICB0aGlzLm9wdHMuZWxlbWVudC50cmlnZ2VyKHsgdHlwZTogInNlbGVjdDItcmVtb3ZlZCIsIHZhbDogdGhpcy5pZChkYXRhKSwgY2hvaWNlOiBkYXRhIH0pOwogICAgICAgICAgICB0aGlzLnRyaWdnZXJDaGFuZ2UoeyByZW1vdmVkOiBkYXRhIH0pOwoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBwb3N0cHJvY2Vzc1Jlc3VsdHM6IGZ1bmN0aW9uIChkYXRhLCBpbml0aWFsLCBub0hpZ2hsaWdodFVwZGF0ZSkgewogICAgICAgICAgICB2YXIgdmFsID0gdGhpcy5nZXRWYWwoKSwKICAgICAgICAgICAgICAgIGNob2ljZXMgPSB0aGlzLnJlc3VsdHMuZmluZCgiLnNlbGVjdDItcmVzdWx0IiksCiAgICAgICAgICAgICAgICBjb21wb3VuZCA9IHRoaXMucmVzdWx0cy5maW5kKCIuc2VsZWN0Mi1yZXN1bHQtd2l0aC1jaGlsZHJlbiIpLAogICAgICAgICAgICAgICAgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICBjaG9pY2VzLmVhY2gyKGZ1bmN0aW9uIChpLCBjaG9pY2UpIHsKICAgICAgICAgICAgICAgIHZhciBpZCA9IHNlbGYuaWQoY2hvaWNlLmRhdGEoInNlbGVjdDItZGF0YSIpKTsKICAgICAgICAgICAgICAgIGlmIChpbmRleE9mKGlkLCB2YWwpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjaG9pY2UuYWRkQ2xhc3MoInNlbGVjdDItc2VsZWN0ZWQiKTsKICAgICAgICAgICAgICAgICAgICAvLyBtYXJrIGFsbCBjaGlsZHJlbiBvZiB0aGUgc2VsZWN0ZWQgcGFyZW50IGFzIHNlbGVjdGVkCiAgICAgICAgICAgICAgICAgICAgY2hvaWNlLmZpbmQoIi5zZWxlY3QyLXJlc3VsdC1zZWxlY3RhYmxlIikuYWRkQ2xhc3MoInNlbGVjdDItc2VsZWN0ZWQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjb21wb3VuZC5lYWNoMihmdW5jdGlvbihpLCBjaG9pY2UpIHsKICAgICAgICAgICAgICAgIC8vIGhpZGUgYW4gb3B0Z3JvdXAgaWYgaXQgZG9lc24ndCBoYXZlIGFueSBzZWxlY3RhYmxlIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBpZiAoIWNob2ljZS5pcygnLnNlbGVjdDItcmVzdWx0LXNlbGVjdGFibGUnKQogICAgICAgICAgICAgICAgICAgICYmIGNob2ljZS5maW5kKCIuc2VsZWN0Mi1yZXN1bHQtc2VsZWN0YWJsZTpub3QoLnNlbGVjdDItc2VsZWN0ZWQpIikubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY2hvaWNlLmFkZENsYXNzKCJzZWxlY3QyLXNlbGVjdGVkIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHRoaXMuaGlnaGxpZ2h0KCkgPT0gLTEgJiYgbm9IaWdobGlnaHRVcGRhdGUgIT09IGZhbHNlICYmIHRoaXMub3B0cy5jbG9zZU9uU2VsZWN0ID09PSB0cnVlKXsKICAgICAgICAgICAgICAgIHNlbGYuaGlnaGxpZ2h0KDApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL0lmIGFsbCByZXN1bHRzIGFyZSBjaG9zZW4gcmVuZGVyIGZvcm1hdE5vTWF0Y2hlcwogICAgICAgICAgICBpZighdGhpcy5vcHRzLmNyZWF0ZVNlYXJjaENob2ljZSAmJiAhY2hvaWNlcy5maWx0ZXIoJy5zZWxlY3QyLXJlc3VsdDpub3QoLnNlbGVjdDItc2VsZWN0ZWQpJykubGVuZ3RoID4gMCl7CiAgICAgICAgICAgICAgICBpZighZGF0YSB8fCBkYXRhICYmICFkYXRhLm1vcmUgJiYgdGhpcy5yZXN1bHRzLmZpbmQoIi5zZWxlY3QyLW5vLXJlc3VsdHMiKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hlY2tGb3JtYXR0ZXIoc2VsZi5vcHRzLmZvcm1hdE5vTWF0Y2hlcywgImZvcm1hdE5vTWF0Y2hlcyIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzdWx0cy5hcHBlbmQoIjxsaSBjbGFzcz0nc2VsZWN0Mi1uby1yZXN1bHRzJz4iICsgZXZhbHVhdGUoc2VsZi5vcHRzLmZvcm1hdE5vTWF0Y2hlcywgc2VsZi5vcHRzLmVsZW1lbnQsIHNlbGYuc2VhcmNoLnZhbCgpKSArICI8L2xpPiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGdldE1heFNlYXJjaFdpZHRoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9uLndpZHRoKCkgLSBnZXRTaWRlQm9yZGVyUGFkZGluZyh0aGlzLnNlYXJjaCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICByZXNpemVTZWFyY2g6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG1pbmltdW1XaWR0aCwgbGVmdCwgbWF4V2lkdGgsIGNvbnRhaW5lckxlZnQsIHNlYXJjaFdpZHRoLAogICAgICAgICAgICAgICAgc2lkZUJvcmRlclBhZGRpbmcgPSBnZXRTaWRlQm9yZGVyUGFkZGluZyh0aGlzLnNlYXJjaCk7CgogICAgICAgICAgICBtaW5pbXVtV2lkdGggPSBtZWFzdXJlVGV4dFdpZHRoKHRoaXMuc2VhcmNoKSArIDEwOwoKICAgICAgICAgICAgbGVmdCA9IHRoaXMuc2VhcmNoLm9mZnNldCgpLmxlZnQ7CgogICAgICAgICAgICBtYXhXaWR0aCA9IHRoaXMuc2VsZWN0aW9uLndpZHRoKCk7CiAgICAgICAgICAgIGNvbnRhaW5lckxlZnQgPSB0aGlzLnNlbGVjdGlvbi5vZmZzZXQoKS5sZWZ0OwoKICAgICAgICAgICAgc2VhcmNoV2lkdGggPSBtYXhXaWR0aCAtIChsZWZ0IC0gY29udGFpbmVyTGVmdCkgLSBzaWRlQm9yZGVyUGFkZGluZzsKCiAgICAgICAgICAgIGlmIChzZWFyY2hXaWR0aCA8IG1pbmltdW1XaWR0aCkgewogICAgICAgICAgICAgICAgc2VhcmNoV2lkdGggPSBtYXhXaWR0aCAtIHNpZGVCb3JkZXJQYWRkaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VhcmNoV2lkdGggPCA0MCkgewogICAgICAgICAgICAgICAgc2VhcmNoV2lkdGggPSBtYXhXaWR0aCAtIHNpZGVCb3JkZXJQYWRkaW5nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VhcmNoV2lkdGggPD0gMCkgewogICAgICAgICAgICAgIHNlYXJjaFdpZHRoID0gbWluaW11bVdpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNlYXJjaC53aWR0aChNYXRoLmZsb29yKHNlYXJjaFdpZHRoKSk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBnZXRWYWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0KSB7CiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLnNlbGVjdC52YWwoKTsKICAgICAgICAgICAgICAgIHJldHVybiB2YWwgPT09IG51bGwgPyBbXSA6IHZhbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMub3B0cy5lbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHNwbGl0VmFsKHZhbCwgdGhpcy5vcHRzLnNlcGFyYXRvciwgdGhpcy5vcHRzLnRyYW5zZm9ybVZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIHNldFZhbDogZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICB2YXIgdW5pcXVlOwogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0LnZhbCh2YWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdW5pcXVlID0gW107CiAgICAgICAgICAgICAgICAvLyBmaWx0ZXIgb3V0IGR1cGxpY2F0ZXMKICAgICAgICAgICAgICAgICQodmFsKS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZih0aGlzLCB1bmlxdWUpIDwgMCkgdW5pcXVlLnB1c2godGhpcyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnZhbCh1bmlxdWUubGVuZ3RoID09PSAwID8gIiIgOiB1bmlxdWUuam9pbih0aGlzLm9wdHMuc2VwYXJhdG9yKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIGJ1aWxkQ2hhbmdlRGV0YWlsczogZnVuY3Rpb24gKG9sZCwgY3VycmVudCkgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IGN1cnJlbnQuc2xpY2UoMCksCiAgICAgICAgICAgICAgICBvbGQgPSBvbGQuc2xpY2UoMCk7CgogICAgICAgICAgICAvLyByZW1vdmUgaW50ZXJzZWN0aW9uIGZyb20gZWFjaCBhcnJheQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGN1cnJlbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgb2xkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVxdWFsKHRoaXMub3B0cy5pZChjdXJyZW50W2ldKSwgdGhpcy5vcHRzLmlkKG9sZFtqXSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBpZihpPjApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG9sZC5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGotLTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7YWRkZWQ6IGN1cnJlbnQsIHJlbW92ZWQ6IG9sZH07CiAgICAgICAgfSwKCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgdmFsOiBmdW5jdGlvbiAodmFsLCB0cmlnZ2VyQ2hhbmdlKSB7CiAgICAgICAgICAgIHZhciBvbGREYXRhLCBzZWxmPXRoaXM7CgogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9sZERhdGE9dGhpcy5kYXRhKCk7CiAgICAgICAgICAgIGlmICghb2xkRGF0YS5sZW5ndGgpIG9sZERhdGE9W107CgogICAgICAgICAgICAvLyB2YWwgaXMgYW4gaWQuICF2YWwgaXMgdHJ1ZSBmb3IgW3VuZGVmaW5lZCxudWxsLCcnLDBdIC0gMCBpcyBsZWdhbAogICAgICAgICAgICBpZiAoIXZhbCAmJiB2YWwgIT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5lbGVtZW50LnZhbCgiIik7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNlbGVjdGlvbihbXSk7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckNoYW5nZSh7YWRkZWQ6IHRoaXMuZGF0YSgpLCByZW1vdmVkOiBvbGREYXRhfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHZhbCBpcyBhIGxpc3Qgb2YgaWRzCiAgICAgICAgICAgIHRoaXMuc2V0VmFsKHZhbCk7CgogICAgICAgICAgICBpZiAodGhpcy5zZWxlY3QpIHsKICAgICAgICAgICAgICAgIHRoaXMub3B0cy5pbml0U2VsZWN0aW9uKHRoaXMuc2VsZWN0LCB0aGlzLmJpbmQodGhpcy51cGRhdGVTZWxlY3Rpb24pKTsKICAgICAgICAgICAgICAgIGlmICh0cmlnZ2VyQ2hhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyQ2hhbmdlKHRoaXMuYnVpbGRDaGFuZ2VEZXRhaWxzKG9sZERhdGEsIHRoaXMuZGF0YSgpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRzLmluaXRTZWxlY3Rpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidmFsKCkgY2Fubm90IGJlIGNhbGxlZCBpZiBpbml0U2VsZWN0aW9uKCkgaXMgbm90IGRlZmluZWQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLm9wdHMuaW5pdFNlbGVjdGlvbih0aGlzLm9wdHMuZWxlbWVudCwgZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlkcz0kLm1hcChkYXRhLCBzZWxmLmlkKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLnNldFZhbChpZHMpOwogICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlU2VsZWN0aW9uKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xlYXJTZWFyY2goKTsKICAgICAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRyaWdnZXJDaGFuZ2Uoc2VsZi5idWlsZENoYW5nZURldGFpbHMob2xkRGF0YSwgc2VsZi5kYXRhKCkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbXVsdGkKICAgICAgICBvblNvcnRTdGFydDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTb3J0aW5nIG9mIGVsZW1lbnRzIGlzIG5vdCBzdXBwb3J0ZWQgd2hlbiBhdHRhY2hlZCB0byA8c2VsZWN0Pi4gQXR0YWNoIHRvIDxpbnB1dCB0eXBlPSdoaWRkZW4nLz4gaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY29sbGFwc2Ugc2VhcmNoIGZpZWxkIGludG8gMCB3aWR0aCBzbyBpdHMgY29udGFpbmVyIGNhbiBiZSBjb2xsYXBzZWQgYXMgd2VsbAogICAgICAgICAgICB0aGlzLnNlYXJjaC53aWR0aCgwKTsKICAgICAgICAgICAgLy8gaGlkZSB0aGUgY29udGFpbmVyCiAgICAgICAgICAgIHRoaXMuc2VhcmNoQ29udGFpbmVyLmhpZGUoKTsKICAgICAgICB9LAoKICAgICAgICAvLyBtdWx0aQogICAgICAgIG9uU29ydEVuZDpmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciB2YWw9W10sIHNlbGY9dGhpczsKCiAgICAgICAgICAgIC8vIHNob3cgc2VhcmNoIGFuZCBtb3ZlIGl0IHRvIHRoZSBlbmQgb2YgdGhlIGxpc3QKICAgICAgICAgICAgdGhpcy5zZWFyY2hDb250YWluZXIuc2hvdygpOwogICAgICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIHNlYXJjaCBjb250YWluZXIgaXMgdGhlIGxhc3QgaXRlbSBpbiB0aGUgbGlzdAogICAgICAgICAgICB0aGlzLnNlYXJjaENvbnRhaW5lci5hcHBlbmRUbyh0aGlzLnNlYXJjaENvbnRhaW5lci5wYXJlbnQoKSk7CiAgICAgICAgICAgIC8vIHNpbmNlIHdlIGNvbGxhcHNlZCB0aGUgd2lkdGggaW4gZHJhZ1N0YXJ0ZWQsIHdlIHJlc2l6ZSBpdCBoZXJlCiAgICAgICAgICAgIHRoaXMucmVzaXplU2VhcmNoKCk7CgogICAgICAgICAgICAvLyB1cGRhdGUgc2VsZWN0aW9uCiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9uLmZpbmQoIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UiKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFsLnB1c2goc2VsZi5vcHRzLmlkKCQodGhpcykuZGF0YSgic2VsZWN0Mi1kYXRhIikpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuc2V0VmFsKHZhbCk7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlckNoYW5nZSgpOwogICAgICAgIH0sCgogICAgICAgIC8vIG11bHRpCiAgICAgICAgZGF0YTogZnVuY3Rpb24odmFsdWVzLCB0cmlnZ2VyQ2hhbmdlKSB7CiAgICAgICAgICAgIHZhciBzZWxmPXRoaXMsIGlkcywgb2xkOwogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGlvbgogICAgICAgICAgICAgICAgICAgICAuY2hpbGRyZW4oIi5zZWxlY3QyLXNlYXJjaC1jaG9pY2UiKQogICAgICAgICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uKCkgeyByZXR1cm4gJCh0aGlzKS5kYXRhKCJzZWxlY3QyLWRhdGEiKTsgfSkKICAgICAgICAgICAgICAgICAgICAgLmdldCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb2xkID0gdGhpcy5kYXRhKCk7CiAgICAgICAgICAgICAgICBpZiAoIXZhbHVlcykgeyB2YWx1ZXMgPSBbXTsgfQogICAgICAgICAgICAgICAgaWRzID0gJC5tYXAodmFsdWVzLCBmdW5jdGlvbihlKSB7IHJldHVybiBzZWxmLm9wdHMuaWQoZSk7IH0pOwogICAgICAgICAgICAgICAgdGhpcy5zZXRWYWwoaWRzKTsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU2VsZWN0aW9uKHZhbHVlcyk7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyU2VhcmNoKCk7CiAgICAgICAgICAgICAgICBpZiAodHJpZ2dlckNoYW5nZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlckNoYW5nZSh0aGlzLmJ1aWxkQ2hhbmdlRGV0YWlscyhvbGQsIHRoaXMuZGF0YSgpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKCiAgICAkLmZuLnNlbGVjdDIgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSwKICAgICAgICAgICAgb3B0cywKICAgICAgICAgICAgc2VsZWN0MiwKICAgICAgICAgICAgbWV0aG9kLCB2YWx1ZSwgbXVsdGlwbGUsCiAgICAgICAgICAgIGFsbG93ZWRNZXRob2RzID0gWyJ2YWwiLCAiZGVzdHJveSIsICJvcGVuZWQiLCAib3BlbiIsICJjbG9zZSIsICJmb2N1cyIsICJpc0ZvY3VzZWQiLCAiY29udGFpbmVyIiwgImRyb3Bkb3duIiwgIm9uU29ydFN0YXJ0IiwgIm9uU29ydEVuZCIsICJlbmFibGUiLCAiZGlzYWJsZSIsICJyZWFkb25seSIsICJwb3NpdGlvbkRyb3Bkb3duIiwgImRhdGEiLCAic2VhcmNoIl0sCiAgICAgICAgICAgIHZhbHVlTWV0aG9kcyA9IFsib3BlbmVkIiwgImlzRm9jdXNlZCIsICJjb250YWluZXIiLCAiZHJvcGRvd24iXSwKICAgICAgICAgICAgcHJvcGVydHlNZXRob2RzID0gWyJ2YWwiLCAiZGF0YSJdLAogICAgICAgICAgICBtZXRob2RzTWFwID0geyBzZWFyY2g6ICJleHRlcm5hbFNlYXJjaCIgfTsKCiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwIHx8IHR5cGVvZihhcmdzWzBdKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgIG9wdHMgPSBhcmdzLmxlbmd0aCA9PT0gMCA\/IHt9IDogJC5leHRlbmQoe30sIGFyZ3NbMF0pOwogICAgICAgICAgICAgICAgb3B0cy5lbGVtZW50ID0gJCh0aGlzKTsKCiAgICAgICAgICAgICAgICBpZiAob3B0cy5lbGVtZW50LmdldCgwKS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGUgPSBvcHRzLmVsZW1lbnQucHJvcCgibXVsdGlwbGUiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGUgPSBvcHRzLm11bHRpcGxlIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGlmICgidGFncyIgaW4gb3B0cykge29wdHMubXVsdGlwbGUgPSBtdWx0aXBsZSA9IHRydWU7fQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNlbGVjdDIgPSBtdWx0aXBsZSA\/IG5ldyB3aW5kb3cuU2VsZWN0MlsiY2xhc3MiXS5tdWx0aSgpIDogbmV3IHdpbmRvdy5TZWxlY3QyWyJjbGFzcyJdLnNpbmdsZSgpOwogICAgICAgICAgICAgICAgc2VsZWN0Mi5pbml0KG9wdHMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZihhcmdzWzBdKSA9PT0gInN0cmluZyIpIHsKCiAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZihhcmdzWzBdLCBhbGxvd2VkTWV0aG9kcykgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgIlVua25vd24gbWV0aG9kOiAiICsgYXJnc1swXTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIHNlbGVjdDIgPSAkKHRoaXMpLmRhdGEoInNlbGVjdDIiKTsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3QyID09PSB1bmRlZmluZWQpIHJldHVybjsKCiAgICAgICAgICAgICAgICBtZXRob2Q9YXJnc1swXTsKCiAgICAgICAgICAgICAgICBpZiAobWV0aG9kID09PSAiY29udGFpbmVyIikgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc2VsZWN0Mi5jb250YWluZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gImRyb3Bkb3duIikgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gc2VsZWN0Mi5kcm9wZG93bjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZHNNYXBbbWV0aG9kXSkgbWV0aG9kID0gbWV0aG9kc01hcFttZXRob2RdOwoKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHNlbGVjdDJbbWV0aG9kXS5hcHBseShzZWxlY3QyLCBhcmdzLnNsaWNlKDEpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpbmRleE9mKGFyZ3NbMF0sIHZhbHVlTWV0aG9kcykgPj0gMAogICAgICAgICAgICAgICAgICAgIHx8IChpbmRleE9mKGFyZ3NbMF0sIHByb3BlcnR5TWV0aG9kcykgPj0gMCAmJiBhcmdzLmxlbmd0aCA9PSAxKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gYWJvcnQgdGhlIGl0ZXJhdGlvbiwgcmVhZHkgdG8gcmV0dXJuIGZpcnN0IG1hdGNoZWQgdmFsdWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGFyZ3VtZW50cyB0byBzZWxlY3QyIHBsdWdpbjogIiArIGFyZ3M7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gKHZhbHVlID09PSB1bmRlZmluZWQpID8gdGhpcyA6IHZhbHVlOwogICAgfTsKCiAgICAvLyBwbHVnaW4gZGVmYXVsdHMsIGFjY2Vzc2libGUgdG8gdXNlcnMKICAgICQuZm4uc2VsZWN0Mi5kZWZhdWx0cyA9IHsKICAgICAgICB3aWR0aDogImNvcHkiLAogICAgICAgIGxvYWRNb3JlUGFkZGluZzogMCwKICAgICAgICBjbG9zZU9uU2VsZWN0OiB0cnVlLAogICAgICAgIG9wZW5PbkVudGVyOiB0cnVlLAogICAgICAgIGNvbnRhaW5lckNzczoge30sCiAgICAgICAgZHJvcGRvd25Dc3M6IHt9LAogICAgICAgIGNvbnRhaW5lckNzc0NsYXNzOiAiIiwKICAgICAgICBkcm9wZG93bkNzc0NsYXNzOiAiIiwKICAgICAgICBmb3JtYXRSZXN1bHQ6IGZ1bmN0aW9uKHJlc3VsdCwgY29udGFpbmVyLCBxdWVyeSwgZXNjYXBlTWFya3VwKSB7CiAgICAgICAgICAgIHZhciBtYXJrdXA9W107CiAgICAgICAgICAgIG1hcmtNYXRjaCh0aGlzLnRleHQocmVzdWx0KSwgcXVlcnkudGVybSwgbWFya3VwLCBlc2NhcGVNYXJrdXApOwogICAgICAgICAgICByZXR1cm4gbWFya3VwLmpvaW4oIiIpOwogICAgICAgIH0sCiAgICAgICAgdHJhbnNmb3JtVmFsOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgcmV0dXJuICQudHJpbSh2YWwpOwogICAgICAgIH0sCiAgICAgICAgZm9ybWF0U2VsZWN0aW9uOiBmdW5jdGlvbiAoZGF0YSwgY29udGFpbmVyLCBlc2NhcGVNYXJrdXApIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGEgPyBlc2NhcGVNYXJrdXAodGhpcy50ZXh0KGRhdGEpKSA6IHVuZGVmaW5lZDsKICAgICAgICB9LAogICAgICAgIHNvcnRSZXN1bHRzOiBmdW5jdGlvbiAocmVzdWx0cywgY29udGFpbmVyLCBxdWVyeSkgewogICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICB9LAogICAgICAgIGZvcm1hdFJlc3VsdENzc0NsYXNzOiBmdW5jdGlvbihkYXRhKSB7cmV0dXJuIGRhdGEuY3NzO30sCiAgICAgICAgZm9ybWF0U2VsZWN0aW9uQ3NzQ2xhc3M6IGZ1bmN0aW9uKGRhdGEsIGNvbnRhaW5lcikge3JldHVybiB1bmRlZmluZWQ7fSwKICAgICAgICBtaW5pbXVtUmVzdWx0c0ZvclNlYXJjaDogMCwKICAgICAgICBtaW5pbXVtSW5wdXRMZW5ndGg6IDAsCiAgICAgICAgbWF4aW11bUlucHV0TGVuZ3RoOiBudWxsLAogICAgICAgIG1heGltdW1TZWxlY3Rpb25TaXplOiAwLAogICAgICAgIGlkOiBmdW5jdGlvbiAoZSkgeyByZXR1cm4gZSA9PSB1bmRlZmluZWQgPyBudWxsIDogZS5pZDsgfSwKICAgICAgICB0ZXh0OiBmdW5jdGlvbiAoZSkgewogICAgICAgICAgaWYgKGUgJiYgdGhpcy5kYXRhICYmIHRoaXMuZGF0YS50ZXh0KSB7CiAgICAgICAgICAgIGlmICgkLmlzRnVuY3Rpb24odGhpcy5kYXRhLnRleHQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS50ZXh0KGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBlW3RoaXMuZGF0YS50ZXh0XTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGUudGV4dDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1hdGNoZXI6IGZ1bmN0aW9uKHRlcm0sIHRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmlwRGlhY3JpdGljcygnJyt0ZXh0KS50b1VwcGVyQ2FzZSgpLmluZGV4T2Yoc3RyaXBEaWFjcml0aWNzKCcnK3Rlcm0pLnRvVXBwZXJDYXNlKCkpID49IDA7CiAgICAgICAgfSwKICAgICAgICBzZXBhcmF0b3I6ICIsIiwKICAgICAgICB0b2tlblNlcGFyYXRvcnM6IFtdLAogICAgICAgIHRva2VuaXplcjogZGVmYXVsdFRva2VuaXplciwKICAgICAgICBlc2NhcGVNYXJrdXA6IGRlZmF1bHRFc2NhcGVNYXJrdXAsCiAgICAgICAgYmx1ck9uQ2hhbmdlOiBmYWxzZSwKICAgICAgICBzZWxlY3RPbkJsdXI6IGZhbHNlLAogICAgICAgIGFkYXB0Q29udGFpbmVyQ3NzQ2xhc3M6IGZ1bmN0aW9uKGMpIHsgcmV0dXJuIGM7IH0sCiAgICAgICAgYWRhcHREcm9wZG93bkNzc0NsYXNzOiBmdW5jdGlvbihjKSB7IHJldHVybiBudWxsOyB9LAogICAgICAgIG5leHRTZWFyY2hUZXJtOiBmdW5jdGlvbihzZWxlY3RlZE9iamVjdCwgY3VycmVudFNlYXJjaFRlcm0pIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSwKICAgICAgICBzZWFyY2hJbnB1dFBsYWNlaG9sZGVyOiAnJywKICAgICAgICBjcmVhdGVTZWFyY2hDaG9pY2VQb3NpdGlvbjogJ3RvcCcsCiAgICAgICAgc2hvdWxkRm9jdXNJbnB1dDogZnVuY3Rpb24gKGluc3RhbmNlKSB7CiAgICAgICAgICAgIC8vIEF0dGVtcHQgdG8gZGV0ZWN0IHRvdWNoIGRldmljZXMKICAgICAgICAgICAgdmFyIHN1cHBvcnRzVG91Y2hFdmVudHMgPSAoKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5hdmlnYXRvci5tc01heFRvdWNoUG9pbnRzID4gMCkpOwoKICAgICAgICAgICAgLy8gT25seSBkZXZpY2VzIHdoaWNoIHN1cHBvcnQgdG91Y2ggZXZlbnRzIHNob3VsZCBiZSBzcGVjaWFsIGNhc2VkCiAgICAgICAgICAgIGlmICghc3VwcG9ydHNUb3VjaEV2ZW50cykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5ldmVyIGZvY3VzIHRoZSBpbnB1dCBpZiBzZWFyY2ggaXMgZGlzYWJsZWQKICAgICAgICAgICAgaWYgKGluc3RhbmNlLm9wdHMubWluaW11bVJlc3VsdHNGb3JTZWFyY2ggPCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH07CgogICAgJC5mbi5zZWxlY3QyLmxvY2FsZXMgPSBbXTsKCiAgICAkLmZuLnNlbGVjdDIubG9jYWxlc1snZW4nXSA9IHsKICAgICAgICAgZm9ybWF0TWF0Y2hlczogZnVuY3Rpb24gKG1hdGNoZXMpIHsgaWYgKG1hdGNoZXMgPT09IDEpIHsgcmV0dXJuICJPbmUgcmVzdWx0IGlzIGF2YWlsYWJsZSwgcHJlc3MgZW50ZXIgdG8gc2VsZWN0IGl0LiI7IH0gcmV0dXJuIG1hdGNoZXMgKyAiIHJlc3VsdHMgYXJlIGF2YWlsYWJsZSwgdXNlIHVwIGFuZCBkb3duIGFycm93IGtleXMgdG8gbmF2aWdhdGUuIjsgfSwKICAgICAgICAgZm9ybWF0Tm9NYXRjaGVzOiBmdW5jdGlvbiAoKSB7IHJldHVybiAiTm8gbWF0Y2hlcyBmb3VuZCI7IH0sCiAgICAgICAgIGZvcm1hdEFqYXhFcnJvcjogZnVuY3Rpb24gKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikgeyByZXR1cm4gIkxvYWRpbmcgZmFpbGVkIjsgfSwKICAgICAgICAgZm9ybWF0SW5wdXRUb29TaG9ydDogZnVuY3Rpb24gKGlucHV0LCBtaW4pIHsgdmFyIG4gPSBtaW4gLSBpbnB1dC5sZW5ndGg7IHJldHVybiAiUGxlYXNlIGVudGVyICIgKyBuICsgIiBvciBtb3JlIGNoYXJhY3RlciIgKyAobiA9PSAxID8gIiIgOiAicyIpOyB9LAogICAgICAgICBmb3JtYXRJbnB1dFRvb0xvbmc6IGZ1bmN0aW9uIChpbnB1dCwgbWF4KSB7IHZhciBuID0gaW5wdXQubGVuZ3RoIC0gbWF4OyByZXR1cm4gIlBsZWFzZSBkZWxldGUgIiArIG4gKyAiIGNoYXJhY3RlciIgKyAobiA9PSAxID8gIiIgOiAicyIpOyB9LAogICAgICAgICBmb3JtYXRTZWxlY3Rpb25Ub29CaWc6IGZ1bmN0aW9uIChsaW1pdCkgeyByZXR1cm4gIllvdSBjYW4gb25seSBzZWxlY3QgIiArIGxpbWl0ICsgIiBpdGVtIiArIChsaW1pdCA9PSAxID8gIiIgOiAicyIpOyB9LAogICAgICAgICBmb3JtYXRMb2FkTW9yZTogZnVuY3Rpb24gKHBhZ2VOdW1iZXIpIHsgcmV0dXJuICJMb2FkaW5nIG1vcmUgcmVzdWx0c+KApiI7IH0sCiAgICAgICAgIGZvcm1hdFNlYXJjaGluZzogZnVuY3Rpb24gKCkgeyByZXR1cm4gIlNlYXJjaGluZ+KApiI7IH0KICAgIH07CgogICAgJC5leHRlbmQoJC5mbi5zZWxlY3QyLmRlZmF1bHRzLCAkLmZuLnNlbGVjdDIubG9jYWxlc1snZW4nXSk7CgogICAgJC5mbi5zZWxlY3QyLmFqYXhEZWZhdWx0cyA9IHsKICAgICAgICB0cmFuc3BvcnQ6ICQuYWpheCwKICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgIGNhY2hlOiBmYWxzZSwKICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIgogICAgICAgIH0KICAgIH07CgogICAgLy8gZXhwb3J0cwogICAgd2luZG93LlNlbGVjdDIgPSB7CiAgICAgICAgcXVlcnk6IHsKICAgICAgICAgICAgYWpheDogYWpheCwKICAgICAgICAgICAgbG9jYWw6IGxvY2FsLAogICAgICAgICAgICB0YWdzOiB0YWdzCiAgICAgICAgfSwgdXRpbDogewogICAgICAgICAgICBkZWJvdW5jZTogZGVib3VuY2UsCiAgICAgICAgICAgIG1hcmtNYXRjaDogbWFya01hdGNoLAogICAgICAgICAgICBlc2NhcGVNYXJrdXA6IGRlZmF1bHRFc2NhcGVNYXJrdXAsCiAgICAgICAgICAgIHN0cmlwRGlhY3JpdGljczogc3RyaXBEaWFjcml0aWNzCiAgICAgICAgfSwgImNsYXNzIjogewogICAgICAgICAgICAiYWJzdHJhY3QiOiBBYnN0cmFjdFNlbGVjdDIsCiAgICAgICAgICAgICJzaW5nbGUiOiBTaW5nbGVTZWxlY3QyLAogICAgICAgICAgICAibXVsdGkiOiBNdWx0aVNlbGVjdDIKICAgICAgICB9CiAgICB9OwoKfShqUXVlcnkpKTsK",
    "size": "148536"
}